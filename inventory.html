<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
 <!-- Paste the security check script here -->
    <script>
        const userPermissions = localStorage.getItem('userPermissions');
        if (!userPermissions) {
            window.location.assign('https://portal.jengchirestaurant.com/index.html');
        }
    </script>
    <!-- End of script -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi - Order List</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Use Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Lucide Icons for a clean, modern look -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Custom styles to override Tailwind for specific components */
        .product-card-hover:hover {
            transform: translateY(-5px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        .btn-hover:hover {
            transform: scale(1.05);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
        }
        .modal {
            background-color: rgba(0, 0, 0, 0.5);
        }
        .modal-content {
            animation: fadeIn 0.3s ease-out;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        /* Hide number input spinners */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Custom card styling for order summary */
        .last-order-card {
            background-color: #fff;
            padding: 1.5rem;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
            border: 1px solid #e5e7eb;
            transition: all 0.2s ease-in-out;
        }
        .last-order-card:hover {
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
        }
        .order-summary-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
        }
        .order-summary-list {
            list-style: none;
            padding: 0;
        }
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid #e5e7eb;
        }
        .order-summary-item:last-child {
            border-bottom: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-0 md:p-4 lg:p-6 max-w-7xl">

        <!-- Header -->
        <header class="bg-white p-6 md:p-8 lg:p-12 text-center rounded-b-3xl shadow-lg border-b-8 border-blue-500">
            <img class="logo w-[323px] mx-auto mb-4 rounded-xl shadow-md transform hover:rotate-y-6 transition-transform duration-300" 
                 src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
            <h1 class="text-2xl md:text-3xl font-extrabold text-black mb-1 drop-shadow-md">JENG CHI RESTAURANT</h1>
            <p class="text-base md:text-lg font-bold text-black mb-1 drop-shadow-md">INVENTORY MANAGEMENT APP</p>
            <p class="text-xl md:text-2xl font-bold text-gray-700 mt-2"><b>ORDER LIST</b></p>
        </header>

        <!-- Filter and Search Bar -->
        <div id="filter-bar" class="flex flex-col md:flex-row justify-center items-center flex-wrap gap-2 md:gap-4 my-8 p-4 bg-white rounded-xl shadow-lg">
            <!-- Dynamic user filter buttons will be rendered here -->
            <button class="filter-btn bg-red-500 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-200 btn-hover" onclick="openModal('confirm-admin', 'Confirm Navigation', 'Are you sure you want to go to the Admin page?', () => { window.location.href='admin.html' })">ADMIN</button>
            
            <div class="relative w-full md:w-auto md:flex-grow-0 md:max-w-xs flex items-center bg-gray-200 rounded-full px-4 py-2 mt-4 md:mt-0 shadow-inner">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search text-gray-500 mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
                <input type="text" placeholder="Search products..." id="search-input" class="bg-transparent outline-none w-full text-gray-800">
            </div>
        </div>

        <!-- Main content area -->
        <main id="main-content" class="p-4 md:p-6">
            <!-- Product sections will be dynamically loaded here -->
            <p class="text-center text-gray-500">Loading inventory...</p>
        </main>
    </div>

    <!-- Floating Action Buttons -->
    <div class="fixed bottom-6 right-6 flex flex-col items-center space-y-4 z-50">
        <button id="download-btn" class="download-btn bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl btn-hover transition-all duration-200" onclick="downloadCurrentOrder()">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
        </button>
        <button id="submit-btn" class="submit-btn bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl btn-hover transition-all duration-200" onclick="openModal('confirm-submit', 'Confirm Submission', 'Are you sure you want to submit this order? This will reset the quantities on this list to zero.', submitInventory)">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-3-8-3-3L2 14l19-7z"/></svg>
        </button>
    </div>

    <!-- Modals -->
    <div id="confirmation-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-[100] hidden">
        <div class="modal-content bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
            <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
            <p id="modal-message" class="text-gray-600 mb-6"></p>
            <div id="modal-icon" class="mb-6"></div>
            <div id="modal-buttons" class="flex justify-center space-x-4">
                <button id="modal-ok-btn" onclick="closeModal()" class="bg-blue-500 text-white px-6 py-2 rounded-full font-semibold transition-colors duration-200 hover:bg-blue-600">OK</button>
                <button id="modal-cancel-btn" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-400">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Image Zoom Modal -->
    <div id="image-modal" class="fixed inset-0 flex items-center justify-center p-4 z-[90] modal hidden" onclick="this.classList.add('hidden')">
        <img id="zoomed-image" class="max-w-full max-h-full object-contain rounded-lg shadow-xl" onclick="event.stopPropagation();">
    </div>

    <!-- Supabase Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // ðŸ”‘ Supabase credentials - IMPORTANT: Replace these with your project's details
        // The URL and anonymous key are a public and non-sensitive way to connect to your Supabase project.
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // Supabase Edge Function URL for sending emails. You will need to deploy this function.
        // https://supabase.com/docs/guides/functions/quickstarts/resend
        const RESEND_FUNCTION_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/send-email";

        // Cache DOM elements
        const mainContentContainer = document.getElementById("main-content");
        const searchInput = document.getElementById("search-input");
        const confirmationModal = document.getElementById('confirmation-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalMessage = document.getElementById('modal-message');
        const modalIcon = document.getElementById('modal-icon');
        const modalOkBtn = document.getElementById('modal-ok-btn');
        const modalCancelBtn = document.getElementById('modal-cancel-btn');
        const imageModal = document.getElementById('image-modal');
        const zoomedImage = document.getElementById('zoomed-image');
        const filterBar = document.getElementById("filter-bar");
        const lastOrderConfirmation = document.getElementById("last-order-confirmation");


        let debounceTimer;
        let products = [];
        let unsubscribe = null; // To store the unsubscribe function for the real-time listener
        let currentCategory = 'Rony';

        document.addEventListener('DOMContentLoaded', async () => {
            await renderUserButtons();
            // Get the first dynamically created button to set it as active
            const firstButton = document.querySelector('.vendor-filter');
            if (firstButton) {
                const categoryName = firstButton.getAttribute('data-user');
                loadCategory(categoryName, firstButton);
            }
        });
        
        // Listen for changes in the search input
        searchInput.addEventListener('input', (event) => {
            const query = event.target.value.toLowerCase();
            const filteredProducts = Object.values(products).flat().filter(p => p.product_name.toLowerCase().includes(query));
            renderProducts(aggregateProducts(filteredProducts));
        });

        // Event listener for a dynamic input field that may not exist on page load
        mainContentContainer.addEventListener('input', (event) => {
            if (event.target.tagName === 'INPUT' && event.target.type === 'number') {
                const productName = event.target.dataset.product_name;
                if (productName) {
                    debounceSave(productName, event.target.value);
                }
            }
        });

        /**
         * Opens the image zoom modal.
         * @param {string} imageUrl - The URL of the image to display.
         */
        function zoomImage(imageUrl) {
            zoomedImage.src = imageUrl;
            imageModal.classList.remove('hidden');
        }

        /**
         * Dynamically fetches unique users from the database and renders filter buttons.
         */
        async function renderUserButtons() {
            const { data, error } = await supabaseClient
                .from('inventory_management')
                .select('user')
                .not('user', 'is', null) // Only select rows where the user column is not null
                .order('user');
            
            if (error) {
                console.error('Error fetching users:', error);
                return;
            }

            // Create a set of unique user strings
            const uniqueUsers = new Set(data.map(item => item.user));

            // Convert the set to an array and sort it
            const userFilters = Array.from(uniqueUsers).sort();
            
            // Remove old dynamic buttons and static ones, but keep the ADMIN button
            document.querySelectorAll('.vendor-filter').forEach(btn => btn.remove());

            const adminButton = filterBar.querySelector('button.bg-red-500');
            
            userFilters.forEach(filterName => {
                const button = document.createElement('button');
                button.textContent = filterName;
                button.classList.add('filter-btn', 'vendor-filter', 'bg-gray-200', 'text-gray-700', 'font-semibold', 'py-2', 'px-6', 'rounded-full', 'shadow-md', 'transition-all', 'duration-200', 'btn-hover');
                button.setAttribute('data-user', filterName);
                button.onclick = () => loadCategory(filterName);
                filterBar.insertBefore(button, adminButton);
            });
        }

        /**
         * Loads all products for a given category using a real-time listener.
         * @param {string} categoryName - The category/vendor type to filter by.
         */
        async function loadCategory(userName) {
            // Unsubscribe from the previous listener if it exists
            if (unsubscribe) {
                unsubscribe();
            }
            
            currentCategory = userName;

            // Update active category button state
            document.querySelectorAll('.vendor-filter').forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
            document.querySelectorAll('.vendor-filter').forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
            const activeBtn = document.querySelector(`.vendor-filter[data-user="${userName}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
                activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
            }
            
            mainContentContainer.innerHTML = `<p class="text-center text-gray-500 p-8">Loading inventory...</p>`;

            // Create a query based on the selected user, ordering by position
            let query = supabaseClient.from("inventory_management").select('*').eq('user', userName).order('position');

            const { data, error } = await query;
            if (error) {
                console.error("Error fetching initial data:", error);
                mainContentContainer.innerHTML = `<p class="text-center text-red-500 p-8">Error loading inventory. Please check the console.</p>`;
                return;
            }
            
            // Aggregate the fetched data to show one product per name, with combined quantities
            products = aggregateProducts(data);
            
            // Render the products, which will now be grouped by position
            renderProducts(products);

            // Subscribe to real-time changes
            const channel = supabaseClient.channel('inventory_changes');
            channel.on('postgres_changes', { event: '*', schema: 'public', table: 'inventory_management' }, async (payload) => {
                const { new: newData, old: oldData } = payload;
                
                const { data: updatedData, error: updateError } = await query;
                if (!updateError) {
                    products = aggregateProducts(updatedData);
                    renderProducts(updatedData);
                }
            }).subscribe();

            // Store the unsubscribe function to clean up when the category changes
            unsubscribe = () => {
                supabaseClient.removeChannel(channel);
            };
        }
        
        /**
         * Aggregates a list of products by name, summing the 'on_hand' quantity.
         * @param {Array<Object>} rawProducts - The raw list of products from the database.
         * @returns {Object} - An object with keys as positions and values as arrays of aggregated products.
         */
        function aggregateProducts(rawProducts) {
            const aggregatedByPosition = {};
            
            rawProducts.forEach(p => {
                const position = p.position || 'No Position';
                
                if (!aggregatedByPosition[position]) {
                    aggregatedByPosition[position] = {};
                }

                if (!aggregatedByPosition[position][p.product_name]) {
                    // Create a new entry for a unique product name within this position group
                    aggregatedByPosition[position][p.product_name] = {
                        product_name: p.product_name,
                        image_url: p.image_url,
                        category: p.category,
                        on_hand: p.on_hand,
                        position: p.position
                    };
                } else {
                    // Add the quantity to an existing entry for this product name and position
                    aggregatedByPosition[position][p.product_name].on_hand += p.on_hand;
                }
            });

            // Convert the nested object structure into a more render-friendly format
            const finalResult = {};
            Object.keys(aggregatedByPosition).sort((a,b) => a - b).forEach(position => {
                finalResult[position] = Object.values(aggregatedByPosition[position]);
            });
            return finalResult;
        }

        /**
         * Renders product cards based on the provided data grouped by position.
         * @param {Object} productsData - An object with keys as positions and values as arrays of aggregated products.
         */
        function renderProducts(productsData) {
            mainContentContainer.innerHTML = '';
            
            if (Object.keys(productsData).length === 0) {
                mainContentContainer.innerHTML = `<p class="text-center text-gray-500 p-8">No products found for this category.</p>`;
                return;
            }

            // Iterate over the positions (which are already sorted)
            Object.keys(productsData).forEach(position => {
                const positionSection = document.createElement('section');
                positionSection.classList.add('py-4');
                
                const positionTitle = document.createElement('h2');
                positionTitle.classList.add('text-2xl', 'font-bold', 'text-gray-700', 'mb-4', 'border-b-2', 'border-gray-300', 'pb-2');
                
                // Customize title for "Julio"
                if (currentCategory === 'Julio') {
                    positionTitle.textContent = position;
                } else {
                    positionTitle.textContent = `Position ${position}`;
                }
                
                positionSection.appendChild(positionTitle);

                const productGrid = document.createElement('div');
                productGrid.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-6');
                positionSection.appendChild(productGrid);

                const productsInPosition = productsData[position];
                
                productsInPosition.forEach(product => {
                    const card = document.createElement("div");
                    card.classList.add("bg-white", "p-6", "rounded-2xl", "shadow-md", "flex", "flex-col", "items-center", "text-center", "space-y-4", "transition-transform", "duration-200", "product-card-hover");
                    
                    card.innerHTML = `
                        <div class="cursor-pointer" onclick="zoomImage('${product.image_url || 'https://placehold.co/200x200/e5e7eb/6b7280?text=No+Image'}')">
                            <img src="${product.image_url || 'https://placehold.co/200x200/e5e7eb/6b7280?text=No+Image'}" 
                                 alt="${product.product_name}" 
                                 class="w-40 h-40 object-contain rounded-lg border border-gray-200">
                        </div>
                        <div class="text-lg font-semibold text-gray-800">${product.product_name}</div>
                        <div class="flex items-center justify-between w-full p-2 bg-gray-100 rounded-lg">
                            <button onclick="updateQuantity('${product.product_name}', -1)" 
                                    class="bg-blue-500 text-white w-8 h-8 rounded-md flex items-center justify-center font-bold text-xl hover:bg-blue-600 transition-colors duration-200">-</button>
                            <input type="number" 
                                    data-product-name="${product.product_name}"
                                    value="${product.on_hand > 0 ? product.on_hand : ''}" 
                                    min="0"
                                    class="text-center w-20 bg-transparent text-xl font-medium outline-none" 
                                    placeholder="0">
                            <button onclick="updateQuantity('${product.product_name}', 1)" 
                                    class="bg-blue-500 text-white w-8 h-8 rounded-md flex items-center justify-center font-bold text-xl hover:bg-blue-600 transition-colors duration-200">+</button>
                        </div>
                    `;
                    productGrid.appendChild(card);
                });

                mainContentContainer.appendChild(positionSection);
            });
        }

        /**
         * Updates the quantity and saves it to the database.
         * This function now updates ALL entries for a given product name, not just one.
         * @param {string} productName - The name of the product to update.
         * @param {number|null} change - The change in quantity (-1, 1, or null for manual input).
         */
        async function updateQuantity(productName, change) {
            // Find the product in the aggregated local state
            const allProducts = Object.values(products).flat();
            const product = allProducts.find(p => p.product_name === productName);
            if (!product) {
                console.error(`Product with name ${productName} not found.`);
                return;
            }

            const input = document.querySelector(`input[data-product-name="${product.product_name}"]`);
            if (!input) {
                console.error(`Input field not found for product name: ${product.product_name}`);
                return;
            }

            let newValue = parseFloat(input.value);
            if (isNaN(newValue)) {
                newValue = 0;
            }

            if (change !== null) {
                newValue = newValue + change;
            }

            if (newValue < 0) {
                newValue = 0;
            }
            
            input.value = newValue > 0 ? newValue : '';

            // Update the local state
            product.on_hand = newValue;

            // Save to Supabase
            const { error } = await supabaseClient
                .from("inventory_management")
                .update({ on_hand: newValue })
                .eq("product_name", productName);

            if (error) {
                console.error("Error updating quantity:", error);
                openModal('error', 'Update Failed', 'An error occurred while saving your changes to the database. Check the console for more info.');
            }
        }

        /**
         * Debounces the save function to prevent excessive API calls while typing.
         * @param {string} productName - The product name to update.
         * @param {string} value - The input value.
         */
        function debounceSave(productName, value) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateQuantity(productName, null);
            }, 500);
        }

        /**
         * Generates and downloads a CSV file of the current order.
         */
        function downloadCurrentOrder() {
            const productsInOrder = Object.values(products).flat().filter(p => p.on_hand > 0);
            if (productsInOrder.length === 0) {
                openModal('info', 'No Items', 'There are no items in your current order to download.');
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Product Name,Quantity\r\n";
            productsInOrder.forEach(product => {
                csvContent += `${product.product_name},${product.on_hand}\r\n`;
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `${currentCategory.replace(/\s+/g, '_')}_order.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            openModal('success', 'Download Complete', 'Your order list has been downloaded as a CSV file.');
        }

        /**
         * Handles the form submission by preparing data, saving it to a new Supabase table,
         * and calling the server-side function to send an email.
         */
        async function submitInventory() {
            // Get the latest values directly from the DOM input fields before submitting
            const allProducts = Object.values(products).flat();
            const productsToSubmit = [];
            
            allProducts.forEach(product => {
                const input = document.querySelector(`input[data-product-name="${product.product_name}"]`);
                if (input && parseFloat(input.value) > 0) {
                    productsToSubmit.push({
                        ...product,
                        on_hand: parseFloat(input.value)
                    });
                }
            });

            if (productsToSubmit.length === 0) {
                openModal('info', 'No Items', 'There are no items in your current order to submit.');
                return;
            }

            // 1. Insert the order into the "submitted_orders" table
            const { error: insertError } = await supabaseClient
                .from('submitted_orders')
                .insert([
                    {
                        order_date: new Date().toISOString(),
                        order_details: productsToSubmit,
                        vendor_list: currentCategory
                    }
                ]);

            if (insertError) {
                console.error("Error submitting order to database:", insertError);
                openModal('error', 'Submission Failed', 'An error occurred while saving your order. Please check the console.');
                return;
            }
            
            // 2. Call the server-side Resend function to send the email
            const emailResult = await sendEmail(productsToSubmit, currentCategory);
            
            // 3. Reset the "on-hand" quantity for the items on the current list
            const productNamesToReset = productsToSubmit.map(p => p.product_name);
            const { error: resetError } = await supabaseClient
                .from("inventory_management")
                .update({ on_hand: 0 })
                .in('product_name', productNamesToReset);

            if (resetError) {
                console.error("Failed to reset quantities:", resetError);
                // Even if reset fails, show a success modal for the submission
                openModal('warning', 'Reset Failed', 'The order was submitted, but there was an error resetting quantities. Please check the console.');
            }

            // 4. Show final status
            if (emailResult.success) {
                openCustomSuccessModal('GRACIAS RONY POR COLOCAR LA ORDEN', 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
            } else {
                openModal('error', 'Email Failed', `Your order was submitted to the database, but the email notification failed. Cause: ${emailResult.message}`);
            }
        }
        
        /**
         * Sends an email using the Resend API via a Supabase Edge Function.
         * @param {array} orderList - The list of products to order.
         * @returns {object} - An object with a 'success' boolean and a 'message' string.
         */
        async function sendEmail(orderList, vendorList) {
            try {
                const htmlBody = formatOrderForEmail(orderList, vendorList);
                const response = await fetch(RESEND_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        to: "admin@jengchirestaurant.com",
                        subject: `New Jeng Chi Inventory Order from the ${vendorList} List`,
                        html: htmlBody
                    }),
                });
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("Error from Supabase function:", errorDetails);
                    return { success: false, message: `Server responded with a non-OK status. Details: ${errorDetails}` };
                }

                const result = await response.json();
                console.log("Email sent successfully:", result);
                return { success: true, message: 'Email sent successfully.' };

            } catch (error) {
                console.error("Network or other error when calling Edge Function:", error);
                return { success: false, message: `Network error. The app could not reach the email server. Cause: ${error.message}` };
            }
        }
        
        /**
         * Formats the order details into an HTML string for the email body.
         * @param {array} orderList - The list of products to order.
         * @param {string} vendorList - The name of the vendor list.
         * @returns {string} - The formatted HTML string.
         */
        function formatOrderForEmail(orderList, vendorList) {
            let tableRows = '';
            orderList.forEach(item => {
                tableRows += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.product_name}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.on_hand}</td>
                    </tr>
                `;
            });

            return `
                <div style="font-family: sans-serif; padding: 20px; color: #333; max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 8px;">
                    <h2 style="color: #007bff;">New Jeng Chi Inventory Order</h2>
                    <p>A new order has been submitted for the <strong>${vendorList}</strong> list:</p>
                    <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">This order was submitted automatically by the Inventory App.</p>
                </div>
            `;
        }
        
        /**
         * Shows the confirmation modal.
         * @param {string} type - 'success', 'error', 'warning', 'confirm-admin', 'confirm-submit'
         * @param {string} title - The modal title.
         * @param {string} message - The modal message.
         * @param {Function} [onConfirm] - Callback to execute on confirmation.
         */
        function openModal(type, title, message, onConfirm) {
            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalOkBtn.onclick = closeModal;
            modalCancelBtn.style.display = 'none';

            // Clear previous modal icon/content
            modalIcon.innerHTML = '';
            modalTitle.style.display = '';
            modalMessage.style.display = '';

            if (type === 'success') {
                modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
            } else if (type === 'error') {
                modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-red-500"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`;
            } else if (type === 'info') {
                modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;
            } else if (type === 'warning') {
                modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-yellow-500"><path d="m21.73 18.27-8.94-15.02c-.89-1.5-3.13-1.5-4.02 0L2.27 18.27c-.89 1.5.23 3.32 2.01 3.32h15.44c1.78 0 2.9-1.82 2.01-3.32z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;
            } else if (type.startsWith('confirm')) {
                modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-500"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v6h6"/></svg>`;
                modalCancelBtn.style.display = 'block';
                modalOkBtn.onclick = () => { onConfirm(); closeModal(); };
            }

            confirmationModal.classList.remove('hidden');
        }

        /**
         * Shows a custom success modal with a specific image and message.
         * @param {string} message - The modal message.
         * @param {string} imageUrl - The URL of the image to display.
         */
        function openCustomSuccessModal(message, imageUrl) {
            modalTitle.textContent = "Â¡Orden Completada!";
            modalMessage.textContent = message;
            modalOkBtn.onclick = closeModal;
            modalCancelBtn.style.display = 'none';

            // Clear previous modal icon/content and then add the custom image
            modalIcon.innerHTML = `
                <img src="${imageUrl}" 
                     alt="Success Image" 
                     onerror="this.src='https://placehold.co/96x96/e5e7eb/6b7280?text=No+Image'" 
                     class="w-24 h-24 rounded-full mx-auto mb-4 object-cover">
            `;

            confirmationModal.classList.remove('hidden');
        }

        /**
         * Hides the confirmation modal.
         */
        function closeModal() {
            confirmationModal.classList.add('hidden');
        }

        /**
         * Fetches and displays the last submitted order from the database.
         */
        async function displayLastOrder() {
            lastOrderConfirmation.innerHTML = `<p class="text-center text-gray-500 p-8">Cargando el Ãºltimo pedido...</p>`;
            
            try {
                const { data, error } = await supabaseClient
                    .from('submitted_orders')
                    .select('order_date, order_details, vendor_list')
                    .order('order_date', { ascending: false })
                    .limit(1);

                if (error) {
                    console.error("Error fetching last order:", error);
                    lastOrderConfirmation.innerHTML = `<p class="text-center text-red-500 p-8">No se pudo recuperar los detalles del Ãºltimo pedido.</p>`;
                    return;
                }

                if (data && data.length > 0) {
                    const lastOrder = data[0];
                    const orderDate = new Date(lastOrder.order_date).toLocaleString();
                    let orderDetailsHtml = '';
                    lastOrder.order_details.forEach(item => {
                        orderDetailsHtml += `<li class="order-summary-item"><span class="font-semibold">${item.product_name}</span><span>${item.on_hand}</span></li>`;
                    });

                    lastOrderConfirmation.innerHTML = `
                        <div class="last-order-card">
                            <h3 class="order-summary-title">Resumen del Ãºltimo pedido</h3>
                            <p class="text-sm text-gray-600 mb-2"><strong>Lista del proveedor:</strong> ${lastOrder.vendor_list}</p>
                            <p class="text-sm text-gray-600 mb-4"><strong>Fecha de envÃ­o:</strong> ${orderDate}</p>
                            <ul class="order-summary-list">
                                ${orderDetailsHtml}
                            </ul>
                        </div>
                    `;
                } else {
                    lastOrderConfirmation.innerHTML = `<p class="text-center text-gray-500 p-8">No se encontraron pedidos anteriores.</p>`;
                }
            } catch (e) {
                console.error("An unexpected error occurred:", e);
                lastOrderConfirmation.innerHTML = `<p class="text-center text-red-500 p-8">OcurriÃ³ un error inesperado al recuperar el Ãºltimo pedido.</p>`;
            }
        }
    </script>
</body>
</html>
