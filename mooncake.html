<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi • Mooncake 2025 — Enterprise Checkout</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&family=Montserrat:wght@600;700;800&display=swap" rel="stylesheet">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.4/jspdf.plugin.autotable.min.js"></script>

  <style>
    :root{--brand:#7A3D36;--brand-2:#A66E66;--ink:#0b0b0c;--paper:#0f0f11;--glass:rgba(255,255,255,.06)}
    html,body{height:100%}
    body{font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans";background:radial-gradient(1400px 800px at 50% -10%, #5b2b26 0%, #221112 38%, #0f0f11 78%);color:#F7F7FA}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.12), rgba(255,255,255,.06));border:1px solid rgba(255,255,255,.16);backdrop-filter: blur(10px);border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.45)}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:.5rem;background:var(--brand);color:white;border-radius:12px;padding:.7rem 1rem;font-weight:700;box-shadow:0 14px 30px rgba(122,61,54,.35);transition:.18s ease}
    .btn:hover{transform:translateY(-1px);filter:saturate(1.04);box-shadow:0 20px 40px rgba(122,61,54,.5)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.22);color:#fff;border-radius:12px;padding:.65rem .95rem}
    .step{display:flex;align-items:center;gap:.6rem;padding:.5rem .8rem;border-radius:12px;border:1px solid rgba(255,255,255,.12)}
    .step[data-active="true"]{background:rgba(255,255,255,.08)}
    .tag{background:#ffffff1a;border:1px solid #ffffff33;padding:.25rem .55rem;border-radius:.65rem;font-size:.7rem}
    .skeleton{position:relative;overflow:hidden;background:#ffffff1a;border-radius:14px}
    .skeleton:after{content:"";position:absolute;inset:0;transform:translateX(-100%);background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent);animation:sweep 1.3s infinite}
    @keyframes sweep{to{transform:translateX(100%)}}
    #toast{position:fixed;right:16px;bottom:16px;display:flex;flex-direction:column;gap:8px;z-index:200}
    .toast{background:#1f1f1f;color:#fff;border:1px solid #363636;border-radius:12px;padding:10px 12px;box-shadow:0 10px 24px rgba(0,0,0,.45);font-size:13px}
  </style>
</head>
<body class="min-h-full">
  <!-- Topbar -->
  <header class="sticky top-0 z-40 border-b border-white/10 backdrop-blur bg-black/60">
    <div class="mx-auto max-w-7xl px-5 py-3 flex items-center gap-4 justify-between">
      <div class="flex items-center gap-4">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="h-10 w-auto rounded shadow" alt="Jeng Chi logo"/>
        <div>
          <div class="font-[Montserrat] text-xl md:text-2xl font-extrabold tracking-tight">Mooncake 2025 — Pre‑Order</div>
          <div class="text-xs opacity-80">Enterprise checkout • Multi‑address shipping • Stripe card payments • Email/PDF confirmation</div>
        </div>
      </div>
      <div class="hidden md:flex items-center gap-2">
        <span class="tag">Secure</span>
        <span class="tag">PCI via Stripe</span>
        <a href="mailto:orders@jengchi.com" class="btn-ghost">Support</a>
      </div>
    </div>
  </header>

  <main class="mx-auto max-w-7xl px-5 py-8 grid grid-cols-1 lg:grid-cols-[1fr_380px] gap-6">
    <!-- LEFT: Content -->
    <section class="space-y-6">
      <!-- Stepper -->
      <nav class="flex flex-wrap gap-2">
        <div class="step" id="s1" data-active="true"><span class="w-7 h-7 rounded-full bg-white/15 flex items-center justify-center font-semibold">1</span><span class="text-sm">Select Items</span></div>
        <div class="step" id="s2"><span class="w-7 h-7 rounded-full bg-white/15 flex items-center justify-center font-semibold">2</span><span class="text-sm">Shipping</span></div>
        <div class="step" id="s3"><span class="w-7 h-7 rounded-full bg-white/15 flex items-center justify-center font-semibold">3</span><span class="text-sm">Review & Pay</span></div>
      </nav>

      <!-- Catalog controls -->
      <div class="card p-4 flex flex-wrap gap-3 items-center justify-between">
        <div class="flex items-center gap-2">
          <input id="search" class="px-3 py-2 rounded-md bg-white/10 border border-white/20 w-64" placeholder="Search products…"/>
          <select id="filterCat" class="px-3 py-2 rounded-md bg-white/10 border border-white/20">
            <option value="">All categories</option>
            <option>Canton Style</option>
            <option>Thousand Layers</option>
            <option>Northern Style</option>
            <option>Special Style</option>
          </select>
        </div>
        <div class="flex items-center gap-2">
          <button id="btnReload" class="btn-ghost">⟳ Reload</button>
          <button id="btnDemo" class="btn-ghost">Try Demo Mode</button>
        </div>
      </div>

      <!-- Product list -->
      <section id="catalog" class="space-y-5">
        <div class="card p-5" id="group-skeleton">
          <div class="h-7 w-40 skeleton mb-4"></div>
          <div class="grid md:grid-cols-2 gap-4">
            <div class="h-28 skeleton"></div>
            <div class="h-28 skeleton"></div>
            <div class="h-28 skeleton"></div>
            <div class="h-28 skeleton"></div>
          </div>
          <p class="text-sm mt-4 opacity-80" id="loadMsg">Loading products…</p>
        </div>
      </section>

      <!-- Shipping panel (step 2) -->
      <section id="shipping" class="hidden space-y-4">
        <div class="card p-5">
          <div class="flex items-center justify-between flex-wrap gap-3">
            <h3 class="text-lg font-semibold">Shipping addresses</h3>
            <div class="text-sm opacity-80">$60 flat per 1–8 items per address, then another $60 per additional 1–8</div>
          </div>
          <div id="shipRows" class="mt-4 space-y-3"></div>
          <button id="btnAddShip" class="btn mt-3">+ Add Address</button>
          <p class="text-sm opacity-80 mt-3">Allocated: <span id="allocated">0</span> / <span id="needAlloc">0</span> items</p>
        </div>
      </section>

      <!-- Review (step 3) -->
      <section id="review" class="hidden space-y-4">
        <div class="card p-5">
          <h3 class="text-lg font-semibold mb-3">Order review</h3>
          <div id="reviewList" class="space-y-2 text-sm"></div>
        </div>
      </section>
    </section>

    <!-- RIGHT: Order Summary -->
    <aside class="card p-5 h-max sticky top-20">
      <h3 class="text-xl font-semibold">Order Summary</h3>
      <div id="cartList" class="mt-3 space-y-2 text-sm"></div>
      <div class="my-3 border-t border-white/10"></div>
      <dl class="text-sm space-y-1">
        <div class="flex justify-between"><dt>Items</dt><dd id="sumItems">$0.00</dd></div>
        <div class="flex justify-between"><dt>Shipping</dt><dd id="sumShipping">$0.00</dd></div>
      </dl>
      <div class="my-3 border-t border-white/10"></div>
      <div class="flex justify-between items-center text-lg font-bold"><span>Total</span><span id="sumTotal">$0.00</span></div>

      <div class="mt-5 grid gap-2">
        <button id="btnNext" class="btn">Continue</button>
        <button id="btnReserve" class="btn-ghost">Reserve (no payment)</button>
        <button id="btnPay" class="btn hidden">Pay with Card (Stripe)</button>
      </div>

      <form id="customer" class="mt-5 grid gap-2 text-sm">
        <input id="custName" class="px-3 py-2 bg-white/10 border border-white/20 rounded-md" placeholder="Full name / Nombre" required />
        <input id="custPhone" class="px-3 py-2 bg-white/10 border border-white/20 rounded-md" placeholder="Phone / Teléfono" />
        <input id="custEmail" type="email" class="px-3 py-2 bg-white/10 border border-white/20 rounded-md" placeholder="Email" />
        <label class="text-xs opacity-80">Pickup date</label>
        <input id="pickupDate" type="date" class="px-3 py-2 bg-white/10 border border-white/20 rounded-md" />
        <textarea id="custNotes" rows="3" class="px-3 py-2 bg-white/10 border border-white/20 rounded-md" placeholder="Notes (flavors, packaging)"></textarea>
      </form>

      <p id="status" class="mt-3 text-xs opacity-80"></p>
    </aside>
  </main>

  <footer class="py-8 text-center text-xs opacity-70">© <span id="y"></span> Jeng Chi Restaurant • Privacy • Terms</footer>
  <div id="toast"></div>

  <script>
    // ===== Config (from v3) =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const SEND_EMAIL_ENDPOINT = `${SUPABASE_URL}/functions/v1/send-email`;
    const CHECKOUT_FN = `${SUPABASE_URL}/functions/v1/mooncake-checkout`;
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    const state = { products: [], cart: new Map(), step: 1, ships: [] };

    // ===== Utils =====
    const fmtUSD = c => `$${(c/100).toFixed(2)}`;
    const parseIntSafe = (v, d=0)=>{ const n=parseInt(v,10); return Number.isFinite(n)?n:d };
    const shipFeeFor = q => q<=0?0: Math.ceil(q/8)*6000; // $60 per 1..8 per address
    function toast(msg){ const box=document.getElementById('toast'); const t=document.createElement('div'); t.className='toast'; t.textContent=msg; box.appendChild(t); setTimeout(()=>{t.style.opacity=.0; setTimeout(()=>t.remove(),400)},2600) }

    // ===== Products (Supabase fetch from v3) =====
    async function loadProducts(){
      document.getElementById('group-skeleton').classList.remove('hidden');
      document.getElementById('loadMsg').textContent = 'Loading products…';
      try{
        const { data, error } = await supabaseClient
          .from('mooncake_products')
          .select('*')
          .eq('is_active', true)
          .order('category', { ascending: true, nullsFirst: true })
          .order('sort_order', { ascending: true, nullsFirst: true })
          .order('name', { ascending: true });
        if(error) throw error;
        state.products = data || [];
        renderCatalog();
      }catch(err){
        console.error(err);
        document.getElementById('loadMsg').textContent = 'Error loading products. Check RLS/keys.';
      }finally{
        document.getElementById('group-skeleton').classList.add('hidden');
      }
    }

    // ===== Catalog rendering (v4 shell) =====
    function renderCatalog(){
      const target = document.getElementById('catalog');
      target.innerHTML = '';
      const term = (document.getElementById('search').value||'').toLowerCase();
      const catFilter = document.getElementById('filterCat').value;
      const filtered = state.products.filter(p=>
        (!catFilter || p.category===catFilter) &&
        (!term || (p.name+ ' ' + (p.description||'')).toLowerCase().includes(term))
      );
      const byCat = {}; for(const p of filtered){ (byCat[p.category||'Other'] ||= []).push(p) }
      const order = ['Canton Style','Thousand Layers','Northern Style','Special Style'];
      const cats = Object.keys(byCat).sort((a,b)=>{ const ia=order.indexOf(a), ib=order.indexOf(b); if(ia!==-1&&ib!==-1) return ia-ib; if(ia!==-1) return -1; if(ib!==-1) return 1; return a.localeCompare(b) });
      for(const cat of cats){
        const sec=document.createElement('section'); sec.className='card p-5';
        sec.innerHTML = `<div class='flex items-center justify-between mb-3'><h3 class='text-lg font-semibold'>${cat}</h3></div>`;
        const grid=document.createElement('div'); grid.className='grid md:grid-cols-2 gap-4';
        for(const p of byCat[cat]){
          const row=document.createElement('div'); row.className='border border-white/10 rounded-xl p-4 flex items-center justify-between gap-3 bg-white/5';
          row.innerHTML=`
            <div class='min-w-0'>
              <div class='font-semibold truncate'>${p.name}</div>
              <div class='text-xs opacity-75 truncate'>${p.description||''}</div>
            </div>
            <div class='flex items-center gap-3'>
              <div class='text-right'><div class='font-bold'>${fmtUSD(p.price_cents)}</div></div>
              <div class='flex items-center gap-2'>
                <button class='btn-ghost px-3' aria-label='minus'>−</button>
                <input class='w-16 text-center rounded-md bg-white/10 border border-white/20 py-2' type='number' min='1' step='1' value='1'>
                <button class='btn-ghost px-3' aria-label='plus'>+</button>
                <button class='btn' aria-label='add'>Add</button>
                <a class='btn-ghost ${p.stripe_payment_link? '':'opacity-50 pointer-events-none'}' href='${p.stripe_payment_link||'#'}' target='_blank'>Buy Now</a>
              </div>
            </div>`;
          const q=row.querySelector('input');
          row.querySelector('[aria-label="minus"]').onclick=()=> q.value=Math.max(1,(+q.value||1)-1);
          row.querySelector('[aria-label="plus"]').onclick =()=> q.value=Math.max(1,(+q.value||1)+1);
          row.querySelector('[aria-label="add"]').onclick  =()=> addToCart(p, Math.max(1, parseInt(q.value||'1',10)));
          grid.appendChild(row);
        }
        sec.appendChild(grid); target.appendChild(sec);
      }
      if(!cats.length){ const empty=document.createElement('div'); empty.className='card p-5 text-sm'; empty.textContent='No products found.'; target.appendChild(empty) }
    }

    // ===== Cart (from v3 logic, adapted) =====
    function addToCart(p, qty){ if(qty<=0) return; const cur=state.cart.get(p.id)||{product:p,qty:0}; cur.qty+=qty; state.cart.set(p.id,cur); renderCart() }
    function totals(){ let qty=0,cents=0; for(const {product,qty:q} of state.cart.values()){ qty+=q; cents+=product.price_cents*q } return {qty,cents} }
    function renderCart(){
      const list=document.getElementById('cartList'); list.innerHTML=''; let itemsCents=0;
      for(const [id,it] of state.cart){ itemsCents += it.product.price_cents*it.qty; const row=document.createElement('div'); row.className='grid grid-cols-[1fr_auto_auto_auto] items-center gap-3 text-sm'; row.innerHTML=`
        <div class='font-medium truncate'>${it.product.name}</div>
        <div>${fmtUSD(it.product.price_cents)}</div>
        <div class='flex items-center gap-2'>
          <button class='btn-ghost px-2' aria-label='dec'>−</button>
          <input class='w-14 text-center bg-white/10 border border-white/20 rounded-md py-1.5' type='number' min='0' value='${it.qty}'>
          <button class='btn-ghost px-2' aria-label='inc'>+</button>
          <button class='btn-ghost px-3' aria-label='remove'>×</button>
        </div>
        <div class='text-right font-semibold'>${fmtUSD(it.product.price_cents*it.qty)}</div>`;
        const [dec,input,inc,rem]=row.querySelectorAll('button,input');
        const commit=v=>{ const n=parseInt(v,10); if(!n){ state.cart.delete(id)} else { it.qty=n; state.cart.set(id,it)} renderCart() }
        dec.onclick=()=>commit((it.qty|0)-1); inc.onclick=()=>commit((it.qty|0)+1); input.onchange=()=>commit(input.value); rem.onclick=()=>{ state.cart.delete(id); renderCart() };
        list.appendChild(row)
      }
      const shipCents=shipTotal(); const sum=itemsCents+shipCents; document.getElementById('sumItems').textContent=fmtUSD(itemsCents); document.getElementById('sumShipping').textContent=fmtUSD(shipCents); document.getElementById('sumTotal').textContent=fmtUSD(sum); document.getElementById('needAlloc').textContent=totals().qty;
    }

    // ===== Shipping (from v3 logic, adapted) =====
    function shipTotal(){ return state.ships.reduce((a,s)=> a + shipFeeFor(s.qty|0), 0) }
    function addShipRow(data={}){ const row={ name:data.name||'', address:data.address||'', city:data.city||'', state:data.state||'', zip:data.zip||'', qty:data.qty||0 }; state.ships.push(row); renderShip() }
    function removeShipRow(i){ state.ships.splice(i,1); renderShip() }
    function renderShip(){ const wrap=document.getElementById('shipRows'); if(!wrap) return; wrap.innerHTML=''; let alloc=0; state.ships.forEach((s,idx)=>{ alloc+=(s.qty|0); const el=document.createElement('div'); el.className='grid grid-cols-[1.2fr_1.8fr_.7fr_auto_auto] gap-2 items-center'; el.innerHTML=`
      <input class='px-3 py-2 bg-white/10 border border-white/20 rounded-md' placeholder='Recipient name' value='${s.name}'>
      <input class='px-3 py-2 bg-white/10 border border-white/20 rounded-md' placeholder='Address, City, State, ZIP' value='${[s.address,s.city,s.state,s.zip].filter(Boolean).join(', ')}'>
      <input class='px-3 py-2 bg-white/10 border border-white/20 rounded-md text-center' type='number' min='0' value='${s.qty}'>
      <div class='text-sm opacity-80'>Ship: <strong>${fmtUSD(shipFeeFor(s.qty))}</strong></div>
      <button class='btn-ghost' aria-label='remove'>Remove</button>`; const [n,a,q,,rm]=el.querySelectorAll('input,button'); n.oninput=()=> s.name=n.value; a.oninput=()=>{ const parts=a.value.split(',').map(x=>x.trim()); [s.address,s.city,s.state,s.zip]=[parts[0]||'',parts[1]||'',parts[2]||'',parts[3]||''] }; q.onchange=()=>{ s.qty=Math.max(0,parseInt(q.value||'0',10)); renderCart(); renderShip(); }; rm.onclick=()=> removeShipRow(idx); wrap.appendChild(el) }); document.getElementById('allocated').textContent=alloc; renderCart() }

    // ===== Reserve (save to Supabase + email + PDF) =====
    async function savePreorder(includeShipping=false){
      const name=document.getElementById('custName').value.trim(); if(!name){ alert('Please enter your name.'); return }
      if(state.cart.size===0){ alert('Add at least one item.'); return }
      const {qty}=totals(); if(qty%4!==0){ alert('Order quantity must be a multiple of 4.'); return }
      const phone=document.getElementById('custPhone').value.trim();
      const email=document.getElementById('custEmail').value.trim();
      const pickup_date=document.getElementById('pickupDate').value || null;
      const notes=document.getElementById('custNotes').value.trim();
      const status=document.getElementById('status'); status.textContent='Saving your preorder…';
      const { data: preorder, error: e1 } = await supabaseClient.from('mooncake_preorders').insert([{ customer_name:name, phone, email, pickup_date, notes }]).select().single();
      if(e1){ status.textContent='Error: '+e1.message; toast('Could not save order.'); return }
      const items = Array.from(state.cart.values()).map(i=>({ preorder_id:preorder.id, product_id:i.product.id, quantity:i.qty }));
      const { error:e2 } = await supabaseClient.from('mooncake_preorder_items').insert(items); if(e2){ status.textContent='Error: '+e2.message; toast('Could not save order items.'); return }
      if(includeShipping){ const ships = state.ships.filter(s=> (s.qty|0) > 0).map(s=>({ preorder_id:preorder.id, recipient_name:s.name, address:s.address, city:s.city, state:s.state, zip:s.zip, qty:s.qty, ship_cents:shipFeeFor(s.qty) })); if(ships.length){ const { error:e3 } = await supabaseClient.from('mooncake_preorder_shipments').insert(ships); if(e3){ status.textContent='Error (shipments): '+e3.message; toast('Could not save shipments.'); return } } }
      try{ await generateOrderPDF(preorder.id, name, email) }catch(err){ console.warn('PDF error',err) }
      try{ await fetch(SEND_EMAIL_ENDPOINT,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ order_id:preorder.id, customer:{ name, phone, email, pickup_date, notes }, items, shipments: state.ships }) }) }catch(err){ console.warn('send-email error',err) }
      state.cart.clear(); renderCart(); status.innerHTML=`✅ Preorder saved! Reference: <strong>${preorder.id}</strong>`; toast('Preorder saved. PDF downloaded.')
    }

    // ===== Stripe Checkout =====
    async function payWithStripe(){
      const {qty}=totals(); if(qty%4!==0){ alert('Order quantity must be a multiple of 4.'); return }
      const allocated = state.ships.reduce((a,r)=>a+(r.qty|0),0); if(allocated !== qty){ alert(`Allocate all items to shipping addresses. Allocated ${allocated} of ${qty}.`); return }
      const name=document.getElementById('custName').value.trim(); if(!name){ alert('Enter your name.'); return }
      const phone=document.getElementById('custPhone').value.trim(); const email=document.getElementById('custEmail').value.trim(); const pickup_date=document.getElementById('pickupDate').value || null; const notes=document.getElementById('custNotes').value.trim();
      const orderItems = Array.from(state.cart.values()).map(({product,qty})=>({ id:product.id, name:product.name, price_cents:product.price_cents, qty }));
      const shipments = state.ships.filter(s=> (s.qty|0) > 0).map(s=>({ name:s.name, address:s.address, city:s.city, state:s.state, zip:s.zip, qty:s.qty, ship_cents:shipFeeFor(s.qty) }));
      const btn=document.getElementById('btnPay'); btn.disabled=true; document.getElementById('status').textContent='Creating secure checkout…';
      try{
        const res = await fetch(CHECKOUT_FN,{ method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ customer:{ name, phone, email, pickup_date, notes }, items: orderItems, shipments }) });
        if(!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json(); if(data?.url){ window.location.href = data.url; return }
        throw new Error('No checkout URL returned');
      }catch(err){ console.error(err); document.getElementById('status').innerHTML='⚠️ Could not start checkout. Configure Edge Function `mooncake-checkout`.'; toast('Stripe checkout could not start.') }
      finally{ btn.disabled=false }
    }

    // ===== PDF (same as v3, adapted) =====
    async function generateOrderPDF(orderId, customerName, email){ const { jsPDF } = window.jspdf; const doc = new jsPDF({ unit:'pt', format:'letter' }); const logo='https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg'; try{ const img=await (await fetch(logo)).blob(); const dataUrl=await new Promise(r=>{ const fr=new FileReader(); fr.onload=()=>r(fr.result); fr.readAsDataURL(img); }); doc.addImage(dataUrl,'JPEG',40,28,90,54)}catch{} doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text('Mooncake Pre‑Order Summary',150,48); doc.setFont('helvetica',''); doc.setFontSize(11); doc.text(`Order #: ${orderId}`,150,68); doc.text(`Customer: ${customerName}`,150,84); if(email) doc.text(`Email: ${email}`,150,100); const items=Array.from(state.cart.values()).map(({product,qty})=>({ category:product.category||'Other', name:product.name, price:fmtUSD(product.price_cents), qty, line:fmtUSD(product.price_cents*qty) })); const byCat={}; items.forEach(i=>{ (byCat[i.category] ||= []).push(i) }); let startY=130; for(const cat of Object.keys(byCat)){ doc.setFont('helvetica','bold'); doc.text(cat,40,startY); startY+=6; doc.autoTable({ startY, head:[['Product','Price','Qty','Line Total']], body: byCat[cat].map(i=>[i.name,i.price,String(i.qty),i.line]), theme:'grid', styles:{ fontSize:10, cellPadding:4 }, headStyles:{ fillColor:[122,61,54] } }); startY = doc.lastAutoTable.finalY + 14 } const shipRows = state.ships.filter(s=> (s.qty|0) > 0).map(s=>[ s.name || '-', `${[s.address,s.city,s.state,s.zip].filter(Boolean).join(', ')}` || '-', String(s.qty), fmtUSD(shipFeeFor(s.qty)) ]); if(shipRows.length){ doc.setFont('helvetica','bold'); doc.text('Shipping',40,startY); startY+=6; doc.autoTable({ startY, head:[['Recipient','Address','Qty','Shipping']], body: shipRows, theme:'grid', styles:{ fontSize:10, cellPadding:4 }, headStyles:{ fillColor:[122,61,54] } }); startY = doc.lastAutoTable.finalY + 12 } const { cents:itemsCents } = totals(); const shipCents = state.ships.reduce((a,r)=> a + shipFeeFor(r.qty|0), 0); const total = itemsCents + shipCents; doc.setFont('helvetica','bold'); doc.text(`Items: ${fmtUSD(itemsCents)}  |  Shipping: ${fmtUSD(shipCents)}  |  Total: ${fmtUSD(total)}`,40,startY); doc.save(`mooncake-preorder-${orderId}.pdf`) }

    // ===== Step navigation =====
    function setStep(n){ state.step=n; document.getElementById('shipping').classList.toggle('hidden', n!==2); document.getElementById('review').classList.toggle('hidden', n!==3); document.getElementById('s1').setAttribute('data-active', n===1); document.getElementById('s2').setAttribute('data-active', n===2); document.getElementById('s3').setAttribute('data-active', n===3); document.getElementById('btnPay').classList.toggle('hidden', n!==3); renderShip(); renderCart(); renderReview() }
    function next(){ if(state.step===1){ if(state.cart.size===0){ alert('Add at least one item.'); return } const {qty}=totals(); if(qty%4!==0){ alert('Order quantity must be a multiple of 4.'); return } setStep(2) } else if(state.step===2){ setStep(3) } }
    function renderReview(){ if(state.step!==3) return; const box=document.getElementById('reviewList'); box.innerHTML=''; for(const {product,qty} of state.cart.values()){ const div=document.createElement('div'); div.className='flex justify-between'; div.innerHTML=`<span>${product.name} × ${qty}</span><span>${fmtUSD(product.price_cents*qty)}</span>`; box.appendChild(div) } const ship=document.createElement('div'); ship.className='mt-2 text-sm opacity-80'; ship.textContent = `Shipping addresses: ${state.ships.length}, Shipping total: ${fmtUSD(shipTotal())}`; box.appendChild(ship) }

    // ===== Wire buttons =====
    document.getElementById('btnNext').addEventListener('click', next);
    document.getElementById('btnReserve').addEventListener('click', ()=> savePreorder(true));
    document.getElementById('btnPay').addEventListener('click', payWithStripe);
    document.getElementById('btnAddShip').addEventListener('click', ()=> addShipRow());
    document.getElementById('btnReload').addEventListener('click', loadProducts);
    document.getElementById('btnDemo').addEventListener('click', ()=>{ state.products=[
      {id:'1',category:'Canton Style',name:'Lotus Seed (2 yolks)',description:'Classic lotus paste, double salted yolk',price_cents:1899},
      {id:'2',category:'Canton Style',name:'Red Bean',description:'Smooth red bean filling',price_cents:1699},
      {id:'3',category:'Northern Style',name:'Five‑Kernel & Roast Pork',description:'Hearty northern style',price_cents:1999},
      {id:'4',category:'Thousand Layers',name:'Taro Swirl',description:'Flaky purple taro layers',price_cents:1799}
    ]; renderCatalog(); });
    document.getElementById('search').addEventListener('input', renderCatalog);
    document.getElementById('filterCat').addEventListener('change', renderCatalog);

    // ===== Init =====
    document.getElementById('y').textContent = new Date().getFullYear();
    addShipRow(); // start with one address
    renderCart();
    loadProducts();
  </script>
</body>
</html>
