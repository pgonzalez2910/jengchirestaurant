x<!DOCTYPE html>
<html lang="en">
<head>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Executive Employee Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .card {
      background-color: #fff;
      border-radius: 1rem;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
    }
    .profile-image {
      width: 8rem;
      height: 8rem;
      border-radius: 50%;
      background: #3b82f6;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 600;
      letter-spacing: -2px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1.5rem 0;
    }
    .glossy-text {
      background: linear-gradient(to right, #4a4a4a, #1a1a1a, #4a4a4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pdf-viewer-container {
      display: none !important;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .pdf-viewer-container.active {
        display: flex !important;
    }

  

.brand {
  height: clamp(61px, 9.8vw, 101px);
}

.main-title {
  margin: 0;
  font-weight: 800;
  letter-spacing: .5px;
  font-size: clamp(16px, 2.6vw, 22px);
  background: linear-gradient(180deg, #000, #575757);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
}

.logo {
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
}
    header {
  background: transparent !important;
  box-shadow: none !important;
  border: none !important;
}


  </style>
</head>

<body class="bg-gray-50 min-h-screen flex flex-col">
<!-- Header -->
<header class="w-full bg-transparent shadow-none pt-0">

  <div class="center-wrap flex flex-col items-center">
    <img 
      src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
      alt="Jeng Chi Logo"
       class="brand logo mt-0 mb-2 w-44"
    />
<h1 class="text-xl font-bold text-gray-800 mb-12">
  Jeng Chi Human Resource Management
</h1>

<!-- Search Section -->
<p class="text-center font-semibold text-gray-700 mb-4">
  Search for an employee to view their profile.
</p>
<div class="w-full max-w-md">
  <input 
    type="text" 
    id="searchInput" 
    placeholder="Search by name..." 
    class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all duration-200" 
    autocomplete="off"
  />
  
  <div id="suggestions" 
       class="absolute w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg z-10 hidden">
  </div>

  <p id="statusMessage" class="text-center text-sm text-gray-500 mt-4"></p>
</div>

<!-- 👇 Moved OUTSIDE max-w-md -->
<div id="employeeProfile" 
     class="bg-white shadow rounded-lg p-8 max-w-6xl w-full mt-8 hidden">
  <p id="statusMessage" class="text-center text-sm text-gray-500 mt-4"></p>
</div>

</header>



   <!-- HR History + Preview -->
  <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
    <!-- History list -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="font-bold mb-4">HR History</h3>
      <div class="grid grid-cols-3 gap-4 mb-6">
        <div class="p-4 bg-gray-50 rounded text-center">
          <p class="text-xl font-bold text-blue-600" id="verbalCount">0</p>
          <p class="text-gray-600">Verbal Warnings</p>
        </div>
        <div class="p-4 bg-gray-50 rounded text-center">
          <p class="text-xl font-bold text-yellow-600" id="writtenCount">0</p>
          <p class="text-gray-600">Written Warnings</p>
        </div>
        <div class="p-4 bg-gray-50 rounded text-center">
          <p class="text-xl font-bold text-red-600" id="terminationCount">0</p>
          <p class="text-gray-600">Terminations</p>
        </div>
      </div>
      <div id="hrHistoryContainer" class="space-y-2"></div>
    </div>
     <!-- Preview panel -->
    <div class="bg-white shadow rounded-lg p-6">
      <h3 class="font-bold mb-4">Preview</h3>
      <div id="documentPreview" class="text-sm text-gray-700">
        Select a document to preview it here.
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="bg-white shadow rounded-lg p-6 text-center">
    <h3 class="font-bold mb-4">Create New Document</h3>
    <div class="flex flex-wrap justify-center gap-3">
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showVerbalWarningForm">Verbal Warning</button>
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showWrittenWarningForm">Written Warning</button>
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showTerminationForm">Termination</button>
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showResignationForm">Resignation</button>
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showTwoWeeksNoticeForm">Two Weeks Notice</button>
      <button class="px-4 py-2 bg-gray-100 hover:bg-gray-200 rounded" id="showTemplateForm"> Templates </button>

    </div>
  </div>

   <!-- Dynamic Forms Container -->
  <div id="form-container" class="hidden mt-6 bg-white shadow rounded-lg p-6"></div>

    
  <!-- PDF Preview Modal -->
  <div id="pdf-viewer-container" class="pdf-viewer-container">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 relative">
      <!-- Close Button -->
      <button onclick="closePdfViewer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
        ✕
      </button>
      <h3 class="text-xl font-bold mb-4 text-gray-800">Preview Document</h3>
      <!-- PDF Content -->
      <iframe id="pdf-viewer" class="w-full h-[600px] border rounded-lg shadow-inner bg-gray-50 mb-6"></iframe>
      <!-- Actions -->
      <div class="flex justify-end space-x-4">
        <button onclick="printPdf()" class="px-6 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800">🖨 Print</button>
        <button onclick="downloadPdf()" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">⬇ Download</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { jsPDF } = window.jspdf;

    const searchInput = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    
    const statusMessageDiv = document.getElementById('statusMessage');
    const formContainer = document.getElementById('form-container');
    const hrHistoryContainer = document.getElementById('hrHistoryContainer');


    const pdfViewerContainer = document.getElementById('pdf-viewer-container');
    const pdfViewer = document.getElementById('pdf-viewer');
    const employeeProfileDiv = document.getElementById('employeeProfile');

    let employees = [];
    let selectedEmployee = null;
    let fetchedDocuments = [];
    let generatedPdf = null;
    const managers = ["Anh Mai Vu", "Pablo Gonzalez", "Janelle Teng", "Craig Reeves", "Shoko Teng","Franciso Teng"];
    const witnessNames = ["Pablo Gonzalez", "Craig Reeves", "Francisco Teng", "Janelle Teng", "Anh Mai Vu", "Shoko Teng"];
    const departments = ["BOH", "FOH","ADMIN"];
    let positions = [];
    
    async function loadEmployees() {
      statusMessageDiv.textContent = 'Loading employee data...';
      const { data, error } = await supabase.from('employees').select('id, full_name, "Current Reports To Employee", primary_role, department, email, phone, hire_date');
      if (error) {
        console.error('Error fetching employees:', error);
        statusMessageDiv.textContent = 'Error loading data. Please try again.';
        return;
      }
      employees = data || [];
      const uniquePositions = new Set(employees.map(emp => emp.primary_role).filter(role => role));
      positions = Array.from(uniquePositions).sort();
      
      // Add Host and Cashier as requested
      if (!positions.includes("Host")) positions.push("Host");
      if (!positions.includes("Cashier")) positions.push("Cashier");
      positions.sort();
      
      statusMessageDiv.textContent = 'Data loaded successfully!';
      setTimeout(() => statusMessageDiv.textContent = '', 2000);
    }
    
    function getInitials(name) {
      if (!name) return '';
      const parts = name.split(' ').filter(part => part.length > 0);
      if (parts.length > 1) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      } else if (parts.length === 1) {
        return parts[0][0].toUpperCase();
      }
      return '';
    }

    function showSuggestions(query) {
      suggestionsDiv.innerHTML = '';
      if (!query) {
        suggestionsDiv.classList.add('hidden');
        return;
      }
      const matches = employees.filter(emp => emp.full_name && emp.full_name.toLowerCase().includes(query.toLowerCase()));
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<p class="p-4 text-gray-400 italic">No suggestions found.</p>';
        suggestionsDiv.classList.remove('hidden');
        return;
      }
      matches.forEach(emp => {
        const div = document.createElement('div');
        div.textContent = emp.full_name;
        div.className = 'px-5 py-3 cursor-pointer hover:bg-gray-100 rounded-lg';
        div.onclick = () => {
          showEmployeeProfile(emp);
          searchInput.value = emp.full_name; // Keep the full name in the input
        };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.classList.remove('hidden');
    }

  
function showEmployeeProfile(employee) {
  suggestionsDiv.classList.add('hidden');
  selectedEmployee = employee;
  const profileDiv = document.getElementById('employeeProfile');
  profileDiv.classList.remove('hidden'); 
   // 🔹 Reset PDF preview whenever switching employee
  pdfViewerContainer.classList.remove("active");
  pdfViewer.src = "";

const hireDateForInput = employee.hire_date || '';

const reportsToOptions = managers.map(manager => {
  const isSelected = manager === employee['Current Reports To Employee'] ? 'selected' : '';
  return `<option value="${manager}" ${isSelected}>${manager}</option>`;
}).join('');

const departmentOptions = departments.map(dep => {
  const isSelected = dep === employee.department ? 'selected' : '';
  return `<option value="${dep}" ${isSelected}>${dep}</option>`;
}).join('');

const positionOptions = positions.map(pos => {
  const isSelected = pos === employee.primary_role ? 'selected' : '';
  return `<option value="${pos}" ${isSelected}>${pos}</option>`;
}).join('');

document.getElementById('employeeProfile').innerHTML = `
  <form id="updateEmployeeForm" class="space-y-10 text-left max-w-7xl mx-auto">
  <div class="grid grid-cols-1 md:grid-cols-2 gap-x-12 gap-y-8">

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Full Name</label>
      <input type="text" name="full_name" value="${employee.full_name || ''}"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Position</label>
      <select name="primary_role"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
        ${positionOptions}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
      <select name="department"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
        ${departmentOptions}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Hire Date</label>
      <input type="date" name="hire_date" value="${hireDateForInput}"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
    </div>

    <!-- Email FULL ROW -->
    <div class="md:col-span-2">
      <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
      <input type="email" name="email" value="${employee.email || ''}"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
    </div>

    <!-- Phone FULL ROW -->
    <div class="md:col-span-2">
      <label class="block text-sm font-medium text-gray-700 mb-2">Phone Number</label>
      <input type="tel" name="phone" value="${employee.phone || ''}"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Reports To</label>
      <select id="reportsToSelect" name="Current Reports To Employee"
        class="w-full px-4 py-3 border rounded-lg focus:ring focus:ring-blue-200">
        ${reportsToOptions}
      </select>
    </div>

    <div>
      <label class="block text-sm font-medium text-gray-700 mb-2">Manager's Role</label>
      <p id="reportsToRole" class="mt-3 text-gray-900 font-semibold">
        ${getRole(employee['Current Reports To Employee']) || 'N/A'}
      </p>
    </div>
  </div>

  <div class="flex justify-center mt-10">
    <button type="submit"
      class="px-10 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700 text-lg">
      Update Profile
    </button>
  </div>

  <p id="updateStatusMessage" class="mt-4 text-center text-sm"></p>
</form>
`;

// Attach listener for profile update
document.getElementById('updateEmployeeForm').addEventListener('submit', handleUpdate);

// Update role dynamically when "Reports To" changes
document.getElementById('reportsToSelect').addEventListener('change', (e) => {
  const managerName = e.target.value;
  document.getElementById('reportsToRole').textContent = getRole(managerName) || 'N/A';
});


  loadDocuments();
}


    async function handleUpdate(e) {
      e.preventDefault();
      const form = e.target;
      const statusMessage = document.getElementById('updateStatusMessage');

      const updatedData = {
        full_name: form.elements['full_name'].value,
        "Current Reports To Employee": form.elements['Current Reports To Employee'].value,
        primary_role: form.elements['primary_role'].value,
        department: form.elements['department'].value,
        email: form.elements['email'].value,
        phone: form.elements['phone'].value,
        hire_date: form.elements['hire_date'].value,
      };

      statusMessage.textContent = 'Updating...';
      statusMessage.className = 'mt-4 text-sm text-gray-500';
      
      const { data, error } = await supabase
        .from('employees')
        .update(updatedData)
        .eq('id', selectedEmployee.id);
      
      if (error) {
        console.error('Update failed:', error);
        statusMessage.textContent = `Error updating: ${error.message}`;
        statusMessage.className = 'mt-4 text-sm text-red-500';
      } else {
        statusMessage.textContent = 'Profile updated successfully!';
        statusMessage.className = 'mt-4 text-sm text-green-600';
        await loadEmployees();
        selectedEmployee = employees.find(emp => emp.id === selectedEmployee.id);
        showEmployeeProfile(selectedEmployee);
      }
    }

    function showForm(type) {
      if (!selectedEmployee) {
        return;
      }

      formContainer.classList.remove('hidden');
      const formTitle = type;
      const today = new Date().toISOString().split('T')[0];
      const witnessOptions = witnessNames.map(name => `<option value="${name}">${name}</option>`).join('');

      let formHtml = '';
      if (type === 'Verbal Warning' || type === 'Written Warning') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Manager's Name</label>
              <input type="text" name="manager_name" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
             <div>
              <label class="block text-sm font-medium text-gray-700">Witness's Name</label>
              <select name="witness_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity50">${witnessOptions}</select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Subject</label>
              <textarea name="subject" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Statement of the Problem</label>
              <textarea name="statement_of_problem" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Reference to Prior Warnings</label>
              <textarea name="prior_warnings" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Company Policy</label>
              <textarea name="company_policy" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Corrective Action and Expectations</label>
              <textarea name="corrective_action" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Timeline for Improvement</label>
              <textarea name="timeline" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Consequences of Failure</label>
              <textarea name="consequences" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Employee Comments</label>
              <textarea name="employee_comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" id="previewPdfBtn">Preview PDF</button>
<button type="submit" 
        class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold" id="saveToDbBtn">
  Save to Database
</button>

            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" id="requestSigBtn">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
     } else if (type === 'Termination') {
  formHtml = `
    <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
    
    <!-- New Termination Checklist -->
    <div class="space-y-4 mb-8">
      <h4 class="text-lg font-bold text-gray-800">Termination Checklist</h4>
      <p class="text-sm text-gray-500">Please answer the following questions to ensure proper procedure.</p>
      
      <!-- Question 1 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">1. Was there a specific incident close in time to the discharge?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q1" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 2 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">2. Can the employer show that the employee violated a known policy or law?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q2" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 3 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">3. Are witnesses available?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q3" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 4 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">4. Does the employer have documentation to support its reasons for termination?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q4" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 5 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">5. Did the employee progress all the way through the disciplinary system?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q5" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 6 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">6. Was the employee confronted with the problem and given a chance to explain?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q6" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 7 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">7. Does the employee belong to a protected minority?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q7" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 8 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">8. Was the treatment given to the employee different from that given to non-minorities?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q8" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 9 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">9. Was the treatment given to the employee different from that given to other workers in general?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q9" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 10 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">10. Was the employee involved in a protected activity?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q10" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
    </div>
    <!-- End New Termination Checklist -->

    <!-- Termination Letter Fields -->

<!-- Termination Effective Date -->
<div class="mb-4">
  <label class="block font-semibold">Termination Effective Date</label>
  <div class="flex space-x-2">
    <input 
      type="number" 
      name="termination_day" 
      placeholder="Day (e.g. 15)" 
      min="1" max="31"
      class="w-1/3 border rounded-md p-2"
    />
    <input 
      type="text" 
      name="termination_month" 
      placeholder="Month (e.g. April)" 
      class="w-1/3 border rounded-md p-2"
    />
    <input 
      type="number" 
      name="termination_year" 
      placeholder="Year (e.g. 2025)" 
      min="2000" max="2100"
      class="w-1/3 border rounded-md p-2"
    />
  </div>
</div>



<!-- Reason & Basis -->
<div>
  <label class="block text-sm font-medium text-gray-700">Reason for Termination</label>
  <textarea name="reason" rows="2" class="w-full border rounded-md p-2"></textarea>
</div>

<div>
  <label class="block text-sm font-medium text-gray-700">Basis for Termination</label>
  <textarea name="basis" rows="2" class="w-full border rounded-md p-2"></textarea>
</div>
<div>
  
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Effective Date</label>
        <input type="date" name="effective_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Paycheck Date</label>
        <input type="date" name="final_pay_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Paycheck Amount</label>
        <input type="text" name="final_pay_amount" placeholder="$____" class="w-full border rounded-md p-2">
      </div>
      <div>
      <div class="mb-4">
  <label class="block font-semibold">In the next payroll cycle will be:</label>
  <div class="flex space-x-2">
    <input 
      type="number" 
      name="next_cycle_day" 
      placeholder="Day" 
      min="1" max="31"
      class="w-1/3 border rounded-md p-2"
    />
    <input 
      type="text" 
      name="next_cycle_month" 
      placeholder="Month (e.g. April)" 
      class="w-1/3 border rounded-md p-2"
    />
    <input 
      type="number" 
      name="next_cycle_year" 
      placeholder="Year" 
      min="2000" max="2100"
      class="w-1/3 border rounded-md p-2"
    />
  </div>
</div>

        <label class="block text-sm font-medium text-gray-700">Insurance End Date</label>
        <input type="date" name="insurance_end" class="w-full border rounded-md p-2">
      </div>
     <!-- Verbal Warnings -->
<div>
  <label for="numVerbalWarnings" class="block text-sm font-medium text-gray-700">Number of Verbal Warnings</label>
  <input type="number" id="numVerbalWarnings" name="numVerbalWarnings" min="0" value="0"
         class="w-full border rounded-md p-2" />
  <div id="verbalWarningsContainer" class="mt-2 space-y-2"></div>
</div>

<!-- Written Warnings -->
<div>
  <label for="numWrittenWarnings" class="block text-sm font-medium text-gray-700">Number of Written Warnings</label>
  <input type="number" id="numWrittenWarnings" name="numWrittenWarnings" min="0" value="0"
         class="w-full border rounded-md p-2" />
  <div id="writtenWarningsContainer" class="mt-2 space-y-2"></div>
</div>

        <label class="block text-sm font-medium text-gray-700">Initial Warning Date</label>
        <input type="date" name="initial_warning_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Pay Delivery Method</label>
        <select name="delivery_method" class="w-full border rounded-md p-2">
          <option value="">-- Select --</option>
          <option>Pick up in person</option>
          <option>Hand delivery</option>
          <option>Direct deposit</option>
          <option>By mail</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Mailing Address</label>
        <textarea name="mailing_address" rows="2" class="w-full border rounded-md p-2"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Company Property to Return</label>
        <textarea name="property" rows="2" class="w-full border rounded-md p-2" placeholder="Keys, uniforms, devices..."></textarea>
      </div>

<div class="flex items-center mt-4">
  <input type="checkbox" name="acknowledgment" class="mr-2">
  <label class="text-sm text-gray-700">I acknowledge receipt of this termination letter</label>
</div>

      <div>
        <label class="block text-sm font-medium text-gray-700">Manager Signature</label>
        <input type="text" name="manager_signature" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="w-full border rounded-md p-2">
      </div>
    </div>
    <div>
<div>
  <label class="block text-sm font-medium text-gray-700">Witness Name</label>
  <select name="witness_name" class="w-full border rounded-md p-2">
    <option value="">-- Select Witness --</option>
    <option value="Janelle Teng">Janelle Teng</option>
    <option value="Shoko Teng">Shoko Teng</option>
    <option value="Francisco Teng">Francisco Teng</option>
    <option value="Pablo Gonzalez">Pablo Gonzalez</option>
    <option value="Craig Reeves">Craig Reeves</option>
    <option value="Anh Mai Vu">Anh Mai Vu</option>
  </select>
</div>

<div>
  <label class="block text-sm font-medium text-gray-700">Witness Role</label>
  <input type="text" name="witness_role" readonly 
         class="w-full border rounded-md p-2 bg-gray-100" 
         placeholder="(auto-filled)">
</div>


    <div class="mt-6 flex justify-center space-x-4">
      <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700" id="previewTerminationPdfBtn">Preview PDF</button>
      <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700" id="saveTerminationToDbBtn">Save to Database</button>
      <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700" id="requestTerminationSigBtn">Request Signature</button>
    </div>
    <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>

    
  `;
setTimeout(() => {
  const witnessSelect = document.querySelector('select[name="witness_name"]');
  const witnessRoleInput = document.querySelector('input[name="witness_role"]');
  
  if (witnessSelect) {
    witnessSelect.addEventListener("change", (e) => {
      const selected = employees.find(emp => emp.full_name === e.target.value);
      witnessRoleInput.value = selected ? selected.primary_role : "";
    });
  }
}, 0);


     } else if (type === 'Resignation' || type === 'Two Weeks Notice') {
  formHtml = `
    <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
    <p class="text-gray-600 mb-4">
      This document is a template. You can generate and download the PDF, but it will not be saved in the system.
    </p>
    <div class="mt-6 flex justify-center space-x-4">
      <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700"
        id="previewResignationPdfBtn">Preview PDF</button>
      <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700"
        id="requestResignationSigBtn">Request Signature</button>
    </div>
  `;
}

   formContainer.innerHTML = `<form id="documentForm" data-form-type="${type}">${formHtml}</form>`;
   const form = document.getElementById('documentForm');

   // Set up event listeners based on the form type
   if (type === 'Verbal Warning' || type === 'Written Warning') {
     document.getElementById('previewPdfBtn').addEventListener('click', () => generatePdfFromForm(type));
     form.addEventListener('submit', (e) => saveDocument(e, type));
     document.getElementById('requestSigBtn').addEventListener('click', requestSignature);
   } else if (type === 'Termination') {
     document.getElementById('previewTerminationPdfBtn').addEventListener('click', handleTerminationPreview);
     form.addEventListener('submit', (e) => saveDocument(e, type));
     document.getElementById('requestTerminationSigBtn').addEventListener('click', requestSignature);

     // Attach listeners for warnings after form is inserted into DOM
     const verbalInput = document.getElementById("numVerbalWarnings");
     if (verbalInput) {
       verbalInput.addEventListener("input", function () {
         const container = document.getElementById("verbalWarningsContainer");
         container.innerHTML = "";
         const count = parseInt(this.value) || 0;
         for (let i = 1; i <= count; i++) {
           container.innerHTML += `
             <input type="date" name="verbal_warning_date_${i}" class="w-full border rounded-md p-2" />
           `;
         }
       });
     }

     const writtenInput = document.getElementById("numWrittenWarnings");
     if (writtenInput) {
       writtenInput.addEventListener("input", function () {
         const container = document.getElementById("writtenWarningsContainer");
         container.innerHTML = "";
         const count = parseInt(this.value) || 0;
         for (let i = 1; i <= count; i++) {
           container.innerHTML += `
             <input type="date" name="written_warning_date_${i}" class="w-full border rounded-md p-2" />
            `;
           }
         });
       }

   } else if (type === 'Resignation' || type === 'Two Weeks Notice') {
     document.getElementById('previewResignationPdfBtn').addEventListener('click', () => generatePdfFromForm(type));
     document.getElementById('requestResignationSigBtn').addEventListener('click', requestSignature);
   }

}


function handleTerminationPreview() {
  const form = document.getElementById('documentForm');

  const formData = {
    // 🔹 Employee Info
    fullName: selectedEmployee.full_name,
    role: selectedEmployee.primary_role,
    department: selectedEmployee.department,
    hireDate: formatDate(selectedEmployee.hire_date),
    email: selectedEmployee.email,
    phone: selectedEmployee.phone,

    // 🔹 Manager & Witness
    managerName: form.elements['manager_signature']?.value || selectedEmployee['Current Reports To Employee'] || '',
    managerRole: getRole(form.elements['manager_signature']?.value || selectedEmployee['Current Reports To Employee']),
    witnessName: form.elements['witness_name']?.value || '',
    witnessRole: form.elements['witness_role']?.value || '',

    // 🔹 Termination details
    effectiveDate: `${form.elements['termination_month']?.value || ''} ${form.elements['termination_day']?.value || ''}, ${form.elements['termination_year']?.value || ''}`,
    reason: form.elements['reason']?.value || '',
    basis: form.elements['basis']?.value || '',

    finalPayDate: form.elements['final_pay_date']?.value || '',
    finalPayAmount: form.elements['final_pay_amount']?.value || '',
    nextCycle: `${form.elements['next_cycle_month']?.value || ''} ${form.elements['next_cycle_day']?.value || ''}, ${form.elements['next_cycle_year']?.value || ''}`,
    deliveryMethod: form.elements['delivery_method']?.value || '',
    mailingAddress: form.elements['mailing_address']?.value || '',
    property: form.elements['property']?.value || '',

    // 🔹 Warnings
    verbalCount: form.elements['numVerbalWarnings']?.value || 0,
    verbalWarnings: Array.from(document.querySelectorAll('[name^="verbal_warning_date_"]')).map(input => ({
      date: input.value, note: '', manager: ''
    })),
    writtenCount: form.elements['numWrittenWarnings']?.value || 0,
    writtenWarnings: Array.from(document.querySelectorAll('[name^="written_warning_date_"]')).map(input => ({
      date: input.value, note: '', manager: ''
    })),
    initialWarningDate: form.elements['initial_warning_date']?.value || '',

    // 🔹 Checklist
    checklist: [
      { question: 'Was there a specific incident close in time to the discharge?', ans: form.querySelector('input[name="q1"]:checked')?.value || '', notes: form.elements['notes_q1']?.value || '' },
      { question: 'Can the employer show that the employee violated a known policy or law?', ans: form.querySelector('input[name="q2"]:checked')?.value || '', notes: form.elements['notes_q2']?.value || '' },
      { question: 'Are witnesses available?', ans: form.querySelector('input[name="q3"]:checked')?.value || '', notes: form.elements['notes_q3']?.value || '' },
      { question: 'Does the employer have documentation to support its reasons for termination?', ans: form.querySelector('input[name="q4"]:checked')?.value || '', notes: form.elements['notes_q4']?.value || '' },
      { question: 'Did the employee progress all the way through the disciplinary system?', ans: form.querySelector('input[name="q5"]:checked')?.value || '', notes: form.elements['notes_q5']?.value || '' },
      { question: 'Was the employee confronted with the problem and given a chance to explain?', ans: form.querySelector('input[name="q6"]:checked')?.value || '', notes: form.elements['notes_q6']?.value || '' },
      { question: 'Does the employee belong to a protected minority?', ans: form.querySelector('input[name="q7"]:checked')?.value || '', notes: form.elements['notes_q7']?.value || '' },
      { question: 'Was the treatment given to the employee different from that given to non-minorities?', ans: form.querySelector('input[name="q8"]:checked')?.value || '', notes: form.elements['notes_q8']?.value || '' },
      { question: 'Was the treatment given to the employee different from that given to other workers in general?', ans: form.querySelector('input[name="q9"]:checked')?.value || '', notes: form.elements['notes_q9']?.value || '' },
      { question: 'Was the employee involved in a protected activity?', ans: form.querySelector('input[name="q10"]:checked')?.value || '', notes: form.elements['notes_q10']?.value || '' }
    ]
  };

  generateTerminationPdf(formData);
}

      
    

  
    
    
    function requestSignature() {
        const signatureModal = `
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]">
                <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full text-center relative">
                    <button onclick="closeSignatureModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-2xl font-bold mb-4">Signature Request</h3>
                    <p class="text-gray-600 mb-6">In a live application, this would send an email to the employee to securely sign the document electronically. A backend service is required for this action.</p>
                    <div class="flex justify-center">
                        <button onclick="closeSignatureModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', signatureModal);
    }
    
    function closeSignatureModal() {
      const modal = document.querySelector('.fixed.inset-0.bg-gray-900');
      if (modal) {
        modal.remove();
      }
    }
    
    // --- Document Generation ---
    function formatHireDate(dateString) {
      if (!dateString) return '';
      const [year, month, day] = dateString.split('-');
      return `${month}/${day}/${year}`;
    }

    function generateDocumentHtml(type, formData) {
      const companyLogoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg?raw=true";

      const employeeName = selectedEmployee.full_name;
      const employeeRole = selectedEmployee.primary_role || "";
      const employeeDept = selectedEmployee.department || "";
      const hireDate = formatHireDate(selectedEmployee.hire_date) || "";
      const managerName = formData.manager_name || "";
      const witnessName = formData.witness_name || "";
      const companyAddress = "400 N. Greenville Ave Ste 11, Richardson, TX 75081";
      const companyPhone = "(972) 669-9094";
      const companyEmail = "admin@jengchirestaurant.com";
      const currentDate = new Date(formData.document_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let documentBody = '';

      switch(type) {
        case 'Verbal Warning':
        case 'Written Warning':
          documentBody = `
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                <tr>
                    <td style="width: 25%; font-weight: bold;">Date:</td>
                    <td>${currentDate}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employee’s Name:</td>
                    <td>${employeeName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employee’s Title:</td>
                    <td>${employeeRole}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Manager's Name:</td>
                    <td>${managerName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Witness's Name:</td>
                    <td>${witnessName}</td>
                </tr>
            </table>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Subject:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.subject}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Statement of the Problem:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.statement_of_problem}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Reference to Prior Warnings:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.prior_warnings}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Company Policy:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.company_policy}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Corrective Action and Expectations:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.corrective_action}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Timeline for Improvement:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.timeline}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Consequences of Failure:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.consequences}</p>

            <div style="margin-top: 2rem;">
                <p style="font-weight: bold;">Employee Comments:</p>
                <p style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 100px;">${formData.employee_comments}</p>
            </div>
            
            <div style="margin-top: 3rem;">
                <p>Employee Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Manager Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Witness Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
            </div>
          `;
          break;
        case 'Termination':
          documentBody = `
            <!-- New Checklist -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 14pt; font-weight: bold; margin-bottom: 1rem;">Termination Checklist</h3>
              <ul style="list-style-type: none; padding-left: 0;">
            ${formData.checklist.map(item => `
  <li style="margin-bottom: 1rem;">
    <p style="font-weight: bold; margin-bottom: 0.25rem;">${item.q}</p>
    <p>Answer: ${item.ans}</p>
    ${item.notes ? `<p>Notes: ${item.notes}</p>` : ''}
  </li>
`).join('')}


              </ul>
            </div>

            <p><strong>Date:</strong> ${currentDate}</p>
            <p><strong>Subject:</strong> Notice of Termination</p>
            <br>
            <p>Dear ${employeeName},</p>
            <br>
            <p>This letter is to inform you that your employment with Jeng Chi is being terminated, effective immediately. This decision is based on a series of documented performance issues and policy violations, as detailed below. This action is final and not subject to further review.</p>
            <br>
            <p><strong>Reason for Termination:</strong></p>
            <p style="white-space: pre-wrap;">${formData.statement_of_problem}</p>
            <br>
            <p><strong>Final Payment:</strong></p>
            <p>Your final paycheck, including all earned wages and accrued benefits, will be sent to the address on file by ${formData.timeline}.</p>
            <br>
            <p>We wish you the best in your future endeavors.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${managerName}</p>
            <p>Manager</p>
            <br><br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Resignation':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi HR,</p>
            <br>
            <p>This letter is to formally notify you of my resignation from my position as ${employeeRole}, effective today, ${currentDate}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Two Weeks Notice':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi Management,</p>
            <br>
            <p>Please accept this letter as formal notification of my resignation from my position as ${employeeRole}. My last day of employment will be two weeks from today, ${new Date(new Date().setDate(new Date().getDate() + 14)).toLocaleDateString('en-US')}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi. I wish the company continued success.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
      }


      return `
        <div class="document-template-content">
          <div style="text-align: center; margin-bottom: 2rem;">
              <img src="${companyLogoUrl}" alt="Company Logo"
     crossorigin="anonymous"
     style="width: 150px; margin-bottom: 1rem;">

              <h2 style="font-size: 24pt; text-align: center; font-weight: bold; margin-bottom: 2rem;">${type}</h2>
          </div>
          ${documentBody}
          <div style="position: absolute; bottom: 1rem; left: 0; right: 0; text-align: center; font-size: 10pt;">
              <hr style="border: none; border-top: 1px solid #ccc; margin-bottom: 0.5rem;">
              <p>${companyAddress} | ${companyPhone} | ${companyEmail}</p>
          </div>
        </div>
      `;
    }

function generateTerminationPdf(formData) {
  const doc = new jsPDF("p", "pt", "letter");
  const pageWidth = doc.internal.pageSize.getWidth();

  // --- LOGO + TITLE ---
  const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
  doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 50, 20, 100, 70);

  doc.setFont("helvetica", "bold").setFontSize(16);
  doc.text("TERMINATION LETTER", pageWidth / 2, 110, { align: "center" });

  // --- EMPLOYEE & MANAGEMENT INFO ---
  if (doc.autoTable) {
    doc.autoTable({
      startY: 140,
      head: [["Employee Information", "Management & Witness"]],
      body: [[
        `Full Name: ${formData.fullName || "____"}\nPosition: ${formData.role || "____"}\nDepartment: ${formData.department || "____"}\nHire Date: ${formData.hireDate || "____"}\nEmail: ${formData.email || "____"}\nPhone: ${formData.phone || "____"}`,
        `Manager: ${formData.managerName || "____"} (${formData.managerRole || "____"})\nWitness: ${formData.witnessName || "____"} (${formData.witnessRole || "____"})`
      ]],
      styles: { fontSize: 10, cellPadding: 5, valign: "top" }
    });
  }

  let y = doc.lastAutoTable.finalY + 30;

  // --- TERMINATION NOTICE ---
  doc.setFont("helvetica", "bold");
  doc.text("This letter serves to formally notify you that your employment with Jeng Chi Restaurant will be terminated effective:", 40, y);
  y += 20;
  doc.setFont("helvetica", "normal");
  doc.text(formData.effectiveDate || "____", 60, y);

  // --- REASON ---
  y += 40;
  doc.setFont("helvetica", "bold");
  doc.text("Reason for Termination", 40, y);
  y += 20;
  doc.setFont("helvetica", "normal");
  doc.text(formData.reason || "____", 40, y, { maxWidth: pageWidth - 80 });

  // --- BASIS ---
  y += 50;
  doc.setFont("helvetica", "bold");
  doc.text("Basis for Termination", 40, y);
  y += 20;
  doc.setFont("helvetica", "normal");
  doc.text(formData.basis || "____", 40, y, { maxWidth: pageWidth - 80 });

  // --- WARNINGS ---
  y += 50;
  doc.setFont("helvetica", "bold");
  doc.text(`Number of Verbal Warnings: ${formData.verbalCount || 0}`, 40, y);
  y += 20;
  if (formData.verbalWarnings?.length) {
    doc.autoTable({
      startY: y,
      head: [["Date", "Description", "Manager/Witness"]],
      body: formData.verbalWarnings.map(w => [w.date, w.note, w.manager]),
      styles: { fontSize: 9 }
    });
    y = doc.lastAutoTable.finalY + 20;
  }

  doc.setFont("helvetica", "bold");
  doc.text(`Number of Written Warnings: ${formData.writtenCount || 0}`, 40, y);
  y += 20;
  if (formData.writtenWarnings?.length) {
    doc.autoTable({
      startY: y,
      head: [["Date", "Description", "Manager/Witness"]],
      body: formData.writtenWarnings.map(w => [w.date, w.note, w.manager]),
      styles: { fontSize: 9 }
    });
    y = doc.lastAutoTable.finalY + 20;
  }

  // --- FINAL PAY INFO ---
  y += 30;
  doc.setFont("helvetica", "bold");
  doc.text("Initial Warning Date:", 40, y);
  doc.text("Final Paycheck Date:", 40, y + 15);
  doc.text("Final Paycheck Amount:", 40, y + 30);
  doc.text("In the next payroll cycle will be:", 40, y + 45);

  doc.setFont("helvetica", "normal");
  doc.text(formData.initialWarningDate || "____", 250, y);
  doc.text(formData.finalPayDate || "____", 250, y + 15);
  doc.text(formData.finalPayAmount || "____", 250, y + 30);
  doc.text(formData.nextCycle || "____", 250, y + 45);
  y += 70;

  // --- DELIVERY METHOD ---
  doc.setFont("helvetica", "bold");
  doc.text("Final Pay Delivery Method:", 40, y);
  y += 20;
  ["Pick Up in Person", "Hand Delivery", "Direct Deposit", "Mail"].forEach((method, i) => {
    doc.rect(50, y + i * 20, 10, 10);
    if (formData.deliveryMethod === method) {
      doc.text("✓", 52, y + i * 20 + 8);
    }
    doc.setFont("helvetica", "normal");
    doc.text(method, 70, y + i * 20 + 8);
  });
  y += 100;

  // --- MAILING & PROPERTY ---
  doc.setFont("helvetica", "bold");
  doc.text("Mailing Address:", 40, y);
  doc.setFont("helvetica", "normal");
  doc.text(formData.mailingAddress || "____", 180, y);
  y += 30;

  doc.setFont("helvetica", "bold");
  doc.text("Company Property to Return:", 40, y);
  doc.setFont("helvetica", "normal");
  doc.text(formData.property || "____", 250, y);
  y += 40;

  // --- CHECKLIST ---
  if (formData.checklist?.length) {
    formData.checklist.forEach((q, i) => {
      doc.setFont("helvetica", "bold");
      doc.text(`${i + 1}. ${q.question}`, 40, y);
      y += 15;
      doc.setFont("helvetica", "normal");
      doc.text(`Answer: ${q.ans}`, 60, y);
      y += 15;
      if (q.notes) {
        doc.text(`Notes: ${q.notes}`, 60, y);
        y += 25;
      } else {
        y += 15;
      }
    });
  }

  // --- ACKNOWLEDGMENT ---
  y += 30;
  doc.rect(40, y, 10, 10);
  doc.text("I acknowledge receipt of this termination letter", 60, y + 8);
  y += 50;

  // --- SIGNATURES ---
  doc.autoTable({
    startY: y,
    head: [["Employee", "Manager", "Witness"]],
    body: [[
      "____________________\n" + (formData.fullName || "Employee") + "\n" + (formData.role || "Role"),
      "____________________\n" + (formData.managerName || "Manager") + "\n" + (formData.managerRole || "Role"),
      "____________________\n" + (formData.witnessName || "Witness") + "\n" + (formData.witnessRole || "Role"),
    ]],
    styles: { halign: "center", fontSize: 10 },
  });

  // --- FOOTER ---
  addFooter(doc);

  // --- PREVIEW ---
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);
  pdfViewer.src = pdfUrl;
  pdfViewerContainer.classList.add("active");
  generatedPdf = doc;

  return doc;
}






    



// --- Helpers ---
function addSectionHeader(doc, title, y, margin) {
  doc.setFont("helvetica", "bold").setFontSize(12).text(title, margin, y);
  return y + 20;
}

function addFooter(doc) {
  const pageCount = doc.internal.getNumberOfPages();

  for (let i = 1; i <= pageCount; i++) {
    doc.setPage(i);

    // Get size for each page
    const pageWidth = doc.internal.pageSize.getWidth();
    const pageHeight = doc.internal.pageSize.getHeight();

    // Draw footer line
    doc.setDrawColor(200);
    doc.line(40, pageHeight - 60, pageWidth - 40, pageHeight - 60);

    // Footer text
    doc.setFont("helvetica", "normal").setFontSize(9);
    doc.text(
      "Jeng Chi Restaurant • 400 N. Greenville Ave Ste 11, Richardson, TX 75081 • admin@jengchirestaurant.com",
      pageWidth / 2,
      pageHeight - 45,
      { align: "center" }
    );

    // Page numbers
    doc.setFont("helvetica", "italic");
    doc.text(`Page ${i} of ${pageCount}`, pageWidth - 60, pageHeight - 30);
  }
}

    
function generatePdf(type, formData) {
  const doc = new jsPDF('p', 'pt', 'letter');
  const pageWidth = doc.internal.pageSize.getWidth();
  const pageHeight = doc.internal.pageSize.getHeight();
  let y = 60;

  // --- Logo + Title ---
  const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
  doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 40, y, 80, 60);
  y += 80;
  doc.setFontSize(16).setFont("helvetica", "bold");
  doc.text(type, pageWidth / 2, y, { align: "center" });
  y += 40;

  // --- Employee / Manager / Witness Info ---
  doc.setFontSize(11).setFont("helvetica", "normal");
  const leftColX = 40;
  const rightColX = pageWidth / 2 + 20;

  doc.text(`Full Name: ${selectedEmployee.full_name}`, leftColX, y);
  doc.text(`Position: ${selectedEmployee.primary_role}`, leftColX, y + 16);
  doc.text(`Department: ${selectedEmployee.department || ''}`, leftColX, y + 32);
  doc.text(`Hire Date: ${formatDate(selectedEmployee.hire_date)}`, leftColX, y + 48);
  doc.text(`Email: ${selectedEmployee.email || ''}`, leftColX, y + 64);
  doc.text(`Phone: ${selectedEmployee.phone || ''}`, leftColX, y + 80);

  doc.text(`Manager: ${formData.manager_name} (${getRole(formData.manager_name)})`, rightColX, y);
  doc.text(`Witness: ${formData.witness_name} (${getRole(formData.witness_name)})`, rightColX, y + 16);
  y += 110;

  // --- Section Writer Helper ---
  function addSection(title, content) {
    if (!content) return;
    const requiredSpace = 100;
    if (y > pageHeight - 180) { // ✅ leave 2.5 inches
      addFooter(doc);
      doc.addPage();
      y = 80;
    }
    doc.setFont("helvetica", "bold").setFontSize(12);
    doc.text(title, leftColX, y);
    const titleWidth = doc.getTextWidth(title);
    doc.line(leftColX, y + 2, leftColX + titleWidth, y + 2);
    y += 18;
    doc.setFont("helvetica", "normal").setFontSize(11);
    const lines = doc.splitTextToSize(content, pageWidth - 80);
    doc.text(lines, leftColX, y, { align: "left", maxWidth: pageWidth - 80 });
    y += lines.length * 16 + 24;
  }

  // --- Termination Checklist ---
  if (type === "Termination" && formData.checklist) {
    const checklistItems = Object.keys(formData.checklist).map(q => {
      const item = formData.checklist[q];
      return `${q}: ${item.answer} \nNotes: ${item.notes || 'N/A'}`;
    }).join('\n\n');
    addSection("Termination Checklist:", checklistItems);
  }

  // --- Warnings Section (only for Verbal/Written) ---
  if (type === "Verbal Warning" || type === "Written Warning") {
    doc.setFont("helvetica", "bold").setFontSize(12);
    doc.text("Warnings Record", leftColX, y);
    y += 20;

    doc.setFont("helvetica", "normal").setFontSize(11);

    let allWarnings = [];

    const numVerbal = parseInt(formData.numVerbalWarnings || 0);
    for (let i = 1; i <= numVerbal; i++) {
      const date = formData[`verbal_warning_date_${i}`];
      if (date) allWarnings.push({ type: "Verbal", date });
    }

    const numWritten = parseInt(formData.numWrittenWarnings || 0);
    for (let i = 1; i <= numWritten; i++) {
      const date = formData[`written_warning_date_${i}`];
      if (date) allWarnings.push({ type: "Written", date });
    }

    if (allWarnings.length > 0) {
      allWarnings.forEach((w) => {
        if (y > pageHeight - 180) {
          addFooter(doc);
          doc.addPage();
          y = 80;
        }
        doc.text(`☐ ${w.type} Warning (Date: ${w.date})`, leftColX + 20, y);
        y += 20;
      });

      if (y > pageHeight - 180) {
        addFooter(doc);
        doc.addPage();
        y = 80;
      }
      doc.text(`The initial warning related to this matter was issued on ${allWarnings[0].date}.`, leftColX + 20, y);
      y += 30;
    } else {
      doc.text("No warnings recorded.", leftColX + 20, y);
      y += 20;
    }
  }

  // --- Add Remaining Sections ---
  addSection("Subject:", formData.subject);
  addSection("Statement of the Problem:", formData.statement_of_problem);
  addSection("Reference to Prior Warnings:", formData.prior_warnings);
  addSection("Company Policy:", formData.company_policy);
  addSection("Corrective Action and Expectations:", formData.corrective_action);
  addSection("Timeline for Improvement:", formData.timeline);
  addSection("Consequences of Failure:", formData.consequences);
  addSection("Employee Comments:", formData.employee_comments);

  // --- Signature Section ---
  if (y > pageHeight - 200) {
    addFooter(doc);
    doc.addPage();
    y = 80;
  }
  y += 40;
  const colWidth = (pageWidth - 80) / 2;
  const sigY = y;

  function signatureBlock(label, name, role, x, yPos) {
    doc.setFont("helvetica", "normal").setFontSize(11);
    doc.line(x, yPos, x + colWidth - 40, yPos);
    doc.setFont("helvetica", "bold").setFontSize(10);
    doc.text(label, x, yPos + 15);
    doc.setFont("helvetica", "normal").setFontSize(10);
    doc.text(`${name} (${role})`, x, yPos + 30);
  }

  signatureBlock("Employee Signature", selectedEmployee.full_name, selectedEmployee.primary_role, leftColX, sigY);
  signatureBlock("Manager Signature", formData.manager_name, getRole(formData.manager_name), leftColX + colWidth, sigY);
  const witnessX = pageWidth / 2 - colWidth / 2;
  signatureBlock("Witness Signature", formData.witness_name, getRole(formData.witness_name), witnessX, sigY + 100);

  // --- Footer with Page Numbers ---
  addFooter(doc);

  // --- Render PDF ---
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);
  pdfViewer.src = pdfUrl;
  pdfViewerContainer.classList.add("active");
  generatedPdf = doc;
  return doc;
}

    
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  return `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}/${d.getFullYear()}`;
}

function getRole(name) {
  if (!name) return ""; // prevent crash
  const emp = employees.find(e => e.full_name === name);
  return emp ? emp.primary_role : "";
}


    searchInput.addEventListener('input', e => showSuggestions(e.target.value));
    window.onload = loadEmployees;

    document.getElementById('showVerbalWarningForm').addEventListener('click', () => showForm('Verbal Warning'));
    document.getElementById('showWrittenWarningForm').addEventListener('click', () => showForm('Written Warning'));
    document.getElementById('showTerminationForm').addEventListener('click', () => showForm('Termination'));
    document.getElementById('showResignationForm').addEventListener('click', () => showForm('Resignation'));
    document.getElementById('showTwoWeeksNoticeForm').addEventListener('click', () => showForm('Two Weeks Notice'));
    
    // Listen for events on the form container using event delegation
   // Listen for events on the form container using event delegation
formContainer.addEventListener('click', (e) => {
  const button = e.target;
  const form = document.getElementById('documentForm');
  const type = form.dataset.formType;

  if (button.id === 'previewPdfBtn') {
    generatePdfFromForm(type);
  } else if (button.id === 'previewTerminationPdfBtn') {
    handleTerminationPreview();
  } else if (button.id === 'previewResignationPdfBtn') {
    generatePdfFromForm(type);
  } else if (button.id === 'requestSigBtn' || button.id === 'requestTerminationSigBtn' || button.id === 'requestResignationSigBtn') {
    requestSignature();
  }
});


    formContainer.addEventListener('submit', (e) => {
      const form = e.target;
      const type = form.dataset.formType;
      if (e.target.id === 'documentForm') {
        saveDocument(e, type);
      }
    });

    async function saveDocument(e, type) {
  e.preventDefault();
  const form = document.getElementById('documentForm');
  const statusMessage = document.getElementById('formStatusMessage');

  // ✅ Defensive check for selected employee
  if (!selectedEmployee) {
    console.error("No employee selected.");
    statusMessage.textContent = "Please select an employee first.";
    statusMessage.className = 'mt-4 text-sm text-red-500';
    return;
  }

  // --- Build formData with safe fallbacks ---
  const formData = {};
  
  if (type === "Verbal Warning" || type === "Written Warning") {
    formData.manager_name = form.elements['manager_name']?.value || selectedEmployee['Current Reports To Employee'] || '';
    formData.witness_name = form.elements['witness_name']?.value || '';
    formData.document_date = form.elements['document_date']?.value || '';
    formData.subject = form.elements['subject']?.value || '';
    formData.statement_of_problem = form.elements['statement_of_problem']?.value || '';
    formData.prior_warnings = form.elements['prior_warnings']?.value || '';
    formData.company_policy = form.elements['company_policy']?.value || '';
    formData.corrective_action = form.elements['corrective_action']?.value || '';
    formData.timeline = form.elements['timeline']?.value || '';
    formData.consequences = form.elements['consequences']?.value || '';
    formData.employee_comments = form.elements['employee_comments']?.value || '';
  } else if (type === "Termination") {
    formData.manager_name = form.elements['manager_signature']?.value || selectedEmployee['Current Reports To Employee'] || '';
    formData.reason = form.elements['reason']?.value || '';
    formData.basis = form.elements['basis']?.value || '';
    formData.property = form.elements['property']?.value || '';
    formData.effective_date = form.elements['effective_date']?.value || '';
    formData.final_pay_date = form.elements['final_pay_date']?.value || '';
    formData.final_pay_amount = form.elements['final_pay_amount']?.value || '';
    formData.insurance_end = form.elements['insurance_end']?.value || '';
    formData.delivery_method = form.elements['delivery_method']?.value || '';
    formData.mailing_address = form.elements['mailing_address']?.value || '';
    formData.acknowledgment = form.elements['acknowledgment']?.checked ? "Acknowledged" : "Not acknowledged";
    
    // Checklist
   const checklistQuestions = [
  "Was there a specific incident close in time to the discharge?",
  "Can the employer show that the employee violated a known policy or law?",
  "Are witnesses available?",
  "Does the employer have documentation to support its reasons for termination?",
  "Did the employee progress all the way through the disciplinary system?",
  "Was the employee confronted with the problem and given a chance to explain?",
  "Does the employee belong to a protected minority?",
  "Was the treatment given to the employee different from that given to non-minorities?",
  "Was the treatment given to the employee different from that given to other workers in general?",
  "Was the employee involved in a protected activity?"
];

formData.checklist = checklistQuestions.map((q, i) => {
  const ans = form.querySelector(`input[name="q${i+1}"]:checked`)?.value || '';
  const notes = form.querySelector(`textarea[name="notes_q${i+1}"]`)?.value || '';
  return { question: q, ans, notes };
});


    // Warnings
    const allWarnings = [];
    const numVerbal = parseInt(form.elements['numVerbalWarnings']?.value || 0);
    for (let i = 1; i <= numVerbal; i++) {
      const date = form.elements[`verbal_warning_date_${i}`]?.value;
      if (date) allWarnings.push({ type: "Verbal", date });
    }
    const numWritten = parseInt(form.elements['numWrittenWarnings']?.value || 0);
    for (let i = 1; i <= numWritten; i++) {
      const date = form.elements[`written_warning_date_${i}`]?.value;
      if (date) allWarnings.push({ type: "Written", date });
    }
    formData.allWarnings = allWarnings;
    formData.initial_warning_date = allWarnings.length > 0 ? allWarnings[0].date : "";
    
    // Other PDF required fields
    formData.employee_name = selectedEmployee.full_name;
    formData.employee_role = selectedEmployee.primary_role;
    formData.employee_department = selectedEmployee.department;
    formData.hire_date = selectedEmployee.hire_date;
    formData.reports_to = selectedEmployee['Current Reports To Employee'];
    formData.witness_name = '';
    formData.manager_role = getRole(formData.manager_name);
    formData.document_date = formData.effective_date || new Date().toISOString().split('T')[0];
    formData.termination_day = form.elements['termination_day']?.value || "";
    formData.termination_month = form.elements['termination_month']?.value || "";
    formData.termination_year = form.elements['termination_year']?.value || "";

    if (Object.keys(formData.checklist).length !== 10) {
      statusMessage.textContent = "Please complete all checklist items before saving.";
      statusMessage.className = 'mt-4 text-sm text-red-500';
      return;
    }
  }

  // --- Save summary for display ---
  const summary = (formData.subject || formData.employee_comments || `Termination of employment effective ${formData.effective_date}`)?.substring(0, 100) + '...' || "(no subject)";

  // --- Choose table ---
  const tableName = type === "Termination" ? "termination_records" : "records";

  // --- Build payload ---
  const payload = {
    employee_id: selectedEmployee.id,
    document_type: type,
    summary,
    content: formData
  };

  console.log("Saving payload:", payload);

  // --- Save to Supabase ---
  const { data, error } = await supabase.from(tableName).insert([payload]);

  if (error) {
    console.error("Supabase Save Error:", error);
    statusMessage.textContent = `Error saving record: ${error.message}`;
    statusMessage.className = 'mt-4 text-sm text-red-500';
  } else {
    statusMessage.textContent = 'Document saved successfully!';
    statusMessage.className = 'mt-4 text-sm text-green-600';
    loadDocuments();
  }
}

    
    async function loadDocuments() {
  if (!selectedEmployee) {
    hrHistoryContainer.innerHTML = '<p class="text-center text-gray-500">Please select an employee.</p>';
    return;
  }
  hrHistoryContainer.innerHTML = '<p class="text-center text-gray-500">Loading documents... <span class="loading-spinner"></span></p>';

  try {
    // Fetch from both tables
    const { data: records, error: error1 } = await supabase
      .from('records')
      .select('*')
      .eq('employee_id', selectedEmployee.id);

    const { data: terminations, error: error2 } = await supabase
      .from('termination_records')
      .select('*')
      .eq('employee_id', selectedEmployee.id);

    if (error1) throw error1;
    if (error2) throw error2;

    // Merge both sets
    let allDocs = [...(records || []), ...(terminations || [])];

    // Sort newest → oldest
    allDocs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    fetchedDocuments = allDocs;

    // Update counters
let verbalCount = allDocs.filter(d => d.document_type === "Verbal Warning").length;
let writtenCount = allDocs.filter(d => d.document_type === "Written Warning").length;
let terminationCount = allDocs.filter(d => d.document_type === "Termination").length;

// ✅ Update the counters in the top HR History
document.getElementById("verbalCount").textContent = verbalCount;
document.getElementById("writtenCount").textContent = writtenCount;
document.getElementById("terminationCount").textContent = terminationCount;
 // ✅ Render clickable list
    if (allDocs.length === 0) {
      hrHistoryContainer.innerHTML = `<p class="text-center text-gray-500">No documents found for ${selectedEmployee.full_name}.</p>`;
      return;
    }
  hrHistoryContainer.innerHTML = allDocs.map((doc, index) => `
      <div 
        class="p-3 border rounded cursor-pointer hover:bg-gray-100 transition"
        data-index="${index}"
      >
        <p class="font-medium text-gray-800">${doc.document_type}</p>
        <p class="text-xs text-gray-500">${new Date(doc.created_at).toLocaleDateString()} — ${doc.summary || '(no subject)'}</p>
      </div>
    `).join('');

    hrHistoryContainer.querySelectorAll('div[data-index]').forEach(div => {
        div.addEventListener('click', (e) => {
            const index = e.currentTarget.dataset.index;
            viewDocument(index);
        });
    });


  } catch (err) {
    console.error('Error fetching documents:', err);
    hrHistoryContainer.innerHTML = `<p class="text-center text-red-500">Error loading documents: ${err.message}</p>`;
  }
}
    
 function viewDocument(index) {
  const docRecord = fetchedDocuments[index];
  if (!docRecord) {
    console.error("Document not found at index:", index);
    return;
  }

  // Parse the saved content (JSONB from Supabase)
  const formData = docRecord.content || {};

  // Restore type + data into PDF generator
  let doc;
  if (docRecord.document_type === "Termination") {
    doc = generateTerminationPdf(formData); 
  } else {
    doc = generatePdf(docRecord.document_type, formData);
  }
  
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);

  document.getElementById("documentPreview").innerHTML = `
    <iframe src="${pdfUrl}" class="w-full h-[400px] border rounded"></iframe>
  `;
}
function generateBlankTemplate(type) {
  const doc = new jsPDF("p", "pt", "letter");
  const pageWidth = doc.internal.pageSize.getWidth();
  const margin = 50;
  let y = 80;

  // Logo
  const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
  doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 40, 20, 80, 60);

  // Title
  doc.setFont("helvetica", "bold").setFontSize(16);
  doc.text(`${type.toUpperCase()} TEMPLATE`, pageWidth / 2, y, { align: "center" });
  y += 40;

  // Helper: Draw a line field
  function lineField(label, gap = 40) {
    doc.setFont("helvetica", "bold").setFontSize(11);
    doc.text(label, margin, y);
    y += 15;
    doc.setFont("helvetica", "normal").setFontSize(11);
    doc.line(margin, y, pageWidth - margin, y); // blank line
    y += gap;
  }

  // Fields by type
  if (type === "Verbal Warning" || type === "Written Warning") {
    lineField("Date:");
    lineField("Employee’s Name:");
    lineField("Employee’s Title:");
    lineField("Manager’s Name:");
    lineField("Witness’s Name:");
    lineField("Subject:");
    lineField("Statement of the Problem:", 60);
    lineField("Reference to Prior Warnings:", 60);
    lineField("Company Policy:", 60);
    lineField("Corrective Action and Expectations:", 60);
    lineField("Timeline for Improvement:", 60);
    lineField("Consequences of Failure:", 60);
    lineField("Employee Comments:", 60);

    // Signatures
    y += 40;
    doc.text("Employee Signature: _________________________", margin, y);
    y += 30;
    doc.text("Manager Signature: _________________________", margin, y);
    y += 30;
    doc.text("Witness Signature: _________________________", margin, y);

  } else if (type === "Termination") {
    lineField("Termination Effective Date:");
    lineField("Employee’s Name:");
    lineField("Employee’s Title:");
    lineField("Department:");
    lineField("Manager’s Name:");
    lineField("Reason for Termination:", 60);
    lineField("Basis for Termination:", 60);
    lineField("Final Paycheck Date:");
    lineField("Final Paycheck Amount:");
    lineField("Insurance End Date:");
    lineField("Mailing Address:", 60);
    lineField("Company Property to Return:", 60);

    // Signatures
    y += 40;
    doc.text("Employee Signature: _________________________", margin, y);
    y += 30;
    doc.text("Manager Signature: _________________________", margin, y);
    y += 30;
    doc.text("Witness Signature: _________________________", margin, y);
  }

  // Footer
  doc.setFont("helvetica", "italic").setFontSize(9);
  doc.text(
    "Jeng Chi Restaurant • 400 N. Greenville Ave Ste 11, Richardson, TX 75081 • admin@jengchirestaurant.com",
    pageWidth / 2, 780, { align: "center" }
  );

  // Show PDF preview
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);
  pdfViewer.src = pdfUrl;
  pdfViewerContainer.classList.add("active");
  generatedPdf = doc;
}

function closePdfModal() {
  document.getElementById("pdfModal").classList.add("hidden");
}

  document.getElementById("showTemplateForm").addEventListener("click", () => {
  formContainer.classList.remove("hidden");
  formContainer.innerHTML = `
    <h3 class="text-xl font-bold mb-6">Print Templates</h3>
    <p class="text-gray-600 mb-4">Choose a blank template to print and fill out by hand.</p>
    <div class="flex flex-wrap gap-4">
      <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700"
        onclick="generateBlankTemplate('Verbal Warning')">Verbal Warning</button>
      <button type="button" class="px-6 py-3 bg-yellow-600 text-white rounded-lg shadow hover:bg-yellow-700"
        onclick="generateBlankTemplate('Written Warning')">Written Warning</button>
      <button type="button" class="px-6 py-3 bg-red-600 text-white rounded-lg shadow hover:bg-red-700"
        onclick="generateBlankTemplate('Termination')">Termination</button>
    </div>
  `;
});


function closePdfViewer() {
  const pdfViewerContainer = document.getElementById("pdf-viewer-container");
  if (pdfViewerContainer) {
    pdfViewerContainer.classList.remove("active"); // hide modal
    document.getElementById("pdf-viewer").src = ""; // clear iframe
  }
}


  </script>




  
</body>
</html>




































