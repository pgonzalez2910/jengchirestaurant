<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Executive Employee Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .card {
      background-color: #fff;
      border-radius: 1rem;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
    }
    .profile-image {
      width: 8rem;
      height: 8rem;
      border-radius: 50%;
      background: #3b82f6;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 600;
      letter-spacing: -2px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1.5rem 0;
    }
    .glossy-text {
      background: linear-gradient(to right, #4a4a4a, #1a1a1a, #4a4a4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pdf-viewer-container {
      display: none !important;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .pdf-viewer-container.active {
        display: flex !important;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Company Logo -->
    <div class="flex flex-col items-center justify-center mb-8">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jengchi Logo" class="w-48 rounded-xl">
      <!-- New Title -->
      <h2 class="text-3xl font-bold text-center mt-6 glossy-text">Jeng Chi Human Resource Management</h2>
    </div>

    <!-- Main Content Container -->
    <div id="main-content">
      <!-- Search Section -->
      <div id="search-section">
        <p class="text-center text-gray-500 mb-8">Search for an employee to view their profile.</p>
        <div class="mb-6 relative">
          <input type="text" id="searchInput" placeholder="Search by name..." class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all duration-200" autocomplete="off" />
          <div id="suggestions" class="absolute w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg z-10 hidden"></div>
        </div>
        <div id="statusMessage" class="text-center text-gray-500 mt-8"></div>
      </div>
      
      <!-- Employee Profile and Document Forms Section -->
      <div id="employee-forms-container" class="hidden">
        <div id="employeeProfile"></div>
        <div class="divider"></div>
        <div class="flex flex-col items-center">
            <p class="text-center text-gray-500 mb-8">Select a document to create a new HR form for <span id="selectedEmployeeName" class="font-semibold text-gray-800"></span>.</p>
            <div class="flex flex-wrap justify-center gap-2 mb-8">
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Verbal Warning')">Verbal Warning</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Written Warning')">Written Warning</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Termination')">Termination</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Resignation')">Resignation</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Two Weeks Notice')">Two Weeks Notice</button>
            </div>
            <div id="form-container"></div>
            <div id="documents-list-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Preview Modal -->
  <div id="pdf-viewer-container" class="pdf-viewer-container">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 relative">
      <!-- Close Button -->
      <button onclick="closePdfViewer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
        ✕
      </button>
      <h3 class="text-xl font-bold mb-4 text-gray-800">Preview Document</h3>
      <!-- PDF Content -->
      <iframe id="pdf-viewer" class="w-full h-[600px] border rounded-lg shadow-inner bg-gray-50 mb-6"></iframe>
      <!-- Actions -->
      <div class="flex justify-end space-x-4">
        <button onclick="printPdf()" class="px-6 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800">🖨 Print</button>
        <button onclick="downloadPdf()" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">⬇ Download</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { jsPDF } = window.jspdf;

    const searchInput = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    const employeeFormsContainer = document.getElementById('employee-forms-container');
    const employeeProfileDiv = document.getElementById('employeeProfile');
    const statusMessageDiv = document.getElementById('statusMessage');
    const formContainer = document.getElementById('form-container');
    const documentsListContainer = document.getElementById('documents-list-container');
    const selectedEmployeeNameSpan = document.getElementById('selectedEmployeeName');
    const pdfViewerContainer = document.getElementById('pdf-viewer-container');
    const pdfViewer = document.getElementById('pdf-viewer');

    let employees = [];
    let selectedEmployee = null;
    let fetchedDocuments = [];
    let generatedPdf = null;
    const managers = ["Mai Vu", "Pablo Gonzalez", "Janelle Teng", "Craig Reeves", "Shoko Teng"];
    const witnessNames = ["Pablo Gonzalez", "Craig Reeves", "Francisco Teng", "Janelle Teng", "Mai Vu", "Shoko Teng"];
    const departments = ["BOH", "FOH"];
    let positions = [];
    
    async function loadEmployees() {
      statusMessageDiv.textContent = 'Loading employee data...';
      const { data, error } = await supabase.from('employees').select('id, full_name, "Current Reports To Employee", primary_role, department, email, phone, hire_date');
      if (error) {
        console.error('Error fetching employees:', error);
        statusMessageDiv.textContent = 'Error loading data. Please try again.';
        return;
      }
      employees = data || [];
      const uniquePositions = new Set(employees.map(emp => emp.primary_role).filter(role => role));
      positions = Array.from(uniquePositions).sort();
      
      // Add Host and Cashier as requested
      if (!positions.includes("Host")) positions.push("Host");
      if (!positions.includes("Cashier")) positions.push("Cashier");
      positions.sort();
      
      statusMessageDiv.textContent = 'Data loaded successfully!';
      setTimeout(() => statusMessageDiv.textContent = '', 2000);
    }
    
    function getInitials(name) {
      if (!name) return '';
      const parts = name.split(' ').filter(part => part.length > 0);
      if (parts.length > 1) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      } else if (parts.length === 1) {
        return parts[0][0].toUpperCase();
      }
      return '';
    }

    function showSuggestions(query) {
      suggestionsDiv.innerHTML = '';
      if (!query) {
        suggestionsDiv.classList.add('hidden');
        return;
      }
      const matches = employees.filter(emp => emp.full_name && emp.full_name.toLowerCase().includes(query.toLowerCase()));
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<p class="p-4 text-gray-400 italic">No suggestions found.</p>';
        suggestionsDiv.classList.remove('hidden');
        return;
      }
      matches.forEach(emp => {
        const div = document.createElement('div');
        div.textContent = emp.full_name;
        div.className = 'px-5 py-3 cursor-pointer hover:bg-gray-100 rounded-lg';
        div.onclick = () => {
          showEmployeeProfile(emp);
          searchInput.value = emp.full_name; // Keep the full name in the input
        };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.classList.remove('hidden');
    }

  
function showEmployeeProfile(employee) {
  suggestionsDiv.classList.add('hidden');
  selectedEmployee = employee;
  employeeFormsContainer.classList.remove('hidden');
  selectedEmployeeNameSpan.textContent = selectedEmployee.full_name;
  formContainer.innerHTML = '';
  documentsListContainer.innerHTML = '';

  const hireDateForInput = employee.hire_date || '';

  const reportsToOptions = managers.map(manager => {
    const isSelected = manager === employee['Current Reports To Employee'] ? 'selected' : '';
    return `<option value="${manager}" ${isSelected}>${manager}</option>`;
  }).join('');

  const departmentOptions = departments.map(dep => {
    const isSelected = dep === employee.department ? 'selected' : '';
    return `<option value="${dep}" ${isSelected}>${dep}</option>`;
  }).join('');

  const positionOptions = positions.map(pos => {
    const isSelected = pos === employee.primary_role ? 'selected' : '';
    return `<option value="${pos}" ${isSelected}>${pos}</option>`;
  }).join('');

  // ✅ Wrap everything in a <form id="updateEmployeeForm">
  employeeProfileDiv.innerHTML = `
    <form id="updateEmployeeForm" class="space-y-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6">
        <div>
          <label class="block text-sm font-medium text-gray-700">Full Name</label>
          <input type="text" name="full_name" value="${employee.full_name || ''}" class="w-full px-4 py-2 border rounded-md">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Position</label>
          <select name="primary_role" class="w-full px-4 py-2 border rounded-md">${positionOptions}</select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Department</label>
          <select name="department" class="w-full px-4 py-2 border rounded-md">${departmentOptions}</select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Hire Date</label>
          <input type="date" name="hire_date" value="${hireDateForInput}" class="w-full px-4 py-2 border rounded-md">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Email Address</label>
          <input type="email" name="email" value="${employee.email || ''}" class="w-full px-4 py-2 border rounded-md">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Phone Number</label>
          <input type="tel" name="phone" value="${employee.phone || ''}" class="w-full px-4 py-2 border rounded-md">
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Reports To</label>
          <select id="reportsToSelect" name="Current Reports To Employee" class="w-full px-4 py-2 border rounded-md">${reportsToOptions}</select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700">Manager's Role</label>
          <p id="reportsToRole" class="mt-2 text-gray-900 font-semibold">${getRole(employee['Current Reports To Employee']) || 'N/A'}</p>
        </div>
      </div>

      <div class="flex justify-center mt-6">
        <button type="submit" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">Update Profile</button>
      </div>
      <p id="updateStatusMessage" class="mt-4 text-center text-sm"></p>
    </form>
  `;

  // ✅ Attach event listener AFTER injecting the form
  document.getElementById('updateEmployeeForm').addEventListener('submit', handleUpdate);

  // ✅ Add change listener to update role dynamically
  document.getElementById('reportsToSelect').addEventListener('change', (e) => {
    const managerName = e.target.value;
    document.getElementById('reportsToRole').textContent = getRole(managerName) || 'N/A';
  });

  loadDocuments();
}

    async function handleUpdate(e) {
      e.preventDefault();
      const form = e.target;
      const statusMessage = document.getElementById('updateStatusMessage');

      const updatedData = {
        full_name: form.elements['full_name'].value,
        "Current Reports To Employee": form.elements['Current Reports To Employee'].value,
        primary_role: form.elements['primary_role'].value,
        department: form.elements['department'].value,
        email: form.elements['email'].value,
        phone: form.elements['phone'].value,
        hire_date: form.elements['hire_date'].value,
      };

      statusMessage.textContent = 'Updating...';
      statusMessage.className = 'mt-4 text-sm text-gray-500';
      
      const { data, error } = await supabase
        .from('employees')
        .update(updatedData)
        .eq('id', selectedEmployee.id);
      
      if (error) {
        console.error('Update failed:', error);
        statusMessage.textContent = `Error updating: ${error.message}`;
        statusMessage.className = 'mt-4 text-sm text-red-500';
      } else {
        statusMessage.textContent = 'Profile updated successfully!';
        statusMessage.className = 'mt-4 text-sm text-green-600';
        await loadEmployees();
        selectedEmployee = employees.find(emp => emp.id === selectedEmployee.id);
        showEmployeeProfile(selectedEmployee);
      }
    }

    function showForm(type) {
      if (!selectedEmployee) {
        return;
      }

      formContainer.classList.remove('hidden');
      const formTitle = type;
      const today = new Date().toISOString().split('T')[0];
      const witnessOptions = witnessNames.map(name => `<option value="${name}">${name}</option>`).join('');

      let formHtml = '';
      if (type === 'Verbal Warning' || type === 'Written Warning') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Manager's Name</label>
              <input type="text" name="manager_name" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
             <div>
              <label class="block text-sm font-medium text-gray-700">Witness's Name</label>
              <select name="witness_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity50">${witnessOptions}</select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Subject</label>
              <textarea name="subject" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Statement of the Problem</label>
              <textarea name="statement_of_problem" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Reference to Prior Warnings</label>
              <textarea name="prior_warnings" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Company Policy</label>
              <textarea name="company_policy" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Corrective Action and Expectations</label>
              <textarea name="corrective_action" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Timeline for Improvement</label>
              <textarea name="timeline" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Consequences of Failure</label>
              <textarea name="consequences" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Employee Comments</label>
              <textarea name="employee_comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" onclick="generatePdfFromForm('${type}')">Preview PDF</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold" onclick="saveDocument(event, '${type}')">Save to Database</button>
            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" onclick="requestSignature()">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
     } else if (type === 'Termination') {
  formHtml = `
    <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
    
    <!-- New Termination Checklist -->
    <div class="space-y-4 mb-8">
      <h4 class="text-lg font-bold text-gray-800">Termination Checklist</h4>
      <p class="text-sm text-gray-500">Please answer the following questions to ensure proper procedure.</p>
      
      <!-- Question 1 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">1. Was there a specific incident close in time to the discharge?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q1" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q1" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 2 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">2. Can the employer show that the employee violated a known policy or law?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q2" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q2" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 3 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">3. Are witnesses available?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q3" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q3" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>

      <!-- Question 4 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">4. Does the employer have documentation to support its reasons for termination?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q4" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q4" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 5 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">5. Did the employee progress all the way through the disciplinary system?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q5" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q5" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 6 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">6. Was the employee confronted with the problem and given a chance to explain?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q6" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q6" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 7 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">7. Does the employee belong to a protected minority?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q7" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q7" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 8 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">8. Was the treatment given to the employee different from that given to non-minorities?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q8" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q8" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 9 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">9. Was the treatment given to the employee different from that given to other workers in general?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q9" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q9" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
      
      <!-- Question 10 -->
      <div class="p-4 border rounded-md bg-gray-50">
        <p class="font-medium">10. Was the employee involved in a protected activity?</p>
        <div class="flex items-center space-x-4 mt-2">
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="Yes" required> <span class="ml-2">Yes</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="No"> <span class="ml-2">No</span></label>
          <label class="inline-flex items-center"><input type="radio" class="form-radio text-indigo-600" name="q10" value="N/A"> <span class="ml-2">N/A</span></label>
        </div>
        <textarea name="notes_q10" class="mt-2 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50" placeholder="Notes..."></textarea>
      </div>
    </div>
    <!-- End New Termination Checklist -->

    <!-- Termination Letter Fields -->





    

<!-- Reason & Basis -->
<div>
  <label class="block text-sm font-medium text-gray-700">Reason for Termination</label>
  <textarea name="reason" rows="2" class="w-full border rounded-md p-2"></textarea>
</div>

<div>
  <label class="block text-sm font-medium text-gray-700">Basis for Termination</label>
  <textarea name="basis" rows="2" class="w-full border rounded-md p-2"></textarea>
</div>
<div>
  <label class="block text-sm font-medium text-gray-700">Return of Company Property</label>
  <textarea name="property" rows="3" class="w-full border rounded-md p-2" placeholder="Keys, uniforms, ID badges, company devices..."></textarea>
</div>









    
    <div class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700">Effective Date</label>
        <input type="date" name="effective_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Paycheck Date</label>
        <input type="date" name="final_pay_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Paycheck Amount</label>
        <input type="text" name="final_pay_amount" placeholder="$____" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Insurance End Date</label>
        <input type="date" name="insurance_end" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Number of Verbal Warnings</label>
        <input type="text" name="verbal_warnings" placeholder="e.g. 2 (Dates: ...)" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Number of Written Warnings</label>
        <input type="text" name="written_warnings" placeholder="e.g. 1 (Dates: ...)" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Initial Warning Date</label>
        <input type="date" name="initial_warning_date" class="w-full border rounded-md p-2">
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Final Pay Delivery Method</label>
        <select name="delivery_method" class="w-full border rounded-md p-2">
          <option value="">-- Select --</option>
          <option>Pick up in person</option>
          <option>Hand delivery</option>
          <option>Direct deposit</option>
          <option>By mail</option>
        </select>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Mailing Address</label>
        <textarea name="mailing_address" rows="2" class="w-full border rounded-md p-2"></textarea>
      </div>
      <div>
        <label class="block text-sm font-medium text-gray-700">Company Property to Return</label>
        <textarea name="property" rows="2" class="w-full border rounded-md p-2" placeholder="Keys, uniforms, devices..."></textarea>
      </div>

<div class="flex items-center mt-4">
  <input type="checkbox" name="acknowledgment" class="mr-2">
  <label class="text-sm text-gray-700">I acknowledge receipt of this termination letter</label>
</div>



      
      <div>
        <label class="block text-sm font-medium text-gray-700">Manager Signature</label>
        <input type="text" name="manager_signature" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="w-full border rounded-md p-2">
      </div>
    </div>






    
    <div class="mt-6 flex justify-center space-x-4">
      <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700" onclick="handleTerminationPreview()">Preview PDF</button>
      <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700">Save to Database</button>
      <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700" onclick="requestSignature()">Request Signature</button>
    </div>
    <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
  `;


      } else if (type === 'Resignation' || type === 'Two Weeks Notice') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Employee Comments</label>
              <textarea name="employee_comments" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" onclick="generatePdfFromForm('${type}')">Preview PDF</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold" onclick="saveDocument(event, '${type}')">Save to Database</button>
            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" onclick="requestSignature()">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
      }
      formContainer.innerHTML = `<form id="documentForm" onsubmit="saveDocument(event, '${type}')">${formHtml}</form>`;
      
    }

    function handleTerminationPreview() {
      const form = document.getElementById('documentForm');
      const formData = {
        employee_name: selectedEmployee.full_name,
        employee_role: selectedEmployee.primary_role || "",
        employee_department: selectedEmployee.department || "",
        manager_name: selectedEmployee['Current Reports To Employee'] || "",
        effective_date: form.elements['effective_date'].value,
        final_pay_date: form.elements['final_pay_date'].value,
        final_pay_amount: form.elements['final_pay_amount'].value,
        insurance_end: form.elements['insurance_end'].value,
        verbal_warnings: form.elements['verbal_warnings'].value,
        written_warnings: form.elements['written_warnings'].value,
        initial_warning_date: form.elements['initial_warning_date'].value,
        delivery_method: form.elements['delivery_method'].value,
        mailing_address: form.elements['mailing_address'].value,
        property: form.elements['property'].value,
        manager_signature: form.elements['manager_signature'].value,
        reason: form.elements['reason']?.value || '',
basis: form.elements['basis']?.value || '',
property: form.elements['property']?.value || '',
acknowledgment: form.elements['acknowledgment']?.checked ? 'Acknowledged' : 'Not acknowledged',

        // Checklist data
        checklist: [
          { q: '1. Was there a specific incident close in time to the discharge?', ans: form.querySelector('input[name="q1"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q1"]')?.value || '' },
          { q: '2. Can the employer show that the employee violated a known policy or law?', ans: form.querySelector('input[name="q2"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q2"]')?.value || '' },
          { q: '3. Are witnesses available?', ans: form.querySelector('input[name="q3"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q3"]')?.value || '' },
          { q: '4. Does the employer have documentation to support its reasons for termination?', ans: form.querySelector('input[name="q4"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q4"]')?.value || '' },
          { q: '5. Did the employee progress all the way through the disciplinary system?', ans: form.querySelector('input[name="q5"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q5"]')?.value || '' },
          { q: '6. Was the employee confronted with the problem and given a chance to explain?', ans: form.querySelector('input[name="q6"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q6"]')?.value || '' },
          { q: '7. Does the employee belong to a protected minority?', ans: form.querySelector('input[name="q7"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q7"]')?.value || '' },
          { q: '8. Was the treatment given to the employee different from that given to non-minorities?', ans: form.querySelector('input[name="q8"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q8"]')?.value || '' },
          { q: '9. Was the treatment given to the employee different from that given to other workers in general?', ans: form.querySelector('input[name="q9"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q9"]')?.value || '' },
          { q: '10. Was the employee involved in a protected activity?', ans: form.querySelector('input[name="q10"]:checked')?.value || '', notes: form.querySelector('textarea[name="notes_q10"]')?.value || '' },
        ]
      };
      generateTerminationPdf(formData);
    }

    
    function requestSignature() {
        const signatureModal = `
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]">
                <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full text-center relative">
                    <button onclick="closeSignatureModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-2xl font-bold mb-4">Signature Request</h3>
                    <p class="text-gray-600 mb-6">In a live application, this would send an email to the employee to securely sign the document electronically. A backend service is required for this action.</p>
                    <div class="flex justify-center">
                        <button onclick="closeSignatureModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', signatureModal);
    }
    
    function closeSignatureModal() {
      const modal = document.querySelector('.fixed.inset-0.bg-gray-900');
      if (modal) {
        modal.remove();
      }
    }
    
    // --- Document Generation ---
    function formatHireDate(dateString) {
      if (!dateString) return '';
      const [year, month, day] = dateString.split('-');
      return `${month}/${day}/${year}`;
    }

    function generateDocumentHtml(type, formData) {
      const companyLogoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg?raw=true";

      const employeeName = selectedEmployee.full_name;
      const employeeRole = selectedEmployee.primary_role || "";
      const employeeDept = selectedEmployee.department || "";
      const hireDate = formatHireDate(selectedEmployee.hire_date) || "";
      const managerName = formData.manager_name || "";
      const witnessName = formData.witness_name || "";
      const companyAddress = "400 N. Greenville Ave Ste 11, Richardson, TX 75081";
      const companyPhone = "(972) 669-9094";
      const companyEmail = "admin@jengchirestaurant.com";
      const currentDate = new Date(formData.document_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let documentBody = '';

      switch(type) {
        case 'Verbal Warning':
        case 'Written Warning':
          documentBody = `
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                <tr>
                    <td style="width: 25%; font-weight: bold;">Date:</td>
                    <td>${currentDate}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employee’s Name:</td>
                    <td>${employeeName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employee’s Title:</td>
                    <td>${employeeRole}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Manager's Name:</td>
                    <td>${managerName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Witness's Name:</td>
                    <td>${witnessName}</td>
                </tr>
            </table>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Subject:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.subject}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Statement of the Problem:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.statement_of_problem}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Reference to Prior Warnings:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.prior_warnings}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Company Policy:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.company_policy}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Corrective Action and Expectations:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.corrective_action}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Timeline for Improvement:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.timeline}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Consequences of Failure:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.consequences}</p>

            <div style="margin-top: 2rem;">
                <p style="font-weight: bold;">Employee Comments:</p>
                <p style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 100px;">${formData.employee_comments}</p>
            </div>
            
            <div style="margin-top: 3rem;">
                <p>Employee Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Manager Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Witness Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
            </div>
          `;
          break;
        case 'Termination':
          documentBody = `
            <!-- New Checklist -->
            <div style="margin-bottom: 2rem;">
              <h3 style="font-size: 14pt; font-weight: bold; margin-bottom: 1rem;">Termination Checklist</h3>
              <ul style="list-style-type: none; padding-left: 0;">
                ${Object.keys(formData.checklist).map(q => {
                  const item = formData.checklist[q];
                  return `
                    <li style="margin-bottom: 1rem;">
                      <p style="font-weight: bold; margin-bottom: 0.25rem;">${item.question}:</p>
                      <p>Answer: ${item.answer}</p>
                      ${item.notes ? `<p>Notes: ${item.notes}</p>` : ''}
                    </li>
                  `;
                }).join('')}
              </ul>
            </div>

            <p><strong>Date:</strong> ${currentDate}</p>
            <p><strong>Subject:</strong> Notice of Termination</p>
            <br>
            <p>Dear ${employeeName},</p>
            <br>
            <p>This letter is to inform you that your employment with Jeng Chi is being terminated, effective immediately. This decision is based on a series of documented performance issues and policy violations, as detailed below. This action is final and not subject to further review.</p>
            <br>
            <p><strong>Reason for Termination:</strong></p>
            <p style="white-space: pre-wrap;">${formData.statement_of_problem}</p>
            <br>
            <p><strong>Final Payment:</strong></p>
            <p>Your final paycheck, including all earned wages and accrued benefits, will be sent to the address on file by ${formData.timeline}.</p>
            <br>
            <p>We wish you the best in your future endeavors.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${managerName}</p>
            <p>Manager</p>
            <br><br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Resignation':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi HR,</p>
            <br>
            <p>This letter is to formally notify you of my resignation from my position as ${employeeRole}, effective today, ${currentDate}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Two Weeks Notice':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi Management,</p>
            <br>
            <p>Please accept this letter as formal notification of my resignation from my position as ${employeeRole}. My last day of employment will be two weeks from today, ${new Date(new Date().setDate(new Date().getDate() + 14)).toLocaleDateString('en-US')}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi. I wish the company continued success.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
      }


      return `
        <div class="document-template-content">
          <div style="text-align: center; margin-bottom: 2rem;">
              <img src="${companyLogoUrl}" alt="Company Logo"
     crossorigin="anonymous"
     style="width: 150px; margin-bottom: 1rem;">

              <h2 style="font-size: 24pt; text-align: center; font-weight: bold; margin-bottom: 2rem;">${type}</h2>
          </div>
          ${documentBody}
          <div style="position: absolute; bottom: 1rem; left: 0; right: 0; text-align: center; font-size: 10pt;">
              <hr style="border: none; border-top: 1px solid #ccc; margin-bottom: 0.5rem;">
              <p>${companyAddress} | ${companyPhone} | ${companyEmail}</p>
          </div>
        </div>
      `;
    }

    function generatePdfFromForm(type) {
      const form = document.getElementById('documentForm');

      const checklistItems = [
          'q1', 'q2', 'q3', 'q4', 'q5', 'q6', 'q7', 'q8', 'q9', 'q10'
      ].reduce((acc, q) => {
          const answer = form.querySelector(`input[name="${q}"]:checked`)?.value;
          const notes = form.querySelector(`textarea[name="notes_${q}"]`)?.value;
          if (answer) {
              const questionText = form.querySelector(`p:has(input[name="${q}"])`).textContent;
              acc[q] = {
                  question: questionText,
                  answer: answer,
                  notes: notes
              };
          }
          return acc;
      }, {});

      if (type === "Termination" && Object.keys(checklistItems).length !== 10) {
        alert("Please complete all checklist items before proceeding.");
        return;
      }

      const formData = {
          manager_name: form.elements['manager_name']?.value || '',
          witness_name: form.elements['witness_name']?.value || '',
          document_date: form.elements['document_date']?.value || new Date().toISOString().split('T')[0],
          subject: form.elements['subject']?.value || '',
          statement_of_problem: form.elements['statement_of_problem']?.value || '',
          prior_warnings: form.elements['prior_warnings']?.value || '',
          company_policy: form.elements['company_policy']?.value || '',
          corrective_action: form.elements['corrective_action']?.value || '',
          timeline: form.elements['timeline']?.value || '',
          consequences: form.elements['consequences']?.value || '',
          employee_comments: form.elements['employee_comments']?.value || '',
          checklist: checklistItems
      };
      
      if (type === 'Termination') {
        generateTerminationPdf(formData);
      } else {
        generatePdf(type, formData);
      }
    }
    
    function closePdfViewer() {
      pdfViewerContainer.classList.remove('active');
      pdfViewer.src = '';
      generatedPdf = null;
    }
    
    function downloadPdf() { if (generatedPdf) generatedPdf.save("document.pdf"); }
    function printPdf() { if (generatedPdf) { const url = generatedPdf.output("bloburl"); const win = window.open(url); win.onload = () => win.print(); } }
    
    function generatePdf(type, formData) {
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      let y = 60;

      // --- Logo + Title ---
      const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
      doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 40, y, 80, 60);
      y += 80;
      doc.setFontSize(16).setFont("helvetica", "bold");
      doc.text(type, pageWidth / 2, y, { align: "center" });
      y += 40;

      // --- Employee / Manager / Witness Info ---
      doc.setFontSize(11).setFont("helvetica", "normal");
      const leftColX = 40;
      const rightColX = pageWidth / 2 + 20;

      doc.text(`Full Name: ${selectedEmployee.full_name}`, leftColX, y);
      doc.text(`Position: ${selectedEmployee.primary_role}`, leftColX, y + 16);
      doc.text(`Department: ${selectedEmployee.department || ''}`, leftColX, y + 32);
      doc.text(`Hire Date: ${formatDate(selectedEmployee.hire_date)}`, leftColX, y + 48);
      doc.text(`Email: ${selectedEmployee.email || ''}`, leftColX, y + 64);
      doc.text(`Phone: ${selectedEmployee.phone || ''}`, leftColX, y + 80);

      doc.text(`Manager: ${formData.manager_name} (${getRole(formData.manager_name)})`, rightColX, y);
      doc.text(`Witness: ${formData.witness_name} (${getRole(formData.witness_name)})`, rightColX, y + 16);
      y += 110;

      // --- Section Writer Helper ---
      function addSection(title, content) {
        if (!content) return;
        const requiredSpace = 100;
        if (y > pageHeight - requiredSpace) {
          addFooter();
          doc.addPage();
          y = 80;
        }
        doc.setFont("helvetica", "bold").setFontSize(12);
        doc.text(title, leftColX, y);
        const titleWidth = doc.getTextWidth(title);
        doc.line(leftColX, y + 2, leftColX + titleWidth, y + 2);
        y += 18;
        doc.setFont("helvetica", "normal").setFontSize(11);
        const lines = doc.splitTextToSize(content, pageWidth - 80);
        doc.text(lines, leftColX, y, { align: "left", maxWidth: pageWidth - 80 });
        y += lines.length * 16 + 24;
      }

      // --- Add All Sections ---
      if (type === "Termination" && formData.checklist) {
        const checklistItems = Object.keys(formData.checklist).map(q => {
          const item = formData.checklist[q];
          return `${q}: ${item.answer} \nNotes: ${item.notes || 'N/A'}`;
        }).join('\n\n');
        addSection("Termination Checklist:", checklistItems);
      }

      addSection("Subject:", formData.subject);
      addSection("Statement of the Problem:", formData.statement_of_problem);
      addSection("Reference to Prior Warnings:", formData.prior_warnings);
      addSection("Company Policy:", formData.company_policy);
      addSection("Corrective Action and Expectations:", formData.corrective_action);
      addSection("Timeline for Improvement:", formData.timeline);
      addSection("Consequences of Failure:", formData.consequences);
      addSection("Employee Comments:", formData.employee_comments);

      // --- Signature Section ---
      if (y > pageHeight - 200) {
        addFooter();
        doc.addPage();
        y = 80;
      }
      y += 40;
      const colWidth = (pageWidth - 80) / 2;
      const sigY = y;

      function signatureBlock(label, name, role, x, yPos) {
        doc.setFont("helvetica", "normal").setFontSize(11);
        doc.line(x, yPos, x + colWidth - 40, yPos);
        doc.setFont("helvetica", "bold").setFontSize(10);
        doc.text(label, x, yPos + 15);
        doc.setFont("helvetica", "normal").setFontSize(10);
        doc.text(`${name} (${role})`, x, yPos + 30);
      }

      // Employee (left)
      signatureBlock("Employee Signature", selectedEmployee.full_name, selectedEmployee.primary_role, leftColX, sigY);

      // Manager (right)
      signatureBlock("Manager Signature", formData.manager_name, getRole(formData.manager_name), leftColX + colWidth, sigY);

      // Witness (centered, next line)
      const witnessX = pageWidth / 2 - colWidth / 2;
      signatureBlock("Witness Signature", formData.witness_name, getRole(formData.witness_name), witnessX, sigY + 100);

      // --- Footer with Page Numbers ---
      function addFooter() {
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(9).setFont("helvetica", "normal");
          doc.text(
            `400 N. Greenville Ave Ste 11, Richardson, TX 75081 | admin@jengchirestaurant.com`,
            pageWidth / 2,
            pageHeight - 40,
            { align: "center" }
          );
          doc.text(`Page ${i} of ${pageCount}`, pageWidth - 60, pageHeight - 20);
        }
      }

      addFooter();

      // --- Render PDF ---
      const pdfBlob = doc.output("blob");
      const pdfUrl = URL.createObjectURL(pdfBlob);
      pdfViewer.src = pdfUrl;
      pdfViewerContainer.classList.add("active");
      generatedPdf = doc;
    }

function addSectionHeader(doc, title, y) {
  doc.setFillColor(240, 240, 240); // light gray
  doc.rect(40, y - 12, 520, 22, "F"); // filled rectangle (x, y, width, height)
  doc.setFont("helvetica", "bold");
  doc.setFontSize(12);
  doc.text(title, 50, y + 3);
  return y + 30;
}


    
function generateTerminationPdf(formData) {
  const doc = new jsPDF('p', 'pt', 'letter');
  const pageWidth = doc.internal.pageSize.getWidth();
  let y = 40;

  // --- Logo Centered ---
  const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
  doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 50, y, 100, 80);
  y += 100;

  // --- Title ---
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("TERMINATION LETTER", pageWidth / 2, y, { align: "center" });
  y += 40;

  // --- Employee Info Block ---
  doc.setFontSize(12);
  doc.setFont("helvetica", "normal");
  doc.text(`Full Name: ${formData.employee_name || "__________________"}`, 40, y); y += 18;
  doc.text(`Position: ${formData.employee_role || "__________________"}`, 40, y); y += 18;
  doc.text(`Department: ${formData.employee_department || "__________________"}`, 40, y); y += 18;
  doc.text(`Hire Date: ${formData.hire_date || "__________________"}`, 40, y); y += 18;
  doc.text(`Reports To: ${formData.reports_to || "__________________"}`, 40, y); y += 18;
  doc.text(`Manager: ${formData.manager_name || ""} (${formData.manager_role || ""})`, 40, y); y += 18;
  doc.text(`Witness: ${formData.witness_name || ""} (${formData.witness_role || ""})`, 40, y); y += 30;

  // --- Termination Statement ---
  doc.setFont("helvetica", "bold");
  doc.text(
    "This letter serves to formally notify you that your employment with Jeng Chi Restaurant will be terminated effective",
    40, y, { maxWidth: 520 }
  );
  y += 20;
  doc.text("____________________, 20____.", 40, y);
  y += 40;

  // --- Reason + Basis ---
  y = addSectionHeader(doc, "Reason & Basis", y);
  doc.setFont("helvetica", "bold"); doc.text("Reason for Termination:", 50, y); y += 18;
  doc.setFont("helvetica", "normal"); doc.text(formData.reason || "__________________", 70, y, { maxWidth: 480 }); y += 25;
  doc.setFont("helvetica", "bold"); doc.text("The basis for your termination is:", 50, y); y += 18;
  doc.setFont("helvetica", "normal"); doc.text(formData.basis || "__________________", 70, y, { maxWidth: 480 }); y += 30;

  // --- Policy Statement ---
  doc.setFont("helvetica", "bold");
  doc.text(
    "This action is being taken due to misconduct connected with work and/or violation of company policy, as documented in our employee handbook and prior disciplinary records.",
    40, y, { maxWidth: 520 }
  );
  y += 50;

  // --- Prior Warnings ---
  y = addSectionHeader(doc, "Prior Warnings", y);
  doc.setFont("helvetica", "normal");
  doc.text(`☐ ${formData.verbal_warnings || "____"} Verbal Warnings (Dates: ${formData.verbal_dates || "________"})`, 60, y); y += 20;
  doc.text(`☐ ${formData.written_warnings || "____"} Written Warnings (Dates: ${formData.written_dates || "________"})`, 60, y); y += 40;

  // --- Final Pay ---
  y = addSectionHeader(doc, "Final Pay", y);
  doc.setFont("helvetica", "normal");
  doc.text(
    `In accordance with the Texas Payday Law, you will receive your final paycheck no later than six (6) calendar days from the termination date.`,
    40, y, { maxWidth: 520 }
  );
  y += 40;
  doc.text(`Your final paycheck in the amount of $${formData.final_amount || "_______"} will be delivered via:`, 40, y); y += 25;
  ["Pick up in person", "Hand delivery", "Direct deposit", "By mail"].forEach(opt => {
    doc.text("☐ " + opt, 60, y); y += 20;
  });
  y += 20;
  doc.text(`Mailing Address: ${formData.mailing_address || "__________________"}`, 40, y, { maxWidth: 520 });
  y += 40;

  // --- Return of Company Property ---
  y = addSectionHeader(doc, "Return of Company Property", y);
  doc.setFont("helvetica", "normal");
  doc.text("☐ Keys, uniforms, ID badges", 60, y); y += 20;
  doc.text("☐ Company devices, credit cards", 60, y); y += 20;
  doc.text("☐ Other restaurant property", 60, y); y += 40;

  // --- Checklist ---
  y = addSectionHeader(doc, "Termination Checklist", y);
  doc.setFont("helvetica", "normal");
  formData.checklist?.forEach((item, idx) => {
    doc.text(`${idx + 1}. ${item.q}`, 60, y, { maxWidth: 500 }); y += 15;
    doc.text(`☑ ${item.ans || "N/A"}   Notes: ${item.notes || "____"}`, 80, y, { maxWidth: 500 });
    y += 25;
  });

  // --- Signature Lines ---
  y = addSectionHeader(doc, "Acknowledgment of Receipt", y);
  doc.setFont("helvetica", "normal");
  doc.text("Employee Signature: ____________________   Date: ___________", 50, y); y += 30;
  doc.text("Manager Signature: _____________________   Date: ___________", 50, y); y += 30;
  doc.text("Witness Signature: _____________________   Date: ___________", 50, y);

  // Show PDF
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);
  pdfViewer.src = pdfUrl;
  pdfViewerContainer.classList.add("active");
  generatedPdf = doc;
}




    
    function generatePdf(type, formData) {
      const doc = new jsPDF('p', 'pt', 'letter');
      const pageWidth = doc.internal.pageSize.getWidth();
      const pageHeight = doc.internal.pageSize.getHeight();
      let y = 60;

      // --- Logo + Title ---
      const logoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
      doc.addImage(logoUrl, "JPEG", pageWidth / 2 - 40, y, 80, 60);
      y += 80;
      doc.setFontSize(16).setFont("helvetica", "bold");
      doc.text(type, pageWidth / 2, y, { align: "center" });
      y += 40;

      // --- Employee / Manager / Witness Info ---
      doc.setFontSize(11).setFont("helvetica", "normal");
      const leftColX = 40;
      const rightColX = pageWidth / 2 + 20;

      doc.text(`Full Name: ${selectedEmployee.full_name}`, leftColX, y);
      doc.text(`Position: ${selectedEmployee.primary_role}`, leftColX, y + 16);
      doc.text(`Department: ${selectedEmployee.department || ''}`, leftColX, y + 32);
      doc.text(`Hire Date: ${formatDate(selectedEmployee.hire_date)}`, leftColX, y + 48);
      doc.text(`Email: ${selectedEmployee.email || ''}`, leftColX, y + 64);
      doc.text(`Phone: ${selectedEmployee.phone || ''}`, leftColX, y + 80);

      doc.text(`Manager: ${formData.manager_name} (${getRole(formData.manager_name)})`, rightColX, y);
      doc.text(`Witness: ${formData.witness_name} (${getRole(formData.witness_name)})`, rightColX, y + 16);
      y += 110;

      // --- Section Writer Helper ---
      function addSection(title, content) {
        if (!content) return;
        const requiredSpace = 100;
        if (y > pageHeight - requiredSpace) {
          addFooter();
          doc.addPage();
          y = 80;
        }
        doc.setFont("helvetica", "bold").setFontSize(12);
        doc.text(title, leftColX, y);
        const titleWidth = doc.getTextWidth(title);
        doc.line(leftColX, y + 2, leftColX + titleWidth, y + 2);
        y += 18;
        doc.setFont("helvetica", "normal").setFontSize(11);
        const lines = doc.splitTextToSize(content, pageWidth - 80);
        doc.text(lines, leftColX, y, { align: "left", maxWidth: pageWidth - 80 });
        y += lines.length * 16 + 24;
      }

      // --- Add All Sections ---
      if (type === "Termination" && formData.checklist) {
        const checklistItems = Object.keys(formData.checklist).map(q => {
          const item = formData.checklist[q];
          return `${q}: ${item.answer} \nNotes: ${item.notes || 'N/A'}`;
        }).join('\n\n');
        addSection("Termination Checklist:", checklistItems);
      }

      addSection("Subject:", formData.subject);
      addSection("Statement of the Problem:", formData.statement_of_problem);
      addSection("Reference to Prior Warnings:", formData.prior_warnings);
      addSection("Company Policy:", formData.company_policy);
      addSection("Corrective Action and Expectations:", formData.corrective_action);
      addSection("Timeline for Improvement:", formData.timeline);
      addSection("Consequences of Failure:", formData.consequences);
      addSection("Employee Comments:", formData.employee_comments);

      // --- Signature Section ---
      if (y > pageHeight - 200) {
        addFooter();
        doc.addPage();
        y = 80;
      }
      y += 40;
      const colWidth = (pageWidth - 80) / 2;
      const sigY = y;

      function signatureBlock(label, name, role, x, yPos) {
        doc.setFont("helvetica", "normal").setFontSize(11);
        doc.line(x, yPos, x + colWidth - 40, yPos);
        doc.setFont("helvetica", "bold").setFontSize(10);
        doc.text(label, x, yPos + 15);
        doc.setFont("helvetica", "normal").setFontSize(10);
        doc.text(`${name} (${role})`, x, yPos + 30);
      }

      // Employee (left)
      signatureBlock("Employee Signature", selectedEmployee.full_name, selectedEmployee.primary_role, leftColX, sigY);

      // Manager (right)
      signatureBlock("Manager Signature", formData.manager_name, getRole(formData.manager_name), leftColX + colWidth, sigY);

      // Witness (centered, next line)
      const witnessX = pageWidth / 2 - colWidth / 2;
      signatureBlock("Witness Signature", formData.witness_name, getRole(formData.witness_name), witnessX, sigY + 100);

      // --- Footer with Page Numbers ---
      function addFooter() {
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(9).setFont("helvetica", "normal");
          doc.text(
            `400 N. Greenville Ave Ste 11, Richardson, TX 75081 | admin@jengchirestaurant.com`,
            pageWidth / 2,
            pageHeight - 40,
            { align: "center" }
          );
          doc.text(`Page ${i} of ${pageCount}`, pageWidth - 60, pageHeight - 20);
        }
      }

      addFooter();

      // --- Render PDF ---
      const pdfBlob = doc.output("blob");
      const pdfUrl = URL.createObjectURL(pdfBlob);
      pdfViewer.src = pdfUrl;
      pdfViewerContainer.classList.add("active");
      generatedPdf = doc;
    }
    
function formatDate(dateStr) {
  if (!dateStr) return "";
  const d = new Date(dateStr);
  return `${(d.getMonth() + 1).toString().padStart(2, '0')}/${d.getDate().toString().padStart(2, '0')}/${d.getFullYear()}`;
}

function getRole(name) {
  const emp = employees.find(e => e.full_name === name);
  return emp ? emp.primary_role : "";
}

    searchInput.addEventListener('input', e => showSuggestions(e.target.value));
    window.onload = loadEmployees;

    async function saveDocument(e, type) {
      e.preventDefault();
      const form = e.target;
      const statusMessage = document.getElementById('formStatusMessage');
      
      const checklistItems = [
        'q1', 'q2', 'q3', 'q4', 'q5', 'q6', 'q7', 'q8', 'q9', 'q10'
      ].reduce((acc, q) => {
          const answer = form.querySelector(`input[name="${q}"]:checked`)?.value;
          const notes = form.querySelector(`textarea[name="notes_${q}"]`)?.value;
          if (answer) {
              const questionText = form.querySelector(`p:has(input[name="${q}"])`).textContent;
              acc[q] = {
                  question: questionText,
                  answer: answer,
                  notes: notes
              };
          }
          return acc;
      }, {});

      if (type === "Termination" && Object.keys(checklistItems).length !== 10) {
        statusMessage.textContent = "Please complete all checklist items before saving.";
        statusMessage.className = 'mt-4 text-sm text-red-500';
        return;
      }

      statusMessage.textContent = 'Saving document...';
      statusMessage.className = 'mt-4 text-sm text-gray-500';

      const formData = {
          manager_name: form.elements['manager_name']?.value || '',
          witness_name: form.elements['witness_name']?.value || '',
          document_date: form.elements['document_date']?.value || '',
          subject: form.elements['subject']?.value || '',
          statement_of_problem: form.elements['statement_of_problem']?.value || '',
          prior_warnings: form.elements['prior_warnings']?.value || '',
          company_policy: form.elements['company_policy']?.value || '',
          corrective_action: form.elements['corrective_action']?.value || '',
          timeline: form.elements['timeline']?.value || '',
          consequences: form.elements['consequences']?.value || '',
          employee_comments: form.elements['employee_comments']?.value || '',
          checklist: checklistItems
      };
      
      const summary = formData.subject?.substring(0, 100) + '...' || '';

      const { data, error } = await supabase
        .from('records')
        .insert([{
          employee_id: selectedEmployee.id,
          document_type: type,
          summary: summary,
          content: formData,
        }]);

      if (error) {
        console.error('Supabase Records Error:', error);
        statusMessage.textContent = `Error saving record: ${error.message}`;
        statusMessage.className = 'mt-4 text-sm text-red-500';
      } else {
        statusMessage.textContent = 'Document saved successfully!';
        statusMessage.className = 'mt-4 text-sm text-green-600';
        loadDocuments();
      }
    }
    
    async function loadDocuments() {
      if (!selectedEmployee) {
        documentsListContainer.innerHTML = '<p class="text-center text-gray-500">Please select an employee.</p>';
        return;
      }
      documentsListContainer.innerHTML = '<p class="text-center text-gray-500">Loading documents... <span class="loading-spinner"></span></p>';

      const { data, error } = await supabase.from('records').select('*').eq('employee_id', selectedEmployee.id).order('created_at', { ascending: false });
      if (error) {
        console.error('Error fetching documents:', error);
        documentsListContainer.innerHTML = `<p class="text-center text-red-500">Error loading documents: ${error.message}</p>`;
        return;
      }
      fetchedDocuments = data || [];
      if (fetchedDocuments.length === 0) {
        documentsListContainer.innerHTML = `<p class="text-center text-gray-500">No documents found for ${selectedEmployee.full_name}.</p>`;
        return;
      }
      
      let html = `<div class="bg-gray-100 p-4 rounded-xl mt-8">
        <h3 class="text-lg font-semibold mb-4">Documents for ${selectedEmployee.full_name}</h3>
        <ul class="space-y-4">`;
      fetchedDocuments.forEach((doc, index) => {
        html += `
          <li class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
            <div>
              <p class="font-bold text-gray-800">${doc.document_type}</p>
              <p class="text-gray-600 text-sm italic">${doc.summary}</p>
              <p class="text-gray-400 text-xs mt-1">${new Date(doc.created_at).toLocaleString()}</p>
            </div>
            <div>
              <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200" onclick="viewDocument(${index})">View</button>
            </div>
          </li>`;
      });
      html += `</ul></div>`;
      documentsListContainer.innerHTML = html;
    }
    
    function viewDocument(index) {
        const doc = fetchedDocuments[index];
        if (doc && doc.content) {
            generatePdf(doc.document_type, doc.content);
        } else {
            console.error('Document data not found.');
        }
    }
  </script>
</body>
</html>








