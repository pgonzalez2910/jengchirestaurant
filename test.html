<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Executive Employee Management</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(180deg, #f8fafc 0%, #ffffff 100%);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 2rem;
    }
    .card {
      background-color: #fff;
      border-radius: 1rem;
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.08);
      padding: 2.5rem;
      max-width: 900px;
      width: 100%;
    }
    .profile-image {
      width: 8rem;
      height: 8rem;
      border-radius: 50%;
      background: #3b82f6;
      color: #fff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 3rem;
      font-weight: 600;
      letter-spacing: -2px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }
    .divider {
      height: 1px;
      background-color: #e5e7eb;
      margin: 1.5rem 0;
    }
    .glossy-text {
      background: linear-gradient(to right, #4a4a4a, #1a1a1a, #4a4a4a);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-fill-color: transparent;
      filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.2));
    }
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #3b82f6;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .pdf-viewer-container {
      display: none !important;
      position: fixed;
      inset: 0;
      background-color: rgba(0, 0, 0, 0.75);
      align-items: center;
      justify-content: center;
      z-index: 100;
    }
    .pdf-viewer-container.active {
        display: flex !important;
    }
  </style>
</head>
<body>
  <div class="card">
    <!-- Company Logo -->
    <div class="flex flex-col items-center justify-center mb-8">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jengchi Logo" class="w-48 rounded-xl">
      <!-- New Title -->
      <h2 class="text-3xl font-bold text-center mt-6 glossy-text">Jeng Chi Human Resource Management</h2>
    </div>

    <!-- Main Content Container -->
    <div id="main-content">
      <!-- Search Section -->
      <div id="search-section">
        <p class="text-center text-gray-500 mb-8">Search for an employee to view their profile.</p>
        <div class="mb-6 relative">
          <input type="text" id="searchInput" placeholder="Search by name..." class="w-full px-5 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 transition-all duration-200" autocomplete="off" />
          <div id="suggestions" class="absolute w-full mt-2 bg-white border border-gray-200 rounded-xl shadow-lg z-10 hidden"></div>
        </div>
        <div id="statusMessage" class="text-center text-gray-500 mt-8"></div>
      </div>
      
      <!-- Employee Profile and Document Forms Section -->
      <div id="employee-forms-container" class="hidden">
        <div id="employeeProfile"></div>
        <div class="divider"></div>
        <div class="flex flex-col items-center">
            <p class="text-center text-gray-500 mb-8">Select a document to create a new HR form for <span id="selectedEmployeeName" class="font-semibold text-gray-800"></span>.</p>
            <div class="flex flex-wrap justify-center gap-2 mb-8">
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Verbal Warning')">Verbal Warning</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Written Warning')">Written Warning</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Termination')">Termination</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Resignation')">Resignation</button>
                <button class="px-6 py-3 bg-gray-100 text-gray-800 rounded-lg shadow-md hover:bg-gray-200 transition-colors duration-200" onclick="showForm('Two Weeks Notice')">Two Weeks Notice</button>
            </div>
            <div id="form-container"></div>
            <div id="documents-list-container"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- PDF Preview Modal -->
  <div id="pdf-viewer-container" class="pdf-viewer-container">
    <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full p-6 relative">
      <!-- Close Button -->
      <button onclick="closePdfViewer()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
        âœ•
      </button>
      <h3 class="text-xl font-bold mb-4 text-gray-800">Preview Document</h3>
      <!-- PDF Content -->
      <iframe id="pdf-viewer" class="w-full h-[600px] border rounded-lg shadow-inner bg-gray-50 mb-6"></iframe>
      <!-- Actions -->
      <div class="flex justify-end space-x-4">
        <button onclick="printPdf()" class="px-6 py-2 bg-gray-700 text-white rounded-lg shadow hover:bg-gray-800">ðŸ–¨ Print</button>
        <button onclick="downloadPdf()" class="px-6 py-2 bg-blue-600 text-white rounded-lg shadow hover:bg-blue-700">â¬‡ Download</button>
      </div>
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { jsPDF } = window.jspdf;

    const searchInput = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    const employeeFormsContainer = document.getElementById('employee-forms-container');
    const employeeProfileDiv = document.getElementById('employeeProfile');
    const statusMessageDiv = document.getElementById('statusMessage');
    const formContainer = document.getElementById('form-container');
    const documentsListContainer = document.getElementById('documents-list-container');
    const selectedEmployeeNameSpan = document.getElementById('selectedEmployeeName');
    const pdfViewerContainer = document.getElementById('pdf-viewer-container');
    const pdfViewer = document.getElementById('pdf-viewer');

    let employees = [];
    let selectedEmployee = null;
    let fetchedDocuments = [];
    let generatedPdf = null;
    const managers = ["Mai Vu", "Pablo Gonzalez", "Janelle Teng", "Craig Reeves", "Shoko Teng"];
    const witnessNames = ["Pablo Gonzalez", "Craig Reeves", "Francisco Teng", "Janelle Teng", "Mai Vu", "Shoko Teng"];
    const departments = ["BOH", "FOH"];
    let positions = [];
    
    async function loadEmployees() {
      statusMessageDiv.textContent = 'Loading employee data...';
      const { data, error } = await supabase.from('employees').select('id, full_name, "Current Reports To Employee", primary_role, department, email, phone, hire_date');
      if (error) {
        console.error('Error fetching employees:', error);
        statusMessageDiv.textContent = 'Error loading data. Please try again.';
        return;
      }
      employees = data || [];
      const uniquePositions = new Set(employees.map(emp => emp.primary_role).filter(role => role));
      positions = Array.from(uniquePositions).sort();
      
      // Add Host and Cashier as requested
      if (!positions.includes("Host")) positions.push("Host");
      if (!positions.includes("Cashier")) positions.push("Cashier");
      positions.sort();
      
      statusMessageDiv.textContent = 'Data loaded successfully!';
      setTimeout(() => statusMessageDiv.textContent = '', 2000);
    }
    
    function getInitials(name) {
      if (!name) return '';
      const parts = name.split(' ').filter(part => part.length > 0);
      if (parts.length > 1) {
        return (parts[0][0] + parts[parts.length - 1][0]).toUpperCase();
      } else if (parts.length === 1) {
        return parts[0][0].toUpperCase();
      }
      return '';
    }

    function showSuggestions(query) {
      suggestionsDiv.innerHTML = '';
      if (!query) {
        suggestionsDiv.classList.add('hidden');
        return;
      }
      const matches = employees.filter(emp => emp.full_name && emp.full_name.toLowerCase().includes(query.toLowerCase()));
      if (matches.length === 0) {
        suggestionsDiv.innerHTML = '<p class="p-4 text-gray-400 italic">No suggestions found.</p>';
        suggestionsDiv.classList.remove('hidden');
        return;
      }
      matches.forEach(emp => {
        const div = document.createElement('div');
        div.textContent = emp.full_name;
        div.className = 'px-5 py-3 cursor-pointer hover:bg-gray-100 rounded-lg';
        div.onclick = () => {
          showEmployeeProfile(emp);
          searchInput.value = emp.full_name; // Keep the full name in the input
        };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.classList.remove('hidden');
    }

    function showEmployeeProfile(employee) {
      suggestionsDiv.classList.add('hidden');
      selectedEmployee = employee;
      employeeFormsContainer.classList.remove('hidden');
      selectedEmployeeNameSpan.textContent = selectedEmployee.full_name;
      formContainer.innerHTML = '';
      documentsListContainer.innerHTML = '';
      
      const initials = getInitials(employee.full_name);
      const hireDateForInput = employee.hire_date || '';
      
      const reportsToOptions = managers.map(manager => {
        const isSelected = manager === employee['Current Reports To Employee'] ? 'selected' : '';
        return `<option value="${manager}" ${isSelected}>${manager}</option>`;
      }).join('');

      const departmentOptions = departments.map(dep => {
        const isSelected = dep === employee.department ? 'selected' : '';
        return `<option value="${dep}" ${isSelected}>${dep}</option>`;
      }).join('');

      const positionOptions = positions.map(pos => {
        const isSelected = pos === employee.primary_role ? 'selected' : '';
        return `<option value="${pos}" ${isSelected}>${pos}</option>`;
      }).join('');
      
      employeeProfileDiv.innerHTML = `
        <div class="flex flex-col items-center text-center mb-6">
          <div class="profile-image mb-4">${initials}</div>
        </div>
        <div class="flex flex-col items-center">
            <h3 class="text-xl font-bold mt-6 mb-4">Edit Employee Information</h3>
            <form id="updateEmployeeForm" class="w-full">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                    <div class="flex flex-col">
                        <label for="full_name" class="text-sm font-medium text-gray-700">Full Name</label>
                        <input type="text" id="full_name" name="full_name" value="${employee.full_name || ''}" class="w-full px-4 py-2 border rounded-md">
                    </div>
                    <div class="flex flex-col">
                        <label for="primary_role" class="text-sm font-medium text-gray-700">Position</label>
                        <select id="primary_role" name="primary_role" class="w-full px-4 py-2 border rounded-md">
                            <option value="">Select Position</option>
                            ${positionOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="department" class="text-sm font-medium text-gray-700">Department</label>
                        <select id="department" name="department" class="w-full px-4 py-2 border rounded-md">
                            <option value="">Select Department</option>
                            ${departmentOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="reports_to" class="text-sm font-medium text-gray-700">Reports To</label>
                        <select id="reports_to" name="Current Reports To Employee" class="w-full px-4 py-2 border rounded-md">
                            <option value="">Select Manager</option>
                            ${reportsToOptions}
                        </select>
                    </div>
                    <div class="flex flex-col">
                        <label for="email" class="text-sm font-medium text-gray-700">Email</label>
                        <input type="email" id="email" name="email" value="${employee.email || ''}" class="w-full px-4 py-2 border rounded-md">
                    </div>
                    <div class="flex flex-col">
                        <label for="phone" class="text-sm font-medium text-gray-700">Phone</label>
                        <input type="tel" id="phone" name="phone" value="${employee.phone || ''}" class="w-full px-4 py-2 border rounded-md">
                    </div>
                    <div class="flex flex-col">
                        <label for="hire_date" class="text-sm font-medium text-gray-700">Hire Date</label>
                        <input type="date" id="hire_date" name="hire_date" value="${hireDateForInput}" class="w-full px-4 py-2 border rounded-md">
                    </div>
                </div>
                <div class="text-center mt-6">
                    <button type="submit" class="px-8 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">Update Profile</button>
                    <p id="updateStatusMessage" class="mt-4 text-sm"></p>
                </div>
            </form>
        </div>
      `;
      document.getElementById('updateEmployeeForm').addEventListener('submit', handleUpdate);
      loadDocuments();
    }

    async function handleUpdate(e) {
      e.preventDefault();
      const form = e.target;
      const statusMessage = document.getElementById('updateStatusMessage');

      const updatedData = {
        full_name: form.elements['full_name'].value,
        "Current Reports To Employee": form.elements['Current Reports To Employee'].value,
        primary_role: form.elements['primary_role'].value,
        department: form.elements['department'].value,
        email: form.elements['email'].value,
        phone: form.elements['phone'].value,
        hire_date: form.elements['hire_date'].value,
      };

      statusMessage.textContent = 'Updating...';
      statusMessage.className = 'mt-4 text-sm text-gray-500';
      
      const { data, error } = await supabase
        .from('employees')
        .update(updatedData)
        .eq('id', selectedEmployee.id);
      
      if (error) {
        console.error('Update failed:', error);
        statusMessage.textContent = `Error updating: ${error.message}`;
        statusMessage.className = 'mt-4 text-sm text-red-500';
      } else {
        statusMessage.textContent = 'Profile updated successfully!';
        statusMessage.className = 'mt-4 text-sm text-green-600';
        await loadEmployees();
        selectedEmployee = employees.find(emp => emp.id === selectedEmployee.id);
        showEmployeeProfile(selectedEmployee);
      }
    }

    function showForm(type) {
      if (!selectedEmployee) {
        return;
      }

      formContainer.classList.remove('hidden');
      const formTitle = type;
      const today = new Date().toISOString().split('T')[0];
      const witnessOptions = witnessNames.map(name => `<option value="${name}">${name}</option>`).join('');

      let formHtml = '';
      if (type === 'Verbal Warning' || type === 'Written Warning') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Manager's Name</label>
              <input type="text" name="manager_name" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
             <div>
              <label class="block text-sm font-medium text-gray-700">Witness's Name</label>
              <select name="witness_name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                ${witnessOptions}
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Subject</label>
              <textarea name="subject" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Statement of the Problem</label>
              <textarea name="statement_of_problem" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Reference to Prior Warnings</label>
              <textarea name="prior_warnings" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Company Policy</label>
              <textarea name="company_policy" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Corrective Action and Expectations</label>
              <textarea name="corrective_action" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Timeline for Improvement</label>
              <textarea name="timeline" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Consequences of Failure</label>
              <textarea name="consequences" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Employee Comments</label>
              <textarea name="employee_comments" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" onclick="generatePdfFromForm('${type}')">Preview PDF</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold">Save to Database</button>
            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" onclick="requestSignature()">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
      } else if (type === 'Termination') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Manager's Name</label>
              <input type="text" name="manager_name" value="${selectedEmployee['Current Reports To Employee'] || ''}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Reason for Termination</label>
              <textarea name="statement_of_problem" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Final Payment Details</label>
              <textarea name="timeline" rows="3" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" onclick="generatePdfFromForm('${type}')">Preview PDF</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold">Save to Database</button>
            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" onclick="requestSignature()">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
      } else if (type === 'Resignation' || type === 'Two Weeks Notice') {
        formHtml = `
          <h3 class="text-xl font-bold mb-6">${formTitle} for ${selectedEmployee.full_name}</h3>
          <div class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700">Date</label>
              <input type="date" name="document_date" value="${today}" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-700">Employee Comments</label>
              <textarea name="employee_comments" rows="5" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50"></textarea>
            </div>
          </div>
          <div class="mt-6 flex justify-center space-x-4">
            <button type="button" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold" onclick="generatePdfFromForm('${type}')">Preview PDF</button>
            <button type="submit" class="px-6 py-3 bg-green-600 text-white rounded-lg shadow-lg hover:bg-green-700 transition-colors duration-200 font-semibold">Save to Database</button>
            <button type="button" class="px-6 py-3 bg-gray-600 text-white rounded-lg shadow-lg hover:bg-gray-700 transition-colors duration-200 font-semibold" onclick="requestSignature()">Request Signature</button>
          </div>
          <p id="formStatusMessage" class="mt-4 text-center text-sm"></p>
        `;
      }
      formContainer.innerHTML = `<form id="documentForm" onsubmit="saveDocument(event, '${type}')">${formHtml}</form>`;
      
    }
    
    function requestSignature() {
        const signatureModal = `
            <div class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-[100]">
                <div class="bg-white p-8 rounded-lg shadow-2xl max-w-lg w-full text-center relative">
                    <button onclick="closeSignatureModal()" class="absolute top-4 right-4 text-gray-500 hover:text-gray-800">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                        </svg>
                    </button>
                    <h3 class="text-2xl font-bold mb-4">Signature Request</h3>
                    <p class="text-gray-600 mb-6">In a live application, this would send an email to the employee to securely sign the document electronically. A backend service is required for this action.</p>
                    <div class="flex justify-center">
                        <button onclick="closeSignatureModal()" class="px-6 py-3 bg-blue-600 text-white rounded-lg shadow-lg hover:bg-blue-700 transition-colors duration-200 font-semibold">Close</button>
                    </div>
                </div>
            </div>
        `;
        document.body.insertAdjacentHTML('beforeend', signatureModal);
    }
    
    function closeSignatureModal() {
      const modal = document.querySelector('.fixed.inset-0.bg-gray-900');
      if (modal) {
        modal.remove();
      }
    }
    
    // --- Document Generation ---
    function formatHireDate(dateString) {
      if (!dateString) return '';
      const [year, month, day] = dateString.split('-');
      return `${month}/${day}/${year}`;
    }

    function generateDocumentHtml(type, formData) {
      const companyLogoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg?raw=true";

      const employeeName = selectedEmployee.full_name;
      const employeeRole = selectedEmployee.primary_role || "";
      const employeeDept = selectedEmployee.department || "";
      const hireDate = formatHireDate(selectedEmployee.hire_date) || "";
      const managerName = formData.manager_name || "";
      const witnessName = formData.witness_name || "";
      const companyAddress = "400 N. Greenville Ave Ste 11, Richardson, TX 75081";
      const companyPhone = "(972) 669-9094";
      const companyEmail = "admin@jengchirestaurant.com";
      const currentDate = new Date(formData.document_date).toLocaleDateString('en-US', {
        year: 'numeric', month: 'long', day: 'numeric'
      });

      let documentBody = '';

      switch(type) {
        case 'Verbal Warning':
        case 'Written Warning':
          documentBody = `
            <table style="width: 100%; border-collapse: collapse; margin-bottom: 2rem;">
                <tr>
                    <td style="width: 25%; font-weight: bold;">Date:</td>
                    <td>${currentDate}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employeeâ€™s Name:</td>
                    <td>${employeeName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Employeeâ€™s Title:</td>
                    <td>${employeeRole}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Manager's Name:</td>
                    <td>${managerName}</td>
                </tr>
                <tr>
                    <td style="font-weight: bold;">Witness's Name:</td>
                    <td>${witnessName}</td>
                </tr>
            </table>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Subject:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.subject}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Statement of the Problem:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.statement_of_problem}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Reference to Prior Warnings:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.prior_warnings}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Company Policy:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.company_policy}</p>
            
            <p style="font-weight: bold; margin-bottom: 0.5rem;">Corrective Action and Expectations:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.corrective_action}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Timeline for Improvement:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.timeline}</p>

            <p style="font-weight: bold; margin-bottom: 0.5rem;">Consequences of Failure:</p>
            <p style="white-space: pre-wrap; margin-bottom: 1rem;">${formData.consequences}</p>

            <div style="margin-top: 2rem;">
                <p style="font-weight: bold;">Employee Comments:</p>
                <p style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 100px;">${formData.employee_comments}</p>
            </div>
            
            <div style="margin-top: 3rem;">
                <p>Employee Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Manager Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
                <p style="margin-top: 2rem;">Witness Signature: _________________________</p>
                <p style="margin-top: 0.5rem;">Date: ________________</p>
            </div>
          `;
          break;
        case 'Termination':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <p><strong>Subject:</strong> Notice of Termination</p>
            <br>
            <p>Dear ${employeeName},</p>
            <br>
            <p>This letter is to inform you that your employment with Jeng Chi is being terminated, effective immediately. This decision is based on a series of documented performance issues and policy violations, as detailed below. This action is final and not subject to further review.</p>
            <br>
            <p><strong>Reason for Termination:</strong></p>
            <p style="white-space: pre-wrap;">${formData.statement_of_problem}</p>
            <br>
            <p><strong>Final Payment:</strong></p>
            <p>Your final paycheck, including all earned wages and accrued benefits, will be sent to the address on file by ${formData.timeline}.</p>
            <br>
            <p>We wish you the best in your future endeavors.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${managerName}</p>
            <p>Manager</p>
            <br><br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Resignation':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi HR,</p>
            <br>
            <p>This letter is to formally notify you of my resignation from my position as ${employeeRole}, effective today, ${currentDate}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
        case 'Two Weeks Notice':
          documentBody = `
            <p><strong>Date:</strong> ${currentDate}</p>
            <br>
            <p>Dear Jeng Chi Management,</p>
            <br>
            <p>Please accept this letter as formal notification of my resignation from my position as ${employeeRole}. My last day of employment will be two weeks from today, ${new Date(new Date().setDate(new Date().getDate() + 14)).toLocaleDateString('en-US')}.</p>
            <br>
            <p style="white-space: pre-wrap;">${formData.employee_comments}</p>
            <br>
            <p>Thank you for the opportunity to work at Jeng Chi. I wish the company continued success.</p>
            <br><br>
            <p>Sincerely,</p>
            <p>${employeeName}</p>
            <br>
            <p>Employee Signature: _________________________</p>
            <p style="margin-top: 0.5rem;">Date: ________________</p>
          `;
          break;
      }


      return `
        <div class="document-template-content">
          <div style="text-align: center; margin-bottom: 2rem;">
              <img src="${companyLogoUrl}" alt="Company Logo"
     crossorigin="anonymous"
     style="width: 150px; margin-bottom: 1rem;">

              <h2 style="font-size: 24pt; text-align: center; font-weight: bold; margin-bottom: 2rem;">${type}</h2>
          </div>
          ${documentBody}
          <div style="position: absolute; bottom: 1rem; left: 0; right: 0; text-align: center; font-size: 10pt;">
              <hr style="border: none; border-top: 1px solid #ccc; margin-bottom: 0.5rem;">
              <p>${companyAddress} | ${companyPhone} | ${companyEmail}</p>
          </div>
        </div>
      `;
    }

    function generatePdfFromForm(type) {
      const form = document.getElementById('documentForm');
      const formData = {
          manager_name: form.elements['manager_name']?.value || '',
          witness_name: form.elements['witness_name']?.value || '',
          document_date: form.elements['document_date']?.value || new Date().toISOString().split('T')[0],
          subject: form.elements['subject']?.value || '',
          statement_of_problem: form.elements['statement_of_problem']?.value || '',
          prior_warnings: form.elements['prior_warnings']?.value || '',
          company_policy: form.elements['company_policy']?.value || '',
          corrective_action: form.elements['corrective_action']?.value || '',
          timeline: form.elements['timeline']?.value || '',
          consequences: form.elements['consequences']?.value || '',
          employee_comments: form.elements['employee_comments']?.value || '',
      };
      generatePdf(type, formData);
    }
    
    function closePdfViewer() {
      pdfViewerContainer.classList.remove('active');
      pdfViewer.src = '';
      generatedPdf = null;
    }
    
    function downloadPdf() { if (generatedPdf) generatedPdf.save("document.pdf"); }
    function printPdf() { if (generatedPdf) { const url = generatedPdf.output("bloburl"); const win = window.open(url); win.onload = () => win.print(); } }
    
   function generatePdf(type, formData) {
  const doc = new jsPDF('p', 'pt', 'letter');
  doc.setFont("helvetica", "normal");

  let y = 40;

  // Title
  doc.setFontSize(18);
  doc.text(type, 220, y);
  y += 40;

  // Employee Info
  doc.setFontSize(12);
  doc.text(`Date: ${formData.document_date}`, 40, y); y += 20;
  doc.text(`Employee: ${selectedEmployee.full_name}`, 40, y); y += 20;
  doc.text(`Role: ${selectedEmployee.primary_role || ''}`, 40, y); y += 20;
  doc.text(`Department: ${selectedEmployee.department || ''}`, 40, y); y += 30;

  // Section Headers & Content
  if (formData.subject) {
    doc.setFont(undefined, "bold");
    doc.text("Subject:", 40, y); y += 20;
    doc.setFont(undefined, "normal");
    doc.text(doc.splitTextToSize(formData.subject, 500), 40, y);
    y += 40;
  }

  if (formData.statement_of_problem) {
    doc.setFont(undefined, "bold");
    doc.text("Statement of the Problem:", 40, y); y += 20;
    doc.setFont(undefined, "normal");
    doc.text(doc.splitTextToSize(formData.statement_of_problem, 500), 40, y);
    y += 40;
  }

  if (formData.corrective_action) {
    doc.setFont(undefined, "bold");
    doc.text("Corrective Action:", 40, y); y += 20;
    doc.setFont(undefined, "normal");
    doc.text(doc.splitTextToSize(formData.corrective_action, 500), 40, y);
    y += 40;
  }

  // Footer
  doc.setFontSize(10);
  doc.text("Jeng Chi Restaurant | 400 N. Greenville Ave, Richardson, TX", 40, 750);

  // --- Show in iframe
  const pdfBlob = doc.output("blob");
  const pdfUrl = URL.createObjectURL(pdfBlob);
  pdfViewer.src = pdfUrl;
  pdfViewerContainer.classList.add("active");

  generatedPdf = doc;
}


    searchInput.addEventListener('input', e => showSuggestions(e.target.value));
    window.onload = loadEmployees;

    async function saveDocument(e, type) {
      e.preventDefault();
      const form = e.target;
      const statusMessage = document.getElementById('formStatusMessage');

      statusMessage.textContent = 'Saving document...';
      statusMessage.className = 'mt-4 text-sm text-gray-500';

      const formData = {
          manager_name: form.elements['manager_name']?.value || '',
          witness_name: form.elements['witness_name']?.value || '',
          document_date: form.elements['document_date']?.value || '',
          subject: form.elements['subject']?.value || '',
          statement_of_problem: form.elements['statement_of_problem']?.value || '',
          prior_warnings: form.elements['prior_warnings']?.value || '',
          company_policy: form.elements['company_policy']?.value || '',
          corrective_action: form.elements['corrective_action']?.value || '',
          timeline: form.elements['timeline']?.value || '',
          consequences: form.elements['consequences']?.value || '',
          employee_comments: form.elements['employee_comments']?.value || '',
      };
      
      const summary = formData.subject?.substring(0, 100) + '...' || '';

      const { data, error } = await supabase
        .from('records')
        .insert([{
          employee_id: selectedEmployee.id,
          document_type: type,
          summary: summary,
          content: formData,
        }]);

      if (error) {
        console.error('Supabase Records Error:', error);
        statusMessage.textContent = `Error saving record: ${error.message}`;
        statusMessage.className = 'mt-4 text-sm text-red-500';
      } else {
        statusMessage.textContent = 'Document saved successfully!';
        statusMessage.className = 'mt-4 text-sm text-green-600';
        loadDocuments();
      }
    }
    
    async function loadDocuments() {
      if (!selectedEmployee) {
        documentsListContainer.innerHTML = '<p class="text-center text-gray-500">Please select an employee.</p>';
        return;
      }
      documentsListContainer.innerHTML = '<p class="text-center text-gray-500">Loading documents... <span class="loading-spinner"></span></p>';

      const { data, error } = await supabase.from('records').select('*').eq('employee_id', selectedEmployee.id).order('created_at', { ascending: false });
      if (error) {
        console.error('Error fetching documents:', error);
        documentsListContainer.innerHTML = `<p class="text-center text-red-500">Error loading documents: ${error.message}</p>`;
        return;
      }
      fetchedDocuments = data || [];
      if (fetchedDocuments.length === 0) {
        documentsListContainer.innerHTML = `<p class="text-center text-gray-500">No documents found for ${selectedEmployee.full_name}.</p>`;
        return;
      }
      
      let html = `<div class="bg-gray-100 p-4 rounded-xl mt-8">
        <h3 class="text-lg font-semibold mb-4">Documents for ${selectedEmployee.full_name}</h3>
        <ul class="space-y-4">`;
      fetchedDocuments.forEach((doc, index) => {
        html += `
          <li class="p-4 bg-white rounded-lg shadow-sm flex items-center justify-between">
            <div>
              <p class="font-bold text-gray-800">${doc.document_type}</p>
              <p class="text-gray-600 text-sm italic">${doc.summary}</p>
              <p class="text-gray-400 text-xs mt-1">${new Date(doc.created_at).toLocaleString()}</p>
            </div>
            <div>
              <button class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition-colors duration-200" onclick="viewDocument(${index})">View</button>
            </div>
          </li>`;
      });
      html += `</ul></div>`;
      documentsListContainer.innerHTML = html;
    }
    
    function viewDocument(index) {
        const doc = fetchedDocuments[index];
        if (doc && doc.content) {
            generatePdf(doc.document_type, doc.content);
        } else {
            console.error('Document data not found.');
        }
    }
  </script>
</body>
</html>

