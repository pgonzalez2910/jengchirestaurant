<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Enterprise Kitchen Workforce Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}
body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
background-color: #f5f7fa;
color: #2d3748;
min-height: 100vh;
}
.container {
max-width: 1400px;
margin: 0 auto;
background: white;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
overflow: hidden;
}
header {
background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
color: white;
padding: 24px 40px;
display: flex;
justify-content: space-between;
align-items: center;
}
header h1 {
font-size: 28px;
font-weight: 700;
margin: 0;
}
.header-subtitle {
font-size: 14px;
opacity: 0.9;
margin-top: 4px;
}
.tabs {
display: flex;
background: #f8fafc;
border-bottom: 1px solid #e2e8f0;
}
.tab-btn {
flex: 1;
min-width: 160px;
padding: 16px 20px;
border: none;
background: none;
cursor: pointer;
font-size: 14px;
font-weight: 600;
color: #718096;
transition: all 0.2s;
position: relative;
}
.tab-btn:hover {
color: #2c5282;
background: #edf2f7;
}
.tab-btn.active {
color: #2c5282;
background: white;
}
.tab-btn.active::after {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 3px;
background: #2c5282;
}
.tab-content {
display: none;
padding: 40px;
}
.tab-content.active {
display: block;
}
.form-group {
margin-bottom: 24px;
}
label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #4a5568;
font-size: 14px;
}
select, button, input {
width: 100%;
padding: 12px 16px;
border: 1px solid #cbd5e0;
border-radius: 6px;
font-size: 15px;
font-family: inherit;
transition: all 0.2s;
}
select:focus, button:focus, input:focus {
outline: none;
border-color: #3182ce;
box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}
button {
background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
color: white;
border: none;
cursor: pointer;
font-weight: 600;
font-size: 15px;
padding: 12px 24px;
border-radius: 6px;
transition: all 0.2s;
width: auto;
}
button:hover {
transform: translateY(-1px);
box-shadow: 0 4px 6px rgba(44, 82, 130, 0.2);
}
button:disabled {
background: #a0aec0;
cursor: not-allowed;
transform: none;
box-shadow: none;
}
button.secondary {
background: #e2e8f0;
color: #4a5568;
}
button.secondary:hover {
background: #cbd5e0;
}
button.success {
background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}
button.success:hover {
box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
}
button.danger {
background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}
button.danger:hover {
box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
}
#status {
padding: 12px 16px;
border-radius: 6px;
margin-top: 20px;
text-align: center;
font-weight: 500;
font-size: 14px;
}
.success {
background: #d1fae5;
color: #065f46;
border: 1px solid #6ee7b7;
}
.error {
background: #fee2e2;
color: #991b1b;
border: 1px solid #fca5a5;
}
.info {
background: #dbeafe;
color: #1e40af;
border: 1px solid #93c5fd;
}
.chart-container {
margin-top: 30px;
padding: 24px;
background: #f8fafc;
border-radius: 8px;
border: 1px solid #e2e8f0;
height: 350px;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
gap: 24px;
margin-top: 24px;
}
.stat-card {
background: white;
padding: 24px;
border-radius: 8px;
text-align: center;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
border: 1px solid #e2e8f0;
transition: all 0.2s;
}
.stat-card:hover {
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transform: translateY(-2px);
}
.stat-card h3 {
font-size: 13px;
color: #718096;
margin-bottom: 12px;
font-weight: 500;
text-transform: uppercase;
letter-spacing: 0.5px;
}
.stat-card .value {
font-size: 36px;
font-weight: 700;
color: #2c5282;
line-height: 1;
}
.log-list {
margin-top: 24px;
max-height: 450px;
overflow-y: auto;
border: 1px solid #e2e8f0;
border-radius: 8px;
}
.log-item {
padding: 14px 20px;
border-bottom: 1px solid #f1f5f9;
display: flex;
justify-content: space-between;
align-items: center;
transition: background 0.2s;
}
.log-item:hover {
background: #f8fafc;
}
.log-item:last-child {
border-bottom: none;
}
.log-time {
font-weight: 600;
color: #2c5282;
font-size: 14px;
min-width: 150px;
}
.log-task {
color: #4a5568;
font-size: 14px;
flex: 1;
padding: 0 20px;
}
.log-duration {
color: #dc2626;
font-weight: 600;
font-size: 14px;
min-width: 80px;
text-align: right;
}
.hidden {
display: none;
}
.manual-form {
max-width: 650px;
margin: 0 auto;
}
.time-row {
display: flex;
gap: 20px;
}
.time-row .form-group {
flex: 1;
margin-bottom: 0;
}
.batch-entry {
background: #f8fafc;
padding: 24px;
border-radius: 8px;
margin-top: 32px;
border: 1px solid #e2e8f0;
}
.batch-entry h3 {
margin-bottom: 12px;
color: #2d3748;
font-size: 16px;
font-weight: 600;
}
.batch-entry p {
line-height: 1.6;
color: #718096;
font-size: 14px;
}
.task-manager {
margin-top: 32px;
padding: 24px;
background: #f8fafc;
border-radius: 8px;
border: 1px solid #e2e8f0;
}
.custom-task-row {
display: flex;
gap: 12px;
margin-bottom: 20px;
}
.custom-task-row input {
flex: 1;
margin-bottom: 0;
}
.task-list {
max-height: 240px;
overflow-y: auto;
margin-top: 20px;
border: 1px solid #e2e8f0;
border-radius: 6px;
}
.task-item {
padding: 12px 16px;
border-bottom: 1px solid #f1f5f9;
display: flex;
justify-content: space-between;
align-items: center;
}
.task-item:last-child {
border-bottom: none;
}
.delete-task {
background: #ef4444;
color: white;
border: none;
border-radius: 4px;
padding: 6px 12px;
cursor: pointer;
font-size: 13px;
font-weight: 500;
transition: all 0.2s;
}
.delete-task:hover {
background: #dc2626;
transform: scale(1.05);
}
.section-title {
font-size: 20px;
font-weight: 700;
color: #2d3748;
margin-bottom: 8px;
}
.section-subtitle {
font-size: 14px;
color: #718096;
margin-bottom: 24px;
}
.card {
background: white;
border-radius: 8px;
padding: 24px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
border: 1px solid #e2e8f0;
}
.action-bar {
display: flex;
gap: 12px;
margin-top: 20px;
}
.period-selector {
background: #f0f9ff;
padding: 20px;
border-radius: 8px;
border: 1px solid #bee3f8;
margin-bottom: 24px;
}
.period-selector h4 {
font-size: 14px;
color: #2c5282;
margin-bottom: 12px;
font-weight: 600;
}
.period-controls {
display: flex;
gap: 16px;
align-items: end;
flex-wrap: wrap;
}
.period-controls .form-group {
flex: 1;
min-width: 150px;
margin-bottom: 0;
}
.current-period-display {
margin-top: 12px;
padding: 12px;
background: #ebf8ff;
border-radius: 6px;
font-size: 14px;
color: #2c5282;
font-weight: 600;
}
.employee-table {
width: 100%;
border-collapse: collapse;
font-size: 14px;
margin-top: 16px;
}
.employee-table th {
padding: 12px;
text-align: left;
color: #4a5568;
font-weight: 600;
background: #f8fafc;
border-bottom: 2px solid #e2e8f0;
}
.employee-table td {
padding: 12px;
border-bottom: 1px solid #e2e8f0;
color: #2d3748;
}
.employee-table tr:hover {
background: #f8fafc;
}
.employee-table .highlight {
font-weight: 600;
color: #2c5282;
}
.filter-bar {
display: flex;
gap: 16px;
margin-bottom: 24px;
flex-wrap: wrap;
}
.filter-bar .form-group {
flex: 1;
min-width: 200px;
margin-bottom: 0;
}

/* BATCH ENTRY TABLE STYLES */
.batch-table-container {
margin-top: 24px;
overflow-x: auto;
border: 1px solid #e2e8f0;
border-radius: 8px;
}
.batch-table {
width: 100%;
border-collapse: collapse;
font-size: 14px;
}
.batch-table th {
background: #f8fafc;
padding: 12px;
text-align: left;
color: #4a5568;
font-weight: 600;
border-bottom: 2px solid #e2e8f0;
}
.batch-table td {
padding: 12px;
border-bottom: 1px solid #e2e8f0;
}
.batch-table input {
width: 100%;
padding: 8px 12px;
font-size: 14px;
}
.batch-table .delete-row-btn {
background: #ef4444;
color: white;
border: none;
border-radius: 4px;
padding: 6px 12px;
cursor: pointer;
font-size: 13px;
white-space: nowrap;
}
.batch-table .delete-row-btn:hover {
background: #dc2626;
}
.batch-summary {
background: #f0f9ff;
padding: 16px;
border-radius: 6px;
margin-top: 20px;
border: 1px solid #bee3f8;
}
.batch-summary h4 {
color: #2c5282;
margin-bottom: 12px;
font-size: 15px;
font-weight: 600;
}
.summary-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
gap: 12px;
}
.summary-item {
background: white;
padding: 12px;
border-radius: 6px;
text-align: center;
}
.summary-item label {
display: block;
font-size: 12px;
color: #718096;
margin-bottom: 4px;
}
.summary-item .value {
font-size: 20px;
font-weight: 700;
color: #2c5282;
}
.batch-actions {
display: flex;
gap: 12px;
margin-top: 24px;
flex-wrap: wrap;
}
.overlap-warning {
background: #fff3cd;
color: #856404;
padding: 8px 12px;
border-radius: 4px;
font-size: 13px;
margin-top: 8px;
border: 1px solid #ffc107;
}

@media (max-width: 768px) {
.tabs {
flex-direction: column;
}
.time-row {
flex-direction: column;
gap: 12px;
}
header {
padding: 20px;
}
header h1 {
font-size: 22px;
}
.custom-task-row {
flex-direction: column;
}
.tab-content {
padding: 24px;
}
.stats-grid {
grid-template-columns: 1fr;
}
.period-controls {
flex-direction: column;
}
.period-controls .form-group {
width: 100%;
}
.filter-bar {
flex-direction: column;
}
.batch-table {
font-size: 12px;
}
.batch-table input {
padding: 6px 8px;
font-size: 12px;
}
.batch-actions {
flex-direction: column;
}
.batch-actions button {
width: 100%;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div>
<h1>Enterprise Kitchen Workforce Management</h1>
<div class="header-subtitle">Performance Tracking & Workload Analytics</div>
</div>
</header>

<div class="tabs">
<button class="tab-btn active" onclick="switchTab('log')">Real-Time Task Logging</button>
<button class="tab-btn" onclick="switchTab('manual')">Batch Entry Mode</button>
<button class="tab-btn" onclick="switchTab('tasks')">Task Management</button>
<button class="tab-btn" onclick="switchTab('dashboard')">Analytics Dashboard</button>
<button class="tab-btn" onclick="switchTab('history')">Activity History</button>
</div>

<!-- LOG TASKS TAB -->
<div id="log" class="tab-content active">
<h2 class="section-title">Active Task Timer</h2>
<p class="section-subtitle">Start and stop timers for real-time task tracking</p>
<div class="card">
<div class="form-group">
<label for="employee">Employee Name</label>
<select id="employee" required>
<option value="">-- Select Employee --</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="form-group">
<label for="task">Task Name</label>
<input type="text" id="task" placeholder="Type task name (e.g., Fish Prep, Dough Making)" />
</div>
<div class="action-bar">
<button onclick="startTask()" id="startBtn">‚ñ∂ Start Task</button>
<button onclick="stopTask()" id="stopBtn" disabled class="danger">‚èπ Stop Task</button>
</div>
<div id="status" class="hidden"></div>
<div id="currentTaskInfo" class="hidden" style="margin-top: 24px; padding: 16px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bee3f8;">
<h3 style="font-size: 14px; color: #2c5282; margin-bottom: 12px; font-weight: 600;">Current Active Task</h3>
<p id="currentTaskDisplay" style="font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #1a365d;"></p>
<p id="elapsedTime" style="font-size: 13px; color: #4a5568; margin: 0;"></p>
</div>
</div>
</div>

<!-- BATCH ENTRY MODE TAB -->
<div id="manual" class="tab-content">
<h2 class="section-title">Batch Entry Mode</h2>
<p class="section-subtitle">Add multiple tasks for the same day and employee at once - Just type the task name!</p>

<div class="card">
<div class="form-group">
<label for="batchDate">üìÖ Date</label>
<input type="date" id="batchDate" value="" required>
</div>

<div class="form-group">
<label for="batchEmployee">üë§ Employee Name</label>
<select id="batchEmployee" required>
<option value="">-- Select Employee --</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>

<div class="batch-actions" style="margin-bottom: 20px;">
<button onclick="addTaskRow()" class="success" style="width: auto;">
‚ûï Add Task Row
</button>
<button onclick="clearAllRows()" class="secondary" style="width: auto;">
üóë Clear All Rows
</button>
</div>

<div class="batch-table-container">
<table class="batch-table" id="batchTable">
<thead>
<tr>
<th style="width: 20%;">‚è∞ Time In</th>
<th style="width: 20%;">‚è∞ Time Out</th>
<th style="width: 45%;">üìù Task (Just Type It!)</th>
<th style="width: 10%;">Duration</th>
<th style="width: 5%;">Action</th>
</tr>
</thead>
<tbody id="batchTableBody">
<!-- Task rows will be added here -->
</tbody>
</table>
</div>

<div id="overlapWarning" class="overlap-warning hidden" style="margin-top: 12px;">
‚ö†Ô∏è Warning: Some tasks have overlapping times!
</div>

<div class="batch-summary" id="batchSummary" style="display: none;">
<h4>üìä Summary</h4>
<div class="summary-grid">
<div class="summary-item">
<label>Total Tasks</label>
<div class="value" id="summaryTotalTasks">0</div>
</div>
<div class="summary-item">
<label>Total Hours</label>
<div class="value" id="summaryTotalHours">0.0</div>
</div>
<div class="summary-item">
<label>First Task</label>
<div class="value" id="summaryFirstTask">-</div>
</div>
<div class="summary-item">
<label>Last Task</label>
<div class="value" id="summaryLastTask">-</div>
</div>
</div>
</div>

<div class="batch-actions">
<button onclick="saveBatchTasks()" class="success" style="flex: 2; min-width: 200px;">
üíæ Save All Tasks
</button>
</div>

<div id="batchStatus" class="hidden" style="margin-top: 20px;"></div>
</div>

<div class="batch-entry">
<h3>üí° How to Use Batch Entry</h3>
<p>
‚Ä¢ Select the date and employee ONCE at the top<br>
‚Ä¢ Click "Add Task Row" to add multiple tasks<br>
‚Ä¢ <strong>Just TYPE the task name</strong> - no need to select from a list!<br>
‚Ä¢ Fill in Time In and Time Out for each row<br>
‚Ä¢ Duration is calculated automatically<br>
‚Ä¢ Review the summary before saving<br>
‚Ä¢ Click "Save All Tasks" to save everything at once!<br>
‚Ä¢ All entries are immediately reflected in analytics
</p>
</div>
</div>

<!-- MANAGE TASKS TAB -->
<div id="tasks" class="tab-content">
<h2 class="section-title">Task Management (Optional)</h2>
<p class="section-subtitle">Create predefined task types if you want them for reference</p>
<div class="card">
<div class="task-manager">
<div class="custom-task-row">
<input type="text" id="newTaskName" placeholder="Enter new task name (e.g., Fish Prep, Dough Making)" />
<button onclick="addCustomTask()" style="width: auto; padding: 12px 20px;">‚ûï Add Task</button>
</div>
<div id="taskStatus" class="hidden" style="margin: 16px 0;"></div>
<h3 style="margin: 20px 0 12px; color: #2d3748; font-size: 15px; font-weight: 600;">Available Task Types (Reference Only)</h3>
<div class="task-list" id="taskList">
<p style="text-align: center; color: #718096; padding: 12px;">No predefined tasks - You can type any task name in Batch Entry!</p>
</div>
</div>
</div>
</div>

<!-- DASHBOARD TAB -->
<div id="dashboard" class="tab-content">
<h2 class="section-title">Performance Analytics Dashboard</h2>
<p class="section-subtitle">Real-time workload distribution and productivity metrics</p>

<!-- Time Period Selector -->
<div class="period-selector">
<h4>üìÖ Select Time Period</h4>
<div class="period-controls">
<div class="form-group">
<label for="timePeriod">Time Period</label>
<select id="timePeriod" onchange="changeTimePeriod()">
<option value="today">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
<option value="custom">Custom Range</option>
</select>
</div>
<div class="form-group" id="startDateGroup" style="display: none;">
<label for="startDate">Start Date</label>
<input type="date" id="startDate" value="">
</div>
<div class="form-group" id="endDateGroup" style="display: none;">
<label for="endDate">End Date</label>
<input type="date" id="endDate" value="">
</div>
<div class="form-group">
<label for="filterEmployeeDashboard">Filter by Employee</label>
<select id="filterEmployeeDashboard" onchange="loadDashboard()">
<option value="">All Employees (Team View)</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<button onclick="loadDashboard()" style="width: auto; margin-bottom: 0;">
üìä Load Data
</button>
</div>
<div id="currentPeriodDisplay" class="current-period-display">
Showing: Today - All Employees
</div>
</div>

<div class="stats-grid">
<div class="stat-card">
<h3>TOTAL TASKS</h3>
<div class="value" id="totalTasks">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">in selected period</div>
</div>
<div class="stat-card">
<h3>TOTAL HOURS</h3>
<div class="value" id="totalHours">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">all employees combined</div>
</div>
<div class="stat-card">
<h3>AVERAGE HOURS</h3>
<div class="value" id="avgHours">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">per employee</div>
</div>
<div class="stat-card">
<h3>TOP PERFORMER</h3>
<div class="value" id="mostActive">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">most hours worked</div>
</div>
<div class="stat-card">
<h3>PRIMARY TASK</h3>
<div class="value" id="busiestTask">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">most frequent task</div>
</div>
<div class="stat-card">
<h3>AVG TASK TIME</h3>
<div class="value" id="avgTaskTime">-</div>
<div style="font-size: 12px; color: #718096; margin-top: 4px;">minutes per task</div>
</div>
</div>

<div class="card" style="margin-top: 24px;">
<h3 style="font-size: 16px; color: #2d3748; margin-bottom: 16px; font-weight: 600;">Workload Distribution</h3>
<div class="chart-container">
<canvas id="fairnessChart"></canvas>
</div>
</div>

<!-- Employee Performance Table -->
<div class="card" style="margin-top: 24px;">
<h3 style="font-size: 16px; color: #2d3748; margin-bottom: 16px; font-weight: 600;">
<span id="employeeTableTitle">Employee Performance Details</span>
</h3>
<div style="overflow-x: auto;">
<table class="employee-table">
<thead>
<tr>
<th>Employee</th>
<th style="text-align: center;">Tasks Completed</th>
<th style="text-align: center;">Total Hours</th>
<th style="text-align: center;">Avg Hours/Task</th>
<th style="text-align: center;">Top Task</th>
</tr>
</thead>
<tbody id="employeePerformanceTable">
<tr><td colspan="5" style="padding: 24px; text-align: center; color: #718096;">Loading...</td></tr>
</tbody>
</table>
</div>
</div>

<button onclick="loadDashboard()" style="margin-top: 24px;">
üîÑ Refresh Data
</button>
</div>

<!-- HISTORY TAB -->
<div id="history" class="tab-content">
<h2 class="section-title">Activity Log</h2>
<p class="section-subtitle">Detailed record of all completed tasks</p>
<div class="card">
<div class="filter-bar">
<div class="form-group">
<label for="historyTimePeriod">Time Period</label>
<select id="historyTimePeriod" onchange="changeHistoryPeriod()">
<option value="today">Today</option>
<option value="week">This Week</option>
<option value="month">This Month</option>
<option value="custom">Custom Range</option>
</select>
</div>
<div class="form-group" id="historyStartDateGroup" style="display: none;">
<label for="historyStartDate">Start Date</label>
<input type="date" id="historyStartDate" value="">
</div>
<div class="form-group" id="historyEndDateGroup" style="display: none;">
<label for="historyEndDate">End Date</label>
<input type="date" id="historyEndDate" value="">
</div>
<div class="form-group">
<label for="filterEmployee">Filter by Employee</label>
<select id="filterEmployee" onchange="loadHistory()">
<option value="">Show All Employees</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<button onclick="loadHistory()" style="width: auto; margin-bottom: 0;">
üîç Load History
</button>
</div>
<div class="log-list" id="logList">
<p style="text-align: center; color: #718096; padding: 24px;">Loading activity log...</p>
</div>
</div>
</div>
</div>

<script>
// ========== SUPABASE SETUP ==========
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const { createClient } = window.supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let activeLogId = null;
let activeEmployeeId = null;
let activeTaskName = null;
let startTime = null;
let timerInterval = null;
let fairnessChart = null;
let taskRowCount = 0;

// Set today's date on load
window.onload = function() {
const today = new Date().toISOString().split('T')[0];
document.getElementById('batchDate').value = today;
document.getElementById('endDate').value = today;
document.getElementById('historyEndDate').value = today;
loadTaskList();
changeTimePeriod();
loadHistory();
addTaskRow();
};

// ========== TAB SWITCHING ==========
function switchTab(tabName) {
document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
document.getElementById(tabName).classList.add('active');
event.target.classList.add('active');
if (tabName === 'dashboard') loadDashboard();
else if (tabName === 'history') loadHistory();
else if (tabName === 'tasks') loadTaskList();
}

// ========== TIME PERIOD MANAGEMENT ==========
function changeTimePeriod() {
const period = document.getElementById('timePeriod').value;
const startDateGroup = document.getElementById('startDateGroup');
const endDateGroup = document.getElementById('endDateGroup');
const today = new Date().toISOString().split('T')[0];

startDateGroup.style.display = 'none';
endDateGroup.style.display = 'none';

if (period === 'week') {
const weekRange = getWeekRange();
document.getElementById('startDate').value = weekRange.start;
document.getElementById('endDate').value = weekRange.end;
} else if (period === 'month') {
const monthRange = getMonthRange();
document.getElementById('startDate').value = monthRange.start;
document.getElementById('endDate').value = monthRange.end;
} else if (period === 'custom') {
startDateGroup.style.display = 'block';
endDateGroup.style.display = 'block';
const lastWeek = new Date();
lastWeek.setDate(lastWeek.getDate() - 7);
document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
document.getElementById('endDate').value = today;
}

loadDashboard();
}

function changeHistoryPeriod() {
const period = document.getElementById('historyTimePeriod').value;
const startDateGroup = document.getElementById('historyStartDateGroup');
const endDateGroup = document.getElementById('historyEndDateGroup');
const today = new Date().toISOString().split('T')[0];

startDateGroup.style.display = 'none';
endDateGroup.style.display = 'none';

if (period === 'week') {
const weekRange = getWeekRange();
document.getElementById('historyStartDate').value = weekRange.start;
document.getElementById('historyEndDate').value = weekRange.end;
} else if (period === 'month') {
const monthRange = getMonthRange();
document.getElementById('historyStartDate').value = monthRange.start;
document.getElementById('historyEndDate').value = monthRange.end;
} else if (period === 'custom') {
startDateGroup.style.display = 'block';
endDateGroup.style.display = 'block';
const lastWeek = new Date();
lastWeek.setDate(lastWeek.getDate() - 7);
document.getElementById('historyStartDate').value = lastWeek.toISOString().split('T')[0];
document.getElementById('historyEndDate').value = today;
}

loadHistory();
}

function getWeekRange() {
const now = new Date();
const dayOfWeek = now.getDay();
const startOfWeek = new Date(now);
startOfWeek.setDate(now.getDate() - dayOfWeek);
startOfWeek.setHours(0, 0, 0, 0);

const endOfWeek = new Date(startOfWeek);
endOfWeek.setDate(startOfWeek.getDate() + 6);
endOfWeek.setHours(23, 59, 59, 999);

return {
start: startOfWeek.toISOString().split('T')[0],
end: endOfWeek.toISOString().split('T')[0]
};
}

function getMonthRange() {
const now = new Date();
const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);
const endOfMonth = new Date(now.getFullYear(), now.getMonth() + 1, 0);

return {
start: startOfMonth.toISOString().split('T')[0],
end: endOfMonth.toISOString().split('T')[0]
};
}

function formatDate(dateStr) {
const date = new Date(dateStr);
return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function getDateRange() {
const period = document.getElementById('timePeriod').value;

if (period === 'today') {
const today = new Date().toISOString().split('T')[0];
return { start: today, end: today };
} else if (period === 'week') {
return getWeekRange();
} else if (period === 'month') {
return getMonthRange();
} else if (period === 'custom') {
return {
start: document.getElementById('startDate').value,
end: document.getElementById('endDate').value
};
}

return getWeekRange();
}

function getHistoryDateRange() {
const period = document.getElementById('historyTimePeriod').value;

if (period === 'today') {
const today = new Date().toISOString().split('T')[0];
return { start: today, end: today };
} else if (period === 'week') {
return getWeekRange();
} else if (period === 'month') {
return getMonthRange();
} else if (period === 'custom') {
return {
start: document.getElementById('historyStartDate').value,
end: document.getElementById('historyEndDate').value
};
}

return getWeekRange();
}

// ========== BATCH ENTRY FUNCTIONS ==========
function addTaskRow() {
taskRowCount++;
const tbody = document.getElementById('batchTableBody');
const row = document.createElement('tr');
row.id = `taskRow${taskRowCount}`;
row.innerHTML = `
<td>
<input type="time" class="timeIn" onchange="calculateDuration(${taskRowCount})" required>
</td>
<td>
<input type="time" class="timeOut" onchange="calculateDuration(${taskRowCount})" required>
</td>
<td>
<input type="text" class="taskName" placeholder="Type task name..." required>
</td>
<td class="duration">-</td>
<td>
<button class="delete-row-btn" onclick="deleteTaskRow(${taskRowCount})">‚úï</button>
</td>
`;
tbody.appendChild(row);
}

function deleteTaskRow(rowId) {
const row = document.getElementById(`taskRow${rowId}`);
if (row) {
row.remove();
updateSummary();
}
}

function clearAllRows() {
if (confirm('Clear all task rows?')) {
document.getElementById('batchTableBody').innerHTML = '';
taskRowCount = 0;
updateSummary();
addTaskRow();
}
}

function calculateDuration(rowId) {
const row = document.getElementById(`taskRow${rowId}`);
if (!row) return;
const timeIn = row.querySelector('.timeIn').value;
const timeOut = row.querySelector('.timeOut').value;
const durationCell = row.querySelector('.duration');
if (timeIn && timeOut) {
const start = new Date(`2000-01-01T${timeIn}`);
const end = new Date(`2000-01-01T${timeOut}`);
if (end <= start) {
durationCell.innerHTML = '<span style="color: #ef4444;">Invalid</span>';
} else {
const diff = (end - start) / 60000;
const h = Math.floor(diff / 60);
const m = Math.round(diff % 60);
durationCell.textContent = h > 0 ? `${h}h ${m}m` : `${m}m`;
}
} else {
durationCell.textContent = '-';
}
updateSummary();
checkOverlaps();
}

function checkOverlaps() {
const rows = document.querySelectorAll('#batchTableBody tr');
const times = [];
let hasOverlap = false;
rows.forEach(row => {
const timeIn = row.querySelector('.timeIn').value;
const timeOut = row.querySelector('.timeOut').value;
if (timeIn && timeOut) {
times.push({
start: new Date(`2000-01-01T${timeIn}`),
end: new Date(`2000-01-01T${timeOut}`),
row: row
});
}
});
for (let i = 0; i < times.length; i++) {
for (let j = i + 1; j < times.length; j++) {
if (times[i].start < times[j].end && times[i].end > times[j].start) {
hasOverlap = true;
break;
}
}
}
const warningDiv = document.getElementById('overlapWarning');
if (hasOverlap) {
warningDiv.classList.remove('hidden');
} else {
warningDiv.classList.add('hidden');
}
}

function updateSummary() {
const rows = document.querySelectorAll('#batchTableBody tr');
let totalTasks = 0;
let totalMinutes = 0;
let firstTime = null;
let lastTime = null;
rows.forEach(row => {
const timeIn = row.querySelector('.timeIn').value;
const timeOut = row.querySelector('.timeOut').value;
const task = row.querySelector('.taskName').value.trim();
if (timeIn && timeOut && task) {
totalTasks++;
const start = new Date(`2000-01-01T${timeIn}`);
const end = new Date(`2000-01-01T${timeOut}`);
if (end > start) {
totalMinutes += (end - start) / 60000;
}
if (!firstTime || timeIn < firstTime) firstTime = timeIn;
if (!lastTime || timeOut > lastTime) lastTime = timeOut;
}
});
const totalHours = (totalMinutes / 60).toFixed(1);
document.getElementById('summaryTotalTasks').textContent = totalTasks;
document.getElementById('summaryTotalHours').textContent = totalHours;
document.getElementById('summaryFirstTask').textContent = firstTime ? formatTime12(firstTime) : '-';
document.getElementById('summaryLastTask').textContent = lastTime ? formatTime12(lastTime) : '-';
if (totalTasks > 0) {
document.getElementById('batchSummary').style.display = 'block';
} else {
document.getElementById('batchSummary').style.display = 'none';
}
}

function formatTime12(time24) {
const [hours, minutes] = time24.split(':');
const hour = parseInt(hours);
const ampm = hour >= 12 ? 'PM' : 'AM';
const hour12 = hour % 12 || 12;
return `${hour12}:${minutes} ${ampm}`;
}

async function saveBatchTasks() {
const date = document.getElementById('batchDate').value;
const employee = document.getElementById('batchEmployee').value;
if (!date || !employee) {
showBatchStatus('Please select date and employee!', 'error');
return;
}
const rows = document.querySelectorAll('#batchTableBody tr');
const tasksToSave = [];
for (const row of rows) {
const timeIn = row.querySelector('.timeIn').value;
const timeOut = row.querySelector('.timeOut').value;
const taskName = row.querySelector('.taskName').value.trim();
if (timeIn && timeOut && taskName) {
if (timeIn >= timeOut) {
showBatchStatus(`Invalid time: ${timeIn} to ${timeOut} for task ${taskName}`, 'error');
return;
}
tasksToSave.push({
timeIn,
timeOut,
taskName
});
}
}
if (tasksToSave.length === 0) {
showBatchStatus('Please fill at least one task!', 'error');
return;
}
if (!confirm(`Save ${tasksToSave.length} task(s) for ${employee} on ${formatDate(date)}?`)) {
return;
}
try {
let emp = await getOrCreateEmployee(employee);
for (const taskData of tasksToSave) {
let task = await getOrCreateTask(taskData.taskName);
const startDateTime = new Date(`${date}T${taskData.timeIn}`);
const endDateTime = new Date(`${date}T${taskData.timeOut}`);
const { error: logError } = await supabaseClient
.from('task_time_logs')
.insert({
employee_id: emp.id,
task_id: task.id,
start_time: startDateTime.toISOString(),
end_time: endDateTime.toISOString(),
date: date
});
if (logError) throw logError;
}
showBatchStatus(`‚úÖ Successfully saved ${tasksToSave.length} task(s)!`, 'success');
document.getElementById('batchTableBody').innerHTML = '';
taskRowCount = 0;
addTaskRow();
updateSummary();
loadDashboard();
loadHistory();
} catch (error) {
console.error('Error saving batch tasks:', error);
showBatchStatus('‚ùå Error saving tasks. Please try again.', 'error');
}
}

async function getOrCreateEmployee(name) {
const { data: emp, error } = await supabaseClient
.from('kitchen_prep_employees')
.select('id')
.eq('name', name)
.single();
if (emp) return emp;
const { data: newEmp, error: insertError } = await supabaseClient
.from('kitchen_prep_employees')
.insert({ name: name })
.select()
.single();
if (insertError) throw insertError;
return newEmp;
}

async function getOrCreateTask(name) {
const { data: task, error } = await supabaseClient
.from('kitchen_tasks')
.select('id')
.eq('name', name)
.single();
if (task) return task;
const { data: newTask, error: insertError } = await supabaseClient
.from('kitchen_tasks')
.insert({ name: name, description: name })
.select()
.single();
if (insertError) throw insertError;
return newTask;
}

function showBatchStatus(message, type) {
const statusDiv = document.getElementById('batchStatus');
statusDiv.textContent = message;
statusDiv.className = type;
statusDiv.classList.remove('hidden');
setTimeout(() => statusDiv.classList.add('hidden'), 5000);
}

// ========== TASK MANAGEMENT ==========
async function loadTaskList() {
try {
const { data: tasks, error } = await supabaseClient
.from('kitchen_tasks')
.select('id, name')
.order('name', { ascending: true });
if (error) {
console.error('Error loading tasks:', error);
document.getElementById('taskList').innerHTML = '<p style="color: #718096; padding: 12px;">No predefined tasks - You can type any task name in Batch Entry!</p>';
return;
}
const taskListDiv = document.getElementById('taskList');
if (!tasks || tasks.length === 0) {
taskListDiv.innerHTML = '<p style="text-align: center; color: #718096; padding: 12px;">No predefined tasks - You can type any task name in Batch Entry!</p>';
return;
}
let html = '';
tasks.forEach(task => {
html += `
<div class="task-item">
<span style="color: #2d3748; font-weight: 500;">${task.name}</span>
<button class="delete-task" onclick="deleteTask('${task.id}', '${task.name}')">Delete</button>
</div>
`;
});
taskListDiv.innerHTML = html;
} catch (error) {
console.error('Error loading tasks:', error);
document.getElementById('taskList').innerHTML = '<p style="color: #718096; padding: 12px;">No predefined tasks - You can type any task name in Batch Entry!</p>';
}
}

async function addCustomTask() {
const taskName = document.getElementById('newTaskName').value.trim();
if (!taskName) {
showTaskStatus('Please enter a task name!', 'error');
return;
}
try {
const { data: existing, error: checkErr } = await supabaseClient
.from('kitchen_tasks')
.select('id')
.eq('name', taskName)
.single();
if (!checkErr && existing) {
showTaskStatus('Task already exists!', 'error');
return;
}
const { error: insertErr } = await supabaseClient
.from('kitchen_tasks')
.insert({ name: taskName, description: taskName });
if (insertErr) throw insertErr;
document.getElementById('newTaskName').value = '';
showTaskStatus(`Task "${taskName}" added successfully!`, 'success');
loadTaskList();
} catch (error) {
console.error('Error adding task:', error);
showTaskStatus('Error adding task. Please try again.', 'error');
}
}

async function deleteTask(taskId, taskName) {
if (!confirm(`Delete task "${taskName}"? This will NOT delete existing logs with this task.`)) return;
try {
const { error } = await supabaseClient
.from('kitchen_tasks')
.delete()
.eq('id', taskId);
if (error) throw error;
showTaskStatus(`Task "${taskName}" deleted successfully!`, 'success');
loadTaskList();
} catch (error) {
console.error('Error deleting task:', error);
showTaskStatus('Error deleting task.', 'error');
}
}

function showTaskStatus(message, type) {
const statusDiv = document.getElementById('taskStatus');
statusDiv.textContent = message;
statusDiv.className = type;
statusDiv.classList.remove('hidden');
setTimeout(() => statusDiv.classList.add('hidden'), 5000);
}

// ========== REAL-TIME TIMER ==========
async function startTask() {
const empName = document.getElementById('employee').value;
const taskName = document.getElementById('task').value.trim();
if (!empName || !taskName) {
showStatus('Please select employee name and enter task!', 'error');
return;
}
try {
const emp = await getOrCreateEmployee(empName);
const task = await getOrCreateTask(taskName);
const now = new Date();
const { data: log, error: logError } = await supabaseClient
.from('task_time_logs')
.insert({
employee_id: emp.id,
task_id: task.id,
start_time: now,
date: now.toISOString().split('T')[0]
})
.select()
.single();
if (logError) throw logError;
activeLogId = log.id;
activeEmployeeId = emp.id;
activeTaskName = taskName;
startTime = now;
document.getElementById('startBtn').disabled = true;
document.getElementById('stopBtn').disabled = false;
document.getElementById('employee').disabled = true;
document.getElementById('task').disabled = true;
document.getElementById('currentTaskDisplay').textContent = `${empName} ‚Ä¢ ${taskName}`;
document.getElementById('currentTaskInfo').classList.remove('hidden');
startTimer();
showStatus(`Task started: ${taskName}`, 'success');
} catch (error) {
console.error('Error starting task:', error);
showStatus('Error starting task. Please try again.', 'error');
}
}

async function stopTask() {
if (!activeLogId) {
showStatus('No active task!', 'error');
return;
}
try {
const now = new Date();
const { error } = await supabaseClient
.from('task_time_logs')
.update({ end_time: now })
.eq('id', activeLogId);
if (error) throw error;
clearInterval(timerInterval);
document.getElementById('startBtn').disabled = false;
document.getElementById('stopBtn').disabled = true;
document.getElementById('employee').disabled = false;
document.getElementById('task').disabled = false;
document.getElementById('currentTaskInfo').classList.add('hidden');
document.getElementById('employee').value = '';
document.getElementById('task').value = '';
activeLogId = null;
activeEmployeeId = null;
activeTaskName = null;
startTime = null;
showStatus('Task completed successfully!', 'success');
loadDashboard();
loadHistory();
} catch (error) {
console.error('Error stopping task:', error);
showStatus('Error stopping task. Please try again.', 'error');
}
}

function startTimer() {
clearInterval(timerInterval);
timerInterval = setInterval(() => {
if (!startTime) return;
const elapsed = Math.floor((new Date() - startTime) / 1000);
const h = Math.floor(elapsed / 3600);
const m = Math.floor((elapsed % 3600) / 60);
const s = elapsed % 60;
const timeStr = `${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
document.getElementById('elapsedTime').textContent = `Elapsed Time: ${timeStr}`;
}, 1000);
}

function showStatus(message, type) {
const statusDiv = document.getElementById('status');
statusDiv.textContent = message;
statusDiv.className = type;
statusDiv.classList.remove('hidden');
setTimeout(() => statusDiv.classList.add('hidden'), 5000);
}

// ========== DASHBOARD ==========
async function loadDashboard() {
try {
const dateRange = getDateRange();
const period = document.getElementById('timePeriod').value;
const filterEmployee = document.getElementById('filterEmployeeDashboard').value;

let periodText = '';
if (period === 'today') periodText = `Today - ${formatDate(dateRange.start)}`;
else if (period === 'week') periodText = `This Week - ${formatDate(dateRange.start)} to ${formatDate(dateRange.end)}`;
else if (period === 'month') periodText = `This Month - ${formatDate(dateRange.start)} to ${formatDate(dateRange.end)}`;
else periodText = `${formatDate(dateRange.start)} to ${formatDate(dateRange.end)}`;

const employeeText = filterEmployee ? filterEmployee : 'All Employees (Team View)';
document.getElementById('currentPeriodDisplay').textContent = `Showing: ${periodText} ‚Ä¢ ${employeeText}`;
document.getElementById('employeeTableTitle').textContent = filterEmployee ?
`${filterEmployee} - Performance Details` : 'Employee Performance Details (All Team Members)';

let query = supabaseClient
.from('task_time_logs')
.select(`
id,
start_time,
end_time,
date,
kitchen_prep_employees(name),
kitchen_tasks(name)
`)
.gte('date', dateRange.start)
.lte('date', dateRange.end)
.order('start_time', { ascending: false });

if (filterEmployee) {
const { data: emp, error: empError } = await supabaseClient
.from('kitchen_prep_employees')
.select('id')
.eq('name', filterEmployee)
.single();
if (!empError && emp) {
query = query.eq('employee_id', emp.id);
}
}

const { data: logs, error } = await query;

if (error) {
console.error('Supabase error loading dashboard:', error);
document.getElementById('totalTasks').textContent = 'Error';
document.getElementById('totalHours').textContent = 'Error';
document.getElementById('avgHours').textContent = 'Error';
document.getElementById('mostActive').textContent = 'Error';
document.getElementById('busiestTask').textContent = 'Error';
document.getElementById('avgTaskTime').textContent = 'Error';
return;
}

console.log('Dashboard data loaded:', logs?.length || 0, 'logs');

const stats = calculateStats(logs || []);

document.getElementById('totalTasks').textContent = stats.totalTasks;
document.getElementById('totalHours').textContent = stats.totalHours.toFixed(1);
document.getElementById('avgHours').textContent = stats.avgHours.toFixed(1);
document.getElementById('mostActive').textContent = stats.mostActive || 'N/A';
document.getElementById('busiestTask').textContent = stats.busiestTask || 'N/A';
document.getElementById('avgTaskTime').textContent = stats.avgTaskTime;

updateFairnessChart(stats.hoursPerCook);
updateEmployeePerformanceTable(stats);

} catch (error) {
console.error('Error loading dashboard:', error);
document.getElementById('totalTasks').textContent = 'Error';
document.getElementById('totalHours').textContent = 'Error';
}
}

function calculateStats(logs) {
const hoursPerCook = {};
const tasksCount = {};
const employeeStats = {};
let totalDuration = 0;
let completedTasks = 0;

logs.forEach(log => {
if (!log.end_time) return;

const cook = log.kitchen_prep_employees?.name || 'Unknown';
const task = log.kitchen_tasks?.name || 'Unknown';
const duration = (new Date(log.end_time) - new Date(log.start_time)) / 3600000;
const durationMinutes = (new Date(log.end_time) - new Date(log.start_time)) / 60000;

hoursPerCook[cook] = (hoursPerCook[cook] || 0) + duration;
tasksCount[task] = (tasksCount[task] || 0) + 1;
totalDuration += duration;
completedTasks++;

if (!employeeStats[cook]) {
employeeStats[cook] = {
totalHours: 0,
taskCount: 0,
tasks: {},
totalMinutes: 0
};
}
employeeStats[cook].totalHours += duration;
employeeStats[cook].taskCount += 1;
employeeStats[cook].tasks[task] = (employeeStats[cook].tasks[task] || 0) + 1;
employeeStats[cook].totalMinutes += durationMinutes;
});

let mostActive = 'N/A', maxHours = 0;
for (const [cook, hours] of Object.entries(hoursPerCook)) {
if (hours > maxHours) { maxHours = hours; mostActive = cook; }
}

let busiestTask = 'N/A', maxTasks = 0;
for (const [task, count] of Object.entries(tasksCount)) {
if (count > maxTasks) { maxTasks = count; busiestTask = task; }
}

const avgHours = Object.keys(hoursPerCook).length > 0
? totalDuration / Object.keys(hoursPerCook).length
: 0;

const avgTaskTime = completedTasks > 0
? Math.round(totalDuration * 60 / completedTasks)
: 0;

for (const cook in employeeStats) {
let topTask = 'N/A', topTaskCount = 0;
for (const [task, count] of Object.entries(employeeStats[cook].tasks)) {
if (count > topTaskCount) {
topTaskCount = count;
topTask = task;
}
}
employeeStats[cook].topTask = topTask;
}

return {
totalTasks: completedTasks,
totalHours: totalDuration,
avgHours,
mostActive,
busiestTask,
avgTaskTime,
hoursPerCook,
employeeStats
};
}

function updateFairnessChart(hoursPerCook) {
const ctx = document.getElementById('fairnessChart').getContext('2d');
if (fairnessChart) {
fairnessChart.destroy();
}

const cookNames = Object.keys(hoursPerCook);
const hours = Object.values(hoursPerCook);

const colors = [
'rgba(44, 82, 130, 0.8)',
'rgba(74, 85, 104, 0.8)',
'rgba(100, 116, 139, 0.8)',
'rgba(142, 152, 167, 0.8)',
'rgba(34, 197, 94, 0.8)',
'rgba(239, 68, 68, 0.8)'
];

const borderColors = [
'rgba(44, 82, 130, 1)',
'rgba(74, 85, 104, 1)',
'rgba(100, 116, 139, 1)',
'rgba(142, 152, 167, 1)',
'rgba(34, 197, 94, 1)',
'rgba(239, 68, 68, 1)'
];

fairnessChart = new Chart(ctx, {
type: 'bar',
data: {
labels: cookNames.length > 0 ? cookNames : ['No Data'],
datasets: [{
label: 'Hours Worked',
data: cookNames.length > 0 ? hours : [0],
backgroundColor: colors.slice(0, cookNames.length),
borderColor: borderColors.slice(0, cookNames.length),
borderWidth: 2,
borderRadius: 4
}]
},
options: {
responsive: true,
maintainAspectRatio: false,
plugins: {
legend: { display: false },
tooltip: {
backgroundColor: 'rgba(44, 82, 130, 0.9)',
titleColor: '#fff',
bodyColor: '#fff',
borderColor: 'rgba(255, 255, 255, 0.2)',
borderWidth: 1
}
},
scales: {
y: {
beginAtZero: true,
grid: {
color: 'rgba(0, 0, 0, 0.05)'
},
ticks: {
color: '#718096',
font: { size: 12 }
},
title: {
display: true,
text: 'Hours',
color: '#4a5568',
font: { size: 13, weight: '600' }
}
},
x: {
grid: {
display: false
},
ticks: {
color: '#4a5568',
font: { size: 13, weight: '600' }
},
title: {
display: true,
text: 'Kitchen Prep Employees',
color: '#4a5568',
font: { size: 13, weight: '600' }
}
}
}
}
});
}

function updateEmployeePerformanceTable(stats) {
const tbody = document.getElementById('employeePerformanceTable');
const filterEmployee = document.getElementById('filterEmployeeDashboard').value;

if (!stats.employeeStats || Object.keys(stats.employeeStats).length === 0) {
tbody.innerHTML = '<tr><td colspan="5" style="padding: 24px; text-align: center; color: #718096;">No data available for this period</td></tr>';
return;
}

const employeeCount = Object.keys(stats.employeeStats).length;
const teamAvgHours = employeeCount > 0 ? stats.totalHours / employeeCount : 0;

let html = '';
for (const [employee, data] of Object.entries(stats.employeeStats)) {
if (filterEmployee && employee !== filterEmployee) continue;

const avgHoursPerTask = data.taskCount > 0 ? (data.totalHours / data.taskCount).toFixed(2) : '0.00';

html += `
<tr>
<td class="highlight">${employee}</td>
<td style="text-align: center;">${data.taskCount}</td>
<td style="text-align: center; font-weight: 600; color: #2c5282;">${data.totalHours.toFixed(1)}</td>
<td style="text-align: center;">${avgHoursPerTask}</td>
<td style="text-align: center; color: #718096;">${data.topTask}</td>
</tr>
`;
}

tbody.innerHTML = html;
}

// ========== HISTORY ==========
async function loadHistory() {
try {
const dateRange = getHistoryDateRange();
const filterCook = document.getElementById('filterEmployee').value;

let query = supabaseClient
.from('task_time_logs')
.select(`
id,
start_time,
end_time,
date,
kitchen_prep_employees(name),
kitchen_tasks(name)
`)
.gte('date', dateRange.start)
.lte('date', dateRange.end)
.order('start_time', { ascending: false });

if (filterCook) {
const { data: emp, error: empError } = await supabaseClient
.from('kitchen_prep_employees')
.select('id')
.eq('name', filterCook)
.single();
if (!empError && emp) {
query = query.eq('employee_id', emp.id);
}
}

const { data: logs, error } = await query;
if (error) {
console.error('Error loading history:', error);
document.getElementById('logList').innerHTML =
'<p style="text-align: center; color: #ef4444; padding: 24px;">Error loading activity log</p>';
return;
}
displayLogs(logs || []);

} catch (error) {
console.error('Error loading history:', error);
document.getElementById('logList').innerHTML =
'<p style="text-align: center; color: #ef4444; padding: 24px;">Error loading activity log</p>';
}
}

function displayLogs(logs) {
const logList = document.getElementById('logList');
if (!logs || logs.length === 0) {
logList.innerHTML = '<p style="text-align: center; color: #718096; padding: 24px;">No tasks logged for this period</p>';
return;
}

let html = '';
logs.forEach(log => {
const cook = log.kitchen_prep_employees.name;
const task = log.kitchen_tasks.name;
const date = formatDate(log.date);
const start = new Date(log.start_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
const end = log.end_time
? new Date(log.end_time).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })
: 'In Progress';

let duration = '‚Äî';
if (log.end_time) {
const diff = (new Date(log.end_time) - new Date(log.start_time)) / 60000;
const h = Math.floor(diff / 60);
const m = Math.round(diff % 60);
duration = h > 0 ? `${h}h ${m}m` : `${m}m`;
}

html += `
<div class="log-item">
<div class="log-time">${date}<br>${start} - ${end}</div>
<div class="log-task">
<strong style="color: #2c5282;">${cook}</strong> ‚Ä¢ ${task}
</div>
<div class="log-duration">${duration}</div>
</div>
`;
});
logList.innerHTML = html;
}
</script>
</body>
</html>
