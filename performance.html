<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Workforce Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=DM+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #f0f4f8; color: #2d3748; min-height: 100vh; }
/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#loginScreen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 60%, #2b6cb0 100%);
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: white; border-radius: 20px; padding: 48px 40px;
  width: 100%; max-width: 420px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.3);
  text-align: center;
}
.login-logo { font-size: 48px; margin-bottom: 8px; }
.login-title { font-size: 24px; font-weight: 700; color: #1a365d; margin-bottom: 4px; }
.login-subtitle { font-size: 14px; color: #718096; margin-bottom: 32px; }
.login-field { margin-bottom: 16px; text-align: left; }
.login-field label { display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
.login-field input {
  width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0;
  border-radius: 10px; font-size: 15px; font-family: inherit;
  transition: all 0.2s;
}
.login-field input:focus { outline: none; border-color: #2c5282; box-shadow: 0 0 0 3px rgba(44,82,130,0.15); }
.login-btn {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  background: linear-gradient(135deg, #2c5282, #1a365d);
  color: white; font-size: 16px; font-weight: 700; cursor: pointer;
  transition: all 0.2s; margin-top: 8px;
}
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(44,82,130,0.4); }
.login-btn:disabled { background: #a0aec0; transform: none; box-shadow: none; cursor: not-allowed; }
#loginError { color: #e53e3e; font-size: 14px; margin-top: 12px; min-height: 20px; font-weight: 500; }
/* ‚îÄ‚îÄ APP SHELL ‚îÄ‚îÄ */
#appShell { display: none; }
.container { max-width: 1600px; margin: 0 auto; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
header {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  color: white; padding: 20px 40px;
  display: flex; justify-content: space-between; align-items: center;
}
header h1 { font-size: 24px; font-weight: 700; }
.header-subtitle { font-size: 13px; opacity: 0.85; margin-top: 3px; }
.header-user {
  display: flex; align-items: center; gap: 12px;
}
.user-badge {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600;
}
.admin-badge {
  background: #f6ad55; color: #7b341e;
  border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.logout-btn {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: white; border-radius: 8px; padding: 7px 16px; font-size: 13px;
  font-weight: 600; cursor: pointer; transition: all 0.2s; width: auto;
}
.logout-btn:hover { background: rgba(255,255,255,0.25); }
/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
.tabs { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; }
.tab-btn {
  flex: 1; min-width: 120px; padding: 14px 18px; border: none;
  background: none; cursor: pointer; font-size: 13px; font-weight: 600;
  color: #718096; transition: all 0.2s; position: relative;
}
.tab-btn:hover { color: #2c5282; background: #edf2f7; }
.tab-btn.active { color: #2c5282; background: white; }
.tab-btn.active::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 3px; background: #2c5282;
}
.tab-content { display: none; padding: 32px 40px; }
.tab-content.active { display: block; }
/* ‚îÄ‚îÄ FORMS ‚îÄ‚îÄ */
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 7px; font-weight: 600; color: #4a5568; font-size: 13px; }
select, input[type=text], input[type=date], input[type=time], input[type=month], input[type=password] {
  width: 100%; padding: 10px 14px; border: 1.5px solid #cbd5e0;
  border-radius: 8px; font-size: 14px; font-family: inherit; transition: all 0.2s;
}
select:focus, input:focus { outline: none; border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.1); }
/* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
button {
  background: linear-gradient(135deg, #2c5282, #1a365d); color: white;
  border: none; cursor: pointer; font-weight: 600; font-size: 14px;
  padding: 10px 20px; border-radius: 8px; transition: all 0.2s; width: auto;
}
button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(44,82,130,0.25); }
button:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
button.secondary { background: #e2e8f0; color: #4a5568; }
button.secondary:hover { background: #cbd5e0; box-shadow: none; }
button.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
button.success:hover { box-shadow: 0 4px 12px rgba(34,197,94,0.25); }
button.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
button.danger:hover { box-shadow: 0 4px 12px rgba(239,68,68,0.25); }
button.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }
/* ‚îÄ‚îÄ STATUS MESSAGES ‚îÄ‚îÄ */
#globalStatus { padding: 10px 16px; border-radius: 8px; margin: 12px 40px 0; text-align: center; font-weight: 500; font-size: 13px; }
.status-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.status-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
.status-info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
.hidden { display: none !important; }
/* ‚îÄ‚îÄ CARDS ‚îÄ‚îÄ */
.card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; margin-bottom: 24px; }
.section-title { font-size: 20px; font-weight: 700; color: #2d3748; margin-bottom: 6px; }
.section-subtitle { font-size: 13px; color: #718096; margin-bottom: 24px; }
.action-bar { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }
/* ‚îÄ‚îÄ STATS GRID ‚îÄ‚îÄ */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card {
  background: white; padding: 20px; border-radius: 12px; text-align: center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
  transition: all 0.2s; position: relative; overflow: hidden;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: var(--accent, #2c5282);
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
.stat-card h3 { font-size: 11px; color: #718096; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; }
.stat-card .value { font-size: 28px; font-weight: 800; color: #2d3748; line-height: 1; margin-bottom: 4px; }
.stat-card .subtext { font-size: 11px; color: #a0aec0; }
.stat-card.blue   { --accent: #3182ce; } .stat-card.blue   .value { color: #2b6cb0; }
.stat-card.green  { --accent: #38a169; } .stat-card.green  .value { color: #276749; }
.stat-card.orange { --accent: #dd6b20; } .stat-card.orange .value { color: #c05621; }
.stat-card.red    { --accent: #e53e3e; } .stat-card.red    .value { color: #c53030; }
.stat-card.purple { --accent: #805ad5; } .stat-card.purple .value { color: #553c9a; }
.stat-card.teal   { --accent: #319795; } .stat-card.teal   .value { color: #285e61; }
/* ‚îÄ‚îÄ TABLES ‚îÄ‚îÄ */
.schedule-table { width: 100%; border-collapse: collapse; }
.schedule-table th { background: #f8fafc; font-weight: 700; color: #4a5568; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; padding: 10px 14px; text-align: left; border-bottom: 2px solid #e2e8f0; }
.schedule-table td { padding: 12px 14px; border-bottom: 1px solid #f0f0f0; font-size: 13px; vertical-align: middle; }
.schedule-table tr:hover td { background: #f8fafc; }
.task-table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
.badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }
.badge-success  { background: #d1fae5; color: #065f46; }
.badge-warning  { background: #fef3c7; color: #92400e; }
.badge-danger   { background: #fee2e2; color: #991b1b; }
.badge-info     { background: #dbeafe; color: #1e40af; }
.badge-untask   { background: #fde8d8; color: #9c4221; }
.badge-purple   { background: #ede9fe; color: #5b21b6; }
/* ‚îÄ‚îÄ PRODUCTIVITY COLOR BANDS ‚îÄ‚îÄ */
.prod-critical { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
.prod-very-low { background: #ffedd5; color: #9a3412; border: 1px solid #fdba74; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
.prod-low      { background: #fef9c3; color: #854d0e; border: 1px solid #fde047; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
.prod-medium   { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
.prod-good     { background: #dcfce7; color: #166534; border: 1px solid #86efac; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
.prod-excellent { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; font-weight: 700; padding: 3px 10px; border-radius: 10px; font-size: 13px; }
/* ‚îÄ‚îÄ SCHEDULE MANAGEMENT ENHANCEMENTS ‚îÄ‚îÄ */
.repeat-options { background: #f0f9ff; border: 1px solid #bae6fd; border-radius: 10px; padding: 16px; margin-top: 12px; }
.repeat-options h4 { font-size: 13px; color: #0369a1; font-weight: 700; margin-bottom: 12px; }
.copy-options { background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 10px; padding: 16px; margin-top: 12px; }
.copy-options h4 { font-size: 13px; color: #166534; font-weight: 700; margin-bottom: 12px; }
.batch-update-bar { background: #fefce8; border: 1px solid #fde047; border-radius: 10px; padding: 12px 16px; margin-bottom: 14px; display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
/* ‚îÄ‚îÄ COMPARISON CHART ‚îÄ‚îÄ */
.comparison-section { margin-top: 24px; }
.chart-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
.chart-tab-btn { padding: 8px 18px; border-radius: 20px; border: 2px solid #e2e8f0; background: white; color: #4a5568; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
.chart-tab-btn.active { background: #2c5282; color: white; border-color: #2c5282; }
.chart-tab-btn:hover:not(.active) { background: #edf2f7; }
/* ‚îÄ‚îÄ TASK ANALYTICS TABLE ‚îÄ‚îÄ */
.task-analytics-row { cursor: pointer; }
.task-analytics-row:hover td { background: #f0f9ff !important; }
/* ‚îÄ‚îÄ FILTER BAR ‚îÄ‚îÄ */
.filters-bar { background: #f8fafc; padding: 18px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
.filters-bar .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
.filters-bar .form-group { flex: 1; min-width: 150px; margin-bottom: 0; }
/* ‚îÄ‚îÄ PERIOD SELECTOR ‚îÄ‚îÄ */
.period-selector { background: #ebf8ff; padding: 18px; border-radius: 10px; border: 1px solid #bee3f8; margin-bottom: 20px; }
.period-selector h4 { font-size: 13px; color: #2c5282; margin-bottom: 12px; font-weight: 700; }
.current-period-display { margin-top: 10px; padding: 10px 14px; background: white; border-radius: 8px; font-size: 13px; color: #2c5282; font-weight: 600; border: 1px solid #bee3f8; }
/* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
   SCHEDULE MANAGEMENT ‚Äî DESIGN SYSTEM
   Font: Sora (headers) + system stack
   ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

/* Root & page shell */
.sc-root { background: #f4f6fa; min-height: 100vh; padding: 28px 32px !important; }

.sc-page-header {
  display: flex; justify-content: space-between; align-items: flex-start;
  margin-bottom: 24px;
}
.sc-page-title {
  font-size: 22px; font-weight: 800; color: #0f172a;
  letter-spacing: -0.5px; margin: 0 0 4px;
}
.sc-page-sub { font-size: 13px; color: #64748b; font-weight: 500; margin: 0; }

/* Ghost/secondary button */
.sc-ghost-btn {
  background: white; border: 1.5px solid #e2e8f0; border-radius: 8px;
  padding: 7px 14px; font-size: 12px; font-weight: 600; color: #475569;
  cursor: pointer; transition: all 0.15s;
}
.sc-ghost-btn:hover { border-color: #94a3b8; color: #0f172a; }

/* Mode rail switcher */
.sc-mode-rail {
  display: flex; align-items: center;
  background: white; border: 1.5px solid #e2e8f0; border-radius: 14px;
  padding: 6px; margin-bottom: 20px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
  width: fit-content; gap: 2px;
}
.sc-mode-btn {
  display: flex; align-items: center; gap: 7px;
  padding: 9px 18px; border-radius: 10px; border: none;
  cursor: pointer; transition: all 0.2s;
  background: transparent; color: #64748b;
  font-size: 13px; font-weight: 600;
}
.sc-mode-btn:hover { background: #f8fafc; color: #0f172a; }
.sc-mode-active {
  background: #0f172a !important; color: white !important;
  box-shadow: 0 2px 8px rgba(15,23,42,0.25);
}
.sc-mode-icon { font-size: 16px; font-weight: 400; }
.sc-mode-divider { width: 1px; height: 20px; background: #e2e8f0; }

/* Panel card */
.sc-panel {
  background: white; border-radius: 20px;
  border: 1.5px solid #e8ecf1;
  padding: 28px; margin-bottom: 20px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.05), 0 4px 16px rgba(0,0,0,0.03);
  animation: scFadeIn 0.25s ease both;
}
@keyframes scFadeIn {
  from { opacity: 0; transform: translateY(8px); }
  to   { opacity: 1; transform: translateY(0); }
}
.sc-panel-header {
  display: flex; align-items: center; gap: 14px; margin-bottom: 24px;
  padding-bottom: 20px; border-bottom: 1.5px solid #f1f5f9;
}
.sc-panel-icon {
  width: 44px; height: 44px; border-radius: 12px;
  display: flex; align-items: center; justify-content: center;
  font-size: 20px; font-weight: 700; flex: 0 0 44px;
}
.sc-icon-add    { background: #dbeafe; color: #1d4ed8; }
.sc-icon-copy   { background: #d1fae5; color: #065f46; }
.sc-icon-repeat { background: #ede9fe; color: #5b21b6; }
.sc-panel-title { font-size: 16px; font-weight: 700; color: #0f172a; margin-bottom: 2px; }
.sc-panel-sub   { font-size: 12px; color: #94a3b8; font-weight: 500; }

/* Form fields */
.sc-form-grid { display: grid; gap: 16px; margin-bottom: 18px; }
.sc-form-grid-2 { grid-template-columns: 1fr 1fr; }
.sc-field { display: flex; flex-direction: column; gap: 7px; margin-bottom: 18px; }
.sc-label {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: #64748b;
}
.sc-optional { font-weight: 500; letter-spacing: 0; text-transform: none; color: #94a3b8; }
.sc-input {
  padding: 11px 14px; border: 1.5px solid #e2e8f0; border-radius: 10px;
  font-size: 14px; color: #0f172a; background: #fafbfc;
  transition: all 0.2s; -webkit-appearance: none; font-family: inherit;
  width: 100%; box-sizing: border-box;
}
.sc-input:focus { outline: none; border-color: #3b82f6; background: white; box-shadow: 0 0 0 3px rgba(59,130,246,0.1); }

/* Role chips */
.sc-role-chips { display: flex; flex-wrap: wrap; gap: 8px; }
.sc-role-chip {
  padding: 7px 14px; border-radius: 20px; border: 1.5px solid #e2e8f0;
  font-size: 12px; font-weight: 600; color: #64748b; background: white;
  cursor: pointer; transition: all 0.15s;
}
.sc-role-chip:hover { border-color: #3b82f6; color: #1d4ed8; }
.sc-role-active { background: #1e40af; border-color: #1e40af; color: white !important; }

/* Week blocks */
.sc-week-block {
  background: #f8fafc; border: 1.5px solid #e8ecf1; border-radius: 14px;
  padding: 18px 20px; margin-bottom: 4px;
}
.sc-week-block-label {
  font-size: 10px; font-weight: 800; letter-spacing: 1.2px;
  text-transform: uppercase; color: #94a3b8; margin-bottom: 14px;
}
.sc-arrow-connector {
  text-align: center; font-size: 20px; color: #cbd5e1;
  margin: 6px 0; font-weight: 300; letter-spacing: -1px;
  margin-bottom: 10px;
}

/* Team member avatar chips */
.sc-team-label {
  display: flex; justify-content: space-between; align-items: center;
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 0.8px; color: #64748b; margin-bottom: 10px;
}
.sc-team-toggles { display: flex; gap: 6px; }
.sc-toggle-all {
  padding: 3px 10px; border-radius: 6px; border: 1px solid #e2e8f0;
  font-size: 11px; font-weight: 600; color: #64748b; background: white;
  cursor: pointer; transition: all 0.15s;
}
.sc-toggle-all:hover { background: #f1f5f9; color: #0f172a; }
.sc-avatar-grid { display: flex; flex-wrap: wrap; gap: 10px; }
.sc-emp-chip {
  display: flex; align-items: center; gap: 10px;
  padding: 10px 14px; border-radius: 14px;
  border: 2px solid #e2e8f0; background: white;
  cursor: pointer; transition: all 0.2s; user-select: none;
  position: relative; min-width: 150px;
}
.sc-emp-chip:hover { border-color: #93c5fd; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59,130,246,0.1); }
.sc-emp-chip[data-checked="true"] {
  border-color: #3b82f6; background: #eff6ff;
  box-shadow: 0 0 0 1px #3b82f6;
}
.sc-emp-avatar {
  width: 34px; height: 34px; border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  font-size: 12px; font-weight: 800; color: white; flex: 0 0 34px;
}
.sc-emp-name { font-size: 13px; font-weight: 600; color: #0f172a; flex: 1; }
.sc-emp-check {
  font-size: 12px; font-weight: 700; color: #3b82f6;
  opacity: 0; transition: opacity 0.15s;
}
.sc-emp-chip[data-checked="true"] .sc-emp-check { opacity: 1; }

/* Days stepper */
.sc-stepper { display: flex; align-items: center; gap: 0; border: 1.5px solid #e2e8f0; border-radius: 12px; overflow: hidden; width: fit-content; }
.sc-step-btn {
  width: 44px; height: 44px; border: none; background: #f8fafc;
  font-size: 18px; font-weight: 400; color: #475569; cursor: pointer;
  transition: all 0.15s; flex: 0 0 44px;
}
.sc-step-btn:hover { background: #e2e8f0; color: #0f172a; }
.sc-step-val {
  width: 56px; height: 44px; border: none; border-left: 1.5px solid #e2e8f0; border-right: 1.5px solid #e2e8f0;
  text-align: center; font-size: 18px; font-weight: 700; color: #0f172a;
  background: white; -webkit-appearance: none;
}
.sc-step-val::-webkit-inner-spin-button, .sc-step-val::-webkit-outer-spin-button { -webkit-appearance: none; }
.sc-step-hint { margin-left: 12px; font-size: 12px; color: #94a3b8; font-weight: 500; }

/* Primary action button */
.sc-primary-btn {
  width: 100%; padding: 15px 24px; border-radius: 14px; border: none;
  background: linear-gradient(135deg, #1e3a8a, #1d4ed8);
  color: white; font-size: 15px; font-weight: 700; font-family: inherit;
  cursor: pointer; transition: all 0.2s; margin-top: 8px;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  box-shadow: 0 4px 14px rgba(29,78,216,0.3);
}
.sc-primary-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(29,78,216,0.4); }
.sc-primary-btn:active { transform: scale(0.99); }
.sc-copy-btn   { background: linear-gradient(135deg, #065f46, #059669); box-shadow: 0 4px 14px rgba(5,150,105,0.3); }
.sc-copy-btn:hover { box-shadow: 0 6px 20px rgba(5,150,105,0.4); }
.sc-repeat-btn { background: linear-gradient(135deg, #4c1d95, #7c3aed); box-shadow: 0 4px 14px rgba(124,58,237,0.3); }
.sc-repeat-btn:hover { box-shadow: 0 6px 20px rgba(124,58,237,0.4); }
.sc-btn-arrow  { font-size: 18px; opacity: 0.8; }

/* Status messages */
.sc-status {
  margin-top: 14px; padding: 12px 16px; border-radius: 10px;
  font-size: 13px; font-weight: 600;
}
.sc-status.success { background: #dcfce7; color: #166534; border: 1px solid #bbf7d0; }
.sc-status.error   { background: #fee2e2; color: #991b1b; border: 1px solid #fecaca; }

/* Shifts table card */
.sc-shifts-card {
  background: white; border-radius: 20px; border: 1.5px solid #e8ecf1;
  overflow: hidden; box-shadow: 0 1px 4px rgba(0,0,0,0.05);
}
.sc-shifts-top {
  display: flex; justify-content: space-between; align-items: center;
  flex-wrap: wrap; gap: 12px; padding: 20px 24px; border-bottom: 1.5px solid #f1f5f9;
}
.sc-shifts-title-block { display: flex; align-items: center; gap: 10px; }
.sc-shifts-title { font-size: 15px; font-weight: 700; color: #0f172a; }
.sc-shifts-count {
  background: #f1f5f9; color: #64748b; border-radius: 20px;
  padding: 3px 10px; font-size: 12px; font-weight: 700;
}
.sc-shifts-filters { display: flex; gap: 8px; flex-wrap: wrap; align-items: center; }
.sc-filter-select {
  padding: 7px 12px; border: 1.5px solid #e2e8f0; border-radius: 8px;
  font-size: 13px; color: #0f172a; background: white; cursor: pointer;
  font-family: inherit;
}
.sc-toolbar { padding: 10px 24px 0; }

/* Batch bar */
.sc-batch-bar {
  display: flex; flex-wrap: wrap; align-items: center; gap: 8px;
  padding: 12px 24px; background: #fffbeb; border-bottom: 1.5px solid #fde68a;
}
.sc-batch-count { font-size: 13px; font-weight: 700; color: #92400e; }
.sc-batch-select, .sc-batch-time {
  padding: 6px 10px; border: 1.5px solid #e2e8f0; border-radius: 7px;
  font-size: 12px; background: white; font-family: inherit;
}
.sc-batch-btn { padding: 6px 14px; border-radius: 7px; border: none; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.15s; }
.sc-batch-update { background: #1d4ed8; color: white; }
.sc-batch-delete { background: #dc2626; color: white; }
.sc-batch-ghost  { background: white; border: 1.5px solid #e2e8f0; color: #475569; }

/* Shifts list wrapper */
.sc-list-wrap { overflow-x: auto; }
.sc-list-wrap .schedule-table { border: none; }
.sc-list-wrap .schedule-table th {
  background: #f8fafc; color: #64748b; font-size: 11px;
  font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;
  border-bottom: 1.5px solid #e8ecf1; padding: 12px 16px;
}
.sc-list-wrap .schedule-table td { padding: 12px 16px; border-bottom: 1px solid #f1f5f9; }
.sc-list-wrap .schedule-table tr:last-child td { border-bottom: none; }
.sc-list-wrap .schedule-table tr:hover td { background: #f8fafc; }

/* Mobile tweaks */
@media (max-width: 768px) {
  .sc-root { padding: 16px !important; }
  .sc-form-grid-2 { grid-template-columns: 1fr; }
  .sc-mode-label { display: none; }
  .sc-emp-chip { min-width: 130px; }
  .sc-shifts-top { flex-direction: column; align-items: flex-start; }
}

@import url('https://fonts.googleapis.com/css2?family=DM+Sans:wght@300;400;500;600;700&family=DM+Mono:wght@400;500&display=swap');

/* Portal root */
#portal {
  background: #f0f2f5;
  min-height: 100vh;
  padding: 0 !important;
  font-family: 'DM Sans', sans-serif;
}

/* Hero header */
.ep-hero {
  background: linear-gradient(145deg, #0a1628 0%, #0f2545 40%, #163366 100%);
  padding: 28px 20px 80px;
  position: relative;
  overflow: hidden;
}
.ep-hero::before {
  content: '';
  position: absolute;
  top: -60px; right: -60px;
  width: 240px; height: 240px;
  background: radial-gradient(circle, rgba(59,130,246,0.18) 0%, transparent 70%);
  border-radius: 50%;
}
.ep-hero::after {
  content: '';
  position: absolute;
  bottom: -40px; left: -40px;
  width: 180px; height: 180px;
  background: radial-gradient(circle, rgba(99,102,241,0.14) 0%, transparent 70%);
  border-radius: 50%;
}
.ep-hero-top {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 24px;
}
.ep-logo-mark {
  display: flex;
  align-items: center;
  gap: 8px;
}
.ep-logo-dot {
  width: 8px; height: 8px;
  background: #3b82f6;
  border-radius: 50%;
  box-shadow: 0 0 8px rgba(59,130,246,0.8);
  animation: epPulse 2s ease-in-out infinite;
}
@keyframes epPulse {
  0%,100% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.4); opacity: 0.7; }
}
.ep-brand {
  font-size: 11px;
  font-weight: 600;
  letter-spacing: 2px;
  text-transform: uppercase;
  color: rgba(255,255,255,0.5);
}
.ep-date-chip {
  background: rgba(255,255,255,0.08);
  border: 1px solid rgba(255,255,255,0.12);
  border-radius: 20px;
  padding: 5px 12px;
  font-size: 11px;
  font-weight: 500;
  color: rgba(255,255,255,0.6);
  letter-spacing: 0.3px;
}
.ep-identity {
  position: relative; z-index: 1;
}
.ep-avatar-ring {
  width: 64px; height: 64px;
  border-radius: 50%;
  background: linear-gradient(135deg, #3b82f6, #6366f1);
  display: flex; align-items: center; justify-content: center;
  font-size: 22px; font-weight: 700; color: white;
  margin-bottom: 14px;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.3), 0 0 0 6px rgba(59,130,246,0.1);
}
.ep-name {
  font-size: 24px; font-weight: 700; color: #fff;
  letter-spacing: -0.3px; margin-bottom: 4px;
}
.ep-role-chip {
  display: inline-flex; align-items: center; gap: 6px;
  background: rgba(59,130,246,0.2);
  border: 1px solid rgba(59,130,246,0.35);
  border-radius: 20px; padding: 4px 12px;
  font-size: 11px; font-weight: 600;
  color: #93c5fd; letter-spacing: 0.5px; text-transform: uppercase;
}
.ep-role-dot { width: 5px; height: 5px; background: #3b82f6; border-radius: 50%; }

/* Floating KPI card strip */
.ep-kpi-strip {
  margin: -48px 16px 0;
  background: white;
  border-radius: 20px;
  padding: 20px;
  box-shadow: 0 20px 60px rgba(10,22,40,0.18), 0 4px 12px rgba(0,0,0,0.08);
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 0;
  position: relative; z-index: 10;
}
.ep-kpi-item {
  padding: 14px 16px;
  position: relative;
}
.ep-kpi-item:nth-child(1),
.ep-kpi-item:nth-child(2) {
  border-bottom: 1px solid #f1f5f9;
}
.ep-kpi-item:nth-child(odd) {
  border-right: 1px solid #f1f5f9;
}
.ep-kpi-label {
  font-size: 10px; font-weight: 600;
  text-transform: uppercase; letter-spacing: 1px;
  color: #94a3b8; margin-bottom: 6px;
}
.ep-kpi-value {
  font-size: 22px; font-weight: 700;
  color: #0f172a; line-height: 1;
  font-family: 'DM Mono', monospace;
  margin-bottom: 2px;
}
.ep-kpi-sub {
  font-size: 10px; color: #94a3b8; font-weight: 500;
}
.ep-kpi-item.productive .ep-kpi-value { color: #059669; }
.ep-kpi-item.untask .ep-kpi-value { color: #d97706; }

/* Productivity gauge */
.ep-prod-wrap {
  position: relative;
}
.ep-prod-gauge {
  height: 4px;
  background: #f1f5f9;
  border-radius: 2px;
  margin-top: 8px;
  overflow: hidden;
}
.ep-prod-fill {
  height: 100%; border-radius: 2px;
  transition: width 1s cubic-bezier(0.4,0,0.2,1);
}

/* Week selector tabs */
.ep-week-nav {
  padding: 20px 16px 8px;
}
.ep-section-label {
  font-size: 11px; font-weight: 700; letter-spacing: 1.5px;
  text-transform: uppercase; color: #64748b;
  margin-bottom: 12px;
}
.ep-day-tabs {
  display: flex; gap: 6px; overflow-x: auto;
  padding-bottom: 4px;
  scrollbar-width: none;
}
.ep-day-tabs::-webkit-scrollbar { display: none; }
.ep-day-btn {
  flex: 0 0 auto;
  display: flex; flex-direction: column; align-items: center;
  padding: 10px 14px; border-radius: 14px;
  background: white; border: 1.5px solid #e2e8f0;
  cursor: pointer; transition: all 0.2s;
  min-width: 52px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.05);
}
.ep-day-btn:hover { border-color: #3b82f6; transform: translateY(-1px); }
.ep-day-btn.active {
  background: #0f2545; border-color: #0f2545;
  box-shadow: 0 4px 12px rgba(15,37,69,0.3);
}
.ep-day-btn.has-tasks { border-color: #bfdbfe; }
.ep-day-btn.active.has-tasks { border-color: #0f2545; }
.ep-day-name {
  font-size: 9px; font-weight: 700; letter-spacing: 0.5px;
  text-transform: uppercase; color: #94a3b8; margin-bottom: 4px;
}
.ep-day-num {
  font-size: 16px; font-weight: 700; color: #1e293b; line-height: 1;
}
.ep-day-dot {
  width: 4px; height: 4px; border-radius: 50%;
  background: #3b82f6; margin-top: 4px; opacity: 0;
}
.ep-day-btn.has-tasks .ep-day-dot { opacity: 1; }
.ep-day-btn.active .ep-day-name,
.ep-day-btn.active .ep-day-num { color: rgba(255,255,255,0.9); }
.ep-day-btn.active .ep-day-dot { background: #60a5fa; }

/* Performance card for selected day */
.ep-perf-section {
  padding: 8px 16px 16px;
}
.ep-perf-card {
  background: white;
  border-radius: 20px;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  border: 1px solid #f1f5f9;
}
.ep-perf-header {
  padding: 18px 20px 14px;
  border-bottom: 1px solid #f8fafc;
  display: flex; justify-content: space-between; align-items: center;
}
.ep-perf-date {
  font-size: 15px; font-weight: 700; color: #0f172a;
}
.ep-perf-sched {
  font-size: 11px; color: #94a3b8; margin-top: 2px; font-weight: 500;
}
.ep-prod-badge {
  padding: 6px 14px; border-radius: 20px;
  font-size: 13px; font-weight: 700;
  font-family: 'DM Mono', monospace;
}

/* Timeline view */
.ep-timeline {
  padding: 16px 20px;
}
.ep-timeline-row {
  display: flex; align-items: stretch; gap: 14px;
  margin-bottom: 2px;
}
.ep-timeline-spine {
  display: flex; flex-direction: column; align-items: center; flex: 0 0 20px;
}
.ep-spine-dot {
  width: 10px; height: 10px; border-radius: 50%;
  flex: 0 0 10px; margin-top: 5px;
  border: 2px solid;
}
.ep-spine-line {
  flex: 1; width: 2px; background: #f1f5f9;
  min-height: 20px; margin-top: 2px;
}
.ep-timeline-row:last-child .ep-spine-line { display: none; }
.ep-task-card {
  flex: 1; padding: 12px 14px;
  border-radius: 12px; margin-bottom: 8px;
  border: 1px solid;
  transition: transform 0.15s;
}
.ep-task-card:active { transform: scale(0.98); }
.ep-task-card.type-task {
  background: #f8fbff; border-color: #dbeafe;
}
.ep-task-card.type-task .ep-spine-dot {
  background: #3b82f6; border-color: #3b82f6;
}
.ep-task-card.type-untask {
  background: #fffbf0; border-color: #fde68a;
}
.ep-task-card.type-untask .ep-spine-dot {
  background: #fbbf24; border-color: #fbbf24;
}
.ep-task-name {
  font-size: 13px; font-weight: 600; color: #0f172a; margin-bottom: 4px;
}
.ep-task-meta {
  display: flex; gap: 10px; align-items: center;
}
.ep-task-time {
  font-size: 11px; color: #64748b; font-weight: 500;
  font-family: 'DM Mono', monospace;
}
.ep-task-dur {
  font-size: 11px; font-weight: 700;
  padding: 2px 8px; border-radius: 8px;
}
.type-task .ep-task-dur { background: #dbeafe; color: #1d4ed8; }
.type-untask .ep-task-dur { background: #fef3c7; color: #92400e; }
.ep-empty-day {
  text-align: center; padding: 32px 20px;
  color: #94a3b8;
}
.ep-empty-icon {
  font-size: 36px; margin-bottom: 8px; opacity: 0.4;
}
.ep-empty-text { font-size: 13px; font-weight: 500; }

/* Log task section */
.ep-log-section {
  padding: 0 16px 16px;
}
.ep-log-card {
  background: white; border-radius: 20px;
  border: 1px solid #f1f5f9;
  overflow: hidden;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}
.ep-log-header {
  padding: 18px 20px 14px;
  border-bottom: 1px solid #f8fafc;
  display: flex; justify-content: space-between; align-items: center;
}
.ep-log-title {
  font-size: 15px; font-weight: 700; color: #0f172a;
}
.ep-log-subtitle {
  font-size: 11px; color: #94a3b8; margin-top: 2px;
}
.ep-log-body { padding: 18px 20px; }
.ep-field { margin-bottom: 16px; }
.ep-field label {
  display: block; font-size: 11px; font-weight: 700;
  letter-spacing: 0.8px; text-transform: uppercase;
  color: #64748b; margin-bottom: 7px;
}
.ep-input {
  width: 100%; padding: 12px 14px;
  border: 1.5px solid #e2e8f0; border-radius: 12px;
  font-size: 14px; font-family: 'DM Sans', sans-serif;
  color: #0f172a; background: #f8fafc;
  transition: all 0.2s;
  -webkit-appearance: none;
}
.ep-input:focus {
  outline: none; border-color: #3b82f6;
  background: white;
  box-shadow: 0 0 0 3px rgba(59,130,246,0.1);
}
.ep-time-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.ep-save-btn {
  width: 100%; padding: 15px;
  background: linear-gradient(135deg, #1d4ed8, #1e40af);
  color: white; border: none; border-radius: 14px;
  font-size: 15px; font-weight: 700;
  font-family: 'DM Sans', sans-serif;
  cursor: pointer; letter-spacing: 0.2px;
  transition: all 0.2s; margin-top: 4px;
  box-shadow: 0 4px 14px rgba(29,78,216,0.35);
}
.ep-save-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(29,78,216,0.4); }
.ep-save-btn:active { transform: scale(0.98); }
.ep-save-btn:disabled { background: #94a3b8; box-shadow: none; transform: none; }
.ep-status {
  margin-top: 12px; padding: 12px 16px;
  border-radius: 12px; font-size: 13px; font-weight: 600;
  text-align: center;
}
.ep-status.success { background: #dcfce7; color: #15803d; }
.ep-status.error   { background: #fee2e2; color: #dc2626; }

/* Bottom spacer for mobile */
.ep-bottom-space { height: 32px; }

/* Loading skeleton */
.ep-skeleton {
  background: linear-gradient(90deg, #f1f5f9 25%, #e2e8f0 50%, #f1f5f9 75%);
  background-size: 200% 100%;
  animation: epSkeleton 1.5s infinite;
  border-radius: 8px; height: 14px; margin-bottom: 8px;
}
@keyframes epSkeleton {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

/* Fade in animation for cards */
@keyframes epFadeUp {
  from { opacity: 0; transform: translateY(12px); }
  to   { opacity: 1; transform: translateY(0); }
}
.ep-animate {
  animation: epFadeUp 0.35s cubic-bezier(0.4,0,0.2,1) both;
}
.ep-animate:nth-child(2) { animation-delay: 0.05s; }
.ep-animate:nth-child(3) { animation-delay: 0.1s; }
.ep-animate:nth-child(4) { animation-delay: 0.15s; }

/* Portal overrides for main shell */
#portal.tab-content { padding: 0; }
.portal-header, .task-log-form, .my-tasks-list, #portalStats { display: none !important; }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: white; border-radius: 16px; padding: 32px; max-width: 560px; width: 92%; max-height: 92vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.modal-header h2 { font-size: 18px; font-weight: 700; }
.modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #718096; padding: 0; width: auto; }
/* ‚îÄ‚îÄ CHART ‚îÄ‚îÄ */
.chart-container { height: 320px; padding: 16px; }
/* ‚îÄ‚îÄ PRODUCTIVITY RING ‚îÄ‚îÄ */
.productivity-ring { position: relative; width: 80px; height: 80px; margin: 0 auto 8px; }
.productivity-ring svg { transform: rotate(-90deg); }
.productivity-ring .pct { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; }
/* ‚îÄ‚îÄ UNTASK BADGE ‚îÄ‚îÄ */
.untask-row td { background: #fff7ed !important; }
.untask-row:hover td { background: #feedd8 !important; }
/* ‚îÄ‚îÄ SCHEDULE TABLE ‚îÄ‚îÄ */
.time-entry { display: grid; grid-template-columns: 145px 145px 1fr 160px 44px; gap: 10px; align-items: center; margin-bottom: 10px; }
.time-entry input, .time-entry select { width: 100%; }
@media (max-width: 768px) {
  .tabs { flex-direction: column; }
  .tab-content { padding: 16px; }
  #portal.tab-content { padding: 0; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .time-grid { grid-template-columns: 1fr; }
  .time-entry { grid-template-columns: 1fr 1fr; }
  header { padding: 16px 20px; }
  header h1 { font-size: 18px; }
  .ep-kpi-strip { margin: -48px 12px 0; }
  .ep-week-nav, .ep-perf-section, .ep-log-section { padding-left: 12px; padding-right: 12px; }
}
</style>
</head>
<body>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     LOGIN SCREEN
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="loginScreen">
  <div class="login-card">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
         alt="Jeng Chi Logo"
         style="width:210px;height:auto;border-radius:12px;margin-bottom:12px;object-fit:contain;">
    <div class="login-title">Kitchen Workforce</div>
    <div class="login-subtitle">Sign in to continue</div>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="doLogin()" id="loginBtn">Sign In</button>
    <div id="loginError"></div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     APP SHELL
‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<div id="appShell">
<div class="container">
<header>
    <div style="display:flex;align-items:center;gap:14px;">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
           alt="Jeng Chi Logo"
           style="width:84px;height:84px;border-radius:8px;object-fit:contain;background:white;padding:3px;">
      <div>
        <h1>Kitchen Workforce Management</h1>
        <div class="header-subtitle">Schedule, Worked, Break & Untask Time Dashboard</div>
      </div>
    </div>
  <div class="header-user">
    <span class="user-badge" id="headerUserName">‚Äî</span>
    <span class="admin-badge hidden" id="adminBadge">Admin</span>
    <button class="logout-btn" onclick="doLogout()">Sign Out</button>
  </div>
</header>
<div id="globalStatus" class="hidden"></div>
<!-- ‚ïê‚ïê‚ïê TABS ‚ïê‚ïê‚ïê -->
<div class="tabs" id="tabBar">
  <!-- Admin tabs injected by JS -->
</div>
<!-- ‚ïê‚ïê‚ïê TAB: EMPLOYEE PORTAL (non-admin) ‚ïê‚ïê‚ïê -->
<div id="portal" class="tab-content">

  <!-- HERO HEADER -->
  <div class="ep-hero">
    <div class="ep-hero-top">
      <div class="ep-logo-mark">
        <div class="ep-logo-dot"></div>
        <span class="ep-brand">Jeng Chi</span>
      </div>
      <div class="ep-date-chip" id="epTodayChip">‚Äî</div>
    </div>
    <div class="ep-identity">
      <div class="ep-avatar-ring" id="epAvatar">JM</div>
      <div class="ep-name" id="epName">Employee</div>
      <div class="ep-role-chip">
        <div class="ep-role-dot"></div>
        <span id="epRoleLabel">Kitchen Staff</span>
      </div>
    </div>
  </div>

  <!-- FLOATING KPI STRIP (today's stats) -->
  <div class="ep-kpi-strip ep-animate">
    <div class="ep-kpi-item productive">
      <div class="ep-kpi-label">Worked</div>
      <div class="ep-kpi-value" id="epKpiWorked">‚Äî</div>
      <div class="ep-kpi-sub" id="epKpiWorkedSub">Today</div>
    </div>
    <div class="ep-kpi-item">
      <div class="ep-kpi-label">Scheduled</div>
      <div class="ep-kpi-value" id="epKpiSched">‚Äî</div>
      <div class="ep-kpi-sub">Shift length</div>
    </div>
    <div class="ep-kpi-item untask">
      <div class="ep-kpi-label">Untask</div>
      <div class="ep-kpi-value" id="epKpiUntask">‚Äî</div>
      <div class="ep-kpi-sub">Unlogged gaps</div>
    </div>
    <div class="ep-kpi-item ep-prod-wrap">
      <div class="ep-kpi-label">Productivity</div>
      <div class="ep-kpi-value" id="epKpiProd">‚Äî</div>
      <div class="ep-prod-gauge">
        <div class="ep-prod-fill" id="epProdFill" style="width:0%;background:#94a3b8;"></div>
      </div>
    </div>
  </div>

  <!-- WEEK SELECTOR -->
  <div class="ep-week-nav ep-animate">
    <div class="ep-section-label">This Week</div>
    <div class="ep-day-tabs" id="epDayTabs">
      <!-- Injected by JS -->
    </div>
  </div>

  <!-- SELECTED DAY PERFORMANCE CARD -->
  <div class="ep-perf-section ep-animate">
    <div class="ep-perf-card" id="epPerfCard">
      <div class="ep-perf-header">
        <div>
          <div class="ep-perf-date" id="epPerfDate">Loading‚Ä¶</div>
          <div class="ep-perf-sched" id="epPerfSched">‚Äî</div>
        </div>
        <div class="ep-prod-badge" id="epPerfBadge" style="background:#f1f5f9;color:#64748b;">‚Äî</div>
      </div>
      <!-- Timeline -->
      <div class="ep-timeline" id="epTimeline">
        <div class="ep-empty-day">
          <div class="ep-empty-icon">üìã</div>
          <div class="ep-empty-text">Select a day to view tasks</div>
        </div>
      </div>
    </div>
  </div>

  <!-- LOG A TASK -->
  <div class="ep-log-section ep-animate">
    <div class="ep-log-card">
      <div class="ep-log-header">
        <div>
          <div class="ep-log-title">Log a Task</div>
          <div class="ep-log-subtitle">Record what you worked on</div>
        </div>
        <!-- Quick date badge -->
        <div class="ep-date-chip" id="epLogDateDisplay" style="color:#1e293b;border-color:#cbd5e1;background:#f8fafc;">Today</div>
      </div>
      <div class="ep-log-body">
        <input type="hidden" id="portalDate">

        <div class="ep-field">
          <label>Task Description</label>
          <input type="text" class="ep-input" id="portalTaskName" placeholder="e.g. Prepped vegetables, Cleaned fryer‚Ä¶" autocomplete="off">
        </div>

        <div class="ep-field">
          <label>Role</label>
          <select class="ep-input" id="portalRole">
            <option value="Kitchen Prep">Kitchen Prep</option>
            <option value="Line Cook">Line Cook</option>
            <option value="Fryer">Fryer</option>
            <option value="Dishwasher">Dishwasher</option>
            <option value="Server">Server</option>
          </select>
        </div>

        <div class="ep-time-row ep-field">
          <div>
            <label>Start Time</label>
            <input type="time" class="ep-input" id="portalStart">
          </div>
          <div>
            <label>End Time</label>
            <input type="time" class="ep-input" id="portalEnd">
          </div>
        </div>

        <button class="ep-save-btn" id="epSaveBtn" onclick="savePortalTask()">Save Task</button>
        <div id="portalStatus" style="display:none;" class="ep-status"></div>
      </div>
    </div>
  </div>

  <div class="ep-bottom-space"></div>

  <!-- Legacy hidden elements (kept for JS compatibility) -->
  <div style="display:none;">
    <div class="portal-header"><div class="portal-avatar" id="portalAvatar">?</div><div><div class="portal-name" id="portalName"></div><div class="portal-sub" id="portalSub"></div></div></div>
    <div id="portalStats"></div>
    <div class="my-tasks-list"><tbody id="portalTasksBody"></tbody></div>
    <div id="pStatTasks"></div><div id="pStatWorked"></div><div id="pStatUntask"></div><div id="pStatProd"></div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: MANAGE SCHEDULE (admin) ‚ïê‚ïê‚ïê -->
<div id="schedule" class="tab-content sc-root">

  <!-- ‚ñë‚ñë PAGE HEADER ‚ñë‚ñë -->
  <div class="sc-page-header">
    <div>
      <h2 class="sc-page-title">Schedule Management</h2>
      <p class="sc-page-sub">Build, replicate, and manage your team's shifts</p>
    </div>
    <div class="sc-header-actions">
      <button class="sc-ghost-btn" onclick="loadSchedules()">‚Ü∫ Refresh</button>
    </div>
  </div>

  <!-- ‚ñë‚ñë ACTION MODE SWITCHER ‚ñë‚ñë -->
  <div class="sc-mode-rail">
    <button class="sc-mode-btn sc-mode-active" id="schedModeAdd"    onclick="switchSchedMode('add')">
      <span class="sc-mode-icon">Ôºã</span>
      <span class="sc-mode-label">Add Shift</span>
    </button>
    <div class="sc-mode-divider"></div>
    <button class="sc-mode-btn" id="schedModeCopy"   onclick="switchSchedMode('copy')">
      <span class="sc-mode-icon">‚á•</span>
      <span class="sc-mode-label">Copy Week</span>
    </button>
    <div class="sc-mode-divider"></div>
    <button class="sc-mode-btn" id="schedModeRepeat" onclick="switchSchedMode('repeat')">
      <span class="sc-mode-icon">‚Üª</span>
      <span class="sc-mode-label">Repeat Week</span>
    </button>
  </div>

  <!-- ‚ñë‚ñë PANEL: ADD SHIFT ‚ñë‚ñë -->
  <div class="sc-panel" id="schedPanelAdd">
    <div class="sc-panel-header">
      <div class="sc-panel-icon sc-icon-add">Ôºã</div>
      <div>
        <div class="sc-panel-title">Add New Shift</div>
        <div class="sc-panel-sub">Assign a single shift to one employee</div>
      </div>
    </div>
    <div class="sc-form-grid sc-form-grid-2">
      <div class="sc-field">
        <label class="sc-label">Date</label>
        <input type="date" class="sc-input" id="scheduleDate" required>
      </div>
      <div class="sc-field">
        <label class="sc-label">Employee</label>
        <select class="sc-input" id="scheduleEmployee" required>
          <option value="">Select employee‚Ä¶</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
    </div>
    <div class="sc-field">
      <label class="sc-label">Role</label>
      <div class="sc-role-chips" id="addRoleChips">
        <button type="button" class="sc-role-chip sc-role-active" onclick="pickRole(this,'add')">Kitchen Prep</button>
        <button type="button" class="sc-role-chip" onclick="pickRole(this,'add')">Line Cook</button>
        <button type="button" class="sc-role-chip" onclick="pickRole(this,'add')">Fryer</button>
        <button type="button" class="sc-role-chip" onclick="pickRole(this,'add')">Dishwasher</button>
        <button type="button" class="sc-role-chip" onclick="pickRole(this,'add')">Server</button>
      </div>
      <select id="scheduleRole" style="display:none;">
        <option selected>Kitchen Prep</option><option>Line Cook</option>
        <option>Fryer</option><option>Dishwasher</option><option>Server</option>
      </select>
    </div>
    <div class="sc-form-grid sc-form-grid-2">
      <div class="sc-field">
        <label class="sc-label">Start Time</label>
        <input type="time" class="sc-input" id="scheduleStart" value="10:00">
      </div>
      <div class="sc-field">
        <label class="sc-label">End Time</label>
        <input type="time" class="sc-input" id="scheduleEnd" value="20:30">
      </div>
    </div>
    <button class="sc-primary-btn" onclick="addScheduleOnce()">Add Shift</button>
    <div id="scheduleStatus" class="sc-status" style="display:none;"></div>
  </div>

  <!-- ‚ñë‚ñë PANEL: COPY WEEK ‚ñë‚ñë -->
  <div class="sc-panel" id="schedPanelCopy" style="display:none;">
    <div class="sc-panel-header">
      <div class="sc-panel-icon sc-icon-copy">‚á•</div>
      <div>
        <div class="sc-panel-title">Copy Week to Another Week</div>
        <div class="sc-panel-sub">Take a source week and paste it onto a new target week</div>
      </div>
    </div>

    <!-- Week range source -->
    <div class="sc-week-block">
      <div class="sc-week-block-label">SOURCE ‚Äî Copy from this period</div>
      <div class="sc-form-grid sc-form-grid-2">
        <div class="sc-field">
          <label class="sc-label">From date</label>
          <input type="date" class="sc-input" id="copyFromDate">
        </div>
        <div class="sc-field">
          <label class="sc-label">To date <span class="sc-optional">(optional, for a range)</span></label>
          <input type="date" class="sc-input" id="copyFromDateEnd">
        </div>
      </div>
    </div>

    <div class="sc-arrow-connector">‚Üì paste onto</div>

    <!-- Target week -->
    <div class="sc-week-block">
      <div class="sc-week-block-label">TARGET ‚Äî Starting on this date</div>
      <div class="sc-field">
        <label class="sc-label">Paste to start date</label>
        <input type="date" class="sc-input" id="copyToDate">
      </div>
    </div>

    <!-- Team member chips -->
    <div class="sc-field">
      <div class="sc-team-label">
        <span>Team Members</span>
        <div class="sc-team-toggles">
          <button type="button" class="sc-toggle-all" onclick="toggleAllCopyEmps(true)">All</button>
          <button type="button" class="sc-toggle-all" onclick="toggleAllCopyEmps(false)">None</button>
        </div>
      </div>
      <div class="sc-avatar-grid" id="copyEmpCheckboxes">
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Julio Mejia" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#667eea,#764ba2);">JM</div>
          <span class="sc-emp-name">Julio Mejia</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Leydi Diaz" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#f093fb,#f5576c);">LD</div>
          <span class="sc-emp-name">Leydi Diaz</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Procoro Tinoco" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#4facfe,#00f2fe);">PT</div>
          <span class="sc-emp-name">Procoro Tinoco</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Wilson Sanchez" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#43e97b,#38f9d7);">WS</div>
          <span class="sc-emp-name">Wilson Sanchez</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
      </div>
    </div>

    <button class="sc-primary-btn sc-copy-btn" onclick="copyScheduleBlock()">
      <span>Copy &amp; Paste Schedule</span>
      <span class="sc-btn-arrow">‚Üí</span>
    </button>
    <div id="copySchedStatus" class="sc-status" style="display:none;"></div>
  </div>

  <!-- ‚ñë‚ñë PANEL: REPEAT WEEK ‚ñë‚ñë -->
  <div class="sc-panel" id="schedPanelRepeat" style="display:none;">
    <div class="sc-panel-header">
      <div class="sc-panel-icon sc-icon-repeat">‚Üª</div>
      <div>
        <div class="sc-panel-title">Repeat Schedule for N Days</div>
        <div class="sc-panel-sub">Clone one day's lineup across consecutive days</div>
      </div>
    </div>

    <div class="sc-form-grid sc-form-grid-2">
      <div class="sc-field">
        <label class="sc-label">Template date <span class="sc-optional">(copy from)</span></label>
        <input type="date" class="sc-input" id="repeatTemplateDate">
      </div>
      <div class="sc-field">
        <label class="sc-label">Start repeating from</label>
        <input type="date" class="sc-input" id="repeatStartDate">
      </div>
    </div>

    <!-- Days stepper -->
    <div class="sc-field">
      <label class="sc-label">Number of days to repeat</label>
      <div class="sc-stepper">
        <button type="button" class="sc-step-btn" onclick="scStep(-1)">‚àí</button>
        <input type="number" class="sc-step-val" id="repeatDaysN" min="1" max="60" value="7" oninput="scClampStep()">
        <button type="button" class="sc-step-btn" onclick="scStep(1)">Ôºã</button>
        <span class="sc-step-hint" id="scStepHint">7 days = 1 week</span>
      </div>
    </div>

    <!-- Team member chips (mirrored from copy panel) -->
    <div class="sc-field">
      <div class="sc-team-label">
        <span>Team Members</span>
        <div class="sc-team-toggles">
          <button type="button" class="sc-toggle-all" onclick="toggleAllRepeatEmps(true)">All</button>
          <button type="button" class="sc-toggle-all" onclick="toggleAllRepeatEmps(false)">None</button>
        </div>
      </div>
      <div class="sc-avatar-grid" id="repeatEmpCheckboxes">
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Julio Mejia" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#667eea,#764ba2);">JM</div>
          <span class="sc-emp-name">Julio Mejia</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Leydi Diaz" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#f093fb,#f5576c);">LD</div>
          <span class="sc-emp-name">Leydi Diaz</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Procoro Tinoco" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#4facfe,#00f2fe);">PT</div>
          <span class="sc-emp-name">Procoro Tinoco</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
        <label class="sc-emp-chip" data-checked="true">
          <input type="checkbox" value="Wilson Sanchez" checked style="display:none;">
          <div class="sc-emp-avatar" style="background:linear-gradient(135deg,#43e97b,#38f9d7);">WS</div>
          <span class="sc-emp-name">Wilson Sanchez</span>
          <span class="sc-emp-check">‚úì</span>
        </label>
      </div>
    </div>

    <button class="sc-primary-btn sc-repeat-btn" onclick="repeatScheduleBlock()">
      <span>Repeat Schedule</span>
      <span class="sc-btn-arrow">‚Üí</span>
    </button>
    <div id="repeatSchedStatus" class="sc-status" style="display:none;"></div>
  </div>

  <!-- ‚ñë‚ñë SHIFTS TABLE ‚ñë‚ñë -->
  <div class="sc-shifts-card">
    <div class="sc-shifts-top">
      <div class="sc-shifts-title-block">
        <span class="sc-shifts-title">Scheduled Shifts</span>
        <span class="sc-shifts-count" id="scShiftsCount">‚Äî</span>
      </div>
      <div class="sc-shifts-filters">
        <select id="scheduleFilterEmployee" onchange="loadSchedules()" class="sc-filter-select">
          <option value="">All employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
        <input type="date" id="scheduleFilterDate" onchange="loadSchedules()" class="sc-filter-select">
        <button onclick="clearScheduleFilters()" class="sc-ghost-btn">‚úï Clear</button>
      </div>
    </div>

    <!-- Batch bar -->
    <div class="sc-batch-bar" id="batchUpdateBar" style="display:none;">
      <span class="sc-batch-count"><span id="batchSelectedCount">0</span> selected</span>
      <select id="batchUpdateRole" class="sc-batch-select"><option value="">Change role‚Ä¶</option><option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option><option>Server</option></select>
      <input type="time" id="batchUpdateStart" class="sc-batch-time" title="New start">
      <input type="time" id="batchUpdateEnd"   class="sc-batch-time" title="New end">
      <button onclick="applyBatchUpdate()"   class="sc-batch-btn sc-batch-update">Update</button>
      <button onclick="deleteBatchSelected()" class="sc-batch-btn sc-batch-delete">Delete</button>
      <button onclick="selectAllVisible()"   class="sc-batch-btn sc-batch-ghost">Select all</button>
      <button onclick="cancelBatchMode()"    class="sc-batch-btn sc-batch-ghost">‚úï Cancel</button>
    </div>

    <div class="sc-toolbar">
      <button onclick="toggleBatchMode()" id="batchModeBtn" class="sc-ghost-btn">‚òë Select &amp; Edit</button>
    </div>

    <div id="scheduleList" class="sc-list-wrap">
      <p style="color:#94a3b8;text-align:center;padding:40px;font-size:14px;">Loading shifts‚Ä¶</p>
    </div>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê TAB: TASK LOGGING (admin) ‚ïê‚ïê‚ïê -->
<div id="tasks" class="tab-content">
  <h2 class="section-title">Real-Time Task Logging</h2>
  <p class="section-subtitle">Track actual work ‚Äî gaps between tasks are automatically logged as Untask time</p>
  <div class="card">
    <div class="form-group">
      <label>üë§ Employee</label>
      <select id="taskEmployee">
        <option value="">-- Select Employee --</option>
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group"><label>üè∑ Role</label>
      <select id="taskRole">
        <option>Kitchen Prep</option><option>Line Cook</option>
        <option>Fryer</option><option>Dishwasher</option>
      </select>
    </div>
    <div class="form-group"><label>üìù Task Name</label>
      <input type="text" id="taskName" placeholder="Type task name...">
    </div>
    <div class="action-bar">
      <button onclick="startTask()" id="startBtn">‚ñ∂ Start Task</button>
      <button onclick="stopTask()" id="stopBtn" disabled class="danger">‚èπ Stop Task</button>
    </div>
    <div id="taskStatus" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
    <div id="activeTaskInfo" class="hidden" style="margin-top:16px;padding:16px;background:#f0f9ff;border-radius:10px;border:1px solid #bee3f8;">
      <h4 style="color:#2c5282;margin-bottom:6px;">‚ñ∂ Active Task</h4>
      <p id="activeTaskDisplay" style="font-weight:600;margin-bottom:6px;"></p>
      <p id="taskTimer" style="font-size:13px;color:#4a5568;font-family:monospace;"></p>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: ALL TASKS (admin) ‚ïê‚ïê‚ïê -->
<div id="allTasks" class="tab-content">
  <h2 class="section-title">All Employee Tasks</h2>
  <p class="section-subtitle">View, edit, and delete all task logs. Untask rows show time gaps between tasks.</p>
  <div class="filters-bar">
    <div class="row">
      <div class="form-group">
        <label>üë§ Employee</label>
        <select id="allTasksEmployee" onchange="loadAllTasks()">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group"><label>üìÖ Start Date</label><input type="date" id="allTasksStartDate" onchange="loadAllTasks()"></div>
      <div class="form-group"><label>üìÖ End Date</label><input type="date" id="allTasksEndDate" onchange="loadAllTasks()"></div>
      <div class="form-group">
        <label>üè∑ Role</label>
        <select id="allTasksRole" onchange="loadAllTasks()">
          <option value="">All Roles</option>
          <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
        </select>
      </div>
      <div class="form-group">
        <label>üìå Status</label>
        <select id="allTasksStatus" onchange="loadAllTasks()">
          <option value="">All (Tasks + Untask)</option>
          <option value="done">‚úÖ Tasks Only (Done)</option>
          <option value="auto">‚è∏ Untask / Break Only (Auto)</option>
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end;">
        <button onclick="loadAllTasks()" class="success" style="">üîÑ Load</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h3 style="font-size:15px;">üìù Task Records</h3>
      <span id="allTasksCount" style="color:#718096;font-size:13px;">0 tasks</span>
    </div>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr>
          <th>Date</th><th>Employee</th><th>Task</th><th>Role</th>
          <th>Start</th><th>End</th><th>Duration</th><th>Type</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody id="allTasksTableBody">
          <tr><td colspan="10" style="text-align:center;padding:40px;color:#718096;">Select filters and click Load</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: BATCH ENTRY (admin) ‚ïê‚ïê‚ïê -->
<div id="batch" class="tab-content">
  <h2 class="section-title">Batch Task Entry</h2>
  <p class="section-subtitle">Add new tasks OR load and edit existing tasks for a specific employee and date ‚Äî changes auto-save on blur</p>
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="form-group"><label>üìÖ Date</label><input type="date" id="batchDate" onchange="batchDateOrEmpChanged()"></div>
      <div class="form-group"><label>üë§ Employee</label>
        <select id="batchEmployee" onchange="batchDateOrEmpChanged()">
          <option value="">-- Select Employee --</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
    </div>
    <!-- Existing tasks (loaded from DB) -->
    <div id="batchExistingSection" style="display:none;margin-bottom:20px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <h4 style="font-size:14px;color:#2d3748;font-weight:700;">üìã Existing Tasks <span id="batchExistingCount" style="background:#dbeafe;color:#1e40af;border-radius:10px;padding:2px 8px;font-size:12px;"></span></h4>
        <span style="font-size:12px;color:#718096;font-style:italic;">&#9998; Click any cell to edit ‚Äî saves automatically</span>
      </div>
      <div class="task-table-container">
        <table class="schedule-table">
          <thead><tr><th>Task</th><th>Role</th><th>Start</th><th>End</th><th>Duration</th><th>Status</th><th>&#128465;</th></tr></thead>
          <tbody id="batchExistingBody"></tbody>
        </table>
      </div>
    </div>
    <div style="border-top:2px dashed #e2e8f0;margin:16px 0;padding-top:16px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
        <h4 style="font-size:14px;color:#2d3748;font-weight:700;">‚ûï Add New Tasks</h4>
      </div>
      <div class="action-bar" style="margin-bottom:16px;">
        <button onclick="addBatchRow()" class="success">‚ûï Add Row</button>
        <button onclick="clearBatchRows()" class="secondary">üóë Clear New Rows</button>
      </div>
      <div id="batchRows"></div>
      <div class="action-bar" style="margin-top:16px;">
        <button onclick="saveBatchTasks()" class="success" style="flex:1;">üíæ Save New Tasks</button>
      </div>
    </div>
    <div id="batchStatus" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: ANALYTICS (admin) ‚ïê‚ïê‚ïê -->
<div id="analytics" class="tab-content">
  <h2 class="section-title">Analytics Dashboard</h2>
  <p class="section-subtitle">Scheduled vs Worked vs Untask vs Break ‚Äî with productivity metrics</p>
  <div class="period-selector">
    <h4>üìÖ Select Time Period</h4>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div class="form-group" style="flex:1;min-width:130px;margin-bottom:0;">
        <label>Period</label>
        <select id="analyticsPeriod" onchange="changeAnalyticsPeriod()">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="form-group" id="dailyDateGroup" style="flex:1;min-width:130px;margin-bottom:0;">
        <label>Date</label><input type="date" id="analyticsDate">
      </div>
      <div class="form-group" id="weeklyDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Week Starting</label><input type="date" id="analyticsWeek">
      </div>
      <div class="form-group" id="monthlyDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Month</label><input type="month" id="analyticsMonth">
      </div>
      <div class="form-group" id="customDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Start Date</label><input type="date" id="analyticsStart">
      </div>
      <div class="form-group" id="customEndGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>End Date</label><input type="date" id="analyticsEnd">
      </div>
      <div class="form-group" style="flex:1;min-width:160px;margin-bottom:0;">
        <label>üë§ Employee</label>
        <select id="analyticsEmployee">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <button onclick="loadAnalytics()" style="margin-bottom:0;">üìä Load</button>
    </div>
    <div id="currentPeriodDisplay" class="current-period-display">Select a period and click Load</div>
  </div>
  <!-- KPI Cards -->
  <div class="stats-grid">
    <div class="stat-card blue">   <h3>üìÖ Scheduled Hours</h3><div class="value" id="totalScheduled">‚Äî</div><div class="subtext">All employees</div></div>
    <div class="stat-card green">  <h3>‚è± Worked Hours</h3>   <div class="value" id="totalWorked">‚Äî</div>   <div class="subtext">Tasks completed</div></div>
    <div class="stat-card orange"> <h3>‚è∏ Untask Hours</h3>  <div class="value" id="totalUnlogged">‚Äî</div> <div class="subtext">Gaps between tasks</div></div>
    <div class="stat-card red">    <h3>‚òï Break Hours</h3>   <div class="value" id="totalBreak">‚Äî</div>    <div class="subtext">1h per employee</div></div>
    <div class="stat-card purple"> <h3>üéØ Productivity</h3>  <div class="value" id="totalProductivity">‚Äî</div><div class="subtext">Worked / (Worked + Untask)</div></div>
    <div class="stat-card teal">   <h3>üìã Total Tasks</h3>  <div class="value" id="totalTasks">‚Äî</div>   <div class="subtext">Logged tasks</div></div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">üìä Hours Distribution by Employee</h3>
    <div class="chart-container"><canvas id="hoursChart"></canvas></div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">üë• Employee Breakdown</h3>
    <div class="task-table-container">
      <table class="schedule-table" id="empBreakdownTable">
        <thead><tr>
          <th>Employee</th><th>Scheduled</th><th>Worked</th><th>Break</th>
          <th>Untask</th><th># Tasks</th><th>Productivity</th>
        </tr></thead>
        <tbody id="employeeBreakdown">
          <tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">Load analytics to see breakdown</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:6px;font-size:15px;">‚è∏ Untask Time Log</h3>
    <p style="color:#718096;font-size:13px;margin-bottom:16px;">Time gaps between consecutive tasks per employee. These are recorded as "UNTASK" entries.</p>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr><th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th></tr></thead>
        <tbody id="unloggedLogBody">
          <tr><td colspan="6" style="text-align:center;padding:24px;color:#718096;">Load analytics to see untask details</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: EMPLOYEE COMPARISON (admin) ‚ïê‚ïê‚ïê -->
<div id="comparison" class="tab-content">
  <h2 class="section-title">üë• Employee Comparison</h2>
  <p class="section-subtitle">Compare performance, hours, and task analytics across employees</p>
  <div class="filters-bar">
    <div class="row">
      <div class="form-group">
        <label>Period</label>
        <select id="compPeriod" onchange="changeCompPeriod()">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly" selected>Monthly</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="form-group" id="compDailyGroup" style="display:none;">
        <label>Date</label><input type="date" id="compDate">
      </div>
      <div class="form-group" id="compWeeklyGroup" style="display:none;">
        <label>Week Starting</label><input type="date" id="compWeek">
      </div>
      <div class="form-group" id="compMonthlyGroup">
        <label>Month</label><input type="month" id="compMonth">
      </div>
      <div class="form-group" id="compCustomStart" style="display:none;">
        <label>Start Date</label><input type="date" id="compStart">
      </div>
      <div class="form-group" id="compCustomEnd" style="display:none;">
        <label>End Date</label><input type="date" id="compEnd">
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end;">
        <button onclick="loadComparison()">üìä Compare</button>
      </div>
    </div>
  </div>

  <!-- Chart type selector -->
  <div class="card">
    <div class="chart-tabs" id="compChartTabs">
      <button class="chart-tab-btn active" onclick="switchCompChart('bar')">üìä Bar Chart</button>
      <button class="chart-tab-btn" onclick="switchCompChart('radar')">üï∏ Radar Chart</button>
      <button class="chart-tab-btn" onclick="switchCompChart('productivity')">üéØ Productivity</button>
      <button class="chart-tab-btn" onclick="switchCompChart('tasks')">üìã Task Duration</button>
    </div>
    <div id="compChartContainer" style="height:380px;padding:8px;">
      <canvas id="compChart"></canvas>
    </div>
    <div id="compTaskChartContainer" style="display:none;height:380px;padding:8px;">
      <canvas id="compTaskChart"></canvas>
    </div>
  </div>

  <!-- Comparison Table -->
  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">üìà Side-by-Side Comparison</h3>
    <div class="task-table-container">
      <table class="schedule-table" id="compTable">
        <thead><tr>
          <th>Employee</th>
          <th>Scheduled</th>
          <th>Worked</th>
          <th>Untask</th>
          <th>Break</th>
          <th>Tasks</th>
          <th>Avg Task Duration</th>
          <th>Productivity</th>
          <th>Rank</th>
        </tr></thead>
        <tbody id="compTableBody">
          <tr><td colspan="9" style="text-align:center;padding:40px;color:#718096;">Click Compare to load data</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- Who Worked Most -->
  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">üèÜ Task Duration Analytics ‚Äî Who Spent the Most Time on Each Task?</h3>
    <div class="filters-bar" style="margin-bottom:16px;">
      <div class="row">
        <div class="form-group">
          <label>Sort By</label>
          <select id="taskAnalyticsSortBy" onchange="renderTaskAnalytics()">
            <option value="total">Total Time Spent</option>
            <option value="avg">Average Duration</option>
            <option value="count">Number of Times Done</option>
          </select>
        </div>
        <div class="form-group">
          <label>Employee</label>
          <select id="taskAnalyticsEmpFilter" onchange="renderTaskAnalytics()">
            <option value="">All Employees</option>
            <option>Julio Mejia</option><option>Leydi Diaz</option>
            <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
          </select>
        </div>
      </div>
    </div>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr>
          <th>#</th><th>Task Name</th><th>Employee</th><th>Times Done</th>
          <th>Total Time</th><th>Avg Duration</th><th>Min Duration</th><th>Max Duration</th>
        </tr></thead>
        <tbody id="taskAnalyticsBody">
          <tr><td colspan="8" style="text-align:center;padding:24px;color:#718096;">Load comparison data first</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê TAB: SCHEDULE VS ACTUAL (admin) ‚ïê‚ïê‚ïê -->
<div id="schedVsActual" class="tab-content">
  <h2 class="section-title">Schedule vs Actual</h2>
  <p class="section-subtitle">Compare planned schedules against actual logged hours</p>
  <div class="filters-bar">
    <div class="row">
      <div class="form-group"><label>üìÖ Date</label><input type="date" id="svaDate"></div>
      <div class="form-group">
        <label>üë§ Employee</label>
        <select id="svaEmployee">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end;">
        <button onclick="loadSchedVsActual()" class="success">üìä Compare</button>
      </div>
    </div>
  </div>
  <div id="svaContent">
    <p style="color:#718096;text-align:center;padding:40px;">Select a date and click Compare</p>
  </div>
</div>
</div><!-- /container -->
</div><!-- /appShell -->
<!-- ‚ïê‚ïê‚ïê EDIT TASK MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="editTaskModal">
  <div class="modal">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Task</h2>
      <button class="modal-close" onclick="closeEditTaskModal()">√ó</button>
    </div>
    <input type="hidden" id="editTaskId">
    <div class="form-group"><label>üë§ Employee</label>
      <select id="editTaskEmployee">
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group"><label>üìÖ Date</label><input type="date" id="editTaskDate"></div>
    <div class="form-group"><label>üè∑ Role</label>
      <select id="editTaskRole">
        <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
      </select>
    </div>
    <div class="form-group"><label>üìù Task Name</label><input type="text" id="editTaskName"></div>
    <div class="form-group"><label>‚è∞ Start Time</label><input type="time" id="editTaskStart"></div>
    <div class="form-group"><label>‚è∞ End Time</label><input type="time" id="editTaskEnd">
      <small style="color:#718096;margin-top:4px;display:block;">Leave blank for open tasks</small>
    </div>
    <div class="action-bar" style="margin-top:20px;">
      <button onclick="saveEditedTask()" class="success" style="flex:1;">üíæ Save Changes</button>
      <button onclick="closeEditTaskModal()" class="secondary" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê EDIT SCHEDULE MODAL ‚ïê‚ïê‚ïê -->
<div class="modal-overlay" id="editScheduleModal">
  <div class="modal">
    <div class="modal-header">
      <h2>‚úèÔ∏è Edit Schedule</h2>
      <button class="modal-close" onclick="closeEditScheduleModal()">√ó</button>
    </div>
    <input type="hidden" id="editScheduleId">
    <div class="form-group"><label>üë§ Employee</label>
      <select id="editScheduleEmployee">
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group"><label>üìÖ Date</label><input type="date" id="editScheduleDate"></div>
    <div class="form-group"><label>üè∑ Role</label>
      <select id="editScheduleRole">
        <option>Kitchen Prep</option><option>Line Cook</option>
        <option>Fryer</option><option>Dishwasher</option><option>Server</option>
      </select>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="form-group"><label>‚è∞ Start Time</label><input type="time" id="editScheduleStart"></div>
      <div class="form-group"><label>‚è∞ End Time</label><input type="time" id="editScheduleEnd"></div>
    </div>
    <div id="editScheduleStatus" class="hidden" style="margin-top:8px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
    <div class="action-bar" style="margin-top:20px;">
      <button onclick="saveEditedSchedule()" class="success" style="flex:1;">üíæ Save Changes</button>
      <button onclick="closeEditScheduleModal()" class="secondary" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>
<!-- ‚ïê‚ïê‚ïê FOOTER ‚ïê‚ïê‚ïê -->
<footer style="background:linear-gradient(135deg,#1a365d 0%,#2c5282 100%);color:white;padding:28px 40px 20px;margin-top:0;">
  <div style="max-width:1600px;margin:0 auto;display:flex;flex-direction:column;align-items:center;gap:14px;">
    <div style="display:flex;align-items:center;gap:14px;">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
           alt="Jeng Chi Restaurant"
           style="width:91px;height:91px;border-radius:8px;object-fit:contain;background:white;padding:3px;">
      <div style="text-align:left;">
        <div style="font-size:15px;font-weight:800;letter-spacing:0.3px;">Jeng Chi Restaurant</div>
        <div style="font-size:11px;opacity:0.75;">Kitchen Workforce Management System</div>
      </div>
    </div>
    <div style="background:rgba(255,255,255,0.08);border:1px solid rgba(255,255,255,0.15);border-radius:10px;padding:14px 20px;max-width:860px;text-align:center;">
      <p style="font-size:12px;font-weight:700;margin-bottom:5px;color:#f6ad55;">‚ö†Ô∏è CONFIDENTIAL ‚Äî FOR INTERNAL USE ONLY</p>
      <p style="font-size:11px;opacity:0.85;line-height:1.7;margin:0;">
        This workforce management system is the exclusive property of <strong>Jeng Chi Restaurant</strong> and is intended solely
        for use by authorized management and staff. All employee schedules, task logs, time records, and productivity data
        contained within this system are strictly confidential. Unauthorized access, sharing, reproduction, or misuse of
        this system or any of its data is strictly prohibited and may result in disciplinary action.
        Management is not liable for inaccuracies resulting from incorrect data entry ‚Äî please review all records carefully before saving.
        By using this system, you agree to handle all information in accordance with Jeng Chi Restaurant's internal policies.
      </p>
    </div>
    <p style="font-size:10px;opacity:0.45;margin:0;">¬© 2026 Jeng Chi Restaurant ¬∑ All rights reserved ¬∑ Unauthorized use prohibited</p>
  </div>
</footer>
<script>
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SUPABASE SETUP
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const { createClient } = window.supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  AUTH STATE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
const ADMINS = ['PG9367', 'JT2316'];
let currentUser = null;   // { username, display_name, is_admin }
// Press Enter on password field to login
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });
  document.getElementById('loginUsername').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('loginPassword').focus();
  });
  // set today's date on portal
  const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  document.getElementById('portalDate').value = today;
  document.getElementById('analyticsDate').value = today;
  document.getElementById('svaDate').value = today;
  document.getElementById('batchDate').value = today;
  document.getElementById('scheduleDate').value = today;
  // Set current month for comparison
  const todayM = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' }).substring(0, 7);
  const compMonthEl = document.getElementById('compMonth');
  if (compMonthEl) compMonthEl.value = todayM;
  // Initialize repeat options UI
  if (document.getElementById('scheduleRepeatMode')) toggleRepeatOptions();
});
async function doLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');
  if (!username || !password) { errEl.textContent = 'Please enter username and password'; return; }
  btn.disabled = true;
  btn.textContent = 'Signing in‚Ä¶';
  errEl.textContent = '';
  try {
    const { data, error } = await supabaseClient
      .from('employees2025')
    .select('username, pin, first_name, last_name')
      .eq('username', username)
      .maybeSingle();
    if (error) throw error;
    if (!data) {
      errEl.textContent = '‚ùå Username not found';
      btn.disabled = false; btn.textContent = 'Sign In'; return;
    }
   if (data.pin !== password) {
      errEl.textContent = '‚ùå Incorrect password';
      btn.disabled = false; btn.textContent = 'Sign In'; return;
    }
    // ‚úÖ Login successful
    currentUser = {
      username: data.username,
     display_name: (data.first_name && data.last_name)
  ? `${data.first_name} ${data.last_name}`
  : data.username,
      is_admin: ADMINS.includes(data.username.toUpperCase())
    };
    initApp();
  } catch (e) {
    console.error('Login error:', e);
    errEl.textContent = '‚ùå Connection error. Try again.';
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}
function doLogout() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtn').textContent = 'Sign In';
}
function initApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';
  // Header
  document.getElementById('headerUserName').textContent = currentUser.display_name;
  if (currentUser.is_admin) {
    document.getElementById('adminBadge').classList.remove('hidden');
  }
  // Build tabs
  const tabBar = document.getElementById('tabBar');
  tabBar.innerHTML = '';
  if (currentUser.is_admin) {
    const adminTabs = [
      { id: 'schedule',    label: 'üìÖ Manage Schedule' },
      { id: 'tasks',       label: '‚è± Task Logging' },
      { id: 'allTasks',    label: 'üìã All Tasks' },
      { id: 'batch',       label: 'üìù Batch Entry' },
      { id: 'analytics',   label: 'üìä Analytics' },
      { id: 'comparison',  label: 'üë• Comparison' },
      { id: 'schedVsActual', label: 'üìà Sched vs Actual' },
    ];
    adminTabs.forEach((t, i) => {
      const btn = document.createElement('button');
      btn.className = 'tab-btn' + (i === 0 ? ' active' : '');
      btn.textContent = t.label;
      btn.onclick = () => switchTab(t.id);
      tabBar.appendChild(btn);
    });
    switchTab('schedule');
    loadSchedules();
  } else {
    // Employee-only tab
    const btn = document.createElement('button');
    btn.className = 'tab-btn active';
    btn.textContent = 'üìã My Tasks';
    btn.onclick = () => switchTab('portal');
    tabBar.appendChild(btn);
    switchTab('portal');
    initPortal();
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  TAB SWITCHING
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  const section = document.getElementById(id);
  if (section) section.classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.textContent.toLowerCase().includes(id.slice(0,4).toLowerCase()) ||
        btn.onclick?.toString().includes(`'${id}'`)) {
      btn.classList.add('active');
    }
  });
  // activate by matching onclick
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.getAttribute('onclick')?.includes(`'${id}'`)) btn.classList.add('active');
  });
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function formatTime(minutes) {
  if (isNaN(minutes) || minutes < 0) return '0m';
  const h = Math.floor(minutes / 60);
  const m = Math.round(minutes % 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function calculateHours(start, end) {
  const s = new Date(`2000-01-01T${start}`);
  const e = new Date(`2000-01-01T${end}`);
  return (e - s) / (1000 * 60);
}
function formatDate(dateStr) {
  if (!dateStr) return '‚Äî';
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatDateTime(isoString) {
  if (!isoString) return '‚Äî';
  return new Date(isoString).toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: 'numeric', minute: '2-digit', hour12: true });
}
function toCSTISOString(dateStr, timeStr) {
  return `${dateStr}T${timeStr}:00-06:00`;
}
function showGlobalStatus(msg, type = 'info') {
  const el = document.getElementById('globalStatus');
  el.textContent = msg;
  el.className = 'status-' + type;
  el.classList.remove('hidden');
  clearTimeout(showGlobalStatus._t);
  showGlobalStatus._t = setTimeout(() => el.classList.add('hidden'), 5000);
}
function showLocalStatus(id, msg, type = 'info') {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.background = type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#dbeafe';
  el.style.color = type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#1e40af';
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 4000);
}
// ‚îÄ‚îÄ Employee/Task ID lookups ‚îÄ‚îÄ
let _employeeMapCache = null;
let _taskMapCache = null;
async function getEmployeeMap(force = false) {
  if (_employeeMapCache && !force) return _employeeMapCache;
  const { data } = await supabaseClient.from('kitchen_prep_employees').select('id,name');
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _employeeMapCache = map;
  return map;
}
async function getTaskMap(force = false) {
  if (_taskMapCache && !force) return _taskMapCache;
  const { data } = await supabaseClient.from('kitchen_tasks').select('id,name');
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _taskMapCache = map;
  return map;
}
async function getEmployeeIdByName(name, createIfMissing = true) {
  if (!name) return null;
  const { data: ex } = await supabaseClient.from('kitchen_prep_employees').select('id').eq('name', name).limit(1).maybeSingle();
  if (ex?.id) return ex.id;
  if (!createIfMissing) return null;
  const { data: cr, error } = await supabaseClient.from('kitchen_prep_employees').insert({ name }).select('id').single();
  if (error) throw error;
  _employeeMapCache = null;
  return cr.id;
}
async function getTaskIdByName(name, createIfMissing = true) {
  if (!name) return null;
  const { data: ex } = await supabaseClient.from('kitchen_tasks').select('id').eq('name', name).limit(1).maybeSingle();
  if (ex?.id) return ex.id;
  if (!createIfMissing) return null;
  const { data: cr, error } = await supabaseClient.from('kitchen_tasks').insert({ name }).select('id').single();
  if (error) throw error;
  _taskMapCache = null;
  return cr.id;
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMPLOYEE PORTAL ‚Äî ENTERPRISE
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _epAllLogs      = [];   // all logs for the week
let _epAllScheds    = [];   // all schedules for the week
let _epTaskMap      = {};
let _epSelectedDate = '';   // currently selected day tab

function initPortal() {
  const name     = currentUser.display_name;
  const initials = name.split(' ').map(w => w[0]).join('').slice(0, 2).toUpperCase();
  const today    = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  const todayFmt = new Date().toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric', timeZone:'America/Chicago' });

  // Update legacy hidden fields (save button compatibility)
  document.getElementById('portalAvatar').textContent = initials;
  document.getElementById('portalName').textContent   = name;

  // Update new enterprise UI
  document.getElementById('epAvatar').textContent       = initials;
  document.getElementById('epName').textContent         = name;
  document.getElementById('epTodayChip').textContent    = todayFmt;
  document.getElementById('epLogDateDisplay').textContent = 'Today';
  document.getElementById('portalDate').value           = today;
  _epSelectedDate = today;

  buildWeekTabs();
  loadPortalTasks();
}

// Build Mon‚ÄìSun tabs for the current week containing today
function buildWeekTabs() {
  const today   = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  const todayDt = new Date(today + 'T12:00:00');
  // Find Monday of this week
  const dow     = todayDt.getDay(); // 0=Sun
  const monday  = new Date(todayDt);
  monday.setDate(todayDt.getDate() - ((dow + 6) % 7));

  const dayNames = ['MON','TUE','WED','THU','FRI','SAT','SUN'];
  let html = '';
  for (let i = 0; i < 7; i++) {
    const d    = new Date(monday);
    d.setDate(monday.getDate() + i);
    const iso  = d.toISOString().split('T')[0];
    const num  = d.getDate();
    const nm   = dayNames[i];
    const isTodayClass = iso === today ? ' today' : '';
    html += `<button class="ep-day-btn${isTodayClass}" id="epDay_${iso}" onclick="epSelectDay('${iso}')">
      <span class="ep-day-name">${nm}</span>
      <span class="ep-day-num">${num}</span>
      <span class="ep-day-dot"></span>
    </button>`;
  }
  document.getElementById('epDayTabs').innerHTML = html;
}

// Called after data loads ‚Äî mark days that have tasks
function markWeekDots(logsArr) {
  const hasTasks = new Set(logsArr.map(l => l.date));
  document.querySelectorAll('#epDayTabs .ep-day-btn').forEach(btn => {
    const iso = btn.id.replace('epDay_', '');
    if (hasTasks.has(iso)) btn.classList.add('has-tasks');
  });
}

// Select a day tab ‚Äî update active state and render perf card
function epSelectDay(dateStr) {
  _epSelectedDate = dateStr;
  document.getElementById('portalDate').value = dateStr;

  // Update log form date badge
  const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  const d     = new Date(dateStr + 'T12:00:00');
  const label = dateStr === today ? 'Today'
    : d.toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });
  document.getElementById('epLogDateDisplay').textContent = label;

  // Update active tab
  document.querySelectorAll('#epDayTabs .ep-day-btn').forEach(b => b.classList.remove('active'));
  const activeBtn = document.getElementById('epDay_' + dateStr);
  if (activeBtn) {
    activeBtn.classList.add('active');
    activeBtn.scrollIntoView({ behavior:'smooth', block:'nearest', inline:'center' });
  }

  renderEpDayCard(dateStr);
}

// Render the performance card for a given day using cached data
function renderEpDayCard(dateStr) {
  const d       = new Date(dateStr + 'T12:00:00');
  const dateLbl = d.toLocaleDateString('en-US', { weekday:'long', month:'long', day:'numeric' });
  const today   = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  const sched   = _epAllScheds.find(s => s.schedule_date === dateStr);
  const dayLogs = _epAllLogs
    .filter(l => l.date === dateStr && l.start_time && l.end_time)
    .sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

  document.getElementById('epPerfDate').textContent = dateLbl;

  // Schedule subtitle
  if (sched) {
    const halfDay = isHalfDayShift(sched.start_time, sched.end_time);
    const bkLabel = halfDay ? 'No break ¬∑ Half-day' : '1h break';
    document.getElementById('epPerfSched').textContent =
      `Scheduled ${sched.start_time.slice(0,5)} ‚Äì ${sched.end_time.slice(0,5)} ¬∑ ${bkLabel}`;
  } else {
    document.getElementById('epPerfSched').textContent = 'No schedule on file';
  }

  // ‚îÄ‚îÄ Compute stats using iron rule ‚îÄ‚îÄ
  let workedMin = 0, schedMin = 0, breakMin = 0;
  if (sched) {
    schedMin = calculateHours(sched.start_time, sched.end_time);
    breakMin = isHalfDayShift(sched.start_time, sched.end_time) ? 0 : (sched.break_minutes || 60);
    const shiftStartISO = toCST_ISO(dateStr, sched.start_time.slice(0,5));
    const shiftEndISO   = toCST_ISO(dateStr, sched.end_time.slice(0,5));
    dayLogs.forEach(log => {
      const cs  = new Date(Math.max(new Date(log.start_time), new Date(shiftStartISO)));
      const ce  = new Date(Math.min(new Date(log.end_time),   new Date(shiftEndISO)));
      const dur = (ce - cs) / (1000 * 60);
      if (dur > 0) workedMin += dur;
    });
  } else {
    dayLogs.forEach(log => {
      const dur = (new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60);
      if (dur > 0) workedMin += dur;
    });
  }
  const effectMin = Math.max(0, schedMin - breakMin);
  const untaskMin = Math.max(0, effectMin - workedMin);
  const prod      = effectMin > 0 ? Math.round((workedMin / effectMin) * 100) : null;

  // ‚îÄ‚îÄ Update KPI strip to reflect this day ‚îÄ‚îÄ
  const dayLabel = dateStr === today ? 'Today'
    : d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' });
  document.getElementById('epKpiWorkedSub').textContent = dayLabel;
  updateEpKpis(workedMin, schedMin, untaskMin, prod);

  // ‚îÄ‚îÄ Update badge ‚îÄ‚îÄ
  const badge = document.getElementById('epPerfBadge');
  if (prod === null) {
    badge.style.background = '#f1f5f9'; badge.style.color = '#64748b'; badge.textContent = '‚Äî';
  } else if (prod >= 90) {
    badge.style.background = '#dcfce7'; badge.style.color = '#166534'; badge.textContent = prod + '%';
  } else if (prod >= 80) {
    badge.style.background = '#d1fae5'; badge.style.color = '#065f46'; badge.textContent = prod + '%';
  } else if (prod >= 70) {
    badge.style.background = '#fef9c3'; badge.style.color = '#854d0e'; badge.textContent = prod + '%';
  } else if (prod >= 60) {
    badge.style.background = '#ffedd5'; badge.style.color = '#9a3412'; badge.textContent = prod + '%';
  } else {
    badge.style.background = '#fee2e2'; badge.style.color = '#991b1b'; badge.textContent = prod + '%';
  }

  // ‚îÄ‚îÄ Build timeline ‚îÄ‚îÄ
  const timeline = document.getElementById('epTimeline');
  if (!dayLogs.length) {
    timeline.innerHTML = `<div class="ep-empty-day">
      <div class="ep-empty-icon">üìã</div>
      <div class="ep-empty-text" style="font-weight:600;color:#475569;margin-bottom:4px;">No tasks logged</div>
      <div style="font-size:12px;color:#94a3b8;">${sched ? `Shift: ${sched.start_time.slice(0,5)} ‚Äì ${sched.end_time.slice(0,5)}` : 'No shift scheduled'}</div>
    </div>`;
    return;
  }

  // Build timeline rows: interleave tasks with untask/break gaps
  const rows = [];
  if (sched) {
    const shiftStart = sched.start_time.slice(0,5);
    const firstTaskFmt = new Date(dayLogs[0].start_time)
      .toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
    if (firstTaskFmt > shiftStart) {
      const gapMin = (new Date(dayLogs[0].start_time) - new Date(toCST_ISO(dateStr, shiftStart))) / 60000;
      if (gapMin >= 1) rows.push({ type:'untask', name:'Untasked', dur: gapMin, startFmt: shiftStart, endFmt: firstTaskFmt });
    }
  }
  dayLogs.forEach((log, i) => {
    const startFmt = new Date(log.start_time).toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
    const endFmt   = new Date(log.end_time).toLocaleTimeString('en-US',   { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
    const dur      = (new Date(log.end_time) - new Date(log.start_time)) / 60000;
    rows.push({ type:'task', name: _epTaskMap[log.task_id] || 'Task', role: log.role, dur, startFmt, endFmt });
    if (i < dayLogs.length - 1) {
      const gapMs = new Date(dayLogs[i+1].start_time) - new Date(log.end_time);
      if (gapMs / 60000 >= 1) {
        const nextFmt = new Date(dayLogs[i+1].start_time).toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
        const { untaskMin: ut, breakMin: bk } = calcGapBreakdown(log.end_time, dayLogs[i+1].start_time, dateStr);
        if (bk >= 1) rows.push({ type:'break',  name:'Break',    dur: bk, startFmt: endFmt, endFmt: nextFmt });
        if (ut >= 1) rows.push({ type:'untask', name:'Untasked', dur: ut, startFmt: endFmt, endFmt: nextFmt });
      }
    }
  });
  if (sched) {
    const shiftEnd   = sched.end_time.slice(0,5);
    const lastEndFmt = new Date(dayLogs[dayLogs.length-1].end_time)
      .toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', hour12:false, timeZone:'America/Chicago' });
    if (lastEndFmt < shiftEnd) {
      const gapMin = (new Date(toCST_ISO(dateStr, shiftEnd)) - new Date(dayLogs[dayLogs.length-1].end_time)) / 60000;
      if (gapMin >= 1) rows.push({ type:'untask', name:'Untasked', dur: gapMin, startFmt: lastEndFmt, endFmt: shiftEnd });
    }
  }

  const colors = {
    task:   { dot:'#3b82f6', card:'ep-task-card type-task' },
    untask: { dot:'#f59e0b', card:'ep-task-card type-untask' },
    break:  { dot:'#a3e635', card:'ep-task-card' }
  };
  let html = '';
  rows.forEach((row, idx) => {
    const c      = colors[row.type] || colors.task;
    const isLast = idx === rows.length - 1;
    html += `<div class="ep-timeline-row">
      <div class="ep-timeline-spine">
        <div class="ep-spine-dot" style="background:${c.dot};border-color:${c.dot};"></div>
        ${isLast ? '' : '<div class="ep-spine-line"></div>'}
      </div>
      <div class="${c.card}" style="${row.type==='break'?'background:#f0fdf4;border-color:#bbf7d0;':''}">
        <div class="ep-task-name">${row.name}${row.role ? `<span style="font-size:10px;font-weight:500;color:#94a3b8;margin-left:8px;">${row.role}</span>` : ''}</div>
        <div class="ep-task-meta">
          <span class="ep-task-time">${row.startFmt} ‚Äì ${row.endFmt}</span>
          <span class="ep-task-dur">${formatTime(Math.round(row.dur))}</span>
        </div>
      </div>
    </div>`;
  });
  timeline.innerHTML = html;
}

// Update hero KPI strip for today
function updateEpKpis(workedMin, schedMin, untaskMin, prod) {
  document.getElementById('epKpiWorked').textContent    = formatTime(Math.round(workedMin));
  document.getElementById('epKpiSched').textContent     = schedMin > 0 ? formatTime(Math.round(schedMin)) : '‚Äî';
  document.getElementById('epKpiUntask').textContent    = formatTime(Math.round(untaskMin));
  const prodEl  = document.getElementById('epKpiProd');
  const fillEl  = document.getElementById('epProdFill');
  if (prod === null) {
    prodEl.textContent = '‚Äî';
    fillEl.style.width = '0%'; fillEl.style.background = '#cbd5e1';
  } else {
    prodEl.textContent = prod + '%';
    const color = prod >= 90 ? '#22c55e' : prod >= 80 ? '#4ade80' : prod >= 70 ? '#facc15' : prod >= 60 ? '#fb923c' : '#f87171';
    fillEl.style.width = Math.min(prod, 100) + '%';
    fillEl.style.background = color;
    prodEl.style.color = color;
  }
}

async function savePortalTask() {
  const date     = document.getElementById('portalDate').value;
  const taskName = document.getElementById('portalTaskName').value.trim();
  const role     = document.getElementById('portalRole').value;
  const startT   = document.getElementById('portalStart').value;
  const endT     = document.getElementById('portalEnd').value;
  const btn      = document.getElementById('epSaveBtn');
  const statusEl = document.getElementById('portalStatus');

  const showStatus = (msg, type) => {
    statusEl.textContent = msg;
    statusEl.className   = 'ep-status ' + type;
    statusEl.style.display = 'block';
    if (type === 'success') setTimeout(() => { statusEl.style.display = 'none'; }, 3000);
  };

  if (!date || !taskName || !startT || !endT) { showStatus('Please fill in all fields', 'error'); return; }
  if (startT >= endT) { showStatus('End time must be after start time', 'error'); return; }

  // Validate against schedule
  try {
    const { data: sched } = await supabaseClient.from('employee_schedules')
      .select('start_time, end_time').eq('employee_name', currentUser.display_name).eq('schedule_date', date).limit(1);
    if (sched && sched[0]) {
      const ss = sched[0].start_time.substring(0,5);
      const se = sched[0].end_time.substring(0,5);
      if (startT < ss || endT > se) {
        showStatus(`Outside your shift (${ss} ‚Äì ${se})`, 'error'); return;
      }
    }
  } catch(e) { /* non-blocking */ }

  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  try {
    const employeeId = await getEmployeeIdByName(currentUser.display_name, true);
    const taskId     = await getTaskIdByName(taskName, true);
    const { error }  = await supabaseClient.from('task_time_logs').insert({
      employee_id: employeeId, task_id: taskId, role,
      start_time: toCSTISOString(date, startT),
      end_time:   toCSTISOString(date, endT),
      date
    });
    if (error) throw error;
    showStatus('Task saved!', 'success');
    document.getElementById('portalTaskName').value = '';
    document.getElementById('portalStart').value    = '';
    document.getElementById('portalEnd').value      = '';
    await loadPortalTasks();
    epSelectDay(_epSelectedDate);
  } catch(e) {
    showStatus('Error: ' + e.message, 'error');
  } finally {
    btn.disabled = false; btn.textContent = 'Save Task';
  }
}

async function loadPortalTasks() {
  const name  = currentUser.display_name;
  const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });

  // Get Monday of this week
  const todayDt = new Date(today + 'T12:00:00');
  const dow     = todayDt.getDay();
  const monday  = new Date(todayDt);
  monday.setDate(todayDt.getDate() - ((dow + 6) % 7));
  const weekStart = monday.toISOString().split('T')[0];

  try {
    const empId = await getEmployeeIdByName(name, false);
    _epTaskMap  = await getTaskMap();

    // Fetch this week's logs + schedules in parallel
    const [logsRes, schedRes] = await Promise.all([
      empId
        ? supabaseClient.from('task_time_logs').select('*')
            .eq('employee_id', empId).gte('date', weekStart).lte('date', today)
            .order('date', { ascending: true }).order('start_time', { ascending: true })
        : Promise.resolve({ data: [] }),
      supabaseClient.from('employee_schedules').select('*')
        .eq('employee_name', name).gte('schedule_date', weekStart).lte('schedule_date', today)
    ]);

    _epAllLogs   = logsRes.data   || [];
    _epAllScheds = schedRes.data  || [];

    // Mark week dots
    markWeekDots(_epAllLogs);

    // Compute today's KPIs
    const todaySched = _epAllScheds.find(s => s.schedule_date === today);
    const todayLogs  = _epAllLogs.filter(l => l.date === today && l.start_time && l.end_time);
    let workedMin = 0, schedMin = 0, breakMin = 0;
    if (todaySched) {
      schedMin  = calculateHours(todaySched.start_time, todaySched.end_time);
      breakMin  = isHalfDayShift(todaySched.start_time, todaySched.end_time) ? 0 : (todaySched.break_minutes || 60);
      const ss  = toCST_ISO(today, todaySched.start_time.slice(0,5));
      const se  = toCST_ISO(today, todaySched.end_time.slice(0,5));
      todayLogs.forEach(l => {
        const cs  = new Date(Math.max(new Date(l.start_time), new Date(ss)));
        const ce  = new Date(Math.min(new Date(l.end_time),   new Date(se)));
        const d   = (ce - cs) / 60000;
        if (d > 0) workedMin += d;
      });
    } else {
      todayLogs.forEach(l => { workedMin += (new Date(l.end_time) - new Date(l.start_time)) / 60000; });
    }

    // Auto-select selected day (defaults to today) ‚Äî this also updates the KPI strip
    const selectDate = _epSelectedDate || today;
    epSelectDay(selectDate);

  } catch(e) {
    console.error('Portal load error:', e);
  }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCHEDULE MANAGEMENT
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSchedules() {
  try {
    const filterEmp  = (document.getElementById('scheduleFilterEmployee')?.value || '').trim();
    const filterDate = (document.getElementById('scheduleFilterDate')?.value || '').trim();
    let q = supabaseClient.from('employee_schedules').select('*').order('schedule_date', { ascending: false }).limit(100);
    if (filterEmp)  q = q.eq('employee_name', filterEmp);
    if (filterDate) q = q.eq('schedule_date', filterDate);
    const { data, error } = await q;
    if (error) throw error;
    const container = document.getElementById('scheduleList');
    if (!data || data.length === 0) {
      updateShiftsCount(0);
      container.innerHTML = '<p style="color:#94a3b8;text-align:center;padding:40px;font-size:14px;">No shifts found ‚Äî add one above or adjust filters</p>';
      return;
    }
    updateShiftsCount(data.length);
    const batchCol = batchMode ? '<th style="width:36px;">‚òë</th>' : '';
    let html = `<table class="schedule-table"><thead><tr>${batchCol}<th>Date</th><th>Employee</th><th>Role</th><th>Hours</th><th>Duration</th><th>Break</th><th>Actions</th></tr></thead><tbody>`;
    // Group by date for visual separation
    let lastDate = '';
    data.forEach(s => {
      const dur = calculateHours(s.start_time, s.end_time);
      const halfDay = isHalfDayShift(s.start_time, s.end_time);
      const breakDisplay = halfDay ? '<span style="color:#9a3412;font-size:12px;">&#9889; Half-day</span>' : (s.break_minutes || 60) + 'm';
      const batchCbCell = batchMode ? `<td><input type="checkbox" id="batchCb_${s.id}" onchange="toggleBatchSelect('${s.id}')" ${batchSelected.has(s.id)?'checked':''}></td>` : '';
      const dateSep = (!batchMode && s.schedule_date !== lastDate)
        ? `<tr><td colspan="7" style="padding:6px 16px 2px;font-size:10px;font-weight:700;letter-spacing:1px;text-transform:uppercase;color:#94a3b8;background:#f8fafc;border-bottom:1px solid #f1f5f9;">${formatDate(s.schedule_date)}</td></tr>`
        : '';
      lastDate = s.schedule_date;
      // Avatar initials for employee
      const initials = s.employee_name.split(' ').map(w=>w[0]).join('').slice(0,2);
      const avatarColors = { 'JM':'#667eea','LD':'#f5576c','PT':'#4facfe','WS':'#43e97b' };
      const aColor = avatarColors[initials] || '#94a3b8';
      html += dateSep + `<tr>
        ${batchCbCell}
        <td style="color:#94a3b8;font-size:12px;">${batchMode ? formatDate(s.schedule_date) : ''}</td>
        <td>
          <div style="display:flex;align-items:center;gap:8px;">
            <div style="width:28px;height:28px;border-radius:8px;background:${aColor}22;color:${aColor};font-size:10px;font-weight:800;display:flex;align-items:center;justify-content:center;flex:0 0 28px;">${initials}</div>
            <strong style="font-size:13px;">${s.employee_name}</strong>
          </div>
        </td>
        <td><span class="badge badge-info" style="font-size:11px;">${s.role}</span></td>
        <td style="font-family:monospace;font-size:13px;font-weight:600;">${s.start_time.slice(0,5)} ‚Äì ${s.end_time.slice(0,5)}</td>
        <td style="font-weight:700;color:#059669;">${formatTime(dur)}</td>
        <td>${breakDisplay}</td>
        <td style="display:flex;gap:6px;">
          <button class="secondary" onclick="openEditScheduleModal('${s.id}')" style="padding:5px 10px;font-size:12px;">&#9999;</button>
          <button class="danger"    onclick="deleteSchedule('${s.id}')"         style="padding:5px 10px;font-size:12px;">&#128465;</button>
        </td>
      </tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) { document.getElementById('scheduleList').innerHTML = '<p style="color:#e53e3e;text-align:center;padding:24px;">Error loading schedules</p>'; }
}
function clearScheduleFilters() {
  const fe = document.getElementById('scheduleFilterEmployee');
  const fd = document.getElementById('scheduleFilterDate');
  if (fe) fe.value = '';
  if (fd) fd.value = '';
  loadSchedules();
}
async function openEditScheduleModal(schedId) {
  try {
    const { data: s, error } = await supabaseClient.from('employee_schedules').select('*').eq('id', schedId).single();
    if (error) throw error;
    document.getElementById('editScheduleId').value       = s.id;
    document.getElementById('editScheduleEmployee').value = s.employee_name;
    document.getElementById('editScheduleDate').value     = s.schedule_date;
    document.getElementById('editScheduleRole').value     = s.role;
    document.getElementById('editScheduleStart').value    = s.start_time ? s.start_time.substring(0,5) : '';
    document.getElementById('editScheduleEnd').value      = s.end_time   ? s.end_time.substring(0,5)   : '';
    document.getElementById('editScheduleStatus').classList.add('hidden');
    document.getElementById('editScheduleModal').classList.add('active');
  } catch (e) { alert('Error loading schedule: ' + e.message); }
}
function closeEditScheduleModal() { document.getElementById('editScheduleModal').classList.remove('active'); }
async function saveEditedSchedule() {
  const id        = document.getElementById('editScheduleId').value;
  const employee  = document.getElementById('editScheduleEmployee').value;
  const date      = document.getElementById('editScheduleDate').value;
  const role      = document.getElementById('editScheduleRole').value;
  const startTime = document.getElementById('editScheduleStart').value;
  const endTime   = document.getElementById('editScheduleEnd').value;
  if (!id || !employee || !date || !startTime || !endTime) {
    showLocalStatus('editScheduleStatus', '‚ö†Ô∏è Fill all fields', 'error'); return;
  }
  if (startTime >= endTime) {
    showLocalStatus('editScheduleStatus', '‚ö†Ô∏è End must be after start', 'error'); return;
  }
  try {
    const breakMin = isHalfDayShift(startTime, endTime) ? 0 : 60;
    const { error } = await supabaseClient.from('employee_schedules')
      .update({ employee_name: employee, schedule_date: date, role, start_time: startTime, end_time: endTime, break_minutes: breakMin })
      .eq('id', id);
    if (error) throw error;
    const note = breakMin === 0 ? ' (half-day ‚Äî no break)' : '';
    showLocalStatus('editScheduleStatus', `‚úÖ Schedule updated${note}!`, 'success');
    setTimeout(() => { closeEditScheduleModal(); loadSchedules(); }, 800);
  } catch (e) { showLocalStatus('editScheduleStatus', '‚ùå Error: ' + e.message, 'error'); }
}
async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;
  const { error } = await supabaseClient.from('employee_schedules').delete().eq('id', id);
  if (!error) { showScStatus('scheduleStatus', '‚úÖ Deleted', 'success'); loadSchedules(); }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  REAL-TIME TASK LOGGING (admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let activeTaskId = null, activeTaskInterval = null, activeTaskStartTime = null;
async function startTask() {
  const employee = document.getElementById('taskEmployee').value;
  const role = document.getElementById('taskRole').value;
  const taskName = document.getElementById('taskName').value.trim();
  if (!employee || !taskName) { showLocalStatus('taskStatus', '‚ö†Ô∏è Select employee and enter task name', 'error'); return; }
  try {
    const dateStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
    const timeStr = new Date().toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0, 5);
    const startISO = toCSTISOString(dateStr, timeStr);
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskId = await getTaskIdByName(taskName, true);
    const { data: log, error } = await supabaseClient.from('task_time_logs').insert({ employee_id: employeeId, task_id: taskId, role, start_time: startISO, date: dateStr }).select().single();
    if (error) throw error;
    activeTaskId = log.id;
    activeTaskStartTime = new Date();
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('activeTaskDisplay').textContent = `${employee} ‚Äî ${taskName} (${role})`;
    document.getElementById('activeTaskInfo').classList.remove('hidden');
    activeTaskInterval = setInterval(() => {
      const e = Math.floor((new Date() - activeTaskStartTime) / 1000);
      const h = Math.floor(e / 3600), m = Math.floor((e % 3600) / 60), s = e % 60;
      document.getElementById('taskTimer').textContent = `Elapsed: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }, 1000);
    showLocalStatus('taskStatus', '‚úÖ Task started!', 'success');
  } catch (e) { showLocalStatus('taskStatus', '‚ùå Error: ' + e.message, 'error'); }
}
async function stopTask() {
  if (!activeTaskId) return;
  try {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
    const timeStr = now.toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0, 5);
    const endISO = toCSTISOString(dateStr, timeStr);
    await supabaseClient.from('task_time_logs').update({ end_time: endISO }).eq('id', activeTaskId);
    clearInterval(activeTaskInterval);
    activeTaskId = null;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('activeTaskInfo').classList.add('hidden');
    document.getElementById('taskName').value = '';
    showLocalStatus('taskStatus', '‚úÖ Task completed!', 'success');
  } catch (e) { showLocalStatus('taskStatus', '‚ùå Error: ' + e.message, 'error'); }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ALL TASKS (admin)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// Default shift end: 8:30 PM CST
const DEFAULT_SHIFT_END = '20:30';
// Build a fake ISO string for a date+time in CST for comparison
function toCST_ISO(dateStr, timeStr) {
  return `${dateStr}T${timeStr}:00-06:00`;
}
// Generate inline gap rows (UNTASK / BREAK) between two timestamps on the same date
function buildGapRows(dateStr, empName, gapStartISO, gapEndISO, isHalfDay = false) {
  const rows = [];
  const gapStart = new Date(gapStartISO);
  const gapEnd   = new Date(gapEndISO);
  const totalMin = (gapEnd - gapStart) / (1000 * 60);
  if (totalMin < 1) return rows;
  // Half-day employees have no break ‚Äî all gap time is UNTASK
  if (isHalfDay) {
    rows.push({ type: 'UNTASK', start: gapStartISO, end: gapEndISO, min: totalMin, emp: empName, date: dateStr });
    return rows;
  }
  const breakS = new Date(toCST_ISO(dateStr, '15:00'));
  const breakE = new Date(toCST_ISO(dateStr, '16:00'));
  // Overlap with break window
  const oStart = Math.max(gapStart.getTime(), breakS.getTime());
  const oEnd   = Math.min(gapEnd.getTime(),   breakE.getTime());
  const breakMin = Math.max(0, (oEnd - oStart) / (1000 * 60));
  // Segment 1: before break
  if (gapStart < breakS && breakMin > 0) {
    const seg = (Math.min(gapEnd, breakS) - gapStart) / (1000 * 60);
    if (seg >= 1) rows.push({ type: 'UNTASK', start: gapStartISO, end: breakS.toISOString(), min: seg, emp: empName, date: dateStr });
  } else if (breakMin === 0) {
    // No break overlap at all ‚Äî pure untask
    rows.push({ type: 'UNTASK', start: gapStartISO, end: gapEndISO, min: totalMin, emp: empName, date: dateStr });
    return rows;
  }
  // Segment 2: the break itself
  if (breakMin >= 1) {
    rows.push({ type: 'BREAK', start: breakS.toISOString(), end: breakE.toISOString(), min: breakMin, emp: empName, date: dateStr });
  }
  // Segment 3: after break
  if (gapEnd > breakE && breakMin > 0) {
    const seg = (gapEnd - Math.max(gapStart, breakE)) / (1000 * 60);
    if (seg >= 1) rows.push({ type: 'UNTASK', start: breakE.toISOString(), end: gapEndISO, min: seg, emp: empName, date: dateStr });
  }
  return rows;
}
function renderGapRow(seg, dateStr) {
  const isBreak = seg.type === 'BREAK';
  const bg    = isBreak ? 'background:#fff0f0;' : 'background:#fff7ed;';
  const badge = isBreak
    ? '<span class="badge badge-danger">‚òï Break</span>'
    : '<span class="badge badge-untask">‚è∏ Untask</span>';
  const icon  = isBreak ? '‚òï' : '‚è∏';
  return `<tr style="${bg}font-style:italic;color:#92400e;">
    <td>${formatDate(dateStr)}</td>
    <td><strong>${seg.emp}</strong></td>
    <td style="color:${isBreak ? '#c53030' : '#9c4221'};font-weight:600;">${icon} ${seg.type === 'BREAK' ? 'BREAK TIME' : 'NO TASK ASSIGNED'}</td>
    <td><span class="badge" style="background:#e2e8f0;color:#4a5568;">‚Äî</span></td>
    <td>${formatDateTime(seg.start)}</td>
    <td>${formatDateTime(seg.end)}</td>
    <td><strong>${formatTime(seg.min)}</strong></td>
    <td>${badge}</td>
    <td><span class="badge" style="background:#fef3c7;color:#92400e;">Auto</span></td>
    <td>‚Äî</td>
  </tr>`;
}
async function loadAllTasks() {
  const employeeName = document.getElementById('allTasksEmployee').value;
  const startDate    = document.getElementById('allTasksStartDate').value;
  const endDate      = document.getElementById('allTasksEndDate').value;
  const role         = document.getElementById('allTasksRole').value;
  const statusFilter = (document.getElementById('allTasksStatus')?.value || '').toLowerCase();
  const tbody        = document.getElementById('allTasksTableBody');
  tbody.innerHTML    = '<tr><td colspan="10" style="text-align:center;padding:24px;">Loading...</td></tr>';
  try {
    let q = supabaseClient.from('task_time_logs').select('*');
    if (startDate) q = q.gte('date', startDate);
    if (endDate)   q = q.lte('date', endDate);
    if (role)      q = q.eq('role', role);
    if (employeeName) {
      const empId = await getEmployeeIdByName(employeeName, false);
      if (!empId) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>'; return; }
      q = q.eq('employee_id', empId);
    }
    const { data: logs, error } = await q;
    if (error) throw error;
    if (!logs || logs.length === 0) {
      document.getElementById('allTasksCount').textContent = '0 tasks';
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>';
      return;
    }
    const [empMap, taskMap, { data: schedules }] = await Promise.all([
      getEmployeeMap(), getTaskMap(),
      supabaseClient.from('employee_schedules').select('employee_name, schedule_date, end_time')
    ]);
    // Enrich and filter only completed tasks
    const enriched = logs.map(l => ({
      ...l,
      _emp:  empMap[l.employee_id] || '?',
      _task: taskMap[l.task_id]    || 'N/A'
    })).filter(l => l.start_time && l.end_time);
    // Sort: date DESC, employee ASC, start_time ASC within same group
    enriched.sort((a, b) => {
      if (a.date !== b.date) return a.date > b.date ? -1 : 1;
      if (a._emp !== b._emp) return a._emp.localeCompare(b._emp);
      return new Date(a.start_time) - new Date(b.start_time);
    });
    // Group by date|emp
    const groups = new Map();
    enriched.forEach(l => {
      const key = `${l.date}|${l._emp}`;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(l);
    });
    // Build schedule end-time lookup
    const schedEnd = {};
    (schedules || []).forEach(s => {
      const et = (s.end_time || DEFAULT_SHIFT_END).substring(0, 5);
      schedEnd[`${s.employee_name}|${s.schedule_date}`] = et;
    });
    let html = '';
    let totalRealTasks = 0;
    for (const [key, group] of groups) {
      const [dateStr, empName] = key.split('|');
      group.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      totalRealTasks += group.length;
      for (let i = 0; i < group.length; i++) {
        const log = group[i];
        // ‚îÄ‚îÄ Gap BEFORE this task ‚îÄ‚îÄ
        if (i > 0) {
          const prev = group[i - 1];
          const gapMin = (new Date(log.start_time) - new Date(prev.end_time)) / (1000 * 60);
          if (gapMin >= 1 && statusFilter !== 'done') {
            buildGapRows(dateStr, empName, prev.end_time, log.start_time)
              .forEach(seg => { html += renderGapRow(seg, dateStr); });
          }
        }
        // ‚îÄ‚îÄ Real task row ‚îÄ‚îÄ
        if (statusFilter !== 'auto') {
          const dur = formatTime((new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60));
          html += `<tr>
            <td>${formatDate(log.date)}</td>
            <td><strong>${log._emp}</strong></td>
            <td>${log._task}</td>
            <td><span class="badge badge-info">${log.role || '‚Äî'}</span></td>
            <td>${formatDateTime(log.start_time)}</td>
            <td>${formatDateTime(log.end_time)}</td>
            <td><strong>${dur}</strong></td>
            <td><span class="badge badge-purple">üìù Task</span></td>
            <td><span class="badge badge-success">Done</span></td>
            <td style="display:flex;gap:6px;">
              <button class="secondary" onclick="openEditTaskModal('${log.id}')" style="padding:5px 10px;font-size:12px;">‚úèÔ∏è</button>
              <button class="danger" onclick="deleteTask('${log.id}')" style="padding:5px 10px;font-size:12px;">üóë</button>
            </td>
          </tr>`;
        }
        // ‚îÄ‚îÄ Gap AFTER last task ‚Üí shift end ‚îÄ‚îÄ
        if (i === group.length - 1 && statusFilter !== 'done') {
          const shiftEndTime = schedEnd[`${empName}|${dateStr}`] || DEFAULT_SHIFT_END;
          const shiftEndISO  = toCST_ISO(dateStr, shiftEndTime);
          const afterMin     = (new Date(shiftEndISO) - new Date(log.end_time)) / (1000 * 60);
          if (afterMin >= 1) {
            buildGapRows(dateStr, empName, log.end_time, shiftEndISO)
              .forEach(seg => { html += renderGapRow(seg, dateStr); });
          }
        }
      }
    }
    document.getElementById('allTasksCount').textContent = `${totalRealTasks} tasks`;
    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>';
  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:24px;color:#e53e3e;">Error: ${e.message}</td></tr>`;
  }
}
async function openEditTaskModal(taskId) {
  try {
    const { data: log, error } = await supabaseClient.from('task_time_logs').select('*').eq('id', taskId).single();
    if (error) throw error;
    const [empMap, taskMap] = await Promise.all([getEmployeeMap(), getTaskMap()]);
    document.getElementById('editTaskId').value = log.id;
    document.getElementById('editTaskEmployee').value = empMap[log.employee_id] || '';
    document.getElementById('editTaskDate').value = log.date || '';
    document.getElementById('editTaskRole').value = log.role || '';
    document.getElementById('editTaskName').value = taskMap[log.task_id] || '';
    document.getElementById('editTaskStart').value = log.start_time ? new Date(log.start_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }) : '';
    document.getElementById('editTaskEnd').value = log.end_time ? new Date(log.end_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }) : '';
    document.getElementById('editTaskModal').classList.add('active');
  } catch (e) { alert('Error loading task: ' + e.message); }
}
function closeEditTaskModal() { document.getElementById('editTaskModal').classList.remove('active'); }
async function saveEditedTask() {
  const id = document.getElementById('editTaskId').value;
  const employee = document.getElementById('editTaskEmployee').value;
  const date = document.getElementById('editTaskDate').value;
  const role = document.getElementById('editTaskRole').value;
  const taskName = document.getElementById('editTaskName').value;
  const startTime = document.getElementById('editTaskStart').value;
  const endTime = document.getElementById('editTaskEnd').value;
  if (!id || !employee || !date || !taskName || !startTime) { alert('Fill all required fields'); return; }
  try {
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskIdDb = await getTaskIdByName(taskName, true);
    const update = { employee_id: employeeId, task_id: taskIdDb, role, start_time: toCSTISOString(date, startTime), date };
    if (endTime) update.end_time = toCSTISOString(date, endTime); else update.end_time = null;
    const { error } = await supabaseClient.from('task_time_logs').update(update).eq('id', id);
    if (error) throw error;
    alert('Task updated!');
    closeEditTaskModal();
    loadAllTasks();
  } catch (e) { alert('Error: ' + e.message); }
}
async function deleteTask(taskId) {
  if (!confirm('Delete this task?')) return;
  const { error } = await supabaseClient.from('task_time_logs').delete().eq('id', taskId);
  if (!error) { showGlobalStatus('‚úÖ Task deleted', 'success'); loadAllTasks(); }
  else alert('Error: ' + error.message);
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BATCH ENTRY
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let batchRowCount = 0;
function addBatchRow() {
  batchRowCount++;
  const div = document.createElement('div');
  div.id = `batchRow${batchRowCount}`;
  div.className = 'time-entry';
  div.innerHTML = `
    <input type="time" class="batchStart" placeholder="Start">
    <input type="time" class="batchEnd" placeholder="End">
    <input type="text" class="batchTask" placeholder="Task name">
    <select class="batchRole">
      <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
    </select>
    <button onclick="removeBatchRow(${batchRowCount})" class="danger" style="padding:7px;">‚úï</button>`;
  document.getElementById('batchRows').appendChild(div);
  attachBatchRowNav(div);
}
function attachBatchRowNav(row) {
  const startInput = row.querySelector('.batchStart');
  const endInput   = row.querySelector('.batchEnd');
  const taskInput  = row.querySelector('.batchTask');
  function isFull(inp) { return /^\d{2}:\d{2}$/.test(inp.value); }
  startInput.addEventListener('keydown', function(e) {
    const key = e.key.toLowerCase();
    if (key === 'a' || key === 'p') {
      setTimeout(() => { if (isFull(this)) endInput.focus(); }, 50);
    }
  });
  endInput.addEventListener('keydown', function(e) {
    const key = e.key.toLowerCase();
    if (key === 'a' || key === 'p') {
      setTimeout(() => { if (isFull(this)) taskInput.focus(); }, 50);
    }
  });
  taskInput.addEventListener('keydown', function(e) {
    if (e.key === 'Tab' && !e.shiftKey) {
      const allRows = Array.from(document.querySelectorAll('#batchRows > div'));
      const idx = allRows.indexOf(row);
      if (idx !== -1 && idx < allRows.length - 1) {
        e.preventDefault();
        const nextStart = allRows[idx + 1].querySelector('.batchStart');
        if (nextStart) nextStart.focus();
      } else if (idx === allRows.length - 1) {
        e.preventDefault();
        addBatchRow();
        const allRowsNow = document.querySelectorAll('#batchRows > div');
        const newRow = allRowsNow[allRowsNow.length - 1];
        newRow.querySelector('.batchStart').focus();
      }
    }
  });
}
function removeBatchRow(id) { document.getElementById(`batchRow${id}`)?.remove(); }
function clearBatchRows() { document.getElementById('batchRows').innerHTML = ''; batchRowCount = 0; }
async function saveBatchTasks() {
  const date = document.getElementById('batchDate').value;
  const employee = document.getElementById('batchEmployee').value;
  if (!date || !employee) { showLocalStatus('batchStatus', '‚ö†Ô∏è Select date and employee', 'error'); return; }
  const rows = document.querySelectorAll('#batchRows > div');
  if (!rows.length) { showLocalStatus('batchStatus', '‚ö†Ô∏è Add at least one task', 'error'); return; }
  try {
    const employeeId = await getEmployeeIdByName(employee, true);
    let saved = 0;
    for (const row of rows) {
      const s = row.querySelector('.batchStart').value;
      const e = row.querySelector('.batchEnd').value;
      const n = row.querySelector('.batchTask').value;
      const r = row.querySelector('.batchRole').value;
      if (!s || !e || !n) continue;
      const taskId = await getTaskIdByName(n, true);
      const { error } = await supabaseClient.from('task_time_logs').insert({ employee_id: employeeId, task_id: taskId, role: r, start_time: toCSTISOString(date, s), end_time: toCSTISOString(date, e), date });
      if (error) throw error;
      saved++;
    }
    showLocalStatus('batchStatus', `‚úÖ Saved ${saved} tasks!`, 'success');
    clearBatchRows();
  } catch (e) { showLocalStatus('batchStatus', '‚ùå Error: ' + e.message, 'error'); }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  ANALYTICS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let hoursChart = null;
// Standard break window: 3:00 PM ‚Äì 4:00 PM CST for FULL-DAY employees only
// Half-day employees (< 5.5 scheduled hours) get NO break
const BREAK_WINDOW_START = 15; // 15:00 CST
const BREAK_WINDOW_END   = 16; // 16:00 CST
const HALF_DAY_THRESHOLD_HOURS = 5.5; // shifts under this = half-day, no break

/**
 * Returns true if this employee's scheduled shift is a half-day (no break)
 */
function isHalfDayShift(schedStart, schedEnd) {
  if (!schedStart || !schedEnd) return false;
  const [sh, sm] = schedStart.split(':').map(Number);
  const [eh, em] = schedEnd.split(':').map(Number);
  const totalMin = (eh * 60 + em) - (sh * 60 + sm);
  return totalMin < HALF_DAY_THRESHOLD_HOURS * 60;
}

/**
 * Given a raw gap (gapStartISO ‚Üí gapEndISO), subtract any overlap
 * with the standard break window (3‚Äì4 PM CST) ONLY for full-day employees.
 * Half-day employees have no break ‚Üí all gap time = untask.
 * Returns: { untaskMin, breakMin }
 */
function calcGapBreakdown(gapStartISO, gapEndISO, dateStr, isHalfDay = false) {
  const gapStart   = new Date(gapStartISO);
  const gapEnd     = new Date(gapEndISO);
  const totalGap   = (gapEnd - gapStart) / (1000 * 60);
  if (totalGap < 1) return { untaskMin: 0, breakMin: 0 };
  
  // Half-day employees: no break at all, all gap = untask
  if (isHalfDay) return { untaskMin: totalGap, breakMin: 0 };
  
  // Build 3 PM and 4 PM boundaries for this date in CST (UTC-6)
  const breakStart = new Date(`${dateStr}T${String(BREAK_WINDOW_START).padStart(2,'0')}:00:00-06:00`);
  const breakEnd   = new Date(`${dateStr}T${String(BREAK_WINDOW_END).padStart(2,'0')}:00:00-06:00`);
  // Overlap between gap and break window
  const overlapStart = Math.max(gapStart.getTime(), breakStart.getTime());
  const overlapEnd   = Math.min(gapEnd.getTime(),   breakEnd.getTime());
  const breakMin     = Math.max(0, (overlapEnd - overlapStart) / (1000 * 60));
  const untaskMin    = Math.max(0, totalGap - breakMin);
  return { untaskMin, breakMin };
}
function changeAnalyticsPeriod() {
  const p = document.getElementById('analyticsPeriod').value;
  document.getElementById('dailyDateGroup').style.display   = p === 'daily'   ? 'block' : 'none';
  document.getElementById('weeklyDateGroup').style.display  = p === 'weekly'  ? 'block' : 'none';
  document.getElementById('monthlyDateGroup').style.display = p === 'monthly' ? 'block' : 'none';
  document.getElementById('customDateGroup').style.display  = p === 'custom'  ? 'block' : 'none';
  document.getElementById('customEndGroup').style.display   = p === 'custom'  ? 'block' : 'none';
}
async function loadAnalytics() {
  const period = document.getElementById('analyticsPeriod').value;
  const selEmp = document.getElementById('analyticsEmployee').value;
  let startDate, endDate, displayText;
  if (period === 'daily') {
    startDate = endDate = document.getElementById('analyticsDate').value;
    displayText = `Daily ‚Äî ${formatDate(startDate)}`;
  } else if (period === 'weekly') {
    startDate = document.getElementById('analyticsWeek').value;
    const we = new Date(startDate); we.setDate(we.getDate() + 6);
    endDate = we.toISOString().split('T')[0];
    displayText = `Weekly ‚Äî ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else if (period === 'monthly') {
    const month = document.getElementById('analyticsMonth').value;
    startDate = `${month}-01`;
    const ld = new Date(+month.split('-')[0], +month.split('-')[1], 0).getDate();
    endDate = `${month}-${String(ld).padStart(2,'0')}`;
    displayText = `Monthly ‚Äî ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else {
    startDate = document.getElementById('analyticsStart').value;
    endDate   = document.getElementById('analyticsEnd').value;
    displayText = `${formatDate(startDate)} to ${formatDate(endDate)}`;
  }
  if (!startDate) { showGlobalStatus('‚ö†Ô∏è Select a date first', 'error'); return; }
  if (selEmp) displayText += ` | ${selEmp}`;
  document.getElementById('currentPeriodDisplay').textContent = displayText;
  try {
    let schedQ = supabaseClient.from('employee_schedules').select('*').gte('schedule_date', startDate).lte('schedule_date', endDate);
    let logsQ  = supabaseClient.from('task_time_logs').select('*').gte('date', startDate).lte('date', endDate);
    if (selEmp) {
      schedQ = schedQ.eq('employee_name', selEmp);
      const eid = await getEmployeeIdByName(selEmp, false);
      logsQ = eid ? logsQ.eq('employee_id', eid) : logsQ.eq('employee_id', '00000000-0000-0000-0000-000000000000');
    }
    const [
      { data: schedules, error: sE },
      { data: logs, error: lE },
      empMap, taskMap
    ] = await Promise.all([schedQ, logsQ, getEmployeeMap(), getTaskMap()]);
    if (sE) throw sE; if (lE) throw lE;
    let totalSched = 0, totalWorked = 0, totalBreak = 0, totalUntask = 0, totalTasks = 0;
    const empStats = {};
    const untaskDetails = [];

    // Build fast lookup: "empName|date" ‚Üí schedule row
    const schedMap = {};
    (schedules || []).forEach(s => { schedMap[`${s.employee_name}|${s.schedule_date}`] = s; });

    // Group task logs by "empName|date"
    const logGroups = {};
    if (logs && logs.length) {
      const enriched = logs
        .filter(l => l.start_time && l.end_time)
        .map(l => ({ ...l, _emp: empMap[l.employee_id] || 'Unknown', _task: taskMap[l.task_id] || 'Unknown' }));
      enriched.forEach(l => {
        const key = `${l._emp}|${l.date}`;
        if (!logGroups[key]) logGroups[key] = [];
        logGroups[key].push(l);
      });
      Object.values(logGroups).forEach(g => g.sort((a, b) => new Date(a.start_time) - new Date(b.start_time)));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    // IRON RULE:  Worked + Untask + Break = Scheduled
    //
    //  schedMin  = scheduled end ‚àí start
    //  breakMin  = schedule.break_minutes (0 for half-day)
    //  effectMin = schedMin ‚àí breakMin
    //  workedMin = sum of task durations CLIPPED to [schedStart, schedEnd]
    //  untaskMin = max(0, effectMin ‚àí workedMin)
    //  Productivity = workedMin / effectMin
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    const processedKeys = new Set();

    for (const s of (schedules || [])) {
      const empName = s.employee_name;
      const dateStr = s.schedule_date;
      const key     = `${empName}|${dateStr}`;
      if (processedKeys.has(key)) continue;
      processedKeys.add(key);

      if (!empStats[empName]) empStats[empName] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };

      const schedMin  = calculateHours(s.start_time, s.end_time);
      const halfDay   = isHalfDayShift(s.start_time, s.end_time);
      const breakMin  = halfDay ? 0 : (s.break_minutes || 60);
      const effectMin = Math.max(0, schedMin - breakMin);

      const shiftStartISO = toCST_ISO(dateStr, s.start_time.substring(0, 5));
      const shiftEndISO   = toCST_ISO(dateStr, s.end_time.substring(0, 5));
      const group = (logGroups[key] || []);

      // Clip each task to the scheduled window, sum worked minutes
      let workedMin = 0;
      let tasksCount = 0;
      for (const log of group) {
        const cs = new Date(Math.max(new Date(log.start_time).getTime(), new Date(shiftStartISO).getTime()));
        const ce = new Date(Math.min(new Date(log.end_time).getTime(),   new Date(shiftEndISO).getTime()));
        const dur = (ce - cs) / (1000 * 60);
        if (dur > 0) { workedMin += dur; tasksCount++; }
      }

      const untaskMin = Math.max(0, effectMin - workedMin);

      totalSched  += schedMin;
      totalBreak  += breakMin;
      totalWorked += workedMin;
      totalUntask += untaskMin;
      totalTasks  += tasksCount;

      empStats[empName].scheduled += schedMin;
      empStats[empName].break     += breakMin;
      empStats[empName].worked    += workedMin;
      empStats[empName].untask    += untaskMin;
      empStats[empName].tasks     += tasksCount;

      // Build untask detail rows for the gap log table
      if (group.length > 0) {
        // Gap: shift start ‚Üí first task
        const firstStart = new Date(Math.max(new Date(group[0].start_time).getTime(), new Date(shiftStartISO).getTime()));
        const beforeFirst = (firstStart.getTime() - new Date(shiftStartISO).getTime()) / (1000 * 60);
        if (beforeFirst >= 1) {
          untaskDetails.push({ employee: empName, date: dateStr, gapStart: shiftStartISO, gapEnd: group[0].start_time, duration: beforeFirst, nextTask: group[0]._task + ' (first task)' });
        }
        // Gaps between tasks
        for (let i = 1; i < group.length; i++) {
          const gapMin = (new Date(group[i].start_time) - new Date(group[i-1].end_time)) / (1000 * 60);
          if (gapMin >= 1) {
            const { untaskMin: ut } = halfDay
              ? { untaskMin: gapMin }
              : calcGapBreakdown(group[i-1].end_time, group[i].start_time, dateStr, false);
            if (ut >= 1) untaskDetails.push({ employee: empName, date: dateStr, gapStart: group[i-1].end_time, gapEnd: group[i].start_time, duration: ut, nextTask: group[i]._task });
          }
        }
        // Gap: last task ‚Üí shift end
        const lastLogEnd = new Date(Math.min(new Date(group[group.length-1].end_time).getTime(), new Date(shiftEndISO).getTime()));
        const afterLast  = (new Date(shiftEndISO).getTime() - lastLogEnd.getTime()) / (1000 * 60);
        if (afterLast >= 1) {
          untaskDetails.push({ employee: empName, date: dateStr, gapStart: group[group.length-1].end_time, gapEnd: shiftEndISO, duration: afterLast, nextTask: '\u{1F3C1} End of Shift (' + s.end_time.substring(0,5) + ')' });
        }
      } else if (untaskMin >= 1) {
        // No tasks at all
        untaskDetails.push({ employee: empName, date: dateStr, gapStart: shiftStartISO, gapEnd: shiftEndISO, duration: untaskMin, nextTask: '\u26A0 No tasks logged' });
      }
    }

    // Employees with task logs but no schedule entry ‚Äî count worked only, no untask/break
    if (logs && logs.length) {
      const enrichedAll = logs
        .filter(l => l.start_time && l.end_time)
        .map(l => ({ ...l, _emp: empMap[l.employee_id] || 'Unknown' }));
      const extra = {};
      enrichedAll.forEach(l => {
        const k = `${l._emp}|${l.date}`;
        if (!processedKeys.has(k)) {
          if (!extra[k]) extra[k] = { emp: l._emp, logs: [] };
          extra[k].logs.push(l);
        }
      });
      for (const { emp, logs: el } of Object.values(extra)) {
        if (!empStats[emp]) empStats[emp] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
        el.forEach(log => {
          const dur = (new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60);
          if (dur > 0) { totalWorked += dur; totalTasks++; empStats[emp].worked += dur; empStats[emp].tasks++; }
        });
      }
    }

    // Productivity = Worked / (Scheduled - Break) = Worked / (Worked + Untask)
    const effectiveSched = Math.max(0, totalSched - totalBreak);
    const productivity   = effectiveSched > 0 ? Math.round((totalWorked / effectiveSched) * 100) : null;
    document.getElementById('totalScheduled').textContent = formatTime(totalSched);
    document.getElementById('totalWorked').textContent    = formatTime(totalWorked);
    document.getElementById('totalUnlogged').textContent  = formatTime(totalUntask);
    document.getElementById('totalBreak').textContent     = formatTime(totalBreak);
    const cls = prodColorClass(productivity);
    const prodEl = document.getElementById('totalProductivity');
    prodEl.textContent = productivity !== null ? productivity + '%' : '\u2014';
    prodEl.className = cls || '';
    document.getElementById('totalTasks').textContent = totalTasks;
    renderEmployeeBreakdown(empStats);
    renderUntaskLog(untaskDetails);
    updateHoursChart(empStats);
  } catch (e) {
    console.error(e);
    showGlobalStatus('Analytics error: ' + e.message, 'error');
  }
}
/**
 * Returns CSS class for productivity color band
 * < 50%   ‚Üí prod-critical (red)
 * 50-60%  ‚Üí prod-very-low (dark orange)
 * 60-70%  ‚Üí prod-low (yellow-orange)
 * 70-80%  ‚Üí prod-medium (yellow)
 * 80-90%  ‚Üí prod-good (light green)
 * 90-100% ‚Üí prod-excellent (green)
 */
function prodColorClass(prod) {
  if (prod === null || prod === undefined) return '';
  if (prod < 50)  return 'prod-critical';
  if (prod < 60)  return 'prod-very-low';
  if (prod < 70)  return 'prod-low';
  if (prod < 80)  return 'prod-medium';
  if (prod < 90)  return 'prod-good';
  return 'prod-excellent';
}

function prodLabel(prod) {
  if (prod === null || prod === undefined) return '‚Äî';
  if (prod < 50)  return `üî¥ ${prod}%`;
  if (prod < 60)  return `üü† ${prod}%`;
  if (prod < 70)  return `üü° ${prod}%`;
  if (prod < 80)  return `üü° ${prod}%`;
  if (prod < 90)  return `üü¢ ${prod}%`;
  return `‚úÖ ${prod}%`;
}

function renderEmployeeBreakdown(empStats) {
  const names = Object.keys(empStats || {});
  const tbody = document.getElementById('employeeBreakdown');
  if (!names.length) { tbody.innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#718096;">No data</td></tr>'; return; }

  // Update header to include balance column
  const thead = tbody.closest('table').querySelector('thead tr');
  if (thead) thead.innerHTML = '<th>Employee</th><th>Scheduled</th><th>Worked</th><th>Break</th><th>Untask</th><th># Tasks</th><th>Productivity</th><th title="Worked + Untask + Break should = Scheduled">&#9989; Balance</th>';

  let html = '';
  names.forEach(name => {
    const s = empStats[name];
    const eff  = Math.max(0, (s.scheduled || 0) - (s.break || 0));
    // Iron rule: Productivity = Worked / Effective = Worked / (Worked + Untask)
    const prod = eff > 0 ? Math.round(((s.worked || 0) / eff) * 100) : null;
    const cls  = prodColorClass(prod);

    // Balance check: Worked + Untask + Break should equal Scheduled (within rounding)
    const total = (s.worked || 0) + (s.untask || 0) + (s.break || 0);
    const diff  = Math.abs(total - (s.scheduled || 0));
    const balanced = diff < 2; // within 2 minutes = fine (rounding)
    const balanceBadge = (s.scheduled || 0) === 0 ? '‚Äî'
      : balanced
        ? '<span class="badge badge-success" title="Worked+Untask+Break = Scheduled ‚úì">&#9989;</span>'
        : `<span class="badge badge-danger" title="Off by ${Math.round(diff)}m">&#9888; Off ${Math.round(diff)}m</span>`;

    html += `<tr>
      <td><strong>${name}</strong></td>
      <td>${formatTime(s.scheduled || 0)}</td>
      <td style="color:#166534;font-weight:700;">${formatTime(s.worked || 0)}</td>
      <td style="color:#9a3412;">${formatTime(s.break || 0)}</td>
      <td><span class="badge badge-warning">${formatTime(s.untask || 0)}</span></td>
      <td>${s.tasks || 0}</td>
      <td><span class="${cls}">${prodLabel(prod)}</span></td>
      <td style="text-align:center;">${balanceBadge}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
}
function renderUntaskLog(details) {
  const tbody = document.getElementById('unloggedLogBody');
  if (!details || !details.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:#718096;">No untask gaps found ‚Äî great productivity!</td></tr>';
    return;
  }
  // Restore original 6-column header
  const thead = tbody.closest('table').querySelector('thead tr');
  if (thead) {
    thead.innerHTML = '<th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th>';
  }
  details.sort((a, b) => (a.date > b.date ? -1 : 1) || a.employee.localeCompare(b.employee));
  let html = '';
  details.forEach(row => {
    const isEndOfShift = row.nextTask.includes('End of Shift');
    html += `<tr class="untask-row">
      <td>${formatDate(row.date)}</td>
      <td><strong>${row.employee}</strong></td>
      <td>${formatDateTime(row.gapStart)}</td>
      <td>${formatDateTime(row.gapEnd)}</td>
      <td><strong class="badge badge-warning">${formatTime(row.duration)}</strong></td>
      <td style="color:${isEndOfShift ? '#c05621' : '#718096'};font-size:12px;font-weight:${isEndOfShift ? '700' : '400'};">‚Üí ${row.nextTask}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
}
function updateHoursChart(empStats) {
  const canvas = document.getElementById('hoursChart');
  if (!canvas) return;
  if (hoursChart) hoursChart.destroy();
  const labels = Object.keys(empStats || {});
  if (!labels.length) return;
  hoursChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Scheduled', data: labels.map(k => +(empStats[k].scheduled / 60).toFixed(2)), backgroundColor: 'rgba(44,82,130,0.75)', borderColor: '#2c5282', borderWidth: 2 },
        { label: 'Worked',    data: labels.map(k => +(empStats[k].worked / 60).toFixed(2)),    backgroundColor: 'rgba(34,197,94,0.75)',  borderColor: '#16a34a', borderWidth: 2 },
        { label: 'Untask',    data: labels.map(k => +(empStats[k].untask / 60).toFixed(2)),    backgroundColor: 'rgba(245,158,11,0.75)', borderColor: '#d97706', borderWidth: 2 },
        { label: 'Break',     data: labels.map(k => +(empStats[k].break / 60).toFixed(2)),     backgroundColor: 'rgba(239,68,68,0.55)',  borderColor: '#dc2626', borderWidth: 2 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' }, ticks: { callback: v => v + 'h' } } },
      plugins: { legend: { position: 'top' } }
    }
  });
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCHEDULE VS ACTUAL
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
async function loadSchedVsActual() {
  const date = document.getElementById('svaDate').value;
  const emp  = document.getElementById('svaEmployee').value;
  if (!date) { showGlobalStatus('‚ö†Ô∏è Select a date', 'error'); return; }
  const container = document.getElementById('svaContent');
  container.innerHTML = '<p style="text-align:center;padding:24px;color:#718096;">Loading...</p>';
  try {
    let schedQ = supabaseClient.from('employee_schedules').select('*').eq('schedule_date', date);
    let logsQ  = supabaseClient.from('task_time_logs').select('*').eq('date', date);
    if (emp) { schedQ = schedQ.eq('employee_name', emp); const eid = await getEmployeeIdByName(emp, false); if (eid) logsQ = logsQ.eq('employee_id', eid); }
    const [{ data: scheds }, { data: logs }, empMap, taskMap] = await Promise.all([schedQ, logsQ, getEmployeeMap(), getTaskMap()]);
    const empNames = [...new Set([...(scheds||[]).map(s=>s.employee_name), ...(logs||[]).map(l=>empMap[l.employee_id]||'').filter(Boolean)])].sort();
    if (!empNames.length) { container.innerHTML = '<p style="color:#718096;text-align:center;padding:40px;">No data for this date</p>'; return; }
    let html = '<table class="schedule-table"><thead><tr><th>Employee</th><th>Scheduled</th><th>Sched Hours</th><th>Worked Hours</th><th>Untask</th><th>Difference</th><th>Status</th></tr></thead><tbody>';
    empNames.forEach(name => {
      const s = (scheds||[]).find(sc => sc.employee_name === name);
      const empId = Object.keys(empMap).find(k => empMap[k] === name);
      const empLogs = (logs||[]).filter(l => l.employee_id === empId && l.start_time && l.end_time);
      const schedMin = s ? calculateHours(s.start_time, s.end_time) : 0;
      const workedMin = empLogs.reduce((sum, l) => sum + (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60), 0);
      const diff = workedMin - schedMin;
      const diffStr = (diff >= 0 ? '+' : '') + formatTime(Math.abs(diff));
      const color = diff >= 0 ? '#065f46' : '#991b1b';
      const status = diff >= 0 ? '<span class="badge badge-success">‚úÖ On Track</span>' : '<span class="badge badge-danger">‚ö†Ô∏è Under</span>';
      html += `<tr><td><strong>${name}</strong></td><td>${s ? s.start_time + ' ‚Äì ' + s.end_time : '‚Äî'}</td><td>${formatTime(schedMin)}</td><td>${formatTime(workedMin)}</td><td>‚Äî</td><td style="font-weight:700;color:${color};">${diffStr}</td><td>${status}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) { container.innerHTML = `<p style="color:#e53e3e;text-align:center;padding:40px;">Error: ${e.message}</p>`; }
}
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCHEDULE DESIGN SYSTEM ‚Äî UI HELPERS
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

// Role chip selector
function pickRole(btn, prefix) {
  const container = btn.closest('.sc-role-chips');
  container.querySelectorAll('.sc-role-chip').forEach(c => c.classList.remove('sc-role-active'));
  btn.classList.add('sc-role-active');
  // Sync hidden select
  const selectId = prefix === 'add' ? 'scheduleRole' : null;
  if (selectId) {
    const sel = document.getElementById(selectId);
    if (sel) {
      for (const opt of sel.options) { if (opt.value === btn.textContent) { sel.value = opt.value; break; } }
    }
  }
}

// Days stepper
function scStep(delta) {
  const inp = document.getElementById('repeatDaysN');
  const v   = Math.min(60, Math.max(1, (parseInt(inp.value) || 7) + delta));
  inp.value = v;
  scClampStep();
}
function scClampStep() {
  const v   = Math.max(1, Math.min(60, parseInt(document.getElementById('repeatDaysN').value) || 1));
  document.getElementById('repeatDaysN').value = v;
  const hint = document.getElementById('scStepHint');
  if (!hint) return;
  if (v % 7 === 0) hint.textContent = `${v} days = ${v/7} week${v/7>1?'s':''}`;
  else hint.textContent = `${v} days`;
}

// Toggle employee chip checked state
function scToggleEmpChip(chip) {
  const isChecked = chip.getAttribute('data-checked') === 'true';
  chip.setAttribute('data-checked', isChecked ? 'false' : 'true');
  const cb = chip.querySelector('input[type=checkbox]');
  if (cb) cb.checked = !isChecked;
}

// Patch toggleAllCopyEmps / toggleAllRepeatEmps to update visual chips
const _origToggleAllCopyEmps   = typeof toggleAllCopyEmps   !== 'undefined' ? toggleAllCopyEmps   : null;
const _origToggleAllRepeatEmps = typeof toggleAllRepeatEmps !== 'undefined' ? toggleAllRepeatEmps : null;

function toggleAllCopyEmps(checked) {
  document.querySelectorAll('#copyEmpCheckboxes input').forEach(cb => cb.checked = checked);
  document.querySelectorAll('#copyEmpCheckboxes .sc-emp-chip').forEach(chip => chip.setAttribute('data-checked', checked ? 'true' : 'false'));
}
function toggleAllRepeatEmps(checked) {
  document.querySelectorAll('#repeatEmpCheckboxes input').forEach(cb => cb.checked = checked);
  document.querySelectorAll('#repeatEmpCheckboxes .sc-emp-chip').forEach(chip => chip.setAttribute('data-checked', checked ? 'true' : 'false'));
}

// Make avatar chips clickable via onclick on the label
document.addEventListener('DOMContentLoaded', () => {
  document.querySelectorAll('.sc-emp-chip').forEach(chip => {
    chip.addEventListener('click', () => {
      const cb = chip.querySelector('input[type=checkbox]');
      // checkbox state already toggled by label default ‚Äî just sync visual
      setTimeout(() => {
        chip.setAttribute('data-checked', cb.checked ? 'true' : 'false');
      }, 0);
    });
  });
  scClampStep();
});

// Show status in the new sc-status style
function showScStatus(id, msg, type) {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.className   = 'sc-status ' + type;
  el.style.display = 'block';
  if (type === 'success') setTimeout(() => { el.style.display = 'none'; }, 4000);
}

// Override schedule status calls to use new system
function showSchedStatus(msg, type)  { showScStatus('scheduleStatus', msg, type); }
function showCopyStatus(msg, type)   { showScStatus('copySchedStatus', msg, type); }
function showRepeatStatus(msg, type) { showScStatus('repeatSchedStatus', msg, type); }

// Update shifts count badge
function updateShiftsCount(n) {
  const el = document.getElementById('scShiftsCount');
  if (el) el.textContent = n + (n === 1 ? ' shift' : ' shifts');
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  SCHEDULE MANAGEMENT ‚Äî Add / Copy / Repeat / Batch
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
function switchSchedMode(mode) {
  ['add','copy','repeat'].forEach(m => {
    const panel = document.getElementById('schedPanel' + m.charAt(0).toUpperCase() + m.slice(1));
    const btn   = document.getElementById('schedMode'  + m.charAt(0).toUpperCase() + m.slice(1));
    if (panel) panel.style.display = m === mode ? 'block' : 'none';
    if (btn)   { btn.classList.toggle('sc-mode-active', m === mode); btn.classList.toggle('sc-mode-btn', true); }
  });
}

function addSchedule() { addScheduleOnce(); } // legacy alias

async function addScheduleOnce() {
  const date     = document.getElementById('scheduleDate').value;
  const employee = document.getElementById('scheduleEmployee').value;
  const role     = document.getElementById('scheduleRole').value;
  const start    = document.getElementById('scheduleStart').value;
  const end      = document.getElementById('scheduleEnd').value;
  if (!date || !employee || !start || !end) { showScStatus('scheduleStatus','‚ö†Ô∏è Fill all fields','error'); return; }
  if (start >= end) { showScStatus('scheduleStatus','‚ö†Ô∏è End must be after start','error'); return; }
  const breakMin = isHalfDayShift(start, end) ? 0 : 60;
  try {
    const { error } = await supabaseClient.from('employee_schedules').insert({
      schedule_date: date, employee_name: employee, role, start_time: start, end_time: end, break_minutes: breakMin
    });
    if (error) throw error;
    showScStatus('scheduleStatus', `‚úÖ Schedule saved${breakMin===0?' (half-day ‚Äî no break)':''}!`, 'success');
    loadSchedules();
  } catch (e) { showScStatus('scheduleStatus','‚ùå Error: ' + e.message,'error'); }
}

// Copy a block of days (single day or week) to a new start date, for selected employees
async function copyScheduleBlock() {
  const fromDate    = document.getElementById('copyFromDate').value;
  const fromDateEnd = document.getElementById('copyFromDateEnd').value;
  const toDate      = document.getElementById('copyToDate').value;
  if (!fromDate || !toDate) { showScStatus('copySchedStatus','‚ö†Ô∏è Fill From date and To date','error'); return; }

  const selectedEmps = [...document.querySelectorAll('#copyEmpCheckboxes input:checked')].map(c => c.value);
  if (!selectedEmps.length) { showScStatus('copySchedStatus','‚ö†Ô∏è Select at least one employee','error'); return; }

  // Determine the date range to copy
  const rangeEnd = fromDateEnd || fromDate;
  // Offset = toDate - fromDate (in days)
  const fromMs = new Date(fromDate + 'T12:00:00').getTime();
  const toMs   = new Date(toDate   + 'T12:00:00').getTime();
  const offsetDays = Math.round((toMs - fromMs) / 86400000);

  try {
    let q = supabaseClient.from('employee_schedules').select('*').gte('schedule_date', fromDate).lte('schedule_date', rangeEnd);
    const { data, error } = await q;
    if (error) throw error;

    // Filter to selected employees
    const filtered = (data||[]).filter(s => selectedEmps.includes(s.employee_name));
    if (!filtered.length) { showScStatus('copySchedStatus','‚ö†Ô∏è No schedules found for selected employees in that range','error'); return; }

    const newRows = filtered.map(s => {
      const origDate = new Date(s.schedule_date + 'T12:00:00');
      origDate.setDate(origDate.getDate() + offsetDays);
      const newDate = origDate.toISOString().split('T')[0];
      return {
        schedule_date: newDate, employee_name: s.employee_name,
        role: s.role, start_time: s.start_time, end_time: s.end_time,
        break_minutes: isHalfDayShift(s.start_time, s.end_time) ? 0 : (s.break_minutes || 60)
      };
    });

    const { error: e2 } = await supabaseClient.from('employee_schedules').insert(newRows);
    if (e2) throw e2;
    showScStatus('copySchedStatus', `‚úÖ Copied ${newRows.length} shift(s) for ${selectedEmps.length} employee(s)!`, 'success');
    loadSchedules();
  } catch (e) { showScStatus('copySchedStatus','‚ùå Error: ' + e.message,'error'); }
}

function toggleAllCopyEmps(checked) {
  document.querySelectorAll('#copyEmpCheckboxes input').forEach(cb => cb.checked = checked);
}

// Repeat a template day N consecutive times, for selected employees
async function repeatScheduleBlock() {
  const templateDate = document.getElementById('repeatTemplateDate').value;
  const startDate    = document.getElementById('repeatStartDate').value;
  const n            = parseInt(document.getElementById('repeatDaysN').value) || 7;
  if (!templateDate || !startDate) { showScStatus('repeatSchedStatus','‚ö†Ô∏è Fill all fields','error'); return; }

  const selectedEmps = [...document.querySelectorAll('#repeatEmpCheckboxes input:checked')].map(c => c.value);
  if (!selectedEmps.length) { showScStatus('repeatSchedStatus','‚ö†Ô∏è Select at least one employee','error'); return; }

  try {
    let q = supabaseClient.from('employee_schedules').select('*').eq('schedule_date', templateDate);
    const { data, error } = await q;
    if (error) throw error;
    const filtered = (data||[]).filter(s => selectedEmps.includes(s.employee_name));
    if (!filtered.length) { showScStatus('repeatSchedStatus','‚ö†Ô∏è No schedules found on template date','error'); return; }

    const newRows = [];
    for (let i = 0; i < n; i++) {
      const d = new Date(startDate + 'T12:00:00');
      d.setDate(d.getDate() + i);
      const dateStr = d.toISOString().split('T')[0];
      filtered.forEach(s => {
        newRows.push({
          schedule_date: dateStr, employee_name: s.employee_name,
          role: s.role, start_time: s.start_time, end_time: s.end_time,
          break_minutes: isHalfDayShift(s.start_time, s.end_time) ? 0 : (s.break_minutes || 60)
        });
      });
    }

    const { error: e2 } = await supabaseClient.from('employee_schedules').insert(newRows);
    if (e2) throw e2;
    showScStatus('repeatSchedStatus', `‚úÖ Added ${newRows.length} shifts (${n} days √ó ${filtered.length} employees)!`, 'success');
    loadSchedules();
  } catch (e) { showScStatus('repeatSchedStatus','‚ùå Error: ' + e.message,'error'); }
}

function toggleAllRepeatEmps(checked) {
  document.querySelectorAll('#repeatEmpCheckboxes input').forEach(cb => cb.checked = checked);
}

// ‚îÄ‚îÄ Batch Edit Mode (checkboxes in schedule list) ‚îÄ‚îÄ
let batchMode = false;
let batchSelected = new Set();

function toggleBatchMode() {
  batchMode = !batchMode;
  batchSelected.clear();
  document.getElementById('batchUpdateBar').style.display = batchMode ? 'flex' : 'none';
  document.getElementById('batchModeBtn').textContent = batchMode ? '‚úï Exit Selection' : '‚òëÔ∏è Select / Batch Edit';
  document.getElementById('batchSelectedCount').textContent = '0 selected';
  loadSchedules();
}

function cancelBatchMode() {
  batchMode = false; batchSelected.clear();
  document.getElementById('batchUpdateBar').style.display = 'none';
  document.getElementById('batchModeBtn').textContent = '‚òëÔ∏è Select / Batch Edit';
  loadSchedules();
}

function toggleBatchSelect(id) {
  if (batchSelected.has(id)) batchSelected.delete(id); else batchSelected.add(id);
  document.getElementById('batchSelectedCount').textContent = `${batchSelected.size} selected`;
  const el = document.getElementById(`batchCb_${id}`);
  if (el) el.checked = batchSelected.has(id);
}

function selectAllVisible() {
  document.querySelectorAll('[id^="batchCb_"]').forEach(cb => {
    const id = cb.id.replace('batchCb_','');
    batchSelected.add(id);
    cb.checked = true;
  });
  document.getElementById('batchSelectedCount').textContent = `${batchSelected.size} selected`;
}

async function applyBatchUpdate() {
  if (!batchSelected.size) { alert('Select at least one row'); return; }
  const newRole  = document.getElementById('batchUpdateRole').value;
  const newStart = document.getElementById('batchUpdateStart').value;
  const newEnd   = document.getElementById('batchUpdateEnd').value;
  if (!newRole && !newStart && !newEnd) { alert('Set at least one field to update'); return; }
  const update = {};
  if (newRole)  update.role       = newRole;
  if (newStart) update.start_time = newStart;
  if (newEnd)   update.end_time   = newEnd;
  if (newStart || newEnd) update.break_minutes = isHalfDayShift(newStart||'09:00', newEnd||'17:00') ? 0 : 60;
  let errors = 0;
  for (const id of batchSelected) {
    const { error } = await supabaseClient.from('employee_schedules').update(update).eq('id', id);
    if (error) errors++;
  }
  if (errors) showGlobalStatus(`‚ö†Ô∏è ${errors} update(s) failed`, 'error');
  else showGlobalStatus(`‚úÖ Updated ${batchSelected.size} schedule(s)!`, 'success');
  batchSelected.clear();
  document.getElementById('batchSelectedCount').textContent = '0 selected';
  loadSchedules();
}

async function deleteBatchSelected() {
  if (!batchSelected.size) { alert('Select at least one row to delete'); return; }
  if (!confirm(`Delete ${batchSelected.size} selected schedule(s)? This cannot be undone.`)) return;
  let errors = 0;
  for (const id of batchSelected) {
    const { error } = await supabaseClient.from('employee_schedules').delete().eq('id', id);
    if (error) errors++;
  }
  if (errors) showGlobalStatus(`‚ö†Ô∏è ${errors} delete(s) failed`, 'error');
  else showGlobalStatus(`üóë Deleted ${batchSelected.size} schedule(s)`, 'success');
  batchSelected.clear();
  document.getElementById('batchSelectedCount').textContent = '0 selected';
  loadSchedules();
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  BATCH ENTRY ‚Äî Load existing + inline edit + auto-save
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let _batchExistingLogs = []; // { id, taskName, role, start, end }

async function batchDateOrEmpChanged() {
  const date = document.getElementById('batchDate').value;
  const emp  = document.getElementById('batchEmployee').value;
  if (!date || !emp) { document.getElementById('batchExistingSection').style.display = 'none'; return; }
  await loadBatchExisting(date, emp);
}

async function loadBatchExisting(date, emp) {
  const section = document.getElementById('batchExistingSection');
  const tbody   = document.getElementById('batchExistingBody');
  try {
    const empId = await getEmployeeIdByName(emp, false);
    if (!empId) { section.style.display = 'none'; return; }
    const { data: logs, error } = await supabaseClient.from('task_time_logs')
      .select('*').eq('employee_id', empId).eq('date', date).order('start_time', { ascending: true });
    if (error) throw error;
    if (!logs || !logs.length) { section.style.display = 'none'; return; }
    const taskMap = await getTaskMap();
    _batchExistingLogs = logs.map(l => ({ ...l, _task: taskMap[l.task_id] || '' }));
    document.getElementById('batchExistingCount').textContent = `${logs.length} task(s)`;
    section.style.display = 'block';
    renderBatchExistingRows();
  } catch(e) { section.style.display = 'none'; }
}

function renderBatchExistingRows() {
  const tbody = document.getElementById('batchExistingBody');
  const roles = ['Kitchen Prep','Line Cook','Fryer','Dishwasher','Server'];
  tbody.innerHTML = _batchExistingLogs.map(l => {
    const startVal = l.start_time ? new Date(l.start_time).toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'}) : '';
    const endVal   = l.end_time   ? new Date(l.end_time).toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit',timeZone:'America/Chicago'}) : '';
    const dur = (l.start_time && l.end_time) ? formatTime((new Date(l.end_time)-new Date(l.start_time))/60000) : '‚Äî';
    const roleOpts = roles.map(r => `<option${r===l.role?' selected':''}>${r}</option>`).join('');
    return `<tr id="batchRow_${l.id}" style="transition:background 0.3s;">
      <td><input type="text" id="batchTask_${l.id}" value="${l._task.replace(/"/g,'&quot;')}" onblur="autoSaveBatchRow('${l.id}')" style="width:100%;padding:6px 8px;border:1.5px solid #e2e8f0;border-radius:6px;font-size:13px;"></td>
      <td><select id="batchRole_${l.id}" onchange="autoSaveBatchRow('${l.id}')" style="width:100%;padding:6px 8px;border:1.5px solid #e2e8f0;border-radius:6px;font-size:13px;">${roleOpts}</select></td>
      <td><input type="time" id="batchStart_${l.id}" value="${startVal}" onblur="autoSaveBatchRow('${l.id}')" style="width:100%;padding:6px 8px;border:1.5px solid #e2e8f0;border-radius:6px;font-size:13px;"></td>
      <td><input type="time" id="batchEnd_${l.id}"   value="${endVal}"   onblur="autoSaveBatchRow('${l.id}')" style="width:100%;padding:6px 8px;border:1.5px solid #e2e8f0;border-radius:6px;font-size:13px;"></td>
      <td id="batchDur_${l.id}" style="font-size:13px;font-weight:600;color:#4a5568;">${dur}</td>
      <td id="batchSt_${l.id}"><span class="badge badge-success">Saved</span></td>
      <td><button class="danger" onclick="deleteBatchExistingRow('${l.id}')" style="padding:4px 8px;font-size:12px;">&#128465;</button></td>
    </tr>`;
  }).join('');
}

async function autoSaveBatchRow(logId) {
  const taskName = document.getElementById(`batchTask_${logId}`)?.value?.trim();
  const role     = document.getElementById(`batchRole_${logId}`)?.value;
  const startVal = document.getElementById(`batchStart_${logId}`)?.value;
  const endVal   = document.getElementById(`batchEnd_${logId}`)?.value;
  if (!taskName || !startVal) return;

  const stEl  = document.getElementById(`batchSt_${logId}`);
  const durEl = document.getElementById(`batchDur_${logId}`);
  const row   = document.getElementById(`batchRow_${logId}`);
  if (stEl) stEl.innerHTML = '<span style="color:#718096;font-size:12px;">üíæ saving‚Ä¶</span>';
  if (row)  row.style.background = '#fffbeb';

  try {
    const log = _batchExistingLogs.find(l => l.id === logId);
    if (!log) return;
    const date = document.getElementById('batchDate').value;
    const taskId = await getTaskIdByName(taskName, true);
    const update = { task_id: taskId, role };
    if (startVal) update.start_time = toCSTISOString(date, startVal);
    if (endVal)   update.end_time   = toCSTISOString(date, endVal);
    else          update.end_time   = null;
    const { error } = await supabaseClient.from('task_time_logs').update(update).eq('id', logId);
    if (error) throw error;
    // Update local cache
    log._task = taskName; log.role = role;
    if (startVal) log.start_time = update.start_time;
    if (endVal)   log.end_time   = update.end_time;
    const dur = (update.start_time && update.end_time) ? formatTime((new Date(update.end_time)-new Date(update.start_time))/60000) : '‚Äî';
    if (durEl) durEl.textContent = dur;
    if (stEl)  stEl.innerHTML = '<span class="badge badge-success">&#10003; Saved</span>';
    if (row) { row.style.background = '#f0fdf4'; setTimeout(()=>{ if(row) row.style.background=''; }, 1200); }
  } catch(e) {
    if (stEl) stEl.innerHTML = `<span class="badge badge-danger">&#10005; Error</span>`;
    if (row)  row.style.background = '#fff1f2';
  }
}

async function deleteBatchExistingRow(logId) {
  if (!confirm('Delete this task?')) return;
  const { error } = await supabaseClient.from('task_time_logs').delete().eq('id', logId);
  if (!error) {
    _batchExistingLogs = _batchExistingLogs.filter(l => l.id !== logId);
    document.getElementById(`batchRow_${logId}`)?.remove();
    document.getElementById('batchExistingCount').textContent = `${_batchExistingLogs.length} task(s)`;
    if (!_batchExistingLogs.length) document.getElementById('batchExistingSection').style.display = 'none';
  }
}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
//  EMPLOYEE COMPARISON
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
let compChart = null;
let compTaskChart = null;
let _compEmpStats = {};
let _compTaskData = [];
let _activeCompChart = 'bar';

function changeCompPeriod() {
  const p = document.getElementById('compPeriod').value;
  document.getElementById('compDailyGroup').style.display   = p === 'daily'   ? 'block' : 'none';
  document.getElementById('compWeeklyGroup').style.display  = p === 'weekly'  ? 'block' : 'none';
  document.getElementById('compMonthlyGroup').style.display = p === 'monthly' ? 'block' : 'none';
  document.getElementById('compCustomStart').style.display  = p === 'custom'  ? 'block' : 'none';
  document.getElementById('compCustomEnd').style.display    = p === 'custom'  ? 'block' : 'none';
}

function switchCompChart(type) {
  _activeCompChart = type;
  document.querySelectorAll('.chart-tab-btn').forEach(b => b.classList.remove('active'));
  event.target.classList.add('active');
  const isTask = type === 'tasks';
  document.getElementById('compChartContainer').style.display = isTask ? 'none' : 'block';
  document.getElementById('compTaskChartContainer').style.display = isTask ? 'block' : 'none';
  if (Object.keys(_compEmpStats).length) renderCompChart(type);
}

async function loadComparison() {
  const period = document.getElementById('compPeriod').value;
  let startDate, endDate;
  if (period === 'daily') {
    startDate = endDate = document.getElementById('compDate').value;
  } else if (period === 'weekly') {
    startDate = document.getElementById('compWeek').value;
    const we = new Date(startDate); we.setDate(we.getDate() + 6);
    endDate = we.toISOString().split('T')[0];
  } else if (period === 'monthly') {
    const month = document.getElementById('compMonth').value;
    if (!month) { showGlobalStatus('‚ö†Ô∏è Select a month', 'error'); return; }
    startDate = `${month}-01`;
    const ld = new Date(+month.split('-')[0], +month.split('-')[1], 0).getDate();
    endDate = `${month}-${String(ld).padStart(2,'0')}`;
  } else {
    startDate = document.getElementById('compStart').value;
    endDate   = document.getElementById('compEnd').value;
  }
  if (!startDate) { showGlobalStatus('‚ö†Ô∏è Select a period', 'error'); return; }

  document.getElementById('compTableBody').innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;">Loading...</td></tr>';

  try {
    const [{ data: schedules }, { data: logs }, empMap, taskMap] = await Promise.all([
      supabaseClient.from('employee_schedules').select('*').gte('schedule_date', startDate).lte('schedule_date', endDate),
      supabaseClient.from('task_time_logs').select('*').gte('date', startDate).lte('date', endDate),
      getEmployeeMap(), getTaskMap()
    ]);

    const empStats = {};
    // Schedule data
    (schedules || []).forEach(s => {
      const dur = calculateHours(s.start_time, s.end_time);
      const bk = isHalfDayShift(s.start_time, s.end_time) ? 0 : (s.break_minutes || 60);
      if (!empStats[s.employee_name]) empStats[s.employee_name] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
      empStats[s.employee_name].scheduled += dur;
      empStats[s.employee_name].break += bk;
    });

    // Build schedule lookup for half-day detection
    const schedMap = {};
    (schedules || []).forEach(s => { schedMap[`${s.employee_name}|${s.schedule_date}`] = s; });

    // Task data
    const enriched = (logs || []).map(l => ({
      ...l, _emp: empMap[l.employee_id] || 'Unknown', _task: taskMap[l.task_id] || 'Unknown'
    })).filter(l => l.start_time && l.end_time);

    // Build task analytics
    const taskAgg = {}; // key: `${emp}|${task}`
    enriched.forEach(l => {
      const dur = (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60);
      if (dur <= 0) return;
      if (!empStats[l._emp]) empStats[l._emp] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
      empStats[l._emp].worked += dur;
      empStats[l._emp].tasks++;
      const key = `${l._emp}||${l._task}`;
      if (!taskAgg[key]) taskAgg[key] = { emp: l._emp, task: l._task, count: 0, total: 0, min: Infinity, max: 0 };
      taskAgg[key].count++;
      taskAgg[key].total += dur;
      taskAgg[key].min = Math.min(taskAgg[key].min, dur);
      taskAgg[key].max = Math.max(taskAgg[key].max, dur);
    });

    // Calculate untask per employee group
    const groups = new Map();
    enriched.forEach(l => {
      const key = `${l.date}|${l._emp}`;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(l);
    });
    for (const [key, group] of groups) {
      const [dateStr, empName] = key.split('|');
      group.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      const sched = schedMap[`${empName}|${dateStr}`];
      const halfDay = sched ? isHalfDayShift(sched.start_time, sched.end_time) : false;
      for (let i = 1; i < group.length; i++) {
        const gapMin = (new Date(group[i].start_time) - new Date(group[i-1].end_time)) / (1000 * 60);
        if (gapMin < 1) continue;
        const { untaskMin } = calcGapBreakdown(group[i-1].end_time, group[i].start_time, dateStr, halfDay);
        if (!empStats[empName]) empStats[empName] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
        empStats[empName].untask += untaskMin;
      }
    }

    _compEmpStats = empStats;
    _compTaskData = Object.values(taskAgg);

    // Render table
    const names = Object.keys(empStats).sort();
    const ranked = [...names].sort((a, b) => {
      const pa = calcProd(empStats[a]);
      const pb = calcProd(empStats[b]);
      return (pb || 0) - (pa || 0);
    });

    let html = '';
    names.forEach(name => {
      const s = empStats[name];
      const prod = calcProd(s);
      const cls = prodColorClass(prod);
      const rank = ranked.indexOf(name) + 1;
      const rankEmoji = rank === 1 ? 'ü•á' : rank === 2 ? 'ü•à' : rank === 3 ? 'ü•â' : `#${rank}`;
      const avgTaskMin = s.tasks > 0 ? Math.round(s.worked / s.tasks) : 0;
      html += `<tr>
        <td><strong>${name}</strong></td>
        <td>${formatTime(s.scheduled || 0)}</td>
        <td>${formatTime(s.worked || 0)}</td>
        <td><span class="badge badge-warning">${formatTime(s.untask || 0)}</span></td>
        <td>${formatTime(s.break || 0)}</td>
        <td>${s.tasks || 0}</td>
        <td>${avgTaskMin > 0 ? formatTime(avgTaskMin) : '‚Äî'}</td>
        <td><span class="${cls}">${prodLabel(prod)}</span></td>
        <td style="font-size:18px;text-align:center;">${rankEmoji}</td>
      </tr>`;
    });
    document.getElementById('compTableBody').innerHTML = html || '<tr><td colspan="9" style="text-align:center;padding:24px;color:#718096;">No data</td></tr>';
    renderCompChart(_activeCompChart);
    renderTaskAnalytics();
  } catch (e) {
    console.error(e);
    document.getElementById('compTableBody').innerHTML = `<tr><td colspan="9" style="text-align:center;padding:24px;color:#e53e3e;">Error: ${e.message}</td></tr>`;
  }
}

function calcProd(s) {
  // Iron rule: Productivity = Worked / (Scheduled - Break) = Worked / (Worked + Untask)
  const effective = Math.max(0, (s.scheduled || 0) - (s.break || 0));
  return effective > 0 ? Math.round((s.worked || 0) / effective * 100) : null;
}

function renderCompChart(type) {
  const labels = Object.keys(_compEmpStats).sort();
  if (!labels.length) return;
  const s = _compEmpStats;
  
  if (compChart) compChart.destroy();
  const ctx = document.getElementById('compChart').getContext('2d');
  
  if (type === 'bar') {
    compChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels,
        datasets: [
          { label: 'Scheduled (h)', data: labels.map(k => +(s[k].scheduled/60).toFixed(2)), backgroundColor: 'rgba(44,82,130,0.75)', borderColor: '#2c5282', borderWidth: 2 },
          { label: 'Worked (h)',    data: labels.map(k => +(s[k].worked/60).toFixed(2)),    backgroundColor: 'rgba(34,197,94,0.75)',  borderColor: '#16a34a', borderWidth: 2 },
          { label: 'Untask (h)',   data: labels.map(k => +(s[k].untask/60).toFixed(2)),    backgroundColor: 'rgba(245,158,11,0.75)', borderColor: '#d97706', borderWidth: 2 },
        ]
      },
      options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { callback: v => v + 'h' } } }, plugins: { legend: { position: 'top' } } }
    });
  } else if (type === 'radar') {
    compChart = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Scheduled', 'Worked', 'Productivity %', 'Tasks', 'Avg Task (min)'],
        datasets: labels.map((k, i) => {
          const colors = ['rgba(44,82,130,0.4)', 'rgba(34,197,94,0.4)', 'rgba(239,68,68,0.4)', 'rgba(245,158,11,0.4)'];
          const borders = ['#2c5282','#16a34a','#dc2626','#d97706'];
          const emp = s[k];
          const prod = calcProd(emp) || 0;
          const avgMin = emp.tasks > 0 ? Math.round(emp.worked / emp.tasks) : 0;
          return {
            label: k,
            data: [
              +(emp.scheduled/60).toFixed(1),
              +(emp.worked/60).toFixed(1),
              prod,
              emp.tasks,
              Math.round(avgMin)
            ],
            backgroundColor: colors[i % colors.length],
            borderColor: borders[i % borders.length],
            borderWidth: 2, pointRadius: 4
          };
        })
      },
      options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
    });
  } else if (type === 'productivity') {
    const prods = labels.map(k => calcProd(s[k]) || 0);
    const bgColors = prods.map(p => {
      if (p < 50) return 'rgba(239,68,68,0.8)';
      if (p < 60) return 'rgba(249,115,22,0.8)';
      if (p < 70) return 'rgba(234,179,8,0.8)';
      if (p < 80) return 'rgba(250,204,21,0.8)';
      if (p < 90) return 'rgba(74,222,128,0.8)';
      return 'rgba(34,197,94,0.8)';
    });
    compChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels.map((k, i) => `${k}: ${prods[i]}%`),
        datasets: [{ data: prods, backgroundColor: bgColors, borderWidth: 2 }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right' },
          tooltip: { callbacks: { label: ctx => ` ${ctx.label}` } }
        }
      }
    });
  }
}

function renderTaskAnalytics() {
  const sortBy = document.getElementById('taskAnalyticsSortBy').value;
  const empFilter = document.getElementById('taskAnalyticsEmpFilter').value;
  let data = [..._compTaskData];
  if (empFilter) data = data.filter(r => r.emp === empFilter);
  if (!data.length) {
    document.getElementById('taskAnalyticsBody').innerHTML = '<tr><td colspan="8" style="text-align:center;padding:24px;color:#718096;">No task data ‚Äî load comparison first</td></tr>';
    // Also update task chart
    if (compTaskChart) compTaskChart.destroy();
    return;
  }
  if (sortBy === 'total') data.sort((a, b) => b.total - a.total);
  else if (sortBy === 'avg') data.sort((a, b) => (b.total/b.count) - (a.total/a.count));
  else data.sort((a, b) => b.count - a.count);

  let html = '';
  data.forEach((r, i) => {
    const avg = Math.round(r.total / r.count);
    html += `<tr class="task-analytics-row">
      <td>${i+1}</td>
      <td><strong>${r.task}</strong></td>
      <td>${r.emp}</td>
      <td><span class="badge badge-info">${r.count}x</span></td>
      <td><strong>${formatTime(r.total)}</strong></td>
      <td>${formatTime(avg)}</td>
      <td>${r.min === Infinity ? '‚Äî' : formatTime(r.min)}</td>
      <td>${formatTime(r.max)}</td>
    </tr>`;
  });
  document.getElementById('taskAnalyticsBody').innerHTML = html;

  // Task duration chart
  if (compTaskChart) compTaskChart.destroy();
  const top10 = data.slice(0, 10);
  const ctx2 = document.getElementById('compTaskChart').getContext('2d');
  compTaskChart = new Chart(ctx2, {
    type: 'horizontalBar' in Chart ? 'horizontalBar' : 'bar',
    data: {
      labels: top10.map(r => `${r.emp.split(' ')[0]}: ${r.task.substring(0,20)}`),
      datasets: [{
        label: 'Total Time (min)',
        data: top10.map(r => Math.round(r.total)),
        backgroundColor: 'rgba(44,82,130,0.75)',
        borderColor: '#2c5282',
        borderWidth: 2
      }, {
        label: 'Avg Duration (min)',
        data: top10.map(r => Math.round(r.total / r.count)),
        backgroundColor: 'rgba(34,197,94,0.75)',
        borderColor: '#16a34a',
        borderWidth: 2
      }]
    },
    options: {
      indexAxis: 'y',
      responsive: true, maintainAspectRatio: false,
      scales: { x: { beginAtZero: true, ticks: { callback: v => v + 'm' } } },
      plugins: { legend: { position: 'top' } }
    }
  });
}
</script></body>
</html>
