<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Workforce Management - Schedule vs Actual Tracker</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
}
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background-color: #f5f7fa;
  color: #2d3748;
  min-height: 100vh;
}
.container {
  max-width: 1600px;
  margin: 0 auto;
  background: white;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
  overflow: hidden;
}
header {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  color: white;
  padding: 24px 40px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}
header h1 {
  font-size: 28px;
  font-weight: 700;
  margin: 0;
}
.header-subtitle {
  font-size: 14px;
  opacity: 0.9;
  margin-top: 4px;
}
.tabs {
  display: flex;
  background: #f8fafc;
  border-bottom: 1px solid #e2e8f0;
  flex-wrap: wrap;
}
.tab-btn {
  flex: 1;
  min-width: 140px;
  padding: 16px 20px;
  border: none;
  background: none;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: #718096;
  transition: all 0.2s;
  position: relative;
}
.tab-btn:hover {
  color: #2c5282;
  background: #edf2f7;
}
.tab-btn.active {
  color: #2c5282;
  background: white;
}
.tab-btn.active::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: #2c5282;
}
.tab-content {
  display: none;
  padding: 40px;
}
.tab-content.active {
  display: block;
}
.form-group {
  margin-bottom: 24px;
}
label {
  display: block;
  margin-bottom: 8px;
  font-weight: 600;
  color: #4a5568;
  font-size: 14px;
}
select, button, input {
  width: 100%;
  padding: 12px 16px;
  border: 1px solid #cbd5e0;
  border-radius: 6px;
  font-size: 15px;
  font-family: inherit;
  transition: all 0.2s;
}
select:focus, button:focus, input:focus {
  outline: none;
  border-color: #3182ce;
  box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}
button {
  background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
  color: white;
  border: none;
  cursor: pointer;
  font-weight: 600;
  font-size: 15px;
  padding: 12px 24px;
  border-radius: 6px;
  transition: all 0.2s;
  width: auto;
}
button:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 6px rgba(44, 82, 130, 0.2);
}
button:disabled {
  background: #a0aec0;
  cursor: not-allowed;
  transform: none;
  box-shadow: none;
}
button.secondary {
  background: #e2e8f0;
  color: #4a5568;
}
button.secondary:hover {
  background: #cbd5e0;
}
button.success {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}
button.success:hover {
  box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
}
button.danger {
  background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}
button.danger:hover {
  box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
}
button.warning {
  background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}
button.warning:hover {
  box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);
}
#status {
  padding: 12px 16px;
  border-radius: 6px;
  margin-top: 20px;
  text-align: center;
  font-weight: 500;
  font-size: 14px;
}
.success {
  background: #d1fae5;
  color: #065f46;
  border: 1px solid #6ee7b7;
}
.error {
  background: #fee2e2;
  color: #991b1b;
  border: 1px solid #fca5a5;
}
.info {
  background: #dbeafe;
  color: #1e40af;
  border: 1px solid #93c5fd;
}
.chart-container {
  margin-top: 30px;
  padding: 24px;
  background: #f8fafc;
  border-radius: 8px;
  border: 1px solid #e2e8f0;
  height: 350px;
}
.stats-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
  gap: 20px;
  margin-top: 24px;
}
.stat-card {
  background: white;
  padding: 20px;
  border-radius: 8px;
  text-align: center;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
  transition: all 0.2s;
}
.stat-card:hover {
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  transform: translateY(-2px);
}
.stat-card h3 {
  font-size: 12px;
  color: #718096;
  margin-bottom: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.stat-card .value {
  font-size: 32px;
  font-weight: 700;
  color: #2c5282;
  line-height: 1;
  margin-bottom: 4px;
}
.stat-card .subtext {
  font-size: 12px;
  color: #718096;
}
.stat-card.positive .value {
  color: #22c55e;
}
.stat-card.negative .value {
  color: #ef4444;
}
.section-title {
  font-size: 20px;
  font-weight: 700;
  color: #2d3748;
  margin-bottom: 8px;
}
.section-subtitle {
  font-size: 14px;
  color: #718096;
  margin-bottom: 24px;
}
.card {
  background: white;
  border-radius: 8px;
  padding: 24px;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
  border: 1px solid #e2e8f0;
  margin-bottom: 24px;
}
.action-bar {
  display: flex;
  gap: 12px;
  margin-top: 20px;
  flex-wrap: wrap;
}
.period-selector {
  background: #f0f9ff;
  padding: 20px;
  border-radius: 8px;
  border: 1px solid #bee3f8;
  margin-bottom: 24px;
}
.period-selector h4 {
  font-size: 14px;
  color: #2c5282;
  margin-bottom: 12px;
  font-weight: 600;
}
.period-controls {
  display: flex;
  gap: 16px;
  align-items: end;
  flex-wrap: wrap;
}
.period-controls .form-group {
  flex: 1;
  min-width: 150px;
  margin-bottom: 0;
}
.current-period-display {
  margin-top: 12px;
  padding: 12px;
  background: #ebf8ff;
  border-radius: 6px;
  font-size: 14px;
  color: #2c5282;
  font-weight: 600;
}
.schedule-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}
.schedule-table th,
.schedule-table td {
  padding: 12px;
  text-align: left;
  border-bottom: 1px solid #e2e8f0;
}
.schedule-table th {
  background: #f8fafc;
  font-weight: 600;
  color: #4a5568;
}
.schedule-table tr:hover {
  background: #f8fafc;
}
.badge {
  display: inline-block;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 600;
}
.badge.success {
  background: #d1fae5;
  color: #065f46;
}
.badge.warning {
  background: #fef3c7;
  color: #92400e;
}
.badge.danger {
  background: #fee2e2;
  color: #991b1b;
}
.badge.info {
  background: #dbeafe;
  color: #1e40af;
}
.comparison-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
  margin-top: 24px;
}
.comparison-card {
  background: white;
  border-radius: 8px;
  padding: 20px;
  border: 1px solid #e2e8f0;
}
.comparison-card h4 {
  font-size: 15px;
  color: #2d3748;
  margin-bottom: 16px;
  font-weight: 600;
}
.metric-row {
  display: flex;
  justify-content: space-between;
  padding: 10px 0;
  border-bottom: 1px solid #f1f5f9;
}
.metric-row:last-child {
  border-bottom: none;
}
.metric-label {
  color: #718096;
  font-size: 14px;
}
.metric-value {
  font-weight: 600;
  color: #2d3748;
}
.gap-alert {
  background: #fff3cd;
  color: #856404;
  padding: 12px;
  border-radius: 6px;
  margin-top: 12px;
  font-size: 14px;
  border: 1px solid #ffc107;
}
.employee-row {
  background: #f8fafc;
  padding: 16px;
  border-radius: 8px;
  margin-bottom: 16px;
  border: 1px solid #e2e8f0;
}
.employee-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}
.employee-name {
  font-weight: 700;
  color: #2d3748;
  font-size: 16px;
}
.employee-role {
  color: #718096;
  font-size: 13px;
}
.time-entry {
  display: flex;
  gap: 12px;
  align-items: center;
  margin-bottom: 8px;
}
.time-entry input {
  flex: 1;
}
.hidden {
  display: none;
}
@media (max-width: 768px) {
  .tabs {
    flex-direction: column;
  }
  .tab-content {
    padding: 20px;
  }
  .stats-grid {
    grid-template-columns: 1fr;
  }
  .period-controls {
    flex-direction: column;
  }
  .period-controls .form-group {
    width: 100%;
  }
  .schedule-table {
    font-size: 12px;
  }
  .schedule-table th,
  .schedule-table td {
    padding: 8px;
  }
}
</style>
</head>
<body>
<div class="container">
  <header>
    <div>
      <h1>Kitchen Workforce Management</h1>
      <div class="header-subtitle">Schedule vs Actual Hours Tracking with Break & Gap Analysis</div>
    </div>
  </header>
  
  <div class="tabs">
    <button class="tab-btn active" onclick="switchTab('schedule')">üìÖ Manage Schedule</button>
    <button class="tab-btn" onclick="switchTab('tasks')">‚è± Task Logging</button>
    <button class="tab-btn" onclick="switchTab('batch')">üìù Batch Entry</button>
    <button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics Dashboard</button>
    <button class="tab-btn" onclick="switchTab('comparison')">üìà Schedule vs Actual</button>
    <button class="tab-btn" onclick="switchTab('gaps')">‚ö†Ô∏è Gap Analysis</button>
  </div>

  <!-- SCHEDULE MANAGEMENT TAB -->
  <div id="schedule" class="tab-content active">
    <h2 class="section-title">Manage Employee Schedule</h2>
    <p class="section-subtitle">Add and edit scheduled shifts for employees</p>
    
    <div class="card">
      <div class="form-group">
        <label for="scheduleDate">üìÖ Date</label>
        <input type="date" id="scheduleDate" required>
      </div>
      <div class="form-group">
        <label for="scheduleEmployee">üë§ Employee</label>
        <select id="scheduleEmployee" required>
          <option value="">-- Select Employee --</option>
          <option value="Julio Mejia">Julio Mejia</option>
          <option value="Leydi Diaz">Leydi Diaz</option>
          <option value="Procoro Tinoco">Procoro Tinoco</option>
          <option value="Wilson Sanchez">Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group">
        <label for="scheduleRole">üè∑ Role/Position</label>
        <select id="scheduleRole" required>
          <option value="Kitchen Prep">Kitchen Prep</option>
          <option value="Line Cook">Line Cook</option>
          <option value="Fryer">Fryer</option>
          <option value="Dishwasher">Dishwasher</option>
          <option value="Server">Server</option>
        </select>
      </div>
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
        <div class="form-group">
          <label for="scheduleStart">‚è∞ Scheduled Start Time</label>
          <input type="time" id="scheduleStart" required>
        </div>
        <div class="form-group">
          <label for="scheduleEnd">‚è∞ Scheduled End Time</label>
          <input type="time" id="scheduleEnd" required>
        </div>
      </div>
      <div class="action-bar">
        <button onclick="addSchedule()" class="success">üíæ Add Schedule</button>
        <button onclick="loadSchedules()" class="secondary">üîÑ Refresh</button>
      </div>
      <div id="scheduleStatus" class="hidden" style="margin-top: 16px;"></div>
    </div>

    <div class="card">
      <h3 style="margin-bottom: 16px; font-size: 16px; color: #2d3748;">üìã Scheduled Shifts</h3>
      <div id="scheduleList">
        <p style="color: #718096; text-align: center; padding: 24px;">Loading schedules...</p>
      </div>
    </div>
  </div>

  <!-- TASK LOGGING TAB -->
  <div id="tasks" class="tab-content">
    <h2 class="section-title">Real-Time Task Logging</h2>
    <p class="section-subtitle">Track actual work hours with automatic break deduction</p>
    
    <div class="card">
      <div class="form-group">
        <label for="taskEmployee">üë§ Employee</label>
        <select id="taskEmployee" required>
          <option value="">-- Select Employee --</option>
          <option value="Julio Mejia">Julio Mejia</option>
          <option value="Leydi Diaz">Leydi Diaz</option>
          <option value="Procoro Tinoco">Procoro Tinoco</option>
          <option value="Wilson Sanchez">Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskRole">üè∑ Role</label>
        <select id="taskRole" required>
          <option value="Kitchen Prep">Kitchen Prep</option>
          <option value="Line Cook">Line Cook</option>
          <option value="Fryer">Fryer</option>
          <option value="Dishwasher">Dishwasher</option>
        </select>
      </div>
      <div class="form-group">
        <label for="taskName">üìù Task Name</label>
        <input type="text" id="taskName" placeholder="Type task name..." required>
      </div>
      <div class="action-bar">
        <button onclick="startTask()" id="startBtn">‚ñ∂ Start Task</button>
        <button onclick="stopTask()" id="stopBtn" disabled class="danger">‚èπ Stop Task</button>
      </div>
      <div id="taskStatus" class="hidden" style="margin-top: 16px;"></div>
      <div id="activeTaskInfo" class="hidden" style="margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bee3f8;">
        <h4 style="color: #2c5282; margin-bottom: 8px;">Active Task</h4>
        <p id="activeTaskDisplay" style="font-weight: 600; margin-bottom: 8px;"></p>
        <p id="taskTimer" style="font-size: 14px; color: #4a5568;"></p>
      </div>
    </div>
  </div>

  <!-- BATCH ENTRY TAB -->
  <div id="batch" class="tab-content">
    <h2 class="section-title">Batch Task Entry</h2>
    <p class="section-subtitle">Add multiple tasks at once for a specific date</p>
    
    <div class="card">
      <div class="form-group">
        <label for="batchDate">üìÖ Date</label>
        <input type="date" id="batchDate" required>
      </div>
      <div class="form-group">
        <label for="batchEmployee">üë§ Employee</label>
        <select id="batchEmployee" required>
          <option value="">-- Select Employee --</option>
          <option value="Julio Mejia">Julio Mejia</option>
          <option value="Leydi Diaz">Leydi Diaz</option>
          <option value="Procoro Tinoco">Procoro Tinoco</option>
          <option value="Wilson Sanchez">Wilson Sanchez</option>
        </select>
      </div>
      <div class="action-bar" style="margin-bottom: 20px;">
        <button onclick="addBatchRow()" class="success">‚ûï Add Task Row</button>
        <button onclick="clearBatchRows()" class="secondary">üóë Clear All</button>
      </div>
      <div id="batchRows">
        <!-- Batch rows will be added here -->
      </div>
      <div class="action-bar" style="margin-top: 20px;">
        <button onclick="saveBatchTasks()" class="success" style="flex: 1;">üíæ Save All Tasks</button>
      </div>
      <div id="batchStatus" class="hidden" style="margin-top: 16px;"></div>
    </div>
  </div>

  <!-- ANALYTICS DASHBOARD TAB -->
  <div id="analytics" class="tab-content">
    <h2 class="section-title">Analytics Dashboard</h2>
    <p class="section-subtitle">Comprehensive performance metrics and time analysis</p>
    
    <div class="period-selector">
      <h4>üìÖ Select Time Period</h4>
      <div class="period-controls">
        <div class="form-group">
          <label for="analyticsPeriod">Period</label>
          <select id="analyticsPeriod" onchange="changeAnalyticsPeriod()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="form-group" id="dailyDateGroup">
          <label for="analyticsDate">Date</label>
          <input type="date" id="analyticsDate">
        </div>
        <div class="form-group" id="weeklyDateGroup" style="display: none;">
          <label for="analyticsWeek">Week Starting</label>
          <input type="date" id="analyticsWeek">
        </div>
        <div class="form-group" id="monthlyDateGroup" style="display: none;">
          <label for="analyticsMonth">Month</label>
          <input type="month" id="analyticsMonth">
        </div>
        <div class="form-group" id="customDateGroup" style="display: none;">
          <label for="analyticsStart">Start Date</label>
          <input type="date" id="analyticsStart">
        </div>
        <div class="form-group" id="customEndGroup" style="display: none;">
          <label for="analyticsEnd">End Date</label>
          <input type="date" id="analyticsEnd">
        </div>
        <button onclick="loadAnalytics()" style="width: auto; margin-bottom: 0;">üìä Load Analytics</button>
      </div>
      <div id="currentPeriodDisplay" class="current-period-display">Loading...</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <h3>Total Scheduled Hours</h3>
        <div class="value" id="totalScheduled">-</div>
        <div class="subtext">Across all employees</div>
      </div>
      <div class="stat-card">
        <h3>Total Worked Hours</h3>
        <div class="value" id="totalWorked">-</div>
        <div class="subtext">Actual time logged</div>
      </div>
      <div class="stat-card">
        <h3>Total Break Time</h3>
        <div class="value" id="totalBreak">-</div>
        <div class="subtext">1 hour per employee</div>
      </div>
      <div class="stat-card">
        <h3>Variance</h3>
        <div class="value" id="totalVariance">-</div>
        <div class="subtext">Scheduled vs Worked</div>
      </div>
      <div class="stat-card">
        <h3>Total Gap Time</h3>
        <div class="value" id="totalGap">-</div>
        <div class="subtext">Between tasks</div>
      </div>
      <div class="stat-card">
        <h3>Efficiency Rate</h3>
        <div class="value" id="efficiencyRate">-</div>
        <div class="subtext">Productivity %</div>
      </div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <h3 style="margin-bottom: 16px;">üìä Hours Distribution</h3>
      <div class="chart-container">
        <canvas id="hoursChart"></canvas>
      </div>
    </div>

    <div class="card" style="margin-top: 24px;">
      <h3 style="margin-bottom: 16px;">üë• Employee Breakdown</h3>
      <div id="employeeBreakdown">
        <p style="color: #718096; text-align: center; padding: 24px;">Loading...</p>
      </div>
    </div>
  </div>

  <!-- SCHEDULE VS ACTUAL COMPARISON TAB -->
  <div id="comparison" class="tab-content">
    <h2 class="section-title">Schedule vs Actual Comparison</h2>
    <p class="section-subtitle">Detailed comparison of scheduled hours vs actual worked hours</p>
    
    <div class="period-selector">
      <h4>üìÖ Select Period</h4>
      <div class="period-controls">
        <div class="form-group">
          <label for="comparePeriod">Period</label>
          <select id="comparePeriod" onchange="changeComparePeriod()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="form-group" id="compareDailyGroup">
          <label for="compareDate">Date</label>
          <input type="date" id="compareDate">
        </div>
        <div class="form-group" id="compareWeeklyGroup" style="display: none;">
          <label for="compareWeek">Week Starting</label>
          <input type="date" id="compareWeek">
        </div>
        <div class="form-group" id="compareMonthlyGroup" style="display: none;">
          <label for="compareMonth">Month</label>
          <input type="month" id="compareMonth">
        </div>
        <div class="form-group" id="compareCustomGroup" style="display: none;">
          <label for="compareStart">Start Date</label>
          <input type="date" id="compareStart">
        </div>
        <div class="form-group" id="compareCustomEndGroup" style="display: none;">
          <label for="compareEnd">End Date</label>
          <input type="date" id="compareEnd">
        </div>
        <button onclick="loadComparison()" style="width: auto; margin-bottom: 0;">üìä Load Comparison</button>
      </div>
    </div>

    <div id="comparisonData">
      <div class="comparison-grid" id="comparisonGrid">
        <!-- Comparison cards will be loaded here -->
      </div>
    </div>
  </div>

  <!-- GAP ANALYSIS TAB -->
  <div id="gaps" class="tab-content">
    <h2 class="section-title">Gap Time Analysis</h2>
    <p class="section-subtitle">Track time gaps between tasks to identify inefficiencies</p>
    
    <div class="period-selector">
      <h4>üìÖ Select Period</h4>
      <div class="period-controls">
        <div class="form-group">
          <label for="gapPeriod">Period</label>
          <select id="gapPeriod" onchange="changeGapPeriod()">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
            <option value="custom">Custom Range</option>
          </select>
        </div>
        <div class="form-group" id="gapDailyGroup">
          <label for="gapDate">Date</label>
          <input type="date" id="gapDate">
        </div>
        <div class="form-group" id="gapWeeklyGroup" style="display: none;">
          <label for="gapWeek">Week Starting</label>
          <input type="date" id="gapWeek">
        </div>
        <div class="form-group" id="gapMonthlyGroup" style="display: none;">
          <label for="gapMonth">Month</label>
          <input type="month" id="gapMonth">
        </div>
        <div class="form-group" id="gapCustomGroup" style="display: none;">
          <label for="gapStart">Start Date</label>
          <input type="date" id="gapStart">
        </div>
        <div class="form-group" id="gapCustomEndGroup" style="display: none;">
          <label for="gapEnd">End Date</label>
          <input type="date" id="gapEnd">
        </div>
        <button onclick="loadGapAnalysis()" style="width: auto; margin-bottom: 0;">üîç Analyze Gaps</button>
      </div>
    </div>

    <div id="gapData">
      <div class="card">
        <h3 style="margin-bottom: 16px;">‚ö†Ô∏è Identified Gaps</h3>
        <div id="gapList">
          <p style="color: #718096; text-align: center; padding: 24px;">No gaps found or select a period to analyze</p>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
// ========== SUPABASE SETUP ==========
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const { createClient } = window.supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let activeTaskId = null;
let activeTaskInterval = null;
let activeTaskStartTime = null;
let batchRowCount = 0;

// Initialize
window.onload = function() {
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('scheduleDate').value = today;
  document.getElementById('analyticsDate').value = today;
  document.getElementById('compareDate').value = today;
  document.getElementById('gapDate').value = today;
  document.getElementById('batchDate').value = today;
  document.getElementById('analyticsWeek').value = getWeekStart(new Date()).toISOString().split('T')[0];
  document.getElementById('compareWeek').value = getWeekStart(new Date()).toISOString().split('T')[0];
  document.getElementById('gapWeek').value = getWeekStart(new Date()).toISOString().split('T')[0];
  
  loadSchedules();
  loadAnalytics();
};

// ========== UTILITY FUNCTIONS ==========
function switchTab(tabName) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');
  event.target.classList.add('active');
  
  if (tabName === 'analytics') loadAnalytics();
  else if (tabName === 'comparison') loadComparison();
  else if (tabName === 'gaps') loadGapAnalysis();
}

function getWeekStart(date) {
  const d = new Date(date);
  const day = d.getDay();
  const diff = d.getDate() - day + (day === 0 ? -6 : 1);
  return new Date(d.setDate(diff));
}

function getMonthStart(date) {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

function formatDate(dateStr) {
  const date = new Date(dateStr);
  return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}

function formatTime(minutes) {
  const h = Math.floor(minutes / 60);
  const m = Math.round(minutes % 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}

function calculateHours(start, end) {
  const s = new Date(`2000-01-01T${start}`);
  const e = new Date(`2000-01-01T${end}`);
  return (e - s) / (1000 * 60); // minutes
}

// ========== SCHEDULE MANAGEMENT ==========
async function addSchedule() {
  const date = document.getElementById('scheduleDate').value;
  const employee = document.getElementById('scheduleEmployee').value;
  const role = document.getElementById('scheduleRole').value;
  const startTime = document.getElementById('scheduleStart').value;
  const endTime = document.getElementById('scheduleEnd').value;
  
  if (!date || !employee || !startTime || !endTime) {
    showScheduleStatus('Please fill all fields!', 'error');
    return;
  }
  
  if (startTime >= endTime) {
    showScheduleStatus('End time must be after start time!', 'error');
    return;
  }
  
  try {
    // Check if employee exists
    const { data: emp, error: empError } = await supabaseClient
      .from('kitchen_prep_employees')
      .select('id')
      .eq('name', employee)
      .single();
    
    if (empError || !emp) {
      // Create new employee
      const { data: newEmp } = await supabaseClient
        .from('kitchen_prep_employees')
        .insert({ name: employee })
        .select()
        .single();
    }
    
    // Add schedule
    const { error } = await supabaseClient
      .from('employee_schedules')
      .insert({
        employee_name: employee,
        role: role,
        schedule_date: date,
        start_time: startTime,
        end_time: endTime,
        break_minutes: 60
      });
    
    if (error) throw error;
    
    showScheduleStatus('Schedule added successfully!', 'success');
    loadSchedules();
  } catch (error) {
    console.error('Error adding schedule:', error);
    showScheduleStatus('Error adding schedule', 'error');
  }
}

async function loadSchedules() {
  try {
    const { data: schedules, error } = await supabaseClient
      .from('employee_schedules')
      .select('*')
      .order('schedule_date', { ascending: false })
      .limit(50);
    
    if (error) throw error;
    
    const container = document.getElementById('scheduleList');
    if (!schedules || schedules.length === 0) {
      container.innerHTML = '<p style="color: #718096; text-align: center; padding: 24px;">No schedules found</p>';
      return;
    }
    
    let html = '<table class="schedule-table"><thead><tr><th>Date</th><th>Employee</th><th>Role</th><th>Scheduled</th><th>Duration</th><th>Break</th><th>Actions</th></tr></thead><tbody>';
    
    schedules.forEach(schedule => {
      const duration = calculateHours(schedule.start_time, schedule.end_time);
      html += `
        <tr>
          <td>${formatDate(schedule.schedule_date)}</td>
          <td><strong>${schedule.employee_name}</strong></td>
          <td><span class="badge info">${schedule.role}</span></td>
          <td>${schedule.start_time} - ${schedule.end_time}</td>
          <td>${formatTime(duration)}</td>
          <td>${schedule.break_minutes} min</td>
          <td><button class="danger" onclick="deleteSchedule('${schedule.id}')" style="padding: 6px 12px; font-size: 13px;">Delete</button></td>
        </tr>
      `;
    });
    
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    console.error('Error loading schedules:', error);
    document.getElementById('scheduleList').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 24px;">Error loading schedules</p>';
  }
}

async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;
  
  try {
    const { error } = await supabaseClient
      .from('employee_schedules')
      .delete()
      .eq('id', id);
    
    if (error) throw error;
    
    showScheduleStatus('Schedule deleted', 'success');
    loadSchedules();
  } catch (error) {
    console.error('Error deleting schedule:', error);
    showScheduleStatus('Error deleting schedule', 'error');
  }
}

function showScheduleStatus(message, type) {
  const div = document.getElementById('scheduleStatus');
  div.textContent = message;
  div.className = type;
  div.classList.remove('hidden');
  setTimeout(() => div.classList.add('hidden'), 3000);
}

// ========== TASK LOGGING ==========
async function startTask() {
  const employee = document.getElementById('taskEmployee').value;
  const role = document.getElementById('taskRole').value;
  const taskName = document.getElementById('taskName').value;
  
  if (!employee || !taskName) {
    showTaskStatus('Please select employee and enter task name', 'error');
    return;
  }
  
  try {
    const now = new Date();
    
    // Get or create employee
    const { data: emp } = await supabaseClient
      .from('kitchen_prep_employees')
      .select('id')
      .eq('name', employee)
      .single();
    
    // Get or create task
    const { data: task } = await supabaseClient
      .from('kitchen_tasks')
      .select('id')
      .eq('name', taskName)
      .single();
    
    let taskId = task?.id;
    if (!taskId) {
      const { data: newTask } = await supabaseClient
        .from('kitchen_tasks')
        .insert({ name: taskName, description: taskName })
        .select()
        .single();
      taskId = newTask.id;
    }
    
    // Create time log
    const { data: log } = await supabaseClient
      .from('task_time_logs')
      .insert({
        employee_id: emp?.id,
        task_id: taskId,
        role: role,
        start_time: now.toISOString(),
        date: now.toISOString().split('T')[0]
      })
      .select()
      .single();
    
    activeTaskId = log.id;
    activeTaskStartTime = now;
    
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('activeTaskDisplay').textContent = `${employee} - ${taskName} (${role})`;
    document.getElementById('activeTaskInfo').classList.remove('hidden');
    
    activeTaskInterval = setInterval(() => {
      const elapsed = Math.floor((new Date() - activeTaskStartTime) / 1000);
      const h = Math.floor(elapsed / 3600);
      const m = Math.floor((elapsed % 3600) / 60);
      const s = elapsed % 60;
      document.getElementById('taskTimer').textContent = 
        `Elapsed: ${h.toString().padStart(2,'0')}:${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }, 1000);
    
    showTaskStatus('Task started!', 'success');
  } catch (error) {
    console.error('Error starting task:', error);
    showTaskStatus('Error starting task', 'error');
  }
}

async function stopTask() {
  if (!activeTaskId) return;
  
  try {
    const now = new Date();
    
    await supabaseClient
      .from('task_time_logs')
      .update({ end_time: now.toISOString() })
      .eq('id', activeTaskId);
    
    clearInterval(activeTaskInterval);
    activeTaskId = null;
    
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('activeTaskInfo').classList.add('hidden');
    document.getElementById('taskName').value = '';
    
    showTaskStatus('Task completed!', 'success');
  } catch (error) {
    console.error('Error stopping task:', error);
    showTaskStatus('Error stopping task', 'error');
  }
}

function showTaskStatus(message, type) {
  const div = document.getElementById('taskStatus');
  div.textContent = message;
  div.className = type;
  div.classList.remove('hidden');
  setTimeout(() => div.classList.add('hidden'), 3000);
}

// ========== BATCH ENTRY ==========
function addBatchRow() {
  batchRowCount++;
  const container = document.getElementById('batchRows');
  const row = document.createElement('div');
  row.id = `batchRow${batchRowCount}`;
  row.className = 'time-entry';
  row.innerHTML = `
    <input type="time" class="batchStart" placeholder="Start Time" required>
    <input type="time" class="batchEnd" placeholder="End Time" required>
    <input type="text" class="batchTask" placeholder="Task Name" required>
    <select class="batchRole">
      <option value="Kitchen Prep">Kitchen Prep</option>
      <option value="Line Cook">Line Cook</option>
      <option value="Fryer">Fryer</option>
      <option value="Dishwasher">Dishwasher</option>
    </select>
    <button onclick="removeBatchRow(${batchRowCount})" class="danger" style="padding: 8px;">‚úï</button>
  `;
  container.appendChild(row);
}

function removeBatchRow(id) {
  const row = document.getElementById(`batchRow${id}`);
  if (row) row.remove();
}

function clearBatchRows() {
  document.getElementById('batchRows').innerHTML = '';
  batchRowCount = 0;
}

async function saveBatchTasks() {
  const date = document.getElementById('batchDate').value;
  const employee = document.getElementById('batchEmployee').value;
  
  if (!date || !employee) {
    showBatchStatus('Please select date and employee', 'error');
    return;
  }
  
  const rows = document.querySelectorAll('#batchRows > div');
  if (rows.length === 0) {
    showBatchStatus('Please add at least one task', 'error');
    return;
  }
  
  try {
    const { data: emp } = await supabaseClient
      .from('kitchen_prep_employees')
      .select('id')
      .eq('name', employee)
      .single();
    
    for (const row of rows) {
      const startTime = row.querySelector('.batchStart').value;
      const endTime = row.querySelector('.batchEnd').value;
      const taskName = row.querySelector('.batchTask').value;
      const role = row.querySelector('.batchRole').value;
      
      if (!startTime || !endTime || !taskName) continue;
      
      const { data: task } = await supabaseClient
        .from('kitchen_tasks')
        .select('id')
        .eq('name', taskName)
        .single();
      
      let taskId = task?.id;
      if (!taskId) {
        const { data: newTask } = await supabaseClient
          .from('kitchen_tasks')
          .insert({ name: taskName, description: taskName })
          .select()
          .single();
        taskId = newTask.id;
      }
      
      const startDateTime = new Date(`${date}T${startTime}`);
      const endDateTime = new Date(`${date}T${endTime}`);
      
      await supabaseClient
        .from('task_time_logs')
        .insert({
          employee_id: emp?.id,
          task_id: taskId,
          role: role,
          start_time: startDateTime.toISOString(),
          end_time: endDateTime.toISOString(),
          date: date
        });
    }
    
    showBatchStatus(`Saved ${rows.length} tasks successfully!`, 'success');
    clearBatchRows();
  } catch (error) {
    console.error('Error saving batch tasks:', error);
    showBatchStatus('Error saving tasks', 'error');
  }
}

function showBatchStatus(message, type) {
  const div = document.getElementById('batchStatus');
  div.textContent = message;
  div.className = type;
  div.classList.remove('hidden');
  setTimeout(() => div.classList.add('hidden'), 3000);
}

// ========== ANALYTICS ==========
function changeAnalyticsPeriod() {
  const period = document.getElementById('analyticsPeriod').value;
  document.getElementById('dailyDateGroup').style.display = period === 'daily' ? 'block' : 'none';
  document.getElementById('weeklyDateGroup').style.display = period === 'weekly' ? 'block' : 'none';
  document.getElementById('monthlyDateGroup').style.display = period === 'monthly' ? 'block' : 'none';
  document.getElementById('customDateGroup').style.display = period === 'custom' ? 'block' : 'none';
  document.getElementById('customEndGroup').style.display = period === 'custom' ? 'block' : 'none';
  loadAnalytics();
}

async function loadAnalytics() {
  const period = document.getElementById('analyticsPeriod').value;
  let startDate, endDate, displayText;
  
  if (period === 'daily') {
    startDate = document.getElementById('analyticsDate').value;
    endDate = startDate;
    displayText = `Daily - ${formatDate(startDate)}`;
  } else if (period === 'weekly') {
    startDate = document.getElementById('analyticsWeek').value;
    const weekEnd = new Date(startDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    endDate = weekEnd.toISOString().split('T')[0];
    displayText = `Weekly - ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else if (period === 'monthly') {
    const month = document.getElementById('analyticsMonth').value;
    startDate = `${month}-01`;
    const lastDay = new Date(year, month, 0).getDate();
    endDate = `${month}-${lastDay.toString().padStart(2,'0')}`;
    displayText = `Monthly - ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else {
    startDate = document.getElementById('analyticsStart').value;
    endDate = document.getElementById('analyticsEnd').value;
    displayText = `${formatDate(startDate)} to ${formatDate(endDate)}`;
  }
  
  document.getElementById('currentPeriodDisplay').textContent = displayText;
  
  try {
    // Get schedules
    const { data: schedules } = await supabaseClient
      .from('employee_schedules')
      .select('*')
      .gte('schedule_date', startDate)
      .lte('schedule_date', endDate);
    
    // Get task logs
    const { data: logs } = await supabaseClient
      .from('task_time_logs')
      .select(`
        *,
        kitchen_prep_employees(name),
        kitchen_tasks(name)
      `)
      .gte('date', startDate)
      .lte('date', endDate);
    
    // Calculate metrics
    let totalScheduledMinutes = 0;
    let totalWorkedMinutes = 0;
    let totalBreakMinutes = 0;
    let totalGapMinutes = 0;
    const employeeStats = {};
    
    // Process schedules
    if (schedules) {
      schedules.forEach(schedule => {
        const duration = calculateHours(schedule.start_time, schedule.end_time);
        totalScheduledMinutes += duration;
        totalBreakMinutes += schedule.break_minutes || 60;
        
        if (!employeeStats[schedule.employee_name]) {
          employeeStats[schedule.employee_name] = {
            scheduled: 0,
            worked: 0,
            break: 0,
            tasks: 0
          };
        }
        employeeStats[schedule.employee_name].scheduled += duration;
        employeeStats[schedule.employee_name].break += schedule.break_minutes || 60;
      });
    }
    
    // Process logs
    if (logs) {
      logs.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      let lastEndTime = null;
      
      logs.forEach(log => {
        if (!log.end_time) return;
        
        const worked = (new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60);
        totalWorkedMinutes += worked;
        
        if (employeeStats[log.kitchen_prep_employees?.name]) {
          employeeStats[log.kitchen_prep_employees.name].worked += worked;
          employeeStats[log.kitchen_prep_employees.name].tasks++;
        }
        
        // Calculate gap
        if (lastEndTime) {
          const gap = (new Date(log.start_time) - new Date(lastEndTime)) / (1000 * 60);
          if (gap > 0) {
            totalGapMinutes += gap;
          }
        }
        lastEndTime = log.end_time;
      });
    }
    
    const variance = totalWorkedMinutes - totalScheduledMinutes;
    const efficiency = totalScheduledMinutes > 0 ? ((totalWorkedMinutes / totalScheduledMinutes) * 100).toFixed(1) : 0;
    
    // Update stats
    document.getElementById('totalScheduled').textContent = formatTime(totalScheduledMinutes);
    document.getElementById('totalWorked').textContent = formatTime(totalWorkedMinutes);
    document.getElementById('totalBreak').textContent = formatTime(totalBreakMinutes);
    document.getElementById('totalVariance').textContent = (variance >= 0 ? '+' : '') + formatTime(variance);
    document.getElementById('totalGap').textContent = formatTime(totalGapMinutes);
    document.getElementById('efficiencyRate').textContent = efficiency + '%';
    
    // Update cards styling
    document.getElementById('totalVariance').parentElement.className = 
      'stat-card ' + (variance >= 0 ? 'positive' : 'negative');
    
    // Update employee breakdown
    let breakdownHtml = '<div class="stats-grid">';
    for (const [emp, stats] of Object.entries(employeeStats)) {
      breakdownHtml += `
        <div class="stat-card">
          <h3>${emp}</h3>
          <div class="value" style="font-size: 24px;">${formatTime(stats.worked)}</div>
          <div class="subtext">Worked / ${formatTime(stats.scheduled)} Scheduled</div>
          <div style="margin-top: 8px; font-size: 13px;">
            <span class="badge info">${stats.tasks} tasks</span>
          </div>
        </div>
      `;
    }
    breakdownHtml += '</div>';
    document.getElementById('employeeBreakdown').innerHTML = breakdownHtml;
    
    // Update chart
    updateHoursChart(employeeStats);
  } catch (error) {
    console.error('Error loading analytics:', error);
  }
}

let hoursChart = null;
function updateHoursChart(employeeStats) {
  const ctx = document.getElementById('hoursChart').getContext('2d');
  if (hoursChart) hoursChart.destroy();
  
  const labels = Object.keys(employeeStats);
  const scheduled = Object.values(employeeStats).map(s => s.scheduled);
  const worked = Object.values(employeeStats).map(s => s.worked);
  
  hoursChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        {
          label: 'Scheduled Hours',
          data: scheduled,
          backgroundColor: 'rgba(44, 82, 130, 0.8)',
          borderColor: 'rgba(44, 82, 130, 1)',
          borderWidth: 2
        },
        {
          label: 'Worked Hours',
          data: worked,
          backgroundColor: 'rgba(34, 197, 94, 0.8)',
          borderColor: 'rgba(34, 197, 94, 1)',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return formatTime(value);
            }
          }
        }
      }
    }
  });
}

// ========== COMPARISON ==========
function changeComparePeriod() {
  const period = document.getElementById('comparePeriod').value;
  document.getElementById('compareDailyGroup').style.display = period === 'daily' ? 'block' : 'none';
  document.getElementById('compareWeeklyGroup').style.display = period === 'weekly' ? 'block' : 'none';
  document.getElementById('compareMonthlyGroup').style.display = period === 'monthly' ? 'block' : 'none';
  document.getElementById('compareCustomGroup').style.display = period === 'custom' ? 'block' : 'none';
  document.getElementById('compareCustomEndGroup').style.display = period === 'custom' ? 'block' : 'none';
  loadComparison();
}

async function loadComparison() {
  const period = document.getElementById('comparePeriod').value;
  let startDate, endDate;
  
  if (period === 'daily') {
    startDate = document.getElementById('compareDate').value;
    endDate = startDate;
  } else if (period === 'weekly') {
    startDate = document.getElementById('compareWeek').value;
    const weekEnd = new Date(startDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    endDate = weekEnd.toISOString().split('T')[0];
  } else if (period === 'monthly') {
    const month = document.getElementById('compareMonth').value;
    startDate = `${month}-01`;
    endDate = `${month}-31`;
  } else {
    startDate = document.getElementById('compareStart').value;
    endDate = document.getElementById('compareEnd').value;
  }
  
  try {
    const { data: schedules } = await supabaseClient
      .from('employee_schedules')
      .select('*')
      .gte('schedule_date', startDate)
      .lte('schedule_date', endDate);
    
    const { data: logs } = await supabaseClient
      .from('task_time_logs')
      .select(`
        *,
        kitchen_prep_employees(name)
      `)
      .gte('date', startDate)
      .lte('date', endDate);
    
    const employees = [...new Set([
      ...(schedules?.map(s => s.employee_name) || []),
      ...(logs?.map(l => l.kitchen_prep_employees?.name) || [])
    ])];
    
    let html = '';
    employees.forEach(emp => {
      const empSchedules = schedules?.filter(s => s.employee_name === emp) || [];
      const empLogs = logs?.filter(l => l.kitchen_prep_employees?.name === emp && l.end_time) || [];
      
      const scheduledMinutes = empSchedules.reduce((sum, s) => 
        sum + calculateHours(s.start_time, s.end_time), 0);
      const workedMinutes = empLogs.reduce((sum, l) => 
        sum + (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60), 0);
      const breakMinutes = empSchedules.reduce((sum, s) => sum + (s.break_minutes || 60), 0);
      
      const variance = workedMinutes - scheduledMinutes;
      const variancePercent = scheduledMinutes > 0 ? ((variance / scheduledMinutes) * 100).toFixed(1) : 0;
      
      html += `
        <div class="comparison-card">
          <h4>${emp}</h4>
          <div class="metric-row">
            <span class="metric-label">Scheduled Hours</span>
            <span class="metric-value">${formatTime(scheduledMinutes)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Worked Hours</span>
            <span class="metric-value">${formatTime(workedMinutes)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Break Time</span>
            <span class="metric-value">${formatTime(breakMinutes)}</span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Variance</span>
            <span class="metric-value" style="color: ${variance >= 0 ? '#22c55e' : '#ef4444'}">
              ${variance >= 0 ? '+' : ''}${formatTime(variance)} (${variancePercent}%)
            </span>
          </div>
          <div class="metric-row">
            <span class="metric-label">Tasks Completed</span>
            <span class="metric-value">${empLogs.length}</span>
          </div>
        </div>
      `;
    });
    
    document.getElementById('comparisonGrid').innerHTML = html || '<p style="grid-column: 1/-1; text-align: center; color: #718096;">No data found</p>';
  } catch (error) {
    console.error('Error loading comparison:', error);
  }
}

// ========== GAP ANALYSIS ==========
function changeGapPeriod() {
  const period = document.getElementById('gapPeriod').value;
  document.getElementById('gapDailyGroup').style.display = period === 'daily' ? 'block' : 'none';
  document.getElementById('gapWeeklyGroup').style.display = period === 'weekly' ? 'block' : 'none';
  document.getElementById('gapMonthlyGroup').style.display = period === 'monthly' ? 'block' : 'none';
  document.getElementById('gapCustomGroup').style.display = period === 'custom' ? 'block' : 'none';
  document.getElementById('gapCustomEndGroup').style.display = period === 'custom' ? 'block' : 'none';
  loadGapAnalysis();
}

async function loadGapAnalysis() {
  const period = document.getElementById('gapPeriod').value;
  let startDate, endDate;
  
  if (period === 'daily') {
    startDate = document.getElementById('gapDate').value;
    endDate = startDate;
  } else if (period === 'weekly') {
    startDate = document.getElementById('gapWeek').value;
    const weekEnd = new Date(startDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    endDate = weekEnd.toISOString().split('T')[0];
  } else if (period === 'monthly') {
    const month = document.getElementById('gapMonth').value;
    startDate = `${month}-01`;
    endDate = `${month}-31`;
  } else {
    startDate = document.getElementById('gapStart').value;
    endDate = document.getElementById('gapEnd').value;
  }
  
  try {
    const { data: logs } = await supabaseClient
      .from('task_time_logs')
      .select(`
        *,
        kitchen_prep_employees(name),
        kitchen_tasks(name)
      `)
      .gte('date', startDate)
      .lte('date', endDate)
      .order('start_time', { ascending: true });
    
    const gaps = [];
    const employeeLastEnd = {};
    
    logs?.forEach(log => {
      if (!log.end_time) return;
      
      const emp = log.kitchen_prep_employees?.name;
      if (employeeLastEnd[emp]) {
        const gapMinutes = (new Date(log.start_time) - new Date(employeeLastEnd[emp])) / (1000 * 60);
        if (gapMinutes > 5) { // Only track gaps > 5 minutes
          gaps.push({
            employee: emp,
            gapStart: employeeLastEnd[emp],
            gapEnd: log.start_time,
            duration: gapMinutes,
            taskBefore: log.kitchen_tasks?.name,
            date: log.date
          });
        }
      }
      employeeLastEnd[emp] = log.end_time;
    });
    
    let html = '';
    if (gaps.length === 0) {
      html = '<p style="text-align: center; color: #718096; padding: 24px;">No significant gaps found (gaps > 5 minutes)</p>';
    } else {
      html = '<table class="schedule-table"><thead><tr><th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th></tr></thead><tbody>';
      gaps.forEach(gap => {
        html += `
          <tr>
            <td>${formatDate(gap.date)}</td>
            <td><strong>${gap.employee}</strong></td>
            <td>${new Date(gap.gapStart).toLocaleTimeString()}</td>
            <td>${new Date(gap.gapEnd).toLocaleTimeString()}</td>
            <td><span class="badge warning">${formatTime(gap.duration)}</span></td>
            <td>${gap.taskBefore}</td>
          </tr>
        `;
      });
      html += '</tbody></table>';
      html += `<div class="gap-alert">‚ö†Ô∏è Total gap time: ${formatTime(gaps.reduce((sum, g) => sum + g.duration, 0))} across ${gaps.length} gaps</div>`;
    }
    
    document.getElementById('gapList').innerHTML = html;
  } catch (error) {
    console.error('Error loading gap analysis:', error);
  }
}
</script>
</body>
</html>
