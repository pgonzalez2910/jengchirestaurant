<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Workforce Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* { box-sizing: border-box; margin: 0; padding: 0; }
body { font-family: 'Inter', sans-serif; background: #f0f4f8; color: #2d3748; min-height: 100vh; }

/* â”€â”€ LOGIN SCREEN â”€â”€ */
#loginScreen {
  position: fixed; inset: 0; z-index: 9999;
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 60%, #2b6cb0 100%);
  display: flex; align-items: center; justify-content: center;
}
.login-card {
  background: white; border-radius: 20px; padding: 48px 40px;
  width: 100%; max-width: 420px;
  box-shadow: 0 25px 60px rgba(0,0,0,0.3);
  text-align: center;
}
.login-logo { font-size: 48px; margin-bottom: 8px; }
.login-title { font-size: 24px; font-weight: 700; color: #1a365d; margin-bottom: 4px; }
.login-subtitle { font-size: 14px; color: #718096; margin-bottom: 32px; }
.login-field { margin-bottom: 16px; text-align: left; }
.login-field label { display: block; font-size: 13px; font-weight: 600; color: #4a5568; margin-bottom: 6px; }
.login-field input {
  width: 100%; padding: 12px 16px; border: 2px solid #e2e8f0;
  border-radius: 10px; font-size: 15px; font-family: inherit;
  transition: all 0.2s;
}
.login-field input:focus { outline: none; border-color: #2c5282; box-shadow: 0 0 0 3px rgba(44,82,130,0.15); }
.login-btn {
  width: 100%; padding: 14px; border: none; border-radius: 10px;
  background: linear-gradient(135deg, #2c5282, #1a365d);
  color: white; font-size: 16px; font-weight: 700; cursor: pointer;
  transition: all 0.2s; margin-top: 8px;
}
.login-btn:hover { transform: translateY(-1px); box-shadow: 0 6px 20px rgba(44,82,130,0.4); }
.login-btn:disabled { background: #a0aec0; transform: none; box-shadow: none; cursor: not-allowed; }
#loginError { color: #e53e3e; font-size: 14px; margin-top: 12px; min-height: 20px; font-weight: 500; }

/* â”€â”€ APP SHELL â”€â”€ */
#appShell { display: none; }
.container { max-width: 1600px; margin: 0 auto; background: white; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
header {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  color: white; padding: 20px 40px;
  display: flex; justify-content: space-between; align-items: center;
}
header h1 { font-size: 24px; font-weight: 700; }
.header-subtitle { font-size: 13px; opacity: 0.85; margin-top: 3px; }
.header-user {
  display: flex; align-items: center; gap: 12px;
}
.user-badge {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  border-radius: 20px; padding: 6px 16px; font-size: 14px; font-weight: 600;
}
.admin-badge {
  background: #f6ad55; color: #7b341e;
  border-radius: 12px; padding: 3px 10px; font-size: 11px; font-weight: 700;
  text-transform: uppercase; letter-spacing: 0.5px;
}
.logout-btn {
  background: rgba(255,255,255,0.15); border: 1px solid rgba(255,255,255,0.3);
  color: white; border-radius: 8px; padding: 7px 16px; font-size: 13px;
  font-weight: 600; cursor: pointer; transition: all 0.2s; width: auto;
}
.logout-btn:hover { background: rgba(255,255,255,0.25); }

/* â”€â”€ TABS â”€â”€ */
.tabs { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-wrap: wrap; }
.tab-btn {
  flex: 1; min-width: 120px; padding: 14px 18px; border: none;
  background: none; cursor: pointer; font-size: 13px; font-weight: 600;
  color: #718096; transition: all 0.2s; position: relative;
}
.tab-btn:hover { color: #2c5282; background: #edf2f7; }
.tab-btn.active { color: #2c5282; background: white; }
.tab-btn.active::after {
  content: ''; position: absolute; bottom: 0; left: 0; right: 0;
  height: 3px; background: #2c5282;
}
.tab-content { display: none; padding: 32px 40px; }
.tab-content.active { display: block; }

/* â”€â”€ FORMS â”€â”€ */
.form-group { margin-bottom: 20px; }
label { display: block; margin-bottom: 7px; font-weight: 600; color: #4a5568; font-size: 13px; }
select, input[type=text], input[type=date], input[type=time], input[type=month], input[type=password] {
  width: 100%; padding: 10px 14px; border: 1.5px solid #cbd5e0;
  border-radius: 8px; font-size: 14px; font-family: inherit; transition: all 0.2s;
}
select:focus, input:focus { outline: none; border-color: #3182ce; box-shadow: 0 0 0 3px rgba(49,130,206,0.1); }

/* â”€â”€ BUTTONS â”€â”€ */
button {
  background: linear-gradient(135deg, #2c5282, #1a365d); color: white;
  border: none; cursor: pointer; font-weight: 600; font-size: 14px;
  padding: 10px 20px; border-radius: 8px; transition: all 0.2s; width: auto;
}
button:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(44,82,130,0.25); }
button:disabled { background: #a0aec0; cursor: not-allowed; transform: none; box-shadow: none; }
button.secondary { background: #e2e8f0; color: #4a5568; }
button.secondary:hover { background: #cbd5e0; box-shadow: none; }
button.success { background: linear-gradient(135deg, #22c55e, #16a34a); }
button.success:hover { box-shadow: 0 4px 12px rgba(34,197,94,0.25); }
button.danger { background: linear-gradient(135deg, #ef4444, #dc2626); }
button.danger:hover { box-shadow: 0 4px 12px rgba(239,68,68,0.25); }
button.warning { background: linear-gradient(135deg, #f59e0b, #d97706); }

/* â”€â”€ STATUS MESSAGES â”€â”€ */
#globalStatus { padding: 10px 16px; border-radius: 8px; margin: 12px 40px 0; text-align: center; font-weight: 500; font-size: 13px; }
.status-success { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
.status-error { background: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
.status-info { background: #dbeafe; color: #1e40af; border: 1px solid #93c5fd; }
.hidden { display: none !important; }

/* â”€â”€ CARDS â”€â”€ */
.card { background: white; border-radius: 12px; padding: 24px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e2e8f0; margin-bottom: 24px; }
.section-title { font-size: 20px; font-weight: 700; color: #2d3748; margin-bottom: 6px; }
.section-subtitle { font-size: 13px; color: #718096; margin-bottom: 24px; }
.action-bar { display: flex; gap: 10px; margin-top: 16px; flex-wrap: wrap; }

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card {
  background: white; padding: 20px; border-radius: 12px; text-align: center;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08); border: 1px solid #e2e8f0;
  transition: all 0.2s; position: relative; overflow: hidden;
}
.stat-card::before {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px;
  background: var(--accent, #2c5282);
}
.stat-card:hover { transform: translateY(-2px); box-shadow: 0 6px 16px rgba(0,0,0,0.1); }
.stat-card h3 { font-size: 11px; color: #718096; margin-bottom: 10px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.6px; }
.stat-card .value { font-size: 28px; font-weight: 800; color: #2d3748; line-height: 1; margin-bottom: 4px; }
.stat-card .subtext { font-size: 11px; color: #a0aec0; }
.stat-card.blue   { --accent: #3182ce; } .stat-card.blue   .value { color: #2b6cb0; }
.stat-card.green  { --accent: #38a169; } .stat-card.green  .value { color: #276749; }
.stat-card.orange { --accent: #dd6b20; } .stat-card.orange .value { color: #c05621; }
.stat-card.red    { --accent: #e53e3e; } .stat-card.red    .value { color: #c53030; }
.stat-card.purple { --accent: #805ad5; } .stat-card.purple .value { color: #553c9a; }
.stat-card.teal   { --accent: #319795; } .stat-card.teal   .value { color: #285e61; }

/* â”€â”€ TABLES â”€â”€ */
.schedule-table { width: 100%; border-collapse: collapse; }
.schedule-table th { background: #f8fafc; font-weight: 700; color: #4a5568; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; padding: 10px 14px; text-align: left; border-bottom: 2px solid #e2e8f0; }
.schedule-table td { padding: 12px 14px; border-bottom: 1px solid #f0f0f0; font-size: 13px; vertical-align: middle; }
.schedule-table tr:hover td { background: #f8fafc; }
.task-table-container { overflow-x: auto; border-radius: 10px; border: 1px solid #e2e8f0; }
.badge { display: inline-block; padding: 3px 10px; border-radius: 10px; font-size: 11px; font-weight: 700; }
.badge-success  { background: #d1fae5; color: #065f46; }
.badge-warning  { background: #fef3c7; color: #92400e; }
.badge-danger   { background: #fee2e2; color: #991b1b; }
.badge-info     { background: #dbeafe; color: #1e40af; }
.badge-untask   { background: #fde8d8; color: #9c4221; }
.badge-purple   { background: #ede9fe; color: #5b21b6; }

/* â”€â”€ FILTER BAR â”€â”€ */
.filters-bar { background: #f8fafc; padding: 18px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 20px; }
.filters-bar .row { display: flex; gap: 12px; flex-wrap: wrap; align-items: flex-end; }
.filters-bar .form-group { flex: 1; min-width: 150px; margin-bottom: 0; }

/* â”€â”€ PERIOD SELECTOR â”€â”€ */
.period-selector { background: #ebf8ff; padding: 18px; border-radius: 10px; border: 1px solid #bee3f8; margin-bottom: 20px; }
.period-selector h4 { font-size: 13px; color: #2c5282; margin-bottom: 12px; font-weight: 700; }
.current-period-display { margin-top: 10px; padding: 10px 14px; background: white; border-radius: 8px; font-size: 13px; color: #2c5282; font-weight: 600; border: 1px solid #bee3f8; }

/* â”€â”€ EMPLOYEE PORTAL â”€â”€ */
.portal-header { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; border-radius: 16px; padding: 28px 32px; margin-bottom: 24px; display: flex; align-items: center; gap: 20px; }
.portal-avatar { width: 64px; height: 64px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; font-weight: 800; border: 3px solid rgba(255,255,255,0.4); }
.portal-name { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.portal-sub { font-size: 14px; opacity: 0.85; }

.task-log-form { background: white; border-radius: 14px; padding: 28px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); margin-bottom: 20px; }
.task-log-form h3 { font-size: 16px; font-weight: 700; color: #2d3748; margin-bottom: 20px; padding-bottom: 12px; border-bottom: 2px solid #e2e8f0; }
.time-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }

.my-tasks-list { background: white; border-radius: 14px; padding: 24px; border: 1px solid #e2e8f0; box-shadow: 0 2px 8px rgba(0,0,0,0.06); }
.my-tasks-list h3 { font-size: 15px; font-weight: 700; color: #2d3748; margin-bottom: 16px; display: flex; justify-content: space-between; align-items: center; }

/* â”€â”€ MODAL â”€â”€ */
.modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
.modal-overlay.active { display: flex; }
.modal { background: white; border-radius: 16px; padding: 32px; max-width: 560px; width: 92%; max-height: 92vh; overflow-y: auto; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
.modal-header h2 { font-size: 18px; font-weight: 700; }
.modal-close { background: none; border: none; font-size: 22px; cursor: pointer; color: #718096; padding: 0; width: auto; }

/* â”€â”€ CHART â”€â”€ */
.chart-container { height: 320px; padding: 16px; }

/* â”€â”€ PRODUCTIVITY RING â”€â”€ */
.productivity-ring { position: relative; width: 80px; height: 80px; margin: 0 auto 8px; }
.productivity-ring svg { transform: rotate(-90deg); }
.productivity-ring .pct { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: 800; }

/* â”€â”€ UNTASK BADGE â”€â”€ */
.untask-row td { background: #fff7ed !important; }
.untask-row:hover td { background: #feedd8 !important; }

/* â”€â”€ SCHEDULE TABLE â”€â”€ */
.time-entry { display: grid; grid-template-columns: 110px 110px 1fr 160px 44px; gap: 10px; align-items: center; margin-bottom: 10px; }
.time-entry input, .time-entry select { width: 100%; }

@media (max-width: 768px) {
  .tabs { flex-direction: column; }
  .tab-content { padding: 16px; }
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .time-grid { grid-template-columns: 1fr; }
  .time-entry { grid-template-columns: 1fr 1fr; }
  header { padding: 16px 20px; }
  header h1 { font-size: 18px; }
}
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     LOGIN SCREEN
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginScreen">
  <div class="login-card">
    <div class="login-logo">ğŸ³</div>
    <div class="login-title">Kitchen Workforce</div>
    <div class="login-subtitle">Sign in to continue</div>
    <div class="login-field">
      <label>Username</label>
      <input type="text" id="loginUsername" placeholder="Enter username" autocomplete="username">
    </div>
    <div class="login-field">
      <label>Password</label>
      <input type="password" id="loginPassword" placeholder="Enter password" autocomplete="current-password">
    </div>
    <button class="login-btn" onclick="doLogin()" id="loginBtn">Sign In</button>
    <div id="loginError"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     APP SHELL
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="appShell">
<div class="container">

<header>
  <div>
    <h1>ğŸ³ Kitchen Workforce Management</h1>
    <div class="header-subtitle">Schedule, Worked, Break & Untask Time Dashboard</div>
  </div>
  <div class="header-user">
    <span class="user-badge" id="headerUserName">â€”</span>
    <span class="admin-badge hidden" id="adminBadge">Admin</span>
    <button class="logout-btn" onclick="doLogout()">Sign Out</button>
  </div>
</header>

<div id="globalStatus" class="hidden"></div>

<!-- â•â•â• TABS â•â•â• -->
<div class="tabs" id="tabBar">
  <!-- Admin tabs injected by JS -->
</div>

<!-- â•â•â• TAB: EMPLOYEE PORTAL (non-admin) â•â•â• -->
<div id="portal" class="tab-content">
  <div class="portal-header">
    <div class="portal-avatar" id="portalAvatar">?</div>
    <div>
      <div class="portal-name" id="portalName">Employee</div>
      <div class="portal-sub" id="portalSub">Log your tasks for today</div>
    </div>
  </div>

  <!-- My Stats today -->
  <div class="stats-grid" id="portalStats">
    <div class="stat-card green">  <h3>âœ… Tasks Today</h3><div class="value" id="pStatTasks">0</div><div class="subtext">Completed</div></div>
    <div class="stat-card blue">   <h3>â± Time Worked</h3><div class="value" id="pStatWorked">0m</div><div class="subtext">Total logged</div></div>
    <div class="stat-card orange"> <h3>â¸ Untask Gaps</h3><div class="value" id="pStatUntask">0m</div><div class="subtext">Between tasks</div></div>
    <div class="stat-card purple"> <h3>ğŸ¯ Productivity</h3><div class="value" id="pStatProd">â€”</div><div class="subtext">Worked vs scheduled</div></div>
  </div>

  <!-- Log a Task -->
  <div class="task-log-form">
    <h3>â• Log a Task</h3>
    <div class="form-group">
      <label>ğŸ“… Date</label>
      <input type="date" id="portalDate">
    </div>
    <div class="form-group">
      <label>ğŸ“ Task Name</label>
      <input type="text" id="portalTaskName" placeholder="Describe what you did...">
    </div>
    <div class="form-group">
      <label>ğŸ· Role</label>
      <select id="portalRole">
        <option value="Kitchen Prep">Kitchen Prep</option>
        <option value="Line Cook">Line Cook</option>
        <option value="Fryer">Fryer</option>
        <option value="Dishwasher">Dishwasher</option>
        <option value="Server">Server</option>
      </select>
    </div>
    <div class="time-grid">
      <div class="form-group">
        <label>â° Start Time</label>
        <input type="time" id="portalStart">
      </div>
      <div class="form-group">
        <label>â° End Time</label>
        <input type="time" id="portalEnd">
      </div>
    </div>
    <div class="action-bar">
      <button onclick="savePortalTask()" class="success" style="flex:1;">ğŸ’¾ Save Task</button>
    </div>
    <div id="portalStatus" class="hidden" style="margin-top:12px; padding:10px; border-radius:8px; font-size:13px; font-weight:500;"></div>
  </div>

  <!-- My Tasks Today -->
  <div class="my-tasks-list">
    <h3>
      ğŸ“‹ My Recent Tasks
      <button onclick="loadPortalTasks()" class="secondary" style="font-size:12px; padding:6px 12px;">ğŸ”„ Refresh</button>
    </h3>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr>
          <th>Date</th><th>Task</th><th>Role</th>
          <th>Start</th><th>End</th><th>Duration</th><th>Type</th>
        </tr></thead>
        <tbody id="portalTasksBody">
          <tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">Your tasks will appear here</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: MANAGE SCHEDULE (admin) â•â•â• -->
<div id="schedule" class="tab-content">
  <h2 class="section-title">Manage Employee Schedule</h2>
  <p class="section-subtitle">Add and manage scheduled shifts for employees</p>
  <div class="card">
    <div class="form-group"><label>ğŸ“… Date</label><input type="date" id="scheduleDate" required></div>
    <div class="form-group">
      <label>ğŸ‘¤ Employee</label>
      <select id="scheduleEmployee" required>
        <option value="">-- Select Employee --</option>
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group">
      <label>ğŸ· Role</label>
      <select id="scheduleRole">
        <option>Kitchen Prep</option><option>Line Cook</option>
        <option>Fryer</option><option>Dishwasher</option><option>Server</option>
      </select>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="form-group"><label>â° Start Time</label><input type="time" id="scheduleStart"></div>
      <div class="form-group"><label>â° End Time</label><input type="time" id="scheduleEnd"></div>
    </div>
    <div class="action-bar">
      <button onclick="addSchedule()" class="success">ğŸ’¾ Add Schedule</button>
      <button onclick="loadSchedules()" class="secondary">ğŸ”„ Refresh</button>
    </div>
    <div id="scheduleStatus" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
  </div>
  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">ğŸ“‹ Scheduled Shifts</h3>
    <div id="scheduleList"><p style="color:#718096;text-align:center;padding:24px;">Loading...</p></div>
  </div>
</div>

<!-- â•â•â• TAB: TASK LOGGING (admin) â•â•â• -->
<div id="tasks" class="tab-content">
  <h2 class="section-title">Real-Time Task Logging</h2>
  <p class="section-subtitle">Track actual work â€” gaps between tasks are automatically logged as Untask time</p>
  <div class="card">
    <div class="form-group">
      <label>ğŸ‘¤ Employee</label>
      <select id="taskEmployee">
        <option value="">-- Select Employee --</option>
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group"><label>ğŸ· Role</label>
      <select id="taskRole">
        <option>Kitchen Prep</option><option>Line Cook</option>
        <option>Fryer</option><option>Dishwasher</option>
      </select>
    </div>
    <div class="form-group"><label>ğŸ“ Task Name</label>
      <input type="text" id="taskName" placeholder="Type task name...">
    </div>
    <div class="action-bar">
      <button onclick="startTask()" id="startBtn">â–¶ Start Task</button>
      <button onclick="stopTask()" id="stopBtn" disabled class="danger">â¹ Stop Task</button>
    </div>
    <div id="taskStatus" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
    <div id="activeTaskInfo" class="hidden" style="margin-top:16px;padding:16px;background:#f0f9ff;border-radius:10px;border:1px solid #bee3f8;">
      <h4 style="color:#2c5282;margin-bottom:6px;">â–¶ Active Task</h4>
      <p id="activeTaskDisplay" style="font-weight:600;margin-bottom:6px;"></p>
      <p id="taskTimer" style="font-size:13px;color:#4a5568;font-family:monospace;"></p>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: ALL TASKS (admin) â•â•â• -->
<div id="allTasks" class="tab-content">
  <h2 class="section-title">All Employee Tasks</h2>
  <p class="section-subtitle">View, edit, and delete all task logs. Untask rows show time gaps between tasks.</p>
  <div class="filters-bar">
    <div class="row">
      <div class="form-group">
        <label>ğŸ‘¤ Employee</label>
        <select id="allTasksEmployee" onchange="loadAllTasks()">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group"><label>ğŸ“… Start Date</label><input type="date" id="allTasksStartDate" onchange="loadAllTasks()"></div>
      <div class="form-group"><label>ğŸ“… End Date</label><input type="date" id="allTasksEndDate" onchange="loadAllTasks()"></div>
      <div class="form-group">
        <label>ğŸ· Role</label>
        <select id="allTasksRole" onchange="loadAllTasks()">
          <option value="">All Roles</option>
          <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
        </select>
      </div>
      <div class="form-group">
        <label>ğŸ“Œ Status</label>
        <select id="allTasksStatus" onchange="loadAllTasks()">
          <option value="">All (Tasks + Untask)</option>
          <option value="done">âœ… Tasks Only (Done)</option>
          <option value="auto">â¸ Untask / Break Only (Auto)</option>
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end;">
        <button onclick="loadAllTasks()" class="success" style="">ğŸ”„ Load</button>
      </div>
    </div>
  </div>
  <div class="card">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;">
      <h3 style="font-size:15px;">ğŸ“ Task Records</h3>
      <span id="allTasksCount" style="color:#718096;font-size:13px;">0 tasks</span>
    </div>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr>
          <th>Date</th><th>Employee</th><th>Task</th><th>Role</th>
          <th>Start</th><th>End</th><th>Duration</th><th>Type</th><th>Status</th><th>Actions</th>
        </tr></thead>
        <tbody id="allTasksTableBody">
          <tr><td colspan="10" style="text-align:center;padding:40px;color:#718096;">Select filters and click Load</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: BATCH ENTRY (admin) â•â•â• -->
<div id="batch" class="tab-content">
  <h2 class="section-title">Batch Task Entry</h2>
  <p class="section-subtitle">Add multiple tasks at once for a specific employee and date</p>
  <div class="card">
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;">
      <div class="form-group"><label>ğŸ“… Date</label><input type="date" id="batchDate"></div>
      <div class="form-group"><label>ğŸ‘¤ Employee</label>
        <select id="batchEmployee">
          <option value="">-- Select Employee --</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
    </div>
    <div class="action-bar" style="margin-bottom:16px;">
      <button onclick="addBatchRow()" class="success">â• Add Task Row</button>
      <button onclick="clearBatchRows()" class="secondary">ğŸ—‘ Clear All</button>
    </div>
    <div id="batchRows"></div>
    <div class="action-bar" style="margin-top:16px;">
      <button onclick="saveBatchTasks()" class="success" style="flex:1;">ğŸ’¾ Save All Tasks</button>
    </div>
    <div id="batchStatus" class="hidden" style="margin-top:12px;padding:10px;border-radius:8px;font-size:13px;font-weight:500;"></div>
  </div>
</div>

<!-- â•â•â• TAB: ANALYTICS (admin) â•â•â• -->
<div id="analytics" class="tab-content">
  <h2 class="section-title">Analytics Dashboard</h2>
  <p class="section-subtitle">Scheduled vs Worked vs Untask vs Break â€” with productivity metrics</p>

  <div class="period-selector">
    <h4>ğŸ“… Select Time Period</h4>
    <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div class="form-group" style="flex:1;min-width:130px;margin-bottom:0;">
        <label>Period</label>
        <select id="analyticsPeriod" onchange="changeAnalyticsPeriod()">
          <option value="daily">Daily</option>
          <option value="weekly">Weekly</option>
          <option value="monthly">Monthly</option>
          <option value="custom">Custom Range</option>
        </select>
      </div>
      <div class="form-group" id="dailyDateGroup" style="flex:1;min-width:130px;margin-bottom:0;">
        <label>Date</label><input type="date" id="analyticsDate">
      </div>
      <div class="form-group" id="weeklyDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Week Starting</label><input type="date" id="analyticsWeek">
      </div>
      <div class="form-group" id="monthlyDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Month</label><input type="month" id="analyticsMonth">
      </div>
      <div class="form-group" id="customDateGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>Start Date</label><input type="date" id="analyticsStart">
      </div>
      <div class="form-group" id="customEndGroup" style="display:none;flex:1;min-width:130px;margin-bottom:0;">
        <label>End Date</label><input type="date" id="analyticsEnd">
      </div>
      <div class="form-group" style="flex:1;min-width:160px;margin-bottom:0;">
        <label>ğŸ‘¤ Employee</label>
        <select id="analyticsEmployee">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <button onclick="loadAnalytics()" style="margin-bottom:0;">ğŸ“Š Load</button>
    </div>
    <div id="currentPeriodDisplay" class="current-period-display">Select a period and click Load</div>
  </div>

  <!-- KPI Cards -->
  <div class="stats-grid">
    <div class="stat-card blue">   <h3>ğŸ“… Scheduled Hours</h3><div class="value" id="totalScheduled">â€”</div><div class="subtext">All employees</div></div>
    <div class="stat-card green">  <h3>â± Worked Hours</h3>   <div class="value" id="totalWorked">â€”</div>   <div class="subtext">Tasks completed</div></div>
    <div class="stat-card orange"> <h3>â¸ Untask Hours</h3>  <div class="value" id="totalUnlogged">â€”</div> <div class="subtext">Gaps between tasks</div></div>
    <div class="stat-card red">    <h3>â˜• Break Hours</h3>   <div class="value" id="totalBreak">â€”</div>    <div class="subtext">1h per employee</div></div>
    <div class="stat-card purple"> <h3>ğŸ¯ Productivity</h3>  <div class="value" id="totalProductivity">â€”</div><div class="subtext">Worked / (Schedâˆ’Break)</div></div>
    <div class="stat-card teal">   <h3>ğŸ“‹ Total Tasks</h3>  <div class="value" id="totalTasks">â€”</div>   <div class="subtext">Logged tasks</div></div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">ğŸ“Š Hours Distribution by Employee</h3>
    <div class="chart-container"><canvas id="hoursChart"></canvas></div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:16px;font-size:15px;">ğŸ‘¥ Employee Breakdown</h3>
    <div class="task-table-container">
      <table class="schedule-table" id="empBreakdownTable">
        <thead><tr>
          <th>Employee</th><th>Scheduled</th><th>Worked</th><th>Break</th>
          <th>Untask</th><th># Tasks</th><th>Productivity</th>
        </tr></thead>
        <tbody id="employeeBreakdown">
          <tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">Load analytics to see breakdown</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h3 style="margin-bottom:6px;font-size:15px;">â¸ Untask Time Log</h3>
    <p style="color:#718096;font-size:13px;margin-bottom:16px;">Time gaps between consecutive tasks per employee. These are recorded as "UNTASK" entries.</p>
    <div class="task-table-container">
      <table class="schedule-table">
        <thead><tr><th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th></tr></thead>
        <tbody id="unloggedLogBody">
          <tr><td colspan="6" style="text-align:center;padding:24px;color:#718096;">Load analytics to see untask details</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- â•â•â• TAB: SCHEDULE VS ACTUAL (admin) â•â•â• -->
<div id="schedVsActual" class="tab-content">
  <h2 class="section-title">Schedule vs Actual</h2>
  <p class="section-subtitle">Compare planned schedules against actual logged hours</p>
  <div class="filters-bar">
    <div class="row">
      <div class="form-group"><label>ğŸ“… Date</label><input type="date" id="svaDate"></div>
      <div class="form-group">
        <label>ğŸ‘¤ Employee</label>
        <select id="svaEmployee">
          <option value="">All Employees</option>
          <option>Julio Mejia</option><option>Leydi Diaz</option>
          <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
        </select>
      </div>
      <div class="form-group" style="display:flex;align-items:flex-end;">
        <button onclick="loadSchedVsActual()" class="success">ğŸ“Š Compare</button>
      </div>
    </div>
  </div>
  <div id="svaContent">
    <p style="color:#718096;text-align:center;padding:40px;">Select a date and click Compare</p>
  </div>
</div>

</div><!-- /container -->
</div><!-- /appShell -->

<!-- â•â•â• EDIT TASK MODAL â•â•â• -->
<div class="modal-overlay" id="editTaskModal">
  <div class="modal">
    <div class="modal-header">
      <h2>âœï¸ Edit Task</h2>
      <button class="modal-close" onclick="closeEditTaskModal()">Ã—</button>
    </div>
    <input type="hidden" id="editTaskId">
    <div class="form-group"><label>ğŸ‘¤ Employee</label>
      <select id="editTaskEmployee">
        <option>Julio Mejia</option><option>Leydi Diaz</option>
        <option>Procoro Tinoco</option><option>Wilson Sanchez</option>
      </select>
    </div>
    <div class="form-group"><label>ğŸ“… Date</label><input type="date" id="editTaskDate"></div>
    <div class="form-group"><label>ğŸ· Role</label>
      <select id="editTaskRole">
        <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
      </select>
    </div>
    <div class="form-group"><label>ğŸ“ Task Name</label><input type="text" id="editTaskName"></div>
    <div class="form-group"><label>â° Start Time</label><input type="time" id="editTaskStart"></div>
    <div class="form-group"><label>â° End Time</label><input type="time" id="editTaskEnd">
      <small style="color:#718096;margin-top:4px;display:block;">Leave blank for open tasks</small>
    </div>
    <div class="action-bar" style="margin-top:20px;">
      <button onclick="saveEditedTask()" class="success" style="flex:1;">ğŸ’¾ Save Changes</button>
      <button onclick="closeEditTaskModal()" class="secondary" style="flex:1;">Cancel</button>
    </div>
  </div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SUPABASE SETUP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const { createClient } = window.supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  AUTH STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const ADMINS = ['PG9367', 'JT2316'];
let currentUser = null;   // { username, display_name, is_admin }

// Press Enter on password field to login
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('loginPassword').addEventListener('keydown', e => {
    if (e.key === 'Enter') doLogin();
  });
  document.getElementById('loginUsername').addEventListener('keydown', e => {
    if (e.key === 'Enter') document.getElementById('loginPassword').focus();
  });
  // set today's date on portal
  const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  document.getElementById('portalDate').value = today;
  document.getElementById('analyticsDate').value = today;
  document.getElementById('svaDate').value = today;
  document.getElementById('batchDate').value = today;
  document.getElementById('scheduleDate').value = today;
});

async function doLogin() {
  const username = document.getElementById('loginUsername').value.trim();
  const password = document.getElementById('loginPassword').value.trim();
  const errEl = document.getElementById('loginError');
  const btn = document.getElementById('loginBtn');

  if (!username || !password) { errEl.textContent = 'Please enter username and password'; return; }

  btn.disabled = true;
  btn.textContent = 'Signing inâ€¦';
  errEl.textContent = '';

  try {
    const { data, error } = await supabaseClient
      .from('employees2025')
    .select('username, pin, first_name, last_name')
      .eq('username', username)
      .maybeSingle();

    if (error) throw error;

    if (!data) {
      errEl.textContent = 'âŒ Username not found';
      btn.disabled = false; btn.textContent = 'Sign In'; return;
    }
   if (data.pin !== password) {
      errEl.textContent = 'âŒ Incorrect password';
      btn.disabled = false; btn.textContent = 'Sign In'; return;
    }

    // âœ… Login successful
    currentUser = {
      username: data.username,
     display_name: (data.first_name && data.last_name)
  ? `${data.first_name} ${data.last_name}`
  : data.username,
      is_admin: ADMINS.includes(data.username.toUpperCase())
    };

    initApp();
  } catch (e) {
    console.error('Login error:', e);
    errEl.textContent = 'âŒ Connection error. Try again.';
    btn.disabled = false; btn.textContent = 'Sign In';
  }
}

function doLogout() {
  currentUser = null;
  document.getElementById('loginScreen').style.display = 'flex';
  document.getElementById('appShell').style.display = 'none';
  document.getElementById('loginUsername').value = '';
  document.getElementById('loginPassword').value = '';
  document.getElementById('loginError').textContent = '';
  document.getElementById('loginBtn').disabled = false;
  document.getElementById('loginBtn').textContent = 'Sign In';
}

function initApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appShell').style.display = 'block';

  // Header
  document.getElementById('headerUserName').textContent = currentUser.display_name;
  if (currentUser.is_admin) {
    document.getElementById('adminBadge').classList.remove('hidden');
  }

  // Build tabs
  const tabBar = document.getElementById('tabBar');
  tabBar.innerHTML = '';

  if (currentUser.is_admin) {
    const adminTabs = [
      { id: 'schedule',    label: 'ğŸ“… Manage Schedule' },
      { id: 'tasks',       label: 'â± Task Logging' },
      { id: 'allTasks',    label: 'ğŸ“‹ All Tasks' },
      { id: 'batch',       label: 'ğŸ“ Batch Entry' },
      { id: 'analytics',   label: 'ğŸ“Š Analytics' },
      { id: 'schedVsActual', label: 'ğŸ“ˆ Sched vs Actual' },
    ];
    adminTabs.forEach((t, i) => {
      const btn = document.createElement('button');
      btn.className = 'tab-btn' + (i === 0 ? ' active' : '');
      btn.textContent = t.label;
      btn.onclick = () => switchTab(t.id);
      tabBar.appendChild(btn);
    });
    switchTab('schedule');
    loadSchedules();
  } else {
    // Employee-only tab
    const btn = document.createElement('button');
    btn.className = 'tab-btn active';
    btn.textContent = 'ğŸ“‹ My Tasks';
    btn.onclick = () => switchTab('portal');
    tabBar.appendChild(btn);
    switchTab('portal');
    initPortal();
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  TAB SWITCHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function switchTab(id) {
  document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  const section = document.getElementById(id);
  if (section) section.classList.add('active');
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.textContent.toLowerCase().includes(id.slice(0,4).toLowerCase()) ||
        btn.onclick?.toString().includes(`'${id}'`)) {
      btn.classList.add('active');
    }
  });
  // activate by matching onclick
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.getAttribute('onclick')?.includes(`'${id}'`)) btn.classList.add('active');
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function formatTime(minutes) {
  if (isNaN(minutes) || minutes < 0) return '0m';
  const h = Math.floor(minutes / 60);
  const m = Math.round(minutes % 60);
  return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function calculateHours(start, end) {
  const s = new Date(`2000-01-01T${start}`);
  const e = new Date(`2000-01-01T${end}`);
  return (e - s) / (1000 * 60);
}
function formatDate(dateStr) {
  if (!dateStr) return 'â€”';
  const d = new Date(dateStr + 'T12:00:00');
  return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
}
function formatDateTime(isoString) {
  if (!isoString) return 'â€”';
  return new Date(isoString).toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: 'numeric', minute: '2-digit', hour12: true });
}
function toCSTISOString(dateStr, timeStr) {
  return `${dateStr}T${timeStr}:00-06:00`;
}
function showGlobalStatus(msg, type = 'info') {
  const el = document.getElementById('globalStatus');
  el.textContent = msg;
  el.className = 'status-' + type;
  el.classList.remove('hidden');
  clearTimeout(showGlobalStatus._t);
  showGlobalStatus._t = setTimeout(() => el.classList.add('hidden'), 5000);
}
function showLocalStatus(id, msg, type = 'info') {
  const el = document.getElementById(id);
  if (!el) return;
  el.textContent = msg;
  el.style.background = type === 'success' ? '#d1fae5' : type === 'error' ? '#fee2e2' : '#dbeafe';
  el.style.color = type === 'success' ? '#065f46' : type === 'error' ? '#991b1b' : '#1e40af';
  el.classList.remove('hidden');
  setTimeout(() => el.classList.add('hidden'), 4000);
}

// â”€â”€ Employee/Task ID lookups â”€â”€
let _employeeMapCache = null;
let _taskMapCache = null;
async function getEmployeeMap(force = false) {
  if (_employeeMapCache && !force) return _employeeMapCache;
  const { data } = await supabaseClient.from('kitchen_prep_employees').select('id,name');
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _employeeMapCache = map;
  return map;
}
async function getTaskMap(force = false) {
  if (_taskMapCache && !force) return _taskMapCache;
  const { data } = await supabaseClient.from('kitchen_tasks').select('id,name');
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _taskMapCache = map;
  return map;
}
async function getEmployeeIdByName(name, createIfMissing = true) {
  if (!name) return null;
  const { data: ex } = await supabaseClient.from('kitchen_prep_employees').select('id').eq('name', name).limit(1).maybeSingle();
  if (ex?.id) return ex.id;
  if (!createIfMissing) return null;
  const { data: cr, error } = await supabaseClient.from('kitchen_prep_employees').insert({ name }).select('id').single();
  if (error) throw error;
  _employeeMapCache = null;
  return cr.id;
}
async function getTaskIdByName(name, createIfMissing = true) {
  if (!name) return null;
  const { data: ex } = await supabaseClient.from('kitchen_tasks').select('id').eq('name', name).limit(1).maybeSingle();
  if (ex?.id) return ex.id;
  if (!createIfMissing) return null;
  const { data: cr, error } = await supabaseClient.from('kitchen_tasks').insert({ name }).select('id').single();
  if (error) throw error;
  _taskMapCache = null;
  return cr.id;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  EMPLOYEE PORTAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function initPortal() {
  const name = currentUser.display_name;
  const initials = name.split(' ').map(w => w[0]).join('').slice(0,2).toUpperCase();
  document.getElementById('portalAvatar').textContent = initials;
  document.getElementById('portalName').textContent = name;
  document.getElementById('portalSub').textContent = `ğŸ‘‹ Welcome back! Log your tasks below.`;
  loadPortalTasks();
}

async function savePortalTask() {
  const date = document.getElementById('portalDate').value;
  const taskName = document.getElementById('portalTaskName').value.trim();
  const role = document.getElementById('portalRole').value;
  const startTime = document.getElementById('portalStart').value;
  const endTime = document.getElementById('portalEnd').value;

  if (!date || !taskName || !startTime || !endTime) {
    showLocalStatus('portalStatus', 'âš ï¸ Please fill in all fields', 'error'); return;
  }
  if (startTime >= endTime) {
    showLocalStatus('portalStatus', 'âš ï¸ End time must be after start time', 'error'); return;
  }

  try {
    const employeeId = await getEmployeeIdByName(currentUser.display_name, true);
    const taskId = await getTaskIdByName(taskName, true);
    const startISO = toCSTISOString(date, startTime);
    const endISO = toCSTISOString(date, endTime);
    const { error } = await supabaseClient.from('task_time_logs').insert({
      employee_id: employeeId, task_id: taskId, role,
      start_time: startISO, end_time: endISO, date
    });
    if (error) throw error;
    showLocalStatus('portalStatus', 'âœ… Task saved!', 'success');
    document.getElementById('portalTaskName').value = '';
    document.getElementById('portalStart').value = '';
    document.getElementById('portalEnd').value = '';
    loadPortalTasks();
  } catch (e) {
    console.error(e);
    showLocalStatus('portalStatus', 'âŒ Error saving task: ' + e.message, 'error');
  }
}

async function loadPortalTasks() {
  const name = currentUser.display_name;
  const today = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
  const sevenDaysAgo = new Date(Date.now() - 7 * 86400000).toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });

  try {
    const empId = await getEmployeeIdByName(name, false);
    if (!empId) {
      document.getElementById('portalTasksBody').innerHTML =
        '<tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">No tasks yet â€” log your first task above!</td></tr>';
      return;
    }

    const { data: logs } = await supabaseClient.from('task_time_logs').select('*')
      .eq('employee_id', empId).gte('date', sevenDaysAgo).order('date', { ascending: false }).order('start_time', { ascending: false });

    const taskMap = await getTaskMap();

    // Compute portal stats (today only)
    const todayLogs = (logs || []).filter(l => l.date === today && l.start_time && l.end_time);
    let workedMin = 0, gapMin = 0;
    const sortedToday = [...todayLogs].sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
    let lastEnd = null;
    sortedToday.forEach(l => {
      const dur = (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60);
      if (dur > 0) workedMin += dur;
      if (lastEnd) {
        const rawGap = (new Date(l.start_time) - new Date(lastEnd)) / (1000 * 60);
        if (rawGap >= 1) {
          const { untaskMin } = calcGapBreakdown(lastEnd, l.start_time, today);
          gapMin += untaskMin;
        }
      }
      lastEnd = l.end_time;
    });

    // Get today's schedule for productivity
    const { data: sched } = await supabaseClient.from('employee_schedules').select('*')
      .eq('employee_name', name).eq('schedule_date', today).limit(1);
    const schedMin = sched && sched[0] ? calculateHours(sched[0].start_time, sched[0].end_time) : 0;
    const breakMin = sched && sched[0] ? (sched[0].break_minutes || 60) : 60;
    const effectiveSched = schedMin - breakMin;
    const prod = effectiveSched > 0 ? Math.round((workedMin / effectiveSched) * 100) : null;

    document.getElementById('pStatTasks').textContent = todayLogs.length;
    document.getElementById('pStatWorked').textContent = formatTime(workedMin);
    document.getElementById('pStatUntask').textContent = formatTime(gapMin);
    document.getElementById('pStatProd').textContent = prod !== null ? prod + '%' : 'â€”';

    // Build task rows
    if (!logs || logs.length === 0) {
      document.getElementById('portalTasksBody').innerHTML =
        '<tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">No tasks in the last 7 days</td></tr>';
      return;
    }

    let html = '';
    logs.forEach(log => {
      const tName = taskMap[log.task_id] || 'â€”';
      const isUntask = tName.toUpperCase().includes('UNTASK');
      const dur = log.start_time && log.end_time
        ? formatTime((new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60)) : 'â€”';
      const rowClass = isUntask ? 'class="untask-row"' : '';
      html += `<tr ${rowClass}>
        <td>${formatDate(log.date)}</td>
        <td>${tName}</td>
        <td><span class="badge badge-info">${log.role || 'â€”'}</span></td>
        <td>${formatDateTime(log.start_time)}</td>
        <td>${log.end_time ? formatDateTime(log.end_time) : '<span class="badge badge-warning">OPEN</span>'}</td>
        <td><strong>${dur}</strong></td>
        <td>${isUntask ? '<span class="badge badge-untask">â¸ Untask</span>' : '<span class="badge badge-success">âœ… Task</span>'}</td>
      </tr>`;
    });
    document.getElementById('portalTasksBody').innerHTML = html;
  } catch (e) {
    console.error(e);
    document.getElementById('portalTasksBody').innerHTML =
      '<tr><td colspan="7" style="text-align:center;padding:24px;color:#e53e3e;">Error loading tasks</td></tr>';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCHEDULE MANAGEMENT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function addSchedule() {
  const date = document.getElementById('scheduleDate').value;
  const employee = document.getElementById('scheduleEmployee').value;
  const role = document.getElementById('scheduleRole').value;
  const startTime = document.getElementById('scheduleStart').value;
  const endTime = document.getElementById('scheduleEnd').value;
  if (!date || !employee || !startTime || !endTime) { showLocalStatus('scheduleStatus', 'âš ï¸ Fill all fields', 'error'); return; }
  if (startTime >= endTime) { showLocalStatus('scheduleStatus', 'âš ï¸ End must be after start', 'error'); return; }
  try {
    await getEmployeeIdByName(employee, true);
    const { error } = await supabaseClient.from('employee_schedules').insert({ employee_name: employee, role, schedule_date: date, start_time: startTime, end_time: endTime, break_minutes: 60 });
    if (error) throw error;
    showLocalStatus('scheduleStatus', 'âœ… Schedule added!', 'success');
    loadSchedules();
  } catch (e) { showLocalStatus('scheduleStatus', 'âŒ Error: ' + e.message, 'error'); }
}

async function loadSchedules() {
  try {
    const { data, error } = await supabaseClient.from('employee_schedules').select('*').order('schedule_date', { ascending: false }).limit(50);
    if (error) throw error;
    const container = document.getElementById('scheduleList');
    if (!data || data.length === 0) { container.innerHTML = '<p style="color:#718096;text-align:center;padding:24px;">No schedules found</p>'; return; }
    let html = '<table class="schedule-table"><thead><tr><th>Date</th><th>Employee</th><th>Role</th><th>Hours</th><th>Duration</th><th>Break</th><th>Action</th></tr></thead><tbody>';
    data.forEach(s => {
      const dur = calculateHours(s.start_time, s.end_time);
      html += `<tr><td>${formatDate(s.schedule_date)}</td><td><strong>${s.employee_name}</strong></td><td><span class="badge badge-info">${s.role}</span></td><td>${s.start_time} â€“ ${s.end_time}</td><td>${formatTime(dur)}</td><td>${s.break_minutes}m</td><td><button class="danger" onclick="deleteSchedule('${s.id}')" style="padding:5px 10px;font-size:12px;">Delete</button></td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) { document.getElementById('scheduleList').innerHTML = '<p style="color:#e53e3e;text-align:center;padding:24px;">Error loading schedules</p>'; }
}

async function deleteSchedule(id) {
  if (!confirm('Delete this schedule?')) return;
  const { error } = await supabaseClient.from('employee_schedules').delete().eq('id', id);
  if (!error) { showLocalStatus('scheduleStatus', 'âœ… Deleted', 'success'); loadSchedules(); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  REAL-TIME TASK LOGGING (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let activeTaskId = null, activeTaskInterval = null, activeTaskStartTime = null;

async function startTask() {
  const employee = document.getElementById('taskEmployee').value;
  const role = document.getElementById('taskRole').value;
  const taskName = document.getElementById('taskName').value.trim();
  if (!employee || !taskName) { showLocalStatus('taskStatus', 'âš ï¸ Select employee and enter task name', 'error'); return; }
  try {
    const dateStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
    const timeStr = new Date().toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0, 5);
    const startISO = toCSTISOString(dateStr, timeStr);
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskId = await getTaskIdByName(taskName, true);
    const { data: log, error } = await supabaseClient.from('task_time_logs').insert({ employee_id: employeeId, task_id: taskId, role, start_time: startISO, date: dateStr }).select().single();
    if (error) throw error;
    activeTaskId = log.id;
    activeTaskStartTime = new Date();
    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;
    document.getElementById('activeTaskDisplay').textContent = `${employee} â€” ${taskName} (${role})`;
    document.getElementById('activeTaskInfo').classList.remove('hidden');
    activeTaskInterval = setInterval(() => {
      const e = Math.floor((new Date() - activeTaskStartTime) / 1000);
      const h = Math.floor(e / 3600), m = Math.floor((e % 3600) / 60), s = e % 60;
      document.getElementById('taskTimer').textContent = `Elapsed: ${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }, 1000);
    showLocalStatus('taskStatus', 'âœ… Task started!', 'success');
  } catch (e) { showLocalStatus('taskStatus', 'âŒ Error: ' + e.message, 'error'); }
}

async function stopTask() {
  if (!activeTaskId) return;
  try {
    const now = new Date();
    const dateStr = now.toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
    const timeStr = now.toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0, 5);
    const endISO = toCSTISOString(dateStr, timeStr);
    await supabaseClient.from('task_time_logs').update({ end_time: endISO }).eq('id', activeTaskId);
    clearInterval(activeTaskInterval);
    activeTaskId = null;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('activeTaskInfo').classList.add('hidden');
    document.getElementById('taskName').value = '';
    showLocalStatus('taskStatus', 'âœ… Task completed!', 'success');
  } catch (e) { showLocalStatus('taskStatus', 'âŒ Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ALL TASKS (admin)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// Default shift end: 8:30 PM CST
const DEFAULT_SHIFT_END = '20:30';

// Build a fake ISO string for a date+time in CST for comparison
function toCST_ISO(dateStr, timeStr) {
  return `${dateStr}T${timeStr}:00-06:00`;
}

// Generate inline gap rows (UNTASK / BREAK) between two timestamps on the same date
function buildGapRows(dateStr, empName, gapStartISO, gapEndISO) {
  const rows = [];
  const gapStart = new Date(gapStartISO);
  const gapEnd   = new Date(gapEndISO);
  const totalMin = (gapEnd - gapStart) / (1000 * 60);
  if (totalMin < 1) return rows;

  const breakS = new Date(toCST_ISO(dateStr, '15:00'));
  const breakE = new Date(toCST_ISO(dateStr, '16:00'));

  // Overlap with break window
  const oStart = Math.max(gapStart.getTime(), breakS.getTime());
  const oEnd   = Math.min(gapEnd.getTime(),   breakE.getTime());
  const breakMin = Math.max(0, (oEnd - oStart) / (1000 * 60));

  // Segment 1: before break
  if (gapStart < breakS && breakMin > 0) {
    const seg = (Math.min(gapEnd, breakS) - gapStart) / (1000 * 60);
    if (seg >= 1) rows.push({ type: 'UNTASK', start: gapStartISO, end: breakS.toISOString(), min: seg, emp: empName, date: dateStr });
  } else if (breakMin === 0) {
    // No break overlap at all â€” pure untask
    rows.push({ type: 'UNTASK', start: gapStartISO, end: gapEndISO, min: totalMin, emp: empName, date: dateStr });
    return rows;
  }

  // Segment 2: the break itself
  if (breakMin >= 1) {
    rows.push({ type: 'BREAK', start: breakS.toISOString(), end: breakE.toISOString(), min: breakMin, emp: empName, date: dateStr });
  }

  // Segment 3: after break
  if (gapEnd > breakE && breakMin > 0) {
    const seg = (gapEnd - Math.max(gapStart, breakE)) / (1000 * 60);
    if (seg >= 1) rows.push({ type: 'UNTASK', start: breakE.toISOString(), end: gapEndISO, min: seg, emp: empName, date: dateStr });
  }

  return rows;
}

function renderGapRow(seg, dateStr) {
  const isBreak = seg.type === 'BREAK';
  const bg    = isBreak ? 'background:#fff0f0;' : 'background:#fff7ed;';
  const badge = isBreak
    ? '<span class="badge badge-danger">â˜• Break</span>'
    : '<span class="badge badge-untask">â¸ Untask</span>';
  const icon  = isBreak ? 'â˜•' : 'â¸';
  return `<tr style="${bg}font-style:italic;color:#92400e;">
    <td>${formatDate(dateStr)}</td>
    <td><strong>${seg.emp}</strong></td>
    <td style="color:${isBreak ? '#c53030' : '#9c4221'};font-weight:600;">${icon} ${seg.type === 'BREAK' ? 'BREAK TIME' : 'NO TASK ASSIGNED'}</td>
    <td><span class="badge" style="background:#e2e8f0;color:#4a5568;">â€”</span></td>
    <td>${formatDateTime(seg.start)}</td>
    <td>${formatDateTime(seg.end)}</td>
    <td><strong>${formatTime(seg.min)}</strong></td>
    <td>${badge}</td>
    <td><span class="badge" style="background:#fef3c7;color:#92400e;">Auto</span></td>
    <td>â€”</td>
  </tr>`;
}

async function loadAllTasks() {
  const employeeName = document.getElementById('allTasksEmployee').value;
  const startDate    = document.getElementById('allTasksStartDate').value;
  const endDate      = document.getElementById('allTasksEndDate').value;
  const role         = document.getElementById('allTasksRole').value;
  const statusFilter = (document.getElementById('allTasksStatus')?.value || '').toLowerCase();
  const tbody        = document.getElementById('allTasksTableBody');
  tbody.innerHTML    = '<tr><td colspan="10" style="text-align:center;padding:24px;">Loading...</td></tr>';

  try {
    let q = supabaseClient.from('task_time_logs').select('*');
    if (startDate) q = q.gte('date', startDate);
    if (endDate)   q = q.lte('date', endDate);
    if (role)      q = q.eq('role', role);
    if (employeeName) {
      const empId = await getEmployeeIdByName(employeeName, false);
      if (!empId) { tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>'; return; }
      q = q.eq('employee_id', empId);
    }

    const { data: logs, error } = await q;
    if (error) throw error;
    if (!logs || logs.length === 0) {
      document.getElementById('allTasksCount').textContent = '0 tasks';
      tbody.innerHTML = '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>';
      return;
    }

    const [empMap, taskMap, { data: schedules }] = await Promise.all([
      getEmployeeMap(), getTaskMap(),
      supabaseClient.from('employee_schedules').select('employee_name, schedule_date, end_time')
    ]);

    // Enrich and filter only completed tasks
    const enriched = logs.map(l => ({
      ...l,
      _emp:  empMap[l.employee_id] || '?',
      _task: taskMap[l.task_id]    || 'N/A'
    })).filter(l => l.start_time && l.end_time);

    // Sort: date DESC, employee ASC, start_time ASC within same group
    enriched.sort((a, b) => {
      if (a.date !== b.date) return a.date > b.date ? -1 : 1;
      if (a._emp !== b._emp) return a._emp.localeCompare(b._emp);
      return new Date(a.start_time) - new Date(b.start_time);
    });

    // Group by date|emp
    const groups = new Map();
    enriched.forEach(l => {
      const key = `${l.date}|${l._emp}`;
      if (!groups.has(key)) groups.set(key, []);
      groups.get(key).push(l);
    });

    // Build schedule end-time lookup
    const schedEnd = {};
    (schedules || []).forEach(s => {
      const et = (s.end_time || DEFAULT_SHIFT_END).substring(0, 5);
      schedEnd[`${s.employee_name}|${s.schedule_date}`] = et;
    });

    let html = '';
    let totalRealTasks = 0;

    for (const [key, group] of groups) {
      const [dateStr, empName] = key.split('|');
      group.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));
      totalRealTasks += group.length;

      for (let i = 0; i < group.length; i++) {
        const log = group[i];

        // â”€â”€ Gap BEFORE this task â”€â”€
        if (i > 0) {
          const prev = group[i - 1];
          const gapMin = (new Date(log.start_time) - new Date(prev.end_time)) / (1000 * 60);
          if (gapMin >= 1 && statusFilter !== 'done') {
            buildGapRows(dateStr, empName, prev.end_time, log.start_time)
              .forEach(seg => { html += renderGapRow(seg, dateStr); });
          }
        }

        // â”€â”€ Real task row â”€â”€
        if (statusFilter !== 'auto') {
          const dur = formatTime((new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60));
          html += `<tr>
            <td>${formatDate(log.date)}</td>
            <td><strong>${log._emp}</strong></td>
            <td>${log._task}</td>
            <td><span class="badge badge-info">${log.role || 'â€”'}</span></td>
            <td>${formatDateTime(log.start_time)}</td>
            <td>${formatDateTime(log.end_time)}</td>
            <td><strong>${dur}</strong></td>
            <td><span class="badge badge-purple">ğŸ“ Task</span></td>
            <td><span class="badge badge-success">Done</span></td>
            <td style="display:flex;gap:6px;">
              <button class="secondary" onclick="openEditTaskModal('${log.id}')" style="padding:5px 10px;font-size:12px;">âœï¸</button>
              <button class="danger" onclick="deleteTask('${log.id}')" style="padding:5px 10px;font-size:12px;">ğŸ—‘</button>
            </td>
          </tr>`;
        }

        // â”€â”€ Gap AFTER last task â†’ shift end â”€â”€
        if (i === group.length - 1 && statusFilter !== 'done') {
          const shiftEndTime = schedEnd[`${empName}|${dateStr}`] || DEFAULT_SHIFT_END;
          const shiftEndISO  = toCST_ISO(dateStr, shiftEndTime);
          const afterMin     = (new Date(shiftEndISO) - new Date(log.end_time)) / (1000 * 60);
          if (afterMin >= 1) {
            buildGapRows(dateStr, empName, log.end_time, shiftEndISO)
              .forEach(seg => { html += renderGapRow(seg, dateStr); });
          }
        }
      }
    }

    document.getElementById('allTasksCount').textContent = `${totalRealTasks} tasks`;
    tbody.innerHTML = html || '<tr><td colspan="10" style="text-align:center;padding:24px;color:#718096;">No tasks found</td></tr>';

  } catch (e) {
    tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:24px;color:#e53e3e;">Error: ${e.message}</td></tr>`;
  }
}

async function openEditTaskModal(taskId) {
  try {
    const { data: log, error } = await supabaseClient.from('task_time_logs').select('*').eq('id', taskId).single();
    if (error) throw error;
    const [empMap, taskMap] = await Promise.all([getEmployeeMap(), getTaskMap()]);
    document.getElementById('editTaskId').value = log.id;
    document.getElementById('editTaskEmployee').value = empMap[log.employee_id] || '';
    document.getElementById('editTaskDate').value = log.date || '';
    document.getElementById('editTaskRole').value = log.role || '';
    document.getElementById('editTaskName').value = taskMap[log.task_id] || '';
    document.getElementById('editTaskStart').value = log.start_time ? new Date(log.start_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }) : '';
    document.getElementById('editTaskEnd').value = log.end_time ? new Date(log.end_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' }) : '';
    document.getElementById('editTaskModal').classList.add('active');
  } catch (e) { alert('Error loading task: ' + e.message); }
}
function closeEditTaskModal() { document.getElementById('editTaskModal').classList.remove('active'); }

async function saveEditedTask() {
  const id = document.getElementById('editTaskId').value;
  const employee = document.getElementById('editTaskEmployee').value;
  const date = document.getElementById('editTaskDate').value;
  const role = document.getElementById('editTaskRole').value;
  const taskName = document.getElementById('editTaskName').value;
  const startTime = document.getElementById('editTaskStart').value;
  const endTime = document.getElementById('editTaskEnd').value;
  if (!id || !employee || !date || !taskName || !startTime) { alert('Fill all required fields'); return; }
  try {
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskIdDb = await getTaskIdByName(taskName, true);
    const update = { employee_id: employeeId, task_id: taskIdDb, role, start_time: toCSTISOString(date, startTime), date };
    if (endTime) update.end_time = toCSTISOString(date, endTime); else update.end_time = null;
    const { error } = await supabaseClient.from('task_time_logs').update(update).eq('id', id);
    if (error) throw error;
    alert('Task updated!');
    closeEditTaskModal();
    loadAllTasks();
  } catch (e) { alert('Error: ' + e.message); }
}

async function deleteTask(taskId) {
  if (!confirm('Delete this task?')) return;
  const { error } = await supabaseClient.from('task_time_logs').delete().eq('id', taskId);
  if (!error) { showGlobalStatus('âœ… Task deleted', 'success'); loadAllTasks(); }
  else alert('Error: ' + error.message);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BATCH ENTRY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let batchRowCount = 0;
function addBatchRow() {
  batchRowCount++;
  const div = document.createElement('div');
  div.id = `batchRow${batchRowCount}`;
  div.className = 'time-entry';
  div.innerHTML = `
    <input type="time" class="batchStart" placeholder="Start">
    <input type="time" class="batchEnd" placeholder="End">
    <input type="text" class="batchTask" placeholder="Task name">
    <select class="batchRole">
      <option>Kitchen Prep</option><option>Line Cook</option><option>Fryer</option><option>Dishwasher</option>
    </select>
    <button onclick="removeBatchRow(${batchRowCount})" class="danger" style="padding:7px;">âœ•</button>`;
  document.getElementById('batchRows').appendChild(div);
}
function removeBatchRow(id) { document.getElementById(`batchRow${id}`)?.remove(); }
function clearBatchRows() { document.getElementById('batchRows').innerHTML = ''; batchRowCount = 0; }

async function saveBatchTasks() {
  const date = document.getElementById('batchDate').value;
  const employee = document.getElementById('batchEmployee').value;
  if (!date || !employee) { showLocalStatus('batchStatus', 'âš ï¸ Select date and employee', 'error'); return; }
  const rows = document.querySelectorAll('#batchRows > div');
  if (!rows.length) { showLocalStatus('batchStatus', 'âš ï¸ Add at least one task', 'error'); return; }
  try {
    const employeeId = await getEmployeeIdByName(employee, true);
    let saved = 0;
    for (const row of rows) {
      const s = row.querySelector('.batchStart').value;
      const e = row.querySelector('.batchEnd').value;
      const n = row.querySelector('.batchTask').value;
      const r = row.querySelector('.batchRole').value;
      if (!s || !e || !n) continue;
      const taskId = await getTaskIdByName(n, true);
      const { error } = await supabaseClient.from('task_time_logs').insert({ employee_id: employeeId, task_id: taskId, role: r, start_time: toCSTISOString(date, s), end_time: toCSTISOString(date, e), date });
      if (error) throw error;
      saved++;
    }
    showLocalStatus('batchStatus', `âœ… Saved ${saved} tasks!`, 'success');
    clearBatchRows();
  } catch (e) { showLocalStatus('batchStatus', 'âŒ Error: ' + e.message, 'error'); }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ANALYTICS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let hoursChart = null;

// Standard break window: 3:00 PM â€“ 4:00 PM CST for full-day employees
const BREAK_WINDOW_START = 15; // 15:00 CST
const BREAK_WINDOW_END   = 16; // 16:00 CST

/**
 * Given a raw gap (gapStartISO â†’ gapEndISO), subtract any overlap
 * with the standard break window (3â€“4 PM CST) and return:
 *   { untaskMin, breakMin }
 */
function calcGapBreakdown(gapStartISO, gapEndISO, dateStr) {
  const gapStart   = new Date(gapStartISO);
  const gapEnd     = new Date(gapEndISO);
  const totalGap   = (gapEnd - gapStart) / (1000 * 60);
  if (totalGap < 1) return { untaskMin: 0, breakMin: 0 };

  // Build 3 PM and 4 PM boundaries for this date in CST (UTC-6)
  const breakStart = new Date(`${dateStr}T${String(BREAK_WINDOW_START).padStart(2,'0')}:00:00-06:00`);
  const breakEnd   = new Date(`${dateStr}T${String(BREAK_WINDOW_END).padStart(2,'0')}:00:00-06:00`);

  // Overlap between gap and break window
  const overlapStart = Math.max(gapStart.getTime(), breakStart.getTime());
  const overlapEnd   = Math.min(gapEnd.getTime(),   breakEnd.getTime());
  const breakMin     = Math.max(0, (overlapEnd - overlapStart) / (1000 * 60));
  const untaskMin    = Math.max(0, totalGap - breakMin);

  return { untaskMin, breakMin };
}

function changeAnalyticsPeriod() {
  const p = document.getElementById('analyticsPeriod').value;
  document.getElementById('dailyDateGroup').style.display   = p === 'daily'   ? 'block' : 'none';
  document.getElementById('weeklyDateGroup').style.display  = p === 'weekly'  ? 'block' : 'none';
  document.getElementById('monthlyDateGroup').style.display = p === 'monthly' ? 'block' : 'none';
  document.getElementById('customDateGroup').style.display  = p === 'custom'  ? 'block' : 'none';
  document.getElementById('customEndGroup').style.display   = p === 'custom'  ? 'block' : 'none';
}

async function loadAnalytics() {
  const period = document.getElementById('analyticsPeriod').value;
  const selEmp = document.getElementById('analyticsEmployee').value;
  let startDate, endDate, displayText;

  if (period === 'daily') {
    startDate = endDate = document.getElementById('analyticsDate').value;
    displayText = `Daily â€” ${formatDate(startDate)}`;
  } else if (period === 'weekly') {
    startDate = document.getElementById('analyticsWeek').value;
    const we = new Date(startDate); we.setDate(we.getDate() + 6);
    endDate = we.toISOString().split('T')[0];
    displayText = `Weekly â€” ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else if (period === 'monthly') {
    const month = document.getElementById('analyticsMonth').value;
    startDate = `${month}-01`;
    const ld = new Date(+month.split('-')[0], +month.split('-')[1], 0).getDate();
    endDate = `${month}-${String(ld).padStart(2,'0')}`;
    displayText = `Monthly â€” ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else {
    startDate = document.getElementById('analyticsStart').value;
    endDate   = document.getElementById('analyticsEnd').value;
    displayText = `${formatDate(startDate)} to ${formatDate(endDate)}`;
  }
  if (!startDate) { showGlobalStatus('âš ï¸ Select a date first', 'error'); return; }
  if (selEmp) displayText += ` | ${selEmp}`;
  document.getElementById('currentPeriodDisplay').textContent = displayText;

  try {
    let schedQ = supabaseClient.from('employee_schedules').select('*').gte('schedule_date', startDate).lte('schedule_date', endDate);
    let logsQ  = supabaseClient.from('task_time_logs').select('*').gte('date', startDate).lte('date', endDate);
    if (selEmp) {
      schedQ = schedQ.eq('employee_name', selEmp);
      const eid = await getEmployeeIdByName(selEmp, false);
      logsQ = eid ? logsQ.eq('employee_id', eid) : logsQ.eq('employee_id', '00000000-0000-0000-0000-000000000000');
    }

    const [
      { data: schedules, error: sE },
      { data: logs, error: lE },
      empMap, taskMap
    ] = await Promise.all([schedQ, logsQ, getEmployeeMap(), getTaskMap()]);
    if (sE) throw sE; if (lE) throw lE;

    let totalSched = 0, totalWorked = 0, totalBreak = 0, totalUntask = 0, totalTasks = 0;
    const empStats = {};
    const untaskDetails = [];

    // â”€â”€ Schedules â”€â”€
    (schedules || []).forEach(s => {
      const dur = calculateHours(s.start_time, s.end_time);
      totalSched += dur;
      totalBreak += s.break_minutes || 60;
      if (!empStats[s.employee_name]) empStats[s.employee_name] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
      empStats[s.employee_name].scheduled += dur;
      empStats[s.employee_name].break += s.break_minutes || 60;
    });

    // â”€â”€ Logs + Gap (Untask) Calculation â”€â”€
    if (logs && logs.length) {
      const enriched = (logs || []).map(l => ({
        ...l,
        _emp: empMap[l.employee_id] || 'Unknown',
        _task: taskMap[l.task_id] || 'Unknown'
      })).filter(l => l.start_time && l.end_time);

      enriched.sort((a, b) => {
        if (a._emp  !== b._emp)  return a._emp.localeCompare(b._emp);
        if ((a.date||'') !== (b.date||'')) return (a.date||'').localeCompare(b.date||'');
        return new Date(a.start_time) - new Date(b.start_time);
      });

      // Build schedule end-time lookup for end-of-shift gap
      const schedEndMap = {};
      (schedules || []).forEach(s => {
        const et = (s.end_time || DEFAULT_SHIFT_END).substring(0, 5);
        schedEndMap[`${s.employee_name}|${s.schedule_date}`] = et;
      });

      // Group by date|emp (date FIRST so split [dateStr, empName] is correct)
      const analyticsGroups = new Map();
      enriched.forEach(l => {
        const key = `${l.date}|${l._emp}`;
        if (!analyticsGroups.has(key)) analyticsGroups.set(key, []);
        analyticsGroups.get(key).push(l);
      });

      for (const [key, group] of analyticsGroups) {
        const [dateStr, empName] = key.split('|');
        group.sort((a, b) => new Date(a.start_time) - new Date(b.start_time));

        // Worked time
        group.forEach(log => {
          const dur = (new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60);
          if (dur > 0) {
            totalWorked += dur; totalTasks++;
            if (!empStats[empName]) empStats[empName] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
            empStats[empName].worked += dur;
            empStats[empName].tasks++;
          }
        });

        // Gaps between consecutive tasks
        for (let i = 1; i < group.length; i++) {
          const prev = group[i - 1];
          const curr = group[i];
          const rawGap = (new Date(curr.start_time) - new Date(prev.end_time)) / (1000 * 60);
          if (rawGap < 1) continue;
          const segs = buildGapRows(dateStr, empName, prev.end_time, curr.start_time);
          segs.forEach(seg => {
            if (!empStats[empName]) empStats[empName] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
            if (seg.type === 'UNTASK') {
              totalUntask += seg.min;
              empStats[empName].untask += seg.min;
              untaskDetails.push({ employee: empName, date: dateStr, gapStart: seg.start, gapEnd: seg.end, duration: seg.min, nextTask: curr._task });
            } else if (seg.type === 'BREAK') {
              if (!(schedules||[]).some(s => s.employee_name === empName && s.schedule_date === dateStr)) {
                totalBreak += seg.min;
                empStats[empName].break += seg.min;
              }
            }
          });
        }

        // End-of-shift gap: last task â†’ shift end
        const lastLog      = group[group.length - 1];
        const shiftEndTime = schedEndMap[`${empName}|${dateStr}`] || DEFAULT_SHIFT_END;
        const shiftEndISO  = toCST_ISO(dateStr, shiftEndTime);
        const afterMin     = (new Date(shiftEndISO) - new Date(lastLog.end_time)) / (1000 * 60);
        if (afterMin >= 1) {
          const segs = buildGapRows(dateStr, empName, lastLog.end_time, shiftEndISO);
          segs.forEach(seg => {
            if (!empStats[empName]) empStats[empName] = { scheduled: 0, worked: 0, break: 0, untask: 0, tasks: 0 };
            if (seg.type === 'UNTASK') {
              totalUntask += seg.min;
              empStats[empName].untask += seg.min;
              untaskDetails.push({ employee: empName, date: dateStr, gapStart: seg.start, gapEnd: seg.end, duration: seg.min, nextTask: 'ğŸ End of Shift (' + shiftEndTime + ')' });
            } else if (seg.type === 'BREAK') {
              if (!(schedules||[]).some(s => s.employee_name === empName && s.schedule_date === dateStr)) {
                totalBreak += seg.min;
                empStats[empName].break += seg.min;
              }
            }
          });
        }
      }
    }

    // â”€â”€ Update KPI cards â”€â”€
    const effectiveSched = Math.max(0, totalSched - totalBreak);
    const productivity = effectiveSched > 0 ? Math.round((totalWorked / effectiveSched) * 100) : null;

    document.getElementById('totalScheduled').textContent   = formatTime(totalSched);
    document.getElementById('totalWorked').textContent      = formatTime(totalWorked);
    document.getElementById('totalUnlogged').textContent    = formatTime(totalUntask);
    document.getElementById('totalBreak').textContent       = formatTime(totalBreak);
    document.getElementById('totalProductivity').textContent = productivity !== null ? productivity + '%' : 'â€”';
    document.getElementById('totalTasks').textContent       = totalTasks;

    renderEmployeeBreakdown(empStats);
    renderUntaskLog(untaskDetails);
    updateHoursChart(empStats);

  } catch (e) {
    console.error(e);
    showGlobalStatus('Analytics error: ' + e.message, 'error');
  }
}

function renderEmployeeBreakdown(empStats) {
  const names = Object.keys(empStats || {});
  const tbody = document.getElementById('employeeBreakdown');
  if (!names.length) { tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;padding:24px;color:#718096;">No data</td></tr>'; return; }
  let html = '';
  names.forEach(name => {
    const s = empStats[name];
    const eff = Math.max(0, (s.scheduled || 0) - (s.break || 0));
    const prod = eff > 0 ? Math.round(((s.worked || 0) / eff) * 100) : null;
    const prodColor = prod === null ? '#718096' : prod >= 80 ? '#065f46' : prod >= 60 ? '#92400e' : '#991b1b';
    const prodBg    = prod === null ? '#f8fafc' : prod >= 80 ? '#d1fae5' : prod >= 60 ? '#fef3c7' : '#fee2e2';
    html += `<tr>
      <td><strong>${name}</strong></td>
      <td>${formatTime(s.scheduled || 0)}</td>
      <td>${formatTime(s.worked || 0)}</td>
      <td>${formatTime(s.break || 0)}</td>
      <td><span class="badge badge-warning">${formatTime(s.untask || 0)}</span></td>
      <td>${s.tasks || 0}</td>
      <td><span style="font-weight:700;color:${prodColor};background:${prodBg};padding:3px 10px;border-radius:10px;font-size:13px;">${prod !== null ? prod + '%' : 'â€”'}</span></td>
    </tr>`;
  });
  tbody.innerHTML = html;
}

function renderUntaskLog(details) {
  const tbody = document.getElementById('unloggedLogBody');
  if (!details || !details.length) {
    tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:24px;color:#718096;">No untask gaps found â€” great productivity!</td></tr>';
    return;
  }

  // Restore original 6-column header
  const thead = tbody.closest('table').querySelector('thead tr');
  if (thead) {
    thead.innerHTML = '<th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th>';
  }

  details.sort((a, b) => (a.date > b.date ? -1 : 1) || a.employee.localeCompare(b.employee));
  let html = '';
  details.forEach(row => {
    const isEndOfShift = row.nextTask.includes('End of Shift');
    html += `<tr class="untask-row">
      <td>${formatDate(row.date)}</td>
      <td><strong>${row.employee}</strong></td>
      <td>${formatDateTime(row.gapStart)}</td>
      <td>${formatDateTime(row.gapEnd)}</td>
      <td><strong class="badge badge-warning">${formatTime(row.duration)}</strong></td>
      <td style="color:${isEndOfShift ? '#c05621' : '#718096'};font-size:12px;font-weight:${isEndOfShift ? '700' : '400'};">â†’ ${row.nextTask}</td>
    </tr>`;
  });
  tbody.innerHTML = html;
}

function updateHoursChart(empStats) {
  const canvas = document.getElementById('hoursChart');
  if (!canvas) return;
  if (hoursChart) hoursChart.destroy();
  const labels = Object.keys(empStats || {});
  if (!labels.length) return;
  hoursChart = new Chart(canvas.getContext('2d'), {
    type: 'bar',
    data: {
      labels,
      datasets: [
        { label: 'Scheduled', data: labels.map(k => +(empStats[k].scheduled / 60).toFixed(2)), backgroundColor: 'rgba(44,82,130,0.75)', borderColor: '#2c5282', borderWidth: 2 },
        { label: 'Worked',    data: labels.map(k => +(empStats[k].worked / 60).toFixed(2)),    backgroundColor: 'rgba(34,197,94,0.75)',  borderColor: '#16a34a', borderWidth: 2 },
        { label: 'Untask',    data: labels.map(k => +(empStats[k].untask / 60).toFixed(2)),    backgroundColor: 'rgba(245,158,11,0.75)', borderColor: '#d97706', borderWidth: 2 },
        { label: 'Break',     data: labels.map(k => +(empStats[k].break / 60).toFixed(2)),     backgroundColor: 'rgba(239,68,68,0.55)',  borderColor: '#dc2626', borderWidth: 2 },
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      scales: { y: { beginAtZero: true, title: { display: true, text: 'Hours' }, ticks: { callback: v => v + 'h' } } },
      plugins: { legend: { position: 'top' } }
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  SCHEDULE VS ACTUAL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadSchedVsActual() {
  const date = document.getElementById('svaDate').value;
  const emp  = document.getElementById('svaEmployee').value;
  if (!date) { showGlobalStatus('âš ï¸ Select a date', 'error'); return; }
  const container = document.getElementById('svaContent');
  container.innerHTML = '<p style="text-align:center;padding:24px;color:#718096;">Loading...</p>';
  try {
    let schedQ = supabaseClient.from('employee_schedules').select('*').eq('schedule_date', date);
    let logsQ  = supabaseClient.from('task_time_logs').select('*').eq('date', date);
    if (emp) { schedQ = schedQ.eq('employee_name', emp); const eid = await getEmployeeIdByName(emp, false); if (eid) logsQ = logsQ.eq('employee_id', eid); }
    const [{ data: scheds }, { data: logs }, empMap, taskMap] = await Promise.all([schedQ, logsQ, getEmployeeMap(), getTaskMap()]);

    const empNames = [...new Set([...(scheds||[]).map(s=>s.employee_name), ...(logs||[]).map(l=>empMap[l.employee_id]||'').filter(Boolean)])].sort();
    if (!empNames.length) { container.innerHTML = '<p style="color:#718096;text-align:center;padding:40px;">No data for this date</p>'; return; }

    let html = '<table class="schedule-table"><thead><tr><th>Employee</th><th>Scheduled</th><th>Sched Hours</th><th>Worked Hours</th><th>Untask</th><th>Difference</th><th>Status</th></tr></thead><tbody>';
    empNames.forEach(name => {
      const s = (scheds||[]).find(sc => sc.employee_name === name);
      const empId = Object.keys(empMap).find(k => empMap[k] === name);
      const empLogs = (logs||[]).filter(l => l.employee_id === empId && l.start_time && l.end_time);
      const schedMin = s ? calculateHours(s.start_time, s.end_time) : 0;
      const workedMin = empLogs.reduce((sum, l) => sum + (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60), 0);
      const diff = workedMin - schedMin;
      const diffStr = (diff >= 0 ? '+' : '') + formatTime(Math.abs(diff));
      const color = diff >= 0 ? '#065f46' : '#991b1b';
      const status = diff >= 0 ? '<span class="badge badge-success">âœ… On Track</span>' : '<span class="badge badge-danger">âš ï¸ Under</span>';
      html += `<tr><td><strong>${name}</strong></td><td>${s ? s.start_time + ' â€“ ' + s.end_time : 'â€”'}</td><td>${formatTime(schedMin)}</td><td>${formatTime(workedMin)}</td><td>â€”</td><td style="font-weight:700;color:${color};">${diffStr}</td><td>${status}</td></tr>`;
    });
    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (e) { container.innerHTML = `<p style="color:#e53e3e;text-align:center;padding:40px;">Error: ${e.message}</p>`; }
}

</script>
</body>
</html>
