<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitchen Workforce Management - Complete System</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
* {
box-sizing: border-box;
margin: 0;
padding: 0;
}
body {
font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
background-color: #f5f7fa;
color: #2d3748;
min-height: 100vh;
}
.container {
max-width: 1600px;
margin: 0 auto;
background: white;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.12), 0 1px 2px rgba(0, 0, 0, 0.24);
overflow: hidden;
}
header {
background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
color: white;
padding: 24px 40px;
display: flex;
justify-content: space-between;
align-items: center;
}
header h1 {
font-size: 28px;
font-weight: 700;
margin: 0;
}
.header-subtitle {
font-size: 14px;
opacity: 0.9;
margin-top: 4px;
}
.tabs {
display: flex;
background: #f8fafc;
border-bottom: 1px solid #e2e8f0;
flex-wrap: wrap;
}
.tab-btn {
flex: 1;
min-width: 140px;
padding: 16px 20px;
border: none;
background: none;
cursor: pointer;
font-size: 14px;
font-weight: 600;
color: #718096;
transition: all 0.2s;
position: relative;
}
.tab-btn:hover {
color: #2c5282;
background: #edf2f7;
}
.tab-btn.active {
color: #2c5282;
background: white;
}
.tab-btn.active::after {
content: '';
position: absolute;
bottom: 0;
left: 0;
right: 0;
height: 3px;
background: #2c5282;
}
.tab-content {
display: none;
padding: 40px;
}
.tab-content.active {
display: block;
}
.form-group {
margin-bottom: 24px;
}
label {
display: block;
margin-bottom: 8px;
font-weight: 600;
color: #4a5568;
font-size: 14px;
}
select, button, input {
width: 100%;
padding: 12px 16px;
border: 1px solid #cbd5e0;
border-radius: 6px;
font-size: 15px;
font-family: inherit;
transition: all 0.2s;
}
select:focus, button:focus, input:focus {
outline: none;
border-color: #3182ce;
box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
}
button {
background: linear-gradient(135deg, #2c5282 0%, #1a365d 100%);
color: white;
border: none;
cursor: pointer;
font-weight: 600;
font-size: 15px;
padding: 12px 24px;
border-radius: 6px;
transition: all 0.2s;
width: auto;
}
button:hover {
transform: translateY(-1px);
box-shadow: 0 4px 6px rgba(44, 82, 130, 0.2);
}
button:disabled {
background: #a0aec0;
cursor: not-allowed;
transform: none;
box-shadow: none;
}
button.secondary {
background: #e2e8f0;
color: #4a5568;
}
button.secondary:hover {
background: #cbd5e0;
}
button.success {
background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
}
button.success:hover {
box-shadow: 0 4px 6px rgba(34, 197, 94, 0.2);
}
button.danger {
background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
}
button.danger:hover {
box-shadow: 0 4px 6px rgba(239, 68, 68, 0.2);
}
button.warning {
background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
}
button.warning:hover {
box-shadow: 0 4px 6px rgba(245, 158, 11, 0.2);
}
#status {
padding: 12px 16px;
border-radius: 6px;
margin-top: 20px;
text-align: center;
font-weight: 500;
font-size: 14px;
}
.success {
background: #d1fae5;
color: #065f46;
border: 1px solid #6ee7b7;
}
.error {
background: #fee2e2;
color: #991b1b;
border: 1px solid #fca5a5;
}
.info {
background: #dbeafe;
color: #1e40af;
border: 1px solid #93c5fd;
}
.chart-container {
margin-top: 30px;
padding: 24px;
background: #f8fafc;
border-radius: 8px;
border: 1px solid #e2e8f0;
height: 350px;
}
.stats-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
gap: 20px;
margin-top: 24px;
}
.stat-card {
background: white;
padding: 20px;
border-radius: 8px;
text-align: center;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
border: 1px solid #e2e8f0;
transition: all 0.2s;
}
.stat-card:hover {
box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
transform: translateY(-2px);
}
.stat-card h3 {
font-size: 12px;
color: #718096;
margin-bottom: 10px;
font-weight: 600;
text-transform: uppercase;
letter-spacing: 0.5px;
}
.stat-card .value {
font-size: 32px;
font-weight: 700;
color: #2c5282;
line-height: 1;
margin-bottom: 4px;
}
.stat-card .subtext {
font-size: 12px;
color: #718096;
}
.stat-card.positive .value {
color: #22c55e;
}
.stat-card.negative .value {
color: #ef4444;
}
.section-title {
font-size: 20px;
font-weight: 700;
color: #2d3748;
margin-bottom: 8px;
}
.section-subtitle {
font-size: 14px;
color: #718096;
margin-bottom: 24px;
}
.card {
background: white;
border-radius: 8px;
padding: 24px;
box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
border: 1px solid #e2e8f0;
margin-bottom: 24px;
}
.action-bar {
display: flex;
gap: 12px;
margin-top: 20px;
flex-wrap: wrap;
}
.period-selector {
background: #f0f9ff;
padding: 20px;
border-radius: 8px;
border: 1px solid #bee3f8;
margin-bottom: 24px;
}
.period-selector h4 {
font-size: 14px;
color: #2c5282;
margin-bottom: 12px;
font-weight: 600;
}
.period-controls {
display: flex;
gap: 16px;
align-items: end;
flex-wrap: wrap;
}
.period-controls .form-group {
flex: 1;
min-width: 150px;
margin-bottom: 0;
}
.current-period-display {
margin-top: 12px;
padding: 12px;
background: #ebf8ff;
border-radius: 6px;
font-size: 14px;
color: #2c5282;
font-weight: 600;
}
.schedule-table {
width: 100%;
border-collapse: collapse;
margin-top: 16px;
}
.schedule-table th,
.schedule-table td {
padding: 12px;
text-align: left;
border-bottom: 1px solid #e2e8f0;
}
.schedule-table th {
background: #f8fafc;
font-weight: 600;
color: #4a5568;
}
.schedule-table tr:hover {
background: #f8fafc;
}
.badge {
display: inline-block;
padding: 4px 12px;
border-radius: 12px;
font-size: 12px;
font-weight: 600;
}
.badge.success {
background: #d1fae5;
color: #065f46;
}
.badge.warning {
background: #fef3c7;
color: #92400e;
}
.badge.danger {
background: #fee2e2;
color: #991b1b;
}
.badge.info {
background: #dbeafe;
color: #1e40af;
}
.comparison-grid {
display: grid;
grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
gap: 20px;
margin-top: 24px;
}
.comparison-card {
background: white;
border-radius: 8px;
padding: 20px;
border: 1px solid #e2e8f0;
}
.comparison-card h4 {
font-size: 15px;
color: #2d3748;
margin-bottom: 16px;
font-weight: 600;
}
.metric-row {
display: flex;
justify-content: space-between;
padding: 10px 0;
border-bottom: 1px solid #f1f5f9;
}
.metric-row:last-child {
border-bottom: none;
}
.metric-label {
color: #718096;
font-size: 14px;
}
.metric-value {
font-weight: 600;
color: #2d3748;
}
.gap-alert {
background: #fff3cd;
color: #856404;
padding: 12px;
border-radius: 6px;
margin-top: 12px;
font-size: 14px;
border: 1px solid #ffc107;
}
.employee-row {
background: #f8fafc;
padding: 16px;
border-radius: 8px;
margin-bottom: 16px;
border: 1px solid #e2e8f0;
}
.employee-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 12px;
}
.employee-name {
font-weight: 700;
color: #2d3748;
font-size: 16px;
}
.employee-role {
color: #718096;
font-size: 13px;
}
.time-entry {
display: grid;
grid-template-columns: 120px 120px 1fr 180px 50px;
gap: 12px;
align-items: center;
margin-bottom: 12px;
}
.time-entry input,
.time-entry select {
width: 100%;
}
.hidden {
display: none;
}
.task-filters {
background: #f8fafc;
padding: 20px;
border-radius: 8px;
border: 1px solid #e2e8f0;
margin-bottom: 24px;
}
.task-filters .period-controls {
display: flex;
gap: 12px;
flex-wrap: wrap;
align-items: flex-end;
}
.task-filters .form-group {
margin-bottom: 0;
flex: 1;
min-width: 180px;
}
.task-table-container {
overflow-x: auto;
background: white;
border-radius: 8px;
border: 1px solid #e2e8f0;
}
.task-actions {
display: flex;
gap: 8px;
}
.task-actions button {
padding: 6px 12px;
font-size: 13px;
width: auto;
}
.modal-overlay {
display: none;
position: fixed;
top: 0;
left: 0;
right: 0;
bottom: 0;
background: rgba(0, 0, 0, 0.5);
z-index: 2000;
align-items: center;
justify-content: center;
}
.modal-overlay.active {
display: flex;
}
.modal {
background: white;
border-radius: 12px;
padding: 32px;
max-width: 600px;
width: 90%;
max-height: 90vh;
overflow-y: auto;
}
.modal-header {
display: flex;
justify-content: space-between;
align-items: center;
margin-bottom: 24px;
}
.modal-header h2 {
font-size: 20px;
font-weight: 700;
color: #2d3748;
}
.modal-close {
background: none;
border: none;
font-size: 24px;
cursor: pointer;
color: #718096;
padding: 0;
width: auto;
}
.modal-close:hover {
color: #2d3748;
}
.modal-body .form-group {
margin-bottom: 16px;
}
@media (max-width: 768px) {
.tabs {
flex-direction: column;
}
.tab-content {
padding: 20px;
}
.stats-grid {
grid-template-columns: 1fr;
}
.period-controls {
flex-direction: column;
}
.period-controls .form-group {
width: 100%;
}
.schedule-table {
font-size: 12px;
}
.schedule-table th,
.schedule-table td {
padding: 8px;
}
.time-entry {
grid-template-columns: 1fr 1fr;
}
}
</style>
</head>
<body>
<div class="container">
<header>
<div>
<h1>Kitchen Workforce Management</h1>
<div class="header-subtitle">Schedule vs Actual Hours Tracking with Break & Gap Analysis</div>
</div>
</header>
<div id="status" class="hidden" style="margin: 16px 40px 0 40px;"></div>
<div class="tabs">
<button class="tab-btn active" onclick="switchTab('schedule')">üìÖ Manage Schedule</button>
<button class="tab-btn" onclick="switchTab('tasks')">‚è± Task Logging</button>
<button class="tab-btn" onclick="switchTab('allTasks')">üìã All Tasks</button>
<button class="tab-btn" onclick="switchTab('batch')">üìù Batch Entry</button>
<button class="tab-btn" onclick="switchTab('analytics')">üìä Analytics Dashboard</button>
<button class="tab-btn" onclick="switchTab('comparison')">üìà Schedule vs Actual</button>
<button class="tab-btn" onclick="switchTab('gaps')">‚ö†Ô∏è Gap Analysis</button>
</div>
<div id="schedule" class="tab-content active">
<h2 class="section-title">Manage Employee Schedule</h2>
<p class="section-subtitle">Add and edit scheduled shifts for employees</p>
<div class="card">
<div class="form-group">
<label for="scheduleDate">üìÖ Date</label>
<input type="date" id="scheduleDate" required>
</div>
<div class="form-group">
<label for="scheduleEmployee">üë§ Employee</label>
<select id="scheduleEmployee" required>
<option value="">-- Select Employee --</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="form-group">
<label for="scheduleRole">üè∑ Role/Position</label>
<select id="scheduleRole" required>
<option value="Kitchen Prep">Kitchen Prep</option>
<option value="Line Cook">Line Cook</option>
<option value="Fryer">Fryer</option>
<option value="Dishwasher">Dishwasher</option>
<option value="Server">Server</option>
</select>
</div>
<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
<div class="form-group">
<label for="scheduleStart">‚è∞ Scheduled Start Time</label>
<input type="time" id="scheduleStart" required>
</div>
<div class="form-group">
<label for="scheduleEnd">‚è∞ Scheduled End Time</label>
<input type="time" id="scheduleEnd" required>
</div>
</div>
<div class="action-bar">
<button onclick="addSchedule()" class="success">üíæ Add Schedule</button>
<button onclick="loadSchedules()" class="secondary">üîÑ Refresh</button>
</div>
<div id="scheduleStatus" class="hidden" style="margin-top: 16px;"></div>
</div>
<div class="card">
<h3 style="margin-bottom: 16px; font-size: 16px; color: #2d3748;">üìã Scheduled Shifts</h3>
<div id="scheduleList">
<p style="color: #718096; text-align: center; padding: 24px;">Loading schedules...</p>
</div>
</div>
</div>
<div id="tasks" class="tab-content">
<h2 class="section-title">Real-Time Task Logging</h2>
<p class="section-subtitle">Track actual work hours with automatic break deduction</p>
<div class="card">
<div class="form-group">
<label for="taskEmployee">üë§ Employee</label>
<select id="taskEmployee" required>
<option value="">-- Select Employee --</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="form-group">
<label for="taskRole">üè∑ Role</label>
<select id="taskRole" required>
<option value="Kitchen Prep">Kitchen Prep</option>
<option value="Line Cook">Line Cook</option>
<option value="Fryer">Fryer</option>
<option value="Dishwasher">Dishwasher</option>
</select>
</div>
<div class="form-group">
<label for="taskName">üìù Task Name</label>
<input type="text" id="taskName" placeholder="Type task name..." required>
</div>
<div class="action-bar">
<button onclick="startTask()" id="startBtn">‚ñ∂ Start Task</button>
<button onclick="stopTask()" id="stopBtn" disabled class="danger">‚èπ Stop Task</button>
</div>
<div id="taskStatus" class="hidden" style="margin-top: 16px;"></div>
<div id="activeTaskInfo" class="hidden" style="margin-top: 20px; padding: 16px; background: #f0f9ff; border-radius: 6px; border: 1px solid #bee3f8;">
<h4 style="color: #2c5282; margin-bottom: 8px;">Active Task</h4>
<p id="activeTaskDisplay" style="font-weight: 600; margin-bottom: 8px;"></p>
<p id="taskTimer" style="font-size: 14px; color: #4a5568;"></p>
</div>
</div>
</div>
<div id="allTasks" class="tab-content">
<h2 class="section-title">All Employee Tasks</h2>
<p class="section-subtitle">View, edit, update, and delete all task logs across all employees</p>
<div class="task-filters">
<h4 style="margin-bottom: 12px; color: #2c5282;">üîç Filter Tasks</h4>
<div class="period-controls">
<div class="form-group">
<label for="allTasksEmployee">üë§ Employee</label>
<select id="allTasksEmployee" onchange="loadAllTasks()">
<option value="">All Employees</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="form-group">
<label for="allTasksStartDate">üìÖ Start Date</label>
<input type="date" id="allTasksStartDate" onchange="loadAllTasks()">
</div>
<div class="form-group">
<label for="allTasksEndDate">üìÖ End Date</label>
<input type="date" id="allTasksEndDate" onchange="loadAllTasks()">
</div>
<div class="form-group">
<label for="allTasksRole">üè∑ Role</label>
<select id="allTasksRole" onchange="loadAllTasks()">
<option value="">All Roles</option>
<option value="Kitchen Prep">Kitchen Prep</option>
<option value="Line Cook">Line Cook</option>
<option value="Fryer">Fryer</option>
<option value="Dishwasher">Dishwasher</option>
</select>
</div>
<div class="form-group" style="display: flex; align-items: flex-end;">
<button onclick="loadAllTasks()" class="success" style="width: auto;">üîÑ Load Tasks</button>
</div>
</div>
</div>
<div class="card">
<div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
<h3 style="font-size: 16px; color: #2d3748;">üìù Task Records</h3>
<span id="allTasksCount" style="color: #718096; font-size: 14px;">0 tasks</span>
</div>
<div class="task-table-container">
<table class="schedule-table">
<thead>
<tr>
<th>Date</th>
<th>Employee</th>
<th>Task Name</th>
<th>Role</th>
<th>Start Time</th>
<th>End Time</th>
<th>Duration</th>
<th>Status</th>
<th>Actions</th>
</tr>
</thead>
<tbody id="allTasksTableBody">
<tr>
<td colspan="9" style="text-align: center; padding: 40px; color: #718096;">
Select filters and click "Load Tasks" to view all tasks
</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div id="batch" class="tab-content">
<h2 class="section-title">Batch Task Entry</h2>
<p class="section-subtitle">Add multiple tasks at once for a specific date</p>
<div class="card">
<div class="form-group">
<label for="batchDate">üìÖ Date</label>
<input type="date" id="batchDate" required>
</div>
<div class="form-group">
<label for="batchEmployee">üë§ Employee</label>
<select id="batchEmployee" required>
<option value="">-- Select Employee --</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="action-bar" style="margin-bottom: 20px;">
<button onclick="addBatchRow()" class="success">‚ûï Add Task Row</button>
<button onclick="clearBatchRows()" class="secondary">üóë Clear All</button>
</div>
<div id="batchRows">
</div>
<div class="action-bar" style="margin-top: 20px;">
<button onclick="saveBatchTasks()" class="success" style="flex: 1;">üíæ Save All Tasks</button>
</div>
<div id="batchStatus" class="hidden" style="margin-top: 16px;"></div>
</div>
</div>
<div id="analytics" class="tab-content">
<h2 class="section-title">Analytics Dashboard</h2>
<p class="section-subtitle">Comprehensive performance metrics and time analysis</p>
<div class="period-selector">
<h4>üìÖ Select Time Period</h4>
<div class="period-controls">
<div class="form-group">
<label for="analyticsPeriod">Period</label>
<select id="analyticsPeriod" onchange="changeAnalyticsPeriod()">
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
<option value="custom">Custom Range</option>
</select>
</div>
<div class="form-group" id="dailyDateGroup">
<label for="analyticsDate">Date</label>
<input type="date" id="analyticsDate">
</div>
<div class="form-group" id="weeklyDateGroup" style="display: none;">
<label for="analyticsWeek">Week Starting</label>
<input type="date" id="analyticsWeek">
</div>
<div class="form-group" id="monthlyDateGroup" style="display: none;">
<label for="analyticsMonth">Month</label>
<input type="month" id="analyticsMonth">
</div>
<div class="form-group" id="customDateGroup" style="display: none;">
<label for="analyticsStart">Start Date</label>
<input type="date" id="analyticsStart">
</div>
<div class="form-group" id="customEndGroup" style="display: none;">
<label for="analyticsEnd">End Date</label>
<input type="date" id="analyticsEnd">
</div>
<!-- NEW EMPLOYEE FILTER -->
<div class="form-group">
<label for="analyticsEmployee">üë§ Filter by Employee</label>
<select id="analyticsEmployee">
<option value="">All Employees</option>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<button onclick="loadAnalytics()" style="width: auto; margin-bottom: 0;">üìä Load Analytics</button>
</div>
<div id="currentPeriodDisplay" class="current-period-display">Loading...</div>
</div>
<div class="stats-grid">
<div class="stat-card">
<h3>Total Scheduled Hours</h3>
<div class="value" id="totalScheduled">-</div>
<div class="subtext">Across all employees</div>
</div>
<div class="stat-card">
<h3>Total Worked Hours</h3>
<div class="value" id="totalWorked">-</div>
<div class="subtext">Actual time logged</div>
</div>
<div class="stat-card">
<h3>Total Break Time</h3>
<div class="value" id="totalBreak">-</div>
<div class="subtext">1 hour per employee</div>
</div>
<div class="stat-card">
<h3>Variance</h3>
<div class="value" id="totalVariance">-</div>
<div class="subtext">Scheduled vs Worked</div>
</div>
<div class="stat-card">
<h3>Total Gap Time</h3>
<div class="value" id="totalGap">-</div>
<div class="subtext">Between tasks</div>
</div>
<div class="stat-card">
<h3>Efficiency Rate</h3>
<div class="value" id="efficiencyRate">-</div>
<div class="subtext">Productivity %</div>
</div>
</div>
<div class="card" style="margin-top: 24px;">
<h3 style="margin-bottom: 16px;">üìä Hours Distribution</h3>
<div class="chart-container">
<canvas id="hoursChart"></canvas>
</div>
</div>
<div class="card" style="margin-top: 24px;">
<h3 style="margin-bottom: 16px;">üë• Employee Breakdown</h3>
<div id="employeeBreakdown">
<p style="color: #718096; text-align: center; padding: 24px;">Loading...</p>
</div>
</div>
</div>
<div id="comparison" class="tab-content">
<h2 class="section-title">Schedule vs Actual Comparison</h2>
<p class="section-subtitle">Detailed comparison of scheduled hours vs actual worked hours</p>
<div class="period-selector">
<h4>üìÖ Select Period</h4>
<div class="period-controls">
<div class="form-group">
<label for="comparePeriod">Period</label>
<select id="comparePeriod" onchange="changeComparePeriod()">
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
<option value="custom">Custom Range</option>
</select>
</div>
<div class="form-group" id="compareDailyGroup">
<label for="compareDate">Date</label>
<input type="date" id="compareDate">
</div>
<div class="form-group" id="compareWeeklyGroup" style="display: none;">
<label for="compareWeek">Week Starting</label>
<input type="date" id="compareWeek">
</div>
<div class="form-group" id="compareMonthlyGroup" style="display: none;">
<label for="compareMonth">Month</label>
<input type="month" id="compareMonth">
</div>
<div class="form-group" id="compareCustomGroup" style="display: none;">
<label for="compareStart">Start Date</label>
<input type="date" id="compareStart">
</div>
<div class="form-group" id="compareCustomEndGroup" style="display: none;">
<label for="compareEnd">End Date</label>
<input type="date" id="compareEnd">
</div>
<button onclick="loadComparison()" style="width: auto; margin-bottom: 0;">üìä Load Comparison</button>
</div>
</div>
<div id="comparisonData">
<div class="comparison-grid" id="comparisonGrid">
</div>
</div>
</div>
<div id="gaps" class="tab-content">
<h2 class="section-title">Gap Time Analysis</h2>
<p class="section-subtitle">Track time gaps between tasks to identify inefficiencies</p>
<div class="period-selector">
<h4>üìÖ Select Period</h4>
<div class="period-controls">
<div class="form-group">
<label for="gapPeriod">Period</label>
<select id="gapPeriod" onchange="changeGapPeriod()">
<option value="daily">Daily</option>
<option value="weekly">Weekly</option>
<option value="monthly">Monthly</option>
<option value="custom">Custom Range</option>
</select>
</div>
<div class="form-group" id="gapDailyGroup">
<label for="gapDate">Date</label>
<input type="date" id="gapDate">
</div>
<div class="form-group" id="gapWeeklyGroup" style="display: none;">
<label for="gapWeek">Week Starting</label>
<input type="date" id="gapWeek">
</div>
<div class="form-group" id="gapMonthlyGroup" style="display: none;">
<label for="gapMonth">Month</label>
<input type="month" id="gapMonth">
</div>
<div class="form-group" id="gapCustomGroup" style="display: none;">
<label for="gapStart">Start Date</label>
<input type="date" id="gapStart">
</div>
<div class="form-group" id="gapCustomEndGroup" style="display: none;">
<label for="gapEnd">End Date</label>
<input type="date" id="gapEnd">
</div>

<div class="form-group">
  <label for="gapEmployee">üë§ Employee</label>
  <select id="gapEmployee" onchange="loadGapAnalysis()">
    <option value="">All Employees</option>
    <option value="Julio Mejia">Julio Mejia</option>
    <option value="Leydi Diaz">Leydi Diaz</option>
    <option value="Procoro Tinoco">Procoro Tinoco</option>
    <option value="Wilson Sanchez">Wilson Sanchez</option>
  </select>
</div>
<button onclick="loadGapAnalysis()" style="width: auto; margin-bottom: 0;">üîç Analyze Gaps</button>
</div>
</div>
<div id="gapData">
<div class="card">
<h3 style="margin-bottom: 16px;">‚ö†Ô∏è Identified Gaps</h3>
<div id="gapList">
<p style="color: #718096; text-align: center; padding: 24px;">No gaps found or select a period to analyze</p>
</div>
</div>
</div>
</div>
</div>
<div class="modal-overlay" id="editTaskModal">
<div class="modal">
<div class="modal-header">
<h2>‚úèÔ∏è Edit Task</h2>
<button class="modal-close" onclick="closeEditTaskModal()">√ó</button>
</div>
<div class="modal-body">
<input type="hidden" id="editTaskId">
<div class="form-group">
<label for="editTaskEmployee">üë§ Employee</label>
<select id="editTaskEmployee" required>
<option value="Julio Mejia">Julio Mejia</option>
<option value="Leydi Diaz">Leydi Diaz</option>
<option value="Procoro Tinoco">Procoro Tinoco</option>
<option value="Wilson Sanchez">Wilson Sanchez</option>
</select>
</div>
<div class="form-group">
<label for="editTaskDate">üìÖ Date</label>
<input type="date" id="editTaskDate" required>
</div>
<div class="form-group">
<label for="editTaskRole">üè∑ Role</label>
<select id="editTaskRole" required>
<option value="Kitchen Prep">Kitchen Prep</option>
<option value="Line Cook">Line Cook</option>
<option value="Fryer">Fryer</option>
<option value="Dishwasher">Dishwasher</option>
</select>
</div>
<div class="form-group">
<label for="editTaskName">üìù Task Name</label>
<input type="text" id="editTaskName" required>
</div>
<div class="form-group">
<label for="editTaskStart">‚è∞ Start Time</label>
<input type="time" id="editTaskStart" required>
</div>
<div class="form-group">
<label for="editTaskEnd">‚è∞ End Time</label>
<input type="time" id="editTaskEnd">
<small style="color: #718096; display: block; margin-top: 4px;">Leave blank for open/active tasks</small>
</div>
<div class="action-bar" style="margin-top: 24px;">
<button onclick="saveEditedTask()" class="success" style="flex: 1;">üíæ Save Changes</button>
<button onclick="closeEditTaskModal()" class="secondary" style="flex: 1;">Cancel</button>
</div>
</div>
</div>
</div>
<script>
// ========== SUPABASE SETUP ==========
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const { createClient } = window.supabase;
const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let __SUPABASE_OK__ = false;

function showGlobalStatus(message, type = 'info', sticky = false) {
  const el = document.getElementById('status');
  if (!el) return;
  el.textContent = message;
  el.className = type;
  el.classList.remove('hidden');
  if (!sticky) {
    clearTimeout(showGlobalStatus._t);
    showGlobalStatus._t = setTimeout(() => {
      el.classList.add('hidden');
    }, 7000);
  }
}

async function testSupabaseConnection() {
  try {
    // Lightweight ping query
    const { error } = await supabaseClient
      .from('kitchen_prep_employees')
      .select('id')
      .limit(1);

    if (error) {
      // Supabase returned a response, but with an error (RLS, missing table, etc.)
      __SUPABASE_OK__ = true;
      console.warn('Supabase query error (connection OK):', error);
      return { ok: true, error };
    }

    __SUPABASE_OK__ = true;
    return { ok: true, error: null };
  } catch (e) {
    // Network-level failure
    __SUPABASE_OK__ = false;
    return { ok: false, error: e };
  }
}

function explainFetchFailure(err) {
  const msg = (err && (err.message || err.toString())) || 'Failed to fetch';
  if (!/Failed to fetch/i.test(msg)) return msg;
  return [
    'Supabase connection failed (Failed to fetch).',
    'Fix checklist:',
    '1) Confirm internet is working.',
    '2) Disable ad-block/VPN/firewall rules that may block: *.supabase.co or cdn.jsdelivr.net',
    '3) If you are on a company network, try a hotspot.',
    '4) In Supabase dashboard: confirm the project is not paused and the URL/key are correct.',
  ].join(' ');
}

async function initApp() {
  showGlobalStatus('Connecting to Supabase...', 'info', true);

  const ping = await testSupabaseConnection();
  if (!ping.ok) {
    console.error('Supabase connection error:', ping.error);
    showGlobalStatus(explainFetchFailure(ping.error), 'error', true);
    return;
  }

  // If ok but tables/RLS error, still allow UI to load but show message
  if (ping.error) {
    showGlobalStatus('Connected to Supabase, but a table/RLS error was returned. Check RLS policies + table names.', 'warning');
  } else {
    showGlobalStatus('‚úÖ Connected to Supabase', 'success');
  }

  // Load initial data
  loadSchedules();
  loadAnalytics();
}

window.addEventListener('unhandledrejection', (e) => {
  console.error('Unhandled promise rejection:', e.reason);
  showGlobalStatus(explainFetchFailure(e.reason), 'error', true);
});

window.addEventListener('error', (e) => {
  // Only surface fetch-related runtime errors prominently
  const msg = e?.error?.message || e?.message || '';
  if (/Failed to fetch/i.test(msg)) {
    showGlobalStatus(explainFetchFailure(e.error || e.message), 'error', true);
  }
});
let activeTaskId = null;
let activeTaskInterval = null;
let activeTaskStartTime = null;
let batchRowCount = 0;

// ========== LOOKUP HELPERS (WORKS EVEN WITHOUT FK RELATIONSHIPS) ==========
let _employeeMapCache = null;
let _taskMapCache = null;

async function getEmployeeMap(force = false) {
  if (_employeeMapCache && !force) return _employeeMapCache;
  const { data, error } = await supabaseClient
    .from('kitchen_prep_employees')
    .select('id,name');
  if (error) throw error;
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _employeeMapCache = map;
  return map;
}

async function getTaskMap(force = false) {
  if (_taskMapCache && !force) return _taskMapCache;
  const { data, error } = await supabaseClient
    .from('kitchen_tasks')
    .select('id,name');
  if (error) throw error;
  const map = {};
  (data || []).forEach(r => { map[r.id] = r.name; });
  _taskMapCache = map;
  return map;
}

async function getEmployeeIdByName(name, createIfMissing = true) {
  if (!name) return null;

  // Try find existing
  const { data: existing, error: findErr } = await supabaseClient
    .from('kitchen_prep_employees')
    .select('id')
    .eq('name', name)
    .limit(1)
    .maybeSingle();

  if (findErr) throw findErr;
  if (existing?.id) return existing.id;

  if (!createIfMissing) return null;

  // Create employee if missing
  const { data: created, error: createErr } = await supabaseClient
    .from('kitchen_prep_employees')
    .insert({ name })
    .select('id')
    .single();

  if (createErr) throw createErr;

  _employeeMapCache = null; // refresh cache
  return created.id;
}

async function getTaskIdByName(name, createIfMissing = true) {
  if (!name) return null;

  const { data: existing, error: findErr } = await supabaseClient
    .from('kitchen_tasks')
    .select('id')
    .eq('name', name)
    .limit(1)
    .maybeSingle();

  if (findErr) throw findErr;
  if (existing?.id) return existing.id;

  if (!createIfMissing) return null;

  const { data: created, error: createErr } = await supabaseClient
    .from('kitchen_tasks')
    .insert({ name, description: name })
    .select('id')
    .single();

  if (createErr) throw createErr;

  _taskMapCache = null; // refresh cache
  return created.id;
}

// ========== TIMEZONE HELPERS (CST/CDT - America/Chicago) ==========

function getCSTOffset(dateStr) {
const probe = new Date(dateStr + 'T12:00:00Z');
const parts = new Intl.DateTimeFormat('en-US', {
timeZone: 'America/Chicago',
timeZoneName: 'shortOffset'
}).formatToParts(probe);
const tz = parts.find(p => p.type === 'timeZoneName')?.value || 'GMT-6';
const m = tz.match(/GMT([+-])(\d{1,2})(?::?(\d{2}))?/);
if (!m) return '-06:00';
const sign = m[1];
const hh = String(m[2]).padStart(2, '0');
const mm = String(m[3] || '00').padStart(2, '0');
return `${sign}${hh}:${mm}`;
}
function toCSTISOString(dateStr, timeStr) {
const offset = getCSTOffset(dateStr);
const cstString = `${dateStr}T${timeStr}:00${offset}`;
return new Date(cstString).toISOString();
}
window.onload = function() {
  const chicagoToday = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });

  document.getElementById('scheduleDate').value = chicagoToday;
  document.getElementById('analyticsDate').value = chicagoToday;
  document.getElementById('compareDate').value = chicagoToday;
  document.getElementById('gapDate').value = chicagoToday;
  document.getElementById('batchDate').value = chicagoToday;

  document.getElementById('allTasksStartDate').value = chicagoToday;
  document.getElementById('allTasksEndDate').value = chicagoToday;

  const chicagoNow = new Date(new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' }));
  const weekStart = getWeekStart(chicagoNow).toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });

  document.getElementById('analyticsWeek').value = weekStart;
  document.getElementById('compareWeek').value = weekStart;
  document.getElementById('gapWeek').value = weekStart;

  initApp();
};
function switchTab(tabName, evt) {
  document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.getElementById(tabName).classList.add('active');

  const e = evt || window.event;
  if (e && e.target) e.target.classList.add('active');

  if (tabName === 'analytics') loadAnalytics();
  else if (tabName === 'comparison') loadComparison();
  else if (tabName === 'gaps') loadGapAnalysis();
  else if (tabName === 'allTasks') loadAllTasks();
}
function getWeekStart(date) {
  // Week starts on SUNDAY (0) -> SATURDAY (6)
  const d = new Date(date);
  d.setHours(12, 0, 0, 0); // stabilize DST edges
  const day = d.getDay(); // 0 = Sunday
  const diff = d.getDate() - day;
  const start = new Date(d);
  start.setDate(diff);
  start.setHours(12, 0, 0, 0);
  return start;
}
function getMonthStart(date) {
return new Date(date.getFullYear(), date.getMonth(), 1);
}
function formatDate(dateStr) {
if (!dateStr) return '‚Äî';
const normalized = /^\d{4}-\d{2}-\d{2}$/.test(dateStr)
? dateStr + 'T12:00:00Z'
: dateStr;
const date = new Date(normalized);
return date.toLocaleDateString('en-US', {
timeZone: 'America/Chicago',
month: 'short',
day: 'numeric',
year: 'numeric'
});
}
function formatTime(minutes) {
const h = Math.floor(minutes / 60);
const m = Math.round(minutes % 60);
return h > 0 ? `${h}h ${m}m` : `${m}m`;
}
function calculateHours(start, end) {
const s = new Date(`2000-01-01T${start}`);
const e = new Date(`2000-01-01T${end}`);
return (e - s) / (1000 * 60);
}
function formatDateTime(isoString) {
if (!isoString) return '‚Äî';
const date = new Date(isoString);
return date.toLocaleTimeString('en-US', {
timeZone: 'America/Chicago',
hour: 'numeric',
minute: '2-digit',
hour12: true
});
}
// ========== SCHEDULE MANAGEMENT ==========
async function addSchedule() {
const date = document.getElementById('scheduleDate').value;
const employee = document.getElementById('scheduleEmployee').value;
const role = document.getElementById('scheduleRole').value;
const startTime = document.getElementById('scheduleStart').value;
const endTime = document.getElementById('scheduleEnd').value;
if (!date || !employee || !startTime || !endTime) {
showScheduleStatus('Please fill all fields!', 'error');
return;
}
if (startTime >= endTime) {
showScheduleStatus('End time must be after start time!', 'error');
return;
}
try {
const { data: emp, error: empError } = await supabaseClient
.from('kitchen_prep_employees')
.select('id')
.eq('name', employee)
.single();
if (empError || !emp) {
const { data: newEmp } = await supabaseClient
.from('kitchen_prep_employees')
.insert({ name: employee })
.select()
.single();
}
const { error } = await supabaseClient
.from('employee_schedules')
.insert({
employee_name: employee,
role: role,
schedule_date: date,
start_time: startTime,
end_time: endTime,
break_minutes: 60
});
if (error) throw error;
showScheduleStatus('Schedule added successfully!', 'success');
loadSchedules();
} catch (error) {
console.error('Error adding schedule:', error);
showScheduleStatus('Error adding schedule', 'error');
}
}
async function loadSchedules() {
try {
const { data: schedules, error } = await supabaseClient
.from('employee_schedules')
.select('*')
.order('schedule_date', { ascending: false })
.limit(50);
if (error) throw error;
const container = document.getElementById('scheduleList');
if (!schedules || schedules.length === 0) {
container.innerHTML = '<p style="color: #718096; text-align: center; padding: 24px;">No schedules found</p>';
return;
}
let html = '<table class="schedule-table"><thead><tr><th>Date</th><th>Employee</th><th>Role</th><th>Scheduled</th><th>Duration</th><th>Break</th><th>Actions</th></tr></thead><tbody>';
schedules.forEach(schedule => {
const duration = calculateHours(schedule.start_time, schedule.end_time);
html += `
<tr>
<td>${formatDate(schedule.schedule_date)}</td>
<td><strong>${schedule.employee_name}</strong></td>
<td><span class="badge info">${schedule.role}</span></td>
<td>${schedule.start_time} - ${schedule.end_time}</td>
<td>${formatTime(duration)}</td>
<td>${schedule.break_minutes} min</td>
<td><button class="danger" onclick="deleteSchedule('${schedule.id}')" style="padding: 6px 12px; font-size: 13px;">Delete</button></td>
</tr>
`;
});
html += '</tbody></table>';
container.innerHTML = html;
} catch (error) {
console.error('Error loading schedules:', error);
document.getElementById('scheduleList').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 24px;">Error loading schedules</p>';
}
}
async function deleteSchedule(id) {
if (!confirm('Delete this schedule?')) return;
try {
const { error } = await supabaseClient
.from('employee_schedules')
.delete()
.eq('id', id);
if (error) throw error;
showScheduleStatus('Schedule deleted', 'success');
loadSchedules();
} catch (error) {
console.error('Error deleting schedule:', error);
showScheduleStatus('Error deleting schedule', 'error');
}
}
function showScheduleStatus(message, type) {
const div = document.getElementById('scheduleStatus');
div.textContent = message;
div.className = type;
div.classList.remove('hidden');
setTimeout(() => div.classList.add('hidden'), 3000);
}
// ========== TASK LOGGING ==========
async function startTask() {
  const employee = document.getElementById('taskEmployee').value;
  const role = document.getElementById('taskRole').value;
  const taskName = document.getElementById('taskName').value;

  if (!employee || !taskName) {
    showTaskStatus('Please select employee and enter task name', 'error');
    return;
  }

  try {
    const dateStr = new Date().toLocaleDateString('en-CA', { timeZone: 'America/Chicago' });
    const timeStr = new Date().toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0, 5);
    const cstStartTime = toCSTISOString(dateStr, timeStr);

    // ‚úÖ Ensure employee + task exist, always use IDs (prevents "Unknown")
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskId = await getTaskIdByName(taskName, true);

    const { data: log, error } = await supabaseClient
      .from('task_time_logs')
      .insert({
        employee_id: employeeId,
        task_id: taskId,
        role: role,
        start_time: cstStartTime,
        date: dateStr
      })
      .select()
      .single();

    if (error) throw error;

    activeTaskId = log.id;
    activeTaskStartTime = new Date();

    document.getElementById('startBtn').disabled = true;
    document.getElementById('stopBtn').disabled = false;

    document.getElementById('activeTaskDisplay').textContent = `${employee} - ${taskName} (${role})`;
    document.getElementById('activeTaskInfo').classList.remove('hidden');

    activeTaskInterval = setInterval(() => {
      const elapsed = Math.floor((new Date() - activeTaskStartTime) / 1000);
      const h = Math.floor(elapsed / 3600);
      const m = Math.floor((elapsed % 3600) / 60);
      const s = elapsed % 60;
      document.getElementById('taskTimer').textContent =
        `Elapsed: ${h.toString().padStart(2, '0')}:${m.toString().padStart(2, '0')}:${s.toString().padStart(2, '0')}`;
    }, 1000);

    showTaskStatus('Task started!', 'success');
  } catch (error) {
    console.error('Error starting task:', error);
    showTaskStatus('Error starting task', 'error');
  }
}

async function stopTask() {
if (!activeTaskId) return;
try {
const now = new Date();
const dateStr = now.toLocaleDateString('en-CA', {
timeZone: 'America/Chicago'
});
const timeStr = now.toLocaleTimeString('en-US', { hour12: false, timeZone: 'America/Chicago' }).substring(0,5);
const cstEndTime = toCSTISOString(dateStr, timeStr);
await supabaseClient
.from('task_time_logs')
.update({ end_time: cstEndTime })
.eq('id', activeTaskId);
clearInterval(activeTaskInterval);
activeTaskId = null;
document.getElementById('startBtn').disabled = false;
document.getElementById('stopBtn').disabled = true;
document.getElementById('activeTaskInfo').classList.add('hidden');
document.getElementById('taskName').value = '';
showTaskStatus('Task completed!', 'success');
} catch (error) {
console.error('Error stopping task:', error);
showTaskStatus('Error stopping task', 'error');
}
}
function showTaskStatus(message, type) {
const div = document.getElementById('taskStatus');
div.textContent = message;
div.className = type;
div.classList.remove('hidden');
setTimeout(() => div.classList.add('hidden'), 3000);
}
// ========== üÜï ALL TASKS MANAGEMENT ==========
async function loadAllTasks() {
  const employeeName = document.getElementById('allTasksEmployee').value;
  const startDate = document.getElementById('allTasksStartDate').value;
  const endDate = document.getElementById('allTasksEndDate').value;
  const role = document.getElementById('allTasksRole').value;

  const tbody = document.getElementById('allTasksTableBody');
  tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px;"><div class="spinner"></div>Loading tasks...</td></tr>';

  try {
    let query = supabaseClient
      .from('task_time_logs')
      .select('*')
      .order('date', { ascending: false })
      .order('start_time', { ascending: false });

    // Filters (use base table columns so it works even if FK relationships are missing)
    if (startDate) query = query.gte('date', startDate);
    if (endDate) query = query.lte('date', endDate);
    if (role) query = query.eq('role', role);

    if (employeeName) {
      const empId = await getEmployeeIdByName(employeeName, false);
      if (!empId) {
        document.getElementById('allTasksCount').textContent = `0 tasks`;
        tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #718096;">No tasks found matching your filters</td></tr>';
        return;
      }
      query = query.eq('employee_id', empId);
    }

    const { data: logs, error } = await query;
    if (error) throw error;

    document.getElementById('allTasksCount').textContent = `${logs?.length || 0} tasks`;

    if (!logs || logs.length === 0) {
      tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #718096;">No tasks found matching your filters</td></tr>';
      return;
    }

    const [empMap, taskMap] = await Promise.all([getEmployeeMap(), getTaskMap()]);

    let html = '';
    logs.forEach(log => {
      const isOpen = !log.end_time;

      const employeeDisplay = empMap[log.employee_id] || 'Unknown';
      const taskDisplay = taskMap[log.task_id] || 'N/A';

      const duration = log.end_time
        ? formatTime((new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60))
        : '‚Äî';

      html += `
        <tr>
          <td>${formatDate(log.date)}</td>
          <td><strong>${employeeDisplay}</strong></td>
          <td>${taskDisplay}</td>
          <td><span class="badge info">${log.role || '‚Äî'}</span></td>
          <td>${formatDateTime(log.start_time)}</td>
          <td>${isOpen ? '<span class="badge warning">OPEN</span>' : formatDateTime(log.end_time)}</td>
          <td><strong>${duration}</strong></td>
          <td>${isOpen ? '<span class="badge warning">Active</span>' : '<span class="badge success">Completed</span>'}</td>
          <td class="task-actions">
            <button class="secondary" onclick="openEditTaskModal('${log.id}')">‚úèÔ∏è Edit</button>
            <button class="danger" onclick="deleteTask('${log.id}')">üóë Delete</button>
          </td>
        </tr>
      `;
    });

    tbody.innerHTML = html;
  } catch (error) {
    console.error('Error loading all tasks:', error);
    tbody.innerHTML = '<tr><td colspan="9" style="text-align: center; padding: 40px; color: #ef4444;">Error loading tasks</td></tr>';
  }
}

async function openEditTaskModal(taskId) {
  try {
    const { data: log, error } = await supabaseClient
      .from('task_time_logs')
      .select('*')
      .eq('id', taskId)
      .single();

    if (error) throw error;

    const [empMap, taskMap] = await Promise.all([getEmployeeMap(), getTaskMap()]);
    const employeeName = empMap[log.employee_id] || '';
    const taskName = taskMap[log.task_id] || '';

    document.getElementById('editTaskId').value = log.id;

    // If we can resolve employee name, set it; otherwise keep current dropdown selection
    if (employeeName) document.getElementById('editTaskEmployee').value = employeeName;

    document.getElementById('editTaskDate').value = log.date || '';
    document.getElementById('editTaskRole').value = log.role || '';
    document.getElementById('editTaskName').value = taskName || '';

    document.getElementById('editTaskStart').value = log.start_time
      ? new Date(log.start_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' })
      : '';

    document.getElementById('editTaskEnd').value = log.end_time
      ? new Date(log.end_time).toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit', timeZone: 'America/Chicago' })
      : '';

    document.getElementById('editTaskModal').classList.add('active');
  } catch (error) {
    console.error('Error loading task for edit:', error);
    alert('Error loading task details');
  }
}

function closeEditTaskModal() {
document.getElementById('editTaskModal').classList.remove('active');
}
async function saveEditedTask() {
  const taskLogId = document.getElementById('editTaskId').value;
  const employee = document.getElementById('editTaskEmployee').value;
  const date = document.getElementById('editTaskDate').value;
  const role = document.getElementById('editTaskRole').value;
  const taskName = document.getElementById('editTaskName').value;
  const startTime = document.getElementById('editTaskStart').value;
  const endTime = document.getElementById('editTaskEnd').value;

  if (!taskLogId || !employee || !date || !taskName || !startTime) {
    alert('Please fill all required fields');
    return;
  }

  try {
    const employeeId = await getEmployeeIdByName(employee, true);
    const taskIdDb = await getTaskIdByName(taskName, true);

    const startDateTimeISO = toCSTISOString(date, startTime);

    const updateData = {
      employee_id: employeeId,
      task_id: taskIdDb,
      role: role,
      start_time: startDateTimeISO,
      date: date
    };

    if (endTime) {
      updateData.end_time = toCSTISOString(date, endTime);
    } else {
      updateData.end_time = null;
    }

    const { error } = await supabaseClient
      .from('task_time_logs')
      .update(updateData)
      .eq('id', taskLogId);

    if (error) throw error;

    alert('Task updated successfully!');
    closeEditTaskModal();
    loadAllTasks();
  } catch (error) {
    console.error('Error updating task:', error);
    alert('Error updating task: ' + error.message);
  }
}

async function deleteTask(taskId) {
if (!confirm('Are you sure you want to delete this task? This cannot be undone.')) return;
try {
const { error } = await supabaseClient
.from('task_time_logs')
.delete()
.eq('id', taskId);
if (error) throw error;
alert('Task deleted successfully!');
loadAllTasks();
} catch (error) {
console.error('Error deleting task:', error);
alert('Error deleting task: ' + error.message);
}
}
// ========== BATCH ENTRY ==========
function addBatchRow() {
batchRowCount++;
const container = document.getElementById('batchRows');
const row = document.createElement('div');
row.id = `batchRow${batchRowCount}`;
row.className = 'time-entry';
row.innerHTML = `
<input type="time" class="batchStart" placeholder="Start Time" required>
<input type="time" class="batchEnd" placeholder="End Time" required>
<input type="text" class="batchTask" placeholder="Task Name" required>
<select class="batchRole">
<option value="Kitchen Prep">Kitchen Prep</option>
<option value="Line Cook">Line Cook</option>
<option value="Fryer">Fryer</option>
<option value="Dishwasher">Dishwasher</option>
</select>
<button onclick="removeBatchRow(${batchRowCount})" class="danger" style="padding: 8px;">‚úï</button>
`;
container.appendChild(row);
}
function removeBatchRow(id) {
const row = document.getElementById(`batchRow${id}`);
if (row) row.remove();
}
function clearBatchRows() {
document.getElementById('batchRows').innerHTML = '';
batchRowCount = 0;
}
async function saveBatchTasks() {
  const date = document.getElementById('batchDate').value;
  const employee = document.getElementById('batchEmployee').value;

  if (!date || !employee) {
    showBatchStatus('Please select date and employee', 'error');
    return;
  }

  const rows = document.querySelectorAll('#batchRows > div');
  if (rows.length === 0) {
    showBatchStatus('Please add at least one task', 'error');
    return;
  }

  try {
    const employeeId = await getEmployeeIdByName(employee, true);

    let savedCount = 0;

    for (const row of rows) {
      const startTime = row.querySelector('.batchStart').value;
      const endTime = row.querySelector('.batchEnd').value;
      const taskName = row.querySelector('.batchTask').value;
      const role = row.querySelector('.batchRole').value;

      if (!startTime || !endTime || !taskName) continue;

      const taskId = await getTaskIdByName(taskName, true);

      const startDateTimeISO = toCSTISOString(date, startTime);
      const endDateTimeISO = toCSTISOString(date, endTime);

      const { error } = await supabaseClient
        .from('task_time_logs')
        .insert({
          employee_id: employeeId,
          task_id: taskId,
          role: role,
          start_time: startDateTimeISO,
          end_time: endDateTimeISO,
          date: date
        });

      if (error) throw error;
      savedCount++;
    }

    showBatchStatus(`Saved ${savedCount} tasks successfully!`, 'success');
    clearBatchRows();
  } catch (error) {
    console.error('Error saving batch tasks:', error);
    showBatchStatus('Error saving tasks', 'error');
  }
}

function showBatchStatus(message, type) {
const div = document.getElementById('batchStatus');
div.textContent = message;
div.className = type;
div.classList.remove('hidden');
setTimeout(() => div.classList.add('hidden'), 3000);
}
// ========== ANALYTICS ==========
function changeAnalyticsPeriod() {
const period = document.getElementById('analyticsPeriod').value;
document.getElementById('dailyDateGroup').style.display = period === 'daily' ? 'block' : 'none';
document.getElementById('weeklyDateGroup').style.display = period === 'weekly' ? 'block' : 'none';
document.getElementById('monthlyDateGroup').style.display = period === 'monthly' ? 'block' : 'none';
document.getElementById('customDateGroup').style.display = period === 'custom' ? 'block' : 'none';
document.getElementById('customEndGroup').style.display = period === 'custom' ? 'block' : 'none';
loadAnalytics();
}
async function loadAnalytics() {
  const period = document.getElementById('analyticsPeriod').value;
  const selectedEmployee = document.getElementById('analyticsEmployee').value;

  let startDate, endDate, displayText;

  if (period === 'daily') {
    startDate = document.getElementById('analyticsDate').value;
    endDate = startDate;
    displayText = `Daily - ${formatDate(startDate)}`;
  } else if (period === 'weekly') {
    startDate = document.getElementById('analyticsWeek').value;
    const weekEnd = new Date(startDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    endDate = weekEnd.toISOString().split('T')[0];
    displayText = `Weekly - ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else if (period === 'monthly') {
    const month = document.getElementById('analyticsMonth').value;
    startDate = `${month}-01`;
    const lastDay = new Date(parseInt(month.split('-')[0]), parseInt(month.split('-')[1]), 0).getDate();
    endDate = `${month}-${lastDay.toString().padStart(2, '0')}`;
    displayText = `Monthly - ${formatDate(startDate)} to ${formatDate(endDate)}`;
  } else {
    startDate = document.getElementById('analyticsStart').value;
    endDate = document.getElementById('analyticsEnd').value;
    displayText = `${formatDate(startDate)} to ${formatDate(endDate)}`;
  }

  if (selectedEmployee) {
    displayText += ` | Employee: ${selectedEmployee}`;
  }

  document.getElementById('currentPeriodDisplay').textContent = displayText;

  try {
    let schedulesQuery = supabaseClient
      .from('employee_schedules')
      .select('*')
      .gte('schedule_date', startDate)
      .lte('schedule_date', endDate);

    let logsQuery = supabaseClient
      .from('task_time_logs')
      .select('*')
      .gte('date', startDate)
      .lte('date', endDate);

    if (selectedEmployee) {
      schedulesQuery = schedulesQuery.eq('employee_name', selectedEmployee);

      const empId = await getEmployeeIdByName(selectedEmployee, false);
      if (empId) {
        logsQuery = logsQuery.eq('employee_id', empId);
      } else {
        // No such employee record, force no logs
        logsQuery = logsQuery.eq('employee_id', '00000000-0000-0000-0000-000000000000');
      }
    }

    const [{ data: schedules, error: schedErr }, { data: logs, error: logsErr }, empMap] = await Promise.all([
      schedulesQuery,
      logsQuery,
      getEmployeeMap()
    ]);

    if (schedErr) throw schedErr;
    if (logsErr) throw logsErr;

    let totalScheduledMinutes = 0;
    let totalWorkedMinutes = 0;
    let totalBreakMinutes = 0;
    let totalGapMinutes = 0;

    const employeeStats = {};

    // Schedules
    (schedules || []).forEach(schedule => {
      const duration = calculateHours(schedule.start_time, schedule.end_time);
      totalScheduledMinutes += duration;
      totalBreakMinutes += schedule.break_minutes || 60;

      if (!employeeStats[schedule.employee_name]) {
        employeeStats[schedule.employee_name] = { scheduled: 0, worked: 0, break: 0, tasks: 0 };
      }

      employeeStats[schedule.employee_name].scheduled += duration;
      employeeStats[schedule.employee_name].break += schedule.break_minutes || 60;
    });

    // Logs (no FK required)
    if (logs && logs.length) {
      const enriched = logs.map(l => ({
        ...l,
        _empName: empMap[l.employee_id] || 'Unknown'
      }));

      enriched.sort((a, b) => {
        if (a._empName !== b._empName) return a._empName.localeCompare(b._empName);
        if ((a.date || '') !== (b.date || '')) return (a.date || '').localeCompare(b.date || '');
        return new Date(a.start_time) - new Date(b.start_time);
      });

      let lastEndTime = null;
      let lastEmployee = null;
      let lastDate = null;

      enriched.forEach(log => {
        if (!log.end_time) return;

        const worked = (new Date(log.end_time) - new Date(log.start_time)) / (1000 * 60);
        totalWorkedMinutes += worked;

        if (!employeeStats[log._empName]) {
          employeeStats[log._empName] = { scheduled: 0, worked: 0, break: 0, tasks: 0 };
        }
        employeeStats[log._empName].worked += worked;
        employeeStats[log._empName].tasks++;

        // ‚úÖ Gap only if same employee + same date
        if (lastEmployee === log._empName && lastDate === log.date && lastEndTime) {
          const gap = (new Date(log.start_time) - new Date(lastEndTime)) / (1000 * 60);
          if (gap > 0) totalGapMinutes += gap;
        }

        lastEndTime = log.end_time;
        lastEmployee = log._empName;
        lastDate = log.date;
      });
    }

    const variance = totalWorkedMinutes - totalScheduledMinutes;
    const efficiency = totalScheduledMinutes > 0 ? ((totalWorkedMinutes / totalScheduledMinutes) * 100).toFixed(1) : 0;

    document.getElementById('totalScheduled').textContent = formatTime(totalScheduledMinutes);
    document.getElementById('totalWorked').textContent = formatTime(totalWorkedMinutes);
    document.getElementById('totalBreak').textContent = formatTime(totalBreakMinutes);
    document.getElementById('totalVariance').textContent = (variance >= 0 ? '+' : '') + formatTime(variance);
    document.getElementById('totalGap').textContent = formatTime(totalGapMinutes);
    document.getElementById('efficiencyRate').textContent = efficiency + '%';

    document.getElementById('totalVariance').parentElement.className =
      'stat-card ' + (variance >= 0 ? 'positive' : 'negative');

    let breakdownHtml = '<div class="stats-grid">';
    for (const [emp, stats] of Object.entries(employeeStats)) {
      breakdownHtml += `
        <div class="stat-card">
          <h3>${emp}</h3>
          <div class="value" style="font-size: 24px;">${formatTime(stats.worked)}</div>
          <div class="subtext">Worked / ${formatTime(stats.scheduled)} Scheduled</div>
          <div style="margin-top: 8px; font-size: 13px;">
            <span class="badge info">${stats.tasks} tasks</span>
          </div>
        </div>
      `;
    }
    breakdownHtml += '</div>';

    document.getElementById('employeeBreakdown').innerHTML = breakdownHtml;
    updateHoursChart(employeeStats);
  } catch (error) {
    console.error('Error loading analytics:', error);
  }
}

let hoursChart = null;
function updateHoursChart(employeeStats) {
const ctx = document.getElementById('hoursChart').getContext('2d');
if (hoursChart) hoursChart.destroy();
const labels = Object.keys(employeeStats);
const scheduled = Object.values(employeeStats).map(s => s.scheduled);
const worked = Object.values(employeeStats).map(s => s.worked);
hoursChart = new Chart(ctx, {
type: 'bar',
data: {
labels: labels,
datasets: [
{
label: 'Scheduled Hours',
data: scheduled,
backgroundColor: 'rgba(44, 82, 130, 0.8)',
borderColor: 'rgba(44, 82, 130, 1)',
borderWidth: 2
},
{
label: 'Worked Hours',
data: worked,
backgroundColor: 'rgba(34, 197, 94, 0.8)',
borderColor: 'rgba(34, 197, 94, 1)',
borderWidth: 2
}
]
},
options: {
responsive: true,
maintainAspectRatio: false,
scales: {
y: {
beginAtZero: true,
ticks: {
callback: function(value) {
return formatTime(value);
}
}
}
}
}
});
}
// ========== COMPARISON ==========
function changeComparePeriod() {
const period = document.getElementById('comparePeriod').value;
document.getElementById('compareDailyGroup').style.display = period === 'daily' ? 'block' : 'none';
document.getElementById('compareWeeklyGroup').style.display = period === 'weekly' ? 'block' : 'none';
document.getElementById('compareMonthlyGroup').style.display = period === 'monthly' ? 'block' : 'none';
document.getElementById('compareCustomGroup').style.display = period === 'custom' ? 'block' : 'none';
document.getElementById('compareCustomEndGroup').style.display = period === 'custom' ? 'block' : 'none';
loadComparison();
}
async function loadComparison() {
const period = document.getElementById('comparePeriod').value;
let startDate, endDate;
if (period === 'daily') {
startDate = document.getElementById('compareDate').value;
endDate = startDate;
} else if (period === 'weekly') {
startDate = document.getElementById('compareWeek').value;
const weekEnd = new Date(startDate);
weekEnd.setDate(weekEnd.getDate() + 6);
endDate = weekEnd.toISOString().split('T')[0];
} else if (period === 'monthly') {
const month = document.getElementById('compareMonth').value;
startDate = `${month}-01`;
endDate = `${month}-31`;
} else {
startDate = document.getElementById('compareStart').value;
endDate = document.getElementById('compareEnd').value;
}
try {
const { data: schedules } = await supabaseClient
.from('employee_schedules')
.select('*')
.gte('schedule_date', startDate)
.lte('schedule_date', endDate);
const { data: logs } = await supabaseClient
.from('task_time_logs')
.select(`
*,
kitchen_prep_employees(name)
`)
.gte('date', startDate)
.lte('date', endDate);
const employees = [...new Set([
...(schedules?.map(s => s.employee_name) || []),
...(logs?.map(l => l.kitchen_prep_employees?.name) || [])
])];
let html = '';
employees.forEach(emp => {
const empSchedules = schedules?.filter(s => s.employee_name === emp) || [];
const empLogs = logs?.filter(l => l.kitchen_prep_employees?.name === emp && l.end_time) || [];
const scheduledMinutes = empSchedules.reduce((sum, s) =>
sum + calculateHours(s.start_time, s.end_time), 0);
const workedMinutes = empLogs.reduce((sum, l) =>
sum + (new Date(l.end_time) - new Date(l.start_time)) / (1000 * 60), 0);
const breakMinutes = empSchedules.reduce((sum, s) => sum + (s.break_minutes || 60), 0);
const variance = workedMinutes - scheduledMinutes;
const variancePercent = scheduledMinutes > 0 ? ((variance / scheduledMinutes) * 100).toFixed(1) : 0;
html += `
<div class="comparison-card">
<h4>${emp}</h4>
<div class="metric-row">
<span class="metric-label">Scheduled Hours</span>
<span class="metric-value">${formatTime(scheduledMinutes)}</span>
</div>
<div class="metric-row">
<span class="metric-label">Worked Hours</span>
<span class="metric-value">${formatTime(workedMinutes)}</span>
</div>
<div class="metric-row">
<span class="metric-label">Break Time</span>
<span class="metric-value">${formatTime(breakMinutes)}</span>
</div>
<div class="metric-row">
<span class="metric-label">Variance</span>
<span class="metric-value" style="color: ${variance >= 0 ? '#22c55e' : '#ef4444'}">
${variance >= 0 ? '+' : ''}${formatTime(variance)} (${variancePercent}%)
</span>
</div>
<div class="metric-row">
<span class="metric-label">Tasks Completed</span>
<span class="metric-value">${empLogs.length}</span>
</div>
</div>
`;
});
document.getElementById('comparisonGrid').innerHTML = html || '<p style="grid-column: 1/-1; text-align: center; color: #718096;">No data found</p>';
} catch (error) {
console.error('Error loading comparison:', error);
}
}
// ========== GAP ANALYSIS ==========
function changeGapPeriod() {
const period = document.getElementById('gapPeriod').value;
document.getElementById('gapDailyGroup').style.display = period === 'daily' ? 'block' : 'none';
document.getElementById('gapWeeklyGroup').style.display = period === 'weekly' ? 'block' : 'none';
document.getElementById('gapMonthlyGroup').style.display = period === 'monthly' ? 'block' : 'none';
document.getElementById('gapCustomGroup').style.display = period === 'custom' ? 'block' : 'none';
document.getElementById('gapCustomEndGroup').style.display = period === 'custom' ? 'block' : 'none';
loadGapAnalysis();
}
async function loadGapAnalysis() {
  const period = document.getElementById('gapPeriod').value;
  const selectedEmployee = document.getElementById('gapEmployee')?.value || '';

  let startDate, endDate;
  if (period === 'daily') {
    startDate = document.getElementById('gapDate').value;
    endDate = startDate;
  } else if (period === 'weekly') {
    startDate = document.getElementById('gapWeek').value;
    const weekEnd = new Date(startDate);
    weekEnd.setDate(weekEnd.getDate() + 6);
    endDate = weekEnd.toISOString().split('T')[0];
  } else if (period === 'monthly') {
    const month = document.getElementById('gapMonth').value;
    startDate = `${month}-01`;
    endDate = `${month}-31`;
  } else {
    startDate = document.getElementById('gapStart').value;
    endDate = document.getElementById('gapEnd').value;
  }

  try {
    let schedulesQuery = supabaseClient
      .from('employee_schedules')
      .select('employee_name, schedule_date, start_time, end_time, break_minutes')
      .gte('schedule_date', startDate)
      .lte('schedule_date', endDate);

    let logsQuery = supabaseClient
      .from('task_time_logs')
      .select(`
        *,
        kitchen_prep_employees(name),
        kitchen_tasks(name)
      `)
      .gte('date', startDate)
      .lte('date', endDate);

    if (selectedEmployee) {
      schedulesQuery = schedulesQuery.eq('employee_name', selectedEmployee);
      logsQuery = logsQuery.eq('kitchen_prep_employees.name', selectedEmployee);
    }

    const { data: schedules, error: schErr } = await schedulesQuery;
    if (schErr) throw schErr;

    const scheduleMap = new Map();
    (schedules || []).forEach(s => {
      const key = `${s.employee_name}|${s.schedule_date}`;
      scheduleMap.set(key, {
        start: s.start_time,
        end: s.end_time,
        breakMinutes: (s.break_minutes ?? 60)
      });
    });

    const { data: logs, error: logErr } = await logsQuery;
    if (logErr) throw logErr;

    // Sort by employee, then date, then start_time
    (logs || []).sort((a, b) => {
      const empA = a.kitchen_prep_employees?.name || '';
      const empB = b.kitchen_prep_employees?.name || '';
      if (empA !== empB) return empA.localeCompare(empB);

      const dateA = a.date || '';
      const dateB = b.date || '';
      if (dateA !== dateB) return dateA.localeCompare(dateB);

      return new Date(a.start_time) - new Date(b.start_time);
    });

    const gaps = [];
    const lastEndByEmpDate = {};
    const gapSumByEmpDate = {};

    (logs || []).forEach(log => {
      if (!log.end_time) return;

      const emp = log.kitchen_prep_employees?.name;
      const logDate = log.date || (log.start_time ? log.start_time.split('T')[0] : null);
      if (!emp || !logDate) return;

      const key = `${emp}|${logDate}`;
      const schedule = scheduleMap.get(key);

      // Shift window (if schedule exists) in Chicago time
      const scheduledStart = schedule ? new Date(toCSTISOString(logDate, schedule.start)) : null;
      const scheduledEnd = schedule ? new Date(toCSTISOString(logDate, schedule.end)) : null;

      const taskStart = new Date(log.start_time);
      const taskEnd = new Date(log.end_time);

      // Clamp lastEnd to shift end if tasks spill late
      if (!lastEndByEmpDate[key]) {
        // First task of day: set lastEnd to min(taskEnd, scheduledEnd) if schedule exists
        lastEndByEmpDate[key] = (scheduledEnd && taskEnd > scheduledEnd) ? scheduledEnd.toISOString() : log.end_time;
        return;
      }

      const previousEnd = new Date(lastEndByEmpDate[key]);

      // Gap candidate between previous task end and this task start
      let gapStart = previousEnd;
      let gapEnd = taskStart;

      // Never allow cross-day gaps (key already prevents it, but keep safe)
      if (gapEnd <= gapStart) {
        lastEndByEmpDate[key] = (scheduledEnd && taskEnd > scheduledEnd) ? scheduledEnd.toISOString() : log.end_time;
        return;
      }

      let withinSchedule = false;
      let effectiveGapStart = gapStart;
      let effectiveGapEnd = gapEnd;

      if (scheduledStart && scheduledEnd) {
        // Only count gaps inside the scheduled shift window
        effectiveGapStart = gapStart < scheduledStart ? scheduledStart : gapStart;
        effectiveGapEnd = gapEnd > scheduledEnd ? scheduledEnd : gapEnd;
        withinSchedule = (effectiveGapStart < effectiveGapEnd);
      }

      if (!scheduledStart || !scheduledEnd) {
        // No schedule: still record the raw gap for that day (but flagged)
        withinSchedule = false;
      }

      if (effectiveGapStart < effectiveGapEnd) {
        const gapMinutes = (effectiveGapEnd - effectiveGapStart) / (1000 * 60);

        // Ignore tiny gaps (<= 5 minutes)
        if (gapMinutes > 5) {
          gaps.push({
            employee: emp,
            date: logDate,
            gapStart: effectiveGapStart.toISOString(),
            gapEnd: effectiveGapEnd.toISOString(),
            duration: gapMinutes,
            nextTask: log.kitchen_tasks?.name || 'N/A',
            withinSchedule,
            scheduledStart: schedule?.start || null,
            scheduledEnd: schedule?.end || null,
            breakMinutes: schedule?.breakMinutes ?? 60
          });

          gapSumByEmpDate[key] = (gapSumByEmpDate[key] || 0) + gapMinutes;
        }
      }

      // Update lastEnd (clamp to shift end if needed)
      lastEndByEmpDate[key] = (scheduledEnd && taskEnd > scheduledEnd) ? scheduledEnd.toISOString() : log.end_time;
    });

    // Compute net gap after break allowance (per employee per day)
    const netByEmpDate = {};
    Object.entries(gapSumByEmpDate).forEach(([key, raw]) => {
      const schedule = scheduleMap.get(key);
      const breakMin = schedule?.breakMinutes ?? 60;
      netByEmpDate[key] = Math.max(0, raw - breakMin);
    });

    // Render
    let html = '';
    if (gaps.length === 0) {
      html = '<p style="text-align: center; color: #718096; padding: 24px;">No significant gaps found (gaps > 5 minutes inside scheduled hours)</p>';
    } else {
      html = '<table class="schedule-table"><thead><tr><th>Date</th><th>Employee</th><th>Gap Start</th><th>Gap End</th><th>Duration</th><th>Next Task</th><th>Shift</th><th>In Shift?</th></tr></thead><tbody>';

      gaps.forEach(g => {
        const startLabel = new Date(g.gapStart).toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: 'numeric', minute: '2-digit' });
        const endLabel = new Date(g.gapEnd).toLocaleTimeString('en-US', { timeZone: 'America/Chicago', hour: 'numeric', minute: '2-digit' });

        html += `
          <tr style="${g.withinSchedule ? '' : 'background: #fef3c7;'}">
            <td>${formatDate(g.date)}</td>
            <td><strong>${g.employee}</strong></td>
            <td>${startLabel}</td>
            <td>${endLabel}</td>
            <td><span class="badge ${g.duration > 30 ? 'danger' : 'warning'}">${formatTime(g.duration)}</span></td>
            <td>${g.nextTask}</td>
            <td>${g.scheduledStart ? `${g.scheduledStart} - ${g.scheduledEnd}` : 'No schedule'}</td>
            <td>${g.withinSchedule ? '<span class="badge success">YES</span>' : '<span class="badge warning">NO</span>'}</td>
          </tr>
        `;
      });

      html += '</tbody></table>';

      const rawTotal = gaps.reduce((sum, g) => sum + g.duration, 0);
      const netTotal = Object.values(netByEmpDate).reduce((sum, v) => sum + v, 0);

      html += `
        <div class="gap-alert">
          ‚ö†Ô∏è Raw gaps: ${formatTime(rawTotal)} across ${gaps.length} gaps.
          <br>
          ‚úÖ Net gaps (after 60m break per day): <strong>${formatTime(netTotal)}</strong>
          ${selectedEmployee ? '' : '<br><small>Tip: Use the Employee filter to validate one person (example: Leydi Diaz).</small>'}
        </div>
      `;
    }

    document.getElementById('gapList').innerHTML = html;
  } catch (error) {
    console.error('Error loading gap analysis:', error);
    document.getElementById('gapList').innerHTML = '<p style="color: #ef4444; text-align: center; padding: 24px;">Error loading gap analysis</p>';
  }
}
const CHICAGO_TZ = 'America/Chicago';
function getChicagoDateStr(d = new Date()) {
return new Intl.DateTimeFormat('en-CA', {
timeZone: CHICAGO_TZ,
year: 'numeric',
month: '2-digit',
day: '2-digit'
}).format(d);
}
function getChicagoOffsetForDate(dateStr) {
const probe = new Date(`${dateStr}T12:00:00Z`);
const parts = new Intl.DateTimeFormat('en-US', {
timeZone: CHICAGO_TZ,
timeZoneName: 'shortOffset'
}).formatToParts(probe);
const tz = parts.find(p => p.type === 'timeZoneName')?.value || 'GMT-6';
const m = tz.match(/GMT([+-])(\d{1,2})(?::?(\d{2}))?/);
if (!m) return '-06:00';
const sign = m[1];
const hh = String(m[2]).padStart(2, '0');
const mm = String(m[3] || '00').padStart(2, '0');
return `${sign}${hh}:${mm}`;
}
function toChicagoISOString(dateStr, timeStr) {
const offset = getChicagoOffsetForDate(dateStr);
const chicagoLocal = `${dateStr}T${timeStr}:00${offset}`;
return new Date(chicagoLocal).toISOString();
}
</script>
</body>
</html>
