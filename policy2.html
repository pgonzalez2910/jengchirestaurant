<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-950">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Handbook Access</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-bg': '#0B1220','jc-card':'#0F172A','jc-border':'#1F2A44',
            'jc-primary':'#E5E7EB','jc-muted':'#9CA3AF','jc-blue':'#60A5FA',
            'jc-green':'#34D399','jc-red':'#F87171','jc-gold':'#C0A06D'
          },
          borderRadius:{'xl2':'1.25rem'}, boxShadow:{'soft':'0 10px 30px rgba(0,0,0,.35)'}
        }
      }
    };
  </script>
</head>
<body class="h-full bg-slate-950 text-jc-primary font-sans antialiased">
  <div class="min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-5xl bg-jc-card/80 backdrop-blur rounded-xl2 shadow-soft border border-jc-border overflow-hidden">
      <div class="grid grid-cols-1 md:grid-cols-2">
        <!-- LEFT -->
        <div class="p-8 md:p-10">
          <div class="flex items-center gap-3 mb-6">
            <img src="https://raw.githubusercontent.com/pe7er/jengchi-assets/main/logo-vertical.png" alt="Jeng Chi" class="h-10 w-auto">
            <h1 class="font-serif-head text-2xl">Sign in</h1>
          </div>
          <div class="space-y-4">
            <label class="block">
              <span class="block text-sm text-jc-muted mb-1">Username</span>
              <input id="username" type="text" placeholder="JT"
                class="w-full bg-slate-900/60 border border-jc-border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-jc-blue" />
            </label>
            <label class="block">
              <span class="block text-sm text-jc-muted mb-1">PIN</span>
              <input id="pin" type="password" inputmode="numeric" placeholder="••••"
                class="w-full bg-slate-900/60 border border-jc-border rounded-lg px-3 py-2 outline-none focus:ring-2 focus:ring-jc-blue" />
            </label>
            <button id="unlockBtn"
              class="w-full bg-slate-800 hover:bg-slate-700 border border-jc-border rounded-lg px-4 py-2 font-semibold transition">
              Unlock
            </button>
            <p class="text-xs text-jc-muted">After a successful login, the handbook and acknowledgment will unlock.</p>
            <p id="error" class="text-sm text-jc-red hidden"></p>
            <p id="ok" class="text-sm text-jc-green hidden"></p>
          </div>
        </div>
        <!-- RIGHT -->
        <div class="p-8 md:p-10 border-t md:border-t-0 md:border-l border-jc-border bg-slate-900/30">
          <h2 class="font-serif-head text-xl mb-4">Handbook Access</h2>
          <div id="locked" class="text-jc-muted">Please sign in to load your profile, policies, and progress.</div>
          <div id="unlocked" class="hidden space-y-6">
            <div class="flex items-center justify-between gap-3">
              <div>
                <div class="text-sm uppercase tracking-wide text-jc-muted mb-2">Profile</div>
                <div id="profile" class="text-sm bg-slate-900/50 border border-jc-border rounded-lg p-3"></div>
              </div>
              <a id="openPdfBtn" href="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf" target="_blank"
                 class="shrink-0 bg-jc-blue/20 hover:bg-jc-blue/30 border border-jc-border rounded-lg px-4 py-2 text-sm">
                Open Handbook PDF
              </a>
            </div>
            <div>
              <div class="text-sm uppercase tracking-wide text-jc-muted mb-2">Required Policies</div>
              <ul id="policies" class="text-sm space-y-2 max-h-64 overflow-auto pr-2"></ul>
            </div>
            <div>
              <div class="text-sm uppercase tracking-wide text-jc-muted mb-2">Progress</div>
              <div id="progress" class="text-sm bg-slate-900/50 border border-jc-border rounded-lg p-3"></div>
            </div>
            <div class="flex gap-2">
              <button id="refreshBtn" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-jc-border rounded-lg px-4 py-2 text-sm">Refresh</button>
              <button id="finalizeBtn" class="flex-1 bg-jc-blue/20 hover:bg-jc-blue/30 border border-jc-border rounded-lg px-4 py-2 text-sm">Finalize</button>
              <button id="logoutBtn" class="flex-1 bg-slate-800 hover:bg-slate-700 border border-jc-border rounded-lg px-4 py-2 text-sm">Logout</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

<script type="module">
/* ========= CONFIG ========= */
const API_BASE = 'https://kpldzwlftkvjjntgsqxx.functions.supabase.co/handbook';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs';

const $ = (id) => document.getElementById(id);
const state = {
  get token() { return localStorage.getItem('hb_token') || ''; },
  set token(v) { v ? localStorage.setItem('hb_token', v) : localStorage.removeItem('hb_token'); },
  username: null
};

function showError(msg){ $('ok').classList.add('hidden'); $('error').textContent = `⚠️ ${msg}`; $('error').classList.remove('hidden'); }
function showOK(msg){ $('error').classList.add('hidden'); $('ok').textContent = `✅ ${msg}`; $('ok').classList.remove('hidden'); }
function lockUI(locked=true){ $('locked').classList.toggle('hidden', !locked); $('unlocked').classList.toggle('hidden', locked); }

/* == fetch wrapper: adds BOTH headers == */
async function api(path, { method='GET', body=null } = {}) {
  const headers = {
    'Content-Type': 'application/json',
    // 1) Needed by Supabase platform to invoke the function
    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
  };
  // 2) Our app-level session token used by requireSession()
  if (state.token) headers['x-hb-token'] = state.token;

  const res = await fetch(`${API_BASE}${path}`, {
    method, headers, body: body ? JSON.stringify(body) : null
  });
  const text = await res.text();
  let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }
  if (!res.ok) throw new Error(data?.message || `${res.status} ${res.statusText}`);
  return data;
}

/* == login == */
$('unlockBtn').addEventListener('click', async () => {
  const u = $('username').value.trim();
  const p = $('pin').value.trim();
  if (!u || !p) { showError('Please enter username and PIN.'); return; }
  try {
    const { token } = await api('/login', { method:'POST', body:{ username: u, pin: p } });
    state.token = token; state.username = u;
    await loadAll();
    lockUI(false); showOK('Unlocked.');
  } catch (e) {
    state.token = ''; lockUI(true); showError(e.message || 'Login failed');
  }
});

/* == load after login == */
async function loadAll(){
  const header = await api('/header');
  state.username = header?.username ?? state.username;
  $('profile').textContent =
    `${header.full_name ?? '—'} • ${header.position ?? '—'} (${header.department ?? '—'}) • Reports to: ${header.reports_to_name ?? '—'} • Username: ${header.username ?? '—'}`;

  const [policies, acksMap, prog] = await Promise.all([ api('/policies'), api('/acks'), api('/progress') ]);

  const ul = $('policies'); ul.innerHTML = '';
  for (const p of policies) {
    const ack = acksMap[p.id];
    const li = document.createElement('li');
    li.className = 'bg-slate-900/50 border border-jc-border rounded px-3 py-2';
    li.innerHTML = `
      <div class="flex items-center justify-between gap-3">
        <span>${p.required ? '<span class="text-jc-gold">•</span> ' : ''}${p.title}</span>
        <span class="text-xs ${ack ? 'text-jc-green' : 'text-jc-muted'}">
          ${ack ? `✓ ${ack.initials} · ${new Date(ack.saved_at).toLocaleString()}` : 'pending'}
        </span>
      </div>
      <div class="mt-2 flex gap-2">
        <input type="text" placeholder="Your initials" value="${state.username ?? ''}" data-initials class="flex-1 bg-slate-900/60 border border-jc-border rounded px-2 py-1 text-sm">
        <button data-save class="shrink-0 bg-slate-800 hover:bg-slate-700 border border-jc-border rounded px-3 py-1 text-sm">Save Ack</button>
      </div>`;
    const saveBtn = li.querySelector('[data-save]');
    const initialsInput = li.querySelector('[data-initials]');
    saveBtn.addEventListener('click', async () => {
      const initials = initialsInput.value.trim();
      if (!initials) { showError('Enter your initials.'); return; }
      try { await api('/save-ack', { method:'POST', body:{ policy_id: p.id, initials } });
            showOK(`Saved for "${p.title}".`); await loadAll(); }
      catch (e) { showError(e.message); }
    });
    ul.appendChild(li);
  }
  $('progress').textContent = `${prog.done_cnt}/${prog.required_cnt} required completed — ${prog.percent_done}%`;
}

/* == buttons == */
$('refreshBtn').addEventListener('click', async () => { try { await loadAll(); showOK('Refreshed.'); } catch(e){ showError(e.message); } });
$('finalizeBtn').addEventListener('click', async () => {
  try { const res = await api('/finalize', { method:'POST', body:{} });
        showOK(`Finalized at ${new Date(res.finalized_at).toLocaleString()}`); }
  catch(e){ showError(e.message); }
});
$('logoutBtn').addEventListener('click', () => { state.token = ''; lockUI(true); showOK('Logged out.'); });

/* == auto-resume == */
window.addEventListener('DOMContentLoaded', async () => {
  if (state.token) {
    try { await loadAll(); lockUI(false); showOK('Session restored.'); }
    catch { state.token=''; lockUI(true); }
  }
});
</script>
</body>
</html>
