<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook (Section I)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#1F2937',
            'jc-secondary': '#334155',
            'jc-gold': '#C0A06D',
            'jc-border': '#E2E8F0',
          },
          boxShadow: {
            'soft': '0 12px 40px rgba(0,0,0,.08)',
            'glow': '0 0 0 1px rgba(255,255,255,.3), 0 20px 60px rgba(0,0,0,.18)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .prose-handbook h2, .prose-handbook h3 { font-family: 'Playfair Display', serif; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <!-- Glossy gradient bg -->
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-30" style="
    background:
      radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
      radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
      radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);
  "></div>

  <!-- ===================== LOGIN (visible first) ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <!-- top: centered logo -->
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <!-- form -->
        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., jteng"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <!-- footer info -->
        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP (hidden until login) ===================== -->
  <div id="appView" class="hidden">
    <!-- Top-right address & copyright -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex justify-end">
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- Centered logo -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex justify-center">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo"
             class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
      </div>
    </header>

    <!-- Employee Information (auto-filled, no manual inputs) -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div>
              <div class="text-slate-500">Employee</div>
              <div id="fi_name" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">User</div>
              <div id="fi_user" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Position</div>
              <div id="fi_position" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Department</div>
              <div id="fi_department" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Reports to</div>
              <div id="fi_reports_to" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Email</div>
              <div id="fi_email" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Phone</div>
              <div id="fi_phone" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Session started</div>
              <div id="fi_session_started" class="font-medium">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Section I content and acks -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-6 pb-24">
      <div class="rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 class="font-serif-head text-3xl text-jc-primary tracking-tight">Section I — Introduction</h1>
          <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>. “Next Section” unlocks when all are saved.</p>
        </div>

        <!-- Progress -->
        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="progCount" class="font-semibold">0</span>/<span id="progTotal">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="progBar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <!-- Policies container -->
        <div id="policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <button id="btnBack" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Back</button>
          <button id="btnNext" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Next Section</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM HOOKS ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');

    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const policiesEl   = document.getElementById('policies');
    const btnNext      = document.getElementById('btnNext');
    const btnBack      = document.getElementById('btnBack');
    const progCountEl  = document.getElementById('progCount');
    const progTotalEl  = document.getElementById('progTotal');
    const progBar      = document.getElementById('progBar');

    /* ========= UTIL ========= */
    const STORE_PREFIX = 'jc_section_i_';
    const CODE_RE = /^(\d+\.\d+)/;
    const wantedCodes = ["1.1","1.2","1.3","1.4","1.5","1.6","1.7"];
    function extractCode(title=''){ const m = String(title).toUpperCase().match(CODE_RE); return m ? m[1] : null; }
    function safe(v, dash='—'){ return (v===null || v===undefined || v==='') ? dash : v; }
    function toast(el, msg, ok=false){ el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); }

    function setSession(data){ localStorage.setItem('hb_session', JSON.stringify(data)); }
    function getHbSession(){ try { return JSON.parse(localStorage.getItem('hb_session')||'{}'); } catch { return {}; } }
    function getSessionInitials(){ const s = getHbSession(); return s?.initials ? String(s.initials).toUpperCase() : ''; }
    function getSessionId(){ const sid = localStorage.getItem('hb_session_id'); return sid ? Number(sid) : null; }
    function getSessionStartedAt(){ return localStorage.getItem('hb_session_started_at') || new Date().toISOString(); }

    /* ========= LOGIN FLOW ========= */
    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        if(error){ console.warn('hb_start_session error', error); }
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId){
          localStorage.setItem('hb_session_id', String(sessionId));
          localStorage.setItem('hb_session_started_at', startedAt);
        }
        return { sessionId, startedAt };
      }catch(e){
        console.warn('start session threw', e);
        const startedAt = new Date().toISOString();
        localStorage.setItem('hb_session_started_at', startedAt);
        return { sessionId: null, startedAt };
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }

      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });

        if (error) { loginMsg.textContent = error.message || 'Login failed'; return; }

        const row = Array.isArray(data) ? data[0] : data;
        if (!row) { loginMsg.textContent = 'Invalid credentials'; return; }

        const s = {
          username: u,
          initials: (row.initials || '').toUpperCase(),
          employee_id: row.employee_id || null,
          full_name: row.full_name || null,
          position: row.position || null,
          department: row.department || null,
          is_owner: !!row.is_owner,
          email: row.email || null,
          phone: row.phone || null,
          reports_to: row.reports_to || null
        };

        setSession(s);
        await startRemoteSession(s.initials);
        loginMsg.textContent = 'Welcome.';
        showApp();
        await bootApp();
      }catch(e){
        loginMsg.textContent = 'Login error';
        console.error(e);
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    /* ========= EMPLOYEE CARD ========= */
    async function fillEmployeeCard(){
      const initials = getSessionInitials();
      const started  = getSessionStartedAt();

      document.getElementById('fi_user').textContent = safe(initials);
      document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

      if(!initials){ return; }

      // Prefer data returned by login:
      const s = getHbSession();
      if (s?.full_name || s?.position || s?.department) {
        document.getElementById('fi_name').textContent        = safe(s.full_name);
        document.getElementById('fi_position').textContent    = safe(s.position);
        document.getElementById('fi_department').textContent  = safe(s.department);
        document.getElementById('fi_reports_to').textContent  = safe(s.reports_to);
        document.getElementById('fi_email').textContent       = safe(s.email);
        document.getElementById('fi_phone').textContent       = safe(s.phone);
        return;
      }

      // Fallback query (if needed)
      const { data, error } = await client
        .from('hb_employees')
        .select('full_name, position, department, reports_to, email, phone')
        .eq('initials', initials)
        .maybeSingle();

      if(error){ console.warn('hb_employees error', error); }

      const e = data || {};
      document.getElementById('fi_name').textContent        = safe(e.full_name);
      document.getElementById('fi_position').textContent    = safe(e.position);
      document.getElementById('fi_department').textContent  = safe(e.department);
      document.getElementById('fi_reports_to').textContent  = safe(e.reports_to || e.manager_name);
      document.getElementById('fi_email').textContent       = safe(e.email);
      document.getElementById('fi_phone').textContent       = safe(e.phone);
    }

    /* ========= SECTION I CONTENT ========= */
    const SECTION_I = [
      {
        code: "1.1",
        title: "Welcome to Jeng Chi Restaurant",
        html: `<p>We are pleased to have you join our team here at Jeng Chi. This restaurant has been operating since 1990 and we would like to recognize our employees as our most valuable resource for our continuous success. Our capability in providing customers with authentic Taiwanese food and an enjoyable customers dining experience depends on having high quality people like yourself and your fellow employees. We want you to enjoy your time with us here and we are committed to helping you succeed in your new job opportunity.</p>`
      },
      {
        code: "1.2",
        title: "Employee Handbook — Purpose and Coverage",
        html: `<p>This Employee Handbook (“Handbook”) summarizes key personnel policies, benefits, and workplace standards of Jeng Chi Restaurant (the “Company”), 400 N. Greenville Avenue, Suite 11, Richardson, Texas 75081. It applies to all employees and is intended to promote consistent, lawful practices in accordance with guidance from the Texas Workforce Commission (TWC) and applicable federal, state, and local laws. Compliance with this Handbook is a condition of employment.</p>`
      },
      {
        code: "1.3",
        title: "Disclaimer, Employment-At-Will & Management Approval Authority",
        html: `
          <p><strong>Purpose.</strong> This section clarifies the nature of employment at Jeng Chi Restaurant (“The Company”), explains how handbook policies may change, and sets the approval standard for any changes to an employee’s position or pay.</p>
          <p><strong>Not a Contract.</strong> This handbook is a general guide to THE COMPANY policies and does not create a contract, guarantee of employment, or promise of specific terms or continued employment. Nothing in this handbook alters the at-will employment relationship, which may be ended by the employee or by THE COMPANY at any time, with or without notice and with or without cause, to the extent permitted by law.</p>
          <p><strong>Right to Modify.</strong> THE COMPANY may interpret, revise, suspend, or discontinue any policy, benefit, or practice described in this handbook at any time, with or without notice, except where advance notice is required by law. If there is a conflict between this handbook and an official plan document (for example, insurance plan documents), the official plan document controls.</p>
          <p><strong>No Unauthorized Promises.</strong> Only a written agreement signed by Janelle Teng or Francisco Teng may modify the at-will relationship or these approval requirements.</p>
          <p><strong>Equal Employment & Non-Retaliation.</strong> All decisions regarding hiring, compensation, scheduling, promotion, demotion, and separation are made based on legitimate business reasons and in compliance with federal, state, and local law. THE COMPANY prohibits unlawful discrimination and retaliation. Employees who raise good-faith concerns or participate in investigations are protected from retaliation.</p>
        `
      },
      {
        code: "1.4",
        title: "Approval Authority for Position & Pay Changes",
        html: `
          <p>To ensure consistency, internal controls, and legal compliance:</p>
          <p><strong>Scope — Prior written approval is required for:</strong></p>
          <ul>
            <li><strong>Pay changes:</strong> Base rate/hourly rate adjustments, salary adjustments, tip-differential changes, bonuses unrelated to formulaic programs, or changes to incentive plans.</li>
            <li><strong>Position changes:</strong> Promotions, demotions, reclassifications (e.g., full-time/part-time status), title changes, and changes in FLSA exemption status.</li>
            <li><strong>Work schedule/pay basis changes</strong> affecting overtime eligibility (e.g., moving from salary to hourly, or vice versa).</li>
          </ul>
          <p><strong>Authorized approvers.</strong> Written approval by either: <em>Janelle Teng (Owner)</em> or <em>Francisco Teng (Owner)</em>. Delegations must be in writing and kept on file.</p>
          <p><strong>Effective dates.</strong> Changes become effective only after written approval and written notice to the employee. Retroactive changes are prohibited unless required to correct an error or ensure legal compliance.</p>
          <p><strong>Invalid changes.</strong> Unapproved promises/changes are void and will be corrected. Employees should report concerns to HR.</p>
        `
      },
      {
        code: "1.5",
        title: "Administration and Changes",
        html: `<p>The Company may modify, rescind, delete, or add policies at any time, in its sole discretion, with or without advance notice, consistent with applicable law. Policy updates may be communicated by revised Handbook pages, written memoranda, email, the HR system, or postings on the employee bulletin board. Unless an effective date is stated, changes are effective upon communication. Employees are responsible for reviewing and complying with updated policies.</p>`
      },
      {
        code: "1.6",
        title: "Interpretation; Deviation; No Past-Practice Rights",
        html: `
          <p>The Company retains discretion to interpret and apply this Handbook and, where appropriate, to deviate from stated procedures based on the facts and business needs of a particular situation, consistent with applicable law. No supervisor’s verbal statement, prior practice, or past decision creates a binding rule, promise of continued employment, or contractual right. Nothing in this Handbook requires the Company to use progressive discipline or follow any specific sequence of corrective steps; the Company may proceed directly to any level of discipline, including termination, where warranted by the circumstances and applicable law.</p>
          <p><strong>Supersession.</strong> This Handbook supersedes and replaces all prior handbooks, policies, and summaries on the same subjects, including the Employee Handbook dated August 2024. To the extent of any conflict between this Handbook and earlier materials, this Handbook controls. (If any policy conflicts with applicable law or an official plan document, the law/plan controls.)</p>
        `
      },
      {
        code: "1.7",
        title: "Conflicts with Law or Other Documents",
        html: `<p>If a policy conflicts with applicable law, the law controls, and the policy will be interpreted or modified to comply. If a conflict exists between this Handbook and an official plan document (for example, a group health plan), the plan document controls. If this Handbook is translated, the English version controls in the event of any inconsistency.</p>`
      }
    ];

    function policyCardTemplate(item){
      const inputId = `init_${item.code.replace('.','_')}`;
      const saved = localStorage.getItem(STORE_PREFIX + item.code);
      const initialsValue = saved ? JSON.parse(saved)?.initials || '' : '';

      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
                <div class="text-[15px] leading-7 text-slate-700">${item.html}</div>
              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${initialsValue}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves to your record.</div>
                </div>
              </div>
            </div>
          </div>
        </article>
      `;
    }

    function renderPolicies(){
      progTotalEl.textContent = SECTION_I.length;
      policiesEl.innerHTML = SECTION_I.map(policyCardTemplate).join('');
    }

    /* ========= SUPABASE: policy lookup & save ========= */
    let POLICY_META = {}; // { "1.1": { id, title }, ... }

    async function loadSectionIPolicies(){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending: true });
      if(error){ console.warn('hb_policies error', error); }

      const meta = {};
      (data||[]).forEach(r=>{
        const code = extractCode(r.title);
        if(code && wantedCodes.includes(code)){
          meta[code] = { id: r.id, title: r.title };
        }
      });
      wantedCodes.forEach(c => { if(!meta[c]) meta[c] = { id: null, title: `Section I ${c}` }; });
      POLICY_META = meta;
    }

    async function prefillSavedAcks(initials){
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);
      if(error){ console.warn('hb_acks prefill error', error); return; }
      const byId = new Map((data||[]).map(r => [r.policy_id, r]));
      for(const [code, meta] of Object.entries(POLICY_META)){
        if(!meta.id) continue;
        const row = byId.get(meta.id);
        if(row && row.agreed){
          localStorage.setItem(STORE_PREFIX + code, JSON.stringify({
            initials: (row.signed_initials || initials).toUpperCase(),
            ts: row.created_at
          }));
        }
      }
    }

    async function saveAckToDB({ initials, policyId }){
      const session_id = getSessionId();
      const hb = getHbSession();
      const employee_id = hb?.employee_id || null;

      // Try RPC first
      try{
        const { error } = await client.rpc('hb_ack_policy', {
          p_initials: initials,
          p_policy_id: policyId,
          p_signed_initials: initials,
          p_session_id: session_id,
          p_agreed: true
        });
        if(!error) return { ok:true };
        console.warn('hb_ack_policy RPC error:', error);
      }catch(e){ console.warn('hb_ack_policy threw:', e); }

      // Fallback: direct insert
      try{
        const payload = {
          policy_id: policyId,
          employee_initials: initials,
          signed_initials: initials,
          agreed: true,
          session_id: session_id
        };
        if (employee_id) payload.employee_id = employee_id;

        const { error } = await client.from('hb_acks').insert(payload);
        if(error){ console.error('hb_acks insert error', error); return { ok:false, error }; }
        return { ok:true };
      }catch(e){
        console.error('hb_acks insert threw', e);
        return { ok:false, error: e?.message || 'Insert failed' };
      }
    }

    function updateProgress(){
      const total = SECTION_I.length;
      let saved = 0;
      SECTION_I.forEach(i=>{ if(localStorage.getItem(STORE_PREFIX + i.code)) saved++; });
      progCountEl.textContent = saved;
      progBar.style.width = Math.round((saved/total)*100) + '%';

      const allDone = saved === total;
      btnNext.disabled = !allDone;
      if(allDone){
        btnNext.classList.remove('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.add('bg-emerald-600');
      }else{
        btnNext.classList.add('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.remove('bg-emerald-600');
      }
    }

    function bindSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const code = btn.getAttribute('data-code');
          const msgEl = document.getElementById(`msg_init_${code.replace('.','_')}`);
          const input = document.getElementById(`init_${code.replace('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toast(msgEl, 'Enter initials.'); return; }

          // local first
          localStorage.setItem(STORE_PREFIX + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));

          // db if we have a policy id
          const policyId = POLICY_META?.[code]?.id || null;
          if(policyId){
            const res = await saveAckToDB({ initials: typed, policyId });
            toast(msgEl, res.ok ? 'Saved.' : 'Saved locally (DB error).', res.ok);
          }else{
            toast(msgEl, 'Saved (local).', true);
          }

          updateProgress();
        });
      });
    }

    /* ========= NAV ========= */
    btnBack.addEventListener('click', ()=> { history.back(); });
    btnNext.addEventListener('click', ()=> {
      if(btnNext.disabled) return;
      alert('Next Section unlocked — navigate to Section II.');
    });

    /* ========= APP BOOT ========= */
    async function bootApp(){
      await fillEmployeeCard();
      renderPolicies();
      await loadSectionIPolicies();
      await prefillSavedAcks(getSessionInitials());
      bindSaveButtons();
      updateProgress();
    }

    /* ========= FIRST LOAD ========= */
    (async function init(){
      // If session already present (e.g., returning user), go straight to app.
      const s = getHbSession();
      if (s?.initials) {
        showApp();
        await bootApp();
        return;
      }
      // otherwise show login (default state)
      showLogin();
    })();
  </script>
</body>
</html>
