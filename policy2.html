<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], 'sans': ['Inter','system-ui','sans-serif'] },
          colors: { 'jc-primary':'#1F2937','jc-secondary':'#334155','jc-gold':'#C0A06D','jc-border':'#E2E8F0' },
          boxShadow: {
            'soft':'0 18px 80px rgba(0,0,0,.12)',
            'glow':'0 0 0 1px rgba(255,255,255,.3), 0 30px 80px rgba(0,0,0,.22)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .prose-handbook h2, .prose-handbook h3 { font-family: 'Playfair Display', serif; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <!-- glossy background -->
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="fixed inset-0 -z-10 pointer-events-none opacity-30"
       style="background:
        radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
        radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
        radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);">
  </div>

  <!-- ===================== LOGIN ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., jteng"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8"
                   class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP ===================== -->
  <div id="appView" class="hidden">
    <!-- top bar -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex items-start justify-between">
        <div></div>
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- logo + signout -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex items-center justify-between gap-3">
        <div class="flex-1"></div>
        <div class="w-full flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi logo"
               class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
        </div>
        <div class="flex-1 flex justify-end">
          <button id="btnSignOut" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Sign out</button>
        </div>
      </div>
    </header>

    <!-- employee card -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div><div class="text-slate-500">Employee</div><div id="fi_name" class="font-medium">—</div></div>
            <div><div class="text-slate-500">User</div><div id="fi_user" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Position</div><div id="fi_position" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Department</div><div id="fi_department" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Reports to</div><div id="fi_reports_to" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Email</div><div id="fi_email" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Phone</div><div id="fi_phone" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Session started</div><div id="fi_session_started" class="font-medium">—</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- tabs -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="flex flex-wrap gap-2">
        <button data-tab="I"   class="tabbtn rounded-xl px-4 py-2 text-sm bg-jc-primary text-white">Section I</button>
        <button data-tab="II"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section II</button>
        <button data-tab="III" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section III</button>
        <button data-tab="IV"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IV</button>
        <button data-tab="V"   class="tabbtn rounded-xl px-4 py-2 text-sm border">Section V</button>
        <button data-tab="VII" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VII</button>
        <button data-tab="VIII"class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VIII</button>
        <button data-tab="IX"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IX</button>
      </div>
    </section>

    <!-- section container -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-4 pb-24">
      <div class="rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 id="sectionTitle" class="font-serif-head text-3xl text-jc-primary tracking-tight">Section I — Introduction</h1>
          <p class="text-sm text-slate-600 mt-1">
            Initial each policy and press <span class="font-medium">Save</span>. “Next Section” unlocks when all are saved.
          </p>
        </div>

        <!-- progress -->
        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="progCount" class="font-semibold">0</span>/<span id="progTotal">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="progBar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <div id="policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <button id="btnBack" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Back</button>
          <button id="btnNext" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Next Section</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ========= SUPABASE CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM HOOKS ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');

    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const sectionTitle = document.getElementById('sectionTitle');
    const policiesEl   = document.getElementById('policies');
    const btnNext      = document.getElementById('btnNext');
    const btnBack      = document.getElementById('btnBack');
    const progCountEl  = document.getElementById('progCount');
    const progTotalEl  = document.getElementById('progTotal');
    const progBar      = document.getElementById('progBar');

    /* ========= UTIL ========= */
    const CODE_RE = /^(\d+\.\d+)/;
    function extractCode(title=''){ const m = String(title).toUpperCase().match(CODE_RE); return m ? m[1] : null; }
    function safe(v, dash='—'){ return (v===null || v===undefined || v==='') ? dash : v; }
    function toastInline(el, msg, ok=false){ el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); }

    function setSession(data){ localStorage.setItem('hb_session', JSON.stringify(data)); }
    function getHbSession(){ try { return JSON.parse(localStorage.getItem('hb_session')||'{}'); } catch { return {}; } }
    function getSessionInitials(){ const s=getHbSession(); return s?.initials ? String(s.initials).toUpperCase() : ''; }
    function getSessionId(){ const sid = localStorage.getItem('hb_session_id'); return sid ? Number(sid) : null; }
    function getSessionStartedAt(){ return localStorage.getItem('hb_session_started_at') || new Date().toISOString(); }

    // namespaced local cache (per employee) – prevents shared tablet bleed
    function currentUserKey() {
      const s = getHbSession();
      return s?.employee_id ? `emp_${s.employee_id}` : (s?.initials ? `init_${s.initials}` : 'anon');
    }
    function nsPrefix(base) { return `${currentUserKey()}__${base}`; }
    function clearNonCurrentUserCache() {
      const keep = currentUserKey();
      const keys = [];
      for (let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));
      keys.forEach(k=>{
        const isHandbookKey = k && k.includes('__jc_section_');
        const belongsToOther = isHandbookKey && !k.startsWith(keep + '__');
        if (belongsToOther) localStorage.removeItem(k);
      });
    }

    /* ========= LOGIN FLOW ========= */
    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        if(error){ console.warn('hb_start_session error', error); }
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId){
          localStorage.setItem('hb_session_id', String(sessionId));
          localStorage.setItem('hb_session_started_at', startedAt);
        }
        return { sessionId, startedAt };
      }catch(e){
        console.warn('start session threw', e);
        const startedAt = new Date().toISOString();
        localStorage.setItem('hb_session_started_at', startedAt);
        return { sessionId: null, startedAt };
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }
      loginMsg.textContent='';

      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });
        if(error){ loginMsg.textContent = error.message || 'Login failed'; return; }
        if(!data){ loginMsg.textContent = 'Invalid credentials'; return; }

        const s = {
          username: u,
          initials: (data.initials || '').toUpperCase(),
          employee_id: data.employee_id || null,
          full_name: data.full_name || null,
          position: data.position || null,
          department: data.department || null,
          is_owner: !!data.is_owner,
          email: data.email || null,
          phone: data.phone || null,
          reports_to: data.reports_to || null
        };

        setSession(s);
        await startRemoteSession(s.initials);
        clearNonCurrentUserCache();
        loginMsg.textContent = 'Welcome.';
        showApp();
        await bootApp();
      }catch(e){
        console.error(e);
        loginMsg.textContent = 'Login error';
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    // sign out
    function signOut(){
      const prefix = currentUserKey() + '__';
      const keys = [];
      for (let i=0;i<localStorage.length;i++) keys.push(localStorage.key(i));
      keys.forEach(k=>{ if(k && k.startsWith(prefix)) localStorage.removeItem(k); });
      localStorage.removeItem('hb_session');
      localStorage.removeItem('hb_session_id');
      localStorage.removeItem('hb_session_started_at');
      showLogin();
    }
    document.getElementById('btnSignOut')?.addEventListener('click', signOut);

    /* ========= EMPLOYEE CARD (robust fetch) ========= */
    async function fillEmployeeCard(){
      const initials = getSessionInitials();
      const started  = getSessionStartedAt();

      document.getElementById('fi_user').textContent = safe(initials);
      document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

      // 1) Use login payload if present
      const s = getHbSession();
      if (s?.full_name || s?.position || s?.department || s?.email || s?.phone) {
        document.getElementById('fi_name').textContent        = safe(s.full_name);
        document.getElementById('fi_position').textContent    = safe(s.position);
        document.getElementById('fi_department').textContent  = safe(s.department);
        document.getElementById('fi_reports_to').textContent  = safe(s.reports_to);
        document.getElementById('fi_email').textContent       = safe(s.email);
        document.getElementById('fi_phone').textContent       = safe(s.phone);
        return;
      }

      // 2) Try hb_employees by initials
      if (initials){
        let resp = await client.from('hb_employees')
          .select('full_name, position, department, reports_to, email, phone')
          .eq('initials', initials).maybeSingle();
        if (!resp.error && resp.data){
          const e = resp.data;
          document.getElementById('fi_name').textContent        = safe(e.full_name);
          document.getElementById('fi_position').textContent    = safe(e.position);
          document.getElementById('fi_department').textContent  = safe(e.department);
          document.getElementById('fi_reports_to').textContent  = safe(e.reports_to);
          document.getElementById('fi_email').textContent       = safe(e.email);
          document.getElementById('fi_phone').textContent       = safe(e.phone);
          return;
        }
      }

      // 3) Try employees by email (if username is an email, or if set in session)
      if (s?.email){
        let resp2 = await client.from('employees')
          .select('full_name, department, phone, "Current Reports To Employee"')
          .eq('email', s.email).maybeSingle();
        if (!resp2.error && resp2.data){
          const e = resp2.data;
          document.getElementById('fi_name').textContent        = safe(e.full_name);
          document.getElementById('fi_department').textContent  = safe(e.department);
          document.getElementById('fi_reports_to').textContent  = safe(e['Current Reports To Employee']);
          document.getElementById('fi_phone').textContent       = safe(e.phone);
          return;
        }
      }

      // 4) Fallback: hb_handbook_access by username ("user")
      if (s?.username){
        const resp3 = await client.from('hb_handbook_access')
          .select('employee_name, position, department, user')
          .eq('user', s.username).maybeSingle();
        if (!resp3.error && resp3.data){
          const e = resp3.data;
          document.getElementById('fi_name').textContent        = safe(e.employee_name);
          document.getElementById('fi_position').textContent    = safe(e.position);
          document.getElementById('fi_department').textContent  = safe(e.department);
          return;
        }
      }
    }

    /* ========= SECTIONS ========= */
    // Section I & II (unchanged from prior message)
    const SECTION_I = [
      { code: "1.1", title: "Welcome to Jeng Chi Restaurant", html: `<p>We are pleased to have you join our team here at Jeng Chi. This restaurant has been operating since 1990 and we would like to recognize our employees as our most valuable resource for our continuous success. Our capability in providing customers with authentic Taiwanese food and an enjoyable customers dining experience depends on having high quality people like yourself and your fellow employees. We want you to enjoy your time with us here and we are committed to helping you succeed in your new job opportunity.</p>` },
      { code: "1.2", title: "Employee Handbook — Purpose and Coverage", html: `<p>This Employee Handbook (“Handbook”) summarizes key personnel policies, benefits, and workplace standards of Jeng Chi Restaurant (the “Company”), 400 N. Greenville Avenue, Suite 11, Richardson, Texas 75081. It applies to all employees and is intended to promote consistent, lawful practices in accordance with guidance from the Texas Workforce Commission (TWC) and applicable federal, state, and local laws. Compliance with this Handbook is a condition of employment.</p>` },
      { code: "1.3", title: "Disclaimer, Employment-At-Will & Management Approval Authority", html: `
        <p><strong>Purpose.</strong> Clarifies at-will, change rights, and approval authority.</p>
        <p><strong>Not a Contract.</strong> This handbook is a guide and does not alter at-will status.</p>
        <p><strong>Right to Modify.</strong> Company may revise policies anytime, consistent with law.</p>
        <p><strong>No Unauthorized Promises.</strong> Only written agreements signed by owners can modify terms.</p>
        <p><strong>Equal Employment & Non-Retaliation.</strong> We comply with law and prohibit retaliation.</p>
      ` },
      { code: "1.4", title: "Approval Authority for Position & Pay Changes", html: `
        <p>Prior written approval required for pay/position/schedule basis changes. Authorized approvers: Janelle Teng or Francisco Teng.</p>
      ` },
      { code: "1.5", title: "Administration and Changes", html: `<p>Company may change policies; employees must review updates.</p>` },
      { code: "1.6", title: "Interpretation; Deviation; No Past-Practice Rights", html: `<p>Company may interpret/deviate as appropriate; no contractual rights created by past practice.</p>` },
      { code: "1.7", title: "Conflicts with Law or Other Documents", html: `<p>Law controls; English version governs if translated.</p>` }
    ];

    const SECTION_II = [
      { code: "2.1", title: "Employee Classifications", html: `<p>Exempt/Nonexempt; Full/Part/Temp; at-will.</p>` },
      { code: "2.2", title: "EEO & ADA", html: `<p>Equal opportunity; accommodation process; no retaliation.</p>` },
      { code: "2.3", title: "Introductory Period", html: `<p>First 60 days; training and review; I-9 within 3 business days.</p>` },
      { code: "2.4", title: "Reporting Discrimination/Harassment", html: `<p>Report to any manager or HR; prompt review; no retaliation.</p>` },
      { code: "2.5", title: "Required Certifications & Paid Training", html: `<p>Food Handler & TABC required where applicable; Company pays initial fee; paid training at Training Rate; renewals required.</p>` },
      { code: "2.6", title: "Paid Training – FLSA/TWC", html: `<p>Training is paid time; tipped training at full minimum wage; overtime uses blended rate.</p>` },
      { code: "2.7", title: "Parking", html: `<p>Park on Greenville or designated employee areas; guest spaces reserved.</p>` },
      { code: "2.8", title: "Required Notices & Postings", html: `<p>All required posters maintained; review as needed.</p>` }
    ];

    /* === Your provided Sections III–IX === */

    // --- Section III (3.1–3.15) ---
    const SECTION_III = [
      { code:"3.1", title:"Pay Periods & Paydays (Texas Payday Law)", html:`<p>Bi-weekly, payday every other Friday via direct deposit or check.</p>` },
      { code:"3.2", title:"Workweek & Hours of Work + Sling Setup", html:`<p>Workweek Sun–Sat for OT; Sling app setup and notifications; no off-the-clock work.</p>` },
      { code:"3.3", title:"Timekeeping (All Employees)", html:`<p>Record all time; missed punch procedure; clock window rule (±7 minutes; >7 needs approval).</p>` },
      { code:"3.4", title:"Timekeeping: Training", html:`<p>Record all required training time; paid; schedule rules.</p>` },
      { code:"3.5", title:"Timekeeping & Wage Compliance", html:`<ul><li>Record all training time</li><li>No off-the-clock work</li><li>Overtime as required by law</li></ul>` },
      { code:"3.6", title:"Overtime (Nonexempt)", html:`<p>1.5× over 40; authorization required; weighted-average when multiple rates.</p>` },
      { code:"3.7", title:"Overtime for Tipped Employees (Servers)", html:`<p>OT paid at $6.13/hr over 40; pre-approval required unless emergency.</p>` },
      { code:"3.8", title:"Meal & Rest Breaks", html:`<p>Meals unpaid when fully relieved; clock out/in; eat in designated areas.</p>` },
      { code:"3.9", title:"Payroll Deductions", html:`<p>Legal deductions; other deductions require specific written authorization.</p>` },
      { code:"3.10", title:"Uniforms & Equipment (Deductions)", html:`<p>Employee-paid uniforms must be specifically authorized; cannot violate minimum wage/OT rules.</p>` },
      { code:"3.11", title:"Wage Garnishments", html:`<p>Follow orders until satisfied; provide documentation if incorrect.</p>` },
      { code:"3.12", title:"Direct Deposit & Lost/Returned Payments", html:`<p>Reissues next business day after funds return; $35 fee only with specific written authorization.</p>` },
      { code:"3.13", title:"Pay Statements & Access (MyToast)", html:`<p>Toast is system of record; use MyToast app for paystubs; final pay deadlines stated.</p>` },
      { code:"3.14", title:"Payroll Questions & Disputes", html:`<p>Report in writing; HR investigates within 3 business days; corrections next payroll.</p>` },
      { code:"3.15", title:"Tips & Gratuities Policy", html:`<p>No managers/BOH in tips; legal pools only; CC tip fee up to actual % (≤3%); acknowledgments required.</p>` }
    ];

    // --- Section IV (4.1–4.15) ---
    const SECTION_IV = [
      { code:"4.1", title:"Zero-Tolerance Policy", html:`<p>Immediate action for serious safety/integrity violations; examples listed; due process and docs.</p>` },
      { code:"4.2", title:"Anti-Harassment / Anti-Discrimination & Diversity", html:`<p>Prohibited conduct; prompt response.</p>` },
      { code:"4.3", title:"Diversity & Inclusion Commitment", html:`<p>Merit-based decisions; accommodations; fair processes.</p>` },
      { code:"4.4", title:"Examples of Prohibited Conduct", html:`<p>Verbal/visual, physical, sexual, electronic, third parties.</p>` },
      { code:"4.5", title:"Speak-Up & Investigation Policy", html:`<p>Report to any manager/HR; fast response; confidentiality; no retaliation.</p>` },
      { code:"4.6", title:"Our Investigation", html:`<p>Timeline, impartial reviewer, evidence, findings, corrective actions.</p>` },
      { code:"4.7", title:"Anti-Retaliation", html:`<p>Strictly prohibited; report immediately.</p>` },
      { code:"4.8", title:"Professional Boundaries & No Horseplay", html:`<p>No horseplay or unprofessional contact; reporting & consequences.</p>` },
      { code:"4.9", title:"Workplace Searches & Monitoring", html:`<p>Company Property inspections; electronic monitoring notice; professional, nondiscriminatory.</p>` },
      { code:"4.10", title:"Personal Cell Phone & Earbud Policy", html:`<p>Phones away while working; no earbuds BOH/guest areas; safety; emergencies; discipline.</p>` },
      { code:"4.11", title:"No Smoking/Vaping/Gum/Dipping", html:`<p>Use designated area during authorized breaks; hygiene; discipline.</p>` },
      { code:"4.12", title:"Personal Errands While on the Clock", html:`<p>Not permitted; company errands require authorization and on-the-clock.</p>` },
      { code:"4.13", title:"Employee Bar Policy", html:`<p>21+ to consume off duty; rules for being a guest; TABC compliance.</p>` },
      { code:"4.14", title:"FOH Order Integrity & Guest Service", html:`<p>Ring-before-serve; packing checks; manager controls; prohibited conduct; incident handling.</p>` },
      { code:"4.15", title:"Dress Code & Uniform Standards", html:`<p>BOH and FOH standards; grooming; tattoos; enforcement; deductions rules.</p>` }
    ];

    // --- Section V (5.1–5.18) ---
    const SECTION_V = [
      { code:"5.1", title:"Standard Progressive Path", html:`<p>Verbal #1 → Verbal #2 → Written #1 → Written #2/Final → Termination (unless facts warrant skipping).</p>` },
      { code:"5.2", title:"Cross-policy progression", html:`<p>Warnings accumulate across policies; severe conduct may skip steps.</p>` },
      { code:"5.3", title:"Documentation & Timelines", html:`<p>Each step documented; copies to employee and HR; refusal to sign noted.</p>` },
      { code:"5.4", title:"Zero-Tolerance / Immediate-Termination Offenses", html:`<p>Violence, theft/fraud, serious harassment, serious safety/food-safety endangerment, illicit drugs at work (as defined) — investigation first, then may terminate immediately.</p>` },
      { code:"5.5", title:"Attendance & Punctuality Ladder", html:`<p>Step ladder; NC/NS may jump to Final/Termination.</p>` },
      { code:"5.6", title:"Fights, Threats & Workplace Violence", html:`<p>Rules for mutual fighting, hitter vs retreating party, threats.</p>` },
      { code:"5.7", title:"Dishonesty, Theft & Wage/Time Integrity", html:`<p>Theft → Termination; off-the-clock/buddy-punching ladder; all worked time paid.</p>` },
      { code:"5.8", title:"Unprofessional/Disrespectful Conduct", html:`<p>Verbal → Verbal → Written → Written/Final → Termination (or skip for severe).</p>` },
      { code:"5.9", title:"Social Media & Communications", html:`<p>Prohibited/Protected; discipline up to termination.</p>` },
      { code:"5.10", title:"Drugs, Alcohol & Impairment", html:`<p>Remove from duty; discipline path unless severity/recurrence.</p>` },
      { code:"5.11", title:"Harassment, Discrimination & Retaliation", html:`<p>Investigation required; discipline depends on findings.</p>` },
      { code:"5.12", title:"Corrective Action Plans (CAPs)", html:`<p>What every CAP must include.</p>` },
      { code:"5.13", title:"Benefits & PTO on Separation", html:`<p>PTO payout per policy/plan; generally not paid unless stated.</p>` },
      { code:"5.14", title:"Resignation (Two-Weeks’ Notice)", html:`<p>How to submit; at-will reminder; forms.</p>` },
      { code:"5.15", title:"Company Acceptance / Scheduling During Notice", html:`<p>Management confirms last day; schedules may be adjusted.</p>` },
      { code:"5.16", title:"Conduct During Notice", html:`<p>All policies apply; may end immediately for serious violations.</p>` },
      { code:"5.17", title:"Job Abandonment (No-Call/No-Show)", html:`<p>Two consecutive misses may be treated as abandonment.</p>` },
      { code:"5.18", title:"Discipline (FOH Order Integrity & Guest Service)", html:`<p>Payment verification rules and discipline; audits; CAPs.</p>` }
    ];

    // --- Section VII (FMLA/PWFA/ADA) uses 6.x codes as you provided ---
    const SECTION_VII = [
      { code:"6.1", title:"Eligibility (FMLA)", html:`<p>12 months, 1,250 hours, 50+ within 75 miles.</p>` },
      { code:"6.2", title:"Qualifying Reasons", html:`<p>Serious health, family care, bonding, military; 26 weeks for servicemember care.</p>` },
      { code:"6.3", title:"Pregnancy & Childbirth — FMLA + PWFA/ADA", html:`<p>How they interact; no separate Texas PDL.</p>` },
      { code:"6.4", title:"Amount, Scheduling & Intermittent", html:`<p>Continuous or intermittent; schedule to reduce disruption.</p>` },
      { code:"6.5", title:"Pay & Benefits During Leave", html:`<p>Unpaid unless PTO substitution per rules; health benefits continuation; FLSA notes.</p>` },
      { code:"6.6", title:"Employee Notice Responsibilities", html:`<p>30-day notice when foreseeable; follow call-in rules.</p>` },
      { code:"6.7", title:"Medical Certification & Fitness-for-Duty", html:`<p>15-day deadline; FFD may be required.</p>` },
      { code:"6.8", title:"Employer Notices", html:`<p>Eligibility & R/R; Designation Notice.</p>` },
      { code:"6.9", title:"Performance, Conduct & Anti-Retaliation", html:`<p>Standards still apply; no interference/retaliation.</p>` },
      { code:"6.10", title:"Fraud/Abuse", html:`<p>Discipline up to termination.</p>` },
      { code:"6.11", title:"Concurrent Leaves & Workers’ Comp", html:`<p>FMLA may run concurrently.</p>` },
      { code:"6.12", title:"How to Request", html:`<p>Notify HR; complete forms; return certification; request accommodations if needed.</p>` },
      { code:"6.13", title:"Administration & Questions", html:`<p>HR administers.</p>` }
    ];

    // --- Section VIII (Benefits) uses 8.x codes ---
    const SECTION_VIII = [
      { code:"8.1", title:"Eligibility & Waiting Period", html:`<p>Full-time (30+); 60-day wait; effective date per plan docs.</p>` },
      { code:"8.2", title:"PTO — Accrual Start", html:`<p>Full-time after 60 days; accrual & caps per PTO policy.</p>` },
      { code:"8.3", title:"Coordination With Leave & Payroll", html:`<p>Deductions & continuation; unpaid leave handling.</p>` },
      { code:"8.4", title:"Payroll Advance Policy", html:`<p>Short-term advance rules (50% of earned hours incl. tips); max 6×/yr; full deduction next check.</p>` },
      { code:"8.5", title:"Conditions for Payroll Advance — How to Request", html:`<p>60+ days; good standing; emergency; request/review/decision steps.</p>` },
      { code:"8.6", title:"Employee Meal (Unpaid Meal Break)", html:`<p>Prepared daily 2:30–3:30; clock out; where to eat; beverages & purchases.</p>` },
      { code:"8.7", title:"Workers’ Compensation Insurance", html:`<p>Subscriber; Society Insurance; exclusive remedy.</p>` },
      { code:"8.8", title:"Employee Time Off (General)", html:`<p>Requests 21 days ahead when planned; approvals discretionary unless law requires; medical certification for medical leaves.</p>` },
      { code:"8.9", title:"Paid Time Off Policy (PTO) — Overview", html:`<p>Upfront PTO; blackout dates; eligibility loss if status changes; other detailed rules as provided.</p>` },
      { code:"8.10", title:"Use and Management of PTO", html:`<p>Upfront; no rollover; automatic year-end payout for active employees; termination rules.</p>` },
      { code:"8.11", title:"Request to Use PTO", html:`<p>21-day notice in Sling + paper form; manager signature; submit to payroll.</p>` },
      { code:"8.12", title:"PTO — Full-Time Mechanics", html:`<p>Eligibility, accrual math (0.02/0.023), caps (40/48), and guardrails.</p>` },
      { code:"8.13", title:"Requesting & Scheduling PTO", html:`<p>Via Sling; no negatives; coordination with leave laws.</p>` },
      { code:"8.14", title:"Pay & FLSA Guardrails; Year-End; Separation", html:`<p>Base rate; PTO not hours worked for OT; year-end auto payout if active; no payout at termination.</p>` }
    ];

    // --- Section IX (Doctor’s Notice & Medical Leave Documentation) uses 7.x codes ---
    const SECTION_IX = [
      { code:"7.1", title:"When a Doctor’s Note Is Required", html:`<p>3+ schedule-day absences; food-safety illnesses; after warnings or surgery/injury; what note must state.</p>` },
      { code:"7.2", title:"How to Submit Your Doctor’s Note", html:`<p>Deliver to HR; confidentiality; receipt provided.</p>` },
      { code:"7.3", title:"FMLA Screening & Paperwork", html:`<p>WH-381/380/382 timelines; provisional treatment; restoration rules.</p>` },
      { code:"7.4", title:"Pregnancy, Childbirth & Related (PWFA/ADA)", html:`<p>Reasonable accommodations absent undue hardship.</p>` },
      { code:"7.5", title:"Workers’ Comp & Work-Injury Notes", html:`<p>Immediate reporting; network use; modified duty possible.</p>` },
      { code:"7.6", title:"Pay, PTO & Scheduling During Medical Leave", html:`<p>Unpaid unless PTO/benefit applies; OT based on hours worked only.</p>` },
      { code:"7.7", title:"If Documentation Is Not Provided", html:`<p>Deadlines (3 business days final); status while pending; possible separation for inability to return; FMLA certification timelines.</p>` },
      { code:"7.8", title:"Fitness-for-Duty (FFD) to Return", html:`<p>Required in stated cases; ADA/PWFA interactive process on restrictions.</p>` },
      { code:"7.9", title:"No Retaliation / Consistent Application", html:`<p>Strictly prohibited; confidentiality preserved.</p>` }
    ];

    // register sections (add more later if needed)
    const SECTIONS = {
      I:    { title: "Section I — Introduction",             store: "jc_section_i_",    items: SECTION_I },
      II:   { title: "Section II — Employment Policies",     store: "jc_section_ii_",   items: SECTION_II },
      III:  { title: "Section III — Hours of Work & Payroll",store: "jc_section_iii_",  items: SECTION_III },
      IV:   { title: "Section IV — Standards of Conduct",    store: "jc_section_iv_",   items: SECTION_IV },
      V:    { title: "Section V — Discipline & Corrective",  store: "jc_section_v_",    items: SECTION_V },
      VII:  { title: "Section VII — FMLA / PWFA / ADA",      store: "jc_section_vii_",  items: SECTION_VII },
      VIII: { title: "Section VIII — Benefits & Services",   store: "jc_section_viii_", items: SECTION_VIII },
      IX:   { title: "Section IX — Doctor’s Notes & Medical",store: "jc_section_ix_",   items: SECTION_IX }
    };

    // policy id map loaded from DB
    let POLICY_META = {};

    /* ========= RENDERING ========= */
    const tabButtons = document.querySelectorAll('.tabbtn');
    let currentTab = 'I';

    function policyCardTemplate(sectionDef, item){
      const inputId = `init_${item.code.replace('.','_')}`;
      const saved = localStorage.getItem(nsPrefix(sectionDef.store) + item.code);
      const initialsValue = saved ? (JSON.parse(saved)?.initials || '') : '';
      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
                <div class="text-[15px] leading-7 text-slate-700">${item.html}</div>
              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${initialsValue}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves directly to your record in Supabase.</div>
                </div>
              </div>
            </div>
          </div>
        </article>
      `;
    }

    function renderSection(tabKey){
      const def = SECTIONS[tabKey];
      currentTab = tabKey;
      sectionTitle.textContent = def.title;
      progTotalEl.textContent = def.items.length;
      policiesEl.innerHTML = def.items.map(item => policyCardTemplate(def, item)).join('');
      wireSaveButtons();
      updateProgress();
    }

    tabButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabButtons.forEach(x => { x.classList.remove('bg-jc-primary','text-white'); x.classList.add('border'); });
        b.classList.add('bg-jc-primary','text-white'); b.classList.remove('border');
        renderSection(b.getAttribute('data-tab'));
      });
    });

    /* ========= DB LOOKUP & SAVE ========= */
    function wantedCodesForAll(){
      const list = [];
      Object.values(SECTIONS).forEach(def => def.items.forEach(i => list.push(i.code)));
      return list;
    }

    async function loadPoliciesMeta(){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending: true });

      if(error){ console.warn('hb_policies error', error); POLICY_META = {}; return; }

      const meta = {};
      (data||[]).forEach(r=>{
        const code = extractCode(r.title);
        if(code){ meta[code] = { id: r.id, title: r.title }; }
      });
      wantedCodesForAll().forEach(c => { if(!meta[c]) meta[c] = { id: null, title: c }; });
      POLICY_META = meta;
    }

    async function prefillAcksFromDB(){
      const initials = getSessionInitials();
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);

      if(error){ console.warn('hb_acks prefill error', error); return; }
      const byId = new Map((data||[]).map(r => [r.policy_id, r]));
      Object.values(SECTIONS).forEach(def=>{
        def.items.forEach(item=>{
          const code = item.code;
          const pid  = POLICY_META?.[code]?.id || null;
          if(!pid) return;
          const row = byId.get(pid);
          if(row && row.agreed){
            localStorage.setItem(nsPrefix(def.store)+code, JSON.stringify({
              initials: (row.signed_initials || initials).toUpperCase(),
              ts: row.created_at
            }));
          }
        });
      });
    }

    async function saveAckToDB({ initials, policyCode }){
      const policyId = POLICY_META?.[policyCode]?.id || null;
      const session_id = getSessionId();
      const hb = getHbSession();
      const employee_id = hb?.employee_id || null;

      if(!policyId){
        return { ok:false, message:'Policy not registered in hb_policies' };
      }

      try{
        const { error } = await client.rpc('hb_ack_policy', {
          p_initials: initials,
          p_policy_id: policyId,
          p_signed_initials: initials,
          p_session_id: session_id,
          p_agreed: true,
          p_employee_id: employee_id
        });
        if(!error) return { ok:true };
        console.warn('hb_ack_policy RPC error:', error);
      }catch(e){ console.warn('hb_ack_policy threw:', e); }

      try{
        const payload = {
          policy_id: policyId,
          employee_initials: initials,
          signed_initials: initials,
          agreed: true,
          session_id,
          employee_id
        };
        const { error } = await client.from('hb_acks').insert(payload);
        if(error){ console.error('hb_acks insert error', error); return { ok:false, message: error.message || 'Insert failed' }; }
        return { ok:true };
      }catch(e){
        console.error('hb_acks insert threw', e);
        return { ok:false, message: e?.message || 'Insert failed' };
      }
    }

    /* ========= PROGRESS & EVENTS ========= */
    function updateProgress(){
      const def = SECTIONS[currentTab];
      const total = def.items.length;
      let saved = 0;
      def.items.forEach(i=>{
        if(localStorage.getItem(nsPrefix(def.store) + i.code)) saved++;
      });
      progCountEl.textContent = saved;
      progBar.style.width = Math.round((saved/total)*100) + '%';

      const allDone = saved === total;
      btnNext.disabled = !allDone;
      if(allDone){
        btnNext.classList.remove('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.add('bg-emerald-600');
      }else{
        btnNext.classList.add('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.remove('bg-emerald-600');
      }
    }

    function wireSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const def = SECTIONS[currentTab];
          const code = btn.getAttribute('data-code');
          const input = document.getElementById(`init_${code.replace('.','_')}`);
          const msgEl = document.getElementById(`msg_init_${code.replace('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toastInline(msgEl, 'Enter initials.'); return; }

          const dbRes = await saveAckToDB({ initials: typed, policyCode: code });
          localStorage.setItem(nsPrefix(def.store) + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));
          toastInline(msgEl, dbRes.ok ? 'Saved to record.' : 'Saved locally (DB not ready).', dbRes.ok);
          updateProgress();
        });
      });
    }

    /* ========= NAV ========= */
    btnBack.addEventListener('click', ()=> { history.back(); });
    btnNext.addEventListener('click', ()=> {
      if(btnNext.disabled) return;
      const order = ["I","II","III","IV","V","VII","VIII","IX"];
      const idx = order.indexOf(currentTab);
      if(idx >=0 && idx < order.length-1){
        document.querySelector(`.tabbtn[data-tab="${order[idx+1]}"]`).click();
      }else{
        alert('All current sections complete.');
      }
    });

    /* ========= APP BOOT ========= */
    async function bootApp(){
      await fillEmployeeCard();
      renderSection('I');          // paint fast
      await loadPoliciesMeta();    // resolve policy IDs
      await prefillAcksFromDB();   // hydrate saved answers
      renderSection(currentTab);   // redraw so inputs reflect prefill
    }

    /* ========= FIRST LOAD ========= */
    (async function init(){
      const s = getHbSession();
      if (s?.initials) {
        showApp();
        await bootApp();
        return;
      }
      showLogin();
    })();
  </script>
</body>
</html>
