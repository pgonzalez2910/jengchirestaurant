<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], 'sans': ['Inter','system-ui','sans-serif'] },
          colors: { 'jc-primary':'#1F2937','jc-secondary':'#334155','jc-gold':'#C0A06D','jc-border':'#E2E8F0' },
          boxShadow: {
            'soft':'0 18px 80px rgba(0,0,0,.12)',
            'glow':'0 0 0 1px rgba(255,255,255,.3), 0 30px 80px rgba(0,0,0,.22)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .prose-handbook h2, .prose-handbook h3 { font-family: 'Playfair Display', serif; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="fixed inset-0 -z-10 pointer-events-none opacity-30"
       style="background:
        radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
        radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
        radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);">
  </div>

  <!-- ===================== LOGIN ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., pg"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8"
                   class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP ===================== -->
  <div id="appView" class="hidden">
    <!-- top address -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex items-start justify-between">
        <div></div>
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- logo + signout -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex items-center justify-between gap-3">
        <div class="flex-1"></div>
        <div class="w-full flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi logo"
               class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
        </div>
        <div class="flex-1 flex justify-end">
          <button id="btnSignOut" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Sign out</button>
        </div>
      </div>
    </header>

    <!-- employee card -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div><div class="text-slate-500">Employee</div><div id="fi_name" class="font-medium">—</div></div>
            <div><div class="text-slate-500">User</div><div id="fi_user" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Position</div><div id="fi_position" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Department</div><div id="fi_department" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Reports to</div><div id="fi_reports_to" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Email</div><div id="fi_email" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Phone</div><div id="fi_phone" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Session started</div><div id="fi_session_started" class="font-medium">—</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- section tabs -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="flex flex-wrap gap-2">
        <button data-tab="I"   class="tabbtn rounded-xl px-4 py-2 text-sm bg-jc-primary text-white">Section I</button>
        <button data-tab="II"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section II</button>
        <button data-tab="III" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section III</button>
        <button data-tab="IV"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IV</button>
        <button data-tab="V"   class="tabbtn rounded-xl px-4 py-2 text-sm border">Section V</button>
        <button data-tab="VII" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VII</button>
        <button data-tab="VIII"class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VIII</button>
        <button data-tab="IX"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IX</button>
      </div>
    </section>

    <!-- section body -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-4 pb-24">
      <div class="rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 id="sectionTitle" class="font-serif-head text-3xl text-jc-primary tracking-tight">Section I — Introduction</h1>
          <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>. “Next Section” unlocks when all are saved.</p>
        </div>

        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="progCount" class="font-semibold">0</span>/<span id="progTotal">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="progBar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <div id="policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <button id="btnBack" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Back</button>
          <button id="btnNext" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Next Section</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ========= SUPABASE ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');
    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const sectionTitle = document.getElementById('sectionTitle');
    const policiesEl   = document.getElementById('policies');
    const btnNext      = document.getElementById('btnNext');
    const btnBack      = document.getElementById('btnBack');
    const progCountEl  = document.getElementById('progCount');
    const progTotalEl  = document.getElementById('progTotal');
    const progBar      = document.getElementById('progBar');

    /* ========= UTIL ========= */
    const CODE_RE = /^(\d+\.\d+)/;
    const safe = (v, dash='—') => (v===null || v===undefined || v==='') ? dash : v;
    const toInitials = (u) => (String(u||'').trim().slice(0,2) || '').toUpperCase();
    const toast = (el, msg, ok=false) => { el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); };
    const extractCode = (t='') => { const m=String(t).toUpperCase().match(CODE_RE); return m?m[1]:null; };

    const setSession = (s)=> localStorage.setItem('hb_session', JSON.stringify(s||{}));
    const getSession = ()=> { try { return JSON.parse(localStorage.getItem('hb_session')||'{}'); } catch { return {}; } };
    const getInitials = ()=> {
      const s = getSession();
      if (s?.initials) return String(s.initials).toUpperCase();
      if (s?.username) return toInitials(s.username);
      return '';
    };
    const getSessionId = ()=> { const sid = localStorage.getItem('hb_session_id'); return sid ? Number(sid) : null; };
    const getSessionStartedAt = ()=> localStorage.getItem('hb_session_started_at') || new Date().toISOString();

    // Stable per-user namespace: employee_id -> initials -> username
    function userNamespace() {
      const s = getSession();
      if (s?.employee_id) return `emp_${s.employee_id}`;
      if (getInitials()) return `init_${getInitials()}`;
      if (s?.username) return `user_${String(s.username).toLowerCase()}`;
      return 'anon';
    }
    const nsKey = (base) => `${userNamespace()}__${base}`;

    /* ========= LOGIN ========= */
    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId) localStorage.setItem('hb_session_id', String(sessionId));
        localStorage.setItem('hb_session_started_at', startedAt);
      }catch(e){
        localStorage.setItem('hb_session_started_at', new Date().toISOString());
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }
      loginMsg.textContent='';

      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });
        if(error){ loginMsg.textContent = error.message || 'Login failed'; return; }
        const s = {
          username: u,
          initials: (data?.initials || toInitials(u)),
          employee_id: data?.employee_id || null,
          full_name: data?.full_name || null,
          position: data?.position || null,
          department: data?.department || null,
          is_owner: !!data?.is_owner,
          email: data?.email || null,
          phone: data?.phone || null,
          reports_to: data?.reports_to || null
        };
        setSession(s);
        await startRemoteSession(s.initials);
        showApp();
        await bootApp();
      }catch(e){
        console.error(e);
        loginMsg.textContent = 'Login error';
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    // Sign out: keep local progress so employees don't lose their place
    document.getElementById('btnSignOut')?.addEventListener('click', ()=>{
      localStorage.removeItem('hb_session');
      localStorage.removeItem('hb_session_id');
      localStorage.removeItem('hb_session_started_at');
      showLogin();
    });

    /* ========= EMPLOYEE CARD ========= */
    
async function fillEmployeeCard(){
  const s = getSession();
  const initials = getInitials();
  const started  = getSessionStartedAt();

  // 1) seed from login/session
  let name        = s?.full_name || null;
  let position    = s?.position || null;
  let department  = s?.department || null;
  let reports_to  = s?.reports_to || null;
  let email       = s?.email || null;
  let phone       = s?.phone || null;
  const username  = s?.username || null;

  // show what we have right away
  document.getElementById('fi_user').textContent        = safe(initials || toInitials(username));
  document.getElementById('fi_name').textContent        = safe(name);
  document.getElementById('fi_position').textContent    = safe(position);
  document.getElementById('fi_department').textContent  = safe(department);
  document.getElementById('fi_reports_to').textContent  = safe(reports_to);
  document.getElementById('fi_email').textContent       = safe(email);
  document.getElementById('fi_phone').textContent       = safe(phone);
  document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

  // 2) If we still need basics, use hb_handbook_access (by username)
  if ((!name || !position || !department) && username){
    const { data: ha } = await client
      .from('hb_handbook_access')
      .select('employee_name, position, department')
      .eq('user', username)
      .maybeSingle();

    if (ha){
      name       = name       || ha.employee_name || null;
      position   = position   || ha.position || null;
      department = department || ha.department || null;

      document.getElementById('fi_name').textContent        = safe(name);
      document.getElementById('fi_position').textContent    = safe(position);
      document.getElementById('fi_department').textContent  = safe(department);
    }
  }

  // 3) Use the official employees data for contact + manager (by full_name)
  //    This hits the view you created above (v_employee_card).
  if (name){
    const { data: ec } = await client
      .from('v_employee_card')
      .select('email, phone, reports_to, department')
      .ilike('full_name', name);   // case-insensitive match

    if (ec && ec.length){
      // pick the first match or the one whose dept matches
      const row = ec.find(r => r.department && department && r.department.toLowerCase() === department.toLowerCase()) || ec[0];

      email      = email      || row.email || null;
      phone      = phone      || row.phone || null;
      reports_to = reports_to || row.reports_to || null;

      document.getElementById('fi_reports_to').textContent  = safe(reports_to);
      document.getElementById('fi_email').textContent       = safe(email);
      document.getElementById('fi_phone').textContent       = safe(phone);
    }
  }
}


    /* ========= SECTION DATA ========= */
    // Section I
    const SECTION_I = [
      { code: "1.1", title: "Welcome to Jeng Chi Restaurant", html: `<p>We are pleased to have you join our team here at Jeng Chi…</p>` },
      { code: "1.2", title: "Employee Handbook — Purpose and Coverage", html: `<p>This Employee Handbook (“Handbook”) summarizes key personnel policies…</p>` },
      { code: "1.3", title: "Disclaimer, Employment-At-Will & Management Approval Authority", html: `<p>Clarifies at-will, right to modify, authorized approvers, and non-retaliation.</p>` },
      { code: "1.4", title: "Approval Authority for Position & Pay Changes", html: `<p>Prior written approval required; owners are the approvers.</p>` },
      { code: "1.5", title: "Administration and Changes", html: `<p>Company may change policies; employees must review updates.</p>` },
      { code: "1.6", title: "Interpretation; Deviation; No Past-Practice Rights", html: `<p>Company may interpret/deviate as appropriate.</p>` },
      { code: "1.7", title: "Conflicts with Law or Other Documents", html: `<p>Law controls; English version governs.</p>` }
    ];

    // Section II (your employment policies summary)
    const SECTION_II = [
      { code: "2.1", title: "Employee Classifications", html: `<p>Exempt/Nonexempt; Full/Part/Temp; at-will.</p>` },
      { code: "2.2", title: "EEO & ADA", html: `<p>Equal opportunity; reasonable accommodation; no retaliation.</p>` },
      { code: "2.3", title: "Introductory Period", html: `<p>First 60 days; I-9 within 3 business days.</p>` },
      { code: "2.4", title: "Reporting Discrimination/Harassment", html: `<p>Report to any manager or HR; prompt review.</p>` },
      { code: "2.5", title: "Required Certifications & Paid Training", html: `<p>Food Handler & TABC as applicable; company pays initial fee; paid training.</p>` },
      { code: "2.6", title: "Paid Training – FLSA/TWC Rules", html: `<p>Training is paid; tipped training at full minimum wage; blended overtime.</p>` },
      { code: "2.7", title: "Parking", html: `<p>Park on Greenville or designated employee areas.</p>` },
      { code: "2.8", title: "Required Notices & Postings", html: `<p>All required posters maintained; review as needed.</p>` }
    ];

    // Section III (Hours & Payroll)
    const SECTION_III = [
      { code:"3.1", title:"Pay Periods & Paydays", html:`<p>Bi-weekly; Friday paydays; DD or check.</p>` },
      { code:"3.2", title:"Workweek & Sling Setup", html:`<p>Sun–Sat workweek; Sling app required; no off-the-clock work.</p>` },
      { code:"3.3", title:"Timekeeping (All)", html:`<p>Record all time; missed punch; 7-minute window rule.</p>` },
      { code:"3.4", title:"Training Time", html:`<p>Record all required training time; paid.</p>` },
      { code:"3.5", title:"Wage Compliance", html:`<p>No off-the-clock; overtime for compensable time.</p>` },
      { code:"3.6", title:"Overtime (Nonexempt)", html:`<p>1.5× over 40; pre-approval required; weighted average.</p>` },
      { code:"3.7", title:"Overtime for Tipped Servers", html:`<p>$6.13 OT rate; pre-approval unless emergency.</p>` },
      { code:"3.8", title:"Meal & Rest", html:`<p>Meals unpaid when relieved; clock out/in; eat where allowed.</p>` },
      { code:"3.9", title:"Payroll Deductions", html:`<p>Legal deductions; others need specific written authorization.</p>` },
      { code:"3.10", title:"Uniforms & Equipment", html:`<p>Itemized deductions only; no minimum wage/OT violation.</p>` },
      { code:"3.11", title:"Wage Garnishments", html:`<p>Honor valid orders; stop on release.</p>` },
      { code:"3.12", title:"Direct Deposit & Reissues", html:`<p>Returned DD reissued next business day; $35 fee only with written auth.</p>` },
      { code:"3.13", title:"Pay Statements (MyToast)", html:`<p>Toast is system of record; app access; final pay rules.</p>` },
      { code:"3.14", title:"Payroll Questions", html:`<p>Report quickly; HR resolves within 3 business days; corrections next payroll.</p>` },
      { code:"3.15", title:"Tips & Gratuities", html:`<p>Managers/BOH don’t take tips; legal pools; CC tip fee ≤ actual % up to 3%.</p>` }
    ];

    // Section IV (Conduct)
    const SECTION_IV = [
      { code:"4.1", title:"Zero-Tolerance Policy", html:`<p>Immediate action for serious safety/integrity issues.</p>` },
      { code:"4.2", title:"Anti-Harassment / Anti-Discrimination", html:`<p>Policy + prompt response.</p>` },
      { code:"4.3", title:"Diversity & Inclusion", html:`<p>Merit-based; accommodations; fair processes.</p>` },
      { code:"4.4", title:"Prohibited Conduct Examples", html:`<p>Verbal/visual; physical; sexual; online; third parties.</p>` },
      { code:"4.5", title:"Speak-Up & Investigation", html:`<p>Report to any manager/HR; confidentiality; no retaliation.</p>` },
      { code:"4.6", title:"Our Investigation", html:`<p>Timeline; reviewer; evidence; actions.</p>` },
      { code:"4.7", title:"Anti-Retaliation", html:`<p>Strictly prohibited.</p>` },
      { code:"4.8", title:"Professional Boundaries & No Horseplay", html:`<p>No horseplay/unnecessary touch; consequences.</p>` },
      { code:"4.9", title:"Searches & Monitoring", html:`<p>Company Property may be inspected; electronic monitoring.</p>` },
      { code:"4.10", title:"Personal Phones & Earbuds", html:`<p>Phones away; earbuds restricted; safety first.</p>` },
      { code:"4.11", title:"No Smoking/Vaping/Gum/Dip", html:`<p>Designated area only; hygiene; discipline.</p>` },
      { code:"4.12", title:"Personal Errands On the Clock", html:`<p>Not permitted; company errands require authorization and on-the-clock.</p>` },
      { code:"4.13", title:"Employee Bar Policy", html:`<p>21+ to consume; off-duty rules; TABC compliance.</p>` },
      { code:"4.14", title:"FOH Order Integrity", html:`<p>Ring-before-serve; packing checks; audits; incidents.</p>` },
      { code:"4.15", title:"Dress Code & Uniforms", html:`<p>BOH/FOH standards; tattoos; enforcement.</p>` }
    ];

    // Section V (Discipline)
    const SECTION_V = [
      { code:"5.1", title:"Progressive Path", html:`<p>Verbal1 → Verbal2 → Written1 → Written2/Final → Termination.</p>` },
      { code:"5.2", title:"Cross-policy progression", html:`<p>Steps accumulate across policies.</p>` },
      { code:"5.3", title:"Documentation & Timelines", html:`<p>Facts, expectations, CAP, window.</p>` },
      { code:"5.4", title:"Immediate-Termination Examples", html:`<p>Violence, theft, serious harassment/safety, illicit drugs at work (as defined) — after investigation.</p>` },
      { code:"5.5", title:"Attendance Ladder", html:`<p>Example ladder; NC/NS may jump steps.</p>` },
      { code:"5.6", title:"Fights & Threats", html:`<p>Rules for mutual fighting/threats.</p>` },
      { code:"5.7", title:"Dishonesty, Theft & Wage Integrity", html:`<p>Theft → termination; timekeeping ladder.</p>` },
      { code:"5.8", title:"Unprofessional Conduct", html:`<p>Verbal→Verbal→Written→Written/Final→Termination (or skip).</p>` },
      { code:"5.9", title:"Social Media", html:`<p>Prohibited vs protected; discipline up to termination.</p>` },
      { code:"5.10", title:"Drugs, Alcohol & Impairment", html:`<p>Remove from duty; discipline depends on severity/recurrence.</p>` },
      { code:"5.11", title:"Harassment/Discrimination/Retaliation", html:`<p>Investigation required; discipline varies.</p>` },
      { code:"5.12", title:"Corrective Action Plans", html:`<p>What a CAP must include.</p>` },
      { code:"5.13", title:"Benefits & PTO at Separation", html:`<p>Per plan/policy.</p>` },
      { code:"5.14", title:"Resignation & Submission", html:`<p>Two-weeks’ process and forms.</p>` },
      { code:"5.15", title:"Scheduling During Notice", html:`<p>May adjust based on business needs.</p>` },
      { code:"5.16", title:"Conduct During Notice", html:`<p>Policies still apply; may end immediately for serious issues.</p>` },
      { code:"5.17", title:"Job Abandonment", html:`<p>Two consecutive no-call/no-shows.</p>` },
      { code:"5.18", title:"FOH Order Integrity – Discipline", html:`<p>Payment verification; audits; CAPs; discipline path.</p>` }
    ];

    // Section VII (FMLA/PWFA/ADA) — uses 6.x codes per your text
    const SECTION_VII = [
      { code:"6.1", title:"Eligibility (FMLA)", html:`<p>12 months; 1,250 hrs; 50+ employees within 75 miles.</p>` },
      { code:"6.2", title:"Qualifying Reasons", html:`<p>Self/family serious health; bonding; military.</p>` },
      { code:"6.3", title:"Pregnancy & Childbirth — FMLA + PWFA/ADA", html:`<p>How they interact; no Texas PDL.</p>` },
      { code:"6.4", title:"Amount & Intermittent", html:`<p>Continuous or intermittent; schedule responsibly.</p>` },
      { code:"6.5", title:"Pay & Benefits During Leave", html:`<p>PTO substitution rules; health coverage; FLSA notes.</p>` },
      { code:"6.6", title:"Employee Notice", html:`<p>30-day notice when foreseeable; follow call-in.</p>` },
      { code:"6.7", title:"Medical Certification & FFD", html:`<p>15-day deadline; fitness-for-duty may be required.</p>` },
      { code:"6.8", title:"Employer Notices", html:`<p>Eligibility & R/R; Designation.</p>` },
      { code:"6.9", title:"Performance & Anti-Retaliation", html:`<p>Standards apply; no interference/retaliation.</p>` },
      { code:"6.10", title:"Fraud/Abuse", html:`<p>Discipline up to termination.</p>` },
      { code:"6.11", title:"Concurrent Leaves", html:`<p>May run with workers' comp, etc.</p>` },
      { code:"6.12", title:"How to Request", html:`<p>Notify; forms; certification; accommodations.</p>` },
      { code:"6.13", title:"Administration & Questions", html:`<p>HR administers.</p>` }
    ];

    // Section VIII (Benefits) — 8.x codes
    const SECTION_VIII = [
      { code:"8.1", title:"Eligibility & Waiting Period", html:`<p>Full-time 30+ hrs; 60-day wait; plan docs control.</p>` },
      { code:"8.2", title:"PTO — Accrual Start", html:`<p>Begins after 60 days; accrual rates & caps per policy.</p>` },
      { code:"8.3", title:"Coordination With Leave & Payroll", html:`<p>Deductions continue; unpaid leave handling.</p>` },
      { code:"8.4", title:"Payroll Advance Policy", html:`<p>Up to 50% of earned hours incl. tips; max 6×/yr; deducted next check.</p>` },
      { code:"8.5", title:"Advance Request Process", html:`<p>Form → review (1 biz day) → decision → full deduct next check.</p>` },
      { code:"8.6", title:"Employee Meal (Unpaid)", html:`<p>2:30–3:30pm; clock out; where/how to eat; beverage pricing.</p>` },
      { code:"8.7", title:"Workers’ Compensation", html:`<p>Subscriber; Society Insurance.</p>` },
      { code:"8.8", title:"Employee Time Off (General)", html:`<p>21-day notice for planned; medical certification where required.</p>` },
      { code:"8.9", title:"PTO Policy — Overview", html:`<p>Upfront; blackout dates; status changes effects.</p>` },
      { code:"8.10", title:"Use & Management of PTO", html:`<p>No rollover; auto year-end payout if active; no payout at termination.</p>` },
      { code:"8.11", title:"Request to Use PTO", html:`<p>21-day notice in Sling + form; manager sign; submit to payroll.</p>` },
      { code:"8.12", title:"PTO — Full-Time Mechanics", html:`<p>0.02 / 0.023 per hour; caps 40/48; guardrails.</p>` },
      { code:"8.13", title:"Scheduling PTO", html:`<p>No negatives; business needs; blackouts; coordination with leave laws.</p>` },
      { code:"8.14", title:"Pay, Year-End & Separation", html:`<p>Base rate; PTO not ‘hours worked’ for OT; year-end payout if active; no payout on termination.</p>` }
    ];

    // Section IX (Doctor’s Notes) — 7.x codes
    const SECTION_IX = [
      { code:"7.1", title:"When a Doctor’s Note Is Required", html:`<p>3+ schedule-day absences; food-safety illnesses; after certain warnings/surgery.</p>` },
      { code:"7.2", title:"How to Submit", html:`<p>Deliver to HR; receipt; confidentiality.</p>` },
      { code:"7.3", title:"FMLA Screening & Paperwork", html:`<p>WH-381/380/382 timelines; provisional handling.</p>` },
      { code:"7.4", title:"Pregnancy/Childbirth (PWFA/ADA)", html:`<p>Reasonable accommodations absent undue hardship.</p>` },
      { code:"7.5", title:"Workers’ Comp Notes", html:`<p>Immediate reporting; modified duty possible.</p>` },
      { code:"7.6", title:"Pay, PTO & Scheduling", html:`<p>Unpaid unless PTO/benefit; OT on hours worked only.</p>` },
      { code:"7.7", title:"If Documentation Not Provided", html:`<p>Deadlines; status; possible separation for inability to return.</p>` },
      { code:"7.8", title:"Fitness-for-Duty to Return", html:`<p>Required in stated cases; ADA/PWFA process for restrictions.</p>` },
      { code:"7.9", title:"No Retaliation / Consistent Application", html:`<p>Strictly prohibited; confidentiality.</p>` }
    ];

    const SECTIONS = {
      I:    { title: "Section I — Introduction",             store: "jc_section_i_",    items: SECTION_I },
      II:   { title: "Section II — Employment Policies",     store: "jc_section_ii_",   items: SECTION_II },
      III:  { title: "Section III — Hours of Work & Payroll",store: "jc_section_iii_",  items: SECTION_III },
      IV:   { title: "Section IV — Standards of Conduct",    store: "jc_section_iv_",   items: SECTION_IV },
      V:    { title: "Section V — Discipline & Corrective",  store: "jc_section_v_",    items: SECTION_V },
      VII:  { title: "Section VII — FMLA / PWFA / ADA",      store: "jc_section_vii_",  items: SECTION_VII },
      VIII: { title: "Section VIII — Benefits & Services",   store: "jc_section_viii_", items: SECTION_VIII },
      IX:   { title: "Section IX — Doctor’s Notes & Medical",store: "jc_section_ix_",   items: SECTION_IX }
    };

    /* ========= RENDERING ========= */
    const tabButtons = document.querySelectorAll('.tabbtn');
    let currentTab = 'I';

    const policyCardTemplate = (def,item)=>{
      const inputId = `init_${item.code.replace('.','_')}`;
      const saved = localStorage.getItem(nsKey(def.store) + item.code);
      const val = saved ? (JSON.parse(saved)?.initials || '') : '';
      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
                <div class="text-[15px] leading-7 text-slate-700">${item.html}</div>
              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${val}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves to your record (DB if available).</div>
                </div>
              </div>
            </div>
          </div>
        </article>`;
    };

    function renderSection(tabKey){
      const def = SECTIONS[tabKey];
      currentTab = tabKey;
      sectionTitle.textContent = def.title;
      progTotalEl.textContent = def.items.length;
      policiesEl.innerHTML = def.items.map(i => policyCardTemplate(def,i)).join('');
      wireSaveButtons();
      updateProgress();
    }

    tabButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabButtons.forEach(x => { x.classList.remove('bg-jc-primary','text-white'); x.classList.add('border'); });
        b.classList.add('bg-jc-primary','text-white'); b.classList.remove('border');
        renderSection(b.getAttribute('data-tab'));
      });
    });

    /* ========= DB POLICY MAP ========= */
    let POLICY_META = {};
    const wantedCodes = ()=> {
      const arr = [];
      Object.values(SECTIONS).forEach(d=> d.items.forEach(i=> arr.push(i.code)));
      return arr;
    };

    async function loadPoliciesMeta(){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending: true });

      const meta = {};
      (data||[]).forEach(r=>{
        const code = extractCode(r.title);
        if(code) meta[code] = { id:r.id, title:r.title };
      });
      wantedCodes().forEach(c=>{ if(!meta[c]) meta[c] = { id:null, title:c }; });
      POLICY_META = meta;
    }

    /* ========= SAVE / PREFILL ========= */
    async function prefillFromDB(){
      const initials = getInitials();
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);

      const byId = new Map((data||[]).map(r=>[r.policy_id, r]));
      Object.values(SECTIONS).forEach(def=>{
        def.items.forEach(item=>{
          const pid = POLICY_META?.[item.code]?.id;
          if(!pid) return;
          const row = byId.get(pid);
          if(row && row.agreed){
            localStorage.setItem(nsKey(def.store)+item.code, JSON.stringify({
              initials: (row.signed_initials || initials).toUpperCase(),
              ts: row.created_at
            }));
          }
        });
      });
    }

    async function saveAckToDB({ initials, policyCode }){
      const policyId = POLICY_META?.[policyCode]?.id || null;
      const session_id = getSessionId();
      const s = getSession();

      if(!policyId) return { ok:false, message:'Policy not registered' };

      // 1) try RPC
      try{
        const { error } = await client.rpc('hb_ack_policy', {
          p_initials: initials,
          p_policy_id: policyId,
          p_signed_initials: initials,
          p_session_id: session_id,
          p_agreed: true,
          p_employee_id: s?.employee_id || null
        });
        if(!error) return { ok:true };
      }catch(e){}

      // 2) fallback insert (requires anon insert policy on hb_acks)
      try{
        const payload = {
          policy_id: policyId,
          employee_initials: initials,
          signed_initials: initials,
          agreed: true,
          session_id: session_id,
          employee_id: s?.employee_id || null
        };
        const { error } = await client.from('hb_acks').insert(payload);
        if(!error) return { ok:true };
      }catch(e){}

      return { ok:false, message:'DB not ready' };
    }

    function updateProgress(){
      const def = SECTIONS[currentTab];
      const total = def.items.length;
      let saved = 0;
      def.items.forEach(i=>{
        if(localStorage.getItem(nsKey(def.store) + i.code)) saved++;
      });
      progCountEl.textContent = saved;
      progBar.style.width = Math.round((saved/total)*100) + '%';

      const allDone = saved === total;
      btnNext.disabled = !allDone;
      if(allDone){
        btnNext.classList.remove('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.add('bg-emerald-600');
      }else{
        btnNext.classList.add('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.remove('bg-emerald-600');
      }
    }

    function wireSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const def = SECTIONS[currentTab];
          const code = btn.getAttribute('data-code');
          const input = document.getElementById(`init_${code.replace('.','_')}`);
          const msgEl = document.getElementById(`msg_init_${code.replace('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toast(msgEl, 'Enter initials.'); return; }

          // save locally (always)
          localStorage.setItem(nsKey(def.store) + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));

          // attempt DB
          const res = await saveAckToDB({ initials: typed, policyCode: code });
          toast(msgEl, res.ok ? 'Saved to record.' : 'Saved locally (DB not ready).', res.ok);
          updateProgress();
        });
      });
    }

    /* ========= NAV ========= */
    btnBack.addEventListener('click', ()=> { history.back(); });
    btnNext.addEventListener('click', ()=>{
      if(btnNext.disabled) return;
      const order = ["I","II","III","IV","V","VII","VIII","IX"];
      const idx = order.indexOf(currentTab);
      if(idx >=0 && idx < order.length-1){
        document.querySelector(`.tabbtn[data-tab="${order[idx+1]}"]`).click();
      }else{
        alert('All sections complete.');
      }
    });

    /* ========= BOOT ========= */
    async function bootApp(){
      await fillEmployeeCard();
      renderSection('I');            // draw immediately
      await loadPoliciesMeta();      // map codes -> policy ids
      await prefillFromDB();         // hydrate from DB if available
      renderSection(currentTab);     // redraw with hydrated values
    }

    (async function init(){
      const s = getSession();
      if (s?.username) { showApp(); await bootApp(); }
      else { showLogin(); }
    })();
  </script>
</body>
</html>
