<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook (Sections I–IX)</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#1F2937',
            'jc-secondary': '#334155',
            'jc-gold': '#C0A06D',
            'jc-border': '#E2E8F0',
          },
          boxShadow: {
            'soft': '0 12px 40px rgba(0,0,0,.08)',
            'glow': '0 0 0 1px rgba(255,255,255,.3), 0 20px 60px rgba(0,0,0,.18)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .prose-handbook h2, .prose-handbook h3 { font-family: 'Playfair Display', serif; }
    .tab { border:1px solid var(--tw-prose-borders, #E2E8F0); }
    .tab-active { background:#C0A06D; color:#fff; border-color:transparent; }
    .tab-inactive { background:#fff; color:#334155; }
    .tab-inactive:hover { background:#f8fafc; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <!-- Glossy background -->
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-30" style="
    background:
      radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
      radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
      radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);
  "></div>

  <!-- ===================== LOGIN (first) ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <!-- Logo -->
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., jteng"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP (after login) ===================== -->
  <div id="appView" class="hidden">
    <!-- Top-right address & copyright -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex justify-end">
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- Centered logo -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex justify-center">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo"
             class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
      </div>
    </header>

    <!-- Employee Information (auto-filled) -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div><div class="text-slate-500">Employee</div><div id="fi_name" class="font-medium">—</div></div>
            <div><div class="text-slate-500">User</div><div id="fi_user" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Position</div><div id="fi_position" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Department</div><div id="fi_department" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Reports to</div><div id="fi_reports_to" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Email</div><div id="fi_email" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Phone</div><div id="fi_phone" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Session started</div><div id="fi_session_started" class="font-medium">—</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <div class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div id="tabs" class="flex flex-wrap gap-2 items-center"></div>
      <div class="ml-auto text-sm text-slate-600 mt-3">
        Effective Date: <span class="font-medium">January 1, 2026</span> • Version: <span class="font-medium">2.0</span>
      </div>
    </div>

    <!-- Sections container -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-4 pb-28">
      <div id="sections"></div>
    </main>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');

    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const tabsWrap = document.getElementById('tabs');
    const sectionsWrap = document.getElementById('sections');

    /* ========= UTIL ========= */
    const CODE_RE = /^(\d+\.\d+(?:\.\d+)*)/;
    const safe = (v, dash='—') => (v===null||v===undefined||v==='') ? dash : v;
    const toast = (el, msg, ok=false) => { el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); };
    const setSession = (data)=> localStorage.setItem('hb_session', JSON.stringify(data));
    const getHbSession = ()=> { try{ return JSON.parse(localStorage.getItem('hb_session')||'{}'); }catch{ return {}; } };
    const getSessionInitials = ()=> (getHbSession()?.initials||'').toUpperCase();
    const getSessionId = ()=> { const sid=localStorage.getItem('hb_session_id'); return sid?Number(sid):null; };
    const getSessionStartedAt = ()=> localStorage.getItem('hb_session_started_at') || new Date().toISOString();
    const extractCode = (title='') => { const m=String(title).match(CODE_RE); return m?m[1]:null; };

    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    /* ========= LOGIN ========= */
    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId){
          localStorage.setItem('hb_session_id', String(sessionId));
          localStorage.setItem('hb_session_started_at', startedAt);
        }
        return { sessionId, startedAt };
      }catch(e){
        const startedAt = new Date().toISOString();
        localStorage.setItem('hb_session_started_at', startedAt);
        return { sessionId:null, startedAt };
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }
      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });
        if(error){ loginMsg.textContent = error.message || 'Login failed'; return; }
        const row = Array.isArray(data)? data[0] : data;
        if(!row){ loginMsg.textContent = 'Invalid credentials'; return; }

        const s = {
          username: u,
          initials: (row.initials||'').toUpperCase(),
          employee_id: row.employee_id || null,
          full_name: row.full_name || null,
          position: row.position || null,
          department: row.department || null,
          is_owner: !!row.is_owner,
          email: row.email || null,
          phone: row.phone || null,
          reports_to: row.reports_to || null
        };
        setSession(s);
        await startRemoteSession(s.initials);
        loginMsg.textContent = 'Welcome.';
        showApp();
        await bootApp();
      }catch(e){
        loginMsg.textContent = 'Login error';
        console.error(e);
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    /* ========= EMPLOYEE CARD ========= */
    async function fillEmployeeCard(){
      const initials = getSessionInitials();
      const started  = getSessionStartedAt();
      document.getElementById('fi_user').textContent = safe(initials);
      document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

      if(!initials) return;
      const s = getHbSession();
      const fill = (e)=> {
        document.getElementById('fi_name').textContent        = safe(e.full_name);
        document.getElementById('fi_position').textContent    = safe(e.position);
        document.getElementById('fi_department').textContent  = safe(e.department);
        document.getElementById('fi_reports_to').textContent  = safe(e.reports_to);
        document.getElementById('fi_email').textContent       = safe(e.email);
        document.getElementById('fi_phone').textContent       = safe(e.phone);
      };

      if(s?.full_name || s?.position || s?.department){ fill(s); return; }

      const { data } = await client
        .from('hb_employees')
        .select('full_name, position, department, reports_to, email, phone')
        .eq('initials', initials).maybeSingle();
      fill(data||{});
    }

    /* ========= SECTION CONTENT ========= */
    const S1 = [
      { code:"1.1", title:"Welcome to Jeng Chi Restaurant", html:`<p>We are pleased to have you join our team here at Jeng Chi. This restaurant has been operating since 1990 ... we are committed to helping you succeed in your new job opportunity.</p>`},
      { code:"1.2", title:"Employee Handbook — Purpose and Coverage", html:`<p>This Employee Handbook (“Handbook”) summarizes key personnel policies ... Compliance with this Handbook is a condition of employment.</p>`},
      { code:"1.3", title:"Disclaimer, Employment-At-Will & Management Approval Authority", html:`
        <p><strong>Purpose.</strong> Clarifies employment at Jeng Chi ... approval standard for changes to an employee’s position or pay.</p>
        <p><strong>Not a Contract.</strong> This handbook does not create a contract or guarantee employment.</p>
        <p><strong>Right to Modify.</strong> The Company may revise/suspend policies at any time, consistent with law.</p>
        <p><strong>No Unauthorized Promises.</strong> Only a written agreement signed by Janelle Teng or Francisco Teng may modify the at-will relationship.</p>
        <p><strong>Equal Employment & Non-Retaliation.</strong> We prohibit unlawful discrimination and retaliation.</p>`},
      { code:"1.4", title:"Approval Authority for Position & Pay Changes", html:`
        <p><strong>Prior written approval is required for:</strong></p>
        <ul class="list-disc ml-6">
          <li><strong>Pay changes:</strong> base/salary/tip-differential/bonuses outside a formula.</li>
          <li><strong>Position changes:</strong> promotions/demotions/reclassifications/FLSA status.</li>
          <li><strong>Work schedule/pay basis changes</strong> affecting overtime eligibility.</li>
        </ul>
        <p><strong>Approvers:</strong> Janelle Teng or Francisco Teng (delegations in writing).</p>
        <p><strong>Effective dates:</strong> Only after written approval + written notice; no retro except to correct errors or ensure compliance.</p>
        <p><strong>Invalid changes:</strong> Unapproved promises are void; report concerns to HR.</p>`},
      { code:"1.5", title:"Administration and Changes", html:`<p>The Company may modify, rescind, delete, or add policies at any time ... Employees are responsible for reviewing updated policies.</p>`},
      { code:"1.6", title:"Interpretation; Deviation; No Past-Practice Rights", html:`<p>Company may interpret/deviate as appropriate, consistent with law. No binding rule from past practices. Progressive discipline may be skipped when warranted.</p><p><strong>Supersession:</strong> This Handbook supersedes prior versions (law/plan controls on conflict).</p>`},
      { code:"1.7", title:"Conflicts with Law or Other Documents", html:`<p>If a policy conflicts with law, the law controls; official plan documents control over summaries; English version controls.</p>`},
    ];

    const S2 = [
      { code:"2.1", title:"Employee Classifications", html:`
        <p><strong>Purpose.</strong> Clarify FLSA/Texas categories.</p>
        <ul class="list-disc ml-6">
          <li><strong>Exempt:</strong> salary, not overtime-eligible (meets tests).</li>
          <li><strong>Nonexempt:</strong> hourly, overtime-eligible; must record all hours.</li>
          <li><strong>Full-Time:</strong> 30+ hrs/wk.</li>
          <li><strong>Part-Time:</strong> &lt;30 hrs/wk.</li>
          <li><strong>Temporary/Seasonal:</strong> defined period/project.</li>
        </ul>
        <p>Classification may change with role; all employment is at-will.</p>`},
      { code:"2.2", title:"Equal Employment Opportunity (EEO) & ADA", html:`
        <p>Equal opportunity; no retaliation.</p>
        <h3 class="text-xl mt-3">Reasonable Accommodation</h3>
        <ul class="list-disc ml-6">
          <li>Who: applicants/employees with disabilities; religious needs; lactation.</li>
          <li>How: notify supervisor or HR/Owner; limited documentation may be requested.</li>
          <li>Interactive process & decision in writing.</li>
        </ul>`},
      { code:"2.3", title:"Introductory Period", html:`
        <p>First 60 days to confirm fit; training/feedback; review around day ~60; at-will remains. I-9 within 3 business days.</p>`},
      { code:"2.4", title:"Reporting Discrimination/Harassment", html:`<ul class="list-disc ml-6"><li>Report to supervisor or HR/Owner.</li><li>Prompt investigation; confidentiality as practicable.</li><li>No retaliation.</li></ul>`},
      { code:"2.5", title:"Required Certifications & Paid Training (Overview)", html:`<p>Food Handler & TABC requirements; Company pays initial fees; scheduled on-site; training time is paid at Training Rate.</p>`},
      { code:"2.5.1", title:"Food Safety (Food Handler – TXDSHS)", html:`<ul class="list-disc ml-6"><li>Who: anyone handling food/utensils/BOH/FOH areas.</li><li>Deadline: within 30 days.</li><li>Paid training; proof & renewals; lapses may remove from duty and lead to discipline.</li></ul>`},
      { code:"2.5.2", title:"Alcohol Service (TABC Seller-Server)", html:`<ul class="list-disc ml-6"><li>Who: sell/serve alcohol (18+).</li><li>Maintain current before any alcohol shift.</li><li>Paid training; proof & renewals.</li></ul>`},
      { code:"2.6", title:"Paid Training – FLSA/TWC", html:`<p>Training Rate ≥ applicable minimum. Tipped roles: full minimum (no tip credit) for training. Overtime uses weighted average when over 40.</p>`},
      { code:"2.7", title:"Parking", html:`<p>Park along Greenville Ave or designated areas past the third statue; not in front of businesses; violations may lead to corrective action.</p>`},
      { code:"2.8", title:"Required Notices & Postings", html:`<p>All required posters are maintained and audited; managers keep them visible; employees should review and ask management.</p>`},
    ];

    /* ===== SECTION III (3.x) ===== */
    const S3 = [
      { code:"3.1", title:"Pay Periods & Paydays (Texas Payday Law)", html:`<p>Bi-weekly payroll; payday every other Friday via direct deposit or check. Direct deposit encouraged.</p>`},
      { code:"3.2", title:"Workweek & Hours of Work + Sling App", html:`
        <p>Workweek: Sun 12:00 a.m. – Sat 11:59 p.m. Schedules set by business needs; arrive fit for duty.</p>
        <h3 class="text-xl mt-3">Sling Setup</h3>
        <ul class="list-disc ml-6">
          <li>Download “Sling: Employee Scheduling” (iOS/Android).</li>
          <li>Create account with your Payroll/HR email/phone. Enable 2FA.</li>
          <li>Join Jeng Chi via invite link or search code.</li>
          <li>Set Profile & Availability; request Time Off in app.</li>
          <li>Enable notifications; view schedules; accept shifts; no no-shows.</li>
        </ul>
        <p><strong>Off-the-clock work is not allowed.</strong></p>`},
      { code:"3.3", title:"Timekeeping (All Employees)", html:`<p>Record all time worked, meetings, mandatory trainings. Missed punch: notify supervisor same day. Clock window: not earlier than 7 minutes; more than 7 needs approval.</p>`},
      { code:"3.4", title:"Timekeeping: Record Training Time", html:`<p>Training scheduled by Company; if taken at other times, report it and it will be paid (scheduling issue handled separately).</p>`},
      { code:"3.5", title:"Timekeeping & Wage Compliance", html:`<ul class="list-disc ml-6"><li>All required training time must be recorded.</li><li>No dual-tasking during training time.</li><li>No off-the-clock work.</li></ul>`},
      { code:"3.6", title:"Overtime (Nonexempt)", html:`<p>1.5× regular rate for >40 hrs in the workweek; only hours worked count; must be approved in advance; paid even if unapproved.</p>`},
      { code:"3.7", title:"Overtime for Tipped Employees (Servers)", html:`<p>Servers: OT paid at $6.13/hr for hours over 40 in the workweek; advance approval except emergency.</p>`},
      { code:"3.8", title:"Meal & Rest Breaks", html:`<p>Texas doesn’t require breaks. Unpaid meal periods require full relief from duty and clock-out/in; eat in designated areas; wash hands.</p>`},
      { code:"3.9", title:"Payroll Deductions", html:`<p>Legal deductions (taxes, garnishments); other deductions need specific written authorization with exact amount and purpose.</p>`},
      { code:"3.10", title:"Uniforms & Work Equipment (Deductions)", html:`<p>Employee-paid uniforms must have specific written authorization; must comply with Payday Law; no blanket authorizations.</p>`},
      { code:"3.11", title:"Wage Garnishments", html:`<p>We comply with valid orders until satisfied or released; bring documentation for disputes.</p>`},
      { code:"3.12", title:"Direct Deposit & Lost/Returned Payments", html:`<p>Keep bank info current; if ACH returns, we reissue next business day after funds return. $35 stop-payment/reissue fee only with one-time written authorization for that occurrence.</p>`},
      { code:"3.13", title:"Pay Statements & Access (MyToast)", html:`
        <p>Toast is payroll system of record. Get paystubs via MyToast app (iOS/Android). Printed copies available by request; processing up to 2 business days.</p>
        <p><strong>Final Pay:</strong> involuntary: within 6 days; voluntary: next regular payday.</p>`},
      { code:"3.14", title:"Payroll Questions & Disputes", html:`<p>Report discrepancies to HR/Payroll ASAP (ideally within 2 business days). HR investigates within 3 business days; corrections on next payroll.</p>`},
      { code:"3.15", title:"Tips & Gratuities Policy (Texas)", html:`
        <p><strong>Core rules:</strong> JCR does not keep employees’ tips. Managers/BOH may not receive tips.</p>
        <p><strong>Card tip fees:</strong> We may deduct the actual processor % from card tips, capped at 3% of the tip amount.</p>
        <p><strong>Tip pooling:</strong> Only as allowed by law; managers/BOH excluded. Eligible: Servers, Bartenders, Bussers, Hosts, Cashiers, Bartender Jr.</p>
        <p><strong>Acknowledgment required.</strong></p>`},
    ];

    /* ===== SECTION IV (4.x) ===== */
    const S4 = [
      { code:"4.1", title:"Zero-Tolerance Policy (Safety, Integrity & Respect)", html:`<p>Immediate action on serious conduct; may proceed directly to termination consistent with investigation and law. Mandatory reporting; anti-retaliation.</p>`},
      { code:"4.2", title:"Anti-Harassment / Anti-Discrimination & Diversity", html:`<p>Prohibits harassment, discrimination, retaliation based on protected status; prompt action when we know or should know.</p>`},
      { code:"4.3", title:"Diversity & Inclusion Commitment", html:`<p>Merit-based practices, respectful teams, reasonable accommodations, fair processes to report and resolve concerns.</p>`},
      { code:"4.4", title:"Examples of Prohibited Conduct", html:`<ul class="list-disc ml-6"><li>Verbal/visual, physical, sexual, electronic/online, third-party harassment.</li></ul>`},
      { code:"4.5", title:"Speak-Up & Investigation Policy", html:`<p>Report to any manager/HR; fast response; confidentiality; no retaliation.</p>`},
      { code:"4.6", title:"Our Investigation (Process)", html:`<p>Start within 1–3 business days; impartial reviewer; preponderance standard; corrective actions as warranted; closing notice; records retained.</p>`},
      { code:"4.7", title:"Anti-Retaliation (Zero Tolerance)", html:`<p>Prohibits retaliation; report immediately; we will correct.</p>`},
      { code:"4.8", title:"Professional Boundaries & No Horseplay", html:`<p>No horseplay/unnecessary contact; definitions and examples; reporting; consequences.</p>`},
      { code:"4.9", title:"Workplace Searches & Monitoring", html:`<p>Company may inspect Company Property; professional/nondiscriminatory; cooperate with inspections.</p>`},
      { code:"4.10", title:"Personal Cell Phone & Earbud Policy", html:`<p>Phones away during work except approved; no earbuds in FOH/BOH; safety rules; emergencies with manager awareness; progressive discipline.</p>`},
      { code:"4.11", title:"No Smoking, Vaping, Chewing Gum, Dipping", html:`<p>No use indoors/near entrances; use designated area on breaks; follow local rules; progressive discipline.</p>`},
      { code:"4.12", title:"Personal Errands While on the Clock", html:`<p>Not permitted; urgent matters require clocking out; Company errands require authorization and on-the-clock compliance.</p>`},
      { code:"4.13", title:"Employee Bar Policy", html:`<p>21+ to consume off duty; strict on-duty prohibition; off-duty patronage rules; TABC compliance.</p>`},
      { code:"4.14", title:"FOH Order Integrity & Guest Service", html:`<p>Ring before serve/pack; manager controls and audits; prohibited conduct; payment verification and walk-outs process.</p>`},
      { code:"4.15", title:"Dress Code & Uniform Standards", html:`<p>Detailed BOH/FOH standards (attire, hair, jewelry, nails, fragrance, tattoos), care & enforcement, deductions with authorization.</p>`},
    ];

    /* ===== SECTION V (5.x) ===== */
    const S5 = [
      { code:"5.1", title:"Standard Progressive Path", html:`<p>Verbal #1 → Verbal #2 → Written #1 → Written #2/Final → Termination (may skip for egregious conduct).</p>`},
      { code:"5.2", title:"Cross-policy progression (no reset)", html:`<p>Warnings accumulate across policies; different-policy break continues up the ladder.</p>`},
      { code:"5.3", title:"Documentation & Timelines", html:`<p>Each step documented; copy to employee; refusal to sign is noted.</p>`},
      { code:"5.4", title:"Zero-Tolerance / Immediate-Termination Offenses", html:`<p>Violence, theft/fraud, severe harassment, serious safety/food-safety endangerment, illicit drugs at work; investigate then may terminate immediately.</p>`},
      { code:"5.5", title:"Attendance & Punctuality Ladder", html:`<p>Defined ladder; NC/NS may be Final or Termination on first occurrence depending on impact/record.</p>`},
      { code:"5.6", title:"Fights, Threats & Workplace Violence", html:`<p>Rules for mutual fights, retreating party, threats; immediate response and review.</p>`},
      { code:"5.7", title:"Dishonesty, Theft & Fraud; Timekeeping Integrity", html:`<p>Theft → Termination; timekeeping violations progressive up to termination; all time worked is paid.</p>`},
      { code:"5.8", title:"Unprofessional / Disrespectful Conduct", html:`<p>Yelling/abuse/insubordination ladder; severe incidents may skip steps.</p>`},
      { code:"5.9", title:"Social Media & Communications", html:`<p>Prohibited disclosures/harassment; protected concerted activity preserved; up to termination for violations.</p>`},
      { code:"5.10", title:"Drugs, Alcohol & Impairment", html:`<p>Remove from duty; safe transport; discipline ladder unless severity/recurrence warrants skipping.</p>`},
      { code:"5.11", title:"Harassment, Discrimination & Retaliation", html:`<p>Zero tolerance; discipline up to termination per investigation.</p>`},
      { code:"5.12", title:"Corrective Action Plans (CAPs)", html:`<p>What/How/Who/When/Measures/Consequences; 1–2 week windows typical.</p>`},
      { code:"5.13", title:"Benefits & PTO on Separation", html:`<p>PTO payout per plan/policy; generally not paid unless policy states otherwise.</p>`},
      { code:"5.14", title:"Resignation (Two-Weeks’ Notice) & How to Submit", html:`<p>At-will reminder; request 2 weeks’ notice; use form; HR confirms last day.</p>`},
      { code:"5.15", title:"Company Acceptance / Scheduling During Notice", html:`<p>Schedules set by business needs; may adjust/release earlier (pay for hours worked).</p>`},
      { code:"5.16", title:"Conduct During Notice", html:`<p>All policies still apply; serious violations may lead to termination.</p>`},
      { code:"5.17", title:"Job Abandonment (No-Call/No-Show)", html:`<p>Two consecutive scheduled shifts NC/NS may be treated as job abandonment; rehire eligibility rules.</p>`},
      { code:"5.18", title:"Discipline — FOH Order Integrity & Guest Service", html:`<p>Walk-out response; audits; incident handling ladders; guest assignment rules; CAP content.</p>`},
    ];

    /* ===== SECTION VI (6.x) — FMLA ===== */
    const S6 = [
      { code:"6.1", title:"Eligibility (FMLA)", html:`<p>12 months employment; 1,250 hours in prior 12 months; 50+ employees within 75 miles.</p>`},
      { code:"6.2", title:"Qualifying Reasons", html:`<p>Own serious health; family care; bonding; military exigency; 26 weeks for covered servicemember care.</p>`},
      { code:"6.3", title:"Pregnancy & Childbirth — PWFA/ADA", html:`<p>Assess accommodations if not FMLA-eligible or post-FMLA; no separate Texas PDL.</p>`},
      { code:"6.4", title:"Amount, Scheduling & Intermittent", html:`<p>Continuous/intermittent/reduced; schedule to avoid undue disruption when practicable.</p>`},
      { code:"6.5", title:"Pay & Benefits During Leave", html:`<p>Generally unpaid; PTO substitution rules; health benefits continuation; FLSA notes.</p>`},
      { code:"6.6", title:"Employee Notice Responsibilities", html:`<p>30 days for foreseeable; asap otherwise; enough info for FMLA assessment.</p>`},
      { code:"6.7", title:"Medical Certification & Fitness-for-Duty", html:`<p>15 days to return cert (extensions as needed); FFD for safety-sensitive roles.</p>`},
      { code:"6.8", title:"Employer Notices", html:`<p>Eligibility & Rights/Responsibilities; Designation Notice timing.</p>`},
      { code:"6.9", title:"Performance, Conduct & Anti-Retaliation", html:`<p>Standards still apply; no interference/retaliation for FMLA or accommodations.</p>`},
      { code:"6.10", title:"Fraud/Abuse", html:`<p>Knowingly misusing FMLA may lead to discipline up to termination.</p>`},
      { code:"6.11", title:"Concurrent Leaves & Workers’ Comp", html:`<p>FMLA may run concurrently when criteria met.</p>`},
      { code:"6.12", title:"How to Request FMLA or Pregnancy Accommodation", html:`<p>Notify, complete forms, return certification, engage in PWFA/ADA interactive process.</p>`},
      { code:"6.13", title:"Administration & Questions", html:`<p>HR administers; contact HR for forms/questions.</p>`},
    ];

    /* ===== SECTION VII (7.x) — Doctor’s Notice & Medical Leave Docs (you titled IX, codes are 7.x) ===== */
    const S7 = [
      { code:"7.1", title:"When a Doctor’s Note Is Required", html:`<p>Rules for short absences, 3+ days, food-safety illnesses, after warnings or surgery/injury.</p>`},
      { code:"7.2", title:"How to Submit Your Doctor’s Note", html:`<p>Deliver to HR; receipt given; confidentiality maintained in medical file.</p>`},
      { code:"7.3", title:"FMLA Screening & Paperwork", html:`<p>Forms WH-381/380/382 timing; provisional treatment; job restoration standards.</p>`},
      { code:"7.4", title:"Pregnancy, Childbirth & Related Conditions (PWFA/ADA)", html:`<p>Reasonable accommodations unless undue hardship; request via HR.</p>`},
      { code:"7.5", title:"Workers’ Compensation & Work-Injury Notes", html:`<p>Report immediately; provide RTW notes to HR; temporary modified duty as available.</p>`},
      { code:"7.6", title:"Pay, PTO & Scheduling During Medical Leave", html:`<p>Unpaid unless PTO/benefit applies; OT based on hours worked; provide restrictions/ETAs.</p>`},
      { code:"7.7", title:"If Documentation Is Not Provided", html:`<p>Deadlines; unpaid pending; may result in separation for inability to return/job abandonment absent extenuating circumstances.</p>`},
      { code:"7.8", title:"Fitness-for-Duty (FFD) to Return", html:`<p>Required after certain absences/illnesses; we assess accommodations.</p>`},
      { code:"7.9", title:"No Retaliation / Consistent Application", html:`<p>No retaliation; consistent enforcement; confidentiality.</p>`},
    ];

    /* ===== SECTION VIII (8.x) — Benefits ===== */
    const S8 = [
      { code:"8.1", title:"Eligibility & Waiting Period", html:`<p>Full-time (30+ hrs); 60-day wait; plan-document controlled; qualifying events; effective dates.</p>`},
      { code:"8.2", title:"PTO — Accrual Start", html:`<p>Full-time only; accrual after 60 days; see PTO policy for caps/scheduling.</p>`},
      { code:"8.3", title:"Coordination With Leave & Payroll", html:`<p>Benefits/deductions continue while eligible; during unpaid leaves you may need to pay premiums directly.</p>`},
      { code:"8.4", title:"Payroll Advance Policy (Overview)", html:`<p>Emergency short-term loans; up to 50% of earned hours incl. tips; repaid from next paycheck; max 6/year.</p>`},
      { code:"8.5", title:"Conditions for Payroll Advance & Process", html:`<p>60+ days; good standing; emergency; request form & review window; notification; calculation & limits.</p>`},
      { code:"8.6", title:"Employee Meal (Unpaid Meal Break)", html:`<p>Off-the-clock meal; where/how to eat; beverages/purchases; hygiene rules.</p>`},
      { code:"8.7", title:"Workers’ Compensation Insurance", html:`<p>Subscriber; coverage through Society Insurance; exclusive remedy per Texas law exceptions.</p>`},
      { code:"8.8", title:"Employee Time Off (Leaves Overview)", html:`<p>Requests 21 days ahead where possible; approval at management discretion; medical certification may be required; reinstatement not guaranteed unless law requires.</p>`},
      { code:"8.9", title:"Paid Time Off Policy (PTO)", html:`<p>Upfront yearly PTO; manager approval via Sling; coverage planning; forfeiture conditions after status changes; special Q4 note.</p>`},
      { code:"8.10", title:"Use and Management of PTO", html:`<p>Upfront; no rollover; unused paid on last paycheck of year; termination payout rules; blackout dates; first-come-first-serve; two in same dept not at same time.</p>`},
      { code:"8.11", title:"Request to use PTO", html:`<p>21-day advance for vacations; Sling + signed form to Payroll.</p>`},
      { code:"8.12", title:"PTO — Full-Time Employees (≥30 hrs/wk)", html:`<p>Eligibility; accrual mechanics and caps; annual cycle; TWC compliance note.</p>`},
      { code:"8.13", title:"Requesting & Scheduling PTO", html:`<p>How to request; approval criteria; no negatives; coordination with leave laws.</p>`},
      { code:"8.14", title:"Pay & FLSA Guardrails; Year-End; Separation", html:`<p>Base rate; PTO not hours worked for OT; year-end payout for active employees; no payout at termination; rehire rules.</p>`},
    ];

    /* ===== Sections registry & locking order ===== */
    const SECTION_DEFS = [
      { key:'S1', label:'Section I — Introduction', store:'jc_section_i_',    list:S1 },
      { key:'S2', label:'Section II — Employment Policies', store:'jc_section_ii_',   list:S2 },
      { key:'S3', label:'Section III — Hours of Work & Payroll', store:'jc_section_iii_', list:S3 },
      { key:'S4', label:'Section IV — Standards of Conduct', store:'jc_section_iv_', list:S4 },
      { key:'S5', label:'Section V — Discipline & Corrective Action', store:'jc_section_v_', list:S5 },
      { key:'S6', label:'Section VI — FMLA', store:'jc_section_vi_', list:S6 },
      { key:'S7', label:'Section VII — Doctor’s Notice & Medical Docs', store:'jc_section_vii_', list:S7 },
      { key:'S8', label:'Section VIII — Benefits & Services', store:'jc_section_viii_', list:S8 },
      // If you later add a true Section IX with 9.x codes, append here.
    ];

    /* ===== Supabase policy id mapping ===== */
    const POLICY_META = {};  // e.g., POLICY_META["1.1"] = {id,...}

    async function loadPolicyMetaForAll(){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending:true });

      if(error){ console.warn('hb_policies', error); return; }
      (data||[]).forEach(r=>{
        const code = extractCode(r.title);
        if(code) POLICY_META[code] = { id:r.id, title:r.title };
      });
    }

    async function prefillAcksForInitials(initials){
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);
      if(error) return;
      const byId = new Map((data||[]).map(r=>[r.policy_id, r]));
      // populate localStorage for every known code
      SECTION_DEFS.forEach(sec=>{
        sec.list.forEach(item=>{
          const meta = POLICY_META[item.code];
          if(meta && byId.has(meta.id) && byId.get(meta.id).agreed){
            localStorage.setItem(sec.store + item.code, JSON.stringify({
              initials:(byId.get(meta.id).signed_initials||initials).toUpperCase(),
              ts: byId.get(meta.id).created_at
            }));
          }
        });
      });
    }

    async function saveAckToDB(initials, policyCode){
      const session_id = getSessionId();
      const hb = getHbSession();
      const employee_id = hb?.employee_id || null;
      const meta = POLICY_META[policyCode];

      if(meta?.id){
        try{
          const { error } = await client.rpc('hb_ack_policy', {
            p_initials: initials, p_policy_id: meta.id,
            p_signed_initials: initials, p_session_id: session_id, p_agreed:true
          });
          if(!error) return { ok:true };
        }catch(e){}
      }
      // Fallback insert
      try{
        const payload = {
          policy_id: meta?.id || null,
          employee_initials: initials,
          signed_initials: initials,
          agreed: true,
          session_id
        };
        if(employee_id) payload.employee_id = employee_id;
        const { error } = await client.from('hb_acks').insert(payload);
        if(error) return { ok:false, error };
        return { ok:true };
      }catch(e){ return { ok:false, error:e?.message||'Insert failed' }; }
    }

    /* ===== Rendering ===== */
    function policyCard(item, storePrefix){
      const inputId = `init_${storePrefix}${item.code.replaceAll('.','_')}`;
      const cache = localStorage.getItem(storePrefix + item.code);
      const val = cache ? (JSON.parse(cache)?.initials || '') : '';
      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
                <div class="text-[15px] leading-7 text-slate-700 prose-handbook">${item.html}</div>
              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${val}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" data-store="${storePrefix}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves to your record.</div>
                </div>
              </div>
            </div>
          </div>
        </article>
      `;
    }

    function sectionShell(idx, def){
      const secId = `sec_${def.key}`;
      const countId = `count_${def.key}`;
      const totalId = `total_${def.key}`;
      const barId = `bar_${def.key}`;
      const listId = `list_${def.key}`;
      const prevId = `prev_${def.key}`;
      const nextId = `next_${def.key}`;
      return `
        <section id="${secId}" class="${idx===0?'':'hidden'} rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40 mt-6">
          <div class="px-6 pt-6 pb-4 border-b border-jc-border">
            <h1 class="font-serif-head text-3xl text-jc-primary tracking-tight">${def.label}</h1>
            <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>.</p>
          </div>

          <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
            <div class="text-sm text-slate-600">Progress: <span id="${countId}" class="font-semibold">0</span>/<span id="${totalId}">0</span> saved</div>
            <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
              <div id="${barId}" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
            </div>
          </div>

          <div id="${listId}" class="p-6"></div>

          <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
            <button id="${prevId}" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Previous</button>
            <button id="${nextId}" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Next</button>
          </div>
        </section>
      `;
    }

    function renderTabs(){
      tabsWrap.innerHTML = '';
      SECTION_DEFS.forEach((def, i)=>{
        const btn = document.createElement('button');
        btn.textContent = def.label.replace(/ —.*/,''); // short label
        btn.className = `tab rounded-xl px-4 py-2 text-sm ${i===0?'tab-active':'tab-inactive'}`;
        btn.id = `tab_${def.key}`;
        btn.disabled = i!==0; // lock others initially; will unlock by progress
        tabsWrap.appendChild(btn);
      });
    }

    function renderSections(){
      sectionsWrap.innerHTML = SECTION_DEFS.map((def, i)=>sectionShell(i,def)).join('');
      // Fill each policy list
      SECTION_DEFS.forEach(def=>{
        const listEl = document.getElementById(`list_${def.key}`);
        const totalEl = document.getElementById(`total_${def.key}`);
        totalEl.textContent = def.list.length;
        listEl.innerHTML = def.list.map(item => policyCard(item, def.store)).join('');
      });
    }

    function updateProgress(def){
      const saved = def.list.filter(item => localStorage.getItem(def.store + item.code)).length;
      document.getElementById(`count_${def.key}`).textContent = saved;
      const pct = Math.round((saved/def.list.length)*100);
      document.getElementById(`bar_${def.key}`).style.width = `${pct}%`;
      const nextBtn = document.getElementById(`next_${def.key}`);
      const allDone = (saved===def.list.length);
      nextBtn.disabled = !allDone;
      nextBtn.classList.toggle('bg-emerald-600', allDone);
      nextBtn.classList.toggle('bg-slate-400', !allDone);
      nextBtn.classList.toggle('cursor-not-allowed', !allDone);
      nextBtn.classList.toggle('opacity-70', !allDone);
      return allDone;
    }

    function activateSection(idx){
      SECTION_DEFS.forEach((def,i)=>{
        document.getElementById(`sec_${def.key}`).classList.toggle('hidden', i!==idx);
        const tab = document.getElementById(`tab_${def.key}`);
        tab.classList.toggle('tab-active', i===idx);
        tab.classList.toggle('tab-inactive', i!==idx);
      });
    }

    function unlockTabsByGate(){
      // Unlock tab[i+1] if section[i] complete
      SECTION_DEFS.forEach((def,i)=>{
        const tab = document.getElementById(`tab_${def.key}`);
        if(i===0){ tab.disabled = false; return; }
        const prevDone = updateProgress(SECTION_DEFS[i-1]);
        const thisDone = updateProgress(def);
        // Unlock if previous is complete
        tab.disabled = !prevDone;
        // Also wire the next button inside sections
        const prevBtn = document.getElementById(`prev_${def.key}`);
        const nextBtn = document.getElementById(`next_${def.key}`);
        if(prevBtn && i>0){
          prevBtn.onclick = ()=>activateSection(i-1);
        }
        if(nextBtn){
          nextBtn.onclick = ()=> {
            if(!nextBtn.disabled && i < SECTION_DEFS.length-1){
              activateSection(i+1);
            }
          };
        }
      });
      // Also set first section prev/next
      const firstPrev = document.getElementById(`prev_${SECTION_DEFS[0].key}`);
      if(firstPrev){ firstPrev.onclick = ()=>window.scrollTo({top:0,behavior:'smooth'}); }
      const firstNext = document.getElementById(`next_${SECTION_DEFS[0].key}`);
      if(firstNext){ firstNext.onclick = ()=> { if(!firstNext.disabled) activateSection(1); } }
    }

    function wireTabClicks(){
      SECTION_DEFS.forEach((def,i)=>{
        const tab = document.getElementById(`tab_${def.key}`);
        tab.addEventListener('click', ()=> {
          if(!tab.disabled) activateSection(i);
        });
      });
    }

    function wireSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const code = btn.getAttribute('data-code');
          const store = btn.getAttribute('data-store');
          const input = document.getElementById(`init_${store}${code.replaceAll('.','_')}`);
          const msgEl = document.getElementById(`msg_init_${store}${code.replaceAll('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toast(msgEl, 'Enter initials.'); return; }

          // Local save
          localStorage.setItem(store + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));

          // DB save
          const res = await saveAckToDB(typed, code);
          toast(msgEl, res.ok ? 'Saved.' : 'Saved locally (DB error).', res.ok);

          // Refresh progress and gates
          SECTION_DEFS.forEach(def=>updateProgress(def));
          unlockTabsByGate();
        });
      });
    }

    /* ===== Boot ===== */
    async function bootApp(){
      await fillEmployeeCard();
      renderTabs();
      renderSections();
      wireTabClicks();

      await loadPolicyMetaForAll();
      await prefillAcksForInitials(getSessionInitials());

      wireSaveButtons();

      // Initial progress + unlock
      SECTION_DEFS.forEach(def=>updateProgress(def));
      unlockTabsByGate();
      activateSection(0);
    }

    (async function init(){
      const s = getHbSession();
      if(s?.initials){
        showApp();
        await bootApp();
      }else{
        showLogin();
      }
    })();
  </script>
</body>
</html>
