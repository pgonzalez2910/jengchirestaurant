<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook (Sections I & II)</title>

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#1F2937',
            'jc-secondary': '#334155',
            'jc-gold': '#C0A06D',
            'jc-border': '#E2E8F0',
          },
          boxShadow: {
            'soft': '0 12px 40px rgba(0,0,0,.08)',
            'glow': '0 0 0 1px rgba(255,255,255,.3), 0 20px 60px rgba(0,0,0,.18)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .prose-handbook h2, .prose-handbook h3 { font-family: 'Playfair Display', serif; }
    .tab-btn { @apply rounded-xl px-4 py-2 text-sm border; }
    .tab-active { @apply bg-jc-gold text-white border-transparent; }
    .tab-inactive { @apply bg-white text-slate-700 border-jc-border hover:bg-slate-50; }
  </style>
</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <!-- Glossy gradient bg -->
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="pointer-events-none fixed inset-0 -z-10 opacity-30" style="
    background:
      radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
      radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
      radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);
  "></div>

  <!-- ===================== LOGIN (visible first) ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <!-- centered logo -->
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., jteng"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP (hidden until login) ===================== -->
  <div id="appView" class="hidden">
    <!-- Top-right address & copyright -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex justify-end">
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- Centered logo -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex justify-center">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo"
             class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
      </div>
    </header>

    <!-- Employee Information (auto-filled) -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>

        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div>
              <div class="text-slate-500">Employee</div>
              <div id="fi_name" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">User</div>
              <div id="fi_user" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Position</div>
              <div id="fi_position" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Department</div>
              <div id="fi_department" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Reports to</div>
              <div id="fi_reports_to" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Email</div>
              <div id="fi_email" class="font-medium">—</div>
            </div>

            <div>
              <div class="text-slate-500">Phone</div>
              <div id="fi_phone" class="font-medium">—</div>
            </div>
            <div>
              <div class="text-slate-500">Session started</div>
              <div id="fi_session_started" class="font-medium">—</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ======= Section Switcher ======= -->
    <div class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="flex items-center gap-2">
        <button id="tabS1" class="tab-btn tab-active">Section I — Introduction</button>
        <button id="tabS2" class="tab-btn tab-inactive">Section II — Employment Policies</button>
        <div class="ml-auto text-sm text-slate-600">
          Effective Date: <span class="font-medium">January 1, 2026</span> • Version: <span class="font-medium">2.0</span>
        </div>
      </div>
    </div>

    <!-- ======= Section Container ======= -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-4 pb-24">
      <!-- Section I -->
      <section id="sec1" class="rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 class="font-serif-head text-3xl text-jc-primary tracking-tight">Section I — Introduction</h1>
          <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>. “Next Section” unlocks when all are saved.</p>
        </div>

        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="s1Count" class="font-semibold">0</span>/<span id="s1Total">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="s1Bar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <div id="s1Policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <span></span>
          <button id="btnToS2" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Go to Section II</button>
        </div>
      </section>

      <!-- Section II -->
      <section id="sec2" class="hidden rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 class="font-serif-head text-3xl text-jc-primary tracking-tight">Section II — Employment Policies</h1>
          <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>.</p>
        </div>

        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="s2Count" class="font-semibold">0</span>/<span id="s2Total">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="s2Bar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <div id="s2Policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <button id="btnBackS1" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Back to Section I</button>
          <button id="btnNextS3" class="rounded-xl bg-emerald-600 text-white px-4 py-2 text-sm">Next (Section III)</button>
        </div>
      </section>
    </main>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');

    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const tabS1 = document.getElementById('tabS1');
    const tabS2 = document.getElementById('tabS2');
    const sec1 = document.getElementById('sec1');
    const sec2 = document.getElementById('sec2');

    const s1PoliciesEl = document.getElementById('s1Policies');
    const s2PoliciesEl = document.getElementById('s2Policies');
    const btnToS2 = document.getElementById('btnToS2');
    const btnBackS1 = document.getElementById('btnBackS1');
    const btnNextS3 = document.getElementById('btnNextS3');

    const s1Count = document.getElementById('s1Count');
    const s1Total = document.getElementById('s1Total');
    const s1Bar   = document.getElementById('s1Bar');
    const s2Count = document.getElementById('s2Count');
    const s2Total = document.getElementById('s2Total');
    const s2Bar   = document.getElementById('s2Bar');

    /* ========= UTIL ========= */
    const CODE_RE = /^(\d+\.\d+(?:\.\d+)*)/;
    const S1_STORE = 'jc_section_i_';
    const S2_STORE = 'jc_section_ii_';

    function extractCode(title=''){ const m = String(title).match(CODE_RE); return m ? m[1] : null; }
    function safe(v, dash='—'){ return (v===null || v===undefined || v==='') ? dash : v; }
    function toast(el, msg, ok=false){ el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); }

    function setSession(data){ localStorage.setItem('hb_session', JSON.stringify(data)); }
    function getHbSession(){ try { return JSON.parse(localStorage.getItem('hb_session')||'{}'); } catch { return {}; } }
    function getSessionInitials(){ const s = getHbSession(); return s?.initials ? String(s.initials).toUpperCase() : ''; }
    function getSessionId(){ const sid = localStorage.getItem('hb_session_id'); return sid ? Number(sid) : null; }
    function getSessionStartedAt(){ return localStorage.getItem('hb_session_started_at') || new Date().toISOString(); }

    /* ========= LOGIN ========= */
    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        if(error){ console.warn('hb_start_session error', error); }
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId){
          localStorage.setItem('hb_session_id', String(sessionId));
          localStorage.setItem('hb_session_started_at', startedAt);
        }
        return { sessionId, startedAt };
      }catch(e){
        console.warn('start session threw', e);
        const startedAt = new Date().toISOString();
        localStorage.setItem('hb_session_started_at', startedAt);
        return { sessionId: null, startedAt };
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }

      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });
        if (error) { loginMsg.textContent = error.message || 'Login failed'; return; }
        const row = Array.isArray(data) ? data[0] : data;
        if (!row) { loginMsg.textContent = 'Invalid credentials'; return; }

        const s = {
          username: u,
          initials: (row.initials || '').toUpperCase(),
          employee_id: row.employee_id || null,
          full_name: row.full_name || null,
          position: row.position || null,
          department: row.department || null,
          is_owner: !!row.is_owner,
          email: row.email || null,
          phone: row.phone || null,
          reports_to: row.reports_to || null
        };

        setSession(s);
        await startRemoteSession(s.initials);
        loginMsg.textContent = 'Welcome.';
        showApp();
        await bootApp();
      }catch(e){
        loginMsg.textContent = 'Login error';
        console.error(e);
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    /* ========= EMPLOYEE CARD ========= */
    async function fillEmployeeCard(){
      const initials = getSessionInitials();
      const started  = getSessionStartedAt();

      document.getElementById('fi_user').textContent = safe(initials);
      document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

      if(!initials){ return; }

      const s = getHbSession();
      if (s?.full_name || s?.position || s?.department) {
        document.getElementById('fi_name').textContent        = safe(s.full_name);
        document.getElementById('fi_position').textContent    = safe(s.position);
        document.getElementById('fi_department').textContent  = safe(s.department);
        document.getElementById('fi_reports_to').textContent  = safe(s.reports_to);
        document.getElementById('fi_email').textContent       = safe(s.email);
        document.getElementById('fi_phone').textContent       = safe(s.phone);
        return;
      }

      const { data, error } = await client
        .from('hb_employees')
        .select('full_name, position, department, reports_to, email, phone')
        .eq('initials', initials)
        .maybeSingle();

      if(error){ console.warn('hb_employees error', error); }

      const e = data || {};
      document.getElementById('fi_name').textContent        = safe(e.full_name);
      document.getElementById('fi_position').textContent    = safe(e.position);
      document.getElementById('fi_department').textContent  = safe(e.department);
      document.getElementById('fi_reports_to').textContent  = safe(e.reports_to || e.manager_name);
      document.getElementById('fi_email').textContent       = safe(e.email);
      document.getElementById('fi_phone').textContent       = safe(e.phone);
    }

    /* ========= SECTION DATA ========= */
    const SECTION_I = [
      {
        code: "1.1",
        title: "Welcome to Jeng Chi Restaurant",
        html: `<p>We are pleased to have you join our team here at Jeng Chi. This restaurant has been operating since 1990 and we would like to recognize our employees as our most valuable resource for our continuous success. Our capability in providing customers with authentic Taiwanese food and an enjoyable customers dining experience depends on having high quality people like yourself and your fellow employees. We want you to enjoy your time with us here and we are committed to helping you succeed in your new job opportunity.</p>`
      },
      {
        code: "1.2",
        title: "Employee Handbook — Purpose and Coverage",
        html: `<p>This Employee Handbook (“Handbook”) summarizes key personnel policies, benefits, and workplace standards of Jeng Chi Restaurant (the “Company”), 400 N. Greenville Avenue, Suite 11, Richardson, Texas 75081. It applies to all employees and is intended to promote consistent, lawful practices in accordance with guidance from the Texas Workforce Commission (TWC) and applicable federal, state, and local laws. Compliance with this Handbook is a condition of employment.</p>`
      },
      {
        code: "1.3",
        title: "Disclaimer, Employment-At-Will & Management Approval Authority",
        html: `
          <p><strong>Purpose.</strong> This section clarifies the nature of employment at Jeng Chi Restaurant (“The Company”), explains how handbook policies may change, and sets the approval standard for any changes to an employee’s position or pay.</p>
          <p><strong>Not a Contract.</strong> This handbook is a general guide to THE COMPANY policies and does not create a contract, guarantee of employment, or promise of specific terms or continued employment. Nothing in this handbook alters the at-will employment relationship, which may be ended by the employee or by THE COMPANY at any time, with or without notice and with or without cause, to the extent permitted by law.</p>
          <p><strong>Right to Modify.</strong> THE COMPANY may interpret, revise, suspend, or discontinue any policy, benefit, or practice described in this handbook at any time, with or without notice, except where advance notice is required by law. If there is a conflict between this handbook and an official plan document (for example, insurance plan documents), the official plan document controls.</p>
          <p><strong>No Unauthorized Promises.</strong> Only a written agreement signed by Janelle Teng or Francisco Teng may modify the at-will relationship or these approval requirements.</p>
          <p><strong>Equal Employment & Non-Retaliation.</strong> All decisions regarding hiring, compensation, scheduling, promotion, demotion, and separation are made based on legitimate business reasons and in compliance with federal, state, and local law. THE COMPANY prohibits unlawful discrimination and retaliation. Employees who raise good-faith concerns or participate in investigations are protected from retaliation.</p>
        `
      },
      {
        code: "1.4",
        title: "Approval Authority for Position & Pay Changes",
        html: `
          <p>To ensure consistency, internal controls, and legal compliance:</p>
          <p><strong>Scope — Prior written approval is required for:</strong></p>
          <ul class="list-disc ml-6">
            <li><strong>Pay changes:</strong> Base rate/hourly rate adjustments, salary adjustments, tip-differential changes, bonuses unrelated to formulaic programs, or changes to incentive plans.</li>
            <li><strong>Position changes:</strong> Promotions, demotions, reclassifications (e.g., full-time/part-time status), title changes, and changes in FLSA exemption status.</li>
            <li><strong>Work schedule/pay basis changes</strong> affecting overtime eligibility (e.g., moving from salary to hourly, or vice versa).</li>
          </ul>
          <p><strong>Authorized approvers.</strong> Written approval by either: <em>Janelle Teng (Owner)</em> or <em>Francisco Teng (Owner)</em>. Delegations must be in writing and kept on file.</p>
          <p><strong>Effective dates.</strong> Changes become effective only after written approval and written notice to the employee. Retroactive changes are prohibited unless required to correct an error or ensure legal compliance.</p>
          <p><strong>Invalid changes.</strong> Unapproved promises/changes are void and will be corrected. Employees should report concerns to HR.</p>
        `
      },
      {
        code: "1.5",
        title: "Administration and Changes",
        html: `<p>The Company may modify, rescind, delete, or add policies at any time, in its sole discretion, with or without advance notice, consistent with applicable law. Policy updates may be communicated by revised Handbook pages, written memoranda, email, the HR system, or postings on the employee bulletin board. Unless an effective date is stated, changes are effective upon communication. Employees are responsible for reviewing and complying with updated policies.</p>`
      },
      {
        code: "1.6",
        title: "Interpretation; Deviation; No Past-Practice Rights",
        html: `
          <p>The Company retains discretion to interpret and apply this Handbook and, where appropriate, to deviate from stated procedures based on the facts and business needs of a particular situation, consistent with applicable law. No supervisor’s verbal statement, prior practice, or past decision creates a binding rule, promise of continued employment, or contractual right. Nothing in this Handbook requires the Company to use progressive discipline or follow any specific sequence of corrective steps; the Company may proceed directly to any level of discipline, including termination, where warranted by the circumstances and applicable law.</p>
          <p><strong>Supersession.</strong> This Handbook supersedes and replaces all prior handbooks, policies, and summaries on the same subjects, including the Employee Handbook dated August 2024. To the extent of any conflict between this Handbook and earlier materials, this Handbook controls. (If any policy conflicts with applicable law or an official plan document, the law/plan controls.)</p>
        `
      },
      {
        code: "1.7",
        title: "Conflicts with Law or Other Documents",
        html: `<p>If a policy conflicts with applicable law, the law controls, and the policy will be interpreted or modified to comply. If a conflict exists between this Handbook and an official plan document (for example, a group health plan), the plan document controls. If this Handbook is translated, the English version controls in the event of any inconsistency.</p>`
      }
    ];

    const SECTION_II = [
      { code: "2.1", title: "Employee Classifications", html: `
        <p><strong>Purpose.</strong> To clarify how we categorize jobs for pay, scheduling, and benefits; and to comply with the Fair Labor Standards Act (FLSA) and Texas law.</p>
        <h3 class="text-xl mt-4">Status Types</h3>
        <ul class="list-disc ml-6">
          <li><strong>Exempt (salary, not overtime-eligible):</strong> Roles that meet FLSA duties and salary basis tests (e.g., certain executive, administrative, or professional positions).</li>
          <li><strong>Nonexempt (hourly, overtime-eligible):</strong> Roles that do not meet the FLSA exemption tests. Nonexempt employees must record all hours worked and are paid overtime for hours &gt; 40 in a workweek.</li>
          <li><strong>Full-Time:</strong> Regularly scheduled 30+ hours per week.</li>
          <li><strong>Part-Time:</strong> Regularly scheduled &lt; 30 hours per week.</li>
          <li><strong>Temporary/Seasonal:</strong> Hired for a defined period or project.</li>
        </ul>
        <h3 class="text-xl mt-4">Notes</h3>
        <ul class="list-disc ml-6">
          <li>Classification is determined by the Company and may change with role changes.</li>
          <li>All employment remains at-will regardless of classification.</li>
        </ul>` },
      { code: "2.2", title: "Equal Employment Opportunity (EEO) & Americans with Disabilities Act (ADA)", html: `
        <p><strong>Policy.</strong> We provide equal employment opportunities without regard to protected characteristics (...). Retaliation for raising good-faith concerns is strictly prohibited.</p>
        <h3 class="text-xl mt-4">Reasonable Accommodation</h3>
        <ul class="list-disc ml-6">
          <li><strong>Who may request:</strong> Applicants and employees with disabilities; employees with sincerely held religious beliefs/practices; nursing employees requesting lactation accommodation.</li>
          <li><strong>How to request:</strong> Notify your supervisor or HR/Owner at any time (earlier is better). You may be asked for limited documentation to understand needs.</li>
          <li><strong>Interactive process:</strong> We will review job essential functions, potential accommodations, and undue hardship.</li>
          <li><strong>Decision:</strong> HR/Owner will provide the accommodation granted or explain alternative options/denials in writing.</li>
        </ul>` },
      { code: "2.3", title: "Introductory Period", html: `
        <p>The first 60 days of employment are an introductory period to confirm job fit and performance expectations.</p>
        <ul class="list-disc ml-6">
          <li><strong>During the period:</strong> Training, feedback, and coaching.</li>
          <li><strong>Review:</strong> Around 60 days, supervisor evaluates and communicates next steps.</li>
          <li><strong>At-will:</strong> No guarantee of continued employment.</li>
          <li><strong>Work authorization:</strong> Complete Form I-9 within 3 business days of hire.</li>
        </ul>` },
      { code: "2.4", title: "Reporting Discrimination/Harassment", html: `
        <ul class="list-disc ml-6">
          <li>Report immediately to your supervisor or HR/Owner (or any manager).</li>
          <li>We investigate promptly, keep matters as confidential as practicable, and take corrective action where appropriate.</li>
          <li>No retaliation for good-faith reports or participation.</li>
        </ul>` },
      { code: "2.5", title: "Required Certifications & Paid Training", html: `<p>Overview of required credentials and paid training practices for roles that handle food or serve alcohol.</p>` },
      { code: "2.5.1", title: "Food Safety (Food Handler – TXDSHS)", html: `
        <ul class="list-disc ml-6">
          <li><strong>Who needs it:</strong> Any employee who handles food...</li>
          <li><strong>Deadline:</strong> Complete an approved course within 30 days of hire.</li>
          <li><strong>Company pays the fee:</strong> Company covers the initial course/card.</li>
          <li><strong>Scheduling:</strong> Manager schedules on-site. Do not self-enroll without approval.</li>
          <li><strong>Paid training time:</strong> Compensable at Training Rate.</li>
          <li><strong>Proof & renewals:</strong> Provide proof and notify 30 days before expiration.</li>
        </ul>` },
      { code: "2.5.2", title: "Alcohol Service (TABC Seller-Server)", html: `
        <ul class="list-disc ml-6">
          <li><strong>Who needs it:</strong> Employees who sell/serve alcohol (18+).</li>
          <li><strong>Maintain current:</strong> Certification must be valid before any alcohol shift.</li>
          <li><strong>Company pays:</strong> Company covers initial course/exam fee.</li>
          <li><strong>Scheduling:</strong> Manager schedules on-site.</li>
          <li><strong>Paid training time:</strong> Compensable at Training Rate.</li>
          <li><strong>Proof & renewals:</strong> Provide/notify 30 days before expiration; lapses may remove you from shifts.</li>
        </ul>` },
      { code: "2.6", title: "Paid Training – FLSA/TWC Compliance Rules", html: `
        <p><strong>Training Rate:</strong> Required training time is paid at least minimum wage.</p>
        <p>Tipped roles: paid full minimum (no tip credit) while training.</p>
        <p>Over 40 hours triggers blended-rate overtime per FLSA.</p>` },
      { code: "2.7", title: "Parking", html: `<p>Park along Greenville Avenue or designated employee areas past the third statue. Do not park in front of businesses. Closest guest spots are reserved for guests.</p>` },
      { code: "2.8", title: "Required Notices and Postings", html: `
        <p>We post all required federal and Texas workplace notices.</p>
        <ul class="list-disc ml-6">
          <li>HR/Owner maintains current versions and audits quarterly.</li>
          <li>Managers ensure posters are visible and undamaged.</li>
          <li>Employees should review posted notices and direct questions to management.</li>
        </ul>` }
    ];

    /* ========= POLICY RENDER + SAVE ========= */
    function cardTemplate(item, storePrefix){
      const inputId = `init_${storePrefix}${item.code.replaceAll('.','_')}`;
      const saved = localStorage.getItem(storePrefix + item.code);
      const initialsValue = saved ? JSON.parse(saved)?.initials || '' : '';
      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
                <div class="text-[15px] leading-7 text-slate-700">${item.html}</div>
              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${initialsValue}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" data-store="${storePrefix}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves to your record.</div>
                </div>
              </div>
            </div>
          </div>
        </article>`;
    }

    function renderPolicies(list, targetEl, storePrefix, countEl, totalEl){
      totalEl.textContent = list.length;
      targetEl.innerHTML = list.map(p => cardTemplate(p, storePrefix)).join('');
    }

    // Map of policy codes -> Supabase policy_id
    let POL_META = { S1: {}, S2: {} };

    async function loadPolicyMeta(sectionList, wantedCodes){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending: true });

      const meta = {};
      if(!error){
        (data||[]).forEach(r=>{
          const code = extractCode(r.title);
          if(code && wantedCodes.includes(code)){ meta[code] = { id: r.id, title: r.title }; }
        });
      }
      // ensure keys exist (local-only fallback)
      wantedCodes.forEach(c=>{ if(!meta[c]) meta[c] = { id:null, title:`${c}` }; });
      return meta;
    }

    async function prefillAcks(initials, meta, storePrefix){
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);
      if(error) return;
      const byId = new Map((data||[]).map(r=>[r.policy_id, r]));
      for(const [code, m] of Object.entries(meta)){
        if(!m.id) continue;
        const row = byId.get(m.id);
        if(row && row.agreed){
          localStorage.setItem(storePrefix + code, JSON.stringify({ initials:(row.signed_initials||initials).toUpperCase(), ts: row.created_at }));
        }
      }
    }

    async function saveAckToDB(initials, policyId){
      const session_id = getSessionId();
      const hb = getHbSession();
      const employee_id = hb?.employee_id || null;

      try{
        const { error } = await client.rpc('hb_ack_policy', {
          p_initials: initials,
          p_policy_id: policyId,
          p_signed_initials: initials,
          p_session_id: session_id,
          p_agreed: true
        });
        if(!error) return { ok:true };
      }catch(e){}

      try{
        const payload = { policy_id: policyId, employee_initials: initials, signed_initials: initials, agreed: true, session_id };
        if(employee_id) payload.employee_id = employee_id;
        const { error } = await client.from('hb_acks').insert(payload);
        if(error) return { ok:false, error };
        return { ok:true };
      }catch(e){ return { ok:false, error:e?.message||'Insert failed' }; }
    }

    function updateSectionProgress(list, storePrefix, countEl, barEl){
      let saved = 0;
      list.forEach(i=>{ if(localStorage.getItem(storePrefix + i.code)) saved++; });
      countEl.textContent = saved;
      barEl.style.width = Math.round((saved/list.length)*100) + '%';
      return saved === list.length;
    }

    function refreshGate(){
      const allS1 = updateSectionProgress(SECTION_I, S1_STORE, s1Count, s1Bar);
      // gate Section II button
      btnToS2.disabled = !allS1;
      if(allS1){
        btnToS2.classList.remove('bg-slate-400','cursor-not-allowed','opacity-70');
        btnToS2.classList.add('bg-emerald-600');
      }else{
        btnToS2.classList.add('bg-slate-400','cursor-not-allowed','opacity-70');
        btnToS2.classList.remove('bg-emerald-600');
      }
      // live update S2 bar too
      updateSectionProgress(SECTION_II, S2_STORE, s2Count, s2Bar);
    }

    function wireSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const code = btn.getAttribute('data-code');
          const store = btn.getAttribute('data-store');
          const input = document.getElementById(`init_${store}${code.replaceAll('.','_')}`);
          const msgEl = document.getElementById(`msg_init_${store}${code.replaceAll('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toast(msgEl, 'Enter initials.'); return; }

          // local save
          localStorage.setItem(store + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));

          // DB save (if mapped)
          const meta = store === S1_STORE ? POL_META.S1 : POL_META.S2;
          const policyId = meta?.[code]?.id || null;
          if(policyId){
            const res = await saveAckToDB(typed, policyId);
            toast(msgEl, res.ok ? 'Saved.' : 'Saved locally (DB error).', res.ok);
          }else{
            toast(msgEl, 'Saved (local).', true);
          }
          refreshGate();
        });
      });
    }

    /* ========= TABS / NAV ========= */
    function activateS1(){
      tabS1.classList.add('tab-active'); tabS1.classList.remove('tab-inactive');
      tabS2.classList.add('tab-inactive'); tabS2.classList.remove('tab-active');
      sec1.classList.remove('hidden'); sec2.classList.add('hidden');
    }
    function activateS2(){
      tabS2.classList.add('tab-active'); tabS2.classList.remove('tab-inactive');
      tabS1.classList.add('tab-inactive'); tabS1.classList.remove('tab-active');
      sec2.classList.remove('hidden'); sec1.classList.add('hidden');
    }

    tabS1.addEventListener('click', activateS1);
    tabS2.addEventListener('click', ()=>{ if(!btnToS2.disabled) activateS2(); });
    btnToS2.addEventListener('click', ()=>{ if(!btnToS2.disabled) activateS2(); });
    btnBackS1.addEventListener('click', activateS1);
    btnNextS3.addEventListener('click', ()=> alert('Proceed to Section III.'));

    /* ========= BOOT ========= */
    async function bootApp(){
      await fillEmployeeCard();

      // Render policies
      s1Total.textContent = SECTION_I.length;
      s2Total.textContent = SECTION_II.length;
      renderPolicies(SECTION_I, s1PoliciesEl, S1_STORE, s1Count, s1Total);
      renderPolicies(SECTION_II, s2PoliciesEl, S2_STORE, s2Count, s2Total);

      // Load Supabase ids
      POL_META.S1 = await loadPolicyMeta(SECTION_I, SECTION_I.map(p=>p.code));
      POL_META.S2 = await loadPolicyMeta(SECTION_II, SECTION_II.map(p=>p.code));

      // Prefill from DB for this user
      await prefillAcks(getSessionInitials(), POL_META.S1, S1_STORE);
      await prefillAcks(getSessionInitials(), POL_META.S2, S2_STORE);

      // Wire buttons & compute progress
      wireSaveButtons();
      refreshGate();
      activateS1(); // start on Section I
    }

    /* ========= FIRST LOAD ========= */
    (async function init(){
      const s = getHbSession();
      if (s?.initials) {
        showApp();
        await bootApp();
        return;
      }
      showLogin();
    })();
  </script>
</body>
</html>
