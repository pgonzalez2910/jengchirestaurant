<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], 'sans': ['Inter','system-ui','sans-serif'] },
          colors: { 'jc-primary':'#1F2937','jc-secondary':'#334155','jc-gold':'#C0A06D','jc-border':'#E2E8F0' },
          boxShadow: {
            'soft':'0 18px 80px rgba(0,0,0,.12)',
            'glow':'0 0 0 1px rgba(255,255,255,.3), 0 30px 80px rgba(0,0,0,.22)'
          }
        }
      }
    }
  </script>

  <!-- Supabase v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  
<style>
  .prose-handbook h2,
  .prose-handbook h3 { font-family: 'Playfair Display', serif; }

  /* Force justified copy inside handbook sections */
  .prose-handbook p,
  .prose-handbook ul,
  .prose-handbook li {
    text-align: justify !important;
    text-justify: inter-word;
  }
</style>



</head>

<body class="h-full bg-slate-50 text-slate-800 font-sans">
  <div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
  <div class="fixed inset-0 -z-10 pointer-events-none opacity-30"
       style="background:
        radial-gradient(800px 400px at 50% -50%, rgba(192,160,109,.25), transparent 60%),
        radial-gradient(600px 320px at 120% 20%, rgba(192,160,109,.18), transparent 60%),
        radial-gradient(700px 500px at -20% 60%, rgba(0,0,0,.06), transparent 65%);">
  </div>

  <!-- ===================== LOGIN ===================== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-6">
    <section class="w-full max-w-[560px] rounded-[24px] bg-white/80 backdrop-blur-md shadow-soft border border-jc-border ring-1 ring-white/50">
      <div class="p-8">
        <div class="flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi" class="h-20 w-auto rounded-xl bg-white/70 shadow-glow ring-1 ring-white/50 object-contain"/>
        </div>

        <h1 class="font-serif-head text-3xl text-center mt-6 text-jc-primary">Employee Portal</h1>
        <p class="text-center text-sm text-slate-600 mt-1">Enterprise Sign-In</p>

        <div class="mt-8 space-y-4">
          <div>
            <label class="block text-sm font-medium text-slate-700">Username</label>
            <input id="username" class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="e.g., pg"/>
          </div>
          <div>
            <label class="block text-sm font-medium text-slate-700">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8"
                   class="mt-1 w-full rounded-xl border border-jc-border px-4 py-3 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40" placeholder="••••"/>
          </div>

          <button id="btnLogin" class="w-full mt-2 rounded-xl bg-jc-gold text-white py-3 text-sm font-medium hover:opacity-95">Sign in</button>
          <div id="loginMsg" class="text-sm h-5 mt-2 text-center"></div>
        </div>

        <div class="mt-10 text-center text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>
  </main>

  <!-- ===================== APP ===================== -->
  <div id="appView" class="hidden">
    <!-- top address -->
    <div class="w-full max-w-[1200px] mx-auto px-6 pt-4">
      <div class="flex items-start justify-between">
        <div></div>
        <div class="text-right text-[13px] leading-5 text-slate-600">
          <div>400 North Greenville Avenue Ste 11</div>
          <div>Richardson Texas 75081</div>
          <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </div>

    <!-- logo + signout -->
    <header class="w-full max-w-[1200px] mx-auto px-6 mt-4">
      <div class="w-full flex items-center justify-between gap-3">
        <div class="flex-1"></div>
        <div class="w-full flex justify-center">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
               alt="Jeng Chi logo"
               class="h-20 w-auto rounded-xl bg-white/70 backdrop-blur-sm shadow-glow ring-1 ring-white/50 object-contain" />
        </div>
        <div class="flex-1 flex justify-end">
          <button id="btnSignOut" class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Sign out</button>
        </div>
      </div>
    </header>

    <!-- employee card -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="rounded-2xl bg-white/80 backdrop-blur-sm shadow-soft ring-1 ring-white/40 border border-jc-border">
        <div class="px-6 py-4 border-b border-jc-border">
          <h2 class="font-serif-head text-2xl text-jc-primary">Employee Information</h2>
        </div>
        <div class="p-6">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-x-16 gap-y-4 text-[15px]">
            <div><div class="text-slate-500">Employee</div><div id="fi_name" class="font-medium">—</div></div>
            <div><div class="text-slate-500">User</div><div id="fi_user" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Position</div><div id="fi_position" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Department</div><div id="fi_department" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Reports to</div><div id="fi_reports_to" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Email</div><div id="fi_email" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Phone</div><div id="fi_phone" class="font-medium">—</div></div>
            <div><div class="text-slate-500">Session started</div><div id="fi_session_started" class="font-medium">—</div></div>
          </div>
        </div>
      </div>
    </section>

    <!-- section tabs -->
    <section class="w-full max-w-[1200px] mx-auto px-6 mt-6">
      <div class="flex flex-wrap gap-2">
        <button data-tab="I"   class="tabbtn rounded-xl px-4 py-2 text-sm bg-jc-primary text-white">Section I</button>
        <button data-tab="II"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section II</button>
        <button data-tab="III" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section III</button>
        <button data-tab="IV"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IV</button>
        <button data-tab="V"   class="tabbtn rounded-xl px-4 py-2 text-sm border">Section V</button>
        <button data-tab="VII" class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VII</button>
        <button data-tab="VIII"class="tabbtn rounded-xl px-4 py-2 text-sm border">Section VIII</button>
        <button data-tab="IX"  class="tabbtn rounded-xl px-4 py-2 text-sm border">Section IX</button>
      </div>
    </section>

    <!-- section body -->
    <main class="w-full max-w-[1200px] mx-auto px-6 mt-4 pb-24">
      <div class="rounded-2xl bg-white shadow-soft border border-jc-border ring-1 ring-white/40">
        <div class="px-6 pt-6 pb-4 border-b border-jc-border">
          <h1 id="sectionTitle" class="font-serif-head text-3xl text-jc-primary tracking-tight">Section I — Introduction</h1>
          <p class="text-sm text-slate-600 mt-1">Initial each policy and press <span class="font-medium">Save</span>. “Next Section” unlocks when all are saved.</p>
        </div>

        <div class="px-6 py-4 border-b border-jc-border flex items-center justify-between">
          <div class="text-sm text-slate-600">Progress: <span id="progCount" class="font-semibold">0</span>/<span id="progTotal">0</span> saved</div>
          <div class="w-56 h-2 bg-slate-100 rounded-full overflow-hidden">
            <div id="progBar" class="h-2 bg-jc-gold rounded-full" style="width:0%"></div>
          </div>
        </div>

        <div id="policies" class="p-6 prose-handbook"></div>

        <div class="px-6 pt-2 pb-6 border-t border-jc-border flex items-center justify-between gap-3">
          <button id="btnBack" class="rounded-xl border px-4 py-2 text-sm hover:bg-slate-50">Back</button>
          <button id="btnNext" class="rounded-xl bg-slate-400 text-white px-4 py-2 text-sm cursor-not-allowed opacity-70" disabled>Next Section</button>
        </div>
      </div>
    </main>
  </div>

  <script>
    /* ========= SUPABASE ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= DOM ========= */
    const loginView = document.getElementById('loginView');
    const appView   = document.getElementById('appView');
    const usernameEl = document.getElementById('username');
    const pinEl      = document.getElementById('pin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');

    const sectionTitle = document.getElementById('sectionTitle');
    const policiesEl   = document.getElementById('policies');
    const btnNext      = document.getElementById('btnNext');
    const btnBack      = document.getElementById('btnBack');
    const progCountEl  = document.getElementById('progCount');
    const progTotalEl  = document.getElementById('progTotal');
    const progBar      = document.getElementById('progBar');

    /* ========= UTIL ========= */
    const CODE_RE = /^(\d+\.\d+)/;
    const safe = (v, dash='—') => (v===null || v===undefined || v==='') ? dash : v;
    const toInitials = (u) => (String(u||'').trim().slice(0,2) || '').toUpperCase();
    const toast = (el, msg, ok=false) => { el.textContent = msg; el.className = `text-sm ${ok?'text-emerald-700':'text-red-600'}`; setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 2400); };
    const extractCode = (t='') => { const m=String(t).toUpperCase().match(CODE_RE); return m?m[1]:null; };

    const setSession = (s)=> localStorage.setItem('hb_session', JSON.stringify(s||{}));
    const getSession = ()=> { try { return JSON.parse(localStorage.getItem('hb_session')||'{}'); } catch { return {}; } };
    const getInitials = ()=> {
      const s = getSession();
      if (s?.initials) return String(s.initials).toUpperCase();
      if (s?.username) return toInitials(s.username);
      return '';
    };
    const getSessionId = ()=> { const sid = localStorage.getItem('hb_session_id'); return sid ? Number(sid) : null; };
    const getSessionStartedAt = ()=> localStorage.getItem('hb_session_started_at') || new Date().toISOString();

    // Stable per-user namespace: employee_id -> initials -> username
    function userNamespace() {
      const s = getSession();
      if (s?.employee_id) return `emp_${s.employee_id}`;
      if (getInitials()) return `init_${getInitials()}`;
      if (s?.username) return `user_${String(s.username).toLowerCase()}`;
      return 'anon';
    }
    const nsKey = (base) => `${userNamespace()}__${base}`;

    /* ========= LOGIN ========= */
    function showApp(){ loginView.classList.add('hidden'); appView.classList.remove('hidden'); }
    function showLogin(){ appView.classList.add('hidden'); loginView.classList.remove('hidden'); }

    async function startRemoteSession(initials){
      try{
        const { data, error } = await client.rpc('hb_start_session', { p_initials: initials });
        const sessionId = data || null;
        const startedAt = new Date().toISOString();
        if(sessionId) localStorage.setItem('hb_session_id', String(sessionId));
        localStorage.setItem('hb_session_started_at', startedAt);
      }catch(e){
        localStorage.setItem('hb_session_started_at', new Date().toISOString());
      }
    }

    async function doLogin(){
      const u = (usernameEl.value||'').trim();
      const p = (pinEl.value||'').trim();
      if(!u || !p){ loginMsg.textContent='Enter username and PIN.'; return; }
      loginMsg.textContent='';

      try{
        const { data, error } = await client.rpc('hb_login_v3', { p_username: u, p_pin: p });
        if(error){ loginMsg.textContent = error.message || 'Login failed'; return; }
        const s = {
          username: u,
          initials: (data?.initials || toInitials(u)),
          employee_id: data?.employee_id || null,
          full_name: data?.full_name || null,
          position: data?.position || null,
          department: data?.department || null,
          is_owner: !!data?.is_owner,
          email: data?.email || null,
          phone: data?.phone || null,
          reports_to: data?.reports_to || null
        };
        setSession(s);
        await startRemoteSession(s.initials);
        showApp();
        await bootApp();
      }catch(e){
        console.error(e);
        loginMsg.textContent = 'Login error';
      }
    }
    btnLogin.addEventListener('click', doLogin);
    pinEl?.addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });

    // Sign out: keep local progress so employees don't lose their place
    document.getElementById('btnSignOut')?.addEventListener('click', ()=>{
      localStorage.removeItem('hb_session');
      localStorage.removeItem('hb_session_id');
      localStorage.removeItem('hb_session_started_at');
      showLogin();
    });

    /* ========= EMPLOYEE CARD ========= */
    
async function fillEmployeeCard(){
  const s = getSession();
  const initials = getInitials();
  const started  = getSessionStartedAt();

  // 1) seed from login/session
  let name        = s?.full_name || null;
  let position    = s?.position || null;
  let department  = s?.department || null;
  let reports_to  = s?.reports_to || null;
  let email       = s?.email || null;
  let phone       = s?.phone || null;
  const username  = s?.username || null;

  // show what we have right away
  document.getElementById('fi_user').textContent        = safe(initials || toInitials(username));
  document.getElementById('fi_name').textContent        = safe(name);
  document.getElementById('fi_position').textContent    = safe(position);
  document.getElementById('fi_department').textContent  = safe(department);
  document.getElementById('fi_reports_to').textContent  = safe(reports_to);
  document.getElementById('fi_email').textContent       = safe(email);
  document.getElementById('fi_phone').textContent       = safe(phone);
  document.getElementById('fi_session_started').textContent = new Date(started).toLocaleString();

  // 2) If we still need basics, use hb_handbook_access (by username)
  if ((!name || !position || !department) && username){
    const { data: ha } = await client
      .from('hb_handbook_access')
      .select('employee_name, position, department')
      .eq('user', username)
      .maybeSingle();

    if (ha){
      name       = name       || ha.employee_name || null;
      position   = position   || ha.position || null;
      department = department || ha.department || null;

      document.getElementById('fi_name').textContent        = safe(name);
      document.getElementById('fi_position').textContent    = safe(position);
      document.getElementById('fi_department').textContent  = safe(department);
    }
  }

  // 3) Use the official employees data for contact + manager (by full_name)
  //    This hits the view you created above (v_employee_card).
  if (name){
    const { data: ec } = await client
      .from('v_employee_card')
      .select('email, phone, reports_to, department')
      .ilike('full_name', name);   // case-insensitive match

    if (ec && ec.length){
      // pick the first match or the one whose dept matches
      const row = ec.find(r => r.department && department && r.department.toLowerCase() === department.toLowerCase()) || ec[0];

      email      = email      || row.email || null;
      phone      = phone      || row.phone || null;
      reports_to = reports_to || row.reports_to || null;

      document.getElementById('fi_reports_to').textContent  = safe(reports_to);
      document.getElementById('fi_email').textContent       = safe(email);
      document.getElementById('fi_phone').textContent       = safe(phone);
    }
  }
}


    /* ========= SECTION DATA ========= */
    // Section I
  /* ========= SECTION I CONTENT (JUSTIFIED) ========= */
const SECTION_I = [
  {
    code: "1.1",
    title: "Welcome to Jeng Chi Restaurant",
    html: `
      <p>We are pleased to have you join our team here at Jeng Chi. This restaurant has been operating since 1990 and we would like to recognize our employees as our most valuable resource for our continuous success. Our capability in providing customers with authentic Taiwanese food and an enjoyable customers dining experience depends on having high quality people like yourself and your fellow employees. We want you to enjoy your time with us here and we are committed to helping you succeed in your new job opportunity.</p>
    `
  },
  {
    code: "1.2",
    title: "Employee Handbook — Purpose and Coverage",
    html: `
      <p>This Employee Handbook (“Handbook”) summarizes key personnel policies, benefits, and workplace standards of Jeng Chi Restaurant (the “Company”), 400 N. Greenville Avenue, Suite 11, Richardson, Texas 75081. It applies to all employees and is intended to promote consistent, lawful practices in accordance with guidance from the Texas Workforce Commission (TWC) and applicable federal, state, and local laws. Compliance with this Handbook is a condition of employment.</p>
    `
  },
  {
    code: "1.3",
    title: "Disclaimer, Employment-At-Will & Management Approval Authority",
    html: `
      <p><strong>Purpose.</strong> This section clarifies the nature of employment at Jeng Chi Restaurant (“The Company”), explains how handbook policies may change, and sets the approval standard for any changes to an employee’s position or pay.</p>
      <p><strong>Not a Contract.</strong> This handbook is a general guide to THE COMPANY policies and does not create a contract, guarantee of employment, or promise of specific terms or continued employment. Nothing in this handbook alters the at-will employment relationship, which may be ended by the employee or by THE COMPANY at any time, with or without notice and with or without cause, to the extent permitted by law.</p>
      <p><strong>Right to Modify.</strong> THE COMPANY may interpret, revise, suspend, or discontinue any policy, benefit, or practice described in this handbook at any time, with or without notice, except where advance notice is required by law. If there is a conflict between this handbook and an official plan document (for example, insurance plan documents), the official plan document controls.</p>
      <p><strong>No Unauthorized Promises.</strong> No supervisor, manager, or employee may make any oral or written promise, agreement, or representation contrary to this section. Only a written agreement signed by Janelle Teng or Francisco Teng may modify the at-will relationship or these approval requirements.</p>
      <p><strong>Equal Employment & Non-Retaliation.</strong> All decisions regarding hiring, compensation, scheduling, promotion, demotion, and separation are made based on legitimate business reasons and in compliance with federal, state, and local law. THE COMPANY prohibits unlawful discrimination and retaliation. Employees who raise good-faith concerns or participate in investigations are protected from retaliation.</p>
      <hr class="my-4 border-jc-border">
    `
  },
  {
    code: "1.4",
    title: "Approval Authority for Position & Pay Changes",
    html: `
      <p>To ensure consistency, internal controls, and legal compliance:</p>
      <p><strong>Scope:</strong></p>
      <ul class="list-disc pl-6">
        <li><strong>Pay changes</strong> — Base rate/hourly rate adjustments, salary adjustments, tip-differential changes, bonuses unrelated to formulaic programs, or changes to incentive plans.</li>
        <li><strong>Position changes</strong> — Promotions, demotions, reclassifications (e.g., full-time/part-time status), title changes, and changes in FLSA exemption status.</li>
        <li><strong>Work schedule/pay basis changes</strong> that may affect overtime eligibility (e.g., moving from salary to hourly, or vice versa).</li>
      </ul>
      <p><strong>Authorized Approvers.</strong> Approval must be provided in writing by one of the following: Janelle Teng (Owner) or Francisco Teng (Owner). Either approver may act; delegation to another leader must be in writing and kept on file.</p>
      <p><strong>Effective Dates.</strong> Changes become effective only after written approval and written notice to the employee. Retroactive changes are prohibited unless required to correct an error or ensure legal compliance.</p>
      <p><strong>Invalid Changes.</strong> Any unapproved promise or change is void and will be corrected. Employees should report concerns to HR.</p>
    `
  },
  {
    code: "1.5",
    title: "Administration and Changes",
    html: `
      <p>The Company may modify, rescind, delete, or add policies at any time, in its sole discretion, with or without advance notice, consistent with applicable law. Policy updates may be communicated by revised Handbook pages, written memoranda, email, the HR system, or postings on the employee bulletin board. Unless an effective date is stated, changes are effective upon communication. Employees are responsible for reviewing and complying with updated policies.</p>
    `
  },
  {
    code: "1.6",
    title: "Interpretation; Deviation; No Past-Practice Rights",
    html: `
      <p>The Company retains discretion to interpret and apply this Handbook and, where appropriate, to deviate from stated procedures based on the facts and business needs of a particular situation, consistent with applicable law. No supervisor’s verbal statement, prior practice, or past decision creates a binding rule, promise of continued employment, or contractual right. Nothing in this Handbook requires the Company to use progressive discipline or follow any specific sequence of corrective steps; the Company may proceed directly to any level of discipline, including termination, where warranted by the circumstances and applicable law.</p>
      <p><strong>Supersession.</strong> This Handbook supersedes and replaces all prior handbooks, policies, and summaries on the same subjects, including the Employee Handbook dated August 2024. To the extent of any conflict between this Handbook and earlier materials, this Handbook controls. (If any policy conflicts with applicable law or an official plan document, the law/plan controls.)</p>
    `
  },
  {
    code: "1.7",
    title: "Conflicts with Law or Other Documents",
    html: `
      <p>If a policy conflicts with applicable law, the law controls, and the policy will be interpreted or modified to comply. If a conflict exists between this Handbook and an official plan document (for example, a group health plan), the plan document controls. If this Handbook is translated, the English version controls in the event of any inconsistency.</p>
    `
  }
];
/* ========= SECTION II — Employment Policies ========= */
/* Drop this RIGHT BELOW your SECTION_I definition. Your existing renderer
   (policyCardTemplate/renderPolicies/bindSaveButtons/updateProgress) works
   with this structure as-is. */

const SECTION_II = [
  {
    code: "2.1",
    title: "Employee Classifications",
    html: `
      <p><strong>Purpose.</strong> To clarify how we categorize jobs for pay, scheduling, and benefits; and to comply with the Fair Labor Standards Act (FLSA) and Texas law.</p>
      <p><strong>Status Types.</strong></p>
      <ul class="list-disc pl-6">
        <li><strong>Exempt</strong> (salary, not overtime-eligible): Roles that meet FLSA duties and salary basis tests (e.g., certain executive, administrative, or professional positions).</li>
        <li><strong>Nonexempt</strong> (hourly, overtime-eligible): Roles that do not meet the FLSA exemption tests. Nonexempt employees must record all hours worked and are paid overtime for hours &gt; 40 in a workweek.</li>
        <li><strong>Full-Time</strong>: Regularly scheduled 30+ hours per week.</li>
        <li><strong>Part-Time</strong>: Regularly scheduled &lt; 30 hours per week.</li>
        <li><strong>Temporary/Seasonal</strong>: Hired for a defined period or project.</li>
      </ul>
      <p><strong>Notes.</strong></p>
      <ul class="list-disc pl-6">
        <li>Classification is determined by the Company and may change with role changes.</li>
        <li>All employment remains at-will regardless of classification.</li>
      </ul>
    `
  },
  {
    code: "2.2",
    title: "Equal Employment Opportunity (EEO) & Americans with Disabilities Act (ADA)",
    html: `
      <p><strong>Policy.</strong> We provide equal employment opportunities without regard to protected characteristics (including race, color, religion, sex—including pregnancy—sexual orientation, gender identity, national origin, age, disability, genetic information, marital status, veteran status, or any other status protected by law). This policy applies to all employment actions (recruiting, hiring, scheduling, pay, promotion, training, discipline, and termination). Retaliation for raising good-faith concerns is strictly prohibited.</p>
      <p><strong>Reasonable Accommodation</strong></p>
      <ul class="list-disc pl-6">
        <li><strong>Who may request:</strong> Applicants and employees with disabilities; employees with sincerely held religious beliefs/practices; nursing employees requesting lactation accommodation.</li>
        <li><strong>How to request:</strong> Notify your supervisor or HR/Owner at any time (earlier is better). You may be asked for limited documentation to understand needs.</li>
        <li><strong>Interactive process:</strong> We will review job essential functions, potential accommodations, and undue hardship.</li>
        <li><strong>Decision:</strong> HR/Owner will provide the accommodation granted or explain alternative options/denials in writing.</li>
      </ul>
    `
  },
  {
    code: "2.3",
    title: "Introductory Period",
    html: `
      <p>The first 60 days of employment are an introductory period to confirm job fit and performance expectations.</p>
      <ul class="list-disc pl-6">
        <li><strong>During the period:</strong> You’ll receive training, feedback, and any needed coaching.</li>
        <li><strong>Review:</strong> At ~60 days, your supervisor evaluates performance and communicates next steps.</li>
        <li><strong>At-will:</strong> Completion (or early completion/extension) does not guarantee continued employment or change at-will status.</li>
        <li><strong>Work authorization:</strong> Within three business days of hire, employees must complete Form I-9 and provide acceptable documentation.</li>
      </ul>
    `
  },
  {
    code: "2.4",
    title: "Reporting Discrimination/Harassment",
    html: `
      <ul class="list-disc pl-6">
        <li>Report immediately to your supervisor or HR/Owner (or any manager).</li>
        <li>We will investigate promptly, keep matters as confidential as practicable, and take corrective action where appropriate.</li>
        <li>No one will be retaliated against for good-faith reports or participation in investigations.</li>
      </ul>
    `
  },
  {
    code: "2.5",
    title: "Required Certifications & Paid Training",
    html: `
      <h3 class="text-xl font-semibold mt-2 mb-1">2.5.1 Food Safety (Food Handler – TXDSHS)</h3>
      <ul class="list-disc pl-6">
        <li><strong>Who needs it:</strong> Any employee who handles food, food-contact surfaces, utensils, or works in food-prep/BOH/FOH areas.</li>
        <li><strong>Deadline:</strong> Complete an approved Texas Food Handler course within 30 days of hire.</li>
        <li><strong>Company pays the fee:</strong> The Company pays the course/card cost initial.</li>
        <li><strong>Scheduling:</strong> A manager will schedule your course on-site. Do not self-enroll without approval.</li>
        <li><strong>Paid training time:</strong> Time spent attending required Food Handler training is compensable and paid at the Training Rate (defined below).</li>
        <li><strong>Proof & renewals:</strong> Provide a copy of your valid card to your Supervisor/HR and notify them 30 days before expiration. Missing or expired credentials may result in removal from food-handling duties until renewed and may lead to discipline.</li>
      </ul>

      <h3 class="text-xl font-semibold mt-4 mb-1">2.5.2 Alcohol Service (TABC Seller-Server)</h3>
      <ul class="list-disc pl-6">
        <li><strong>Who needs it:</strong> Employees who sell/serve alcohol (servers, bartenders, some FOH). Must be 18+ to serve alcohol in Texas.</li>
        <li><strong>Before any alcohol shift:</strong> Maintain a current TABC seller-server certification.</li>
        <li><strong>Company pays the fee:</strong> The Company pays the course/exam fee initial.</li>
        <li><strong>Scheduling:</strong> A manager will schedule your course (on-site).</li>
        <li><strong>Paid training time:</strong> Time spent attending required TABC training is compensable and paid at the Training Rate (defined below).</li>
        <li><strong>Proof & renewals:</strong> Provide proof of certification to Supervisor/HR and notify 30 days before expiration. Employees with lapsed certification may be removed from alcohol-service shifts until renewed and may face discipline.</li>
      </ul>
    `
  },
  {
    code: "2.6",
    title: "Paid Training – FLSA/TWC Compliance Rules",
    html: `
      <p><strong>Training Rate (compensable time):</strong> Required, job-related training time is paid time at a Training Rate equal to at least the applicable minimum wage (federal or Texas, whichever is higher).</p>
      <ul class="list-disc pl-6">
        <li>For tipped employees, training hours are paid at full minimum wage (no tip credit) because training time does not produce tips.</li>
        <li>For non-exempt employees with a regular rate above minimum wage, required training hours may be paid at the Training Rate. If the employee’s total hours in the workweek trigger overtime (over 40), overtime is calculated using the weighted-average (blended) regular rate for that week, per FLSA.</li>
      </ul>
    `
  },
  {
    code: "2.7",
    title: "Parking",
    html: `
      <p>Employees must park along Greenville Avenue or in designated employee areas past the third statue. Do not park in front of Jeng Chi or other businesses. Spaces nearest the restaurants are reserved for guests. Violations may result in corrective action.</p>
    `
  },
  {
    code: "2.8",
    title: "Required Notices and Postings",
    html: `
      <p>We post all required federal and Texas workplace notices (e.g., TWC Texas Payday/Unemployment, EEOC “Know Your Rights,” FLSA minimum wage, and Workers’ Compensation status).</p>
      <ul class="list-disc pl-6">
        <li>HR/Owner maintains current versions and audits quarterly.</li>
        <li>Managers ensure posters are visible and undamaged.</li>
        <li>Employees should review posted notices and direct questions to management.</li>
      </ul>
    `
  }
];

/* If you use a code allow-list for Section lookups, be sure these are in it: */
const SECTION_II_CODES = SECTION_II.map(i => i.code);


    // Section III (Hours & Payroll)
   /* ========= SECTION III — Hours of Work & Payroll Practices ========= */
/* Drop this RIGHT BELOW your SECTION_II definition. It works with your
   existing renderer (policyCardTemplate/renderPolicies/etc.). */

const SECTION_III = [
  {
    code: "3.1",
    title: "Pay Periods & Paydays (Texas Payday Law)",
    html: `
      <p><strong>Pay frequency.</strong> The Company pays bi-weekly; payday is every other Friday by direct deposit or check.</p>
      <p><strong>Methods.</strong> Direct deposit is encouraged; paper checks are available when direct deposit is not used.</p>
    `
  },
  {
    code: "3.2",
    title: "Workweek & Hours of Work",
    html: `
      <p><strong>Workweek definition:</strong> The Company’s workweek is Sunday 12:00 a.m. through Saturday 11:59 p.m. This fixed workweek is used to calculate overtime.</p>
      <p><strong>Scheduling:</strong> Managers schedule based on business needs. Employees are expected to be available for assigned shifts and to arrive fit for duty.</p>
      <h3 class="text-lg font-semibold mt-3 mb-1">Scheduling & the Sling App (Employee Setup)</h3>
      <ul class="list-disc pl-6">
        <li><strong>Download the app</strong></li>
        <li>iPhone: Open App Store → search “Sling: Employee Scheduling” → Install.</li>
        <li>Android: Open Google Play → search “Sling: Employee Scheduling” → Install.</li>
        <li class="mt-2 italic">Tip: do not download “Sling TV.” The correct icon says Sling with “Employee Scheduling.”</li>
      </ul>
      <ul class="list-disc pl-6 mt-2">
        <li><strong>Create your account</strong></li>
        <li>Open the app → tap Sign up (or log in if invited previously).</li>
        <li>Use the same email or mobile number you gave Payroll/HR.</li>
        <li>Create a strong password; enable two-factor authentication if prompted.</li>
      </ul>
      <ul class="list-disc pl-6 mt-2">
        <li><strong>Join our workplace</strong></li>
        <li>If you received an invite link by text/email: tap it and follow prompts (you’ll land in Jeng Chi Restaurant automatically).</li>
        <li>If you did not get an invite: open Sling → Join an existing workplace → enter the workplace code provided by your manager/HR or search “Jeng Chi Restaurant (Richardson, TX)” and request access.</li>
      </ul>
      <ul class="list-disc pl-6 mt-2">
        <li><strong>Set your profile & availability</strong></li>
        <li>Tap Profile → add your name and preferred contact.</li>
        <li>Tap Availability to mark regular days/times you can work.</li>
        <li>If needed, submit Time Off requests under Time Off (not guaranteed—subject to business needs).</li>
      </ul>
      <ul class="list-disc pl-6 mt-2">
        <li><strong>Turn on notifications</strong></li>
        <li>In the app: Settings → Notifications → enable Schedule changes, New shifts, Messages, Time off status.</li>
        <li>On your phone: allow Push Notifications for Sling.</li>
      </ul>
      <ul class="list-disc pl-6 mt-2">
        <li><strong>View your schedule</strong></li>
        <li>Tap Schedule → select Week/Month view.</li>
        <li>Accept shifts as required; contact the Manager on Duty in-app if there’s a conflict (do not no-show).</li>
      </ul>
      <p class="mt-2"><strong>Off-the-clock work is not allowed.</strong> Any work performed must be recorded and will be paid.</p>
    `
  },
  {
    code: "3.3",
    title: "Timekeeping (All Employees)",
    html: `
      <p><strong>Record all time worked:</strong> This includes required meetings, mandatory trainings taken during work hours, and any pre-/post-shift duties.</p>
      <p><strong>Missed punch procedure:</strong> If you forget to clock in/out, notify your supervisor the same day.</p>
      <p><strong>Clock window:</strong> Do not clock in earlier than 7 minutes before your shift; more than 7 minutes requires manager approval.</p>
    `
  },
  {
    code: "3.4",
    title: "Timekeeping: Record all training time on your timecard",
    html: `
      <p><strong>When training occurs:</strong> The Company will schedule required training during work hours or at designated times. If you complete required training at a different time without approval, report the time anyway—it will be paid—and we may address the scheduling issue separately through coaching.</p>
      <p><strong>Consequences for non-completion:</strong> Failure to complete required training/renewals on time may result in removal from related duties and/or discipline, up to and including termination, consistent with law and Company policy.</p>
    `
  },
  {
    code: "3.5",
    title: "Timekeeping & Wage Compliance",
    html: `
      <ul class="list-disc pl-6">
        <li>Nonexempt & Exempt employees must accurately record all time spent in required training during work hours.</li>
        <li>Training time cannot be taken simultaneously with other duties.</li>
        <li>Nothing in this policy permits pay to fall below applicable minimum wage or to avoid overtime for compensable training hours in a workweek.</li>
        <li>No off-the-clock work. All work must be recorded. Working without recording time is prohibited. If work occurs, it will be paid; policy violations may lead to discipline.</li>
      </ul>
    `
  },
  {
    code: "3.6",
    title: "Overtime (Nonexempt)",
    html: `
      <p><strong>When owed.</strong> Overtime is paid at 1.5× the regular rate for all hours worked over 40 in a workweek. Only hours actually worked count toward the 40-hour threshold.</p>
      <p><strong>Authorization.</strong> Overtime must be approved in advance by a supervisor. If unapproved overtime occurs, it will be paid and may be addressed through coaching or discipline.</p>
      <p><strong>Multiple rates.</strong> If you work at different rates in the same week, overtime is based on the weighted average regular rate unless a lawful alternative is used.</p>
    `
  },
  {
    code: "3.7",
    title: "Overtime for Tipped Employees (Servers)",
    html: `
      <p>Applies to all Server employees. Overtime is paid at $6.13 per hour for all hours worked over 40 in a single workweek. Overtime must be approved in advance by management unless there’s an emergency.</p>
    `
  },
  {
    code: "3.8",
    title: "Meal & Rest Breaks",
    html: `
      <ul class="list-disc pl-6">
        <li>Texas law does not require meal or rest breaks. When the Company provides a meal period, it is unpaid and you must be fully relieved of duty.</li>
        <li><strong>Clocking:</strong> Non-exempt employees must clock out at the start of an unpaid meal period and clock back in when returning to work. No off-the-clock work.</li>
        <li><strong>Location:</strong> Eat only in designated employee dining areas. Do not eat in food-prep, service pass, cookline, or dish areas. Wash hands before returning to duty.</li>
      </ul>
    `
  },
  {
    code: "3.9",
    title: "Payroll Deductions (Texas Payday Law)",
    html: `
      <p><strong>Required by law:</strong> The Company deducts taxes and other legally required amounts (e.g., child support, tax levies).</p>
      <p><strong>Employee-authorized:</strong> Any other deduction requires a specific, written authorization that states the purpose and exact dollar amount (no blanket/open-ended authorizations).</p>
      <p><strong>Overpayments:</strong> The Company may recover wage overpayments consistent with law; we will notify the employee and may use a reasonable repayment schedule if needed.</p>
    `
  },
  {
    code: "3.10",
    title: "Uniforms & Work Equipment (Deductions)",
    html: `
      <p><strong>Employee-paid uniforms.</strong> Employees are required to obtain and maintain the Company’s designated uniform and appearance standards at their own expense; any payroll deduction must be expressly authorized in writing, state the specific item and exact dollar amount, and comply with the Texas Payday Law. No blanket or open-ended authorizations.</p>
    `
  },
  {
    code: "3.11",
    title: "Wage Garnishments",
    html: `
      <p>Upon receipt of a valid court order or agency notice, the Company will withhold wages as directed until the order is satisfied or we receive a formal release. Employees should provide documentation if they believe an order is satisfied or incorrect.</p>
    `
  },
  {
    code: "3.12",
    title: "Direct Deposit & Lost/Returned Payments",
    html: `
      <p>Direct deposit is encouraged but not required. Employees using direct deposit must keep bank information current. If a direct deposit is returned (closed/incorrect account), the Company will reissue payment on the next regular business day after funds are returned to the Company.</p>
      <p>If a replacement is requested due to reasons not caused by the Company (e.g., employee lost or damaged the check, provided wrong banking information, or failed to update a closed account), the Company may assess a $35 processing fee to cover bank stop-payment/administrative costs.</p>
      <p><strong>Written authorization required (Texas Payday Law):</strong> The fee will only be taken if the employee signs a Payroll Deduction Authorization stating the specific purpose ($35 stop-payment/reissue fee) and exact amount ($35) for that occurrence.</p>
    `
  },
  {
    code: "3.13",
    title: "Pay Statements & Access (MyToast)",
    html: `
      <p><strong>Payroll system of record.</strong> The Company uses Toast Payroll (“Toast”) as the Company’s payroll system of record. All wages are processed in Toast, and the official pay statement (paystub) for each pay period is generated by Toast.</p>
      <h3 class="text-lg font-semibold mt-2 mb-1">How to access your paystub in MyToast (mobile app)</h3>
      <ul class="list-disc pl-6">
        <li><strong>Download the app:</strong> iOS (App Store): search “MyToast”; Android (Google Play): search “MyToast”.</li>
        <li><strong>Create or sign in to your account:</strong> Use the personal email on file with Payroll; set a strong password; enable two-factor authentication (optional).</li>
        <li><strong>Find your pay statements:</strong> Open the app → Pay → select a Pay Date → View/Download. Download/Save a PDF (recommended).</li>
        <li><strong>Paper copy:</strong> Request a printed paystub from HR using the Pay Statement (Paystub) Print Request form. Standard processing time: up to 2 business days.</li>
      </ul>
      <h3 class="text-lg font-semibold mt-2 mb-1">Final Pay (Separations)</h3>
      <ul class="list-disc pl-6">
        <li><strong>Involuntary separation:</strong> Final wages are due within 6 calendar days of discharge.</li>
        <li><strong>Voluntary resignation:</strong> Final wages are due on the next regular payday after the resignation date.</li>
      </ul>
      <p>The Company may not hold a final paycheck past the statutory deadline for reasons like unreturned property; if amounts are owed and allowed, we use lawful deductions with written authorization or other lawful means.</p>
    `
  },
  {
    code: "3.14",
    title: "Payroll Questions & Disputes",
    html: `
      <p><strong>Who to contact.</strong> Report any pay discrepancy to HR/Payroll in writing as soon as you discover it (ideally within 2 business days of payday).</p>
      <p><strong>Investigation & correction.</strong> HR will review time records and pay data and respond within 3 business days; any confirmed underpayment will be corrected on the next regular payroll.</p>
    `
  },
  {
    code: "3.15",
    title: "Tips & Gratuities Policy (Texas) — Pooling, Credit-Card Tips & Processing Fees",
    html: `
      <p><strong>Scope & Purpose.</strong> This policy applies to all tipped and non-tipped employees at Jeng Chi Restaurant (JCR) and governs tips, tip pooling, credit-card tips and associated processing fees, service charges, and required legal notices under federal law (FLSA) and Texas law (Texas Payday Rules).</p>
      <h3 class="text-lg font-semibold mt-2 mb-1">Definitions</h3>
      <ul class="list-disc pl-6">
        <li><strong>Tip:</strong> A voluntary amount a guest leaves for service. Tips are the employee’s property except as set out in a valid tip pool.</li>
        <li><strong>Credit-Card Tip:</strong> A tip left by a guest as part of a payment by credit or debit card.</li>
      </ul>
      <h3 class="text-lg font-semibold mt-2 mb-1">Core Rules (FLSA/Texas Compliance)</h3>
      <ul class="list-disc pl-6">
        <li>JCR does not keep employees’ tips. Managers and Back of the House are prohibited from keeping any portion of employees’ tips or receiving tips from a tip pool.</li>
        <li>Tip pools will be operated only as allowed by law and this policy, with full and prompt distribution on or before the regular payday for the workweek (or as soon as practicable thereafter if necessary for payroll).</li>
      </ul>
      <h3 class="text-lg font-semibold mt-2 mb-1">Credit-Card Processing Fees on Tipped Amounts</h3>
      <p>When a guest leaves a tip on a credit or debit card, JCR may deduct from the employee’s credit/debit card tip an amount equal to the actual percentage processing fee charged by the card processor on that tip amount, not to exceed three percent (3%). If the actual processing percentage is lower than 3%, only the lower actual percentage will be deducted.</p>
      <h3 class="text-lg font-semibold mt-2 mb-1">Tip Pooling / Sharing</h3>
      <p>JCR may require mandatory tip pooling consistent with federal and Texas law. Managers and Back of the House never participate.</p>
      <p><strong>Eligible Roles for Tips:</strong> Servers, Bartenders, Bussers, Hosts, Cashiers, Bartender Jr.</p>
      <p class="mt-2"><strong>Acknowledgment.</strong> Employees must sign the acknowledgments and any applicable authorizations attached to this policy. Refusal to sign required legal notices may affect eligibility for a tip credit or participation in a tip pool.</p>
    `
  }
];

const SECTION_III_CODES = SECTION_III.map(i => i.code);


    // Section IV (Conduct)
    const SECTION_IV = [
      { code:"4.1", title:"Zero-Tolerance Policy", html:`<p>Immediate action for serious safety/integrity issues.</p>` },
      { code:"4.2", title:"Anti-Harassment / Anti-Discrimination", html:`<p>Policy + prompt response.</p>` },
      { code:"4.3", title:"Diversity & Inclusion", html:`<p>Merit-based; accommodations; fair processes.</p>` },
      { code:"4.4", title:"Prohibited Conduct Examples", html:`<p>Verbal/visual; physical; sexual; online; third parties.</p>` },
      { code:"4.5", title:"Speak-Up & Investigation", html:`<p>Report to any manager/HR; confidentiality; no retaliation.</p>` },
      { code:"4.6", title:"Our Investigation", html:`<p>Timeline; reviewer; evidence; actions.</p>` },
      { code:"4.7", title:"Anti-Retaliation", html:`<p>Strictly prohibited.</p>` },
      { code:"4.8", title:"Professional Boundaries & No Horseplay", html:`<p>No horseplay/unnecessary touch; consequences.</p>` },
      { code:"4.9", title:"Searches & Monitoring", html:`<p>Company Property may be inspected; electronic monitoring.</p>` },
      { code:"4.10", title:"Personal Phones & Earbuds", html:`<p>Phones away; earbuds restricted; safety first.</p>` },
      { code:"4.11", title:"No Smoking/Vaping/Gum/Dip", html:`<p>Designated area only; hygiene; discipline.</p>` },
      { code:"4.12", title:"Personal Errands On the Clock", html:`<p>Not permitted; company errands require authorization and on-the-clock.</p>` },
      { code:"4.13", title:"Employee Bar Policy", html:`<p>21+ to consume; off-duty rules; TABC compliance.</p>` },
      { code:"4.14", title:"FOH Order Integrity", html:`<p>Ring-before-serve; packing checks; audits; incidents.</p>` },
      { code:"4.15", title:"Dress Code & Uniforms", html:`<p>BOH/FOH standards; tattoos; enforcement.</p>` }
    ];

    // Section V (Discipline)
    const SECTION_V = [
      { code:"5.1", title:"Progressive Path", html:`<p>Verbal1 → Verbal2 → Written1 → Written2/Final → Termination.</p>` },
      { code:"5.2", title:"Cross-policy progression", html:`<p>Steps accumulate across policies.</p>` },
      { code:"5.3", title:"Documentation & Timelines", html:`<p>Facts, expectations, CAP, window.</p>` },
      { code:"5.4", title:"Immediate-Termination Examples", html:`<p>Violence, theft, serious harassment/safety, illicit drugs at work (as defined) — after investigation.</p>` },
      { code:"5.5", title:"Attendance Ladder", html:`<p>Example ladder; NC/NS may jump steps.</p>` },
      { code:"5.6", title:"Fights & Threats", html:`<p>Rules for mutual fighting/threats.</p>` },
      { code:"5.7", title:"Dishonesty, Theft & Wage Integrity", html:`<p>Theft → termination; timekeeping ladder.</p>` },
      { code:"5.8", title:"Unprofessional Conduct", html:`<p>Verbal→Verbal→Written→Written/Final→Termination (or skip).</p>` },
      { code:"5.9", title:"Social Media", html:`<p>Prohibited vs protected; discipline up to termination.</p>` },
      { code:"5.10", title:"Drugs, Alcohol & Impairment", html:`<p>Remove from duty; discipline depends on severity/recurrence.</p>` },
      { code:"5.11", title:"Harassment/Discrimination/Retaliation", html:`<p>Investigation required; discipline varies.</p>` },
      { code:"5.12", title:"Corrective Action Plans", html:`<p>What a CAP must include.</p>` },
      { code:"5.13", title:"Benefits & PTO at Separation", html:`<p>Per plan/policy.</p>` },
      { code:"5.14", title:"Resignation & Submission", html:`<p>Two-weeks’ process and forms.</p>` },
      { code:"5.15", title:"Scheduling During Notice", html:`<p>May adjust based on business needs.</p>` },
      { code:"5.16", title:"Conduct During Notice", html:`<p>Policies still apply; may end immediately for serious issues.</p>` },
      { code:"5.17", title:"Job Abandonment", html:`<p>Two consecutive no-call/no-shows.</p>` },
      { code:"5.18", title:"FOH Order Integrity – Discipline", html:`<p>Payment verification; audits; CAPs; discipline path.</p>` }
    ];

    // Section VII (FMLA/PWFA/ADA) — uses 6.x codes per your text
    const SECTION_VII = [
      { code:"6.1", title:"Eligibility (FMLA)", html:`<p>12 months; 1,250 hrs; 50+ employees within 75 miles.</p>` },
      { code:"6.2", title:"Qualifying Reasons", html:`<p>Self/family serious health; bonding; military.</p>` },
      { code:"6.3", title:"Pregnancy & Childbirth — FMLA + PWFA/ADA", html:`<p>How they interact; no Texas PDL.</p>` },
      { code:"6.4", title:"Amount & Intermittent", html:`<p>Continuous or intermittent; schedule responsibly.</p>` },
      { code:"6.5", title:"Pay & Benefits During Leave", html:`<p>PTO substitution rules; health coverage; FLSA notes.</p>` },
      { code:"6.6", title:"Employee Notice", html:`<p>30-day notice when foreseeable; follow call-in.</p>` },
      { code:"6.7", title:"Medical Certification & FFD", html:`<p>15-day deadline; fitness-for-duty may be required.</p>` },
      { code:"6.8", title:"Employer Notices", html:`<p>Eligibility & R/R; Designation.</p>` },
      { code:"6.9", title:"Performance & Anti-Retaliation", html:`<p>Standards apply; no interference/retaliation.</p>` },
      { code:"6.10", title:"Fraud/Abuse", html:`<p>Discipline up to termination.</p>` },
      { code:"6.11", title:"Concurrent Leaves", html:`<p>May run with workers' comp, etc.</p>` },
      { code:"6.12", title:"How to Request", html:`<p>Notify; forms; certification; accommodations.</p>` },
      { code:"6.13", title:"Administration & Questions", html:`<p>HR administers.</p>` }
    ];

    // Section VIII (Benefits) — 8.x codes
    const SECTION_VIII = [
      { code:"8.1", title:"Eligibility & Waiting Period", html:`<p>Full-time 30+ hrs; 60-day wait; plan docs control.</p>` },
      { code:"8.2", title:"PTO — Accrual Start", html:`<p>Begins after 60 days; accrual rates & caps per policy.</p>` },
      { code:"8.3", title:"Coordination With Leave & Payroll", html:`<p>Deductions continue; unpaid leave handling.</p>` },
      { code:"8.4", title:"Payroll Advance Policy", html:`<p>Up to 50% of earned hours incl. tips; max 6×/yr; deducted next check.</p>` },
      { code:"8.5", title:"Advance Request Process", html:`<p>Form → review (1 biz day) → decision → full deduct next check.</p>` },
      { code:"8.6", title:"Employee Meal (Unpaid)", html:`<p>2:30–3:30pm; clock out; where/how to eat; beverage pricing.</p>` },
      { code:"8.7", title:"Workers’ Compensation", html:`<p>Subscriber; Society Insurance.</p>` },
      { code:"8.8", title:"Employee Time Off (General)", html:`<p>21-day notice for planned; medical certification where required.</p>` },
      { code:"8.9", title:"PTO Policy — Overview", html:`<p>Upfront; blackout dates; status changes effects.</p>` },
      { code:"8.10", title:"Use & Management of PTO", html:`<p>No rollover; auto year-end payout if active; no payout at termination.</p>` },
      { code:"8.11", title:"Request to Use PTO", html:`<p>21-day notice in Sling + form; manager sign; submit to payroll.</p>` },
      { code:"8.12", title:"PTO — Full-Time Mechanics", html:`<p>0.02 / 0.023 per hour; caps 40/48; guardrails.</p>` },
      { code:"8.13", title:"Scheduling PTO", html:`<p>No negatives; business needs; blackouts; coordination with leave laws.</p>` },
      { code:"8.14", title:"Pay, Year-End & Separation", html:`<p>Base rate; PTO not ‘hours worked’ for OT; year-end payout if active; no payout on termination.</p>` }
    ];

    // Section IX (Doctor’s Notes) — 7.x codes
    const SECTION_IX = [
      { code:"7.1", title:"When a Doctor’s Note Is Required", html:`<p>3+ schedule-day absences; food-safety illnesses; after certain warnings/surgery.</p>` },
      { code:"7.2", title:"How to Submit", html:`<p>Deliver to HR; receipt; confidentiality.</p>` },
      { code:"7.3", title:"FMLA Screening & Paperwork", html:`<p>WH-381/380/382 timelines; provisional handling.</p>` },
      { code:"7.4", title:"Pregnancy/Childbirth (PWFA/ADA)", html:`<p>Reasonable accommodations absent undue hardship.</p>` },
      { code:"7.5", title:"Workers’ Comp Notes", html:`<p>Immediate reporting; modified duty possible.</p>` },
      { code:"7.6", title:"Pay, PTO & Scheduling", html:`<p>Unpaid unless PTO/benefit; OT on hours worked only.</p>` },
      { code:"7.7", title:"If Documentation Not Provided", html:`<p>Deadlines; status; possible separation for inability to return.</p>` },
      { code:"7.8", title:"Fitness-for-Duty to Return", html:`<p>Required in stated cases; ADA/PWFA process for restrictions.</p>` },
      { code:"7.9", title:"No Retaliation / Consistent Application", html:`<p>Strictly prohibited; confidentiality.</p>` }
    ];

    const SECTIONS = {
      I:    { title: "Section I — Introduction",             store: "jc_section_i_",    items: SECTION_I },
      II:   { title: "Section II — Employment Policies",     store: "jc_section_ii_",   items: SECTION_II },
      III:  { title: "Section III — Hours of Work & Payroll",store: "jc_section_iii_",  items: SECTION_III },
      IV:   { title: "Section IV — Standards of Conduct",    store: "jc_section_iv_",   items: SECTION_IV },
      V:    { title: "Section V — Discipline & Corrective",  store: "jc_section_v_",    items: SECTION_V },
      VII:  { title: "Section VII — FMLA / PWFA / ADA",      store: "jc_section_vii_",  items: SECTION_VII },
      VIII: { title: "Section VIII — Benefits & Services",   store: "jc_section_viii_", items: SECTION_VIII },
      IX:   { title: "Section IX — Doctor’s Notes & Medical",store: "jc_section_ix_",   items: SECTION_IX }
    };

    /* ========= RENDERING ========= */
    const tabButtons = document.querySelectorAll('.tabbtn');
    let currentTab = 'I';

    const policyCardTemplate = (def,item)=>{
      const inputId = `init_${item.code.replace('.','_')}`;
      const saved = localStorage.getItem(nsKey(def.store) + item.code);
      const val = saved ? (JSON.parse(saved)?.initials || '') : '';
      return `
        <article class="mb-6 last:mb-0 rounded-2xl border border-jc-border bg-white/80 backdrop-blur-sm shadow-soft">
          <div class="p-6">
            <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
              <div class="md:max-w-[70ch]">
                <h2 class="text-2xl font-serif-head text-jc-primary mb-1">${item.code} ${item.title}</h2>
              <div class="text-[15px] leading-7 text-slate-700 text-justify">${item.html}</div>

              </div>
              <div class="min-w-[260px] md:w-[320px]">
                <div class="rounded-xl border border-jc-border bg-white p-4 shadow-sm">
                  <label class="block text-xs text-slate-500 mb-1">Type your initials to acknowledge</label>
                  <input id="${inputId}" class="w-full rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="Your initials" value="${val}">
                  <div class="mt-3 flex items-center gap-2">
                    <button data-code="${item.code}" class="btnSave rounded-xl bg-jc-gold text-white px-3 py-2 text-sm hover:opacity-90">Save</button>
                    <span id="msg_${inputId}" class="text-sm"></span>
                  </div>
                  <div class="mt-2 text-xs text-slate-500">Saves to your record (DB if available).</div>
                </div>
              </div>
            </div>
          </div>
        </article>`;
    };

    function renderSection(tabKey){
      const def = SECTIONS[tabKey];
      currentTab = tabKey;
      sectionTitle.textContent = def.title;
      progTotalEl.textContent = def.items.length;
      policiesEl.innerHTML = def.items.map(i => policyCardTemplate(def,i)).join('');
      wireSaveButtons();
      updateProgress();
    }

    tabButtons.forEach(b=>{
      b.addEventListener('click', ()=>{
        tabButtons.forEach(x => { x.classList.remove('bg-jc-primary','text-white'); x.classList.add('border'); });
        b.classList.add('bg-jc-primary','text-white'); b.classList.remove('border');
        renderSection(b.getAttribute('data-tab'));
      });
    });

    /* ========= DB POLICY MAP ========= */
    let POLICY_META = {};
    const wantedCodes = ()=> {
      const arr = [];
      Object.values(SECTIONS).forEach(d=> d.items.forEach(i=> arr.push(i.code)));
      return arr;
    };

    async function loadPoliciesMeta(){
      const { data, error } = await client
        .from('hb_policies')
        .select('id, title, is_active, sort_order')
        .eq('is_active', true)
        .order('sort_order', { ascending: true });

      const meta = {};
      (data||[]).forEach(r=>{
        const code = extractCode(r.title);
        if(code) meta[code] = { id:r.id, title:r.title };
      });
      wantedCodes().forEach(c=>{ if(!meta[c]) meta[c] = { id:null, title:c }; });
      POLICY_META = meta;
    }

    /* ========= SAVE / PREFILL ========= */
    async function prefillFromDB(){
      const initials = getInitials();
      if(!initials) return;
      const { data, error } = await client
        .from('hb_acks')
        .select('policy_id, signed_initials, agreed, created_at')
        .eq('employee_initials', initials);

      const byId = new Map((data||[]).map(r=>[r.policy_id, r]));
      Object.values(SECTIONS).forEach(def=>{
        def.items.forEach(item=>{
          const pid = POLICY_META?.[item.code]?.id;
          if(!pid) return;
          const row = byId.get(pid);
          if(row && row.agreed){
            localStorage.setItem(nsKey(def.store)+item.code, JSON.stringify({
              initials: (row.signed_initials || initials).toUpperCase(),
              ts: row.created_at
            }));
          }
        });
      });
    }

    async function saveAckToDB({ initials, policyCode }){
      const policyId = POLICY_META?.[policyCode]?.id || null;
      const session_id = getSessionId();
      const s = getSession();

      if(!policyId) return { ok:false, message:'Policy not registered' };

      // 1) try RPC
      try{
        const { error } = await client.rpc('hb_ack_policy', {
          p_initials: initials,
          p_policy_id: policyId,
          p_signed_initials: initials,
          p_session_id: session_id,
          p_agreed: true,
          p_employee_id: s?.employee_id || null
        });
        if(!error) return { ok:true };
      }catch(e){}

      // 2) fallback insert (requires anon insert policy on hb_acks)
      try{
        const payload = {
          policy_id: policyId,
          employee_initials: initials,
          signed_initials: initials,
          agreed: true,
          session_id: session_id,
          employee_id: s?.employee_id || null
        };
        const { error } = await client.from('hb_acks').insert(payload);
        if(!error) return { ok:true };
      }catch(e){}

      return { ok:false, message:'DB not ready' };
    }

    function updateProgress(){
      const def = SECTIONS[currentTab];
      const total = def.items.length;
      let saved = 0;
      def.items.forEach(i=>{
        if(localStorage.getItem(nsKey(def.store) + i.code)) saved++;
      });
      progCountEl.textContent = saved;
      progBar.style.width = Math.round((saved/total)*100) + '%';

      const allDone = saved === total;
      btnNext.disabled = !allDone;
      if(allDone){
        btnNext.classList.remove('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.add('bg-emerald-600');
      }else{
        btnNext.classList.add('bg-slate-400','cursor-not-allowed','opacity-70');
        btnNext.classList.remove('bg-emerald-600');
      }
    }

    function wireSaveButtons(){
      document.querySelectorAll('.btnSave').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const def = SECTIONS[currentTab];
          const code = btn.getAttribute('data-code');
          const input = document.getElementById(`init_${code.replace('.','_')}`);
          const msgEl = document.getElementById(`msg_init_${code.replace('.','_')}`);
          const typed = (input?.value || '').trim().toUpperCase();
          if(!typed){ toast(msgEl, 'Enter initials.'); return; }

          // save locally (always)
          localStorage.setItem(nsKey(def.store) + code, JSON.stringify({ initials: typed, ts: new Date().toISOString() }));

          // attempt DB
          const res = await saveAckToDB({ initials: typed, policyCode: code });
          toast(msgEl, res.ok ? 'Saved to record.' : 'Saved locally (DB not ready).', res.ok);
          updateProgress();
        });
      });
    }

    /* ========= NAV ========= */
    btnBack.addEventListener('click', ()=> { history.back(); });
    btnNext.addEventListener('click', ()=>{
      if(btnNext.disabled) return;
      const order = ["I","II","III","IV","V","VII","VIII","IX"];
      const idx = order.indexOf(currentTab);
      if(idx >=0 && idx < order.length-1){
        document.querySelector(`.tabbtn[data-tab="${order[idx+1]}"]`).click();
      }else{
        alert('All sections complete.');
      }
    });

    /* ========= BOOT ========= */
    async function bootApp(){
      await fillEmployeeCard();
      renderSection('I');            // draw immediately
      await loadPoliciesMeta();      // map codes -> policy ids
      await prefillFromDB();         // hydrate from DB if available
      renderSection(currentTab);     // redraw with hydrated values
    }

    (async function init(){
      const s = getSession();
      if (s?.username) { showApp(); await bootApp(); }
      else { showLogin(); }
    })();
  </script>
</body>
</html>
