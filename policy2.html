<!DOCTYPE html>
<html lang="en" class="h-full bg-white">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Handbook & Policy Acknowledgment</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root { --hdr: 72px; }
    body { color:#0f172a; }
    .card { background:#fff; border:1px solid #E5E7EB; border-radius:16px; box-shadow:0 10px 30px rgba(0,0,0,.06); }

    /* Sticky handbook viewer at the top */
    .sticky-top { position: sticky; top: var(--hdr); z-index: 30; }
    .pdf-toolbar { border-bottom:1px solid #E5E7EB; }

    /* PDF page wrapper + canvas */
    .pdf-page-wrapper {
      width:100%;
      margin:0 auto 0.75rem;
      border-radius:12px;
      overflow:hidden;
      position:relative;
      min-height:80px;
    }
    .pdf-page { width:100%; display:block; background:#fff; border:1px solid #E5E7EB; border-radius:12px; }

    /* Fixed-height viewer; internal scroll shows more pages */
    .pdf-scroller {
      height: min(60vh, 640px);
      overflow-y: auto;
      overflow-x: hidden;
      background:#fff;
      border-radius: 0 0 16px 16px;
    }
    @media (max-width: 1023px) { .pdf-scroller { height: min(55vh, 520px); } }

    .policies-col { padding-top: 1rem; }
  </style>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily:{ 'serif-head':['Playfair Display','serif'], 'sans':['Inter','system-ui','sans-serif'] }
        }
      }
    }
  </script>
</head>
<body class="font-sans h-full">

<!-- ===== HEADER (sticky) ===== -->
<header class="border-b border-gray-200 bg-white/90 backdrop-blur sticky top-0 z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 py-3 flex items-center justify-between gap-4">
    <div class="flex items-center gap-3">
      <img class="h-12 w-auto rounded bg-white" alt="Jeng Chi"
           src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg">
      <div class="min-w-0">
        <h1 class="text-2xl font-serif-head truncate">Employee Handbook & Acknowledgment</h1>
        <div id="who" class="text-xs text-slate-600"></div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <!-- Admin-only: Download Employees CSV (optional; leave hidden if you don't need it) -->
      <button id="btnEmployeesCsv"
              class="hidden text-xs px-3 py-2 border border-gray-200 rounded hover:bg-slate-50">
        Download Employees (CSV)
      </button>
      <button id="logoutBtn"
              class="hidden text-xs px-3 py-2 border border-gray-200 rounded hover:bg-slate-50">
        Sign out
      </button>
    </div>
  </div>
</header>

<main class="max-w-7xl mx-auto px-4 sm:px-6 py-4">

  <!-- ===== LOGIN (large inputs, no placeholders/hints) ===== -->
  <aside id="loginPanel" class="z-40 w-[min(92vw,540px)] mx-auto">
    <div class="bg-white border border-gray-200 rounded-2xl p-6 sm:p-8 shadow">
      <h2 class="font-serif-head text-2xl sm:text-3xl text-slate-900 mb-6">Sign In</h2>
      <div class="space-y-6">
        <div>
          <label class="block text-lg font-semibold mb-2">Initials</label>
          <input id="loginInitials"
                 class="w-full rounded-xl border border-gray-300 px-4 py-4 text-2xl tracking-wide focus:outline-none focus:ring-2 focus:ring-sky-400">
        </div>
        <div>
          <label class="block text-lg font-semibold mb-2">PIN</label>
          <input id="loginPin" type="password" inputmode="numeric" maxlength="8"
                 class="w-full rounded-xl border border-gray-300 px-4 py-4 text-2xl tracking-widest focus:outline-none focus:ring-2 focus:ring-sky-400">
        </div>
        <div class="flex items-center gap-4">
          <button id="loginBtn"
                  class="rounded-xl bg-slate-900 text-white px-6 py-4 text-xl font-semibold hover:opacity-95">
            Enter
          </button>
          <div id="loginMsg" class="text-lg text-rose-600"></div>
        </div>
      </div>
    </div>
  </aside>

  <!-- ===== APP (shown after login) ===== -->
  <section id="appWrap" class="hidden">

    <!-- 1) HANDBOOK (sticky top, internal scroll; starts at HB page 6) -->
    <div class="sticky-top">
      <div class="card overflow-hidden">
        <div class="pdf-toolbar px-4 py-3 flex items-center justify-between">
          <div class="text-sm">
            Handbook — <span id="pageLabelHeader">PDF — · HB —</span>
          </div>
          <div class="flex items-center gap-2">
            <button id="prevPage" class="text-sm px-3 py-1 border border-gray-200 rounded hover:bg-slate-50">◀</button>
            <button id="zoomOut" class="text-sm px-3 py-1 border border-gray-200 rounded hover:bg-slate-50">–</button>
            <span id="zoomPct" class="text-sm w-12 text-center">100%</span>
            <button id="zoomIn" class="text-sm px-3 py-1 border border-gray-200 rounded hover:bg-slate-50">+</button>
            <button id="nextPage" class="text-sm px-3 py-1 border border-gray-200 rounded hover:bg-slate-50">▶</button>
          </div>
        </div>
        <div id="pdfContainer" class="pdf-scroller px-3">
          <!-- canvases injected here -->
        </div>
      </div>
    </div>

    <!-- 2) POLICIES (below handbook; auto-filters to current HB page) -->
    <div class="policies-col">
      <div class="card">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
          <div class="font-medium">
            Policies attached to handbook page <span id="pageLabelPolicy">—</span>
          </div>
          <div class="flex items-center gap-3">
            <label class="text-xs text-slate-600 flex items-center gap-2 select-none">
              <input id="filterCurrent" type="checkbox" class="accent-sky-600" checked>
              Show only current page
            </label>
            <button id="finalizeBtn" class="text-xs px-3 py-1 border border-gray-200 rounded hover:bg-slate-50">Finalize</button>
          </div>
        </div>
        <div id="policies" class="p-3 space-y-3"></div>
      </div>

      <!-- Employee info card (auto-loads all fields) -->
      <div class="card mt-4">
        <div class="px-4 py-3 border-b border-gray-200 flex items-center justify-between">
          <div class="font-medium">Employee Information</div>
        </div>
        <div id="empErr" class="hidden px-4 pt-3 pb-0 text-sm text-rose-600"></div>
        <div class="px-4 py-4 text-sm">
          <div class="grid sm:grid-cols-2 gap-x-6 gap-y-2">
            <div><div class="text-slate-500">Employee</div><div id="empName">—</div></div>
            <div><div class="text-slate-500">User</div><div id="empUser">—</div></div>
            <div><div class="text-slate-500">Position</div><div id="empPos">—</div></div>
            <div><div class="text-slate-500">Department</div><div id="empDept">—</div></div>
            <div><div class="text-slate-500">Reports to</div><div id="empReports">—</div></div>
            <div><div class="text-slate-500">Email</div><div id="empEmail">—</div></div>
            <div><div class="text-slate-500">Phone</div><div id="empPhone">—</div></div>
            <div><div class="text-slate-500">Hire date</div><div id="empHire">—</div></div>
            <div class="sm:col-span-2"><div class="text-slate-500">Session started</div><div id="sessionTime">—</div></div>
          </div>
        </div>
      </div>

      <div id="toastOK"  class="hidden bg-emerald-50 text-emerald-700 border border-emerald-200 rounded px-3 py-2 text-sm mt-3">Saved.</div>
      <div id="toastErr" class="hidden bg-rose-50 text-rose-700 border border-rose-200 rounded px-3 py-2 text-sm mt-3">Error.</div>
    </div>
  </section>
</main>

<script type="module">
/* ===== CONFIG ===== */
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* Use your working Edge Functions */
const API_BASE = "https://kpldzwlftkvjjntgsqxx.functions.supabase.co/handbook";
const HANDBOOK_PDF = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";

/* Helper that includes anon key + token for Edge calls */
async function api(path, {method='GET', body=null} = {}) {
  const headers = {'Content-Type':'application/json','Authorization':`Bearer ${SUPABASE_ANON_KEY}`};
  if (state.token) headers['x-hb-token'] = state.token;
  const r = await fetch(`${API_BASE}${path}`, {method, headers, body: body?JSON.stringify(body):null});
  const t = await r.text(); let data; try{ data=JSON.parse(t);}catch{ data={raw:t}; }
  if(!r.ok) throw new Error(data?.message || `${r.status} ${r.statusText}`);
  return data;
}

/* ===== STATE ===== */
const $ = (id)=>document.getElementById(id);
const state = {
  session:null, initials:null, isOwner:false, token:null,
  pdfDoc:null, currentPDF:1, scale:1.0,
  pageOffset:0,          // If your PDF has front-matter, set this; HB = PDF - offset
  START_HB_PAGE: 6,      // Start at handbook page 6
  policies:[], acks:{}
};
let renderTaskMap = new Map();

const clamp = (n, lo, hi) => Math.max(lo, Math.min(hi, n));
const hbFromPDF = (pdfPage)=> pdfPage - state.pageOffset;
const pdfFromHB = (hbPage)=> hbPage + state.pageOffset;

/* ===== TOASTS ===== */
function show(el, yes=true){ el.classList.toggle('hidden', !yes); }
function toastOK(msg='Saved.'){$('toastErr').classList.add('hidden'); $('toastOK').textContent=msg; show($('toastOK'), true); setTimeout(()=>show($('toastOK'),false),1400); }
function toastErr(msg='Something went wrong.'){$('toastOK').classList.add('hidden'); $('toastErr').textContent=msg; show($('toastErr'), true); setTimeout(()=>show($('toastErr'),false),2200); }

/* ===== LOGIN ===== */
async function doLogin(){
  const initials = ($('loginInitials').value||'').trim().toUpperCase();
  const pin = ($('loginPin').value||'').trim();
  if(!initials || !pin){ $('loginMsg').textContent='Enter initials & PIN.'; return; }

  try{
    // (1) Validate via RPC
    const { data: rows, error } = await client.rpc('hb_login', { p_initials: initials, p_pin: pin });
    if(error || !rows || rows.length===0){ $('loginMsg').textContent='Invalid credentials.'; return; }

    // (2) Get Edge token for /handbook/header
    const { token } = await api('/login', { method:'POST', body:{ username: initials, pin } });

    state.session = { initials, is_owner: !!rows[0]?.is_owner || initials==='PG' || initials==='JT', token };
    state.initials = initials; state.isOwner = state.session.is_owner; state.token = token;

    localStorage.setItem('hb_session', JSON.stringify(state.session));
    $('who').textContent = `Logged in: ${initials}`;
    show($('logoutBtn'), true);
    if(state.isOwner) show($('btnEmployeesCsv'), true);

    await Promise.all([loadEmployeeHeader(), loadPolicies(), loadAcks()]);
    await loadPdf();

    show($('loginPanel'), false);
    show($('appWrap'), true);
  }catch(e){
    console.warn(e);
    $('loginMsg').textContent='Login error.';
  }
}
$('loginBtn').addEventListener('click', doLogin);
$('loginPin').addEventListener('keydown', e=>{ if(e.key==='Enter') doLogin(); });
$('logoutBtn').addEventListener('click', ()=>{ localStorage.removeItem('hb_session'); location.reload(); });

/* ===== EMPLOYEE CARD (Edge Function with token; table fallback) ===== */
async function loadEmployeeHeader(){
  const empErr = $('empErr');
  const set = (id,val)=> ( $(id).textContent = (val ?? '—') );

  try{
    // Preferred: Edge Function (bypasses RLS)
    const header = await api('/header');
    set('empName',   header?.full_name);
    set('empUser',   header?.username || state.initials);
    set('empPos',    header?.position);
    set('empDept',   header?.department);
    set('empReports',header?.reports_to_name);
    set('empEmail',  header?.email);
    set('empPhone',  header?.phone);
    set('empHire',   header?.hire_date);
    set('sessionTime', new Date().toLocaleString());
    empErr.classList.add('hidden');
    return;
  }catch(err){
    empErr.textContent = 'Employee header unavailable: ' + (err?.message || 'unknown error');
    empErr.classList.remove('hidden');
    console.warn('Header fetch failed, falling back to table:', err);
  }

  // Fallback (works only if RLS allows anon read)
  try{
    const { data: e, error } = await client.from('hb_employees').select('*').eq('initials', state.initials).single();
    if(error) throw error;
    set('empName',   e?.full_name);
    set('empUser',   e?.username || state.initials);
    set('empPos',    e?.position);
    set('empDept',   e?.department);
    set('empReports',e?.reports_to_name);
    set('empEmail',  e?.email);
    set('empPhone',  e?.phone);
    set('empHire',   e?.hire_date);
    set('sessionTime', new Date().toLocaleString());
    empErr.classList.add('hidden');
  }catch(e){
    empErr.textContent = 'Employee table is blocked by RLS.';
    empErr.classList.remove('hidden');
  }
}

/* ===== POLICIES & ACKS ===== */
function policyRange(p){
  const start = Number(p.page_start ?? p.start_page ?? p.page ?? p.page_label ?? 0) || 0;
  const end   = Number(p.page_end   ?? p.end_page   ?? p.page ?? p.page_label ?? start) || start;
  return [start, end];
}
async function loadPolicies(){
  const { data, error } = await client
    .from('hb_policies')
    .select('id,title,page_start,page_end,required,sort_order,is_active')
    .eq('is_active', true)
    .order('sort_order', { ascending:true });
  state.policies = (!error && data) ? data : [];
}
async function loadAcks(){
  try{
    const { data } = await client
      .from('hb_acks')
      .select('policy_id, saved_at, initials, agreed')
      .eq('employee_initials', state.initials);
    state.acks = {};
    (data||[]).forEach(r=> state.acks[r.policy_id] = r);
  }catch{}
}

$('filterCurrent').addEventListener('change', renderPolicies);

function visiblePolicies(){
  const hb = hbFromPDF(state.currentPDF);
  if (!$('filterCurrent').checked) return state.policies;
  return state.policies.filter(p => {
    const [s,e] = policyRange(p);
    return hb >= s && hb <= e;
  });
}

function renderPolicies(){
  const hb = hbFromPDF(state.currentPDF);
  $('pageLabelPolicy').textContent = hb > 0 ? hb : '—';
  const list = $('policies'); list.innerHTML='';

  const items = visiblePolicies();
  if (!items.length){
    const d=document.createElement('div');
    d.className='text-sm text-slate-500';
    d.textContent = $('filterCurrent').checked ? `No policies found for HB page ${hb}.` : 'No policies available.';
    list.appendChild(d);
    return;
  }

  for (const p of items){
    const [s,e] = policyRange(p);
    const ack = state.acks[p.id];

    const card = document.createElement('div');
    card.className='border border-gray-200 rounded-lg p-3';
    card.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <div class="font-medium">${p.title}</div>
          <div class="text-xs text-slate-500 mt-0.5">HB page ${s}${e!==s?`–${e}`:''} ${p.required ? '• Required':''}</div>
        </div>
        <div class="text-xs ${ack?'text-emerald-600':'text-slate-500'}">
          ${ack?`✓ ${ack.initials || state.initials} · ${new Date(ack.saved_at).toLocaleString()}`:'pending'}
        </div>
      </div>
      <div class="mt-2 flex flex-wrap gap-2">
        <label class="text-xs text-slate-600 self-center">Initials</label>
        <input type="text" class="flex-1 min-w-[140px] bg-white border border-gray-200 rounded px-2 py-1 text-sm" data-initials>
        <button class="shrink-0 text-sm px-3 py-1 border border-gray-200 rounded hover:bg-slate-50" data-save>Save</button>
        <button class="shrink-0 text-xs px-2 py-1 border border-gray-200 rounded hover:bg-slate-50" data-open>Open</button>
      </div>`;
    const input = card.querySelector('[data-initials]');
    const btnSave = card.querySelector('[data-save]');
    const btnOpen = card.querySelector('[data-open]');

    btnSave.addEventListener('click', async ()=>{
      const initials = (input.value||'').trim() || state.initials;
      if(!initials){ toastErr('Enter initials.'); return; }
      try{
        await client.rpc('hb_ack_policy', {
          p_initials: state.initials,
          p_policy_id: p.id,
          p_signed_initials: initials,
          p_session_id: null,
          p_agreed: true
        });
        state.acks[p.id] = { initials, saved_at: new Date().toISOString(), agreed:true };
        toastOK('Saved.');
        renderPolicies();
      }catch(e){ toastErr('Save failed.'); }
    });

    btnOpen.addEventListener('click', ()=>{
      changeActivePage(clamp(pdfFromHB(s), 1, state.pdfDoc?.numPages || 999));
      $('appWrap').scrollIntoView({behavior:'smooth', block:'start'});
    });

    list.appendChild(card);
  }
}

$('finalizeBtn').addEventListener('click', async ()=>{
  try{
    await client.from('hb_ack_forms').insert({
      initials: state.initials,
      session_id: null,
      pdf_url: null
    });
    toastOK('Finalized.');
  }catch(e){ toastErr('Finalize failed.'); }
});

/* ===== PDF.JS LOADER ===== */
const PDF_JS_CANDIDATES = [
  { lib:'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/pdfjs/pdf.min.mjs',
    worker:'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/pdfjs/pdf.worker.min.mjs' },
  { lib:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.min.mjs',
    worker:'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/5.4.149/pdf.worker.min.mjs' }
];

async function loadPdfJsLib() {
  for (const opt of PDF_JS_CANDIDATES) {
    try {
      const pdfjs = await import(opt.lib);
      pdfjs.GlobalWorkerOptions.workerSrc = opt.worker;
      window.pdfjsLib = pdfjs;
      return pdfjs;
    } catch {}
  }
  // Fallback to UMD
  await new Promise((resolve, reject) => {
    const s = document.createElement('script');
    s.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.min.js';
    s.onload = () => {
      if (!window.pdfjsLib) return reject(new Error('pdfjsLib missing'));
      window.pdfjsLib.GlobalWorkerOptions.workerSrc =
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.8.69/build/pdf.worker.min.js';
      resolve();
    };
    s.onerror = reject;
    document.head.appendChild(s);
  });
  return window.pdfjsLib;
}

async function loadPdf(){
  const pdfjs = await (window.pdfjsLib || loadPdfJsLib());
  const pdf = await pdfjs.getDocument(HANDBOOK_PDF).promise;
  state.pdfDoc = pdf;

  const container = $('pdfContainer'); container.innerHTML='';

  // Build page wrappers
  for (let i=1;i<=pdf.numPages;i++){
    const wrap=document.createElement('div');
    wrap.className='pdf-page-wrapper';
    wrap.dataset.pageNo=String(i); wrap.dataset.rendered='';
    const cv=document.createElement('canvas');
    cv.className='pdf-page'; cv.height=80;
    wrap.appendChild(cv);
    container.appendChild(wrap);
  }

  // Start at HB page 6  → PDF page = HB + offset
  const initialPDF = clamp(pdfFromHB(state.START_HB_PAGE), 1, pdf.numPages);
  state.currentPDF = initialPDF;
  changeActivePage(initialPDF);

  // Listeners
  container.addEventListener('scroll', handlePageScroll);
  $('prevPage').addEventListener('click', ()=> navigatePage(-1));
  $('nextPage').addEventListener('click', ()=> navigatePage(1));
  $('zoomIn').addEventListener('click', ()=>{ state.scale = Math.min(2.0, state.scale+0.1); $('zoomPct').textContent=`${Math.round(state.scale*100)}%`; rerenderVisible(); });
  $('zoomOut').addEventListener('click', ()=>{ state.scale = Math.max(0.5, state.scale-0.1); $('zoomPct').textContent=`${Math.round(state.scale*100)}%`; rerenderVisible(); });

  window.addEventListener('resize', ()=>{ clearTimeout(window._rt); window._rt = setTimeout(rerenderVisible, 120); });
}

let isNavigating=false, scrollTimer=null;

function handlePageScroll(){
  if (isNavigating || !state.pdfDoc) return;
  if (scrollTimer) clearTimeout(scrollTimer);
  scrollTimer = setTimeout(() => {
    const container = $('pdfContainer');
    const scrollBottom = container.scrollTop + container.clientHeight;
    const wrappers = container.querySelectorAll('.pdf-page-wrapper');
    let newActive = state.currentPDF;
    for (const wrap of wrappers) {
      const pageNo = Number(wrap.dataset.pageNo);
      const wrapTop = wrap.offsetTop;
      if (wrapTop >= container.scrollTop && wrapTop < scrollBottom) { newActive = pageNo; break; }
    }
    if (newActive !== state.currentPDF) changeActivePage(newActive);
  }, 100);
}

function navigatePage(delta){
  const np = state.currentPDF + delta;
  if (state.pdfDoc && np>=1 && np<=state.pdfDoc.numPages) changeActivePage(np);
}

function updatePageHeaderLabel(){
  const pdf = state.currentPDF;
  const hb  = hbFromPDF(pdf);
  $('pageLabelHeader').textContent = `PDF ${pdf} · HB ${hb>0?hb:'—'}`;
  $('pageLabelPolicy').textContent = hb>0?hb:'—';
}

function changeActivePage(pageNo){
  if (isNavigating || pageNo === state.currentPDF) return;
  isNavigating = true;
  state.currentPDF = pageNo;
  renderSinglePage(pageNo);
  renderPolicies();
  const container = $('pdfContainer');
  const targetWrap = container.querySelector(`[data-page-no="${pageNo}"]`);
  if (targetWrap) {
    container.scrollTo({ top: targetWrap.offsetTop, behavior: 'smooth' });
    setTimeout(()=>{ isNavigating=false; }, 350);
  } else { isNavigating=false; }
}

async function renderSinglePage(pageNo){
  const wrappers = $('pdfContainer').querySelectorAll('.pdf-page-wrapper');
  const pagesToRender = new Set([pageNo, pageNo-1, pageNo+1].filter(n=> n>=1 && n<=state.pdfDoc.numPages));
  wrappers.forEach(wrap=>{
    const n = Number(wrap.dataset.pageNo);
    if (pagesToRender.has(n) && !wrap.dataset.rendered) {
      renderPageToCanvas(n, wrap.querySelector('canvas'), wrap);
    }
  });
  updatePageHeaderLabel();
}

async function renderPageToCanvas(pageNo, canvas, wrapEl){
  const prev=renderTaskMap.get(pageNo);
  if(prev){ try{ prev.cancel(); }catch{} renderTaskMap.delete(pageNo); }

  const page = await state.pdfDoc.getPage(pageNo);
  const wrapWidth = Math.max(320, (wrapEl?.clientWidth || $('pdfContainer').clientWidth || 600));
  const baseViewport = page.getViewport({ scale: 1.0 });
  const fitScale = wrapWidth / baseViewport.width;
  const finalScale = fitScale * (state.scale || 1.0) * (window.innerWidth<=1023 ? 1.1 : 1.0);
  const viewport = page.getViewport({ scale: finalScale });

  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const cssW = Math.floor(viewport.width), cssH = Math.floor(viewport.height);
  canvas.style.width  = cssW + 'px'; canvas.style.height = cssH + 'px';
  canvas.width  = Math.floor(cssW * dpr); canvas.height = Math.floor(cssH * dpr);

  const ctx = canvas.getContext('2d', { alpha:false });
  const task = page.render({ canvasContext: ctx, viewport, transform:[dpr,0,0,dpr,0,0] });
  renderTaskMap.set(pageNo, task);

  try{
    await task.promise;
    if (wrapEl) wrapEl.dataset.rendered='1';
    canvas.style.marginLeft='auto'; canvas.style.marginRight='auto';
  }catch(e){
    if (e.name !== 'RenderingCancelledException') console.warn(e);
  }finally{
    if (renderTaskMap.get(pageNo) === task) renderTaskMap.delete(pageNo);
  }
}

function rerenderVisible(){
  for (const n of [state.currentPDF, state.currentPDF-1, state.currentPDF+1]){
    if (!n || !state.pdfDoc || n<1 || n>state.pdfDoc.numPages) continue;
    const wrap = $('pdfContainer').querySelector(`[data-page-no="${n}"]`);
    if (wrap){ wrap.dataset.rendered=''; renderPageToCanvas(n, wrap.querySelector('canvas'), wrap); }
  }
  updatePageHeaderLabel();
}

/* ===== ADMIN CSV (optional) ===== */
$('btnEmployeesCsv').addEventListener('click', async ()=>{
  try{
    const { data, error } = await client
      .from('hb_employees')
      .select('full_name,username,initials,position,department,email,phone,hire_date,reports_to_name')
      .order('full_name', { ascending:true });
    if (error) throw error;
    const rows = data || [];
    const header = ['full_name','username','initials','position','department','email','phone','hire_date','reports_to_name'];
    const csv = [header.join(',')]
      .concat(rows.map(r=> header.map(k => `"${String(r[k]??'').replace(/"/g,'""')}"`).join(',')))
      .join('\n');

    const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `employees_${new Date().toISOString().slice(0,10)}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }catch(e){ toastErr('CSV download failed.'); }
});

/* ===== RESTORE SESSION ===== */
(function init(){
  // Adjust sticky offset to header height
  const hdr = document.querySelector('header'); 
  document.documentElement.style.setProperty('--hdr', `${(hdr?.offsetHeight || 72)}px`);

  const raw = localStorage.getItem('hb_session');
  if (raw){
    try{
      const s = JSON.parse(raw);
      state.session = s; state.initials = s.initials; state.isOwner = !!s.is_owner; state.token = s.token;
      $('who').textContent = `Logged in: ${s.initials}`;
      show($('logoutBtn'), true);
      if(state.isOwner) show($('btnEmployeesCsv'), true);

      (async ()=>{
        await Promise.all([loadEmployeeHeader(), loadPolicies(), loadAcks()]);
        await loadPdf();
        show($('loginPanel'), false);
        show($('appWrap'), true);
      })();
    }catch{ localStorage.removeItem('hb_session'); }
  }
})();

/* ===== SAFETY ===== */
window.addEventListener('unhandledrejection', (e)=>{ console.warn('[UNHANDLED]', e.reason); });
</script>
</body>
</html>
