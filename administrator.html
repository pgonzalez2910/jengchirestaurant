<!DOCTYPE html>
<html lang="en" class="h-full bg-[#F7F5F1]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeng Chi — Executive Administrator Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A','jc-muted':'#6B7280','jc-gold':'#B9965A','jc-border':'#E5E4E2','jc-bg':'#F7F5F1',
            'jc-danger':'#B91C1C','jc-success':'#166534','jc-warn':'#92400E'
          },
          boxShadow: { 'soft':'0 14px 30px -14px rgba(15,23,42,0.15)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .label{ font-weight:700; color:#0B0F1A; letter-spacing:.01em; position:relative; }
    .label::before{ content:""; position:absolute; left:0; right:0; top:-0.4rem; height:.4rem;
      background:linear-gradient(180deg,rgba(255,255,255,.45),rgba(255,255,255,0)); pointer-events:none; }
    .input{ @apply w-full rounded-xl border border-jc-border bg-white px-3 py-2 text-jc-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/35; }
    .btn{ @apply inline-flex items-center justify-center rounded-xl px-3.5 py-2 font-medium shadow-sm transition; }
    .btn-gold{ @apply bg-jc-gold text-white hover:brightness-95; }
    .btn-ghost{ @apply bg-white border border-jc-border text-jc-ink hover:bg-jc-bg; }
    .btn-danger{ @apply bg-red-600 text-white hover:bg-red-700; }
    .tag{ @apply inline-flex items-center rounded-full border border-jc-border bg-white px-2.5 py-1 text-xs font-medium text-jc-muted; }
    .tab{ @apply px-4 py-2 rounded-xl text-sm font-medium cursor-pointer border border-transparent hover:bg-white/60; }
    .tab-active{ @apply bg-white border-jc-border shadow-soft; }
    .banner{ @apply rounded-xl border px-3 py-2 text-sm; }
    dialog::backdrop{ background: rgba(15,23,42,.35); }
    .hint{ @apply text-xs text-jc-muted; }
    .link{ @apply text-xs underline underline-offset-2 text-jc-muted hover:text-jc-ink; }
    .loader-spin { border: 2px solid rgba(255,255,255,0.4); border-top: 2px solid white; border-radius: 50%; width:1em; height:1em; animation: spin 1s linear infinite; margin-right:.5rem; }
    @keyframes spin { 0%{ transform:rotate(0deg);} 100%{ transform:rotate(360deg);} }
    .table { @apply w-full text-sm; }
    .table th { @apply text-left text-jc-muted font-medium border-b border-jc-border py-2; }
    .table td { @apply border-b border-jc-border py-2; }
    .pill { @apply inline-flex items-center rounded-full px-2 py-0.5 text-[11px] font-medium bg-slate-100 text-slate-700; }
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <div class="min-h-full">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 bg-jc-bg/75 backdrop-blur border-b border-jc-border">
      <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/jengchilogo.jpg" alt="Jeng Chi" class="h-10 w-10 rounded-xl object-cover border border-jc-border">
          <div>
            <div class="text-xl font-serif-head">Jeng Chi — Administrator Portal</div>
            <div class="text-xs text-jc-muted">Corporate • Business • Executive • Professional • Enterprise</div>
          </div>
        </div>
        <div id="userBox" class="hidden items-center gap-3">
          <span id="adminName" class="text-sm text-jc-muted"></span>
          <button id="logoutBtn" class="btn btn-ghost">Log out</button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <!-- ===== AUTH CARD ===== -->
      <section id="authSection" class="max-w-4xl mx-auto py-10 md:py-20">
        <div class="flex flex-col md:flex-row bg-white rounded-3xl border border-jc-border shadow-2xl overflow-hidden min-h-[400px]">
          <!-- Left (Branding) -->
          <div class="w-full md:w-2/5 p-8 bg-jc-ink flex flex-col justify-between">
            <div>
              <h1 class="text-3xl font-serif-head text-white mb-3">Executive Access Portal</h1>
              <p class="text-sm text-gray-400 border-l-2 border-jc-gold pl-3 py-1">Secure authentication for proprietary employee data. Enter your credentials to manage personnel records and view corporate analytics.</p>
            </div>
            <img src="https://placehold.co/100x100/0F172A/B9965A?text=JC+Corporate" alt="Jeng Chi Corporate System" class="h-16 w-16 opacity-70 mt-6 self-start md:self-end">
          </div>

          <!-- Right (Form) -->
          <div class="w-full md:w-3/5 p-8 flex flex-col justify-center">
            <h2 class="text-2xl font-serif-head font-semibold mb-1 text-jc-ink">Sign In</h2>
            <p class="text-sm text-jc-muted mb-6">Verify your dedicated Administrator account details.</p>

            <div id="authBanner" class="hidden banner mb-4"></div>

            <form id="loginForm" class="space-y-5" autocomplete="off">
              <div>
                <label class="label">Username</label>
                <input id="username" class="input" placeholder="Your corporate username" required />
              </div>

              <div>
                <label class="label">PIN</label>
                <div class="relative">
                  <input id="pin" class="input pr-12 tracking-widest" type="password" placeholder="••••" inputmode="numeric" minlength="4" maxlength="8" required />
                  <button type="button" id="togglePin" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
                </div>
              </div>

              <button id="signInBtn" class="btn btn-gold w-full flex items-center justify-center" type="submit">
                <span id="signInText">Secure Sign In</span>
                <span id="signInSpin" class="hidden flex items-center">
                  <span class="loader-spin"></span> Authenticating…
                </span>
              </button>

              <div class="text-[10px] text-jc-muted text-center leading-relaxed mt-3">
                Security Policy: 5 failed attempts trigger a temporary lock (10 minutes).
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- ===== APP ===== -->
      <section id="appSection" class="hidden">
        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button data-tab="dashboard" class="tab tab-active">Dashboard</button>
          <button data-tab="employees" class="tab">Personnel Management</button>
          <button data-tab="reports" class="tab">Reports</button>
          <button data-tab="settings" class="tab">Settings</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">Total Employees</div>
              <div id="kpiTotal" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">FOH</div>
              <div id="kpiFOH" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">BOH</div>
              <div id="kpiBOH" class="text-3xl font-semibold">—</div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-3">Quick Filters</h3>
            <div class="flex flex-wrap gap-2">
              <button class="tag" data-q="FOH">FOH</button>
              <button class="tag" data-q="BOH">BOH</button>
              <button class="tag" data-q="Server">Server</button>
              <button class="tag" data-q="Line Cook">Line Cook</button>
              <button class="tag" data-q="">Clear</button>
            </div>
          </div>
        </div>

        <!-- Employees -->
        <div id="tab-employees" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="flex flex-col md:flex-row md:items-end gap-3">
              <div class="grow">
                <label class="label">Search Employees</label>
                <input id="searchInput" class="input" type="text" placeholder="Name, department, email, position, username…" />
              </div>
              <div class="w-full md:w-auto flex gap-2">
                <select id="deptFilter" class="input">
                  <option value="">All Departments</option>
                  <option value="FOH">FOH</option>
                  <option value="BOH">BOH</option>
                </select>
              </div>
            </div>

            <!-- Admin actions -->
            <div class="mt-4 flex flex-wrap items-center gap-2">
              <span class="text-xs text-jc-muted mr-2">PIN Controls:</span>
              <button id="revealAllPins" class="btn btn-gold text-xs">Reveal all PINs</button>
              <button id="hideAllPins" class="btn btn-ghost text-xs">Hide PINs</button>
              <span class="mx-2 text-jc-muted">•</span>
              <button id="exportGridCsv" class="btn btn-ghost text-xs">Export grid CSV</button>
            </div>
          </div>

          <!-- Card Grid -->
          <div id="empGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <div id="addEmployeeCard" class="bg-jc-gold/5 border-2 border-dashed border-jc-gold/30 rounded-2xl p-5 shadow-soft hover:bg-jc-gold/10 transition cursor-pointer flex flex-col items-center justify-center text-center h-[200px]">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-jc-gold mb-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-3-1.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.023 18.023 0 0 1 12 21.75c-3.18 0-6.23-.42-9.201-1.05a.75.75 0 0 1-.437-.695Z" />
              </svg>
              <h4 class="text-jc-gold font-semibold">Add New Personnel</h4>
              <p class="text-xs text-jc-muted">Click to onboard a new employee.</p>
            </div>
          </div>

          <div class="flex items-center justify-between pt-3 border-t border-jc-border mt-4">
            <div id="rowsInfo" class="text-xs text-jc-muted"></div>
            <div class="flex gap-2">
              <button id="prevPage" class="btn btn-ghost text-sm">Prev</button>
              <button id="nextPage" class="btn btn-ghost text-sm">Next</button>
            </div>
          </div>
        </div>

        <!-- Reports -->
        <div id="tab-reports" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Status</h3>
            <div class="flex items-center gap-2">
              <span class="tag">Server: <span id="serverStatus" class="ml-1 font-semibold text-yellow-700">pending</span></span>
            </div>
            <p class="text-sm text-jc-muted mt-2">Reserved for PDF/CSV reports and admin analytics.</p>
          </div>

          <!-- Access Audit -->
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="flex items-center justify-between mb-3">
              <h3 class="text-base font-semibold">Access History (Audit)</h3>
              <div class="text-xs text-jc-muted">PIN reveals & credential changes are logged.</div>
            </div>

            <!-- Filters -->
            <div class="grid grid-cols-1 md:grid-cols-5 gap-3 mb-4">
              <div>
                <label class="label">Employee</label>
                <select id="auditEmployee" class="input">
                  <option value="">All</option>
                </select>
              </div>
              <div>
                <label class="label">Action</label>
                <select id="auditAction" class="input">
                  <option value="">All</option>
                  <option>login_success</option>
                  <option>login_failure</option>
                  <option>pin_set</option>
                  <option>pin_reveal</option>
                  <option>username_set</option>
                  <option>employee_update</option>
                  <option>employee_delete</option>
                </select>
              </div>
              <div>
                <label class="label">Start</label>
                <input type="date" id="auditStart" class="input" />
              </div>
              <div>
                <label class="label">End</label>
                <input type="date" id="auditEnd" class="input" />
              </div>
              <div>
                <label class="label">Limit</label>
                <select id="auditLimit" class="input">
                  <option>50</option><option>100</option><option>200</option>
                </select>
              </div>
            </div>

            <div class="flex gap-2 mb-3">
              <button id="loadAuditBtn" class="btn btn-ghost text-sm">Load Logs</button>
              <button id="exportAuditCsv" class="btn btn-ghost text-sm">Export CSV</button>
            </div>

            <div class="overflow-auto">
              <table class="table">
                <thead>
                  <tr>
                    <th class="w-[140px]">Timestamp</th>
                    <th>Employee</th>
                    <th>Action</th>
                    <th>By</th>
                    <th>Details</th>
                  </tr>
                </thead>
                <tbody id="auditTbody">
                  <tr><td colspan="5" class="py-6 text-center text-jc-muted">No data</td></tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab-settings" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Configuration</h3>
            <ul class="list-disc ml-5 text-sm text-jc-muted space-y-1">
              <li>Admins table: <code>public.administrators</code></li>
              <li>Login RPC: <code>public.admin_login(p_username, p_pin)</code></li>
              <li>Read from <code>public.employees_admin</code> when available</li>
              <li>Access RPC: <code>public.admin_update_employee_access(p_admin_id, p_employee_id, p_username, p_pin)</code> (preferred)</li>
              <li>PIN reveal RPC: <code>public.admin_reveal_employee_pin(p_admin_id, p_employee_id)</code></li>
              <li>Audit feed RPC (one of): <code>public.admin_access_audit(...)</code> or table <code>public.auth_audit</code></li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Employee Modal -->
  <dialog id="empModal" class="rounded-2xl w-full max-w-5xl p-0 border border-jc-border shadow-2xl">
    <form id="empForm" class="bg-white rounded-2xl p-8 space-y-8" method="dialog">
      <div class="flex items-start justify-between gap-3 border-b pb-4 border-jc-border/70">
        <div>
          <h3 id="empModalTitle" class="text-2xl font-serif-head text-jc-ink">Personnel Record Management</h3>
          <p class="text-sm text-jc-muted mt-1">Enterprise view for updating employee data and access credentials.</p>
        </div>
        <button type="button" id="closeModal" class="btn btn-ghost text-sm">Close</button>
      </div>

      <!-- Modal Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button type="button" data-modaltab="data" class="modal-tab tab tab-active">Personnel Data</button>
        <button type="button" data-modaltab="access" class="modal-tab tab">System Access</button>
      </div>
      
      <div class="border border-jc-border/70 rounded-2xl p-6">
        <!-- Tab 1: Personnel Data -->
        <div id="modaltab-data" class="modal-tab-content grid grid-cols-1 md:grid-cols-2 gap-8">
          <div class="space-y-4">
            <h4 class="text-base font-semibold text-jc-ink pb-1 border-b border-jc-border/50">Core Identity & Contact</h4>
            <div><label class="label">First Name</label><input id="fName" class="input" required /></div>
            <div><label class="label">Last Name</label><input id="lName" class="input" /></div>
            <div><label class="label">Email (Work)</label><input id="eMail" type="email" class="input" placeholder="unique@jengchirestaurant.com" /></div>
            <div><label class="label">Phone Number</label><input id="phone" type="tel" class="input" placeholder="(123) 456-7890" /></div>
          </div>

          <div class="space-y-4">
            <h4 class="text-base font-semibold text-jc-ink pb-1 border-b border-jc-border/50">Employment Status & Role</h4>
            <div><label class="label">Department</label>
              <select id="dept" class="input" required>
                <option value="FOH">FOH - Front of House</option>
                <option value="BOH">BOH - Back of House</option>
              </select>
            </div>
            <div><label class="label">Position/Role</label>
              <select id="positionSel" class="input"></select>
              <input id="positionCustom" class="input mt-2 hidden" placeholder="Type custom position…" />
            </div>
            <div><label class="label">Reports To (Manager)</label>
              <select id="reportToSel" class="input"></select>
            </div>
            <div><label class="label">Status</label>
              <select id="status" class="input" required>
                <option value="Active">Active</option>
                <option value="Leave">On Leave</option>
                <option value="Terminated">Terminated</option>
              </select>
            </div>
            <div class="pt-2"><span class="text-xs text-jc-muted">Employee ID: <span id="displayEmpId" class="font-semibold">N/A</span></span></div>
          </div>
        </div>

        <!-- Tab 2: System Access -->
        <div id="modaltab-access" class="modal-tab-content hidden p-6 bg-jc-ink rounded-xl text-white shadow-xl">
          <h4 class="text-base font-semibold text-jc-gold mb-6 border-b border-gray-700 pb-2">System Login Credentials & Auditing</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
            <div>
              <label class="label text-white">System Username (Login ID)</label>
              <input id="uName" class="input bg-gray-800 border-gray-700 text-white" placeholder="e.g., jengchi.admin" />
            </div>
            <div>
              <label class="label text-white">Current PIN (Plaintext)</label>
              <input id="pinCurrent" class="input bg-gray-800 border-gray-700 text-green-400 font-mono tracking-wider" readonly value="—" />
              <p class="hint text-red-400 mt-1">PIN is visible for executive auditing (action is logged).</p>
            </div>
            <div>
              <label class="label text-white">PIN Status</label>
              <div id="pinStatus" class="text-sm font-medium p-2 rounded-xl border border-yellow-500 text-yellow-100 bg-yellow-900/50">Unconfigured</div>
            </div>
          </div>

          <div class="mt-8 border-t border-gray-700/50 pt-6">
            <h5 class="text-xs font-medium text-jc-gold mb-3">Set/Reset New PIN (4–8 Digits)</h5>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-4">
              <div>
                <label class="label text-white">New PIN</label>
                <div class="relative">
                  <input id="pinNew" class="input pr-12 tracking-widest bg-gray-800 border-gray-700 text-white" type="password" inputmode="numeric" minlength="4" maxlength="8" placeholder="••••" />
                  <button type="button" id="togglePinNew" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">Show</button>
                </div>
              </div>
              <div>
                <label class="label text-white">Confirm PIN</label>
                <div class="relative">
                  <input id="pinNew2" class="input pr-12 tracking-widest bg-gray-800 border-gray-700 text-white" type="password" inputmode="numeric" minlength="4" maxlength="8" placeholder="••••" />
                  <button type="button" id="togglePinNew2" class="absolute right-2 top-1/2 -translate-y-1/2 text-gray-400 text-xs">Show</button>
                </div>
              </div>
              <div class="flex items-end">
                <div class="text-[11px] text-gray-400 leading-relaxed">
                  • Only digits (0–9).<br/>• Hashed at save. Leaving blank keeps current PIN.
                </div>
              </div>
            </div>
          </div>

          <!-- Employee recent audit feed -->
          <div class="mt-8 border-t border-gray-700/50 pt-6">
            <h5 class="text-xs font-medium text-jc-gold mb-3">Recent Activity (Last 10)</h5>
            <ul id="empAuditList" class="text-sm text-white/80 space-y-1">
              <li class="text-gray-400">No activity</li>
            </ul>
          </div>
        </div><!-- /access -->
      </div><!-- /content box -->

      <div class="flex items-center justify-end pt-4 border-t border-jc-border/70">
        <div class="flex gap-3">
          <button type="button" id="deleteEmp" class="btn btn-danger hidden">Delete Record</button>
          <button type="submit" class="btn btn-gold">Save Changes</button>
        </div>
      </div>

      <input type="hidden" id="empId" />
    </form>
  </dialog>

  <!-- Confirm Modal -->
  <dialog id="confirmModal" class="rounded-2xl w-full max-w-sm p-5 border border-jc-border shadow-soft">
    <h3 id="confirmTitle" class="text-lg font-semibold mb-2 text-jc-ink">Confirmation</h3>
    <p id="confirmMessage" class="text-sm text-jc-ink mb-6">Are you sure?</p>
    <div class="flex justify-end gap-3">
      <button id="confirmCancel" class="btn btn-ghost text-sm">Cancel</button>
      <button id="confirmOK" class="btn btn-danger text-sm">OK</button>
    </div>
  </dialog>

  <script>
    // ================== SUPABASE ==================
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================== STATIC LISTS ==================
    const FOH_POSITIONS = ["Server","Bartender Jr","Bartender","Cashier","Host","Manager on Duty","Custom…"];
    const BOH_POSITIONS = ["Dumpling Maker","Line Cook","Kitchen Prep","Busser","Dishwasher","Pastry Chef","Noodle Maker","Custom…"];
    const CORE_MANAGERS = ["Janelle Teng","Pablo Gonzalez","Shoko Teng","Craig Reeves","Anh Mai Vu"];

    // ================== STATE ==================
    let session = null;
    let page = 1;
    const pageSize = 12;
    let rows = [];
 let READ_SOURCE = 'employees_admin';  // ← ¡VUELVE A USAR LA VISTA!
    let ALL_EMP_NAMES = [];
    const PIN_CACHE = new Map();
    let LAST_AUDIT_ROWS = [];

    // Column map (auto-detected)
    let COLS = {
      nameMode: 'single',
      single: 'full_name',
      first: 'first_name',
      last:  'last_name',
      username: 'username',
      email: 'email',
      dept:  'department',
      position: 'position',
      reportTo: 'report_to',
      status: 'status',
      phone: 'phone',
      has_pin: 'has_pin',
      id: 'id',
      pin_hint: 'pin_hint_last2'
    };

    // ================== HELPERS ==================
    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
    const setTabs=(active)=>{ qsa('.tab').forEach(b=>{const t=b.dataset.tab; if(!t) return; b.classList.toggle('tab-active',t===active); const pane=qs('#tab-'+t); if(pane) pane.classList.toggle('hidden',t!==active);}); localStorage.setItem('jc-active-tab',active);};
    const paginate=(arr,p,s)=>Array.isArray(arr)?arr.slice((p-1)*s,(p-1)*s+s):[];
    const banner=(type,msg)=>{ const box=qs('#authBanner'); const map={error:'border-red-200 bg-red-50 text-red-800', ok:'border-emerald-200 bg-emerald-50 text-emerald-800', info:'border-slate-200 bg-white text-slate-700'}; box.className=`banner ${map[type]||map.info}`; box.textContent=msg; box.classList.remove('hidden'); };
    const clearBanner=()=>qs('#authBanner').classList.add('hidden');
    const sanitizeUsername = (u) => (u||'').trim().toLowerCase().replace(/[^a-z0-9._-]/g,'');
    const validUsername = (u) => /^[a-z0-9._-]{2,32}$/.test(u||'');
    const validPinFormat = (pin) => /^[0-9]{4,8}$/.test(pin || '');
    const csvEscape = (v)=>`"${String(v??'').replace(/"/g,'""')}"`;
    const toCsv = (rows)=> rows.length ? [Object.keys(rows[0]).join(','), ...rows.map(r=>Object.values(r).map(csvEscape).join(','))].join('\n') : '';

    function nameFromRow(r){
      if(READ_SOURCE==='employees_admin') return r.full_name || '';
      if (COLS.nameMode==='single') return r[COLS.single] || '';
      const a=r[COLS.first]||'', b=r[COLS.last]||''; return [a,b].filter(Boolean).join(' ').trim();
    }
    function sortByName(a,b){ return nameFromRow(a).localeCompare(nameFromRow(b)); }

    // Confirm modal helpers
    var confirmModal = qs('#confirmModal');
    var confirmTitle = qs('#confirmTitle');
    var confirmMessage = qs('#confirmMessage');
    var confirmCancel = qs('#confirmCancel');
    var confirmOK = qs('#confirmOK');

    function showCustomAlert(message, title = 'Error', okText = 'OK') {
      return new Promise(resolve => {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmTitle.classList.toggle('text-jc-danger', /error|failed/i.test(title));
        confirmCancel.classList.add('hidden');
        confirmOK.textContent = okText;
        confirmOK.classList.remove('btn-danger');
        confirmOK.classList.add('btn-gold');
        confirmOK.onclick = () => { confirmModal.close(); resolve(true); };
        confirmModal.showModal();
      });
    }
    function showCustomConfirm(message, title = 'Confirm Action', okText = 'Delete') {
      return new Promise(resolve => {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmTitle.classList.add('text-jc-danger');
        confirmCancel.classList.remove('hidden');
        confirmOK.textContent = okText;
        confirmOK.classList.add('btn-danger');
        confirmOK.classList.remove('btn-gold');
        confirmOK.onclick = () => { confirmModal.close(); resolve(true); };
        confirmCancel.onclick = () => { confirmModal.close(); resolve(false); };
        confirmModal.showModal();
      });
    }

    // ================== RPC HELPERS ==================
    async function setEmployeePin(empId, pin){
      const adminId = session?.admin_id || null;
      try{
        const { error } = await supabase.rpc('admin_update_employee_access', {
          p_admin_id: adminId, p_employee_id: empId, p_username: null, p_pin: String(pin)
        });
        if (error) throw error;
        return true;
      }catch(err){
        if (err?.code === 'PGRST202' || /not found|function .* does not exist/i.test(err?.message||'')){
          const { error } = await supabase.rpc('admin_set_employee_pin', {
            p_emp_id: empId, p_pin: String(pin), p_admin_id: adminId
          });
          if (error) throw error;
          return true;
        }
        throw err;
      }
    }

    async function updateAccess(empId, newUsernameOrNull, newPinOrNull){
      const adminId = session?.admin_id || null;
      let uOk=false, pOk=false;
      try{
        const { error } = await supabase.rpc('admin_update_employee_access', {
          p_admin_id: adminId, p_employee_id: empId, p_username: newUsernameOrNull, p_pin: newPinOrNull
        });
        if (error) throw error;
        uOk = newUsernameOrNull !== null; pOk = newPinOrNull !== null;
        return { uOk, pOk };
      }catch(err){
        if (err?.code !== 'PGRST202' && !/not found|does not exist/i.test(err?.message||'')){ throw err; }
        if (newUsernameOrNull !== null){
          const { error: uErr } = await supabase.from('employees').update({ username: newUsernameOrNull }).eq(COLS.id, empId);
          if (uErr) throw uErr; uOk = true;
        }
        if (newPinOrNull !== null){ await setEmployeePin(empId, newPinOrNull); pOk = true; }
        return { uOk, pOk };
      }
    }
async function revealPin(empId){
  if (!empId || !session?.admin_id) return null;
  if (PIN_CACHE.has(String(empId))) return PIN_CACHE.get(String(empId));

  try {
    const { data, error } = await supabase.rpc('admin_reveal_employee_pin', {
      p_admin_id: session.admin_id,
      p_employee_id: empId
    });

    if (error) throw error;
    const pin = data || null;  // RPC devuelve texto directamente
    if (pin) PIN_CACHE.set(String(empId), pin);
    return pin;
  } catch (err) {
    console.error('[REVEAL_PIN]', err);
    throw err;
  }
}




    // Audit feed (RPC preferred, table fallback)
    async function fetchAudit({ employee_id=null, action=null, since=null, until=null, limit=50, offset=0 }={}){
      // Try RPC first
      try{
        const { data, error } = await supabase.rpc('admin_access_audit', {
          p_admin_id: session?.admin_id || null,
          p_employee_id: employee_id, p_action: action,
          p_since: since, p_until: until, p_limit: limit, p_offset: offset
        });
        if (error) throw error;
        return data || [];
      }catch(err){
        // Fallback to table "auth_audit" if present
        try{
          let q = supabase.from('auth_audit').select('*').order('created_at',{ascending:false}).limit(limit);
          if (employee_id) q = q.eq('employee_id', employee_id);
          if (action) q = q.eq('action', action);
          if (since) q = q.gte('created_at', since);
          if (until) q = q.lte('created_at', until);
          const { data, error } = await q;
          if (error) throw error;
          return data || [];
        }catch(_){
          return [];
        }
      }
    }

    // Username/email helpers
    async function findByEmail(email){
      const e = (email||'').trim().toLowerCase(); if(!e) return null;
      const { data } = await supabase.from('employees').select('*').ilike('email', e).limit(1);
      return (data && data[0]) || null;
    }
    async function findByUsername(username){
      const u = sanitizeUsername(username); if(!u) return null;
      const { data } = await supabase.from('employees').select('*').ilike('username', u).limit(1);
      return (data && data[0]) || null;
    }
    function showFieldError(el, msg){ el.setCustomValidity(msg||''); el.reportValidity(); }
    async function ensureUniqueEmailOrOpen(email){
      const existing = await findByEmail(email);
      if(!existing) return { ok:true };
      if (await showCustomConfirm('That email is already used by another employee. Open that record to edit?', 'Duplicate Email Detected', 'Open Record')){ openModal(existing); }
      return { ok:false, message:'Duplicate email' };
    }
    async function ensureUniqueUsernameOrOpen(username, selfId){
      const existing = await findByUsername(username);
      if(!existing) return { ok:true };
      if (String(existing.id) === String(selfId)) return { ok:true };
      if (await showCustomConfirm('That username is already used by another employee. Open that record to edit?', 'Duplicate Username Detected', 'Open Record')){ openModal(existing); }
      return { ok:false, message:'Duplicate username' };
    }

    // ================== AUTH ==================
    const authSection = qs('#authSection');
    const appSection  = qs('#appSection');
    const userBox     = qs('#userBox');
    const adminNameEl = qs('#adminName');

    async function rpcAdminLogin(username, pin){
      if(!/^[a-z0-9._-]{2,32}$/i.test(username)) throw { friendly:'Invalid username format.' };
      if(!/^[0-9]{4,8}$/.test(pin)) throw { friendly:'PIN must be 4–8 digits.' };
      const { data, error } = await supabase.rpc('admin_login', { p_username: username, p_pin: pin });
      if(error) throw error;
      if(!data || !data.length) return null;
      return data[0];
    }
    function showApp(profile){
      const uname = profile.admin_username || profile.username || 'Administrator';
      adminNameEl.textContent = `${uname} — Administrator`;
      userBox.classList.remove('hidden'); authSection.classList.add('hidden'); appSection.classList.remove('hidden');
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');
    }
    function showAuth(){ userBox.classList.add('hidden'); authSection.classList.remove('hidden'); appSection.classList.add('hidden'); }

    // ================== SOURCE / SCHEMA DETECTION ==================
    async function detectReadSource(){
      const res = await supabase.from('employees_admin').select('*').limit(1);
      READ_SOURCE = res.error ? 'employees' : 'employees_admin';
    }
    async function detectEmployeesSchema(){
      const { data, error } = await supabase.from(READ_SOURCE).select('*').limit(1);
      if(error) return;
      const row  = (data && data[0]) || {};
      const keys = Object.keys(row);
      const has  = k => keys.includes(k);

      COLS.id = has('id') ? 'id' : COLS.id;

      if (has('full_name') || has('name')) {
        COLS.nameMode='single'; COLS.single = has('full_name') ? 'full_name' : 'name';
      } else {
        COLS.nameMode='split';
        COLS.first = has('first_name') ? 'first_name' : has('fname') ? 'fname' : has('first') ? 'first' : 'first_name';
        COLS.last  = has('last_name')  ? 'last_name'  : has('lname') ? 'lname' : has('last')  ? 'last'  : 'last_name';
      }

      // Explicitly check for access columns in the schema
      // We keep the default names as fallbacks since merging depends on these keys existing.
      COLS.username = has('username') ? 'username' : COLS.username;
      COLS.has_pin  = has('has_pin')  ? 'has_pin'  : COLS.has_pin;
      COLS.pin_hint = has('pin_hint_last2') ? 'pin_hint_last2' : COLS.pin_hint;

      COLS.email    = has('email') ? 'email' : has('work_email') ? 'work_email' : 'email';
      COLS.dept     = has('department') ? 'department' : has('dept') ? 'dept' : 'department';
      COLS.position = has('position') ? 'position' : has('role') ? 'role' : has('primary_role') ? 'primary_role' : 'position';
     COLS.reportTo = has('manager') ? 'manager' : 'report_to';
     
     
          COLS.status   = has('status') ? 'status' : has('employment_status') ? 'employment_status' : 'status';
      COLS.phone    = has('phone') ? 'phone' : has('contact_phone') ? 'contact_phone' : 'phone';
    }
    // ================== CRUD ==================
    async function fetchEmployees(){
      const { data, error } = await supabase.from(READ_SOURCE).select('*');
      if(error){ console.error(error); return []; }
      return (data || []).sort(sortByName);
    }

    function collectPositionValue(){
      const sel = qs('#positionSel').value;
      return sel === '__custom__' ? qs('#positionCustom').value.trim() : sel;
    }

    function fillReportToOptions(currentValue = ""){
      const sel = qs('#reportToSel');
      const items = [...CORE_MANAGERS];
      if (currentValue && !items.includes(currentValue)) items.unshift(currentValue);
      sel.innerHTML = items.map(n => `<option value="${n}">${n}</option>`).join('');
    }
    function collectReportToValue(){ return qs('#reportToSel').value; }

    function toggleCustom(selectEl, customInputId){
      const show = selectEl.value === '__custom__';
      qs('#'+customInputId).classList.toggle('hidden', !show);
      if(show) qs('#'+customInputId).focus();
    }

    async function insertEmployeeFromForm(){
      const emailEl = qs('#eMail');
      const userEl  = qs('#uName');

      const rawU = sanitizeUsername(userEl.value);
      if (rawU && !validUsername(rawU)) { showFieldError(userEl,'Username must be 2–32 chars [a-z0-9._-].'); throw new Error('Invalid username'); }

      const email = (emailEl.value||'').trim().toLowerCase();

      const uok = rawU ? await ensureUniqueUsernameOrOpen(rawU) : { ok:true };
      if(!uok.ok){ showFieldError(userEl, uok.message); throw new Error(uok.message); }
      showFieldError(userEl,'');

      const eok = email ? await ensureUniqueEmailOrOpen(email) : { ok:true };
      if(!eok.ok){ showFieldError(emailEl, eok.message); throw new Error(eok.message); }
      showFieldError(emailEl,'');

      const row = {};
      if (COLS.nameMode==='single'){
        row[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        row[COLS.first]  = qs('#fName').value.trim();
        row[COLS.last]   = qs('#lName').value.trim();
      }
      row[COLS.username] = rawU || null;
      row[COLS.email]    = email || null;
      row[COLS.phone]    = qs('#phone').value.trim() || null;
      row[COLS.dept]     = qs('#dept').value.split(' - ')[0];
      row[COLS.position] = collectPositionValue();
      row[COLS.reportTo] = collectReportToValue();
      row[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').insert(row).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }

    async function updateEmployeeFromForm(id){
      const emailEl = qs('#eMail');
      const userEl  = qs('#uName');

      const rawU = sanitizeUsername(userEl.value);
      if (rawU && !validUsername(rawU)) { showFieldError(userEl,'Username must be 2–32 chars [a-z0-9._-].'); throw new Error('Invalid username'); }

      const existingUser = await findByUsername(rawU);
      if(existingUser && String(existingUser[COLS.id]) !== String(id)){
        if (await showCustomConfirm('That username is used by another employee. Open that record to edit instead?', 'Duplicate Username Detected','Open Record')){ openModal(existingUser); }
        throw new Error('Duplicate username');
      }
      showFieldError(userEl,'');

      const email = (emailEl.value||'').trim().toLowerCase();
      const existingMail = await findByEmail(email);
      if(existingMail && String(existingMail[COLS.id]) !== String(id)){
        if (await showCustomConfirm('That email is used by another employee. Open that record to edit instead?', 'Duplicate Email Detected','Open Record')){ openModal(existingMail); }
        throw new Error('Duplicate email');
      }
      showFieldError(emailEl,'');

      const patch = {};
      if (COLS.nameMode==='single'){
        patch[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        patch[COLS.first]  = qs('#fName').value.trim();
        patch[COLS.last]   = qs('#lName').value.trim();
      }
      patch[COLS.email]    = email || null;
      patch[COLS.phone]    = qs('#phone').value.trim() || null;
      patch[COLS.dept]     = qs('#dept').value.split(' - ')[0];
      patch[COLS.position] = collectPositionValue();
      patch[COLS.reportTo] = collectReportToValue();
      patch[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').update(patch).eq(COLS.id, id).select().single();
      if(error){ console.error(error); throw error; }
      data.desired_username = rawU || null;
      return data;
    }

    async function deleteEmployeeById(id){
      const { error } = await supabase.from('employees').delete({ returning:'minimal' }).eq(COLS.id, id);
      if(error) throw error;
    }

    // ================== RENDER ==================
    function renderKPIs(list){
      const total = list.length;
      const foh = list.filter(r=>(r.department||'').toUpperCase()==='FOH').length;
      const boh = list.filter(r=>(r.department||'').toUpperCase()==='BOH').length;
      qs('#kpiTotal').textContent = total;
      qs('#kpiFOH').textContent   = foh;
      qs('#kpiBOH').textContent   = boh;
    }

    function applyFilters(source){
      const q = (qs('#searchInput').value||'').trim().toLowerCase();
      const dept = qs('#deptFilter').value;
      return source.filter(r=>{
        const hay = [nameFromRow(r), r.email, r.position, r.department, r.report_to, r.status, r.username].join(' ').toLowerCase();
        const passQ = q ? hay.includes(q) : true;
        const passD = dept ? (String(r.department||'')===dept) : true;
        return passQ && passD;
      });
    }

    function getStatusClass(status) {
      status = status ? status.toLowerCase() : '';
      if (status.includes('active')) return 'bg-green-50 text-green-700 ring-green-600/20';
      if (status.includes('leave')) return 'bg-yellow-50 text-yellow-800 ring-yellow-600/20';
      if (status.includes('terminated')) return 'bg-red-50 text-red-700 ring-red-600/20';
      return 'bg-gray-50 text-gray-700 ring-gray-600/20';
    }

    function renderEmployeeCard(r) {
      const name = nameFromRow(r);
      const statusClass = getStatusClass(r.status);
      const u = r.username || '—';
      const pinTxt = r.has_pin ? 'Set' : 'Unconfigured';
      const pinColor = r.has_pin ? 'text-jc-success' : 'text-jc-warn';

      return `
        <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft hover:shadow-lg transition flex flex-col justify-between">
          <div class="flex items-center justify-between mb-4">
            <span class="inline-flex items-center rounded-full px-3 py-1 text-xs font-medium ring-1 ring-inset ${statusClass}">
              ${r.status || 'Unknown Status'}
            </span>
            <div class="text-xs text-jc-muted font-mono">ID: ${r.id}</div>
          </div>

          <div class="flex-grow">
            <h4 class="text-xl font-serif-head font-semibold text-jc-ink mb-0 truncate">${name}</h4>
            <p class="text-sm text-jc-gold font-medium mb-3">${r.position || '—'}</p>
          </div>

          <div class="border-t border-jc-gold/30 my-3"></div>

          <dl class="text-xs space-y-2">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.5 20.25a8.25 8.25 0 0 1 15 0" /></svg>
              <dt class="text-jc-muted font-medium w-16">Username:</dt>
              <dd class="ml-1 text-jc-ink truncate">${u}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 ${pinColor} mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V6a3.75 3.75 0 1 0-7.5 0v3M4.5 9h15V19.5a1.5 1.5 0 0 1-1.5 1.5h-12A1.5 1.5 0 0 1 4.5 19.5V9Z" /></svg>
              <dt class="text-jc-muted font-medium w-16">PIN:</dt>
              <dd class="ml-1 font-mono">
                <span id="pin-val-${r.id}">${r.has_pin ? "••••" : "—"}</span>
                <button class="link ml-2" data-reveal="${r.id}">Reveal</button>
                <button class="link ml-1" data-hide="${r.id}">Hide</button>
              </dd>
            </div>

            <div class="flex items-center">
              <span class="pill mr-2">PIN Auth: <span class="${pinColor} ml-1 font-semibold">${pinTxt}</span></span>
              ${r.pin_hint_last2 ? `<span class="pill">hint: **${String(r.pin_hint_last2).padStart(2,'*')}</span>` : ``}
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 21V6.375a3.75 3.75 0 0 1 7.5 0V21m-9-9h16.5" /></svg>
              <dt class="text-jc-muted font-medium w-16">Dept:</dt>
              <dd class="ml-1 text-jc-ink">${r.department || '—'}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0" /></svg>
              <dt class="text-jc-muted font-medium w-16">Manager:</dt>
              <dd class="ml-1 text-jc-ink truncate">${r.report_to || '—'}</dd>
            </div>
          </dl>

          <div class="pt-4 mt-4 border-t border-jc-border flex justify-between">
            <button class="btn btn-ghost text-xs py-1" data-edit="${r.id}">View/Edit Record</button>
            <button class="btn btn-danger text-xs py-1" data-del="${r.id}">Delete</button>
          </div>
        </div>
      `;
    }

    function renderTable(){
      const filtered = applyFilters(rows);
      const paged = paginate(filtered, page, pageSize);
      const grid = qs('#empGrid');
      const addCard = qs('#addEmployeeCard').outerHTML;
      grid.innerHTML = addCard + paged.map(renderEmployeeCard).join('');
      qs('#addEmployeeCard').onclick = () => openModal(null);

      // Re-apply any cached PINs to the DOM
      paged.forEach(r=>{
        const cached = PIN_CACHE.get(String(r.id));
        if (cached){ const el=qs(`#pin-val-${r.id}`); if (el) el.textContent = cached; }
      });

      const start = (page-1)*pageSize+1, end = Math.min(page*pageSize, filtered.length);
      qs('#rowsInfo').textContent = filtered.length ? `Showing ${start}-${end} of ${filtered.length} total records` : 'No employees matched your search.';
      qs('#prevPage').disabled = page === 1;
      qs('#nextPage').disabled = page * pageSize >= filtered.length;
    }

    // ================== MODAL ==================
    var empModal = qs('#empModal');
    var empForm  = qs('#empForm');

    function fillPositionOptions(){
      const dept = qs('#dept').value.split(' - ')[0];
      const sel = qs('#positionSel');
      const list = dept === 'BOH' ? BOH_POSITIONS : FOH_POSITIONS;
      sel.innerHTML = list.map(p=>`<option value="${p==='Custom…'?'__custom__':p}">${p}</option>`).join('');
      toggleCustom(sel, 'positionCustom');
    }
async function autoRevealPin(rowId, pinStatusEl, pinCurrentEl) {
  if (!rowId || !session?.admin_id) {
    pinCurrentEl.value = '—';
    pinStatusEl.textContent = 'Unconfigured';
    pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-yellow-100 bg-yellow-900/50';
    return;
  }

  const row = rows.find(r => String(r.id) === String(rowId));
  if (!row || !row.has_pin) {
    pinCurrentEl.value = '—';
    pinStatusEl.textContent = 'Unconfigured';
    pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-yellow-100 bg-yellow-900/50';
    return;
  }

  pinCurrentEl.value = 'FETCHING…';
  try {
    const pin = await revealPin(rowId);
   if (!pin) {
  pinCurrentEl.value = 'NOT FOUND';
  pinStatusEl.textContent = 'No PIN';
  pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-yellow-100 bg-yellow-900/50';
  return;
}
    pinCurrentEl.value = pin;
    pinStatusEl.textContent = 'Active (Visible)';
    pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-success text-white bg-green-700';
  } catch (err) {
    pinCurrentEl.value = 'ERROR';
    pinStatusEl.textContent = 'System Error';
    pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-danger text-white bg-red-700';
    console.error('[AUTO_REVEAL_ERROR]', err);
  }
}
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
   
      async function loadEmployeeAudit(empId){
      const listEl = qs('#empAuditList');
      listEl.innerHTML = `<li class="text-gray-400">Loading…</li>`;
      const rows = await fetchAudit({ employee_id: empId, limit: 10 });
      if (!rows.length){ listEl.innerHTML = `<li class="text-gray-400">No activity</li>`; return; }
      listEl.innerHTML = rows.map(a=>{
        const ts = a.created_at || a.ts || a.timestamp || '';
        const actor = a.admin_name || a.actor_name || a.admin_username || a.actor || 'system';
        const action = a.action || a.event || '';
        const detail = a.details || a.detail || '';
        return `<li><span class="opacity-70">${ts}</span> — <span class="font-medium">${action}</span> by <span class="opacity-90">${actor}</span> <span class="opacity-80">${detail?('· '+detail):''}</span></li>`;
      }).join('');
    }

    function openModal(row){
      fillPositionOptions();
     const currentRpt = row ? (row[COLS.reportTo] || "") : "";
      fillReportToOptions(currentRpt);

      qs('#displayEmpId').textContent = 'N/A';
      qs('#pinNew').value = ''; qs('#pinNew2').value = '';

      ['togglePinNew','togglePinNew2'].forEach(id=>{
        const btn = qs('#'+id);
        const input = qs('#'+(id==='togglePinNew'?'pinNew':'pinNew2'));
        if (btn) btn.textContent = 'Show';
        if (input) input.type = 'password';
      });

      const pinStatusEl = qs('#pinStatus');
      const pinCurrentEl = qs('#pinCurrent');
      const dataTab = qs('#modaltab-data');
      const accessTab = qs('#modaltab-access');

      qsa('.modal-tab').forEach(tab => tab.classList.remove('tab-active'));
      qs('[data-modaltab="data"]').classList.add('tab-active');
      dataTab.classList.remove('hidden'); accessTab.classList.add('hidden');

      pinCurrentEl.value = '—';
      pinStatusEl.textContent = 'Unconfigured';
      pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-yellow-100 bg-yellow-900/50';

      if(row){
        qs('#empModalTitle').textContent = 'Edit Personnel Record';
        const employeeId = row.id;
        qs('#empId').value = employeeId;
        qs('#displayEmpId').textContent = employeeId;

        const full = nameFromRow(row);
        const parts = full.split(' ');
        qs('#fName').value = parts.length>1 ? parts.slice(0,-1).join(' ') : full;
        qs('#lName').value = parts.length>1 ? parts.slice(-1).join(' ') : '';

        qs('#uName').value  = row.username || '';
        qs('#eMail').value  = row.email    || '';
        qs('#phone').value  = row.phone    || '';

      const deptValue = row.department === 'BOH' ? 'BOH' : 'FOH';  // ← COINCIDE CON <option value="FOH">
qs('#dept').value = deptValue;

        fillPositionOptions();
        const pos = row.position||'';
        if(qs('#positionSel').querySelector(`option[value="${pos}"]`)) qs('#positionSel').value = pos;
        else { qs('#positionSel').value='__custom__'; qs('#positionCustom').classList.remove('hidden'); qs('#positionCustom').value = pos; }

        if (currentRpt && qs('#reportToSel').querySelector(`option[value="${currentRpt}"]`)) {
          qs('#reportToSel').value = currentRpt;
        }

        qs('#status').value = (row.status||'Active').toString().replace(/^active$/i,'Active').replace('On Leave','Leave').replace('Terminated','Terminated');

        autoRevealPin(employeeId, pinStatusEl, pinCurrentEl);
        loadEmployeeAudit(employeeId);
        qs('#deleteEmp').classList.remove('hidden');
      } else {
        qs('#empModalTitle').textContent = 'Add New Personnel';
        empForm.reset();
        qs('#empId').value = '';
        qs('#dept').value  = 'FOH - Front of House';
        qs('#deleteEmp').classList.add('hidden');
        fillPositionOptions();
        fillReportToOptions();
        qs('#empAuditList').innerHTML = `<li class="text-gray-400">No activity</li>`;
      }

      // Modal tab switching
      qsa('.modal-tab').forEach(b => {
        b.onclick = () => {
          const targetTab = b.dataset.modaltab;
          qsa('.modal-tab').forEach(tab => tab.classList.remove('tab-active'));
          b.classList.add('tab-active');
          qsa('.modal-tab-content').forEach(content => content.classList.add('hidden'));
          qs('#modaltab-' + targetTab).classList.remove('hidden');
        };
      });

      // Rebind delete each open
      const delBtnOld = qs('#deleteEmp');
      const fresh = delBtnOld.cloneNode(true);
      delBtnOld.replaceWith(fresh);
      fresh.addEventListener('click', async () => {
        const id = qs('#empId').value;
        if (!id) { await showCustomAlert('No employee selected.'); return; }
        const who = (rows.find(r => String(r.id) === String(id))?.full_name) || 'this employee';
        if (!await showCustomConfirm(`Delete ${who}? This cannot be undone.`, 'Confirm Deletion', 'Delete Record')) return;
        const original = fresh.textContent;
        fresh.disabled = true; fresh.textContent = 'Deleting…';
        try { await deleteEmployeeById(id); empModal.close(); await reloadData(); }
        catch (err) { console.error('[MODAL_DELETE]', err); await showCustomAlert(`Delete failed: ${err.message || err}`, 'Delete Failed'); }
        finally { fresh.disabled = false; fresh.textContent = original; }
      });

      empModal.showModal();
    }

    // ================== INIT / EVENTS ==================
    document.addEventListener('DOMContentLoaded', ()=>{
      // Tabs
      qsa('.tab').forEach(b=>{ if(b.dataset.tab){ b.addEventListener('click', ()=>setTabs(b.dataset.tab)); }});
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');

      // PIN show/hide toggles (auth + modal)
      qs('#togglePin').addEventListener('click', ()=>{
        const i = qs('#pin'); const show = i.type==='password'; i.type = show ? 'text':'password';
        qs('#togglePin').textContent = show ? 'Hide' : 'Show';
      });
      const tp = (btnId, inputId)=>{
        const btn=qs('#'+btnId), input=qs('#'+inputId);
        btn?.addEventListener('click', ()=>{ const show=input.type==='password'; input.type=show?'text':'password'; btn.textContent = show?'Hide':'Show';});
      };
      tp('togglePinNew','pinNew'); tp('togglePinNew2','pinNew2');

      // Login
      qs('#loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); clearBanner();
        qs('#signInBtn').disabled=true; qs('#signInText').classList.add('hidden'); qs('#signInSpin').classList.remove('hidden');
        try{
          const profile = await rpcAdminLogin(qs('#username').value.trim(), qs('#pin').value.trim());
          if(!profile){ banner('error','Invalid credentials.'); return; }
          session = { admin_id: profile.admin_id, employee_id: profile.employee_id };
          showApp(profile);

    
          await detectEmployeesSchema();
          await reloadData();
        }catch(err){
          console.error(err);
          if (err.code === 'PGRST202') banner('error',"Login service isn't registered. Create RPC public.admin_login(p_username,p_pin) and NOTIFY pgrst,'reload schema';");
          else banner('error', err.friendly || 'Login failed. Please verify admin setup.');
        }finally{
          qs('#signInBtn').disabled=false; qs('#signInText').classList.remove('hidden'); qs('#signInSpin').classList.add('hidden');
        }
      });

      // Logout
      qs('#logoutBtn').addEventListener('click', ()=>{ session=null; showAuth(); });

      // Dashboard shortcuts -> Employees filter
      qsa('#tab-dashboard [data-q]').forEach(b=>{
        b.addEventListener('click', ()=>{ setTabs('employees'); qs('#searchInput').value = b.dataset.q; renderTable(); });
      });

      // Filters & pager
      qs('#searchInput').addEventListener('input', ()=>{ page=1; renderTable(); });
      qs('#deptFilter').addEventListener('change', ()=>{ page=1; renderTable(); });
      qs('#prevPage').addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      qs('#nextPage').addEventListener('click', ()=>{ const filtered=applyFilters(rows); if(page*pageSize<filtered.length){ page++; renderTable(); } });

      // Grid delegation (edit/delete + reveal/hide pin)
      document.addEventListener('click', async (ev) => {
        const revealBtn = ev.target.closest('[data-reveal]');
        const hideBtn   = ev.target.closest('[data-hide]');
        const editBtn   = ev.target.closest('[data-edit]');
        const delBtn    = ev.target.closest('[data-del]');

        if (revealBtn){
          const id = revealBtn.getAttribute('data-reveal');
          const span = qs(`#pin-val-${id}`); if (span) span.textContent='…';
          try{
            const pin = await revealPin(id);
            span.textContent = pin || '—';
          }catch(err){
            console.error('[REVEAL_PIN]', err);
            span.textContent = 'ERR';
            showCustomAlert('PIN reveal failed. Ensure RPC admin_reveal_employee_pin exists and you have privileges.', 'PIN Reveal Failed');
          }
          return;
        }
        if (hideBtn){
          const id = hideBtn.getAttribute('data-hide');
          const span = qs(`#pin-val-${id}`); if (span) span.textContent='••••';
          return;
        }
        if (editBtn){
          const id = editBtn.getAttribute('data-edit');
          const row = rows.find(x => String(x.id) === String(id));
          if (row) openModal(row);
          return;
        }
        if (delBtn){
          const id = delBtn.getAttribute('data-del'); if (!id) return;
          const btn = delBtn;
          const row = rows.find(r => String(r.id) === String(id));
          const who = nameFromRow(row) || 'this employee';
          if (!await showCustomConfirm(`Delete ${who}? This cannot be undone.`, 'Confirm Deletion', 'Delete Record')) return;

          const original = btn.textContent;
          btn.disabled = true; btn.textContent = 'Deleting…';
          try { await deleteEmployeeById(id); await reloadData(); }
          catch (err) { console.error('[ROW_DELETE]', err); await showCustomAlert(`Delete failed: ${err.message || err}`, 'Delete Failed'); }
          finally { btn.disabled = false; btn.textContent = original; }
        }
      });

      // Open/close modal
      qs('#addEmployeeCard').addEventListener('click', ()=>openModal(null));
      qs('#closeModal').addEventListener('click', ()=>empModal.close());

      // Modal selects
      qs('#dept').addEventListener('change', fillPositionOptions);
      qs('#positionSel').addEventListener('change', e=>toggleCustom(e.target, 'positionCustom'));

      // Modal save
      empForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const saveBtn = e.submitter;
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Processing…'; }

        try{
          const isUpdate = qs('#empId').value || null;
          let savedRow;
          if(isUpdate){ savedRow = await updateEmployeeFromForm(isUpdate); }
          else { savedRow = await insertEmployeeFromForm(); }

          const targetId = savedRow[COLS.id];
          let uChanged=false, pChanged=false;

          // Access updates
          const desiredUsername = sanitizeUsername(qs('#uName').value);
          const prior = rows.find(r=>String(r.id)===String(targetId));
          const prevU = prior ? (prior.username||'') : (savedRow.username||'');
          const usernameNeedsUpdate = (desiredUsername || '') !== (prevU || '');

          const newPin  = (qs('#pinNew').value || '').trim();
          const newPin2 = (qs('#pinNew2').value || '').trim();
          let pinVal = null;

          if (newPin || newPin2){
            if (newPin !== newPin2) throw new Error('New PIN and Confirm PIN do not match.');
            if (!validPinFormat(newPin)) throw new Error('PIN must be 4–8 digits (0–9).');
            pinVal = newPin;
          }

          if (usernameNeedsUpdate || pinVal !== null){
            const res = await updateAccess(targetId, usernameNeedsUpdate ? desiredUsername : null, pinVal);
            uChanged = !!res.uOk; pChanged = !!res.pOk;
          }

          empModal.close();
          await reloadData();

          let msg = 'Employee record saved successfully.';
          if (uChanged && pChanged) msg = 'Employee record, username, and PIN updated successfully.';
          else if (uChanged) msg = 'Employee record and username updated successfully.';
          else if (pChanged) msg = 'Employee record and PIN updated successfully.';
          await showCustomAlert(msg, 'Save Complete');
        }catch(err){
          console.error(err);
          await showCustomAlert(err.message || 'Save failed. Check console for details.', 'Save Failed');
        }finally{
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
        }
      });

      // Employees: Reveal all / Hide all / Export CSV
      qs('#revealAllPins').addEventListener('click', async ()=>{
        if (!await showCustomConfirm('Reveal PINs for all employees shown in the grid?', 'Confirm PIN Reveal', 'Reveal')) return;
        const filtered = applyFilters(rows);
        for (const r of filtered){
          const span = qs(`#pin-val-${r.id}`); if (span) span.textContent='…';
          try{ const pin = await revealPin(r.id); if (span) span.textContent = pin || '—'; }
          catch(err){ if (span) span.textContent='ERR'; console.error('[REVEAL_ALL]', err); }
        }
        await showCustomAlert('PINs revealed for current grid (where available).', 'Reveal Complete', 'OK');
      });
      qs('#hideAllPins').addEventListener('click', ()=>{
        applyFilters(rows).forEach(r=>{ const el=qs(`#pin-val-${r.id}`); if (el) el.textContent='••••'; });
      });
      qs('#exportGridCsv').addEventListener('click', ()=>{
        const filtered = applyFilters(rows);
        const out = filtered.map(r=>({
          id: r.id,
          name: nameFromRow(r),
          department: r.department||'',
          position: r.position||'',
          username: r.username||'',
          pin: PIN_CACHE.get(String(r.id)) || '',
          status: r.status||'',
          email: r.email||'',
          manager: r.report_to||''
        }));
        const csv = toCsv(out);
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'employees_grid.csv'; a.click(); URL.revokeObjectURL(url);
      });

      // Reports: Audit filters
      qs('#loadAuditBtn').addEventListener('click', loadAuditUI);
      qs('#exportAuditCsv').addEventListener('click', ()=>{
        const csv = toCsv(LAST_AUDIT_ROWS);
        const blob = new Blob([csv], {type:'text/csv'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = 'access_audit.csv'; a.click(); URL.revokeObjectURL(url);
      });
    });

    // ================== DATA LOAD ==================
   async function reloadData(){
  qs('#serverStatus').textContent='pending'; 
  qs('#serverStatus').className='ml-1 font-semibold text-yellow-700';

  const list = await fetchEmployees();
  
  let meta = [];
  try {
    const { data: metaData, error: metaErr } = await supabase.rpc('admin_auth_meta', { 
      p_admin_id: session?.admin_id || null 
    });
    if (!metaErr) meta = metaData || [];
  } catch (_) {}

  const metaMap = new Map(meta.map(m => [String(m.id), m]));

 rows = list.map(r => {
  const m = metaMap.get(String(r.id));
  return {
    ...r,
    // Merge username, prioritizing auth meta if employee table field is null
    username: r[COLS.username] || m?.username || '', 
    email: r[COLS.email] || m?.email || '',
    // Merge PIN status/hint, prioritizing auth meta
    has_pin: r[COLS.has_pin] ?? m?.has_pin ?? false,
    pin_hint_last2: r[COLS.pin_hint] || m?.pin_hint_last2
  };
});

      ALL_EMP_NAMES = rows
        .map(r => ({ id: r.id, name: nameFromRow(r) }))
        .filter(x => x.name)
        .sort((a,b) => a.name.localeCompare(b.name));

      renderKPIs(rows);
      renderTable();
      populateAuditSelectors();
      qs('#serverStatus').textContent='ok'; 
      qs('#serverStatus').className='ml-1 font-semibold text-green-700';
    }

    function populateAuditSelectors(){
      const sel = qs('#auditEmployee');
      const cur = sel.value;
      sel.innerHTML = `<option value="">All</option>` + ALL_EMP_NAMES.map(e=>`<option value="${e.id}">${e.name}</option>`).join('');
      if (cur){ sel.value = cur; }
    }

    async function loadAuditUI(){
      const empId = qs('#auditEmployee').value || null;
      const action = qs('#auditAction').value || null;
      const start  = qs('#auditStart').value || null;
      const end    = qs('#auditEnd').value || null;
      const limit  = parseInt(qs('#auditLimit').value || '50', 10);

      const tbody = qs('#auditTbody');
      tbody.innerHTML = `<tr><td colspan="5" class="py-6 text-center text-jc-muted">Loading…</td></tr>`;
      const rows = await fetchAudit({
        employee_id: empId, // UUIDs should be passed as strings or null
        action, since: start ? new Date(start).toISOString() : null,
        until: end ? new Date(new Date(end).getTime()+24*3600*1000-1).toISOString() : null,
        limit
      });

      LAST_AUDIT_ROWS = rows.map(a=>({
        timestamp: a.created_at || a.ts || a.timestamp || '',
        employee_id: a.employee_id || '',
        employee: a.employee_name || a.employee || '',
        action: a.action || a.event || '',
        by: a.admin_name || a.actor_name || a.admin_username || a.actor || 'system',
        details: a.details || a.detail || ''
      }));

      if (!LAST_AUDIT_ROWS.length){
        tbody.innerHTML = `<tr><td colspan="5" class="py-6 text-center text-jc-muted">No results</td></tr>`;
        return;
      }

      tbody.innerHTML = LAST_AUDIT_ROWS.map(a=>`
        <tr>
          <td class="align-top">${a.timestamp}</td>
          <td class="align-top">${a.employee || ('#'+a.employee_id)}</td>
          <td class="align-top"><span class="pill">${a.action}</span></td>
          <td class="align-top">${a.by}</td>
          <td class="align-top">${a.details||''}</td>
        </tr>
      `).join('');
    }
  </script>
</body>
</html>

