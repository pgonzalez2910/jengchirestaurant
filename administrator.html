<!DOCTYPE html>
<html lang="en" class="h-full bg-[#F7F5F1]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeng Chi — Executive Administrator Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A','jc-muted':'#6B7280','jc-gold':'#B9965A','jc-border':'#E5E4E2','jc-bg':'#F7F5F1',
            'jc-danger':'#B91C1C','jc-success':'#166534','jc-warn':'#92400E'
          },
          boxShadow: { 'soft':'0 14px 30px -14px rgba(15,23,42,0.15)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .input{ @apply w-full rounded-xl border border-jc-border bg-white px-3 py-2 text-jc-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/35; }
    .btn{ @apply inline-flex items-center justify-center rounded-xl px-3.5 py-2 font-medium shadow-sm transition; }
    .btn-gold{ @apply bg-jc-gold text-white hover:brightness-95; }
    .btn-ghost{ @apply bg-white border border-jc-border text-jc-ink hover:bg-jc-bg; }
    .btn-danger{ @apply bg-red-600 text-white hover:bg-red-700; }
    .tag{ @apply inline-flex items-center rounded-full border border-jc-border bg-white px-2.5 py-1 text-xs font-medium text-jc-muted; }
    .tab{ @apply px-4 py-2 rounded-xl text-sm font-medium cursor-pointer border border-transparent hover:bg-white/60; }
    .tab-active{ @apply bg-white border-jc-border shadow-soft; }
    .label{ @apply text-sm font-semibold text-jc-ink; }
    .banner{ @apply rounded-xl border px-3 py-2 text-sm; }
    dialog::backdrop{ background: rgba(15,23,42,.35); }
    .hint{ @apply text-xs text-jc-muted; }
    .link-danger{ @apply text-red-700 hover:text-red-800 underline underline-offset-2; }
    .loader-spin { border: 2px solid rgba(255, 255, 255, 0.4); border-top: 2px solid white; border-radius: 50%; width: 1em; height: 1em; animation: spin 1s linear infinite; margin-right: 0.5rem; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <div class="min-h-full">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 bg-jc-bg/75 backdrop-blur border-b border-jc-border">
      <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/jengchilogo.jpg" alt="Jeng Chi" class="h-10 w-10 rounded-xl object-cover border border-jc-border">
          <div>
            <div class="text-xl font-serif-head">Jeng Chi — Administrator Portal</div>
            <div class="text-xs text-jc-muted">Corporate • Business • Executive • Professional • Enterprise</div>
          </div>
        </div>
        <div id="userBox" class="hidden items-center gap-3">
          <span id="adminName" class="text-sm text-jc-muted"></span>
          <button id="logoutBtn" class="btn btn-ghost">Log out</button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <!-- ===== AUTH CARD ===== -->
      <section id="authSection" class="max-w-4xl mx-auto py-10 md:py-20">
        <div class="flex flex-col md:flex-row bg-white rounded-3xl border border-jc-border shadow-2xl overflow-hidden min-h-[400px]">
          <!-- Left (Branding) -->
          <div class="w-full md:w-2/5 p-8 bg-jc-ink flex flex-col justify-between">
            <div>
              <h1 class="text-3xl font-serif-head text-white mb-3">Executive Access Portal</h1>
              <p class="text-sm text-gray-400 border-l-2 border-jc-gold pl-3 py-1">Secure authentication for proprietary employee data. Enter your credentials to manage personnel records and view corporate analytics.</p>
            </div>
            <img src="https://placehold.co/100x100/0F172A/B9965A?text=JC+Corporate" alt="Jeng Chi Corporate System" class="h-16 w-16 opacity-70 mt-6 self-start md:self-end">
          </div>

          <!-- Right (Form) -->
          <div class="w-full md:w-3/5 p-8 flex flex-col justify-center">
            <h2 class="text-2xl font-serif-head font-semibold mb-1 text-jc-ink">Sign In</h2>
            <p class="text-sm text-jc-muted mb-6">Verify your dedicated Administrator account details.</p>

            <div id="authBanner" class="hidden banner mb-4"></div>

            <form id="loginForm" class="space-y-5" autocomplete="off">
              <div>
                <label class="label">Username</label>
                <input id="username" class="input" placeholder="Your corporate username" required />
              </div>

              <div>
                <label class="label">PIN</label>
                <div class="relative">
                  <input id="pin" class="input pr-12 tracking-widest" type="password" placeholder="••••" inputmode="numeric" minlength="4" maxlength="8" required />
                  <button type="button" id="togglePin" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
                </div>
              </div>

              <button id="signInBtn" class="btn btn-gold w-full flex items-center justify-center" type="submit">
                <span id="signInText">Secure Sign In</span>
                <span id="signInSpin" class="hidden flex items-center">
                  <span class="loader-spin"></span> Authenticating…
                </span>
              </button>

              <div class="text-[10px] text-jc-muted text-center leading-relaxed mt-3">
                Security Policy: 5 failed attempts trigger a temporary lock (10 minutes).
              </div>
            </form>
          </div>
        </div>
      </section>

      <!-- ===== APP ===== -->
      <section id="appSection" class="hidden">
        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button data-tab="dashboard" class="tab tab-active">Dashboard</button>
          <button data-tab="employees" class="tab">Personnel Management</button>
          <button data-tab="reports" class="tab">Reports</button>
          <button data-tab="settings" class="tab">Settings</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">Total Employees</div>
              <div id="kpiTotal" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">FOH</div>
              <div id="kpiFOH" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">BOH</div>
              <div id="kpiBOH" class="text-3xl font-semibold">—</div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-3">Quick Filters</h3>
            <div class="flex flex-wrap gap-2">
              <button class="tag" data-q="FOH">FOH</button>
              <button class="tag" data-q="BOH">BOH</button>
              <button class="tag" data-q="Server">Server</button>
              <button class="tag" data-q="Line Cook">Line Cook</button>
              <button class="tag" data-q="">Clear</button>
            </div>
          </div>
        </div>

        <!-- Employees -->
        <div id="tab-employees" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="flex flex-col md:flex-row md:items-end gap-3">
              <div class="grow">
                <label class="label">Search Employees</label>
                <input id="searchInput" class="input" type="text" placeholder="Name, department, email, position, username…" />
              </div>
              <div class="w-full md:w-auto flex gap-2">
                <select id="deptFilter" class="input">
                  <option value="">All Departments</option>
                  <option value="FOH">FOH</option>
                  <option value="BOH">BOH</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Card Grid -->
          <div id="empGrid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            <!-- Add Card -->
            <div id="addEmployeeCard" class="bg-jc-gold/5 border-2 border-dashed border-jc-gold/30 rounded-2xl p-5 shadow-soft hover:bg-jc-gold/10 transition cursor-pointer flex flex-col items-center justify-center text-center h-[200px]">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-jc-gold mb-2">
                <path stroke-linecap="round" stroke-linejoin="round" d="M19 7.5v3m0 0v3m0-3h3m-3 0h-3m-3-1.5a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM3.751 20.105a8.25 8.25 0 0 1 16.498 0 .75.75 0 0 1-.437.695A18.023 18.023 0 0 1 12 21.75c-3.18 0-6.23-.42-9.201-1.05a.75.75 0 0 1-.437-.695Z" />
              </svg>
              <h4 class="text-jc-gold font-semibold">Add New Personnel</h4>
              <p class="text-xs text-jc-muted">Click to onboard a new employee.</p>
            </div>
          </div>

          <div class="flex items-center justify-between pt-3 border-t border-jc-border mt-4">
            <div id="rowsInfo" class="text-xs text-jc-muted"></div>
            <div class="flex gap-2">
              <button id="prevPage" class="btn btn-ghost text-sm">Prev</button>
              <button id="nextPage" class="btn btn-ghost text-sm">Next</button>
            </div>
          </div>
        </div>

        <!-- Reports -->
        <div id="tab-reports" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Status</h3>
            <div class="flex items-center gap-2">
              <span class="tag">Server: <span id="serverStatus" class="ml-1 font-semibold text-yellow-700">pending</span></span>
            </div>
            <p class="text-sm text-jc-muted mt-2">Reserved for PDF/CSV reports and admin analytics.</p>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab-settings" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Configuration</h3>
            <ul class="list-disc ml-5 text-sm text-jc-muted space-y-1">
              <li>Admins table: <code>public.administrators</code></li>
              <li>Login RPC: <code>public.admin_login(p_username, p_pin)</code></li>
              <li>Read from <code>public.employees_admin</code> when available</li>
              <li>Access RPC: <code>public.admin_update_employee_access(p_admin_id, p_employee_id, p_username, p_pin)</code> (preferred)</li>
              <li>PIN RPC (fallback): <code>public.admin_set_employee_pin(p_emp_id, p_pin, p_admin_id)</code></li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Employee Modal -->
  <dialog id="empModal" class="rounded-2xl w-full max-w-4xl p-0 border border-jc-border shadow-soft">
    <form id="empForm" class="bg-white rounded-2xl p-8 space-y-8" method="dialog">
      <div class="flex items-start justify-between gap-3 border-b pb-4 border-jc-border/70">
        <div>
          <h3 id="empModalTitle" class="text-xl font-serif-head text-jc-ink">Personnel Record Management</h3>
          <p class="text-sm text-jc-muted mt-1">Update employee data and employment status.</p>
        </div>
        <button type="button" id="closeModal" class="btn btn-ghost text-sm">Close</button>
      </div>

      <!-- GRID: 3 columns -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <!-- Personal -->
        <div class="space-y-4">
          <h4 class="text-sm font-semibold text-jc-ink pb-1 border-b border-jc-border/50">Personal Identity</h4>
          <div>
            <label class="label">First Name</label>
            <input id="fName" class="input" required />
          </div>
          <div>
            <label class="label">Last Name</label>
            <input id="lName" class="input" />
          </div>
          <div>
            <label class="label">Phone Number</label>
            <input id="phone" type="tel" class="input" placeholder="(123) 456-7890" />
          </div>
        </div>

        <!-- Contact & Access -->
        <div class="space-y-4">
          <h4 class="text-sm font-semibold text-jc-ink pb-1 border-b border-jc-border/50">Contact & Access</h4>

          <div>
            <label class="label">System Username</label>
            <input id="uName" class="input" placeholder="e.g., jengchi.admin" />
            <p id="uNameWarn" class="hidden hint mt-1"></p>
          </div>

          <div>
            <label class="label">Email (Work)</label>
            <input id="eMail" type="email" class="input" placeholder="unique@jengchirestaurant.com" />
            <p id="emailWarn" class="hidden hint mt-1"></p>
          </div>

          <div>
            <label class="label">Department</label>
            <select id="dept" class="input" required>
              <option value="FOH">FOH - Front of House</option>
              <option value="BOH">BOH - Back of House</option>
            </select>
          </div>

          <div class="pt-2">
            <span class="text-xs text-jc-muted">Employee ID: <span id="displayEmpId" class="font-semibold">N/A</span></span>
          </div>
        </div>

        <!-- Role & Status -->
        <div class="space-y-4">
          <h4 class="text-sm font-semibold text-jc-ink pb-1 border-b border-jc-border/50">Role & Status</h4>

          <div>
            <label class="label">Position/Role</label>
            <select id="positionSel" class="input"></select>
            <input id="positionCustom" class="input mt-2 hidden" placeholder="Type custom position…" />
          </div>

          <div>
            <label class="label">Reports To (Manager)</label>
            <select id="reportToSel" class="input"></select>
            <input id="reportToCustom" class="input mt-2 hidden" placeholder="Type manager name…" />
          </div>

          <div>
            <label class="label">Status</label>
            <select id="status" class="input" required>
              <option value="Active">Active</option>
              <option value="Leave">On Leave</option>
              <option value="Terminated">Terminated</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Security -->
      <div class="space-y-3 md:col-span-3 border-t border-jc-border/70 pt-6">
        <h4 class="text-sm font-semibold text-jc-ink">Security — Access & PIN Management</h4>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="label text-jc-muted">Current System ID (Read Only)</label>
            <div id="currentSystemId" class="text-sm font-mono p-2 border border-jc-border rounded-xl bg-jc-bg text-jc-ink/70">N/A</div>
          </div>

          <div>
            <label class="label text-jc-muted">PIN Status</label>
            <div id="pinStatus" class="text-sm font-medium p-2 rounded-xl border">Unconfigured</div>
          </div>
          <div></div>
        </div>

        <p class="hint">Use the fields below to **set a new PIN** (4–8 digits). Leaving them blank keeps the current PIN.</p>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="label">New PIN</label>
            <div class="relative">
              <input id="pinNew" class="input pr-12 tracking-widest" type="password" inputmode="numeric" minlength="4" maxlength="8" placeholder="••••" />
              <button type="button" id="togglePinNew" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
            </div>
          </div>

          <div>
            <label class="label">Confirm PIN</label>
            <div class="relative">
              <input id="pinNew2" class="input pr-12 tracking-widest" type="password" inputmode="numeric" minlength="4" maxlength="8" placeholder="••••" />
              <button type="button" id="togglePinNew2" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
            </div>
          </div>

          <div class="flex items-end">
            <div class="text-[11px] text-jc-muted leading-relaxed">
              • Only digits (0–9).<br>
              • 4–8 characters.<br>
              • Hashed in the database; admins cannot view the actual PIN.
            </div>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end pt-4 border-t border-jc-border/70">
        <div class="flex gap-3">
          <button type="button" id="deleteEmp" class="btn btn-danger hidden">Delete Record</button>
          <button type="submit" class="btn btn-gold">Save Changes</button>
        </div>
      </div>

      <input type="hidden" id="empId" />
    </form>
  </dialog>

  <!-- Confirm Modal -->
  <dialog id="confirmModal" class="rounded-2xl w-full max-w-sm p-5 border border-jc-border shadow-soft">
    <h3 id="confirmTitle" class="text-lg font-semibold mb-2 text-jc-ink">Confirmation</h3>
    <p id="confirmMessage" class="text-sm text-jc-ink mb-6">Are you sure?</p>
    <div class="flex justify-end gap-3">
      <button id="confirmCancel" class="btn btn-ghost text-sm">Cancel</button>
      <button id="confirmOK" class="btn btn-danger text-sm">OK</button>
    </div>
  </dialog>

  <script>
    // ================== SUPABASE ==================
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================== STATIC LISTS ==================
    const FOH_POSITIONS = ["Server","Bartender Jr","Bartender","Cashier","Host","Manager on Duty","Custom…"];
    const BOH_POSITIONS = ["Dumpling Maker","Line Cook","Kitchen Prep","Busser","Dishwasher","Pastry Chef","Noodle Maker","Custom…"];
    const CORE_MANAGERS = ["Janelle Teng","Pablo Gonzalez","Craig Reeves","Shoko Teng","Mai Vu","Custom…"];

    // ================== STATE ==================
    let session = null;
    let page = 1;
    const pageSize = 12;
    let rows = [];
    let READ_SOURCE = 'employees_admin';
    let ALL_EMP_NAMES = [];

    // Write schema map for public.employees
    let COLS = {
      nameMode: 'single',
      single: 'full_name',
      first: 'first_name',
      last:  'last_name',
      username: 'username',
      email: 'email',
      dept:  'department',
      position: 'position',
      reportTo: 'report_to',
      status: 'status',
      phone: 'phone',
      has_pin: 'has_pin',
      id: 'id'
    };

    // ================== HELPERS ==================
    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
    const setTabs=(active)=>{ qsa('.tab').forEach(b=>{const t=b.dataset.tab; b.classList.toggle('tab-active',t===active); qs('#tab-'+t).classList.toggle('hidden',t!==active);}); localStorage.setItem('jc-active-tab',active);};
    const paginate=(arr,p,s)=>Array.isArray(arr)?arr.slice((p-1)*s,(p-1)*s+s):[];
    const banner=(type,msg)=>{ const box=qs('#authBanner'); const map={error:'border-red-200 bg-red-50 text-red-800', ok:'border-emerald-200 bg-emerald-50 text-emerald-800', info:'border-slate-200 bg-white text-slate-700'}; box.className=`banner ${map[type]||map.info}`; box.textContent=msg; box.classList.remove('hidden'); };
    const clearBanner=()=>qs('#authBanner').classList.add('hidden');

    function nameFromRow(r){
      if(READ_SOURCE==='employees_admin') return r.full_name || '';
      if (COLS.nameMode==='single') return r[COLS.single] || '';
      const a=r[COLS.first]||'', b=r[COLS.last]||''; return [a,b].filter(Boolean).join(' ').trim();
    }
    function sortByName(a,b){ return nameFromRow(a).localeCompare(nameFromRow(b)); }

    // Username formatting & checks
    const sanitizeUsername = (u) => (u||'').trim().toLowerCase().replace(/[^a-z0-9._-]/g,'');
    const validUsername = (u) => /^[a-z0-9._-]{2,32}$/.test(u||'');

    function validPinFormat(pin){ return /^[0-9]{4,8}$/.test(pin || ''); }

    // Custom dialogs
    const confirmModal = qs('#confirmModal');
    const confirmTitle = qs('#confirmTitle');
    const confirmMessage = qs('#confirmMessage');
    const confirmCancel = qs('#confirmCancel');
    const confirmOK = qs('#confirmOK');

    function showCustomAlert(message, title = 'Error', okText = 'OK') {
      return new Promise(resolve => {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmTitle.classList.toggle('text-jc-danger', /error|failed/i.test(title));
        confirmCancel.classList.add('hidden');
        confirmOK.textContent = okText;
        confirmOK.classList.remove('btn-danger');
        confirmOK.classList.add('btn-gold');
        confirmOK.onclick = () => { confirmModal.close(); resolve(true); };
        confirmModal.showModal();
      });
    }
    function showCustomConfirm(message, title = 'Confirm Action', okText = 'Delete') {
      return new Promise(resolve => {
        confirmTitle.textContent = title;
        confirmMessage.textContent = message;
        confirmTitle.classList.add('text-jc-danger');
        confirmCancel.classList.remove('hidden');
        confirmOK.textContent = okText;
        confirmOK.classList.add('btn-danger');
        confirmOK.classList.remove('btn-gold');
        confirmOK.onclick = () => { confirmModal.close(); resolve(true); };
        confirmCancel.onclick = () => { confirmModal.close(); resolve(false); };
        confirmModal.showModal();
      });
    }

    // PIN RPCs
    async function setEmployeePin(empId, pin){
      const adminId = session?.admin_id || null;
      // Preferred: single RPC that can also set username (we’ll still call it here when only PIN changed)
      try{
        const { data, error } = await supabase.rpc('admin_update_employee_access', {
          p_admin_id: adminId, p_employee_id: empId, p_username: null, p_pin: String(pin)
        });
        if (error) throw error;
        return true;
      }catch(err){
        // Fallback: legacy PIN-only function
        if (err?.code === 'PGRST202' || /not found|function .* does not exist/i.test(err?.message||'')){
          const { data, error } = await supabase.rpc('admin_set_employee_pin', {
            p_emp_id: empId, p_pin: String(pin), p_admin_id: adminId
          });
          if (error) throw error;
          return true;
        }
        throw err;
      }
    }

    async function updateAccess(empId, newUsernameOrNull, newPinOrNull){
      const adminId = session?.admin_id || null;
      let uOk=false, pOk=false;

      // Try consolidated RPC first
      try{
        const { data, error } = await supabase.rpc('admin_update_employee_access', {
          p_admin_id: adminId,
          p_employee_id: empId,
          p_username: newUsernameOrNull,
          p_pin: newPinOrNull
        });
        if (error) throw error;
        uOk = newUsernameOrNull !== null;
        pOk = newPinOrNull !== null;
        return { uOk, pOk };
      }catch(err){
        // Fallbacks
        if (err?.code !== 'PGRST202' && !/not found|does not exist/i.test(err?.message||'')){
          // Unknown error from preferred RPC, bubble up
          throw err;
        }
        // Username fallback (direct update)
        if (newUsernameOrNull !== null){
          const { error: uErr } = await supabase.from('employees').update({ username: newUsernameOrNull }).eq(COLS.id, empId);
          if (uErr) throw uErr;
          uOk = true;
        }
        // PIN fallback
        if (newPinOrNull !== null){
          await setEmployeePin(empId, newPinOrNull);
          pOk = true;
        }
        return { uOk, pOk };
      }
    }

    // Username/email helpers
    async function findByEmail(email){
      const e = (email||'').trim().toLowerCase();
      if(!e) return null;
      const { data } = await supabase.from('employees').select('*').ilike('email', e).limit(1);
      return (data && data[0]) || null;
    }
    async function findByUsername(username){
      const u = sanitizeUsername(username);
      if(!u) return null;
      const { data } = await supabase.from('employees').select('*').ilike('username', u).limit(1);
      return (data && data[0]) || null;
    }
    function showFieldError(el, msg){ el.setCustomValidity(msg||''); el.reportValidity(); }

    async function ensureUniqueEmailOrOpen(email){
      const existing = await findByEmail(email);
      if(!existing) return { ok:true };
      if (await showCustomConfirm('That email is already used by another employee. Open that record to edit?', 'Duplicate Email Detected', 'Open Record')){
        openModal(existing);
      }
      return { ok:false, message:'Duplicate email' };
    }
    async function ensureUniqueUsernameOrOpen(username, selfId){
      const existing = await findByUsername(username);
      if(!existing) return { ok:true };
      if (String(existing.id) === String(selfId)) return { ok:true }; // same person
      if (await showCustomConfirm('That username is already used by another employee. Open that record to edit?', 'Duplicate Username Detected', 'Open Record')){
        openModal(existing);
      }
      return { ok:false, message:'Duplicate username' };
    }

    // ================== AUTH ==================
    const authSection = qs('#authSection');
    const appSection  = qs('#appSection');
    const userBox     = qs('#userBox');
    const adminNameEl = qs('#adminName');

    async function rpcAdminLogin(username, pin){
      if(!/^[a-z0-9._-]{2,32}$/i.test(username)) throw { friendly:'Invalid username format.' };
      if(!/^[0-9]{4,8}$/.test(pin)) throw { friendly:'PIN must be 4–8 digits.' };
      const { data, error } = await supabase.rpc('admin_login', { p_username: username, p_pin: pin });
      if(error) throw error;
      if(!data || !data.length) return null;
      return data[0];
    }
    function showApp(profile){
      const uname = profile.admin_username || profile.username || 'Administrator';
      adminNameEl.textContent = `${uname} — Administrator`;
      userBox.classList.remove('hidden'); authSection.classList.add('hidden'); appSection.classList.remove('hidden');
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');
    }
    function showAuth(){ userBox.classList.add('hidden'); authSection.classList.remove('hidden'); appSection.classList.add('hidden'); }

    // ================== SOURCE / SCHEMA DETECTION ==================
    async function detectReadSource(){
      let res = await supabase.from('employees_admin').select('*').limit(1);
      READ_SOURCE = res.error ? 'employees' : 'employees_admin';
    }
    async function detectEmployeesSchema(){
      const { data, error } = await supabase.from('employees').select('*').limit(1);
      if(error) return;
      const row  = (data && data[0]) || {};
      const keys = Object.keys(row);
      const has  = k => keys.includes(k);

      COLS.id = has('id') ? 'id' : COLS.id;

      if (has('full_name') || has('name')) {
        COLS.nameMode='single'; COLS.single = has('full_name') ? 'full_name' : 'name';
      } else {
        COLS.nameMode='split';
        COLS.first = has('first_name') ? 'first_name' : has('fname') ? 'fname' : has('first') ? 'first' : 'first_name';
        COLS.last  = has('last_name')  ? 'last_name'  : has('lname') ? 'lname' : has('last')  ? 'last'  : 'last_name';
      }

      COLS.username = has('username') ? 'username' : 'username';
      COLS.email    = has('email') ? 'email' : has('work_email') ? 'work_email' : 'email';
      COLS.dept     = has('department') ? 'department' : has('dept') ? 'dept' : 'department';
      COLS.position = has('position') ? 'position' : has('role') ? 'role' : has('primary_role') ? 'primary_role' : 'position';
      COLS.reportTo = has('report_to') ? 'report_to'
                    : has('manager') ? 'manager'
                    : has('Current Reports To Employee') ? 'Current Reports To Employee'
                    : 'report_to';
      COLS.status   = has('status') ? 'status' : has('employment_status') ? 'employment_status' : 'status';
      COLS.phone    = has('phone') ? 'phone' : has('contact_phone') ? 'contact_phone' : 'phone';
    }

    // ================== CRUD ==================
    async function fetchEmployees(){
      const { data, error } = await supabase.from(READ_SOURCE).select('*');
      if(error){ console.error(error); return []; }
      return (data || []).sort(sortByName);
    }

    function collectPositionValue(){
      const sel = qs('#positionSel').value;
      return sel === '__custom__' ? qs('#positionCustom').value.trim() : sel;
    }
    function collectReportToValue(){
      const sel = qs('#reportToSel').value;
      return sel === '__custom__' ? qs('#reportToCustom').value.trim() : sel;
    }

    async function insertEmployeeFromForm(){
      const emailEl = qs('#eMail');
      const userEl  = qs('#uName');

      const rawU = sanitizeUsername(userEl.value);
      if (rawU && !validUsername(rawU)) { showFieldError(userEl,'Username must be 2–32 chars [a-z0-9._-].'); throw new Error('Invalid username'); }

      const email = (emailEl.value||'').trim().toLowerCase();

      const uok = rawU ? await ensureUniqueUsernameOrOpen(rawU) : { ok:true };
      if(!uok.ok){ showFieldError(userEl, uok.message); throw new Error(uok.message); }
      showFieldError(userEl,'');

      const eok = email ? await ensureUniqueEmailOrOpen(email) : { ok:true };
      if(!eok.ok){ showFieldError(emailEl, eok.message); throw new Error(eok.message); }
      showFieldError(emailEl,'');

      const row = {};
      if (COLS.nameMode==='single'){
        row[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        row[COLS.first]  = qs('#fName').value.trim();
        row[COLS.last]   = qs('#lName').value.trim();
      }
      row[COLS.username] = rawU || null;
      row[COLS.email]    = email || null;
      row[COLS.phone]    = qs('#phone').value.trim() || null;
      row[COLS.dept]     = qs('#dept').value.split(' - ')[0];
      row[COLS.position] = collectPositionValue();
      row[COLS.reportTo] = collectReportToValue();
      row[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').insert(row).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }

    async function updateEmployeeFromForm(id){
      const emailEl = qs('#eMail');
      const userEl  = qs('#uName');

      const rawU = sanitizeUsername(userEl.value);
      if (rawU && !validUsername(rawU)) { showFieldError(userEl,'Username must be 2–32 chars [a-z0-9._-].'); throw new Error('Invalid username'); }

      // Username uniqueness (respect same record)
      const existingUser = await findByUsername(rawU);
      if(existingUser && String(existingUser[COLS.id]) !== String(id)){
        if (await showCustomConfirm('That username is used by another employee. Open that record to edit instead?', 'Duplicate Username Detected','Open Record')){
          openModal(existingUser);
        }
        throw new Error('Duplicate username');
      }
      showFieldError(userEl,'');

      const email = (emailEl.value||'').trim().toLowerCase();
      const existingMail = await findByEmail(email);
      if(existingMail && String(existingMail[COLS.id]) !== String(id)){
        if (await showCustomConfirm('That email is used by another employee. Open that record to edit instead?', 'Duplicate Email Detected','Open Record')){
          openModal(existingMail);
        }
        throw new Error('Duplicate email');
      }
      showFieldError(emailEl,'');

      const patch = {};
      if (COLS.nameMode==='single'){
        patch[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        patch[COLS.first]  = qs('#fName').value.trim();
        patch[COLS.last]   = qs('#lName').value.trim();
      }
      // NOTE: username is handled via RPC (admin-gated) for security; we don't include it in patch here.
      patch[COLS.email]    = email || null;
      patch[COLS.phone]    = qs('#phone').value.trim() || null;
      patch[COLS.dept]     = qs('#dept').value.split(' - ')[0];
      patch[COLS.position] = collectPositionValue();
      patch[COLS.reportTo] = collectReportToValue();
      patch[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').update(patch).eq(COLS.id, id).select().single();
      if(error){ console.error(error); throw error; }
      // Return updated base row + the desired username (for subsequent access RPC)
      data.desired_username = rawU || null;
      return data;
    }

    async function deleteEmployeeById(id){
      const { error } = await supabase.from('employees').delete({ returning:'minimal' }).eq(COLS.id, id);
      if(error) throw error;
    }

    // ================== RENDER ==================
    function renderKPIs(list){
      const total = list.length;
      const foh = list.filter(r=>(r.department||'').toUpperCase()==='FOH').length;
      const boh = list.filter(r=>(r.department||'').toUpperCase()==='BOH').length;
      qs('#kpiTotal').textContent = total;
      qs('#kpiFOH').textContent   = foh;
      qs('#kpiBOH').textContent   = boh;
    }

    function applyFilters(source){
      const q = (qs('#searchInput').value||'').trim().toLowerCase();
      const dept = qs('#deptFilter').value;
      return source.filter(r=>{
        const hay = [
          nameFromRow(r), r.email, r.position, r.department, r.report_to, r.status, r.username
        ].join(' ').toLowerCase();
        const passQ = q ? hay.includes(q) : true;
        const passD = dept ? (String(r.department||'')===dept) : true;
        return passQ && passD;
      });
    }

    function getStatusClass(status) {
      status = status ? status.toLowerCase() : '';
      if (status.includes('active')) return 'bg-green-50 text-green-700 ring-green-600/20';
      if (status.includes('leave')) return 'bg-yellow-50 text-yellow-800 ring-yellow-600/20';
      if (status.includes('terminated')) return 'bg-red-50 text-red-700 ring-red-600/20';
      return 'bg-gray-50 text-gray-700 ring-gray-600/20';
    }

    function renderEmployeeCard(r) {
      const name = nameFromRow(r);
      const statusClass = getStatusClass(r.status);
      const u = r.username || '—';
      const pinTxt = r.has_pin ? 'Set' : 'Unconfigured';
      const pinColor = r.has_pin ? 'text-green-700' : 'text-yellow-700';

      return `
        <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft hover:shadow-lg transition">
          <div class="flex items-center justify-between mb-3">
            <span class="inline-flex items-center rounded-md px-2 py-1 text-xs font-medium ring-1 ring-inset ${statusClass}">
              ${r.status || 'Unknown'}
            </span>
            <div class="text-xs text-jc-muted font-mono">ID: ${r.id}</div>
          </div>

          <h4 class="text-xl font-serif-head font-semibold mb-1 truncate">${name}</h4>
          <p class="text-sm text-jc-gold mb-1">${r.position || 'N/A'}</p>

          <dl class="text-xs space-y-2">
            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 0 1-2.25 2.25h-15a2.25 2.25 0 0 1-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0 0 19.5 4.5h-15a2.25 2.25 0 0 0-2.25 2.25m19.5 0v.243a2.25 2.25 0 0 1-1.07 1.916l-7.5 4.685a2.25 2.25 0 0 1-2.352 0L3.321 8.916A2.25 2.25 0 0 1 2.25 6.993V6.75" /></svg>
              <dt class="text-jc-muted">Email:</dt>
              <dd class="ml-1 font-medium text-jc-ink truncate">${r.email || '—'}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 7V6a2 2 0 0 0-2-2h-1M4 7V6a2 2 0 0 1 2-2h1m0 12h10m-6 4h2m-1-4v4" /></svg>
              <dt class="text-jc-muted">Username:</dt>
              <dd class="ml-1 font-medium text-jc-ink truncate">${u}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 7.5h.008v.008H12V7.5Zm0 9h.008v.008H12V16.5Zm0-3h.008v.008H12V13.5Z" /></svg>
              <dt class="text-jc-muted">PIN:</dt>
              <dd class="ml-1 font-medium ${pinColor}">${pinTxt}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 6.75c0 8.284 6.716 15 15 15h2.25a2.25 2.25 0 0 0 2.25-2.25v-1.372c0-.516-.35-1.012-.915-1.11L16.29 17.06c-1.18-.216-2.433-.042-3.419.557l-.475.316a.75.75 0 0 1-1.096-.282 12 12 0 0 1-3.328-3.328.75.75 0 0 1-.282-1.096l.316-.475c.599-.986.772-2.239.556-3.419L8.71 4.786c-.097-.565-.593-.915-1.11-.915H6.75c-1.24 0-2.25 1.01-2.25 2.25v2.25Z" /></svg>
              <dt class="text-jc-muted">Dept:</dt>
              <dd class="ml-1 font-medium text-jc-ink">${r.department || '—'}</dd>
            </div>

            <div class="flex items-center">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-jc-muted mr-2" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 6a3.75 3.75 0 1 1-7.5 0 3.75 3.75 0 0 1 7.5 0ZM4.501 20.118a8.97 8.97 0 0 1 14.998 0A12.083 12.083 0 0 0 12 17.25a12.083 12.083 0 0 0-7.499 2.868Z" /></svg>
              <dt class="text-jc-muted">Manager:</dt>
              <dd class="ml-1 font-medium text-jc-ink truncate">${r.report_to || '—'}</dd>
            </div>
          </dl>

          <div class="pt-4 mt-4 border-t border-jc-border flex justify-between">
            <button class="btn btn-ghost text-xs py-1" data-edit="${r.id}">View/Edit</button>
            <button class="btn btn-danger text-xs py-1" data-del="${r.id}">Delete</button>
          </div>
        </div>
      `;
    }

    function renderTable(){
      const filtered = applyFilters(rows);
      const paged = paginate(filtered, page, pageSize);
      const grid = qs('#empGrid');

      const addCard = qs('#addEmployeeCard').outerHTML;
      grid.innerHTML = addCard + paged.map(renderEmployeeCard).join('');

      qs('#addEmployeeCard').onclick = () => openModal(null);

      const start = (page-1)*pageSize+1, end = Math.min(page*pageSize, filtered.length);
      qs('#rowsInfo').textContent = filtered.length ? `Showing ${start}-${end} of ${filtered.length} total records` : 'No employees matched your search.';

      qs('#prevPage').disabled = page === 1;
      qs('#nextPage').disabled = page * pageSize >= filtered.length;
    }

    // ================== MODAL ==================
    const empModal = qs('#empModal');
    const empForm  = qs('#empForm');

    function fillPositionOptions(){
      const dept = qs('#dept').value.split(' - ')[0];
      const sel = qs('#positionSel');
      const list = dept === 'BOH' ? BOH_POSITIONS : FOH_POSITIONS;
      sel.innerHTML = list.map(p=>`<option value="${p==='Custom…'?'__custom__':p}">${p}</option>`).join('');
      toggleCustom(sel, 'positionCustom');
    }
    function fillReportToOptions(){
      const sel = qs('#reportToSel');
      const merged = [...new Set([...CORE_MANAGERS, ...ALL_EMP_NAMES.filter(n=>n && !CORE_MANAGERS.includes(n))])];
      sel.innerHTML = merged.map(n=>`<option value="${n==='Custom…'?'__custom__':n}">${n}</option>`).join('');
      toggleCustom(sel, 'reportToCustom');
    }
    function toggleCustom(selectEl, customInputId){
      const show = selectEl.value === '__custom__';
      qs('#'+customInputId).classList.toggle('hidden', !show);
      if(show) qs('#'+customInputId).focus();
    }

    function openModal(row){
      fillPositionOptions();
      fillReportToOptions();

      qs('#displayEmpId').textContent = 'N/A';
      qs('#pinNew').value = '';
      qs('#pinNew2').value = '';

      // Reset password toggle labels
      ['togglePinNew','togglePinNew2'].forEach(id=>{
        const btn = qs('#'+id); const input = qs('#'+id.replace('toggle','').toLowerCase());
        if (btn) btn.textContent = 'Show';
        if (input) input.type = 'password';
      });

      const currentSystemIdEl = qs('#currentSystemId');
      const pinStatusEl = qs('#pinStatus');

      if(row){
        qs('#empModalTitle').textContent = 'Edit Personnel Record';
        qs('#empId').value = row.id;
        qs('#displayEmpId').textContent = row.id;

        const full = nameFromRow(row);
        const parts = full.split(' ');
        qs('#fName').value = parts.length>1 ? parts.slice(0,-1).join(' ') : full;
        qs('#lName').value = parts.length>1 ? parts.slice(-1).join(' ') : '';

        qs('#uName').value  = row.username || '';
        qs('#eMail').value  = row.email    || '';
        qs('#phone').value  = row.phone    || '';
        const deptValue = row.department === 'BOH' ? 'BOH - Back of House' : 'FOH - Front of House';
        qs('#dept').value   = deptValue;

        fillPositionOptions();
        const pos = row.position||'';
        if(qs('#positionSel').querySelector(`option[value="${pos}"]`)) qs('#positionSel').value = pos;
        else { qs('#positionSel').value='__custom__'; qs('#positionCustom').classList.remove('hidden'); qs('#positionCustom').value = pos; }

        fillReportToOptions();
        const rpt = row.report_to||'';
        if(qs('#reportToSel').querySelector(`option[value="${rpt}"]`)) qs('#reportToSel').value = rpt;
        else { qs('#reportToSel').value='__custom__'; qs('#reportToCustom').classList.remove('hidden'); qs('#reportToCustom').value = rpt; }

        qs('#status').value = (row.status||'Active').toString().replace(/^active$/i,'Active').replace('On Leave','Leave').replace('Terminated','Terminated');

        currentSystemIdEl.textContent = row.email || 'N/A';
        if (row.has_pin){
          pinStatusEl.textContent = 'Set (Hashed)';
          pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-success text-jc-success bg-green-50/70';
        } else {
          pinStatusEl.textContent = 'Unconfigured';
          pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-jc-warn bg-yellow-50/70';
        }

        qs('#deleteEmp').classList.remove('hidden');
      } else {
        qs('#empModalTitle').textContent = 'Add New Personnel';
        empForm.reset();
        qs('#empId').value = '';
        qs('#dept').value  = 'FOH - Front of House';
        qs('#deleteEmp').classList.add('hidden');
        fillPositionOptions();
        fillReportToOptions();

        currentSystemIdEl.textContent = 'N/A (New Record)';
        pinStatusEl.textContent = 'Unconfigured (Must Set)';
        pinStatusEl.className = 'text-sm font-medium p-2 rounded-xl border border-jc-warn text-jc-warn bg-yellow-50/70';
      }

      // Rebind delete each open
      const delBtnOld = qs('#deleteEmp');
      const fresh = delBtnOld.cloneNode(true);
      delBtnOld.replaceWith(fresh);
      fresh.addEventListener('click', async () => {
        const id = qs('#empId').value;
        if (!id) { await showCustomAlert('No employee selected.'); return; }
        const who = (rows.find(r => String(r.id) === String(id))?.full_name) || 'this employee';
        if (!await showCustomConfirm(`Delete ${who}? This cannot be undone.`, 'Confirm Deletion', 'Delete Record')) return;

        const original = fresh.textContent;
        fresh.disabled = true; fresh.textContent = 'Deleting…';
        try {
          await deleteEmployeeById(id);
          empModal.close();
          await reloadData();
        } catch (err) {
          console.error('[MODAL_DELETE]', err);
          await showCustomAlert(`Delete failed: ${err.message || err}`, 'Delete Failed');
        } finally {
          fresh.disabled = false; fresh.textContent = original;
        }
      });

      empModal.showModal();
    }

    // ================== INIT / EVENTS ==================
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs
      qsa('.tab').forEach(b=>b.addEventListener('click', ()=>setTabs(b.dataset.tab)));
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');

      // PIN toggle
      qs('#togglePin').addEventListener('click', ()=>{
        const i = qs('#pin'); const show = i.type==='password'; i.type = show ? 'text':'password';
        qs('#togglePin').textContent = show ? 'Hide' : 'Show';
      });
      const tp = (btnId, inputId)=>{
        const btn=qs('#'+btnId), input=qs('#'+inputId);
        btn?.addEventListener('click', ()=>{ const show=input.type==='password'; input.type=show?'text':'password'; btn.textContent = show?'Hide':'Show';});
      };
      tp('togglePinNew','pinNew');
      tp('togglePinNew2','pinNew2');

      // login
      qs('#loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); clearBanner();
        qs('#signInBtn').disabled=true; qs('#signInText').classList.add('hidden'); qs('#signInSpin').classList.remove('hidden');
        try{
          const profile = await rpcAdminLogin(qs('#username').value.trim(), qs('#pin').value.trim());
          if(!profile){ banner('error','Invalid credentials.'); return; }
          session = { admin_id: profile.admin_id, employee_id: profile.employee_id };
          showApp(profile);

          await detectReadSource();
          await detectEmployeesSchema();
          await reloadData();
        }catch(err){
          console.error(err);
          if (err.code === 'PGRST202') banner('error',"Login service isn't registered. Create RPC public.admin_login(p_username,p_pin) and NOTIFY pgrst,'reload schema';");
          else banner('error', err.friendly || 'Login failed. Please verify admin setup.');
        }finally{
          qs('#signInBtn').disabled=false; qs('#signInText').classList.remove('hidden'); qs('#signInSpin').classList.add('hidden');
        }
      });

      // logout
      qs('#logoutBtn').addEventListener('click', ()=>{ session=null; showAuth(); });

      // dashboard quick filters
      qsa('#tab-dashboard [data-q]').forEach(b=>{
        b.addEventListener('click', ()=>{ setTabs('employees'); qs('#searchInput').value = b.dataset.q; renderTable(); });
      });

      // filters & pager
      qs('#searchInput').addEventListener('input', ()=>{ page=1; renderTable(); });
      qs('#deptFilter').addEventListener('change', ()=>{ page=1; renderTable(); });
      qs('#prevPage').addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      qs('#nextPage').addEventListener('click', ()=>{ const filtered=applyFilters(rows); if(page*pageSize<filtered.length){ page++; renderTable(); } });

      // grid delegation (edit/delete)
      document.addEventListener('click', async (ev) => {
        const editBtn = ev.target.closest('[data-edit]');
        const delBtn  = ev.target.closest('[data-del]');
        if (editBtn){
          const id = editBtn.getAttribute('data-edit');
          const row = rows.find(x => String(x.id) === String(id));
          if (row) openModal(row);
          return;
        }
        if (delBtn){
          const id = delBtn.getAttribute('data-del');
          if (!id) return;
          const btn = delBtn;
          const row = rows.find(r => String(r.id) === String(id));
          const who = nameFromRow(row) || 'this employee';
          if (!await showCustomConfirm(`Delete ${who}? This cannot be undone.`, 'Confirm Deletion', 'Delete Record')) return;

          const original = btn.textContent;
          btn.disabled = true; btn.textContent = 'Deleting…';
          try {
            await deleteEmployeeById(id);
            await reloadData();
          } catch (err) {
            console.error('[ROW_DELETE]', err);
            await showCustomAlert(`Delete failed: ${err.message || err}`, 'Delete Failed');
          } finally {
            btn.disabled = false; btn.textContent = original;
          }
        }
      });

      // open/close modal
      qs('#addEmployeeCard').addEventListener('click', ()=>openModal(null));
      qs('#closeModal').addEventListener('click', ()=>empModal.close());

      // modal selects
      qs('#dept').addEventListener('change', fillPositionOptions);
      qs('#positionSel').addEventListener('change', e=>toggleCustom(e.target, 'positionCustom'));
      qs('#reportToSel').addEventListener('change', e=>toggleCustom(e.target, 'reportToCustom'));

      // modal save
      empForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const saveBtn = e.submitter;
        if (saveBtn) { saveBtn.disabled = true; saveBtn.textContent = 'Processing…'; }

        try{
          const isUpdate = qs('#empId').value || null;
          let savedRow;
          if(isUpdate){
            savedRow = await updateEmployeeFromForm(isUpdate);
          }else{
            savedRow = await insertEmployeeFromForm();
          }

          const targetId = savedRow[COLS.id];
          let uChanged=false, pChanged=false;

          // Access updates (username + pin) via RPC
          const desiredUsername = sanitizeUsername(qs('#uName').value);
          const prior = rows.find(r=>String(r.id)===String(targetId));
          const prevU = prior ? (prior.username||'') : (savedRow.username||'');
          const usernameNeedsUpdate = (desiredUsername || '') !== (prevU || '');

          const newPin  = (qs('#pinNew').value || '').trim();
          const newPin2 = (qs('#pinNew2').value || '').trim();
          let pinVal = null;

          if (newPin || newPin2){
            if (newPin !== newPin2) throw new Error('New PIN and Confirm PIN do not match.');
            if (!validPinFormat(newPin)) throw new Error('PIN must be 4–8 digits (0–9).');
            pinVal = newPin;
          }

          if (usernameNeedsUpdate || pinVal !== null){
            const res = await updateAccess(targetId, usernameNeedsUpdate ? desiredUsername : null, pinVal);
            uChanged = !!res.uOk; pChanged = !!res.pOk;
          }

          empModal.close();
          await reloadData();

          let msg = 'Employee record saved successfully.';
          if (uChanged && pChanged) msg = 'Employee record, username, and PIN updated successfully.';
          else if (uChanged) msg = 'Employee record and username updated successfully.';
          else if (pChanged) msg = 'Employee record and PIN updated successfully.';
          await showCustomAlert(msg, 'Save Complete');
        }catch(err){
          console.error(err);
          await showCustomAlert(err.message || 'Save failed. Check console for details.', 'Save Failed');
        }finally{
          if (saveBtn) { saveBtn.disabled = false; saveBtn.textContent = 'Save Changes'; }
        }
      });
    });

    async function reloadData(){
      qs('#serverStatus').textContent='pending'; qs('#serverStatus').className='ml-1 font-semibold text-yellow-700';
      const list = await fetchEmployees();
      rows = list;

      // cache names for Report To dropdown
      ALL_EMP_NAMES = list.map(r=>r.full_name).filter(Boolean).sort((a,b)=>a.localeCompare(b));

      renderKPIs(list);
      renderTable();
      qs('#serverStatus').textContent='ok'; qs('#serverStatus').className='ml-1 font-semibold text-green-700';
    }
  </script>
</body>
</html>
