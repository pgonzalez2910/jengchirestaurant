<!DOCTYPE html>
<html lang="en" class="h-full bg-[#F7F5F1]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeng Chi — Executive Administrator Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A','jc-muted':'#6B7280','jc-gold':'#B9965A','jc-border':'#E5E4E2','jc-bg':'#F7F5F1',
            'jc-danger':'#B91C1C','jc-success':'#166534','jc-warn':'#92400E'
          },
          boxShadow: { 'soft':'0 14px 30px -14px rgba(15,23,42,0.15)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .input{ @apply w-full rounded-xl border border-jc-border bg-white px-3 py-2 text-jc-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/35; }
    .btn{ @apply inline-flex items-center justify-center rounded-xl px-3.5 py-2 font-medium shadow-soft transition; }
    .btn-gold{ @apply bg-jc-gold text-white hover:brightness-95; }
    .btn-ghost{ @apply bg-white border border-jc-border text-jc-ink hover:bg-jc-bg; }
    .btn-danger{ @apply bg-red-600 text-white hover:bg-red-700; }
    .tag{ @apply inline-flex items-center rounded-full border border-jc-border bg-white px-2.5 py-1 text-xs font-medium text-jc-muted; }
    .tab{ @apply px-4 py-2 rounded-xl text-sm font-medium cursor-pointer border border-transparent hover:bg-white/60; }
    .tab-active{ @apply bg-white border-jc-border shadow-soft; }
    .label{ @apply text-sm font-semibold text-jc-ink; }
    .banner{ @apply rounded-xl border px-3 py-2 text-sm; }
    dialog::backdrop{ background: rgba(15,23,42,.35); }
    .hint{ @apply text-xs text-jc-muted; }
    .row-actions{ @apply flex gap-2; }
    .link-danger{ @apply text-red-700 hover:text-red-800 underline underline-offset-2; }
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <div class="min-h-full">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 bg-jc-bg/75 backdrop-blur border-b border-jc-border">
      <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/jengchilogo.jpg" alt="Jeng Chi" class="h-10 w-10 rounded-xl object-cover border border-jc-border">
          <div>
            <div class="text-xl font-serif-head">Jeng Chi — Administrator Portal</div>
            <div class="text-xs text-jc-muted">Corporate • Business • Executive • Professional • Enterprise</div>
          </div>
        </div>
        <div id="userBox" class="hidden items-center gap-3">
          <span id="adminName" class="text-sm text-jc-muted"></span>
          <button id="logoutBtn" class="btn btn-ghost">Log out</button>
        </div>
      </div>
    </header>

    <main class="mx-auto max-w-7xl px-4 py-8">
      <!-- ===== AUTH CARD ===== -->
      <section id="authSection" class="max-w-md mx-auto">
        <div id="authBanner" class="hidden banner mb-4"></div>

        <div class="bg-white rounded-2xl border border-jc-border p-6 shadow-soft">
          <h2 class="text-lg font-semibold mb-1">Administrator Sign In</h2>
          <p class="text-sm text-jc-muted mb-4">Only authorized corporate administrators may access this portal.</p>

          <form id="loginForm" class="space-y-4" autocomplete="off">
            <div>
              <label class="label">Username</label>
              <input id="username" class="input" placeholder="Your admin username" required />
            </div>

            <div>
              <label class="label">PIN</label>
              <div class="relative">
                <input id="pin" class="input pr-12 tracking-widest" type="password" placeholder="••••" inputmode="numeric" minlength="4" maxlength="8" required />
                <button type="button" id="togglePin" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
              </div>
              <p class="hint mt-1">PIN is hidden while typing.</p>
            </div>

            <button id="signInBtn" class="btn btn-gold w-full" type="submit">
              <span id="signInText">Sign In</span>
              <span id="signInSpin" class="hidden">Signing in…</span>
            </button>

            <div class="text-[11px] text-jc-muted leading-relaxed">
              Security: 5 failed attempts trigger a temporary lock (10 minutes).
            </div>
          </form>
        </div>
      </section>

      <!-- ===== APP ===== -->
      <section id="appSection" class="hidden">
        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button data-tab="dashboard" class="tab tab-active">Dashboard</button>
          <button data-tab="employees" class="tab">Employees</button>
          <button data-tab="reports" class="tab">Reports</button>
          <button data-tab="settings" class="tab">Settings</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">Total Employees</div>
              <div id="kpiTotal" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">FOH</div>
              <div id="kpiFOH" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">BOH</div>
              <div id="kpiBOH" class="text-3xl font-semibold">—</div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-3">Quick Filters</h3>
            <div class="flex flex-wrap gap-2">
              <button class="tag" data-q="FOH">FOH</button>
              <button class="tag" data-q="BOH">BOH</button>
              <button class="tag" data-q="Server">Server</button>
              <button class="tag" data-q="Line Cook">Line Cook</button>
              <button class="tag" data-q="">Clear</button>
            </div>
          </div>
        </div>

        <!-- Employees (CRUD) -->
        <div id="tab-employees" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="flex flex-col md:flex-row md:items-end gap-3">
              <div class="grow">
                <label class="label">Search employees</label>
                <input id="searchInput" class="input" type="text" placeholder="Name, department, email, position..." />
              </div>
              <div class="w-full md:w-auto flex gap-2">
                <select id="deptFilter" class="input">
                  <option value="">All Departments</option>
                  <option value="FOH">FOH</option>
                  <option value="BOH">BOH</option>
                </select>
                <button id="addEmployeeBtn" class="btn btn-gold">Add Employee</button>
              </div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-jc-muted">
                  <tr class="border-b border-jc-border">
                    <th class="py-2 pr-4">Name</th>
                    <th class="py-2 pr-4">Email</th>
                    <th class="py-2 pr-4">Department</th>
                    <th class="py-2 pr-4">Position</th>
                    <th class="py-2 pr-4">Report To</th>
                    <th class="py-2 pr-4">Status</th>
                    <th class="py-2 pr-0 text-right">Actions</th>
                  </tr>
                </thead>
                <tbody id="empTbody"></tbody>
              </table>
            </div>

            <div class="flex items-center justify-between pt-3">
              <div id="rowsInfo" class="text-xs text-jc-muted"></div>
              <div class="flex gap-2">
                <button id="prevPage" class="btn btn-ghost text-sm">Prev</button>
                <button id="nextPage" class="btn btn-ghost text-sm">Next</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Reports -->
        <div id="tab-reports" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Status</h3>
            <div class="flex items-center gap-2">
              <span class="tag">Server: <span id="serverStatus" class="ml-1 font-semibold text-yellow-700">pending</span></span>
            </div>
            <p class="text-sm text-jc-muted mt-2">Reserved for PDF/CSV reports and admin analytics.</p>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab-settings" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Configuration</h3>
            <ul class="list-disc ml-5 text-sm text-jc-muted space-y-1">
              <li>Admins table: <code>public.administrators</code></li>
              <li>Login RPC: <code>public.admin_login(p_username, p_pin)</code></li>
              <li>Employees read from <code>public.employees_admin</code>; writes go to <code>public.employees</code></li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Employee Modal -->
  <dialog id="empModal" class="rounded-2xl w-full max-w-2xl p-0 border border-jc-border shadow-soft">
    <form id="empForm" class="bg-white rounded-2xl p-5 space-y-4" method="dialog">
      <div class="flex items-start justify-between gap-3">
        <h3 id="empModalTitle" class="text-lg font-semibold">Add Employee</h3>
        <button type="button" id="closeModal" class="btn btn-ghost">Close</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label">First Name</label>
          <input id="fName" class="input" required />
        </div>
        <div>
          <label class="label">Last Name</label>
          <input id="lName" class="input" />
        </div>

        <div class="md:col-span-2">
          <label class="label">Email</label>
          <input id="eMail" type="email" class="input" placeholder="unique@jengchirestaurant.com" />
          <p id="emailWarn" class="hidden hint mt-1"></p>
        </div>

        <div>
          <label class="label">Department</label>
          <select id="dept" class="input" required>
            <option value="FOH">FOH</option>
            <option value="BOH">BOH</option>
          </select>
        </div>

        <!-- Position select + custom -->
        <div>
          <label class="label">Position</label>
          <select id="positionSel" class="input"></select>
          <input id="positionCustom" class="input mt-2 hidden" placeholder="Type custom position…" />
        </div>

        <!-- Report To select + custom -->
        <div class="md:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">Report To</label>
            <select id="reportToSel" class="input"></select>
            <input id="reportToCustom" class="input mt-2 hidden" placeholder="Type manager name…" />
          </div>
          <div>
            <label class="label">Status</label>
            <select id="status" class="input" required>
              <option value="Active">Active</option>
              <option value="Leave">Leave</option>
              <option value="Terminated">Terminated</option>
            </select>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-between pt-2">
        <span class="text-xs text-jc-muted">Corporate Business • Executive • Professional</span>
        <div class="flex gap-2">
          <button type="button" id="deleteEmp" class="btn btn-danger hidden">Delete</button>
          <button type="submit" class="btn btn-gold">Save</button>
        </div>
      </div>

      <input type="hidden" id="empId" />
    </form>
  </dialog>

  <script>
    // ================== SUPABASE CONFIG ==================
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ================== STATIC LISTS ==================
    const FOH_POSITIONS = ["Server","Bartender","Host/Hostess","Cashier","Busser","Food Runner","Expeditor","Supervisor","Manager","Custom…"];
    const BOH_POSITIONS = ["Line Cook","Wok Chef","Dumpling Maker","Pastry","Prep Cook","Dishwasher","Expo","Sous Chef","Chef","Custom…"];
    const CORE_MANAGERS = ["Janelle Teng","Pablo Gonzalez","Craig Reeves","Shoko Teng","Mai Vu","Custom…"];

    // ================== STATE ==================
    let session = null;
    let page = 1;
    const pageSize = 12;
    let rows = [];
    let READ_SOURCE = 'employees_admin';
    let ALL_EMP_NAMES = [];

    // Write schema map for public.employees
    let COLS = {
      nameMode: 'single',
      single: 'full_name',
      first: 'first_name',
      last:  'last_name',
      email: 'email',
      dept:  'department',
      position: 'position',                // may map to primary_role
      reportTo: 'report_to',               // may map to "Current Reports To Employee"
      status: 'status',
      id: 'id'
    };

    // ================== HELPERS ==================
    const qs  = (s,el=document)=>el.querySelector(s);
    const qsa = (s,el=document)=>[...el.querySelectorAll(s)];
    const setTabs=(active)=>{ qsa('.tab').forEach(b=>{const t=b.dataset.tab; b.classList.toggle('tab-active',t===active); qs('#tab-'+t).classList.toggle('hidden',t!==active);}); localStorage.setItem('jc-active-tab',active);};
    const paginate=(arr,p,s)=>arr.slice((p-1)*s,(p-1)*s+s);
    const banner=(type,msg)=>{ const box=qs('#authBanner'); const map={error:'border-red-200 bg-red-50 text-red-800', ok:'border-emerald-200 bg-emerald-50 text-emerald-800', info:'border-slate-200 bg-white text-slate-700'}; box.className=`banner ${map[type]||map.info}`; box.textContent=msg; box.classList.remove('hidden'); };
    const clearBanner=()=>qs('#authBanner').classList.add('hidden');

    function nameFromRow(r){
      if(READ_SOURCE==='employees_admin') return r.full_name || '';
      if (COLS.nameMode==='single') return r[COLS.single] || '';
      const a=r[COLS.first]||'', b=r[COLS.last]||''; return [a,b].filter(Boolean).join(' ').trim();
    }

    // ===== Email uniqueness with soft-resolve =====
    async function findByEmail(email){
      const e = (email||'').trim().toLowerCase();
      if(!e) return null;
      const { data } = await supabase.from('employees').select('*').ilike('email', e).limit(1);
      return (data && data[0]) || null;
    }
    async function ensureUniqueEmailOrOpen(email){
      const existing = await findByEmail(email);
      if(!existing) return { ok:true };
      if(confirm('That email is already used by another employee. Open that record to edit?')){
        openModal(existing);
      }
      return { ok:false, message:'Duplicate email' };
    }
    function showFieldError(el, msg){ el.setCustomValidity(msg||''); el.reportValidity(); }

    // ================== AUTH ==================
    const authSection = qs('#authSection');
    const appSection  = qs('#appSection');
    const userBox     = qs('#userBox');
    const adminNameEl = qs('#adminName');

    async function rpcAdminLogin(username, pin){
      if(!/^[a-z0-9._-]{2,32}$/i.test(username)) throw { friendly:'Invalid username format.' };
      if(!/^[0-9]{4,8}$/.test(pin)) throw { friendly:'PIN must be 4–8 digits.' };
      const { data, error } = await supabase.rpc('admin_login', { p_username: username, p_pin: pin });
      if(error) throw error;
      if(!data || !data.length) return null;
      return data[0];
    }
    function showApp(profile){
      const uname = profile.admin_username || profile.username || 'Administrator';
      adminNameEl.textContent = `${uname} — Administrator`;
      userBox.classList.remove('hidden'); authSection.classList.add('hidden'); appSection.classList.remove('hidden');
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');
    }
    function showAuth(){ userBox.classList.add('hidden'); authSection.classList.remove('hidden'); appSection.classList.add('hidden'); }

    // ================== SOURCE / SCHEMA DETECTION ==================
    async function detectReadSource(){
      let res = await supabase.from('employees_admin').select('*').limit(1);
      READ_SOURCE = res.error ? 'employees' : 'employees_admin';
    }
    async function detectEmployeesSchema(){
      const { data, error } = await supabase.from('employees').select('*').limit(1);
      if(error) return;
      const row  = (data && data[0]) || {};
      const keys = Object.keys(row); // exact
      const has  = k => keys.includes(k);

      COLS.id = has('id') ? 'id' : COLS.id;

      if (has('full_name') || has('name')) {
        COLS.nameMode='single'; COLS.single = has('full_name') ? 'full_name' : 'name';
      } else {
        COLS.nameMode='split';
        COLS.first = has('first_name') ? 'first_name' : has('fname') ? 'fname' : has('first') ? 'first' : 'first_name';
        COLS.last  = has('last_name')  ? 'last_name'  : has('lname') ? 'lname' : has('last')  ? 'last'  : 'last_name';
      }

      COLS.email    = has('email') ? 'email' : has('work_email') ? 'work_email' : 'email';
      COLS.dept     = has('department') ? 'department' : has('dept') ? 'dept' : 'department';
      COLS.position = has('position') ? 'position' : has('role') ? 'role' : has('primary_role') ? 'primary_role' : 'position';
      COLS.reportTo = has('report_to') ? 'report_to'
                    : has('manager') ? 'manager'
                    : has('Current Reports To Employee') ? 'Current Reports To Employee'
                    : 'report_to';
      COLS.status   = has('status') ? 'status' : has('employment_status') ? 'employment_status' : 'status';
    }

    // ================== CRUD ==================
    async function fetchEmployees(){
      const { data, error } = await supabase.from(READ_SOURCE).select('*');
      if(error){ console.error(error); banner('error','Error loading employees.'); return []; }
      return data||[];
    }

    function collectPositionValue(){
      const sel = qs('#positionSel').value;
      return sel === '__custom__' ? qs('#positionCustom').value.trim() : sel;
    }
    function collectReportToValue(){
      const sel = qs('#reportToSel').value;
      return sel === '__custom__' ? qs('#reportToCustom').value.trim() : sel;
    }

    async function insertEmployeeFromForm(){
      const emailEl = qs('#eMail');
      const email = (emailEl.value||'').trim().toLowerCase();

      const ok = await ensureUniqueEmailOrOpen(email);
      if(!ok.ok){ showFieldError(emailEl, ok.message); throw new Error(ok.message); }
      showFieldError(emailEl, '');

      const row = {};
      if (COLS.nameMode==='single'){
        row[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        row[COLS.first]  = qs('#fName').value.trim();
        row[COLS.last]   = qs('#lName').value.trim();
      }
      row[COLS.email]    = email || null;
      row[COLS.dept]     = qs('#dept').value;
      row[COLS.position] = collectPositionValue();
      row[COLS.reportTo] = collectReportToValue();
      row[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').insert(row).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }

    async function updateEmployeeFromForm(id){
      const emailEl = qs('#eMail');
      const email = (emailEl.value||'').trim().toLowerCase();

      const existing = await findByEmail(email);
      if(existing && String(existing[COLS.id]) !== String(id)){
        if(confirm('That email is used by another employee. Open that record to edit instead?')){
          openModal(existing);
        }
        throw new Error('Duplicate email');
      }
      showFieldError(emailEl, '');

      const patch = {};
      if (COLS.nameMode==='single'){
        patch[COLS.single] = `${qs('#fName').value.trim()} ${qs('#lName').value.trim()}`.trim();
      } else {
        patch[COLS.first]  = qs('#fName').value.trim();
        patch[COLS.last]   = qs('#lName').value.trim();
      }
      patch[COLS.email]    = email || null;
      patch[COLS.dept]     = qs('#dept').value;
      patch[COLS.position] = collectPositionValue();
      patch[COLS.reportTo] = collectReportToValue();
      patch[COLS.status]   = qs('#status').value;

      const { data, error } = await supabase.from('employees').update(patch).eq(COLS.id, id).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }

    async function deleteEmployeeById(id){
      const { error } = await supabase.from('employees').delete({ returning:'minimal' }).eq(COLS.id, id);
      if(error) throw error;
    }

    // ================== RENDER ==================
    function renderKPIs(list){
      const total = list.length;
      const foh = list.filter(r=>(r.department||'').toUpperCase()==='FOH').length;
      const boh = list.filter(r=>(r.department||'').toUpperCase()==='BOH').length;
      qs('#kpiTotal').textContent = total;
      qs('#kpiFOH').textContent   = foh;
      qs('#kpiBOH').textContent   = boh;
    }

    function applyFilters(source){
      const q = (qs('#searchInput').value||'').trim().toLowerCase();
      const dept = qs('#deptFilter').value;
      return source.filter(r=>{
        const hay = [
          nameFromRow(r), r.email, r.position, r.department, r.report_to, r.status
        ].join(' ').toLowerCase();
        const passQ = q ? hay.includes(q) : true;
        const passD = dept ? (String(r.department||'')===dept) : true;
        return passQ && passD;
      });
    }

    function renderTable(){
      const filtered = applyFilters(rows);
      const paged = paginate(filtered, page, pageSize);
      const tb = qs('#empTbody');

      tb.innerHTML = paged.map(r=>`
        <tr class="border-b border-jc-border">
          <td class="py-2 pr-4">${nameFromRow(r)}</td>
          <td class="py-2 pr-4">${r.email||''}</td>
          <td class="py-2 pr-4"><span class="tag">${r.department||''}</span></td>
          <td class="py-2 pr-4">${r.position||''}</td>
          <td class="py-2 pr-4">${r.report_to||''}</td>
          <td class="py-2 pr-4">${r.status||''}</td>
          <td class="py-2 pr-0 text-right">
            <div class="row-actions">
              <button class="btn btn-ghost text-sm" data-edit="${r.id}">Edit</button>
              <button class="btn btn-danger text-sm" data-del="${r.id}">Delete</button>
            </div>
          </td>
        </tr>`).join('');

      // wire edit/delete actions
      qsa('[data-edit]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const id = b.getAttribute('data-edit');
          const row = rows.find(x=>String(x.id)===String(id));
          openModal(row);
        });
      });
      qsa('[data-del]').forEach(b=>{
        b.addEventListener('click', async ()=>{
          const id = b.getAttribute('data-del');
          const row = rows.find(x=>String(x.id)===String(id));
          if(!row) return;
          const who = nameFromRow(row) || 'this employee';
          if(!confirm(`Delete ${who}? This cannot be undone.`)) return;

          const original = b.textContent;
          b.disabled = true; b.textContent = 'Deleting…';
          try {
            await deleteEmployeeById(id);
            await reloadData();
          } catch (err){
            console.error('[ROW_DELETE]', err);
            if (err && err.code === '42501') {
              alert('Delete blocked by Row Level Security policy on employees.');
            } else {
              alert(`Delete failed: ${err.message || err}`);
            }
          } finally {
            b.disabled = false; b.textContent = original;
          }
        });
      });

      const start = (page-1)*pageSize+1, end = Math.min(page*pageSize, filtered.length);
      qs('#rowsInfo').textContent = filtered.length ? `Showing ${start}-${end} of ${filtered.length}` : 'No rows';
    }

    // ================== MODAL & DROPDOWNS ==================
    const empModal = qs('#empModal');
    const empForm  = qs('#empForm');
    const deleteBtn= qs('#deleteEmp');

    function fillPositionOptions(){
      const dept = qs('#dept').value;
      const sel = qs('#positionSel');
      const list = dept === 'BOH' ? BOH_POSITIONS : FOH_POSITIONS;
      sel.innerHTML = list.map(p=>`<option value="${p==='Custom…'?'__custom__':p}">${p}</option>`).join('');
      toggleCustom(sel, 'positionCustom');
    }
    function fillReportToOptions(){
      const sel = qs('#reportToSel');
      const merged = [...new Set([...CORE_MANAGERS, ...ALL_EMP_NAMES.filter(n=>n && !CORE_MANAGERS.includes(n))])];
      sel.innerHTML = merged.map(n=>`<option value="${n==='Custom…'?'__custom__':n}">${n}</option>`).join('');
      toggleCustom(sel, 'reportToCustom');
    }
    function toggleCustom(selectEl, customInputId){
      const show = selectEl.value === '__custom__';
      qs('#'+customInputId).classList.toggle('hidden', !show);
      if(show) qs('#'+customInputId).focus();
    }

    function openModal(row){
      fillPositionOptions();
      fillReportToOptions();

      if(row){
        qs('#empModalTitle').textContent = 'Edit Employee';
        qs('#empId').value = row.id;

        const full = nameFromRow(row);
        const parts = full.split(' ');
        qs('#fName').value = parts.length>1 ? parts.slice(0,-1).join(' ') : full;
        qs('#lName').value = parts.length>1 ? parts.slice(-1).join(' ') : '';

        qs('#eMail').value   = row.email||'';
        qs('#dept').value    = row.department||'FOH';
        fillPositionOptions();
        const pos = row.position||'';
        if(qs('#positionSel').querySelector(`option[value="${pos}"]`)) qs('#positionSel').value = pos;
        else { qs('#positionSel').value='__custom__'; qs('#positionCustom').classList.remove('hidden'); qs('#positionCustom').value = pos; }

        fillReportToOptions();
        const rpt = row.report_to||'';
        if(qs('#reportToSel').querySelector(`option[value="${rpt}"]`)) qs('#reportToSel').value = rpt;
        else { qs('#reportToSel').value='__custom__'; qs('#reportToCustom').classList.remove('hidden'); qs('#reportToCustom').value = rpt; }

        qs('#status').value  = (row.status||'Active').toString().replace(/^active$/i,'Active');

        deleteBtn.classList.remove('hidden');
      } else {
        qs('#empModalTitle').textContent = 'Add Employee';
        empForm.reset();
        qs('#empId').value = '';
        deleteBtn.classList.add('hidden');
        fillPositionOptions();
        fillReportToOptions();
      }
      empModal.showModal();
    }

    // ================== INIT / EVENTS ==================
    document.addEventListener('DOMContentLoaded', ()=>{
      // tabs
      qsa('.tab').forEach(b=>b.addEventListener('click', ()=>setTabs(b.dataset.tab)));
      setTabs(localStorage.getItem('jc-active-tab') || 'employees');

      // PIN toggle
      qs('#togglePin').addEventListener('click', ()=>{
        const i = qs('#pin'); const show = i.type==='password'; i.type = show ? 'text':'password';
        qs('#togglePin').textContent = show ? 'Hide' : 'Show';
      });

      // login
      qs('#loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault(); clearBanner();
        qs('#signInBtn').disabled=true; qs('#signInText').classList.add('hidden'); qs('#signInSpin').classList.remove('hidden');
        try{
          const profile = await rpcAdminLogin(qs('#username').value.trim(), qs('#pin').value.trim());
          if(!profile){ banner('error','Invalid credentials.'); return; }
          session = { admin_id: profile.admin_id, employee_id: profile.employee_id };
          showApp(profile);

          await detectReadSource();
          await detectEmployeesSchema();
          await reloadData();
        } catch(err){
          console.error(err);
          if (err.code === 'PGRST202') banner('error',"Login service isn't registered. Create RPC public.admin_login(p_username,p_pin) and NOTIFY pgrst,'reload schema';");
          else banner('error','Login failed. Please verify admin setup.');
        } finally {
          qs('#signInBtn').disabled=false; qs('#signInText').classList.remove('hidden'); qs('#signInSpin').classList.add('hidden');
        }
      });

      // logout
      qs('#logoutBtn').addEventListener('click', ()=>{ session=null; showAuth(); });

      // dashboard quick filters
      qsa('#tab-dashboard [data-q]').forEach(b=>{
        b.addEventListener('click', ()=>{ setTabs('employees'); qs('#searchInput').value = b.dataset.q; renderTable(); });
      });

      // employees filters & pager
      qs('#searchInput').addEventListener('input', ()=>{ page=1; renderTable(); });
      qs('#deptFilter').addEventListener('change', ()=>{ page=1; renderTable(); });
      qs('#prevPage').addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      qs('#nextPage').addEventListener('click', ()=>{ const filtered=applyFilters(rows); if(page*pageSize<filtered.length){ page++; renderTable(); } });

      // open/close modal
      qs('#addEmployeeBtn').addEventListener('click', ()=>openModal(null));
      qs('#closeModal').addEventListener('click', ()=>empModal.close());

      // modal selects
      qs('#dept').addEventListener('change', fillPositionOptions);
      qs('#positionSel').addEventListener('change', e=>toggleCustom(e.target, 'positionCustom'));
      qs('#reportToSel').addEventListener('change', e=>toggleCustom(e.target, 'reportToCustom'));

      // modal save
      empForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const id = qs('#empId').value || null;
        try{
          if(id) await updateEmployeeFromForm(id); else await insertEmployeeFromForm();
          empModal.close();
          await reloadData();
        } catch(err){ console.error(err); alert(err.message || 'Save failed.'); }
      });

      // modal delete — robust binding
      (function bindDeleteInModal(){
        const btn = document.getElementById('deleteEmp');
        if(!btn) return;
        const clone = btn.cloneNode(true);
        btn.parentNode.replaceChild(clone, btn);
        clone.addEventListener('click', async ()=>{
          const id = document.getElementById('empId').value;
          if(!id){ alert('No employee selected.'); return; }
          const who = (rows.find(r=>String(r.id)===String(id))?.full_name) || 'this employee';
          if(!confirm(`Delete ${who}? This cannot be undone.`)) return;

          const original = clone.textContent;
          clone.disabled = true; clone.textContent = 'Deleting…';
          try{
            await deleteEmployeeById(id);
            empModal.close();
            await reloadData();
          } catch (err){
            console.error('[MODAL_DELETE]', err);
            if (err && err.code === '42501') {
              alert('Delete blocked by Row Level Security policy on employees.');
            } else {
              alert(`Delete failed: ${err.message || err}`);
            }
          } finally {
            clone.disabled = false; clone.textContent = original;
          }
        });
      })();
    });

    async function reloadData(){
      qs('#serverStatus').textContent='pending'; qs('#serverStatus').className='ml-1 font-semibold text-yellow-700';
      const list = await fetchEmployees();
      rows = list;

      // cache names for Report To dropdown
      ALL_EMP_NAMES = list.map(r=>r.full_name).filter(Boolean).sort((a,b)=>a.localeCompare(b));

      renderKPIs(list);
      renderTable();
      qs('#serverStatus').textContent='ok'; qs('#serverStatus').className='ml-1 font-semibold text-green-700';
    }
  </script>
</body>
</html>
