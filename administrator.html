<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Administrator Portal</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A',
            'jc-muted':'#6B7280',
            'jc-gold':'#C0A06D',
            'jc-border':'#E5E7EB',
            'jc-bg':'#FBF8F3',
            'jc-card':'#FFFFFF'
          },
          boxShadow: { 'soft':'0 10px 25px -10px rgba(0,0,0,0.12)' }
        }
      }
    }
  </script>

  <!-- Supabase JS -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    .input { @apply w-full rounded-xl border border-jc-border bg-white px-3 py-2 text-jc-ink shadow-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/40; }
    .btn { @apply inline-flex items-center justify-center rounded-xl px-4 py-2 font-medium shadow-soft transition; }
    .btn-gold { @apply bg-jc-gold text-white hover:brightness-95; }
    .btn-ghost { @apply bg-white border border-jc-border text-jc-ink hover:bg-jc-bg; }
    .tag { @apply inline-flex items-center rounded-full border border-jc-border bg-white px-2.5 py-1 text-xs font-medium text-jc-muted; }
    .tab { @apply px-4 py-2 rounded-xl text-sm font-medium cursor-pointer border border-transparent hover:bg-white/60; }
    .tab-active { @apply bg-white border-jc-border shadow-soft; }
    .label { @apply text-sm font-semibold text-jc-ink; }
  </style>
</head>
<body class="h-full font-sans text-jc-ink">
  <div class="min-h-full">
    <!-- Top Bar -->
    <header class="sticky top-0 z-40 bg-jc-bg/70 backdrop-blur border-b border-jc-border">
      <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/jengchilogo.jpg" alt="Jeng Chi" class="h-10 w-10 rounded-xl object-cover border border-jc-border">
          <div>
            <div class="text-xl font-serif-head">Jeng Chi — Administrator Portal</div>
            <div class="text-xs text-jc-muted">Executive Business Professional Enterprise</div>
          </div>
        </div>
        <div id="userBox" class="hidden items-center gap-3">
          <span id="adminName" class="text-sm text-jc-muted"></span>
          <button id="logoutBtn" class="btn btn-ghost">Log out</button>
        </div>
      </div>
    </header>

    <!-- Auth Gate -->
    <main class="mx-auto max-w-7xl px-4 py-6">
      <section id="authSection" class="max-w-md mx-auto">
        <div class="bg-white rounded-2xl border border-jc-border p-5 shadow-soft">
          <h2 class="text-lg font-semibold mb-1">Administrator Sign In</h2>
          <p class="text-sm text-jc-muted mb-4">Only authorized administrators may access this portal.</p>

          <form id="loginForm" class="space-y-4" autocomplete="off">
            <div>
              <label class="label">Username</label>
              <input id="username" class="input" placeholder="Your admin username" inputmode="latin" required />
            </div>
            <div>
              <label class="label">PIN</label>
              <div class="relative">
                <!-- NOTE: removed pattern that caused the browser warning; we validate in JS -->
                <input id="pin" class="input pr-12 tracking-widest"
                       type="password" placeholder="••••"
                       inputmode="numeric" minlength="4" maxlength="8" required />
                <button type="button" id="togglePin" class="absolute right-2 top-1/2 -translate-y-1/2 text-jc-muted text-xs">Show</button>
              </div>
              <p class="text-xs text-jc-muted mt-1">PIN is hidden while typing.</p>
            </div>
            <button class="btn btn-gold w-full" type="submit">Sign In</button>
          </form>
        </div>
      </section>

      <!-- App -->
      <section id="appSection" class="hidden">
        <!-- Tabs -->
        <div class="flex flex-wrap gap-2 mb-4">
          <button data-tab="dashboard" class="tab tab-active">Dashboard</button>
          <button data-tab="employees" class="tab">Employees</button>
          <button data-tab="reports" class="tab">Reports</button>
          <button data-tab="settings" class="tab">Settings</button>
        </div>

        <!-- Dashboard -->
        <div id="tab-dashboard" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">Total Employees</div>
              <div id="kpiTotal" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">FOH</div>
              <div id="kpiFOH" class="text-3xl font-semibold">—</div>
            </div>
            <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
              <div class="text-sm text-jc-muted mb-1">BOH</div>
              <div id="kpiBOH" class="text-3xl font-semibold">—</div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-3">Quick Filters</h3>
            <div id="quickFilters" class="flex flex-wrap gap-2"></div>
          </div>
        </div>

        <!-- Employees -->
        <div id="tab-employees" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="flex flex-col md:flex-row md:items-end gap-3">
              <div class="grow">
                <label class="label">Search employees</label>
                <input id="searchInput" class="input" type="text" placeholder="Name, email, position..." />
              </div>
              <div class="w-full md:w-auto flex gap-2">
                <select id="deptFilter" class="input">
                  <option value="">All Departments</option>
                  <option value="FOH">FOH</option>
                  <option value="BOH">BOH</option>
                </select>
                <button id="addEmployeeBtn" class="btn btn-gold">Add Employee</button>
              </div>
            </div>
          </div>

          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <div class="overflow-x-auto">
              <table class="min-w-full text-sm">
                <thead class="text-left text-jc-muted">
                  <tr class="border-b border-jc-border">
                    <th class="py-2 pr-4">Name</th>
                    <th class="py-2 pr-4">Email</th>
                    <th class="py-2 pr-4">Department</th>
                    <th class="py-2 pr-4">Position</th>
                    <th class="py-2 pr-4">Report To</th>
                    <th class="py-2 pr-4">Status</th>
                    <th class="py-2 pr-4"></th>
                  </tr>
                </thead>
                <tbody id="empTbody"></tbody>
              </table>
            </div>

            <div class="flex items-center justify-between pt-3">
              <div id="rowsInfo" class="text-xs text-jc-muted"></div>
              <div class="flex gap-2">
                <button id="prevPage" class="btn btn-ghost text-sm">Prev</button>
                <button id="nextPage" class="btn btn-ghost text-sm">Next</button>
              </div>
            </div>
          </div>
        </div>

        <!-- Reports -->
        <div id="tab-reports" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Status</h3>
            <div class="flex items-center gap-2">
              <span class="tag">Server: <span id="serverStatus" class="ml-1 font-semibold text-yellow-700">pending</span></span>
            </div>
            <p class="text-sm text-jc-muted mt-2">This section will render PDF/CSV reports and survey names.</p>
          </div>
        </div>

        <!-- Settings -->
        <div id="tab-settings" class="hidden space-y-4">
          <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
            <h3 class="text-base font-semibold mb-2">Configuration</h3>
            <ul class="list-disc ml-5 text-sm text-jc-muted space-y-1">
              <li>Username + PIN is validated by a secure Postgres function (<code>admin_login</code>).</li>
              <li>Admins are managed in the <code>administrators</code> table and linked to <code>employees</code>.</li>
            </ul>
          </div>
        </div>
      </section>
    </main>
  </div>

  <!-- Add/Edit Employee Modal -->
  <dialog id="empModal" class="rounded-2xl w-full max-w-2xl p-0 border border-jc-border shadow-soft">
    <form id="empForm" class="bg-white rounded-2xl p-5 space-y-4" method="dialog">
      <div class="flex items-start justify-between gap-3">
        <h3 id="empModalTitle" class="text-lg font-semibold">Add Employee</h3>
        <button type="button" id="closeModal" class="btn btn-ghost">Close</button>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label class="label">First Name</label>
          <input id="fName" class="input" required />
        </div>
        <div>
          <label class="label">Last Name</label>
          <input id="lName" class="input" required />
        </div>
        <div class="md:col-span-2">
          <label class="label">Email</label>
          <input id="eMail" type="email" class="input" required />
        </div>
        <div>
          <label class="label">Department</label>
          <select id="dept" class="input" required>
            <option value="FOH">FOH</option>
            <option value="BOH">BOH</option>
          </select>
        </div>
        <div>
          <label class="label">Position</label>
          <select id="position" class="input" required></select>
        </div>
        <div>
          <label class="label">Report To</label>
          <select id="reportTo" class="input" required></select>
        </div>
        <div>
          <label class="label">Status</label>
          <select id="status" class="input" required>
            <option value="Active">Active</option>
            <option value="Leave">Leave</option>
            <option value="Terminated">Terminated</option>
          </select>
        </div>
      </div>

      <div class="flex items-center justify-end gap-2 pt-2">
        <button type="button" id="deleteEmp" class="btn btn-ghost hidden">Delete</button>
        <button type="submit" class="btn btn-gold">Save</button>
      </div>

      <input type="hidden" id="empId" />
    </form>
  </dialog>

  <script>
    // ---------------- CONFIG ----------------
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Admin-facing dropdown constants
    const REPORT_TO = ['Craig Reeves','Shoko Teng','Pablo Gonzalez','Janelle Teng','Mai Vu'];
    const POSITIONS = ['Server','Bartender','Busser','Host/Cashier','Food Runner','Dumpling Maker','Line Cook','Wok Chef','Pastry Chef','Dishwasher','Prep Cook'];

    // ---------------- STATE ----------------
    let session = null;
    let page = 1;
    const pageSize = 12;
    let currentRows = [];

    // ---------------- HELPERS ----------------
    const qs  = (sel,el=document)=>el.querySelector(sel);
    const qsa = (sel,el=document)=>[...el.querySelectorAll(sel)];
    const fmtName = (r)=>[r.first_name,r.last_name].filter(Boolean).join(' ');
    const toast = (msg)=>alert(msg);

    function setServerStatus(text='pending', color='text-yellow-700'){
      const el = qs('#serverStatus');
      if(!el) return;
      el.textContent = text;
      el.className = 'ml-1 font-semibold ' + color;
    }
    function setTabs(active){
      qsa('.tab').forEach(b=>{
        const t = b.dataset.tab;
        b.classList.toggle('tab-active', t===active);
        qs('#tab-'+t).classList.toggle('hidden', t!==active);
      });
      localStorage.setItem('jc-admin-active-tab', active);
    }
    function buildDropdowns(){
      qs('#reportTo').innerHTML = REPORT_TO.map(n=>`<option>${n}</option>`).join('');
      qs('#position').innerHTML  = POSITIONS.map(n=>`<option>${n}</option>`).join('');
    }
    function buildQuickFilters(list){
      const box = qs('#quickFilters');
      const uniqPositions = [...new Set(list.map(r=>r.position).filter(Boolean))].slice(0,18);
      box.innerHTML = uniqPositions.map(p=>`<button class="tag" data-pos="${p}">${p}</button>`).join('');
      qsa('[data-pos]').forEach(b=>{
        b.addEventListener('click', ()=>{
          qs('#searchInput').value = b.dataset.pos;
          renderTable();
        });
      });
    }
    function paginate(arr, page, size){ const s=(page-1)*size; return arr.slice(s, s+size); }

    // ---------------- AUTH (via Postgres RPC) ----------------
    const authSection = qs('#authSection');
    const appSection  = qs('#appSection');
    const userBox     = qs('#userBox');
    const adminNameEl = qs('#adminName');

    function showApp(profile){
      adminNameEl.textContent = `${profile.display_name} — ${profile.role || 'Administrator'}`;
      userBox.classList.remove('hidden');
      authSection.classList.add('hidden');
      appSection.classList.remove('hidden');
      setTabs(localStorage.getItem('jc-admin-active-tab') || 'dashboard');
    }
    function showAuth(){
      userBox.classList.add('hidden');
      authSection.classList.remove('hidden');
      appSection.classList.add('hidden');
    }

    async function rpcAdminLogin(username, pin){
      // client-side validation (fixes the “Please match the requested format” issue)
      if(!/^[a-z0-9._-]{2,32}$/i.test(username)) throw new Error('Invalid username');
      if(!/^[0-9]{4,8}$/.test(pin)) throw new Error('PIN must be 4–8 digits');
      const { data, error } = await supabase.rpc('admin_login', { p_username: username, p_pin: pin });
      if(error) throw error;
      // data is an array of rows the function returns; success = 1 row
      if(!data || !data.length) return null;
      return data[0];
    }

    // ---------------- DATA (Supabase) ----------------
    async function fetchEmployees(){
      const { data, error } = await supabase
        .from('employees')
        .select('*')
        .order('last_name', { ascending: true })
        .order('first_name', { ascending: true });
      if(error){ console.error(error); toast('Error loading employees'); return []; }
      return data || [];
    }
    async function insertEmployee(row){
      const { data, error } = await supabase.from('employees').insert(row).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }
    async function updateEmployee(id, patch){
      const { data, error } = await supabase.from('employees').update(patch).eq('id', id).select().single();
      if(error){ console.error(error); throw error; }
      return data;
    }
    async function deleteEmployee(id){
      const { error } = await supabase.from('employees').delete().eq('id', id);
      if(error){ console.error(error); throw error; }
    }

    // ---------------- RENDER ----------------
    function applyFilters(source){
      const q = (qs('#searchInput').value||'').trim().toLowerCase();
      const dept = qs('#deptFilter').value;
      return source.filter(r=>{
        const hay = `${fmtName(r)} ${r.email||''} ${r.position||''} ${r.department||''} ${r.report_to||''}`.toLowerCase();
        const passQ = q ? hay.includes(q) : true;
        const passD = dept ? (r.department===dept) : true;
        return passQ && passD;
      });
    }
    function renderKPIs(list){
      qs('#kpiTotal').textContent = list.length;
      qs('#kpiFOH').textContent = list.filter(r=>r.department==='FOH').length;
      qs('#kpiBOH').textContent = list.filter(r=>r.department==='BOH').length;
    }
    function renderTable(){
      const filtered = applyFilters(currentRows);
      const rows = paginate(filtered, page, pageSize);
      const tb = qs('#empTbody');
      tb.innerHTML = rows.map(r=>`
        <tr class="border-b border-jc-border">
          <td class="py-2 pr-4">${fmtName(r)}</td>
          <td class="py-2 pr-4">${r.email||''}</td>
          <td class="py-2 pr-4"><span class="tag">${r.department||''}</span></td>
          <td class="py-2 pr-4">${r.position||''}</td>
          <td class="py-2 pr-4">${r.report_to||''}</td>
          <td class="py-2 pr-4">${r.status||'Active'}</td>
          <td class="py-2 pr-0"><button class="btn btn-ghost text-sm" data-edit="${r.id}">Edit</button></td>
        </tr>`).join('');

      const start = (page-1)*pageSize+1, end = Math.min(page*pageSize, filtered.length);
      qs('#rowsInfo').textContent = filtered.length ? `Showing ${start}-${end} of ${filtered.length}` : 'No rows';

      qsa('[data-edit]').forEach(b=>{
        const id = b.dataset.edit;
        b.addEventListener('click', ()=>{
          const row = currentRows.find(x=>String(x.id)===String(id));
          openModal(row);
        });
      });
    }

    // ---------------- MODAL ----------------
    const empModal = qs('#empModal');
    const empForm  = qs('#empForm');
    const deleteBtn= qs('#deleteEmp');
    function openModal(row){
      buildDropdowns();
      if(row){
        qs('#empModalTitle').textContent = 'Edit Employee';
        qs('#empId').value = row.id;
        qs('#fName').value = row.first_name||'';
        qs('#lName').value = row.last_name||'';
        qs('#eMail').value = row.email||'';
        qs('#dept').value = row.department||'FOH';
        qs('#position').value = row.position||POSITIONS[0];
        qs('#reportTo').value = row.report_to||REPORT_TO[0];
        qs('#status').value = row.status||'Active';
        deleteBtn.classList.remove('hidden');
      } else {
        qs('#empModalTitle').textContent = 'Add Employee';
        empForm.reset();
        qs('#empId').value = '';
        deleteBtn.classList.add('hidden');
      }
      empModal.showModal();
    }

    // ---------------- INIT ----------------
    document.addEventListener('DOMContentLoaded', async ()=>{
      // Tabs
      qsa('.tab').forEach(b=>b.addEventListener('click', ()=>setTabs(b.dataset.tab)));

      // Show/Hide PIN
      qs('#togglePin').addEventListener('click', ()=>{
        const input = qs('#pin');
        const isPwd = input.type === 'password';
        input.type = isPwd ? 'text' : 'password';
        qs('#togglePin').textContent = isPwd ? 'Hide' : 'Show';
      });

      // Login
      qs('#loginForm').addEventListener('submit', async (e)=>{
        e.preventDefault();
        const username = qs('#username').value.trim();
        const pin = qs('#pin').value.trim();

        try{
          const profile = await rpcAdminLogin(username, pin);
          if(!profile){ toast('Invalid credentials or inactive admin.'); return; }
          session = { admin_id: profile.admin_id, employee_id: profile.employee_id };
          showApp(profile);
          await reloadData();
        } catch(err){
          console.error(err);
          toast('Login failed.');
        }
      });

      // Logout
      qs('#logoutBtn').addEventListener('click', ()=>{
        session = null;
        showAuth();
      });

      // Search / filters
      qs('#searchInput')?.addEventListener('input', ()=>{ page=1; renderTable(); });
      qs('#deptFilter')?.addEventListener('change', ()=>{ page=1; renderTable(); });

      // Pager
      qs('#prevPage')?.addEventListener('click', ()=>{ if(page>1){ page--; renderTable(); }});
      qs('#nextPage')?.addEventListener('click', ()=>{
        const filtered = applyFilters(currentRows);
        if(page*pageSize < filtered.length){ page++; renderTable(); }
      });

      // Add employee
      qs('#addEmployeeBtn')?.addEventListener('click', ()=>openModal(null));
      qs('#closeModal')?.addEventListener('click', ()=>empModal.close());

      // Save employee
      empForm.addEventListener('submit', async (e)=>{
        e.preventDefault();
        const id = qs('#empId').value || null;
        const row = {
          first_name: qs('#fName').value.trim(),
          last_name:  qs('#lName').value.trim(),
          email:      qs('#eMail').value.trim().toLowerCase(),
          department: qs('#dept').value,
          position:   qs('#position').value,
          report_to:  qs('#reportTo').value,
          status:     qs('#status').value
        };
        try{
          if(id){ await updateEmployee(id, row); } else { await insertEmployee(row); }
          empModal.close();
          await reloadData();
        } catch(err){
          toast('Save failed. Check console.');
        }
      });

      // Delete employee
      deleteBtn.addEventListener('click', async ()=>{
        const id = qs('#empId').value;
        if(!id) return;
        if(!confirm('Delete this employee?')) return;
        try{
          await deleteEmployee(id);
          empModal.close();
          await reloadData();
        } catch(err){
          toast('Delete failed. Check console.');
        }
      });

      // Restore last tab
      setTabs(localStorage.getItem('jc-admin-active-tab') || 'dashboard');
    });

    async function reloadData(){
      setServerStatus('pending','text-yellow-700');
      const list = await fetchEmployees();
      currentRows = list;
      qs('#reportTo') && buildDropdowns();
      renderKPIs(list);
      renderTable();
      buildQuickFilters(list);
      setServerStatus('ok','text-green-700');
    }
  </script>
</body>
</html>
