<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FAF9F6]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Administrator Portal — Jeng Chi Restaurant</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], 'sans': ['Inter','system-ui','sans-serif'] },
          colors: { 'jc-gold':'#C0A06D','jc-dark':'#1F2937','jc-muted':'#6B7280','jc-border':'#E5E7EB','jc-bg':'#FAF9F6' },
          boxShadow:{'soft':'0 12px 40px rgba(0,0,0,0.06)'}
        }
      }
    }
  </script>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-btn{border-radius:9999px;border:1px solid #E5E7EB;padding:.5rem 1rem}
    .tab-btn[disabled]{cursor:not-allowed;opacity:.55;background:#f3f4f6}
    .tab-active{background:white}
  </style>
</head>

<body class="h-full bg-jc-bg font-sans flex items-center justify-center">
  <main class="w-full max-w-6xl bg-white rounded-2xl border border-jc-border shadow-soft p-6 md:p-8">

    <!-- LOGIN VIEW -->
    <div id="loginView">
      <div class="flex flex-col items-center mb-6">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="w-28 mb-3" alt="Jeng Chi Logo">
        <h1 class="font-serif-head text-2xl text-jc-dark">Administrator Portal</h1>
        <p class="text-sm text-jc-muted">Restricted Access</p>
      </div>

      <div id="alert" class="hidden mb-4 p-3 rounded-lg text-center text-sm"></div>

      <form id="loginForm" class="grid grid-cols-1 md:grid-cols-3 gap-3">
        <div>
          <label class="block text-sm font-semibold text-jc-dark mb-1">Username</label>
          <input id="username" type="text" placeholder="pg / jt"
                 class="w-full border border-jc-border rounded-lg px-3 py-2 focus:ring-2 focus:ring-jc-gold focus:outline-none" required />
        </div>
        <div>
          <label class="block text-sm font-semibold text-jc-dark mb-1">PIN</label>
          <input id="pin" type="password" maxlength="6" placeholder="••••"
                 class="w-full border border-jc-border rounded-lg px-3 py-2 focus:ring-2 focus:ring-jc-gold focus:outline-none" required />
        </div>
        <div class="flex items-end">
          <button type="submit" class="w-full bg-jc-gold text-jc-dark font-semibold py-2 rounded-lg hover:brightness-95 transition-all">
            Sign In
          </button>
        </div>
      </form>
    </div>

    <!-- ADMIN VIEW -->
    <div id="adminView" class="hidden">
      <div class="flex justify-between items-center mb-6">
        <div class="flex items-center gap-3">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="w-24" alt="Jeng Chi Logo">
          <div>
            <div class="text-jc-dark font-semibold">Administrator Portal</div>
            <div class="text-xs text-jc-muted">Signed in as <span id="adminName">—</span> (<span id="adminInitials">—</span>)</div>
          </div>
        </div>
        <button id="signOutBtn" class="px-3 py-1 border border-jc-border rounded-md text-sm hover:bg-jc-border/30 transition-all">Sign out</button>
      </div>

      <!-- Tabs -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button id="tabDashboard" class="tab-btn tab-active">Dashboard</button>
        <button id="tabEmployees" class="tab-btn">Employees</button>
        <button id="tabAccess" class="tab-btn">Handbook Access</button>
        <button id="tabSurvey" class="tab-btn">Survey</button>
      </div>

      <!-- Content: Dashboard -->
      <section id="panelDashboard" class="rounded-2xl border border-jc-border shadow-soft bg-white p-6">
        <h2 class="font-serif-head text-xl text-jc-dark mb-4">Overview</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
          <div class="rounded-xl border border-jc-border p-4">
            <div class="text-xs text-jc-muted">Employees</div>
            <div id="statEmployees" class="text-2xl font-semibold">—</div>
          </div>
          <div class="rounded-xl border border-jc-border p-4">
            <div class="text-xs text-jc-muted">Active HB Access</div>
            <div id="statAccess" class="text-2xl font-semibold">—</div>
          </div>
          <div class="rounded-xl border border-jc-border p-4">
            <div class="text-xs text-jc-muted">Admins</div>
            <div id="statAdmins" class="text-2xl font-semibold">—</div>
          </div>
          <div class="rounded-xl border border-jc-border p-4">
            <div class="text-xs text-jc-muted">Session Started</div>
            <div id="statStarted" class="text-sm">—</div>
          </div>
        </div>
      </section>

      <!-- Content: Employees -->
      <section id="panelEmployees" class="hidden rounded-2xl border border-jc-border shadow-soft bg-white p-6">
        <h2 class="font-serif-head text-xl text-jc-dark mb-4">Employees</h2>
        <div class="mb-3 flex gap-2">
          <input id="empSearch" type="text" placeholder="Search name / initials / dept…" class="border border-jc-border rounded-lg px-3 py-2 w-full md:w-80">
          <button id="empReload" class="border border-jc-border rounded-lg px-3">Reload</button>
        </div>
        <div class="overflow-auto rounded-xl border border-jc-border">
          <table class="min-w-full text-sm">
            <thead class="bg-[#FAF9F6]">
              <tr class="text-left">
                <th class="px-3 py-2 border-b">Full Name</th>
                <th class="px-3 py-2 border-b">Initials</th>
                <th class="px-3 py-2 border-b">Department</th>
                <th class="px-3 py-2 border-b">Position</th>
                <th class="px-3 py-2 border-b">Email</th>
                <th class="px-3 py-2 border-b">Phone</th>
              </tr>
            </thead>
            <tbody id="empTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Content: Handbook Access -->
      <section id="panelAccess" class="hidden rounded-2xl border border-jc-border shadow-soft bg-white p-6">
        <h2 class="font-serif-head text-xl text-jc-dark mb-4">HB Handbook Access</h2>
        <div class="mb-3 flex gap-2">
          <input id="hbSearch" type="text" placeholder="Search user / initials…" class="border border-jc-border rounded-lg px-3 py-2 w-full md:w-80">
          <button id="hbReload" class="border border-jc-border rounded-lg px-3">Reload</button>
        </div>
        <div class="overflow-auto rounded-xl border border-jc-border">
          <table class="min-w-full text-sm">
            <thead class="bg-[#FAF9F6]">
              <tr class="text-left">
                <th class="px-3 py-2 border-b">User</th>
                <th class="px-3 py-2 border-b">Initials</th>
                <th class="px-3 py-2 border-b">Active</th>
                <th class="px-3 py-2 border-b">Department</th>
                <th class="px-3 py-2 border-b">Email</th>
              </tr>
            </thead>
            <tbody id="hbTbody"></tbody>
          </table>
        </div>
      </section>

      <!-- Content: Survey -->
      <section id="panelSurvey" class="hidden rounded-2xl border border-jc-border shadow-soft bg-white p-0 overflow-hidden">
        <iframe id="surveyFrame" title="Survey" class="w-full" style="min-height: 70vh; border:0"></iframe>
        <div id="surveyMsg" class="hidden p-4 text-sm text-jc-muted">
          The survey site refused to load inside an iframe (security headers). Open it directly: <a href="https://portal.jengchirestaurant.com/survey" class="underline" target="_blank" rel="noopener">portal.jengchirestaurant.com/survey</a>.
        </div>
      </section>
    </div>

    <footer class="text-center mt-8 text-xs text-jc-muted">
      400 North Greenville Avenue Ste 11, Richardson TX 75081<br/>
      © 2025 Jeng Chi Restaurant — All Rights Reserved
    </footer>
  </main>

  <script type="module">
    // ===== Supabase =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // ===== Elements =====
    const loginView = document.getElementById("loginView");
    const adminView = document.getElementById("adminView");
    const alertBox  = document.getElementById("alert");
    const loginForm = document.getElementById("loginForm");
    const signOutBtn= document.getElementById("signOutBtn");

    const adminNameEl = document.getElementById("adminName");
    const adminInitEl = document.getElementById("adminInitials");

    // Tabs
    const panels = {
      dashboard: document.getElementById("panelDashboard"),
      employees: document.getElementById("panelEmployees"),
      access:    document.getElementById("panelAccess"),
      survey:    document.getElementById("panelSurvey"),
    };
    const btns = {
      dashboard: document.getElementById("tabDashboard"),
      employees: document.getElementById("tabEmployees"),
      access:    document.getElementById("tabAccess"),
      survey:    document.getElementById("tabSurvey"),
    };

    // Dashboard stats
    const statEmployees = document.getElementById("statEmployees");
    const statAccess    = document.getElementById("statAccess");
    const statAdmins    = document.getElementById("statAdmins");
    const statStarted   = document.getElementById("statStarted");

    // Employees table
    const empTbody   = document.getElementById("empTbody");
    const empSearch  = document.getElementById("empSearch");
    const empReload  = document.getElementById("empReload");

    // HB table
    const hbTbody  = document.getElementById("hbTbody");
    const hbSearch = document.getElementById("hbSearch");
    const hbReload = document.getElementById("hbReload");

    // Survey iframe
    const surveyFrame = document.getElementById("surveyFrame");
    const surveyMsg   = document.getElementById("surveyMsg");

    // ===== Helpers =====
    function showAlert(msg, type="error"){
      alertBox.classList.remove("hidden");
      alertBox.textContent = msg;
      alertBox.className = `mb-4 p-3 rounded-lg text-center text-sm ${
        type==="error"
        ? "bg-red-100 text-red-700 border border-red-300"
        : "bg-green-100 text-green-700 border border-green-300"
      }`;
    }
    function hideAlert(){ alertBox.classList.add("hidden"); }

    function setActive(tab){
      // buttons
      Object.values(btns).forEach(b=>b.classList.remove("tab-active"));
      btns[tab].classList.add("tab-active");
      // panels
      Object.values(panels).forEach(p=>p.classList.add("hidden"));
      panels[tab].classList.remove("hidden");
    }

    async function loadDashboard(){
      const [{ data: empCount }, { data: hbCount }, { data: adminCount }] = await Promise.all([
        supabase.from("employees").select("id", { count: "exact", head: true }),
        supabase.from("hb_handbook_access").select("id", { count: "exact", head: true }).eq("is_active", true),
        supabase.from("hb_handbook_access").select("id", { count: "exact", head: true }).eq("is_admin", true),
      ]);
      statEmployees.textContent = empCount?.length ?? empCount ?? "—";
      statAccess.textContent    = hbCount?.length ?? hbCount ?? "—";
      statAdmins.textContent    = adminCount?.length ?? adminCount ?? "—";
      statStarted.textContent   = new Date().toLocaleString();
    }

    function renderEmpRows(rows){
      empTbody.innerHTML = rows.map(r => `
        <tr class="odd:bg-white even:bg-[#fbfbfb]">
          <td class="px-3 py-2 border-b">${r.full_name ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.initials ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.department ?? r.dept ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.position ?? r.position_title ?? r.job_title ?? ""}</td>
          <td class="px-3 py-2 border-b break-all">${r.email ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.phone ?? r.phone_number ?? ""}</td>
        </tr>
      `).join("");
    }
    async function loadEmployees(q=""){
      let s = supabase.from("employees").select("*").order("full_name", { ascending: true }).limit(250);
      if(q){
        const like = `%${q}%`;
        s = s.or(`full_name.ilike.${like},initials.ilike.${like},department.ilike.${like},position.ilike.${like},email.ilike.${like}`);
      }
      const { data } = await s;
      renderEmpRows(data ?? []);
    }

    function renderHbRows(rows){
      hbTbody.innerHTML = rows.map(r => `
        <tr class="odd:bg-white even:bg-[#fbfbfb]">
          <td class="px-3 py-2 border-b">${r.username ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.initials ?? ""}</td>
          <td class="px-3 py-2 border-b">${r.is_active ? "Yes" : "No"}</td>
          <td class="px-3 py-2 border-b">${r.department ?? ""}</td>
          <td class="px-3 py-2 border-b break-all">${r.email ?? ""}</td>
        </tr>
      `).join("");
    }
    async function loadHB(q=""){
      let s = supabase.from("hb_handbook_access").select("*").order("username").limit(250);
      if(q){
        const like = `%${q}%`;
        s = s.or(`username.ilike.${like},initials.ilike.${like},email.ilike.${like}`);
      }
      const { data } = await s;
      renderHbRows(data ?? []);
    }

    function initSurvey(){
      // load in-page; if blocked by X-Frame-Options, show message
      surveyFrame.src = "https://portal.jengchirestaurant.com/survey";
      surveyFrame.onload = () => { surveyMsg.classList.add("hidden"); };
      surveyFrame.onerror = () => { surveyMsg.classList.remove("hidden"); };
    }

    // ===== Session restore for admin =====
    async function restoreAdmin(){
      const token = localStorage.getItem("admin_session_token");
      if(!token) return;

      // We stored hb row columns in token record previously
      const { data } = await supabase
        .from("session_tokens")
        .select("*, hb_handbook_access(*)")
        .eq("token", token)
        .maybeSingle();

      const hb = data?.hb_handbook_access;
      if(hb?.is_admin){
        loginView.classList.add("hidden");
        adminView.classList.remove("hidden");
        adminNameEl.textContent = hb.employee_name || hb.full_name || "Administrator";
        adminInitEl.textContent = hb.initials || hb.username || "";
        // load default data
        setActive("dashboard");
        loadDashboard();
        loadEmployees();
        loadHB();
        initSurvey();
      }else{
        localStorage.removeItem("admin_session_token");
      }
    }

    // ===== Login flow =====
    loginForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      hideAlert();
      const username = document.getElementById("username").value.trim();
      const pin      = document.getElementById("pin").value.trim();
      if(!username || !pin) return showAlert("Please enter both username and PIN.");

      try{
        const { data: hb, error } = await supabase
          .from("hb_handbook_access")
          .select("*")
          .ilike("username", username)
          .maybeSingle();

        if(error || !hb) return showAlert("Invalid credentials.");
        if(!hb.is_admin)  return showAlert("Admin access required.");
        const okPin = (hb.pin_plain && hb.pin_plain.trim()===pin) || (hb.pin && hb.pin.trim()===pin);
        if(!okPin) return showAlert("Invalid credentials.");

        // Save token as admin session
        const token = crypto.randomUUID();
        const { error: upErr } = await supabase
          .from("session_tokens")
          .upsert({
            token,
            employee_id: hb.id,       // keep consistency with existing table
            username: hb.username,
            initials: hb.initials,
            created_at: new Date().toISOString(),
            expires_at: new Date(Date.now()+24*60*60*1000).toISOString()
          }, { onConflict: "employee_id" });
        if(upErr) throw upErr;

        localStorage.setItem("admin_session_token", token);
        showAlert("Welcome, administrator!", "success");

        loginView.classList.add("hidden");
        adminView.classList.remove("hidden");
        adminNameEl.textContent = hb.employee_name || hb.full_name || "Administrator";
        adminInitEl.textContent = hb.initials || hb.username || "";

        // Load data
        setActive("dashboard");
        loadDashboard();
        loadEmployees();
        loadHB();
        initSurvey();

      }catch(err){
        console.error("[ADMIN LOGIN ERROR]", err);
        showAlert("Login failed. Please try again.");
      }
    });

    // ===== Tab wiring =====
    btns.dashboard.addEventListener("click", ()=>{ setActive("dashboard"); loadDashboard(); });
    btns.employees.addEventListener("click", ()=>{ setActive("employees"); });
    btns.access.addEventListener("click", ()=>{ setActive("access"); });
    btns.survey.addEventListener("click", ()=>{ setActive("survey"); initSurvey(); });

    empReload.addEventListener("click", ()=>loadEmployees(empSearch.value.trim()));
    empSearch.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); loadEmployees(empSearch.value.trim()); } });

    hbReload.addEventListener("click", ()=>loadHB(hbSearch.value.trim()));
    hbSearch.addEventListener("keydown", (e)=>{ if(e.key==="Enter"){ e.preventDefault(); loadHB(hbSearch.value.trim()); } });

    // ===== Sign out =====
    signOutBtn.addEventListener("click", ()=>{
      localStorage.removeItem("admin_session_token");
      adminView.classList.add("hidden");
      loginView.classList.remove("hidden");
      showAlert("You have signed out.", "success");
    });

    // Auto-restore
    restoreAdmin();
  </script>
</body>
</html>
