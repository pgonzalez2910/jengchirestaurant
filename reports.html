<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Training Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A','jc-muted':'#6B7280','jc-gold':'#C0A06D',
            'jc-border':'#E5E7EB','jc-card':'#FFFFFF','jc-gold-dark':'#A58B5E'
          },
          boxShadow: { 'elevated':'0 30px 80px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- Supabase -->
  <script type="module" defer src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>

  <style>
    .card{ background:#FFF; border:1px solid #E5E7EB; border-radius:20px }
    .gold-divider{ height:4px; background:linear-gradient(90deg,#C0A06D,#D7BF8F,#C0A06D); border-radius:999px }
  </style>
</head>
<body class="h-full font-sans text-jc-ink">
  <main class="min-h-screen">
    <!-- ===== Admin Gate (no creds in code) ===== -->
    <section id="gate" class="px-4 py-12">
      <div class="max-w-md mx-auto card shadow-elevated p-8">
        <div class="text-center mb-6">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="h-12 w-auto mx-auto rounded" alt="Jeng Chi" onerror="this.style.display='none'">
          <h1 class="font-serif-head text-3xl mt-3">Executive Dashboard</h1>
          <p class="text-jc-muted mt-1">Corporate Reporting Access</p>
        </div>
        <form id="loginForm" class="space-y-4">
          <div>
            <label for="adminUser" class="block text-sm text-jc-muted mb-1">Username</label>
            <input id="adminUser" class="w-full rounded-xl border border-jc-border px-3.5 py-2.75 focus:outline-none focus:ring-2 focus:ring-jc-gold" placeholder="Enter admin username" autocomplete="username" autofocus>
          </div>
          <div>
            <label for="adminPass" class="block text-sm text-jc-muted mb-1">Password</label>
            <input id="adminPass" type="password" class="w-full rounded-xl border border-jc-border px-3.5 py-2.75 focus:outline-none focus:ring-2 focus:ring-jc-gold" placeholder="Password" autocomplete="current-password">
          </div>
          <button class="w-full rounded-xl py-3 font-semibold transition-colors duration-200" style="background:#C0A06D;color:#111" onmouseover="this.style.backgroundColor='#A58B5E'" onmouseout="this.style.backgroundColor='#C0A06D'">Sign in</button>
          <p id="gateErr" class="text-sm text-red-600 hidden mt-2"></p>
        </form>
        <p class="text-xs text-jc-muted mt-6 text-center">© 2025 Jeng Chi Restaurant — All Rights Reserved</p>
      </div>
    </section>

    <!-- ===== Dashboard ===== -->
    <section id="dash" class="hidden px-4 py-10">
      <div class="max-w-7xl mx-auto space-y-8">
        <!-- Header -->
        <div class="card p-6 shadow-elevated">
          <div class="flex items-center justify-between">
            <div>
              <h2 class="font-serif-head text-2xl">Corporate Enterprise Dashboard</h2>
              <p class="text-jc-muted">Steps of Service Training — Executive Reporting</p>
            </div>
            <div class="text-right">
              <div class="text-sm text-jc-muted">Signed in as</div>
              <div id="whoAmI" class="font-semibold">—</div>
              <button id="signOutBtn" class="text-sm text-red-600 hover:text-red-700 mt-1">Sign Out</button>
            </div>
          </div>
          <div class="gold-divider mt-4"></div>
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
              <div class="text-xs text-jc-muted uppercase">Total Submissions</div>
              <div id="kTotal" class="text-2xl font-semibold">0</div>
            </div>
            <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
              <div class="text-xs text-jc-muted uppercase">Perfect (Q2–Q9)</div>
              <div id="kPerfect" class="text-2xl font-semibold">0</div>
            </div>
            <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
              <div class="text-xs text-jc-muted uppercase">Most-Missed Question</div>
              <div id="kMissed" class="text-sm font-semibold mt-1">—</div>
            </div>
            <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
              <div class="text-xs text-jc-muted uppercase">Most Wrong (Employee)</div>
              <div id="kWorstEmp" class="text-sm font-semibold mt-1">—</div>
            </div>
          </div>
        </div>

        <!-- Charts -->
        <div class="grid lg:grid-cols-2 gap-6">
          <div class="card p-6 shadow-elevated">
            <h3 class="font-semibold">Kolache Preferences (Q1)</h3>
            <p class="text-jc-muted text-sm mb-2">Counts by favorite flavor (for future catering).</p>
            <canvas id="donutKolache" height="220"></canvas>
          </div>

          <div class="card p-6 shadow-elevated">
            <h3 class="font-semibold">Correct Answers by Question (Q2–Q9)</h3>
            <p class="text-jc-muted text-sm mb-2">How many employees answered each core question correctly.</p>
            <canvas id="barPerQuestion" height="220"></canvas>
          </div>
        </div>

        <!-- All submissions -->
        <div class="card p-6 shadow-elevated">
          <div class="flex items-center justify-between mb-3">
            <h3 class="font-semibold">All Submissions</h3>
            <span id="perfectList" class="text-sm text-jc-muted"></span>
          </div>
          <div class="overflow-x-auto">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left border-b border-jc-border">
                  <th class="py-2 pr-4 whitespace-nowrap">Submitted</th>
                  <th class="py-2 pr-4 whitespace-nowrap">Employee</th>
                  <th class="py-2 pr-4 whitespace-nowrap">Email</th>
                  <th class="py-2 pr-4 whitespace-nowrap">Phone</th>
                  <th class="py-2 pr-4 whitespace-nowrap">Core Score (Q2–Q9)</th>
                  <th class="py-2 whitespace-nowrap">Wrong (Core)</th>
                </tr>
              </thead>
              <tbody id="tblBody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

    // ===== Supabase project =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== DOM =====
    const gate = document.getElementById('gate');
    const dash = document.getElementById('dash');
    const gateErr = document.getElementById('gateErr');
    const loginForm = document.getElementById('loginForm');
    const adminUser = document.getElementById('adminUser');
    const adminPass = document.getElementById('adminPass');
    const signOutBtn = document.getElementById('signOutBtn');

    const whoAmI = document.getElementById('whoAmI');
    const kTotal = document.getElementById('kTotal');
    const kPerfect = document.getElementById('kPerfect');
    const kMissed = document.getElementById('kMissed');
    const kWorstEmp = document.getElementById('kWorstEmp');
    const perfectList = document.getElementById('perfectList');
    const tblBody = document.getElementById('tblBody');

    // ===== Answer key (internal q1..q8 are UI Q2..Q9) =====
    const correct = {
      q1: "When we greet the guest at the table",
      q2: "After offering an upsell to bottled water, tea, cocktails.",
      q3: "2 minute or 2 bite check back",
      q4: "There is no rule of 1",
      q5: "Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
      q6: "First (early) shift receives large table priority",
      q7: "Place the bar menu on the table then hand the menu to the seat",
      q8: ["11am","2-4pm","8-8:30pm"]
    };
    const CORE_KEYS = ['q1','q2','q3','q4','q5','q6','q7','q8'];
    const asArr = v => Array.isArray(v) ? v : (v ? [v] : []);
    const eqSet = (a,b) => { const A=new Set(a),B=new Set(b); if(A.size!==B.size) return false; for(const v of A) if(!B.has(v)) return false; return true; };
    const isCorrect = (k,val) => Array.isArray(correct[k]) ? eqSet(asArr(val), correct[k]) : (val === correct[k]);

    // Charts
    let donut, bar;
    const GOLD = '#C0A06D';
    const chartBase = { animation:false, responsive:true, maintainAspectRatio:false };

    function renderKolacheDonut(counts){
      const labels = ["Sausage","Sausage with Cheese","Sausage with Cheese & Jalapeño"];
      const ctx = document.getElementById('donutKolache');
      if (donut) donut.destroy();
      donut = new Chart(ctx, {
        type:'doughnut',
        data:{ labels, datasets:[{ data:labels.map(l=>counts[l]||0), backgroundColor:[GOLD,'#D7BF8F','#A58B5E'], borderWidth:2 }] },
        options:{ ...chartBase, cutout:'60%', plugins:{ legend:{ position:'bottom' } } }
      });
    }
    function renderPerQuestionBar(series, total){
      const ctx = document.getElementById('barPerQuestion');
      if (bar) bar.destroy();
      const labels = CORE_KEYS.map((_,i)=>`Q${i+2}`);
      bar = new Chart(ctx, {
        type:'bar',
        data:{ labels, datasets:[{ label:'Correct', data:CORE_KEYS.map(k=>series[k]||0), backgroundColor:GOLD, borderRadius:4 }] },
        options:{ ...chartBase, plugins:{legend:{display:false}}, scales:{ y:{ beginAtZero:true, suggestedMax: Math.max(5,total), ticks:{precision:0} } } }
      });
    }

    function signOut() {
      adminUser.value = '';
      adminPass.value = '';
      whoAmI.textContent = '—';
      dash.classList.add('hidden');
      gate.classList.remove('hidden');
    }
    signOutBtn.addEventListener('click', signOut);

    // Login -> call secure RPC with typed credentials (no hardcoding)
    loginForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      gateErr.classList.add('hidden'); gateErr.textContent = '';

      const u = (adminUser.value||'').trim();
      const p = (adminPass.value||'').trim();
      if (!u || !p) {
        gateErr.textContent = 'Enter username and password.';
        gateErr.classList.remove('hidden');
        return;
      }

      // ask server for data using provided creds
      const { data, error } = await sb.rpc('hb_ts_export_admin', { p_username: u, p_password: p });
      if (error) {
        console.error(error);
        gateErr.textContent = 'Invalid credentials or server error.';
        gateErr.classList.remove('hidden');
        return;
      }

      whoAmI.textContent = `${u} (Administrator)`;
      gate.classList.add('hidden');
      dash.classList.remove('hidden');

      // normalize rows
      const rows = (data||[]).map(r=>{
        const ans = r.answers || {};
        const coreScore = CORE_KEYS.reduce((acc,k)=> acc + (isCorrect(k, ans[k]) ? 1 : 0), 0);
        const wrongCore = CORE_KEYS.length - coreScore;
        return {
          submitted_at: r.submitted_at,
          full_name: r.full_name || r.username || '',
          username: r.username || '',
          email: (r.email ?? '') || '',
          phone: r.phone || '',
          coreScore,
          wrongCore,
          answers: ans
        };
      }).sort((a,b)=> b.wrongCore - a.wrongCore);

      // KPIs
      kTotal.textContent = rows.length.toString();
      const perfects = rows.filter(r=>r.coreScore === CORE_KEYS.length);
      kPerfect.textContent = perfects.length.toString();
      perfectList.textContent = perfects.length ? perfects.map(r=>r.full_name || r.username).join(', ') : '—';

      if (rows.length) {
        const worst = rows[0];
        kWorstEmp.textContent = `${worst.full_name || worst.username} (${worst.wrongCore} wrong)`;
      } else {
        kWorstEmp.textContent = '—';
      }

      // per-question correct counts & most missed
      const perQ = {}; CORE_KEYS.forEach(k=>perQ[k]=0);
      rows.forEach(r=>{ CORE_KEYS.forEach(k=>{ if (isCorrect(k, r.answers[k])) perQ[k] += 1; }); });
      const least = CORE_KEYS.slice().sort((a,b)=> (perQ[a]-perQ[b]))[0] || null;
      const missedQNum = least ? `Q${CORE_KEYS.indexOf(least) + 2}` : '—';
      kMissed.textContent = least ? `${missedQNum} — ${rows.length - perQ[least]} missed` : '—';

      // kolache (Q1)
      const kolCounts = { "Sausage":0, "Sausage with Cheese":0, "Sausage with Cheese & Jalapeño":0 };
      rows.forEach(r=>{ const pick = r.answers?.q0; if (kolCounts.hasOwnProperty(pick)) kolCounts[pick] += 1; });
      renderKolacheDonut(kolCounts);

      // bar chart
      renderPerQuestionBar(perQ, rows.length);

      // table
      const body = rows.map(r=>{
        const dt = r.submitted_at ? new Date(r.submitted_at).toLocaleString() : '';
        const rowClass = r.coreScore === CORE_KEYS.length ? 'bg-green-50/50' : '';
        return `
          <tr class="border-b border-jc-border/70 ${rowClass}">
            <td class="py-2 pr-4 whitespace-nowrap">${dt}</td>
            <td class="py-2 pr-4">${r.full_name || r.username || '—'}</td>
            <td class="py-2 pr-4">${r.email || '—'}</td>
            <td class="py-2 pr-4">${r.phone || '—'}</td>
            <td class="py-2 pr-4 font-semibold">${r.coreScore} / ${CORE_KEYS.length}</td>
            <td class="py-2 text-red-600 font-semibold">${r.wrongCore}</td>
          </tr>`;
      }).join('');
      tblBody.innerHTML = body;
    });
  </script>
</body>
</html>
