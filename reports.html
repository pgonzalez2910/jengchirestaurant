<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Training Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js + Data Labels -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <!-- jsPDF & html2canvas -->
  <script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-gold':'#C0A06D',
            'jc-muted':'#6B7280',
            'jc-ink':'#0F172A',
            'jc-border':'#E5E7EB'
          },
          boxShadow: { 'elevated':'0 25px 60px rgba(0,0,0,0.07), 0 6px 18px rgba(0,0,0,0.05)' }
        }
      }
    }
  </script>

  <style>
    .card{background:#FFF;border:1px solid #E5E7EB;border-radius:20px}
    .gold-divider{height:4px;background:linear-gradient(90deg,#C0A06D,#D7BE88,#C0A06D);border-radius:999px}
    .gold-btn{background:#C0A06D;color:#111;border-radius:10px;padding:10px 18px;font-weight:600}
    .gold-btn:hover{filter:brightness(0.95)}
    .page-break{page-break-after:always}
    @media print {.no-print{display:none!important}}
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-10 space-y-10">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="font-serif-head text-3xl">Executive Performance Dashboard</h1>
        <p class="text-jc-muted text-sm mt-1">Steps of Service Training — Corporate Report</p>
      </div>
      <div class="text-right">
        <div class="font-semibold text-sm text-jc-muted">Signed in as Janelle (Administrator)</div>
        <button id="btnPdf" class="gold-btn no-print mt-1">Download PDF Report</button>
      </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
      <div class="card p-5">
        <div class="text-xs uppercase text-jc-muted">Total Submissions</div>
        <div id="totalSub" class="text-3xl font-bold mt-2">—</div>
      </div>
      <div class="card p-5">
        <div class="text-xs uppercase text-jc-muted">Perfect (Q2 – Q9)</div>
        <div id="perfectNames" class="text-sm mt-2">—</div>
      </div>
      <div class="card p-5">
        <div class="text-xs uppercase text-jc-muted">Most Missed Question</div>
        <div id="mostMissed" class="text-sm mt-2">—</div>
      </div>
      <div class="card p-5">
        <div class="text-xs uppercase text-jc-muted">Most Wrong (Employee)</div>
        <div id="mostWrongEmp" class="text-sm mt-2">—</div>
      </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="card p-6 shadow-elevated flex flex-col items-center justify-center">
        <h2 class="font-serif-head text-xl mb-3">Kolache Preferences (Q1)</h2>
        <canvas id="kolacheChart" style="max-width:320px;max-height:320px;"></canvas>
      </div>
      <div class="card p-6 shadow-elevated">
        <h2 class="font-serif-head text-xl mb-3">Employee Scores</h2>
        <canvas id="scoreChart"></canvas>
      </div>
    </div>

    <section id="employeeReports" class="space-y-8"></section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
    const sb = createClient("https://kpldzwlftkvjjntgsqxx.supabase.co",
                            "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs");

    const correct = {
      q1:"When we greet the guest at the table",
      q2:"After offering an upsell to bottled water, tea, cocktails.",
      q3:"2 minute or 2 bite check back",
      q4:"There is no rule of 1",
      q5:"Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
      q6:"First (early) shift receives large table priority",
      q7:"Place the bar menu on the table then hand the menu to the seat",
      q8:["11am","2-4pm","8-8:30pm"],
      q9:["11am","Whenever they are empty"]
    };

    const qNames = {
      q1:"When do we place a black bev nap on the table?",
      q2:"When do we bring tap water to the guest?",
      q3:"What is the rule of 2?",
      q4:"What is the rule of 1?",
      q5:"According to our Steps of Service, what is the correct order for service?",
      q6:"Which of these is not true when hosting?",
      q7:"When handing the menu we…",
      q8:"When do we wipe all menus?",
      q9:"When do we fill the condiments on the table?"
    };

    const { data, error } = await sb.rpc('hb_ts_export_admin', { p_username:'Janelle', p_password:'DFW#1Dumplings' });
    if (error) { alert("Admin auth failed"); console.error(error); throw error; }

    document.getElementById('totalSub').textContent = data.length;
    const perfect = data.filter(e => e.score === e.total);
    document.getElementById('perfectNames').textContent =
      perfect.length ? perfect.map(e=>e.full_name).join(', ') : 'None';

    // compute most-missed question
    const missCounts = {};
    data.forEach(emp=>{
      const ans = emp.answers || {};
      for (const [k,v] of Object.entries(correct)) {
        const empVal = ans[k];
        const isArray = Array.isArray(v);
        const correctAns = isArray ? v.sort().join('|') : v;
        const empAns = Array.isArray(empVal) ? empVal.sort().join('|') : empVal;
        if (empAns !== correctAns) missCounts[k] = (missCounts[k]||0)+1;
      }
    });
    const topMiss = Object.entries(missCounts).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('mostMissed').textContent = topMiss ? `${topMiss[0].toUpperCase()} — ${topMiss[1]} missed` : '—';

    const worst = data.sort((a,b)=>a.score-b.score)[0];
    document.getElementById('mostWrongEmp').textContent = worst ? `${worst.full_name} (${worst.total - worst.score} wrong)` : '—';

    // ✨ Glossy Donut Chart (50% scale + percentage)
    const flavors = {};
    data.forEach(e=>{
      const flavor = e.answers?.q0 || '—';
      flavors[flavor] = (flavors[flavor]||0)+1;
    });
    const totalCount = Object.values(flavors).reduce((a,b)=>a+b,0);
    const labels = Object.keys(flavors);
    const values = Object.values(flavors);
    const percentages = values.map(v => ((v/totalCount)*100).toFixed(1));

    const ctx = document.getElementById('kolacheChart').getContext('2d');
    new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels.map((l,i)=>`${l} (${percentages[i]}%)`),
        datasets: [{
          data: values,
          backgroundColor: [
            'rgba(255, 206, 86, 0.95)', // gold
            'rgba(255, 159, 64, 0.95)', // orange
            'rgba(75, 192, 192, 0.95)', // teal
            'rgba(153, 102, 255, 0.95)', // violet
            'rgba(255, 99, 132, 0.95)'  // pink
          ],
          borderWidth: 2,
          borderColor: '#fff',
          hoverOffset: 8
        }]
      },
      options: {
        cutout: '65%',
        plugins: {
          legend: {
            position: 'bottom',
            labels: { color: '#333', font: { size: 12, family: 'Inter' } }
          },
          datalabels: {
            color: '#000',
            font: { weight: 'bold', size: 11 },
            formatter: (value, ctx) => {
              const pct = ((value / totalCount) * 100).toFixed(1);
              return pct + '%';
            }
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Bar chart
    new Chart(document.getElementById('scoreChart'), {
      type:'bar',
      data:{
        labels:data.map(e=>e.full_name),
        datasets:[{
          label:'Correct Answers',
          data:data.map(e=>e.score),
          backgroundColor:'#C0A06D'
        }]
      },
      options:{
        scales:{y:{beginAtZero:true,max:8}},
        plugins:{legend:{display:false}}
      }
    });

    // Employee reports
    const container = document.getElementById('employeeReports');
    data.forEach((emp,idx)=>{
      const card = document.createElement('div');
      card.className = 'card p-6 shadow-elevated';
      card.innerHTML = `
        <h2 class="font-serif-head text-xl">${emp.full_name}</h2>
        <p class="text-sm text-jc-muted mb-2">${emp.position} — ${emp.department}</p>
        <p class="font-semibold mb-4">Score: ${emp.score}/${emp.total}</p>
        ${Object.entries(qNames).map(([k,label])=>{
          const userAns = emp.answers?.[k];
          const right = Array.isArray(correct[k])
              ? JSON.stringify([...correct[k]].sort()) === JSON.stringify([...userAns].sort())
              : correct[k] === userAns;
          return `
            <div class="mb-3">
              <div class="font-medium">${label}</div>
              <div class="ml-2 text-sm ${right?'text-green-700':'text-red-700'}">
                ${Array.isArray(userAns)?userAns.join(', '):userAns||'—'}
                ${right?' ✅':' ❌ <em>Correct: '+(Array.isArray(correct[k])?correct[k].join(', '):correct[k])+'</em>'}
              </div>
            </div>`;
        }).join('')}
        ${idx<data.length-1?'<div class="page-break"></div>':''}
      `;
      container.appendChild(card);
    });

    // PDF export
    document.getElementById('btnPdf').addEventListener('click',async()=>{
      const pdf = new jspdf.jsPDF({orientation:'p',unit:'pt',format:'a4'});
      const pages = document.querySelectorAll('#employeeReports > div');
      for (let i=0;i<pages.length;i++){
        const canvas = await html2canvas(pages[i]);
        const img = canvas.toDataURL('image/png');
        const w = pdf.internal.pageSize.getWidth();
        const h = canvas.height * w / canvas.width;
        pdf.addImage(img,'PNG',0,0,w,h);
        if (i<pages.length-1) pdf.addPage();
      }
      pdf.save('JengChi_Training_Report.pdf');
    });
  </script>
</body>
</html>
