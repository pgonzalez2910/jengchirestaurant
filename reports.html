<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Corporate Executive Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            sans: ['Inter','system-ui','sans-serif']
          },
          colors: {
            'jc-ink':'#0F172A','jc-muted':'#6B7280','jc-gold':'#C0A06D',
            'jc-border':'#E5E7EB','jc-card':'#FFFFFF','jc-gold-dark':'#A58B5E'
          },
          boxShadow: {
            'elevated':'0 24px 60px rgba(0,0,0,0.08), 0 6px 20px rgba(0,0,0,0.05)'
          }
        }
      }
    }
  </script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <!-- jsPDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Supabase -->
  <script type="module" defer src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>

  <style>
    .card{background:#FFF;border:1px solid #E5E7EB;border-radius:20px;}
    .gold-divider{height:4px;background:linear-gradient(90deg,#C0A06D,#D7BF8F,#C0A06D);border-radius:999px;}
  </style>
</head>
<body class="h-full font-sans text-jc-ink">
<main class="min-h-screen">

  <!-- ===== Dashboard ===== -->
  <section id="dash" class="px-4 py-10">
    <div class="max-w-7xl mx-auto space-y-8">
      <!-- Header -->
      <div class="card p-6 shadow-elevated">
        <div class="flex items-center justify-between">
          <div>
            <h2 class="font-serif-head text-2xl">Corporate Enterprise Dashboard</h2>
            <p class="text-jc-muted">Steps of Service Training — Executive Reporting</p>
          </div>
          <div class="text-right">
            <div class="text-sm text-jc-muted">Signed in as</div>
            <div id="whoAmI" class="font-semibold">Janelle (Administrator)</div>
            <button id="pdfBtn" class="text-sm bg-jc-gold hover:bg-jc-gold-dark text-black px-3 py-1 rounded-md mt-2 font-semibold">Download PDF Report</button>
          </div>
        </div>
        <div class="gold-divider mt-4"></div>

        <div class="grid md:grid-cols-4 gap-4 mt-4">
          <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
            <div class="text-xs text-jc-muted uppercase">Total Submissions</div>
            <div id="kTotal" class="text-2xl font-semibold">0</div>
          </div>
          <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
            <div class="text-xs text-jc-muted uppercase">Perfect (Q2–Q9)</div>
            <div id="kPerfect" class="text-2xl font-semibold">0</div>
            <div id="kPerfectNames" class="text-xs text-jc-muted mt-1"></div>
          </div>
          <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
            <div class="text-xs text-jc-muted uppercase">Most-Missed Question</div>
            <div id="kMissed" class="text-sm font-semibold mt-1">—</div>
          </div>
          <div class="p-4 rounded-xl border border-jc-border bg-[#F9FAFB]">
            <div class="text-xs text-jc-muted uppercase">Most Wrong (Employee)</div>
            <div id="kWorstEmp" class="text-sm font-semibold mt-1">—</div>
          </div>
        </div>
      </div>

      <!-- Charts -->
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="card p-6 shadow-elevated">
          <h3 class="font-semibold mb-1">Kolache Preferences (Q1)</h3>
          <p class="text-jc-muted text-sm mb-2">Counts by favorite flavor (for future catering).</p>
          <canvas id="kolacheChart" height="250"></canvas>
        </div>

        <div class="card p-6 shadow-elevated">
          <h3 class="font-semibold mb-1">Employee Scores</h3>
          <p class="text-jc-muted text-sm mb-2">Each employee’s total correct answers (Q2–Q9).</p>
          <canvas id="scoreChart" height="250"></canvas>
        </div>
      </div>

      <!-- Summary Table -->
      <div class="card p-6 shadow-elevated">
        <h3 class="font-semibold mb-3">All Employee Scores</h3>
        <div class="overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead>
              <tr class="text-left border-b border-jc-border bg-jc-gold/10">
                <th class="py-2 px-3">Employee</th>
                <th class="py-2 px-3">Department</th>
                <th class="py-2 px-3">Position</th>
                <th class="py-2 px-3">Score</th>
                <th class="py-2 px-3">Wrong</th>
              </tr>
            </thead>
            <tbody id="tblBody"></tbody>
          </table>
        </div>
      </div>

      <!-- Employee Cards -->
      <div id="empCards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

    </div>
  </section>
</main>

<script type="module">
  import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
  const sb = createClient("https://kpldzwlftkvjjntgsqxx.supabase.co",
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs");

  const CORE_KEYS = ['q1','q2','q3','q4','q5','q6','q7','q8'];

  const res = await sb.rpc('hb_ts_export_admin', { p_username: 'Janelle', p_password: 'DFW#1Dumplings' });
  const rows = res.data || [];
  console.log(rows);

  // KPIs
  document.getElementById('kTotal').textContent = rows.length;
  const perfects = rows.filter(r => r.score === r.total);
  document.getElementById('kPerfect').textContent = perfects.length;
  document.getElementById('kPerfectNames').textContent = perfects.map(r=>r.full_name).join(', ') || '—';

  const worst = rows.sort((a,b)=>b.total-b.score - (a.total-a.score))[0];
  document.getElementById('kWorstEmp').textContent = `${worst.full_name} (${worst.total - worst.score} wrong)`;

  // Missed Question (rough)
  const perQ = {}; CORE_KEYS.forEach(k=>perQ[k]=0);
  rows.forEach(r=>{
    CORE_KEYS.forEach(k=>{
      if (r.answers[k] && typeof r.answers[k] === 'string') perQ[k]++;
    });
  });
  const least = Object.entries(perQ).sort((a,b)=>a[1]-b[1])[0];
  document.getElementById('kMissed').textContent = `${least[0].toUpperCase()} — ${rows.length - least[1]} missed`;

  // Kolache chart
  const kolCounts = {"Sausage":0,"Sausage with Cheese":0,"Sausage with Cheese & Jalapeño":0};
  rows.forEach(r=>{
    const pick = r.answers?.q0;
    if(kolCounts.hasOwnProperty(pick)) kolCounts[pick]++;
  });
  new Chart(document.getElementById('kolacheChart'), {
    type:'doughnut',
    data:{
      labels:Object.keys(kolCounts),
      datasets:[{data:Object.values(kolCounts), backgroundColor:['#C0A06D','#D7BF8F','#A58B5E']}]
    },
    options:{plugins:{legend:{position:'bottom'}}}
  });

  // Employee score chart
  new Chart(document.getElementById('scoreChart'), {
    type:'bar',
    data:{
      labels:rows.map(r=>r.full_name),
      datasets:[{label:'Score',data:rows.map(r=>r.score), backgroundColor:'#C0A06D'}]
    },
    options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:8}}}
  });

  // Table
  document.getElementById('tblBody').innerHTML = rows.map(r=>`
    <tr class="border-b border-jc-border hover:bg-jc-gold/5">
      <td class="py-2 px-3">${r.full_name}</td>
      <td class="py-2 px-3">${r.department}</td>
      <td class="py-2 px-3">${r.position}</td>
      <td class="py-2 px-3 font-semibold">${r.score}</td>
      <td class="py-2 px-3 text-red-600 font-semibold">${r.total - r.score}</td>
    </tr>`).join('');

  // Employee cards
  document.getElementById('empCards').innerHTML = rows.map(r=>{
    const answers = Object.entries(r.answers || {}).map(([k,v])=>`<li><strong>${k}:</strong> ${v}</li>`).join('');
    return `<div class="card p-4 shadow-elevated">
      <h4 class="font-semibold text-lg mb-1">${r.full_name}</h4>
      <p class="text-sm text-jc-muted mb-2">${r.position} — ${r.department}</p>
      <p class="text-sm font-semibold">Score: ${r.score}/${r.total}</p>
      <ul class="text-xs mt-2 space-y-1">${answers}</ul>
    </div>`;
  }).join('');

  // PDF Report
  document.getElementById('pdfBtn').addEventListener('click', async()=>{
    const doc = new window.jspdf.jsPDF('p','pt','a4');
    const dashboard = document.querySelector('main');
    const canvas = await html2canvas(dashboard,{scale:2});
    const img = canvas.toDataURL('image/png');
    const w = doc.internal.pageSize.getWidth();
    const h = (canvas.height * w) / canvas.width;
    doc.addImage(img,'PNG',0,0,w,h);
    doc.save('Executive_Report.pdf');
  });
</script>
</body>
</html>
