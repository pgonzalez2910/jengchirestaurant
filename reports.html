<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Training Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: { 'jc-gold':'#C0A06D','jc-muted':'#6B7280','jc-ink':'#0F172A','jc-border':'#E5E7EB' },
          boxShadow: { 'elevated':'0 25px 60px rgba(0,0,0,0.07), 0 6px 18px rgba(0,0,0,0.05)' }
        }
      }
    }
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .card{background:#FFF;border:1px solid #E5E7EB;border-radius:20px}
    .gold-btn{background:#C0A06D;color:#111;border-radius:10px;padding:10px 18px;font-weight:600}
    .gold-btn:hover{filter:brightness(0.95)}
    .page-break{page-break-after:always}
    @media print {.no-print{display:none!important}}
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-10 space-y-10">
    <header class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <h1 class="font-serif-head text-3xl">Executive Training Dashboard</h1>
        <p class="text-jc-muted text-sm mt-1">Steps of Service Training — Corporate Report</p>
      </div>
      <div class="text-right">
        <div class="font-semibold text-sm text-jc-muted">Signed in as Janelle (Administrator)</div>
        <button id="btnPdfReport" class="gold-btn no-print mt-1">Download Executive PDF Report</button>
      </div>
    </header>

    <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5">
      <div class="card p-5"><div class="text-xs uppercase text-jc-muted">Total Submissions</div><div id="totalSub" class="text-3xl font-bold mt-2">—</div></div>
      <div class="card p-5"><div class="text-xs uppercase text-jc-muted">Perfect (Q2 – Q9)</div><div id="perfectNames" class="text-sm mt-2">—</div></div>
      <div class="card p-5"><div class="text-xs uppercase text-jc-muted">Most Missed Question</div><div id="mostMissed" class="text-sm mt-2">—</div></div>
      <div class="card p-5"><div class="text-xs uppercase text-jc-muted">Most Wrong (Employee)</div><div id="mostWrongEmp" class="text-sm mt-2">—</div></div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
      <div class="card p-6 shadow-elevated flex flex-col items-center justify-center">
        <h2 class="font-serif-head text-xl mb-3">Kolache Preferences (Q1)</h2>
        <canvas id="kolacheChart" style="max-width:360px;max-height:360px;"></canvas>
      </div>
      <div class="card p-6 shadow-elevated">
        <h2 class="font-serif-head text-xl mb-3">Employee Scores</h2>
        <canvas id="scoreChart"></canvas>
      </div>
    </div>

    <section id="employeeReports" class="space-y-8"></section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
    window.sb = createClient(
      "https://kpldzwlftkvjjntgsqxx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
    );

    const correct = {
      q1:"When we greet the guest at the table",
      q2:"After offering an upsell to bottled water, tea, cocktails.",
      q3:"2 minute or 2 bite check back",
      q4:"There is no rule of 1",
      q5:"Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
      q6:"First (early) shift receives large table priority",
      q7:"Place the bar menu on the table then hand the menu to the seat",
      q8:["11am","2-4pm","8-8:30pm"],
      q9:["11am","Whenever they are empty"]
    };

    const qNames = {
      q1:"When do we place a black bev nap on the table?",
      q2:"When do we bring tap water to the guest?",
      q3:"What is the rule of 2?",
      q4:"What is the rule of 1?",
      q5:"What is the correct order for service?",
      q6:"Which of these is not true when hosting?",
      q7:"When handing the menu we…",
      q8:"When do we wipe all menus?",
      q9:"When do we fill the condiments on the table?"
    };

    const { data, error } = await sb.rpc('hb_ts_export_admin', { p_username:'Janelle', p_password:'DFW#1Dumplings' });
    if (error) { alert("Admin auth failed"); console.error(error); throw error; }

    // A–Z sort by full_name for everything (dashboard + charts + cards)
    const sorted = data.slice().sort((a,b)=> (a.full_name||"").localeCompare(b.full_name||"", undefined, {sensitivity:'base'}));

    document.getElementById('totalSub').textContent = sorted.length;
    const perfect = sorted.filter(e => e.score === e.total);
    document.getElementById('perfectNames').textContent =
      perfect.length ? perfect.map(e=>e.full_name).join(', ') : 'None';

    // Most missed question
    const missCounts = {};
    sorted.forEach(emp=>{
      const ans = emp.answers || {};
      for (const [k,v] of Object.entries(correct)) {
        const empVal = ans[k];
        const right = Array.isArray(v)
          ? JSON.stringify([...(empVal||[])].sort()) === JSON.stringify([...v].sort())
          : empVal === v;
        if (!right) missCounts[k] = (missCounts[k]||0)+1;
      }
    });
    const topMiss = Object.entries(missCounts).sort((a,b)=>b[1]-a[1])[0];
    document.getElementById('mostMissed').textContent = topMiss ? `${topMiss[0].toUpperCase()} — ${topMiss[1]} missed` : '—';

    const worst = sorted.slice().sort((a,b)=>a.score-b.score)[0];
    document.getElementById('mostWrongEmp').textContent = worst ? `${worst.full_name} (${worst.total - worst.score} wrong)` : '—';

    // Donut chart — Blue Sky + Glossy Green palette
    const flavors = {};
    sorted.forEach(e=>{
      const flavor = e.answers?.q0 || '—';
      flavors[flavor] = (flavors[flavor]||0)+1;
    });
    const totalCount = Object.values(flavors).reduce((a,b)=>a+b,0);
    const labels = Object.keys(flavors);
    const values = Object.values(flavors);

    const dctx = document.getElementById('kolacheChart').getContext('2d');
    const skyBlue = '#38BDF8';   // blue sky
    const glossyGreen = '#22C55E'; // glossy green
    const gradBlue = dctx.createLinearGradient(0,0,0,300);
    gradBlue.addColorStop(0, '#7DD3FC');
    gradBlue.addColorStop(1, skyBlue);
    const gradGreen = dctx.createLinearGradient(0,0,0,300);
    gradGreen.addColorStop(0, '#86EFAC');
    gradGreen.addColorStop(1, glossyGreen);

    const palette = [
      gradBlue,         // 1
      gradGreen,        // 2
      '#C0A06D',        // gold
      '#8B5CF6',        // violet
      '#F59E0B',        // amber
      '#F472B6',        // pink
      '#0EA5E9',        // sky variant
      '#16A34A'         // green variant
    ];

    const percentages = values.map(v => ((v/totalCount)*100).toFixed(1));

    new Chart(dctx, {
      type: 'doughnut',
      data: {
        labels: labels.map((l,i)=>`${l} (${percentages[i]}%)`),
        datasets: [{ data: values, backgroundColor: labels.map((_,i)=>palette[i % palette.length]), borderWidth: 2, borderColor: '#fff', hoverOffset: 8 }]
      },
      options: {
        cutout: '65%',
        plugins: {
          legend: { position: 'bottom', labels: { color: '#333', font: { size: 12, family: 'Inter' } } },
          datalabels: {
            color: '#000', font: { weight: 'bold', size: 11 },
            formatter: (value) => ((value / totalCount) * 100).toFixed(1) + '%'
          }
        }
      },
      plugins: [ChartDataLabels]
    });

    // Bar chart (A–Z)
    new Chart(document.getElementById('scoreChart'), {
      type:'bar',
      data:{
        labels:sorted.map(e=>e.full_name),
        datasets:[{ label:'Correct Answers', data:sorted.map(e=>e.score), backgroundColor:'#C0A06D' }]
      },
      options:{ scales:{y:{beginAtZero:true,max:8}}, plugins:{legend:{display:false}} }
    });

    // Employee cards (A–Z)
    const container = document.getElementById('employeeReports');
    const qEntries = Object.entries(qNames);
    sorted.forEach((emp, idx) => {
      const qaHtml = qEntries.map(([k, label]) => {
        const userAns = emp.answers?.[k];
        const right = Array.isArray(correct[k])
          ? JSON.stringify([...(userAns || [])].sort()) === JSON.stringify([...correct[k]].sort())
          : correct[k] === userAns;

        const userAnsText = Array.isArray(userAns) ? userAns.join(', ') : (userAns ?? '—');
        const corrText = Array.isArray(correct[k]) ? correct[k].join(', ') : correct[k];

        return `
          <div class="mb-3">
            <div class="font-medium">${label}</div>
            <div class="ml-2 text-sm ${right ? 'text-green-700' : 'text-red-700'}">
              ${userAnsText}${right ? ' ✅' : ` ❌ <em>Correct: ${corrText}</em>`}
            </div>
          </div>`;
      }).join('');

      const card = document.createElement('div');
      card.className = 'card p-6 shadow-elevated';
      card.innerHTML = `
        <h2 class="font-serif-head text-xl">${emp.full_name}</h2>
        <p class="text-sm text-jc-muted mb-2">${emp.position ?? ''} — ${emp.department ?? ''}</p>
        <p class="font-semibold mb-4">Score: ${emp.score}/${emp.total}</p>
        ${qaHtml}
        ${idx < sorted.length - 1 ? '<div class="page-break"></div>' : ''}
      `;
      container.appendChild(card);
    });

    // expose
    window.currentEmp = window.currentEmp || { is_owner: true };
  </script>

  <!-- Call the Edge Function (make sure to include Authorization/apikey headers) -->
  <script type="module">
    const EDGE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/generate-survey-report";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const btn = document.getElementById("btnPdfReport");
    btn?.addEventListener("click", async () => {
      try {
        btn.disabled = true; btn.textContent = "Generating PDF…";
        const resp = await fetch(EDGE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "apikey": SUPABASE_ANON_KEY
          },
          body: JSON.stringify({})
        });
        if (!resp.ok) throw new Error(await resp.text());
        const blob = await resp.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a"); a.href = url; a.download = "JengChi_Executive_Training_Report.pdf";
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
      } catch (e) { console.error(e); alert("PDF generation failed."); }
      finally { btn.disabled = false; btn.textContent = "Download Executive PDF Report"; }
    });
  </script>
</body>
</html>
