<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Training Dashboard</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head': ['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: { 'jc-gold':'#C0A06D','jc-muted':'#6B7280','jc-ink':'#0F172A','jc-border':'#E5E7EB', 'jc-bg':'#FBF8F3', 'jc-primary':'#0F172A' },
          boxShadow: { 'elevated':'0 15px 40px rgba(0,0,0,0.05), 0 4px 12px rgba(0,0,0,0.03)' }
        }
      }
    }
  </script>

  <style>
    body { font-family: Inter, system-ui, sans-serif; }
    .card{background:#FFF;border:1px solid #E5E7EB;border-radius:12px; transition: box-shadow 0.3s ease;}
    .card:hover { box-shadow: 0 0 0 2px rgba(192, 160, 109, 0.5); }
    .gold-btn{background:#C0A06D;color:#111;border-radius:8px;padding:8px 16px;font-weight:600;transition:all 0.15s ease-in-out}
    .gold-btn:hover{filter:brightness(0.95)}

    /* Sticky Header */
    #dashboardHeader {
        position: sticky; top: 0; z-index: 50;
        background-color: #ffffff; border-bottom: 1px solid #E5E7EB;
        padding: 1.5rem 0;
    }
    main { padding-top: 0; }

    /* Tabs */
    .tab-button {
        padding: 0.75rem 1.5rem; font-weight: 500; color: #6B7280;
        cursor: pointer; border-bottom: 2px solid transparent;
        transition: all 0.2s ease-in-out;
    }
    .tab-button.active { color: #C0A06D; border-bottom: 2px solid #C0A06D; font-weight: 600; }

    /* ─────── PRINT ONLY INDIVIDUAL REPORTS ─────── */
    @media print {
        /* Hide everything except the individual reports */
        .no-print, #dashboardHeader, #contentSummary, .tab-button { display: none !important; }
        body { background:#FFF !important; margin:0 !important; padding:0 !important; }
        #contentReports { display: block !important; margin:0 !important; }

        /* One employee per page */
        .employee-report { page-break-before: always; }
        #contentReports .employee-report:first-of-type { page-break-before: avoid; }

        /* Clean look */
        .card { box-shadow:none !important; border:1px solid #E5E7EB; }
    }

    /* Loading overlay */
    #loadingOverlay {
      position:fixed; inset:0; background:rgba(255,255,255,0.95);
      display:flex; align-items:center; justify-content:center;
      font-size:1.2rem; color:#6B7280; z-index:9999;
    }
  </style>
</head>

<body class="h-full font-sans text-jc-ink bg-[#FBF8F3]">
  <div id="loadingOverlay">Loading dashboard…</div>

  <div id="dashboardHeader" class="no-print">
      <header class="max-w-7xl mx-auto px-4 md:px-8 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-4">
              <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
                   alt="Jeng Chi Logo" class="h-8 w-auto rounded-lg shadow-sm" onerror="this.style.display='none'"/>
              <div>
                  <h1 class="font-serif-head text-xl text-jc-primary">Jeng Chi Training Oversight</h1>
                  <p class="text-jc-muted text-xs mt-0.5">Executive Data Dashboard</p>
              </div>
          </div>
          <div class="flex items-center gap-4">
              <div class="text-right">
                  <div class="font-semibold text-sm text-jc-muted">Janelle (Administrator)</div>
              </div>
              <button id="btnPrint" class="gold-btn">Print Individual Reports</button>
          </div>
      </header>
  </div>

  <main class="max-w-7xl mx-auto px-4 md:px-8 py-8 space-y-8">
    <!-- Tab Navigation (hidden in print) -->
    <div class="flex border-b border-jc-border no-print">
        <div id="tabSummary" class="tab-button active">Executive Summary</div>
        <div id="tabReports" class="tab-button">Individual Reports</div>
      </div>

    <!-- Executive Summary (hidden in print) -->
    <div id="contentSummary">
      <!-- Key Performance Indicators & Summary Widget -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
          <!-- Summary Card (Aesthetics Focused) -->
          <div class="card p-6 shadow-elevated bg-[#F6F2E8] lg:col-span-1 flex flex-col justify-between">
              <h2 class="font-serif-head text-xl border-b border-jc-border pb-2 mb-4">Performance Metrics </h2>
              <div class="space-y-4">
                  <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-jc-muted">Total Submissions</span>
                      <span id="totalSub" class="text-2xl font-bold text-jc-primary">—</span>
                  </div>
                  <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-jc-muted">Average Score</span>
                      <span id="avgScore" class="text-2xl font-bold text-jc-gold">—</span>
                  </div>
                  <div class="flex items-center justify-between">
                      <span class="text-sm font-medium text-jc-muted">Completion Rate</span>
                      <span id="completionRate" class="text-2xl font-bold text-green-600">—</span>
                  </div>
              </div>
              <div class="mt-6 pt-4 border-t border-jc-border text-xs text-jc-muted">
                  Analyzed against 9 core knowledge questions (Q2-Q10).
              </div>
          </div>

          <!-- Charts (Score and Preference) -->
          <div class="lg:col-span-2 grid grid-cols-1 md:grid-cols-2 gap-8">
              <div class="card p-6 shadow-elevated">
                  <h2 class="font-serif-head text-lg mb-3 border-b pb-2">Employee Score Comparison</h2>
                  <div style="height: 300px;"><canvas id="scoreChart"></canvas></div>
              </div>
              <div class="card p-6 shadow-elevated flex flex-col">
                  <h2 class="font-serif-head text-lg mb-3 border-b pb-2">Kolache Preferences (Q1)</h2>
                  <div class="flex-grow flex items-center justify-center">
                      <canvas id="kolacheChart" style="max-width:280px;max-height:280px;"></canvas>
                  </div>
              </div>
          </div>
      </div>

      <!-- Submission Status Table -->
      <section class="card p-6 shadow-elevated mt-8">
          <div class="flex items-center justify-between mb-4">
              <h2 class="font-serif-head text-xl">Front-of-House Submission Status</h2>
              <div class="text-sm text-jc-muted font-medium" id="serverCount">—</div>
          </div>
          <div class="overflow-x-auto">
              <table class="min-w-full border-separate border-spacing-0">
                  <thead class="bg-[#F6F2E8]">
                      <tr class="text-left text-xs uppercase font-semibold text-jc-muted">
                          <th class="py-3 px-4 rounded-tl-lg">Name</th>
                          <th class="py-3 px-4">Username</th>
                          <th class="py-3 px-4">Position</th>
                          <th class="py-3 px-4">Score</th>
                          <th class="py-3 px-4 text-center rounded-tr-lg">Submitted Date</th>
                      </tr>
                  </thead>
                  <tbody id="serverRows" class="text-sm"></tbody>
              </table>
          </div>
      </section>
      
      <!-- Key Errors Section -->
      <section class="grid grid-cols-1 md:grid-cols-2 gap-8 mt-8">
          <div class="card p-6 shadow-elevated">
              <h2 class="font-serif-head text-xl border-b pb-2 mb-4">Top Missed Questions</h2>
              <div id="missedList" class="space-y-2">—</div>
          </div>
          <div class="card p-6 shadow-elevated">
              <h2 class="font-serif-head text-xl border-b pb-2 mb-4">Lowest Score</h2>
              <div id="mostWrongEmp" class="text-sm font-medium">—</div>
          </div>
      </section>
      <section class="card p-6 shadow-elevated mt-8">
          <h2 class="font-serif-head text-xl border-b pb-2 mb-4">Perfect Scores & Top Performers</h2>
          <div id="perfectList" class="text-sm text-green-700 font-medium">—</div>
      </section>
    </div>

    <!-- Individual Reports (ONLY this prints) -->
    <div id="contentReports" class="hidden">
        <h2 class="font-serif-head text-2xl pt-2">Individual Training Reports</h2>
        <section id="employeeReports" class="space-y-8 mt-4"></section>
    </div>
  </main>

  <!-- ==================== SCRIPT ==================== -->
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
    const sb = createClient(
      "https://kpldzwlftkvjjntgsqxx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
    );

    /* ---------- CORRECT ANSWERS ---------- */
    const correct = {
      q1:["When we greet the guest at the table", "When the bev nap is wet"],
      q2:["When the guest asks for tap water", "After offering an upsell to bottled water, tea, cocktails."],
      q3:"2 minute or 2 bite check back",
      q4:"There is no rule of 1",
      q5:"Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
      q6:"Ask the customer what table they would like to sit",
      q7:"Place the bar menu on the table then hand the menu to the guest",
      q8:["2-4pm","8-8:30pm","Whenever they are dirty"],
      q9:["Before we take our break","Whenever they are used"]
    };
    const qNames = {
      q1:"When do we place a black bev nap on the table?",
      q2:"When do we bring tap water to the guest?",
      q3:"What is the rule of 2?",
      q4:"What is the rule of 1?",
      q5:"What is the correct order for service?",
      q6:"Which of these is not true when hosting?",
      q7:"When handing the menu we…",
      q8:"When do we wipe all menus?",
      q9:"When do we fill the condiments on the table?"
    };

    const arraysEqualSet = (a, b) => {
      const A = new Set(a.map(x=>x.trim())), B = new Set(b.map(x=>x.trim()));
      if (A.size!==B.size) return false;
      for (const v of A) if (!B.has(v)) return false;
      return true;
    };

    /* ---------- TAB SWITCHING ---------- */
    document.getElementById('tabSummary').addEventListener('click',()=>showContent('Summary'));
    document.getElementById('tabReports').addEventListener('click',()=>showContent('Reports'));
    function showContent(tab){
      document.getElementById('contentSummary').classList.toggle('hidden',tab!=='Summary');
      document.getElementById('contentReports').classList.toggle('hidden',tab!=='Reports');
      document.getElementById('tabSummary').classList.toggle('active',tab==='Summary');
      document.getElementById('tabReports').classList.toggle('active',tab==='Reports');
    }

    /* ---------- DATA FETCH (both params required) ---------- */
    let sorted = [];
    async function fetchDataAndProcess(){
      const { data, error } = await sb.rpc('hb_ts_export_admin',{
        p_password:'DFW#1Dumplings',
        p_username:'Janelle'
      });
      if (error){
        console.error(error);
        document.getElementById('loadingOverlay').textContent='Error loading data';
        return;
      }
      const recalculatedData = (data??[]).map(emp=>{
        let score=0; const ans=emp.answers||{};
        for (const k of Object.keys(correct)){
          const userAns=ans[k]; const correctAns=correct[k]; let ok=false;
          if (Array.isArray(correctAns)){
            const ua=Array.isArray(userAns)?userAns:(userAns?[userAns]:[]);
            ok=arraysEqualSet(ua,correctAns);
          }else{
            ok=(userAns||'').toString().trim()===(correctAns||'').toString().trim();
          }
          if(ok) score++;
        }
        return {...emp,score,total:9,answers:ans};
      });
      sorted = recalculatedData.slice().sort((a,b)=>(a.full_name||'').localeCompare(b.full_name||'',undefined,{sensitivity:'base'}));
      renderKPIs(); renderCharts(); await renderSubmissionTableAndReports();
      document.getElementById('loadingOverlay').remove();
    }

    /* ---------- RENDER FUNCTIONS ---------- */
    function renderKPIs() {
        const totalSubmissions = sorted.length;
        document.getElementById('totalSub').textContent = totalSubmissions;
        
        const totalActualScore = sorted.reduce((sum, emp) => sum + emp.score, 0);
        let avgScore = '—';
        if (totalSubmissions > 0) {
            avgScore = ((totalActualScore / totalSubmissions) / 9 * 100).toFixed(1) + '%';
        }
        document.getElementById('avgScore').textContent = avgScore;

        const staffCount = document.querySelectorAll('#serverRows tr').length || sorted.length;
        const completionPct = staffCount > 0 ? ((totalSubmissions / staffCount) * 100).toFixed(1) + '%' : '—';
        document.getElementById('completionRate').textContent = `${completionPct} (${totalSubmissions}/${staffCount})`;

        const missCounts = {};
        sorted.forEach(emp=>{
            for (const [k,v] of Object.entries(correct)) {
                const userAns = emp.answers?.[k];
                let isCorrect = false;
                if (Array.isArray(v)) {
                    const userArray = Array.isArray(userAns) ? userAns : (userAns ? [userAns] : []);
                    isCorrect = arraysEqualSet(userArray, v);
                } else {
                    const userStr = (userAns || '').toString().trim();
                    const correctStr = (v || '').toString().trim();
                    isCorrect = userStr === correctStr;
                }
                if (!isCorrect) missCounts[k] = (missCounts[k]||0)+1;
            }
        });
        
        const topMisses = Object.entries(missCounts).sort((a,b)=>b[1]-a[1]).slice(0, 3);
        const missedList = document.getElementById('missedList');
        missedList.innerHTML = topMisses.length ? topMisses.map(([k, count]) => `
            <div class="text-sm">
                <div class="font-semibold text-jc-primary">${qNames[k]}</div>
                <div class="text-red-500 text-xs">${count} staff missed this question.</div>
            </div>
        `).join('') : '<p class="text-sm text-jc-muted">No submissions yet.</p>';

        const perfect = sorted.filter(e => e.score === 9);
        const perfectList = document.getElementById('perfectList');
        if(perfectList) perfectList.textContent = perfect.length ? perfect.map(e=>e.full_name).join(', ') : 'None yet.';
        
        const worst = sorted.slice().sort((a,b)=>a.score-b.score)[0];
        let worstEmpHtml = '<div class="text-sm text-jc-muted">None.</div>';
        if (worst) {
            const nameColor = worst.score === 9 ? 'text-green-600' : 'text-red-600';
            const wrongCount = 9 - worst.score;
            worstEmpHtml = `
                <div class="text-sm">
                    <div class="font-semibold ${nameColor}">${worst.full_name}</div>
                    <div class="text-jc-muted text-xs">
                        ${worst.score}/9 Correct (${wrongCount} wrong)
                    </div>
                </div>
            `;
            if (sorted.every(e => e.score === 9)) {
                worstEmpHtml = `<div class="text-sm text-green-700 font-medium">All employees achieved a perfect score!</div>`;
            }
        }
        const mostWrongEmp = document.getElementById('mostWrongEmp');
        if (mostWrongEmp) mostWrongEmp.innerHTML = worstEmpHtml;
    }

    function renderCharts() {
        const kolacheChartEl = document.getElementById('kolacheChart');
        if (kolacheChartEl) {
            const flavors = {};
            sorted.forEach(e=>{ const f = e.answers?.q0 || '—'; flavors[f] = (flavors[f]||0)+1; });
            const totalCount = Object.values(flavors).reduce((a,b)=>a+b,0);
            const labels = Object.keys(flavors);
            const values = Object.values(flavors);
            const dctx = kolacheChartEl.getContext('2d');
            const palette = ['#C0A06D', '#7DD3FC', '#86EFAC', '#8B5CF6', '#F59E0B', '#F472B6', '#0EA5E9', '#16A34A'];
            
            new Chart(dctx, {
                type: 'doughnut',
                data: { labels, datasets: [{ data: values, backgroundColor: labels.map((_,i)=>palette[i%palette.length]), borderWidth:1, borderColor:'#fff', hoverOffset:8 }] },
                options: { responsive: true, maintainAspectRatio: false, cutout:'70%', plugins:{ legend:{ position:'bottom', labels:{ color:'#333', font:{ size:12, family:'Inter'}}}, datalabels:{ color:'#fff', font:{ weight:'bold', size:11 }, formatter: v => ((v/totalCount)*100).toFixed(0)+'%' } } },
                plugins:[ChartDataLabels]
            });
        }

        const scoreChartEl = document.getElementById('scoreChart');
        if (scoreChartEl) {
            const sctx = scoreChartEl.getContext('2d');
            const scores = sorted.map(e=>e.score);
            const names = sorted.map(e=>e.full_name);
            const gradient = sctx.createLinearGradient(0, 0, sctx.canvas.width, 0);
            gradient.addColorStop(0, '#D7BF8F'); gradient.addColorStop(1, '#C0A06D');

            new Chart(sctx, {
                type:'bar',
                data:{ labels: names, datasets:[{ label:'Score', data: scores, backgroundColor: gradient, borderRadius: 4 }] },
                options:{ responsive: true, maintainAspectRatio: false, indexAxis: 'y', scales:{ y:{ beginAtZero:true, grid: { display: false } }, x:{ max:9, ticks:{ stepSize: 1 }, title: { display: true, text: 'Correct Answers (Max 9)', color: '#6B7280' } } }, plugins:{ legend:{ display:false }, datalabels: { anchor: 'end', align: 'end', color: '#444', formatter: (value) => `${value}/9` } } },
                plugins:[ChartDataLabels]
            });
        }
    }

    async function renderSubmissionTableAndReports() {
        const { data: staff, error: staffErr } = await sb.from('hb_handbook_access').select('full_name, employee_name, username, department, phone, position, is_active').eq('is_active', true);
        if (staffErr) console.error(staffErr);

        const targetPositions = ['server', 'cashier', 'host','bartender'];
        const servers = (staff ?? []).filter(r => targetPositions.includes(String(r.position || '').toLowerCase())).map(r => {
            const username = r.username ?? '—';
            const submission = sorted.find(sub => (sub.username || '').toLowerCase() === (username.toLowerCase()));
            const displayName = (r.full_name && r.full_name.trim()) || (r.employee_name && r.employee_name.trim()) || (username && username.trim()) || '—';
            return { full_name: displayName, username, position: r.position ?? '—', department: r.department ?? '—', submitted: !!submission, score: submission?.score ?? 0, total: submission?.total ?? 9, submitted_at: submission?.submitted_at };
        }).sort((a,b)=> (a.full_name||'').localeCompare(b.full_name||'', undefined, {sensitivity:'base'}));

        const serverCount = document.getElementById('serverCount');
        if(serverCount) serverCount.textContent = `${sorted.length} of ${servers.length} Front-of-House staff total submitted`;

        const serverRows = document.getElementById('serverRows');
        const fmtDate = d => { try { return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }); } catch { return '—'; } };
        if (serverRows) serverRows.innerHTML = '';
        servers.forEach(s => {
            const tr = document.createElement('tr');
            const scoreClass = s.score === s.total ? 'text-green-600 font-bold' : (s.submitted ? 'text-jc-primary' : 'text-jc-muted');
            tr.className = 'hover:bg-[#FFF] border-b border-jc-border last:border-b-0';
            tr.innerHTML = `
                <td class="py-3 px-4 font-semibold">${s.full_name}</td>
                <td class="py-3 px-4 text-jc-muted">${s.username}</td>
                <td class="py-3 px-4">${s.position}</td>
                <td class="py-3 px-4 ${scoreClass}">${s.submitted ? `${s.score}/${s.total}` : '—'}</td>
                <td class="py-3 px-4 text-center text-jc-muted">${s.submitted ? fmtDate(s.submitted_at) : '<span class="text-red-500">PENDING</span>'}</td>
            `;
            serverRows.appendChild(tr);
        });

        const container = document.getElementById('employeeReports');
        const qEntries = Object.entries(qNames);
        if(container) container.innerHTML = '';
        sorted.forEach(emp => {
            const qaHtml = qEntries.map(([k, label]) => {
                if (k === 'q0') return '';
                const userAns = emp.answers?.[k];
                const correctAns = correct[k];
                let right = false;
                if (Array.isArray(correctAns)) {
                    const userArray = Array.isArray(userAns) ? userAns : (userAns ? [userAns] : []);
                    right = arraysEqualSet(userArray, correctAns);
                } else {
                    right = (userAns || '').toString().trim() === (correctAns || '').toString().trim();
                }
                const userAnsText = Array.isArray(userAns) ? userAns.join(', ') : (userAns ?? '—');
                const corrText = Array.isArray(correctAns) ? correctAns.join(', ') : correctAns;
                return `
                    <div class="mb-3 border-b border-dashed border-jc-border pb-3">
                        <div class="font-medium text-sm">${label}</div>
                        <div class="ml-2 text-xs">
                            <span class="${right ? 'text-green-700' : 'text-red-700'} font-semibold">
                                ${right ? 'Correct: ' + userAnsText : 'Incorrect: ' + userAnsText}
                            </span>
                            ${right ? '' : `<em class="text-jc-muted block mt-1">Correct: ${corrText}</em>`}
                        </div>
                    </div>`;
            }).join('');
            const card = document.createElement('div');
            card.className = 'card p-6 shadow-elevated employee-report';
            card.innerHTML = `
                <div class="flex items-center justify-between border-b pb-2 mb-4">
                    <h2 class="font-serif-head text-xl">${emp.full_name}</h2>
                    <p class="font-bold text-xl ${emp.score === emp.total ? 'text-green-600' : 'text-jc-gold'}">Score: ${emp.score}/${emp.total}</p>
                </div>
                <p class="text-sm text-jc-muted mb-4">${emp.position ?? ''} — ${emp.department ?? ''} | Submitted: ${fmtDate(emp.submitted_at)}</p>
                ${qaHtml}
            `;
            container.appendChild(card);
        });
    }

    /* ---------- PRINT BUTTON – ONLY INDIVIDUAL REPORTS ---------- */
    document.getElementById('btnPrint').addEventListener('click',()=>{
      document.getElementById('contentReports').classList.remove('hidden');
      window.print();
      window.addEventListener('afterprint',()=>{
        if (!document.getElementById('tabReports').classList.contains('active')){
          document.getElementById('contentReports').classList.add('hidden');
        }
      },{once:true});
    });

    /* ---------- INIT ---------- */
    fetchDataAndProcess();
    window.currentEmp = window.currentEmp || { is_owner:true };
  </script>
</body>
</html>
