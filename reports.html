<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FAF9F7]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Performance Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

  <!-- jsPDF + html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <!-- Supabase -->
  <script type="module" defer src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>

  <style>
    .card{background:#FFF;border-radius:20px;box-shadow:0 12px 32px rgba(0,0,0,0.04);}
    .divider{height:3px;background:linear-gradient(90deg,#C0A06D,#D8C194,#C0A06D);border-radius:999px;}
  </style>
</head>
<body class="font-sans text-jcText">
<main class="min-h-screen p-6">

  <!-- ===== HEADER ===== -->
  <div class="card p-6 mb-8">
    <div class="flex justify-between items-center flex-wrap gap-2">
      <div>
        <h1 class="font-serif text-2xl">Executive Performance Dashboard</h1>
        <p class="text-gray-500 text-sm">Steps of Service Training — Corporate Report</p>
      </div>
      <div class="text-right">
        <p class="text-xs text-gray-400">Signed in as</p>
        <p class="font-semibold">Janelle (Administrator)</p>
        <button id="pdfBtn" class="mt-2 bg-[#C0A06D] hover:bg-[#A78C60] text-white text-sm px-3 py-1.5 rounded-md shadow-soft">
          Download PDF Report
        </button>
      </div>
    </div>
    <div class="divider mt-3"></div>

    <div class="grid md:grid-cols-4 gap-4 mt-4">
      <div class="p-4 bg-[#F8F9FA] rounded-lg">
        <p class="text-xs text-gray-500 uppercase">Total Submissions</p>
        <p id="kTotal" class="text-2xl font-semibold">—</p>
      </div>
      <div class="p-4 bg-[#F8F9FA] rounded-lg">
        <p class="text-xs text-gray-500 uppercase">Perfect (Q2–Q9)</p>
        <p id="kPerfect" class="text-2xl font-semibold">—</p>
        <p id="kPerfectNames" class="text-xs text-gray-400 mt-1"></p>
      </div>
      <div class="p-4 bg-[#F8F9FA] rounded-lg">
        <p class="text-xs text-gray-500 uppercase">Most-Missed Question</p>
        <p id="kMissed" class="text-sm font-semibold mt-1">—</p>
      </div>
      <div class="p-4 bg-[#F8F9FA] rounded-lg">
        <p class="text-xs text-gray-500 uppercase">Most Wrong (Employee)</p>
        <p id="kWorstEmp" class="text-sm font-semibold mt-1">—</p>
      </div>
    </div>
  </div>

  <!-- ===== CHARTS ===== -->
  <div class="grid lg:grid-cols-2 gap-6">
    <div class="card p-6">
      <h3 class="font-semibold mb-1">Kolache Preferences (Q1)</h3>
      <p class="text-gray-500 text-sm mb-2">Flavor distribution by employee preference.</p>
      <canvas id="kolacheChart" height="250"></canvas>
    </div>

    <div class="card p-6">
      <h3 class="font-semibold mb-1">Employee Scores</h3>
      <p class="text-gray-500 text-sm mb-2">Total correct answers (Q2–Q9).</p>
      <canvas id="scoreChart" height="250"></canvas>
    </div>
  </div>

  <!-- ===== WRONG ANSWER SUMMARY ===== -->
  <div class="card p-6 mt-8">
    <h3 class="font-semibold mb-3">Wrong Answers Summary</h3>
    <table class="min-w-full text-sm border-t border-gray-200">
      <thead>
        <tr class="bg-[#F8F9FA] border-b border-gray-200">
          <th class="py-2 px-3 text-left">Employee</th>
          <th class="py-2 px-3 text-left">Question</th>
          <th class="py-2 px-3 text-left">Their Answer</th>
        </tr>
      </thead>
      <tbody id="wrongTable"></tbody>
    </table>
  </div>

  <!-- ===== EMPLOYEE SUMMARY CARDS ===== -->
  <h3 class="font-semibold mt-10 mb-4 text-lg">Employee Summary Cards</h3>
  <div id="empCards" class="grid md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

</main>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";
const sb = createClient(
  "https://kpldzwlftkvjjntgsqxx.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
);

// ==== Question Labels ====
const QUESTION_TEXTS = {
  q2: "When do we place a black bev nap on the table?",
  q3: "When do we bring tap water to the guest?",
  q4: "What is the rule of 2?",
  q5: "What is the rule of 1?",
  q6: "According to our Steps of Service, what is the correct order for service?",
  q7: "Which of these is not true when hosting?",
  q8: "When handing the menu we…..",
  q9: "When do we wipe all menus?"
};
const CORE_KEYS = Object.keys(QUESTION_TEXTS);

// ===== Fetch =====
const { data: rows } = await sb.rpc("hb_ts_export_admin", {
  p_username: "Janelle",
  p_password: "DFW#1Dumplings"
});

// ===== Handle Empty / No Data =====
if (!rows || rows.length === 0) {
  document.body.innerHTML = "<div class='p-10 text-center text-gray-500 font-medium'>No submissions found.</div>";
  throw new Error("No data");
}

// ===== KPI =====
document.getElementById("kTotal").textContent = rows.length;
const perfects = rows.filter(r=>r.score===r.total);
document.getElementById("kPerfect").textContent = perfects.length;
document.getElementById("kPerfectNames").textContent = perfects.map(r=>r.full_name).join(", ") || "—";
const worst = [...rows].sort((a,b)=>(b.total-b.score)-(a.total-a.score))[0];
document.getElementById("kWorstEmp").textContent = `${worst.full_name} (${worst.total - worst.score} wrong)`;

// ===== Most Missed =====
const qStats={}; CORE_KEYS.forEach(k=>qStats[k]={wrong:0});
rows.forEach(r=>CORE_KEYS.forEach(k=>{
  const ans=r.answers?.[k];
  if(ans && typeof ans==="object" && ans.correct===false) qStats[k].wrong++;
}));
const miss=Object.entries(qStats).sort((a,b)=>b[1].wrong-a[1].wrong)[0];
document.getElementById("kMissed").textContent=`${miss[0].toUpperCase()} — ${miss[1].wrong} missed`;

// ===== Kolache Donut (Distinct Colors + Labels + %) =====
const kol={}; rows.forEach(r=>{const pick=r.answers?.q0;if(pick)kol[pick]=(kol[pick]||0)+1;});
const totalK=Object.values(kol).reduce((a,b)=>a+b,0);
const colorPalette=[
  "#C0A06D","#E3B778","#9E806C","#F4C27E","#A2B86C","#D88484",
  "#79A7D3","#E6985C","#B180BF","#62A87C","#D6A56C","#BB8C55"
];
new Chart(document.getElementById("kolacheChart"),{
  type:"doughnut",
  plugins:[ChartDataLabels],
  data:{
    labels:Object.keys(kol),
    datasets:[{
      data:Object.values(kol),
      backgroundColor:colorPalette.slice(0,Object.keys(kol).length),
      borderWidth:2,borderColor:"#FFF"
    }]
  },
  options:{
    plugins:{
      legend:{position:"bottom"},
      datalabels:{
        color:"#000",
        font:{weight:"600"},
        formatter:(v,ctx)=>{
          const label=ctx.chart.data.labels[ctx.dataIndex];
          return `${label}\n${((v/totalK)*100).toFixed(1)}%`;
        }
      }
    }
  }
});

// ===== Employee Scores =====
new Chart(document.getElementById("scoreChart"),{
  type:"bar",
  data:{labels:rows.map(r=>r.full_name),datasets:[{data:rows.map(r=>r.score),backgroundColor:"#C0A06D"}]},
  options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,max:8}}}
});

// ===== Employee Summary =====
document.getElementById("empCards").innerHTML = rows.map(r=>{
  if(!r.answers) return `<div class='card p-5 text-gray-400 text-sm'>${r.full_name}<br><em>No answers submitted</em></div>`;
  const qa=CORE_KEYS.map(k=>{
    const ans=r.answers[k];
    let val="—",cls="text-gray-700";
    if(ans){
      if(typeof ans==="object" && ("value" in ans || "correct" in ans)){
        val=ans.value??"—";cls=ans.correct?"text-green-600":"text-red-600";
      }else if(typeof ans==="string"){val=ans.trim()||"—";}
    }
    return `<li class="mb-2"><div class="text-sm font-semibold">${QUESTION_TEXTS[k]}</div><div class="text-sm ${cls}">${val}</div></li>`;
  }).join("");
  return `<div class="card p-5">
     <h4 class="font-semibold text-lg">${r.full_name}</h4>
     <p class="text-sm text-gray-500">${r.position} — ${r.department}</p>
     <p class="font-semibold mt-1">Score: ${r.score}/${r.total}</p>
     <ul class="mt-2">${qa}</ul>
   </div>`;
}).join("");

// ===== PDF Export (All Employees in One File, One per Page) =====
document.getElementById("pdfBtn").addEventListener("click",async()=>{
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p","pt","a4");
  for(const [i,r] of rows.entries()){
    const qa = CORE_KEYS.map(k=>{
      const a=r.answers?.[k];
      let val="—",symbol="";
      if(a){
        if(typeof a==="object"){val=a.value??"—";symbol=a.correct?"✅":"❌";}
        else if(typeof a==="string"){val=a;symbol="";}
      }
      return `<tr><td>${QUESTION_TEXTS[k]}</td><td>${val}</td><td>${symbol}</td></tr>`;
    }).join("");
    const html = `
      <div style='padding:20pt;font-family:Inter;'>
        <h2 style='font-family:Playfair Display;font-size:20pt;margin-bottom:4pt;'>${r.full_name}</h2>
        <p style='font-family:Inter;font-size:11pt;color:#444;'>${r.position} — ${r.department}</p>
        <p style='font-weight:600;margin:8pt 0;'>Score: ${r.score}/${r.total}</p>
        <table style='width:100%;border-collapse:collapse;font-size:10pt;'>
          <thead><tr><th align='left'>Question</th><th align='left'>Answer</th><th>✓</th></tr></thead>
          <tbody>${qa}</tbody>
        </table>
      </div>`;
    const temp=document.createElement("div");
    temp.innerHTML=html;document.body.appendChild(temp);
    const canvas=await html2canvas(temp,{scale:2});
    document.body.removeChild(temp);
    const img=canvas.toDataURL("image/png");
    const w=doc.internal.pageSize.getWidth();
    const h=(canvas.height*w)/canvas.width;
    doc.addImage(img,"PNG",0,0,w,h);
    if(i<rows.length-1) doc.addPage();
  }
  doc.save("Executive_Report.pdf");
});
</script>
</body>
</html>
