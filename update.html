<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Benefits Admin Center</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet"/>
  <!-- Supabase SDK -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <script>
  // --- Configuration & Init ---
  const SUPABASE_URL = 'https://kpldzwlftkvjjntgsqxx.supabase.co';
  const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs';
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  let enrollments = [];
  let rates = [];
  let currentYear = '2026';

  const PLAN_NAMES = { 
    "F_PLAN_2W": "F-PLAN 2W / Base MAC", 
    "F_PLAN_3W": "F-PLAN 3W / Buy Up MAC", 
    "HMO": "HMO", 
    "HMO_HSA": "HMO HSA", 
    "PPO": "PPO", 
    "PLAN_1": "Vision Plan 1", 
    "WAIVE": "Waived" 
  };

  // --- UI Logic: Login ---
  async function handleLogin() {
    const u = document.getElementById('username').value.trim().toUpperCase();
    const p = document.getElementById('pin').value.trim();
    
    const { data } = await supabase
      .from('portal_users')
      .select()
      .eq('username', u)
      .eq('pin', p)
      .maybeSingle();

    const isEmergencyAuth = (u === 'ADMIN' && p === '1234');

    if (data || isEmergencyAuth) {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('adminPanel').classList.remove('hidden');
      loadData();
    } else {
      alert('Invalid Credentials. Try ADMIN / 1234.');
    }
  }

  function handleLogout() {
    location.reload();
  }

  // --- Data Loading ---
  async function loadData() {
    try {
      currentYear = document.getElementById('yearSelect').value;

      const ratesReq = await supabase.from('benefit_rates').select('*');
      rates = ratesReq.data || [];

      const enrollReq = await supabase
        .from('benefit_enrollments')
        .select('*')
        .eq('benefit_year', currentYear)
        .not('full_name', 'is', null)
        .order('full_name');
      
      enrollments = enrollReq.data || [];
      renderTable();

    } catch (err) {
      console.error("Error loading data:", err);
      enrollments = [];
      renderTable();
    }
  }

  function getRate(plan, tier, type) {
    if (!plan || plan === 'WAIVE') return 0;
    const r = rates.find(rt => 
      rt.effective_year == currentYear && 
      rt.plan_code === plan && 
      rt.tier === tier && 
      (rt.coverage || '').toLowerCase() === type.toLowerCase()
    );
    return r ? parseFloat(r.amount) : 0; 
  }

  function renderTable() {
    const tbody = document.querySelector('#benefitsTable tbody');
    if (!tbody) return;
    
    tbody.innerHTML = '';

    if (enrollments.length === 0) {
      tbody.innerHTML = `<tr><td colspan="7" class="p-8 text-center text-slate-400">No enrollments found for ${currentYear}</td></tr>`;
      return;
    }

    const buildOpts = (opts, selected) => opts.map(o => {
      const value = typeof o === 'object' ? o.value : o;
      const label = typeof o === 'object' ? o.label : (PLAN_NAMES[o] || o);
      return `<option value="${value}" ${selected===value?'selected':''}>${label}</option>`;
    }).join('');

    enrollments.forEach(en => {
      const medicalCost = getRate(en.medical_plan, en.tier_election, 'medical');
      const dentalCost = getRate(en.dental_plan, en.tier_election, 'dental');
      const visionCost = getRate(en.vision_plan, en.tier_election, 'vision');
      const total = medicalCost + dentalCost + visionCost;
      const totalAnnual = total * 26;

      const row = document.createElement('tr');
      row.className = "hover:bg-slate-50 transition-colors";
      row.dataset.id = en.id;

      row.innerHTML = `
        <td class="p-4 border-b font-medium text-slate-700">
          <div class="flex flex-col">
            <span>${en.full_name || 'Unknown'}</span>
            <span class="text-xs text-slate-400">${en.username || ''}</span>
          </div>
        </td>
        <td class="p-4 border-b">
          <select class="tier w-full p-2 border rounded bg-white focus:ring-2 focus:ring-brand-accent outline-none text-sm">
            ${buildOpts(['EO','ES','EC','EF'], en.tier_election)}
          </select>
        </td>
        <td class="p-4 border-b">
          <select class="medical w-full p-2 border rounded bg-white focus:ring-2 focus:ring-brand-accent outline-none text-sm">
            ${buildOpts([
              {value: 'WAIVE', label: 'Waived'},
              {value: 'ATBCB402', label: 'PPO'},
              {value: 'ATBAB303', label: 'HMO'},
              {value: 'ATBAP393', label: 'HMO HSA'}
            ], en.medical_plan)}
          </select>
        </td>
        <td class="p-4 border-b">
          <select class="dental w-full p-2 border rounded bg-white focus:ring-2 focus:ring-brand-accent outline-none text-sm">
            ${buildOpts(['WAIVE','F_PLAN_2W','F_PLAN_3W'], en.dental_plan)}
          </select>
        </td>
        <td class="p-4 border-b">
          <select class="vision w-full p-2 border rounded bg-white focus:ring-2 focus:ring-brand-accent outline-none text-sm">
            ${buildOpts(['WAIVE','PLAN_1'], en.vision_plan)}
          </select>
        </td>
        <td class="p-4 border-b font-bold text-brand-primary text-right pr-8 group relative cursor-help">
          $${total.toFixed(2)}
          <div class="absolute bottom-full right-0 mb-2 hidden group-hover:block w-48 bg-slate-800 text-white text-xs rounded p-2 shadow-lg z-50">
            Annual: $${totalAnnual.toLocaleString(undefined, {minimumFractionDigits: 2})}
            <div class="text-slate-400 text-[10px]">(26 Pay Periods)</div>
          </div>
        </td>
        <td class="p-4 border-b text-center">
          <button class="text-slate-400 hover:text-red-600 transition delete-btn" title="Clear Enrollment">
            <i class="fas fa-trash-alt"></i>
          </button>
        </td>
      `;
      tbody.appendChild(row);
    });

    // BULLETPROOF EVENT DELEGATION
    const tableBody = tbody;
    tableBody.onclick = (e) => {
      const btn = e.target.closest('.delete-btn');
      if (btn) deleteEnrollment(btn.closest('tr'));
    };
    tableBody.onchange = (e) => {
      const select = e.target.closest('select');
      if (select) saveRow(select.closest('tr'));
    };
  }

  async function saveRow(row) {
    if (!row) return;
    const id = row.dataset.id;
    if (!id) return;

    const updates = {
      tier_election: row.querySelector('.tier')?.value || 'EO',
      medical_plan: row.querySelector('.medical')?.value || 'WAIVE',
      dental_plan: row.querySelector('.dental')?.value || 'WAIVE',
      vision_plan: row.querySelector('.vision')?.value || 'WAIVE'
    };

    const { error } = await supabase
      .from('benefit_enrollments')
      .update(updates)
      .eq('id', id);

    if (error) alert("Save failed: " + error.message);
    else loadData();
  }

  async function deleteEnrollment(row) {
    if (!row || !confirm(`Reset benefits for ${row.querySelector('td span')?.textContent}?`)) return;
    const id = row.dataset.id;
    const { error } = await supabase
      .from('benefit_enrollments')
      .update({ tier_election: 'EO', medical_plan: 'WAIVE', dental_plan: 'WAIVE', vision_plan: 'WAIVE' })
      .eq('id', id);
    if (error) alert("Error: " + error.message);
    else loadData();
  }

  function toggleAddModal() {
    document.getElementById('addModal').classList.toggle('hidden');
  }

  async function addNewEmployee() {
    const fn = document.getElementById('newFirst').value.trim();
    const ln = document.getElementById('newLast').value.trim();
    const un = document.getElementById('newUser').value.trim().toUpperCase();
    if (!fn || !ln || !un) return alert("Fill all fields");

    const { error } = await supabase.from('benefit_enrollments').insert({
      username: un,
      full_name: `${fn} ${ln}`,
      benefit_year: currentYear,
      tier_election: 'EO',
      medical_plan: 'WAIVE',
      dental_plan: 'WAIVE',
      vision_plan: 'WAIVE'
    });

    if (error) alert("Error: " + error.message);
    else {
      toggleAddModal();
      document.getElementById('newFirst').value = '';
      document.getElementById('newLast').value = '';
      document.getElementById('newUser').value = '';
      loadData();
    }
  }
</script>

  <style>
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: #f1f5f9; }
    ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    .brand-primary { color: #1e293b; }
    .bg-brand-primary { background-color: #1e293b; }
    .text-brand-accent { color: #d4af37; }
    .bg-brand-accent { background-color: #d4af37; }
  </style>
</head>
<body class="antialiased text-slate-800">

<!-- Login Screen -->
<div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-gradient-to-br from-slate-900 to-slate-800">
  <div class="bg-white p-10 rounded-2xl shadow-2xl w-full max-w-md transform transition-all scale-100">
    <div class="text-center mb-8">
      <div class="inline-flex items-center justify-center w-16 h-16 rounded-full bg-slate-100 mb-4">
        <i class="fas fa-user-shield text-3xl text-brand-accent"></i>
      </div>
      <h1 class="text-2xl font-bold text-brand-primary">Admin Access</h1>
      <p class="text-slate-500 text-sm">Please authenticate to continue</p>
    </div>
    
    <div class="space-y-4">
      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">Username</label>
        <input id="username" type="text" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-accent outline-none transition">
      </div>
      <div>
        <label class="block text-xs font-bold text-slate-500 uppercase tracking-wider mb-1">PIN</label>
        <input id="pin" type="password" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-brand-accent outline-none transition">
      </div>
      <button onclick="handleLogin()" class="w-full bg-brand-primary text-white py-3 rounded-lg font-bold hover:bg-slate-700 shadow-lg hover:shadow-xl transition-all transform active:scale-95">
        Enter Portal
      </button>
    </div>
  </div>
</div>

<!-- Main App -->
<div id="adminPanel" class="min-h-screen hidden flex flex-col">
  
  <!-- Header -->
  <header class="bg-white shadow-md z-10 sticky top-0">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-20 flex justify-between items-center">
      <div class="flex items-center gap-4">
        <div class="w-10 h-10 bg-brand-primary rounded-lg flex items-center justify-center text-brand-accent">
          <i class="fas fa-file-invoice-dollar text-xl"></i>
        </div>
        <div>
          <h1 class="text-xl font-bold text-brand-primary leading-none">Benefits Admin</h1>
          <div class="flex items-center text-sm text-slate-500 mt-1">
            <span>Year:</span>
            <select id="yearSelect" onchange="loadData()" class="ml-2 bg-slate-100 border-none rounded px-2 py-0.5 text-brand-primary font-bold cursor-pointer hover:bg-slate-200 focus:ring-0">
              <option value="2025">2025</option>
              <option value="2026" selected>2026</option>
              <option value="2027">2027</option>
            </select>
          </div>
        </div>
      </div>
      <button onclick="handleLogout()" class="text-slate-400 hover:text-red-600 transition flex items-center gap-2 text-sm font-medium">
        <span>Logout</span>
        <i class="fas fa-sign-out-alt"></i>
      </button>
    </div>
  </header>

  <!-- Content -->
  <main class="flex-1 p-6 max-w-7xl mx-auto w-full">
    <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden flex flex-col h-[calc(100vh-8rem)]">
      
      <!-- Toolbar -->
      <div class="p-4 border-b border-slate-100 flex justify-between items-center bg-slate-50/50">
        <h2 class="font-bold text-slate-700">Enrollment Management</h2>
        <button onclick="toggleAddModal()" class="bg-brand-accent hover:bg-yellow-600 text-white px-4 py-2 rounded-lg text-sm font-bold shadow-sm transition flex items-center gap-2">
          <i class="fas fa-user-plus"></i> New Employee
        </button>
      </div>

      <!-- Table Container -->
      <div class="overflow-auto flex-1">
        <table class="w-full text-left border-collapse" id="benefitsTable">
          <thead class="bg-brand-primary text-white sticky top-0 z-10 shadow-sm">
            <tr>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold w-1/6">Employee</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold w-32">Tier</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold">Medical Plan</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold">Dental Plan</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold">Vision Plan</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold text-right pr-8 w-32">Bi-Weekly</th>
              <th class="p-4 text-xs uppercase tracking-wider font-semibold text-center w-16">Action</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-slate-100 text-sm">
            <!-- Rows injected here -->
          </tbody>
        </table>
      </div>
    </div>
  </main>

</div>

<!-- Add Employee Modal -->
<div id="addModal" class="fixed inset-0 z-50 flex items-center justify-center bg-slate-900/50 backdrop-blur-sm hidden">
  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md overflow-hidden animate-fade-in-up">
    <div class="bg-brand-primary p-4 flex justify-between items-center">
      <h3 class="text-white font-bold">Add New Employee</h3>
      <button onclick="toggleAddModal()" class="text-slate-400 hover:text-white transition"><i class="fas fa-times"></i></button>
    </div>
    <div class="p-6 space-y-4">
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">First Name</label>
          <input id="newFirst" class="w-full p-2 border rounded focus:ring-2 focus:ring-brand-accent outline-none">
        </div>
        <div>
          <label class="block text-xs font-bold text-slate-500 mb-1">Last Name</label>
          <input id="newLast" class="w-full p-2 border rounded focus:ring-2 focus:ring-brand-accent outline-none">
        </div>
      </div>
      <div>
        <label class="block text-xs font-bold text-slate-500 mb-1">Username (Unique ID)</label>
        <input id="newUser" placeholder="e.g. JDDOE" class="w-full p-2 border rounded focus:ring-2 focus:ring-brand-accent outline-none uppercase">
      </div>
      <button onclick="addNewEmployee()" class="w-full bg-brand-accent text-white py-3 rounded-lg font-bold hover:bg-yellow-600 transition mt-2">
        Create Record
      </button>
    </div>
  </div>
</div>

</body>
</html>
