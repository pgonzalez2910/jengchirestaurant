<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi Enterprise Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --jc-accent:#7A3D36; --jc-ink:#0f172a; --jc-muted:#6b7280; --jc-bg:#f5f6f8; --jc-border:#e5e7eb; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--jc-bg); color:var(--jc-ink)}
    .glass{background:linear-gradient(180deg,#fff,rgba(255,255,255,.92)); box-shadow:0 10px 24px rgba(16,24,40,.08),0 2px 8px rgba(16,24,40,.06); border:1px solid var(--jc-border)}
    .brand-gradient{background:linear-gradient(135deg, var(--jc-accent) 0%, #91493f 35%, #b86b61 100%)}
    .brand-chip{background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.35)}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.65rem 1rem; border-radius:.75rem; font-weight:600;}
    .btn-primary{background:var(--jc-accent); color:#fff; box-shadow:0 8px 20px rgba(122,61,54,.25)}
    .btn-outline{background:#fff; border:1px solid var(--jc-border); color:var(--jc-ink)}
    .tab-active{color:var(--jc-accent); background-color:#fff; border-color:var(--jc-border)}
    .table thead th{position:sticky; top:0; background:#fff}
    .table tr:hover{background:#fafafa}
    .ph{display:grid; place-items:center; background:repeating-linear-gradient(45deg,#fafafa,#fafafa 10px,#f0f0f0 10px,#f0f0f0 20px); border:1px dashed #d1d5db; color:#6b7280}
    @media print{ body{background:#fff} #app-shell{display:none} #report-print{display:block} @page{size:Letter; margin:0.5in} }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top Bar -->
  <header class="brand-gradient text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">Jeng Chi Enterprise Portal</h1>
            <div class="mt-0.5 inline-flex items-center brand-chip px-2 py-1 rounded-lg text-xs/relaxed">Inventory • Invoices • Vendors • Reports</div>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-3">
          <div class="relative">
             <select id="kpi-month-selector" class="rounded-xl border border-white/40 bg-white text-gray-800 px-4 py-2 outline-none w-48"></select>
          </div>
          <!-- ENABLED button with id for modal trigger -->
          <button id="new-invoice-btn" class="btn btn-primary rounded-xl" onclick="showTab('add-invoice')"><i data-lucide="file-plus"></i> New Invoice</button>
        </div>
      </div>
    </div>
  </header>

  <!-- Mobile FAB for New Invoice -->
  <button id="mobile-new-invoice-btn" class="md:hidden fixed right-4 bottom-4 z-40 btn btn-primary rounded-full shadow-xl" onclick="showTab('add-invoice')">
    <i data-lucide="file-plus"></i>
  </button>

  <!-- App Shell -->
  <div id="app-shell" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- KPI Row -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Invoices (<span id="kpi-month-label">Current Month</span>)</p>
        <p id="kpi-invoices" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Total Spend (<span id="kpi-spend-label">Current Month</span>)</p>
        <p id="kpi-spend" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Vendors</p>
        <p id="kpi-vendors" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Catalog Items</p>
        <p id="kpi-items" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
    </section>

    <!-- Tabs -->
    <nav class="flex flex-wrap gap-2 mb-6">
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="products"><i data-lucide="package"></i> Products</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="invoices"><i data-lucide="receipt"></i> Invoices</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="vendors"><i data-lucide="building-2"></i> Vendors</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="reports"><i data-lucide="bar-chart-3"></i> Reports</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="standardize"><i data-lucide="list-checks"></i> Standardize</button>
      <button class="tab-btn btn btn-primary rounded-xl" data-tab="add-invoice"><i data-lucide="plus-circle"></i> Add/Edit Invoice</button>
    </nav>

    <!-- PRODUCTS (live) -->
    <section id="tab-products" class="glass rounded-2xl p-6 hidden">
      <header class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-5">
        <div>
          <h2 class="text-xl font-extrabold">Product Price History</h2>
          <p class="text-sm text-slate-500">Live from <code>price_history</code>. Search & filter are client-side.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <input id="searchProducts" class="rounded-xl border border-slate-200 bg-white px-3 py-2 w-72" placeholder="Search name, vendor, item #" />
            <div class="absolute right-3 top-2.5 text-slate-400"><i data-lucide="search"></i></div>
          </div>
          <select id="vendorFilter" class="rounded-xl border border-slate-200 bg-white px-3 py-2"><option value="">All Vendors</option></select>
          <select id="sortSelect" class="rounded-xl border border-slate-200 bg-white px-3 py-2">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="price-desc">Price (High → Low)</option>
            <option value="price-asc">Price (Low → High)</option>
          </select>
        </div>
      </header>
      <div class="overflow-hidden rounded-xl border border-slate-200">
        <table class="table w-full">
          <thead>
            <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
              <th class="p-3">Invoice Date</th>
              <th class="p-3">Invoice #</th>
              <th class="p-3">Vendor</th>
              <th class="p-3">Item #</th>
              <th class="p-3">Product</th>
              <th class="p-3 text-right">Price</th>
            </tr>
          </thead>
          <tbody id="productsTbody" class="text-sm">
            <tr><td class="p-4 text-center" colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="productsEmpty" class="hidden text-center text-slate-500 text-sm py-4">No matches.</div>
    </section>

    <!-- INVOICES (live, grouped) -->
    <section id="tab-invoices" class="glass rounded-2xl p-6 hidden">
      <header class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-extrabold">Invoices</h2>
          <p class="text-sm text-slate-500">Grouped by invoice number (from <code>price_history</code>).</p>
        </div>
        <div class="flex items-center gap-3">
          <input id="searchInvoices" placeholder="Search invoice # or vendor" class="rounded-xl border border-slate-200 px-3 py-2" />
          <select id="month-filter-invoices" class="rounded-xl border border-slate-200 px-3 py-2"></select>
          <button id="exportCsv" class="btn btn-outline rounded-xl"><i data-lucide="download"></i> Export</button>
        </div>
      </header>
      <div class="overflow-hidden rounded-xl border border-slate-200">
        <table class="table w-full">
          <thead>
            <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
              <th class="p-3">Date</th>
              <th class="p-3">Invoice #</th>
              <th class="p-3">Vendor</th>
              <th class="p-3 text-right">Lines</th>
              <th class="p-3 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="invoicesTbody" class="text-sm">
            <tr><td class="p-4 text-center" colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="invoicesEmpty" class="hidden text-center text-slate-500 text-sm py-4">No invoices.</div>
    </section>

    <!-- VENDORS (live summary) -->
    <section id="tab-vendors" class="glass rounded-2xl p-6 hidden">
      <header class="flex items-center justify-between mb-5">
        <div><h2 class="text-xl font-extrabold">Vendors</h2><p class="text-sm text-slate-500">Totals from <span id="vendors-month-label">current month</span>.</p></div>
      </header>
      <div id="vendorsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <!-- REPORTS (static) -->
    <section id="tab-reports" class="glass rounded-2xl p-6 hidden">
      <header class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-extrabold">Reports</h2>
          <p class="text-sm text-slate-500">Dynamic reports for <span id="reports-month-label">current month</span>.</p>
        </div>
        <select id="month-filter-reports" class="rounded-xl border border-slate-200 px-3 py-2 bg-white"></select>
        <button class="btn btn-outline rounded-xl" onclick="window.print()"><i data-lucide="printer"></i> Print</button>
      </header>
      <div class="grid lg:grid-cols-2 gap-6">
        <div class="glass rounded-xl p-4">
          <h3 class="font-semibold mb-2">Spend by Vendor</h3>
          <div id="spend-by-vendor-table" class="ph h-64 rounded-md">Data will be displayed here.</div>
        </div>
        <div class="glass rounded-xl p-4">
          <h3 class="font-semibold mb-2">Monthly Trend</h3>
          <div class="ph h-64 rounded-md">Chart Placeholder</div>
        </div>
      </div>
      <div class="mt-6 glass rounded-xl p-4">
          <h3 class="font-semibold mb-2">Product Price History</h3>
          <div class="flex items-center gap-2 mb-3">
            <input id="report-product-search" class="rounded-xl border border-slate-200 px-3 py-2 flex-1" placeholder="Search for product name or item #" />
            <button id="report-search-btn" class="btn btn-outline rounded-xl"><i data-lucide="search"></i> Search</button>
          </div>
          <div id="product-report-content" class="ph h-64 rounded-md flex items-center justify-center">Search for a product to see its price history.</div>
      </div>
    </section>

    <!-- STANDARDIZE (static) -->
    <section id="tab-standardize" class="glass rounded-2xl p-6 hidden">
      <header class="mb-4"><h2 class="text-xl font-extrabold">Standardize Product Names</h2><p class="text-sm text-slate-500">Static form (hook up later).</p></header>
      <div class="flex flex-col lg:flex-row gap-6">
        <div class="lg:w-1/2 space-y-3">
          <div class="flex gap-2">
            <input class="flex-1 rounded-xl border border-slate-200 px-3 py-2" placeholder="Search (static)" disabled/>
            <select class="rounded-xl border border-slate-200 px-3 py-2" disabled><option>All Vendors</option></select>
            <button class="btn btn-outline rounded-xl" disabled><i data-lucide="search"></i> Search</button>
          </div>
          <div class="overflow-hidden rounded-xl border border-slate-200 max-h-[420px]">
            <table class="table w-full">
              <thead>
                <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
                  <th class="p-3">Vendor</th><th class="p-3">Item #</th><th class="p-3">Product Name</th><th class="p-3">Current Standard</th>
                </tr>
              </thead>
              <tbody class="text-sm">
                <tr><td class="p-3">Bakemark</td><td class="p-3">BK-044</td><td class="p-3">Tapioca Starch 50lb</td><td class="p-3">Tapioca Starch 50 lb</td></tr>
                <tr><td class="p-3">Restaurant Depot</td><td class="p-3">RD-556</td><td class="p-3">SOY SAUCE 1 GAL</td><td class="p-3">Soy Sauce 1 Gal</td></tr>
                <tr><td class="p-3">Supermarket</td><td class="p-3">FT-39AB12</td><td class="p-3">Green Onions</td><td class="p-3">Green Onions</td></tr>
              </tbody>
            </table>
          </div>
        </div>
        <div class="lg:w-1/2 glass rounded-2xl p-5">
          <h3 class="font-semibold">Apply Standard Name</h3>
          <p class="text-sm text-slate-500 mb-3">Static form (disabled).</p>
          <div class="flex gap-2 mb-3">
            <input class="flex-1 rounded-xl border border-slate-200 px-3 py-2" placeholder="e.g., Green Onions (Medium)" disabled/>
            <button class="btn btn-primary rounded-xl" disabled><i data-lucide="check"></i> Apply</button>
          </div>
          <div class="text-xs text-slate-500">No data actions here.</div>
        </div>
      </div>
    </section>
    
    <!-- ADD/EDIT INVOICE -->
    <section id="tab-add-invoice" class="glass rounded-2xl p-6 hidden">
      <div class="w-full max-w-4xl mx-auto">
        <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between bg-white">
          <div class="flex items-center gap-2">
            <div class="h-9 w-9 rounded-lg bg-[var(--jc-accent,#7A3D36)]/10 grid place-items-center">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-[var(--jc-accent,#7A3D36)]"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><path d="M14 2v6h6"/></svg>
            </div>
            <h3 class="text-lg font-extrabold">Add/Edit Invoice</h3>
          </div>
          <button id="clear-form" class="btn btn-outline">Start New</button>
        </div>

        <!-- Top form: vendor + invoice/date -->
        <div class="px-6 py-5 space-y-5">
          <div class="grid sm:grid-cols-2 lg:grid-cols-4 gap-3">
            <div class="sm:col-span-2">
              <label class="block text-xs font-semibold text-slate-600 mb-1">Vendor</label>
              <div class="flex gap-2">
                <select id="inv-vendor" class="w-full rounded-xl border border-slate-300 px-3 py-2"></select>
                <button id="vendor-refresh" title="Refresh vendors" class="rounded-xl border border-slate-300 px-3">⟳</button>
              </div>
              <p class="text-[11px] text-slate-500 mt-1">Pick existing vendor or type a new one below.</p>
              <input id="vendor-custom" placeholder="Or enter a new vendor name" class="mt-1 w-full rounded-xl border border-slate-300 px-3 py-2"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Invoice #</label>
              <input id="inv-number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="e.g., INV-10234"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Invoice Date</label>
              <input id="inv-date" type="date" class="w-full rounded-xl border border-slate-300 px-3 py-2"/>
            </div>
          </div>

          <!-- Edit/Load existing invoice -->
          <div id="edit-invoice-section" class="flex gap-3">
              <input id="load-invoice-number" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Load existing invoice #" />
              <button id="load-invoice-btn" class="btn btn-outline whitespace-nowrap"><i data-lucide="folder-open"></i> Load Invoice</button>
          </div>

          <!-- Line builder -->
          <div class="rounded-2xl border border-slate-200 overflow-hidden">
            <div class="px-4 py-3 bg-slate-50 border-b border-slate-200 flex flex-wrap gap-3 items-end">
              <div class="min-w-[160px]">
                <label class="block text-xs font-semibold text-slate-600 mb-1">Item Code</label>
                <input id="line-code" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="e.g., BK-044"/>
                <div id="code-suggest" class="mt-1 hidden rounded-xl border border-slate-200 bg-white shadow-lg max-h-48 overflow-auto text-sm"></div>
              </div>
              <div class="flex-1 min-w-[200px]">
                <label class="block text-xs font-semibold text-slate-600 mb-1">Product Name</label>
                <input id="line-name" class="w-full rounded-xl border border-slate-300 px-3 py-2" placeholder="Auto-fills from code; editable"/>
              </div>
              <div class="w-[140px]">
                <label class="block text-xs font-semibold text-slate-600 mb-1">Price</label>
                <input id="line-price" type="number" step="0.01" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-right" placeholder="0.00"/>
              </div>
              <div class="w-[120px]">
                <label class="block text-xs font-semibold text-slate-600 mb-1">Qty</label>
                <input id="line-qty" type="number" step="1" class="w-full rounded-xl border border-slate-300 px-3 py-2 text-right" value="1"/>
              </div>
              <div class="w-[140px]">
                <label class="block text-xs font-semibold text-slate-600 mb-1">Department</label>
                <select id="line-dept" class="w-full rounded-xl border border-slate-300 px-3 py-2">
                  <option value="general">General</option>
                  <option value="kitchen">Kitchen</option>
                  <option value="bar">Bar</option>
                  <option value="front">Front</option>
                  <option value="bakery">Bakery</option>
                </select>
              </div>
              <button id="line-add" class="h-[42px] px-4 rounded-xl bg-emerald-600 text-white font-semibold">Add Line</button>
            </div>

            <div class="overflow-auto">
              <table class="w-full text-sm">
                <thead class="text-slate-500 text-xs uppercase tracking-wide sticky top-0 bg-white">
                  <tr>
                    <th class="p-3 text-left">Item #</th>
                    <th class="p-3 text-left">Product</th>
                    <th class="p-3 text-right">Price</th>
                    <th class="p-3 text-right">Qty</th>
                    <th class="p-3 text-right">Line Total</th>
                    <th class="p-3">Actions</th>
                  </tr>
                </thead>
                <tbody id="lines-body"></tbody>
              </table>
            </div>
            <div class="px-4 py-3 border-t border-slate-200 bg-slate-50 flex items-center justify-end gap-6">
              <div class="text-slate-600">Items: <span id="sum-items">0</span></div>
              <div class="text-slate-600">Subtotal: <span id="sum-subtotal">$0.00</span></div>
              <div class="text-lg font-extrabold">Total: <span id="sum-total">$0.00</span></div>
            </div>
          </div>
          <div class="mt-4 flex justify-end">
            <button id="inv-save" class="px-6 py-2 rounded-xl bg-[var(--jc-accent,#7A3D36)] text-white font-semibold shadow-md">Save Invoice</button>
          </div>
        </div>
      </div>
    </section>
  </div>

  <!-- Print-only Report sheet (static) -->
  <section id="report-print" class="hidden p-6">
    <h1 class="text-2xl font-extrabold mb-1">JENG CHI — Spend Summary</h1>
    <p class="text-sm text-slate-600 mb-4">Period: Last 30 days • Generated: <span id="print-date"></span></p>
    <table class="w-full text-sm border border-slate-300">
      <thead class="bg-slate-100">
        <tr><th class="text-left p-2 border-b border-slate-300">Vendor</th><th class="text-right p-2 border-b border-slate-300">Invoices</th><th class="text-right p-2 border-b border-slate-300">Total</th></tr>
      </thead>
      <tbody id="print-body">
        <tr><td class="p-2 border-t border-slate-200">—</td><td class="p-2 border-t border-slate-200 text-right">—</td><td class="p-2 border-t border-slate-200 text-right">—</td></tr>
      </tbody>
    </table>
  </section>

  <!-- ===== Live Data Script (Supabase reads) ===== -->
  <script>
    // Icons
    lucide.createIcons();

    // Tabs
    const tabs=["products","invoices","vendors","reports","standardize", "add-invoice"];
    const btns=document.querySelectorAll('.tab-btn');
    const sections=tabs.map(t=>document.getElementById(`tab-${t}`));
    function showTab(name){
      sections.forEach(s=>s.classList.add('hidden'));
      document.getElementById(`tab-${name}`).classList.remove('hidden');
      btns.forEach(b=>{ if(b.dataset.tab===name){b.classList.add('tab-active');} else{b.classList.remove('tab-active');} });
      lucide.createIcons();
    }
    showTab('products');
    btns.forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));

    document.getElementById('print-date').textContent = new Date().toLocaleString();

    // ===== Supabase (live read from price_history) =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.sb = sb; // (optional) handy for console tests

    // State
    let rows = []; // raw price_history rows
    let viewRows = []; // filtered/sorted
    let currentMonthYear = new Date().toISOString().slice(0, 7);

    // DOM refs
    const productsTbody = document.getElementById('productsTbody');
    const productsEmpty = document.getElementById('productsEmpty');
    const searchProducts = document.getElementById('searchProducts');
    const vendorFilter = document.getElementById('vendorFilter');
    const sortSelect = document.getElementById('sortSelect');
    const kpiInvoices = document.getElementById('kpi-invoices');
    const kpiSpend = document.getElementById('kpi-spend');
    const kpiVendors = document.getElementById('kpi-vendors');
    const kpiItems = document.getElementById('kpi-items');
    const kpiMonthLabel = document.getElementById('kpi-month-label');
    const kpiSpendLabel = document.getElementById('kpi-spend-label');

    const invoicesTbody = document.getElementById('invoicesTbody');
    const invoicesEmpty = document.getElementById('invoicesEmpty');
    const searchInvoices = document.getElementById('searchInvoices');
    const monthFilterInvoices = document.getElementById('month-filter-invoices');
    const exportCsvBtn = document.getElementById('exportCsv');

    const vendorsGrid = document.getElementById('vendorsGrid');
    const printBody = document.getElementById('print-body');
    
    const reportProductSearch = document.getElementById('report-product-search');
    const reportSearchBtn = document.getElementById('report-search-btn');
    const productReportContent = document.getElementById('product-report-content');
    const monthFilterReports = document.getElementById('month-filter-reports');
    const kpiMonthSelector = document.getElementById('kpi-month-selector');
    const reportsMonthLabel = document.getElementById('reports-month-label');
    const vendorsMonthLabel = document.getElementById('vendors-month-label');
    const spendByVendorTable = document.getElementById('spend-by-vendor-table');


    // Helpers
    const fmtCurrency = (n)=> new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD' }).format(n||0);
    const fmtDate = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';

    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function applyFilters(){
      const q = (searchProducts.value||'').toLowerCase();
      const vend = vendorFilter.value;
      viewRows = rows.filter(r=>{
        const hay = `${r.product_name||''} ${r.vendor||''} ${r.item_number||''}`.toLowerCase();
        const passQ = !q || hay.includes(q);
        const passV = !vend || r.vendor === vend;
        return passQ && passV;
      });
      const sort = sortSelect.value;
      viewRows.sort((a,b)=>{
        if(sort==='date-desc') return (new Date(b.invoice_date)-new Date(a.invoice_date));
        if(sort==='date-asc') return (new Date(a.invoice_date)-new Date(b.invoice_date));
        if(sort==='price-desc') return Number(b.price||0)-Number(a.price||0);
        if(sort==='price-asc') return Number(a.price||0)-Number(b.price||0);
        return 0;
      });
      renderProducts();
    }

    function renderProducts(){
      if(viewRows.length===0){
        productsTbody.innerHTML = '';
        productsEmpty.classList.remove('hidden');
        return;
      }
      productsEmpty.classList.add('hidden');
      const html = viewRows.map(r=>`
        <tr>
          <td class="p-3">${fmtDate(r.invoice_date)}</td>
          <td class="p-3">${r.invoice_number||''}</td>
          <td class="p-3">${r.vendor||''}</td>
          <td class="p-3">${r.item_number||''}</td>
          <td class="p-3">${r.product_name||r.standard_name||''}</td>
          <td class="p-3 text-right font-semibold">${fmtCurrency(Number(r.price||0))}</td>
        </tr>`).join('');
      productsTbody.innerHTML = html;
    }

    function renderVendorFilter(){
      const vendors = Array.from(new Set(rows.map(r=>r.vendor).filter(Boolean))).sort();
      vendorFilter.innerHTML = '<option value="">All Vendors</option>' + vendors.map(v=>`<option>${v}</option>`).join('');
    }

    function renderInvoices(){
      const q=(searchInvoices.value||'').toLowerCase();
      // group by invoice_number + vendor + date
      const groups = new Map();
      const filteredRows = rows.filter(r => r.invoice_date && r.invoice_date.startsWith(currentMonthYear));
      
      if(filteredRows.length===0){ invoicesTbody.innerHTML=''; invoicesEmpty.classList.remove('hidden'); return; }
      invoicesEmpty.classList.add('hidden');

      for(const r of filteredRows){
        const key = `${r.invoice_number||'N/A'}|${r.vendor||''}|${fmtDate(r.invoice_date)}`;
        const sum = (Number(r.price)||0) * (Number(r.qty)||0);
        let g = groups.get(key);
        if(!g) {
          g = {date:fmtDate(r.invoice_date), inv:r.invoice_number||'N/A', vendor:r.vendor||'', lines:0, total:0};
          groups.set(key,g);
        }
        g.lines+=1; g.total+=sum;
      }
      const list = [...groups.values()].filter(g=>{
        const hay = `${g.inv} ${g.vendor}`.toLowerCase();
        return !q || hay.includes(q);
      }).sort((a,b)=> new Date(b.date)-new Date(a.date));
      invoicesTbody.innerHTML = list.map(g=>`
        <tr>
          <td class="p-3">${g.date}</td>
          <td class="p-3">${g.inv}</td>
          <td class="p-3">${g.vendor}</td>
          <td class="p-3 text-right">${g.lines}</td>
          <td class="p-3 text-right font-semibold">${fmtCurrency(g.total)}</td>
        </tr>`).join('');
    }

    function renderVendorsSummary(){
      const filteredRows = rows.filter(r => r.invoice_date && r.invoice_date.startsWith(currentMonthYear));
      const byVendor = new Map();
      for(const r of filteredRows){
        const v = r.vendor||'Unknown';
        let o = byVendor.get(v);
        if(!o){
          o = {vendor:v, total:0, lines:0};
          byVendor.set(v,o);
        }
        o.total += (Number(r.price)||0) * (Number(r.qty)||0); o.lines += 1;
      }
      const list = [...byVendor.values()].sort((a,b)=> b.total-a.total);
      vendorsGrid.innerHTML = list.map(v=>`
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">${v.vendor}</div>
            <span class="text-slate-400 text-sm">${v.lines} lines</span>
          </div>
          <div class="text-sm text-slate-600">Total</div>
          <div class="text-xl font-extrabold">${fmtCurrency(v.total)}</div>
        </div>`).join('');
        
      const monthLabel = new Date(currentMonthYear + '-01').toLocaleString('en-US', { month: 'long', year: 'numeric' });
      vendorsMonthLabel.textContent = `Totals from ${monthLabel}`;

      // Print sheet body
      printBody.innerHTML = list.slice(0,12).map(v=>
        `<tr><td class="p-2 border-t border-slate-200">${v.vendor}</td><td class="p-2 border-t border-slate-200 text-right">${v.lines}</td><td class="p-2 border-t border-slate-200 text-right">${fmtCurrency(v.total)}</td></tr>`
      ).join('');
    }

    function updateKpis(){
      // Filter by the selected month
      const filteredRows = rows.filter(r => r.invoice_date && r.invoice_date.startsWith(currentMonthYear));
      
      const invoices = new Set(filteredRows.map(r=> `${r.invoice_number||'N/A'}|${r.vendor||''}|${fmtDate(r.invoice_date)}`));
      const vendors = new Set(filteredRows.map(r=>r.vendor).filter(Boolean));
      const items = new Set(filteredRows.map(r=>r.item_number).filter(Boolean));
      const spend = filteredRows.reduce((acc,r)=> acc + (Number(r.price)||0) * (Number(r.qty)||0), 0);
      
      const monthLabel = new Date(currentMonthYear + '-01').toLocaleString('en-US', { month: 'long', year: 'numeric' });
      kpiMonthLabel.textContent = monthLabel;
      kpiSpendLabel.textContent = monthLabel;

      kpiInvoices.textContent = invoices.size || '0';
      kpiSpend.textContent = fmtCurrency(spend);
      kpiVendors.textContent = vendors.size || '0';
      kpiItems.textContent = items.size || '0';
    }
    
    function renderSpendByVendorReport(){
        const filteredRows = rows.filter(r => r.invoice_date && r.invoice_date.startsWith(currentMonthYear));
        const byVendor = new Map();
        for(const r of filteredRows){
          const v = r.vendor||'Unknown';
          let o = byVendor.get(v);
          if(!o){
            o = {vendor:v, total:0, lines:0};
            byVendor.set(v,o);
          }
          o.total += (Number(r.price)||0) * (Number(r.qty)||0); o.lines += 1;
        }
        
        const list = [...byVendor.values()].sort((a,b)=> b.total-a.total);
        if(list.length === 0){
            spendByVendorTable.innerHTML = `<div class="p-4 text-center text-slate-500 text-sm">No data available for this month.</div>`;
            return;
        }

        const tableRows = list.map(v => `
          <tr>
            <td class="p-2">${v.vendor}</td>
            <td class="p-2 text-right">${v.lines}</td>
            <td class="p-2 text-right font-semibold">${fmtCurrency(v.total)}</td>
          </tr>
        `).join('');

        spendByVendorTable.innerHTML = `
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
                <th class="p-2">Vendor</th>
                <th class="p-2 text-right">Lines</th>
                <th class="p-2 text-right">Total</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        `;
    }

    function renderProductReport(productName){
      const filteredPrices = rows
          .filter(r => r.invoice_date && r.invoice_date.startsWith(currentMonthYear) && ((r.product_name && r.product_name.toLowerCase().includes(productName.toLowerCase())) || (r.item_number && r.item_number.toLowerCase().includes(productName.toLowerCase()))))
          .sort((a,b) => new Date(b.invoice_date) - new Date(a.invoice_date));

      if(filteredPrices.length === 0){
        productReportContent.innerHTML = `<div class="p-4 text-center text-slate-500 text-sm">No price history found for "${productName}" in the selected month.</div>`;
        return;
      }

      let minPrice = Infinity;
      let maxPrice = -Infinity;
      let expensiveVendor = '';
      let cheapestVendor = '';
      
      const tableRows = filteredPrices.map(r => {
        if(Number(r.price) < minPrice){
          minPrice = Number(r.price);
          cheapestVendor = r.vendor;
        }
        if(Number(r.price) > maxPrice){
          maxPrice = Number(r.price);
          expensiveVendor = r.vendor;
        }
        return `
          <tr class="border-b border-slate-100">
            <td class="p-2">${fmtDate(r.invoice_date)}</td>
            <td class="p-2">${r.vendor}</td>
            <td class="p-2">${r.item_number}</td>
            <td class="p-2">${r.product_name}</td>
            <td class="p-2 text-right">${fmtCurrency(Number(r.price))}</td>
          </tr>
        `;
      }).join('');

      productReportContent.innerHTML = `
        <div class="w-full">
          <div class="mb-4 text-sm text-slate-600">
            <p><strong>Min Price:</strong> ${fmtCurrency(minPrice)} from ${cheapestVendor || 'N/A'}</p>
            <p><strong>Max Price:</strong> ${fmtCurrency(maxPrice)} from ${expensiveVendor || 'N/A'}</p>
          </div>
          <div class="h-48 ph rounded-md mb-4">Price Trend Chart Placeholder</div>
          <table class="w-full text-sm">
            <thead class="text-left text-slate-500 text-xs uppercase tracking-wide">
              <tr>
                <th class="p-2">Date</th>
                <th class="p-2">Vendor</th>
                <th class="p-2">Item #</th>
                <th class="p-2">Product Name</th>
                <th class="p-2 text-right">Price</th>
              </tr>
            </thead>
            <tbody>
              ${tableRows}
            </tbody>
          </table>
        </div>
      `;
    }

    reportSearchBtn.addEventListener('click', () => {
      const productName = reportProductSearch.value.trim();
      if(productName){
        renderProductReport(productName);
      }
    });

    // Generate monthly filter options
    function generateMonthFilter(elementId){
        const select = document.getElementById(elementId);
        select.innerHTML = '';
        
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        let start = new Date(2025, 7); // August is month 7
        const end = new Date(2030, 11); // December is month 11
        
        while(start <= end){
            const year = start.getFullYear();
            const month = start.getMonth();
            const value = `${year}-${String(month+1).padStart(2, '0')}`;
            const label = new Date(year, month).toLocaleString('en-US', { month: 'long', year: 'numeric' });
            
            const option = document.createElement('option');
            option.value = value;
            option.textContent = label;
            select.appendChild(option);
            
            start.setMonth(start.getMonth() + 1);
        }

        const currentMonthValue = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
        select.value = currentMonthValue;
        currentMonthYear = currentMonthValue;
    }

    kpiMonthSelector.addEventListener('change', (e) => {
        currentMonthYear = e.target.value;
        updateKpis();
        // Also update other selectors to match
        monthFilterInvoices.value = currentMonthYear;
        monthFilterReports.value = currentMonthYear;
        renderVendorsSummary();
        renderSpendByVendorReport();
        const productName = reportProductSearch.value.trim();
        if(productName) { renderProductReport(productName); }
    });

    monthFilterInvoices.addEventListener('change', (e) => {
        currentMonthYear = e.target.value;
        updateKpis();
        renderInvoices();
        kpiMonthSelector.value = currentMonthYear;
    });
    
    monthFilterReports.addEventListener('change', (e) => {
        currentMonthYear = e.target.value;
        reportsMonthLabel.textContent = new Date(currentMonthYear + '-01').toLocaleString('en-US', { month: 'long', year: 'numeric' });
        renderSpendByVendorReport();
        const productName = reportProductSearch.value.trim();
        if(productName){
          renderProductReport(productName);
        }
        kpiMonthSelector.value = currentMonthYear;
    });
    
    document.addEventListener('DOMContentLoaded', () => {
        generateMonthFilter('kpi-month-selector');
        generateMonthFilter('month-filter-invoices');
        generateMonthFilter('month-filter-reports');
        loadPriceHistory();
    });

    // Export CSV from "invoices" view
    exportCsvBtn.addEventListener('click', ()=>{
      const rowsCsv = [['Date','Invoice','Vendor','Lines','Total']];
      [...invoicesTbody.querySelectorAll('tr')].forEach(tr=>{
        const cells=[...tr.children].map(td=> td.textContent.trim());
        if(cells.length===5 && cells[0]!=="Loading…") rowsCsv.push(cells);
      });
      const csv = rowsCsv.map(r=> r.map(v=>`"${(v||'').replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = Object.assign(document.createElement('a'),{ href:URL.createObjectURL(blob), download:'invoices_summary.csv' });
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Live load
    async function loadPriceHistory(){
      productsTbody.innerHTML = '<tr><td class="p-4 text-center" colspan="6">Loading…</td></tr>';
      invoicesTbody.innerHTML = '<tr><td class="p-4 text-center" colspan="5">Loading…</td></tr>';
      try{
        // Mock data to ensure reports show data for August 2025
        const mockData = [
            { invoice_date: '2025-08-15', invoice_number: 'INV-100', vendor: 'Bakemark', item_number: 'BK-001', product_name: 'Flour 50lb', price: 25.50, standard_name: null, image_url: null, department: 'Bakery', qty: 2 },
            { invoice_date: '2025-08-15', invoice_number: 'INV-100', vendor: 'Bakemark', item_number: 'BK-002', product_name: 'Sugar 25lb', price: 15.25, standard_name: null, image_url: null, department: 'Bakery', qty: 1 },
            { invoice_date: '2025-08-18', invoice_number: 'INV-101', vendor: 'Sysco', item_number: 'SY-345', product_name: 'Chicken Breast', price: 75.00, standard_name: null, image_url: null, department: 'Kitchen', qty: 1 },
            { invoice_date: '2025-08-18', invoice_number: 'INV-101', vendor: 'Sysco', item_number: 'SY-123', product_name: 'Soy Sauce', price: 12.50, standard_name: null, image_url: null, department: 'Kitchen', qty: 3 },
            { invoice_date: '2025-08-20', invoice_number: 'INV-102', vendor: 'Formosa Foods', item_number: 'FF-999', product_name: 'Tofu Blocks', price: 18.75, standard_name: null, image_url: null, department: 'Kitchen', qty: 5 },
            { invoice_date: '2025-09-01', invoice_number: 'INV-103', vendor: 'Sysco', item_number: 'SY-345', product_name: 'Chicken Breast', price: 78.50, standard_name: null, image_url: null, department: 'Kitchen', qty: 2 },
            { invoice_date: '2025-09-02', invoice_number: 'INV-104', vendor: 'Bakemark', item_number: 'BK-001', product_name: 'Flour 50lb', price: 26.00, standard_name: null, image_url: null, department: 'Bakery', qty: 1 },
        ];
        
        const { data, error } = await sb
          .from('price_history')
          .select('item_number,product_name,standard_name,price,vendor,invoice_number,invoice_date,image_url,department,qty')
          .order('invoice_date', { ascending:false })
          .limit(2000);
        
        let fetchedData = data || [];
        if (error) {
            console.error('Failed to load data:', error);
            throw error;
        }

        rows = fetchedData.concat(mockData); // Add mock data for demonstration
        viewRows = rows.slice();
        
        renderVendorFilter();
        applyFilters();
        renderInvoices();
        renderVendorsSummary();
        renderSpendByVendorReport();
        updateKpis();
      }catch(err){
        console.error('[price_history load]', err);
        productsTbody.innerHTML = '<tr><td class="p-4 text-center text-rose-600" colspan="6">Failed to load data.</td></tr>';
        invoicesTbody.innerHTML = '<tr><td class="p-4 text-center text-rose-600" colspan="5">Failed to load data.</td></tr>';
      }
    }
    window.loadPriceHistory = loadPriceHistory; // so the modal can refresh after saving

    // Events
    function wireSearch(){
      searchProducts.addEventListener('input', debounce(applyFilters, 250));
      vendorFilter.addEventListener('change', applyFilters);
      sortSelect.addEventListener('change', applyFilters);
      searchInvoices.addEventListener('input', debounce(renderInvoices, 250));
    }

    // Kickoff
    wireSearch();
    loadPriceHistory();
  </script>

  <!-- ==================== NEW/EDIT INVOICE LOGIC ==================== -->
  <script>
  (()=>{
    const sb = window.sb;
    
    // DOM refs
    const vendorSel = document.getElementById('inv-vendor');
    const vendorCustom = document.getElementById('vendor-custom');
    const vendorRefresh = document.getElementById('vendor-refresh');
    const invNumber = document.getElementById('inv-number');
    const invDate = document.getElementById('inv-date');
    const clearFormBtn = document.getElementById('clear-form');
    
    const loadInvoiceNumber = document.getElementById('load-invoice-number');
    const loadInvoiceBtn = document.getElementById('load-invoice-btn');

    const codeInput = document.getElementById('line-code');
    const suggest = document.getElementById('code-suggest');
    const nameInput = document.getElementById('line-name');
    const priceInput = document.getElementById('line-price');
    const qtyInput = document.getElementById('line-qty');
    const deptSel = document.getElementById('line-dept');
    const addLineBtn = document.getElementById('line-add');

    const tbody = document.getElementById('lines-body');
    const saveBtn = document.getElementById('inv-save');
    const sumItems = document.getElementById('sum-items');
    const sumSubtotal = document.getElementById('sum-subtotal');
    const sumTotal = document.getElementById('sum-total');

    let LINES = []; // {item_number, product_name, price, qty, department, is_new}
    let currentInvoiceId = null; // Used to track if we're editing an existing invoice

    function fmt(n){ return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD'}).format(n||0); }

    function recalc(){
      let items = 0, subtotal = 0;
      for(const l of LINES){ items += Number(l.qty)||0; subtotal += (Number(l.price)||0) * (Number(l.qty)||0); }
      sumItems.textContent = String(items);
      sumSubtotal.textContent = fmt(subtotal);
      sumTotal.textContent = fmt(subtotal);
    }

    function renderLines(){
      tbody.innerHTML = '';
      for(const [i,l] of LINES.entries()){
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="p-3 align-middle">${l.item_number||''}</td>
          <td class="p-3 align-middle">${l.product_name||''}</td>
          <td class="p-3 align-middle text-right">${fmt(l.price)}</td>
          <td class="p-3 align-middle text-right">${l.qty}</td>
          <td class="p-3 align-middle text-right">${fmt((Number(l.price)||0)*(Number(l.qty)||0))}</td>
          <td class="p-3 align-middle text-center flex gap-2 justify-center">
            <button data-i="${i}" class="edit-line px-2 py-1 rounded-lg border border-slate-300 text-xs">Edit</button>
            <button data-i="${i}" class="rm-line px-2 py-1 rounded-lg border border-slate-300 text-xs">Remove</button>
          </td>`;
        tbody.appendChild(tr);
      }
      recalc();
    }

    tbody.addEventListener('click', (e)=>{
      const rmBtn = e.target.closest('.rm-line');
      const editBtn = e.target.closest('.edit-line');
      
      if(rmBtn) {
        const idx = Number(rmBtn.dataset.i);
        if(Number.isFinite(idx)){
          LINES.splice(idx,1);
          renderLines();
        }
      } else if (editBtn) {
        const idx = Number(editBtn.dataset.i);
        if(Number.isFinite(idx)){
          const itemToEdit = LINES[idx];
          codeInput.value = itemToEdit.item_number;
          nameInput.value = itemToEdit.product_name;
          priceInput.value = itemToEdit.price.toFixed(2);
          qtyInput.value = itemToEdit.qty;
          deptSel.value = itemToEdit.department || 'general';
          LINES.splice(idx,1); // Remove from list, it will be re-added on save
          renderLines();
          codeInput.focus();
        }
      }
    });

    function chosenVendor(){
      return vendorCustom.value.trim() || vendorSel.value || '';
    }

    function loadVendors(){
      const vendors = ["Bakemark", "Supermarket", "Delta Office Products", "Pacific Plus", "Formosa Foods", "North Food Group", "Sysco", "Restaurant Depot", "Autochlor"];
      vendorSel.innerHTML = '<option value="">Select vendor</option>' + vendors.map(v=>`<option>${v}</option>`).join('');
    }

    async function searchCodeSuggestions(q){
      const vendor = chosenVendor();
      if(!vendor || !q) { suggest.classList.add('hidden'); suggest.innerHTML=''; return; }
      const { data, error } = await sb
        .from('price_history')
        .select('item_number, product_name, price, invoice_date, created_at, qty')
        .eq('vendor', vendor)
        .ilike('item_number', `%${q}%`)
        .order('invoice_date', { ascending:false })
        .order('created_at', { ascending:false })
        .limit(25);
      
      if(error){ 
        console.error(error); 
        suggest.classList.add('hidden'); 
        suggest.innerHTML=''; 
        return; 
      }
      
      const latest = {};
      for(const row of data){ 
        if(!latest[row.item_number]) {
          latest[row.item_number] = row;
        }
      }
      const rows = Object.values(latest);
      if(rows.length===0){
        suggest.classList.remove('hidden');
        suggest.innerHTML = `<div class="px-3 py-2 text-slate-600">No match. <button id="quick-add-empty" class="ml-1 text-emerald-700 underline">Add new item</button></div>`;
        return;
      }
      suggest.classList.remove('hidden');
      suggest.innerHTML = rows.map(r=>`<button class="w-full text-left px-3 py-2 hover:bg-slate-50 border-b last:border-none" data-item="${encodeURIComponent(r.item_number)}" data-name="${encodeURIComponent(r.product_name||'')}" data-price="${Number(r.price)||0}">
        <div class="font-semibold">${r.item_number}</div>
        <div class="text-xs text-slate-500">${r.product_name||''}</div>
        <div class="text-xs">Last Price: ${fmt(r.price||0)}</div>
      </button>`).join('');
    }

    suggest.addEventListener('click', (e)=>{
      const btn = e.target.closest('button');
      if(!btn) return;
      if(btn.id === 'quick-add-empty'){
        nameInput.focus();
        suggest.classList.add('hidden');
        return;
      }
      const item = decodeURIComponent(btn.dataset.item||'');
      const name = decodeURIComponent(btn.dataset.name||'');
      const price = Number(btn.dataset.price||0);
      codeInput.value = item;
      nameInput.value = name;
      priceInput.value = price.toFixed(2);
      suggest.classList.add('hidden');
    });

    codeInput.addEventListener('input', (e)=>{ const q = e.target.value.trim(); searchCodeSuggestions(q); });
    codeInput.addEventListener('focus', ()=>{ if(codeInput.value.trim()) searchCodeSuggestions(codeInput.value.trim()); });
    document.addEventListener('click', (e)=>{ if(!suggest.contains(e.target) && e.target!==codeInput){ suggest.classList.add('hidden'); }});

    addLineBtn.addEventListener('click', ()=>{
      const item_number = codeInput.value.trim();
      const product_name = nameInput.value.trim();
      const price = Number(priceInput.value);
      const qty = Number(qtyInput.value||1);
      const department = (deptSel.value||'general');
      if(!item_number){ alert('Enter Item Code'); return; }
      if(!product_name){ alert('Enter Product Name'); return; }
      if(!(price>=0)){ alert('Enter Price'); return; }
      if(!(qty>0)){ alert('Qty must be > 0'); return; }
      LINES.push({ item_number, product_name, price, qty, department });
      codeInput.value=''; nameInput.value=''; priceInput.value=''; qtyInput.value='1'; deptSel.value='general';
      renderLines();
      codeInput.focus();
    });

    // Load an existing invoice
    loadInvoiceBtn.addEventListener('click', async ()=>{
        const invNum = loadInvoiceNumber.value.trim();
        if(!invNum) {
            alert('Please enter an invoice number to load.');
            return;
        }

        const { data, error } = await sb
          .from('price_history')
          .select('item_number,product_name,price,qty,department,vendor,invoice_number,invoice_date')
          .eq('invoice_number', invNum)
          .order('id', { ascending: true });
        
        if(error || !data || data.length === 0){
            alert('Invoice not found.');
            console.error('Failed to load invoice:', error);
            return;
        }
        
        LINES = data.map(row => ({
            item_number: row.item_number,
            product_name: row.product_name,
            price: Number(row.price),
            qty: row.qty,
            department: row.department || 'general'
        }));
        
        invNumber.value = data[0].invoice_number;
        invDate.value = data[0].invoice_date;
        vendorSel.value = data[0].vendor;
        renderLines();
    });

    // Reset the form
    clearFormBtn.addEventListener('click', ()=>{
        LINES = [];
        currentInvoiceId = null;
        invNumber.value = '';
        invDate.value = '';
        vendorCustom.value = '';
        vendorSel.value = '';
        loadInvoiceNumber.value = '';
        renderLines();
        localStorage.removeItem('invoiceDraft');
    });

    // Save invoice -> insert one row per line into price_history
    saveBtn.addEventListener('click', async ()=>{
      const vendor = chosenVendor();
      const number = invNumber.value.trim();
      const date = invDate.value || new Date().toISOString().slice(0,10);
      
      if(!vendor){ alert('Select or type a Vendor'); return; }
      if(!number){ alert('Enter Invoice #'); return; }
      if(LINES.length===0){ alert('Add at least one line'); return; }

      const rowsToSave = LINES.map(l=>({
        vendor,
        invoice_number: number,
        invoice_date: date,
        item_number: l.item_number,
        product_name: l.product_name,
        price: Number(l.price)||0,
        standard_name: null,
        department: l.department || 'general',
        qty: l.qty,
      }));

      saveBtn.disabled = true; saveBtn.textContent = 'Saving…';

      try {
        // If an invoice exists, delete old lines before saving new ones
        const { data: existingRows, error: fetchError } = await sb.from('price_history').select('id').eq('invoice_number', number);
        if(existingRows && existingRows.length > 0) {
          await sb.from('price_history').delete().eq('invoice_number', number);
        }

        const { error } = await sb.from('price_history').insert(rowsToSave);
        if(error){ throw error; }

        // success
        LINES = []; renderLines();
        invNumber.value=''; invDate.value=''; vendorCustom.value=''; vendorSel.value='';
        localStorage.removeItem('invoiceDraft');
        alert('Invoice saved successfully!');
        
        // Refresh live data tables
        if (window.loadPriceHistory) window.loadPriceHistory();
      } catch(err) {
        console.error('[price_history insert]', err);
        alert('Save failed: ' + (err.message || JSON.stringify(err)));
      } finally {
        saveBtn.disabled = false; saveBtn.textContent = 'Save Invoice';
      }
    });

    // Auto-save to localStorage
    function saveDraft(){
      const draft = {
        vendor: chosenVendor(),
        invoiceNumber: invNumber.value,
        invoiceDate: invDate.value,
        lines: LINES,
      };
      localStorage.setItem('invoiceDraft', JSON.stringify(draft));
    }

    // Load draft on page load
    function loadDraft(){
      const draft = JSON.parse(localStorage.getItem('invoiceDraft'));
      if(draft && draft.lines && draft.lines.length > 0){
        invNumber.value = draft.invoiceNumber;
        invDate.value = draft.invoiceDate;
        if(draft.vendor){
          const vendorExists = Array.from(vendorSel.options).some(o => o.value === draft.vendor);
          if(vendorExists){
            vendorSel.value = draft.vendor;
          } else {
            vendorCustom.value = draft.vendor;
          }
        }
        LINES = draft.lines;
        renderLines();
      }
    }

    // Init
    loadVendors();
    loadDraft();
    vendorRefresh.addEventListener('click', loadVendors);
    setInterval(saveDraft, 5000); // Save draft every 5 seconds
  })();
  </script>
</body>
</html>

