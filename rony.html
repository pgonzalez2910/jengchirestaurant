<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi — General Order List (Full Page)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--primary:#3b82f6;--primary-dark:#2563eb;--bg:#f1f5f9;--surface:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb}
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}

    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;width:100vw}
    .app-header{position:sticky;top:0;z-index:50;background:var(--surface);display:grid;grid-template-columns:1fr auto;gap:16px;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .header-left{display:flex;align-items:center;gap:14px}
    .branding{height:60px}
    .titles h1{margin:0;font-size:1.35rem;font-weight:800;letter-spacing:.2px}
    .titles h3{margin:.15rem 0 0;font-size:.98rem;color:var(--muted)}
    .date-input{width:100%;max-width:240px;padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px}

    .main{width:100%;height:100%;padding:18px 18px 120px 18px}
    .category{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;margin:0 0 18px 0;box-shadow:0 8px 22px rgba(15,23,42,.06)}
    .category h2{margin:0 0 14px 2px;font-size:1.05rem;font-weight:800;color:#111;border-bottom:1px solid var(--border);padding-bottom:10px}

    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{display:flex;flex-direction:column;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.12)}
    .img{width:120px;height:120px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:linear-gradient(145deg,rgba(255,255,255,.5),rgba(255,255,255,.2))}
    .name{font-weight:800;font-size:1.02rem;margin-top:4px;background:linear-gradient(180deg,#000,#333);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}

    .counter{display:flex;align-items:center;gap:10px;margin-top:6px}
    .counter input{width:74px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:.55rem .4rem;font-size:1.05rem}
    .counter button{background:var(--primary);border:none;color:#fff;padding:.55rem .95rem;border-radius:12px;font-size:1.15rem;font-weight:900;cursor:pointer;box-shadow:0 4px 10px rgba(59,130,246,.3)}
    .counter button:hover{background:var(--primary-dark)}

    .footer{background:var(--surface);border-top:1px solid var(--border);padding:14px 20px}
    .footer-inner{max-width:none;margin:0 auto}
    .footer h2{margin:0 0 .6rem 0;font-size:1rem;font-weight:800;color:#111}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;list-style:none;padding:0;margin:10px 0 0 0}
    .row{display:flex;justify-content:space-between;border:1px dashed var(--border);border-radius:10px;padding:8px 10px}

    .fab{position:fixed;right:16px;bottom:16px;z-index:100}
    .fab img{width:92px;height:92px;border-radius:50%;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.22)}

    .modal{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(0,0,0,.45);z-index:1000}
    .modal.show{display:flex}
    .modal-card{background:#fff;padding:18px 20px;border-radius:14px;max-width:520px;width:92%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn{padding:.6rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:900;cursor:pointer}
    .err{white-space:pre-wrap;text-align:left;background:#fff7f7;border:1px solid #fecaca;color:#991b1b;padding:10px;border-radius:10px}
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div class="header-left">
        <img class="branding" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo"/>
        <div class="titles"><h1>JENG CHI RESTAURANT</h1><h3>GENERAL ORDER LIST</h3></div>
      </div>
      <div style="text-align:right"><input type="date" id="order-date" class="date-input"/></div>
    </header>

    <main class="main">
      <section id="inventory-list"><p style="text-align:center;color:#6b7280">Loading inventory...</p></section>
    </main>

    <!-- Footer with IDs used in JS -->
    <footer class="footer" id="order-history-footer" style="display:none">
      <div class="footer-inner">
        <h2>Last Submitted Order</h2>
        <div id="last-order-details"><p style="text-align:center;color:#6b7280">No order submitted yet.</p></div>
      </div>
    </footer>
  </div>

  <div class="fab"><img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit" onclick="submitInventory()"/></div>

  <div id="modal" class="modal"><div class="modal-card"><h3 id="m-title" style="font-size:1.1rem;font-weight:800"></h3><div id="m-icon" style="margin:.8rem 0"></div><div id="m-msg" style="color:#111"></div><div style="margin-top:10px"><button class="btn" onclick="closeModal()">OK</button></div></div></div>

<script>
// ===== Supabase client =====
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const supabaseClient = db; // alias for compatibility

// ===== Helpers =====
const TZ = 'America/Chicago';
const ORDER_CONFIRMATION_TO = 'admin@jengchirestaurant.com';
const q = (s,r=document)=>r.querySelector(s);
const todayYmd = ()=>{const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`};
const dateInputToLocalMidnightISO = s=>{const [y,m,d]=s.split('-').map(Number);return new Date(y,m-1,d,0,0,0).toISOString();};
function formatCT(d){ const dt=(d instanceof Date)?d:new Date(d); return new Intl.DateTimeFormat('en-US',{dateStyle:'medium',timeStyle:'short',timeZone:TZ}).format(dt); }
function openModal(t,m,i){q('#m-title').textContent=t;q('#m-msg').innerHTML=typeof m==='string'?m:`<div class="err">${m?.message||m||'Unknown error'}</div>`;q('#m-icon').innerHTML=i?`<img src="${i}" style="height:95px">`:'';q('#modal').classList.add('show');}
function closeModal(){q('#modal').classList.remove('show');}
function readQty(input){const raw=(input?.value??'').trim();if(raw==='')return{selected:false,qty:0};const n=Number(raw);return{selected:true,qty:Number.isFinite(n)?n:0};}
const FIXED_IMAGES = { 'Soy Bean Oil': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/soybean.jpg' };
function numericPositionKey(val){const m=String(val??'').match(/\d+/);if(m){return{k:Number(m[0]),has:true}}return{k:Number.POSITIVE_INFINITY,has:false}}
function formatCT(d) {
  const dt = (d instanceof Date) ? d : new Date(d);
  return new Intl.DateTimeFormat('en-US', {
    dateStyle: 'medium',
    timeStyle: 'short',
    timeZone: 'America/Chicago'
  }).format(dt);
}


  

// ===== Inventory UI =====
async function loadInventory(){
  const container = q('#inventory-list');
  container.innerHTML = '';
  const { data, error } = await db
    .from('inventory_management')
    .select('id, product_name, image_url, on_hand, position, user')
    .ilike('user','rony')
    .order('position',{ascending:true});

  if(error){ container.innerHTML = `<div class="category"><p>Error loading: ${error.message}</p></div>`; console.error(error); return; }

  const rows = (data||[]).map(r=>({ id:r.id, name:(r.product_name||'').trim(), image:r.image_url, on_hand:Number(r.on_hand||0), position:r.position??'0' }));

  const byPos = new Map();
  for(const r of rows){
    if(!byPos.has(r.position)) byPos.set(r.position, new Map());
    const map = byPos.get(r.position);
    if(!map.has(r.name)){
      const img = FIXED_IMAGES[r.name] || r.image || '';
      map.set(r.name, { id:r.id, name:r.name, image:img, on_hand:r.on_hand });
    }else{
      const cur = map.get(r.name); cur.on_hand += r.on_hand; map.set(r.name, cur);
    }
  }

  const sortedPositions = [...byPos.keys()].sort((a,b)=>{
    const A=numericPositionKey(a), B=numericPositionKey(b);
    if(A.has && B.has) return A.k - B.k;
    if(A.has && !B.has) return -1;
    if(!A.has && B.has) return 1;
    return String(a).localeCompare(String(b));
  });

  for(const pos of sortedPositions){
    const map = byPos.get(pos);
    const sec = document.createElement('section'); sec.className='category'; sec.innerHTML = `<h2>Position ${pos}</h2><div class="grid"></div>`;
    const grid = sec.querySelector('.grid');
    for(const item of map.values()){
      const card = document.createElement('div'); card.className='card'; card.dataset.id = item.id;
      card.innerHTML = `
        <img class="img" src="${item.image || 'https://via.placeholder.com/120'}" alt="${item.name}">
        <div class="name">${item.name}</div>
        <div class="counter">
          <button type="button" data-delta="-1">-</button>
          <input type="number" inputmode="numeric" min="0" placeholder="" value="${item.on_hand>0?item.on_hand:''}">
          <button type="button" data-delta="1">+</button>
        </div>`;
      const [btnMinus, input, btnPlus] = card.querySelectorAll('.counter > *');
      btnMinus.addEventListener('click', ()=>adjustQty(card,-1));
      btnPlus.addEventListener('click', ()=>adjustQty(card, 1));
      input.addEventListener('change', ()=>persistQty(card));
      grid.appendChild(card);
    }
    container.appendChild(sec);
  }
}

function adjustQty(card, delta){ const input = card.querySelector('input'); let v = parseInt(input.value||'0',10); if(isNaN(v)) v = 0; v = Math.max(0, v + delta); input.value = v || ''; persistQty(card); }
async function persistQty(card){ const id = card.dataset.id; const input=card.querySelector('input'); let v = parseInt(input.value||'0',10); if(isNaN(v)) v=0; const { error } = await db.from('inventory_management').update({ on_hand:v }).eq('id', id); if(error) {console.error('update error', error); openModal('Update error', error);} }

// ===== submitted_orders insert with fallback (JSON vs TEXT) =====
async function insertSubmittedOrder(payload){
  let res = await db.from('submitted_orders').insert([payload]).select();
  if(!res.error) return res;
  try{
    const alt = { ...payload, summary_details: JSON.stringify(payload.summary_details||[]) };
    res = await db.from('submitted_orders').insert([alt]).select();
  }catch(e){ res.error = res.error || e; }
  return res;
}

// ===== inventory_check manual upsert (no unique index needed) =====
async function saveInventoryCheckManually(rows){
  const failures=[]; let saved=0;
  for(const r of rows){
    const upd = await db.from('inventory_check')
      .update({ on_hand:r.on_hand, tentative:r.tentative })
      .match({ order_date:r.order_date, product_name:r.product_name, user:r.user })
      .select();

    if(upd.error){ failures.push({name:r.product_name, reason:upd.error.message}); continue; }
    if(Array.isArray(upd.data) && upd.data.length>0){ saved++; continue; }

    const ins = await db.from('inventory_check').insert([r]).select();
    if(ins.error){ failures.push({name:r.product_name, reason:ins.error.message}); continue; }
    saved++;
  }
  return { saved, failures };
}

// ===== Submit flow =====
async function submitInventory(){
  const dateVal = document.getElementById('order-date').value || todayYmd();
  const orderDateISO = new Date(dateVal + 'T00:00:00').toISOString(); // stable midnight
  const cards = [...document.querySelectorAll('.card')];

  // collect selected (blank means "not selected", 0 is a valid quantity)
  const items = cards.map(c=>{
    const name = c.querySelector('.name').textContent.trim();
    const v = c.querySelector('input').value.trim();
    const selected = v !== '';
    return { id:c.dataset.id, name, selected, quantity: selected ? Number(v||0) : 0 };
  }).filter(x => x.selected && x.name);

  if (!items.length) {
    openModal('Nothing to submit','Type quantities (0 allowed).');
    return;
  }

  // --- 1) submitted_orders insert with JSON/TEXT fallback ---
  let soError = null;
  let res = await db.from('submitted_orders').insert([{
    order_date: orderDateISO,
    vendor_list: 'General List',
    summary_details: items
  }]);

  if (res.error) {
    // likely TEXT column for summary_details -> stringify
    const res2 = await db.from('submitted_orders').insert([{
      order_date: orderDateISO,
      vendor_list: 'General List',
      summary_details: JSON.stringify(items)
    }]);
    if (res2.error) soError = res2.error;
  }
  if (soError) { openModal('Submit failed (submitted_orders)', soError.message); return; }

  // --- 2) inventory_check manual upsert (works w/out unique index) ---
  const batch = items.map(it=>({
    order_date: dateVal,                 // DATE column
    product_name: it.name,
    on_hand: it.quantity,
    tentative: it.quantity,
    user: 'Rony'
  }));

  const failures = []; let saved = 0;
  for (const r of batch) {
    const upd = await db.from('inventory_check')
      .update({ on_hand:r.on_hand, tentative:r.tentative })
      .match({ order_date:r.order_date, product_name:r.product_name, user:r.user })
      .select();

    if (upd.error) { failures.push(`${r.product_name}: ${upd.error.message}`); continue; }
    if (Array.isArray(upd.data) && upd.data.length > 0) { saved++; continue; }

    const ins = await db.from('inventory_check').insert([r]).select();
    if (ins.error) { failures.push(`${r.product_name}: ${ins.error.message}`); continue; }
    saved++;
  }
  if (failures.length) {
    openModal('Saved with errors', failures.join('<br>'));
    return; // don’t claim success unless all lines are written
  }

  // --- 3) reset only submitted items in inventory_management ---
  const ids = items.map(i=>i.id);
  const { error: resetErr } = await db.from('inventory_management').update({ on_hand:0 }).in('id', ids);
  if (resetErr) console.warn('reset error', resetErr);

  // --- 4) refresh footer, scroll, celebrate ---
  await displayLastOrder();
  document.getElementById('order-history-footer')?.scrollIntoView({ behavior: 'smooth' });
  openModal('¡Éxito!', 'Gracias Rony por ayudarme a poner la orden',
    'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');

  await loadInventory();
}


// ===== Footer: last order (CST/CDT) =====
async function displayLastOrder() {
  const cont = document.getElementById("last-order-details");
  const footer = document.getElementById("order-history-footer");
  cont.innerHTML = "<p>Loading...</p>";

  const { data, error } = await db
    .from("submitted_orders")
    .select("order_date, summary_details, vendor_list")
    .order("order_date", { ascending: false })
    .limit(1);

  footer.style.display = "block"; // ensure visible

  if (error) {
    console.error("submitted_orders read error", error);
    cont.innerHTML = `<p style="color:#991b1b">Error: ${error.message}</p>`;
    return;
  }
  if (!data || !data.length) {
    cont.innerHTML = "<p>No orders.</p>";
    return;
  }

  const last = data[0];

  // Handle JSON/JSONB/TEXT
  let details = [];
  if (Array.isArray(last.summary_details)) details = last.summary_details;
  else if (typeof last.summary_details === "string") {
    try { details = JSON.parse(last.summary_details); } catch { details = []; }
  }

  const items = (details || [])
    .map(i => `<li class="order-summary-item"><span>${i.name}</span><span>${i.quantity}</span></li>`)
    .join("");

  cont.innerHTML = `
    <p><strong>Vendor:</strong> ${last.vendor_list || "General List"}</p>
    <p><strong>Date:</strong> ${formatCT(last.order_date)}</p>
    <ul class="order-summary-list">${items || '<li class="order-summary-item"><span>(empty)</span><span>-</span></li>'}</ul>
  `;
}


// ===== Init =====
addEventListener('DOMContentLoaded', async ()=>{ q('#order-date').value = todayYmd(); await loadInventory(); await displayLastOrder(); });
</script>
</body>
</html>

