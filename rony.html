<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Inventory — Rony (Full Page)</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --primary:#3b82f6;--primary-dark:#2563eb;--bg:#f1f5f9;--surface:#fff;--text:#0f172a;--muted:#6b7280;--border:#e5e7eb
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial;color:var(--text);background:var(--bg)}

    /* FULL-PAGE APP SHELL */
    .app{display:grid;grid-template-rows:auto 1fr auto;min-height:100vh;width:100vw}
    .app-header{position:sticky;top:0;z-index:50;background:var(--surface);display:grid;grid-template-columns:280px 1fr 280px;gap:16px;align-items:center;padding:14px 20px;border-bottom:1px solid var(--border);box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .header-center{text-align:center}
    .branding{height:68px}
    .titles h1{margin:0;font-size:1.35rem;font-weight:800;letter-spacing:.2px}
    .titles h3{margin:.15rem 0 0;font-size:.98rem;color:var(--muted)}
    .date-input{width:100%;max-width:240px;padding:.55rem .7rem;border:1px solid var(--border);border-radius:10px}

    /* EDGE‑TO‑EDGE MAIN CONTENT */
    .main{width:100%;height:100%;padding:18px 18px 120px 18px} /* extra bottom padding so the FAB never overlaps */
    .category{background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:18px;margin:0 0 18px 0;box-shadow:0 8px 22px rgba(15,23,42,.06)}
    .category h2{margin:0 0 14px 2px;font-size:1.05rem;font-weight:800;color:#111;border-bottom:1px solid var(--border);padding-bottom:10px}

    /* DENSE, FULL‑WIDTH GRID */
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:16px}
    .card{display:flex;flex-direction:column;align-items:center;gap:10px;background:var(--surface);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:0 6px 16px rgba(0,0,0,.06)}
    .card:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.12)}
    .img{width:120px;height:120px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:linear-gradient(145deg,rgba(255,255,255,.5),rgba(255,255,255,.2))}
    .name{font-weight:800;font-size:1.02rem;margin-top:4px;background:linear-gradient(180deg,#000,#333);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-align:center}

    /* COUNTER */
    .counter{display:flex;align-items:center;gap:10px;margin-top:6px}
    .counter input{width:74px;text-align:center;border:1px solid var(--border);border-radius:10px;padding:.55rem .4rem;font-size:1.05rem}
    .counter button{background:var(--primary);border:none;color:#fff;padding:.55rem .95rem;border-radius:12px;font-size:1.15rem;font-weight:900;cursor:pointer;box-shadow:0 4px 10px rgba(59,130,246,.3)}
    .counter button:hover{background:var(--primary-dark)}

    /* FOOTER */
    .footer{background:var(--surface);border-top:1px solid var(--border);padding:14px 20px}
    .footer-inner{max-width:none;margin:0 auto}
    .footer h2{margin:0 0 .6rem 0;font-size:1rem;font-weight:800;color:#111}
    .list{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:8px;list-style:none;padding:0;margin:10px 0 0 0}
    .row{display:flex;justify-content:space-between;border:1px dashed var(--border);border-radius:10px;padding:8px 10px}

    /* FAB submit button pinned to bottom-right */
    .fab{position:fixed;right:16px;bottom:16px;z-index:100}
    .fab img{width:92px;height:92px;border-radius:50%;cursor:pointer;box-shadow:0 8px 22px rgba(0,0,0,.22)}

    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;inset:0;background:rgba(0,0,0,.45);display:none;align-items:center;justify-content:center}
    .modal.show{display:flex}
    .modal-card{background:#fff;padding:18px 20px;border-radius:14px;max-width:440px;width:92%;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,.35)}
    .btn{padding:.6rem 1rem;background:var(--primary);color:#fff;border:none;border-radius:10px;font-weight:900;cursor:pointer}
  </style>
</head>
<body>
  <div class="app">
    <header class="app-header">
      <div><input type="date" id="order-date" class="date-input"/></div>
      <div class="header-center">
        <img class="branding" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo"/>
        <div class="titles"><h1>JENG CHI RESTAURANT</h1><h3>RONY — ORDER LIST</h3></div>
      </div>
      <div style="text-align:right;color:var(--muted);font-weight:700">JENG CHI MANAGEMENT APP</div>
    </header>

    <main class="main">
      <section id="inventory-list"><p style="text-align:center;color:#6b7280">Loading inventory...</p></section>
    </main>

    <footer class="footer">
      <div class="footer-inner" id="history" style="display:none">
        <h2>Last Submitted Order</h2>
        <div id="last-order"><p style="text-align:center;color:#6b7280">No order submitted yet.</p></div>
        <div style="text-align:center;margin-top:12px">
          <p><b>Click logout when finished</b></p>
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffylogout.jpg" style="height:120px;cursor:pointer" onclick="logoutUser()"/>
        </div>
      </div>
    </footer>
  </div>

  <div class="fab"><img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit" onclick="submitInventory()"/></div>

  <div id="modal" class="modal">
    <div class="modal-card">
      <h3 id="m-title" style="font-size:1.1rem;font-weight:800"></h3>
      <div id="m-icon" style="margin:.8rem 0"></div>
      <p id="m-msg" style="color:#6b7280"></p>
      <div style="margin-top:10px"><button class="btn" onclick="closeModal()">OK</button></div>
    </div>
  </div>

<script>
/**********************
 * Supabase setup
 **********************/
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const db = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/**********************
 * Helpers & constants
 **********************/
const TZ = "America/Chicago";
const ORDER_CONFIRMATION_TO = "admin@jengchirestaurant.com";
const q = (sel, root=document) => root.querySelector(sel);
function formatCT(dateLike){ return new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:TZ}).format(new Date(dateLike)); }
function todayYmd(){ const d=new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}` }
function dateInputToLocalMidnightISO(dStr){ const [y,m,d] = dStr.split('-').map(Number); return new Date(y, m-1, d, 0,0,0).toISOString(); }
function openModal(title,msg,img){ q('#m-title').textContent=title; q('#m-msg').textContent=msg; q('#m-icon').innerHTML=img?`<img src="${img}" style="height:95px">`:''; q('#modal').classList.add('show'); }
function closeModal(){ q('#modal').classList.remove('show'); }
function logoutUser(){ localStorage.removeItem('userPermissions'); location.href='https://portal.jengchirestaurant.com/index.html'; }
function readQty(input){ const raw=(input?.value??'').trim(); if(raw==='') return {selected:false, qty:0}; const n=Number(raw); return {selected:true, qty:Number.isFinite(n)?n:0}; }

/**********************
 * Render inventory (ID‑based)
 **********************/
async function loadInventory(){
  const container = q('#inventory-list');
  container.innerHTML = ""; // fresh render

  const { data, error } = await db
    .from('inventory_management')
    .select('id, product_name, image_url, on_hand, position, user')
    .ilike('user','rony')
    .order('position', { ascending:true });
  if(error){ container.innerHTML = '<div class="category"><p>Error loading.</p></div>'; console.error(error); return; }
  
  const rows = (data||[]).map(r=>({ id:r.id, name:(r.product_name||'').trim(), image:r.image_url, on_hand:Number(r.on_hand||0), position:r.position||'1' }));
  const byPos = new Map();
  for(const r of rows){ if(!byPos.has(r.position)) byPos.set(r.position, []); byPos.get(r.position).push(r); }

  for(const [pos, items] of byPos.entries()){
    const sec = document.createElement('section'); sec.className='category'; sec.innerHTML = `<h2>Position ${pos}</h2><div class="grid"></div>`;
    const grid = sec.querySelector('.grid');
    for(const it of items){
      const card = document.createElement('div'); card.className='card'; card.dataset.id = it.id;
      card.innerHTML = `
        <img class="img" src="${it.image || 'https://via.placeholder.com/120'}" alt="${it.name}">
        <div class="name">${it.name}</div>
        <div class="counter">
          <button type="button" data-delta="-1">-</button>
          <input type="number" inputmode="numeric" min="0" placeholder="" value="${it.on_hand>0?it.on_hand:''}">
          <button type="button" data-delta="1">+</button>
        </div>`;
      const [btnMinus, input, btnPlus] = card.querySelectorAll('.counter > *');
      btnMinus.addEventListener('click', ()=>adjustQty(card, -1));
      btnPlus.addEventListener('click', ()=>adjustQty(card,  1));
      input.addEventListener('change', ()=>persistQty(card));
      grid.appendChild(card);
    }
    container.appendChild(sec);
  }
}
function adjustQty(card, delta){ const input = card.querySelector('input'); let v = parseInt(input.value||'0',10); if(isNaN(v)) v = 0; v = Math.max(0, v + delta); input.value = v || ''; persistQty(card); }
async function persistQty(card){ const id = card.dataset.id; const input=card.querySelector('input'); let v = parseInt(input.value||'0',10); if(isNaN(v)) v=0; const { error } = await db.from('inventory_management').update({ on_hand:v }).eq('id', id); if(error) console.error('update error', error); }

/**********************
 * Submit order (explicit 0 save + ID clear)
 **********************/
async function submitInventory(){
  const dateInput = q('#order-date').value || todayYmd();
  const orderDateISO = dateInputToLocalMidnightISO(dateInput);

  const cards = [...document.querySelectorAll('.card')];
  const items = cards.map(c=>{ const id = c.dataset.id; const name = c.querySelector('.name').textContent.trim(); const { selected, qty } = readQty(c.querySelector('input')); return { id, name, selected, quantity: qty }; }).filter(x=>x.selected && x.name);
  if(!items.length){ openModal('Nothing to submit','Type quantities (0 allowed).'); return; }

  const { error: insErr } = await db.from('submitted_orders').insert([{ order_date: orderDateISO, vendor_list:'General List', summary_details: items }]);
  if(insErr){ console.error(insErr); openModal('Error','Submit failed'); return; }

  const batch = items.map(it=>({ order_date: orderDateISO, product_name: it.name, on_hand: it.quantity, tentative: it.quantity, user:'Rony' }));
  let upErr = null; try{ const { error } = await db.from('inventory_check').upsert(batch, { onConflict:'order_date,product_name,"user"' }); upErr = error||null; }catch(e){ upErr = e; }
  if(upErr){ const failures=[]; for(const it of batch){ const { error } = await db.from('inventory_check').upsert([it], { onConflict:'order_date,product_name,"user"' }); if(error) failures.push({ name: it.product_name, error }); } if(failures.length){ const msg = failures.map(f=>`• ${f.name} — ${f.error?.message||'insert failed'}`).join('\n'); openModal('Saved with some errors', msg); } }

  try{ await db.functions.invoke('send-email', { body: { to: ORDER_CONFIRMATION_TO, vendor:'General List', orderDate: orderDateISO, items } }); }catch(e){ console.warn('email error', e); }

  const ids = items.map(i=>i.id); await db.from('inventory_management').update({ on_hand: 0 }).in('id', ids);
  await displayLastOrder(); await loadInventory(); openModal('Success','Submitted. Explicit 0s were saved as out-of-stock.','https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
}

/**********************
 * Last order footer
 **********************/
async function displayLastOrder(){
  const box = q('#last-order'); const history = q('#history'); box.innerHTML = '<p>Loading...</p>';
  const { data, error } = await db.from('submitted_orders').select('order_date,summary_details,vendor_list').order('order_date',{ascending:false}).limit(1);
  if(error || !data || !data.length){ box.innerHTML = '<p>No orders.</p>'; history.style.display='block'; return; }
  const last = data[0]; let details = Array.isArray(last.summary_details) ? last.summary_details : []; if(!details.length && typeof last.summary_details==='string'){ try{ details = JSON.parse(last.summary_details); }catch{} }
  const items = details.map(i=>`<li class="row"><span>${i.name}</span><span>${i.quantity}</span></li>`).join('');
  box.innerHTML = `<div style="font-weight:700;margin-bottom:6px">Vendor: ${last.vendor_list}</div><div style="margin-bottom:6px">Date: ${formatCT(last.order_date)}</div><ul class="list">${items}</ul>`; history.style.display = 'block';
}

/**********************
 * Boot
 **********************/
addEventListener('DOMContentLoaded', async ()=>{ q('#order-date').value = todayYmd(); await loadInventory(); await displayLastOrder(); });
</script>
</body>
</html>
