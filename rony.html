<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi â€” Order List</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --primary:#3b82f6; --primary-dark:#2563eb; --success:#16a34a; --bg:#f3f4f6; --surface:#ffffff; --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ===== Header ===== */
    .app-header{position:sticky;top:0;z-index:20;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .app-header-inner{max-width:1400px;margin:0 auto;padding:14px 16px;display:grid;grid-template-columns:1fr minmax(220px, 640px) 1fr;align-items:center;gap:12px}
    .app-name{font-weight:800;font-size:clamp(12px, 1.2vw, 14px);letter-spacing:.4px;background:linear-gradient(180deg,#000,#575757);-webkit-background-clip:text;-webkit-text-fill-color:transparent;justify-self:start;white-space:nowrap}
    .center-wrap{justify-self:center;text-align:center;display:flex;flex-direction:column;align-items:center;gap:6px}
    .brand{height:clamp(61px, 9.8vw, 101px)}
    .main-title{margin:0;font-weight:800;letter-spacing:.5px;font-size:clamp(16px, 2.6vw, 22px);background:linear-gradient(180deg,#000,#575757);-webkit-background-clip:text;-webkit-text-fill-color:transparent}
    .right-wrap{justify-self:end;display:flex;align-items:center;gap:10px}
    .date-input{border:1px solid #e5e7eb;border-radius:10px;padding:8px 12px;font-size:clamp(12px, 1.6vw, 14px);background:#fff}
    .badge{display:inline-block;padding:6px 10px;border:1px solid var(--border);border-radius:999px;font-weight:700;font-size:12px;background:#fff}

    @media (max-width:780px){
      .app-header-inner{grid-template-columns:1fr auto;grid-template-areas:"appname date" "center center";row-gap:10px}
      .app-name{grid-area:appname;justify-self:start}
      .right-wrap{grid-area:date;justify-self:end}
      .center-wrap{grid-area:center}
    }

    /* ===== Global progress ===== */
    .global-progress-wrap{max-width:1400px;margin:10px auto 0;padding:0 16px}
    .global-bar{height:10px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid var(--border);position:relative}
    .global-bar > span{display:block;height:100%;width:0;background:var(--primary);transition:width .2s ease}
    .global-label{margin:6px 0 14px;font-size:12px;color:var(--muted);display:flex;justify-content:space-between}
    .complete{background:var(--success)!important}

    /* ===== Page layout ===== */
    .main-container{width:100%;max-width:100%;margin:10px auto;padding:0 12px}
    .category-section{background:transparent;margin-bottom:10px}
    .category-section h2{display:flex;align-items:center;justify-content:space-between;margin:16px 6px 8px;font-size:15px;font-weight:800;border-bottom:2px solid var(--border);padding-bottom:6px;color:#111}
    .progress-wrap{flex:0 0 220px;margin-left:10px}
    .progress{height:8px;background:#f1f5f9;border-radius:999px;overflow:hidden;border:1px solid var(--border)}
    .progress > span{display:block;height:100%;width:0;background:var(--primary);transition:width .2s ease}

    .product-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .product-card{background:var(--surface);border-radius:14px;padding:18px;box-shadow:0 3px 10px rgba(0,0,0,.08);display:flex;flex-direction:column;align-items:center;text-align:center}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.12);transition:.2s}
    .product-details img{width:120px;height:120px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.1))}
    .product-name{font-weight:700;font-size:14px;margin-top:10px;line-height:1.25}
    .counter{display:flex;align-items:center;gap:10px;margin-top:12px}
    .counter button{background:var(--primary);border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer}
    .counter button:hover{background:var(--primary-dark)}
    .counter input{width:90px;text-align:center;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:14px}

    /* Submit FAB bottom-right */
    .fab{position:fixed;right:18px;bottom:18px;z-index:50}
    .fab img{width:92px;height:92px;border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer}
    .fab img:hover{transform:scale(1.06)}

    /* ===== Footer: CURRENT ORDER SUMMARY (live) ===== */
    .footer-history{max-width:1100px;margin:22px auto;padding:18px;background:var(--surface);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .footer-title{margin:0 0 10px;font-size:16px;font-weight:800;border-bottom:2px solid var(--border);padding-bottom:6px}
    .order-summary-list{list-style:none;margin:0;padding:0}
    .order-summary-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}
    .order-summary-empty{color:var(--muted);text-align:center;margin:6px 0}
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
  <header class="app-header">
    <div class="app-header-inner">
      <div class="app-name">JENG CHI MANAGEMENT APP</div>
      <div class="center-wrap">
        <img class="brand" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Company Logo"/>
        <h1 class="main-title">GENERAL ORDER LIST</h1>
      </div>
      <div class="right-wrap">
        <span id="selected-badge" class="badge">0 counted</span>
        <input type="date" id="order-date" class="date-input"/>
      </div>
    </div>
  </header>

  <!-- ===== Global Progress ===== -->
  <div class="global-progress-wrap">
    <div class="global-bar"><span id="global-progress"></span></div>
    <div class="global-label"><span>Overall progress</span><span id="global-progress-label">0%</span></div>
  </div>

  <!-- ===== Main ===== -->
  <div class="main-container">
    <section id="inventory-list"><p style="text-align:center;color:var(--muted);">Loading inventoryâ€¦</p></section>
  </div>

  <!-- ===== Footer: Current Order Summary (live) ===== -->
  <footer id="order-summary-footer" class="footer-history">
    <h3 class="footer-title">Current Order Summary</h3>
    <div id="current-order-container">
      <p class="order-summary-empty">No items selected yet.</p>
    </div>
  </footer>

  <!-- Submit FAB -->
  <div class="fab">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit Order" onclick="submitInventory()"/>
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="modal" style="display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);justify-content:center;align-items:center">
    <div class="modal-content" style="background:#fff;padding:22px;border-radius:12px;max-width:420px;width:92%;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.3)">
      <h3 id="modal-title" style="font-size:18px;font-weight:800"></h3>
      <div id="modal-icon" style="margin:10px 0"></div>
      <p id="modal-message" style="color:var(--muted)"></p>
      <div style="margin-top:10px">
        <button onclick="closeModal()" style="padding:8px 14px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-weight:700">OK</button>
      </div>
    </div>
  </div>

<script>
// ===== Settings
const COUNT_BLANK_AS_ZERO = false;  // blanks are NOT counted
const STEP_BUTTON = 0.10;           // +/- buttons change by 0.10; you can still TYPE any 2-decimal value

// ===== Supabase + Email
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// Email settings
const EMAIL_TO = "admin@jengchirestaurant.com";
const EDGE_EMAIL_FUNCTION = "order-email"; // optional Edge Function name

// ===== Helpers
function todayYmd(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function dateInputToLocalMidnightISO(ymd){if(!ymd)return new Date().toISOString();const [y,m,d]=ymd.split('-').map(Number);return new Date(y,m-1,d,0,0,0).toISOString()}
function round2(n){return Math.round(n*100)/100}
function fmt2(n){const x=Number(n);return Number.isFinite(x)?x.toFixed(2):""}

// ===== Init
document.addEventListener('DOMContentLoaded',async()=>{
  document.getElementById('order-date').value = todayYmd();
  await loadInventory();
});

// ===== Inventory UI
async function loadInventory(){
  const container = document.getElementById('inventory-list');
  container.innerHTML = "<p style='text-align:center;color:#6b7280;'>Loadingâ€¦</p>";

  const { data, error } = await supabaseClient
    .from('inventory_management')
    .select('product_name,image_url,on_hand,position')
    .eq('user','Rony')
    .order('position',{ascending:true});

  if(error || !data){ console.error(error); container.innerHTML = '<p>Error loading.</p>'; return; }

  const grouped = {};
  for(const row of data){
   if (!row.position) continue; // ðŸ”’ skip uncategorized items entirely
const pos = row.position;
    grouped[pos] ||= {};
    const prod = grouped[pos][row.product_name] ||= { total:0, image: row.image_url };
    // keep decimals; zero stays zero here (we won't show it by default though)
    prod.total += Number(row.on_hand)||0;
  }

  const posKeys = Object.keys(grouped).sort((a,b)=>{
    const na = parseInt(a,10); const nb = parseInt(b,10);
    const aIsNum = Number.isFinite(na); const bIsNum = Number.isFinite(nb);
    if(aIsNum && bIsNum) return na-nb;
    if(aIsNum) return -1; if(bIsNum) return 1;
    return String(a).localeCompare(String(b));
  });

  container.innerHTML = '';
  for(const pos of posKeys){
    const sec = document.createElement('div');
    sec.className = 'category-section';

    const header = document.createElement('h2');
    header.innerHTML = `Position ${pos}<span class="progress-wrap"><div class="progress"><span id="prog-${pos}"></span></div></span>`;
    sec.appendChild(header);

    const grid = document.createElement('div');
    grid.className = 'product-grid';

    const sortedEntries = Object.entries(grouped[pos]).sort(([a],[b]) => a.localeCompare(b));

    for(const [name,obj] of sortedEntries){
      const initVal = Number(obj.total);
      // >>> NO DEFAULT ZERO: only prefill if > 0
      const valueAttr = initVal > 0 ? `value="${fmt2(initVal)}"` : '';
      const card = document.createElement('div');
      card.className = 'product-card';
      card.innerHTML = `
        <div class="product-details"><img src="${obj.image||'https://via.placeholder.com/120'}" alt="${name}"></div>
        <div class="product-name">${name}</div>
        <div class="counter">
          <button onclick="updateQty('${encodeURIComponent(name)}',-1)">-</button>
          <input type="number" step="0.01" data-pos="${pos}" data-name="${name.replace(/"/g,'&quot;')}" ${valueAttr} min="0" placeholder="" />
          <button onclick="updateQty('${encodeURIComponent(name)}',1)">+</button>
        </div>`;
      grid.appendChild(card);
    }

    sec.appendChild(grid);
    container.appendChild(sec);
  }

  updateProgress();
  container.addEventListener('input', (e)=>{
    if(e.target && e.target.matches('input[type="number"][data-name]')) updateProgress();
  }, { passive:true });
}

// change = Â±1; buttons add/subtract STEP_BUTTON
async function updateQty(encodedName, change){
  const name = decodeURIComponent(encodedName);
  const input = document.querySelector(`input[data-name="${CSS.escape(name)}"]`);
  const curRaw = input?.value ?? '';
  let current = parseFloat(curRaw);
  if(!Number.isFinite(current) || current < 0) current = 0;

  let next = current + (change * STEP_BUTTON);
  if(next < 0) next = 0;
  next = round2(next);
  input.value = fmt2(next);

  await supabaseClient
    .from('inventory_management')
    .update({ on_hand: next })
    .eq('product_name', name)
    .eq('user','Rony');

  updateProgress();
}

function updateProgress(){
  const inputs = Array.from(document.querySelectorAll('input[type="number"][data-name]'));
  const byPos = new Map();
  let countedTotal = 0;

  for(const inp of inputs){
    const pos = inp.getAttribute('data-pos') || 'Uncategorized';
    const rec = byPos.get(pos) || { total:0, selected:0 };
    rec.total += 1;

    const hasValue = inp.value !== '' && inp.value !== null;
    const n = parseFloat(inp.value);
    const isNumeric = Number.isFinite(n) && n >= 0;

    // selected only if the user set a value (including explicit 0.00)
    const isSelected = !COUNT_BLANK_AS_ZERO ? (hasValue && isNumeric) : true;
    if(isSelected){ rec.selected += 1; countedTotal += 1; }
    byPos.set(pos, rec);
  }

  // Per-position
  for(const [pos,{total,selected}] of byPos.entries()){
    const span = document.getElementById(`prog-${pos}`);
    if(!span) continue;
    const pct = total ? Math.round((selected/total)*100) : 0;
    span.style.width = `${pct}%`;
    span.classList.toggle('complete', total>0 && selected===total);
  }

  // Global
  const globalSpan = document.getElementById('global-progress');
  const globalLabel = document.getElementById('global-progress-label');
  const totalInputs = inputs.length;
  const pctGlobal = totalInputs ? Math.round((countedTotal/totalInputs)*100) : 0;
  globalSpan.style.width = `${pctGlobal}%`;
  globalSpan.classList.toggle('complete', pctGlobal===100 && totalInputs>0);
  if(globalLabel) globalLabel.textContent = `${pctGlobal}%`;

  const badge = document.getElementById('selected-badge');
  if(badge) badge.textContent = `${countedTotal} counted`;

  buildCurrentOrderSummary();
}

function buildCurrentOrderSummary(){
  const container = document.getElementById('current-order-container');
  const inputs = Array.from(document.querySelectorAll('input[type="number"][data-name]'));
  const items = [];
  for(const inp of inputs){
    const hasValue = inp.value !== '' && inp.value !== null; // explicit set
    if(!hasValue) continue; // blanks not shown
    const n = parseFloat(inp.value);
    if(!Number.isFinite(n) || n < 0) continue;
    items.push({
      name: inp.getAttribute('data-name'),
      qty: fmt2(n),
      pos: inp.getAttribute('data-pos')||'Uncategorized'
    });
  }
  container.innerHTML = items.length
    ? `<ul class="order-summary-list">${items.map(i=>`<li class="order-summary-item"><span>${i.name}</span><span>${i.qty}</span></li>`).join('')}</ul>`
    : '<p class="order-summary-empty">No items set yet.</p>';
}

function showSubmittedSummary(products){
  const container = document.getElementById('current-order-container');
  const filtered = products.filter(p=>p.explicit);
  container.innerHTML = filtered.length
    ? `<ul class="order-summary-list">${filtered.map(i=>`<li class="order-summary-item"><span>${i.name}</span><span>${fmt2(i.quantity)}</span></li>`).join('')}</ul>`
    : '<p class="order-summary-empty">No items set yet.</p>';
}

// ===== Email sender =====
async function sendEmail(orderDate, products){
  const ordered = products; // already filtered to explicit below

  const subject = `General Order â€” ${orderDate} â€” ${ordered.length} items`;
  const lines = ordered.map(p=>`- ${fmt2(p.quantity)} Ã— ${p.name}`).join('\n');
  const text = `New order submitted\n\nDate: ${orderDate}\nItems: ${ordered.length}\n\n${lines}\n\nâ€” Sent from Jeng Chi Management App`;
  const html = `<h3>New order submitted</h3><p><b>Date:</b> ${orderDate}</p><p><b>Items:</b> ${ordered.length}</p><ul>${ordered.map(p=>`<li><b>${fmt2(p.quantity)}</b> Ã— ${p.name}</li>`).join('')}</ul><p>â€” Sent from Jeng Chi Management App</p>`;

  // Try Supabase Edge Function (optional)
  try{
    const resp = await fetch(`${SUPABASE_URL}/functions/v1/${EDGE_EMAIL_FUNCTION}`, {
      method:'POST',
      headers:{
        'Content-Type':'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ to: EMAIL_TO, subject, text, html })
    });
    if(resp.ok) return true;
    console.warn('Edge function email failed:', await resp.text());
  }catch(e){ console.warn('Edge function email error:', e); }

  // Fallback: open a mail draft
  const mailto = `mailto:${encodeURIComponent(EMAIL_TO)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(text)}`;
  window.location.href = mailto;
  return false;
}

// ===== Submit order (saves ONLY items with explicit values; blanks are ignored) =====
async function submitInventory(){
  const ymd = document.getElementById('order-date').value || todayYmd();
  const ts = dateInputToLocalMidnightISO(ymd);

  // Collect all items
  const productsAll = [...document.querySelectorAll('.product-card')].map(card=>{
    const name = card.querySelector('.product-name').textContent.trim();
    const inp = card.querySelector('input');
    const raw = inp.value;
    const explicit = raw !== '' && raw !== null; // user set a value (including 0.00)
    const n = parseFloat(raw);
    const quantity = Number.isFinite(n) && n>=0 ? round2(n) : 0;
    return { name, quantity, explicit, out_of_stock: quantity===0 };
  });

  // Only items the user set (no default zeros)
  const products = productsAll.filter(p => p.explicit);

  if(products.length === 0){
    openModal('Sin selecciÃ³n','No elegiste ningÃºn producto todavÃ­a.');
    return;
  }

  openModal('Enviando ordenâ€¦','Guardando tu orden en el sistema.');
  showSubmittedSummary(products);
  document.getElementById('order-summary-footer').scrollIntoView({behavior:'smooth'});

  // 1) submitted_orders (jsonb details) â€” store only explicit items
  const { error: orderErr } = await supabaseClient
    .from('submitted_orders')
    .insert([{ order_date: ts, vendor_list: 'General List', summary_details: products }]);
  if(orderErr){ openModal('Error','No se pudo guardar en submitted_orders.'); console.error(orderErr); return; }

  // 2) inventory_check upsert â€” only explicit items
  const rows = products.map(p=>({ order_date: ymd, product_name: p.name, on_hand: p.quantity, tentative: p.quantity, user: 'Rony' }));
  const { error: invErr } = await supabaseClient
    .from('inventory_check')
    .upsert(rows, { onConflict: 'order_date,product_name, "user"', ignoreDuplicates: false });
  if(invErr){ openModal('Error','No se pudo guardar en inventory_check.'); console.error(invErr); return; }

  // 3) Email confirmation
  const mailed = await sendEmail(ymd, products);
  if(mailed){
    openModal('Â¡Ã‰xito!','Orden enviada y correo de confirmaciÃ³n enviado a admin@jengchirestaurant.com.',
      'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
  }else{
    openModal('Orden guardada','Se abriÃ³ un borrador de email con el resumen. Revisa tu correo para enviarlo.',
      'https://raw.githubusercontent.com/pgonzalez2910/jengchirestaurant-images/main/daffy.jpg');
  }
}

// ===== Modal helpers
function openModal(title,msg,icon){
  const m = document.getElementById('custom-modal');
  document.getElementById('modal-title').innerHTML = title;
  document.getElementById('modal-message').innerHTML = msg;
  document.getElementById('modal-icon').innerHTML = icon ? `<img src="${icon}" style="height:100px">` : '';
  m.style.display = 'flex';
}
function closeModal(){ document.getElementById('custom-modal').style.display = 'none' }
</script>
</body>
</html>

