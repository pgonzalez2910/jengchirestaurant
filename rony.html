<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Inventory - Order List</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root {
      --primary-color:#3b82f6; --primary-dark:#2563eb;
      --bg-color:#f3f4f6; --surface-color:#ffffff;
      --text-color:#111; --light-text-color:#6b7280;
      --border-color:#e5e7eb; --shadow-color:rgba(0,0,0,0.15);
    }
    body { font-family:'Inter',sans-serif; margin:0; background:var(--bg-color); color:var(--text-color); }
    .app-header {
      background:var(--surface-color); padding:1.25rem 2rem; display:flex; align-items:center; justify-content:space-between;
      box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:0; z-index:10;
    }
    .header-center{text-align:center; flex:1;}
    .branding{height:70px;}
    .titles h1{margin:0;font-size:1.5rem;font-weight:700;color:var(--primary-color);}
    .titles h3{margin:.25rem 0 0;font-size:1.125rem;}
    .main-container{max-width:1200px;margin:1.5rem auto;padding:0 1rem;}
    .category-section h2{
      margin-top:2rem;font-size:1.25rem;font-weight:700;
      border-bottom:2px solid var(--border-color);padding-bottom:.5rem;color:#111;
    }
    .product-grid{display:grid;gap:2rem;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));}
    .product-card{
      background:var(--surface-color); border-radius:15px; padding:1.5rem;
      box-shadow:0 4px 10px rgba(0,0,0,0.1); display:flex;flex-direction:column; align-items:center;
      transition:all .3s ease; text-align:center;
    }
    .product-card:hover{ transform:translateY(-6px); box-shadow:0 10px 20px rgba(0,0,0,0.2); }
    .product-details img{
      width:120px;height:120px; object-fit:contain; border:1px solid var(--border-color); border-radius:12px;
      background:linear-gradient(145deg,rgba(255,255,255,0.4),rgba(255,255,255,0.1)); box-shadow:inset 0 0 10px rgba(255,255,255,0.5);
    }
    .product-name{
      font-weight:700; font-size:1rem; margin-top:0.8rem;
      background:linear-gradient(180deg,#000,#444); -webkit-background-clip:text; -webkit-text-fill-color:transparent; letter-spacing:0.3px;
    }
    .counter{ display:flex; align-items:center; justify-content:center; gap:.75rem; margin-top:1rem; }
    .counter input{
      width:60px;text-align:center; border:1px solid var(--border-color); border-radius:6px; padding:.5rem; font-size:1rem;
    }
    .counter button{
      background:var(--primary-color); border:none; color:#fff; padding:.6rem 1rem; border-radius:8px; font-size:1.2rem; font-weight:bold; cursor:pointer; transition:background .2s ease;
    }
    .counter button:hover{background:var(--primary-dark);}
    .fab-container{position:fixed;bottom:2rem;right:2rem;display:flex;flex-direction:column;gap:1rem;align-items:center;}
    .submit-btn-img{width:7rem;height:7rem;border-radius:50%;cursor:pointer;box-shadow:0 4px 8px rgba(0,0,0,0.15);transition:.2s;}
    .submit-btn-img:hover{transform:scale(1.1);}
    .footer-history{max-width:1000px;margin:2rem auto;padding:1.5rem;background:var(--surface-color);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .footer-history h2{margin:0 0 1rem;font-size:1.25rem;font-weight:700;border-bottom:2px solid var(--border-color);padding-bottom:.5rem;}
    .order-summary-list{list-style:none;padding:0;margin:0;}
    .order-summary-item{display:flex;justify-content:space-between;padding:.4rem 0;border-bottom:1px solid var(--border-color);}
    .logout-section{text-align:center;margin-top:1.5rem;}
    .logout-btn-img{height:120px;cursor:pointer;}
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.4);justify-content:center;align-items:center;}
    .modal-content{background:white;padding:2rem;border-radius:12px;max-width:400px;width:90%;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,0.3);}

/* Force the Submit Order button to stick to bottom-right corner */
.submit-order-btn {
position: fixed !important;
bottom: 20px !important;
right: 20px !important;
z-index: 9999 !important;
margin: 0 !important;
}


/* Remove any default margins or transforms that push it upward */
.submit-order-btn img,
.submit-order-btn button {
display: block;
margin: 0;
transform: none !important;
}





  </style>
</head>
<body>
  <header class="app-header">
    <div><input type="date" id="order-date" class="border p-2 rounded-lg text-sm"></div>
    <div class="header-center">
      <img class="branding" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo"/>
      <div class="titles"><h1>JENG CHI RESTAURANT</h1><h3>ORDER LIST</h3></div>
    </div>
    <div><h2 style="font-size:.9rem;color:var(--light-text-color);">JENG CHI MANAGEMENT APP</h2></div>
  </header>

  <div class="main-container">
    <section id="inventory-list"><p style="text-align:center;color:#6b7280;">Loading inventory...</p></section>
  </div>

  <footer id="order-history-footer" class="footer-history" style="display:none;">
    <h2>Last Submitted Order</h2>
    <div id="last-order-details"><p style="text-align:center;color:#6b7280;">No order submitted yet.</p></div>
    <div class="logout-section">
      <p><b>Click logout when finished</b></p>
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffylogout.jpg" class="logout-btn-img" onclick="logoutUser()"/>
    </div>
  </footer>

 <div class="fab-container submit-order-btn">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit" class="submit-btn-img" onclick="submitInventory()"/>
  </div>

  <!-- âœ… Custom Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="font-size:1.25rem;font-weight:600;"></h3>
      <div id="modal-icon" style="margin:1rem 0;"></div>
      <p id="modal-message" style="color:#6b7280;"></p>
      <div class="modal-buttons">
        <button onclick="closeModal()" style="padding:.5rem 1rem;background:#3b82f6;color:white;border:none;border-radius:6px;font-weight:600;">OK</button>
      </div>
    </div>
  </div>

<script>
/* =========================
   Supabase setup
========================= */
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* =========================
   Constants
========================= */
const TZ = "America/Chicago"; // CST/CDT
const ORDER_CONFIRMATION_TO = "admin@jengchirestaurant.com";

/* =========================
   Helpers
========================= */
// Format a Date/ISO string in America/Chicago
function formatCT(dateLike) {
  return new Intl.DateTimeFormat("en-US", {
    dateStyle: "medium",
    timeStyle: "short",
    timeZone: TZ,
  }).format(new Date(dateLike));
}

// Convert <input type="date"> (YYYY-MM-DD) to local-midnight ISO
function dateInputToLocalMidnightISO(dateStr) {
  if (!dateStr) return new Date().toISOString();
  const [y, m, d] = dateStr.split("-").map(Number);
  const dt = new Date(y, m - 1, d, 0, 0, 0); // local midnight
  return dt.toISOString(); // stored in UTC, represents local midnight
}

// Today's date in YYYY-MM-DD for the input
function todayYmd() {
  const dt = new Date();
  const y = dt.getFullYear();
  const m = String(dt.getMonth() + 1).padStart(2, "0");
  const d = String(dt.getDate()).padStart(2, "0");
  return `${y}-${m}-${d}`;
}

/* =========================
   Init
========================= */
document.addEventListener("DOMContentLoaded", async () => {
  // default the date to today
  document.getElementById("order-date").value = todayYmd();

  await loadInventory();
  await displayLastOrder();
});

function logoutUser() {
  localStorage.removeItem("userPermissions");
  window.location = "https://portal.jengchirestaurant.com/index.html";
}

/* =========================
   Inventory UI
========================= */
async function loadInventory() {
  const container = document.getElementById("inventory-list");
  container.innerHTML = "<p style='text-align:center;color:#6b7280;'>Loading...</p>";

  const { data, error } = await supabaseClient
    .from("inventory_management")
    .select("product_name,image_url,on_hand,position")
    .eq("user", "Rony")
    .order("position", { ascending: true });

  if (error || !data) {
    console.error(error);
    container.innerHTML = "<p>Error loading.</p>";
    return;
  }

  const grouped = {};
  data.forEach((item) => {
    const pos = item.position || "Uncategorized";
    if (!grouped[pos]) grouped[pos] = {};
    if (!grouped[pos][item.product_name]) {
      grouped[pos][item.product_name] = { total: item.on_hand, image: item.image_url };
    } else {
      grouped[pos][item.product_name].total += item.on_hand;
    }
  });

  container.innerHTML = "";
  Object.keys(grouped).forEach((pos) => {
    const sec = document.createElement("div");
    sec.className = "category-section";
    sec.innerHTML = `<h2>Position ${pos}</h2>`;

    const grid = document.createElement("div");
    grid.className = "product-grid";

    Object.entries(grouped[pos]).forEach(([name, obj]) => {
      const card = document.createElement("div");
      card.className = "product-card";
      card.innerHTML = `
        <div class="product-details">
          <img src="${obj.image || "https://via.placeholder.com/80"}" alt="${name}">
        </div>
        <div class="product-name">${name}</div>
        <div class="counter">
          <button onclick="updateQty('${name}',-1)">-</button>
          <input
            type="number"
            id="qty-${name}"
            ${Number(obj.total) > 0 ? `value="${obj.total}"` : ""}
            min="0"
            placeholder=""
          >
          <button onclick="updateQty('${name}',1)">+</button>
        </div>`;
      grid.appendChild(card);
    });

    sec.appendChild(grid);
    container.appendChild(sec);
  });
}

async function updateQty(name, change) {
  const input = document.getElementById(`qty-${name}`);
  let val = parseInt(input.value || 0) + change;
  if (val < 0) val = 0;
  input.value = val || "";

  await supabaseClient
    .from("inventory_management")
    .update({ on_hand: val })
    .eq("product_name", name)
    .eq("user", "Rony");
}

/* =========================
   Submit order
========================= */
async function submitInventory() {
  const dateInput = document.getElementById("order-date").value;      // "YYYY-MM-DD"
  const orderDateISO = dateInputToLocalMidnightISO(dateInput);        // local midnight â†’ UTC ISO

  const products = [...document.querySelectorAll(".product-card")]
    .map((card) => {
      const name = card.querySelector(".product-name").textContent;
      const qty = parseInt(card.querySelector("input").value || 0);
      return { name, quantity: qty };
    })
    .filter((p) => p.quantity > 0);

  if (!products.length) {
    openModal("Error", "No items selected");
    return;
  }

  const vendorList = "General List";

  // Save master order (UTC timestamp)
  const { error } = await supabaseClient.from("submitted_orders").insert([
    {
      order_date: new Date().toISOString(), // stored in UTC
      vendor_list: vendorList,
      summary_details: products,
    },
  ]);
  if (error) {
    console.error(error);
    openModal("Error", "Submit failed");
    return;
  }

  // ðŸ”” Email confirmation via Edge Function (Supabase client handles auth header)
  try {
    await supabaseClient.functions.invoke("send-email", {
      body: {
        to: ORDER_CONFIRMATION_TO,
        vendor: vendorList,
        orderDate: orderDateISO, // let the function format to America/Chicago
        items: products,
      },
    });
  } catch (e) {
    console.warn("Email function error:", e);
  }

  // Per-item snapshot (UTC)
  for (const p of products) {
    await supabaseClient.from("inventory_check").insert([
      {
        order_date: new Date().toISOString(),
        product_name: p.name,
        on_hand: p.quantity,
        tentative: p.quantity,
        user: "Rony",
      },
    ]);
  }

  // Clear counts for items just ordered
  await supabaseClient
    .from("inventory_management")
    .update({ on_hand: 0 })
    .in("product_name", products.map((p) => p.name))
    .eq("user", "Rony");

  await displayLastOrder();
  await loadInventory();

  document.getElementById("order-history-footer").scrollIntoView({ behavior: "smooth" });
  openModal("Â¡Ã‰xito!", "Gracias Rony por ayudarme a poner la orden",
    "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg");
}

/* =========================
   Last order footer (show CST/CDT)
========================= */
async function displayLastOrder() {
  const cont = document.getElementById("last-order-details");
  const footer = document.getElementById("order-history-footer");
  cont.innerHTML = "<p>Loading...</p>";

  const { data, error } = await supabaseClient
    .from("submitted_orders")
    .select("order_date,summary_details,vendor_list")
    .order("order_date", { ascending: false })
    .limit(1);

  if (error || !data || !data.length) {
    cont.innerHTML = "<p>No orders.</p>";
    footer.style.display = "block";
    return;
  }

  const last = data[0];
  let details = [];
  if (Array.isArray(last.summary_details)) details = last.summary_details;
  else if (typeof last.summary_details === "string") {
    try { details = JSON.parse(last.summary_details); } catch { details = []; }
  }

  const items = details
    .map((i) => `<li class="order-summary-item"><span>${i.name}</span><span>${i.quantity}</span></li>`)
    .join("");

  cont.innerHTML = `
    <p><strong>Vendor:</strong> ${last.vendor_list}</p>
    <p><strong>Date:</strong> ${formatCT(last.order_date)}</p>
    <ul class="order-summary-list">${items}</ul>
  `;
  footer.style.display = "block";
}

/* =========================
   Modal
========================= */
function openModal(title, message, imageUrl) {
  const modal = document.getElementById("custom-modal");
  document.getElementById("modal-title").textContent = title;
  document.getElementById("modal-message").textContent = message;
  document.getElementById("modal-icon").innerHTML = imageUrl ? `<img src="${imageUrl}" style="height:100px;">` : "";
  modal.style.display = "flex";
}
function closeModal() {
  document.getElementById("custom-modal").style.display = "none";
}
</script>
</body>
</html>
