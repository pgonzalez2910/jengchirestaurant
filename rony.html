<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi Inventory - Order List</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* CSS variables for a consistent theme */
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --text-color: #1f2937;
            --light-text-color: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* -----------------------
           âœ… Header
           ----------------------- */
        .app-header {
            background-color: var(--surface-color);
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-left {
            grid-column: 1 / 2;
            align-self: start;
        }

        .header-center {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .header-right {
            grid-column: 3 / 4;
            justify-self: end;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .app-header .branding {
            height: 75px;
            border-radius: 8px;
        }

        .app-header .titles {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
            text-align: center;
        }

        .app-header .titles h1 {
            margin: 0.5rem 0 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .app-header .titles h3 {
            margin: 0.25rem 0 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .header-right h2 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--light-text-color);
        }

        .logout-btn-img {
            height: 148px; /* Increased by 85% from 80px */
            width: auto;
            cursor: pointer;
        }

        .filter-bar {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 1rem;
            margin-bottom: 2rem;
        }
        
        .filter-btn {
            background-color: var(--surface-color);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease;
        }
        
        .filter-btn:hover {
            background-color: #f0f0f0;
        }
        
        .filter-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .category-section h2 {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-top: 2rem;
        }

        /* -----------------------
           âœ… Main Content
           ----------------------- */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        /* -----------------------
           âœ… Product Grid
           ----------------------- */
        .product-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }
        
        @media (min-width: 768px) {
            .product-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .product-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px var(--shadow-color);
        }

        .product-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .product-details img {
            width: 80px;
            height: 80px;
            object-fit: contain; /* Changed from cover to contain */
            border-radius: 8px;
            border: 1px solid var(--border-color);
            cursor: pointer;
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: auto;
        }

        .counter button {
            background-color: var(--primary-color);
            color: var(--surface-color);
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1;
            transition: background-color 0.2s ease;
        }

        .counter button:hover {
            background-color: var(--primary-dark);
        }

        .counter input {
            width: 70px;
            text-align: center;
            font-size: 1rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .counter input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* -----------------------
           âœ… Submit and Download Buttons (Floating)
           ----------------------- */
        .fab-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .fab-btn {
            width: 8.64rem;
            height: 8.64rem;
            border-radius: 9999px;
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }

        .fab-btn:hover {
            transform: scale(1.1);
        }
        
        .submit-btn-img {
            width: 8.64rem; /* Increased by 35% from 6.4rem */
            height: 8.64rem; /* Increased by 35% from 6.4rem */
            border-radius: 9999px;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s ease;
        }
        
        .submit-btn-img:hover {
            transform: scale(1.1);
        }

        .download-btn {
            background-color: var(--primary-color);
        }

        /* -----------------------
           âœ… Modal
           ----------------------- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            padding: 2rem;
            border-radius: 12px;
            width: 80%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
        }
        .modal-buttons {
            margin-top: 20px;
            display: flex;
            justify-content: center;
            gap: 1rem;
        }
        .modal-btn {
            padding: 0.75rem 1.5rem;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            border: none;
        }
        .modal-confirm-btn {
            background-color: var(--primary-color);
            color: white;
        }
        .modal-confirm-btn:hover {
            background-color: var(--primary-dark);
        }
        .modal-cancel-btn {
            background-color: #d1d5db;
            color: var(--text-color);
        }
        .modal-cancel-btn:hover {
            background-color: #9ca3af;
        }
        
        /* -----------------------
           âœ… Order History Footer
           ----------------------- */
        .footer-history {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem 1.5rem;
            background-color: var(--surface-color);
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            display: none;
        }
        .footer-history h2 {
            font-size: 1.5rem;
            font-weight: 700;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
            margin-bottom: 1rem;
        }
        .order-summary-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        .order-summary-item {
            display: flex;
            justify-content: space-between;
            padding: 0.5rem 0;
            border-bottom: 1px solid var(--border-color);
        }
        .order-summary-item:last-child {
            border-bottom: none;
        }

        .logout-section {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1rem;
        }
        
        .logout-btn-img {
            height: 148px; /* Increased by 85% from 80px */
            width: auto;
            cursor: pointer;
        }

        .call-to-action {
            font-size: 1.2rem;
            font-weight: bold;
            color: var(--text-color);
        }

    </style>
</head>
<body>
    <!-- âœ… App Header -->
    <header class="app-header">
        <div class="header-left">
            <input type="date" id="order-date" class="border p-2 rounded-lg text-sm" />
        </div>
        <div class="header-center">
            <img class="branding" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
            <div class="titles">
                <h1>JENG CHI RESTAURANT</h1>
                <h3>ORDER LIST</h3>
            </div>
        </div>
        <div class="header-right">
            <h2>JENG CHI MANAGEMENT APP</h2>
        </div>
    </header>
    
    <div class="filter-bar">
        <button id="general-list-btn" class="filter-btn active" onclick="loadInventory('General List')">General List</button>
    </div>

    <!-- âœ… Main Content Container -->
    <div class="main-container">
        <!-- Product Grid -->
        <section id="inventory-list">
            <p style="text-align:center; color: #6b7280; font-size: 1.125rem;">Loading inventory...</p>
        </section>
    </div>

    <!-- âœ… Order History Footer -->
    <footer id="order-history-footer" class="footer-history">
        <h2>Last Submitted Order</h2>
        <div id="last-order-details">
            <p style="text-align:center; color: #6b7280;">No order submitted yet.</p>
        </div>
        <div class="logout-section">
            <p class="call-to-action">Por favor Click in the logout button</p>
            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffylogout.jpg" alt="Logout Button" class="logout-btn-img" onclick="logoutUser()">
        </div>
    </footer>
    
    <!-- âœ… Floating Action Buttons -->
    <div class="fab-container">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit Button" class="submit-btn-img" onclick="openConfirmModal()">
    </div>

    <!-- âœ… Custom Modal for Messages -->
    <div id="custom-modal" class="modal">
        <div class="modal-content">
            <h3 id="modal-title" style="font-size:1.25rem; font-weight:600;"></h3>
            <div id="modal-icon" style="margin-top:1rem; margin-bottom:1rem;"></div>
            <p id="modal-message" style="margin-top:1rem; color:#6b7280;"></p>
            <div class="modal-buttons" id="modal-buttons">
                <!-- Buttons will be rendered here dynamically -->
            </div>
        </div>
    </div>

    <!-- âœ… Custom Modal for Image Zoom -->
    <div id="image-modal" class="modal" onclick="closeImageModal()">
        <img id="zoomed-image" style="max-width: 90%; max-height: 90%; object-fit: contain;">
    </div>

    <script>
        // Store the state of the image zoom modal.
        let isImageZoomed = false;
        let products = {}; // Stores the product data globally
        let currentVendorList = 'General List'; // This is now a constant
        let debounceTimer;

        /**
         * Clears user permissions and redirects to the login page.
         */
        function logoutUser() {
             try {
                localStorage.removeItem('userPermissions');
                window.location.assign('https://portal.jengchirestaurant.com/index.html');
             } catch (err) {
                console.warn("localStorage not available or redirect failed:", err);
                openModal('Logout Failed', 'Could not complete logout in this environment.');
             }
        }

        /**
         * Shows a general-purpose modal.
         * @param {string} title - The title of the modal.
         * @param {string} message - The message of the modal.
         * @param {function} [onConfirm] - Optional callback for a confirmation modal.
         * @param {string} [imageUrl] - Optional image URL for a success modal.
         */
        let isModalOpen = false;
        function openModal(title, message, onConfirm = null, imageUrl = null) {
            if (isModalOpen) return;  // ðŸ”’ Prevents double-open
            isModalOpen = true;
            const modal = document.getElementById('custom-modal');
            const modalTitle = document.getElementById('modal-title');
            const modalMessage = document.getElementById('modal-message');
            const modalButtons = document.getElementById('modal-buttons');
            const modalIcon = document.getElementById('modal-icon');

            modalTitle.textContent = title;
            modalMessage.textContent = message;
            modalButtons.innerHTML = ''; // Clear previous buttons
            modalIcon.innerHTML = ''; // Clear previous icon/image

            if (imageUrl) {
                modalIcon.innerHTML = `<img src="${imageUrl}" alt="Success Image" style="height: 100px; width: auto; margin-bottom: 1rem;"/>`;
            }

            if (onConfirm) {
                // If onConfirm is provided, show confirm and cancel buttons.
                const confirmBtn = document.createElement('button');
                confirmBtn.textContent = 'OK';
                confirmBtn.classList.add('modal-btn', 'modal-confirm-btn');
                confirmBtn.onclick = () => {
                    closeModal();
                    onConfirm();
                };
                
                const cancelBtn = document.createElement('button');
                cancelBtn.textContent = 'Cancel';
                cancelBtn.classList.add('modal-btn', 'modal-cancel-btn');
                cancelBtn.onclick = closeModal;

                modalButtons.appendChild(confirmBtn);
                modalButtons.appendChild(cancelBtn);
            } else {
                // Otherwise, show a simple OK button.
                const okBtn = document.createElement('button');
                okBtn.textContent = 'OK';
                okBtn.classList.add('modal-btn', 'modal-confirm-btn');
                okBtn.onclick = closeModal;
                modalButtons.appendChild(okBtn);
            }

            modal.style.display = 'flex';
        }
        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.style.display = 'none';
            isModalOpen = false; // ðŸ”“ Reset lock
        }
        
        /**
         * Opens the confirmation modal for submitting an order.
         */
        function openConfirmModal() {
            const message = "Gracias Rony Carranza por ayudarme a poner la orden.";
            // Pass the correct URL to the openModal function
            openModal('Confirmar EnvÃ­o', message, submitInventory, 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
        }

        /**
         * Shows the image zoom modal.
         * @param {string} imageUrl - The URL of the image to display.
         */
        function openImageModal(imageUrl) {
            const imageModal = document.getElementById('image-modal');
            const zoomedImage = document.getElementById('zoomed-image');
            zoomedImage.src = imageUrl;
            imageModal.style.display = 'flex';
            isImageZoomed = true;
        }

        /**
         * Hides the image zoom modal.
         */
        function closeImageModal() {
            const imageModal = document.getElementById('image-modal');
            imageModal.style.display = 'none';
            isImageZoomed = false;
        }

        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const RESEND_FUNCTION_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/send-email";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', async () => {
             // To be uncommented for live site
             /*
             try {
                const userPermissions = localStorage.getItem('userPermissions');
                if (!userPermissions) {
                  window.location.assign('https://portal.jengchirestaurant.com/index.html');
                }
             } catch (err) {
                console.warn("localStorage not available in preview:", err);
             }
             */
            document.getElementById('order-date').valueAsDate = new Date();
            // Load the single 'General List' by default
            await loadInventory('General List');
            await displayLastOrder();
        });
        
        document.getElementById('inventory-list').addEventListener('input', (event) => {
            if (event.target.tagName === 'INPUT' && event.target.type === 'number') {
                const productName = event.target.id.replace('qty-', '');
                if (productName) {
                    debounceSave(productName, event.target.value);
                }
            }
        });
        
        function debounceSave(productName, value) {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(() => {
                updateQuantity(productName, 0, value);
            }, 500);
        }

        // The filter button function is no longer needed but this keeps the code running smoothly.
        async function loadInventory(vendorList) {
            currentVendorList = vendorList;
            
            const container = document.getElementById("inventory-list");
            container.innerHTML = `<p style="text-align:center; color: #6b7280; font-size: 1.125rem;">Loading inventory...</p>`;
            
            try {
                // Fetch all products for Rony, regardless of vendor
                let query = supabaseClient
                    .from("inventory_management")
                    .select("product_name, image_url, on_hand, position")
                    .eq('"user"', 'Rony')
                    .order('position', { ascending: true });

                const { data, error } = await query;
                
                if (error) throw error;
                
                if (!data || data.length === 0) {
                    container.innerHTML = `<p style="text-align:center; color:#6b7280;">No products found for this list.</p>`;
                    return;
                }

                const groupedByPosition = data.reduce((acc, item) => {
                    const position = item.position || 'Uncategorized';
                    if (!acc[position]) {
                        acc[position] = {};
                    }
                    if (!acc[position][item.product_name]) {
                        acc[position][item.product_name] = {
                            totalOnHand: 0,
                            image_url: item.image_url,
                        };
                    }
                    acc[position][item.product_name].totalOnHand += item.on_hand;
                    return acc;
                }, {});

                container.innerHTML = "";
                
                const sortedPositions = Object.keys(groupedByPosition).sort((a, b) => {
                    const numA = parseInt(a);
                    const numB = parseInt(b);
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return numA - numB;
                    }
                    return a.localeCompare(b);
                });

                for (const position of sortedPositions) {
                    const positionSection = document.createElement('div');
                    positionSection.classList.add('category-section');
                    positionSection.innerHTML = `<h2>Position ${position}</h2>`;
                    
                    const productGrid = document.createElement('section');
                    productGrid.classList.add('product-grid');
                    
                    const groupedProducts = groupedByPosition[position];
                    for (const productName in groupedProducts) {
                        const product = groupedProducts[productName];
                        const card = document.createElement("div");
                        card.classList.add("product-card");

                        card.innerHTML = `
                            <div class="product-details">
                                <img src="${product.image_url || "https://via.placeholder.com/80?text=No+Image"}" alt="${productName}" onclick="openImageModal('${product.image_url || "https://via.placeholder.com/80?text=No+Image"}')">
                                <div class="product-name">${productName}</div>
                            </div>
                            <div class="counter">
                                <button onclick="updateQuantity('${productName}', -1)">-</button>
                                <input type="number" id="qty-${productName}" value="${product.totalOnHand ?? 0}" min="0">
                                <button onclick="updateQuantity('${productName}', 1)">+</button>
                            </div>
                        `;
                        productGrid.appendChild(card);
                    }
                    
                    positionSection.appendChild(productGrid);
                    container.appendChild(positionSection);
                }

            } catch (e) {
                console.error("Error loading inventory:", e);
                container.innerHTML = `<p style="text-align:center; color:red;">Failed to load inventory. Please check your database connection.</p>`;
            }
        }

        async function updateQuantity(productName, change, value) {
            const input = document.getElementById(`qty-${productName}`);
            let newValue;
            if (value !== undefined) {
              newValue = parseInt(value);
            } else {
              newValue = parseInt(input.value) + change;
            }
            if (isNaN(newValue) || newValue < 0) {
              newValue = 0;
            }
            input.value = newValue;

            const { error } = await supabaseClient
                .from("inventory_management")
                .update({ on_hand: newValue })
                .eq("product_name", productName)
                .eq('"user"', 'Rony');

            if (error) {
                console.error("Error updating:", error);
                openModal('Error', 'An error occurred while updating the quantity. Please check the console.');
            }
        }

        async function submitInventory() {
    const orderDate = document.getElementById('order-date').value;
    if (!orderDate) {
         openModal('Submission Failed', 'Please select a date for your order.');
         return;
    }
    
    const productsToSubmit = Array.from(document.querySelectorAll('.product-card')).map(card => {
        const name = card.querySelector('.product-name').textContent;
        const quantity = parseInt(card.querySelector('input').value);
        return { name, quantity };
    }).filter(p => p.quantity > 0);
    
    if (productsToSubmit.length === 0) {
        openModal('Submission Failed', 'There are no items to submit. Please add quantities to your order.');
        return;
    }

    try {
        const { error: insertError } = await supabaseClient
            .from('submitted_orders')
            .insert([
                { order_date: new Date().toISOString(), order_details: productsToSubmit, vendor_list: currentVendorList }
            ]);
        
        if (insertError) throw insertError;
        console.log("Order submitted to database.");
    } catch (e) {
        console.error("Error submitting order:", e);
        openModal('Submission Failed', 'An error occurred while saving your order. Please check the console.');
        return;
    }

    // âœ… Send email (make sure it does NOT re-insert)
    await sendEmail(productsToSubmit, currentVendorList);

    // âœ… Reset quantities
    const productNamesToReset = productsToSubmit.map(p => p.name);
    try {
        const { error: resetError } = await supabaseClient
            .from("inventory_management")
            .update({ on_hand: 0 })
            .in("product_name", productNamesToReset)
            .eq('"user"', 'Rony');

        if (resetError) throw resetError;
        console.log("Quantities have been reset.");
    } catch (e) {
        console.error("Error resetting quantities:", e);
    }
    
    // âœ… Refresh footer immediately
    await displayLastOrder();
    await loadInventory(currentVendorList);
    document.getElementById('order-history-footer').scrollIntoView({ behavior: 'smooth' });
    
    openModal('Success', 'Gracias Rony Carranza por ayudarme a poner la orden', null, 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
}

        
        async function sendEmail(orderList, vendorList) {
            try {
                const htmlBody = formatOrderForEmail(orderList, vendorList);
                const response = await fetch(RESEND_FUNCTION_URL, {
                    method: 'POST',
                    headers: { 
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify({
                        to: "admin@jengchirestaurant.com",
                        subject: `New Jeng Chi Inventory Order from the ${vendorList} List`,
                        html: htmlBody
                    }),
                });
                
                if (!response.ok) {
                    const errorDetails = await response.text();
                    console.error("Error from Edge Function:", errorDetails);
                } else {
                    console.log("Email sent successfully!");
                }
            } catch (error) {
                console.error("Network error when calling Edge Function:", error);
            }
        }
        
        function formatOrderForEmail(orderList, vendorList) {
            let tableRows = '';
            orderList.forEach(item => {
                tableRows += `
                    <tr>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.name}</td>
                        <td style="padding: 8px; border: 1px solid #ddd;">${item.quantity}</td>
                    </tr>
                `;
            });
            return `
                <div style="font-family: sans-serif; padding: 20px; color: #333; max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 8px;">
                    <h2 style="color: #007bff;">New Jeng Chi Inventory Order</h2>
                    <p>A new order has been submitted for the <strong>${vendorList}</strong> list:</p>
                    <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product</th>
                                <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Quantity</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${tableRows}
                        </tbody>
                    </table>
                    <p style="margin-top: 20px; font-size: 12px; color: #666;">This order was submitted automatically by the Inventory App.</p>
                </div>
            `;
        }

        async function displayLastOrder() {
            const footer = document.getElementById('order-history-footer');
            const detailsContainer = document.getElementById('last-order-details');
            detailsContainer.innerHTML = `<p style="text-align:center; color: #6b7280;">Loading last order...</p>`;
            
            try {
                const { data, error } = await supabaseClient
                    .from('submitted_orders')
                    .select('order_date, order_details, vendor_list')
                    .order('order_date', { ascending: false })
                    .limit(1);

                if (error) throw error;

                if (data && data.length > 0) {
                    const lastOrder = data[0];
                    const orderDate = new Date(lastOrder.order_date).toLocaleString();
                    const orderList = lastOrder.order_details;
                    let orderDetailsHtml = '';
                    orderList.forEach(item => {
                        orderDetailsHtml += `<li class="order-summary-item"><span>${item.name}</span><span>${item.quantity}</span></li>`;
                    });

                    detailsContainer.innerHTML = `
                        <p style="font-size:0.9rem; color:#6b7280; margin-bottom:0.5rem;"><strong>Vendor List:</strong> ${lastOrder.vendor_list}</p>
                        <p style="font-size:0.9rem; color:#6b7280; margin-bottom:1rem;"><strong>Submitted On:</strong> ${orderDate}</p>
                        <ul class="order-summary-list">
                            ${orderDetailsHtml}
                        </ul>
                    `;
                    footer.style.display = 'block';
                } else {
                    detailsContainer.innerHTML = `<p style="text-align:center; color: #6b7280;">No orders found.</p>`;
                    footer.style.display = 'block';
                }

            } catch (e) {
                console.error("Error fetching last order:", e);
                detailsContainer.innerHTML = `<p style="text-align:center; color:red;">Failed to load order history.</p>`;
                footer.style.display = 'block';
            }
        }
        
    </script>
</body>
</html>
