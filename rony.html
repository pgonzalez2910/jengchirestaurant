<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi — Order List</title>
  <link rel="preconnect" href="https://fonts.googleapis.com"/>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root {
      --primary:#3b82f6; --primary-dark:#2563eb;
      --bg:#f3f4f6; --surface:#ffffff;
      --ink:#0f172a; --muted:#6b7280; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:"Inter",system-ui,Arial,sans-serif;background:var(--bg);color:var(--ink)}

    /* ===== Header (L: app name | C: title + logo | R: date picker) ===== */
    .app-header{position:sticky;top:0;z-index:20;background:var(--surface);box-shadow:0 2px 8px rgba(0,0,0,.08)}
    .app-header-inner{max-width:1400px;margin:0 auto;padding:14px 16px;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:12px}
    .app-name{font-weight:800;font-size:14px;letter-spacing:.4px;color:var(--primary)}
    .center-wrap{display:flex;flex-direction:column;align-items:center;gap:6px}
    .main-title{margin:0;font-size:18px;font-weight:800;color:var(--primary);letter-spacing:.5px}
    .brand{height:56px}
    .right-wrap{display:flex;justify-content:flex-end;align-items:center}
    .date-input{border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:13px;background:#fff}

    /* ===== Page layout ===== */
    .main-container{width:100%;max-width:100%;margin:10px auto;padding:0 12px}
    .category-section{background:transparent}
    .category-section h2{margin:16px 6px 10px;font-size:15px;font-weight:800;border-bottom:2px solid var(--border);padding-bottom:6px;color:#111}

    /* Full‑width responsive product grid */
    .product-grid{display:grid;gap:16px;grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}

    .product-card{background:var(--surface);border-radius:14px;padding:18px;box-shadow:0 3px 10px rgba(0,0,0,.08);display:flex;flex-direction:column;align-items:center;text-align:center}
    .product-card:hover{transform:translateY(-4px);box-shadow:0 10px 18px rgba(0,0,0,.12);transition:.2s}
    .product-details img{width:120px;height:120px;object-fit:contain;border:1px solid var(--border);border-radius:12px;background:linear-gradient(145deg,rgba(255,255,255,.45),rgba(255,255,255,.1))}
    .product-name{font-weight:700;font-size:14px;margin-top:10px;line-height:1.25}

    .counter{display:flex;align-items:center;gap:10px;margin-top:12px}
    .counter button{background:var(--primary);border:none;color:#fff;padding:8px 12px;border-radius:8px;font-size:16px;font-weight:700;cursor:pointer}
    .counter button:hover{background:var(--primary-dark)}
    .counter input{width:64px;text-align:center;border:1px solid var(--border);border-radius:8px;padding:8px 10px;font-size:14px}

    /* Submit FAB bottom-right */
    .fab{position:fixed;right:18px;bottom:18px;z-index:50}
    .fab img{width:92px;height:92px;border-radius:50%;box-shadow:0 6px 16px rgba(0,0,0,.25);cursor:pointer}
    .fab img:hover{transform:scale(1.06)}

    /* Footer last order */
    .footer-history{max-width:1100px;margin:22px auto;padding:18px;background:var(--surface);border-radius:12px;box-shadow:0 2px 6px rgba(0,0,0,.08)}
    .footer-history h3{margin:0 0 10px;font-size:16px;font-weight:800;border-bottom:2px solid var(--border);padding-bottom:6px}
    .order-summary-list{list-style:none;margin:0;padding:0}
    .order-summary-item{display:flex;justify-content:space-between;padding:6px 0;border-bottom:1px solid var(--border)}

    /* Modal */
    .modal{display:none;position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.4);justify-content:center;align-items:center}
    .modal-content{background:#fff;padding:22px;border-radius:12px;max-width:420px;width:92%;text-align:center;box-shadow:0 4px 10px rgba(0,0,0,.3)}
  </style>
</head>
<body>
  <!-- ===== Header ===== -->
<header class="app-header">
<div class="app-header-inner">
<!-- Left: App name -->
<div class="app-name" style="font-weight:800;font-size:14px;
background:linear-gradient(180deg,#000,#555);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;">
JENG CHI MANAGEMENT APP
</div>


<!-- Center: Logo first, then title under it -->
<div class="center-wrap" style="display:flex;flex-direction:column;align-items:center;gap:6px;">
<img class="brand" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Company Logo" style="height:64px;"/>
<h1 class="main-title" style="margin:0;font-size:20px;font-weight:800;
background:linear-gradient(180deg,#000,#555);
-webkit-background-clip:text;
-webkit-text-fill-color:transparent;">
GENERAL ORDER LIST
</h1>
</div>


<!-- Right: Date picker -->
<div class="right-wrap">
<input type="date" id="order-date" class="date-input"/>
</div>
</div>
</header>
  <!-- ===== Main ===== -->
  <div class="main-container">
    <section id="inventory-list"><p style="text-align:center;color:var(--muted);">Loading inventory…</p></section>
  </div>

  <!-- ===== Last order footer ===== -->
  <footer id="order-history-footer" class="footer-history" style="display:none;">
    <h3>Last Submitted Order</h3>
    <div id="last-order-details"><p style="text-align:center;color:var(--muted);">No order submitted yet.</p></div>
    <div style="text-align:center;margin-top:14px;">
      <p><b>Click logout when finished</b></p>
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffylogout.jpg" alt="Logout" style="height:110px;cursor:pointer;" onclick="logoutUser()"/>
    </div>
  </footer>

  <!-- Submit FAB -->
  <div class="fab">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit Order" onclick="submitInventory()"/>
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="font-size:18px;font-weight:800"></h3>
      <div id="modal-icon" style="margin:10px 0"></div>
      <p id="modal-message" style="color:var(--muted)"></p>
      <div style="margin-top:10px">
        <button onclick="closeModal()" style="padding:8px 14px;background:var(--primary);color:#fff;border:none;border-radius:8px;font-weight:700">OK</button>
      </div>
    </div>
  </div>

<script>
/***** Supabase *****/
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/***** Constants & helpers *****/
const TZ = "America/Chicago";
const ORDER_CONFIRMATION_TO = "admin@jengchirestaurant.com";
function formatCT(dateLike){
  return new Intl.DateTimeFormat("en-US",{dateStyle:"medium",timeStyle:"short",timeZone:TZ}).format(new Date(dateLike));
}
function todayYmd(){const d=new Date();return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`}
function dateInputToLocalMidnightISO(ymd){if(!ymd)return new Date().toISOString();const [y,m,d]=ymd.split('-').map(Number);return new Date(y,m-1,d,0,0,0).toISOString()}

/***** Init *****/
document.addEventListener('DOMContentLoaded',async()=>{
  document.getElementById('order-date').value = todayYmd();
  await loadInventory();
  await displayLastOrder();
});

function logoutUser(){
  localStorage.removeItem('userPermissions');
  window.location = 'https://portal.jengchirestaurant.com/index.html';
}

/***** Inventory UI (inputs blank when 0) *****/
async function loadInventory(){
  const container = document.getElementById('inventory-list');
  container.innerHTML = "<p style='text-align:center;color:#6b7280;'>Loading…</p>";

  const { data, error } = await supabaseClient
    .from('inventory_management')
    .select('product_name,image_url,on_hand,position')
    .eq('user','Rony')
    .order('position',{ascending:true});

  if(error || !data){
    console.error(error); container.innerHTML = '<p>Error loading.</p>'; return;
  }

  // Group by position and roll-up duplicates per product
  const grouped = {};
  for(const row of data){
    const pos = row.position || 'Uncategorized';
    grouped[pos] ||= {};
    const prod = grouped[pos][row.product_name] ||= { total:0, image: row.image_url };
    prod.total += Number(row.on_hand)||0;
  }

  // Render
  container.innerHTML = '';
  for(const pos of Object.keys(grouped)){
    const sec = document.createElement('div');
    sec.className = 'category-section';
    sec.innerHTML = `<h2>Position ${pos}</h2>`;

    const grid = document.createElement('div');
    grid.className = 'product-grid';

    for(const [name,obj] of Object.entries(grouped[pos])){
      const card = document.createElement('div');
      card.className = 'product-card';
      const valueAttr = Number(obj.total)>0 ? `value="${obj.total}"` : '';
      card.innerHTML = `
        <div class="product-details">
          <img src="${obj.image || 'https://via.placeholder.com/120'}" alt="${name}">
        </div>
        <div class="product-name">${name}</div>
        <div class="counter">
          <button onclick="updateQty('${encodeURIComponent(name)}',-1)">-</button>
          <input type="number" data-name="${name.replace(/"/g,'&quot;')}" ${valueAttr} min="0" placeholder="" />
          <button onclick="updateQty('${encodeURIComponent(name)}',1)">+</button>
        </div>`;
      grid.appendChild(card);
    }

    sec.appendChild(grid);
    container.appendChild(sec);
  }
}

async function updateQty(encodedName, change){
  const name = decodeURIComponent(encodedName);
  const input = document.querySelector(`input[data-name="${CSS.escape(name)}"]`);
  let current = parseInt(input?.value ?? '',10); if(!Number.isFinite(current) || current<0) current=0;
  let next = current + change; if(next<0) next=0;
  if(input) input.value = next===0 ? '' : String(next); // keep blank when 0

  await supabaseClient
    .from('inventory_management')
    .update({ on_hand: next })
    .eq('product_name', name)
    .eq('user','Rony');
}

/***** Submit order (SAVE explicit 0s) *****/
async function submitInventory(){
  const dateInput = document.getElementById('order-date').value;
  const orderDateISO = dateInputToLocalMidnightISO(dateInput);

  // collect ALL products; blank => 0
  const products = [...document.querySelectorAll('.product-card')].map(card=>{
    const name = card.querySelector('.product-name').textContent.trim();
    const raw = card.querySelector('input').value;
    const n = parseInt(raw,10);
    const quantity = Number.isFinite(n) && n>=0 ? n : 0;
    return { name, quantity, out_of_stock: quantity===0 };
  });

  const vendorList = 'General List';

  // master
  const { error: orderErr } = await supabaseClient.from('submitted_orders').insert([
    { order_date: new Date().toISOString(), vendor_list: vendorList, summary_details: products }
  ]);
  if(orderErr){ console.error(orderErr); openModal('Error','Submit failed'); return; }

  // email (best effort)
  try{
    await supabaseClient.functions.invoke('send-email', { body: { to: ORDER_CONFIRMATION_TO, vendor: vendorList, orderDate: orderDateISO, items: products } });
  }catch(e){ console.warn('Email function error:', e); }

  // per-item snapshot (insert zeros too)
  for(const p of products){
    await supabaseClient.from('inventory_check').insert([
      { order_date: new Date().toISOString(), product_name: p.name, on_hand: p.quantity, tentative: p.quantity, user: 'Rony' }
    ]);
  }

  // reset current on_hand to 0
  await supabaseClient.from('inventory_management')
    .update({ on_hand: 0 })
    .in('product_name', products.map(p=>p.name))
    .eq('user','Rony');

  await displayLastOrder();
  await loadInventory();
  document.getElementById('order-history-footer').scrollIntoView({behavior:'smooth'});
  openModal('¡Éxito!','Gracias Rony por ayudarme a poner la orden','https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
}

/***** Last order footer *****/
async function displayLastOrder(){
  const cont = document.getElementById('last-order-details');
  const footer = document.getElementById('order-history-footer');
  cont.innerHTML = '<p>Loading…</p>';

  const { data, error } = await supabaseClient
    .from('submitted_orders')
    .select('order_date,summary_details,vendor_list')
    .order('order_date',{ascending:false})
    .limit(1);

  if(error || !data || !data.length){
    cont.innerHTML = '<p>No orders.</p>'; footer.style.display='block'; return;
  }

  const last = data[0];
  let details = [];
  if(Array.isArray(last.summary_details)) details = last.summary_details;
  else if(typeof last.summary_details === 'string'){ try{ details = JSON.parse(last.summary_details) }catch{ details=[] } }

  const items = details.map(i=>`<li class="order-summary-item"><span>${i.name}</span><span>${i.quantity}</span></li>`).join('');
  cont.innerHTML = `<p><strong>Vendor:</strong> ${last.vendor_list}</p>
                    <p><strong>Date:</strong> ${formatCT(last.order_date)}</p>
                    <ul class="order-summary-list">${items}</ul>`;
  footer.style.display='block';
}

/***** Modal *****/
function openModal(title,msg,img){
  const m = document.getElementById('custom-modal');
  document.getElementById('modal-title').textContent = title;
  document.getElementById('modal-message').textContent = msg;
  document.getElementById('modal-icon').innerHTML = img ? `<img src="${img}" style="height:100px">` : '';
  m.style.display = 'flex';
}
function closeModal(){ document.getElementById('custom-modal').style.display = 'none' }
</script>
</body>
</html>


