<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Benefits (Corporate Tech)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans:['Inter','system-ui','-apple-system','Segoe UI','Roboto','Arial','sans-serif'], 'serif-head':['Playfair Display','serif'] },
          colors: { jcgold:'#B9965A', ink:'#0F172A', tech:'#0EA5E9' },
          boxShadow: { soft:'0 10px 30px rgba(2,6,23,.06)' }
        }
      }
    }; /* ← keep the semicolon */
  </script>

  <style>
    .soft-card{ background:#fff; border:1px solid #E5E7EB; border-radius:14px; box-shadow:0 6px 24px rgba(15,23,42,.06); overflow:visible; }
    .section-cap{ height:3px; background:linear-gradient(90deg,#0EA5E9 0%, #B9965A 60%, transparent 100%); border-radius:4px 4px 0 0; }
    .lbl{ font-size:11px; letter-spacing:.14em; text-transform:uppercase; font-weight:700; color:#64748B; }
    .inp{ margin-top:.25rem; width:100%; border:1px solid #CBD5E1; border-radius:10px; padding:.5rem .75rem; font-size:.9rem; }
    .inp:focus{ outline:none; border-color:#0EA5E9; box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .select-chevron{ appearance:none; background:no-repeat right .6rem center/16px url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230EA5E9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); padding-right:2rem; }
    .step-dot{ width:28px; height:28px; border-radius:9999px; display:grid; place-items:center; font-size:12px; font-weight:700; }
  </style>
</head>
<body class="h-full">
  <header class="bg-white/90 backdrop-blur sticky top-0 z-20 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 lg:px-6 py-3 flex items-center justify-between">
      <div>
        <div class="text-[11px] font-semibold tracking-widest text-jcgold uppercase">Jeng Chi • Enrollment</div>
        <h1 class="font-serif-head text-2xl text-ink -mt-0.5">Executive Benefits Platform</h1>
      </div>
      <div class="flex items-center gap-3">
        <span class="hidden sm:inline-flex items-center rounded-lg bg-white px-3 py-1 text-sm ring-1 ring-slate-200 text-slate-700">Jeng Chi Restaurant</span>
        <span class="text-sm text-slate-500">Status: <b id="health" class="text-ink">Connecting…</b></span>
      </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 lg:px-6 pb-3">
      <div class="flex items-center gap-3">
        <div class="step-dot bg-ink text-white">1</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/80 text-white">2</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/60 text-white">3</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/40 text-white">4</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/20 text-white">5</div>
      </div>
    </div>
  </header>

  <div class="max-w-7xl mx-auto px-4 lg:px-6 py-8 grid grid-cols-12 gap-8">

    <main class="col-span-12 lg:col-span-8 space-y-10">

      <!-- 1. Context -->
      <section id="sec-context" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">1 · Employee Context</h2>
            <span class="text-xs text-slate-500">Pick employee & coverage tier</span>
          </div>
          <div class="grid md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-2">
              <label class="lbl">Employee</label>
              <div class="relative">
                <input id="empSearch" class="inp" placeholder="Search by name or username…" autocomplete="off" />
                <div id="empList" class="absolute z-50 left-0 right-0 bg-white ring-1 ring-slate-200 rounded-lg mt-1 hidden max-h-64 overflow-auto shadow-soft"></div>
              </div>
              <p id="empInfo" class="mt-2 text-sm text-slate-700"></p>
            </div>
            <div>
              <label class="lbl">Coverage Tier</label>
              <select id="tier" class="inp select-chevron">
                <option value="">— Select Tier —</option>
                <option value="EO">Employee Only</option>
                <option value="ES">Employee + Spouse/Partner</option>
                <option value="EC">Employee + Child(ren)</option>
                <option value="EF">Employee + Family</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- 2. Reason -->
      <section id="sec-reason" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">2 · Reason for Submitting </h2>
            <span class="text-xs text-slate-500">QLE & Open Enrollment changes</span>
          </div>

          <div class="grid md:grid-cols-2 gap-6">
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-5">
              <div class="font-semibold text-ink mb-1">Qualifying Life Event</div>
              <p class="text-[12px] text-slate-600 mb-4">Requests must be submitted within 30 days of the event.</p>
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_new_hire" type="checkbox" class="rounded border-slate-300"> New Hire</label>
                  <input id="qe_new_hire_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_emp_gain_loss" type="checkbox" class="rounded border-slate-300"> Employee: Gain/Loss of Coverage</label>
                  <input id="qe_emp_gain_loss_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_birth" type="checkbox" class="rounded border-slate-300"> Birth / Adoption</label>
                  <input id="qe_birth_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_marriage" type="checkbox" class="rounded border-slate-300"> Marriage</label>
                  <input id="qe_marriage_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_dep_gain_loss" type="checkbox" class="rounded border-slate-300"> Dependent: Gain/Loss</label>
                  <input id="qe_dep_gain_loss_date" type="date" class="inp">
                </div>
                <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_court" type="checkbox" class="rounded border-slate-300"> Court Order</label>
                <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_demo_change" type="checkbox" class="rounded border-slate-300"> Demographic Change</label>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_rehire" type="checkbox" class="rounded border-slate-300"> Rehire</label>
                  <input id="qe_rehire_date" type="date" class="inp">
                </div>
              </div>
            </div>

            <div class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="font-semibold text-ink mb-2">Open Enrollment</div>
              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-2 text-sm"><input id="oe_add_cov"   type="checkbox" class="rounded border-slate-300"> Add Coverage</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_drop_cov"  type="checkbox" class="rounded border-slate-300"> Drop Coverage</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_med" type="checkbox" class="rounded border-slate-300"> Change Medical</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_den" type="checkbox" class="rounded border-slate-300"> Change Dental</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_vis" type="checkbox" class="rounded border-slate-300"> Change Vision</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_update_vol" type="checkbox" class="rounded border-slate-300"> Update Vol Life Amount</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_add_dep"   type="checkbox" class="rounded border-slate-300"> Add Dependent(s)</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_demo"     type="checkbox" class="rounded border-slate-300"> Demographic Update</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. Employee -->
      <section id="sec-employee" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">3 · Employee Information</h2>
            <span class="text-xs text-slate-500">Personal • Contact • Employment</span>
          </div>

          <!-- START MODIFIED GRID 1 -->
          <div class="grid md:grid-cols-4 gap-4">
            <div><label class="lbl">SSN</label><input id="ssn" class="inp" placeholder="xxx-xx-xxxx"></div>
            <div><label class="lbl">Date of Birth</label><input id="dob" type="date" class="inp"></div>
            <div><label class="lbl">Gender</label>
              <select id="gender" class="inp select-chevron"><option value="">— Select —</option><option>M</option><option>F</option><option>X</option></select>
            </div>
            <!-- MARITAL STATUS ADDED HERE -->
            <div>
              <label class="lbl">Marital Status</label>
              <select id="marital_status" class="inp select-chevron">
                <option value="">-- Select --</option>
                <option value="single">Single</option>
                <option value="married">Married</option>
                <option value="divorced">Divorced</option>
                <option value="widowed">Widowed</option>
                <option value="prefer_not_to_say">Prefer not to say</option>
              </select>
            </div>
          </div>
          <!-- END MODIFIED GRID 1 -->

          <!-- START NEW GRID 2 to hold the moved Hire Date -->
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Date of Hire (Required)</label><input id="hire_date" type="date" class="inp"></div>
          </div>
          <!-- END NEW GRID 2 -->

          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div class="md:col-span-2"><label class="lbl">Address (Street, Apt/Bldg #)</label><input id="addr_street" class="inp"></div>
            <div><label class="lbl">City</label><input id="addr_city" class="inp"></div>
            <div><label class="lbl">State</label><input id="addr_state" class="inp"></div>
          </div>

          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Zip</label><input id="addr_zip" class="inp"></div>
            <div><label class="lbl">Phone</label><input id="phone" class="inp"></div>
            <div><label class="lbl">Email</label><input id="email" class="inp"></div>
            <div><label class="lbl">Job Title</label><input id="job_title" class="inp"></div>
          </div>

          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Annual Salary</label><input id="annual_salary" type="number" step="0.01" class="inp" placeholder="0.00"></div>
          </div>
        </div>
      </section>

      <!-- 4. Dependents -->
      <section id="sec-dependents" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">4 · Dependents</h2>
            <span class="text-xs text-slate-500">Spouse/Partner and Children</span>
          </div>

          <div id="spouseBlock" class="hidden rounded-xl border border-slate-200 bg-slate-50 p-5 mb-6">
            <div class="font-semibold text-ink mb-3">Spouse / Domestic Partner</div>
            <div class="grid md:grid-cols-5 gap-4">
              <div><label class="lbl">First</label><input id="sp_first" class="inp"></div>
              <div><label class="lbl">Last</label><input id="sp_last" class="inp"></div>
              <div><label class="lbl">DOB</label><input id="sp_dob" type="date" class="inp"></div>
              <div><label class="lbl">SSN</label><input id="sp_ssn" class="inp"></div>
              <div><label class="lbl">Gender</label>
                <select id="sp_gender" class="inp select-chevron"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
              </div>
            </div>
          </div>

          <div id="childrenBlock" class="hidden">
            <div class="font-semibold text-ink mb-2">Dependent Children</div>
            <div id="kidsWrap" class="space-y-4"></div>
            <button id="addKid" type="button" class="mt-3 inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50">+ Add Dependent Child</button>
          </div>
        </div>
      </section>

      <!-- 5. Plans -->
      <section id="sec-plans" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">5 · Plans & Contribution</h2>
            <span class="text-xs text-slate-500">Pick plans • See totals • Save or PDF</span>
          </div>

          <div class="grid md:grid-cols-4 gap-6">
            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Medical</div>
              <select id="medPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="HMO_HSA">HMO / ATBAP393 HSA</option>
                <option value="HMO">HMO / ATBAB303</option>
                <option value="PPO">PPO / ATBCB402</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="medPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="medAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>

            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Dental</div>
              <select id="denPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="F_PLAN_2W">F-PLAN 2W / Base MAC</option>
                <option value="F_PLAN_3W">F-PLAN 3W / Buy Up MAC</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="denPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="denAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>

            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Vision</div>
              <select id="visPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="PLAN_1">UC ClearVision Plan 1</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="visPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="visAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>

            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">HSA Contribution</div>
              <label class="lbl">Per Paycheck</label>
              <input id="hsa_amount" type="number" step="0.01" class="inp" placeholder="0.00" />
              <p class="text-xs text-slate-500 mt-2">Voluntary pre-tax contribution (included in totals).</p>
              <div class="mt-4 border-t pt-4">
                <div class="font-semibold text-ink mb-2">Voluntary Life</div>
                <label class="lbl">Amount (Per Paycheck)</label>
                <input id="vol_life_amount" type="number" step="0.01" class="inp" placeholder="0.00" />
                <p class="text-xs text-slate-500 mt-2">Enter a value to manage Beneficiaries.</p>
              </div>
            </div>
          </div>

          <div id="beneficiariesBlock" class="hidden mt-6 p-5 rounded-lg border border-slate-200 bg-slate-50">
            <div class="font-semibold text-ink mb-2">Beneficiaries</div>
            <div id="beneficiariesWrap" class="space-y-3"></div>
            <button id="addBeneficiary" type="button" class="mt-3 inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50">+ Add Beneficiary</button>
            <p class="text-xs text-slate-600 mt-2">Tip: Shares should total 100%.</p>
          </div>

          <div class="mt-6 flex gap-3">
            <button id="btnSave" type="button" class="inline-flex items-center rounded-lg bg-tech text-white px-5 py-2.5 font-semibold hover:brightness-110">Save</button>
            <button id="btnPDF"  type="button" class="inline-flex items-center rounded-lg bg-ink text-white px-5 py-2.5 font-semibold hover:bg-slate-800">PDF</button>
            <p id="msg" class="text-sm text-slate-700 self-center"></p>
          </div>
        </div>
      </section>

    </main>

    <aside class="col-span-12 lg:col-span-4">
      <div class="sticky top-24 soft-card p-6 md:p-7">
        <div class="text-[11px] font-semibold tracking-widest text-jcgold uppercase">Summary</div>
        <h3 class="font-serif-head text-xl text-ink mt-1 mb-1">At-a-Glance</h3>
        <p class="text-sm text-slate-600 mb-4">Totals update as you select plans.</p>
        <div class="space-y-3">
          <div class="flex justify-between text-sm"><span class="text-slate-600">Medical</span><span id="sum_med" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Dental</span><span id="sum_den" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Vision</span><span id="sum_vis" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Tier</span><span id="sum_tier" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">HSA (per pay)</span><span id="sum_hsa" class="font-semibold text-ink">$0.00</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Vol Life (per pay)</span><span id="sum_vl" class="font-semibold text-ink">$0.00</span></div>
          <div class="h-px bg-slate-200 my-2"></div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">Per Pay Total</span>
            <span id="totalPPP" class="text-2xl font-serif-head text-ink">$0.00</span>
          </div>
          <div class="text-right text-[12px] text-slate-600">Annual (26): <span id="totalAnnual" class="font-semibold text-ink">$0.00</span></div>
          <div class="grid grid-cols-2 gap-3 mt-4">
            <button id="btnSave2" type="button" class="inline-flex items-center rounded-lg bg-tech text-white px-3 py-2 font-semibold hover:brightness-110">Save</button>
            <button id="btnPDF2"  type="button" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 font-semibold text-ink hover:bg-slate-50">PDF</button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-benefits";
    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let RATES = {};
    let EMP = null;
    let timer = null;

    // elements
    const tierSel = document.getElementById("tier");
    const medPlan = document.getElementById("medPlan");
    const denPlan = document.getElementById("denPlan");
    const visPlan = document.getElementById("visPlan");
    const medPPP = document.getElementById("medPPP");
    const medAnnual = document.getElementById("medAnnual");
    const denPPP = document.getElementById("denPPP");
    const denAnnual = document.getElementById("denAnnual");
    const visPPP = document.getElementById("visPPP");
    const visAnnual = document.getElementById("visAnnual");
    const totalPPP = document.getElementById("totalPPP");
    const totalAnnual = document.getElementById("totalAnnual");
    const sumMed = document.getElementById("sum_med");
    const sumDen = document.getElementById("sum_den");
    const sumVis = document.getElementById("sum_vis");
    const sumTier = document.getElementById("sum_tier");
    const sumHsa = document.getElementById("sum_hsa");
    const sumVL = document.getElementById("sum_vl");
    const btnSave = document.getElementById("btnSave");
    const btnPDF = document.getElementById("btnPDF");
    const btnSave2 = document.getElementById("btnSave2");
    const btnPDF2 = document.getElementById("btnPDF2");
    const msg = document.getElementById("msg");
    const hsaInput = document.getElementById("hsa_amount");
    const vlInput  = document.getElementById("vol_life_amount");
    const beneBlock = document.getElementById("beneficiariesBlock");
    const beneWrap  = document.getElementById("beneficiariesWrap");
    const kidsWrap  = document.getElementById("kidsWrap");
    const empSearch = document.getElementById("empSearch");
    const empList   = document.getElementById("empList");
    const empInfo   = document.getElementById("empInfo");

    const val = id => document.getElementById(id)?.value.trim();
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v ?? ""); };
    const getCB = id => document.getElementById(id)?.checked || false;
    const setCB = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

    // health
    (async () => {
      const el = document.getElementById("health");
      try {
        const r = await sb.from('benefit_rates').select('coverage').limit(1);
        el.textContent = r.error ? 'REST Error' : 'DB Connected';
      } catch { el.textContent = "Blocked by browser"; }
    })();

    async function loadRates() {
      const { data, error } = await sb.from("benefit_rates").select("coverage,plan_code,tier,amount,per_year_periods");
      if (error) return console.error(error);
      RATES = {};
      for (const r of data) {
        RATES[r.coverage] ??= {};
        RATES[r.coverage][r.plan_code] ??= {};
        RATES[r.coverage][r.plan_code][r.tier] = { amt: Number(r.amount), ppp: r.per_year_periods || 26 };
      }
    }

    const fmt = n => `$${Number(n||0).toFixed(2)}`;
    const mapTier = t => ({EO:"Employee Only", ES:"Employee + Spouse/Partner", EC:"Employee + Child(ren)", EF:"Employee + Family"}[t] || "—");
    function mapPlanLabel(c, code){
      const MAP = {
        MEDICAL:{HMO_HSA:"HMO / ATBAP393 HSA", HMO:"HMO / ATBAB303", PPO:"PPO / ATBCB402", WAIVE:"Waive"},
        DENTAL: {F_PLAN_2W:"F-PLAN 2W / Base MAC", F_PLAN_3W:"F-PLAN 3W / Buy Up MAC", WAIVE:"Waive"},
        VISION: {PLAN_1:"UC ClearVision Plan 1", WAIVE:"Waive"}
      };
      return MAP[c]?.[code] || "—";
    }
    function getRate(c,p,t){ if(!p || p==="WAIVE") return {amt:0,ppp:26}; return RATES?.[c]?.[p]?.[t] ?? {amt:0,ppp:26}; }

    function toggleDepBlocks(){
      document.getElementById("spouseBlock").classList.toggle("hidden", !(tierSel.value==="ES"||tierSel.value==="EF"));
      document.getElementById("childrenBlock").classList.toggle("hidden", !(tierSel.value==="EC"||tierSel.value==="EF"));
    }

    function updatePrices(){
      const t = tierSel.value || "";
      const mr = getRate("MEDICAL", medPlan.value, t);
      const dr = getRate("DENTAL",  denPlan.value, t);
      const vr = getRate("VISION",  visPlan.value, t);

      medPPP.textContent = fmt(mr.amt);   medAnnual.textContent = fmt(mr.amt * mr.ppp);
      denPPP.textContent = fmt(dr.amt);   denAnnual.textContent = fmt(dr.amt * dr.ppp);
      visPPP.textContent = fmt(vr.amt);   visAnnual.textContent = fmt(vr.amt * vr.ppp);

      sumMed.textContent = medPlan.value ? mapPlanLabel("MEDICAL", medPlan.value) : "—";
      sumDen.textContent = denPlan.value ? mapPlanLabel("DENTAL",  denPlan.value) : "—";
      sumVis.textContent = visPlan.value ? mapPlanLabel("VISION",  visPlan.value) : "—";
      sumTier.textContent = tierSel.value ? mapTier(tierSel.value) : "—";

      const hsa = Number(hsaInput.value||0);
      const vl  = Number(vlInput.value||0);
      sumHsa.textContent = fmt(hsa);
      sumVL.textContent  = fmt(vl);

      const total = mr.amt + dr.amt + vr.amt + hsa + vl;
      totalPPP.textContent = fmt(total);
      totalAnnual.textContent = fmt(total * 26);

      toggleDepBlocks();
      beneBlock.classList.toggle("hidden", !(vl > 0));
      const ok = !!EMP;
      [btnSave,btnSave2,btnPDF,btnPDF2].forEach(b=> b.disabled = !ok);
    }

    function clearForNewEmployee(){
      tierSel.value=""; medPlan.value=""; denPlan.value=""; visPlan.value="";
      // ADDED marital_status to the reset list
      ["ssn","dob","gender","marital_status","hire_date","addr_street","addr_city","addr_state","addr_zip","phone","email","job_title","annual_salary","hsa_amount","vol_life_amount"]
        .forEach(id => setVal(id,""));
      kidsWrap.innerHTML="";
      beneWrap.innerHTML="";
      document.getElementById("spouseBlock").classList.add("hidden");
      document.getElementById("childrenBlock").classList.add("hidden");
      beneBlock.classList.add("hidden");
      sumMed.textContent="—"; sumDen.textContent="—"; sumVis.textContent="—"; sumTier.textContent="—";
      totalPPP.textContent="$0.00"; totalAnnual.textContent="$0.00"; sumHsa.textContent="$0.00"; sumVL.textContent="$0.00";
      [btnSave,btnSave2,btnPDF,btnPDF2].forEach(b=> b.disabled = true);
    }

    // --- Employee search (PUBLIC alias view) ---
    empSearch.addEventListener("input", ()=>{
      clearTimeout(timer);
      timer=setTimeout(async ()=>{
        const q=empSearch.value.trim();
        empList.innerHTML=""; empList.classList.add("hidden");
        if(!q){ return; }

        const { data, error } = await sb
          .from('v_employees_masked')
          .select('id, full_name, username, position_title, hire_date, dob, phone_primary, email, address_line1, address_line2, ssn_masked')
          .or(`full_name.ilike.%${q}%,username.ilike.%${q}%`)
          .order('full_name')
          .limit(25);

        if (error) { console.error('search error:', error.message); return; }
        if (!data || data.length===0) return;

        empList.classList.remove("hidden");
        data.forEach(e=>{
          const row=document.createElement("div");
          row.className="px-3 py-2 rounded-md hover:bg-slate-100 cursor-pointer text-sm";
          row.textContent=`${e.full_name} — ${e.position_title ?? ""}`;
          row.onclick=()=>selectEmployee(e);
          empList.appendChild(row);
        });
      },220);
    });

    function hydrateEmployeeUiFromHR(e){
      setVal("job_title",  e.position_title ?? "");
      setVal("hire_date",  e.hire_date ?? "");
      setVal("dob",        e.dob ?? "");
      setVal("phone",      e.phone_primary ?? "");
      setVal("email",      e.email ?? "");
      const street = [e.address_line1, e.address_line2].filter(Boolean).join(" ");
      setVal("addr_street", street);
      setVal("ssn",        e.ssn_masked ?? "");
    }

    async function selectEmployee(e){
      EMP = e;
      empList.classList.add("hidden");
      empSearch.value = e.full_name;
      empInfo.textContent = `Title: ${e.position_title ?? "—"} • User: ${e.username ?? "—"} • Hired: ${e.hire_date ?? "—"}`;

      clearForNewEmployee();
      hydrateEmployeeUiFromHR(e);

      await preloadEnrollment();
      updatePrices();
      [btnSave,btnSave2,btnPDF,btnPDF2].forEach(b=> b.disabled = false);
    }

    document.getElementById("addKid").addEventListener("click", ()=> addKidRow());
    function addKidRow(row=null){
      const div=document.createElement("div");
      div.className="grid md:grid-cols-6 gap-4 items-end p-4 rounded-lg border border-slate-200 bg-white";
      div.innerHTML=`
        <div><label class="lbl">First</label><input class="inp kid_first"></div>
        <div><label class="lbl">Last</label><input class="inp kid_last"></div>
        <div><label class="lbl">DOB</label><input type="date" class="inp kid_dob"></div>
        <div><label class="lbl">SSN</label><input class="inp kid_ssn"></div>
        <div><label class="lbl">Gender</label>
          <select class="inp select-chevron kid_gender"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
        <div><button type="button" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50 removeKid">Remove</button></div>`;
      kidsWrap.appendChild(div);
      if(row){ div.querySelector(".kid_first").value=row.first||""; div.querySelector(".kid_last").value=row.last||""; div.querySelector(".kid_dob").value=row.dob||""; div.querySelector(".kid_ssn").value=row.ssn||""; div.querySelector(".kid_gender").value=row.gender||""; }
      div.querySelector(".removeKid").onclick=()=>div.remove();
    }

    document.getElementById("addBeneficiary").addEventListener("click", ()=> addBeneRow());
    function addBeneRow(row=null){
      const div=document.createElement("div");
      div.className="grid md:grid-cols-6 gap-3 items-end p-3 rounded-md border border-slate-200 bg-white";
      div.innerHTML=`
        <div class="md:col-span-2"><label class="lbl">Name</label><input class="inp bene_name"></div>
        <div><label class="lbl">Relationship</label><input class="inp bene_rel" placeholder="Spouse/Child/Other"></div>
        <div><label class="lbl">% Share</label><input type="number" step="1" class="inp bene_pct" placeholder="0"></div>
        <div><label class="lbl">SSN (opt)</label><input class="inp bene_ssn"></div>
        <div><label class="lbl">DOB (opt)</label><input type="date" class="inp bene_dob"></div>
        <div><button type="button" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50 bene_remove">Remove</button></div>`;
      beneWrap.appendChild(div);
      if(row){
        div.querySelector(".bene_name").value=row.name||"";
        div.querySelector(".bene_rel").value=row.relationship||"";
        div.querySelector(".bene_pct").value=row.pct||"";
        div.querySelector(".bene_ssn").value=row.ssn||"";
        div.querySelector(".bene_dob").value=row.dob||"";
      }
      div.querySelector(".bene_remove").onclick=()=>div.remove();
    }

    async function preloadEnrollment(){
      if(!EMP) return;
      const { data } = await sb
        .from("benefit_enrollments")
        .select("*")
        .eq("employee_id", Number(EMP.id))
        .maybeSingle();

      if(!data) return;

      if(data.tier_election) tierSel.value=data.tier_election;
      if(data.medical_plan)  medPlan.value=data.medical_plan;
      if(data.dental_plan)   denPlan.value=data.dental_plan;
      if(data.vision_plan)   visPlan.value=data.vision_plan;

      const q=data.qualifying_events||{};
      setCB("qe_new_hire",q.new_hire); setVal("qe_new_hire_date",q.new_hire_date);
      setCB("qe_emp_gain_loss",q.emp_gain_loss); setVal("qe_emp_gain_loss_date",q.emp_gain_loss_date);
      setCB("qe_birth",q.birth_or_adoption); setVal("qe_birth_date",q.birth_or_adoption_date);
      setCB("qe_marriage",q.marriage); setVal("qe_marriage_date",q.marriage_date);
      setCB("qe_dep_gain_loss",q.dependent_gain_loss); setVal("qe_dep_gain_loss_date",q.dependent_gain_loss_date);
      setCB("qe_court",q.court_order); setCB("qe_demo_change",q.demo_change);
      setCB("qe_rehire",q.rehire); setVal("qe_rehire_date",q.rehire_date);

      const oe=data.oe_changes||{};
      setCB("oe_add_cov",oe.add_cov); setCB("oe_drop_cov",oe.drop_cov);
      setCB("oe_change_med",oe.change_med); setCB("oe_change_den",oe.change_den);
      setCB("oe_change_vis",oe.change_vis); setCB("oe_update_vol",oe.update_vol);
      setCB("oe_add_dep",oe.add_dep); setCB("oe_demo",oe.demo_change);

      if (data.ssn)  setVal("ssn",  data.ssn);
      if (data.dob)  setVal("dob",  data.dob);
      if (data.gender) setVal("gender", data.gender);
      if (data.marital_status) setVal("marital_status", data.marital_status); // LOAD new field
      if (data.phone)  setVal("phone",  data.phone);
      if (data.email)  setVal("email",  data.email);
      if (data.job_title) setVal("job_title", data.job_title);
      if (data.hire_date) setVal("hire_date", data.hire_date);
      if (data.annual_salary!=null) setVal("annual_salary", data.annual_salary);

      const a=data.address||{};
      if (a.street) setVal("addr_street", a.street);
      if (a.city)   setVal("addr_city", a.city);
      if (a.state)  setVal("addr_state", a.state);
      if (a.zip)    setVal("addr_zip", a.zip);

      if (data.hsa_amount!=null) setVal("hsa_amount", data.hsa_amount);
      if (data.vol_life_amount!=null) setVal("vol_life_amount", data.vol_life_amount);

      beneWrap.innerHTML="";
      (data.beneficiaries||[]).forEach(b=>addBeneRow(b));

      if(data.spouse){
        setVal("sp_first",data.spouse.first); setVal("sp_last",data.spouse.last);
        setVal("sp_dob",data.spouse.dob); setVal("sp_ssn",data.spouse.ssn);
        setVal("sp_gender",data.spouse.gender);
      }
      kidsWrap.innerHTML="";
      (data.dependents||[]).forEach(d=>addKidRow(d));
    }

    async function handleSave() {
      if (!EMP) { msg.textContent = "Pick an employee first."; return; }

      const toDateOrNull   = (s) => (s && s.length ? s : null);
      const toNumberOrNull = (s) => (s && s.length ? Number(s) : null);
      const toNumber0      = (s) => (s && s.length ? Number(s) : 0);

      const qualifying_events = {
        new_hire: getCB("qe_new_hire"),
        new_hire_date: toDateOrNull(val("qe_new_hire_date")),
        emp_gain_loss: getCB("qe_emp_gain_loss"),
        emp_gain_loss_date: toDateOrNull(val("qe_emp_gain_loss_date")),
        birth_or_adoption: getCB("qe_birth"),
        birth_or_adoption_date: toDateOrNull(val("qe_birth_date")),
        marriage: getCB("qe_marriage"),
        marriage_date: toDateOrNull(val("qe_marriage_date")),
        dependent_gain_loss: getCB("qe_dep_gain_loss"),
        dependent_gain_loss_date: toDateOrNull(val("qe_dep_gain_loss_date")),
        court_order: getCB("qe_court"),
        demo_change: getCB("qe_demo_change"),
        rehire: getCB("qe_rehire"),
        rehire_date: toDateOrNull(val("qe_rehire_date")),
      };

      const oe_changes = {
        add_cov: getCB("oe_add_cov"),
        drop_cov: getCB("oe_drop_cov"),
        change_med: getCB("oe_change_med"),
        change_den: getCB("oe_change_den"),
        change_vis: getCB("oe_change_vis"),
        update_vol: getCB("oe_update_vol"),
        add_dep: getCB("oe_add_dep"),
        demo_change: getCB("oe_demo"),
      };

      const address = {
        street: val("addr_street") || null,
        city:   val("addr_city")   || null,
        state:  val("addr_state")  || null,
        zip:    val("addr_zip")    || null,
      };

      const spouse = (tierSel.value === "ES" || tierSel.value === "EF")
        ? {
            first:  val("sp_first")  || null,
            last:   val("sp_last")   || null,
            dob:    toDateOrNull(val("sp_dob")),
            ssn:    val("sp_ssn")    || null,
            gender: val("sp_gender") || null,
          }
        : null;

      const dependents = (tierSel.value === "EC" || tierSel.value === "EF")
        ? Array.from(document.querySelectorAll("#kidsWrap > div"))
            .map(row => ({
              first:  row.querySelector(".kid_first").value.trim()  || null,
              last:   row.querySelector(".kid_last").value.trim()   || null,
              dob:    toDateOrNull(row.querySelector(".kid_dob").value.trim()),
              ssn:    row.querySelector(".kid_ssn").value.trim()    || null,
              gender: row.querySelector(".kid_gender").value        || null,
            }))
            .filter(k => k.first || k.last)
        : [];

      const beneficiaries = Number(vlInput.value || 0) > 0
        ? Array.from(document.querySelectorAll("#beneficiariesWrap > div"))
            .map(row => ({
              name:         row.querySelector(".bene_name").value.trim() || null,
              relationship: row.querySelector(".bene_rel").value.trim()  || null,
              pct:          toNumberOrNull(row.querySelector(".bene_pct").value),
              ssn:          row.querySelector(".bene_ssn").value.trim()  || null,
              dob:          toDateOrNull(row.querySelector(".bene_dob").value),
            }))
            .filter(b => b.name)
        : [];

      const payload = {
        employee_id: Number(EMP.id),
        tier_election: tierSel.value || null,
        medical_plan:  medPlan.value || null,
        dental_plan:   denPlan.value || null,
        vision_plan:   visPlan.value || null,
        qualifying_events,
        oe_changes,
        ssn:        val("ssn") || null,
        dob:        toDateOrNull(val("dob")),
        gender:     val("gender") || null,
        marital_status: val("marital_status") || null, // SAVE new field
        address,
        phone:      val("phone") || null,
        email:      val("email") || null,
        job_title:  val("job_title") || null,
        hire_date:  toDateOrNull(val("hire_date")),
        annual_salary: toNumberOrNull(val("annual_salary")),
        spouse,
        dependents,
        hsa_amount:   toNumber0(val("hsa_amount")),
        vol_life_amount: toNumber0(val("vol_life_amount")),
        beneficiaries,
      };

      // Primary UPSERT (requires UNIQUE(employee_id))
      let { error } = await sb
        .from("benefit_enrollments")
        .upsert(payload, { onConflict: "employee_id" });

      // Fallback path: update→insert
      if (error && /no unique|ON CONFLICT/i.test(error.message)) {
        const { data: existing } = await sb
          .from("benefit_enrollments")
          .select("employee_id")
          .eq("employee_id", payload.employee_id)
          .maybeSingle();

        if (existing) {
          ({ error } = await sb
            .from("benefit_enrollments")
            .update(payload)
            .eq("employee_id", payload.employee_id));
        } else {
          ({ error } = await sb.from("benefit_enrollments").insert(payload));
        }
      }

      msg.textContent = error ? `Save failed: ${error.message}` : "Saved ✔";
      setTimeout(() => (msg.textContent = ""), 1500);
    }

    async function fetchEmployeeUuid(empId) {
      const { data, error } = await sb
        .from('hr_employees')     // table/view that has uuid
        .select('uuid')
        .eq('id', empId)
        .maybeSingle();

      if (error) { console.error('uuid lookup failed:', error.message); }
      return data?.uuid || null;
    } /* fixed: had been missing in one version */

    // PDF (GET with explicit error text)
    async function handlePDF() {
      if (!EMP) { msg.textContent = "Pick an employee first."; return; }

      // Ensure saved enrollment exists
      const check = await sb
        .from("benefit_enrollments")
        .select("employee_id")
        .eq("employee_id", Number(EMP.id))
        .maybeSingle();

      if (!check.data) {
        msg.textContent = "Save the enrollment first, then try PDF.";
        return;
      }

      msg.textContent = "Generating PDF…";
      const url = `${FN_URL}?employee_id=${encodeURIComponent(EMP.id)}`;
const res = await fetch(url, {
  method: "GET",
  headers: {
    Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
    apikey: SUPABASE_ANON_KEY,
    Accept: "application/pdf"
  }
});

      const ct = res.headers.get("content-type") || "";
    if (!res.ok) {
  const details = await res.text(); // Always get raw text first
  console.error("Full response:", { status: res.status, headers: Object.fromEntries(res.headers), body: details });
  msg.textContent = `PDF error ${res.status}: ${details || 'No details provided'}`;
  return;
}

      const blob = await res.blob();
      const objUrl = URL.createObjectURL(blob);
      window.open(objUrl, "_blank", "noopener");
      msg.textContent = "";
    }

    // Events
    [tierSel, medPlan, denPlan, visPlan, hsaInput, vlInput, document.getElementById("marital_status")].forEach(el=>el.addEventListener("input", updatePrices));
    document.getElementById("btnSave").addEventListener("click", handleSave);
    document.getElementById("btnSave2").addEventListener("click", handleSave);
    document.getElementById("btnPDF").addEventListener("click", handlePDF);
    document.getElementById("btnPDF2").addEventListener("click", handlePDF);

    // Boot
    (async ()=>{ await loadRates(); updatePrices(); })();
  </script>
</body>
</html>
