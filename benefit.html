<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FAF9F6]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Benefits Platform</title>

  <!-- Tailwind + Fonts -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />

  <!-- Supabase (UMD for window.supabase) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root { --jc-gold:#C0A06D; --jc-ink:#0F172A; }
    body { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji", "Segoe UI Symbol"; }
    .headline { font-family: "Playfair Display", serif; }
    .card { @apply rounded-2xl bg-white shadow-xl ring-1 ring-slate-100 p-6 md:p-8; }
    .sec-title { @apply headline font-bold text-2xl text-slate-900 mb-6; }
    .sub-title { @apply font-semibold text-slate-800 mt-5 mb-2; }
    .lbl { @apply text-xs font-semibold tracking-wide text-slate-600 uppercase; }
    .inp { @apply mt-1 w-full rounded-lg border border-slate-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--jc-gold)] focus:border-[var(--jc-gold)]; }
    .ghost { @apply text-slate-400 italic; }
    .btn { @apply inline-flex items-center justify-center rounded-lg px-4 py-2 font-semibold transition; }
    .btn-gold { @apply bg-[var(--jc-gold)] text-white hover:brightness-110 disabled:opacity-40 disabled:cursor-not-allowed; }
    .btn-ink  { @apply bg-slate-900 text-white hover:bg-slate-800 disabled:opacity-40 disabled:cursor-not-allowed; }
    .btn-outline { @apply border border-slate-300 text-slate-800 hover:bg-slate-50; }
    .divider { @apply h-px bg-slate-200 my-4; }
    .pill { @apply inline-flex items-center rounded-full border px-3 py-1 text-xs font-semibold; }
    /* Sticky summary on large screens */
    @media (min-width: 1024px) {
      .summary-sticky { position: sticky; top: 96px; }
    }
  </style>
</head>
<body class="h-full">
  <!-- Top Bar -->
  <header class="bg-white/80 backdrop-blur sticky top-0 z-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8">
      <div class="h-16 flex items-center justify-between">
        <div class="flex items-center gap-3">
          <div class="w-9 h-9 rounded-xl bg-[var(--jc-gold)]/15 text-[var(--jc-gold)] flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7h18M5 7v10a2 2 0 002 2h10a2 2 0 002-2V7M7 7V5a2 2 0 012-2h6a2 2 0 012 2v2"/></svg>
          </div>
          <div>
            <div class="headline text-xl leading-5 text-slate-900">Executive Benefits Platform</div>
            <div class="text-xs text-slate-500 -mt-0.5">Jeng Chi Restaurant &amp; Bakery</div>
          </div>
        </div>
        <div class="text-xs text-slate-500">Status: <span id="health" class="font-semibold">Connecting…</span></div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <main class="bg-gradient-to-br from-[#e8dfcf] via-[#f3eee5] to-[#f9f7f3] min-h-screen py-10">
    <div class="max-w-7xl mx-auto px-4 md:px-6 lg:px-8">
      <div class="grid lg:grid-cols-3 gap-8">

        <!-- LEFT: form flow -->
        <div class="lg:col-span-2 space-y-8">

          <!-- 1. Employee Context + Tier -->
          <section id="sec-context" class="card">
            <h2 class="sec-title">1. Employee Context & Coverage Tier</h2>

            <div class="grid md:grid-cols-3 gap-4 items-end">
              <div class="md:col-span-2">
                <label class="lbl">Employee</label>
                <div class="relative">
                  <input id="empSearch" class="inp" placeholder="Type name or username…" />
                  <div id="empList" class="absolute z-20 left-0 right-0 bg-white border border-slate-200 rounded-lg shadow-xl mt-1 hidden max-h-64 overflow-auto"></div>
                </div>
                <p id="empInfo" class="mt-2 text-sm text-slate-600"></p>
              </div>

              <div>
                <label class="lbl">Coverage Tier</label>
                <select id="tier" class="inp">
                  <option value="">— Select Tier —</option>
                  <option value="EO">Employee Only</option>
                  <option value="ES">Employee + Spouse/Partner</option>
                  <option value="EC">Employee + Child(ren)</option>
                  <option value="EF">Employee + Family</option>
                </select>
              </div>
            </div>
          </section>

          <!-- 2. Reason / Events -->
          <section class="card">
            <h2 class="sec-title">2. Reason for Submitting</h2>

            <div class="grid md:grid-cols-2 gap-6">
              <!-- QLE -->
              <div class="rounded-xl border border-amber-200/70 bg-amber-50 p-5">
                <div class="headline text-lg text-amber-900 mb-2">Qualifying Life Event</div>
                <p class="text-xs text-amber-800 mb-4">Requests must be submitted within 30 days of the qualifying event.</p>

                <div class="space-y-3">
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_new_hire" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> New Employee / New Hire</label>
                    <input id="qe_new_hire_date" type="date" class="inp" placeholder="Date">
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_emp_gain_loss" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Employee: Gain/Loss of Coverage</label>
                    <input id="qe_emp_gain_loss_date" type="date" class="inp" placeholder="Date">
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_birth" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Birth or Adoption of Child</label>
                    <input id="qe_birth_date" type="date" class="inp" placeholder="Date">
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_marriage" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Marriage</label>
                    <input id="qe_marriage_date" type="date" class="inp" placeholder="Date">
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_dep_gain_loss" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Dependent: Gain/Loss of Coverage</label>
                    <input id="qe_dep_gain_loss_date" type="date" class="inp" placeholder="Date">
                  </div>
                  <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_court" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Court Order</label>
                  <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_demo_change" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Demographic Change</label>
                  <label class="flex items-center gap-2 text-sm text-slate-800"><input id="qe_rehire" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Rehire / Re-Enrollment</label>
                  <input id="qe_rehire_date" type="date" class="inp" placeholder="Date">
                </div>
              </div>

              <!-- OE -->
              <div class="rounded-xl border p-5 bg-white">
                <div class="headline text-lg text-slate-900 mb-2">Open Enrollment Changes</div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm"><input id="oe_add_cov"   type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Add Coverage</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_drop_cov"  type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Drop Coverage</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_change_med" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Change Medical Plan</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_change_den" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Change Dental Plan</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_change_vis" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Change Vision Plan</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_update_vol" type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Update Vol Life Amount</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_add_dep"   type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Add Dependent(s)</label>
                  <label class="flex items-center gap-2 text-sm"><input id="oe_demo"     type="checkbox" class="rounded text-[var(--jc-gold)] focus:ring-[var(--jc-gold)]"> Demographic Update</label>
                </div>
              </div>
            </div>
          </section>

          <!-- 3. Employee Information -->
          <section class="card">
            <h2 class="sec-title">3. Employee Information</h2>

            <div class="grid md:grid-cols-4 gap-4">
              <div><label class="lbl">SSN</label><input id="ssn" class="inp" placeholder="xxx-xx-xxxx"></div>
              <div><label class="lbl">Date of Birth</label><input id="dob" type="date" class="inp"></div>
              <div><label class="lbl">Gender</label>
                <select id="gender" class="inp">
                  <option value="">— Select —</option><option>M</option><option>F</option><option>X</option>
                </select>
              </div>
              <div><label class="lbl">Date of Hire (Required)</label><input id="hire_date" type="date" class="inp"></div>
            </div>

            <div class="grid md:grid-cols-4 gap-4 mt-4">
              <div class="md:col-span-2"><label class="lbl">Address (Street, Apt/Bldg #)</label><input id="addr_street" class="inp"></div>
              <div><label class="lbl">City</label><input id="addr_city" class="inp"></div>
              <div><label class="lbl">State</label><input id="addr_state" class="inp"></div>
            </div>

            <div class="grid md:grid-cols-4 gap-4 mt-4">
              <div><label class="lbl">Zip</label><input id="addr_zip" class="inp"></div>
              <div><label class="lbl">Phone</label><input id="phone" class="inp"></div>
              <div><label class="lbl">Email</label><input id="email" class="inp"></div>
              <div><label class="lbl">Job Title</label><input id="job_title" class="inp"></div>
            </div>

            <div class="grid md:grid-cols-4 gap-4 mt-4">
              <div><label class="lbl">Annual Salary</label><input id="annual_salary" type="number" step="0.01" class="inp" placeholder="0.00"></div>
              <div class="md:col-span-3"></div>
            </div>
          </section>

          <!-- 4. Dependents -->
          <section class="card">
            <h2 class="sec-title">4. Dependents</h2>

            <!-- Spouse -->
            <div id="spouseBlock" class="hidden rounded-xl border border-slate-200 bg-slate-50 p-4 mb-6">
              <div class="headline text-lg text-slate-900 mb-3">Spouse / Domestic Partner</div>
              <div class="grid md:grid-cols-5 gap-4">
                <div><label class="lbl">First</label><input id="sp_first" class="inp"></div>
                <div><label class="lbl">Last</label><input id="sp_last" class="inp"></div>
                <div><label class="lbl">DOB</label><input id="sp_dob" type="date" class="inp"></div>
                <div><label class="lbl">SSN</label><input id="sp_ssn" class="inp"></div>
                <div><label class="lbl">Gender</label>
                  <select id="sp_gender" class="inp"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
                </select></div>
              </div>
            </div>

            <!-- Children -->
            <div id="childrenBlock" class="hidden">
              <div class="headline text-lg text-slate-900 mb-2">Dependent Children</div>
              <div id="kidsWrap" class="space-y-4"></div>
              <button id="addKid" type="button" class="btn btn-outline mt-3">+ Add Dependent Child</button>
            </div>
          </section>

          <!-- 5. Plans -->
          <section class="card">
            <h2 class="sec-title">5. Plans & Contribution</h2>

            <div class="grid md:grid-cols-4 gap-6">
              <!-- Medical -->
              <div class="rounded-xl border p-4 bg-white">
                <div class="font-semibold text-slate-900 mb-2">Medical</div>
                <select id="medPlan" class="inp">
                  <option value="">— Select Plan —</option>
                  <option value="HMO_HSA">HMO / ATBAP393 HSA</option>
                  <option value="HMO">HMO / ATBAB303</option>
                  <option value="PPO">PPO / ATBCB402</option>
                  <option value="WAIVE">Waive Coverage</option>
                </select>
                <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="medPPP" class="font-bold text-slate-900">$0.00</span></div>
                <div class="text-xs text-slate-600">Annual: <span id="medAnnual" class="font-bold text-slate-900">$0.00</span></div>
              </div>

              <!-- Dental -->
              <div class="rounded-xl border p-4 bg-white">
                <div class="font-semibold text-slate-900 mb-2">Dental</div>
                <select id="denPlan" class="inp">
                  <option value="">— Select Plan —</option>
                  <option value="F_PLAN_2W">F-PLAN 2W / Base MAC</option>
                  <option value="F_PLAN_3W">F-PLAN 3W / Buy Up MAC</option>
                  <option value="WAIVE">Waive Coverage</option>
                </select>
                <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="denPPP" class="font-bold text-slate-900">$0.00</span></div>
                <div class="text-xs text-slate-600">Annual: <span id="denAnnual" class="font-bold text-slate-900">$0.00</span></div>
              </div>

              <!-- Vision -->
              <div class="rounded-xl border p-4 bg-white">
                <div class="font-semibold text-slate-900 mb-2">Vision</div>
                <select id="visPlan" class="inp">
                  <option value="">— Select Plan —</option>
                  <option value="PLAN_1">UC ClearVision Plan 1</option>
                  <option value="WAIVE">Waive Coverage</option>
                </select>
                <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="visPPP" class="font-bold text-slate-900">$0.00</span></div>
                <div class="text-xs text-slate-600">Annual: <span id="visAnnual" class="font-bold text-slate-900">$0.00</span></div>
              </div>

              <!-- HSA -->
              <div class="rounded-xl border p-4 bg-white">
                <div class="font-semibold text-slate-900 mb-2">HSA Contribution</div>
                <label class="lbl">Per Paycheck</label>
                <input id="hsa_amount" type="number" step="0.01" class="inp" placeholder="0.00" />
                <p class="text-xs text-slate-500 mt-2">Optional pre-tax contribution (Section 6 of your PDF).</p>
              </div>
            </div>
          </section>

          <!-- Response / messages -->
          <p id="msg" class="text-sm text-slate-600"></p>
        </div>

        <!-- RIGHT: live summary -->
        <aside class="summary-sticky">
          <div class="card">
            <div class="headline text-lg mb-1">Summary</div>
            <p class="text-sm text-slate-500 mb-4">Review at a glance. Buttons enable after you pick an employee and selections.</p>

            <div class="space-y-3">
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Medical</span>
                <span id="sum_med" class="font-semibold text-slate-900">—</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Dental</span>
                <span id="sum_den" class="font-semibold text-slate-900">—</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Vision</span>
                <span id="sum_vis" class="font-semibold text-slate-900">—</span>
              </div>
              <div class="flex justify-between text-sm">
                <span class="text-slate-600">Tier</span>
                <span id="sum_tier" class="font-semibold text-slate-900">—</span>
              </div>

              <div class="divider"></div>

              <div class="flex justify-between items-center">
                <span class="text-sm text-slate-600">Per Pay Total</span>
                <span id="totalPPP" class="headline text-xl text-[var(--jc-gold)]">$0.00</span>
              </div>
              <div class="text-right text-xs text-slate-500">Annual (26): <span id="totalAnnual" class="font-semibold text-slate-700">$0.00</span></div>

              <div class="grid grid-cols-2 gap-3 mt-4">
                <button id="btnSave" class="btn btn-gold" disabled>Save</button>
                <button id="btnPDF"  class="btn btn-ink"  disabled>PDF</button>
              </div>
            </div>
          </div>
        </aside>

      </div>
    </div>
  </main>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/enrollment_pdf";
    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= HEALTH PING ========= */
    (async () => {
      const health = document.getElementById("health");
      try {
        const r = await fetch(`${SUPABASE_URL}/rest/v1/benefit_rates?select=coverage&limit=1`, {
          headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` }
        });
        health.textContent = r.ok ? "DB Connected" : `REST ${r.status}`;
      } catch { health.textContent = "Browser blocked fetch"; }
    })();

    /* ========= RATES ========= */
    let RATES = {};
    async function loadRates() {
      const { data, error } = await sb.from("benefit_rates").select("coverage,plan_code,tier,amount,per_year_periods");
      if (error) { console.error(error); return; }
      RATES = {};
      for (const r of data) {
        RATES[r.coverage] ??= {};
        RATES[r.coverage][r.plan_code] ??= {};
        RATES[r.coverage][r.plan_code][r.tier] = { amt: Number(r.amount), ppp: r.per_year_periods || 26 };
      }
    }

    /* ========= STATE & REFS ========= */
    let EMP = null;
    const tierSel = document.getElementById("tier");
    const medPlan = document.getElementById("medPlan");
    const denPlan = document.getElementById("denPlan");
    const visPlan = document.getElementById("visPlan");
    const medPPP = document.getElementById("medPPP");
    const medAnnual = document.getElementById("medAnnual");
    const denPPP = document.getElementById("denPPP");
    const denAnnual = document.getElementById("denAnnual");
    const visPPP = document.getElementById("visPPP");
    const visAnnual = document.getElementById("visAnnual");
    const sumMed = document.getElementById("sum_med");
    const sumDen = document.getElementById("sum_den");
    const sumVis = document.getElementById("sum_vis");
    const sumTier = document.getElementById("sum_tier");
    const totalPPP = document.getElementById("totalPPP");
    const totalAnnual = document.getElementById("totalAnnual");
    const btnSave = document.getElementById("btnSave");
    const btnPDF = document.getElementById("btnPDF");
    const msg = document.getElementById("msg");

    /* ========= HELPERS ========= */
    const fmt = n => `$${Number(n).toFixed(2)}`;
    function getRate(coverage, plan, tier) {
      if (!plan || plan === "WAIVE") return { amt: 0, ppp: 26 };
      return RATES?.[coverage]?.[plan]?.[tier] ?? { amt: 0, ppp: 26 };
    }
    function enableActionsIfReady() {
      const ok = !!(EMP && tierSel.value && (medPlan.value || denPlan.value || visPlan.value));
      btnSave.disabled = !ok;
      btnPDF.disabled  = !ok;
    }
    function updateBlocksByTier() {
      document.getElementById("spouseBlock").classList.toggle("hidden", !(tierSel.value === "ES" || tierSel.value === "EF"));
      document.getElementById("childrenBlock").classList.toggle("hidden", !(tierSel.value === "EC" || tierSel.value === "EF"));
    }

    function updatePrices() {
      const t = tierSel.value || "";
      const mr = getRate("MEDICAL", medPlan.value, t);
      const dr = getRate("DENTAL",  denPlan.value, t);
      const vr = getRate("VISION",  visPlan.value, t);

      medPPP.textContent   = fmt(mr.amt);  medAnnual.textContent = fmt(mr.amt * mr.ppp);
      denPPP.textContent   = fmt(dr.amt);  denAnnual.textContent = fmt(dr.amt * dr.ppp);
      visPPP.textContent   = fmt(vr.amt);  visAnnual.textContent = fmt(vr.amt * vr.ppp);

      sumMed.textContent = medPlan.value ? mapPlanLabel("MEDICAL", medPlan.value) : "—";
      sumDen.textContent = denPlan.value ? mapPlanLabel("DENTAL",  denPlan.value) : "—";
      sumVis.textContent = visPlan.value ? mapPlanLabel("VISION",  visPlan.value) : "—";
      sumTier.textContent = tierSel.value ? mapTier(tierSel.value) : "—";

      const total = mr.amt + dr.amt + vr.amt;
      totalPPP.textContent   = fmt(total);
      totalAnnual.textContent = fmt(total * 26);

      updateBlocksByTier();
      enableActionsIfReady();
    }
    function mapTier(t) {
      return {EO:"Employee Only", ES:"Employee + Spouse/Partner", EC:"Employee + Child(ren)", EF:"Employee + Family"}[t] || "—";
    }
    function mapPlanLabel(c, code) {
      const MAP = {
        MEDICAL: { HMO_HSA:"HMO / ATBAP393 HSA", HMO:"HMO / ATBAB303", PPO:"PPO / ATBCB402", WAIVE:"Waive" },
        DENTAL:  { F_PLAN_2W:"F-PLAN 2W / Base MAC", F_PLAN_3W:"F-PLAN 3W / Buy Up MAC", WAIVE:"Waive" },
        VISION:  { PLAN_1:"UC ClearVision Plan 1", WAIVE:"Waive" }
      };
      return MAP[c]?.[code] || "—";
    }

    /* ========= EMPLOYEE SEARCH ========= */
    const empSearch = document.getElementById("empSearch");
    const empList = document.getElementById("empList");
    const empInfo = document.getElementById("empInfo");
    let timer = null;

    function clearAllForNewEmployee() {
      // reset selections to blank placeholders
      tierSel.value = ""; medPlan.value = ""; denPlan.value = ""; visPlan.value = "";
      ['ssn','dob','gender','hire_date','addr_street','addr_city','addr_state','addr_zip','phone','email','job_title','annual_salary','hsa_amount']
        .forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });
      // dependents
      document.getElementById("spouseBlock").classList.add("hidden");
      document.getElementById("childrenBlock").classList.add("hidden");
      document.getElementById("kidsWrap").innerHTML = "";
      // summary
      sumMed.textContent = "—"; sumDen.textContent="—"; sumVis.textContent="—"; sumTier.textContent="—";
      totalPPP.textContent = "$0.00"; totalAnnual.textContent="$0.00";
      btnSave.disabled = true; btnPDF.disabled = true;
    }

    empSearch.addEventListener("input", () => {
      clearTimeout(timer);
      timer = setTimeout(async () => {
        const q = empSearch.value.trim();
        empList.innerHTML = ""; empList.classList.add("hidden");
        if (!q) return;
        const { data, error } = await sb
          .from("employees")
          .select("id, full_name, employee_position, email, username, hire_date, annual_salary, phone")
          .or(`full_name.ilike.%${q}%,username.ilike.%${q}%`)
          .order("full_name").limit(20);
        if (error || !data?.length) return;
        empList.classList.remove("hidden");
        data.forEach(e => {
          const div = document.createElement("div");
          div.className = "px-3 py-2 hover:bg-amber-50 cursor-pointer text-sm";
          div.textContent = `${e.full_name} — ${e.employee_position}`;
          div.onclick = () => selectEmployee(e);
          empList.appendChild(div);
        });
      }, 220);
    });

    async function selectEmployee(e) {
      EMP = e;
      empList.classList.add("hidden");
      empSearch.value = e.full_name;
      empInfo.textContent = `Title: ${e.employee_position} • Email: ${e.email ?? "—"} • Hired: ${e.hire_date ?? "—"}`;

      // Reset UI to blank defaults, then preload any saved enrollment
      clearAllForNewEmployee();
      await preloadEnrollment();
      updatePrices();
    }

    /* ========= DEPENDENTS UI ========= */
    const kidsWrap = document.getElementById("kidsWrap");
    document.getElementById("addKid").addEventListener("click", () => addKidRow());

    function addKidRow(row=null) {
      const div = document.createElement("div");
      div.className = "grid md:grid-cols-6 gap-4 items-end p-4 border border-slate-200 rounded-xl bg-slate-50";
      div.innerHTML = `
        <div><label class="lbl">First</label><input class="inp kid_first"></div>
        <div><label class="lbl">Last</label><input class="inp kid_last"></div>
        <div><label class="lbl">DOB</label><input type="date" class="inp kid_dob"></div>
        <div><label class="lbl">SSN</label><input class="inp kid_ssn"></div>
        <div><label class="lbl">Gender</label>
          <select class="inp kid_gender"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
        <div><button type="button" class="btn btn-outline w-full removeKid">Remove</button></div>`;
      kidsWrap.appendChild(div);
      if (row) {
        div.querySelector(".kid_first").value = row.first || "";
        div.querySelector(".kid_last").value  = row.last  || "";
        div.querySelector(".kid_dob").value   = row.dob   || "";
        div.querySelector(".kid_ssn").value   = row.ssn   || "";
        div.querySelector(".kid_gender").value= row.gender|| "";
      }
      div.querySelector(".removeKid").onclick = () => div.remove();
    }

    /* ========= PRELOAD & SAVE ========= */
    function setVal(id, v) { const el = document.getElementById(id); if (el) el.value = (v ?? ""); }
    function setCB(id, v)  { const el = document.getElementById(id); if (el) el.checked = !!v; }
    function val(id)       { const el = document.getElementById(id); return el ? el.value.trim() : ""; }
    function getCB(id)     { const el = document.getElementById(id); return el ? !!el.checked : false; }

    async function preloadEnrollment() {
      if (!EMP) return;
      // seed from employee base data
      setVal("email",  EMP.email  ?? "");
      setVal("phone",  EMP.phone  ?? "");
      setVal("hire_date", EMP.hire_date ?? "");
      setVal("annual_salary", EMP.annual_salary ?? "");

      const { data } = await sb.from("benefit_enrollments").select("*").eq("employee_id", EMP.id).maybeSingle();
      if (!data) return;

      // tier & plans (may be empty, keep placeholders if null)
      if (data.tier_election) tierSel.value = data.tier_election;
      if (data.medical_plan)  medPlan.value = data.medical_plan;
      if (data.dental_plan)   denPlan.value = data.dental_plan;
      if (data.vision_plan)   visPlan.value = data.vision_plan;

      // QLE
      const q = data.qualifying_events || {};
      setCB("qe_new_hire", q.new_hire); setVal("qe_new_hire_date", q.new_hire_date);
      setCB("qe_emp_gain_loss", q.emp_gain_loss); setVal("qe_emp_gain_loss_date", q.emp_gain_loss_date);
      setCB("qe_birth", q.birth_or_adoption); setVal("qe_birth_date", q.birth_or_adoption_date);
      setCB("qe_marriage", q.marriage); setVal("qe_marriage_date", q.marriage_date);
      setCB("qe_dep_gain_loss", q.dependent_gain_loss); setVal("qe_dep_gain_loss_date", q.dependent_gain_loss_date);
      setCB("qe_court", q.court_order);
      setCB("qe_demo_change", q.demo_change);
      setCB("qe_rehire", q.rehire); setVal("qe_rehire_date", q.rehire_date);

      // OE
      const oe = data.oe_changes || {};
      setCB("oe_add_cov", oe.add_cov); setCB("oe_drop_cov", oe.drop_cov);
      setCB("oe_change_med", oe.change_med); setCB("oe_change_den", oe.change_den);
      setCB("oe_change_vis", oe.change_vis); setCB("oe_update_vol", oe.update_vol);
      setCB("oe_add_dep", oe.add_dep); setCB("oe_demo", oe.demo_change);

      // employee
      setVal("ssn", data.ssn); setVal("dob", data.dob); setVal("gender", data.gender);
      const a = data.address || {};
      setVal("addr_street", a.street); setVal("addr_city", a.city);
      setVal("addr_state", a.state);   setVal("addr_zip", a.zip);
      setVal("job_title", data.job_title); setVal("hsa_amount", data.hsa_amount);

      // spouse/children
      if (data.spouse) {
        setVal("sp_first", data.spouse.first);
        setVal("sp_last",  data.spouse.last);
        setVal("sp_dob",   data.spouse.dob);
        setVal("sp_ssn",   data.spouse.ssn);
        setVal("sp_gender",data.spouse.gender);
      }
      document.getElementById("kidsWrap").innerHTML = "";
      (data.dependents || []).forEach(d => addKidRow(d));
    }

    document.getElementById("btnSave").addEventListener("click", async () => {
      if (!EMP) { msg.textContent = "Pick an employee first."; return; }

      const qualifying_events = {
        new_hire: getCB("qe_new_hire"), new_hire_date: val("qe_new_hire_date"),
        emp_gain_loss: getCB("qe_emp_gain_loss"), emp_gain_loss_date: val("qe_emp_gain_loss_date"),
        birth_or_adoption: getCB("qe_birth"), birth_or_adoption_date: val("qe_birth_date"),
        marriage: getCB("qe_marriage"), marriage_date: val("qe_marriage_date"),
        dependent_gain_loss: getCB("qe_dep_gain_loss"), dependent_gain_loss_date: val("qe_dep_gain_loss_date"),
        court_order: getCB("qe_court"),
        demo_change: getCB("qe_demo_change"),
        rehire: getCB("qe_rehire"), rehire_date: val("qe_rehire_date")
      };
      const oe_changes = {
        add_cov: getCB("oe_add_cov"), drop_cov: getCB("oe_drop_cov"),
        change_med: getCB("oe_change_med"), change_den: getCB("oe_change_den"),
        change_vis: getCB("oe_change_vis"), update_vol: getCB("oe_update_vol"),
        add_dep: getCB("oe_add_dep"), demo_change: getCB("oe_demo")
      };
      const address = { street: val("addr_street"), city: val("addr_city"), state: val("addr_state"), zip: val("addr_zip") };
      const spouse  = (tierSel.value==="ES"||tierSel.value==="EF") ? {
        first: val("sp_first"), last: val("sp_last"), dob: val("sp_dob"), ssn: val("sp_ssn"), gender: val("sp_gender")
      } : null;
      const dependents = (tierSel.value==="EC"||tierSel.value==="EF") ?
        Array.from(document.querySelectorAll("#kidsWrap > div")).map(row => ({
          first: row.querySelector(".kid_first").value.trim(),
          last:  row.querySelector(".kid_last").value.trim(),
          dob:   row.querySelector(".kid_dob").value.trim(),
          ssn:   row.querySelector(".kid_ssn").value.trim(),
          gender:row.querySelector(".kid_gender").value
        })).filter(k => k.first || k.last) : [];

      const payload = {
        employee_id: EMP.id,
        tier_election: tierSel.value || null,
        medical_plan:  medPlan.value  || null,
        dental_plan:   denPlan.value  || null,
        vision_plan:   visPlan.value  || null,
        qualifying_events, oe_changes,
        ssn: val("ssn"), dob: val("dob"), gender: val("gender"),
        address, phone: val("phone"), email: val("email"),
        job_title: val("job_title"), hire_date: val("hire_date"),
        annual_salary: val("annual_salary") ? Number(val("annual_salary")) : null,
        spouse, dependents,
        hsa_amount: val("hsa_amount") ? Number(val("hsa_amount")) : null
      };

      const { error } = await sb.from("benefit_enrollments").upsert(payload, { onConflict: "employee_id" });
      msg.textContent = error ? `Save failed: ${error.message}` : "Saved ✔";
      setTimeout(() => msg.textContent = "", 1600);
    });

    document.getElementById("btnPDF").addEventListener("click", async () => {
      if (!EMP) { msg.textContent = "Pick an employee first."; return; }
      msg.textContent = "Generating PDF…";
      try {
        const res = await fetch(`${FN_URL}?employee_id=${encodeURIComponent(EMP.id)}`);
        if (!res.ok) throw new Error(`PDF error ${res.status}`);
        const blob = await res.blob();
        const href = URL.createObjectURL(blob);
        window.open(href, "_blank", "noopener");
        msg.textContent = "";
      } catch (e) {
        msg.textContent = e.message;
      }
    });

    /* ========= EVENTS ========= */
    [tierSel, medPlan, denPlan, visPlan].forEach(el => el.addEventListener("change", updatePrices));

    // Boot
    (async () => { await loadRates(); updatePrices(); })();
  </script>
</body>
</html>
