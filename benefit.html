<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
<meta http-equiv="Pragma" content="no-cache">
<meta http-equiv="Expires" content="0">
  
  <title>Jeng Chi — Executive Benefits (Corporate Tech)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans:['Inter','system-ui','-apple-system','Segoe UI','Roboto','Arial','sans-serif'],
            'serif-head':['Playfair Display','serif']
          },
          colors: { jcgold:'#B9965A', jcgold2:'#C0A06D', ink:'#0F172A', tech:'#0EA5E9' },
          boxShadow: { soft:'0 10px 30px rgba(2,6,23,.06)' }
        }
      }
    };
  </script>
  <style>
    body {
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(185,150,90,.10), transparent 60%),
        radial-gradient(1000px 700px at -20% 20%, rgba(14,165,233,.08), transparent 55%),
        #F8FAFC;
    }
    .soft-card{ background:#fff; border:1px solid #E5E7EB; border-radius:16px; box-shadow:0 10px 36px rgba(15,23,42,.06); overflow:visible; }
    .section-cap{ height:3px; background:linear-gradient(90deg,#C0A06D 0%, #B9965A 55%, rgba(11,22,45,0.0) 100%); border-radius:6px 6px 0 0; }
    .lbl{ font-size:11px; letter-spacing:.14em; text-transform:uppercase; font-weight:700; color:#64748B; }
    .inp{ margin-top:.25rem; width:100%; border:1px solid #CBD5E1; border-radius:12px; padding:.6rem .8rem; font-size:.92rem; background:#fff; }
    .inp:focus{ outline:none; border-color:#0EA5E9; box-shadow:0 0 0 3px rgba(14,165,233,.15); }
    .select-chevron{
      appearance:none;
      background:no-repeat right .7rem center/16px url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%230EA5E9' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E");
      padding-right:2rem;
    }
    .step-dot{ width:30px; height:30px; border-radius:9999px; display:grid; place-items:center; font-size:12px; font-weight:700; }
    .gold-chip{ display:inline-flex; align-items:center; gap:.5rem; padding:.35rem .6rem; border-radius:9999px; font-size:11px; font-weight:700; letter-spacing:.12em; text-transform:uppercase; color:#3f3a2f; background:linear-gradient(135deg,#F3E5C0 0%, #C0A06D 35%, #B9965A 65%, #E7D3A2 100%); box-shadow:inset 0 1px 0 rgba(255,255,255,.4); }
    .enterprise-rail{ background:linear-gradient(180deg, rgba(192,160,109,.28) 0%, rgba(185,150,90,.16) 40%, transparent 100%); border:1px solid rgba(185,150,90,.28); }
    .summary-kpi{ display:flex; align-items:baseline; justify-content:space-between; padding:.6rem .75rem; border:1px dashed #E2E8F0; border-radius:12px; background:#fff; }
    .summary-badge{ font-size:11px; font-weight:700; color:#475569; letter-spacing:.12em; text-transform:uppercase; }
    @media print {
      @page { margin: 15mm 12mm 22mm; }
      .pdf-footer{
        position: fixed; left: 12mm; right: 12mm; bottom: 8mm;
        display: grid; grid-template-columns: 1fr 140px 1fr; gap: 8px; align-items: center;
        font-size: 11px; color: #64748B;
        border-top: 1px solid #CBD5E1; padding-top: 6px; white-space: nowrap;
      }
      .pdf-footer .right{ text-align: right; }
      .pdf-footer .left, .pdf-footer .right{ overflow: hidden; text-overflow: ellipsis; }
    }
    @media screen { .pdf-footer { display: none; } }
  </style>
</head>
<body class="h-full">
  <!-- Header -->
  <header class="bg-white/90 backdrop-blur sticky top-0 z-20 border-b border-slate-200">
    <div class="max-w-[1600px] mx-auto px-6 py-3 flex items-center justify-between">
      <div>
        <div class="text-[11px] font-semibold tracking-widest text-jcgold uppercase">Jeng Chi • Enrollment</div>
        <h1 class="font-serif-head text-2xl text-ink -mt-0.5">Executive Benefits Platform</h1>
      </div>
      <div class="flex items-center gap-3">
        <span class="hidden sm:inline-flex items-center rounded-xl bg-white px-3 py-1 text-sm ring-1 ring-slate-200 text-slate-700">Jeng Chi Restaurant</span>
        <span class="text-sm text-slate-500">Status: <b id="health" class="text-ink">Connecting…</b></span>
      </div>
    </div>
    <div class="max-w-[1600px] mx-auto px-6 pb-3">
      <div class="flex items-center gap-3">
        <div class="step-dot bg-ink text-white">1</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/80 text-white">2</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/60 text-white">3</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/40 text-white">4</div><div class="h-px flex-1 bg-slate-200"></div>
        <div class="step-dot bg-ink/20 text-white">5</div>
      </div>
    </div>
  </header>

  <!-- Content -->
  <div class="max-w-[1600px] mx-auto px-6 py-8 grid grid-cols-12 gap-10">
    <main class="col-span-12 xl:col-span-9 space-y-10">
      <!-- 1. Context -->
      <section id="sec-context" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">1 · Employee Context</h2>
            <span class="text-xs text-slate-500">Pick employee & coverage tier</span>
          </div>
          <div class="grid md:grid-cols-3 gap-4 items-end">
            <div class="md:col-span-2">
              <label class="lbl">Employee</label>
              <div class="relative">
                <input id="empSearch" class="inp" placeholder="Search by name or username…" autocomplete="off" />
                <div id="empList" class="absolute z-50 left-0 right-0 bg-white ring-1 ring-slate-200 rounded-lg mt-1 hidden max-h-64 overflow-auto shadow-soft"></div>
              </div>
              <p id="empInfo" class="mt-2 text-sm text-slate-700"></p>
            </div>
            <div>
              <label class="lbl">Coverage Tier</label>
              <select id="tier" class="inp select-chevron">
                <option value="">— Select Tier —</option>
                <option value="EO">Employee Only</option>
                <option value="ES">Employee + Spouse/Partner</option>
                <option value="EC">Employee + Child(ren)</option>
                <option value="EF">Employee + Family</option>
              </select>
            </div>
          </div>
        </div>
      </section>

      <!-- 2. Reason -->
      <section id="sec-reason" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">2 · Reason for Submitting</h2>
            <span class="text-xs text-slate-500">QLE & Open Enrollment changes</span>
          </div>
          <div class="grid md:grid-cols-2 gap-6">
            <div class="rounded-xl border border-slate-200 bg-slate-50 p-5">
              <div class="font-semibold text-ink mb-1">Qualifying Life Event</div>
              <p class="text-[12px] text-slate-600 mb-4">Requests must be submitted within 30 days of the event.</p>
              <div class="space-y-3">
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_new_hire" type="checkbox" class="rounded border-slate-300"> New Hire</label>
                  <input id="qe_new_hire_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_emp_gain_loss" type="checkbox" class="rounded border-slate-300"> Employee: Gain/Loss of Coverage</label>
                  <input id="qe_emp_gain_loss_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_birth" type="checkbox" class="rounded border-slate-300"> Birth / Adoption</label>
                  <input id="qe_birth_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_marriage" type="checkbox" class="rounded border-slate-300"> Marriage</label>
                  <input id="qe_marriage_date" type="date" class="inp">
                </div>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_dep_gain_loss" type="checkbox" class="rounded border-slate-300"> Dependent: Gain/Loss</label>
                  <input id="qe_dep_gain_loss_date" type="date" class="inp">
                </div>
                <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_court" type="checkbox" class="rounded border-slate-300"> Court Order</label>
                <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_demo_change" type="checkbox" class="rounded border-slate-300"> Demographic Change</label>
                <div class="grid grid-cols-2 gap-3">
                  <label class="flex items-center gap-2 text-sm text-ink"><input id="qe_rehire" type="checkbox" class="rounded border-slate-300"> Rehire</label>
                  <input id="qe_rehire_date" type="date" class="inp">
                </div>
              </div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="font-semibold text-ink mb-2">Open Enrollment</div>
              <div class="grid grid-cols-2 gap-3">
                <label class="flex items-center gap-2 text-sm"><input id="oe_add_cov" type="checkbox" class="rounded border-slate-300"> Add Coverage</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_drop_cov" type="checkbox" class="rounded border-slate-300"> Drop Coverage</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_med" type="checkbox" class="rounded border-slate-300"> Change Medical</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_den" type="checkbox" class="rounded border-slate-300"> Change Dental</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_change_vis" type="checkbox" class="rounded border-slate-300"> Change Vision</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_update_vol" type="checkbox" class="rounded border-slate-300"> Update Vol Life Amount</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_add_dep" type="checkbox" class="rounded border-slate-300"> Add Dependent(s)</label>
                <label class="flex items-center gap-2 text-sm"><input id="oe_demo" type="checkbox" class="rounded border-slate-300"> Demographic Update</label>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- 3. Employee -->
      <section id="sec-employee" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">3 · Employee Information</h2>
            <span class="text-xs text-slate-500">Personal • Contact • Employment</span>
          </div>
          <div class="grid md:grid-cols-4 gap-4">
            <div><label class="lbl">SSN</label><input id="ssn" class="inp" placeholder="xxx-xx-xxxx"></div>
            <div><label class="lbl">Date of Birth</label><input id="dob" type="date" class="inp"></div>
            <div><label class="lbl">Gender</label>
              <select id="gender" class="inp select-chevron"><option value="">— Select —</option><option>M</option><option>F</option><option>X</option></select>
            </div>
            <div>
              <label class="lbl">Marital Status</label>
              <select id="marital_status" class="inp select-chevron">
                <option value="">-- Select --</option>
                <option value="single">Single</option>
                <option value="married">Married</option>
                <option value="divorced">Divorced</option>
                <option value="widowed">Widowed</option>
                <option value="prefer_not_to_say">Prefer not to say</option>
              </select>
            </div>
          </div>
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Date of Hire (Required)</label><input id="hire_date" type="date" class="inp"></div>
          </div>
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div class="md:col-span-2"><label class="lbl">Address (Street, Apt/Bldg #)</label><input id="addr_street" class="inp"></div>
            <div><label class="lbl">City</label><input id="addr_city" class="inp"></div>
            <div><label class="lbl">State</label><input id="addr_state" class="inp"></div>
          </div>
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Zip</label><input id="addr_zip" class="inp"></div>
            <div><label class="lbl">Phone</label><input id="phone" class="inp"></div>
            <div><label class="lbl">Email</label><input id="email" class="inp"></div>
            <div><label class="lbl">Job Title</label><input id="job_title" class="inp"></div>
          </div>
          <div class="grid md:grid-cols-4 gap-4 mt-4">
            <div><label class="lbl">Annual Salary</label><input id="annual_salary" type="number" step="0.01" class="inp" placeholder="0.00"></div>
          </div>
        </div>
      </section>

      <!-- 4. Dependents -->
      <section id="sec-dependents" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">4 · Dependents</h2>
            <span class="text-xs text-slate-500">Spouse/Partner and Children</span>
          </div>
          <div id="spouseBlock" class="hidden rounded-xl border border-slate-200 bg-slate-50 p-5 mb-6">
            <div class="font-semibold text-ink mb-3">Spouse / Domestic Partner</div>
            <div class="grid md:grid-cols-5 gap-4">
              <div><label class="lbl">First</label><input id="sp_first" class="inp"></div>
              <div><label class="lbl">Last</label><input id="sp_last" class="inp"></div>
              <div><label class="lbl">DOB</label><input id="sp_dob" type="date" class="inp"></div>
              <div><label class="lbl">SSN</label><input id="sp_ssn" class="inp"></div>
              <div><label class="lbl">Gender</label>
                <select id="sp_gender" class="inp select-chevron"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
              </div>
            </div>
          </div>
          <div id="childrenBlock" class="hidden">
            <div class="font-semibold text-ink mb-2">Dependent Children</div>
            <div id="kidsWrap" class="space-y-4"></div>
            <button id="addKid" type="button" class="mt-3 inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M5 12h14M12 5v14"/></svg>
              Add Dependent Child
            </button>
          </div>
        </div>
      </section>

      <!-- 5. Plans -->
      <section id="sec-plans" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-8">
          <div class="flex items-center justify-between mb-4">
            <h2 class="font-serif-head text-xl text-ink">5 · Plans & Contribution</h2>
            <span class="text-xs text-slate-500">Pick plans • See totals • Save or PDF</span>
          </div>
          <div class="grid md:grid-cols-3 gap-6">
            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Medical</div>
              <select id="medPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="HMO_HSA">HMO / ATBAP393 HSA</option>
                <option value="HMO">HMO / ATBAB303</option>
                <option value="PPO">PPO / ATBCB402</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="medPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="medAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>
            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Dental</div>
              <select id="denPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="F_PLAN_2W">F-PLAN 2W / Base MAC</option>
                <option value="F_PLAN_3W">F-PLAN 3W / Buy Up MAC</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="denPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="denAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>
            <div class="p-4 rounded-lg border border-slate-200 bg-white">
              <div class="font-semibold text-ink mb-2">Vision</div>
              <select id="visPlan" class="inp select-chevron">
                <option value="">— Select Plan —</option>
                <option value="PLAN_1">UC ClearVision Plan 1</option>
                <option value="WAIVE">Waive Coverage</option>
              </select>
              <div class="mt-3 text-xs text-slate-600">Per Pay: <span id="visPPP" class="font-bold text-ink">$0.00</span></div>
              <div class="text-xs text-slate-600">Annual: <span id="visAnnual" class="font-bold text-ink">$0.00</span></div>
            </div>
          </div>

          <!-- Section 9 — Company-Paid Life & AD&D -->
          <div class="mt-6 rounded-lg border border-slate-200 bg-white overflow-hidden">
            <div class="bg-slate-50 px-4 py-2 text-sm font-semibold">
              Section 9: Life &amp; AD&amp;D Coverages (Company-Paid)
            </div>
            <div class="grid grid-cols-12 text-sm">
              <div class="col-span-5 p-3 border-t font-medium">Term Life and AD&amp;D</div>
              <div class="col-span-3 p-3 border-t">Allstate</div>
              <div class="col-span-4 p-3 border-t">$25,000 Term Life &amp; AD&amp;D Benefit — 100% employer-paid</div>
            </div>
          </div>

          <!-- Section 10 — Beneficiaries -->
          <div id="beneficiariesBlock" class="mt-6 p-5 rounded-lg border border-slate-200 bg-slate-50">
            <div class="font-semibold text-ink">Section 10: Beneficiary Designation for Life &amp; AD&amp;D</div>
            <p class="text-xs text-slate-600 mb-3">
              If two or more primary beneficiaries are named, and you do not list percentages, proceeds will be paid in equal shares to the named
              primary beneficiaries. If no primary beneficiary survives you, proceeds will be paid to the contingent beneficiary(ies).
              Benefit percentages must total to <b>100%</b> for each group.
            </p>
            <div class="text-[12px] font-semibold tracking-wide text-slate-600 uppercase mb-1">Primary</div>
            <div id="benePrimaryWrap" class="space-y-2"></div>
            <button id="addPrimary" type="button"
              class="mt-2 inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M5 12h14M12 5v14"/></svg>
              Add Primary
            </button>
            <div class="h-px bg-slate-200 my-4"></div>
            <div class="text-[12px] font-semibold tracking-wide text-slate-600 uppercase mb-1">Contingent</div>
            <div id="beneContingentWrap" class="space-y-2"></div>
            <button id="addContingent" type="button"
              class="mt-2 inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 text-sm font-semibold text-ink hover:bg-slate-50">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-1"><path d="M5 12h14M12 5v14"/></svg>
              Add Contingent
            </button>
            <div id="benePctMsg" class="mt-2 text-xs text-slate-600"></div>
          </div>

          <!-- Buttons -->
          <div class="mt-6 flex gap-3">
            <button id="btnSave" type="button" class="inline-flex items-center rounded-lg bg-tech text-white px-5 py-2.5 font-semibold hover:brightness-110">Save & Update PDF</button>
            <button id="btnPDF" type="button" class="inline-flex items-center rounded-lg bg-ink text-white px-5 py-2.5 font-semibold hover:bg-slate-800">PDF</button>
            <p id="msg" class="text-sm text-slate-700 self-center"></p>
          </div>
        </div>
      </section>

      <!-- 6. Plan Elections (Summary) -->
      <section id="sec-elections-summary" class="soft-card">
        <div class="section-cap"></div>
        <div class="p-6 md:p-7">
          <div class="flex items-start md:items-center justify-between gap-4 mb-4">
            <div class="gold-chip">Plan Elections (Summary)</div>
            <div class="text-right">
              <div class="summary-badge">Current Tier</div>
              <div class="text-lg font-serif-head text-ink" id="elTier">—</div>
            </div>
          </div>
          <div class="grid lg:grid-cols-3 gap-5">
            <div class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-ink">Medical</div>
                <span class="text-[11px] text-slate-500 uppercase tracking-wide">Per Pay / Annual</span>
              </div>
              <div class="mt-1 text-sm text-slate-600">Selected:</div>
              <div class="text-[15px] font-medium text-ink" id="elMedName">—</div>
              <div class="summary-kpi mt-3">
                <span id="elMedPPP" class="text-ink font-semibold">$0.00</span>
                <span id="elMedAnnual" class="text-slate-600 text-sm">$0.00</span>
              </div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-ink">Dental</div>
                <span class="text-[11px] text-slate-500 uppercase tracking-wide">Per Pay / Annual</span>
              </div>
              <div class="mt-1 text-sm text-slate-600">Selected:</div>
              <div class="text-[15px] font-medium text-ink" id="elDenName">—</div>
              <div class="summary-kpi mt-3">
                <span id="elDenPPP" class="text-ink font-semibold">$0.00</span>
                <span id="elDenAnnual" class="text-slate-600 text-sm">$0.00</span>
              </div>
            </div>
            <div class="rounded-xl border border-slate-200 bg-white p-5">
              <div class="flex items-center justify-between">
                <div class="font-semibold text-ink">Vision</div>
                <span class="text-[11px] text-slate-500 uppercase tracking-wide">Per Pay / Annual</span>
              </div>
              <div class="mt-1 text-sm text-slate-600">Selected:</div>
              <div class="text-[15px] font-medium text-ink" id="elVisName">—</div>
              <div class="summary-kpi mt-3">
                <span id="elVisPPP" class="text-ink font-semibold">$0.00</span>
                <span id="elVisAnnual" class="text-slate-600 text-sm">$0.00</span>
              </div>
            </div>
          </div>
        </div>
      </section>
    </main>

    <aside class="col-span-12 xl:col-span-3">
      <div class="sticky top-24 soft-card p-6 md:p-7 enterprise-rail">
        <div class="text-[11px] font-semibold tracking-widest text-jcgold uppercase">Summary</div>
        <h3 class="font-serif-head text-xl text-ink mt-1 mb-1">At-a-Glance</h3>
        <p class="text-sm text-slate-600 mb-4">Totals update as you select plans.</p>
        <div class="space-y-3">
          <div class="flex justify-between text-sm"><span class="text-slate-600">Medical</span><span id="sum_med" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Dental</span><span id="sum_den" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Vision</span><span id="sum_vis" class="font-semibold text-ink">—</span></div>
          <div class="flex justify-between text-sm"><span class="text-slate-600">Tier</span><span id="sum_tier" class="font-semibold text-ink">—</span></div>

          <div class="h-px bg-slate-200 my-2"></div>
          <div class="flex items-center justify-between">
            <span class="text-sm text-slate-600">Per Pay Total</span>
            <span id="totalPPP" class="text-2xl font-serif-head text-ink">$0.00</span>
          </div>
          <div class="text-right text-[12px] text-slate-600">Annual (26): <span id="totalAnnual" class="font-semibold text-ink">$0.00</span></div>

          <div class="grid grid-cols-2 gap-3 mt-4">
            <button id="btnSave2" type="button" class="inline-flex items-center rounded-lg bg-tech text-white px-3 py-2 font-semibold hover:brightness-110">Save</button>
            <button id="btnPDF2" type="button" class="inline-flex items-center rounded-lg border border-slate-300 bg-white px-3 py-2 font-semibold text-ink hover:bg-slate-50">PDF</button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- PRINT FOOTER -->
  <div class="pdf-footer">
    <div class="left">
      Confidential • For internal HR use only. Policies and benefits are subject to change.
    </div>
    <div class="center"></div>
    <div class="right">
      Jeng Chi Restaurant • 400 N Greenville Ave, Richardson, TX 75081
    </div>
  </div>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-benefits";

    const { createClient } = window.supabase;
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let RATES = {};
    let EMP = null;
    let timer = null;

    // [ALL ELEMENT SELECTORS — FULL]

    const tierSel = document.getElementById("tier");
    const medPlan = document.getElementById("medPlan");
    const denPlan = document.getElementById("denPlan");
    const visPlan = document.getElementById("visPlan");
    const medPPP = document.getElementById("medPPP");
    const medAnnual = document.getElementById("medAnnual");
    const denPPP = document.getElementById("denPPP");
    const denAnnual = document.getElementById("denAnnual");
    const visPPP = document.getElementById("visPPP");
    const visAnnual = document.getElementById("visAnnual");
    const totalPPP = document.getElementById("totalPPP");
    const totalAnnual = document.getElementById("totalAnnual");
    const sumMed = document.getElementById("sum_med");
    const sumDen = document.getElementById("sum_den");
    const sumVis = document.getElementById("sum_vis");
    const sumTier = document.getElementById("sum_tier");

    const btnSave = document.getElementById("btnSave");
    const btnPDF = document.getElementById("btnPDF");
    const btnSave2 = document.getElementById("btnSave2");
    const btnPDF2 = document.getElementById("btnPDF2");
    const msg = document.getElementById("msg");
    const kidsWrap = document.getElementById("kidsWrap");
    const empSearch = document.getElementById("empSearch");
    const empList = document.getElementById("empList");
    const empInfo = document.getElementById("empInfo");

    const elTier = document.getElementById("elTier");
    const elMedName = document.getElementById("elMedName");
    const elDenName = document.getElementById("elDenName");
    const elVisName = document.getElementById("elVisName");
    const elMedPPP = document.getElementById("elMedPPP");
    const elDenPPP = document.getElementById("elDenPPP");
    const elVisPPP = document.getElementById("elVisPPP");
    const elMedAnnual = document.getElementById("elMedAnnual");
    const elDenAnnual = document.getElementById("elDenAnnual");
    const elVisAnnual = document.getElementById("elVisAnnual");

    const benePrimaryWrap = document.getElementById("benePrimaryWrap");
    const beneContingentWrap = document.getElementById("beneContingentWrap");
    const addPrimary = document.getElementById("addPrimary");
    const addContingent = document.getElementById("addContingent");
    const benePctMsg = document.getElementById("benePctMsg");

    const val = id => document.getElementById(id)?.value.trim();
    const setVal = (id, v) => { const el = document.getElementById(id); if (el) el.value = (v ?? ""); };
    const getCB = id => document.getElementById(id)?.checked || false;
    const setCB = (id, v) => { const el = document.getElementById(id); if (el) el.checked = !!v; };

    // Health check
    (async () => {
      const el = document.getElementById("health");
      try {
        const r = await sb.from('benefit_rates').select('coverage').limit(1);
        el.textContent = r.error ? 'REST Error' : 'DB Connected';
      } catch { el.textContent = "Blocked by browser"; }
    })();

    async function loadRates() {
      const { data, error } = await sb.from("benefit_rates")
        .select("coverage,plan_code,tier,amount,per_year_periods");
      if (error) return console.error(error);
      RATES = {};
      for (const r of data) {
        RATES[r.coverage] ??= {};
        RATES[r.coverage][r.plan_code] ??= {};
        RATES[r.coverage][r.plan_code][r.tier] = { amt: Number(r.amount), ppp: r.per_year_periods || 26 };
      }
    }

    const fmt = n => `$${Number(n||0).toFixed(2)}`;
    const mapTier = t => ({EO:"Employee Only", ES:"Employee + Spouse/Partner", EC:"Employee + Child(ren)", EF:"Employee + Family"}[t] || "—");
    function mapPlanLabel(c, code){
      const MAP = {
        MEDICAL:{HMO_HSA:"HMO / ATBAP393 HSA", HMO:"HMO / ATBAB303", PPO:"PPO / ATBCB402", WAIVE:"Waive"},
        DENTAL: {F_PLAN_2W:"F-PLAN 2W / Base MAC", F_PLAN_3W:"F-PLAN 3W / Buy Up MAC", WAIVE:"Waive"},
        VISION: {PLAN_1:"UC ClearVision Plan 1", WAIVE:"Waive"}
      };
      return MAP[c]?.[code] || "—";
    }
    function getRate(c,p,t){ if(!p || p==="WAIVE") return {amt:0,ppp:26}; return RATES?.[c]?.[p]?.[t] ?? {amt:0,ppp:26}; }

    function toggleDepBlocks(){
      document.getElementById("spouseBlock").classList.toggle("hidden", !(tierSel.value==="ES"||tierSel.value==="EF"));
      document.getElementById("childrenBlock").classList.toggle("hidden", !(tierSel.value==="EC"||tierSel.value==="EF"));
    }

    function updatePrices(){
      const t = tierSel.value || "";
      const mr = getRate("MEDICAL", medPlan.value, t);
      const dr = getRate("DENTAL", denPlan.value, t);
      const vr = getRate("VISION", visPlan.value, t);

      medPPP.textContent = fmt(mr.amt); medAnnual.textContent = fmt(mr.amt * mr.ppp);
      denPPP.textContent = fmt(dr.amt); denAnnual.textContent = fmt(dr.amt * dr.ppp);
      visPPP.textContent = fmt(vr.amt); visAnnual.textContent = fmt(vr.amt * vr.ppp);

      sumMed.textContent = medPlan.value ? mapPlanLabel("MEDICAL", medPlan.value) : "—";
      sumDen.textContent = denPlan.value ? mapPlanLabel("DENTAL", denPlan.value) : "—";
      sumVis.textContent = visPlan.value ? mapPlanLabel("VISION", visPlan.value) : "—";
      sumTier.textContent = tierSel.value ? mapTier(tierSel.value) : "—";

      const total = mr.amt + dr.amt + vr.amt;
      totalPPP.textContent = fmt(total);
      totalAnnual.textContent = fmt(total * 26);

      toggleDepBlocks();

      const ok = !!(EMP && EMP.uuid);
      [btnSave, btnSave2, btnPDF, btnPDF2].forEach(b => b.disabled = !ok);

      elTier.textContent = tierSel.value ? mapTier(tierSel.value) : "—";
      elMedName.textContent = medPlan.value ? mapPlanLabel("MEDICAL", medPlan.value) : "—";
      elDenName.textContent = denPlan.value ? mapPlanLabel("DENTAL", denPlan.value) : "—";
      elVisName.textContent = visPlan.value ? mapPlanLabel("VISION", visPlan.value) : "—";
      elMedPPP.textContent = fmt(mr.amt); elMedAnnual.textContent = fmt(mr.amt * mr.ppp);
      elDenPPP.textContent = fmt(dr.amt); elDenAnnual.textContent = fmt(dr.amt * dr.ppp);
      elVisPPP.textContent = fmt(vr.amt); elVisAnnual.textContent = fmt(vr.amt * vr.ppp);
    }

    function clearForNewEmployee(){
      tierSel.value=""; medPlan.value=""; denPlan.value=""; visPlan.value="";
      ["ssn","dob","gender","marital_status","hire_date","addr_street","addr_city","addr_state","addr_zip","phone","email","job_title","annual_salary"]
        .forEach(id => setVal(id,""));

      kidsWrap.innerHTML="";
      document.getElementById("spouseBlock").classList.add("hidden");
      document.getElementById("childrenBlock").classList.add("hidden");

      benePrimaryWrap.innerHTML = "";
      beneContingentWrap.innerHTML = "";
      benePctMsg.textContent = "";

      sumMed.textContent="—"; sumDen.textContent="—"; sumVis.textContent="—"; sumTier.textContent="—";
      totalPPP.textContent="$0.00"; totalAnnual.textContent="$0.00";

      [btnSave,btnSave2,btnPDF,btnPDF2].forEach(b=> b.disabled = true);

      elTier.textContent = "—";
      elMedName.textContent = "—"; elDenName.textContent = "—"; elVisName.textContent = "—";
      elMedPPP.textContent = "$0.00"; elDenPPP.textContent = "$0.00"; elVisPPP.textContent = "$0.00";
      elMedAnnual.textContent = "$0.00"; elDenAnnual.textContent = "$0.00"; elVisAnnual.textContent = "$0.00";
    }

    // Employee search
empSearch.addEventListener("input", () => {
  clearTimeout(timer);
  timer = setTimeout(async () => {
    const q = empSearch.value.trim();
    empList.innerHTML = "";
    empList.classList.add("hidden");
    if (!q) return;

    const { data, error } = await sb
      .from('v_employees_masked')
      .select('id, first_name, last_name, username, job_title, pin')
      .or(`first_name.ilike.%${q}%,last_name.ilike.%${q}%,username.ilike.%${q}%`)
      .order('last_name')
      .order('first_name')
      .limit(25);

    if (error || !data || data.length === 0) return;

    empList.classList.remove("hidden");
    const seen = new Set();

    data.forEach(e => {
      const key = String(e.id);
      if (seen.has(key)) return;
      seen.add(key);

      const fullName = `${e.first_name || ""} ${e.last_name || ""}`.trim();
      const display = fullName || e.username;

      const row = document.createElement("div");
      row.className = "px-3 py-2 rounded-md hover:bg-slate-100 cursor-pointer text-sm";
      row.innerHTML = `
        <div class="font-medium text-ink">${display}</div>
        <div class="text-xs text-slate-500">${e.job_title || "—"} • ID: ${e.id}</div>
      `;
      row.addEventListener('mousedown', ev => {
        ev.preventDefault();
        selectEmployee({
          ...e,
          full_name: fullName,
          position_title: e.job_title
        });
      });
      empList.appendChild(row);
    });
  }, 220);
});;


    document.addEventListener('click', (e)=>{
      if (!empList.contains(e.target) && e.target !== empSearch) {
        empList.classList.add('hidden');
      }
    });

    empSearch.addEventListener('keydown', (e)=>{
      if (e.key === 'Enter') {
        const first = empList.querySelector('div');
        if (first) first.dispatchEvent(new MouseEvent('mousedown', {bubbles:true}));
      }
    });

    function hydrateEmployeeUiFromHR(e) {
      setVal("ssn", e.ssn_masked ?? "");
      setVal("dob", e.dob ?? "");
      setVal("hire_date", e.hire_date ?? "");
      setVal("phone", e.phone_primary ?? "");
      setVal("email", e.email ?? "");
      setVal("addr_street", e.address_line1 ?? "");
      setVal("addr_city", e.address_line2 ?? "");
      setVal("job_title", e.position_title ?? "");
    }

    // --- FINAL FIXED: Use EMP.uuid (real Supabase UUID) as employee_id ---
async function resolveEmployeeUUID(hrRow) {
  console.log("Resolving UUID for employee:", hrRow.id);

  const employeeId = String(hrRow.id);

  // Step 1: Look up existing mapping
 const { data, error } = await sb
  .from("hb_access")
  .select("employee_id")
  .eq("employee_external_id", employeeId)
  .maybeSingle();

  if (error) {
    console.error("DB error looking up hb_access:", error);
    return null;
  }

  // Step 2: If we have a REAL UUID (contains dashes), use it
  if (data?.employee_id && data.employee_id.includes('-')) {
    console.log("Valid UUID found:", data.employee_id);
    return data.employee_id;
  }

  // Step 3: Row exists but employee_id is numeric → FIX IT (update in place)
  if (data?.employee_id) {
    console.warn("Found old numeric employee_id. Fixing it now...");
    const newUuid = crypto.randomUUID();

    const { error: updErr } = await sb
      .from("hb_access")
      .update({
        employee_id: newUuid,
        initials: "HR"
      })
      .eq("employee_external_id", employeeId);

    if (updErr) {
      console.error("Failed to update existing row:", updErr);
      return null;
    }

    console.log("Fixed! New UUID:", newUuid);
    return newUuid;
  }

  // Step 4: No row at all → create fresh
  console.warn("No mapping found. Creating new one...");
  const newUuid = crypto.randomUUID();

  const { error: insErr } = await sb
    .from("hb_access")
    .insert({
      employee_external_id: employeeId,
      employee_id: newUuid,
      initials: "HR"
    });

  if (insErr) {
    console.error("Failed to insert new mapping:", insErr);
    return null;
  }

  console.log("Created new UUID:", newUuid);
  return newUuid;
}


async function selectEmployee(e) {
  try {
    EMP = { ...e, external_id: String(e.id) };
    EMP.uuid = await resolveEmployeeUUID(e);  // Ensure this returns a valid UUID

    // Ensure EMP.uuid is populated before proceeding
if (!EMP.uuid || !EMP.uuid.includes('-')) {
  EMP.uuid = EMP.external_id;
  console.warn("[FALLBACK] Using external_id as key (will fail PDF)");
}
    console.log("Employee UUID (or external_id):", EMP.uuid);  // Log for debugging

    EMP.username = e.username ?? EMP.full_name?.toLowerCase().replace(/[^a-z0-9]+/g, "").slice(0,12) + "_" + String(e.id).slice(-6);
    EMP.full_name = e.full_name;

    empList.classList.add("hidden");
    empSearch.value = e.full_name || "";
    clearForNewEmployee();
    hydrateEmployeeUiFromHR(e);

    empInfo.innerHTML = `Ready • Key: ${EMP.uuid}`;
    await preloadEnrollment();
    updatePrices();
    [btnSave, btnSave2, btnPDF, btnPDF2].forEach(b => b.disabled = false);
  } catch (err) {
    console.error("Select employee failed:", err);
    empInfo.innerHTML = `<b class="text-rose-700">Error: ${err.message}</b>`;
    EMP = null;
  }
}

    function getEnrollmentFilter() {
      return EMP?.uuid ? { column: "employee_id", value: EMP.uuid } : null;
    }

    // Dependents UI
    document.getElementById("addKid").addEventListener("click", ()=> addKidRow());
    function addKidRow(row={}) {
      const div=document.createElement("div");
      div.className="grid md:grid-cols-6 gap-4 items-end p-4 rounded-lg border border-slate-200 bg-white";
      div.innerHTML=`
        <div><label class="lbl">First</label><input class="inp kid_first"></div>
        <div><label class="lbl">Last</label><input class="inp kid_last"></div>
        <div><label class="lbl">DOB</label><input type="date" class="inp kid_dob"></div>
        <div><label class="lbl">SSN</label><input class="inp kid_ssn"></div>
        <div><label class="lbl">Gender</label>
          <select class="inp select-chevron kid_gender"><option value="">—</option><option>M</option><option>F</option><option>X</option></select>
        </div>
        <div><button type="button" class="inline-flex items-center justify-center h-[46px] rounded-lg border border-red-300 bg-white text-sm font-semibold text-red-700 hover:bg-red-50 removeKid w-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>
        </button></div>`;
      kidsWrap.appendChild(div);
      div.querySelector(".kid_first").value = row.first||"";
      div.querySelector(".kid_last").value = row.last||"";
      div.querySelector(".kid_dob").value = row.dob||"";
      div.querySelector(".kid_ssn").value = row.ssn||"";
      div.querySelector(".kid_gender").value = row.gender||"";
      div.querySelector(".removeKid").onclick = ()=>div.remove();
    }

    // Beneficiaries
    function beneRowTemplate() {
      const div = document.createElement("div");
      div.className = "grid md:grid-cols-7 gap-3 items-end p-3 rounded-md border border-slate-200 bg-white bene-row";
      div.innerHTML = `
        <div><label class="lbl">First</label><input class="inp bene_first"></div>
        <div><label class="lbl">Last</label><input class="inp bene_last"></div>
        <div><label class="lbl">Date of Birth</label><input type="date" class="inp bene_dob"></div>
        <div><label class="lbl">Relationship</label><input class="inp bene_rel" placeholder="Spouse/Child/Other"></div>
        <div><label class="lbl">Social Security #</label><input class="inp bene_ssn" placeholder=""></div>
        <div><label class="lbl">% Share</label><input type="number" step="1" class="inp bene_pct" placeholder="0"></div>
        <div><button type="button" class="inline-flex items-center justify-center h-[46px] rounded-lg border border-red-300 bg-white text-sm font-semibold text-red-700 hover:bg-red-50 bene_remove w-full">
          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4"><path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2M10 11v6M14 11v6"/></svg>
        </button></div>
      `;
      div.querySelector(".bene_remove").onclick = () => { div.remove(); computeBenePct(); };
      div.querySelector(".bene_pct").addEventListener("input", computeBenePct);
      return div;
    }

    function createBeneficiaryRow(role, preset=null){
      const row = beneRowTemplate();
      row.dataset.role = role;
      if (preset){
        row.querySelector(".bene_first").value = preset.first || "";
        row.querySelector(".bene_last").value = preset.last || "";
        row.querySelector(".bene_dob").value = preset.dob || "";
        row.querySelector(".bene_rel").value = preset.relationship || "";
        row.querySelector(".bene_ssn").value = preset.ssn || "";
        row.querySelector(".bene_pct").value = preset.pct ?? "";
      }
      (role === "primary" ? benePrimaryWrap : beneContingentWrap).appendChild(row);
      computeBenePct();
    }
    addPrimary.addEventListener("click", ()=> createBeneficiaryRow("primary"));
    addContingent.addEventListener("click", ()=> createBeneficiaryRow("contingent"));

    function sumPct(container){
      return Array.from(container.querySelectorAll(".bene_pct"))
        .reduce((s,el)=> s + (Number(el.value||0) || 0), 0);
    }
    function anyPct(container){
      return Array.from(container.querySelectorAll(".bene_pct"))
        .some(el => el.value !== "");
    }
    function computeBenePct(){
      const pTot = sumPct(benePrimaryWrap);
      const cTot = sumPct(beneContingentWrap);
      const pTxt = anyPct(benePrimaryWrap) ? `Primary total: ${pTot}%` : `Primary total: 0%`;
      const cTxt = anyPct(beneContingentWrap) ? `Contingent total: ${cTot}%` : `Contingent total: 0%`;
      benePctMsg.textContent = `${pTxt} • ${cTxt} (must equal 100% each if specified)`;
    }

    async function preloadEnrollment(){
      if(!EMP) return;
      const filt = getEnrollmentFilter();
      if (!filt) return;

      const { data, error } = await sb
        .from("benefit_enrollments")
        .select("*")
        .eq(filt.column, filt.value)
        .maybeSingle();

      if(error){ console.error('preload error:', error); return; }
      const d = data;
      if(!d) return;

      if(d.tier_election) tierSel.value=d.tier_election;
      if(d.medical_plan) medPlan.value=d.medical_plan;
      if(d.dental_plan) denPlan.value=d.dental_plan;
      if(d.vision_plan) visPlan.value=d.vision_plan;

      const q=d.qualifying_events||{};
      setCB("qe_new_hire",q.new_hire); setVal("qe_new_hire_date",q.new_hire_date);
      setCB("qe_emp_gain_loss",q.emp_gain_loss); setVal("qe_emp_gain_loss_date",q.emp_gain_loss_date);
      setCB("qe_birth",q.birth_or_adoption); setVal("qe_birth_date",q.birth_or_adoption_date);
      setCB("qe_marriage",q.marriage); setVal("qe_marriage_date",q.marriage_date);
      setCB("qe_dep_gain_loss",q.dependent_gain_loss); setVal("qe_dep_gain_loss_date",q.dependent_gain_loss_date);
      setCB("qe_court",q.court_order); setCB("qe_demo_change",q.demo_change);
      setCB("qe_rehire",q.rehire); setVal("qe_rehire_date",q.rehire_date);

      const oe=d.oe_changes||{};
      setCB("oe_add_cov",oe.add_cov); setCB("oe_drop_cov",oe.drop_cov);
      setCB("oe_change_med",oe.change_med); setCB("oe_change_den",oe.change_den);
      setCB("oe_change_vis",oe.change_vis); setCB("oe_update_vol",oe.update_vol);
      setCB("oe_add_dep",oe.add_dep); setCB("oe_demo",oe.demo_change);

      if (d.ssn) setVal("ssn", d.ssn);
      if (d.dob) setVal("dob", d.dob);
      if (d.gender) setVal("gender", d.gender);
      if (d.marital_status) setVal("marital_status", d.marital_status);
      if (d.phone) setVal("phone", d.phone);
      if (d.email) setVal("email", d.email);
      if (d.job_title) setVal("job_title", d.job_title);
      if (d.hire_date) setVal("hire_date", d.hire_date);
      if (d.annual_salary!=null) setVal("annual_salary", d.annual_salary);

      const a=d.address||{};
      if (a.street) setVal("addr_street", a.street);
      if (a.city) setVal("addr_city", a.city);
      if (a.state) setVal("addr_state", a.state);
      if (a.zip) setVal("addr_zip", a.zip);

      benePrimaryWrap.innerHTML = ""; beneContingentWrap.innerHTML = "";
      (d.beneficiaries || []).forEach(b => createBeneficiaryRow((b.role==="contingent")?"contingent":"primary", b));
      computeBenePct();

      if(d.spouse){
        setVal("sp_first",d.spouse.first); setVal("sp_last",d.spouse.last);
        setVal("sp_dob",d.spouse.dob); setVal("sp_ssn",d.spouse.ssn);
        setVal("sp_gender",d.spouse.gender);
      }
      kidsWrap.innerHTML="";
      (d.dependents||[]).forEach(dep=>addKidRow(dep));

      updatePrices();
    }

    function getFullEnrollmentPayload() {
      const toDateOrNull = (s) => (s && s.length ? s : null);
      const toNumberOrNull = (s) => {
        if (!s || !s.length) return null;
        const n = Number(s);
        return Number.isFinite(n) ? n : null;
      };

      const qualifying_events = {
        new_hire: getCB("qe_new_hire"),
        new_hire_date: toDateOrNull(val("qe_new_hire_date")),
        emp_gain_loss: getCB("qe_emp_gain_loss"),
        emp_gain_loss_date: toDateOrNull(val("qe_emp_gain_loss_date")),
        birth_or_adoption: getCB("qe_birth"),
        birth_or_adoption_date: toDateOrNull(val("qe_birth_date")),
        marriage: getCB("qe_marriage"),
        marriage_date: toDateOrNull(val("qe_marriage_date")),
        dependent_gain_loss: getCB("qe_dep_gain_loss"),
        dependent_gain_loss_date: toDateOrNull(val("qe_dep_gain_loss_date")),
        court_order: getCB("qe_court"),
        demo_change: getCB("qe_demo_change"),
        rehire: getCB("qe_rehire"),
        rehire_date: toDateOrNull(val("qe_rehire_date")),
      };

      const oe_changes = {
        add_cov: getCB("oe_add_cov"),
        drop_cov: getCB("oe_drop_cov"),
        change_med: getCB("oe_change_med"),
        change_den: getCB("oe_change_den"),
        change_vis: getCB("oe_change_vis"),
        update_vol: getCB("oe_update_vol"),
        add_dep: getCB("oe_add_dep"),
        demo_change: getCB("oe_demo"),
      };

      const address = {
        street: val("addr_street") || null,
        city: val("addr_city") || null,
        state: val("addr_state") || null,
        zip: val("addr_zip") || null,
      };

      const spouse = (tierSel.value === "ES" || tierSel.value === "EF")
        ? { first: val("sp_first") || null, last: val("sp_last") || null, dob: toDateOrNull(val("sp_dob")), ssn: val("sp_ssn") || null, gender: val("sp_gender") || null }
        : null;

      const dependents = (tierSel.value === "EC" || tierSel.value === "EF")
        ? Array.from(document.querySelectorAll("#kidsWrap > div")).map(row => ({
            first: row.querySelector(".kid_first").value.trim() || null,
            last: row.querySelector(".kid_last").value.trim() || null,
            dob: toDateOrNull(row.querySelector(".kid_dob").value.trim()),
            ssn: row.querySelector(".kid_ssn").value.trim() || null,
            gender: row.querySelector(".kid_gender").value || null,
          })).filter(k => k.first || k.last)
        : [];

      const collectBene = (wrap, role) => Array.from(wrap.querySelectorAll(".bene-row")).map(row => ({
        role,
        first: row.querySelector(".bene_first").value.trim() || null,
        last: row.querySelector(".bene_last").value.trim() || null,
        dob: toDateOrNull(row.querySelector(".bene_dob")?.value.trim()),
        relationship: row.querySelector(".bene_rel").value.trim() || null,
        ssn: row.querySelector(".bene_ssn").value.trim() || null,
        pct: toNumberOrNull(row.querySelector(".bene_pct").value)
      })).filter(b => b.first || b.last);

      const beneficiaries = [...collectBene(benePrimaryWrap, "primary"), ...collectBene(beneContingentWrap, "contingent")];

      return {
        tier_election: tierSel.value || null,
        medical_plan: medPlan.value || null,
        dental_plan: denPlan.value || null,
        vision_plan: visPlan.value || null,
        qualifying_events, oe_changes,
        ssn: val("ssn") || null,
        dob: toDateOrNull(val("dob")),
        gender: val("gender") || null,
        marital_status: val("marital_status") || null,
        address, phone: val("phone") || null,
        email: val("email") || null,
        job_title: val("job_title") || null,
        hire_date: toDateOrNull(val("hire_date")),
        annual_salary: toNumberOrNull(val("annual_salary")),
        spouse, dependents, beneficiaries,
        employee_id: EMP?.uuid ?? null, // FIX: Renamed from employee_id_uuid to employee_id for filter consistency
        username: EMP?.username ?? null,
        full_name: EMP?.full_name ?? null,
      };
    }

    async function performSave(payload) {
      const benePrimary = payload.beneficiaries.filter(b => b.role === 'primary');
      const beneContingent = payload.beneficiaries.filter(b => b.role === 'contingent');
      const pHas = benePrimary.some(b => b.pct != null);
      const cHas = beneContingent.some(b => b.pct != null);
      const pTot = benePrimary.reduce((s,b)=> s + (b.pct || 0), 0);
      const cTot = beneContingent.reduce((s,b)=> s + (b.pct || 0), 0);
      if (pHas && pTot !== 100) { msg.textContent = "Primary % must total 100%."; return { success:false }; }
      if (cHas && cTot !== 100) { msg.textContent = "Contingent % must total 100%."; return { success:false }; }

      const filt = getEnrollmentFilter();
      if (!filt){ msg.textContent = "Missing employee key."; return { success:false }; }

      const { data: existing, error: selErr } = await sb
        .from("benefit_enrollments")
        .select("id")
        .eq(filt.column, filt.value)
        .maybeSingle();

      if (selErr){ console.error("Select error:", selErr); msg.textContent="Save failed (select)."; return { success:false }; }

      if (existing?.id){
        const { error: updErr } = await sb.from("benefit_enrollments").update(payload).eq("id", existing.id);
        if (updErr){ console.error("Update error:", updErr); msg.textContent="Save failed (update)."; return { success:false }; }
        return { success:true, id: existing.id };
      } else {
        const { data: ins, error: insErr } = await sb.from("benefit_enrollments").insert(payload).select("id").maybeSingle();
        if (insErr){ console.error("Insert error:", insErr); msg.textContent="Save failed (insert)."; return { success:false }; }
        return { success:true, id: ins?.id };
      }
    }

    async function ensureEmployeeSelected() {
      if (EMP) return true;
      const q = (empSearch.value || '').trim();
      if (!q) { msg.textContent = "Type or select an employee first."; return false; }

      const { data, error } = await sb.from('v_employees_masked')
        .select('id, full_name, username, email, position_title, hire_date, dob, phone_primary, address_line1, address_line2, ssn_masked')
        .or(`full_name.eq.${q},username.eq.${q},email.eq.${q}`)
        .limit(2);

      if (error || !data || data.length !== 1) {
        msg.textContent = "Please select an employee from the dropdown list.";
        return false;
      }
      await selectEmployee(data[0]);
      return true;
    }

  async function handlePDF() {
  if (!(await ensureEmployeeSelected())) return;
  const filt = getEnrollmentFilter();
  if (!filt) { msg.textContent = "Missing employee key."; return; }

  try {
    // First: try to get from DB
    const { data, error } = await sb
      .from("benefit_enrollments")
      .select("pdf_url")
      .eq(filt.column, filt.value)
      .maybeSingle();

    let url = data?.pdf_url;

    // If not in DB, generate on-the-fly (fallback)
    if (!url) {
      msg.textContent = "Generating PDF now...";
      const pdfUrl = FN_URL + `?employee_uuid=${EMP.uuid}`;
      const res = await fetch(pdfUrl, {
        headers: {
          "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
          "apikey": SUPABASE_ANON_KEY
        }
      });
      if (!res.ok) throw new Error("Failed to generate PDF");
      const pdfBytes = await res.arrayBuffer();
      const pdfKey = `enrollment_pdfs/employee_${EMP.uuid}.pdf`;  // This ensures the URL format is correct
      await sb.storage.from('employee-pdfs').upload(pdfKey, pdfBytes, { upsert: true });

      // Get the public URL of the PDF
      const { data: { publicUrl } } = sb.storage.from('employee-pdfs').getPublicUrl(pdfKey);
      url = publicUrl;

      // Update DB so next time it's instant
      await sb.from("benefit_enrollments").update({ pdf_url: url }).eq(filt.column, filt.value);
    }

    // Open the PDF in a new tab
    window.open(url, '_blank');
    msg.textContent = "PDF opened!";
    setTimeout(() => msg.textContent = "", 3000);
  } catch (e) {
    console.error(e);
    msg.textContent = "Failed to load PDF.";
  }
}


     async function handleSave() {
      if (!(await ensureEmployeeSelected())) return;
      msg.textContent = "Saving data...";
      const payload = getFullEnrollmentPayload();
      const result = await performSave(payload);
      if (!result.success) return;
 
      await preloadEnrollment();
      msg.textContent = "Generating PDF...";
      try {
        // FIXED: Correctly detect numeric vs UUID and use right query param
        let pdfUrl = FN_URL;
        if (EMP.uuid && /^\d+$/.test(EMP.uuid)) {
          pdfUrl += `?employee_id=${EMP.uuid}`;
        } else if (EMP.uuid && EMP.uuid.includes('-')) {
          pdfUrl += `?employee_uuid=${EMP.uuid}`;
        } else {
          throw new Error("Invalid employee key: " + EMP.uuid);
        }

        console.log("PDF Generation URL →", pdfUrl);
        const res = await fetch(pdfUrl, {
          method: "GET",
          headers: {
            "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
            "apikey": SUPABASE_ANON_KEY
          }
        });

        if (!res.ok) {
          const err = await res.text();
          console.error("PDF Function Error:", err);
          throw new Error(`Server error: ${err}`);
        }
        // ... rest of your existing code (upload, update pdf_url, etc.)

    const pdfBytes = await res.arrayBuffer();
    const pdfKey = `enrollment_pdfs/employee_${EMP.uuid}.pdf`;

    await sb.storage.from('employee-pdfs')
        .upload(pdfKey, pdfBytes, { upsert: true });

    const { data: { publicUrl } } = sb.storage.from('employee-pdfs').getPublicUrl(pdfKey);
        

    // Check if the pdf_url is being correctly updated
    console.log("Generated PDF URL:", publicUrl);
        

    const filt = getEnrollmentFilter();
    await sb.from("benefit_enrollments").update({ pdf_url: publicUrl }).eq(filt.column, filt.value);

    msg.textContent = "Saved & PDF Updated!";
    setTimeout(() => msg.textContent = "", 3000);
  } catch (e) {
    console.error("PDF Update/Save Error:", e);
    msg.textContent = "PDF failed (check console).";
  }
}



    [tierSel, medPlan, denPlan, visPlan, document.getElementById("marital_status")]
      .forEach(el=>el.addEventListener("input", updatePrices));

    btnSave.addEventListener("click", handleSave);
    btnSave2.addEventListener("click", handleSave);
    btnPDF.addEventListener("click", handlePDF);
    btnPDF2.addEventListener("click", handlePDF);

    (async ()=>{ await loadRates(); updatePrices(); })();
  </script>
</body>
</html>


