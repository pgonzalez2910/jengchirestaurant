<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-950">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi — Executive Benefits Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        :root {
            --jc-navy: #002147;
            --jc-navy-dark: #00152f;
            --jc-navy-soft: #0b2447;
            --jc-gold: #f6c453;
            --jc-gold-deep: #d99a1a;
            --jc-bg: #020617;
        }

        body {
            font-family: 'Poppins', sans-serif;
            color: #e5e7eb;
        }

        .accent-gold {
            background: linear-gradient(135deg, var(--jc-gold), var(--jc-gold-deep));
            color: #111827;
        }
        .accent-gold:hover {
            background: linear-gradient(135deg, #ffd369, #e3aa25);
        }

        .spinner {
            border: 4px solid #e0e0e0;
            border-top: 4px solid var(--jc-gold);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin .8s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }

        .modal-bg { background: rgba(15,23,42,0.85); }

        @media print {
            #dashboard,
            #loginScreen,
            #spinnerOverlay,
            #feedbackModal,
            #userModal {
                display: none !important;
            }
            #printView {
                display: block !important;
            }
            .print-iframe {
                page-break-after: always;
            }
            iframe {
                width: 100%;
                height: 95vh;
                border: none;
            }
        }

        .transition-all { transition: all 0.3s ease; }
        .section-header { font-weight: 600; letter-spacing: 0.18em; text-transform: uppercase; }

        .card {
            background: #020617;
            border: 1px solid #1f2937;
            border-radius: 18px;
            box-shadow: 0 22px 60px rgba(15,23,42,0.6);
        }

        .input-focus { transition: all 0.25s ease; }
        .input-focus:focus {
            border-color: var(--jc-gold);
            box-shadow: 0 0 0 3px rgba(246,196,83,0.35);
        }

        .btn-icon { display: inline-flex; align-items: center; gap: 8px; }
        .fade-in { animation: fadeIn 0.45s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

        .glossy-logo {
            filter: brightness(1.06) contrast(1.15);
            transition: filter 0.25s ease, transform 0.25s ease;
        }
        .glossy-logo:hover {
            filter: brightness(1.12) contrast(1.22);
            transform: translateY(-2px);
        }

        .shell-gradient {
            background:
                radial-gradient(circle at 0% 0%, rgba(246,196,83,0.18), transparent 55%),
                radial-gradient(circle at 100% 100%, rgba(56,189,248,0.12), transparent 55%),
                #020617;
        }

        .soft-badge {
            border-radius: 9999px;
        }

        .workspace-tag {
            font-size: 0.6rem;
            letter-spacing: 0.22em;
            text-transform: uppercase;
        }

        .metric-card {
            background: radial-gradient(circle at top left, #020617, #0b1220);
            border-radius: 18px;
            border: 1px solid #1f2937;
            box-shadow: 0 16px 40px rgba(15,23,42,0.7);
        }

        .metric-label {
            font-size: 0.65rem;
            letter-spacing: 0.18em;
            text-transform: uppercase;
            color: #9ca3af;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: #f9fafb;
        }

        .metric-sub {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .role-chip {
            border-radius: 9999px;
            padding: 0.35rem 0.9rem;
            font-size: 0.7rem;
            letter-spacing: 0.16em;
            text-transform: uppercase;
        }

        .role-chip--admin {
            background: rgba(22,163,74,0.16);
            border: 1px solid rgba(22,163,74,0.55);
            color: #bbf7d0;
        }

        .role-chip--user {
            background: rgba(59,130,246,0.12);
            border: 1px solid rgba(59,130,246,0.55);
            color: #bfdbfe;
        }

        .login-hero {
            background:
                radial-gradient(circle at 0% 0%, rgba(246,196,83,0.28), transparent 60%),
                radial-gradient(circle at 100% 100%, rgba(56,189,248,0.18), transparent 55%),
                linear-gradient(135deg, #020617, #020617);
        }

        .login-kpi {
            background: radial-gradient(circle at top left, #020617, #020617);
            border-radius: 1.25rem;
            border: 1px solid rgba(148,163,184,0.35);
        }

        .login-card-glow {
            box-shadow:
                0 36px 90px rgba(15,23,42,0.9),
                0 0 0 1px rgba(148,163,184,0.45);
        }

        .employee-pill {
            border-radius: 9999px;
            border: 1px solid rgba(148,163,184,0.4);
            background: rgba(15,23,42,0.75);
            color: #e5e7eb;
        }
        .employee-pill:hover {
            background: rgba(30,64,175,0.85);
        }
        .employee-pill--active {
            background: linear-gradient(135deg, #f6c453, #d99a1a);
            color: #020617;
            border-color: transparent;
            box-shadow: 0 0 0 1px rgba(250,250,250,0.4), 0 18px 40px rgba(15,23,42,0.8);
        }

        .cost-bar-track {
            height: 0.7rem;
            border-radius: 9999px;
            background: #020617;
            border: 1px solid #1f2937;
            overflow: hidden;
        }
        .cost-bar-med { background: #38bdf8; }
        .cost-bar-den { background: #2dd4bf; }
        .cost-bar-vis { background: #a855f7; }

        .audit-strip {
            background: linear-gradient(90deg, #020617, #020617);
            border-radius: 9999px;
            border: 1px solid #1f2937;
        }

        .kpi-header-card {
            border-radius: 16px;
            border: 1px solid #1f2937;
            background: radial-gradient(circle at top left, #020617, #020617);
        }

        .tab-btn {
            border-radius: 9999px;
        }
    </style>
</head>
<body class="min-h-screen shell-gradient">

    <!-- Global Spinner Overlay -->
    <div id="spinnerOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-slate-950 rounded-2xl p-8 flex flex-col items-center card max-w-sm w-full border border-slate-800">
            <div class="spinner mb-4"></div>
            <p class="text-slate-100 font-semibold text-lg tracking-wide">Processing request...</p>
            <p class="text-slate-400 text-sm mt-1">Please wait a moment</p>
        </div>
    </div>

    <!-- Custom Feedback/Alert/Prompt Modal -->
    <div id="feedbackModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-slate-950 rounded-2xl card w-full max-w-lg p-8 fade-in border border-slate-800">
            <h3 id="feedbackModalTitle" class="text-2xl font-semibold mb-4 text-slate-50 section-header"></h3>
            <p id="feedbackModalMessage" class="text-slate-300 mb-6"></p>
            <textarea id="feedbackModalPromptInput" class="hidden border border-slate-600 bg-slate-900 w-full p-3 rounded-lg text-sm h-32 resize-none input-focus text-slate-100" placeholder="Enter selection..."></textarea>
            <div id="feedbackModalButtons" class="flex justify-end gap-4"></div>
        </div>
    </div>

    <!-- LOGIN SCREEN -->
    <div id="loginScreen" class="min-h-screen flex items-center justify-center px-4 py-10">
        <div class="max-w-6xl w-full grid gap-10 lg:grid-cols-[1.25fr,0.9fr] items-stretch">
            <!-- Narrative / KPI column -->
            <div class="login-hero rounded-3xl border border-slate-800 p-8 sm:p-10 flex flex-col justify-between gap-10">
                <div class="space-y-6">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div class="absolute -inset-1 rounded-2xl bg-gradient-to-tr from-[color:var(--jc-gold)]/70 via-sky-400/50 to-transparent blur-md opacity-95"></div>
                            <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
                                 class="relative w-14 h-14 rounded-2xl object-cover glossy-logo ring-1 ring-[color:var(--jc-gold)]/80"
                                 alt="Jeng Chi Logo" />
                        </div>
                        <div>
                            <p class="workspace-tag text-[color:var(--jc-gold)]/90">Jeng Chi Restaurant</p>
                            <h1 class="text-2xl sm:text-3xl font-bold text-slate-50 tracking-tight">
                                Executive Benefits Portal
                            </h1>
                            <p class="text-xs text-slate-300 mt-1">
                                Confidential workspace for HR, Finance, and Ownership.
                            </p>
                        </div>
                    </div>

                    <div class="space-y-3 mt-4">
                        <p class="text-[0.75rem] text-slate-300 max-w-xl leading-relaxed">
                            Review signed enrollments, compare multi-year benefit elections, and manage executive access
                            in a single, secure console. Use your assigned initials and 4-digit PIN to continue.
                        </p>
                        <div class="flex flex-wrap gap-2 text-[0.7rem]">
                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/80 border border-slate-600 soft-badge text-slate-200">
                                <i class="fa-regular fa-file-signature text-[color:var(--jc-gold)]"></i>
                                <span>Signed enrollments</span>
                            </span>
                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/80 border border-slate-600 soft-badge text-slate-200">
                                <i class="fa-regular fa-chart-line text-sky-400"></i>
                                <span>Multi-year benefit analytics</span>
                            </span>
                            <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900/80 border border-slate-600 soft-badge text-slate-200">
                                <i class="fa-regular fa-user-lock text-emerald-400"></i>
                                <span>Portal access controls</span>
                            </span>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs">
                    <div class="login-kpi px-4 py-3 shadow-sm flex flex-col gap-1 text-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="metric-label">Workspace</span>
                            <i class="fa-regular fa-table-layout text-slate-400"></i>
                        </div>
                        <p class="text-sm font-semibold mt-1">Document Hub</p>
                        <p class="metric-sub">Finalized PDFs for audit, print, and compliance.</p>
                    </div>
                    <div class="login-kpi px-4 py-3 shadow-sm flex flex-col gap-1 text-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="metric-label">Analytics</span>
                            <i class="fa-regular fa-chart-mixed text-slate-400"></i>
                        </div>
                        <p class="text-sm font-semibold mt-1">Benefit Timeline</p>
                        <p class="metric-sub">Side-by-side 2025 vs 2026 impact per employee.</p>
                    </div>
                    <div class="login-kpi px-4 py-3 shadow-sm flex flex-col gap-1 text-slate-100">
                        <div class="flex items-center justify-between">
                            <span class="metric-label">Security</span>
                            <i class="fa-regular fa-user-shield text-slate-400"></i>
                        </div>
                        <p class="text-sm font-semibold mt-1">Access Governance</p>
                        <p class="metric-sub">Username & PIN authentication with audit trail.</p>
                    </div>
                </div>
            </div>

            <!-- Login panel -->
            <div class="bg-slate-950/90 card rounded-3xl p-8 sm:p-10 text-left fade-in login-card-glow border border-slate-800">
                <div class="flex items-start justify-between mb-8 gap-3">
                    <div>
                        <p class="section-header text-[0.6rem] text-slate-400 mb-1">Executive Sign-In</p>
                        <h2 class="text-2xl font-bold text-slate-50">Enter your portal credentials</h2>
                        <p class="text-xs text-slate-400 mt-1">
                            Use the initials and PIN issued to you by HR or Ownership.
                        </p>
                    </div>
                    <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-900/40 text-emerald-200 text-[0.7rem] border border-emerald-500/50 soft-badge">
                        <span class="w-2 h-2 rounded-full bg-emerald-400 animate-pulse"></span>
                        Secure Executive Access
                    </span>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label for="username" class="block text-sm font-medium text-slate-200 mb-1">
                            Username <span class="text-slate-500 text-xs">(assigned initials, e.g. PG)</span>
                        </label>
                        <input
                            id="username"
                            type="text"
                            placeholder="Enter your assigned initials"
                            class="border border-slate-700 bg-slate-900 w-full p-3 rounded-lg text-base input-focus text-slate-100 placeholder:text-slate-500"
                        />
                    </div>
                    <div>
                        <label for="pin" class="block text-sm font-medium text-slate-200 mb-1">
                            PIN
                        </label>
                        <input
                            id="pin"
                            type="password"
                            placeholder="4-digit secure PIN"
                            class="border border-slate-700 bg-slate-900 w-full p-3 rounded-lg text-base input-focus text-slate-100 placeholder:text-slate-500"
                        />
                    </div>
                </div>

                <button
                    id="loginBtn"
                    class="w-full accent-gold font-semibold py-3.5 rounded-xl shadow-md hover:shadow-2xl transition-all btn-icon justify-center text-sm tracking-wide"
                >
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Sign In to Executive Console</span>
                </button>
                <p id="loginError" class="text-red-400 text-sm mt-4 hidden"></p>

                <div class="mt-6 space-y-2 text-xs text-slate-400">
                    <p>
                        This system contains confidential employee benefit information. Access is limited to authorized
                        executives and HR leaders. Activity is logged and subject to review.
                    </p>
                    <p class="flex items-center gap-2 text-[0.7rem]">
                        <i class="fa-regular fa-circle-exclamation text-[color:var(--jc-gold-deep)]"></i>
                        <span>Questions about your access? Contact HR or an Executive Administrator.</span>
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- DASHBOARD SHELL -->
    <div id="dashboard" class="hidden min-h-screen">
        <div class="min-h-screen flex flex-col">
            <!-- Top Navigation Bar -->
            <header class="bg-slate-950 border-b border-slate-800 shadow-xl">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <div class="relative">
                            <div class="absolute -inset-1 rounded-2xl bg-gradient-to-tr from-[color:var(--jc-gold)]/75 via-sky-400/55 to-transparent blur-md opacity-95"></div>
                            <img
                                src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
                                class="relative w-12 h-12 md:w-14 md:h-14 rounded-2xl object-cover glossy-logo ring-1 ring-[color:var(--jc-gold)]/80"
                                alt="Jeng Chi Logo"
                            />
                        </div>
                        <div>
                            <p class="workspace-tag text-[color:var(--jc-gold)]/90">Jeng Chi Restaurant</p>
                            <h1 class="text-xl sm:text-2xl font-semibold text-white tracking-tight">
                                Executive Benefits Portal
                            </h1>
                            <p class="text-[0.75rem] text-slate-400 mt-1">
                                Multi-year HR & Benefits command center for leadership.
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="hidden sm:flex flex-col items-end gap-1 text-right">
                            <div id="portalRole" class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-600 text-[0.7rem]"></div>
                            <span class="inline-flex items-center gap-2 text-[0.65rem] text-slate-500">
                                <i class="fa-regular fa-location-dot text-sky-400"></i>
                                <span>All times in Chicago CST</span>
                            </span>
                        </div>
                        <div id="printContainer" class="relative hidden">
                            <button
                                id="printMenuBtn"
                                class="px-3 py-2 rounded-xl bg-slate-900 hover:bg-slate-800 border border-slate-700 flex items-center gap-2 text-xs sm:text-sm text-slate-100 transition-all"
                                title="Print Options"
                            >
                                <i class="fas fa-print text-[color:var(--jc-gold)]"></i>
                                <span class="hidden sm:inline">Print</span>
                            </button>
                            <div
                                id="printMenu"
                                class="hidden absolute right-0 mt-3 bg-slate-950 border border-slate-700 rounded-2xl card z-40 w-72 overflow-hidden text-sm"
                            >
                                <button
                                    id="printAll"
                                    class="block w-full text-left px-5 py-3 text-slate-100 hover:bg-slate-900 transition-all"
                                >
                                    Print All Documents (PDF Merge)
                                </button>
                                <button
                                    id="printByEmployee"
                                    class="block w-full text-left px-5 py-3 text-slate-100 hover:bg-slate-900 transition-all"
                                >
                                    Print by Employee (Open Tabs)
                                </button>
                            </div>
                        </div>
                        <button
                            id="logoutBtn"
                            class="accent-gold px-4 sm:px-6 py-2.5 rounded-xl shadow-md hover:shadow-2xl transition-all btn-icon text-xs sm:text-sm"
                        >
                            <i class="fas fa-sign-out-alt"></i>
                            <span>Logout</span>
                        </button>
                    </div>
                </div>
            </header>

            <!-- Global KPI Strip -->
            <section class="bg-slate-950/95 border-b border-slate-800">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3">
                    <div class="kpi-header-card px-4 py-3 flex flex-col gap-1">
                        <p class="metric-label">Signed Employees</p>
                        <p class="metric-value text-[color:var(--jc-gold)]" id="kpiSignedEmployees">0</p>
                        <p class="metric-sub">Employees with finalized benefit packets.</p>
                    </div>
                    <div class="kpi-header-card px-4 py-3 flex flex-col gap-1">
                        <p class="metric-label">Current Year</p>
                        <p class="metric-value text-sky-400" id="kpiCurrentYear">2026</p>
                        <p class="metric-sub">Active benefit cycle under review.</p>
                    </div>
                    <div class="kpi-header-card px-4 py-3 flex flex-col gap-1">
                        <p class="metric-label">Active Admin Users</p>
                        <p class="metric-value text-emerald-400" id="kpiActiveAdmins">0</p>
                        <p class="metric-sub">Administrators with portal access enabled.</p>
                    </div>
                    <div class="kpi-header-card px-4 py-3 flex flex-col gap-1">
                        <p class="metric-label">Open Sessions</p>
                        <p class="metric-value text-slate-100" id="kpiOpenSessions">0</p>
                        <p class="metric-sub">Current browser session using this console.</p>
                    </div>
                </div>
            </section>

            <!-- Main Content Shell -->
            <main class="flex-1 bg-slate-950">
                <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-6">

                    <!-- Workspace Navigation Bar -->
                    <section class="bg-slate-950/90 border border-slate-800 rounded-3xl px-4 sm:px-6 py-4 shadow-2xl">
                        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                            <div>
                                <p class="workspace-tag text-slate-400">Executive Workspaces</p>
                                <p class="text-xs text-slate-400 max-w-xl mt-1">
                                    Move between the Document Control Center, benefit analytics, user & role console,
                                    and audit-ready access logs.
                                </p>
                            </div>
                            <nav class="flex flex-wrap gap-2">
                                <button
                                    id="tabDocs"
                                    class="tab-btn px-4 py-2 bg-gray-100 text-gray-700 text-xs sm:text-sm font-medium flex items-center gap-2 shadow-sm"
                                >
                                    <i class="fas fa-file-signature text-slate-700"></i>
                                    <span>Signed Documents</span>
                                </button>
                                <button
                                    id="tabSummary"
                                    class="tab-btn px-4 py-2 bg-gray-100 text-gray-700 text-xs sm:text-sm font-medium flex items-center gap-2 shadow-sm hidden"
                                >
                                    <i class="fas fa-chart-bar text-slate-700"></i>
                                    <span>Benefit Summary</span>
                                </button>
                                <button
                                    id="tabUsers"
                                    class="tab-btn px-4 py-2 bg-gray-100 text-gray-700 text-xs sm:text-sm font-medium flex items-center gap-2 shadow-sm hidden"
                                >
                                    <i class="fas fa-users-gear text-slate-700"></i>
                                    <span>Authorized Users</span>
                                </button>
                                <button
                                    id="tabLogs"
                                    class="tab-btn px-4 py-2 bg-gray-100 text-gray-700 text-xs sm:text-sm font-medium flex items-center gap-2 shadow-sm hidden"
                                >
                                    <i class="fas fa-clipboard-list text-slate-700"></i>
                                    <span>Access Logs</span>
                                </button>
                            </nav>
                        </div>
                    </section>

                    <!-- Workspace Content -->
                    <section class="space-y-6">

                        <!-- Signed Documents Section -->
                        <section
                            id="docsSection"
                            class="card rounded-3xl p-6 lg:p-8 bg-slate-950/95 text-slate-100 overflow-x-auto fade-in"
                        >
                            <!-- Workspace ribbon -->
                            <div class="flex flex-col gap-3 mb-6 lg:flex-row lg:items-center lg:justify-between">
                                <div>
                                    <p class="workspace-tag text-slate-400 mb-1">Document Control Center</p>
                                    <h2 class="text-xl lg:text-2xl font-bold text-slate-50">
                                        Employee Signed Benefit Documents
                                    </h2>
                                    <p class="text-sm text-slate-400 max-w-xl mt-2">
                                        Alphabetical index of employees with completed benefit packets.
                                        PDFs are final, signed copies of each employee’s elections and ready for audit
                                        or production printing.
                                    </p>
                                </div>
                                <div class="flex flex-col gap-2 text-xs text-slate-400">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-700 soft-badge">
                                        <i class="fa-regular fa-database text-emerald-400"></i>
                                        <span>Live from employees2025 (signed_pdf_url)</span>
                                    </div>
                                    <p class="flex items-center gap-2">
                                        <i class="fa-regular fa-circle-info text-sky-400"></i>
                                        <span>Click “View PDF” for browser-native viewing and printing.</span>
                                    </p>
                                </div>
                            </div>

                            <!-- Search & KPI Row -->
                            <div class="flex flex-col xl:flex-row gap-4 items-start xl:items-end mb-6">
                                <div class="w-full xl:max-w-md">
                                    <label for="docSearch" class="block text-sm font-medium text-slate-200 mb-1">
                                        Search signed employees
                                    </label>
                                    <div class="relative">
                                        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">
                                            <i class="fa-regular fa-magnifying-glass"></i>
                                        </span>
                                        <input
                                            id="docSearch"
                                            type="text"
                                            placeholder="Filter by last name, first name, or username..."
                                            class="border border-slate-700 bg-slate-900 w-full pl-8 pr-3 py-2.5 rounded-lg text-sm input-focus text-slate-100 placeholder:text-slate-500"
                                        />
                                    </div>
                                </div>
                                <div class="flex flex-wrap gap-2 text-[0.75rem]">
                                    <span class="soft-badge inline-flex items-center gap-2 px-3 py-1 bg-slate-900 text-slate-200 border border-slate-700">
                                        <i class="fa-regular fa-layer-group text-[color:var(--jc-gold)]"></i>
                                        <span>Total Signed:&nbsp;<span id="signedCount">0</span></span>
                                    </span>
                                    <span class="soft-badge inline-flex items-center gap-2 px-3 py-1 bg-slate-900 text-slate-400 border border-dashed border-slate-600">
                                        <i class="fa-regular fa-calendar-week"></i>
                                        <span>New in last 7 days:&nbsp;<span id="signedLast7">—</span></span>
                                    </span>
                                </div>
                            </div>

                            <!-- Table -->
                            <div class="rounded-2xl border border-slate-800 overflow-hidden shadow-sm bg-slate-950/80">
                                <table class="w-full min-w-[700px] text-sm">
                                    <thead class="bg-slate-900 border-b border-slate-800">
                                        <tr class="text-slate-300 font-semibold">
                                            <th class="text-left py-3 px-4">Last Name</th>
                                            <th class="text-left px-4">First Name</th>
                                            <th class="text-left px-4">Username</th>
                                            <th class="text-left px-4">Document Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="docBody" class="divide-y divide-slate-800">
                                        <tr>
                                            <td colspan="4" class="text-center py-6 text-slate-500">
                                                Loading documents...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <!-- Benefit Summary Section (Admin Only) -->
                        <section
                            id="summarySection"
                            class="card rounded-3xl p-6 lg:p-8 bg-slate-950/95 text-slate-100 overflow-x-auto hidden fade-in"
                        >
                            <!-- Workspace ribbon -->
                            <div class="flex flex-col gap-3 mb-6 lg:flex-row lg:items-center lg:justify-between">
                                <div>
                                    <p class="workspace-tag text-slate-400 mb-1">Benefit Analytics Workspace</p>
                                    <h2 class="text-xl lg:text-2xl font-bold text-slate-50 mt-1">
                                        Employee Benefit Analytics — 2025 vs 2026
                                    </h2>
                                    <p class="text-sm text-slate-400 max-w-xl mt-2">
                                        Select an employee from the directory to generate a summary card. Each card
                                        shows bi-weekly totals, annualized cost, coverage tier, and a visual bar
                                        comparing Medical, Dental, and Vision across years.
                                    </p>
                                </div>
                                <div class="flex flex-col gap-2 text-xs text-slate-400">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-700 soft-badge">
                                        <i class="fa-regular fa-database text-emerald-400"></i>
                                        <span>employees2025 · benefit_enrollments · benefit_rates</span>
                                    </div>
                                    <p>
                                        Use this view during renewal strategy, budgeting, and one-on-one reviews.
                                    </p>
                                </div>
                            </div>

                            <!-- Tab-specific KPI row -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Comparison Years</p>
                                    <p class="metric-value flex items-center gap-2 text-[color:var(--jc-gold)]">
                                        <span>2025</span>
                                        <i class="fa-regular fa-arrow-right-long text-slate-500"></i>
                                        <span>2026</span>
                                    </p>
                                    <p class="metric-sub">Side-by-side per employee; values render on selection.</p>
                                </div>
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Plan Mix Insight</p>
                                    <p class="metric-value text-sky-400 flex items-center gap-2">
                                        <i class="fa-regular fa-layer-group"></i>
                                        <span>Medical · Dental · Vision</span>
                                    </p>
                                    <p class="metric-sub">Stacked cost bars highlight plan composition.</p>
                                </div>
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Change Signal</p>
                                    <p class="metric-value text-emerald-400 flex items-center gap-2">
                                        <i class="fa-regular fa-arrow-trend-up"></i>
                                        <span>Year-over-year delta</span>
                                    </p>
                                    <p class="metric-sub">Delta card flags increases, savings, or flat trends.</p>
                                </div>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-[0.9fr,1.6fr] gap-8">
                                <!-- Left: Employee list & search -->
                                <div class="md:col-span-1 flex flex-col gap-4">
                                    <div>
                                        <label for="employeeSearch" class="block text-sm font-medium text-slate-200 mb-1">
                                            Search employees
                                        </label>
                                        <div class="relative">
                                            <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 text-xs">
                                                <i class="fa-regular fa-magnifying-glass"></i>
                                            </span>
                                            <input
                                                id="employeeSearch"
                                                type="text"
                                                placeholder="Search by Last, First or Username..."
                                                class="border border-slate-700 bg-slate-900 w-full pl-8 pr-3 py-2.5 rounded-lg text-sm input-focus text-slate-100 placeholder:text-slate-500"
                                            />
                                        </div>
                                    </div>
                                    <div class="bg-slate-950 rounded-2xl border border-slate-800 max-h-[600px] overflow-y-auto p-4">
                                        <div class="flex items-center justify-between mb-3">
                                            <h3 class="font-semibold text-slate-100 text-xs section-header">
                                                Employee Directory
                                            </h3>
                                            <span class="text-[0.65rem] text-slate-500">
                                                Pulls from signed employees only
                                            </span>
                                        </div>
                                        <div id="employeeList" class="space-y-1 text-sm" data-active-username="">
                                            <p class="text-slate-500 py-2">
                                                Loading users...
                                            </p>
                                        </div>
                                    </div>
                                </div>

                                <!-- Right: Summary card container -->
                                <div
                                    id="summaryCardContainer"
                                    class="md:col-span-2 min-h-[320px] flex items-center justify-center bg-slate-950 border border-dashed border-slate-700 rounded-3xl px-6"
                                >
                                    <div class="text-center max-w-md">
                                        <p class="text-slate-400 text-sm md:text-base mb-3">
                                            Select an employee from the directory to generate their
                                            benefit summary and side-by-side year comparison.
                                        </p>
                                        <div class="flex items-center justify-center gap-2 text-xs text-slate-500">
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900 border border-slate-700">
                                                <i class="fa-regular fa-circle-plus text-emerald-400"></i>
                                                <span>Bi-weekly & annual totals</span>
                                            </span>
                                            <span class="inline-flex items-center gap-1 px-2 py-1 rounded-full bg-slate-900 border border-slate-700">
                                                <i class="fa-regular fa-arrows-retweet text-sky-400"></i>
                                                <span>Tier + plan mix per year</span>
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>

                        <!-- Authorized Users Section (Admin Only) -->
                        <section
                            id="usersSection"
                            class="card rounded-3xl p-6 lg:p-8 bg-slate-950/95 text-slate-100 overflow-x-auto hidden fade-in"
                        >
                            <!-- Workspace ribbon -->
                            <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4 mb-6">
                                <div class="space-y-2">
                                    <p class="workspace-tag text-slate-400 mb-1">User & Role Admin Console</p>
                                    <h2 class="text-xl lg:text-2xl font-bold text-slate-50">
                                        Authorized Users & Portal Credentials
                                    </h2>
                                    <p class="text-sm text-slate-400 max-w-xl">
                                        Maintain which executives and managers can enter the Executive Benefits Portal.
                                        This control surface manages username & PIN combinations and role visibility
                                        for the workspaces above.
                                    </p>
                                </div>
                                <button
                                    id="addUser"
                                    class="accent-gold px-4 sm:px-6 py-2.5 rounded-xl transition-all btn-icon text-sm shadow-md hover:shadow-2xl"
                                >
                                    <i class="fas fa-user-plus"></i>
                                    <span>Add User</span>
                                </button>
                            </div>

                            <!-- Info cards -->
                            <div class="flex flex-col lg:flex-row gap-4 mb-6 text-xs">
                                <div class="flex-1 bg-slate-950 border border-slate-800 rounded-2xl px-4 py-3 space-y-1">
                                    <p class="font-semibold text-slate-100 text-xs">Role legend</p>
                                    <p class="text-[0.7rem] text-slate-400">
                                        <span class="font-semibold text-slate-100">Administrator:</span> can view
                                        Benefit Summary, manage users, and review access logs.
                                    </p>
                                    <p class="text-[0.7rem] text-slate-400">
                                        <span class="font-semibold text-slate-100">Standard User:</span> restricted
                                        to Signed Documents workspace only.
                                    </p>
                                </div>
                                <div class="flex-1 bg-slate-950 border border-slate-800 rounded-2xl px-4 py-3 space-y-1">
                                    <p class="font-semibold text-slate-100 text-xs">Security notes</p>
                                    <p class="text-[0.7rem] text-slate-400">
                                        Changes here are demo-only and do not write to Supabase in this module. A full
                                        implementation would point to an auth table secured with RLS.
                                    </p>
                                </div>
                            </div>

                            <!-- Users Table -->
                            <div class="rounded-2xl border border-slate-800 overflow-hidden shadow-sm bg-slate-950/80">
                                <table class="w-full min-w-[700px] text-sm">
                                    <thead class="bg-slate-900 border-b border-slate-800">
                                        <tr class="text-slate-300 font-semibold">
                                            <th class="text-left py-3 px-4">Full Name</th>
                                            <th class="text-left px-4">Username</th>
                                            <th class="text-left px-4">PIN</th>
                                            <th class="text-left px-4">Role</th>
                                            <th class="text-left px-4">Status</th>
                                            <th class="text-left px-4">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="userBody" class="divide-y divide-slate-800">
                                        <tr>
                                            <td colspan="6" class="text-center py-6 text-slate-500">
                                                Loading users...
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                        <!-- Access Logs Section (Admin Only) -->
                        <section
                            id="logsSection"
                            class="card rounded-3xl p-6 lg:p-8 bg-slate-950/95 text-slate-100 overflow-x-auto hidden fade-in"
                        >
                            <!-- Header -->
                            <div class="flex flex-col gap-3 mb-6 lg:flex-row lg:items-center lg:justify-between">
                                <div class="space-y-2">
                                    <p class="workspace-tag text-slate-400 mb-1">Audit & Compliance View</p>
                                    <h2 class="text-xl lg:text-2xl font-bold text-slate-50">
                                        Portal Access History
                                    </h2>
                                    <p class="text-sm text-slate-400 max-w-xl">
                                        All logins and logouts captured with Chicago CST timestamps and a calculated
                                        session duration. Use this console to confirm portal activity during open
                                        enrollment, audits, and investigations.
                                    </p>
                                </div>
                                <div class="flex flex-col gap-2 text-xs text-slate-400">
                                    <div class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-slate-900 border border-slate-700 soft-badge">
                                        <i class="fa-regular fa-globe text-sky-400"></i>
                                        <span>Supabase table: portal_logs</span>
                                    </div>
                                    <p>Durations are rounded to the nearest minute when logout is recorded.</p>
                                </div>
                            </div>

                            <!-- Filter bar (visual only) -->
                            <div class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-3 text-xs">
                                <div class="inline-flex flex-wrap gap-2">
                                    <span class="soft-badge inline-flex items-center gap-2 px-3 py-1 bg-slate-900 border border-slate-700 text-slate-200">
                                        <i class="fa-regular fa-calendar-days text-[color:var(--jc-gold)]"></i>
                                        <span>Last 30 days</span>
                                    </span>
                                    <span class="soft-badge inline-flex items-center gap-2 px-3 py-1 bg-slate-900 border border-slate-700 text-slate-200">
                                        <i class="fa-regular fa-users"></i>
                                        <span>All users</span>
                                    </span>
                                </div>
                                <p class="text-slate-500">
                                    Entries reflect the 50 most recent sessions for this portal.
                                </p>
                            </div>

                            <!-- KPI row -->
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Time Standard</p>
                                    <p class="metric-value text-[color:var(--jc-gold)] flex items-center gap-2">
                                        <i class="fa-regular fa-location-dot text-sky-400"></i>
                                        <span>Chicago CST</span>
                                    </p>
                                    <p class="metric-sub">All timestamps normalized to a single time zone.</p>
                                </div>
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Session Tracking</p>
                                    <p class="metric-value text-emerald-400 flex items-center gap-2">
                                        <i class="fa-regular fa-stopwatch"></i>
                                        <span>Duration (min)</span>
                                    </p>
                                    <p class="metric-sub">Calculated from login to logout, or flagged as Active.</p>
                                </div>
                                <div class="metric-card px-4 py-4 flex flex-col gap-1">
                                    <p class="metric-label">Scope</p>
                                    <p class="metric-value text-slate-100 flex items-center gap-2">
                                        <i class="fa-regular fa-list-timeline"></i>
                                        <span>Last 50 sessions</span>
                                    </p>
                                    <p class="metric-sub">Recent history to support audits and spot checks.</p>
                                </div>
                            </div>

                            <!-- Logs Table -->
                            <div class="rounded-2xl border border-slate-800 overflow-hidden shadow-sm bg-slate-950/80">
                                <table class="w-full min-w-[700px] text-sm">
                                    <thead class="bg-slate-900 border-b border-slate-800">
                                        <tr class="text-slate-300 font-semibold">
                                            <th class="text-left py-3 px-4">Username</th>
                                            <th class="text-left px-4">Login Time</th>
                                            <th class="text-left px-4">Logout Time</th>
                                            <th class="text-left px-4">Duration (min)</th>
                                        </tr>
                                    </thead>
                                    <tbody id="logBody" class="divide-y divide-slate-800">
                                        <tr>
                                            <td colspan="4" class="text-center py-6 text-slate-500">
                                                No logs available
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </section>

                    </section>
                </div>
            </main>
        </div>
    </div>

    <!-- User Management Modal -->
    <div id="userModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-slate-950 rounded-2xl card w-full max-w-md p-8 fade-in border border-slate-800">
            <h3 id="modalTitle" class="text-2xl font-bold text-slate-50 mb-6 section-header"></h3>
            <div class="space-y-4">
                <input id="modalFullName" type="text" placeholder="Full Name" class="border border-slate-700 bg-slate-900 w-full p-3 rounded text-base input-focus text-slate-100 placeholder:text-slate-500" />
                <input id="modalUsername" type="text" placeholder="Username (2-3 initials)" class="border border-slate-700 bg-slate-900 w-full p-3 rounded text-base input-focus text-slate-100 placeholder:text-slate-500" />
                <input id="modalPin" type="number" placeholder="PIN (4 digits)" class="border border-slate-700 bg-slate-900 w-full p-3 rounded text-base input-focus text-slate-100 placeholder:text-slate-500" />
                <select id="modalRole" class="border border-slate-700 bg-slate-900 w-full p-3 rounded text-base input-focus text-slate-100">
                    <option value="user">Standard User</option>
                    <option value="admin">Administrator</option>
                </select>
                <label id="modalActiveContainer" class="flex items-center gap-3 text-base text-slate-200">
                    <input id="modalActive" type="checkbox" class="form-checkbox h-5 w-5 text-[color:var(--jc-gold)] bg-slate-900 border-slate-700" /> Portal Active
                </label>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="modalCancel" class="px-6 py-3 rounded-lg bg-slate-900 hover:bg-slate-800 text-slate-100 border border-slate-700 transition-all btn-icon text-sm">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="modalSave" class="px-6 py-3 rounded-lg accent-gold transition-all btn-icon text-sm">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>

    <!-- Print View -->
    <section id="printView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-12 bg-white rounded-2xl card">
        <h1 class="text-4xl font-bold mb-8 text-center text-gray-900 section-header">
            Jeng Chi Employee Documents (Print View)
        </h1>
        <p class="text-center text-gray-600 mb-8 print:hidden text-lg">
            The browser's print dialog should have appeared. All documents are embedded below. Click "Close" when done printing.
        </p>
        <button
            id="closePrintView"
            class="mb-10 accent-gold px-6 py-3 rounded-lg block mx-auto print:hidden transition-all btn-icon"
        >
            <i class="fas fa-times-circle"></i> Close Print View
        </button>
        <div id="printContainerContent" class="space-y-12"></div>
    </section>

    <!-- SCRIPT BLOCK -->
    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const RATE_SCHEDULE_ID = '10729793-8776-423e-a4e4-b7532c64031b';

        // --- GLOBAL STATE ---
        let currentUser = null;
        let employeeDataCache = [];
        let authorizedUsersCache = [];
        let docSubscription = null;
        const TIMEZONE = 'America/Chicago';
        const LOCALE = 'en-US';
        let nextAuthUserId = 5;

        const storedUser = sessionStorage.getItem("auth_user");

        let AUTHORIZED_USERS = [
            { id: 1, full_name: "Francisco Teng", username: "FT", pin: "9094", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 2, full_name: "Pablo Gonzalez", username: "PG", pin: "9367", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 3, full_name: "Garret Moore", username: "GM", pin: "1740", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 4, full_name: "Janelle Teng", username: "JT", pin: "2316", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" }
        ];

        const STATIC_PLAN_NAMES = {
            "F_PLAN_2W": "F-PLAN 2W / Base MAC",
            "F_PLAN_3W": "F-PLAN 3W / Buy Up MAC",
            "HMO": "HMO / ATBAB303",
            "HMO_HSA": "HMO / ATBAP393 HSA",
            "LIFE_CORE": "Allstate Term Life & AD&D (Employer-Paid)",
            "PLAN_1": "UC ClearVision Plan 1",
            "PPO": "PPO / ATBCB402",
        };
        let planDisplayNames = STATIC_PLAN_NAMES;

        // --- FETCHERS ---
        async function fetchPlanRates(planCodes, tier) {
            if (RATE_SCHEDULE_ID === 'YOUR_ACTIVE_RATE_SCHEDULE_UUID') {
                console.warn("RATE_SCHEDULE_ID is not configured. Using $0.00 placeholders for premiums.");
                return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }
            const { data, error } = await supabase
                .from('benefit2_rates')
                .select('plan_code, amount, per_year_periods')
                .eq('schedule_id', RATE_SCHEDULE_ID)
                .eq('tier', tier)
                .in('plan_code', planCodes);

            if (error) {
                console.error("Error fetching plan rates:", error);
                return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }
            const perPeriodRates = data.map(rate => ({
                plan_code: rate.plan_code,
                per_period_cost: parseFloat(rate.amount)
            }));
            return perPeriodRates;
        }

        async function fetchEmployeeDetails(username) {
            const { data: employee, error: empError } = await supabase
                .from('employees2025')
                .select('id, first_name, last_name, job_title, original_hire_date, username')
                .eq('username', username)
                .single();

            if (empError || !employee) return { employee: null, enrollment: null };

            const { data: enrollments, error: enrollError } = await supabase
                .from('benefit_enrollments')
                .select('tier_election, medical_plan, dental_plan, vision_plan, dependents, beneficiaries, spouse, signed_at')
                .eq('username', username)
                .order('created_at', { ascending: false })
                .limit(1);

            const enrollment = enrollments?.[0] || null;
            if (enrollError) console.error("Enrollment error:", enrollError);

            return { employee, enrollment };
        }

        async function fetchEmployeeData() {
            const { data, error } = await supabase
                .from('employees2025')
                .select(`
                    id,
                    first_name,
                    last_name,
                    username,
                    pin,
                    signed_pdf_url,
                    job_title
                `)
                .neq('signed_pdf_url', null);
            if (error) {
                console.error("Error fetching employee data:", error);
                document.getElementById("docBody").innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">ERROR: Could not connect to database or fetch employee list.</td></tr>`;
                return [];
            }
            const employees = data.map(e => ({
                id: e.id,
                first_name: e.first_name,
                last_name: e.last_name,
                username: e.username,
                pin: e.pin,
                signed_pdf_url: e.signed_pdf_url,
                job_title: e.job_title || 'N/A'
            }));
            const uniqueEmployees = Array.from(new Map(employees.map(item => [item.id, item])).values());
            employeeDataCache = uniqueEmployees;
            return uniqueEmployees;
        }

        async function fetchAuthorizedUsers() {
            authorizedUsersCache = AUTHORIZED_USERS;
            nextAuthUserId = authorizedUsersCache.reduce((max, user) => Math.max(max, user.id), 0) + 1;
            return authorizedUsersCache;
        }

        // --- REAL-TIME SUBSCRIPTION ---
        function unsubscribeFromDocs() {
            if (docSubscription) {
                supabase.removeChannel(docSubscription);
                docSubscription = null;
            }
        }

        async function subscribeToDocs() {
            unsubscribeFromDocs();
            await fetchEmployeeData();
            renderDocBody();
            docSubscription = supabase.channel('signed_documents')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'employees2025', filter: 'signed_pdf_url=neq.null' }, (payload) => {
                    console.log('Real-time change detected for signed document:', payload);
                    fetchEmployeeData().then(renderDocBody);
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') console.log('Real-time document feed active');
                    if (err) showAlert('Real-time error: Could not subscribe to document updates.', 'Error');
                });
        }

        // --- UTILITIES ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'USD' }).format(amount || 0);
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString(LOCALE);
        };

        const esc = (t) => String(t ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

        const formatTime = (date) => date.toLocaleString(LOCALE, {
            timeZone: TIMEZONE,
            year: 'numeric', month: 'numeric', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true
        });

        // Custom Modal Logic
        const fModal = document.getElementById('feedbackModal');
        const fTitle = document.getElementById('feedbackModalTitle');
        const fMessage = document.getElementById('feedbackModalMessage');
        const fInput = document.getElementById('feedbackModalPromptInput');
        const fButtons = document.getElementById('feedbackModalButtons');
        function showCustomModal(title, message, type = 'alert', promptPlaceholder = '') {
            return new Promise((resolve) => {
                fTitle.textContent = title;
                fMessage.innerHTML = message.replace(/\n/g, '<br>');
                fButtons.innerHTML = '';
                fInput.value = '';
                fInput.placeholder = promptPlaceholder;
                if (type === 'prompt') {
                    fInput.classList.remove('hidden');
                    fInput.focus();
                } else {
                    fInput.classList.add('hidden');
                }
                const setupButton = (text, className, action) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.className = `px-4 py-2 rounded-lg shadow-sm transition duration-150 ${className}`;
                    btn.onclick = () => {
                        fModal.classList.add('hidden');
                        action();
                    };
                    fButtons.appendChild(btn);
                };
                if (type === 'confirm' || type === 'prompt') {
                    setupButton('Cancel', 'bg-slate-800 hover:bg-slate-700 text-slate-100 border border-slate-600', () => resolve(type === 'confirm' ? false : null));
                }
                const primaryText = type === 'prompt' ? 'Select' : 'OK';
                setupButton(primaryText, 'accent-gold', () => {
                    if (type === 'prompt') {
                        resolve(fInput.value.trim());
                    } else {
                        resolve(type === 'confirm' ? true : true);
                    }
                });
                fModal.classList.remove('hidden');
            });
        }
        const showAlert = (message, title = 'Notification') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'alert');
        const showConfirm = (message, title = 'Confirm Action') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'confirm');
        const showPrompt = (message, title = 'Input Required') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'prompt', 'Enter selection...');

        const spinner = document.getElementById("spinnerOverlay");
        const showSpinner = () => spinner.classList.remove("hidden");
        const hideSpinner = () => spinner.classList.add("hidden");

        // --- TAB CONTROL ---
        const tabs = {
            docs: { button: document.getElementById("tabDocs"), section: document.getElementById("docsSection"), load: () => loadDocs() },
            summary: { button: document.getElementById("tabSummary"), section: document.getElementById("summarySection"), load: () => loadSummary() },
            logs: { button: document.getElementById("tabLogs"), section: document.getElementById("logsSection"), load: () => loadLogs() },
            users: { button: document.getElementById("tabUsers"), section: document.getElementById("usersSection"), load: () => loadUsers() }
        };

        function switchTab(tabKey) {
            unsubscribeFromDocs();
            Object.keys(tabs).forEach(key => {
                const tab = tabs[key];
                tab.button.classList.remove("accent-gold", "text-white");
                tab.button.classList.add("bg-gray-100", "text-gray-700");
                tab.section.classList.add("hidden");
            });

            const currentTab = tabs[tabKey];
            if (!currentTab) return;

            currentTab.button.classList.add("accent-gold", "text-white");
            currentTab.button.classList.remove("bg-gray-100", "text-gray-700");
            currentTab.section.classList.remove("hidden");
            currentTab.load();
        }

        document.getElementById("tabDocs").onclick = () => switchTab("docs");
        document.getElementById("tabSummary").onclick = () => currentUser.role === 'admin' ? switchTab("summary") : null;
        document.getElementById("tabLogs").onclick = () => currentUser.role === 'admin' ? switchTab("logs") : null;
        document.getElementById("tabUsers").onclick = () => currentUser.role === 'admin' ? switchTab("users") : null;

        // --- AUTHENTICATION & SESSION MANAGEMENT ---
        const loginScreen = document.getElementById("loginScreen");
        const dashboard = document.getElementById("dashboard");
        const closePrintView = document.getElementById("closePrintView");
        const loginBtn = document.getElementById("loginBtn");
        const usernameInput = document.getElementById("username");
        const pinInput = document.getElementById("pin");

        function handleLoginEnter(event) {
            if (event.key === "Enter") {
                event.preventDefault();
                loginBtn.click();
            }
        }
        usernameInput.addEventListener("keydown", handleLoginEnter);
        pinInput.addEventListener("keydown", handleLoginEnter);

        const logoutBtn = document.getElementById("logoutBtn");
        const loginError = document.getElementById("loginError");
        const printContainer = document.getElementById("printContainer");
        const portalRole = document.getElementById("portalRole");

        closePrintView.onclick = () => {
            document.getElementById("printView").classList.add("hidden");
            dashboard.classList.remove("hidden");
            document.getElementById("printContainerContent").innerHTML = '';
        };

        loginBtn.onclick = async () => {
            const u = document.getElementById("username").value.trim().toUpperCase();
            const p = document.getElementById("pin").value.trim();
            loginError.classList.add("hidden");
            showSpinner();
            await fetchAuthorizedUsers();
            const user = authorizedUsersCache.find(e => e.username === u && String(e.pin) === p && e.active);
            await fetchEmployeeData();
            const employeeRecord = employeeDataCache.find(e => e.username === u);
            if (user) {
                currentUser = { ...user, full_name: user.full_name, role: user.role || 'user' };
                if (employeeRecord) {
                    const { data: logData, error: logError } = await supabase
                        .from('portal_logs')
                        .insert([{ employee_id: employeeRecord.id, login_time: new Date().toISOString() }])
                        .select('id');
                    if (logError) {
                        console.error("Failed to record login to DB:", logError);
                        showAlert(`Login recorded, but DB log insert failed. Error: ${logError.message}`, "Log Error");
                    } else {
                        currentUser.log_id = logData[0].id;
                    }
                } else {
                    console.warn(`Employee record (and ID) not found for username ${u}. Cannot log access.`);
                }
                sessionStorage.setItem("auth_user", JSON.stringify(currentUser));
                showDashboard();
            } else {
                loginError.textContent = "Invalid username, PIN, or inactive account.";
                loginError.classList.remove("hidden");
            }
            hideSpinner();
        };

        logoutBtn.onclick = async () => {
            const user = currentUser;
            const logoutTime = new Date();
            if (user && user.log_id) {
                const { data: logEntry, error: fetchError } = await supabase
                    .from('portal_logs')
                    .select('login_time')
                    .eq('id', user.log_id)
                    .single();
                let durationMin = 0;
                if (!fetchError && logEntry && logEntry.login_time) {
                    const loginTime = new Date(logEntry.login_time);
                    const durationMs = logoutTime.getTime() - loginTime.getTime();
                    durationMin = Math.round(durationMs / (1000 * 60));
                } else {
                    console.warn("Could not retrieve login time for duration calculation.");
                }
                const { error: updateError } = await supabase
                    .from('portal_logs')
                    .update({
                        logout_time: logoutTime.toISOString(),
                        duration_minutes: durationMin
                    })
                    .eq('id', user.log_id);
                if (updateError) {
                    console.error("Failed to record manual logout/duration to DB:", updateError);
                    showAlert(`Error logging out session ID ${user.log_id}. See console for details.`, "Logout Failed");
                }
            }
            unsubscribeFromDocs();
            currentUser = null;
            sessionStorage.removeItem("auth_user");
            loginScreen.classList.remove("hidden");
            dashboard.classList.add("hidden");
            document.getElementById("username").value = '';
            document.getElementById("pin").value = '';
        };

        function updateHeaderKpis() {
            const signedEl = document.getElementById('kpiSignedEmployees');
            const yearEl = document.getElementById('kpiCurrentYear');
            const adminEl = document.getElementById('kpiActiveAdmins');
            const openEl = document.getElementById('kpiOpenSessions');

            if (signedEl) signedEl.textContent = employeeDataCache.length || 0;
            if (yearEl) yearEl.textContent = '2026';
            if (adminEl) adminEl.textContent = AUTHORIZED_USERS.filter(u => u.role === 'admin' && u.active).length;
            if (openEl) openEl.textContent = currentUser ? '1' : '0';
        }

        function showDashboard() {
            loginScreen.classList.add("hidden");
            dashboard.classList.remove("hidden");
            const isAdmin = currentUser.role === 'admin';
            const isJT = currentUser.username === 'JT';
            const roleLabel = isAdmin ? 'Administrator' : 'Standard User';
            if (portalRole) {
                portalRole.innerHTML = `
                    <span class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-400">Logged in as</span>
                    <span class="ml-2 font-semibold text-slate-50">${roleLabel}</span>
                    <span class="mx-1 text-slate-600">·</span>
                    <span class="text-slate-200">${esc(currentUser.username)}</span>
                `;
            }

            if (isAdmin) {
                tabs.summary.button.classList.remove("hidden");
                tabs.users.button.classList.remove("hidden");
                printContainer.classList.remove("hidden");
                if (isJT) {
                    tabs.logs.button.classList.add("hidden");
                    tabs.logs.section.classList.add("hidden");
                } else {
                    tabs.logs.button.classList.remove("hidden");
                }
            } else {
                tabs.summary.button.classList.add("hidden");
                tabs.users.button.classList.add("hidden");
                tabs.logs.button.classList.add("hidden");
                printContainer.classList.add("hidden");
            }
            updateHeaderKpis();
            switchTab("docs");
        }

        function recordLogout() {
            const user = currentUser || JSON.parse(sessionStorage.getItem("auth_user"));
            if (!user || !user.log_id) return;
            const logoutTime = new Date();
            const payload = {
                logout_time: logoutTime.toISOString(),
                duration_minutes: -1
            };
            const syncXhr = new XMLHttpRequest();
            syncXhr.open('PUT', `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${user.log_id}`, false);
            syncXhr.setRequestHeader('apikey', SUPABASE_KEY);
            syncXhr.setRequestHeader('Authorization', `Bearer ${SUPABASE_KEY}`);
            syncXhr.setRequestHeader('Content-Type', 'application/json');
            try {
                syncXhr.send(JSON.stringify(payload));
                console.log(`Synchronous auto-logout signal sent for ID: ${user.log_id}`);
            } catch (e) {
                console.error("Failed synchronous DB update on close:", e);
            }
            sessionStorage.removeItem("auth_user");
        }

        window.addEventListener('beforeunload', recordLogout);

        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showSpinner();
            fetchAuthorizedUsers().then(() => fetchEmployeeData().then(() => { showDashboard(); hideSpinner(); }));
        }

        // --- DATA LOADERS ---
        function loadDocs() {
            subscribeToDocs();
        }

        async function loadSummary() {
            const container = document.getElementById('summaryCardContainer');
            const searchInput = document.getElementById('employeeSearch');
            showSpinner();
            await fetchEmployeeData();
            hideSpinner();
            if (employeeDataCache.length === 0) {
                container.innerHTML = `<p class="text-red-400 text-center">No signed documents found. Cannot generate summary card.</p>`;
                return;
            }
            searchInput.oninput = () => renderEmployeeList(searchInput.value.toLowerCase());
            renderEmployeeList('');
            container.innerHTML = `<p class="text-slate-400 text-center">Select an employee from the list to view their detailed summary card.</p>`;
        }

        function renderEmployeeList(filterText) {
            const employeeListEl = document.getElementById('employeeList');
            employeeListEl.innerHTML = '';
            const activeUsername = employeeListEl.dataset.activeUsername || '';
            const filteredUsers = employeeDataCache.filter(u =>
                u.first_name.toLowerCase().includes(filterText) ||
                u.last_name.toLowerCase().includes(filterText) ||
                u.username.toLowerCase().includes(filterText)
            ).sort((a, b) => a.last_name.localeCompare(b.last_name));
            if (filteredUsers.length === 0) {
                employeeListEl.innerHTML = `<p class="text-slate-500 text-xs py-2">No employees match your search.</p>`;
                return;
            }
            filteredUsers.forEach(u => {
                const userButton = document.createElement('button');
                userButton.className = 'w-full text-left px-3 py-2 text-xs employee-pill transition duration-150';
                if (u.username === activeUsername) userButton.classList.add('employee-pill--active');
                userButton.textContent = `${u.last_name}, ${u.first_name} (${u.username})`;
                userButton.dataset.username = u.username;
                userButton.onclick = (ev) => handleEmployeeSelect(u.username, ev.currentTarget);
                employeeListEl.appendChild(userButton);
            });
        }

        async function handleEmployeeSelect(username, buttonEl) {
            const employeeListEl = document.getElementById('employeeList');
            employeeListEl.dataset.activeUsername = username;
            employeeListEl.querySelectorAll('button').forEach(btn => btn.classList.remove('employee-pill--active'));
            if (buttonEl) buttonEl.classList.add('employee-pill--active');

            const container = document.getElementById('summaryCardContainer');
            container.innerHTML = `
                <div class="flex flex-col items-center py-16">
                    <div class="spinner"></div>
                    <p class="mt-4 text-sm text-slate-400">Loading benefits data...</p>
                </div>`;
            showSpinner();
            const { employee, enrollment } = await fetchEmployeeDetails(username);

            if (!employee || !enrollment) {
                hideSpinner();
                container.innerHTML = `
                    <div class="p-6 text-center bg-yellow-950/60 rounded-xl border border-yellow-600/60 w-full">
                        <p class="font-semibold text-yellow-100">Employee data not fully available for ${esc(username)}.</p>
                        <p class="text-sm text-yellow-200 mt-1">Could not find employee record or completed enrollment form.</p>
                    </div>`;
                return;
            }

            const chosenPlans = [];
            if (enrollment.medical_plan && !enrollment.medical_plan.toUpperCase().includes('WAIVE') && enrollment.medical_plan.toUpperCase() !== 'NO') chosenPlans.push(enrollment.medical_plan);
            if (enrollment.dental_plan && !enrollment.dental_plan.toUpperCase().includes('WAIVE') && enrollment.dental_plan.toUpperCase() !== 'NO') chosenPlans.push(enrollment.dental_plan);
            if (enrollment.vision_plan && !enrollment.vision_plan.toUpperCase().includes('WAIVE') && enrollment.vision_plan.toUpperCase() !== 'NO') chosenPlans.push(enrollment.vision_plan);

            const rates = await fetchPlanRates(chosenPlans, enrollment.tier_election);
            renderSummaryCard(employee, enrollment, rates);
            hideSpinner();
        }

        function loadUsers() {
            if (currentUser.role !== 'admin') return;
            const userBody = document.getElementById("userBody");
            userBody.innerHTML = "";
            if (authorizedUsersCache.length === 0) {
                userBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-slate-500">No authorized users found</td></tr>`;
                return;
            }
            authorizedUsersCache.sort((a, b) => a.username.localeCompare(b.username)).forEach(u => {
                const roleLabel = u.role === 'admin' ? 'Administrator' : 'Standard';
                const roleChip = u.role === 'admin'
                    ? `<span class="inline-flex items-center gap-2 px-3 py-1 role-chip role-chip--admin"><i class="fa-regular fa-crown"></i><span>${roleLabel}</span></span>`
                    : `<span class="inline-flex items-center gap-2 px-3 py-1 role-chip role-chip--user"><i class="fa-regular fa-user"></i><span>${roleLabel}</span></span>`;
                const statusChip = u.active
                    ? `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-emerald-900/40 text-emerald-200 text-[0.7rem] border border-emerald-600/70"><span class="w-2 h-2 rounded-full bg-emerald-400"></span>Active</span>`
                    : `<span class="inline-flex items-center gap-1 px-2.5 py-1 rounded-full bg-red-900/40 text-red-200 text-[0.7rem] border border-red-600/70"><span class="w-2 h-2 rounded-full bg-red-400"></span>Inactive</span>`;

                userBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b border-slate-800 hover:bg-slate-900/60" data-id="${u.id}">
                        <td class="py-2.5 px-4 text-sm text-slate-100">${esc(u.full_name)}</td>
                        <td class="px-4 text-sm text-slate-200">${esc(u.username)}</td>
                        <td class="px-4 text-sm text-slate-300">
                            <span class="inline-flex items-center px-2 py-0.5 rounded-full bg-slate-900 border border-slate-700 text-[0.7rem] tracking-widest">${esc(u.pin)}</span>
                        </td>
                        <td class="px-4 text-sm">${roleChip}</td>
                        <td class="px-4 text-sm">${statusChip}</td>
                        <td class="px-4 text-sm space-x-3">
                            <button class="text-sky-300 hover:text-sky-100 js-edit inline-flex items-center gap-1 text-xs">
                                <i class="fa-regular fa-pen-to-square"></i><span>Edit</span>
                            </button>
                            <button class="text-red-400 hover:text-red-200 js-del inline-flex items-center gap-1 text-xs">
                                <i class="fa-regular fa-trash-can"></i><span>Delete</span>
                            </button>
                        </td>
                    </tr>
                `);
            });
        }

        function loadLogs() {
            if (currentUser.role !== 'admin') return;
            const logBody = document.getElementById("logBody");
            logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-slate-500">Fetching logs from database...</td></tr>`;
            supabase
                .from('portal_logs')
                .select(`
                    login_time,
                    logout_time,
                    duration_minutes,
                    employee_data:employee_id (username)
                `)
                .order('login_time', { ascending: false })
                .limit(50)
                .then(({ data: logData, error }) => {
                    if (error) {
                        console.error("DB Error fetching logs:", error);
                        logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-400">Error fetching logs from database. Check RLS policies.</td></tr>`;
                        return;
                    }
                    if (!logData || logData.length === 0) {
                        logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-slate-500">No logs available.</td></tr>`;
                        return;
                    }
                    logBody.innerHTML = "";
                    logData.forEach(l => {
                        const username = l.employee_data?.username || 'N/A';
                        const loginTimeCST = formatTime(new Date(l.login_time));
                        const logoutTimeCST = l.logout_time ? formatTime(new Date(l.logout_time)) : '<span class="text-emerald-400 font-semibold">Active</span>';
                        let durationDisplay = 'N/A';
                        if (l.logout_time) {
                            durationDisplay = (typeof l.duration_minutes === 'number' && l.duration_minutes >= 0)
                                ? `${l.duration_minutes} min`
                                : 'N/A';
                        } else {
                            durationDisplay = 'Active';
                        }
                        logBody.insertAdjacentHTML("beforeend", `
                            <tr class="border-b border-slate-800 hover:bg-slate-900/60">
                                <td class="py-2.5 px-4 text-sm text-slate-100">${esc(username)}</td>
                                <td class="px-4 text-sm text-slate-200">${esc(loginTimeCST)}</td>
                                <td class="px-4 text-sm text-slate-200">${logoutTimeCST}</td>
                                <td class="px-4 text-sm text-slate-100">${durationDisplay}</td>
                            </tr>
                        `);
                    });
                })
                .catch(e => {
                    console.error("Unknown error during log fetch:", e);
                    logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-400">Unknown client error occurred.</td></tr>`;
                });
        }

        // --- RENDERING FUNCTIONS ---
        function renderDocBody() {
            const docBody = document.getElementById("docBody");
            const countLabel = document.getElementById("signedCount");
            const last7Label = document.getElementById("signedLast7");
            const filterInput = document.getElementById("docSearch");
            const filterValue = (filterInput?.value || '').toLowerCase();

            let docs = employeeDataCache.filter(d => d.signed_pdf_url);
            if (filterValue) {
                docs = docs.filter(d =>
                    d.first_name.toLowerCase().includes(filterValue) ||
                    d.last_name.toLowerCase().includes(filterValue) ||
                    d.username.toLowerCase().includes(filterValue)
                );
            }

            const sortedDocs = docs.sort((a, b) => {
                const lastNameA = a.last_name.toLowerCase();
                const lastNameB = b.last_name.toLowerCase();
                if (lastNameA < lastNameB) return -1;
                if (lastNameA > lastNameB) return 1;
                const firstNameA = a.first_name.toLowerCase();
                const firstNameB = b.first_name.toLowerCase();
                if (firstNameA < firstNameB) return -1;
                if (firstNameA > firstNameB) return 1;
                return 0;
            });

            docBody.innerHTML = "";
            if (sortedDocs.length === 0) {
                docBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-slate-500">No signed documents available.</td></tr>`;
                if (countLabel) countLabel.textContent = "0";
                if (last7Label) last7Label.textContent = "—";
                return;
            }

            sortedDocs.forEach(d => {
                const docActions = d.signed_pdf_url ? `
                    <a href="${esc(d.signed_pdf_url)}" target="_blank" class="text-sky-300 hover:text-sky-100 mr-3 text-sm underline-offset-2 hover:underline">View PDF</a>
                    <button data-url="${esc(d.signed_pdf_url)}" class="text-slate-400 hover:text-slate-100 js-print text-sm" title="Print Document">
                        <i class="fa-solid fa-print"></i>
                    </button>
                ` : '<span class="text-slate-500 text-sm">N/A</span>';

                docBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b border-slate-800 last:border-b-0 hover:bg-slate-900/60">
                        <td class="py-2.5 px-4 text-sm text-slate-100">${esc(d.last_name)}</td>
                        <td class="px-4 text-sm text-slate-100">${esc(d.first_name)}</td>
                        <td class="px-4 text-sm text-slate-300">${esc(d.username)}</td>
                        <td class="px-4 text-sm">${docActions}</td>
                    </tr>
                `);
            });

            const signedCount = employeeDataCache.filter(d => d.signed_pdf_url).length;
            if (countLabel) countLabel.textContent = `${signedCount}`;
            if (last7Label) last7Label.textContent = "—";
            updateHeaderKpis();
        }

        // --- EXECUTIVE SUMMARY CARD (2025 vs 2026) ---
        async function renderSummaryCard(employee, enrollmentCurrent) {
            const container = document.getElementById('summaryCardContainer');
            container.innerHTML = `
                <div class="text-center py-20">
                    <div class="spinner mx-auto"></div>
                    <p class="mt-6 text-base text-slate-400">Loading benefit history...</p>
                </div>
            `;

            const yearsToShow = [2025, 2026];

            const { data: allEnrollments, error: enrollErr } = await supabase
                .from('benefit_enrollments')
                .select('*')
                .eq('username', employee.username)
                .in('benefit_year', yearsToShow)
                .order('benefit_year', { ascending: true });

            if (enrollErr) {
                console.error('Error loading enrollments:', enrollErr);
                container.innerHTML = `
                    <div class="p-6 text-center bg-red-950/70 rounded-xl border border-red-600/70 w-full">
                        <p class="font-semibold text-red-100">Could not load enrollment history.</p>
                        <p class="text-sm text-red-200 mt-1">Check benefit_enrollments table permissions (RLS) and try again.</p>
                    </div>`;
                return;
            }

            if (!allEnrollments || allEnrollments.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center bg-yellow-950/70 rounded-xl border border-yellow-600/70 w-full">
                        <p class="font-semibold text-yellow-100">No enrollment records found.</p>
                        <p class="text-sm text-yellow-200 mt-1">This employee does not have benefit elections on file for 2025 or 2026.</p>
                    </div>`;
                return;
            }

            const { data: rateRows, error: rateErr } = await supabase
                .from('benefit_rates')
                .select('*')
                .in('effective_year', yearsToShow);

            if (rateErr) {
                console.error('Error loading rates:', rateErr);
                container.innerHTML = `
                    <div class="p-6 text-center bg-red-950/70 rounded-xl border border-red-600/70 w-full">
                        <p class="font-semibold text-red-100">Could not load rate schedule.</p>
                        <p class="text-sm text-red-200 mt-1">Check benefit_rates table permissions (RLS) and try again.</p>
                    </div>`;
                return;
            }

            const planLabel = (code) => {
                if (!code || code === 'WAIVE') return 'Waived';
                const map = {
                    'ATBCB402': 'PPO / ATBCB402',
                    'ATBAB303': 'HMO / ATBAB303',
                    'ATBAP393': 'HMO HSA / ATBAP393',
                    'F_PLAN_2W': 'F-PLAN 2W / Base MAC',
                    'F_PLAN_3W': 'F-PLAN 3W / Buy Up MAC',
                    'PLAN_1': 'Vision Plan 1',
                };
                return map[code] || code;
            };

            const getRate = (plan, tier, type, year) => {
                if (!plan || plan === 'WAIVE') return 0;
                const r = rateRows.find(rt =>
                    String(rt.effective_year) === String(year) &&
                    rt.plan_code === plan &&
                    rt.tier === tier &&
                    (rt.coverage || '').toLowerCase() === type.toLowerCase()
                );
                return r ? parseFloat(r.amount) : 0;
            };

            const getCost = (enrollment, year) => {
                if (!enrollment) return { med: 0, den: 0, vis: 0, total: 0 };
                const med = getRate(enrollment.medical_plan, enrollment.tier_election, 'medical', year);
                const den = getRate(enrollment.dental_plan, enrollment.tier_election, 'dental', year);
                const vis = getRate(enrollment.vision_plan, enrollment.tier_election, 'vision', year);
                return { med, den, vis, total: med + den + vis };
            };

            const tierLabels = {
                EO: 'Employee Only',
                ES: 'Employee + Spouse',
                EC: 'Employee + Children',
                EF: 'Employee + Family',
            };

            const yearSummaries = yearsToShow.map(year => {
                const enrollment = allEnrollments.find(e => e.benefit_year === year);
                if (!enrollment) return null;
                const cost = getCost(enrollment, year);
                return { year, enrollment, cost };
            }).filter(Boolean);

            if (yearSummaries.length === 0) {
                container.innerHTML = `
                    <div class="p-6 text-center bg-yellow-950/70 rounded-xl border border-yellow-600/70 w-full">
                        <p class="font-semibold text-yellow-100">No benefit elections on file for 2025 or 2026.</p>
                    </div>`;
                return;
            }

            const hireDate = employee.original_hire_date ? formatDate(employee.original_hire_date) : 'N/A';
            const jobTitle = employee.job_title || 'Team Member';
            const lastFirst = `${(employee.last_name || '').toUpperCase()}, ${employee.first_name || ''}`;
            const maxTotal = Math.max(...yearSummaries.map(y => y.cost.total)) || 1;

            const cardsHtml = yearSummaries.map(summary => {
                const { year, enrollment, cost } = summary;
                const isCurrent = enrollmentCurrent && enrollmentCurrent.benefit_year === year;
                const borderClass = isCurrent
                    ? 'border-4 border-amber-500 shadow-2xl'
                    : 'border border-slate-800 shadow-xl';

                const tier = enrollment.tier_election || 'EO';
                const tierText = tierLabels[tier] || 'Coverage Tier';

                const medPct = maxTotal ? (cost.med / maxTotal) * 100 : 0;
                const denPct = maxTotal ? (cost.den / maxTotal) * 100 : 0;
                const visPct = maxTotal ? (cost.vis / maxTotal) * 100 : 0;

                return `
                    <div class="bg-slate-950 rounded-3xl ${borderClass} overflow-hidden flex flex-col">
                        <div class="bg-gradient-to-r from-slate-950 to-slate-900 text-white px-8 py-6 flex items-center justify-between">
                            <div class="text-left">
                                <p class="text-xs uppercase tracking-[0.25em] text-slate-400">Benefit Year</p>
                                <p class="text-3xl font-black">${year}</p>
                                ${isCurrent ? `<p class="mt-1 text-amber-400 font-semibold text-xs">Current Election</p>` : ''}
                            </div>
                            <div class="text-right">
                                <p class="text-[0.6rem] uppercase tracking-[0.25em] text-slate-400">Bi-Weekly Total</p>
                                <p class="text-3xl font-black text-emerald-400 mt-1">${formatCurrency(cost.total)}</p>
                                <p class="text-xs text-slate-300 mt-1">Annual: ${formatCurrency(cost.total * 26)}</p>
                            </div>
                        </div>

                        <div class="p-8 flex flex-col gap-6 flex-1">
                            <div class="inline-flex items-center gap-3 px-4 py-2 bg-slate-900 rounded-full border border-slate-700 w-fit">
                                <span class="text-[0.65rem] font-semibold tracking-[0.22em] text-slate-400 uppercase">Tier</span>
                                <span class="text-sm font-bold text-slate-50">${tier}</span>
                                <span class="text-xs text-slate-400">· ${tierText}</span>
                            </div>

                            <div class="grid grid-cols-1 lg:grid-cols-3 gap-5">
                                <div class="bg-gradient-to-br from-slate-950 to-blue-950 rounded-2xl p-5 border border-slate-800">
                                    <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-400">Medical</p>
                                    <p class="mt-2 text-sm font-semibold text-slate-50">${planLabel(enrollment.medical_plan)}</p>
                                    <p class="mt-4 text-2xl font-black text-emerald-400">${formatCurrency(cost.med)}</p>
                                    <p class="text-xs text-slate-400 mt-1">Bi-Weekly</p>
                                </div>

                                <div class="bg-gradient-to-br from-slate-950 to-teal-950 rounded-2xl p-5 border border-slate-800">
                                    <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-400">Dental</p>
                                    <p class="mt-2 text-sm font-semibold text-slate-50">${planLabel(enrollment.dental_plan)}</p>
                                    <p class="mt-4 text-2xl font-black text-emerald-400">${formatCurrency(cost.den)}</p>
                                    <p class="text-xs text-slate-400 mt-1">Bi-Weekly</p>
                                </div>

                                <div class="bg-gradient-to-br from-slate-950 to-purple-950 rounded-2xl p-5 border border-slate-800">
                                    <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-400">Vision</p>
                                    <p class="mt-2 text-sm font-semibold text-slate-50">${planLabel(enrollment.vision_plan)}</p>
                                    <p class="mt-4 text-2xl font-black text-emerald-400">${formatCurrency(cost.vis)}</p>
                                    <p class="text-xs text-slate-400 mt-1">Bi-Weekly</p>
                                </div>
                            </div>

                            <!-- Stacked cost bar -->
                            <div class="mt-4 space-y-3">
                                <div class="flex items-center justify-between text-[0.75rem] text-slate-400">
                                    <span>Cost composition · ${year}</span>
                                    <span>${formatCurrency(cost.total)} per pay period</span>
                                </div>
                                <div class="cost-bar-track">
                                    <div class="h-full flex">
                                        <div class="cost-bar-med" style="width:${medPct}%;"></div>
                                        <div class="cost-bar-den" style="width:${denPct}%;"></div>
                                        <div class="cost-bar-vis" style="width:${visPct}%;"></div>
                                    </div>
                                </div>
                                <div class="flex flex-wrap items-center gap-3 text-[0.65rem] text-slate-400 mt-1">
                                    <span class="inline-flex items-center gap-1">
                                        <span class="h-2 w-2 rounded-full cost-bar-med"></span> Medical
                                    </span>
                                    <span class="inline-flex items-center gap-1">
                                        <span class="h-2 w-2 rounded-full cost-bar-den"></span> Dental
                                    </span>
                                    <span class="inline-flex items-center gap-1">
                                        <span class="h-2 w-2 rounded-full cost-bar-vis"></span> Vision
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            let comparisonHtml = '';
            if (yearSummaries.length >= 2) {
                const sorted = [...yearSummaries].sort((a, b) => a.year - b.year);
                const first = sorted[0];
                const last = sorted[sorted.length - 1];
                const diff = last.cost.total - first.cost.total;
                const diffLabel = diff > 0 ? 'Increase in Bi-Weekly Deduction' :
                                  diff < 0 ? 'Savings per Pay Period' :
                                  'No Change vs Prior Year';
                const diffColor = diff > 0 ? 'text-red-400' : diff < 0 ? 'text-emerald-400' : 'text-slate-200';
                const sign = diff > 0 ? '+' : diff < 0 ? '−' : '';

                comparisonHtml = `
                    <div class="mt-12 bg-gradient-to-r from-slate-950 via-slate-900 to-slate-950 text-white rounded-3xl p-10 shadow-2xl border border-slate-800">
                        <p class="text-[0.65rem] uppercase tracking-[0.3em] text-slate-400 text-center">2025 → 2026 Comparison</p>
                        <p class="text-2xl md:text-3xl font-bold mt-3 text-center">${diffLabel}</p>
                        <p class="mt-6 text-5xl md:text-6xl font-black text-center ${diffColor}">
                            ${sign}${formatCurrency(Math.abs(diff))}
                        </p>
                        <p class="mt-4 text-xs md:text-sm text-slate-300 text-center">
                            Bi-weekly difference between ${first.year} and ${last.year}. Positive values indicate higher employee deduction; negative values indicate savings.
                        </p>
                    </div>
                `;
            }

            container.innerHTML = `
                <div class="max-w-6xl mx-auto space-y-10">
                    <!-- Employee header card -->
                    <div class="bg-slate-950 rounded-3xl shadow-xl border border-slate-800 p-8 flex flex-col md:flex-row md:items-center md:justify-between gap-6">
                        <div>
                            <p class="text-[0.65rem] uppercase tracking-[0.28em] text-slate-400 mb-2">
                                Employee Benefit Summary
                            </p>
                            <h2 class="text-2xl md:text-3xl font-black text-slate-50">
                                ${lastFirst}
                            </h2>
                            <p class="mt-2 text-sm text-slate-400">
                                ${jobTitle} · Username ${esc(employee.username)} · Hired ${hireDate}
                            </p>
                        </div>
                        <div class="flex flex-col items-start md:items-end gap-2">
                            <p class="text-[0.65rem] uppercase tracking-[0.28em] text-slate-400">
                                Years Displayed
                            </p>
                            <div class="inline-flex flex-wrap gap-2">
                                ${yearSummaries.map(y => `
                                    <span class="px-3 py-1 rounded-full text-xs font-semibold bg-slate-900 text-white border border-slate-700">
                                        ${y.year}
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    </div>

                    <!-- Side-by-side year cards -->
                    <div class="grid grid-cols-1 xl:grid-cols-2 gap-8">
                        ${cardsHtml}
                    </div>

                    <!-- Comparison block -->
                    ${comparisonHtml}
                </div>
            `;
        }

        // --- EVENT HANDLERS ---
        const docBodyEl = document.getElementById("docBody");
        docBodyEl.addEventListener("click", (e) => {
            if (e.target.classList.contains("js-print") || e.target.closest(".js-print")) {
                const btn = e.target.classList.contains("js-print") ? e.target : e.target.closest(".js-print");
                const url = btn.dataset.url;
                if (url) {
                    window.open(url, "_blank");
                    showAlert(`Print window opened for document: ${url.substring(url.lastIndexOf('/') + 1)}`, "Print Initiated");
                }
            }
        });

        const docSearchInput = document.getElementById("docSearch");
        if (docSearchInput) {
            docSearchInput.addEventListener("input", () => renderDocBody());
        }

        const printMenuBtn = document.getElementById("printMenuBtn");
        const printMenu = document.getElementById("printMenu");
        printMenuBtn.onclick = () => printMenu.classList.toggle("hidden");
        document.addEventListener("click", (e) => {
            if (!printMenu.contains(e.target) && e.target !== printMenuBtn) printMenu.classList.add("hidden");
        });

        document.getElementById("printAll").onclick = async () => {
            printMenu.classList.add("hidden");

            const docsToPrint = employeeDataCache.filter(d => d.signed_pdf_url);
            if (docsToPrint.length === 0) {
                return showAlert("No signed documents found to print.");
            }

            const employeeIds = docsToPrint.map(d => d.id);
            showSpinner();

            try {
                const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "apikey": SUPABASE_KEY,
                        "Authorization": `Bearer ${SUPABASE_KEY}`
                    },
                    body: JSON.stringify({ employee_ids: employeeIds })
                });

                if (!res.ok) {
                    const txt = await res.text();
                    console.error("merge-signed-pdfs error:", txt);
                    hideSpinner();
                    return showAlert("Error generating combined PDF. (Relies on deployed Supabase Edge function)", "Merge Failed");
                }

                const blob = await res.blob();
                const url = URL.createObjectURL(blob);
                window.open(url, "_blank");

                hideSpinner();
                showAlert(
                    "Combined PDF has been generated and opened in a new tab. Use your browser's Print function to print all pages at once.",
                    "Ready to Print"
                );
            } catch (e) {
                console.error("Unexpected error:", e);
                hideSpinner();
                showAlert("Unexpected error calling merge function. See console for details.", "Merge Failed");
            }
        };

        document.getElementById("printByEmployee").onclick = async () => {
            printMenu.classList.add("hidden");
            const docsWithPDFs = employeeDataCache.filter(d => d.signed_pdf_url);
            if (docsWithPDFs.length === 0) {
                return showAlert("No signed documents found.");
            }
            const choices = docsWithPDFs
                .map(d => `${d.last_name}, ${d.first_name} (${d.username})`)
                .sort();
            const choiceList = choices.map((c, i) => `[${i + 1}] ${c}`).join("\n");
            const selPrompt = `Select an employee by entering their name/username or the corresponding number.\n\n${choiceList}`;
            const selectedValue = await showPrompt(selPrompt, "Print by Employee");
            if (!selectedValue) return;
            let selectedUser;
            const index = parseInt(selectedValue);
            if (!isNaN(index) && index >= 1 && index <= choices.length) {
                selectedUser = choices[index - 1];
            } else {
                selectedUser = choices.find(c => c.toLowerCase().includes(selectedValue.toLowerCase()));
            }
            if (!selectedUser) {
                return showAlert("Invalid selection. Please enter a valid name/username or number from the list.");
            }
            const usernameMatch = selectedUser.match(/\((.*?)\)/);
            if (!usernameMatch) return showAlert("Internal error: Could not parse username.");
            const targetUsername = usernameMatch[1];
            const documentsToPrint = employeeDataCache.filter(d => d.username === targetUsername && d.signed_pdf_url);
            if (documentsToPrint.length === 0) {
                return showAlert(`No signed documents found for **${selectedUser}**.`);
            }
            documentsToPrint.forEach(d => window.open(d.signed_pdf_url, "_blank"));
            showAlert(`Opened ${documentsToPrint.length} document(s) for **${selectedUser}** in new tabs.`, "Print Initiated");
        };

        // --- USER CRUD LOGIC ---
        const userBodyEl = document.getElementById("userBody");
        userBodyEl.addEventListener("click", async (e) => {
            if (!currentUser || currentUser.role !== 'admin') return;
            const row = e.target.closest("tr[data-id]");
            if (!row) return;
            const id = parseInt(row.dataset.id);
            const user = authorizedUsersCache.find(u => u.id === id);
            if (!user) return;
            if (e.target.classList.contains("js-edit") || e.target.closest(".js-edit")) {
                openModal(user);
                return;
            }
            if (e.target.classList.contains("js-del") || e.target.closest(".js-del")) {
                const isConfirmed = await showConfirm(`Are you sure you want to delete the user: **${esc(user.full_name)} (${esc(user.username)})**?`);
                if (!isConfirmed) return;
                showSpinner();
                const index = AUTHORIZED_USERS.findIndex(u => u.id === id);
                if (index > -1) {
                    authorizedUsersCache.splice(index, 1);
                    AUTHORIZED_USERS.splice(index, 1);
                    showAlert(`User **${esc(user.full_name)}** deleted successfully. (Note: This change is not persistent)`, "User Deleted");
                }
                loadUsers();
                hideSpinner();
            }
        });

        const userModal = document.getElementById("userModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalFullName = document.getElementById("modalFullName");
        const modalUsername = document.getElementById("modalUsername");
        const modalPin = document.getElementById("modalPin");
        const modalRole = document.getElementById("modalRole");
        const modalActive = document.getElementById("modalActive");
        const modalCancel = document.getElementById("modalCancel");
        const modalSave = document.getElementById("modalSave");
        let editingId = null;

        document.getElementById("addUser").onclick = () => openModal(null);

        function openModal(user) {
            editingId = user ? user.id : null;
            modalTitle.textContent = editingId ? "Edit Authorized User" : "Add New Authorized User";
            modalFullName.value = user?.full_name || "";
            modalUsername.value = user?.username || "";
            modalPin.value = user?.pin || "";
            modalRole.value = user?.role || "user";
            modalActive.checked = user ? !!user.active : true;
            const isPg = user?.username === 'PG';
            modalUsername.disabled = isPg;
            modalRole.disabled = isPg;
            modalActive.disabled = isPg;
            userModal.classList.remove("hidden");
            modalFullName.focus();
        }

        modalCancel.onclick = () => userModal.classList.add("hidden");

        modalSave.onclick = async () => {
            if (!currentUser || currentUser.role !== 'admin') return;
            showSpinner();
            await new Promise(r => setTimeout(r, 200));
            const fullName = modalFullName.value.trim();
            const pinString = String(modalPin.value).trim();

            const payload = {
                full_name: fullName,
                username: modalUsername.value.trim().toUpperCase(),
                pin: pinString,
                role: modalRole.value,
                active: modalActive.checked,
            };

            if (!payload.username || !payload.pin || !fullName) {
                hideSpinner();
                return showAlert("All fields (Full Name, Username, PIN) are required.", "Input Error");
            }
            if (payload.pin.length !== 4 || isNaN(payload.pin)) {
                hideSpinner();
                return showAlert("PIN must be exactly 4 digits.", "Input Error");
            }

            let action = "Updated";
            if (editingId) {
                const index = AUTHORIZED_USERS.findIndex(u => u.id === editingId);
                if (index > -1) {
                    const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username && u.id !== editingId);
                    const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin && u.id !== editingId);
                    if (isUsernameTaken) {
                        hideSpinner();
                        return showAlert(`The username **${payload.username}** is already in use by another user.`, "Update Failed");
                    }
                    if (isPinTaken) {
                        hideSpinner();
                        return showAlert(`The PIN **${payload.pin}** is already in use by another user.`, "Update Failed");
                    }
                    AUTHORIZED_USERS[index] = { ...AUTHORIZED_USERS[index], ...payload };
                    authorizedUsersCache[index] = AUTHORIZED_USERS[index];
                }
            } else {
                action = "Created";
                const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username);
                const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin);
                if (isUsernameTaken) {
                    hideSpinner();
                    return showAlert(`The username **${payload.username}** is already in use.`, "Creation Failed");
                }
                if (isPinTaken) {
                    hideSpinner();
                    return showAlert(`The PIN **${payload.pin}** is already in use.`, "Creation Failed");
                }
                const newUser = {
                    id: nextAuthUserId++,
                    ...payload,
                    created_at: new Date().toISOString()
                };
                AUTHORIZED_USERS.push(newUser);
                authorizedUsersCache.push(newUser);
            }

            loadUsers();
            showAlert(`User **${esc(payload.username)}** ${action.toLowerCase()} successfully. (Note: Non-persistent change)`, `${action} Success`);
            hideSpinner();
            userModal.classList.add("hidden");
        };

        AUTHORIZED_USERS.forEach(u => {
            if (u.id >= nextAuthUserId) {
                nextAuthUserId = u.id + 1;
            }
        });
    </script>
</body>
</html>
