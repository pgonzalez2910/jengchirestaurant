<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Discipline Dashboard</title>

  <!-- Google Fonts: Inter + Poppins -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind Configuration -->
  <script>
    tailwind = window.tailwind || {};
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            heading: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            brand: {
              50: '#f1f8ff',
              100: '#e0f0ff',
              200: '#b9ddff',
              500: '#1d8fe3',
              600: '#0f74c4',
            },
          },
        },
      },
    };
  </script>

  <!-- Tailwind via CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" integrity="sha512-YcsIPQ2krqYJtX7J8zQJr0Iu7t5HTw9KpZUKxvJp+qAJiGc0i5vxuWZP+2R1RL3X9ppVbR2povVdR0QWm8Fv4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>
</head>
<body class="min-h-screen bg-gradient-to-b from-sky-50 via-slate-50 to-white text-slate-900 font-sans flex flex-col">
  <!-- Header -->
  <header class="sticky top-0 z-30 bg-white/80 backdrop-blur border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-4">
        <img
          src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
          alt="Jeng Chi Restaurant Logo"
          class="h-14 w-auto rounded-md shadow-sm bg-white object-contain border border-slate-200"
        />
        <div>
          <h1 class="text-xl sm:text-2xl font-heading font-semibold text-slate-900 tracking-tight">
            Jeng Chi HR Discipline Dashboard
          </h1>
          <p class="text-xs sm:text-sm text-slate-500">
            Centralized discipline tracking, corrective actions, and audit trail for Jeng Chi Restaurant.
          </p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span class="hidden sm:inline-flex items-center px-3 py-1 rounded-full bg-sky-50 text-sky-700 text-xs font-medium border border-sky-200">
          <i class="fa-solid fa-user-tie mr-1.5 text-xs"></i>
          HR Manager Console
        </span>
      </div>
    </div>
  </header>

  <!-- Main Content Wrapper -->
  <main class="flex-1">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 lg:py-10 space-y-6 lg:space-y-8">
      <!-- Horizontal Navigation Tabs -->
      <section class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm px-4 py-3 sm:py-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-3">
          <div>
            <h2 class="text-xs font-heading font-semibold text-slate-600 uppercase tracking-wide mb-1">
              Navigation
            </h2>
            <p class="text-[11px] text-slate-500">
              Use these steps to search, review, and document employee discipline across devices.
            </p>
          </div>
        </div>
        <div class="flex flex-wrap gap-2 sm:gap-3">
          <button
            id="nav-search"
            class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm rounded-full border border-sky-100 bg-sky-50 text-sky-800 font-medium hover:bg-sky-100 transition"
          >
            <i class="fa-solid fa-magnifying-glass text-xs sm:text-sm"></i>
            <span>Step 1 · Employee Search</span>
            <span class="hidden sm:inline text-[9px] uppercase tracking-wide ml-1">Start</span>
          </button>
          <button
            id="nav-profile"
            class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-id-badge text-xs sm:text-sm"></i>
            <span>Step 2 · Profile & Snapshot</span>
          </button>
          <button
            id="nav-history"
            class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-clipboard-list text-xs sm:text-sm"></i>
            <span>Step 3 · Documented History</span>
          </button>
          <button
            id="nav-new-action"
            class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-file-pen text-xs sm:text-sm"></i>
            <span>Step 4 · New Corrective Action</span>
          </button>
          <button
            id="nav-compliance"
            class="inline-flex items-center gap-2 px-3 sm:px-4 py-2 text-xs sm:text-sm rounded-full border border-slate-200 bg-white text-slate-700 hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-scale-balanced text-xs sm:text-sm"></i>
            <span>Compliance Notes</span>
          </button>
        </div>
      </section>

      <!-- STEP 1: Employee Search -->
      <section id="employee-search-section" class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
        <div class="flex items-center justify-between gap-2 mb-4">
          <div>
            <h2 class="text-sm sm:text-base font-heading font-semibold text-slate-900">
              Step 1 · Employee Search
            </h2>
            <p class="text-xs sm:text-sm text-slate-500">
              Choose how you want to search, start typing the employee name, and select from the suggestions or run a full search.
            </p>
          </div>
        </div>

        <div class="space-y-3">
          <div class="grid grid-cols-1 sm:grid-cols-[minmax(0,0.9fr),minmax(0,1.1fr),auto,auto] gap-2 sm:gap-3">
            <div>
              <label for="searchType" class="block text-xs font-medium text-slate-700 mb-1">
                Search By
              </label>
              <select
                id="searchType"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              >
                <option value="name">Name (first or last)</option>
                <option value="last_name">Last Name only</option>
              </select>
            </div>
            <div id="searchTermWrapper" class="relative">
              <label for="searchTerm" class="block text-xs font-medium text-slate-700 mb-1">
                Employee Name
              </label>
              <input
                id="searchTerm"
                type="text"
                placeholder="Start typing employee name to see suggestions..."
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              />
              <div
                id="autocompleteList"
                class="hidden absolute z-20 mt-1 w-full rounded-xl border border-slate-200 bg-white shadow-lg max-h-56 overflow-auto"
              ></div>
            </div>
            <div class="flex items-end">
              <button
                id="searchBtn"
                class="w-full inline-flex items-center justify-center rounded-xl bg-brand-500 hover:bg-brand-600 text-white text-sm font-medium px-3 py-2 shadow-sm transition"
              >
                <i class="fa-solid fa-magnifying-glass mr-1.5 text-xs"></i>
                Search
              </button>
            </div>
            <div class="flex items-end">
              <button
                id="clearSearchBtn"
                class="w-full inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-700 text-sm font-medium px-3 py-2 shadow-sm transition"
              >
                <i class="fa-solid fa-eraser mr-1.5 text-xs"></i>
                Clear
              </button>
            </div>
          </div>
          <p id="searchStatus" class="text-xs text-slate-500 min-h-[1.25rem]">
            Start typing a name to see suggestions, or click <span class="font-medium text-slate-700">Search</span> for a full result list.
          </p>
        </div>

        <!-- Search Results Table -->
        <div class="mt-5 border-t border-slate-100 pt-4">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-xs font-semibold text-slate-700 uppercase tracking-wide">
              Search Results
            </h3>
          </div>
          <div class="overflow-x-auto rounded-xl border border-slate-200 bg-slate-50/60">
            <table class="min-w-full text-left text-xs sm:text-sm">
              <thead class="bg-slate-100 text-slate-600 text-[11px] sm:text-xs uppercase tracking-wide">
                <tr>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Employee</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Role / Position</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Hire Date</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Status</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Warnings</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Terminations</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold text-right">Profile</th>
                </tr>
              </thead>
              <tbody id="searchResultsBody" class="divide-y divide-slate-100 text-slate-700">
                <tr id="searchResultsEmptyRow">
                  <td colspan="7" class="px-4 py-4 text-center text-xs text-slate-400 italic">
                    No employees loaded yet. Use the fields above to search and select an employee.
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- STEP 2: Executive Employee Profile -->
      <section id="employee-profile-section" class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h2 class="text-sm sm:text-base font-heading font-semibold text-slate-900">
              Step 2 · Executive Employee Profile
            </h2>
            <p class="text-xs sm:text-sm text-slate-500">
              Once an employee is selected, review their core employment details and discipline snapshot.
            </p>
          </div>
          <div class="flex flex-wrap gap-2">
            <span
              id="selectedEmployeeBadge"
              class="inline-flex items-center px-3 py-1 rounded-full bg-slate-50 border border-slate-200 text-[11px] text-slate-600"
            >
              <span class="w-1.5 h-1.5 rounded-full bg-slate-300 mr-2"></span>
              No employee selected
            </span>
          </div>
        </div>

        <div class="grid grid-cols-1 xl:grid-cols-[minmax(0,1.1fr),minmax(0,1.4fr)] gap-5 lg:gap-6">
          <!-- Profile Card -->
          <div class="bg-slate-50/70 border border-slate-200 rounded-2xl p-4 sm:p-5 flex flex-col gap-4">
            <div class="flex items-start gap-4">
              <div
                class="flex-shrink-0 w-14 h-14 sm:w-16 sm:h-16 rounded-2xl bg-gradient-to-br from-sky-200 to-sky-400 text-white flex items-center justify-center text-xl sm:text-2xl font-semibold"
                id="profileInitials"
              >
                --
              </div>
              <div class="flex-1 space-y-1">
                <div class="flex flex-wrap items-center gap-x-2 gap-y-1">
                  <h3 id="profileName" class="text-base sm:text-lg font-heading font-semibold text-slate-900">
                    Select an employee from Step 1
                  </h3>
                  <span
                    id="profileStatusPill"
                    class="inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-600 border border-slate-200"
                  >
                    Status: —
                  </span>
                </div>
                <p id="profilePosition" class="text-xs sm:text-sm text-slate-600">
                  Position will appear here after selection.
                </p>
                <div class="flex flex-wrap gap-3 mt-1 text-[11px] text-slate-500">
                  <span id="profileId" class="inline-flex items-center gap-1">
                    <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                    Employee ID: —
                  </span>
                  <span id="profileHireDate" class="inline-flex items-center gap-1">
                    <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                    Hire Date: —
                  </span>
                  <span id="profileReportTo" class="inline-flex items-center gap-1">
                    <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                    Reports To: —
                  </span>
                  <span id="profileHrWitness" class="inline-flex items-center gap-1">
                    <span class="h-1 w-1 rounded-full bg-slate-300"></span>
                    HR Witness: —
                  </span>
                </div>
              </div>
            </div>
            <div class="text-[11px] text-slate-500 leading-snug">
              This profile card is a high-level snapshot. For a full audit trail, review the
              <span class="font-semibold text-slate-700">Documented History</span> panel below.
            </div>
          </div>

          <!-- Snapshot Metrics -->
          <div class="bg-slate-50/70 border border-slate-200 rounded-2xl p-4 sm:p-5 space-y-4">
            <div class="flex items-center justify-between gap-2">
              <h3 class="text-xs font-semibold text-slate-700 uppercase tracking-wide">
                Discipline Snapshot
              </h3>
            </div>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
              <div class="rounded-2xl border border-sky-100 bg-white px-3 py-3 flex flex-col gap-1 shadow-sm">
                <p class="text-[11px] font-medium text-slate-500">Written Warnings</p>
                <p id="metricWritten" class="text-xl font-semibold text-sky-700">0</p>
                <p class="text-[11px] text-slate-400">
                  Logged written warnings on file.
                </p>
              </div>
              <div class="rounded-2xl border border-amber-100 bg-white px-3 py-3 flex flex-col gap-1 shadow-sm">
                <p class="text-[11px] font-medium text-slate-500">Final Warnings</p>
                <p id="metricFinal" class="text-xl font-semibold text-amber-700">0</p>
                <p class="text-[11px] text-slate-400">
                  Final step warnings prior to termination.
                </p>
              </div>
              <div class="rounded-2xl border border-rose-100 bg-white px-3 py-3 flex flex-col gap-1 shadow-sm">
                <p class="text-[11px] font-medium text-slate-500">Termination Letters</p>
                <p id="metricTermination" class="text-xl font-semibold text-rose-700">0</p>
                <p class="text-[11px] text-slate-400">
                  Documented terminations issued for this record.
                </p>
              </div>
            </div>

            <div class="mt-3 border-t border-slate-100 pt-3">
              <p class="text-xs font-semibold text-slate-700 mb-1">
                Last Disciplinary Action
              </p>
              <div id="lastActionContainer" class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 text-xs">
                <div class="flex flex-wrap gap-x-4 gap-y-1 text-slate-600">
                  <span id="lastActionType">No actions recorded yet.</span>
                  <span id="lastActionDate"></span>
                  <span id="lastActionManager"></span>
                </div>
                <div class="text-[11px] text-slate-400">
                  Most recent entry from the discipline history.
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- STEP 3: Documented History (Audit Trail) -->
      <section id="employee-history-section" class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h2 class="text-sm sm:text-base font-heading font-semibold text-slate-900">
              Step 3 · Documented History (Audit Trail)
            </h2>
            <p class="text-xs sm:text-sm text-slate-500">
              View the full record of verbal warnings, written warnings, final warnings, and termination actions for the selected employee.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <span class="hidden sm:inline text-[11px] text-slate-400">
              Sorted by most recent incident date.
            </span>
          </div>
        </div>

        <div id="historyEmptyState" class="rounded-2xl border border-dashed border-slate-200 bg-slate-50/60 px-4 py-6 text-center text-xs text-slate-500">
          No recorded actions for this employee. Once a corrective action is saved in
          <span class="font-medium text-slate-700">Step 4</span>, it will appear in this audit trail.
        </div>

        <div id="historyTableWrapper" class="hidden mt-1">
          <div class="overflow-x-auto rounded-xl border border-slate-200 bg-slate-50/60">
            <table class="min-w-full text-left text-xs sm:text-sm">
              <thead class="bg-slate-100 text-slate-600 text-[11px] sm:text-xs uppercase tracking-wide">
                <tr>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Date</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Action Type</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Policy Area</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Summary</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Manager</th>
                  <th class="px-3 sm:px-4 py-2 font-semibold">Follow-up</th>
                </tr>
              </thead>
              <tbody id="historyTableBody" class="divide-y divide-slate-100 text-slate-700">
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- STEP 4: Record New Corrective Action -->
      <section id="new-action-section" class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
          <div>
            <h2 class="text-sm sm:text-base font-heading font-semibold text-slate-900">
              Step 4 · Record New Corrective Action
            </h2>
            <p class="text-xs sm:text-sm text-slate-500">
              Complete this form to log a new verbal warning, written warning, final warning, or termination notice and attach it to the employee’s record.
            </p>
          </div>
          <div class="rounded-full border border-amber-100 bg-amber-50 px-3 py-1 text-[11px] text-amber-700">
            <i class="fa-solid fa-triangle-exclamation mr-1.5"></i>
            Ensure the correct employee is selected before saving.
          </div>
        </div>

        <form id="newActionForm" class="space-y-5">
          <!-- Row 1 -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="actionType" class="block text-xs font-medium text-slate-700 mb-1">
                Action Type <span class="text-rose-500">*</span>
              </label>
              <select
                id="actionType"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              >
                <option value="">Select an action type</option>
                <option value="VERBAL_WARNING">Verbal Warning</option>
                <option value="WRITTEN_WARNING">Written Warning</option>
                <option value="FINAL_WARNING">Final Warning</option>
                <option value="TERMINATION">Final Termination</option>
              </select>
            </div>
            <div>
              <label for="incidentDate" class="block text-xs font-medium text-slate-700 mb-1">
                Incident Date <span class="text-rose-500">*</span>
              </label>
              <input
                id="incidentDate"
                type="date"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              />
            </div>
            <div>
              <label for="policyArea" class="block text-xs font-medium text-slate-700 mb-1">
                Policy Area (optional)
              </label>
              <select
                id="policyArea"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              >
                <option value="">Select policy area</option>
                <option value="Attendance & Punctuality">Attendance &amp; Punctuality</option>
                <option value="Conduct / Workplace Behavior">Conduct / Workplace Behavior</option>
                <option value="Harassment / Discrimination">Harassment / Discrimination</option>
                <option value="Safety / OSHA / TWC">Safety / OSHA / TWC</option>
                <option value="Wage & Hour / DOL">Wage &amp; Hour / DOL</option>
                <option value="Performance / Quality of Work">Performance / Quality of Work</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!-- Row 2: Description & Corrective Plan -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label for="incidentDescription" class="block text-xs font-medium text-slate-700 mb-1">
                Description of Incident <span class="text-rose-500">*</span>
              </label>
              <textarea
                id="incidentDescription"
                rows="4"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
                placeholder="Describe what occurred, including dates, witnesses, and any prior related conversations."
              ></textarea>
            </div>
            <div>
              <label for="correctivePlan" class="block text-xs font-medium text-slate-700 mb-1">
                Corrective Action Plan (required for Written/Final/Termination)
              </label>
              <textarea
                id="correctivePlan"
                rows="4"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
                placeholder="Outline expectations, performance standards, timelines, and consequences if improvement is not achieved. Optional for verbal warnings."
              ></textarea>
            </div>
          </div>

          <!-- Row 3: Follow-Up / Names -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div>
              <label for="followUpDate" class="block text-xs font-medium text-slate-700 mb-1">
                Follow-up Review Date (optional)
              </label>
              <input
                id="followUpDate"
                type="date"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
              />
            </div>
            <div>
              <label for="managerName" class="block text-xs font-medium text-slate-700 mb-1">
                Manager / Supervisor Name <span class="text-rose-500">*</span>
              </label>
              <input
                id="managerName"
                type="text"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
                placeholder="Manager responsible for this action"
              />
            </div>
            <div>
              <label for="hrWitness" class="block text-xs font-medium text-slate-700 mb-1">
                HR Witness
              </label>
              <input
                id="hrWitness"
                type="text"
                class="block w-full rounded-xl border-slate-200 bg-slate-50 focus:bg-white py-2 px-3 text-sm text-slate-900 shadow-inner focus:outline-none focus:ring-2 focus:ring-brand-200 focus:border-brand-400"
                placeholder="HR witness for this action"
              />
            </div>
          </div>

          <!-- Acknowledgments & Notes -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50/80 px-3 py-3">
              <label class="flex items-start gap-2 text-xs text-slate-700">
                <input
                  id="ackPolicyProvided"
                  type="checkbox"
                  class="mt-0.5 rounded border-slate-300 text-brand-500 focus:ring-brand-200"
                />
                <span>
                  Employee has been provided access to the Employee Handbook and applicable
                  <span class="font-medium">DOL/TWC postings</span> related to this corrective action.
                </span>
              </label>
              <p class="text-[11px] text-slate-400">
                This confirms the employee knows what policies apply to this situation.
              </p>
            </div>
            <div class="space-y-2 rounded-2xl border border-slate-200 bg-slate-50/80 px-3 py-3 text-xs text-slate-700">
              <p class="font-semibold text-slate-800">
                Documentation Notes
              </p>
              <p class="text-justify">
                For verbal warnings, use this form as a log of the coaching conversation. Summarize key points in the
                description and retain any additional notes or statements in the employee file.
              </p>
              <p class="text-[11px] text-slate-400 text-justify">
                Written employee statements can be collected separately and attached to the file when appropriate.
              </p>
            </div>
          </div>

          <!-- Actions -->
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 pt-3 border-t border-slate-100">
            <div class="flex flex-wrap gap-2">
              <button
                id="saveActionBtn"
                type="button"
                class="inline-flex items-center justify-center rounded-xl bg-brand-500 hover:bg-brand-600 text-white text-sm font-medium px-4 py-2.5 shadow-sm transition"
              >
                <i class="fa-solid fa-floppy-disk mr-1.5 text-xs"></i>
                Save to Employee Record (employees2025)
              </button>
              <button
                id="generatePdfBtn"
                type="button"
                class="inline-flex items-center justify-center rounded-xl border border-slate-200 bg-white hover:bg-slate-50 text-slate-800 text-sm font-medium px-4 py-2.5 shadow-sm transition"
              >
                <i class="fa-solid fa-file-pdf mr-1.5 text-xs"></i>
                Generate PDF for Signature
              </button>
            </div>
            <p class="text-[11px] text-slate-400">
              Saving updates the counts and history in <span class="font-medium">employees2025</span>. PDF output can be printed or digitally signed.
            </p>
          </div>
        </form>
      </section>

      <!-- Compliance Notes Section -->
      <section id="compliance-section" class="bg-white/95 border border-slate-200 rounded-2xl shadow-sm p-5 sm:p-6">
        <div class="flex items-center justify-between gap-2 mb-4">
          <div>
            <h2 class="text-sm sm:text-base font-heading font-semibold text-slate-900">
              Compliance Notes (Reference Only)
            </h2>
            <p class="text-xs sm:text-sm text-slate-500">
              These notes support consistent, compliant discipline practices. They are informational and not legal advice.
            </p>
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 lg:gap-6">
          <div class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50/80 px-4 py-4 text-xs text-slate-700">
            <h3 class="text-xs font-semibold text-slate-800">
              At-Will Employment &amp; Documentation
            </h3>
            <p class="text-justify">
              Corrective action forms serve as documentation only and do <span class="font-semibold">not</span> change
              the at-will employment relationship. Employment may be ended at any time, with or without cause, in
              accordance with company policy and applicable law.
            </p>
            <p class="text-justify">
              Keep all discipline records, including PDFs and written statements, in secure HR files with access
              limited to authorized managers and HR personnel.
            </p>
            <p class="text-[11px] text-slate-400 text-justify">
              When in doubt, slow down, document the facts, and escalate for review.
            </p>
          </div>
          <div class="space-y-3 rounded-2xl border border-slate-200 bg-slate-50/80 px-4 py-4 text-xs text-slate-700">
            <h3 class="text-xs font-semibold text-slate-800">
              TWC, DOL, and Consistent Application
            </h3>
            <p class="text-justify">
              Managers should be mindful of guidance from the
              <span class="font-medium">Texas Workforce Commission (TWC)</span> and the
              <span class="font-medium">U.S. Department of Labor (DOL)</span>, especially for wage &amp; hour, safety,
              and protected leave matters. This dashboard is a tool to organize information, not legal advice.
            </p>
            <p class="text-justify">
              Apply policies consistently across employees in similar roles and situations. Inconsistent discipline can
              raise risk in unemployment claims or other proceedings.
            </p>
            <p class="text-justify">
              For complex or sensitive situations (e.g., harassment, discrimination, medical issues, or potential
              retaliation), consult ownership and, where appropriate, outside legal counsel before final action.
            </p>
          </div>
        </div>
      </section>
    </div>
  </main>

  <!-- Disclaimer Footer -->
  <footer class="border-t border-slate-200 bg-white/90 mt-4">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-2">
      <p class="text-[11px] text-slate-500 text-justify">
        This dashboard is an internal Human Resources tool for Jeng Chi Restaurant. It is intended for authorized HR and
        management personnel only and is provided for documentation and record-keeping purposes. Nothing within this
        system should be interpreted as legal advice or as creating a contract of employment. All employment remains
        at-will, consistent with applicable law and the Jeng Chi Employee Handbook.
      </p>
      <p class="text-[11px] text-slate-400 sm:text-right">
        &copy; <span id="footerYear"></span> Jeng Chi Restaurant. All rights reserved.
      </p>
    </div>
  </footer>

  <!-- Hidden PDF Template -->
  <div id="pdf-template" class="hidden fixed inset-0 z-50 flex items-start justify-center overflow-auto bg-white px-6 py-8 text-slate-900">
    <div class="w-full max-w-3xl mx-auto border border-slate-200 rounded-xl px-8 py-6 text-sm leading-relaxed">
      <div class="flex items-start justify-between gap-4 mb-4">
        <div>
          <h1 class="text-lg font-heading font-semibold text-slate-900">
            Jeng Chi Restaurant – Human Resources
          </h1>
          <p class="text-xs text-slate-600">
            Corrective Action Notice
          </p>
        </div>
        <div class="text-right text-xs text-slate-600">
          <p><span class="font-medium">Today’s Date:</span> <span id="pdfTodayDate">—</span></p>
          <p><span class="font-medium">Location:</span> Richardson, Texas</p>
        </div>
      </div>

      <hr class="border-slate-200 my-3" />

      <!-- Employee Details -->
      <div class="mb-4">
        <h2 class="text-sm font-semibold text-slate-800 mb-1">Employee Information</h2>
        <div class="grid grid-cols-2 gap-2 text-xs">
          <p><span class="font-medium">Employee Name:</span> <span id="pdfEmployeeName">—</span></p>
          <p><span class="font-medium">Employee ID:</span> <span id="pdfEmployeeId">—</span></p>
          <p><span class="font-medium">Position / Job Title:</span> <span id="pdfEmployeePosition">—</span></p>
          <p><span class="font-medium">Employment Status:</span> <span id="pdfEmployeeStatus">—</span></p>
          <p><span class="font-medium">Reports To:</span> <span id="pdfReportsTo">—</span></p>
        </div>
      </div>

      <hr class="border-slate-200 my-3" />

      <!-- Incident Details -->
      <div class="mb-4">
        <h2 class="text-sm font-semibold text-slate-800 mb-1">Incident &amp; Corrective Action</h2>
        <div class="grid grid-cols-2 gap-2 text-xs mb-2">
          <p><span class="font-medium">Action Type:</span> <span id="pdfActionType">—</span></p>
          <p><span class="font-medium">Incident Date:</span> <span id="pdfIncidentDate">—</span></p>
          <p><span class="font-medium">Policy Area:</span> <span id="pdfPolicyArea">—</span></p>
          <p><span class="font-medium">Follow-up Review Date:</span> <span id="pdfFollowUpDate">—</span></p>
        </div>
        <div class="mb-2">
          <p class="text-xs font-medium text-slate-800 mb-1">Description of Incident</p>
          <p id="pdfIncidentDescription" class="text-xs text-slate-700 whitespace-pre-line">
          </p>
        </div>
        <div>
          <p class="text-xs font-medium text-slate-800 mb-1">Corrective Action Plan / Notes</p>
          <p id="pdfCorrectivePlan" class="text-xs text-slate-700 whitespace-pre-line">
          </p>
        </div>
      </div>

      <hr class="border-slate-200 my-3" />

      <!-- Manager & HR -->
      <div class="mb-4 text-xs">
        <p><span class="font-medium">Manager / Supervisor:</span> <span id="pdfManagerName">—</span></p>
        <p><span class="font-medium">HR Witness:</span> <span id="pdfHrWitness">—</span></p>
      </div>

      <!-- Acknowledgment -->
      <div class="mb-4 text-xs">
        <h2 class="text-sm font-semibold text-slate-800 mb-1">Acknowledgments</h2>
        <p>
          <span class="font-medium">Handbook &amp; DOL/TWC Postings Provided:</span>
          <span id="pdfAckPolicyProvided">—</span>
        </p>
        <p class="mt-2 text-[11px] text-slate-500">
          This notice is intended to document expectations and standards. It does not alter the at-will employment
          relationship. Employment may be ended at any time, with or without cause, consistent with company policy and applicable law.
        </p>
      </div>

      <hr class="border-slate-200 my-3" />

      <!-- Signatures -->
      <div class="grid grid-cols-1 gap-6 mt-4 text-xs">
        <div>
          <div class="h-10 border-b border-slate-300 mb-1"></div>
          <p class="text-slate-700">Employee Signature</p>
          <p class="text-[11px] text-slate-500">Acknowledges receipt of this notice (not agreement).</p>
          <p class="mt-1 text-slate-700">
            Date: ___________________________
          </p>
        </div>
        <div>
          <div class="h-10 border-b border-slate-300 mb-1"></div>
          <p class="text-slate-700">Manager / HR Signature</p>
          <p class="mt-1 text-slate-700">
            Date: ___________________________
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Supabase & App Logic -->
  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;

    let currentEmployee = null;
    let currentDisciplineHistory = [];
    let autocompleteTimeout = null;

    const actionTypeLabels = {
      VERBAL_WARNING: "Verbal Warning",
      WRITTEN_WARNING: "Written Warning",
      FINAL_WARNING: "Final Warning",
      TERMINATION: "Final Termination",
    };

    function scrollToSection(id) {
      const el = document.getElementById(id);
      if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start" });
      }
    }

    function formatDate(dateStr) {
      if (!dateStr) return "—";
      const d = new Date(dateStr);
      if (Number.isNaN(d.getTime())) return dateStr;
      return d.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function truncateText(text, maxLength) {
      if (!text) return "";
      if (text.length <= maxLength) return text;
      return text.slice(0, maxLength - 1) + "…";
    }

    function populateManagerAndWitnessFromEmployee() {
      const managerEl = document.getElementById("managerName");
      const hrWitnessEl = document.getElementById("hrWitness");
      if (!managerEl && !hrWitnessEl) return;

      const reportTo = (currentEmployee && currentEmployee.report_to) || "";
      const witnessDefault =
        (currentEmployee && currentEmployee.hr_witness) || reportTo || "";

      if (managerEl) managerEl.value = reportTo;
      if (hrWitnessEl) hrWitnessEl.value = witnessDefault;
    }

    function renderEmployeeProfile() {
      const initialsEl = document.getElementById("profileInitials");
      const nameEl = document.getElementById("profileName");
      const positionEl = document.getElementById("profilePosition");
      const idEl = document.getElementById("profileId");
      const hireDateEl = document.getElementById("profileHireDate");
      const reportToEl = document.getElementById("profileReportTo");
      const hrWitnessProfileEl = document.getElementById("profileHrWitness");
      const statusPillEl = document.getElementById("profileStatusPill");
      const selectedBadgeEl = document.getElementById("selectedEmployeeBadge");

      const metricWrittenEl = document.getElementById("metricWritten");
      const metricFinalEl = document.getElementById("metricFinal");
      const metricTerminationEl = document.getElementById("metricTermination");

      const lastActionTypeEl = document.getElementById("lastActionType");
      const lastActionDateEl = document.getElementById("lastActionDate");
      const lastActionManagerEl = document.getElementById("lastActionManager");

      if (!currentEmployee) {
        initialsEl.textContent = "--";
        nameEl.textContent = "Select an employee from Step 1";
        positionEl.textContent = "Position will appear here after selection.";
        idEl.textContent = "Employee ID: —";
        hireDateEl.textContent = "Hire Date: —";
        reportToEl.textContent = "Reports To: —";
        hrWitnessProfileEl.textContent = "HR Witness: —";

        statusPillEl.textContent = "Status: —";
        statusPillEl.className =
          "inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-600 border border-slate-200";

        selectedBadgeEl.innerHTML =
          '<span class="w-1.5 h-1.5 rounded-full bg-slate-300 mr-2"></span>No employee selected';

        metricWrittenEl.textContent = "0";
        metricFinalEl.textContent = "0";
        metricTerminationEl.textContent = "0";

        lastActionTypeEl.textContent = "No actions recorded yet.";
        lastActionDateEl.textContent = "";
        lastActionManagerEl.textContent = "";
        return;
      }

      const firstName = currentEmployee.first_name || "";
      const lastName = currentEmployee.last_name || "";
      const fullName = `${firstName} ${lastName}`.trim() || "Employee";

      const initials =
        (firstName?.[0] || "").toUpperCase() +
        (lastName?.[0] || "").toUpperCase();

      const position =
        currentEmployee.position || currentEmployee.job_title || "—";
      const hireDate =
        currentEmployee.original_hire_date || currentEmployee.hire_date;
      const employmentStatus = currentEmployee.employment_status || "Unknown";
      const reportTo = currentEmployee.report_to || "—";
      const hrWitness =
        currentEmployee.hr_witness || currentEmployee.report_to || "—";

      const disciplinaryWarningCount =
        Number(currentEmployee.disciplinary_warning_count || 0);
      const finalWarningCount =
        Number(currentEmployee.final_warning_count || 0);
      const terminationLetterCount =
        Number(currentEmployee.termination_letter_count || 0);

      initialsEl.textContent = initials || "--";
      nameEl.textContent = fullName;
      positionEl.textContent = position;
      idEl.textContent = `Employee ID: ${currentEmployee.employee_id ?? "—"}`;
      hireDateEl.textContent = `Hire Date: ${formatDate(hireDate)}`;
      reportToEl.textContent = `Reports To: ${reportTo}`;
      hrWitnessProfileEl.textContent = `HR Witness: ${hrWitness}`;

      const isActive =
        typeof employmentStatus === "string" &&
        employmentStatus.toLowerCase() === "active";

      if (isActive) {
        statusPillEl.textContent = `Status: ${employmentStatus}`;
        statusPillEl.className =
          "inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-emerald-50 text-emerald-700 border border-emerald-100";
      } else {
        statusPillEl.textContent = `Status: ${employmentStatus}`;
        statusPillEl.className =
          "inline-flex items-center px-2.5 py-0.5 rounded-full text-[11px] font-medium bg-slate-100 text-slate-700 border border-slate-200";
      }

      selectedBadgeEl.innerHTML = `
        <span class="w-1.5 h-1.5 rounded-full ${
          isActive ? "bg-emerald-400" : "bg-slate-400"
        } mr-2"></span>
        Selected: <span class="font-semibold ml-1">${fullName}</span>
      `;

      metricWrittenEl.textContent = String(disciplinaryWarningCount);
      metricFinalEl.textContent = String(finalWarningCount);
      metricTerminationEl.textContent = String(terminationLetterCount);

      const lastAction = currentEmployee.last_disciplinary_action || null;
      if (!lastAction) {
        lastActionTypeEl.textContent = "No actions recorded yet.";
        lastActionDateEl.textContent = "";
        lastActionManagerEl.textContent = "";
      } else {
        const typeLabel =
          actionTypeLabels[lastAction.action_type] ||
          lastAction.action_type ||
          "Action";
        lastActionTypeEl.textContent = `Type: ${typeLabel}`;
        lastActionDateEl.textContent = `Date: ${formatDate(
          lastAction.incident_date || lastAction.created_at
        )}`;
        if (lastAction.manager_name) {
          lastActionManagerEl.textContent = `Manager: ${lastAction.manager_name}`;
        } else {
          lastActionManagerEl.textContent = "";
        }
      }

      populateManagerAndWitnessFromEmployee();
    }

    function renderHistoryTable() {
      const emptyStateEl = document.getElementById("historyEmptyState");
      const tableWrapperEl = document.getElementById("historyTableWrapper");
      const bodyEl = document.getElementById("historyTableBody");

      if (!currentEmployee || !currentDisciplineHistory.length) {
        emptyStateEl.classList.remove("hidden");
        tableWrapperEl.classList.add("hidden");
        bodyEl.innerHTML = "";
        return;
      }

      emptyStateEl.classList.add("hidden");
      tableWrapperEl.classList.remove("hidden");

      const sorted = [...currentDisciplineHistory].sort((a, b) => {
        const aDate = a.incident_date || a.created_at;
        const bDate = b.incident_date || b.created_at;
        return new Date(bDate || 0) - new Date(aDate || 0);
      });

      bodyEl.innerHTML = "";

      sorted.forEach((action) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-100/80 transition";

        const typeLabel =
          actionTypeLabels[action.action_type] || action.action_type || "Action";

        const followUp = action.follow_up_date
          ? formatDate(action.follow_up_date)
          : "—";

        tr.innerHTML = `
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-slate-700">
            ${formatDate(action.incident_date || action.created_at)}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${
              action.action_type === "TERMINATION"
                ? "bg-rose-50 text-rose-700 border border-rose-100"
                : action.action_type === "FINAL_WARNING"
                ? "bg-amber-50 text-amber-700 border border-amber-100"
                : action.action_type === "WRITTEN_WARNING"
                ? "bg-sky-50 text-sky-700 border border-sky-100"
                : action.action_type === "VERBAL_WARNING"
                ? "bg-slate-50 text-slate-700 border border-slate-200"
                : "bg-slate-50 text-slate-700 border border-slate-200"
            }">
              ${typeLabel}
            </span>
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-slate-700">
            ${action.policy_area || "—"}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top text-slate-700">
            ${truncateText(action.incident_description || "", 90)}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-slate-700">
            ${action.manager_name || "—"}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-slate-700">
            ${followUp}
          </td>
        `;
        bodyEl.appendChild(tr);
      });
    }

    function loadEmployee(employee) {
      currentEmployee = employee || null;
      const history =
        employee && Array.isArray(employee.discipline_history)
          ? employee.discipline_history
          : employee && employee.discipline_history
          ? employee.discipline_history
          : [];
      currentDisciplineHistory = Array.isArray(history) ? history : [];

      renderEmployeeProfile();
      renderHistoryTable();
      scrollToSection("employee-profile-section");
    }

    function renderSearchResults(data, updateStatus = true) {
      const resultsBody = document.getElementById("searchResultsBody");
      const searchStatusEl = document.getElementById("searchStatus");
      const emptyRow = document.getElementById("searchResultsEmptyRow");
      if (emptyRow) emptyRow.remove?.();

      if (!data || !data.length) {
        if (updateStatus) {
          searchStatusEl.textContent = "No employees found for the given name.";
        }
        resultsBody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-xs text-slate-400 italic">
              No matching employees in employees2025.
            </td>
          </tr>
        `;
        return;
      }

      if (updateStatus) {
        searchStatusEl.textContent = `Found ${data.length} employee${
          data.length !== 1 ? "s" : ""
        }. Click a row or “Open Profile” to view details.`;
      }

      resultsBody.innerHTML = "";

      data.forEach((employee) => {
        const tr = document.createElement("tr");
        tr.className =
          "cursor-pointer hover:bg-slate-100/80 transition";

        const firstName = employee.first_name || "";
        const lastName = employee.last_name || "";
        const fullName = `${firstName} ${lastName}`.trim() || "Employee";

        const position =
          employee.position || employee.job_title || "—";
        const employmentStatus = employee.employment_status || "Unknown";
        const hireDate =
          employee.original_hire_date || employee.hire_date;

        const disciplinaryWarningCount =
          Number(employee.disciplinary_warning_count || 0);
        const finalWarningCount =
          Number(employee.final_warning_count || 0);
        const terminationLetterCount =
          Number(employee.termination_letter_count || 0);

        const statusPillClass =
          typeof employmentStatus === "string" &&
          employmentStatus.toLowerCase() === "active"
            ? "bg-emerald-50 text-emerald-700 border border-emerald-100"
            : "bg-slate-100 text-slate-700 border border-slate-200";

        tr.innerHTML = `
          <td class="px-3 sm:px-4 py-2 align-top">
            <div class="text-sm font-medium text-slate-900">${fullName}</div>
            <div class="text-[11px] text-slate-500">ID: ${
              employee.employee_id ?? "—"
            }</div>
          </td>
          <td class="px-3 sm:px-4 py-2 align-top text-sm text-slate-700 whitespace-nowrap">
            ${position}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-sm text-slate-700">
            ${formatDate(hireDate)}
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${statusPillClass}">
              ${employmentStatus}
            </span>
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-sm text-slate-700">
            <div class="flex flex-col gap-0.5">
              <span class="inline-flex items-center gap-1 text-[11px] text-slate-700">
                <span class="w-1.5 h-1.5 rounded-full bg-sky-400"></span>
                Written: <span class="font-semibold">${disciplinaryWarningCount}</span>
              </span>
              <span class="inline-flex items-center gap-1 text-[11px] text-amber-700">
                <span class="w-1.5 h-1.5 rounded-full bg-amber-400"></span>
                Final: <span class="font-semibold">${finalWarningCount}</span>
              </span>
            </div>
          </td>
          <td class="px-3 sm:px-4 py-2 align-top whitespace-nowrap text-sm text-slate-700">
            <span class="inline-flex items-center gap-1 text-[11px] text-rose-700">
              <span class="w-1.5 h-1.5 rounded-full bg-rose-400"></span>
              ${terminationLetterCount}
            </span>
          </td>
          <td class="px-3 sm:px-4 py-2 align-top text-right">
            <button
              type="button"
              class="inline-flex items-center justify-center rounded-lg border border-slate-200 bg-white hover:bg-slate-50 text-xs font-medium text-slate-800 px-3 py-1.5 shadow-sm"
            >
              Open Profile
            </button>
          </td>
        `;

        tr.addEventListener("click", () => loadEmployee(employee));
        const button = tr.querySelector("button");
        if (button) {
          button.addEventListener("click", (ev) => {
            ev.stopPropagation();
            loadEmployee(employee);
          });
        }

        resultsBody.appendChild(tr);
      });
    }

    async function handleSearch() {
      const searchTermInput = document.getElementById("searchTerm");
      const searchTypeSelect = document.getElementById("searchType");
      const searchStatusEl = document.getElementById("searchStatus");
      const resultsBody = document.getElementById("searchResultsBody");

      const term = (searchTermInput.value || "").trim();
      const searchType = searchTypeSelect.value;

      if (!term) {
        alert("Please enter a name to search.");
        return;
      }

      searchStatusEl.textContent = "Searching employees in employees2025...";
      resultsBody.innerHTML = "";

      let query = supabaseClient.from("employees2025").select("*");

      if (searchType === "name") {
        query = query.or(
          `first_name.ilike.%${term}%,last_name.ilike.%${term}%`
        );
      } else if (searchType === "last_name") {
        query = query.ilike("last_name", `%${term}%`);
      }

      const { data, error } = await query;

      if (error) {
        console.error("Search error:", error);
        searchStatusEl.textContent =
          "An error occurred while searching. Please try again.";
        resultsBody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-xs text-rose-500">
              Error searching employees. Check console for details.
            </td>
          </tr>
        `;
        return;
      }

      renderSearchResults(data, true);
    }

    function clearAutocomplete() {
      const autocompleteList = document.getElementById("autocompleteList");
      if (!autocompleteList) return;
      autocompleteList.innerHTML = "";
      autocompleteList.classList.add("hidden");
    }

    async function handleAutocomplete() {
      const searchTermInput = document.getElementById("searchTerm");
      const searchTypeSelect = document.getElementById("searchType");
      const autocompleteList = document.getElementById("autocompleteList");
      const searchStatusEl = document.getElementById("searchStatus");

      if (!searchTermInput || !searchTypeSelect || !autocompleteList) return;

      const term = (searchTermInput.value || "").trim();
      const searchType = searchTypeSelect.value;

      if (term.length < 2) {
        clearAutocomplete();
        searchStatusEl.textContent =
          "Type at least two letters of the employee name to see suggestions.";
        return;
      }

      searchStatusEl.textContent = "Loading name suggestions...";

      let query = supabaseClient.from("employees2025").select("*").limit(10);

      if (searchType === "name") {
        query = query.or(
          `first_name.ilike.%${term}%,last_name.ilike.%${term}%`
        );
      } else if (searchType === "last_name") {
        query = query.ilike("last_name", `%${term}%`);
      }

      const { data, error } = await query;

      if (error) {
        console.error("Autocomplete error:", error);
        clearAutocomplete();
        searchStatusEl.textContent =
          "An error occurred while loading suggestions.";
        return;
      }

      if (!data || !data.length) {
        clearAutocomplete();
        searchStatusEl.textContent = "No employees match the typed name.";
        return;
      }

      autocompleteList.innerHTML = "";
      data.forEach((emp) => {
        const firstName = emp.first_name || "";
        const lastName = emp.last_name || "";
        const fullName = `${firstName} ${lastName}`.trim() || "Employee";
        const position = emp.position || emp.job_title || "—";

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "w-full text-left px-3 py-2 hover:bg-slate-100 focus:bg-slate-100 focus:outline-none flex items-center justify-between gap-3 text-xs text-slate-700";
        btn.innerHTML = `
          <span>
            <span class="font-medium text-slate-900">${fullName}</span>
            <span class="block text-[11px] text-slate-500">
              ID: ${emp.employee_id ?? "—"} • ${position}
            </span>
          </span>
        `;
        btn.addEventListener("click", () => {
          searchTermInput.value = fullName;
          clearAutocomplete();
          loadEmployee(emp);
          searchStatusEl.textContent =
            "Employee loaded from suggestions. Review profile and history below.";
          renderSearchResults([emp], false);
        });

        autocompleteList.appendChild(btn);
      });

      autocompleteList.classList.remove("hidden");
      searchStatusEl.textContent =
        "Select an employee from the suggestions or run a full search.";
    }

    function clearSearch() {
      const searchTermInput = document.getElementById("searchTerm");
      const searchStatusEl = document.getElementById("searchStatus");
      const resultsBody = document.getElementById("searchResultsBody");

      searchTermInput.value = "";
      clearAutocomplete();
      searchStatusEl.textContent =
        "Start typing a name to see suggestions, or click Search for a full result list.";
      resultsBody.innerHTML = `
        <tr id="searchResultsEmptyRow">
          <td colspan="7" class="px-4 py-4 text-center text-xs text-slate-400 italic">
            No employees loaded yet. Use the fields above to search and select an employee.
          </td>
        </tr>
      `;
    }

    async function handleSaveAction() {
      if (!currentEmployee) {
        alert(
          "Please select an employee in Step 1 before saving a corrective action."
        );
        return;
      }

      const actionTypeEl = document.getElementById("actionType");
      const incidentDateEl = document.getElementById("incidentDate");
      const policyAreaEl = document.getElementById("policyArea");
      const incidentDescriptionEl =
        document.getElementById("incidentDescription");
      const correctivePlanEl = document.getElementById("correctivePlan");
      const followUpDateEl = document.getElementById("followUpDate");
      const managerNameEl = document.getElementById("managerName");
      const hrWitnessEl = document.getElementById("hrWitness");
      const ackPolicyProvidedEl =
        document.getElementById("ackPolicyProvided");

      const action_type = actionTypeEl.value;
      const incident_date = incidentDateEl.value;
      const policy_area = policyAreaEl.value || null;
      const incident_description = incidentDescriptionEl.value.trim();
      const corrective_plan = correctivePlanEl.value.trim();
      const follow_up_date = followUpDateEl.value || null;
      const manager_name = managerNameEl.value.trim();
      const hr_witness = hrWitnessEl.value.trim() || null;
      const ack_policy_provided = !!ackPolicyProvidedEl.checked;

      const missing = [];

      if (!action_type) missing.push("Action Type");
      if (!incident_date) missing.push("Incident Date");
      if (!incident_description)
        missing.push("Description of Incident");
      if (action_type !== "VERBAL_WARNING" && !corrective_plan)
        missing.push("Corrective Action Plan");
      if (!manager_name) missing.push("Manager / Supervisor Name");

      if (missing.length) {
        alert(
          "Please complete the following required fields before saving:\n\n- " +
            missing.join("\n- ")
        );
        return;
      }

      const actionRecord = {
        action_type,
        incident_date,
        policy_area,
        incident_description,
        corrective_plan: corrective_plan || null,
        follow_up_date,
        manager_name,
        hr_witness,
        ack_policy_provided,
        created_at: new Date().toISOString(),
      };

      const history = Array.isArray(currentDisciplineHistory)
        ? [...currentDisciplineHistory]
        : [];

      history.push(actionRecord);

      let written =
        Number(currentEmployee.disciplinary_warning_count || 0);
      let final =
        Number(currentEmployee.final_warning_count || 0);
      let termination =
        Number(currentEmployee.termination_letter_count || 0);

      if (action_type === "WRITTEN_WARNING") {
        written += 1;
      } else if (action_type === "FINAL_WARNING") {
        final += 1;
      } else if (action_type === "TERMINATION") {
        termination += 1;
      }

      const employeeId = currentEmployee.employee_id;

      const updatePayload = {
        disciplinary_warning_count: written,
        final_warning_count: final,
        termination_letter_count: termination,
        last_disciplinary_action: actionRecord,
        discipline_history: history,
        hr_witness,
      };

      const { data, error } = await supabaseClient
        .from("employees2025")
        .update(updatePayload)
        .eq("employee_id", employeeId)
        .select()
        .single();

      if (error) {
        console.error("Error updating employees2025:", error);
        alert(
          "An error occurred while saving the corrective action. Please check the console and try again."
        );
        return;
      }

      currentEmployee = data || {
        ...currentEmployee,
        ...updatePayload,
      };
      currentDisciplineHistory =
        (data && data.discipline_history) || history;

      renderEmployeeProfile();
      renderHistoryTable();

      const form = document.getElementById("newActionForm");
      form.reset();
      populateManagerAndWitnessFromEmployee();

      alert("Corrective action saved to employees2025.");
    }

    function handleGeneratePdf() {
      if (!currentEmployee) {
        alert(
          "Please select an employee in Step 1 before generating a PDF."
        );
        return;
      }

      const actionTypeEl = document.getElementById("actionType");
      const incidentDateEl = document.getElementById("incidentDate");
      const policyAreaEl = document.getElementById("policyArea");
      const incidentDescriptionEl =
        document.getElementById("incidentDescription");
      const correctivePlanEl = document.getElementById("correctivePlan");
      const followUpDateEl = document.getElementById("followUpDate");
      const managerNameEl = document.getElementById("managerName");
      const hrWitnessEl = document.getElementById("hrWitness");
      const ackPolicyProvidedEl =
        document.getElementById("ackPolicyProvided");

      const action_type = actionTypeEl.value;
      const incident_date = incidentDateEl.value;
      const incident_description = incidentDescriptionEl.value.trim();
      const corrective_plan = correctivePlanEl.value.trim();
      const policy_area = policyAreaEl.value || "—";
      const follow_up_date = followUpDateEl.value || "—";
      const manager_name = managerNameEl.value.trim() || "—";
      const hr_witness = hrWitnessEl.value.trim() || "—";
      const ack_policy_provided = !!ackPolicyProvidedEl.checked;

      const missing = [];

      if (!action_type) missing.push("Action Type");
      if (!incident_date) missing.push("Incident Date");
      if (!incident_description)
        missing.push("Description of Incident");
      if (action_type !== "VERBAL_WARNING" && !corrective_plan)
        missing.push("Corrective Action Plan");
      if (!managerNameEl.value.trim())
        missing.push("Manager / Supervisor Name");

      if (missing.length) {
        alert(
          "Please complete the following required fields before generating a PDF:\n\n- " +
            missing.join("\n- ")
        );
        return;
      }

      const pdfTodayDateEl = document.getElementById("pdfTodayDate");
      const pdfEmployeeNameEl =
        document.getElementById("pdfEmployeeName");
      const pdfEmployeeIdEl = document.getElementById("pdfEmployeeId");
      const pdfEmployeePositionEl =
        document.getElementById("pdfEmployeePosition");
      const pdfEmployeeStatusEl =
        document.getElementById("pdfEmployeeStatus");
      const pdfReportsToEl =
        document.getElementById("pdfReportsTo");
      const pdfActionTypeEl = document.getElementById("pdfActionType");
      const pdfIncidentDateEl =
        document.getElementById("pdfIncidentDate");
      const pdfPolicyAreaEl = document.getElementById("pdfPolicyArea");
      const pdfFollowUpDateEl =
        document.getElementById("pdfFollowUpDate");
      const pdfIncidentDescriptionEl =
        document.getElementById("pdfIncidentDescription");
      const pdfCorrectivePlanEl =
        document.getElementById("pdfCorrectivePlan");
      const pdfManagerNameEl =
        document.getElementById("pdfManagerName");
      const pdfHrWitnessEl =
        document.getElementById("pdfHrWitness");
      const pdfAckPolicyProvidedEl =
        document.getElementById("pdfAckPolicyProvided");

      const firstName = currentEmployee.first_name || "";
      const lastName = currentEmployee.last_name || "";
      const fullName =
        `${firstName} ${lastName}`.trim() || "Employee";

      const position =
        currentEmployee.position || currentEmployee.job_title || "—";
      const employmentStatus =
        currentEmployee.employment_status || "Unknown";
      const reportsTo = currentEmployee.report_to || "—";

      pdfTodayDateEl.textContent = formatDate(new Date().toISOString());
      pdfEmployeeNameEl.textContent = fullName;
      pdfEmployeeIdEl.textContent =
        currentEmployee.employee_id ?? "—";
      pdfEmployeePositionEl.textContent = position;
      pdfEmployeeStatusEl.textContent = employmentStatus;
      pdfReportsToEl.textContent = reportsTo;

      const typeLabel =
        actionTypeLabels[action_type] || action_type || "Action";

      pdfActionTypeEl.textContent = typeLabel;
      pdfIncidentDateEl.textContent = formatDate(incident_date);
      pdfPolicyAreaEl.textContent = policy_area || "—";
      pdfFollowUpDateEl.textContent =
        follow_up_date === "—" ? "—" : formatDate(follow_up_date);

      pdfIncidentDescriptionEl.textContent = incident_description;
      pdfCorrectivePlanEl.textContent = corrective_plan;

      pdfManagerNameEl.textContent = manager_name || "—";
      pdfHrWitnessEl.textContent = hr_witness || "—";

      pdfAckPolicyProvidedEl.textContent = ack_policy_provided
        ? "Yes"
        : "No";

      const pdfContainer = document.getElementById("pdf-template");
      pdfContainer.classList.remove("hidden");

      const fileName =
        "JengChi_Corrective_Action_" +
        fullName.replace(/\s+/g, "_") +
        ".pdf";

      const opt = {
        margin: 0.5,
        filename: fileName,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2 },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
      };

      const worker = (window.html2pdf || html2pdf)()
        .set(opt)
        .from(pdfContainer)
        .save();

      worker
        .then(() => {
          pdfContainer.classList.add("hidden");
        })
        .catch((e) => {
          console.error("PDF generation error:", e);
          pdfContainer.classList.add("hidden");
          alert(
            "An error occurred while generating the PDF. Please check the console and try again."
          );
        });
    }

    document.addEventListener("DOMContentLoaded", () => {
      // Footer year
      const footerYearEl = document.getElementById("footerYear");
      if (footerYearEl) {
        footerYearEl.textContent = new Date().getFullYear();
      }

      // Navigation
      const navSearch = document.getElementById("nav-search");
      const navProfile = document.getElementById("nav-profile");
      const navHistory = document.getElementById("nav-history");
      const navNewAction = document.getElementById("nav-new-action");
      const navCompliance = document.getElementById("nav-compliance");

      navSearch?.addEventListener("click", () =>
        scrollToSection("employee-search-section")
      );
      navProfile?.addEventListener("click", () =>
        scrollToSection("employee-profile-section")
      );
      navHistory?.addEventListener("click", () =>
        scrollToSection("employee-history-section")
      );
      navNewAction?.addEventListener("click", () =>
        scrollToSection("new-action-section")
      );
      navCompliance?.addEventListener("click", () =>
        scrollToSection("compliance-section")
      );

      // Search buttons
      const searchBtn = document.getElementById("searchBtn");
      const clearSearchBtn =
        document.getElementById("clearSearchBtn");
      searchBtn?.addEventListener("click", () => {
        handleSearch();
      });
      clearSearchBtn?.addEventListener("click", () => {
        clearSearch();
      });

      // Autocomplete typing
      const searchTermInput = document.getElementById("searchTerm");
      const searchTermWrapper =
        document.getElementById("searchTermWrapper");
      searchTermInput?.addEventListener("input", () => {
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(handleAutocomplete, 220);
      });
      document.addEventListener("click", (event) => {
        if (
          searchTermWrapper &&
          !searchTermWrapper.contains(event.target)
        ) {
          clearAutocomplete();
        }
      });

      // Save Action
      const saveActionBtn = document.getElementById("saveActionBtn");
      saveActionBtn?.addEventListener("click", () => {
        handleSaveAction();
      });

      // Generate PDF
      const generatePdfBtn =
        document.getElementById("generatePdfBtn");
      generatePdfBtn?.addEventListener("click", () => {
        handleGeneratePdf();
      });

      // Initial rendering
      renderEmployeeProfile();
      renderHistoryTable();
      clearSearch();
      populateManagerAndWitnessFromEmployee();
    });
  </script>

  
</body>
</html>
