<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Enterprise Portal</title>

  <!-- GOOGLE FONTS -->
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Manrope:wght@300;400;500;600;700&display=swap" rel="stylesheet" />

  <!-- TAILWIND CONFIG (CDN MODE) -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            heading: ["Cinzel", "serif"],
            body: ["Manrope", "system-ui", "sans-serif"],
          },
          colors: {
            brand: {
              red: "#7a1f1f",
              red_light: "#a63a3a",
              gold: "#d4b171",
              gold_light: "#e8d3a4",
            },
          },
        },
      },
    };
  </script>

  <!-- TAILWIND VIA CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- FONT AWESOME -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    xintegrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />

  <!-- html2pdf -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.48.0/dist/umd/supabase.js"></script>

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- SheetJS (XLSX) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- BASE STYLES (NO @apply) -->
  <style>
    body {
      font-family: "Manrope", system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #f9fafb;
    }

    /* Enterprise Components */
    .card {
        border-radius: 1.5rem;
        border: 1px solid #e5e7eb;
        background-color: #ffffff;
        box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
    }
    .input-premium {
      width: 100%;
      border-radius: 0.75rem;
      border: 1px solid #d1d5db;
      background-color: #f9fafb;
      padding: 0.75rem 1rem;
      font-size: 0.875rem;
      transition: all 0.2s;
      outline: none;
    }
    .input-premium:focus {
      border-color: #7a1f1f;
      box-shadow: 0 0 0 3px rgba(122, 31, 31, 0.2);
      background-color: #ffffff;
    }
    .btn-primary {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1.5rem;
      border-radius: 0.75rem;
      background-color: #7a1f1f;
      color: #ffffff;
      font-weight: 600;
      font-size: 0.875rem;
      box-shadow: 0 4px 10px rgba(122, 31, 31, 0.2);
      transition: background-color 0.15s ease, box-shadow 0.15s ease;
    }
    .btn-primary:hover {
      background-color: #a63a3a;
      box-shadow: 0 6px 14px rgba(122, 31, 31, 0.3);
    }


    /* Sidebar Styles */
    .sidebar-link {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      padding: 0.75rem 1.25rem;
      font-size: 0.875rem;
      font-weight: 500;
      color: #475569;
      border-radius: 0.75rem;
      transition: background-color 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
      width: 100%;
      text-align: left;
    }

    .sidebar-link i {
      color: #7a1f1f;
    }

    .sidebar-link:hover {
      background-color: #e5e7eb;
    }

    .sidebar-active {
      background-color: #7a1f1f;
      color: #ffffff;
      box-shadow: 0 6px 14px rgba(0, 0, 0, 0.15);
    }

    .sidebar-active i {
      color: #ffffff;
    }
  </style>
</head>

<body class="h-full flex bg-slate-50">

  <!-- ========================================== -->
  <!-- FIXED ENTERPRISE SIDEBAR -->
  <!-- ========================================== -->
  <!-- ========================================== -->
<!-- FIXED ENTERPRISE SIDEBAR -->
<!-- ========================================== -->
<!-- ========================================== -->
<!-- FIXED ENTERPRISE SIDEBAR -->
<!-- ========================================== -->
<aside class="w-60 fixed top-0 left-0 h-full bg-white border-r border-slate-200 z-40 flex flex-col">
  <!-- Logo only -->
  <div class="px-5 py-6 flex justify-center border-b border-slate-200">
    <img
      src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
      class="h-24 w-auto"
      alt="Jeng Chi Logo"
    />
  </div>

  <!-- NAVIGATION LINKS -->
  <nav class="mt-6 flex-1 px-3 space-y-1">
    <button id="menu-dashboard" class="sidebar-link sidebar-active">
      <i class="fa-solid fa-chart-line"></i>
      Dashboard
    </button>
    <button id="menu-profile" class="sidebar-link">
      <i class="fa-solid fa-id-badge"></i>
      Employee Profile
    </button>
    <button id="menu-history" class="sidebar-link">
      <i class="fa-solid fa-folder-tree"></i>
      Audit History
    </button>
    <button id="menu-action" class="sidebar-link">
      <i class="fa-solid fa-file-pen"></i>
      New Action
    </button>
    <button id="menu-analytics" class="sidebar-link">
      <i class="fa-solid fa-chart-pie"></i>
      Analytics
    </button>
    <button id="menu-executive" class="sidebar-link">
      <i class="fa-solid fa-user-tie"></i>
      Executive Summary
    </button>
    <button id="menu-compliance" class="sidebar-link">
      <i class="fa-solid fa-scale-balanced"></i>
      Compliance
    </button>
  </nav>

  <footer class="p-4 text-[11px] text-slate-500 border-t border-slate-200">
    © <span id="footerYear"></span> Jeng Chi Restaurant
  </footer>
</aside>



  <!-- ========================================== -->
  <!-- MAIN CONTENT -->
  <!-- ========================================== -->
  <div class="flex-1 ml-60 min-h-screen flex flex-col">

    <!-- HEADER -->
<header class="w-full bg-white/95 backdrop-blur border-b border-slate-200 shadow-sm sticky top-0 z-30">
  <div class="w-full px-4 lg:px-6 py-3 flex items-center justify-between">

    <!-- LEFT: Title + Tagline -->
    <div class="flex items-center gap-5">
      <div class="leading-tight">
        <!-- Small system name -->
       

        <!-- Main title (now black) -->
        <p class="font-heading text-lg md:text-xl font-semibold text-black">
          Discipline &amp; Compliance Portal
        </p>
      </div>

      <!-- Divider + tagline (now black) -->
      <div class="hidden md:flex items-center gap-3">
        <span class="h-8 w-px bg-slate-200"></span>
        <p class="text-[11px] tracking-[0.18em] uppercase text-black font-medium">
          Discipline • Compliance • Corrective Action Management
        </p>
      </div>
    </div>

    <!-- RIGHT: Icons -->
    <div class="flex items-center gap-3">
      <button class="p-2 rounded-lg hover:bg-slate-100 text-slate-600" aria-label="Help">
        <i class="fa-solid fa-circle-info text-base"></i>
      </button>
      <button class="p-2 rounded-lg hover:bg-slate-100 text-slate-600" aria-label="Settings">
        <i class="fa-solid fa-gear text-base"></i>
      </button>
    </div>

  </div>
</header>




       
    <!-- MAIN -->
  <main id="mainContent" class="flex-1 w-full px-4 lg:px-6 py-10 space-y-12">


     <!-- ========================================== -->
<!-- DASHBOARD SECTION -->
<!-- ========================================== -->
<section id="dashboardSection" class="space-y-10">

 <!-- KPI GRID (reduced ~75% + bold labels) -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-3">

  <!-- Active Employees -->
  <button onclick="openKpiPanel('employees')" 
          class="card px-3 py-3 text-center hover:shadow-lg transition shadow-sm">
    <i class="fa-solid fa-users text-xl text-brand-gold mb-1"></i>
    <p class="text-xl font-heading font-bold text-brand-red" id="kpiActiveEmployees">0</p>
    <p class="text-[11px] font-semibold text-slate-700 mt-0.5">Active Employees</p>
  </button>

  <!-- Written Warnings -->
  <button onclick="openKpiPanel('written')" 
          class="card px-3 py-3 text-center hover:shadow-lg transition shadow-sm">
    <i class="fa-solid fa-pen-to-square text-xl text-sky-600 mb-1"></i>
    <p class="text-xl font-heading font-bold text-sky-700" id="kpiWrittenWarnings">0</p>
    <p class="text-[11px] font-semibold text-slate-700 mt-0.5">Written Warnings</p>
  </button>

  <!-- Final Warnings -->
  <button onclick="openKpiPanel('final')" 
          class="card px-3 py-3 text-center hover:shadow-lg transition shadow-sm">
    <i class="fa-solid fa-exclamation-triangle text-xl text-amber-600 mb-1"></i>
    <p class="text-xl font-heading font-bold text-amber-700" id="kpiFinalWarnings">0</p>
    <p class="text-[11px] font-semibold text-slate-700 mt-0.5">Final Warnings</p>
  </button>

  <!-- Terminations -->
  <button onclick="openKpiPanel('termination')" 
          class="card px-3 py-3 text-center hover:shadow-lg transition shadow-sm">
    <i class="fa-solid fa-user-slash text-xl text-rose-600 mb-1"></i>
    <p class="text-xl font-heading font-bold text-rose-700" id="kpiTerminations">0</p>
    <p class="text-[11px] font-semibold text-slate-700 mt-0.5">Terminations YTD</p>
  </button>
</div>
  <!-- END KPI GRID -->
<!-- GLOBAL SEARCH -->
<div class="w-full">
  <div class="relative">
    <input
      id="globalSearchInput"
      type="text"
      placeholder="Search employees by name…"
      class="w-full px-4 py-3 rounded-lg border border-slate-300 focus:ring-2 focus:ring-brand-red/40 focus:border-brand-red outline-none text-sm shadow-sm"
    />
    <button
      id="globalSearchBtn"
      class="absolute right-2 top-1/2 -translate-y-1/2 text-brand-red hover:text-brand-red_light"
    >
      <i class="fa-solid fa-magnifying-glass text-lg"></i>
    </button>

    <!-- AUTOCOMPLETE -->
    <div
      id="globalAutocomplete"
      class="hidden absolute w-full top-full left-0 bg-white border border-slate-200 rounded-lg shadow-lg mt-1 max-h-64 overflow-auto z-50"
    ></div>
  </div>
</div>






  <!-- RECENT ACTIONS TABLE -->
  <div class="bg-white border border-slate-200 rounded-2xl shadow-sm p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-heading text-lg text-slate-900 flex items-center gap-2">
        <i class="fa-solid fa-clock-rotate-left text-brand-red"></i>
        Recent Disciplinary Actions
      </h3>
      <p class="text-xs text-slate-500">Last 10 actions recorded</p>
    </div>

    <div class="overflow-x-auto border border-slate-200 rounded-xl bg-slate-50/50">
      <table class="min-w-full text-sm">
        <thead class="bg-slate-100 text-slate-600 text-xs uppercase tracking-wide">
          <tr>
            <th class="px-4 py-2 text-left font-semibold">Date</th>
            <th class="px-4 py-2 text-left font-semibold">Employee</th>
            <th class="px-4 py-2 text-left font-semibold">Type</th>
            <th class="px-4 py-2 text-left font-semibold">Manager</th>
            <th class="px-4 py-2 text-left font-semibold">View</th>
          </tr>
        </thead>
        <tbody id="recentActionsTable" class="divide-y divide-slate-200 text-slate-700">
          <tr id="recentActionsEmpty">
            <td colspan="5" class="py-4 text-center text-xs text-slate-400 italic">
              No recent actions recorded.
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</section>



      <!-- ========================================== -->
            <!-- ========================================== -->
      <!-- EMPLOYEE PROFILE SECTION – REDESIGNED -->
      <!-- ========================================== -->
      <section id="profileSection" class="hidden space-y-8">

        <!-- BREADCRUMB -->
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <button onclick="switchView('dashboard')" class="hover:text-brand-red">
            Dashboard
          </button>
          <span>/</span>
          <span class="font-semibold text-slate-700">Employee Profile</span>
        </div>

        <!-- MAIN GRID: SNAPSHOT (LEFT) + DETAILS (RIGHT) -->
        <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">

          <!-- ================= LEFT: EMPLOYEE SNAPSHOT ================= -->
          <div class="space-y-6 xl:col-span-1">

            <!-- Identity / Status Card -->
            <div class="card p-6 flex flex-col gap-5">
              <div class="flex items-center gap-4">
                <div
                  id="profileAvatar"
                  class="h-16 w-16 rounded-full bg-brand-red/10 text-brand-red flex items-center justify-center text-2xl font-heading shadow-sm"
                >
                  JC
                </div>

                <div class="min-w-0">
                  <h2
                    id="profileFullNameDisplay"
                    class="font-heading text-2xl tracking-wide text-slate-900 truncate"
                  >
                    —
                  </h2>
                  <p
                    id="profilePositionDisplay"
                    class="text-xs sm:text-sm text-slate-500 mt-1 truncate"
                  >
                    Position • Department
                  </p>
                </div>
              </div>

              <!-- Behavioral / Status Flags -->
              <div
                id="behaviorFlags"
                class="flex flex-wrap gap-2 pt-2 border-t border-slate-100"
              ></div>

              <!-- Quick Info Strip -->
              <div class="mt-2 grid grid-cols-2 gap-3 text-xs">
                <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Risk Snapshot
                  </p>
                  <p class="text-sm text-slate-800">
                    Uses AI-assisted pattern scoring
                  </p>
                </div>
                <div class="rounded-xl bg-slate-50 border border-slate-200 px-3 py-2">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Compliance
                  </p>
                  <p class="text-sm text-slate-800">
                    TWC / DOL aligned documentation
                  </p>
                </div>
              </div>
            </div>

            <!-- Risk Metrics Snapshot -->
            <div class="card p-5 space-y-4">
              <div class="flex items-center justify-between">
                <h3 class="font-heading text-sm text-slate-900">
                  Corrective Action Summary
                </h3>
                <span class="inline-flex items-center gap-1 text-[11px] px-2 py-1 rounded-full bg-slate-50 border border-slate-200 text-slate-500">
                  <i class="fa-solid fa-shield-halved text-brand-red"></i>
                  HR View Only
                </span>
              </div>

              <div class="grid grid-cols-2 gap-3">
                <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Verbal Warnings
                  </p>
                  <p
                    id="metricVerbal"
                    class="mt-1 text-2xl font-heading font-semibold text-sky-700"
                  >
                    0
                  </p>
                </div>

                <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Written Warnings
                  </p>
                  <p
                    id="metricWritten"
                    class="mt-1 text-2xl font-heading font-semibold text-indigo-700"
                  >
                    0
                  </p>
                </div>

                <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Final Warnings
                  </p>
                  <p
                    id="metricFinal"
                    class="mt-1 text-2xl font-heading font-semibold text-amber-700"
                  >
                    0
                  </p>
                </div>

                <div class="rounded-2xl bg-slate-50 border border-slate-200 px-4 py-3">
                  <p class="text-[11px] uppercase tracking-wide text-slate-500">
                    Terminations
                  </p>
                  <p
                    id="metricTermination"
                    class="mt-1 text-2xl font-heading font-semibold text-rose-700"
                  >
                    0
                  </p>
                </div>
              </div>
            </div>

          </div>

          <!-- ================= RIGHT: DETAIL PANELS ================= -->
          <div class="space-y-6 xl:col-span-2">

            <!-- Employee Information Form -->
            <div class="card p-7 space-y-6">
              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
                <div>
                  <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-id-card text-brand-red"></i>
                    Employee Information
                  </h3>
                  <p class="text-xs text-slate-500 mt-1">
                    Keep legal and contact data current before recording new actions.
                  </p>
                </div>

                <div class="flex gap-3">
                  <button
                    id="resetEmployeeBtn"
                    class="px-4 py-2.5 rounded-xl border border-slate-300 text-xs font-semibold text-slate-600 hover:bg-slate-100 transition"
                  >
                    Reset
                  </button>
                  <button
                    id="saveEmployeeBtn"
                    class="btn-primary text-xs px-4 py-2.5"
                  >
                    <i class="fa-solid fa-floppy-disk"></i>
                    Save Profile
                  </button>
                </div>
              </div>

              <!-- Form Grid -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
                <!-- First Name -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">First Name</label>
                  <input id="firstNameInput" type="text" class="input-premium mt-1" />
                </div>

                <!-- Last Name -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">Last Name</label>
                  <input id="lastNameInput" type="text" class="input-premium mt-1" />
                </div>

                <!-- Email -->
                <div class="md:col-span-2">
                  <label class="text-[11px] font-semibold text-slate-600">Email</label>
                  <input id="emailInput" type="email" class="input-premium mt-1" />
                </div>

                <!-- Position -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">Position</label>
                  <input id="positionInput" type="text" class="input-premium mt-1" />
                </div>

                <!-- Department -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">Department</label>
                  <input id="departmentInput" type="text" class="input-premium mt-1" />
                </div>

                <!-- Reports To -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">Reports To</label>
                  <input id="reportsToInput" type="text" class="input-premium mt-1" />
                </div>

                <!-- Hire Date -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">Hire Date</label>
                  <input id="hireDateInput" type="date" class="input-premium mt-1" />
                </div>

                <!-- HR Witness (Default Contact) -->
                <div>
                  <label class="text-[11px] font-semibold text-slate-600">HR Witness</label>
                  <input id="hrWitnessInput" type="text" class="input-premium mt-1" />
                </div>
              </div>
            </div>

            <!-- Last Action + Compliance Notes -->
            <div class="grid grid-cols-1 lg:grid-cols-[minmax(0,2fr)_minmax(0,1.2fr)] gap-6">

              <!-- Latest Corrective Action -->
              <div class="card p-7 flex flex-col gap-4">
                <div class="flex items-center justify-between">
                  <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
                    <i class="fa-solid fa-chart-line text-brand-red"></i>
                    Latest Corrective Action
                  </h3>
                  <button
                    id="goToNewActionBtn"
                    onclick="switchView('action')"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-brand-red text-white text-xs font-semibold shadow hover:bg-brand-red_light"
                  >
                    <i class="fa-solid fa-file-pen"></i>
                    Record New Action
                  </button>
                </div>

                <div
                  id="lastActionPanel"
                  class="mt-1 text-sm text-slate-600 space-y-1 border border-slate-200 rounded-2xl px-4 py-3 bg-slate-50"
                >
                  <p id="lastActionType">No actions recorded yet.</p>
                  <p id="lastActionDate"></p>
                  <p id="lastActionManager"></p>
                </div>

                <p class="text-[11px] text-slate-400">
                  Use this panel as the single source of truth before any performance discussion or
                  termination recommendation.
                </p>
              </div>

              <!-- Compliance Notes -->
              <div class="bg-slate-50 border border-slate-200 rounded-3xl shadow-sm p-6 text-sm text-slate-700 space-y-3">
                <p class="font-heading text-base text-slate-900 flex items-center gap-2">
                  <i class="fa-solid fa-scale-balanced text-brand-red"></i>
                  HR Compliance Notes
                </p>
                <p>
                  All corrective actions must follow TWC and DOL standards. Documentation must be factual,
                  consistent, and tied to clear behavioral or policy expectations.
                </p>
                <p>
                  Ensure employees receive the Employee Handbook and required postings before any written or
                  final warning is issued.
                </p>
                <p class="text-[11px] text-slate-500">
                  HR records are confidential and may only be accessed by authorized personnel.
                </p>
              </div>

            </div>
          </div>
        </div>
      </section>


      <!-- ========================================== -->
      <!-- HISTORY SECTION - PART C -->
      <!-- ========================================== -->
      <section id="historySection" class="hidden space-y-10">
        <!-- BREADCRUMB -->
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <button onclick="switchView('dashboard')" class="hover:text-brand-red">
            Dashboard
          </button>
          <span>/</span>
          <button onclick="switchView('profile')" class="hover:text-brand-red" id="historyBreadcrumbName">
            Employee Profile
          </button>
          <span>/</span>
          <span class="font-semibold text-slate-700">Audit History</span>
        </div>

        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <h2 class="font-heading text-2xl text-slate-900 tracking-wide">
              Employee Disciplinary History
            </h2>
            <p class="text-sm text-slate-600 mt-1">
              Review, print, and manage all corrective actions recorded for this employee.
            </p>
          </div>
          <button
            id="btnToNewAction"
            onclick="switchView('action')"
            class="btn-primary"
          >
            <i class="fa-solid fa-file-circle-plus"></i>
            Record New Action
          </button>
        </div>

        <div class="bg-white border border-slate-200 rounded-3xl shadow-sm p-8">
          <div id="historyEmptyState" class="text-center py-16 px-4">
            <i class="fa-solid fa-folder-open text-5xl text-slate-300"></i>
            <p class="mt-4 text-lg font-heading text-slate-700">No Records Found</p>
            <p class="text-sm text-slate-500 mt-1">This employee has no disciplinary history on file.</p>
            <button
              id="emptyStateNewActionBtn"
              onclick="switchView('action')"
              class="btn-primary"
            >
              <i class="fa-solid fa-file-circle-plus"></i>
              Record First Action
            </button>
          </div>

          <div id="historyTableWrapper" class="overflow-x-auto hidden">
            <table class="min-w-full text-sm">
              <thead>
                <tr class="text-left text-xs uppercase tracking-wide text-slate-500 border-b border-slate-200">
                  <th class="py-3 px-3">Date</th>
                  <th class="py-3 px-3">Type</th>
                  <th class="py-3 px-3">Category</th>
                  <th class="py-3 px-3">Summary</th>
                  <th class="py-3 px-3">Sentiment</th>
                  <th class="py-3 px-3">Manager</th>
                  <th class="py-3 px-3 text-right">Actions</th>
                </tr>
              </thead>
              <tbody id="historyTableBody" class="divide-y divide-slate-200"></tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- ========================================== -->
      <!-- NEW ACTION SECTION -->
      <!-- ========================================== -->
      <section id="newActionSection" class="hidden space-y-10">
        <!-- BREADCRUMB -->
        <div class="flex items-center gap-2 text-sm text-slate-500">
          <button onclick="switchView('dashboard')" class="hover:text-brand-red">
            Dashboard
          </button>
          <span>/</span>
          <button onclick="switchView('profile')" class="hover:text-brand-red" id="actionBreadcrumbName">
            Employee Profile
          </button>
          <span>/</span>
          <span class="font-semibold text-slate-700">New Action</span>
        </div>
        
        <!-- HEADER -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-6">
          <div>
            <h2 class="font-heading text-2xl text-slate-900 tracking-wide">
              New Disciplinary Action
            </h2>
            <p class="text-sm text-slate-600">
              Provide factual, policy-based documentation that complies with TWC and DOL requirements.
            </p>
          </div>
        </div>

        <!-- EMPLOYEE STRIP -->
        <div class="bg-slate-50 border border-slate-200 rounded-2xl shadow-sm p-6 text-sm flex flex-col md:flex-row md:items-center md:justify-between gap-4">
          <div class="flex items-center gap-3">
            <div
              id="actionEmpAvatar"
              class="h-12 w-12 rounded-full bg-brand-red/10 text-brand-red flex items-center justify-center font-heading text-lg"
            >
              JC
            </div>
            <div>
              <p id="actionEmpName" class="font-heading text-base text-slate-900">Employee Name</p>
              <p id="actionEmpMeta" class="text-xs text-slate-500">Position • Department</p>
            </div>
          </div>
        </div>

        <!-- FORM -->
        <form id="newActionForm" class="bg-white border border-slate-200 rounded-3xl shadow-sm p-8 space-y-10">

          <!-- CLASSIFICATION -->
          <div class="space-y-4">
            <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-list-check text-brand-red"></i>
              Classification
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="text-xs font-semibold text-slate-600">Action Type <span class="text-rose-600">*</span></label>
                <select
                  id="actionTypeInput"
                  class="input-premium"
                >
                  <option value="">Select type…</option>
                  <option value="VERBAL_WARNING">Verbal Warning</option>
                  <option value="WRITTEN_WARNING">Written Warning</option>
                  <option value="FINAL_WARNING">Final Warning</option>
                  <option value="TERMINATION">Final Termination</option>
                </select>
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-600">Incident Date <span class="text-rose-600">*</span></label>
                <input
                  id="incidentDateInput"
                  type="date"
                  class="input-premium"
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-600">Policy Area</label>
                <select
                  id="policyAreaInput"
                  class="input-premium"
                >
                  <option value="">Select area…</option>
                  <option value="Attendance & Punctuality">Attendance & Punctuality</option>
                  <option value="Conduct / Behavior">Conduct / Behavior</option>
                  <option value="Harassment / Discrimination">Harassment / Discrimination</option>
                  <option value="Safety / OSHA / TWC">Safety / OSHA / TWC</option>
                  <option value="Wage & Hour / DOL">Wage & Hour / DOL</option>
                  <option value="Performance / Quality">Performance / Quality</option>
                  <option value="Other">Other</option>
                </select>
              </div>
            </div>
          </div>

          <!-- NARRATIVE -->
          <div class="space-y-4">
            <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-comment-dots text-brand-red"></i>
              Narrative
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="text-xs font-semibold text-slate-600">
                  Description of Incident <span class="text-rose-600">*</span>
                </label>
                <textarea
                  id="incidentDescriptionInput"
                  rows="6"
                  class="input-premium"
                  placeholder="Write facts only. Include what occurred, when, where, and witnesses."
                ></textarea>
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-600">
                  Corrective Action Plan <span class="text-rose-600">*</span>
                </label>
                <textarea
                  id="correctivePlanInput"
                  rows="6"
                  class="input-premium"
                  placeholder="Explain expectations, deadlines, and consequences if improvement is not achieved."
                ></textarea>
              </div>
            </div>
          </div>

          <!-- AUTHORITY -->
          <div class="space-y-4">
            <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-user-tie text-brand-red"></i>
              Authority
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <label class="text-xs font-semibold text-slate-600">
                  Manager/Supervisor <span class="text-rose-600">*</span>
                </label>
                <input
                  id="managerNameInput"
                  type="text"
                  class="input-premium"
                  placeholder="Name of supervisor"
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-600">HR Witness</label>
                <input
                  id="hrWitnessActionInput"
                  type="text"
                  class="input-premium"
                  placeholder="HR Representative"
                />
              </div>
              <div>
                <label class="text-xs font-semibold text-slate-600">Follow-Up Date</label>
                <input
                  id="followUpDateInput"
                  type="date"
                  class="input-premium"
                />
              </div>
            </div>
          </div>

          <!-- ACK -->
          <div class="space-y-4">
            <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-clipboard-check text-brand-red"></i>
              Acknowledgment
            </h3>
            <label class="flex items-start gap-3 text-sm text-slate-700">
              <input
                id="ackPoliciesInput"
                type="checkbox"
                class="mt-1 rounded border-slate-300 text-brand-red focus:ring-brand-red"
              />
              Employee has received the Employee Handbook, DOL/TWC postings, and relevant policy documents.
            </label>
          </div>
        </form>

        <!-- ACTION BAR -->
        <div class="flex flex-col sm:flex-row sm:justify-end gap-4">
          <button
            id="previewPdfBtn"
            class="inline-flex items-center gap-2 border border-slate-300 text-slate-700 px-5 py-2.5 rounded-xl text-sm shadow hover:bg-slate-50 transition"
          >
            <i class="fa-solid fa-file-pdf text-rose-600"></i>
            Preview / Download PDF
          </button>
          <button
            id="submitActionBtn"
            class="btn-primary"
          >
            <i class="fa-solid fa-floppy-disk"></i>
            Submit Action
          </button>
        </div>
      </section>

      <!-- ========================================== -->
      <!-- ANALYTICS SECTION - PART D + F -->
      <!-- ========================================== -->
      <section id="analyticsSection" class="hidden space-y-10">

        <div id="analyticsMainContainer" class="space-y-10">

          <!-- HEADER -->
          <div class="w-full bg-gradient-to-r from-brand-red to-brand-red_light rounded-3xl shadow-xl p-10 text-white relative overflow-hidden">
            <div class="absolute inset-0 bg-white/10 backdrop-blur-sm"></div>
            <div class="relative z-10 flex flex-col md:flex-row md:items-center md:justify-between gap-8">
              <div>
                <h2 class="font-heading text-3xl md:text-4xl font-semibold tracking-wide drop-shadow-sm">
                  Executive Analytics Command Center
                </h2>
                <p class="text-base text-white/90 mt-2">
                  Organization-Wide Discipline, Risk, and Compliance Insights
                </p>
              </div>
              <div class="flex flex-col items-end gap-3">
                <div class="flex gap-2">
                  <button
                    id="exportAnalyticsPdfBtn"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/90 hover:bg-white text-brand-red text-xs font-semibold shadow"
                  >
                    <i class="fa-solid fa-file-pdf"></i>
                    Export PDF
                  </button>
                  <button
                    id="exportAnalyticsExcelBtn"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/90 hover:bg-white text-brand-red text-xs font-semibold shadow"
                  >
                    <i class="fa-solid fa-file-excel"></i>
                    Export Excel
                  </button>
                  <button
                    id="exportAnalyticsCsvBtn"
                    class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-white/90 hover:bg-white text-brand-red text-xs font-semibold shadow"
                  >
                    <i class="fa-solid fa-file-csv"></i>
                    Export CSV
                  </button>
                </div>
                <button
                  id="sendAnalyticsEmailBtn"
                  class="inline-flex items-center gap-2 px-4 py-2 rounded-xl bg-red-700 hover:bg-red-800 text-white text-xs font-semibold shadow"
                >
                  <i class="fa-solid fa-envelope-circle-check"></i>
                  Email Executive Report
                </button>
              </div>
            </div>
          </div>

          <!-- KPI GRID -->
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
              <p class="text-xs uppercase tracking-wide font-semibold text-slate-500">Total Warnings (YTD)</p>
              <div class="flex items-center justify-between mt-2">
                <p id="kpiTotalWarnings" class="text-4xl font-heading text-brand-red">0</p>
                <i class="fa-solid fa-briefcase text-brand-red text-3xl"></i>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
              <p class="text-xs uppercase tracking-wide font-semibold text-slate-500">Final Warnings (YTD)</p>
              <div class="flex items-center justify-between mt-2">
                <p id="kpiFinalWarningsAnalytics" class="text-4xl font-heading text-amber-700">0</p>
                <i class="fa-solid fa-exclamation text-amber-600 text-3xl"></i>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
              <p class="text-xs uppercase tracking-wide font-semibold text-slate-500">Terminations (YTD)</p>
              <div class="flex items-center justify-between mt-2">
                <p id="kpiTerminationsAnalytics" class="text-4xl font-heading text-rose-700">0</p>
                <i class="fa-solid fa-user-slash text-rose-600 text-3xl"></i>
              </div>
            </div>
            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
              <p class="text-xs uppercase tracking-wide font-semibold text-slate-500">Highest Risk Department</p>
              <div class="flex items-center justify-between mt-2">
                <p id="kpiRiskDept" class="text-xl font-heading text-slate-800">—</p>
                <i class="fa-solid fa-fire text-red-500 text-3xl"></i>
              </div>
            </div>
          </div>

          <!-- PREDICTION ENGINE OUTPUT - PART F -->
          <div class="card p-6 space-y-6">
            <h2 class="font-heading text-2xl text-slate-800 mb-4">
              Predictive Risk Forecast — Next 90 Days
            </h2>

            <div id="predictionSummary" class="text-sm text-slate-600 mb-4">
              Loading predictive insights…
            </div>

            <!-- HIGH RISK FORECAST LIST -->
            <div>
              <h3 class="font-heading text-lg mb-2 text-slate-700">Employees with Elevated Forecasted Risk</h3>
              <div id="forecastEmployeeList" class="space-y-4"></div>
            </div>

            <!-- DEPARTMENT VOLATILITY -->
            <div class="mt-8">
              <h3 class="font-heading text-lg mb-2 text-slate-700">Department Volatility Index (DVI)</h3>
              <div id="forecastDeptVolatility" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></div>
            </div>

            <!-- MANAGER RISK ATTRIBUTION -->
            <div class="mt-8">
              <h3 class="font-heading text-lg mb-2 text-slate-700">Manager Risk Attribution (MRA)</h3>
              <div id="managerRiskAttribution" class="space-y-4"></div>
            </div>
          </div>
          <!-- END PREDICTION ENGINE OUTPUT -->


          <!-- TREND CHART -->
          <div class="bg-white border border-slate-200 rounded-3xl shadow-sm p-8">
            <h3 class="font-heading text-xl text-slate-900 mb-4 flex items-center gap-2">
              <i class="fa-solid fa-chart-line text-brand-red"></i>
              12-Month Discipline Trend
            </h3>
            <div class="h-72">
              <canvas id="disciplineTrendChart"></canvas>
            </div>
          </div>

          <!-- DEPARTMENT RISK CHART -->
          <div class="bg-white border border-slate-200 rounded-3xl shadow-sm p-8">
            <h3 class="font-heading text-xl text-slate-900 mb-4 flex items-center gap-2">
              <i class="fa-solid fa-building-user text-brand-red"></i>
              Department Risk Levels
            </h3>
            <div class="h-72">
              <canvas id="departmentRiskChart"></canvas>
            </div>
          </div>

          <!-- HEATMAP -->
          <div class="bg-white border border-slate-200 rounded-3xl shadow-sm p-8">
            <h3 class="font-heading text-xl text-slate-900 mb-4 flex items-center gap-2">
              <i class="fa-solid fa-calendar-days text-brand-red"></i>
              Warning Heatmap (Day × Month)
            </h3>
            <canvas
              id="disciplineHeatmapCanvas"
              width="900"
              height="400"
              class="border border-slate-200 rounded-xl shadow-inner bg-slate-50"
            ></canvas>
          </div>

          <!-- TOP RISK + AI SUMMARY -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div class="bg-white border border-slate-200 rounded-2xl p-6 shadow-sm">
              <h3 class="font-heading text-lg text-slate-900 flex items-center gap-2">
                <i class="fa-solid fa-triangle-exclamation text-rose-600"></i>
                Top 10 At-Risk Employees
              </h3>
              <div id="topRiskList" class="mt-4 space-y-2 text-sm"></div>
            </div>

            <div class="bg-white rounded-2xl p-6 border border-slate-200 shadow-sm">
              <h3 class="font-heading text-lg flex items-center gap-2 text-slate-900">
                <i class="fa-solid fa-robot text-brand-red"></i>
                AI Risk Forecast Summary
              </h3>
              <p id="aiModelVersion" class="text-xs text-slate-500 mt-1">Model Version: (static preview)</p>
              <div id="aiStats" class="mt-4 text-sm space-y-2">
                <p>Training Accuracy: <span id="aiAccuracy">—</span></p>
                <p>Top Feature Contributions:</p>
                <ul id="aiFeatureList" class="list-disc pl-6 text-xs"></ul>
              </div>
            </div>
          </div>

          <!-- PREDICTIVE INSIGHTS -->
          <div class="bg-slate-50 border border-slate-200 rounded-3xl shadow-sm p-8 space-y-4">
            <h3 class="font-heading text-xl text-slate-900 flex items-center gap-2">
              <i class="fa-solid fa-brain text-brand-red"></i>
              Predictive Compliance & Risk Insights
            </h3>
            <ul id="predictiveInsights" class="list-disc ml-6 text-sm text-slate-700 space-y-2"></ul>
          </div>

        </div>
      </section>
      
      <!-- ============================================================= --><!-- ⭐ EXECUTIVE SUMMARY (CEO Dashboard) - PART E --><!-- ============================================================= --><section id="view-executive" class="hidden space-y-10">

        <div class="flex items-center justify-between">
          <h1 class="font-heading text-3xl text-brand-red">Executive Summary Report</h1>

          <button onclick="generateExecutivePDF()" 
                  class="px-6 py-3 rounded-xl bg-brand-red text-white shadow hover:bg-brand-red_light">
            <i class="fa-solid fa-file-pdf"></i> Download Executive PDF
          </button>
        </div>

        <!-- SUMMARY HEADER -->
        <div class="card p-6">
          <h2 class="font-heading text-xl text-slate-700 mb-4">Summary Overview</h2>
          <p class="text-sm leading-relaxed text-slate-600">
            This executive HR report provides a consolidated view of employee discipline trends, 
            risk indicators, department health, and organizational compliance areas within Jeng Chi. 
            Data is refreshed in real time from the enterprise HR Portal.
          </p>
        </div>

        <!-- KPI SUMMARY -->
        <div id="execKpiRow" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <div class="card p-6 text-center">
            <p class="text-sm text-slate-500">Total Employees</p>
            <p id="execTotalEmployees" class="text-3xl font-heading text-brand-red mt-2">0</p>
          </div>
          <div class="card p-6 text-center">
            <p class="text-sm text-slate-500">Total Disciplinary Actions</p>
            <p id="execTotalActions" class="text-3xl font-heading text-brand-red mt-2">0</p>
          </div>
          <div class="card p-6 text-center">
            <p class="text-sm text-slate-500">Avg. Risk Score</p>
            <p id="execAvgRisk" class="text-3xl font-heading text-amber-600 mt-2">0</p>
          </div>
          <div class="card p-6 text-center">
            <p class="text-sm text-slate-500">Terminations YTD</p>
            <p id="execTerminations" class="text-3xl font-heading text-rose-600 mt-2">0</p>
          </div>
        </div>

        <!-- RISK INSIGHT PANEL -->
        <div class="card p-6">
          <h2 class="font-heading text-xl text-slate-700 mb-4">Risk Insight</h2>
          <p id="execRiskInsight" class="text-sm text-slate-600"></p>
        </div>

        <!-- HIGH RISK EMPLOYEE TABLE -->
        <div class="card p-6">
          <h2 class="font-heading text-xl text-slate-700 mb-4">High Risk Employees</h2>

          <table class="w-full text-sm">
            <thead class="bg-slate-100 text-slate-600">
              <tr>
                <th class="py-2 px-3 text-left">Employee</th>
                <th class="py-2 px-3 text-left">Position</th>
                <th class="py-2 px-3 text-left">Department</th>
                <th class="py-2 px-3 text-right">Risk Score</th>
              </tr>
            </thead>
            <tbody id="execHighRiskTable" class="divide-y divide-slate-200"></tbody>
          </table>
        </div>
      </section>

      <!-- ========================================== -->
      <!-- HIDDEN PDF TEMPLATE -->
      <!-- ========================================== -->
      <section id="pdf-template" class="hidden">
        <div class="max-w-3xl mx-auto my-8 bg-white text-slate-900 p-10 text-sm border border-slate-200 rounded-2xl">
          <div class="flex items-center justify-between mb-6">
            <div>
              <h2 class="font-heading text-xl text-brand-red">Corrective Action Notice</h2>
              <p class="text-xs text-slate-500">Jeng Chi Restaurant • Human Resources</p>
            </div>
            <img
              src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
              class="h-12 w-auto rounded"
              alt="Jeng Chi Logo Small"
            />
          </div>

          <p class="text-xs text-slate-500 mb-4">Date Generated: <span id="pdfTodayDate"></span></p>

          <div class="border border-slate-200 rounded-lg p-4 mb-4">
            <h3 class="font-heading text-sm text-slate-900 mb-2">Employee Information</h3>
            <p><strong>Name:</strong> <span id="pdfEmployeeName"></span></p>
            <p><strong>Employee ID:</strong> <span id="pdfEmployeeId"></span></p>
            <p><strong>Position:</strong> <span id="pdfEmployeePosition"></span></p>
            <p><strong>Status:</strong> <span id="pdfEmployeeStatus"></span></p>
            <p><strong>Reports To:</strong> <span id="pdfReportsTo"></span></p>
          </div>

          <div class="border border-slate-200 rounded-lg p-4 mb-4">
            <h3 class="font-heading text-sm text-slate-900 mb-2">Action Details</h3>
            <p><strong>Action Type:</strong> <span id="pdfActionType"></span></p>
            <p><strong>Incident Date:</strong> <span id="pdfIncidentDate"></span></p>
            <p><strong>Policy Area:</strong> <span id="pdfPolicyArea"></span></p>
            <p><strong>Follow-Up Date:</strong> <span id="pdfFollowUpDate"></span></p>
          </div>

          <div class="border border-slate-200 rounded-lg p-4 mb-4">
            <h3 class="font-heading text-sm text-slate-900 mb-2">Description of Incident</h3>
            <p id="pdfIncidentDescription" class="whitespace-pre-wrap"></p>
          </div>

          <div class="border border-slate-200 rounded-lg p-4 mb-4">
            <h3 class="font-heading text-sm text-slate-900 mb-2">Corrective Action Plan</h3>
            <p id="pdfCorrectivePlan" class="whitespace-pre-wrap"></p>
          </div>

          <div class="border border-slate-200 rounded-lg p-4 mb-4">
            <h3 class="font-heading text-sm text-slate-900 mb-2">Acknowledgments</h3>
            <p><strong>Manager/Supervisor:</strong> <span id="pdfManagerName"></span></p>
            <p><strong>HR Witness:</strong> <span id="pdfHrWitness"></span></p>
            <p><strong>Employee Received Policies:</strong> <span id="pdfAckPolicyProvided"></span></p>
          </div>

          <p class="text-[11px] text-slate-500 mt-6">
            This document is confidential and intended solely for HR and management use. It is not a contract and does not
            alter the at-will employment relationship.
          </p>
        </div>
      </section>

    </main>
  </div>
  
  <!-- ========================================================= -->
  <!-- ⭐ SLIDE-IN KPI DETAIL PANEL - PART B -->
  <!-- ========================================================= -->
  <div id="kpiPanel" 
       class="fixed top-0 right-0 w-[480px] h-full bg-white shadow-2xl border-l border-slate-200 
              translate-x-full transition-transform duration-300 z-[999] flex flex-col">

    <!-- HEADER -->
    <div class="p-6 border-b border-slate-200 flex items-center justify-between">
      <h2 id="kpiPanelTitle" class="font-heading text-xl text-slate-900">
        KPI Detail
      </h2>

      <button onclick="closeKpiPanel()" 
              class="text-slate-400 hover:text-brand-red text-2xl">
        <i class="fa-solid fa-xmark"></i>
      </button>
    </div>

    <!-- CONTENT AREA -->
    <div class="flex-1 overflow-y-auto p-6 space-y-6">

      <!-- FILTERED LIST TITLE -->
      <p id="kpiPanelSubtitle" class="text-sm text-slate-500">Showing results…</p>

      <!-- LIST OF ACTIONS -->
      <div id="kpiPanelList" class="space-y-4"></div>

    </div>

    <!-- FOOTER -->
    <div class="p-6 border-t border-slate-200 bg-slate-50">
      <button onclick="closeKpiPanel()" 
              class="px-5 py-3 rounded-xl border border-slate-300 text-slate-600 hover:bg-slate-100 w-full">
        Back to Dashboard
      </button>
    </div>
  </div>

  <!-- ========================================================= -->
  <!-- ⭐ EDIT WARNING MODAL - PART C -->
  <!-- ========================================================= -->
  <div id="editActionModal"
       class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center">
    <div class="bg-white w-full max-w-2xl rounded-2xl shadow-2xl overflow-hidden">

      <!-- HEADER -->
      <div class="px-6 py-4 border-b border-slate-200 flex justify-between items-center">
        <h2 class="font-heading text-xl text-brand-red">Edit Disciplinary Action</h2>
        <button onclick="closeEditModal()" class="text-slate-500 hover:text-brand-red text-2xl">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>

      <!-- BODY -->
      <div class="p-6 space-y-6">

        <input type="hidden" id="editActionIndex" />

        <div>
          <label class="text-sm font-semibold text-slate-600">Action Type</label>
          <select id="editActionType" class="input-premium mt-1">
            <option value="VERBAL_WARNING">Verbal Warning</option>
            <option value="WRITTEN_WARNING">Written Warning</option>
            <option value="FINAL_WARNING">Final Warning</option>
            <option value="TERMINATION">Final Termination</option>
          </select>
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">Incident Date</label>
          <input id="editIncidentDate" type="date" class="input-premium mt-1" />
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">Policy Area</label>
          <input id="editPolicyArea" type="text" class="input-premium mt-1" />
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">Incident Description</label>
          <textarea id="editIncidentDescription" class="input-premium mt-1" rows="4"></textarea>
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">Corrective Plan</label>
          <textarea id="editCorrectivePlan" class="input-premium mt-1" rows="4"></textarea>
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">Manager</label>
          <input id="editManagerName" type="text" class="input-premium mt-1" />
        </div>

        <div>
          <label class="text-sm font-semibold text-slate-600">HR Witness</label>
          <input id="editHrWitness" type="text" class="input-premium mt-1" />
        </div>

      </div>

      <!-- FOOTER -->
      <div class="px-6 py-4 bg-slate-50 border-t border-slate-200 flex justify-between">

        <button onclick="deleteActionConfirm()" 
                class="px-5 py-3 rounded-xl bg-rose-600 text-white hover:bg-rose-700 shadow">
          <i class="fa-solid fa-trash"></i> Delete
        </button>

        <button onclick="saveEditedAction()" 
                class="px-7 py-3 rounded-xl bg-brand-red text-white hover:bg-brand-red_light shadow">
          <i class="fa-solid fa-floppy-disk"></i> Save Changes
        </button>

      </div>

    </div>
  </div>
  
  <!-- ========================================================= -->
  <!-- ⭐ DELETE CONFIRMATION MODAL - PART C -->
  <!-- ========================================================= -->
  <div id="deleteActionModal"
       class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm z-[9999] flex items-center justify-center">
    <div class="bg-white w-full max-w-lg rounded-2xl shadow-2xl">

      <div class="px-6 py-5 border-b border-slate-300">
        <h3 class="font-heading text-xl text-rose-700">Confirm Delete</h3>
      </div>

      <div class="p-6 text-slate-700 text-sm">
        Are you sure you want to permanently delete this disciplinary action?
        <p class="text-xs text-slate-500 mt-2">This cannot be undone.</p>
      </div>

      <div class="px-6 py-4 bg-slate-100 border-t border-slate-300 flex justify-between">
        <button onclick="closeDeleteModal()" 
                class="px-5 py-2 border rounded-xl hover:bg-slate-200">
          Cancel
        </button>

        <button onclick="deleteAction()" 
                class="px-6 py-2 bg-rose-600 text-white rounded-xl shadow hover:bg-rose-700">
          Delete Permanently
        </button>
      </div>

    </div>
  </div>


  <!-- ========================================== -->
  <!-- CORE SCRIPT -->
  <!-- ========================================== -->
  <script>
    /* --------------------------------------------------
       Supabase Init
    -------------------------------------------------- */
   const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY =
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;

    /* --------------------------------------------------
       Global State & Helpers
    -------------------------------------------------- */
    let currentEmployee = null;
    let currentHistory = []; // Renamed from currentDisciplineHistory for simplicity
    let autocompleteTimeout = null;
    let currentActionIndex = -1; // For tracking the action being edited/deleted

    const actionTypeLabels = {
      VERBAL_WARNING: "Verbal Warning",
      WRITTEN_WARNING: "Written Warning",
      FINAL_WARNING: "Final Warning",
      TERMINATION: "Final Termination",
    };
    
    // PART G - Behavioral Lexicon
    const behaviorLexicon = {
      attendance: ["late", "tardy", "absent", "no call", "no show"],
      attitude: ["argued", "refused", "insubordinate", "rude", "aggressive", "hostile"],
      safety: ["safety", "hazard", "dangerous", "osha", "injury", "spill", "equipment misuse"],
      harassment: ["harass", "discriminat", "inappropriate", "sexual", "racist"],
      performance: ["slow", "poor quality", "incorrect", "errors", "not meeting expectations"],
      policy: ["policy violation", "against policy", "did not follow", "noncompliance"],
      theft: ["stole", "missing", "theft", "void abuse", "discount abuse"],
      guest: ["complaint", "guest upset", "customer issue"]
    };


    function formatDate(value) {
      if (!value) return "—";
      const d = new Date(value);
      if (isNaN(d.getTime())) return value;
      return d.toLocaleDateString("en-US", {
        year: "numeric",
        month: "short",
        day: "numeric",
      });
    }

    function truncateText(text, maxLen) {
      if (!text) return "";
      // Strip newlines for single-line display
      const singleLine = text.replace(/[\r\n]+/g, ' '); 
      return singleLine.length <= maxLen ? singleLine : singleLine.slice(0, maxLen - 1) + "…";
    }

    function getInitials(first, last) {
      const f = (first || "").trim()[0] || "";
      const l = (last || "").trim()[0] || "";
      const combo = (f + l).toUpperCase();
      return combo || "--";
    }

    function setFooterYear() {
      const el = document.getElementById("footerYear");
      if (el) el.textContent = new Date().getFullYear();
    }
    
    // Simple alert replacement for demonstration
    window.alert = (message) => {
        console.warn("Custom Alert:", message);
        // In a true enterprise app, this would trigger a custom toast/modal
        const displayBox = document.createElement('div');
        displayBox.style.cssText = 'position: fixed; top: 10%; left: 50%; transform: translateX(-50%); background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); z-index: 10000; max-width: 90%; font-family: Manrope;';
        displayBox.innerHTML = `<h4 style="margin-top:0; color:#7a1f1f; font-family:Cinzel;">System Notification</h4><p>${message}</p><button onclick="this.parentNode.remove()" style="float:right; background:#7a1f1f; color:#fff; padding:5px 10px; border:none; border-radius:5px;">Close</button>`;
        document.body.appendChild(displayBox);
    };


    /* --------------------------------------------------
       Navigation & View Control
    -------------------------------------------------- */
    // Renamed to switchView for cleaner inline HTML usage (Part A)
    function switchView(viewName) {
      const viewMap = {
        'dashboard': 'dashboardSection',
        'profile': 'profileSection',
        'history': 'historySection',
        'action': 'newActionSection',
        'analytics': 'analyticsSection',
        'executive': 'view-executive'
      };

      const sections = ['dashboardSection', 'profileSection', 'historySection', 'newActionSection', 'analyticsSection', 'view-executive'];
      const targetId = viewMap[viewName];
      
      sections.forEach((id) => {
        const el = document.getElementById(id);
        if (el) el.classList.add("hidden");
      });
      
      const target = document.getElementById(targetId);
      if (target) target.classList.remove("hidden");
      
      setSidebarActive(`menu-${viewName}`);
      window.scrollTo({ top: 0, behavior: "smooth" });
      
      // Update breadcrumbs and trigger history/analytics refresh if needed
      if (currentEmployee) {
          document.getElementById('historyBreadcrumbName').textContent = currentEmployee.last_name || 'Employee Profile';
          document.getElementById('actionBreadcrumbName').textContent = currentEmployee.last_name || 'Employee Profile';
      }
      
      // Load specific data on view switch
      if (viewName === 'history') renderHistoryTable();
      if (viewName === 'analytics') initializeAnalytics();
      if (viewName === 'executive') initializeExecutiveSummary();
      
    }

    function setSidebarActive(buttonId) {
      document.querySelectorAll(".sidebar-link").forEach((btn) => {
        btn.classList.remove("sidebar-active");
      });
      const target = document.getElementById(buttonId);
      if (target) target.classList.add("sidebar-active");
    }

    function bindSidebarNavigation() {
      // Replaced by inline switchView calls now that the function is defined globally
    }
    
    // Hook up all buttons to the new switchView function (Part E)
    document.getElementById("menu-dashboard")?.addEventListener("click", () => switchView('dashboard'));
    document.getElementById("menu-profile")?.addEventListener("click", () => switchView('profile'));
    document.getElementById("menu-history")?.addEventListener("click", () => switchView('history'));
    document.getElementById("menu-action")?.addEventListener("click", () => switchView('action'));
    document.getElementById("menu-analytics")?.addEventListener("click", () => switchView('analytics'));
    document.getElementById("menu-executive")?.addEventListener("click", () => switchView('executive'));
    
    
    /* --------------------------------------------------
       Employee Profile Logic
    -------------------------------------------------- */
    
    function computeHistoryCounts(history) {
      const res = { verbal: 0, written: 0, final: 0, term: 0 };
      (history || []).forEach((a) => {
        switch (a.action_type) {
          case "VERBAL_WARNING":
            res.verbal++;
            break;
          case "WRITTEN_WARNING":
            res.written++;
            break;
          case "FINAL_WARNING":
            res.final++;
            break;
          case "TERMINATION":
            res.term++;
            break;
        }
      });
      return res;
    }

    function calculateRiskScore(emp) {
      if (!emp) return 0;
      const history = Array.isArray(emp.discipline_history) ? emp.discipline_history : [];

      let score = 0;
      const written = Number(emp.disciplinary_warning_count || 0);
      const final = Number(emp.final_warning_count || 0);
      const term = Number(emp.termination_letter_count || 0);

      score += written * 10;
      score += final * 25;
      score += term * 40;

      const now = new Date();
      history.forEach((act) => {
        const incidentDate = act.incident_date ? new Date(act.incident_date) : null;
        if (!incidentDate || isNaN(incidentDate.getTime())) return;
        const diffDays = (now - incidentDate) / (1000 * 60 * 60 * 24);
        if (diffDays <= 30) score += 5;
        if (act.follow_up_date && new Date(act.follow_up_date) < now) score += 3;
        if (act.policy_area?.includes("Attendance")) score += 5;
        if (act.policy_area?.includes("Conduct")) score += 10;
        if (act.policy_area?.includes("Harassment")) score += 10;
        if (act.policy_area?.includes("Safety")) score += 10;
      });

      const mostRecent = history[history.length - 1];
      if (mostRecent && mostRecent.incident_date) {
        const timeSince = (now - new Date(mostRecent.incident_date)) / (1000 * 60 * 60 * 24);
        if (timeSince > 120) score -= 5;
      }
      return Math.max(score, 0);
    }

    function getRiskLevel(score) {
      if (score >= 70) return "CRITICAL";
      if (score >= 40) return "HIGH";
      if (score >= 20) return "MODERATE";
      return "LOW";
    }

    function updateRiskWidgets() {
        // Redesigned: Risk widgets now live inside the Profile Header (Part A HTML)
        const riskLevelBadge = document.getElementById("riskLevelBadge");
        const terminationPrediction = document.getElementById("terminationPrediction");
        
        // This is not strictly needed anymore since Part A removed them, but keeping logic clean.
    }
// =========================================================
// UNIVERSAL EMPLOYEE FETCH FUNCTION (for KPI, search, etc.)
// =========================================================
// Reusable fetch used by KPI panel, recent actions, etc.
async function fetchEmployeeAndSelect(employee_id, fallbackId = null) {
  try {
    console.log("fetchEmployeeAndSelect →", { employee_id, fallbackId });

    // Base query
    let query = supabaseClient.from("employees2025").select("*").limit(1);

    // Prefer employee_id, fall back to numeric id if needed
    if (employee_id) {
      query = query.eq("employee_id", employee_id);
    } else if (fallbackId !== null) {
      query = query.eq("id", fallbackId);
    }

    // Use maybeSingle so "0 rows" doesn’t crash with PGRST116
    const { data, error } = await query.maybeSingle();

    if (error || !data) {
      console.error("Failed to fetch employee detail:", error || "No data");
      window.alert("Failed to load employee details.");
      return;
    }

    // You already have this helper:
    //   function selectEmployee(emp) {
    //     loadEmployeeRecord(emp);
    //     switchView("profile");
    //   }
    selectEmployee(data);
  } catch (err) {
    console.error("Failed to fetch employee detail:", err);
    window.alert("Failed to load employee details.");
  }
}


function showSystemNotification(title, message) {
  const modal = document.createElement("div");
  modal.className =
    "fixed inset-0 flex items-center justify-center bg-black/50 backdrop-blur-sm z-[9999]";
  modal.innerHTML = `
    <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-sm text-center border border-slate-200">
      <h2 class="font-heading text-lg text-brand-red mb-2">${title}</h2>
      <p class="text-sm text-slate-700 mb-5">${message}</p>
      <button class="px-5 py-2 rounded-lg bg-brand-red text-white font-semibold hover:bg-brand-red_light transition"
              onclick="this.closest('.fixed').remove()">Close</button>
    </div>
  `;
  document.body.appendChild(modal);
}





    function renderEmployeeProfile() {
      const avatarEl = document.getElementById("profileAvatar");
      const nameEl = document.getElementById("profileFullNameDisplay");
      const positionEl = document.getElementById("profilePositionDisplay");
      
      // Update Breadcrumbs
      const historyBreadcrumb = document.getElementById('historyBreadcrumbName');
      const actionBreadcrumb = document.getElementById('actionBreadcrumbName');

      const metricVerbalEl = document.getElementById("metricVerbal");
      const metricWrittenEl = document.getElementById("metricWritten");
      const metricFinalEl = document.getElementById("metricFinal");
      const metricTerminationEl = document.getElementById("metricTermination");

      const lastTypeEl = document.getElementById("lastActionType");
      const lastDateEl = document.getElementById("lastActionDate");
      const lastManagerEl = document.getElementById("lastActionManager");

      if (!currentEmployee) {
        // Reset view state
        return;
      }

      const fn = currentEmployee.first_name || "";
      const ln = currentEmployee.last_name || "";
      const fullName = `${fn} ${ln}`.trim() || "—";
      const position =
  currentEmployee.position_title ||
  currentEmployee.job_title ||
  currentEmployee.position || // legacy, just in case
  "—";
      const department = currentEmployee.department || "—";
      const hireDate =
        currentEmployee.original_hire_date ||
        currentEmployee.hire_date ||
        null;
      const reportsTo = currentEmployee.report_to || "—";
      const employmentStatus = currentEmployee.employment_status || "Unknown";
      const isActive = employmentStatus.toLowerCase() === "active";

      avatarEl.textContent = getInitials(fn, ln);
      nameEl.textContent = fullName;
      positionEl.textContent = `${position} • ${department}`;
      
      if(historyBreadcrumb) historyBreadcrumb.textContent = fullName;
      if(actionBreadcrumb) actionBreadcrumb.textContent = fullName;
      

      // Metrics from history
      const counts = computeHistoryCounts(currentHistory);
      metricVerbalEl.textContent = counts.verbal;
      metricWrittenEl.textContent = counts.written;
      metricFinalEl.textContent = counts.final;
      metricTerminationEl.textContent = counts.term;

      // Last action
      let lastAction = currentEmployee.last_disciplinary_action || null;
      if (!lastAction && currentHistory.length) {
        const sorted = [...currentHistory].sort((a, b) => {
          const ad = a.incident_date || a.created_at;
          const bd = b.incident_date || b.created_at;
          return new Date(bd) - new Date(ad);
        });
        lastAction = sorted[0];
      }

      if (!lastAction) {
        lastTypeEl.textContent = "No actions recorded yet.";
        lastDateEl.textContent = "";
        lastManagerEl.textContent = "";
      } else {
        lastTypeEl.textContent = `Type: ${
          actionTypeLabels[lastAction.action_type] || lastAction.action_type
        }`;
        lastDateEl.textContent = `Date: ${formatDate(
          lastAction.incident_date || lastAction.created_at
        )}`;
        lastManagerEl.textContent = lastAction.manager_name
          ? `Manager: ${lastAction.manager_name}`
          : "";
      }

      // Populate profile form (Part A fields)
      document.getElementById("firstNameInput").value = fn;
      document.getElementById("lastNameInput").value = ln;
      document.getElementById("emailInput").value = currentEmployee.email || "";
      document.getElementById("positionInput").value = position || "";
      document.getElementById("departmentInput").value = department || "";
      document.getElementById("reportsToInput").value = reportsTo || "";
      document.getElementById("hrWitnessInput").value =
        currentEmployee.hr_witness || "";
      document.getElementById("hireDateInput").value =
        hireDate && !isNaN(new Date(hireDate))
          ? new Date(hireDate).toISOString().slice(0, 10)
          : "";

      renderBehaviorFlags(currentEmployee); // PART G
      // updateRiskWidgets(); // Redesigned out
    }
    
    // PART C: Rerender metrics after any save/delete
    function renderMetrics() {
        renderEmployeeProfile();
        loadDashboardKPIs();
        loadRecentActions();
        renderAnalyticsDashboard();
    }

    // PART C: Updated History Table Renderer
    function renderHistoryTable() {
      const emptyStateEl = document.getElementById("historyEmptyState");
      const tableWrapper = document.getElementById("historyTableWrapper");
      const bodyEl = document.getElementById("historyTableBody");

      if (!currentEmployee || !currentHistory.length) {
        emptyStateEl.classList.remove("hidden");
        tableWrapper.classList.add("hidden");
        bodyEl.innerHTML = "";
        return;
      }

      emptyStateEl.classList.add("hidden");
      tableWrapper.classList.remove("hidden");

      const sorted = [...currentHistory].sort((a, b) => {
        const ad = a.incident_date || a.created_at;
        const bd = b.incident_date || b.created_at;
        return new Date(bd) - new Date(ad);
      });

      bodyEl.innerHTML = "";
      sorted.forEach((action, index) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-100 transition";

        const typeLabel = actionTypeLabels[action.action_type] || action.action_type;
        const typePillClass =
          action.action_type === "TERMINATION"
            ? "bg-rose-50 text-rose-700 border border-rose-200"
            : action.action_type === "FINAL_WARNING"
            ? "bg-amber-50 text-amber-700 border border-amber-200"
            : action.action_type === "WRITTEN_WARNING"
            ? "bg-sky-50 text-sky-700 border border-sky-200"
            : "bg-slate-50 text-slate-700 border border-slate-200";

        const summary = truncateText(action.incident_description || "", 60);
        const followUp = action.follow_up_date
          ? formatDate(action.follow_up_date)
          : "—";
          
        // PART G: Sentiment Score
        const severity = computeSentimentScore(action.incident_description || "");
        const severityColor =
              severity >= 80 ? "text-rose-600" :
              severity >= 40 ? "text-amber-600" :
              "text-emerald-600";
        const severityPill = `<span class="font-semibold ${severityColor}">${severity}</span>`;


        tr.innerHTML = `
          <td class="px-3 py-2 whitespace-nowrap text-slate-700">
            ${formatDate(action.incident_date || action.created_at)}
          </td>
          <td class="px-3 py-2 whitespace-nowrap">
            <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[11px] font-medium ${typePillClass}">
              ${typeLabel}
            </span>
          </td>
          <td class="px-3 py-2 whitespace-nowrap text-slate-700">
            ${action.policy_area || "—"}
          </td>
          <td class="px-3 py-2 text-slate-700">
            ${summary}
          </td>
          <td class="px-3 py-2 text-center">${severityPill}</td>
          <td class="px-3 py-2 whitespace-nowrap text-slate-700">
            ${action.manager_name || "—"}
          </td>
          <td class="text-right whitespace-nowrap space-x-3 pr-4">
            <button onclick="openEditAction(${index})" 
                    class="text-sky-600 hover:underline text-xs">
              Edit
            </button>
            <button onclick="openEditAction(${index})" 
                    class="text-rose-600 hover:underline text-xs">
              Delete
            </button>
            <button onclick="handleGeneratePdf(true, ${index})" 
                    class="text-brand-red hover:underline text-xs">
              PDF
            </button>
          </td>
        `;
        bodyEl.appendChild(tr);
      });
    }

    function loadEmployeeRecord(emp) {
      currentEmployee = emp || null;
      // PART C: Use currentHistory variable
      currentHistory = Array.isArray(emp?.discipline_history)
        ? [...emp.discipline_history]
        : [];
      renderEmployeeProfile();
      renderHistoryTable();
    }

    function selectEmployee(emp) {
      loadEmployeeRecord(emp);
      switchView("profile");
    }

    function populateNewActionEmployeeHeader() {
      if (!currentEmployee) return;
      document.getElementById("actionEmpName").textContent =
        `${currentEmployee.first_name || ""} ${currentEmployee.last_name || ""}`.trim();
      document.getElementById("actionEmpMeta").textContent =
  `${currentEmployee.position_title || currentEmployee.job_title || "—"} • ${
    currentEmployee.department || "—"
  }`;
      document.getElementById("actionEmpAvatar").textContent = getInitials(
        currentEmployee.first_name,
        currentEmployee.last_name
      );
    }
    
    document.getElementById("saveEmployeeBtn")?.addEventListener('click', saveEmployeeProfile);
    
    // PART A: Reset button functionality
    document.getElementById("resetEmployeeBtn")?.addEventListener('click', () => {
        if(currentEmployee) {
            loadEmployeeRecord(currentEmployee); // Reloads the original state
            window.alert("Employee profile changes discarded.");
        }
    });


    /* --------------------------------------------------
       Global Search (Header)
    -------------------------------------------------- */
    async function handleGlobalSearch() {
      const input = document.getElementById("globalSearchInput");
      const box = document.getElementById("globalAutocomplete");
      const term = input.value.trim();

      if (!term) {
        box.classList.add("hidden");
        box.innerHTML = "";
        return;
      }

      const { data, error } = await supabaseClient
        .from("employees2025")
        .select("*")
        .or(`first_name.ilike.%${term}%,last_name.ilike.%${term}%`)
        .limit(12);

      if (error) {
        console.error("Search error:", error);
        box.innerHTML =
          '<div class="px-4 py-2 text-xs text-rose-600">Error loading results.</div>';
        box.classList.remove("hidden");
        return;
      }

      if (!data || data.length === 0) {
        box.innerHTML =
          '<div class="px-4 py-2 text-xs text-slate-500">No results…</div>';
        box.classList.remove("hidden");
        return;
      }

      box.innerHTML = "";
      box.classList.remove("hidden");

      data.forEach((emp) => {
        const fullName = `${emp.first_name || ""} ${emp.last_name || ""}`.trim();
        const row = document.createElement("button");
        row.type = "button";
        row.className =
          "w-full text-left px-4 py-2 hover:bg-slate-100 text-sm border-b border-slate-100";
        row.innerHTML = `
          <div class="font-medium text-slate-900">${fullName}</div>
          <div class="text-[11px] text-slate-500">
            ${emp.position || "—"} · Hire: ${formatDate(emp.hire_date)}
          </div>
        `;
        row.addEventListener("click", () => {
          box.classList.add("hidden");
          box.innerHTML = "";
          input.value = fullName;
          selectEmployee(emp);
        });
        box.appendChild(row);
      });
    }




    function initGlobalSearchEvents() {
      const input = document.getElementById("globalSearchInput");
      const btn = document.getElementById("globalSearchBtn");
      const box = document.getElementById("globalAutocomplete");

      input.addEventListener("input", () => {
        clearTimeout(autocompleteTimeout);
        autocompleteTimeout = setTimeout(handleGlobalSearch, 160);
      });

      btn.addEventListener("click", handleGlobalSearch);

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          handleGlobalSearch();
        }
      });

      document.addEventListener("click", (e) => {
        if (!box.contains(e.target) && e.target !== input) {
          box.classList.add("hidden");
        }
      });

      const heroBtn = document.getElementById("heroFindEmployeeBtn");
      heroBtn?.addEventListener("click", () => {
        input.focus();
        input.scrollIntoView({ behavior: "smooth", block: "center" });
      });
    }

    /* --------------------------------------------------
       Save Employee Profile (Part A)
    -------------------------------------------------- */
    async function saveEmployeeProfile() {
      if (!currentEmployee) {
        window.alert("No employee selected.");
        return;
      }

      const payload = {
        first_name: document.getElementById("firstNameInput").value.trim(),
        last_name: document.getElementById("lastNameInput").value.trim(),
        email: document.getElementById("emailInput").value.trim(),
        position: document.getElementById("positionInput").value.trim(),
        department: document.getElementById("departmentInput").value.trim(),
        report_to: document.getElementById("reportsToInput").value.trim(),
        hr_witness: document.getElementById("hrWitnessInput").value.trim(),
        original_hire_date: document.getElementById("hireDateInput").value || null,
        hire_date: document.getElementById("hireDateInput").value || null, // Keeping both for flexibility
      };

      const { data, error } = await supabaseClient
        .from("employees2025")
        .update(payload)
        .eq("employee_id", currentEmployee.employee_id)
        .select()
        .single();

      if (error) {
        console.error("Update error:", error);
        window.alert("Could not save employee changes.");
        return;
      }

      loadEmployeeRecord(data);
      window.alert("Employee information updated successfully.");
    }

    /* --------------------------------------------------
       Dashboard KPIs + Recent Actions
    -------------------------------------------------- */
    async function loadDashboardKPIs() {
  const { data, error } = await supabaseClient
    .from("employees2025")
    .select(
      "employment_status, status, disciplinary_warning_count, final_warning_count, termination_letter_count"
    );

  if (error) {
    console.error("KPI error:", error);
    return;
  }

  const activeEmployees = (data || []).filter((e) => {
    const status = String(e.employment_status || e.status || "")
      .trim()
      .toLowerCase();
    return status === "active";
  }).length;

  const writtenWarnings = data.reduce(
    (t, e) => t + Number(e.disciplinary_warning_count || 0),
    0
  );

  const finalWarnings = data.reduce(
    (t, e) => t + Number(e.final_warning_count || 0),
    0
  );

  const terminations = data.reduce(
    (t, e) => t + Number(e.termination_letter_count || 0),
    0
  );

  document.getElementById("kpiActiveEmployees").textContent = activeEmployees;
  document.getElementById("kpiWrittenWarnings").textContent = writtenWarnings;
  document.getElementById("kpiFinalWarnings").textContent = finalWarnings;
  document.getElementById("kpiTerminations").textContent = terminations;

  const kpiEmp = document.getElementById("kpiEmployees");
  const kpiWrittenOld = document.getElementById("kpiWritten");
  const kpiFinalOld = document.getElementById("kpiFinal");

  if (kpiEmp) kpiEmp.textContent = activeEmployees;
  if (kpiWrittenOld) kpiWrittenOld.textContent = writtenWarnings;
  if (kpiFinalOld) kpiFinalOld.textContent = finalWarnings;
}




    async function loadRecentActions() {
      const tableBody = document.getElementById("recentActionsTable");
      
      const { data: actions, error } = await supabaseClient
        .from("employees_discipline_actions")
        .select("*")
        .order("incident_date", { ascending: false })
        .limit(10);

      if (error) {
        console.error("Recent actions error:", error);
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="py-4 text-center text-xs text-rose-600">
              Error loading recent actions.
            </td>
          </tr>`;
        return;
      }

      if (!actions || actions.length === 0) {
        tableBody.innerHTML = `
          <tr>
            <td colspan="5" class="py-4 text-center text-xs text-slate-400 italic">
              No recent actions recorded.
            </td>
          </tr>`;
        return;
      }

      const ids = [...new Set(actions.map((a) => a.employee_id))];
      let nameMap = {};
      if (ids.length) {
        const { data: emps, error: empError } = await supabaseClient
          .from("employees2025")
          .select("employee_id, first_name, last_name")
          .in("employee_id", ids);

        if (!empError && emps) {
          emps.forEach((e) => {
            nameMap[e.employee_id] = `${e.first_name || ""} ${e.last_name || ""}`.trim();
          });
        }
      }

      tableBody.innerHTML = "";
      actions.forEach((a) => {
        const tr = document.createElement("tr");
        tr.className = "hover:bg-slate-100 transition";

        const label = actionTypeLabels[a.action_type] || a.action_type;
        const employeeName = nameMap[a.employee_id] || `ID ${a.employee_id}`;

        tr.innerHTML = `
          <td class="px-4 py-2 whitespace-nowrap text-slate-700">
            ${formatDate(a.incident_date || a.created_at)}
          </td>
          <td class="px-4 py-2 text-sm text-slate-800">
            ${employeeName}
          </td>
          <td class="px-4 py-2 text-sm text-slate-700">
            ${label}
          </td>
          <td class="px-4 py-2 text-sm text-slate-700">
            ${a.manager_name || "—"}
          </td>
          <td class="px-4 py-2 text-sm">
            <button class="text-xs text-brand-red underline hover:text-brand-red_light"
                    onclick="openActionFromKpi(${a.employee_id})">
              View
            </button>
          </td>
        `;
        tableBody.appendChild(tr);
      });
    }

    /* --------------------------------------------------
       New Action Save + PDF
    -------------------------------------------------- */
    function collectActionFormData() {
      const action_type = document.getElementById("actionTypeInput").value;
      const incident_date = document.getElementById("incidentDateInput").value;
      const policy_area = document.getElementById("policyAreaInput").value || null;
      const incident_description = document
        .getElementById("incidentDescriptionInput")
        .value.trim();
      const corrective_plan = document
        .getElementById("correctivePlanInput")
        .value.trim();
      const follow_up_date = document.getElementById("followUpDateInput").value || null;
      const manager_name = document.getElementById("managerNameInput").value.trim();
      const hr_witness = document.getElementById("hrWitnessActionInput").value.trim() || null;
      const ack_policy_provided = document.getElementById("ackPoliciesInput").checked;

      const missing = [];
      if (!action_type) missing.push("Action Type");
      if (!incident_date) missing.push("Incident Date");
      if (!incident_description) missing.push("Description of Incident");
      if (action_type !== "VERBAL_WARNING" && !corrective_plan)
        missing.push("Corrective Action Plan");
      if (!manager_name) missing.push("Manager / Supervisor Name");

      if (missing.length) {
        window.alert(
          "Please complete the following required fields:\n\n- " +
            missing.join("\n- ")
        );
        return null;
      }

      return {
        action_type,
        incident_date,
        policy_area,
        incident_description,
        corrective_plan: corrective_plan || null,
        follow_up_date,
        manager_name,
        hr_witness,
        ack_policy_provided,
        created_at: new Date().toISOString(),
      };
    }

    async function handleSaveAction() {
      if (!currentEmployee) {
        window.alert("Please select an employee first.");
        return;
      }

      const actionRecord = collectActionFormData();
      if (!actionRecord) return;

      const history = Array.isArray(currentHistory)
        ? [...currentHistory]
        : [];
      history.push(actionRecord);

      // Recalculate counts from new history
      const counts = computeHistoryCounts(history);

      const updatePayload = {
        discipline_history: history,
        last_disciplinary_action: actionRecord,
        disciplinary_warning_count: counts.written,
        final_warning_count: counts.final,
        termination_letter_count: counts.term,
        hr_witness: actionRecord.hr_witness,
      };

      const { data, error } = await supabaseClient
        .from("employees2025")
        .update(updatePayload)
        .eq("employee_id", currentEmployee.employee_id)
        .select()
        .single();

      if (error) {
        console.error("Error updating employees2025:", error);
        window.alert("Error saving corrective action.");
        return;
      }

      // Insert into log table
      const logPayload = {
        employee_id: currentEmployee.employee_id,
        ...actionRecord,
        department: currentEmployee.department || currentEmployee.position || "Unknown",
        employee_name: `${currentEmployee.first_name || ""} ${currentEmployee.last_name || ""}`
      };

      const { error: logError } = await supabaseClient
        .from("employees_discipline_actions")
        .insert(logPayload);

      if (logError) {
        console.error("Error inserting into employees_discipline_actions:", logError);
      }

      // Update local
      loadEmployeeRecord(data);
      renderMetrics();
      document.getElementById("newActionForm").reset();
      populateNewActionEmployeeHeader();
      window.alert("Corrective action saved successfully.");
      switchView('history');
    }

    async function handleGeneratePdf(isHistoryAction = false, index = -1) {
      if (!currentEmployee) {
        window.alert("Please select an employee before generating a PDF.");
        return;
      }

      let actionRecord;
      if(isHistoryAction && index >= 0) {
        actionRecord = currentHistory[index];
      } else {
        actionRecord = collectActionFormData();
      }
      
      if (!actionRecord) return;
      
      const pdfContainer = document.getElementById("pdf-template");
      
      const firstName = currentEmployee.first_name || "";
      const lastName = currentEmployee.last_name || "";
      const fullName = `${firstName} ${lastName}`.trim();
      const position =
        currentEmployee.position || currentEmployee.job_title || "—";
      const employmentStatus =
        currentEmployee.employment_status || "Unknown";
      const reportsTo = currentEmployee.report_to || "—";
      
      document.getElementById("pdfTodayDate").textContent = formatDate(new Date().toISOString());
      document.getElementById("pdfEmployeeName").textContent = fullName;
      document.getElementById("pdfEmployeeId").textContent = currentEmployee.employee_id || "—";
      document.getElementById("pdfEmployeePosition").textContent = position;
      document.getElementById("pdfEmployeeStatus").textContent = employmentStatus;
      document.getElementById("pdfReportsTo").textContent = reportsTo;

      document.getElementById("pdfActionType").textContent =
        actionTypeLabels[actionRecord.action_type] || actionRecord.action_type;
      document.getElementById("pdfIncidentDate").textContent = formatDate(actionRecord.incident_date);
      document.getElementById("pdfPolicyArea").textContent = actionRecord.policy_area || "—";
      document.getElementById("pdfFollowUpDate").textContent = actionRecord.follow_up_date
        ? formatDate(actionRecord.follow_up_date)
        : "—";
      document.getElementById("pdfIncidentDescription").textContent = actionRecord.incident_description;
      document.getElementById("pdfCorrectivePlan").textContent = actionRecord.corrective_plan || "—";
      document.getElementById("pdfManagerName").textContent = actionRecord.manager_name;
      document.getElementById("pdfHrWitness").textContent = actionRecord.hr_witness || "—";
      document.getElementById("pdfAckPolicyProvided").textContent = actionRecord.ack_policy_provided ? "Yes" : "No";

      pdfContainer.classList.remove("hidden");

      const opt = {
        margin: 0.5,
        filename: `JengChi_Corrective_Action_${fullName || "Employee"}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
      };

      try {
        await html2pdf().set(opt).from(pdfContainer).save();
      } catch (err) {
        console.error("PDF generation error:", err);
        window.alert("Error generating PDF. Check console for details.");
      } finally {
        pdfContainer.classList.add("hidden");
      }
    }

    /* --------------------------------------------------
       PART C: EDIT / DELETE ENGINE
    -------------------------------------------------- */
    
    // ⭐ OPEN EDIT MODAL
    function openEditAction(index) {
      const action = currentHistory[index];
      if (!action) return;

      currentActionIndex = index; // Store index for later delete/save logic
      
      document.getElementById("editActionIndex").value = index;
      document.getElementById("editActionType").value = action.action_type;
      document.getElementById("editIncidentDate").value = action.incident_date;
      document.getElementById("editPolicyArea").value = action.policy_area || "";
      document.getElementById("editIncidentDescription").value = action.incident_description || "";
      document.getElementById("editCorrectivePlan").value = action.corrective_plan || "";
      document.getElementById("editManagerName").value = action.manager_name || "";
      document.getElementById("editHrWitness").value = action.hr_witness || "";

      document.getElementById("editActionModal").classList.remove("hidden");
    }
    
    // ⭐ CLOSE EDIT MODAL
    function closeEditModal() {
      document.getElementById("editActionModal").classList.add("hidden");
      currentActionIndex = -1;
    }
    
    // ⭐ SAVE EDITED ACTION
    async function saveEditedAction() {
      const idx = Number(document.getElementById("editActionIndex").value);
      const action = currentHistory[idx];

      if (!action) return;

      // 1. Updated values (Update local state copy)
      action.action_type = document.getElementById("editActionType").value;
      action.incident_date = document.getElementById("editIncidentDate").value;
      action.policy_area = document.getElementById("editPolicyArea").value;
      action.incident_description = document.getElementById("editIncidentDescription").value;
      action.corrective_plan = document.getElementById("editCorrectivePlan").value;
      action.manager_name = document.getElementById("editManagerName").value;
      action.hr_witness = document.getElementById("editHrWitness").value;
      
      // Update employee summary counts if action type changed
      const counts = computeHistoryCounts(currentHistory);

      /* 2. SAVE TO SUPABASE (update full history array and counts) */
      const { data, error } = await supabaseClient
        .from("employees2025")
        .update({ 
            discipline_history: currentHistory, 
            last_disciplinary_action: action,
            disciplinary_warning_count: counts.written,
            final_warning_count: counts.final,
            termination_letter_count: counts.term,
        })
        .eq("employee_id", currentEmployee.employee_id)
        .select()
        .single();

      if (error) {
        window.alert("Error saving changes: " + error.message);
        return;
      }
      
      // 3. Update local state and UI
      loadEmployeeRecord(data); // Re-load to ensure fresh data and recalculate everything
      renderMetrics();
      
      window.alert("Action updated successfully.");

      closeEditModal();
    }
    
    // ⭐ DELETE CONFIRMATION
    function deleteActionConfirm() {
      document.getElementById("editActionModal").classList.add("hidden");
      document.getElementById("deleteActionModal").classList.remove("hidden");
    }
    
    // ⭐ CLOSE DELETE MODAL
    function closeDeleteModal() {
      document.getElementById("deleteActionModal").classList.add("hidden");
      document.getElementById("editActionModal").classList.remove("hidden"); // Return to edit modal
    }
    
    // ⭐ DELETE ACTION
    async function deleteAction() {
      const idx = currentActionIndex;
      
      if (idx === -1 || idx >= currentHistory.length) {
          closeDeleteModal();
          return;
      }
      
      const removed = currentHistory.splice(idx, 1);
      const counts = computeHistoryCounts(currentHistory);
      
      const lastAction = currentHistory.length > 0 ? currentHistory[currentHistory.length - 1] : null;

      /* UPDATE SUPABASE */
      const { data, error } = await supabaseClient
        .from("employees2025")
        .update({ 
            discipline_history: currentHistory,
            last_disciplinary_action: lastAction,
            disciplinary_warning_count: counts.written,
            final_warning_count: counts.final,
            termination_letter_count: counts.term,
        })
        .eq("employee_id", currentEmployee.employee_id)
        .select()
        .single();

      if (error) {
        window.alert("Error deleting action: " + error.message);
        return;
      }

      window.alert("Action deleted successfully.");

      closeDeleteModal();
      loadEmployeeRecord(data); // Re-load to ensure fresh data and recalculate everything
      renderMetrics();
    }


    /* --------------------------------------------------
       PART F & G: Behavioral/Predictive Engine Logic
    -------------------------------------------------- */
    
    // PART G: Sentiment Scoring
    function computeSentimentScore(description) {
      const desc = (description || "").toLowerCase();
      let score = 0;

      Object.values(behaviorLexicon).flat().forEach(keyword => {
        if (desc.includes(keyword)) score += 10;
      });

      // Severity modifiers
      if (desc.includes("final warning")) score += 20;
      if (desc.includes("termination")) score += 30;
      if (desc.includes("threat")) score += 25;

      return score;
    }
    
    function detectBehaviorCategories(description) {
      const desc = (description || "").toLowerCase();
      const categories = [];

      for (const [cat, keywords] of Object.entries(behaviorLexicon)) {
        if (keywords.some(k => desc.includes(k))) {
          categories.push(cat);
        }
      }

      return categories;
    }

    function computeEmployeeBehaviorProfile(employee) {
      const history = employee.discipline_history || [];

      let totalScore = 0;
      let allCategories = [];

      history.forEach(act => {
        const score = computeSentimentScore(act.incident_description || "");
        const cats = detectBehaviorCategories(act.incident_description || "");

        totalScore += score;
        allCategories = allCategories.concat(cats);
      });

      const uniqueCategories = [...new Set(allCategories)];

      return {
        score: totalScore,
        categories: uniqueCategories
      };
    }

    function determineBehavioralFlag(score, categories) {
      if (score >= 120) return { label: "High Risk Pattern", color: "bg-rose-600 text-white", icon:"fa-circle-exclamation" };
      if (score >= 80) return { label: "Escalation Detected", color: "bg-amber-600 text-white", icon:"fa-triangle-exclamation" };
      if (score >= 40) return { label: "Performance Concerns", color: "bg-yellow-400 text-slate-800", icon:"fa-exclamation" };
      return { label: "Active", color: "bg-emerald-600 text-white", icon:"fa-check" };

    }

    function renderBehaviorFlags(employee) {
      const container = document.getElementById("behaviorFlags");
      if (!container) return;
      container.innerHTML = "";

      const profile = computeEmployeeBehaviorProfile(employee);
      const flag = determineBehavioralFlag(profile.score, profile.categories);

      const pill = document.createElement("div");
      pill.className = `inline-flex items-center gap-2 px-4 py-2 rounded-xl text-xs font-semibold shadow ${flag.color}`;
      pill.innerHTML = `<i class="fa-solid ${flag.icon}"></i> ${flag.label}`;

      container.appendChild(pill);

      // Optional: display categories
      if (profile.categories.length) {
        profile.categories.slice(0, 3).forEach(cat => { // Limit to top 3 categories
          const c = document.createElement("span");
          c.className = "px-3 py-1 rounded-lg bg-slate-200 text-slate-700 text-xs";
          c.textContent = cat.replace(/_/g, " ").toUpperCase();
          container.appendChild(c);
        });
      }
    }
    
    
    // PART F: Prediction Logic (Integrated into Analytics Load)
    
    function predictEmployeeRisk(employees) {
      return employees.map(e => {
        const hist = e.discipline_history || [];

        const last90 = hist.filter(a => {
          const d = new Date(a.incident_date || a.created_at);
          return (Date.now() - d.getTime()) < (90 * 24 * 60 * 60 * 1000);
        }).length;

        const finalWarnings = e.final_warning_count || 0;
        const written = e.disciplinary_warning_count || 0;

        // AI-inspired weighted score
        const score =
          last90 * 25 +
          written * 10 +
          finalWarnings * 35 +
          hist.length * 4;

        return { employee: e, score };
      })
        .filter(x => x.score >= 40)
        .sort((a, b) => b.score - a.score);
    }

    function computeDepartmentVolatility(employees) {
      const dept = {};

      employees.forEach(e => {
        const h = e.discipline_history || [];
        const d = e.department || e.position || "Unknown";

        if (!dept[d]) dept[d] = [];

        dept[d].push(h.length);
      });

      const volatility = Object.entries(dept).map(([d, incidents]) => {
        const avg = incidents.reduce((a,b)=>a+b,0) / incidents.length;
        const variance = incidents.map(i => Math.pow(i - avg, 2))
                                  .reduce((a,b)=>a+b,0) / incidents.length;

        const score = Math.round(Math.sqrt(variance) * 10); // normalized

        return { department: d, score };
      });

      return volatility.sort((a,b)=>b.score - a.score);
    }

    function computeManagerRisk(employees) {
      const mgrMap = {};

      employees.forEach(e => {
        const manager = e.report_to || "No Manager Assigned";
        const hist = e.discipline_history || [];

        if (!mgrMap[manager]) mgrMap[manager] = 0;

        mgrMap[manager] += hist.length;
      });

      return Object.entries(mgrMap)
        .map(([manager, count]) => ({ manager, count }))
        .sort((a,b)=>b.count - a.count);
    }
    
    // PART F: Renderers
    
    function renderPredictionSummary(empForecast, volatility) {
      const el = document.getElementById("predictionSummary");
      if (!el) return;

      const highDept = volatility[0];
      const highCount = empForecast.length;

      el.innerHTML = `
        <strong class="text-brand-red">Predictive Forecast Active:</strong>
        ${highCount} employees show elevated incident likelihood within the next 90 days.
        Highest volatility detected in: 
        <strong>${highDept.department}</strong>.
      `;
    }

    function renderForecastEmployeeList(list) {
      const box = document.getElementById("forecastEmployeeList");
      if (!box) return;
      box.innerHTML = "";

      if (!list.length) {
        box.innerHTML = `<p class="text-slate-400">No employees show elevated risk.</p>`;
        return;
      }

      list.forEach(({ employee, score }) => {
        const div = document.createElement("div");
        div.className = "p-4 border border-slate-200 rounded-xl shadow-sm flex justify-between items-center hover:bg-slate-50 transition cursor-pointer";

        div.innerHTML = `
          <div>
            <p class='font-semibold text-slate-700'>
              ${employee.first_name || ""} ${employee.last_name || ""}
            </p>
            <p class='text-xs text-slate-500'>
              ${employee.position || "—"} • ${employee.department || "—"}
            </p>
          </div>
          <span class='px-3 py-1 rounded-lg bg-rose-600 text-white text-xs'>
            Forecast Score: ${score}
          </span>
        `;
        div.onclick = () => selectEmployee(employee);
        box.appendChild(div);
      });
    }

    function renderVolatility(list) {
      const box = document.getElementById("forecastDeptVolatility");
      if (!box) return;
      box.innerHTML = "";

      list.forEach(({ department, score }) => {
        const color = score > 30 ? "bg-rose-100" :
                      score > 15 ? "bg-amber-100" : "bg-emerald-100";

        const textColor = score > 30 ? "text-rose-700" :
                          score > 15 ? "text-amber-700" : "text-emerald-700";

        const div = document.createElement("div");
        div.className = `p-4 rounded-xl border border-slate-200 shadow ${color}`;

        div.innerHTML = `
          <p class="font-heading text-lg text-slate-700">${department}</p>
          <p class="text-sm mt-1">Volatility Score: <strong class="${textColor}">${score}</strong></p>
        `;

        box.appendChild(div);
      });
    }

    function renderManagerRisk(list) {
      const box = document.getElementById("managerRiskAttribution");
      if (!box) return;
      box.innerHTML = "";

      list.forEach(({ manager, count }) => {
        const div = document.createElement("div");

        div.className = "p-4 border border-slate-200 rounded-xl shadow-sm flex justify-between items-center";

        div.innerHTML = `
          <p class="text-slate-700">${manager}</p>
          <span class="px-3 py-1 rounded-lg bg-brand-red/10 text-brand-red text-xs">
            ${count} incidents
          </span>
        `;

        box.appendChild(div);
      });
    }
    
    // PART F/G: Main Prediction Engine Call
    async function generatePredictionEngine(employees) {
      const forecastEmployees = predictEmployeeRisk(employees);
      const volatility = computeDepartmentVolatility(employees);
      const managerRisk = computeManagerRisk(employees);

      renderPredictionSummary(forecastEmployees, volatility);
      renderForecastEmployeeList(forecastEmployees);
      renderVolatility(volatility);
      renderManagerRisk(managerRisk);
    }
    

    /* --------------------------------------------------
       Analytics (Charts + Heatmap + Exports)
    -------------------------------------------------- */
    
    // Analytics functions copied from Part D...

    Chart.defaults.font.family = "Manrope, sans-serif";
    Chart.defaults.color = "#374151";
    Chart.defaults.font.size = 12;

    const chartRegistry = { trend: null, department: null, severity: null };

    function destroyChart(name) {
      if (chartRegistry[name]) {
        chartRegistry[name].destroy();
        chartRegistry[name] = null;
      }
    }

    // LINE TREND (Part D)
    function initTrendChart(labels, values) {
      destroyChart("trend");
      const ctx = document.getElementById("disciplineTrendChart");
      if (!ctx) return;
      chartRegistry.trend = new Chart(ctx.getContext("2d"), {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Total Actions",
              data: values,
              borderColor: "#7a1f1f",
              backgroundColor: "rgba(122,31,31,0.15)",
              tension: 0.3,
              borderWidth: 2,
              fill: true,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          interaction: { intersect: false, mode: "index" },
          plugins: {
            legend: { position: "top" },
          },
          scales: {
            x: {
              title: {
                display: true,
                text: "Month",
                font: { family: "Cinzel", size: 13 },
              },
            },
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Count",
                font: { family: "Cinzel", size: 13 },
              },
            },
          },
        },
      });
    }
    
    // RISK BAR CHART (Part D)
    function initDepartmentRiskChart(labels, scores) {
      destroyChart("department");
      const ctx = document.getElementById("departmentRiskChart");
      if (!ctx) return;
      chartRegistry.department = new Chart(ctx.getContext("2d"), {
        type: "bar",
        data: {
          labels,
          datasets: [
            {
              label: "Risk Score",
              data: scores,
              backgroundColor: "#7a1f1f",
              borderRadius: 6,
            },
          ],
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { display: false },
            tooltip: {
              callbacks: {
                label: function (ctx) {
                  return `Risk Score: ${ctx.raw}`;
                },
              },
            },
          },
          scales: {
            x: { ticks: { font: { size: 11 } } },
            y: { beginAtZero: true },
          },
        },
      });
    }
    
    // SEVERITY DONUT CHART (Part D)
    function renderSeverityChart(d) {
      destroyChart("severity");
      const ctx = document.getElementById("severityChart");
      if (!ctx) return;

      chartRegistry.severity = new Chart(ctx, {
        type: "doughnut",
        data: {
          labels: ["Verbal", "Written", "Final", "Termination"],
          datasets: [{
            data: [d.verbal, d.written, d.final, d.termination],
            backgroundColor: ["#94a3b8","#d4b171","#f59e0b","#b91c1c"]
          }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { position: 'right' }
            }
        }
      });
    }

    // HEATMAP (Part D)
    function drawHeatmap(matrix, monthLabels, dayLabels) {
      const canvas = document.getElementById("disciplineHeatmapCanvas");
      if (!canvas) return;
      const ctx = canvas.getContext("2d");
      const width = canvas.width;
      const height = canvas.height;

      ctx.clearRect(0, 0, width, height);

      const cols = monthLabels.length;
      const rows = dayLabels.length;
      const cellWidth = width / (cols + 1);
      const cellHeight = height / (rows + 1);

      ctx.font = "14px Manrope";
      ctx.fillStyle = "#374151";

      // Month labels
      monthLabels.forEach((m, i) => {
        const x = (i + 1) * cellWidth + cellWidth / 2;
        ctx.fillText(m, x - 15, 20);
      });

      // Day labels
      dayLabels.forEach((d, i) => {
        const y = (i + 1) * cellHeight + cellHeight / 1.4;
        ctx.fillText(d, 10, y);
      });

      // Cells
      for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
          const value = matrix[r][c];
          const max = 10;
          const intensity = Math.min(value / max, 1);
          const color = `rgba(${122 + 60 * intensity}, ${31}, ${31}, ${
            0.08 + intensity * 0.35
          })`;
          const x = (c + 1) * cellWidth;
          const y = (r + 1) * cellHeight;

          ctx.fillStyle = color;
          ctx.fillRect(x, y, cellWidth - 4, cellHeight - 4);
          ctx.strokeStyle = "#e5e7eb";
          ctx.strokeRect(x, y, cellWidth - 4, cellHeight - 4);
        }
      }
    }
    
    // DATA GENERATORS (Part D)
    
    async function loadAnalyticsData() {
      const { data, error } = await supabaseClient.from("employees2025").select("*");
      if (error) {
        console.error("Analytics fetch error:", error);
        return null;
      }
      return data || [];
    }

    function build12MonthTrend(allEmployees) {
      const now = new Date();
      const months = [];
      const monthlyActions = [];

      for (let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        const label = d.toLocaleString("en-US", { month: "short" });
        months.push(label);
        monthlyActions.push(0);
      }

      for (const emp of allEmployees) {
        const history = Array.isArray(emp.discipline_history)
          ? emp.discipline_history
          : [];
        history.forEach((entry) => {
          const dt = new Date(entry.incident_date || entry.created_at);
          if (isNaN(dt.getTime())) return;
          const diffMonths =
            (now.getFullYear() - dt.getFullYear()) * 12 +
            (now.getMonth() - dt.getMonth());
          if (diffMonths >= 0 && diffMonths < 12) {
            const idx = 11 - diffMonths;
            monthlyActions[idx]++;
          }
        });
      }

      return { months, values: monthlyActions };
    }

    function computeDepartmentRisk(allEmployees) {
      const deptMap = {};
      allEmployees.forEach((emp) => {
        const dep =
          emp.department || emp.position || "Unknown Department";
        if (!deptMap[dep]) {
          deptMap[dep] = { score: 0 };
        }
        const hist = Array.isArray(emp.discipline_history)
          ? emp.discipline_history
          : [];
        // Simplified risk score based on counts for chart
        deptMap[dep].score += (emp.disciplinary_warning_count || 0) * 1;
        deptMap[dep].score += (emp.final_warning_count || 0) * 3;
        deptMap[dep].score += (emp.termination_letter_count || 0) * 8;
      });

      const sortedDepts = Object.entries(deptMap).sort(([, a], [, b]) => b.score - a.score);

      const labels = sortedDepts.map(([label]) => label);
      const scores = sortedDepts.map(([, { score }]) => score);
      
      const highestRiskDept = labels.length ? labels[0] : "—";
      return { labels, scores, highestRiskDept };
    }

    function buildHeatmap(allEmployees) {
      const matrix = Array.from({ length: 7 }, () => Array(12).fill(0));
      const now = new Date();

      for (const emp of allEmployees) {
        const hist = Array.isArray(emp.discipline_history)
          ? emp.discipline_history
          : [];
        hist.forEach((entry) => {
          const dt = new Date(entry.incident_date || entry.created_at);
          if (isNaN(dt.getTime())) return;
          const diffMonths =
            (now.getFullYear() - dt.getFullYear()) * 12 +
            (now.getMonth() - dt.getMonth());
          if (diffMonths >= 0 && diffMonths < 12) {
            const monthIndex = 11 - diffMonths;
            const dayIndex = dt.getDay(); // 0 (Sun) to 6 (Sat)
            matrix[dayIndex][monthIndex]++;
          }
        });
      }

      const monthLabels = [];
      for (let i = 11; i >= 0; i--) {
        const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
        monthLabels.push(d.toLocaleString("en-US", { month: "short" }));
      }

      const dayLabels = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
      return { matrix, monthLabels, dayLabels };
    }
    
    function generateSeverityData(allEmployees) {
        const d = { verbal: 0, written: 0, final: 0, termination: 0 };
        allEmployees.forEach(e => {
            d.written += (e.disciplinary_warning_count || 0);
            d.final += (e.final_warning_count || 0);
            d.termination += (e.termination_letter_count || 0);
            (e.discipline_history || []).forEach(act => {
                if (act.action_type === "VERBAL_WARNING") d.verbal++;
            });
        });
        return d;
    }


    function generatePredictiveInsights(allEmployees) {
      const insights = [];
      const highRiskEmployees = [];

      allEmployees.forEach((emp) => {
        const risk = calculateRiskScore(emp);
        if (risk >= 40) {
          highRiskEmployees.push({
            name: `${emp.first_name || ""} ${emp.last_name || ""}`.trim(),
            score: risk,
          });
        }
      });

      highRiskEmployees.sort((a, b) => b.score - a.score);
      if (highRiskEmployees.length > 0) {
        insights.push(
          `<strong>High-Risk Employees:</strong> ${highRiskEmployees
            .map((e) => `${e.name} (score ${e.score})`)
            .slice(0, 3) // Show top 3 in summary
            .join(", ")}`
        );
      }

      const dept = computeDepartmentRisk(allEmployees);
      insights.push(
        `<strong>Highest Risk Department:</strong> ${dept.highestRiskDept}`
      );

      const trend = build12MonthTrend(allEmployees);
      const recentActions = trend.values.slice(-3);
      const last3Sum = recentActions.reduce((a, b) => a + b, 0);
      
      const avgMonthly = trend.values.slice(0, 9).reduce((a,b)=>a+b,0) / 9;

      if (last3Sum > avgMonthly * 1.5) {
        insights.push(
          "Written warnings have increased significantly in the last 90 days."
        );
      }
      
      const termCount = allEmployees.reduce((t, e) => t + (e.termination_letter_count || 0), 0);
      if (termCount > 5) {
          insights.push("Termination volume is elevated this year. Ensure TWC compliance is documented on all final actions.");
      }


      if (!insights.length) {
        insights.push("No significant risk indicators detected at this time.");
      }
      return insights;
    }

    async function renderAnalyticsDashboard() {
      const employees = await loadAnalyticsData();
      if (!employees) return;

      const kpiTotalWarnings = employees.reduce(
        (sum, e) => sum + (e.disciplinary_warning_count || 0) + (e.final_warning_count || 0),
        0
      );
      const kpiFinalWarnings = employees.reduce(
        (sum, e) => sum + (e.final_warning_count || 0),
        0
      );
      const kpiTerminations = employees.reduce(
        (sum, e) => sum + (e.termination_letter_count || 0),
        0
      );

      document.getElementById("kpiTotalWarnings").textContent = kpiTotalWarnings;
      document.getElementById("kpiFinalWarningsAnalytics").textContent =
        kpiFinalWarnings;
      document.getElementById("kpiTerminationsAnalytics").textContent =
        kpiTerminations;

      const trend = build12MonthTrend(employees);
      initTrendChart(trend.months, trend.values);

      const dept = computeDepartmentRisk(employees);
      initDepartmentRiskChart(dept.labels, dept.scores);
      document.getElementById("kpiRiskDept").textContent = dept.highestRiskDept;

      const severity = generateSeverityData(employees);
      renderSeverityChart(severity);

      const heat = buildHeatmap(employees);
      drawHeatmap(heat.matrix, heat.monthLabels, heat.dayLabels);

      const insights = generatePredictiveInsights(employees);
      const ul = document.getElementById("predictiveInsights");
      if(ul) {
        ul.innerHTML = "";
        insights.forEach((i) => {
          const li = document.createElement("li");
          li.innerHTML = i;
          ul.appendChild(li);
        });
      }

      // Top 10 risk employees (simple reuse of calculateRiskScore)
      const scored = employees.map((emp) => {
        const risk = calculateRiskScore(emp);
        return {
          ...emp,
          risk_score: risk,
          risk_level: getRiskLevel(risk),
        };
      });
      const top10 = scored.sort((a, b) => b.risk_score - a.risk_score).slice(0, 10);
      const list = document.getElementById("topRiskList");
      if(list) {
        list.innerHTML = "";
        top10.forEach((emp) => {
          const item = document.createElement("div");
          item.className =
            "flex justify-between border-b border-slate-100 py-1 text-xs sm:text-sm";
          item.innerHTML = `
            <span>${(emp.first_name || "")} ${(emp.last_name || "")}</span>
            <span class="font-semibold">${emp.risk_level} (${emp.risk_score})</span>
          `;
          list.appendChild(item);
        });
      }
      
      // PART F: Integrate Prediction Engine Output
      generatePredictionEngine(employees);

      // Static AI model info (placeholder)
      document.getElementById("aiModelVersion").textContent =
        "Model Version: HR-Risk-v1 (static)";
      document.getElementById("aiAccuracy").textContent = "~88% (simulated)";
      const featureList = document.getElementById("aiFeatureList");
      if(featureList) {
        featureList.innerHTML = `
          <li>Written Warnings</li>
          <li>Final Warnings</li>
          <li>Incident Frequency (last 6 months)</li>
          <li>Policy Severity (Harassment / Safety / Wage)</li>
          <li>Missed Follow-Up Dates</li>
        `;
      }
    }
    
    async function initializeAnalytics() {
        const employees = await loadAnalyticsData();
        if (!employees) return;
        renderAnalyticsDashboard();
    }


    /* --------------------------------------------------
       Executive Summary (Part E)
    -------------------------------------------------- */
    async function initializeExecutiveSummary() {
      const employees = await loadAnalyticsData();
      if (!employees) return;

      loadExecutiveSummary(employees);
    }
    
    function loadExecutiveSummary(employees) {
      const allActions = employees.flatMap(e => e.discipline_history || []);

      // KPIs
      document.getElementById("execTotalEmployees").textContent = employees.length;
      document.getElementById("execTotalActions").textContent = allActions.length;

      const termCount = employees.reduce((t, e) => t + (e.termination_letter_count || 0), 0);
      document.getElementById("execTerminations").textContent = termCount;

      // Average Risk Score
      const riskScores = employees.map(e => {
        const hist = e.discipline_history || [];
        // PART E: Use the simplified scoring logic as requested in the prompt for this view
        return (hist.length * 10) + ((e.final_warning_count || 0) * 25);
      });

      const avgRisk = riskScores.length ? (riskScores.reduce((a,b)=>a+b,0) / riskScores.length).toFixed(1) : 0;
      document.getElementById("execAvgRisk").textContent = avgRisk;

      // Risk Insight Narrative
      document.getElementById("execRiskInsight").innerHTML = generateRiskNarrative(avgRisk, termCount);

      // High Risk Table
      const highRisk = employees
        .map(e => {
          const hist = e.discipline_history || [];
          const score = (hist.length * 10) + ((e.final_warning_count || 0) * 25);
          return { e, score };
        })
        .filter(x => x.score > 40)
        .sort((a,b)=>b.score - a.score);

      renderExecHighRiskTable(highRisk);
    }
    
    function generateRiskNarrative(avgRisk, termCount) {
      let message = "";

      if (avgRisk >= 60)
        message += "<strong class='text-rose-600'>High organizational risk detected.</strong> Immediate HR review is recommended.<br>";

      else if (avgRisk >= 40)
        message += "<strong class='text-amber-600'>Moderate risk present.</strong> Monitor rising departments closely.<br>";

      else
        message += "<strong class='text-emerald-600'>Risk level stable.</strong> Continue standard compliance oversight.<br>";

      if (termCount > 5)
        message += "Terminations YTD are above expected levels. Review policy enforcement consistency.";

      return message;
    }
    
    function renderExecHighRiskTable(list) {
      const tbody = document.getElementById("execHighRiskTable");
      if (!tbody) return;
      tbody.innerHTML = "";

      if (!list.length) {
        tbody.innerHTML = "<tr><td colspan='4' class='py-4 text-center text-slate-400'>No high-risk employees.</td></tr>";
        return;
      }

      list.forEach(({ e, score }) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td class="py-2 px-3">${e.first_name || ""} ${e.last_name || ""}</td>
          <td class="py-2 px-3">${e.position || e.job_title || "—"}</td>
          <td class="py-2 px-3">${e.department || "—"}</td>
          <td class="py-2 px-3 text-right font-semibold text-rose-700">${score}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    
    function generateExecutivePDF() {
      const element = document.getElementById("view-executive");
      if (!element) return;

      const opt = {
        margin:       0.5,
        filename:     `JengChi_ExecutiveReport_${new Date().toISOString().slice(0,10)}.pdf`,
        image:        { type: 'jpeg', quality: 0.98 },
        html2canvas:  { scale: 2 },
        jsPDF:        { unit: 'in', format: 'letter', orientation: 'portrait' }
      };

      html2pdf().set(opt).from(element).save();
    }
    

    /* --------------------------------------------------
       Analytics Exports + Email Stub
    -------------------------------------------------- */
    async function exportAnalyticsPDF() {
      const element = document.getElementById("analyticsMainContainer");
      if (!element) {
        window.alert("Analytics container not found.");
        return;
      }
      const opt = {
        margin: 0.4,
        filename: `JengChi_Analytics_Report_${new Date().getFullYear()}.pdf`,
        image: { type: "jpeg", quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
      };
      await html2pdf().set(opt).from(element).save();
    }

    function exportAnalyticsCSV(allEmployees) {
      if (!Array.isArray(allEmployees)) return;
      let csv =
        "First Name,Last Name,Department,Position,Verbal,Written,Final,Terminations\n";
      allEmployees.forEach((emp) => {
        const history = Array.isArray(emp.discipline_history)
          ? emp.discipline_history
          : [];
        const counts = computeHistoryCounts(history);
        csv += `${emp.first_name || ""},${emp.last_name || ""},${
          emp.department || ""
        },${emp.position || ""},${counts.verbal},${counts.written},${
          counts.final
        },${counts.term}\n`;
      });

      const blob = new Blob([csv], { type: "text/csv" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `JengChi_Analytics_${new Date()
        .toISOString()
        .slice(0, 10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
    }

    async function exportAnalyticsExcel() {
      const employees = await loadAnalyticsData();
      if (!employees) {
        window.alert("Cannot export Excel — no employee data found.");
        return;
      }

      const wb = XLSX.utils.book_new();

      const kpiData = [
        ["Metric", "Value"],
        [
          "Total Warnings",
          employees.reduce(
            (s, e) => s + (e.disciplinary_warning_count || 0),
            0
          ),
        ],
        [
          "Final Warnings",
          employees.reduce((s, e) => s + (e.final_warning_count || 0), 0),
        ],
        [
          "Terminations",
          employees.reduce(
            (s, e) => s + (e.termination_letter_count || 0),
            0
          ),
        ],
        ["Active Employees", employees.length],
      ];
      const kpiSheet = XLSX.utils.aoa_to_sheet(kpiData);
      XLSX.utils.book_append_sheet(wb, kpiSheet, "Executive Summary");

      const dept = computeDepartmentRisk(employees);
      const deptRows = [["Department", "Risk Score"]];
      dept.labels.forEach((d, i) => {
        deptRows.push([d, dept.scores[i]]);
      });
      const deptSheet = XLSX.utils.aoa_to_sheet(deptRows);
      XLSX.utils.book_append_sheet(wb, deptSheet, "Dept Risk Ranking");

      const matrixRows = [
        ["Employee", "Verbal", "Written", "Final", "Terminations"],
      ];
      employees.forEach((emp) => {
        const hist = Array.isArray(emp.discipline_history)
          ? emp.discipline_history
          : [];
        const counts = computeHistoryCounts(hist);
        matrixRows.push([
          `${emp.first_name || ""} ${emp.last_name || ""}`.trim(),
          counts.verbal,
          counts.written,
          counts.final,
          counts.term,
        ]);
      });
      const matrixSheet = XLSX.utils.aoa_to_sheet(matrixRows);
      XLSX.utils.book_append_sheet(wb, matrixSheet, "Warning Matrix");

      const rawSheet = XLSX.utils.json_to_sheet(employees);
      XLSX.utils.book_append_sheet(wb, rawSheet, "Raw Employees");

      const filename = `JengChi_Analytics_Export_${new Date()
        .toISOString()
        .slice(0, 10)}.xlsx`;
      XLSX.writeFile(wb, filename);
    }

    async function sendExecutiveReportEmail() {
        // Mock function, showing the expected behavior
        window.alert("Email stub triggered: In a live system, this would securely send the PDF and Excel reports to the executive distribution list via a Supabase Edge Function.");
    }
    
    
    /* --------------------------------------------------
       PART B: KPI Panel Engine
    -------------------------------------------------- */
    
    // ⭐ OPEN KPI PANEL
    function openKpiPanel(type) {
      const panel = document.getElementById("kpiPanel");
      const title = document.getElementById("kpiPanelTitle");
      const subtitle = document.getElementById("kpiPanelSubtitle");
      const list = document.getElementById("kpiPanelList");

      let label = "";
      let filterType = "";

      if (type === "employees") {
        label = "Active Employees";
        filterType = "employees";
      }
      if (type === "written") {
        label = "Written Warnings";
        filterType = "WRITTEN_WARNING";
      }
      if (type === "final") {
        label = "Final Warnings";
        filterType = "FINAL_WARNING";
      }
      if (type === "termination") {
        label = "Terminations";
        filterType = "TERMINATION";
      }

      title.textContent = label;

      /* ==================================
         LOAD FILTERED DATA FROM SUPABASE
         ================================== */
      if (filterType === "employees") {
        subtitle.textContent = "List of all active employees";
        loadActiveEmployees(list);
      } else {
        subtitle.textContent = `Showing all ${label}`;
        loadFilteredWarnings(list, filterType);
      }

      panel.classList.remove("translate-x-full");
    }
    
    // ⭐ CLOSE KPI PANEL
    function closeKpiPanel() {
      document.getElementById("kpiPanel").classList.add("translate-x-full");
    }
    
    // ⭐ LOAD ACTIVE EMPLOYEES IN KPI PANEL
  // ⭐ LOAD ACTIVE EMPLOYEES IN KPI PANEL
async function loadActiveEmployees(list) {
  list.innerHTML = `<p class="text-sm text-slate-400">Loading…</p>`;

  try {
    const { data, error } = await supabaseClient
      .from("employees2025")
      .select(
        "id, employee_id, first_name, last_name, position_title, job_title, department, employment_status, status"
      )
      .order("last_name", { ascending: true });

    if (error) {
      console.error("loadActiveEmployees error:", error);
      list.innerHTML = `<p class="text-sm text-rose-600">Error loading employees.</p>`;
      return;
    }

    const activeEmployees = (data || []).filter((emp) => {
      const status = String(emp.employment_status || emp.status || "")
        .trim()
        .toLowerCase();
      // only check if they are active – don't require employee_id
      return status === "active";
    });

    console.log(
      "[loadActiveEmployees] rows:",
      (data || []).length,
      "active:",
      activeEmployees.length
    );

    if (!activeEmployees.length) {
      list.innerHTML = `<p class="text-sm text-slate-500">No active employees found.</p>`;
      return;
    }

    list.innerHTML = "";

    activeEmployees.forEach((emp) => {
      const row = document.createElement("div");
      row.className =
        "p-4 border border-slate-200 rounded-xl shadow-sm hover:bg-slate-50 cursor-pointer transition";

      const position = emp.position_title || emp.job_title || "—";
      const department = emp.department || "—";

      row.innerHTML = `
        <p class="font-medium text-slate-900 text-sm">
          ${(emp.first_name || "")} ${(emp.last_name || "")}
        </p>
        <p class="text-xs text-slate-500">${position} • ${department}</p>
      `;

      row.onclick = () => {
        // Use employee_id if it exists, otherwise fall back to primary key id
        fetchEmployeeAndSelect(emp.employee_id || null, emp.id);
        closeKpiPanel();
      };

      list.appendChild(row);
    });
  } catch (e) {
    console.error("loadActiveEmployees exception:", e);
    list.innerHTML = `<p class="text-sm text-rose-600">Error loading employees.</p>`;
  }
}




    // ⭐ LOAD FILTERED WARNINGS FOR KPI PANEL
    async function loadFilteredWarnings(list, type) {
  list.innerHTML = `<p class="text-sm text-slate-400">Loading…</p>`;

  try {
    const { data, error } = await supabaseClient
      .from("employees_discipline_actions")
      .select("*")
      .order("incident_date", { ascending: false });

    if (error) {
      console.error("loadFilteredWarnings error:", error);
      list.innerHTML = `<p class="text-sm text-rose-600">Error loading records.</p>`;
      return;
    }

    const normalizedTarget = String(type || "")
      .toUpperCase()
      .replace(/\s+/g, "_");

    // accept WRITTEN_WARNING, Written Warning, written warning, etc.
    const actions = (data || []).filter(a => {
      const normalized = String(a.action_type || "")
        .toUpperCase()
        .replace(/\s+/g, "_");
      return normalized === normalizedTarget;
    });

    if (!actions.length) {
      list.innerHTML = `<p class="text-sm text-slate-500">No records found.</p>`;
      return;
    }

    // build employee name map
    const ids = [...new Set(actions.map(a => a.employee_id))];
    let nameMap = {};

    if (ids.length) {
      const { data: emps, error: empError } = await supabaseClient
        .from("employees2025")
        .select("employee_id, first_name, last_name")
        .in("employee_id", ids);

      if (!empError && emps) {
        emps.forEach(e => {
          nameMap[e.employee_id] =
            `${e.first_name || ""} ${e.last_name || ""}`.trim();
        });
      }
    }

    list.innerHTML = "";

    actions.forEach(action => {
      const employeeName =
        nameMap[action.employee_id] || `ID ${action.employee_id}`;
      const div = document.createElement("div");
      div.className =
        "p-4 border border-slate-200 rounded-xl shadow-sm bg-white flex flex-col gap-1";

      div.innerHTML = `
        <p class="font-medium text-slate-900 text-sm">
          ${employeeName}
        </p>
        <p class="text-xs text-slate-500">
          ${truncateText(action.incident_description || "", 80)}
        </p>
        <div class="flex justify-between text-xs mt-2">
          <span class="text-slate-500">
            ${new Date(action.incident_date || action.created_at).toLocaleDateString()}
          </span>
          <button class="text-brand-red hover:underline"
                  onclick="openActionFromKpi(${action.employee_id})">
            View History
          </button>
        </div>
      `;

      list.appendChild(div);
    });
  } catch (e) {
    console.error("loadFilteredWarnings exception:", e);
    list.innerHTML = `<p class="text-sm text-rose-600">Error loading records.</p>`;
  }
}



    
    // ⭐ LOAD EMPLOYEE FROM KPI PANEL (VIEW BUTTON)
  async function openActionFromKpi(empId) {
  await fetchEmployeeAndSelect(empId);   // empId here is employee_id from actions table
  closeKpiPanel();
  switchView("history");
}

    /* --------------------------------------------------
       Init
    -------------------------------------------------- */
    document.addEventListener("DOMContentLoaded", () => {
      setFooterYear();
      bindSidebarNavigation();
      initGlobalSearchEvents();
      
      // Load initial dashboard data
      loadDashboardKPIs();
      loadRecentActions();
      renderAnalyticsDashboard();

      // Start on dashboard
      switchView("dashboard");
    });
  </script>
</body>
</html>
