<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Executive Employee Management</title>

  <!-- Gate -->
  <script>
    const manager = sessionStorage.getItem("manager");
    if (!manager) {
      // Uncomment to enforce gate in production:
      // location.href = "https://portal.jengchirestaurant.com/index.html";
    }
  </script>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

  <style>
    :root{ --ink:#0f172a; --muted:#64748b; --line:#e6e8ee; }
    html,body{ height:100%; }
    body{ font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f7f8fb; color:var(--ink); }
    .brand{ height: clamp(56px, 8vw, 96px); }
    .card{ background:#fff; border:1px solid var(--line); border-radius:14px; }
    .shadow-soft{ box-shadow:0 10px 30px rgba(2,6,23,.06); }
    .field{ border:1px solid var(--line); border-radius:10px; padding:.7rem .9rem; }
    .field:focus{ outline:none; box-shadow:0 0 0 3px rgba(2,6,23,.12); border-color:#0f172a; }
    .tab-btn{ padding:.65rem 1rem; font-weight:800; border-bottom:2px solid transparent; color:#475569; }
    .tab-btn.active{ color:#0f172a; border-bottom-color:#0f172a; }
    .mini-tab{ padding:.45rem .8rem; border:1px solid var(--line); border-radius:999px; font-weight:700; font-size:.85rem; color:#334155; }
    .mini-tab.active{ background:#0f172a; color:#fff; border-color:#0f172a; }
    .suggest{ position:absolute; inset-inline:0; top:100%; margin-top:.4rem; background:#fff; border:1px solid var(--line); border-radius:12px; overflow:hidden; z-index:20; }
    .suggest-item{ padding:.6rem .9rem; cursor:pointer; }
    .suggest-item:hover{ background:#f8fafc; }
    .kpi{ background:#f8fafc; border:1px solid var(--line); border-radius:12px; padding:14px; text-align:center; }
  </style>
</head>

<body class="min-h-screen">
  <!-- Header -->
  <header class="bg-transparent">
    <div class="max-w-7xl mx-auto px-5 pt-6 pb-2 flex flex-col items-center">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
           alt="Jeng Chi Logo" class="brand mb-1"/>
      <h1 class="text-2xl md:text-3xl font-extrabold tracking-tight text-slate-800">Jeng Chi — Human Resources</h1>
      <p class="text-sm text-slate-500 mt-1">Executive Employee Management</p>
    </div>
  </header>

  <!-- Search -->
  <section class="max-w-3xl mx-auto px-5 mt-6">
    <div class="card shadow-soft p-5 relative">
      <label class="block text-sm font-semibold text-slate-700 mb-1">Search employee</label>
      <input id="searchInput" type="text" placeholder="Type a name…"
             class="field w-full" autocomplete="off"/>
      <div id="suggestions" class="suggest hidden"></div>
      <p id="statusMessage" class="text-xs text-slate-500 mt-3"></p>
    </div>
  </section>

  <!-- Main -->
  <main id="mainArea" class="max-w-7xl mx-auto px-5 mt-8 hidden">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
      <!-- Left -->
      <section class="lg:col-span-7 space-y-4">
        <!-- Banner -->
        <div class="card shadow-soft p-5">
          <div class="flex items-center gap-4">
            <div id="initials" class="w-16 h-16 rounded-full bg-blue-600 text-white flex items-center justify-center text-2xl font-extrabold"></div>
            <div>
              <div id="empName" class="text-xl font-extrabold"></div>
              <div id="empMeta" class="text-sm text-slate-600"></div>
            </div>
          </div>
        </div>

        <!-- Tabs -->
        <div class="card shadow-soft">
          <div class="flex gap-4 px-5 pt-4 border-b">
            <button class="tab-btn active" data-tab="profileTab">Profile</button>
            <button class="tab-btn" data-tab="historyTab">Disciplinary History</button>
            <button class="tab-btn" data-tab="newTab">New Disciplinary Action</button>
          </div>

          <div class="p-5">
            <!-- Profile -->
            <div id="profileTab">
              <form id="updateEmployeeForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-semibold mb-1">Full name</label>
                  <input name="full_name" class="field w-full"/>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Position</label>
                  <select name="primary_role" class="field w-full"></select>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Department</label>
                  <select name="department" class="field w-full"></select>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Hire date</label>
                  <input type="date" name="hire_date" class="field w-full"/>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold mb-1">Email</label>
                  <input type="email" name="email" class="field w-full"/>
                </div>
                <div class="md:col-span-2">
                  <label class="block text-sm font-semibold mb-1">Phone</label>
                  <input type="tel" name="phone" class="field w-full"/>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Reports to</label>
                  <select id="reportsToSelect" name="Current Reports To Employee" class="field w-full"></select>
                </div>
                <div>
                  <label class="block text-sm font-semibold mb-1">Manager role</label>
                  <p id="reportsToRole" class="mt-2 font-semibold text-slate-800">—</p>
                </div>

                <div class="md:col-span-2 mt-2">
                  <button class="w-full md:w-auto px-5 py-2 rounded-lg bg-slate-900 text-white font-extrabold">Update Profile</button>
                  <span id="updateStatusMessage" class="text-xs text-slate-500 ml-3"></span>
                </div>
              </form>
            </div>

            <!-- History -->
            <div id="historyTab" class="hidden">
              <div id="historyGroups" class="space-y-6"></div>
            </div>

            <!-- New -->
            <div id="newTab" class="hidden">
              <div class="flex flex-wrap gap-2 mb-4">
                <button class="mini-tab active" data-action="Verbal Warning">Verbal</button>
                <button class="mini-tab" data-action="Written Warning">Written</button>
                <button class="mini-tab" data-action="Termination">Termination</button>
                <button class="mini-tab" data-action="Two Weeks Notice">Two Weeks Notice</button>
                <button class="mini-tab" data-action="Resignation">Resignation</button>
              </div>
              <div id="formContainer" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right -->
      <aside class="lg:col-span-5 space-y-4">
        <div class="card shadow-soft p-5">
          <h3 class="text-lg font-extrabold mb-3">Summary</h3>
          <div class="grid grid-cols-2 sm:grid-cols-3 gap-3">
            <div class="kpi"><div class="text-lg font-extrabold text-blue-700" id="verbalCount">0</div><div class="text-xs text-slate-600">Verbal</div></div>
            <div class="kpi"><div class="text-lg font-extrabold text-yellow-700" id="writtenCount">0</div><div class="text-xs text-slate-600">Written</div></div>
            <div class="kpi"><div class="text-lg font-extrabold text-red-700" id="terminationCount">0</div><div class="text-xs text-slate-600">Termination</div></div>
            <div class="kpi"><div class="text-lg font-extrabold text-purple-700" id="twoWeekCount">0</div><div class="text-xs text-slate-600">Two Weeks</div></div>
            <div class="kpi"><div class="text-lg font-extrabold text-emerald-700" id="resignationCount">0</div><div class="text-xs text-slate-600">Resignation</div></div>
          </div>
        </div>

        <div class="card shadow-soft p-5">
          <div class="flex items-center justify-between mb-3">
            <h3 class="text-lg font-extrabold">Document Preview</h3>
            <div class="flex gap-2">
              <button id="btnPrint" class="px-3 py-1.5 text-sm rounded-lg border">Print</button>
              <button id="btnDownload" class="px-3 py-1.5 text-sm rounded-lg bg-slate-900 text-white">Download</button>
            </div>
          </div>
          <div id="documentPreview" class="text-sm text-slate-600">
            Select a record or create a new action to preview the PDF here.
          </div>
        </div>
      </aside>
    </div>
  </main>

  <script>
    /* ====== CONFIG ====== */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const { jsPDF } = window.jspdf;
    const COMPANY_LOGO_URL = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";

    // ✅ Fixed witness list used in ALL disciplinary actions
    const witnessNames = [
      "Pablo Gonzalez",
      "Shoko Teng",
      "Francisco Teng",
      "Janelle Teng",
      "Craig Reeves",
      "Anh Mai Vu"
    ];

    /* ====== DOM ====== */
    const searchInput = document.getElementById('searchInput');
    const suggestionsDiv = document.getElementById('suggestions');
    const statusMessageDiv = document.getElementById('statusMessage');
    const mainArea = document.getElementById('mainArea');
    const initials = document.getElementById('initials');
    const empName = document.getElementById('empName');
    const empMeta = document.getElementById('empMeta');

    const profileTab = document.getElementById('profileTab');
    const historyTab = document.getElementById('historyTab');
    const newTab = document.getElementById('newTab');
    const historyGroups = document.getElementById('historyGroups');

    const updateForm = document.getElementById('updateEmployeeForm');
    const reportsToSelect = document.getElementById('reportsToSelect');
    const reportsToRole = document.getElementById('reportsToRole');
    const updateStatusMessage = document.getElementById('updateStatusMessage');
    const formContainer = document.getElementById('formContainer');

    const documentPreview = document.getElementById('documentPreview');
    const btnPrint = document.getElementById('btnPrint');
    const btnDownload = document.getElementById('btnDownload');

    /* ====== STATE ====== */
    let employees = [];
    let positions = [];
    let departments = ["BOH","FOH","ADMIN"];
    let managers = [];
    let selectedEmployee = null;
    let fetchedDocuments = [];
    let cachedLogoDataUrl = null;
    let lastGeneratedDoc = null; // jsPDF instance

    /* ====== HELPERS ====== */
    const norm = s => (s||"").trim();
    const fmtDate = s => !s ? "" : new Date(s).toLocaleDateString("en-US");
    const getInitials = name => (name||"").split(/\s+/).filter(Boolean).map(p=>p[0]).slice(0,2).join("").toUpperCase();

    async function fetchDataUrl(url){
      try{
        const res = await fetch(url, { mode: "cors", cache: "force-cache" });
        const blob = await res.blob();
        return await new Promise((resolve) => {
          const fr = new FileReader();
          fr.onload = () => resolve(fr.result);
          fr.readAsDataURL(blob);
        });
      }catch(err){
        console.warn("Image fetch failed:", err);
        return null;
      }
    }
    async function ensureLogo(){
      if(!cachedLogoDataUrl) cachedLogoDataUrl = await fetchDataUrl(COMPANY_LOGO_URL);
      return cachedLogoDataUrl;
    }
    function getRole(name){
      if(!name) return "";
      const emp = employees.find(e => e.full_name === name);
      return emp ? (emp.primary_role || "") : "";
    }

    function setTabs(){
      document.querySelectorAll(".tab-btn").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          profileTab.classList.toggle("hidden", btn.dataset.tab !== "profileTab");
          historyTab.classList.toggle("hidden", btn.dataset.tab !== "historyTab");
          newTab.classList.toggle("hidden", btn.dataset.tab !== "newTab");
        });
      });
      document.querySelectorAll(".mini-tab").forEach(btn=>{
        btn.addEventListener("click", ()=>{
          document.querySelectorAll(".mini-tab").forEach(b=>b.classList.remove("active"));
          btn.classList.add("active");
          renderActionForm(btn.dataset.action);
        });
      });
    }

    function previewDoc(doc){
      try{
        lastGeneratedDoc = doc;
        const blob = doc.output("blob");
        const url = URL.createObjectURL(blob);
        document.getElementById("documentPreview").innerHTML = `
          <object data="${url}" type="application/pdf" class="w-full h-[760px] rounded-lg border">
            <iframe src="${url}" class="w-full h-[760px] border rounded-lg"></iframe>
          </object>
          <div class="mt-2 text-xs text-slate-500">
            If the preview doesn’t load, <a href="${url}" target="_blank" class="text-blue-600 underline">open the PDF in a new tab</a>.
          </div>
        `;
      }catch(e){
        console.error(e);
        document.getElementById("documentPreview").innerHTML = `<div class="text-rose-600 text-sm">Could not render PDF preview.</div>`;
      }
    }

    btnPrint.onclick = ()=>{ if(lastGeneratedDoc) lastGeneratedDoc.autoPrint && (window.open(lastGeneratedDoc.output('bloburl'), '_blank')); };
    btnDownload.onclick = ()=>{ if(lastGeneratedDoc) lastGeneratedDoc.save("document.pdf"); };

    /* ====== LOAD EMPLOYEES ====== */
    async function loadEmployees(){
      statusMessageDiv.textContent = "Loading employees…";
      const { data, error } = await supabase
        .from("employees")
        .select('id, full_name, "Current Reports To Employee", primary_role, department, email, phone, hire_date');

      if(error){ statusMessageDiv.textContent = "Error loading employees."; console.error(error); return; }

      employees = data || [];
      positions = Array.from(new Set(employees.map(e => e.primary_role).filter(Boolean))).sort();
      if (!positions.includes("Host")) positions.push("Host");
      if (!positions.includes("Cashier")) positions.push("Cashier");
      positions.sort();
      managers = Array.from(new Set(employees.map(e => e.full_name))).sort();

      statusMessageDiv.textContent = "Ready. Type a name to begin.";
    }

    /* ====== SEARCH ====== */
    function showSuggestions(query){
      suggestionsDiv.innerHTML = "";
      if(!query){ suggestionsDiv.classList.add("hidden"); return; }
      const q = query.toLowerCase();
      const matches = employees.filter(e => (e.full_name||"").toLowerCase().includes(q)).slice(0, 8);
      if(!matches.length){
        suggestionsDiv.innerHTML = `<div class="suggest-item text-slate-400 italic">No matches</div>`;
        suggestionsDiv.classList.remove("hidden");
        return;
      }
      matches.forEach(emp=>{
        const div = document.createElement("div");
        div.className = "suggest-item";
        div.textContent = emp.full_name;
        div.onclick = ()=>{ selectEmployee(emp); suggestionsDiv.classList.add("hidden"); searchInput.value = emp.full_name; };
        suggestionsDiv.appendChild(div);
      });
      suggestionsDiv.classList.remove("hidden");
    }
    searchInput.addEventListener("input", e => showSuggestions(e.target.value));
    document.addEventListener("click", (e)=>{
      if(!e.target.closest("#searchInput") && !e.target.closest("#suggestions")){
        suggestionsDiv.classList.add("hidden");
      }
    });

    /* ====== SELECT EMPLOYEE ====== */
    function selectEmployee(emp){
      selectedEmployee = emp;
      mainArea.classList.remove("hidden");

      // banner
      initials.textContent = getInitials(emp.full_name);
      empName.textContent = emp.full_name || "";
      empMeta.textContent = [emp.primary_role, emp.department].filter(Boolean).join(" • ");

      // profile form
      updateForm.elements["full_name"].value = emp.full_name || "";
      updateForm.elements["hire_date"].value = emp.hire_date || "";
      updateForm.elements["email"].value = emp.email || "";
      updateForm.elements["phone"].value = emp.phone || "";
      updateForm.elements["primary_role"].innerHTML = positions.map(p=>`<option ${p===emp.primary_role?'selected':''}>${p}</option>`).join("");
      updateForm.elements["department"].innerHTML = departments.map(d=>`<option ${d===emp.department?'selected':''}>${d}</option>`).join("");
      reportsToSelect.innerHTML = managers.map(m=>`<option ${m===emp['Current Reports To Employee']?'selected':''}>${m}</option>`).join("");
      reportsToRole.textContent = getRole(emp['Current Reports To Employee']) || "—";
      reportsToSelect.onchange = (e)=>{ reportsToRole.textContent = getRole(e.target.value) || "—"; };
      updateStatusMessage.textContent = "";

      // tabs default to Profile
      document.querySelectorAll(".tab-btn").forEach(b=>b.classList.remove("active"));
      document.querySelector('.tab-btn[data-tab="profileTab"]').classList.add("active");
      profileTab.classList.remove("hidden");
      historyTab.classList.add("hidden");
      newTab.classList.add("hidden");

      // clear preview & forms
      documentPreview.innerHTML = `Select a record or create a new action to preview the PDF here.`;
      formContainer.innerHTML = "";
      document.querySelectorAll(".mini-tab").forEach((b,i)=> b.classList.toggle("active", i===0));

      // load docs
      loadDocuments();
      // setup default new action form
      renderActionForm("Verbal Warning");
    }

    /* ====== UPDATE PROFILE ====== */
    updateForm.addEventListener("submit", async (e)=>{
      e.preventDefault();
      if(!selectedEmployee) return;
      const payload = {
        full_name: updateForm.elements["full_name"].value,
        "Current Reports To Employee": updateForm.elements["Current Reports To Employee"].value,
        primary_role: updateForm.elements["primary_role"].value,
        department: updateForm.elements["department"].value,
        email: updateForm.elements["email"].value,
        phone: updateForm.elements["phone"].value,
        hire_date: updateForm.elements["hire_date"].value
      };
      updateStatusMessage.textContent = "Updating…";
      const { error } = await supabase.from("employees").update(payload).eq("id", selectedEmployee.id);
      if(error){ updateStatusMessage.textContent = "Update failed."; console.error(error); return; }
      await loadEmployees();
      const updated = employees.find(e=>e.id===selectedEmployee.id);
      if(updated) selectEmployee(updated);
      updateStatusMessage.textContent = "Profile updated.";
    });

    /* ====== HISTORY (FETCH + RENDER) ====== */
    async function loadDocuments(){
      if(!selectedEmployee){ historyGroups.innerHTML = ""; return; }
      historyGroups.innerHTML = `<div class="text-center text-slate-500">Loading history…</div>`;

      const [{ data: rec1, error: e1 }, { data: rec2, error: e2 }] = await Promise.all([
        supabase.from("records").select("*").eq("employee_id", selectedEmployee.id),
        supabase.from("termination_records").select("*").eq("employee_id", selectedEmployee.id)
      ]);
      if(e1||e2){ historyGroups.innerHTML = `<div class="text-rose-600">Error loading records.</div>`; console.error(e1||e2); return; }

      const all = [...(rec1||[]), ...(rec2||[])].sort((a,b)=> new Date(b.created_at) - new Date(a.created_at));
      fetchedDocuments = all;

      // counts
      const count = t => all.filter(d=>d.document_type===t).length;
      document.getElementById("verbalCount").textContent = count("Verbal Warning");
      document.getElementById("writtenCount").textContent = count("Written Warning");
      document.getElementById("terminationCount").textContent = count("Termination");
      document.getElementById("twoWeekCount").textContent = count("Two Weeks Notice");
      document.getElementById("resignationCount").textContent = count("Resignation");

      // grouped lists
      const order = ["Verbal Warning","Written Warning","Termination","Two Weeks Notice","Resignation"];
      historyGroups.innerHTML = order.map(type=>{
        const list = all.filter(d=>d.document_type===type);
        if(!list.length) return `
          <div class="opacity-70">
            <h4 class="font-extrabold text-slate-800 mb-2">${type}</h4>
            <div class="text-xs text-slate-400">No records.</div>
          </div>`;
        const html = list.map((d)=>`
          <div class="p-3 border rounded-lg hover:bg-slate-50 cursor-pointer flex items-center justify-between" data-id="${d.id}" data-type="${type}">
            <div>
              <div class="font-bold">${type}</div>
              <div class="text-xs text-slate-500">${fmtDate(d.created_at)} — ${d.summary || "(no summary)"}</div>
            </div>
            <div class="text-xs text-slate-400">Preview ▶</div>
          </div>
        `).join("");
        return `
          <div>
            <h4 class="font-extrabold text-slate-800 mb-2">${type}</h4>
            <div class="space-y-2">${html}</div>
          </div>`;
      }).join("");

      historyGroups.querySelectorAll("[data-id]").forEach(el=>{
        el.addEventListener("click", ()=>{
          const id = el.getAttribute("data-id");
          const type = el.getAttribute("data-type");
          const rec = all.find(r => String(r.id) === String(id) && r.document_type===type);
          if(!rec) return;

          if(rec.document_type==="Termination"){
            // Normalize content for preview (fill missing employee fields)
            const fd = rec.content || {};
            const normalized = buildTerminationPreviewData({
              manager_signature: fd.manager_name || selectedEmployee["Current Reports To Employee"] || "",
              effective_date: fd.effective_date || "",
              final_pay_date: fd.final_pay_date || "",
              final_pay_amount: fd.final_pay_amount || "",
              reason: fd.reason || "",
              basis: fd.basis || "",
              delivery_method: fd.delivery_method || "",
              mailing_address: fd.mailing_address || "",
              // witness (persisted)
              witness_name: fd.witness_name || ""
            });
            // Copy checklist if exists
            if (Array.isArray(fd.checklist)) {
              normalized.checklist = fd.checklist;
            }
            generateTerminationPdf(normalized).then(doc=>previewDoc(doc));
          } else if(rec.document_type==="Verbal Warning" || rec.document_type==="Written Warning"){
            generateWarningPdf(rec.document_type, rec.content||{}).then(doc=>previewDoc(doc));
          } else {
            generateLetterPdf(rec.document_type, rec.content||{}).then(doc=>previewDoc(doc));
          }
        });
      });
    }

    /* ====== NEW ACTION FORMS ====== */
    function renderActionForm(type){
      const today = new Date().toISOString().split("T")[0];

      if(type==="Verbal Warning" || type==="Written Warning"){
        formContainer.innerHTML = `
          <form id="formWarn" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Date</label>
              <input name="document_date" type="date" value="${today}" class="field w-full">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Manager</label>
              <select name="manager_name" class="field w-full">
                ${managers.map(n=>`<option ${n===selectedEmployee['Current Reports To Employee']?'selected':''}>${n}</option>`).join("")}
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Witness</label>
              <select name="witness_name" class="field w-full">
                ${witnessNames.map(n=>`<option>${n}</option>`).join("")}
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Subject</label>
              <input name="subject" class="field w-full" placeholder="Short subject">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Statement of the problem</label>
              <textarea name="statement_of_problem" rows="5" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Reference to Prior Warnings</label>
              <textarea name="prior_warnings" rows="3" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Company Policy</label>
              <textarea name="company_policy" rows="3" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Corrective Action and Expectations</label>
              <textarea name="corrective_action" rows="5" class="field w-full"></textarea>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Timeline for Improvement</label>
              <textarea name="timeline" rows="3" class="field w-full"></textarea>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Consequences of Failure</label>
              <textarea name="consequences" rows="3" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Employee Comments</label>
              <textarea name="employee_comments" rows="3" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2 flex flex-wrap gap-2 mt-1">
              <button class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-bold" type="submit">Save</button>
              <button id="pv" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold" type="button">Preview</button>
            </div>
            <div id="formMsg" class="text-xs text-slate-500 md:col-span-2"></div>
          </form>`;
        const form = document.getElementById("formWarn");
        form.onsubmit = (e)=> saveDocument(e, type);
        document.getElementById("pv").onclick = async ()=>{
          const fd = Object.fromEntries(new FormData(form).entries());
          const doc = await generateWarningPdf(type, fd);
          previewDoc(doc);
        };

      } else if(type==="Termination"){
        formContainer.innerHTML = `
          <form id="formTermination" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Effective date</label>
              <input name="effective_date" type="date" value="${today}" class="field w-full">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Manager</label>
              <select name="manager_signature" class="field w-full">
                ${managers.map(n=>`<option ${n===selectedEmployee['Current Reports To Employee']?'selected':''}>${n}</option>`).join("")}
              </select>
            </div>

            <!-- Witness (fixed list) -->
            <div>
              <label class="block text-sm font-semibold mb-1">Witness</label>
              <select name="witness_name" class="field w-full">
                <option value="">-- Select Witness --</option>
                ${witnessNames.map(n=>`<option>${n}</option>`).join("")}
              </select>
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Witness role</label>
              <input name="witness_role" class="field w-full bg-slate-50" readonly placeholder="Auto-filled">
            </div>

            <!-- Checklist (10) -->
            ${[...Array(10)].map((_,i)=>`
              <div class="md:col-span-2 p-3 border rounded-lg">
                <p class="font-medium mb-2">${i+1}. ${[
                  "Was there a specific incident close in time to the discharge?",
                  "Can the employer show that the employee violated a known policy or law?",
                  "Are witnesses available?",
                  "Does the employer have documentation to support its reasons for termination?",
                  "Did the employee progress all the way through the disciplinary system?",
                  "Was the employee confronted with the problem and given a chance to explain?",
                  "Does the employee belong to a protected minority?",
                  "Was the treatment given to the employee different from that given to non-minorities?",
                  "Was the treatment given to the employee different from other workers in general?",
                  "Was the employee involved in a protected activity?"
                ][i]}</p>
                <div class="flex gap-4">
                  <label class="inline-flex items-center gap-2"><input type="radio" name="q${i+1}" value="Yes"> <span>Yes</span></label>
                  <label class="inline-flex items-center gap-2"><input type="radio" name="q${i+1}" value="No"> <span>No</span></label>
                  <label class="inline-flex items-center gap-2"><input type="radio" name="q${i+1}" value="N/A"> <span>N/A</span></label>
                </div>
                <textarea name="notes_q${i+1}" class="field w-full mt-2" rows="2" placeholder="Notes…"></textarea>
              </div>
            `).join("")}

            <div>
              <label class="block text-sm font-semibold mb-1">Final pay date</label>
              <input name="final_pay_date" type="date" class="field w-full">
            </div>
            <div>
              <label class="block text-sm font-semibold mb-1">Final pay amount</label>
              <input name="final_pay_amount" class="field w-full" placeholder="$0.00">
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Reason</label>
              <textarea name="reason" rows="2" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Basis</label>
              <textarea name="basis" rows="3" class="field w-full"></textarea>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Company property to return</label>
              <textarea name="property" rows="2" class="field w-full"></textarea>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Delivery Method</label>
              <select name="delivery_method" class="field w-full">
                <option value="">-- Select --</option>
                <option>Pick up in person</option>
                <option>Hand delivery</option>
                <option>Direct deposit</option>
                <option>By mail</option>
              </select>
            </div>
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Mailing address</label>
              <textarea name="mailing_address" rows="2" class="field w-full"></textarea>
            </div>

            <div class="md:col-span-2 flex flex-wrap gap-2 mt-1">
              <button class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-bold" type="submit">Save</button>
              <button id="pt" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold" type="button">Preview</button>
            </div>
            <div id="formMsg" class="text-xs text-slate-500 md:col-span-2"></div>
          </form>`;
        const form = document.getElementById("formTermination");
        // witness role auto-fill
        const wSel = form.querySelector('select[name="witness_name"]');
        const wRole = form.querySelector('input[name="witness_role"]');
        if (wSel && wRole) {
          wSel.addEventListener('change', (e) => {
            wRole.value = getRole(e.target.value) || "";
          });
        }
        form.onsubmit = (e)=> saveDocument(e, "Termination");
        document.getElementById("pt").onclick = ()=>{
          const fd = Object.fromEntries(new FormData(form).entries());
          const formData = buildTerminationPreviewData(fd);
          generateTerminationPdf(formData).then(doc=>previewDoc(doc));
        };

      } else if(type==="Two Weeks Notice" || type==="Resignation"){
        formContainer.innerHTML = `
          <form id="formLetter" class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-semibold mb-1">Date</label>
              <input name="document_date" type="date" value="${today}" class="field w-full">
            </div>

            <!-- Optional witness for letters -->
            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">Witness (optional)</label>
              <select name="witness_name" class="field w-full">
                <option value="">-- Select Witness --</option>
                ${witnessNames.map(n=>`<option>${n}</option>`).join("")}
              </select>
            </div>

            <div class="md:col-span-2">
              <label class="block text-sm font-semibold mb-1">${type==="Two Weeks Notice"?"Comments / Last working day (optional)":"Comments"}</label>
              <textarea name="employee_comments" rows="4" class="field w-full" placeholder="${type==="Two Weeks Notice"?"Anything to add…":"Reason / message…"}"></textarea>
            </div>
            <div class="md:col-span-2 flex flex-wrap gap-2 mt-1">
              <button class="px-4 py-2 rounded-lg bg-slate-900 text-white text-sm font-bold" type="submit">Save</button>
              <button id="pl" class="px-4 py-2 rounded-lg bg-blue-600 text-white text-sm font-bold" type="button">Preview</button>
            </div>
            <div id="formMsg" class="text-xs text-slate-500 md:col-span-2"></div>
          </form>`;
        const form = document.getElementById("formLetter");
        form.onsubmit = (e)=> saveDocument(e, type);
        document.getElementById("pl").onclick = async ()=>{
          const fd = Object.fromEntries(new FormData(form).entries());
          const doc = await generateLetterPdf(type, fd);
          previewDoc(doc);
        };
      }
    }

    /* ====== SAVE DOCUMENT ====== */
    async function saveDocument(e, type){
      e.preventDefault();
      if(!selectedEmployee) return;
      const form = e.target.closest("form");
      const fd = Object.fromEntries(new FormData(form).entries());
      let content = {};
      let summary = "";

      if(type==="Verbal Warning" || type==="Written Warning"){
        content = {
          manager_name: fd.manager_name || selectedEmployee['Current Reports To Employee'] || "",
          witness_name: fd.witness_name || "",
          document_date: fd.document_date || "",
          subject: fd.subject || "",
          statement_of_problem: fd.statement_of_problem || "",
          prior_warnings: fd.prior_warnings || "",
          company_policy: fd.company_policy || "",
          corrective_action: fd.corrective_action || "",
          timeline: fd.timeline || "",
          consequences: fd.consequences || "",
          employee_comments: fd.employee_comments || ""
        };
        summary = (content.subject || content.statement_of_problem || "").slice(0,100);

      } else if(type==="Termination"){
        // checklist
        const qs = [
          "Was there a specific incident close in time to the discharge?",
          "Can the employer show that the employee violated a known policy or law?",
          "Are witnesses available?",
          "Does the employer have documentation to support its reasons for termination?",
          "Did the employee progress all the way through the disciplinary system?",
          "Was the employee confronted with the problem and given a chance to explain?",
          "Does the employee belong to a protected minority?",
          "Was the treatment given to the employee different from that given to non-minorities?",
          "Was the treatment given to the employee different from other workers in general?",
          "Was the employee involved in a protected activity?"
        ];
        const checklist = qs.map((q, i)=>({
          question: q,
          ans: fd[`q${i+1}`] || "",
          notes: fd[`notes_q${i+1}`] || ""
        }));

        content = {
          manager_name: fd.manager_signature || selectedEmployee['Current Reports To Employee'] || "",
          effective_date: fd.effective_date || "",
          final_pay_date: fd.final_pay_date || "",
          final_pay_amount: fd.final_pay_amount || "",
          reason: fd.reason || "",
          basis: fd.basis || "",
          property: fd.property || "",
          delivery_method: fd.delivery_method || "",
          mailing_address: fd.mailing_address || "",
          // ✅ persist witness
          witness_name: fd.witness_name || "",
          witness_role: getRole(fd.witness_name) || "",
          checklist
        };
        summary = (content.reason || `Effective ${fmtDate(content.effective_date)}`).slice(0,100);

      } else {
        // letters
        content = {
          document_date: fd.document_date || "",
          employee_comments: fd.employee_comments || "",
          witness_name: fd.witness_name || ""
        };
        summary = (type==="Two Weeks Notice" ? "Two weeks notice submitted" : "Resignation letter") + ` • ${fmtDate(content.document_date)}`;
      }

      const table = (type==="Termination") ? "termination_records" : "records";
      const payload = { employee_id: selectedEmployee.id, document_type: type, summary, content };

      form.querySelector("#formMsg").textContent = "Saving…";
      const { error } = await supabase.from(table).insert([payload]);
      if(error){ form.querySelector("#formMsg").textContent = "Save failed."; console.error(error); return; }
      form.querySelector("#formMsg").textContent = "Saved.";
      await loadDocuments();
    }

    /* ====== PDF GENERATORS (with data-URL logo) ====== */
    async function generateWarningPdf(type, data){
      const doc = new jsPDF("p","pt","letter");
      const W = doc.internal.pageSize.getWidth();
      let y = 56;

      const logo = await ensureLogo();
      if(logo) doc.addImage(logo, "JPEG", W/2 - 44, y-24, 88, 64);

      y += 56;
      doc.setFont("helvetica","bold").setFontSize(16);
      doc.text(type.toUpperCase(), W/2, y, {align:"center"});
      y += 28;

      // header info
      doc.setFont("helvetica","normal").setFontSize(11);
      const left = 48, right = W/2 + 16;

      doc.text(`Employee: ${selectedEmployee.full_name}`, left, y);
      doc.text(`Manager: ${data.manager_name || selectedEmployee["Current Reports To Employee"] || ""}`, right, y);
      y += 16;
      doc.text(`Position: ${selectedEmployee.primary_role || ""}`, left, y);
      doc.text(`Witness: ${data.witness_name || ""}`, right, y);
      y += 16;
      doc.text(`Department: ${selectedEmployee.department || ""}`, left, y);
      doc.text(`Date: ${fmtDate(data.document_date || Date.now())}`, right, y);
      y += 28;

      const maxW = W - 2*left;
      function section(title, text){
        if(!text) return;
        doc.setFont("helvetica","bold").text(title, left, y);
        y += 14;
        doc.setFont("helvetica","normal");
        const lines = doc.splitTextToSize(text, maxW);
        doc.text(lines, left, y);
        y += lines.length*14 + 12;
      }

      section("Subject", data.subject);
      section("Statement of the Problem", data.statement_of_problem);
      section("Reference to Prior Warnings", data.prior_warnings);
      section("Company Policy", data.company_policy);
      section("Corrective Action and Expectations", data.corrective_action);
      section("Timeline for Improvement", data.timeline);
      section("Consequences of Failure", data.consequences);
      section("Employee Comments", data.employee_comments);

      // signatures
      y += 24;
      doc.text("______________________________", left, y);
      doc.text("Employee Signature", left, y+14);
      doc.text("______________________________", left + 260, y);
      doc.text("Manager Signature", left + 260, y+14);
      y += 44;
      doc.text("______________________________", left, y);
      doc.text("Witness Signature", left, y+14);

      // footer
      doc.setFont("helvetica","italic").setFontSize(9);
      doc.text("Jeng Chi Restaurant • 400 N. Greenville Ave Ste 11, Richardson, TX 75081 • admin@jengchirestaurant.com",
               W/2, 780, {align:"center"});

      return doc;
    }

    function buildTerminationPreviewData(fd){
      return {
        fullName: selectedEmployee.full_name,
        role: selectedEmployee.primary_role,
        department: selectedEmployee.department,
        hireDate: fmtDate(selectedEmployee.hire_date),
        email: selectedEmployee.email,
        phone: selectedEmployee.phone,

        managerName: fd.manager_signature || selectedEmployee["Current Reports To Employee"] || "",
        managerRole: getRole(fd.manager_signature || selectedEmployee["Current Reports To Employee"]),

        // witness
        witnessName: fd.witness_name || "",
        witnessRole: getRole(fd.witness_name) || "",

        effectiveDate: fmtDate(fd.effective_date),
        reason: fd.reason || "",
        basis: fd.basis || "",
        finalPayDate: fd.final_pay_date || "",
        finalPayAmount: fd.final_pay_amount || "",
        deliveryMethod: fd.delivery_method || "",
        mailingAddress: fd.mailing_address || "",
        checklist: [...Array(10)].map((_,i)=>({question:`Q${i+1}`, ans: fd[`q${i+1}`]||"", notes: fd[`notes_q${i+1}`]||""}))
      };
    }

    async function generateTerminationPdf(data){
      const doc = new jsPDF("p","pt","letter");
      const W = doc.internal.pageSize.getWidth();
      let y = 56;

      const logo = await ensureLogo();
      if(logo) doc.addImage(logo, "JPEG", W/2 - 50, y-22, 100, 70);
      y += 60;

      doc.setFont("helvetica","bold").setFontSize(16);
      doc.text("TERMINATION LETTER", W/2, y, {align:"center"});
      y += 30;

      // Ensure employee fields exist (when previewing saved content)
      const fullName = data.fullName || (selectedEmployee?.full_name || "");
      const role = data.role || (selectedEmployee?.primary_role || "");
      const department = data.department || (selectedEmployee?.department || "");
      const effectiveDate = data.effectiveDate || fmtDate(data.effective_date || "");
      const managerName = data.managerName || (selectedEmployee?.["Current Reports To Employee"] || "");
      const witnessName = data.witnessName || data.witness_name || "";
      const witnessRole = data.witnessRole || data.witness_role || getRole(witnessName) || "";

      const left = 48, right = W/2 + 16;
      doc.setFont("helvetica","normal").setFontSize(11);
      doc.text(`Employee: ${fullName}`, left, y);
      doc.text(`Effective date: ${effectiveDate || ""}`, right, y);
      y += 16;
      doc.text(`Position: ${role}`, left, y);
      doc.text(`Manager: ${managerName || ""}`, right, y);
      y += 16;
      doc.text(`Department: ${department || ""}`, left, y);
      doc.text(`Witness: ${witnessName || ""}${witnessRole ? ` (${witnessRole})` : ""}`, right, y);
      y += 28;

      const maxW = W - 2*left;
      function section(title, text){
        if(!text) return;
        doc.setFont("helvetica","bold").text(title, left, y);
        y += 14;
        doc.setFont("helvetica","normal");
        const lines = doc.splitTextToSize(text, maxW);
        doc.text(lines, left, y);
        y += lines.length*14 + 12;
      }

      section("Reason / Basis for Termination", ((data.reason||"") ? `${data.reason}\n\n` : "") + (data.basis||""));
      section("Final Payment", `Final paycheck ${data.finalPayAmount || data.final_pay_amount || ""} on ${fmtDate(data.finalPayDate || data.final_pay_date) || "N/A"}.`);
      if(data.deliveryMethod || data.delivery_method) section("Delivery Method", data.deliveryMethod || data.delivery_method);
      if(data.mailingAddress || data.mailing_address) section("Mailing Address", data.mailingAddress || data.mailing_address);

      const checklist = Array.isArray(data.checklist) ? data.checklist : [];
      if(checklist.length){
        doc.setFont("helvetica","bold").text("Checklist", left, y); y+=14;
        doc.setFont("helvetica","normal");
        checklist.forEach((q,i)=>{
          const t = `${i+1}. ${q.question} — Answer: ${q.ans}${q.notes?`. Notes: ${q.notes}`:""}`;
          const lines = doc.splitTextToSize(t, maxW);
          doc.text(lines, left, y); y += lines.length*14+6;
        });
      }

      y += 12;
      doc.text("Sincerely,", left, y); y += 18;
      doc.text(`${managerName || ""}`, left, y); y += 24;

      // signatures
      doc.text("______________________________", left, y);
      doc.text("Employee Signature", left, y+14);
      doc.text("______________________________", left + 260, y);
      doc.text("Manager Signature", left + 260, y+14);
      y += 44;
      doc.text("______________________________", left, y);
      doc.text("Witness Signature", left, y+14);

      // footer
      doc.setFont("helvetica","italic").setFontSize(9);
      doc.text("Jeng Chi Restaurant • 400 N. Greenville Ave Ste 11, Richardson, TX 75081 • admin@jengchirestaurant.com",
               W/2, 780, {align:"center"});

      return doc;
    }

    async function generateLetterPdf(type, data){
      const doc = new jsPDF("p","pt","letter");
      const W = doc.internal.pageSize.getWidth();
      let y = 56;
      const logo = await ensureLogo();
      if(logo) doc.addImage(logo, "JPEG", W/2 - 44, y-24, 88, 64);
      y += 56;
      doc.setFont("helvetica","bold").setFontSize(16);
      doc.text(type.toUpperCase(), W/2, y, {align:"center"});
      y += 30;
      const left = 56;
      doc.setFont("helvetica","normal").setFontSize(11);
      const date = fmtDate(data.document_date || Date.now());

      doc.text(`Date: ${date}`, left, y); y+=18;

      // Optional witness line on letters
      if (data.witness_name) { doc.text(`Witness: ${data.witness_name}`, left, y); y += 18; }

      const message = (data.employee_comments || "This letter serves as formal notice.").trim();
      const lines = doc.splitTextToSize(message, W - left*2);

      if(type==="Two Weeks Notice"){
        doc.text(`Dear Management,`, left, y); y+=18;
        doc.text(lines, left, y); y += lines.length*14+18;
        doc.text(`My last day will be two weeks from today (${fmtDate(new Date(Date.now()+14*24*3600*1000))}).`, left, y); y+=28;
      }else{
        doc.text(`Dear HR,`, left, y); y+=18;
        doc.text(lines, left, y); y += lines.length*14+28;
      }
      doc.text("Sincerely,", left, y); y+=18;
      doc.text(selectedEmployee.full_name, left, y);
      doc.setFont("helvetica","italic").setFontSize(9);
      doc.text("Jeng Chi Restaurant • 400 N. Greenville Ave Ste 11, Richardson, TX 75081 • admin@jengchirestaurant.com",
               W/2, 780, {align:"center"});
      return doc;
    }

    /* ====== INIT ====== */
    setTabs();
    loadEmployees();
  </script>
</body>
</html>
