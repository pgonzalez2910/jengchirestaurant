<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi — Admin Portal | Employee Handbook Acknowledgments</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Playfair+Display:wght@600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { 
                        'serif-head': ['Playfair Display', 'serif'], 
                        'sans': ['Inter', 'system-ui', 'sans-serif'] 
                    },
                    colors: {
                        'jc-primary': '#1F2937',
                        'jc-secondary': '#334155',
                        'jc-gold': '#C0A06D',
                        'jc-border': '#E2E8F0',
                        'jc-green': '#10B981',
                        'jc-blue': '#3B82F6',
                        'jc-gray': '#6B7280'
                    }
                }
            }
        }
    </script>
    
    <style>
        .print-container {
            display: none;
        }
        @media print {
            body * {
                visibility: hidden;
            }
            .print-container,
            .print-container * {
                visibility: visible;
            }
            .print-container {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 20px;
            }
            .no-print {
                display: none !important;
            }
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-800">
    <!-- Header -->
    <header class="bg-white shadow-sm border-b border-jc-border">
        <div class="max-w-7xl mx-auto px-6 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center gap-4">
                    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" 
                         alt="Jeng Chi Logo" 
                         class="h-14 w-auto rounded-lg bg-white shadow-md object-contain">
                    <div>
                        <h1 class="text-2xl font-serif-head text-jc-primary font-bold">Admin Portal</h1>
                        <p class="text-sm text-jc-gray mt-0.5">Employee Handbook Acknowledgments</p>
                    </div>
                </div>
                <div class="text-right text-xs text-jc-gray">
                    <div>400 North Greenville Avenue Ste 11</div>
                    <div>Richardson, TX 75081</div>
                    <div class="mt-1">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-6 py-8">
        <!-- Dashboard Stats -->
        <section class="mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <div class="bg-white rounded-xl shadow-sm border border-jc-border p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-jc-gray">Total Submissions</p>
                            <p id="stat-total" class="text-3xl font-bold text-jc-primary mt-1">—</p>
                        </div>
                        <div class="bg-jc-blue/10 p-3 rounded-full">
                            <svg class="w-6 h-6 text-jc-blue" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-jc-border p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-jc-gray">Completed Employees</p>
                            <p id="stat-completed" class="text-3xl font-bold text-jc-green mt-1">—</p>
                        </div>
                        <div class="bg-jc-green/10 p-3 rounded-full">
                            <svg class="w-6 h-6 text-jc-green" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-jc-border p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-jc-gray">Pending Submissions</p>
                            <p id="stat-pending" class="text-3xl font-bold text-jc-gray mt-1">—</p>
                        </div>
                        <div class="bg-jc-gray/10 p-3 rounded-full">
                            <svg class="w-6 h-6 text-jc-gray" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
                
                <div class="bg-white rounded-xl shadow-sm border border-jc-border p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-jc-gray">Last Updated</p>
                            <p id="stat-last-update" class="text-sm font-medium text-jc-primary mt-1">—</p>
                        </div>
                        <div class="bg-jc-gold/10 p-3 rounded-full">
                            <svg class="w-6 h-6 text-jc-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Controls -->
        <section class="mb-6 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div class="flex flex-wrap gap-3">
                <button id="btn-refresh" class="flex items-center gap-2 px-4 py-2 bg-jc-blue text-white rounded-lg hover:bg-jc-blue/90 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                    </svg>
                    Refresh Data
                </button>
                
                <button id="btn-print-all" class="flex items-center gap-2 px-4 py-2 bg-jc-gold text-white rounded-lg hover:bg-jc-gold/90 transition-colors">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"></path>
                    </svg>
                    Print All Documents
                </button>
            </div>
            
            <div class="flex flex-wrap gap-3">
                <div class="relative">
                    <input type="text" 
                           id="search-input" 
                           placeholder="Search by name, department..." 
                           class="pl-10 pr-4 py-2 w-full md:w-64 rounded-lg border border-jc-border focus:outline-none focus:ring-2 focus:ring-jc-gold/40">
                    <svg class="w-5 h-5 text-jc-gray absolute left-3 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                    </svg>
                </div>
                
                <select id="filter-department" class="px-4 py-2 rounded-lg border border-jc-border focus:outline-none focus:ring-2 focus:ring-jc-gold/40">
                    <option value="">All Departments</option>
                    <option value="FOH">Front of House</option>
                    <option value="BOH">Back of House</option>
                    <option value="Management">Management</option>
                </select>
                
                <select id="filter-status" class="px-4 py-2 rounded-lg border border-jc-border focus:outline-none focus:ring-2 focus:ring-jc-gold/40">
                    <option value="">All Status</option>
                    <option value="completed">Completed</option>
                    <option value="incomplete">Incomplete</option>
                </select>
            </div>
        </section>

        <!-- Submissions Table -->
        <section class="bg-white rounded-xl shadow-sm border border-jc-border overflow-hidden">
            <div class="px-6 py-4 border-b border-jc-border">
                <h2 class="font-serif-head text-xl text-jc-primary font-bold">Employee Submissions</h2>
                <p class="text-sm text-jc-gray mt-1">Click on any row to view detailed acknowledgment document</p>
            </div>
            
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-jc-border">
                    <thead class="bg-slate-50">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Employee</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Department</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Position</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Policies Acknowledged</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Last Updated</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-jc-gray uppercase tracking-wider">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submissions-table-body" class="bg-white divide-y divide-jc-border">
                        <tr>
                            <td colspan="7" class="px-6 py-12 text-center text-jc-gray">
                                <svg class="mx-auto h-12 w-12 text-jc-gray/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 7v10c0 2.21 3.582 4 8 4s8-1.79 8-4V7M4 7c0 2.21 3.582 4 8 4s8-1.79 8-4M4 7c0-2.21 3.582-4 8-4s8 1.79 8 4m0 5c0 2.21-3.582 4-8 4s-8-1.79-8-4"></path>
                                </svg>
                                <p class="mt-2 text-sm font-medium">Loading submissions...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            
            <div id="no-results" class="hidden px-6 py-12 text-center text-jc-gray">
                <svg class="mx-auto h-12 w-12 text-jc-gray/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.172 16.172a4 4 0 015.656 0M9.172 9.172a4 4 0 015.656 0m-7.088 7.088L12 12m-7.088 7.088L12 12m-7.088-7.088L12 12"></path>
                </svg>
                <p class="mt-2 text-sm font-medium">No submissions found matching your criteria</p>
            </div>
            
            <div id="empty-state" class="hidden px-6 py-12 text-center text-jc-gray">
                <svg class="mx-auto h-12 w-12 text-jc-gray/40" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                </svg>
                <p class="mt-2 text-sm font-medium">No submissions available</p>
            </div>
        </section>
    </main>

    <!-- Modal for Document Preview -->
    <div id="document-modal" class="fixed inset-0 z-50 hidden">
        <div class="fixed inset-0 bg-black bg-opacity-50 transition-opacity" aria-hidden="true"></div>
        
        <div class="fixed inset-0 z-50 overflow-y-auto">
            <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
                <div class="relative transform overflow-hidden rounded-2xl bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-4xl">
                    <div class="bg-white px-6 pb-4 pt-5 sm:p-6 sm:pb-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <h3 class="font-serif-head text-2xl font-bold text-jc-primary" id="modal-title">Employee Acknowledgment Document</h3>
                                <p class="text-sm text-jc-gray mt-1" id="modal-subtitle">Detailed view of employee handbook acknowledgment</p>
                            </div>
                            <button id="btn-close-modal" class="text-jc-gray hover:text-jc-primary">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                                </svg>
                            </button>
                        </div>
                        
                        <div id="document-content" class="mt-6 max-h-[60vh] overflow-y-auto">
                            <div class="text-center py-12 text-jc-gray">
                                <svg class="mx-auto h-12 w-12 animate-spin text-jc-gold" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                                </svg>
                                <p class="mt-2 text-sm">Loading document...</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="bg-gray-50 px-6 py-4 flex items-center justify-between gap-3">
                        <button id="btn-print-single" class="flex items-center gap-2 px-4 py-2 bg-jc-gold text-white rounded-lg hover:bg-jc-gold/90 transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2z"></path>
                            </svg>
                            Print Document
                        </button>
                        
                        <button id="btn-close-modal-bottom" class="px-4 py-2 border border-jc-border rounded-lg hover:bg-slate-50 transition-colors">
                            Close
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Print Container (Hidden) -->
    <div id="print-container" class="print-container"></div>

    <script>
        // ========== SUPABASE CONFIGURATION ==========
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========== STATE ==========
        let allSubmissions = [];
        let currentDocumentData = null;

        // ========== UTILITY FUNCTIONS ==========
        const formatDate = (dateString) => {
            if (!dateString) return '—';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        };

        const formatShortDate = (dateString) => {
            if (!dateString) return '—';
            const date = new Date(dateString);
            return date.toLocaleDateString('en-US', { 
                year: 'numeric', 
                month: 'short', 
                day: 'numeric'
            });
        };

        const getStatusBadge = (completedCount, totalCount) => {
            const percentage = (completedCount / totalCount) * 100;
            let color = 'bg-jc-gray/10 text-jc-gray';
            let text = 'Incomplete';
            
            if (percentage === 100) {
                color = 'bg-jc-green/10 text-jc-green';
                text = 'Completed';
            } else if (percentage > 50) {
                color = 'bg-jc-blue/10 text-jc-blue';
                text = 'In Progress';
            }
            
            return `<span class="px-3 py-1 rounded-full text-xs font-medium ${color}">${text}</span>`;
        };

        // ========== FETCH DATA ==========
        async function fetchSubmissions() {
            try {
                // Fetch all acknowledgments
                const { data: acks, error: acksError } = await supabaseClient
                    .from('hb_acks')
                    .select(`
                        policy_id,
                        employee_initials,
                        signed_initials,
                        agreed,
                        created_at,
                        session_id,
                        employee_id
                    `)
                    .eq('agreed', true)
                    .order('created_at', { ascending: false });

                if (acksError) throw acksError;

                // Fetch employee info - FIXED: Removed employee_id from select
                const { data: employees, error: empError } = await supabaseClient
                    .from('v_employee_card')
                    .select(`
                        full_name,
                        position,
                        department,
                        email,
                        phone
                    `);

                if (empError) {
                    console.warn('Could not fetch employee data:', empError.message);
                    // Continue without employee details
                }

                // Fetch policy metadata
                const { data: policies, error: policiesError } = await supabaseClient
                    .from('hb_policies')
                    .select('id, code, title')
                    .eq('is_active', true);

                if (policiesError) throw policiesError;

                // Group acknowledgments by employee
                const employeeMap = new Map();
                
                acks.forEach(ack => {
                    // Use employee_id if available, otherwise fall back to initials or session_id
                    const key = ack.employee_id || ack.employee_initials || ack.session_id;
                    if (!employeeMap.has(key)) {
                        employeeMap.set(key, {
                            key,
                            employee_id: ack.employee_id,
                            initials: ack.employee_initials,
                            session_id: ack.session_id,
                            acknowledgments: [],
                            first_ack: ack.created_at,
                            last_ack: ack.created_at
                        });
                    }
                    
                    const employee = employeeMap.get(key);
                    employee.acknowledgments.push({
                        policy_id: ack.policy_id,
                        signed_initials: ack.signed_initials,
                        created_at: ack.created_at
                    });
                    
                    if (new Date(ack.created_at) > new Date(employee.last_ack)) {
                        employee.last_ack = ack.created_at;
                    }
                });

                // Enrich with employee details - FIXED: Match by full_name instead of employee_id
                const enrichedSubmissions = Array.from(employeeMap.values()).map(emp => {
                    // Try to find employee by matching initials or name
                    let employeeDetail = null;
                    
                    if (emp.initials) {
                        const initialsLower = emp.initials.toLowerCase();
                        employeeDetail = employees?.find(e => 
                            e.full_name?.toLowerCase().includes(initialsLower) ||
                            e.full_name?.split(' ').map(n => n[0]).join('').toLowerCase() === initialsLower
                        );
                    }
                    
                    return {
                        ...emp,
                        full_name: employeeDetail?.full_name || emp.initials || 'Unknown Employee',
                        position: employeeDetail?.position || '—',
                        department: employeeDetail?.department || '—',
                        email: employeeDetail?.email || '—',
                        phone: employeeDetail?.phone || '—',
                        total_policies: policies.length,
                        completed_policies: emp.acknowledgments.length,
                        policies: emp.acknowledgments.map(a => {
                            const policy = policies.find(p => p.id === a.policy_id);
                            return {
                                code: policy?.code || 'Unknown',
                                title: policy?.title || 'Unknown Policy',
                                signed_initials: a.signed_initials,
                                created_at: a.created_at
                            };
                        })
                    };
                });

                allSubmissions = enrichedSubmissions;
                renderSubmissions();
                updateStats();
                
            } catch (error) {
                console.error('Error fetching submissions:', error);
                document.getElementById('submissions-table-body').innerHTML = `
                    <tr>
                        <td colspan="7" class="px-6 py-12 text-center text-red-600">
                            <p class="font-medium">Error loading data: ${error.message}</p>
                            <p class="text-sm mt-2">Please refresh the page or contact support</p>
                        </td>
                    </tr>
                `;
            }
        }

        // ========== RENDER FUNCTIONS ==========
        function renderSubmissions() {
            const tbody = document.getElementById('submissions-table-body');
            const noResults = document.getElementById('no-results');
            const emptyState = document.getElementById('empty-state');
            
            // Get filter values
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const departmentFilter = document.getElementById('filter-department').value;
            const statusFilter = document.getElementById('filter-status').value;
            
            // Filter submissions
            let filtered = [...allSubmissions];
            
            if (searchTerm) {
                filtered = filtered.filter(sub => 
                    sub.full_name.toLowerCase().includes(searchTerm) ||
                    sub.department.toLowerCase().includes(searchTerm) ||
                    sub.position.toLowerCase().includes(searchTerm)
                );
            }
            
            if (departmentFilter) {
                filtered = filtered.filter(sub => 
                    sub.department.toLowerCase().includes(departmentFilter.toLowerCase())
                );
            }
            
            if (statusFilter) {
                filtered = filtered.filter(sub => {
                    const percentage = (sub.completed_policies / sub.total_policies) * 100;
                    if (statusFilter === 'completed') return percentage === 100;
                    if (statusFilter === 'incomplete') return percentage < 100;
                    return true;
                });
            }
            
            // Show/hide empty states
            if (allSubmissions.length === 0) {
                emptyState.classList.remove('hidden');
                noResults.classList.add('hidden');
                tbody.innerHTML = '';
                return;
            }
            
            if (filtered.length === 0) {
                noResults.classList.remove('hidden');
                tbody.innerHTML = '';
            } else {
                noResults.classList.add('hidden');
                emptyState.classList.add('hidden');
            }
            
            // Render table rows
            tbody.innerHTML = filtered.map(sub => {
                const percentage = ((sub.completed_policies / sub.total_policies) * 100).toFixed(0);
                const statusHTML = getStatusBadge(sub.completed_policies, sub.total_policies);
                
                return `
                    <tr class="hover:bg-slate-50 cursor-pointer" data-key="${sub.key}">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="font-medium text-jc-primary">${sub.full_name}</div>
                            <div class="text-sm text-jc-gray">${sub.email}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium bg-blue-100 text-blue-800 rounded">${sub.department || '—'}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${sub.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="w-24">
                                <div class="flex items-center gap-2">
                                    <div class="text-xs font-medium text-jc-primary">${sub.completed_policies}/${sub.total_policies}</div>
                                    <div class="flex-1 h-2 bg-slate-200 rounded-full overflow-hidden">
                                        <div class="h-2 ${percentage === '100' ? 'bg-jc-green' : 'bg-jc-blue'}" style="width: ${percentage}%"></div>
                                    </div>
                                </div>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">${statusHTML}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-jc-gray">${formatShortDate(sub.last_ack)}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <button class="view-btn px-3 py-1 text-sm font-medium text-jc-blue hover:text-jc-blue/80 border border-jc-blue/30 rounded-lg transition-colors" data-key="${sub.key}">
                                View Details
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Add click handlers
            tbody.querySelectorAll('tr').forEach(row => {
                row.addEventListener('click', () => {
                    const key = row.getAttribute('data-key');
                    showDocumentModal(key);
                });
            });
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const key = btn.getAttribute('data-key');
                    showDocumentModal(key);
                });
            });
        }

        function updateStats() {
            const total = allSubmissions.length;
            const completed = allSubmissions.filter(s => 
                (s.completed_policies / s.total_policies) === 1
            ).length;
            const pending = total - completed;
            const lastUpdate = allSubmissions.length > 0 
                ? new Date(Math.max(...allSubmissions.map(s => new Date(s.last_ack)))).toLocaleString()
                : 'Never';
            
            document.getElementById('stat-total').textContent = total;
            document.getElementById('stat-completed').textContent = completed;
            document.getElementById('stat-pending').textContent = pending;
            document.getElementById('stat-last-update').textContent = lastUpdate;
        }

        function showDocumentModal(key) {
            const submission = allSubmissions.find(s => s.key === key);
            if (!submission) return;
            
            currentDocumentData = submission;
            
            const modalTitle = document.getElementById('modal-title');
            const modalSubtitle = document.getElementById('modal-subtitle');
            const documentContent = document.getElementById('document-content');
            
            modalTitle.textContent = `${submission.full_name} — Acknowledgment Document`;
            modalSubtitle.textContent = `Department: ${submission.department} | Position: ${submission.position}`;
            
            // Build document content
            const policiesHTML = submission.policies.map(policy => `
                <div class="border-b border-jc-border py-3">
                    <div class="flex items-start justify-between">
                        <div class="flex-1">
                            <div class="font-medium text-jc-primary">${policy.code}</div>
                            <div class="text-sm text-jc-gray mt-1">${policy.title}</div>
                        </div>
                        <div class="text-right ml-4">
                            <div class="font-medium text-jc-green">${policy.signed_initials || '—'}</div>
                            <div class="text-xs text-jc-gray mt-1">${formatShortDate(policy.created_at)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
            
            documentContent.innerHTML = `
                <div class="bg-white p-6 rounded-lg border border-jc-border">
                    <div class="border-b border-jc-border pb-6 mb-6">
                        <div class="flex justify-between items-start">
                            <div>
                                <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" 
                                     alt="Jeng Chi Logo" 
                                     class="h-12 w-auto mb-4">
                                <h2 class="font-serif-head text-xl text-jc-primary font-bold">Employee Handbook Acknowledgment</h2>
                                <p class="text-sm text-jc-gray mt-1">Jeng Chi Restaurant — Richardson, TX</p>
                            </div>
                            <div class="text-right text-sm">
                                <div class="font-medium">${formatDate(new Date())}</div>
                                <div class="text-jc-gray">Document ID: ${submission.key}</div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-6 mb-6">
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Employee Name</div>
                            <div class="font-medium text-jc-primary">${submission.full_name}</div>
                        </div>
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Department</div>
                            <div class="font-medium text-jc-primary">${submission.department}</div>
                        </div>
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Position</div>
                            <div class="font-medium text-jc-primary">${submission.position}</div>
                        </div>
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Email</div>
                            <div class="font-medium text-jc-primary">${submission.email}</div>
                        </div>
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Phone</div>
                            <div class="font-medium text-jc-primary">${submission.phone}</div>
                        </div>
                        <div>
                            <div class="text-xs text-jc-gray mb-1">Session ID</div>
                            <div class="font-medium text-jc-primary">${submission.session_id || '—'}</div>
                        </div>
                    </div>
                    
                    <div class="border-t border-jc-border pt-6">
                        <h3 class="font-serif-head text-lg text-jc-primary font-bold mb-4">Acknowledged Policies</h3>
                        <div class="space-y-2">
                            ${policiesHTML || '<div class="text-jc-gray text-sm">No policies acknowledged</div>'}
                        </div>
                    </div>
                    
                    <div class="border-t border-jc-border pt-6 mt-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <div class="text-xs text-jc-gray mb-1">Completion Status</div>
                                <div class="font-medium text-jc-primary">${submission.completed_policies}/${submission.total_policies} policies acknowledged</div>
                            </div>
                            <div>
                                <div class="text-xs text-jc-gray mb-1">Last Updated</div>
                                <div class="font-medium text-jc-primary">${formatDate(submission.last_ack)}</div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('document-modal').classList.remove('hidden');
            document.body.style.overflow = 'hidden';
        }

        // ========== PRINT FUNCTIONS ==========
        function printDocument(elementId) {
            const printContent = document.getElementById(elementId).innerHTML;
            const printContainer = document.getElementById('print-container');
            
            printContainer.innerHTML = `
                <style>
                    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; padding: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .logo { height: 80px; margin-bottom: 10px; }
                    h1 { font-family: 'Playfair Display', serif; color: #1F2937; margin: 0; font-size: 24px; }
                    .subtitle { color: #6B7280; font-size: 12px; margin-top: 5px; }
                    .section { margin-bottom: 20px; }
                    .section-title { font-family: 'Playfair Display', serif; color: #1F2937; font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #C0A06D; padding-bottom: 5px; }
                    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
                    .info-item { font-size: 11px; }
                    .info-label { color: #6B7280; font-weight: 500; margin-bottom: 2px; }
                    .info-value { color: #1F2937; font-weight: 600; }
                    .policy-list { width: 100%; border-collapse: collapse; font-size: 10px; }
                    .policy-list th { background-color: #1F2937; color: white; padding: 8px; text-align: left; font-weight: 600; }
                    .policy-list td { padding: 6px; border-bottom: 1px solid #E2E8F0; }
                    .policy-list tr:last-child td { border-bottom: none; }
                    .policy-code { font-weight: 600; color: #1F2937; width: 15%; }
                    .policy-title { color: #334155; width: 65%; }
                    .policy-signature { font-weight: 600; color: #10B981; text-align: right; width: 20%; }
                    .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #C0A06D; text-align: center; font-size: 10px; color: #6B7280; }
                </style>
                ${printContent}
            `;
            
            window.print();
        }

        function printAllDocuments() {
            if (allSubmissions.length === 0) {
                alert('No documents available to print');
                return;
            }
            
            const printContainer = document.getElementById('print-container');
            let allHTML = '';
            
            allSubmissions.forEach((submission, index) => {
                const policiesHTML = submission.policies.map(policy => `
                    <tr>
                        <td class="policy-code">${policy.code}</td>
                        <td class="policy-title">${policy.title}</td>
                        <td class="policy-signature">${policy.signed_initials || '—'}</td>
                    </tr>
                `).join('');
                
                allHTML += `
                    <div style="page-break-after: always;">
                        <div class="header">
                            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="logo">
                            <h1>Employee Handbook Acknowledgment</h1>
                            <div class="subtitle">Jeng Chi Restaurant — Richardson, TX</div>
                        </div>
                        
                        <div class="section">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Employee Name</div>
                                    <div class="info-value">${submission.full_name}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Department</div>
                                    <div class="info-value">${submission.department}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Position</div>
                                    <div class="info-value">${submission.position}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Email</div>
                                    <div class="info-value">${submission.email}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Phone</div>
                                    <div class="info-value">${submission.phone}</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Session ID</div>
                                    <div class="info-value">${submission.session_id || '—'}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-title">Acknowledged Policies</div>
                            <table class="policy-list">
                                <thead>
                                    <tr>
                                        <th>Code</th>
                                        <th>Policy Title</th>
                                        <th>Initials</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${policiesHTML || '<tr><td colspan="3" style="text-align: center; color: #6B7280;">No policies acknowledged</td></tr>'}
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="section">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">Completion Status</div>
                                    <div class="info-value">${submission.completed_policies}/${submission.total_policies} policies acknowledged</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">Last Updated</div>
                                    <div class="info-value">${formatDate(submission.last_ack)}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="footer">
                            <div>400 North Greenville Avenue Ste 11, Richardson TX 75081</div>
                            <div>© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
                            <div style="margin-top: 5px;">Document ${index + 1} of ${allSubmissions.length} | Printed: ${new Date().toLocaleString()}</div>
                        </div>
                    </div>
                `;
            });
            
            printContainer.innerHTML = `
                <style>
                    body { font-family: 'Inter', system-ui, sans-serif; margin: 0; padding: 20px; }
                    .header { text-align: center; margin-bottom: 30px; }
                    .logo { height: 80px; margin-bottom: 10px; }
                    h1 { font-family: 'Playfair Display', serif; color: #1F2937; margin: 0; font-size: 24px; }
                    .subtitle { color: #6B7280; font-size: 12px; margin-top: 5px; }
                    .section { margin-bottom: 20px; }
                    .section-title { font-family: 'Playfair Display', serif; color: #1F2937; font-size: 16px; font-weight: bold; margin-bottom: 10px; border-bottom: 2px solid #C0A06D; padding-bottom: 5px; }
                    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 20px; }
                    .info-item { font-size: 11px; }
                    .info-label { color: #6B7280; font-weight: 500; margin-bottom: 2px; }
                    .info-value { color: #1F2937; font-weight: 600; }
                    .policy-list { width: 100%; border-collapse: collapse; font-size: 10px; }
                    .policy-list th { background-color: #1F2937; color: white; padding: 8px; text-align: left; font-weight: 600; }
                    .policy-list td { padding: 6px; border-bottom: 1px solid #E2E8F0; }
                    .policy-list tr:last-child td { border-bottom: none; }
                    .policy-code { font-weight: 600; color: #1F2937; width: 15%; }
                    .policy-title { color: #334155; width: 65%; }
                    .policy-signature { font-weight: 600; color: #10B981; text-align: right; width: 20%; }
                    .footer { margin-top: 30px; padding-top: 20px; border-top: 2px solid #C0A06D; text-align: center; font-size: 10px; color: #6B7280; }
                </style>
                ${allHTML}
            `;
            
            window.print();
        }

        // ========== EVENT LISTENERS ==========
        document.addEventListener('DOMContentLoaded', () => {
            // Fetch data on load
            fetchSubmissions();
            
            // Refresh button
            document.getElementById('btn-refresh').addEventListener('click', fetchSubmissions);
            
            // Print all button
            document.getElementById('btn-print-all').addEventListener('click', printAllDocuments);
            
            // Search and filter
            document.getElementById('search-input').addEventListener('input', renderSubmissions);
            document.getElementById('filter-department').addEventListener('change', renderSubmissions);
            document.getElementById('filter-status').addEventListener('change', renderSubmissions);
            
            // Modal close buttons
            document.getElementById('btn-close-modal').addEventListener('click', () => {
                document.getElementById('document-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
            
            document.getElementById('btn-close-modal-bottom').addEventListener('click', () => {
                document.getElementById('document-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
            
            // Print single document
            document.getElementById('btn-print-single').addEventListener('click', () => {
                if (currentDocumentData) {
                    printDocument('document-content');
                }
            });
            
            // Close modal on backdrop click
            document.querySelector('#document-modal .fixed.inset-0.bg-black').addEventListener('click', () => {
                document.getElementById('document-modal').classList.add('hidden');
                document.body.style.overflow = 'auto';
            });
        });
    </script>
</body>
</html>
