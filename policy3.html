<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeng Chi ‚Äî Manager Handbook Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@media print {
  body * { visibility: hidden; }
  #printFrame { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; }
}
.signature-container {
  position: relative;
  width: 100%;
  border: 2px solid #d1d5db;
  border-radius: 0.5rem;
  background: white;
  padding: 1rem;
}
#managerSignatureCanvas {
  display: block;
  width: 100%;
  height: 200px;
  border: 2px dashed #9ca3af;
  border-radius: 0.5rem;
  background: white;
  cursor: crosshair;
  touch-action: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  user-select: none;
}
</style>
</head>
<body class="h-full bg-slate-50">
<!-- ============================================ -->
<!-- LOGIN VIEW -->
<!-- ============================================ -->
<div id="loginView" class="min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Manager Portal</h1>
      <p class="text-gray-600 mt-2">Handbook Approvals</p>
    </div>
    <input id="managerUsername" type="text" placeholder="Username (e.g., STJG)"
      class="w-full rounded-xl border border-gray-300 px-4 py-3 mb-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase"
      onkeydown="if(event.key==='Enter'||event.key==='Tab'){event.preventDefault();document.getElementById('managerPassword').focus();}">
    <input id="managerPassword" type="password" placeholder="Password"
      class="w-full rounded-xl border border-gray-300 px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      onkeydown="if(event.key==='Enter'){document.getElementById('btnManagerLogin').click();}">
    <button id="btnManagerLogin" class="w-full bg-blue-600 text-white rounded-xl py-3 font-semibold hover:bg-blue-700 transition">
      Sign In
    </button>
    <div id="loginError" class="text-red-600 text-sm mt-2 text-center hidden"></div>
  </div>
</div>

<!-- ============================================ -->
<!-- ROLE SELECTION VIEW (for PGJG, JTJG) -->
<!-- ============================================ -->
<div id="roleSelectionView" class="hidden min-h-screen flex items-center justify-center p-6">
  <div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
    <div class="text-center mb-6">
      <h1 class="text-3xl font-bold text-gray-900">Welcome, <span id="roleSelectName"></span></h1>
      <p class="text-gray-600 mt-2">Please select your role for this session</p>
    </div>
    
    <div class="space-y-3">
      <button id="btnSelectManager" class="w-full bg-blue-600 text-white rounded-xl py-4 font-semibold hover:bg-blue-700 transition text-lg">
        üëî Login as Manager
      </button>
      <button id="btnSelectHR" class="w-full bg-purple-600 text-white rounded-xl py-4 font-semibold hover:bg-purple-700 transition text-lg">
        üè¢ Login as HR Manager
      </button>
    </div>
    
    <button id="btnBackToLogin" class="w-full mt-4 text-gray-600 hover:text-gray-800 text-sm">
      ‚Üê Back to Login
    </button>
  </div>
</div>

<!-- ============================================ -->
<!-- MANAGER DASHBOARD -->
<!-- ============================================ -->
<div id="dashboardView" class="hidden">
  <!-- Header -->
  <header class="bg-white shadow-sm border-b">
    <div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
      <div>
        <h1 class="text-2xl font-bold text-gray-900">Welcome, <span id="managerName"></span></h1>
        <p class="text-sm text-gray-600">Department: <span id="managerDept"></span></p>
      </div>
      <button id="btnSignOut" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
        Sign Out
      </button>
      <button id="btnDiagnostic" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold transition">
        üîç DB Diagnostic
      </button>
    </div>
  </header>

  <!-- ============================================ -->
  <!-- DIAGNOSTIC PANEL (hidden by default)        -->
  <!-- ============================================ -->
  <div id="diagnosticPanel" class="hidden max-w-7xl mx-auto px-6 pt-4">
    <div class="bg-yellow-50 border-2 border-yellow-400 rounded-xl p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-xl font-bold text-yellow-900">üîç Database Diagnostic Tool</h2>
        <button id="btnCloseDiagnostic" class="text-yellow-700 hover:text-yellow-900 font-bold text-xl">‚úï</button>
      </div>
      <p class="text-yellow-800 text-sm mb-4">Enter employee initials to see exactly what is saved in the database ‚Äî sessions, signatures, acks, and status records.</p>
      <div class="flex gap-3 mb-4">
        <input id="diagInitials" type="text" placeholder="Employee initials (e.g. PG)" 
          class="rounded-lg border border-yellow-300 px-4 py-2 uppercase font-mono text-lg w-40 focus:ring-2 focus:ring-yellow-400">
        <button id="btnRunDiag" class="px-6 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold">
          Run Diagnostic
        </button>
        <button id="btnFixSession" class="px-6 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-semibold hidden">
          üîß Fix: Tag Today's Acks with Latest Session
        </button>
      </div>
      <div id="diagOutput" class="space-y-4 text-sm font-mono"></div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="max-w-7xl mx-auto p-6">
    <!-- ============================================ -->
    <!-- STATS CARDS -->
    <!-- ============================================ -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-gray-400">
        <div class="text-sm text-gray-600">Not Started</div>
        <div class="text-3xl font-bold text-gray-900" id="statsNotStarted">0</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-blue-400">
        <div class="text-sm text-gray-600">Employee Signed</div>
        <div class="text-3xl font-bold text-blue-900" id="statsEmployeeSigned">0</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-orange-400">
        <div class="text-sm text-gray-600">Manager Approved</div>
        <div class="text-3xl font-bold text-orange-900" id="statsManagerApproved">0</div>
      </div>
      <div class="bg-white rounded-xl shadow-sm p-4 border-l-4 border-green-400">
        <div class="text-sm text-gray-600">Fully Approved</div>
        <div class="text-3xl font-bold text-green-900" id="statsFullyApproved">0</div>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- STEP 1: ONE-TIME MANAGER SIGNATURE -->
    <!-- ============================================ -->
    <div id="signatureSetupSection" class="bg-white rounded-xl shadow-sm p-6 mb-6">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-xl font-bold">Step 1: Your Signature</h2>
        <button id="btnEditSignature" class="hidden px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold text-sm">
          ‚úèÔ∏è Edit Signature
        </button>
      </div>

      <!-- Existing signature display -->
      <div id="existingSignatureBox" class="hidden mb-4 border-2 border-green-300 rounded-xl p-4 bg-green-50">
        <p class="text-green-700 font-semibold text-sm mb-2">‚úÖ Signature on file:</p>
        <img id="existingSignatureImg" src="" alt="Saved signature" class="max-h-20 border border-gray-200 rounded bg-white p-1">
        <p id="existingSigDate" class="text-xs text-gray-500 mt-1"></p>
      </div>

      <!-- Draw new signature -->
      <div id="drawSignatureBox">
        <p class="text-gray-600 mb-3">Draw your signature below using your mouse or finger.</p>
        <div class="signature-container">
          <canvas id="managerSignatureCanvas"></canvas>
        </div>
        <div class="flex gap-2 mt-4">
          <button id="btnClearManagerSig" class="text-sm text-red-600 hover:text-red-700 font-medium">
            üóëÔ∏è Clear
          </button>
          <button id="btnCancelEdit" class="hidden text-sm text-gray-600 hover:text-gray-800 font-medium ml-2">
            ‚úï Cancel
          </button>
          <button id="btnSaveManagerSig" class="ml-auto px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
            ‚úÖ Save Signature
          </button>
        </div>
      </div>

      <div id="signatureSavedMsg" class="text-green-600 text-sm mt-2 hidden">‚úÖ Signature saved successfully!</div>
    </div>

    <!-- ============================================ -->
    <!-- STEP 2: APPROVE ALL SECTION (for regular managers) -->
    <!-- ============================================ -->
    <div id="approveAllSection" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl shadow-sm p-6 mb-6 hidden">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Step 2: Approve All Submissions</h2>
          <p class="text-gray-600 mt-1">Your signature will be added to all pending employee handbooks</p>
        </div>
        <button id="btnApproveAll" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-lg transition">
          ‚úÖ Approve All (<span id="pendingApprovalCount">0</span> employees)
        </button>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- STEP 2: HR FINAL APPROVAL (for JTJG only) -->
    <!-- ============================================ -->
    <div id="hrApproveAllSection" class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl shadow-sm p-6 mb-6 hidden">
      <div class="flex justify-between items-center">
        <div>
          <h2 class="text-xl font-bold text-gray-900">Step 2: HR Final Approval</h2>
          <p class="text-gray-600 mt-1">Add your signature as final HR approval to all manager-approved handbooks</p>
        </div>
        <button id="btnHRApproveAll" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-lg transition">
          ‚úÖ HR Approve All (<span id="pendingHRApprovalCount">0</span> employees)
        </button>
      </div>
    </div>

    <!-- ============================================ -->
    <!-- TABS: PENDING vs SUBMITTED -->
    <!-- ============================================ -->
    <div class="bg-white rounded-xl shadow-sm">
      <div class="border-b border-gray-200">
        <nav class="flex -mb-px">
          <button id="tabPending" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
            Pending Submissions
          </button>
          <button id="tabSubmitted" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
            Submitted & Approved
          </button>
        </nav>
      </div>

      <!-- ============================================ -->
      <!-- PENDING LIST -->
      <!-- ============================================ -->
      <div id="pendingContent" class="p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Employees Who Haven't Submitted</h2>
          <span id="pendingCount" class="text-sm text-gray-600"></span>
        </div>
        <div id="pendingList" class="space-y-2"></div>
      </div>

      <!-- ============================================ -->
      <!-- SUBMITTED LIST -->
      <!-- ============================================ -->
      <div id="submittedContent" class="p-6 hidden">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-xl font-bold">Submitted Handbooks</h2>
          <div class="flex gap-2">
            <button onclick="loadEmployees()" 
              class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
              üîÑ Refresh List
            </button>
            <button id="btnRegenerateAll" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold">
              üîÑ Regenerate All Approved
            </button>
            <button id="btnPrintAll" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold">
              üñ®Ô∏è Print All
            </button>
            <span id="submittedCount" class="text-sm text-gray-600 self-center"></span>
          </div>
        </div>
        <div id="submittedList" class="space-y-2"></div>
      </div>
    </div>
  </div>
</div>

<!-- Hidden iframe for printing -->
<iframe id="printFrame" style="display:none;"></iframe>

<!-- ============================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================ -->
<script>
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
// ============================================
// TIMEZONE HELPERS (CST - Central Standard Time)
// ============================================
function toCSTDate(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  // Convert to CST (UTC-6) or CDT (UTC-5)
  return date.toLocaleString('en-US', {
    timeZone: 'America/Chicago',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
}

function toCSTDateString(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', {
    timeZone: 'America/Chicago',
    year: 'numeric',
    month: '2-digit',
    day: '2-digit'
  });
}

function toCSTTimeString(dateString) {
  if (!dateString) return 'N/A';
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-US', {
    timeZone: 'America/Chicago',
    hour: '2-digit',
    minute: '2-digit',
    second: '2-digit',
    hour12: true
  });
}


let currentManager = null;
let managerSignatureData = null;
let allEmployees = [];
let pendingEmployees = [];
let submittedEmployees = [];

// ============================================
// SIGNATURE CANVAS SETUP
// ============================================
let canvas, ctx, isDrawing = false, hasSignature = false;

function initSignatureCanvas() {
  canvas = document.getElementById('managerSignatureCanvas');
  if (!canvas) {
    console.error('Canvas not found!');
    return;
  }
  const container = canvas.parentElement;
  canvas.width = container.clientWidth - 32;
  canvas.height = 200;
  ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#1f2937';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  canvas.replaceWith(canvas.cloneNode(true));
  canvas = document.getElementById('managerSignatureCanvas');
  canvas.width = container.clientWidth - 32;
  canvas.height = 200;
  ctx = canvas.getContext('2d');
  ctx.strokeStyle = '#1f2937';
  ctx.lineWidth = 2;
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  canvas.onmousedown = startDrawing;
  canvas.onmousemove = draw;
  canvas.onmouseup = stopDrawing;
  canvas.onmouseleave = stopDrawing;
  canvas.ontouchstart = handleTouchStart;
  canvas.ontouchmove = handleTouchMove;
  canvas.ontouchend = stopDrawing;
  console.log('‚úÖ Signature canvas initialized:', canvas.width, 'x', canvas.height);
}

function getCoords(e) {
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width / rect.width;
  const scaleY = canvas.height / rect.height;
  if (e.touches && e.touches[0]) {
    return {
      x: (e.touches[0].clientX - rect.left) * scaleX,
      y: (e.touches[0].clientY - rect.top) * scaleY
    };
  }
  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top) * scaleY
  };
}

function startDrawing(e) {
  e.preventDefault();
  isDrawing = true;
  hasSignature = true;
  const coords = getCoords(e);
  ctx.beginPath();
  ctx.moveTo(coords.x, coords.y);
}

function draw(e) {
  if (!isDrawing) return;
  e.preventDefault();
  const coords = getCoords(e);
  ctx.lineTo(coords.x, coords.y);
  ctx.stroke();
}

function stopDrawing(e) {
  if (e) e.preventDefault();
  isDrawing = false;
}

function handleTouchStart(e) {
  startDrawing(e);
}

function handleTouchMove(e) {
  draw(e);
}

function clearSignature() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  hasSignature = false;
  console.log('‚úÖ Signature cleared');
}

function getSignatureDataURL() {
  return canvas.toDataURL('image/png');
}

function isSignatureEmpty() {
  return !hasSignature;
}

// ============================================
// LOGIN
// ============================================
document.getElementById('btnManagerLogin').addEventListener('click', async () => {
  const username = document.getElementById('managerUsername').value.trim().toUpperCase();
  const password = document.getElementById('managerPassword').value.trim();
  const errorDiv = document.getElementById('loginError');
  
  if (!username || !password) {
    errorDiv.textContent = 'Please enter username and password';
    errorDiv.classList.remove('hidden');
    return;
  }
  
  try {
    const { data, error } = await client.rpc('hb_manager_login', {
      p_username: username,
      p_password: password
    });
    
    if (error || !data || !data.ok) {
      errorDiv.textContent = 'Invalid username or password';
      errorDiv.classList.remove('hidden');
      return;
    }
    
    currentManager = data;
    
    // Determine role selection flow
    const dualRoleUsers = ['PGJG', 'JTJG'];
    const hrOnlyUsers = ['FTJG'];
    
    if (dualRoleUsers.includes(currentManager.username)) {
      // Show role selection for dual-role users
      showRoleSelection();
      return;
    } else if (hrOnlyUsers.includes(currentManager.username)) {
      // FTJG is HR only
      currentManager.selectedRole = 'hr';
    } else {
      // All other users are managers only
      currentManager.selectedRole = 'manager';
    }
    
    await showDashboard();
  } catch (err) {
    console.error('Login error:', err);
    errorDiv.textContent = 'Login failed. Please try again.';
    errorDiv.classList.remove('hidden');
  }
});

// ============================================
// SHOW ROLE SELECTION
// ============================================
function showRoleSelection() {
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('roleSelectionView').classList.remove('hidden');
  document.getElementById('roleSelectName').textContent = currentManager.full_name;
}

// Role selection buttons
document.getElementById('btnSelectManager').addEventListener('click', async () => {
  currentManager.selectedRole = 'manager';
  document.getElementById('roleSelectionView').classList.add('hidden');
  await showDashboard();
});

document.getElementById('btnSelectHR').addEventListener('click', async () => {
  currentManager.selectedRole = 'hr';
  document.getElementById('roleSelectionView').classList.add('hidden');
  await showDashboard();
});

document.getElementById('btnBackToLogin').addEventListener('click', () => {
  document.getElementById('roleSelectionView').classList.add('hidden');
  document.getElementById('loginView').classList.remove('hidden');
  currentManager = null;
});

// ============================================
// SHOW DASHBOARD
// ============================================
async function showDashboard() {
  document.getElementById('loginView').classList.add('hidden');
  document.getElementById('dashboardView').classList.remove('hidden');
  document.getElementById('managerName').textContent = currentManager.full_name;
  
  const roleText = currentManager.selectedRole === 'hr' ? 'HR Manager' : 'Manager';
  document.getElementById('managerDept').textContent = roleText;
  document.getElementById('managerDept').textContent = roleText;
  
  setTimeout(() => {
    initSignatureCanvas();
  }, 100);

  // Load existing signature for this manager
  await loadExistingSignature();
  
  await loadEmployees();
}

// ============================================
// LOAD EXISTING SIGNATURE
// ============================================
async function loadExistingSignature() {
  const { data: sigs } = await client
    .from('hb_manager_signatures')
    .select('signature_data, signed_at')
    .eq('manager_username', currentManager.username)
    .order('signed_at', { ascending: false })
    .limit(1);

  if (sigs?.length && sigs[0].signature_data) {
    const sig = sigs[0];
    managerSignatureData = sig.signature_data;

    // Show existing signature box
    document.getElementById('existingSignatureImg').src = sig.signature_data;
    document.getElementById('existingSigDate').textContent =
      'Saved: ' + toCSTDate(sig.signed_at);
    document.getElementById('existingSignatureBox').classList.remove('hidden');
    document.getElementById('drawSignatureBox').classList.add('hidden');
    document.getElementById('btnEditSignature').classList.remove('hidden');

    // Show approve section immediately since sig exists
    if (currentManager.selectedRole === 'hr') {
      document.getElementById('hrApproveAllSection').classList.remove('hidden');
    } else {
      document.getElementById('approveAllSection').classList.remove('hidden');
    }
    console.log('‚úÖ Existing signature loaded for', currentManager.username);
  } else {
    // No signature ‚Äî show draw box
    document.getElementById('existingSignatureBox').classList.add('hidden');
    document.getElementById('drawSignatureBox').classList.remove('hidden');
    document.getElementById('btnEditSignature').classList.add('hidden');
    console.log('‚ÑπÔ∏è No existing signature for', currentManager.username);
  }
}

// ============================================
// üî• LOAD EMPLOYEES (FIXED - Shows Most Recent Submission Only)
// ============================================
async function loadEmployees() {
  console.log('üîç Loading employees...');
  
  // Clear cached data first
  pendingEmployees = [];
  submittedEmployees = [];
  
  const employeeQuery = client
    .from('employees2025')
    .select('employee_id, first_name, last_name, job_title, department, email, phone, report_to, status')
    .eq('status', 'Active')
    .order('first_name', { ascending: true });
  
  const { data: rawEmployees, error: empError } = await employeeQuery;
  
  if (empError) {
    console.error('‚ùå Error loading employees:', empError);
    alert('Failed to load employees: ' + empError.message);
    return;
  }
  
  let allEmps = (rawEmployees || []).map(emp => ({
    id: emp.employee_id,
    initials: (emp.first_name?.charAt(0) + emp.last_name?.charAt(0) || '??').toUpperCase(),
    full_name: `${emp.first_name || ''} ${emp.last_name || ''}`.trim(),
    position: emp.job_title,
    department: emp.department,
    email: emp.email,
    phone: emp.phone,
    report_to: emp.report_to,
    status: emp.status
  }));
  
  let filteredEmps = allEmps;
  
  if (!currentManager.can_see_all_employees) {
    if (currentManager.allowed_employee_initials && currentManager.allowed_employee_initials.length > 0) {
      filteredEmps = filteredEmps.filter(emp =>
        currentManager.allowed_employee_initials.includes(emp.initials)
      );
    } else if (currentManager.allowed_positions && currentManager.allowed_positions.length > 0) {
      filteredEmps = filteredEmps.filter(emp =>
        emp.position && currentManager.allowed_positions.includes(emp.position)
      );
    }
  }
  
  if (currentManager.can_see_all_employees &&
      currentManager.blocked_employee_initials &&
      currentManager.blocked_employee_initials.length > 0) {
    filteredEmps = filteredEmps.filter(emp =>
      !currentManager.blocked_employee_initials.includes(emp.initials)
    );
    console.log(`üö´ Blocked ${currentManager.blocked_employee_initials.length} employees for ${currentManager.username}`);
  }
  
  allEmployees = filteredEmps;
  console.log('üìã All employees loaded:', allEmployees.length);
  
  // ============================================
  // üî• CRITICAL FIX: Get MOST RECENT status per employee
  // ============================================
  console.log('\nüìä Fetching submission statuses...');
  const { data: statuses, error: statusError } = await client
    .from('hb_acknowledgment_status')
    .select('*')
    .order('created_at', { ascending: false });  // Newest first
  
  const { data: signatures, error: sigError } = await client
    .from('hb_employee_signatures')
    .select('employee_initials, pdf_url, signed_at, created_at, session_id')
    .order('created_at', { ascending: false });  // Newest first

  // ‚îÄ‚îÄ ALSO fetch from hb_ack_forms which stores the email-sent PDF url ‚îÄ‚îÄ
  const { data: ackForms } = await client
    .from('hb_ack_forms')
    .select('initials, pdf_url, created_at, status')
    .not('pdf_url', 'is', null)
    .order('created_at', { ascending: false });
  
  if (statusError) console.error('‚ùå Error loading statuses:', statusError);
  if (sigError) console.error('‚ùå Error loading signatures:', sigError);
  
  console.log('üìä Statuses:', statuses?.length || 0);
  console.log('‚úçÔ∏è Signatures:', signatures?.length || 0);
  console.log('üì¨ Ack Forms with PDF:', ackForms?.length || 0);
  
  // ‚îÄ‚îÄ Build a map of the NEWEST pdf_url per employee from ALL sources ‚îÄ‚îÄ
  const latestPDFMap = new Map(); // initials ‚Üí { pdf_url, date }

  // From hb_acknowledgment_status (column is final_pdf_url)
  (statuses || []).forEach(s => {
    if (!s.final_pdf_url) return;
    const ex = latestPDFMap.get(s.employee_initials);
    if (!ex || s.created_at > ex.date) {
      latestPDFMap.set(s.employee_initials, { pdf_url: s.final_pdf_url, date: s.created_at });
    }
  });

  // From hb_employee_signatures (may have newer pdf_url if email fn saved it)
  (signatures || []).forEach(sig => {
    if (!sig.pdf_url) return;
    const ex = latestPDFMap.get(sig.employee_initials);
    if (!ex || sig.created_at > ex.date) {
      latestPDFMap.set(sig.employee_initials, { pdf_url: sig.pdf_url, date: sig.created_at });
    }
  });

  // From hb_ack_forms (email function PDF ‚Äî often the most recent)
  (ackForms || []).forEach(af => {
    if (!af.pdf_url || !af.initials) return;
    const ex = latestPDFMap.get(af.initials);
    if (!ex || af.created_at > ex.date) {
      latestPDFMap.set(af.initials, { pdf_url: af.pdf_url, date: af.created_at });
    }
  });

  console.log('üîó Latest PDF URLs found for:', latestPDFMap.size, 'employees');

  // ============================================
  // Build submittedMap ‚Äî keep ONLY most recent status per employee
  // ============================================
  const submittedMap = new Map();
  
  (statuses || []).forEach(s => {
    if (!s.employee_signed) return;
    const existing = submittedMap.get(s.employee_initials);
    if (!existing || new Date(s.created_at) > new Date(existing.created_at)) {
      submittedMap.set(s.employee_initials, s);
      console.log(`‚úÖ Status for ${s.employee_initials}: ${s.created_at}`);
    }
  });

  // ‚îÄ‚îÄ Attach the BEST pdf_url to each status record ‚îÄ‚îÄ
  submittedMap.forEach((status, initials) => {
    const best = latestPDFMap.get(initials);
    if (best) {
      status.pdf_url = best.pdf_url;
      console.log(`üìÑ PDF URL set for ${initials} (from ${best.date}):`, best.pdf_url.slice(-40));
    }
    // Also attach the most recent signature date for display
    const latestSig = (signatures || []).find(sg => sg.employee_initials === initials);
    if (latestSig?.signed_at || latestSig?.created_at) {
      const sigDate = latestSig?.signed_at || latestSig?.created_at;
      const statusDate = status.employee_signed_at || status.created_at;
      if (sigDate) status.employee_signed_at = sigDate > statusDate ? sigDate : statusDate;
    }
  });
  
  console.log('‚úÖ Submitted employees (most recent only):', submittedMap.size);
  
  // Separate pending vs submitted
  pendingEmployees = allEmployees.filter(e => !submittedMap.has(e.initials));
  submittedEmployees = allEmployees.filter(e => submittedMap.has(e.initials));
  
  // Attach status to each submitted employee
  submittedEmployees = submittedEmployees.map(emp => {
    const status = submittedMap.get(emp.initials);
    return { ...emp, status };
  });
  
  console.log('‚è≥ Pending:', pendingEmployees.length);
  console.log('‚úÖ Submitted:', submittedEmployees.length);
  
  // Update UI
  updateStats();
  renderPendingList();
  renderSubmittedList();
  updateApprovalCount();
}

// ============================================
// UPDATE STATS
// ============================================
function updateStats() {
  const notStarted = pendingEmployees.length;
  const employeeSigned = submittedEmployees.filter(e => e.status?.employee_signed && !e.status?.manager_approved).length;
  const managerApproved = submittedEmployees.filter(e => e.status?.manager_approved && !e.status?.hr_approved).length;
  const fullyApproved = submittedEmployees.filter(e => e.status?.hr_approved).length;
  
  document.getElementById('statsNotStarted').textContent = notStarted;
  document.getElementById('statsEmployeeSigned').textContent = employeeSigned;
  document.getElementById('statsManagerApproved').textContent = managerApproved;
  document.getElementById('statsFullyApproved').textContent = fullyApproved;
}

// ============================================
// RENDER PENDING LIST
// ============================================
function renderPendingList() {
  const container = document.getElementById('pendingList');
  document.getElementById('pendingCount').textContent = `${pendingEmployees.length} employees`;
  
  if (pendingEmployees.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-8">‚úÖ All employees have submitted!</p>';
    return;
  }
  
  const html = pendingEmployees.map(emp => `
    <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-700">
          ${emp.initials || '??'}
        </div>
        <div>
          <div class="font-semibold text-gray-900">${emp.full_name || 'Unknown'}</div>
          <div class="text-sm text-gray-600">${emp.position || 'N/A'} ‚Ä¢ ${emp.department || 'N/A'}</div>
        </div>
      </div>
      <span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">
        ‚è≥ Not Submitted
      </span>
    </div>
  `).join('');
  
  container.innerHTML = html;
}

// ============================================
// RENDER SUBMITTED LIST
// ============================================
function renderSubmittedList() {
  const container = document.getElementById('submittedList');
  document.getElementById('submittedCount').textContent = `${submittedEmployees.length} submitted`;
  
  if (submittedEmployees.length === 0) {
    container.innerHTML = '<p class="text-center text-gray-500 py-8">No submissions yet</p>';
    return;
  }
  
  const html = submittedEmployees.map(emp => {
    const status = emp.status || {};
    const hasPDF = !!status.pdf_url;
    // ‚úÖ Use CST timezone for display
    const signedDate = status.employee_signed_at
      ? toCSTDateString(status.employee_signed_at)
      : 'Unknown Date';
    const signedTime = status.employee_signed_at
      ? toCSTTimeString(status.employee_signed_at)
      : '';
    
    const sigCount = (status.employee_signed ? 1 : 0) +
                     (status.manager_approved ? 1 : 0) +
                     (status.hr_approved ? 1 : 0);
    
    let statusBadge = '';
    let signatureBadge = '';
    
    if (status.hr_approved) {
      statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">‚úÖ Fully Approved</span>';
      signatureBadge = '<span class="px-2 py-1 bg-green-500 text-white rounded text-xs font-bold">3/3 ‚úì</span>';
    } else if (status.manager_approved) {
      statusBadge = '<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">‚è≥ Awaiting HR</span>';
      signatureBadge = '<span class="px-2 py-1 bg-orange-500 text-white rounded text-xs font-bold">2/3</span>';
    } else {
      statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">‚è≥ Pending Approval</span>';
      signatureBadge = '<span class="px-2 py-1 bg-blue-500 text-white rounded text-xs font-bold">1/3</span>';
    }
    
    const isHR = currentManager.selectedRole === 'hr';
    
    return `
      <div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-700">
            ${emp.initials || '??'}
          </div>
          <div>
            <div class="flex items-center gap-2">
              <div class="font-semibold text-gray-900">${emp.full_name || 'Unknown'}</div>
              ${signatureBadge}
            </div>
            <div class="text-sm text-gray-600">${emp.position || 'N/A'} ‚Ä¢ Submitted: ${signedDate} ${signedTime}</div>
            ${status.manager_approved ? '<div class="text-xs text-gray-500 mt-1">Manager: ' + (status.manager_approved_by || 'Unknown') + ' ‚Ä¢ ' + toCSTDate(status.manager_approved_at) + '</div>' : ''}
            ${status.hr_approved ? '<div class="text-xs text-gray-500">HR: ' + (status.hr_approved_by || 'Unknown') + ' ‚Ä¢ ' + toCSTDate(status.hr_approved_at) + '</div>' : ''}
          </div>
        </div>
        <div class="flex items-center gap-2 flex-wrap justify-end">
          ${statusBadge}
          ${hasPDF ? `
            <button onclick="printSinglePDF('${emp.initials}')"
              class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-sm font-medium">
              üìÑ View PDF
            </button>
          ` : `
            <span class="px-3 py-1 bg-gray-100 text-gray-500 rounded text-xs">No PDF yet</span>
          `}
          ${!isHR && !status.manager_approved ? `
            <button onclick="approveSingleEmployee('${emp.initials}', '${emp.full_name}')"
              class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium font-semibold">
              ‚úÖ Approve
            </button>
          ` : ''}
          ${status.manager_approved ? `
            <button onclick="regenerateSinglePDF('${emp.initials}', '${emp.full_name}')"
              class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 text-sm font-medium">
              üîÑ Regen PDF
            </button>
          ` : ''}
          ${isHR && status.manager_approved && !status.hr_approved ? `
            <button onclick="hrApproveSingle('${emp.initials}', '${emp.full_name}')"
              class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">
              ‚úÖ HR Approve
            </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
  
  container.innerHTML = html;
}


// ============================================
// TAB SWITCHING
// ============================================
document.getElementById('tabPending').addEventListener('click', () => {
  document.getElementById('pendingContent').classList.remove('hidden');
  document.getElementById('submittedContent').classList.add('hidden');
  document.getElementById('tabPending').classList.add('border-blue-600', 'text-blue-600');
  document.getElementById('tabPending').classList.remove('border-transparent', 'text-gray-500');
  document.getElementById('tabSubmitted').classList.remove('border-blue-600', 'text-blue-600');
  document.getElementById('tabSubmitted').classList.add('border-transparent', 'text-gray-500');
});

document.getElementById('tabSubmitted').addEventListener('click', () => {
  document.getElementById('submittedContent').classList.remove('hidden');
  document.getElementById('pendingContent').classList.add('hidden');
  document.getElementById('tabSubmitted').classList.add('border-blue-600', 'text-blue-600');
  document.getElementById('tabSubmitted').classList.remove('border-transparent', 'text-gray-500');
  document.getElementById('tabPending').classList.remove('border-blue-600', 'text-blue-600');
  document.getElementById('tabPending').classList.add('border-transparent', 'text-gray-500');
});

// ============================================
// REGENERATE ALL APPROVED PDFs
// ============================================
document.getElementById('btnRegenerateAll').addEventListener('click', async () => {
  const approvedEmployees = submittedEmployees.filter(e => e.status?.manager_approved);
  
  if (approvedEmployees.length === 0) {
    alert('No approved employees to regenerate PDFs for');
    return;
  }
  
  if (!confirm(`Regenerate PDFs for ${approvedEmployees.length} approved employees?\nThis will create new PDFs with all current signatures.`)) {
    return;
  }
  
  const progressDiv = document.createElement('div');
  progressDiv.id = 'regenerateAllProgressDiv';
  progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
  progressDiv.innerHTML = `
    <div class="font-bold mb-2">üîÑ Regenerating PDFs...</div>
    <div id="regenerateAllProgress" class="text-sm">0 / ${approvedEmployees.length}</div>
    <div class="text-xs mt-2 opacity-80">Please wait...</div>
  `;
  document.body.appendChild(progressDiv);
  
  let completed = 0;
  const errors = [];
  
  for (const emp of approvedEmployees) {
    try {
      const regenPayload = {
        employee_initials: emp.initials,
        manager_username: currentManager.username,
        manager_name: currentManager.full_name,
        manager_approved_at: emp.status?.manager_approved_at || null
      };
      // Include HR info if already approved
      if (emp.status?.hr_approved && emp.status?.hr_approved_by) {
        regenPayload.hr_username = emp.status.hr_approved_by;
        regenPayload.hr_name = emp.status.hr_approved_by === 'JTJG' ? 'Francisco Teng' : emp.status.hr_approved_by;
        regenPayload.hr_approved_at = emp.status.hr_approved_at || null;
      }
      const response = await client.functions.invoke('regenerate-handbook-pdf', { body: regenPayload });
      
      if (response.error || !response.data?.ok) {
        throw new Error(response.error?.message || response.data?.error || 'Failed');
      }
      
      completed++;
      document.getElementById('regenerateAllProgress').textContent = `${completed} / ${approvedEmployees.length}`;
    } catch (error) {
      console.error(`Error regenerating ${emp.initials}:`, error);
      errors.push(`${emp.full_name}: ${error.message}`);
    }
  }
  
  document.body.removeChild(progressDiv);
  
  if (errors.length > 0) {
    alert(`‚ö†Ô∏è Regenerated ${completed} PDFs.\nErrors for ${errors.length} employees:\n${errors.join('\n')}`);
  } else {
    alert(`‚úÖ Successfully regenerated ${completed} PDFs!`);
  }
  
  await loadEmployees();
});

// ============================================
// EDIT SIGNATURE BUTTON
// ============================================
document.getElementById('btnEditSignature').addEventListener('click', () => {
  document.getElementById('existingSignatureBox').classList.add('hidden');
  document.getElementById('drawSignatureBox').classList.remove('hidden');
  document.getElementById('btnEditSignature').classList.add('hidden');
  document.getElementById('btnCancelEdit').classList.remove('hidden');
  clearSignature();
  setTimeout(() => initSignatureCanvas(), 50);
});

document.getElementById('btnCancelEdit').addEventListener('click', () => {
  // Restore existing sig display
  document.getElementById('drawSignatureBox').classList.add('hidden');
  document.getElementById('existingSignatureBox').classList.remove('hidden');
  document.getElementById('btnEditSignature').classList.remove('hidden');
  document.getElementById('btnCancelEdit').classList.add('hidden');
});

// ============================================
// SAVE MANAGER SIGNATURE
// ============================================
document.getElementById('btnSaveManagerSig').addEventListener('click', async () => {
  if (isSignatureEmpty()) {
    alert('Please draw your signature first');
    return;
  }
  
  managerSignatureData = getSignatureDataURL();
  console.log('üíæ Saving signature...');
  
  const cstNow = new Date().toLocaleString('en-US', { timeZone: 'America/Chicago' });
  const nowISO = new Date().toISOString();

  const { error } = await client.from('hb_manager_signatures').insert({
    manager_username: currentManager.username,
    employee_initials: null,
    signature_data: managerSignatureData,
    signed_at: nowISO,
    signed_at_cst: cstNow
  });
  
  if (error) {
    console.error('Error saving signature:', error);
    alert('Failed to save signature: ' + error.message);
    return;
  }
  
  console.log('‚úÖ Signature saved!', cstNow);

  // Update the existing sig preview
  document.getElementById('existingSignatureImg').src = managerSignatureData;
  document.getElementById('existingSigDate').textContent = 'Saved: ' + toCSTDate(nowISO);

  document.getElementById('signatureSavedMsg').classList.remove('hidden');
  document.getElementById('btnCancelEdit').classList.add('hidden');

  setTimeout(() => {
    document.getElementById('signatureSavedMsg').classList.add('hidden');
    document.getElementById('drawSignatureBox').classList.add('hidden');
    document.getElementById('existingSignatureBox').classList.remove('hidden');
    document.getElementById('btnEditSignature').classList.remove('hidden');
    document.getElementById('signatureSetupSection').style.display = '';

    if (currentManager.selectedRole === 'hr') {
      document.getElementById('hrApproveAllSection').classList.remove('hidden');
    } else {
      document.getElementById('approveAllSection').classList.remove('hidden');
    }
    updateApprovalCount();
  }, 1500);
});

document.getElementById('btnClearManagerSig').addEventListener('click', clearSignature);

// ============================================
// UPDATE APPROVAL COUNT
// ============================================
function updateApprovalCount() {
  const isHR = currentManager.selectedRole === 'hr';
  
  if (isHR) {
    // For HR: count employees with manager approval but no HR approval
    const pending = submittedEmployees.filter(e => e.status?.manager_approved && !e.status?.hr_approved).length;
    const countElement = document.getElementById('pendingHRApprovalCount');
    if (countElement) {
      countElement.textContent = pending;
    }
  } else {
    // For regular managers: count employees with employee signature but no manager approval
    const pending = submittedEmployees.filter(e => e.status?.employee_signed && !e.status?.manager_approved).length;
    const countElement = document.getElementById('pendingApprovalCount');
    if (countElement) {
      countElement.textContent = pending;
    }
  }
}

// ============================================
// APPROVE ALL EMPLOYEES (MANAGER)
// ============================================
document.getElementById('btnApproveAll').addEventListener('click', async () => {
  if (!managerSignatureData) {
    alert('‚ö†Ô∏è Please save your signature first!');
    return;
  }
  
  const employeesToApprove = submittedEmployees.filter(e => e.status?.employee_signed && !e.status?.manager_approved);
  
  if (employeesToApprove.length === 0) {
    alert('‚úÖ All employees already approved!');
    return;
  }
  
  if (!confirm(`Approve ${employeesToApprove.length} employees and add your signature to their handbooks?`)) {
    return;
  }
  
  const progressDiv = document.createElement('div');
  progressDiv.id = 'approvalProgressDiv';
  progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
  progressDiv.innerHTML = `
    <div class="font-bold mb-2">üìù Processing Approvals...</div>
    <div id="approvalProgress" class="text-sm">0 / ${employeesToApprove.length}</div>
    <div class="text-xs mt-2 opacity-80">Updating PDFs with your signature...</div>
  `;
  document.body.appendChild(progressDiv);
  
  let completed = 0;
  const errors = [];
  
  for (const emp of employeesToApprove) {
    try {
      console.log(`üìù Approving ${emp.full_name}...`);
      
      // Update status
      const { error: statusError } = await client
        .from('hb_acknowledgment_status')
        .update({
          manager_approved: true,
          manager_approved_by: currentManager.username,
          manager_approved_at: new Date().toISOString()
        })
        .eq('employee_initials', emp.initials)
        .eq('id', emp.status.id);
      
      if (statusError) throw statusError;
      
      // Regenerate PDF with MOST RECENT signature
      const response = await client.functions.invoke('regenerate-handbook-pdf', {
        body: {
          employee_initials: emp.initials,
          manager_username: currentManager.username,
          manager_name: currentManager.full_name
        }
      });
      
      if (response.error) {
        throw new Error(`PDF update failed: ${response.error.message}`);
      }
      
      completed++;
      document.getElementById('approvalProgress').textContent = `${completed} / ${employeesToApprove.length}`;
    } catch (error) {
      console.error(`‚ùå Error approving ${emp.initials}:`, error);
      errors.push(`${emp.full_name}: ${error.message}`);
    }
  }
  
  document.body.removeChild(progressDiv);
  
  if (errors.length > 0) {
    alert(`‚ö†Ô∏è Approved ${completed} employees.\nErrors for ${errors.length} employees:\n${errors.join('\n')}`);
  } else {
    alert(`‚úÖ Successfully approved all ${completed} employees!\nPDFs updated with your signature.`);
  }
  
  await loadEmployees();
});

// ============================================
// HR APPROVE ALL EMPLOYEES
// ============================================
document.getElementById('btnHRApproveAll').addEventListener('click', async () => {
  if (!managerSignatureData) {
    alert('‚ö†Ô∏è Please save your signature first!');
    return;
  }
  
  const employeesToApprove = submittedEmployees.filter(e => e.status?.manager_approved && !e.status?.hr_approved);
  
  if (employeesToApprove.length === 0) {
    alert('‚úÖ All manager-approved employees have HR approval!');
    return;
  }
  
  if (!confirm(`Add HR approval for ${employeesToApprove.length} employees?\nYour signature will be added as final approval.`)) {
    return;
  }
  
  const progressDiv = document.createElement('div');
  progressDiv.id = 'hrApprovalProgressDiv';
  progressDiv.className = 'fixed top-4 right-4 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
  progressDiv.innerHTML = `
    <div class="font-bold mb-2">üìù Processing HR Approvals...</div>
    <div id="hrApprovalProgress" class="text-sm">0 / ${employeesToApprove.length}</div>
    <div class="text-xs mt-2 opacity-80">Adding final HR signature...</div>
  `;
  document.body.appendChild(progressDiv);
  
  let completed = 0;
  const errors = [];
  
  for (const emp of employeesToApprove) {
    try {
      console.log(`üìù HR Approving ${emp.full_name}...`);
      
      // Update status
      const { error: statusError } = await client
        .from('hb_acknowledgment_status')
        .update({
          hr_approved: true,
          hr_approved_by: currentManager.username,
          hr_approved_at: new Date().toISOString()
        })
        .eq('employee_initials', emp.initials)
        .eq('id', emp.status.id);
      
      if (statusError) throw statusError;
      
      // Regenerate PDF with HR signature
      const hrNowAll = new Date().toISOString();
      const response = await client.functions.invoke('regenerate-handbook-pdf', {
        body: {
          employee_initials: emp.initials,
          hr_username: currentManager.username,
          hr_name: currentManager.full_name,
          hr_approved_at: hrNowAll,
          manager_username: emp.status.manager_approved_by || currentManager.username,
          manager_name: emp.status.manager_approved_by || currentManager.full_name,
          manager_approved_at: emp.status.manager_approved_at || null
        }
      });
      
      if (response.error) {
        throw new Error(`PDF update failed: ${response.error.message}`);
      }
      
      completed++;
      document.getElementById('hrApprovalProgress').textContent = `${completed} / ${employeesToApprove.length}`;
    } catch (error) {
      console.error(`‚ùå Error HR approving ${emp.initials}:`, error);
      errors.push(`${emp.full_name}: ${error.message}`);
    }
  }
  
  document.body.removeChild(progressDiv);
  
  if (errors.length > 0) {
    alert(`‚ö†Ô∏è HR Approved ${completed} employees.\nErrors for ${errors.length} employees:\n${errors.join('\n')}`);
  } else {
    alert(`‚úÖ Successfully HR approved all ${completed} employees!\nPDFs updated with HR signature.`);
  }
  
  await loadEmployees();
});

// ============================================
// APPROVE SINGLE EMPLOYEE (from submitted list)
// ============================================
window.approveSingleEmployee = async function(employeeInitials, employeeName) {
  if (!managerSignatureData) {
    alert('‚ö†Ô∏è Please draw and save your signature first (Step 1 above)!');
    return;
  }
  if (!confirm(`Approve ${employeeName}'s handbook and generate PDF with your signature?`)) return;

  const employee = submittedEmployees.find(e => e.initials === employeeInitials);
  if (!employee || !employee.status) { alert('Employee data not found'); return; }

  const progressDiv = document.createElement('div');
  progressDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
  progressDiv.innerHTML = `<div class="font-bold mb-1">‚úÖ Approving ${employeeName}...</div><div class="text-xs opacity-80">Generating PDF...</div>`;
  document.body.appendChild(progressDiv);

  try {
    // 1. Mark as manager approved
    const { error: statusError } = await client
      .from('hb_acknowledgment_status')
      .update({
        manager_approved: true,
        manager_approved_by: currentManager.username,
        manager_approved_at: new Date().toISOString()
      })
      .eq('employee_initials', employeeInitials)
      .eq('id', employee.status.id);
    if (statusError) throw statusError;

    // 2. Regenerate PDF with manager signature
    const response = await client.functions.invoke('regenerate-handbook-pdf', {
      body: {
        employee_initials: employeeInitials,
        manager_username: currentManager.username,
        manager_name: currentManager.full_name,
        manager_approved_at: new Date().toISOString()
      }
    });
    if (response.error) throw new Error(`PDF failed: ${response.error.message}`);

    document.body.removeChild(progressDiv);
    alert(`‚úÖ ${employeeName} approved! PDF generated with your signature.`);
    await loadEmployees();
  } catch (error) {
    document.body.removeChild(progressDiv);
    console.error('Approve error:', error);
    alert(`‚ùå Approval failed:\n${error.message}`);
  }
};

// ============================================
// HR APPROVE SINGLE
// ============================================
window.hrApproveSingle = async function(employeeInitials, employeeName) {
  if (!managerSignatureData) {
    alert('‚ö†Ô∏è Please save your signature first!');
    return;
  }
  
  if (!confirm(`Add HR approval for ${employeeName}?`)) {
    return;
  }
  
  const employee = submittedEmployees.find(e => e.initials === employeeInitials);
  if (!employee || !employee.status) {
    alert('Employee not found');
    return;
  }
  
  try {
    // Update status
    const { error: statusError } = await client
      .from('hb_acknowledgment_status')
      .update({
        hr_approved: true,
        hr_approved_by: currentManager.username,
        hr_approved_at: new Date().toISOString()
      })
      .eq('employee_initials', employeeInitials)
      .eq('id', employee.status.id);
    
    if (statusError) throw statusError;
    
    // Regenerate PDF
    const hrNow = new Date().toISOString();
    const response = await client.functions.invoke('regenerate-handbook-pdf', {
      body: {
        employee_initials: employeeInitials,
        hr_username: currentManager.username,
        hr_name: currentManager.full_name,
        hr_approved_at: hrNow,
        manager_username: employee.status.manager_approved_by || currentManager.username,
        manager_name: employee.status.manager_approved_by || currentManager.full_name,
        manager_approved_at: employee.status.manager_approved_at || null
      }
    });

    if (response.error) throw new Error(`PDF failed: ${response.error.message}`);

    alert(`‚úÖ HR approval added for ${employeeName}!`);
    await loadEmployees();
  } catch (error) {
    console.error('HR approval error:', error);
    alert(`‚ùå Failed to add HR approval:\n${error.message}`);
  }
};

// ============================================
// PRINT SINGLE PDF
// ============================================
window.printSinglePDF = async function(employeeInitials) {
  const employee = submittedEmployees.find(e => e.initials === employeeInitials);
  
  if (!employee || !employee.status || !employee.status.pdf_url) {
    alert('PDF not found for this employee');
    return;
  }
  
  window.open(employee.status.pdf_url, '_blank');
  
  await client
    .from('hb_acknowledgment_status')
    .update({
      printed: true,
      printed_at: new Date().toISOString(),
      print_count: (employee.status.print_count || 0) + 1
    })
    .eq('employee_initials', employeeInitials)
    .eq('id', employee.status.id);
  
  await loadEmployees();
};

// ============================================
// PRINT ALL PDFs
// ============================================
document.getElementById('btnPrintAll').addEventListener('click', async () => {
  const employeesWithPDF = submittedEmployees.filter(e => e.status?.pdf_url);
  
  if (employeesWithPDF.length === 0) {
    alert('No PDFs available to print');
    return;
  }
  
  if (!confirm(`Open ${employeesWithPDF.length} PDF files for printing?`)) {
    return;
  }
  
  employeesWithPDF.forEach((emp, index) => {
    setTimeout(() => {
      window.open(emp.status.pdf_url, '_blank');
    }, index * 300);
  });
  
  alert(`Opening ${employeesWithPDF.length} PDFs for printing...`);
});

// ============================================
// REGENERATE SINGLE PDF
// ============================================
window.regenerateSinglePDF = async function(employeeInitials, employeeName) {
  if (!confirm(`Regenerate PDF for ${employeeName}?\nThis will create a new PDF with the MOST RECENT signatures.`)) {
    return;
  }
  
  console.log('üîÑ Regenerating PDF for', employeeInitials);

  // Find the employee's status so we know if HR approved
  const employee = submittedEmployees.find(e => e.initials === employeeInitials);
  const isHRApproved = employee?.status?.hr_approved;
  const hrApprovedBy = employee?.status?.hr_approved_by;
  
  const progressDiv = document.createElement('div');
  progressDiv.id = 'regenerateProgressDiv';
  progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
  progressDiv.innerHTML = `
    <div class="font-bold mb-2">üîÑ Regenerating PDF...</div>
    <div class="text-sm">${employeeName}</div>
    <div class="text-xs mt-2 opacity-80">Please wait...</div>
  `;
  document.body.appendChild(progressDiv);
  
  try {
    // Build payload ‚Äî always include manager, include HR if already approved
    const payload = {
      employee_initials: employeeInitials,
      manager_username: currentManager.username,
      manager_name: currentManager.full_name,
      manager_approved_at: employee?.status?.manager_approved_at || null
    };

    // If HR already approved, pass their info so signature appears in PDF
    if (isHRApproved && hrApprovedBy) {
      payload.hr_username = hrApprovedBy;
      payload.hr_name = hrApprovedBy === 'JTJG' ? 'Francisco Teng' : hrApprovedBy;
      payload.hr_approved_at = employee?.status?.hr_approved_at || null;
    }

    const response = await client.functions.invoke('regenerate-handbook-pdf', { body: payload });
    
    if (response.error || !response.data || !response.data.ok) {
      throw new Error(response.error?.message || response.data?.error || 'PDF regeneration failed');
    }
    
    document.body.removeChild(progressDiv);
    
    const successDiv = document.createElement('div');
    successDiv.className = 'fixed top-4 right-4 bg-green-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
    successDiv.innerHTML = `
      <div class="font-bold mb-2">‚úÖ PDF Regenerated!</div>
      <div class="text-sm">${employeeName}</div>
      <div class="text-xs mt-2">
        <a href="${response.data.pdf_url}" target="_blank" class="underline">View PDF</a>
      </div>
    `;
    document.body.appendChild(successDiv);
    
    setTimeout(() => {
      document.body.removeChild(successDiv);
    }, 5000);
    
    await loadEmployees();
  } catch (error) {
    console.error('‚ùå Regeneration error:', error);
    document.body.removeChild(progressDiv);
    alert(`‚ùå Failed to regenerate PDF:\n${error.message}`);
  }
};

// ============================================
// üîç DIAGNOSTIC TOOL
// ============================================
document.getElementById('btnDiagnostic').addEventListener('click', () => {
  document.getElementById('diagnosticPanel').classList.toggle('hidden');
});
document.getElementById('btnCloseDiagnostic').addEventListener('click', () => {
  document.getElementById('diagnosticPanel').classList.add('hidden');
});

document.getElementById('btnRunDiag').addEventListener('click', async () => {
  const initials = document.getElementById('diagInitials').value.trim().toUpperCase();
  if (!initials) { alert('Enter initials first'); return; }
  
  const out = document.getElementById('diagOutput');
  out.innerHTML = '<div class="text-yellow-700 animate-pulse">‚è≥ Querying database...</div>';
  document.getElementById('btnFixSession').classList.add('hidden');

  try {
    // ‚îÄ‚îÄ 1. Sessions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const { data: sessions } = await client
      .from('hb_sessions')
      .select('*')
      .eq('initials', initials)
      .order('created_at', { ascending: false })
      .limit(10);

    // ‚îÄ‚îÄ 2. Employee Signatures ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const { data: sigs } = await client
      .from('hb_employee_signatures')
      .select('id, employee_initials, session_id, signed_at, created_at, pdf_url, signature_type')
      .eq('employee_initials', initials)
      .order('created_at', { ascending: false })
      .limit(10);

    // ‚îÄ‚îÄ 3. Acknowledgment Status ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const { data: statuses } = await client
      .from('hb_acknowledgment_status')
      .select('*')
      .eq('employee_initials', initials)
      .order('created_at', { ascending: false })
      .limit(10);

    // ‚îÄ‚îÄ 4. Individual Policy Acks ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const { data: acks } = await client
      .from('hb_acks')
      .select('id, employee_initials, session_id, policy_id, signed_initials, agreed, created_at, saved_at')
      .eq('employee_initials', initials)
      .order('created_at', { ascending: false })
      .limit(50);

    // ‚îÄ‚îÄ 5. hb_ack_forms (email submissions ‚Äî has the emailed PDF url) ‚îÄ‚îÄ
    const { data: ackForms } = await client
      .from('hb_ack_forms')
      .select('id, initials, session_id, status, pdf_url, created_at, manager_email_to')
      .eq('initials', initials)
      .order('created_at', { ascending: false })
      .limit(10);

    // ‚îÄ‚îÄ Build report ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const row = (label, val, highlight = false) =>
      `<div class="${highlight ? 'text-red-700 font-bold' : 'text-gray-800'}"><span class="text-gray-500 w-40 inline-block">${label}:</span> ${val}</div>`;

    const section = (title, color, content) =>
      `<div class="bg-white border border-${color}-300 rounded-lg p-4 mb-3">
        <h3 class="font-bold text-${color}-800 mb-2">${title}</h3>
        ${content}
      </div>`;

    const fmt = (d) => d ? toCSTDate(d) : '<span class="text-gray-400">null</span>';

    // Sessions
    let sessHtml = sessions?.length
      ? sessions.map(s => `<div class="mb-1 pl-2 border-l-2 border-blue-200">
          <b>Session ID: ${s.id}</b> | Started: ${fmt(s.created_at)} | Initials: ${s.initials}
        </div>`).join('')
      : '<div class="text-gray-400">No sessions found (table may be named differently)</div>';

    // Signatures
    let sigHtml = sigs?.length
      ? sigs.map((s, i) => `<div class="mb-2 pl-2 border-l-4 ${i === 0 ? 'border-green-400' : 'border-gray-200'}">
          <b>${i === 0 ? '‚≠ê MOST RECENT' : `#${i+1}`}</b> | session_id: <b>${s.session_id ?? 'NULL'}</b>
          | signed_at: ${fmt(s.signed_at)} | created_at: ${fmt(s.created_at)}
          | has_pdf: ${s.pdf_url ? `‚úÖ <a href="${s.pdf_url}" target="_blank" class="underline text-blue-600 text-xs">View PDF</a>` : '‚ùå'}
        </div>`).join('')
      : '<div class="text-red-500 font-bold">‚ùå NO SIGNATURE RECORDS FOUND</div>';

    // Statuses
    let statusHtml = statuses?.length
      ? statuses.map((s, i) => `<div class="mb-2 pl-2 border-l-4 ${i === 0 ? 'border-green-400' : 'border-gray-200'}">
          <b>${i === 0 ? '‚≠ê MOST RECENT' : `#${i+1}`}</b> | session_id: <b>${s.session_id ?? 'NULL'}</b>
          | created_at: ${fmt(s.created_at)}
          | emp_signed: ${s.employee_signed ? '‚úÖ' : '‚ùå'} @ ${fmt(s.employee_signed_at)}
          | mgr_approved: ${s.manager_approved ? '‚úÖ' : '‚ùå'} @ ${fmt(s.manager_approved_at)}
          | hr_approved: ${s.hr_approved ? '‚úÖ' : '‚ùå'} @ ${fmt(s.hr_approved_at)}
          ${s.final_pdf_url ? `| pdf: <a href="${s.final_pdf_url}" target="_blank" class="underline text-blue-600 text-xs">View PDF</a>` : '| pdf: none'}
        </div>`).join('')
      : '<div class="text-red-500 font-bold">‚ùå NO STATUS RECORDS FOUND</div>';

    // Acks grouped by session_id
    const acksBySession = {};
    (acks || []).forEach(a => {
      const key = String(a.session_id ?? 'null');
      if (!acksBySession[key]) acksBySession[key] = [];
      acksBySession[key].push(a);
    });
    let acksHtml = Object.keys(acksBySession).length
      ? Object.entries(acksBySession).map(([sid, list]) => `
          <div class="mb-2 pl-2 border-l-4 border-purple-200">
            <b>session_id: ${sid}</b> ‚Äî ${list.length} acks | dates: ${fmt(list[list.length-1]?.created_at)} ‚Üí ${fmt(list[0]?.created_at)}
            <br><span class="text-gray-500 text-xs">${list.map(a => a.policy_id).join(', ')}</span>
          </div>`).join('')
      : '<div class="text-red-500 font-bold">‚ùå NO ACK RECORDS FOUND</div>';

    // ‚îÄ‚îÄ KEY DIAGNOSIS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const latestSig = sigs?.[0];
    const latestStatus = statuses?.[0];
    const latestSigSession = latestSig?.session_id;
    const acksForLatestSig = (acks || []).filter(a => String(a.session_id) === String(latestSigSession));
    const latestSignedAt = latestSig?.signed_at || latestSig?.created_at;
    
    const mismatch = latestSig && statuses?.length && 
      latestSig.session_id !== null &&
      latestStatus?.session_id !== null &&
      String(latestSig.session_id) !== String(latestStatus?.session_id);

    // ‚îÄ‚îÄ ack_forms (email submissions) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    let ackFormsHtml = ackForms?.length
      ? ackForms.map((af, i) => `<div class="mb-2 pl-2 border-l-4 ${i === 0 ? 'border-green-400' : 'border-gray-200'}">
          <b>${i === 0 ? '‚≠ê MOST RECENT' : `#${i+1}`}</b> | session_id: ${af.session_id ?? 'null'}
          | status: ${af.status || 'N/A'} | date: ${fmt(af.created_at)}
          ${af.pdf_url ? `| üìÑ <a href="${af.pdf_url}" target="_blank" class="underline text-blue-600 font-bold">Open Emailed PDF</a>` : '| no pdf_url'}
        </div>`).join('')
      : '<div class="text-gray-400">No hb_ack_forms records found</div>';

    // ‚îÄ‚îÄ Find the most recent emailed PDF URL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
    const emailedPDF = (ackForms || []).find(af => af.pdf_url)?.pdf_url;

    let diagHtml = `<div class="bg-${mismatch ? 'red' : 'green'}-50 border border-${mismatch ? 'red' : 'green'}-300 rounded p-3 mb-2">`;
    diagHtml += `<b class="text-${mismatch ? 'red' : 'green'}-800">DIAGNOSIS:</b><br>`;
    diagHtml += `‚Ä¢ Latest signature session_id: <b>${latestSigSession ?? 'NULL'}</b> (${fmt(latestSignedAt)})<br>`;
    diagHtml += `‚Ä¢ Latest status session_id: <b>${latestStatus?.session_id ?? 'NULL'}</b> (${fmt(latestStatus?.created_at)})<br>`;
    diagHtml += `‚Ä¢ Acks found for latest sig's session: <b>${acksForLatestSig.length}</b><br>`;
    diagHtml += `‚Ä¢ Emailed PDF exists in hb_ack_forms: <b>${emailedPDF ? '‚úÖ Yes' : '‚ùå No'}</b>`;
    if (emailedPDF) diagHtml += ` ‚Äî <a href="${emailedPDF}" target="_blank" class="underline text-blue-700 font-bold">üìÑ Open it here</a>`;
    diagHtml += `<br>`;

    if (mismatch) {
      diagHtml += `<br>‚ö†Ô∏è <b class="text-red-700">SESSION MISMATCH DETECTED!</b> The latest signature uses session ${latestSigSession} but the status record uses session ${latestStatus?.session_id}. The PDF was built from the WRONG session's acks.<br>`;
      diagHtml += `Click "üîß Fix" below to re-tag acks with the correct session.`;
      document.getElementById('btnFixSession').classList.remove('hidden');
      document.getElementById('btnFixSession').dataset.initials = initials;
      document.getElementById('btnFixSession').dataset.correctSession = latestSigSession;
      document.getElementById('btnFixSession').dataset.wrongSession = latestStatus?.session_id;
    } else if (acksForLatestSig.length === 0 && acks?.length > 0) {
      diagHtml += `<br>‚ö†Ô∏è <b class="text-orange-700">ACKS EXIST BUT WRONG SESSION!</b> There are ${acks.length} ack records but NONE match the latest signature's session_id (${latestSigSession}). The PDF would be EMPTY or use old acks.`;
    } else {
      diagHtml += `<br>‚úÖ Sessions match. ${acksForLatestSig.length} acks linked to latest signature.`;
    }

    // ‚îÄ‚îÄ Show "Save Emailed PDF to DB" button if we have the URL ‚îÄ‚îÄ
    if (emailedPDF) {
      diagHtml += `<br><br><button onclick="saveEmailedPDFtoDB('${initials}', '${emailedPDF}')" 
        class="px-4 py-2 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700 mt-2">
        üíæ Save Emailed PDF URL to DB (makes it appear in manager portal)
      </button>`;
    }

    diagHtml += '</div>';

    out.innerHTML =
      diagHtml +
      section('üì° Sessions (hb_sessions)', 'blue', sessHtml) +
      section(`‚úçÔ∏è Employee Signatures (hb_employee_signatures) ‚Äî ${sigs?.length || 0} records`, 'green', sigHtml) +
      section(`üìã Acknowledgment Status (hb_acknowledgment_status) ‚Äî ${statuses?.length || 0} records`, 'orange', statusHtml) +
      section(`üìù Individual Acks (hb_acks) ‚Äî ${acks?.length || 0} records`, 'purple', acksHtml) +
      section(`üì¨ Email Submissions (hb_ack_forms) ‚Äî ${ackForms?.length || 0} records`, 'indigo', ackFormsHtml);

  } catch (err) {
    out.innerHTML = `<div class="text-red-600 font-bold">‚ùå Diagnostic failed: ${err.message}</div>`;
  }
});

// ‚îÄ‚îÄ Save emailed PDF URL to DB so manager portal can find it ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.saveEmailedPDFtoDB = async function(initials, pdfUrl) {
  if (!confirm(`Save the emailed PDF URL for ${initials} to the database?\nThis will make the PDF appear in the manager portal immediately.`)) return;

  const nowISO = new Date().toISOString();
  let saved = false;

  // Update hb_employee_signatures (most recent record)
  const { error: sigErr } = await client
    .from('hb_employee_signatures')
    .update({ pdf_url: pdfUrl, pdf_generated_at: nowISO })
    .eq('employee_initials', initials)
    .order('created_at', { ascending: false })
    .limit(1);
  if (!sigErr) saved = true;
  else console.warn('sigErr:', sigErr.message);

  // Update hb_acknowledgment_status (most recent record) using id
  const { data: latestStatus } = await client
    .from('hb_acknowledgment_status')
    .select('id')
    .eq('employee_initials', initials)
    .order('created_at', { ascending: false })
    .limit(1)
    .single();

  if (latestStatus?.id) {
    const { error: statusErr } = await client
      .from('hb_acknowledgment_status')
      .update({ final_pdf_url: pdfUrl, updated_at: nowISO })
      .eq('id', latestStatus.id);
    if (!statusErr) saved = true;
    else console.warn('statusErr:', statusErr.message);
  }

  if (saved) {
    alert(`‚úÖ PDF URL saved to database for ${initials}!\nRefresh the manager portal to see the PDF button.`);
    await loadEmployees();
    document.getElementById('btnRunDiag').click(); // Re-run diagnostic
  } else {
    alert(`‚ö†Ô∏è Could not save PDF URL to DB. Check console for errors.`);
  }
};

// ‚îÄ‚îÄ FIX: Re-tag acks with correct session ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
document.getElementById('btnFixSession').addEventListener('click', async () => {
  const initials = document.getElementById('btnFixSession').dataset.initials;
  const correctSession = document.getElementById('btnFixSession').dataset.correctSession;
  const wrongSession = document.getElementById('btnFixSession').dataset.wrongSession;
  
  if (!confirm(`This will update acks from session ${wrongSession} ‚Üí session ${correctSession} for ${initials}.\nThis fixes the date mismatch in the PDF. Proceed?`)) return;
  
  // Update hb_acks that have the wrong session_id
  const { error: acksErr, count } = await client
    .from('hb_acks')
    .update({ session_id: Number(correctSession) })
    .eq('employee_initials', initials)
    .eq('session_id', Number(wrongSession));

  // Update hb_acknowledgment_status to match
  const { error: statusErr } = await client
    .from('hb_acknowledgment_status')
    .update({ session_id: Number(correctSession) })
    .eq('employee_initials', initials)
    .eq('session_id', Number(wrongSession));

  if (acksErr || statusErr) {
    alert(`‚ö†Ô∏è Fix had errors:\n${acksErr?.message || ''}\n${statusErr?.message || ''}`);
  } else {
    alert(`‚úÖ Session re-tagged! Now run the diagnostic again to verify, then click Regenerate PDF.`);
    document.getElementById('btnRunDiag').click();
  }
});

// ============================================
// SIGN OUT
// ============================================
document.getElementById('btnSignOut').addEventListener('click', () => {
  if (confirm('Are you sure you want to sign out?')) {
    currentManager = null;
    managerSignatureData = null;
    document.getElementById('dashboardView').classList.add('hidden');
    document.getElementById('loginView').classList.remove('hidden');
    document.getElementById('managerUsername').value = '';
    document.getElementById('managerPassword').value = '';
  }
});
</script>
</body>
</html>
