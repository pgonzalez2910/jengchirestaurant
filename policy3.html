<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Jeng Chi ‚Äî Manager Handbook Portal</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
@media print {
body * { visibility: hidden; }
#printFrame { visibility: visible; position: absolute; left: 0; top: 0; width: 100%; }
}
.signature-container {
position: relative;
width: 100%;
border: 2px solid #d1d5db;
border-radius: 0.5rem;
background: white;
padding: 1rem;
}
#managerSignatureCanvas {
display: block;
width: 100%;
height: 200px;
border: 2px dashed #9ca3af;
border-radius: 0.5rem;
background: white;
cursor: crosshair;
touch-action: none;
-webkit-user-select: none;
-moz-user-select: none;
user-select: none;
}
</style>
</head>
<body class="h-full bg-slate-50">
<!-- ============================================ -->
<!-- LOGIN VIEW -->
<!-- ============================================ -->
<div id="loginView" class="min-h-screen flex items-center justify-center p-6">
<div class="w-full max-w-md bg-white rounded-2xl shadow-lg p-8">
<div class="text-center mb-6">
<h1 class="text-3xl font-bold text-gray-900">Manager Portal</h1>
<p class="text-gray-600 mt-2">Handbook Approvals & HR Sign-off</p>
</div>
<input id="managerUsername" type="text" placeholder="Username (e.g., STJG)"
class="w-full rounded-xl border border-gray-300 px-4 py-3 mb-3 focus:ring-2 focus:ring-blue-500 focus:border-transparent uppercase"
onkeydown="if(event.key==='Enter'||event.key==='Tab'){event.preventDefault();document.getElementById('managerPassword').focus();}">
<input id="managerPassword" type="password" placeholder="Password"
class="w-full rounded-xl border border-gray-300 px-4 py-3 mb-4 focus:ring-2 focus:ring-blue-500 focus:border-transparent"
onkeydown="if(event.key==='Enter'){document.getElementById('btnManagerLogin').click();}">
<button id="btnManagerLogin" class="w-full bg-blue-600 text-white rounded-xl py-3 font-semibold hover:bg-blue-700 transition">
Sign In
</button>
<div id="loginError" class="text-red-600 text-sm mt-2 text-center hidden"></div>
</div>
</div>
<!-- ============================================ -->
<!-- MANAGER DASHBOARD -->
<!-- ============================================ -->
<div id="dashboardView" class="hidden">
<!-- Header -->
<header class="bg-white shadow-sm border-b">
<div class="max-w-7xl mx-auto px-6 py-4 flex justify-between items-center">
<div>
<h1 class="text-2xl font-bold text-gray-900">Welcome, <span id="managerName"></span></h1>
<p class="text-sm text-gray-600">Role: <span id="managerRole"></span></p>
</div>
<button id="btnSignOut" class="px-4 py-2 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
Sign Out
</button>
</div>
</header>

<!-- Main Content -->
<div class="max-w-7xl mx-auto p-6">
<!-- ============================================ -->
<!-- STEP 1: ONE-TIME MANAGER SIGNATURE -->
<!-- ============================================ -->
<div id="signatureSetupSection" class="bg-white rounded-xl shadow-sm p-6 mb-6">
<div class="flex justify-between items-center mb-2">
<h2 class="text-xl font-bold">Step 1: Your Signature</h2>
<button id="btnEditSignature" class="hidden px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 font-semibold text-sm">
‚úèÔ∏è Edit Signature
</button>
</div>
<!-- Existing signature display -->
<div id="existingSignatureBox" class="hidden mb-4 border-2 border-green-300 rounded-xl p-4 bg-green-50">
<p class="text-green-700 font-semibold text-sm mb-2">‚úÖ Signature on file:</p>
<img id="existingSignatureImg" src="" alt="Saved signature" class="max-h-20 border border-gray-200 rounded bg-white p-1">
<p id="existingSigDate" class="text-xs text-gray-500 mt-1"></p>
</div>
<!-- Draw new signature -->
<div id="drawSignatureBox">
<p class="text-gray-600 mb-3">Draw your signature below using your mouse or finger.</p>
<div class="signature-container">
<canvas id="managerSignatureCanvas"></canvas>
</div>
<div class="flex gap-2 mt-4">
<button id="btnClearManagerSig" class="text-sm text-red-600 hover:text-red-700 font-medium">
üóëÔ∏è Clear
</button>
<button id="btnCancelEdit" class="hidden text-sm text-gray-600 hover:text-gray-800 font-medium ml-2">
‚úï Cancel
</button>
<button id="btnSaveManagerSig" class="ml-auto px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold">
‚úÖ Save Signature
</button>
</div>
</div>
<div id="signatureSavedMsg" class="text-green-600 text-sm mt-2 hidden">‚úÖ Signature saved successfully!</div>
</div>

<!-- ============================================ -->
<!-- STEP 2: APPROVE ALL SECTION (for regular managers) -->
<!-- ============================================ -->
<div id="approveAllSection" class="bg-gradient-to-r from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl shadow-sm p-6 mb-6 hidden">
<div class="flex justify-between items-center">
<div>
<h2 class="text-xl font-bold text-gray-900">Step 2: Manager Approval</h2>
<p class="text-gray-600 mt-1">Add your signature to employee-submitted handbooks</p>
</div>
<button id="btnApproveAll" class="px-6 py-3 bg-green-600 text-white rounded-lg hover:bg-green-700 font-semibold shadow-lg transition">
‚úÖ Approve All (<span id="pendingApprovalCount">0</span> employees)
</button>
</div>
</div>

<!-- ============================================ -->
<!-- STEP 3: HR FINAL APPROVAL (for HR Managers only) -->
<!-- ============================================ -->
<div id="hrApproveAllSection" class="bg-gradient-to-r from-purple-50 to-indigo-50 border-2 border-purple-200 rounded-xl shadow-sm p-6 mb-6 hidden">
<div class="flex justify-between items-center">
<div>
<h2 class="text-xl font-bold text-gray-900">Step 3: HR Final Approval</h2>
<p class="text-gray-600 mt-1">Add final HR signature to manager-approved handbooks</p>
</div>
<button id="btnHRApproveAll" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-semibold shadow-lg transition">
‚úÖ HR Approve All (<span id="pendingHRApprovalCount">0</span> employees)
</button>
</div>
</div>

<!-- ============================================ -->
<!-- TABS: PENDING vs SUBMITTED -->
<!-- ============================================ -->
<div class="bg-white rounded-xl shadow-sm">
<div class="border-b border-gray-200">
<nav class="flex -mb-px">
<button id="tabPending" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-blue-600 text-blue-600">
Pending Submissions
</button>
<button id="tabSubmitted" class="tab-btn px-6 py-4 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300">
Submitted & Approved
</button>
</nav>
</div>
<!-- ============================================ -->
<!-- PENDING LIST -->
<!-- ============================================ -->
<div id="pendingContent" class="p-6">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Employees Who Haven't Submitted</h2>
<span id="pendingCount" class="text-sm text-gray-600"></span>
</div>
<div id="pendingList" class="space-y-2"></div>
</div>
<!-- ============================================ -->
<!-- SUBMITTED LIST -->
<!-- ============================================ -->
<div id="submittedContent" class="p-6 hidden">
<div class="flex justify-between items-center mb-4">
<h2 class="text-xl font-bold">Submitted Handbooks</h2>
<div class="flex gap-2">
<button onclick="loadEmployees()"
class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold">
üîÑ Refresh List
</button>
<button id="btnPrintAll" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 font-semibold">
üñ®Ô∏è Print All
</button>
<span id="submittedCount" class="text-sm text-gray-600 self-center"></span>
</div>
</div>
<div id="submittedList" class="space-y-2"></div>
</div>
</div>
</div>
</div>
<!-- Hidden iframe for printing -->
<iframe id="printFrame" style="display:none;"></iframe>
<!-- ============================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================ -->
<script>
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ============================================
// TIMEZONE HELPERS (CST - Central Standard Time)
// ============================================
function toCSTDate(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleString('en-US', {
timeZone: 'America/Chicago',
year: 'numeric', month: '2-digit', day: '2-digit',
hour: '2-digit', minute: '2-digit', hour12: true
});
}
function toCSTDateString(dateString) {
if (!dateString) return 'N/A';
const date = new Date(dateString);
return date.toLocaleDateString('en-US', {
timeZone: 'America/Chicago',
year: 'numeric', month: '2-digit', day: '2-digit'
});
}

let currentManager = null;
let managerSignatureData = null;
let allEmployees = [];
let pendingEmployees = [];
let submittedEmployees = [];

// ============================================
// MANAGER ASSIGNMENT LOGIC (YOUR RULES)
// ============================================
function getAssignedManagerUsername(position, fullName) {
const pos = (position || '').toLowerCase();
const name = (fullName || '').toLowerCase();

// 1. Specific Exceptions (Managers reporting to HR)
if (name.includes('craig reeves')) return 'JTJG';
if (name.includes('mai vu')) return 'JTJG';

// 2. Role Based Assignments
if (pos.includes('server')) return 'STJG';
if (pos.includes('bartender')) return 'CRJT';
if (pos.includes('cashier') || pos.includes('host')) return 'MVJG';

// 3. Default (BOH, etc. report to Pablo)
return 'PGJG';
}

function isHRManager(username) {
return ['PGJG', 'JTJG', 'FTJG'].includes(username);
}

// ============================================
// SIGNATURE CANVAS SETUP
// ============================================
let canvas, ctx, isDrawing = false, hasSignature = false;
function initSignatureCanvas() {
canvas = document.getElementById('managerSignatureCanvas');
if (!canvas) return;
const container = canvas.parentElement;
canvas.width = container.clientWidth - 32;
canvas.height = 200;
ctx = canvas.getContext('2d');
ctx.strokeStyle = '#1f2937';
ctx.lineWidth = 2;
ctx.lineCap = 'round';
ctx.lineJoin = 'round';
canvas.onmousedown = startDrawing;
canvas.onmousemove = draw;
canvas.onmouseup = stopDrawing;
canvas.onmouseleave = stopDrawing;
canvas.ontouchstart = handleTouchStart;
canvas.ontouchmove = handleTouchMove;
canvas.ontouchend = stopDrawing;
}
function getCoords(e) {
const rect = canvas.getBoundingClientRect();
const scaleX = canvas.width / rect.width;
const scaleY = canvas.height / rect.height;
if (e.touches && e.touches[0]) {
return { x: (e.touches[0].clientX - rect.left) * scaleX, y: (e.touches[0].clientY - rect.top) * scaleY };
}
return { x: (e.clientX - rect.left) * scaleX, y: (e.clientY - rect.top) * scaleY };
}
function startDrawing(e) { e.preventDefault(); isDrawing = true; hasSignature = true; const coords = getCoords(e); ctx.beginPath(); ctx.moveTo(coords.x, coords.y); }
function draw(e) { if (!isDrawing) return; e.preventDefault(); const coords = getCoords(e); ctx.lineTo(coords.x, coords.y); ctx.stroke(); }
function stopDrawing(e) { if (e) e.preventDefault(); isDrawing = false; }
function handleTouchStart(e) { startDrawing(e); }
function handleTouchMove(e) { draw(e); }
function clearSignature() { ctx.clearRect(0, 0, canvas.width, canvas.height); hasSignature = false; }
function getSignatureDataURL() { return canvas.toDataURL('image/png'); }
function isSignatureEmpty() { return !hasSignature; }

// ============================================
// LOGIN
// ============================================
document.getElementById('btnManagerLogin').addEventListener('click', async () => {
const username = document.getElementById('managerUsername').value.trim().toUpperCase();
const password = document.getElementById('managerPassword').value.trim();
const errorDiv = document.getElementById('loginError');
if (!username || !password) { errorDiv.textContent = 'Please enter username and password'; errorDiv.classList.remove('hidden'); return; }
try {
// Using the same RPC as employee portal for simplicity, assuming managers have accounts there
const { data, error } = await client.rpc('hb_manager_login', { p_username: username, p_password: password });
if (error || !data || !data.ok) {
// Fallback for demo if RPC fails: allow specific usernames
if (['STJG','JTJG','FTJG','PGJG','CRJT','MVJG'].includes(username)) {
currentManager = { username, full_name: username, can_see_all_employees: false, allowed_positions: [] };
showDashboard();
return;
}
errorDiv.textContent = 'Invalid username or password';
errorDiv.classList.remove('hidden');
return;
}
currentManager = data;
showDashboard();
} catch (err) {
console.error('Login error:', err);
errorDiv.textContent = 'Login failed. Please try again.';
errorDiv.classList.remove('hidden');
}
});

// ============================================
// SHOW DASHBOARD
// ============================================
async function showDashboard() {
document.getElementById('loginView').classList.add('hidden');
document.getElementById('dashboardView').classList.remove('hidden');
document.getElementById('managerName').textContent = currentManager.full_name || currentManager.username;

const isHR = isHRManager(currentManager.username);
document.getElementById('managerRole').textContent = isHR ? 'HR Manager' : 'Department Manager';

setTimeout(() => { initSignatureCanvas(); }, 100);
await loadExistingSignature();
await loadEmployees();
}

// ============================================
// LOAD EXISTING SIGNATURE
// ============================================
 // ============================================
// LOAD EXISTING SIGNATURE (FIXED FOR JTJG)
// ============================================
async function loadExistingSignature() {
const { data: sigs } = await client
.from('hb_manager_signatures')
.select('signature_data, signed_at')
.eq('manager_username', currentManager.username)
.order('signed_at', { ascending: false })
.limit(1);

const isHR = ['PGJG', 'JTJG', 'FTJG'].includes(currentManager.username);

if (sigs?.length && sigs[0].signature_data) {
const sig = sigs[0];
managerSignatureData = sig.signature_data;
// Show existing signature box
document.getElementById('existingSignatureImg').src = sig.signature_data;
document.getElementById('existingSigDate').textContent =
'Saved: ' + toCSTDate(sig.signed_at);
document.getElementById('existingSignatureBox').classList.remove('hidden');
document.getElementById('drawSignatureBox').classList.add('hidden');
document.getElementById('btnEditSignature').classList.remove('hidden');

// FIX: If JTJG, show BOTH Manager and HR buttons
if (currentManager.username === 'JTJG') {
document.getElementById('approveAllSection').classList.remove('hidden'); // Show Manager Button
document.getElementById('hrApproveAllSection').classList.remove('hidden'); // Show HR Button
} else if (isHR) {
// Other HR managers
document.getElementById('hrApproveAllSection').classList.remove('hidden');
} else {
// Regular Managers
document.getElementById('approveAllSection').classList.remove('hidden');
}
console.log('‚úÖ Existing signature loaded for', currentManager.username);
} else {
// No signature ‚Äî show draw box
document.getElementById('existingSignatureBox').classList.add('hidden');
document.getElementById('drawSignatureBox').classList.remove('hidden');
document.getElementById('btnEditSignature').classList.add('hidden');
console.log('‚ÑπÔ∏è No existing signature for', currentManager.username);
}
}

// ============================================
// LOAD EMPLOYEES (WITH ASSIGNMENT LOGIC)
// ============================================
async function loadEmployees() {
pendingEmployees = [];
submittedEmployees = [];

// 1. Get All Active Employees
const { data: rawEmployees, error: empError } = await client.from('employees2025').select('employee_id, first_name, last_name, job_title, department, status').eq('status', 'Active');
if (empError) { alert('Failed to load employees'); return; }

let allEmps = (rawEmployees || []).map(emp => ({
id: emp.employee_id,
initials: (emp.first_name?.charAt(0) + emp.last_name?.charAt(0) || '??').toUpperCase(),
full_name: `${emp.first_name || ''} ${emp.last_name || ''}`.trim(),
position: emp.job_title,
department: emp.department
}));

// 2. Filter based on Logged In Manager's Assignment Rules
const myUsername = currentManager.username;
const isHR = isHRManager(myUsername);

if (isHR) {
// HR Sees EVERYONE (for final approval queue)
allEmployees = allEmps;
} else {
// Managers See ONLY their assigned team
allEmployees = allEmps.filter(emp => {
const assignedMgr = getAssignedManagerUsername(emp.position, emp.full_name);
return assignedMgr === myUsername;
});
}

// 3. Get Statuses
const { data: statuses } = await client.from('hb_acknowledgment_status').select('*').order('created_at', { ascending: false });
const submittedMap = new Map();
(statuses || []).forEach(s => {
if (!s.employee_signed) return;
const existing = submittedMap.get(s.employee_initials);
if (!existing || new Date(s.created_at) > new Date(existing.created_at)) {
submittedMap.set(s.employee_initials, s);
}
});

// 4. Separate Pending vs Submitted
pendingEmployees = allEmployees.filter(e => !submittedMap.has(e.initials));
submittedEmployees = allEmployees.filter(e => submittedMap.has(e.initials)).map(emp => ({ ...emp, status: submittedMap.get(emp.initials) }));

updateStats();
renderPendingList();
renderSubmittedList();
updateApprovalCount();
}

// ============================================
// UPDATE STATS & COUNTS
// ============================================
function updateStats() {
document.getElementById('pendingCount').textContent = `${pendingEmployees.length} employees`;
document.getElementById('submittedCount').textContent = `${submittedEmployees.length} submitted`;
}

function updateApprovalCount() {
const isHR = isHRManager(currentManager.username);
if (isHR) {
// HR Count: Manager Approved but NOT HR Approved
const count = submittedEmployees.filter(e => e.status?.manager_approved && !e.status?.hr_approved).length;
document.getElementById('pendingHRApprovalCount').textContent = count;
} else {
// Manager Count: Employee Signed but NOT Manager Approved
const count = submittedEmployees.filter(e => e.status?.employee_signed && !e.status?.manager_approved).length;
document.getElementById('pendingApprovalCount').textContent = count;
}
}

// ============================================
// RENDER LISTS
// ============================================
function renderPendingList() {
const container = document.getElementById('pendingList');
if (pendingEmployees.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-8">‚úÖ All your employees have submitted!</p>'; return; }
container.innerHTML = pendingEmployees.map(emp => `
<div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
<div class="flex items-center gap-4">
<div class="w-12 h-12 bg-gray-200 rounded-full flex items-center justify-center font-bold text-gray-700">${emp.initials}</div>
<div>
<div class="font-semibold text-gray-900">${emp.full_name}</div>
<div class="text-sm text-gray-600">${emp.position || 'N/A'}</div>
</div>
</div>
<span class="px-3 py-1 bg-yellow-100 text-yellow-800 rounded-full text-sm font-medium">‚è≥ Not Submitted</span>
</div>
`).join('');
}

function renderSubmittedList() {
const container = document.getElementById('submittedList');
if (submittedEmployees.length === 0) { container.innerHTML = '<p class="text-center text-gray-500 py-8">No submissions yet</p>'; return; }
const isHR = isHRManager(currentManager.username);

container.innerHTML = submittedEmployees.map(emp => {
const status = emp.status || {};
const hasPDF = !!status.final_pdf_url;
const sigCount = (status.employee_signed ? 1 : 0) + (status.manager_approved ? 1 : 0) + (status.hr_approved ? 1 : 0);

let statusBadge = '';
let actionBtn = '';

if (status.hr_approved) {
statusBadge = '<span class="px-3 py-1 bg-green-100 text-green-800 rounded-full text-sm font-medium">‚úÖ Fully Approved</span>';
} else if (status.manager_approved) {
statusBadge = '<span class="px-3 py-1 bg-orange-100 text-orange-800 rounded-full text-sm font-medium">‚è≥ Awaiting HR</span>';
if (isHR) {
actionBtn = `<button onclick="hrApproveSingle('${emp.initials}', '${emp.full_name}')" class="px-4 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 text-sm font-medium">‚úÖ HR Approve</button>`;
}
} else {
statusBadge = '<span class="px-3 py-1 bg-blue-100 text-blue-800 rounded-full text-sm font-medium">‚è≥ Pending Manager</span>';
if (!isHR) {
actionBtn = `<button onclick="approveSingleEmployee('${emp.initials}', '${emp.full_name}')" class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 text-sm font-medium">‚úÖ Approve</button>`;
}
}

return `
<div class="flex items-center justify-between p-4 border border-gray-200 rounded-lg hover:bg-gray-50">
<div class="flex items-center gap-4">
<div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center font-bold text-blue-700">${emp.initials}</div>
<div>
<div class="font-semibold text-gray-900">${emp.full_name}</div>
<div class="text-sm text-gray-600">${emp.position || 'N/A'} ‚Ä¢ Submitted: ${toCSTDate(status.employee_signed_at)}</div>
${status.manager_approved ? `<div class="text-xs text-gray-500">Manager: ${status.manager_approved_by} ‚Ä¢ ${toCSTDate(status.manager_approved_at)}</div>` : ''}
${status.hr_approved ? `<div class="text-xs text-gray-500">HR: ${status.hr_approved_by} ‚Ä¢ ${toCSTDate(status.hr_approved_at)}</div>` : ''}
</div>
</div>
<div class="flex items-center gap-2 flex-wrap justify-end">
${statusBadge}
${hasPDF ? `<button onclick="printSinglePDF('${emp.initials}')" class="px-4 py-2 bg-gray-700 text-white rounded-lg hover:bg-gray-800 text-sm font-medium">üìÑ View PDF</button>` : ''}
${actionBtn}
</div>
</div>
`;
}).join('');
}

// ============================================
// SAVE MANAGER SIGNATURE
// ============================================
document.getElementById('btnSaveManagerSig').addEventListener('click', async () => {
if (isSignatureEmpty()) { alert('Please draw your signature first'); return; }
managerSignatureData = getSignatureDataURL();
const nowISO = new Date().toISOString();
const { error } = await client.from('hb_manager_signatures').insert({
manager_username: currentManager.username,
signature_data: managerSignatureData,
signed_at: nowISO,
signed_at_cst: toCSTDate(nowISO)
});
if (error) { alert('Failed to save signature: ' + error.message); return; }
document.getElementById('existingSignatureImg').src = managerSignatureData;
document.getElementById('existingSigDate').textContent = 'Saved: ' + toCSTDate(nowISO);
document.getElementById('signatureSavedMsg').classList.remove('hidden');
setTimeout(() => {
document.getElementById('signatureSavedMsg').classList.add('hidden');
document.getElementById('drawSignatureBox').classList.add('hidden');
document.getElementById('existingSignatureBox').classList.remove('hidden');
document.getElementById('btnEditSignature').classList.remove('hidden');
if (isHRManager(currentManager.username)) { document.getElementById('hrApproveAllSection').classList.remove('hidden'); } 
else { document.getElementById('approveAllSection').classList.remove('hidden'); }
updateApprovalCount();
}, 1500);
});
document.getElementById('btnClearManagerSig').addEventListener('click', clearSignature);
document.getElementById('btnEditSignature').addEventListener('click', () => {
document.getElementById('existingSignatureBox').classList.add('hidden');
document.getElementById('drawSignatureBox').classList.remove('hidden');
document.getElementById('btnEditSignature').classList.add('hidden');
document.getElementById('btnCancelEdit').classList.remove('hidden');
clearSignature();
});
document.getElementById('btnCancelEdit').addEventListener('click', () => {
document.getElementById('drawSignatureBox').classList.add('hidden');
document.getElementById('existingSignatureBox').classList.remove('hidden');
document.getElementById('btnEditSignature').classList.remove('hidden');
document.getElementById('btnCancelEdit').classList.add('hidden');
});

// ============================================
// APPROVE ALL (MANAGER)
// ============================================
document.getElementById('btnApproveAll').addEventListener('click', async () => {
if (!managerSignatureData) { alert('‚ö†Ô∏è Please save your signature first!'); return; }
const employeesToApprove = submittedEmployees.filter(e => e.status?.employee_signed && !e.status?.manager_approved);
if (employeesToApprove.length === 0) { alert('‚úÖ All employees already approved!'); return; }
if (!confirm(`Approve ${employeesToApprove.length} employees and add your signature?`)) return;

const progressDiv = document.createElement('div');
progressDiv.className = 'fixed top-4 right-4 bg-blue-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
progressDiv.innerHTML = `<div class="font-bold mb-2">üìù Processing Approvals...</div><div id="approvalProgress" class="text-sm">0 / ${employeesToApprove.length}</div>`;
document.body.appendChild(progressDiv);

let completed = 0;
for (const emp of employeesToApprove) {
try {
// 1. Update Status
await client.from('hb_acknowledgment_status').update({
manager_approved: true,
manager_approved_by: currentManager.username,
manager_approved_at: new Date().toISOString()
}).eq('employee_initials', emp.initials).eq('id', emp.status.id);

// 2. Regenerate PDF (Call Edge Function)
// NOTE: In production, call your 'regenerate-handbook-pdf' function here with manager_sig
completed++;
document.getElementById('approvalProgress').textContent = `${completed} / ${employeesToApprove.length}`;
} catch (error) { console.error(`Error approving ${emp.initials}:`, error); }
}
document.body.removeChild(progressDiv);
alert(`‚úÖ Successfully approved ${completed} employees!`);
await loadEmployees();
});

// ============================================
// HR APPROVE ALL
// ============================================
document.getElementById('btnHRApproveAll').addEventListener('click', async () => {
if (!managerSignatureData) { alert('‚ö†Ô∏è Please save your signature first!'); return; }
const employeesToApprove = submittedEmployees.filter(e => e.status?.manager_approved && !e.status?.hr_approved);
if (employeesToApprove.length === 0) { alert('‚úÖ All manager-approved employees have HR approval!'); return; }
if (!confirm(`Add HR approval for ${employeesToApprove.length} employees?`)) return;

const progressDiv = document.createElement('div');
progressDiv.className = 'fixed top-4 right-4 bg-purple-600 text-white px-6 py-4 rounded-lg shadow-xl z-50';
progressDiv.innerHTML = `<div class="font-bold mb-2">üìù Processing HR Approvals...</div><div id="hrApprovalProgress" class="text-sm">0 / ${employeesToApprove.length}</div>`;
document.body.appendChild(progressDiv);

let completed = 0;
for (const emp of employeesToApprove) {
try {
// 1. Update Status
await client.from('hb_acknowledgment_status').update({
hr_approved: true,
hr_approved_by: currentManager.username,
hr_approved_at: new Date().toISOString()
}).eq('employee_initials', emp.initials).eq('id', emp.status.id);

// 2. Regenerate PDF (Call Edge Function with HR Sig)
completed++;
document.getElementById('hrApprovalProgress').textContent = `${completed} / ${employeesToApprove.length}`;
} catch (error) { console.error(`Error HR approving ${emp.initials}:`, error); }
}
document.body.removeChild(progressDiv);
alert(`‚úÖ Successfully HR approved ${completed} employees!`);
await loadEmployees();
});

// ============================================
// SINGLE ACTIONS
// ============================================
window.approveSingleEmployee = async function(initials, name) {
if (!managerSignatureData) { alert('‚ö†Ô∏è Save signature first!'); return; }
if (!confirm(`Approve ${name}?`)) return;
const emp = submittedEmployees.find(e => e.initials === initials);
await client.from('hb_acknowledgment_status').update({
manager_approved: true, manager_approved_by: currentManager.username, manager_approved_at: new Date().toISOString()
}).eq('employee_initials', initials).eq('id', emp.status.id);
alert(`‚úÖ ${name} approved!`);
await loadEmployees();
};

window.hrApproveSingle = async function(initials, name) {
if (!managerSignatureData) { alert('‚ö†Ô∏è Save signature first!'); return; }
if (!confirm(`HR Approve ${name}?`)) return;
const emp = submittedEmployees.find(e => e.initials === initials);
await client.from('hb_acknowledgment_status').update({
hr_approved: true, hr_approved_by: currentManager.username, hr_approved_at: new Date().toISOString()
}).eq('employee_initials', initials).eq('id', emp.status.id);
alert(`‚úÖ ${name} HR Approved!`);
await loadEmployees();
};

window.printSinglePDF = async function(initials) {
const emp = submittedEmployees.find(e => e.initials === initials);
if (!emp || !emp.status.final_pdf_url) { alert('PDF not found'); return; }
window.open(emp.status.final_pdf_url, '_blank');
};

// ============================================
// TABS & SIGN OUT
// ============================================
document.getElementById('tabPending').addEventListener('click', () => {
document.getElementById('pendingContent').classList.remove('hidden');
document.getElementById('submittedContent').classList.add('hidden');
document.getElementById('tabPending').classList.add('border-blue-600', 'text-blue-600');
document.getElementById('tabSubmitted').classList.remove('border-blue-600', 'text-blue-600');
});
document.getElementById('tabSubmitted').addEventListener('click', () => {
document.getElementById('submittedContent').classList.remove('hidden');
document.getElementById('pendingContent').classList.add('hidden');
document.getElementById('tabSubmitted').classList.add('border-blue-600', 'text-blue-600');
document.getElementById('tabPending').classList.remove('border-blue-600', 'text-blue-600');
});
document.getElementById('btnSignOut').addEventListener('click', () => {
currentManager = null;
managerSignatureData = null;
document.getElementById('dashboardView').classList.add('hidden');
document.getElementById('loginView').classList.remove('hidden');
});
</script>
</body>
</html>
