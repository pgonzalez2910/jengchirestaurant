<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JENG CHI — Inventory Orders</title>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{
      --ink:#0f172a; --muted:#64748b; --line:#e6e8ee;
      --navy-1:#0b1b39; --navy-2:#12254d; --navy-3:#0b1b39;
    }
    body{ font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f6f7fb; color:var(--ink); }
    .tab{ padding:.7rem 1rem; font-weight:800; border-bottom:2px solid transparent; }
    .tab.active{ border-bottom-color:#0f172a; color:#0f172a; }

    /*— EXECUTIVE CARD (RONY) —*/
    .cardx{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px; }
    .cardx .title{ font-weight:900; font-size:1.05rem; letter-spacing:.2px; }
    .cardx .meta{ display:flex; flex-wrap:wrap; gap:.5rem; margin-top:.25rem; color:#334155; }
    .cardx .poster{ height:100px; border:1px solid var(--line); border-radius:8px; background:linear-gradient(180deg,#f9fafb,#f1f5f9);
              display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .cardx .poster img{ height:100%; width:auto; object-fit:contain; }
    .cardx .kpi{ display:grid; grid-template-columns:repeat(2,minmax(0,1fr)); gap:12px; }
    .cardx .kbox{ border:1px solid var(--line); border-radius:10px; padding:10px 12px; background:#fff; }
    .cardx .kbox .klabel{ font-size:.66rem; font-weight:800; color:var(--muted); letter-spacing:.18px; text-transform:uppercase; }
    .cardx .kbox .kval{ font-size:2rem; line-height:2.1rem; font-weight:900; margin-top:.1rem; }
    .cardx .label{ display:block; font-size:.78rem; font-weight:800; margin-bottom:.28rem; color:#0f172a; }
    .cardx .field{ border:1px solid var(--line); border-radius:10px; padding:.58rem .65rem; background:#fff; }
    .cardx .field:focus{ outline:none; box-shadow:0 0 0 3px rgba(2,6,23,.12); border-color:#0f172a; }
    .cardx .actions{ display:grid; grid-template-columns:1fr 120px; gap:.75rem; align-items:end; }
    .cardx .reco{ display:flex; align-items:center; justify-content:center; gap:.45rem; padding:.6rem .92rem;
              border-radius:999px; color:#fff; font-weight:900; white-space:nowrap;
              background:
                radial-gradient(120% 120% at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 45%),
                linear-gradient(180deg, var(--navy-1) 0%, var(--navy-2) 55%, var(--navy-3) 100%);
              box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 8px 24px rgba(2,6,23,.22);
              border:1px solid rgba(30,41,59,.45); text-shadow:0 1px 0 rgba(0,0,0,.25); }
    .cardx .dotb{ width:.6rem; height:.6rem; background:#38bdf8; border-radius:999px; box-shadow:0 0 0 2px rgba(255,255,255,.25) inset; }
    .cardx .glossy-black{
      color: white;
      background:
        radial-gradient(120% 120% at 30% 0%, rgba(255,255,255,.2) 0%, rgba(255,255,255,0) 45%),
        linear-gradient(180deg, #1c1c1e 0%, #0a0a0c 55%, #1c1c1e 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 8px 24px rgba(2,6,23,.22);
      border:1px solid rgba(30,41,59,.45);
    }
    .cardx .glossy-green{
      color: white;
      text-shadow: 0 1px 0 rgba(0,0,0,.25);
      background:
          radial-gradient(120% 120% at 30% 0%, rgba(255,255,255,.35) 0%, rgba(255,255,255,0) 45%),
          linear-gradient(180deg, #0f6c44 0%, #177c4d 55%, #0f6c44 100%);
      box-shadow: inset 0 1px 0 rgba(255,255,255,.25), 0 8px 24px rgba(2,6,23,.22);
      border:1px solid rgba(30,41,59,.45);
    }
    .cardx .glossy-white-text{
      color: white !important;
      text-shadow: 0 0 10px rgba(255, 255, 255, 0.5), 0 0 20px rgba(255, 255, 255, 0.3);
    }

    /* Category headers / grid (category shown only as header, not inside the card) */
    .cat-section{ margin-bottom:18px; }
    .cat-header{ display:flex; align-items:center; justify-content:space-between; border-bottom:1px solid var(--line); margin:.25rem 0 .6rem; padding-bottom:.25rem; }
    .cat-title{ font-weight:900; font-size:.98rem; letter-spacing:.2px; color:#0f172a; }
    .cat-grid{ display:grid; grid-template-columns:1fr; gap:12px; }
    @media (min-width:1000px){ .cat-grid{ grid-template-columns:1fr 1fr; } }

    /* Generic UI */
    .card{ background:#fff; border:1px solid var(--line); border-radius:12px; padding:14px 16px; }
    .btn{ border-radius:10px; padding:.7rem 1rem; font-weight:900; }
    .btn-dark{ background:#0f172a; color:#fff; }
    .btn-light{ background:#fff; border:1px solid var(--line); }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .rj-sep{ height:2px; background:linear-gradient(90deg,transparent,#11182726,transparent); border-radius:999px; margin:18px 0 14px; }
    .section-title{ display:none; }
    .hidden{ display:none; }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto py-8 px-4">
    <header class="text-center mb-6">
      <img id="logoTop" class="mx-auto h-16 mb-2" alt="Jeng Chi Logo">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">JENG CHI RESTAURANT</h1>
      <p class="text-sm text-gray-500">Inventory Orders</p>
    </header>

    <div class="flex items-center gap-6 border-b mb-6">
      <button class="tab active" data-tab="panel-order">Create Order</button>
      <button class="tab" data-tab="panel-edit">Edit Order</button>
      <button class="tab" data-tab="panel-report">Reports</button>
    </div>

    <!-- CREATE ORDER -->
    <section id="panel-order">
      <div class="card mb-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="label">Order date</label>
            <input id="orderDate" type="date" class="field w-full"/>
          </div>
          <div>
            <label class="label">Filter by vendor (optional)</label>
            <select id="vendorFilter" class="field w-full">
              <option value="">— All —</option>
            </select>
          </div>
        </div>
      </div>

      <h3 class="section-title">Rony — Order</h3>
      <div id="gridRony" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <div id="rjSep" class="rj-sep" aria-hidden="true"></div>

      <h3 class="section-title">Julio — Order</h3>
      <div id="gridJulio" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <div class="mt-6 flex items-center justify-between card">
        <p class="text-sm text-gray-600">Review vendors and click submit. In Julio, “Order” equals “On Hand”.</p>
        <button id="btnSubmit" class="btn btn-dark">Submit Order</button>
      </div>
    </section>

    <!-- EDIT ORDER -->
    <section id="panel-edit" class="hidden">
      <div class="card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="label">Order date</label>
            <input id="editDate" type="date" class="field w-full"/>
          </div>
          <div>
            <label class="label">Filter by vendor (optional)</label>
            <select id="editVendor" class="field w-full">
              <option value="">— All —</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnLoadEdit" class="btn btn-light w-full">Load</button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto card">
        <table class="min-w-full text-sm">
          <thead class="border-b bg-gray-50">
            <tr>
              <th class="text-left py-2 px-3">Product</th>
              <th class="text-left py-2 px-3">On Hand</th>
              <th class="text-left py-2 px-3">Order Qty</th>
              <th class="text-left py-2 px-3">Vendor</th>
              <th class="text-left py-2 px-3">User</th>
              <th class="text-left py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="editRows"></tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="btnSaveEdits" class="btn btn-dark">Save Changes</button>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="panel-report" class="hidden">
      <div class="card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="label">Order date</label>
            <input id="reportDate" type="date" class="field w-full"/>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnReportPreview" class="btn btn-light w-full">Preview / Edit Vendors</button>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnReport" class="btn btn-dark w-full">Generate PDFs (one per vendor)</button>
          </div>
        </div>
      </div>
      <p class="text-sm text-gray-600 mb-3">Preview shows only items actually ordered (Qty &gt; 0). Edit vendors inline and save before generating PDFs.</p>

      <div class="overflow-x-auto card mb-3">
        <table class="min-w-full text-sm">
          <thead class="border-b bg-gray-50">
            <tr>
              <th class="text-left py-2 px-3">Product</th>
              <th class="text-left py-2 px-3">Qty</th>
              <th class="text-left py-2 px-3">Vendor</th>
              <th class="text-left py-2 px-3">User</th>
            </tr>
          </thead>
          <tbody id="reportRows"></tbody>
        </table>
      </div>
      <div class="mt-2 flex gap-3">
        <button id="btnSaveReportVendor" class="btn btn-dark">Save Vendor Changes</button>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white rounded-xl p-6 w-[92%] max-w-md">
      <h3 id="mTitle" class="text-lg font-extrabold mb-2"></h3>
      <p id="mMsg" class="text-sm text-gray-700 mb-4"></p>
      <div class="text-right">
        <button id="mOk" class="btn btn-dark">OK</button>
      </div>
    </div>
  </div>

<script>
/* ===== BASIC CONFIG ===== */
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const COMPANY_LOGO = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
document.getElementById("logoTop").src = COMPANY_LOGO;

/* Logos for PDFs */
const vendorLogos = {
  "Formosa Foods":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg",
  "North Food Group":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg",
  "Pacific Plus":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg",
  "Delta Office Products":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg",
  "Supermarket":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg"
};
const logoData = {};

/* ===== Helper + aliases ===== */
const VENDOR_ALIASES = {
  'delta office product':'Delta Office Products','delta office products':'Delta Office Products',
  'pacific':'Pacific Plus','pacific plus':'Pacific Plus','formosa foods':'Formosa Foods',
  'north food group':'North Food Group','supermarket':'Supermarket'
};
const canon = v => VENDOR_ALIASES[(v||'').trim().toLowerCase()] || (v||'').trim();
const ALLOWED_VENDORS = ["Supermarket","Pacific Plus","Formosa Foods","North Food Group","Delta Office Products"];
const $ = s => document.querySelector(s);
const norm = s => (s||"").trim();
function todayYMD(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function formatPDFDate(dateISO){ if(!dateISO) return ""; const parts=dateISO.split('-'); return `${parts[1]}-${parts[2]}-${parts[0]}`; }
function showModal(t,m){ $("#mTitle").textContent=t; $("#mMsg").textContent=m; $("#modal").classList.remove("hidden"); $("#modal").classList.add("flex"); }
$("#mOk").onclick=()=>{ $("#modal").classList.add("hidden"); $("#modal").classList.remove("flex"); };

const SUBMIT_KEY="jengchi_submit_lock";
function cooldownMs(){ const v=localStorage.getItem(SUBMIT_KEY); if(!v) return 0; const el=Date.now()-Number(v); return Math.max(0, 5*60*1000 - el); }
function applyCooldown(){ $("#btnSubmit").disabled = cooldownMs()>0; }
async function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }
async function toDataUrl(url){ try{ const res=await fetch(url); const blob=await res.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onloadend=()=>r({data:fr.result, fmt: (blob.type.includes('png')?'PNG':'JPEG')}); fr.readAsDataURL(blob); }); }catch{ return {data:null, fmt:'JPEG'}; }}

/* ===== Enrichment flags ===== */
const enrich = { has:false, item_code:false, image_url:false, par:false, avg:false, conv:false, vendor:false, vendors:false, category:false };
let convColumn = null;
async function detectEnrichment(){
  try{
    let { error } = await supabase.from("inventory_management").select("product_name").limit(1);
    if(error){ enrich.has=false; return; }
    enrich.has=true;
    const probe = async (col)=> (await supabase.from("inventory_management").select(col).limit(1)).error ? false : true;
    enrich.item_code = await probe("item_code");
    enrich.image_url = await probe("image_url");
    enrich.par       = await probe("par");
    enrich.avg       = await probe("avg_daily_usage");
    enrich.vendor    = await probe("vendor");
    enrich.vendors   = await probe("vendors");
    enrich.category  = await probe("category");
    const convCandidates=["conversion_factor","case_size","units_per_case","uom_per_case","pack_size"];
    for(const c of convCandidates){ const ok=await probe(c); if(ok){ convColumn=c; enrich.conv=true; break; } }
  }catch{ enrich.has=false; }
}

/* Filters */
async function loadVendorsForFilters(){
  const opts = ['<option value="">— All —</option>'].concat(ALLOWED_VENDORS.map(v=>`<option>${v}</option>`)).join("");
  $("#vendorFilter").innerHTML = opts; $("#editVendor").innerHTML = opts;
}

/* PRODUCT × VENDOR → ITEM CODE from `vendors` column */
let PRODUCT_VENDOR_CODES = new Map();
async function buildVendorCodeMap(){
  PRODUCT_VENDOR_CODES = new Map();
  if(!enrich.has) return;
  const { data, error } = await supabase.from("inventory_management").select("product_name,vendors,item_code");
  if(error || !Array.isArray(data)) return;
  data.forEach(r=>{
    const pn=norm(r.product_name); if(!pn) return;
    if(!PRODUCT_VENDOR_CODES.has(pn)) PRODUCT_VENDOR_CODES.set(pn,{});
    const map=PRODUCT_VENDOR_CODES.get(pn);
    const vendors=(r.vendors||"").split(",").map(v=>canon(v)).filter(Boolean);
    if(vendors.length){ vendors.forEach(v=>{ map[v]=(r.item_code||"").trim(); }); }
  });
}
function vendorsForProduct(productName,currentVendor){
  const list=[...ALLOWED_VENDORS]; const cur=canon(currentVendor);
  if(cur && !list.includes(cur)) list.unshift(cur);
  return [...new Set(list)];
}
function codeFor(productName,vendor){
  const pn=norm(productName), v=canon(vendor); const map=PRODUCT_VENDOR_CODES.get(pn)||{};
  const code=map[v]; return (code && code!=="") ? code : "-------";
}

/* Utils */
const fmt2 = v => { const n=Number(v); return Number.isFinite(n) ? n.toFixed(2) : ''; };
const isRony = u => (u||'').toLowerCase()==='rony';
function vendorSelectHtml(current,options){
  const displayCurrent=current?canon(current):'';
  const set=new Set([displayCurrent, ...options.map(canon)].filter(Boolean));
  const opts=['<option value="">— pick —</option>'].concat([...set].map(v=>`<option value="${v}" ${v===displayCurrent?'selected':''}>${v}</option>`)).join('');
  return `<select class="field w-full vendor-select">${opts}</select>`;
}
function vendorSelectCellHtml(current,options){
  const displayCurrent=current?canon(current):'';
  const set=new Set([displayCurrent, ...options.map(canon)].filter(Boolean));
  const opts=['<option value="">— pick —</option>'].concat([...set].map(v=>`<option value="${v}" ${v===displayCurrent?'selected':''}>${v}</option>`)).join('');
  return `<select class="field w-full edit-vendor">${opts}</select>`;
}

/* ===== EXECUTIVE CARD BUILDER (RONY) ===== */
function buildExecutiveRonyCard(row, vendorOptions){
  const wrap=document.createElement('div'); wrap.className="cardx"; wrap.dataset.product=row.product_name;
  const img=row.image_url?`<img src="${row.image_url}" alt="product">`:`<div class="text-xs text-gray-400">No Image</div>`;
  const onHandDisplay = fmt2(row.on_hand||0);
  const rec = recommendedCases(row.par, row.on_hand, row.conv);
  const initialCode = codeFor(row.product_name, row.vendor || '');

  let recommendedPill = '';
  if (rec !== null && rec > 1) {
      recommendedPill = `<div class="reco glossy-green"><span class="dotb"></span> Recommended: ${rec} cases</div>`;
  }

  wrap.innerHTML = `
    <div class="flex gap-4">
      <div class="poster">${img}</div>
      <div class="flex-1">
        <div class="title">${row.product_name}</div>
        <div class="meta">
          <div class="chip glossy-black"><span class="font-bold glossy-white-text">Item&nbsp;Code:</span> <code class="item-code glossy-white-text font-bold">${initialCode}</code></div>
        </div>
        <div class="mt-3 grid grid-cols-2 gap-3">
          <div class="kbox glossy-black"><div class="klabel font-bold glossy-white-text">On Hand</div><div class="kval font-bold glossy-white-text">${onHandDisplay}</div></div>
          <div class="kbox glossy-black"><div class="klabel font-bold glossy-white-text">Par</div><div class="kval font-bold glossy-white-text">${row.par!=null ? Number(row.par) : '-'}</div></div>
        </div>
      </div>
    </div>
    <div class="mt-4 grid grid-cols-1 md:grid-cols-2 gap-4">
      <div>
        <label class="label">Vendor</label>
        ${vendorSelectHtml(row.vendor||'', vendorOptions)}
      </div>
      <div>
        <label class="label">Order</label>
        <input type="number" step="0.01" min="0" class="field w-full order-input" />
      </div>
    </div>
    <div class="mt-4">
      ${recommendedPill}
    </div>
  `;
  const sel = wrap.querySelector(".vendor-select");
  const codeSpan = wrap.querySelector(".item-code");
  if(sel){
    const update = () => { codeSpan.textContent = codeFor(row.product_name, sel.value); };
    sel.addEventListener("change", update);
    update();
  }
  return wrap;
}

/* ===== Classic card for JULIO (unchanged) ===== */
function buildCardClassic(row, vendorOptions, readOnly){
  const wrap=document.createElement('div'); wrap.className="card"; wrap.dataset.product=row.product_name;
  const img=row.image_url?`<img src="${row.image_url}" alt="product">`:`<div class="text-xs text-gray-400">No Image</div>`;
  const readonlyQty=Number(row.on_hand||0);
  const orderValue=readOnly?(readonlyQty===0?'':readonlyQty):'';
  const onHandDisplay=isRony(row.user)?fmt2(row.on_hand||0):Number(row.on_hand||0);
  wrap.innerHTML=`
    <div class="grid grid-cols-[110px_1fr] gap-4 items-center">
      <div class="poster" style="height:100px">${img}</div>
      <div>
        <div class="font-extrabold mb-1">${row.product_name}</div>
        <div class="text-xs text-gray-500 -mt-1">Item Code: <span class="font-semibold item-code">-------</span></div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div><label class="label">Vendor</label>${vendorSelectHtml(row.vendor||'', vendorOptions)}</div>
          <div><label class="label">Order</label><input type="number" step="0.01" min="0" value="${orderValue}" class="field w-full order-input" ${readOnly?'readonly':''}/></div>
        </div>
        <div class="mt-2 text-sm text-gray-700">On Hand: <b>${onHandDisplay}</b>${row.par!=null?` · Par: <b>${Number(row.par)}</b>`:''}</div>
      </div>
    </div>`;
  const sel=wrap.querySelector(".vendor-select"); const codeSpan=wrap.querySelector(".item-code");
  if(sel){ const update=()=>codeSpan.textContent=codeFor(row.product_name, sel.value); sel.addEventListener("change", update); update(); }
  return wrap;
}

/* ===== Logic ===== */
function recommendedCases(parUnits, onHand, conv){
  if(parUnits==null) return null;
  const unitsNeeded=Math.max(0, Number(parUnits)-Number(onHand||0));
  const perCase=Math.max(1, Number(conv||1));
  return Math.ceil(unitsNeeded / perCase);
}

/* Rony grouped by category (category shown only as header) */
function renderRonyCategorized(container, rows){
  container.innerHTML='';
  const groups=new Map();
  for(const r of rows){
    const key=(r.category && r.category.trim())?r.category.trim():'Uncategorized';
    if(!groups.has(key)) groups.set(key,[]);
    groups.get(key).push(r);
  }
  const cats=[...groups.keys()].sort((a,b)=>a.localeCompare(b));
  if(!cats.length){ container.innerHTML='<p class="text-gray-500">No Rony products to show.</p>'; return; }
  for(const cat of cats){
    const section=document.createElement('div'); section.className='cat-section';
    section.innerHTML=`<div class="cat-header"><div class="cat-title">${cat}</div></div><div class="cat-grid"></div>`;
    const grid=section.querySelector('.cat-grid');
    const items=groups.get(cat).sort((a,b)=> a.product_name.localeCompare(b.product_name));
    for(const r of items){
      const opts=vendorsForProduct(r.product_name, r.vendor);
      grid.appendChild(buildExecutiveRonyCard(r, opts));
    }
    container.appendChild(section);
  }
}
function renderJulioClassic(container, rows) {
  container.innerHTML = '';
  if (!rows.length) { container.innerHTML = '<p class="text-gray-500">No Julio products to show.</p>'; return; }
  rows.forEach(r => { const opts = vendorsForProduct(r.product_name, r.vendor); container.appendChild(buildCardClassic(r, opts, true)); });
}

/* Load Create tab */
async function loadCreate(dateISO){
  await loadVendorsForFilters();
  await buildVendorCodeMap();

  let cols="product_name,on_hand,tentative,user,vendor";
  const { data: base, error } = await supabase.from("inventory_check").select(cols).eq("order_date", dateISO).order("user",{ascending:true}).order("product_name",{ascending:true});

  const rGrid=$("#gridRony"), jGrid=$("#gridJulio"); rGrid.innerHTML=""; jGrid.innerHTML="";
  if(error){ showModal("Error","Error loading data from Supabase."); return; }
  if(!base?.length){ rGrid.innerHTML='<p class="text-gray-500">No items to show.</p>'; jGrid.innerHTML=''; return; }

  let extraMap=new Map();
  if(enrich.has){
    let sel="product_name";
    if(enrich.item_code) sel+=",item_code";
    if(enrich.image_url) sel+=",image_url";
    if(enrich.par) sel+=",par";
    if(enrich.avg) sel+=",avg_daily_usage";
    if(enrich.category) sel+=",category";
    if(enrich.conv && convColumn) sel+=","+convColumn;
    const { data: info } = await supabase.from("inventory_management").select(sel);
    (info||[]).forEach(r=> extraMap.set(norm(r.product_name), r));
  }

  const rows=base.map(r=>{
    const ex=extraMap.get(norm(r.product_name))||{};
    return { ...r, item_code:ex.item_code, image_url:ex.image_url, par:(ex.par!=null?Number(ex.par):null), category:ex.category||null, avg_day:(ex.avg_daily_usage!=null?Math.round(Number(ex.avg_daily_usage)||0):null), conv:(convColumn && ex[convColumn]!=null?Math.max(1,Number(ex[convColumn])||1):1) };
  });

  const rony=rows.filter(x=>(x.user||'').toLowerCase()==='rony');
  const julio=rows.filter(x=>(x.user||'').toLowerCase()==='julio');

  const vf=$("#vendorFilter").value;
  let ronyFiltered=rony, julioFiltered=julio;
  if(vf){ ronyFiltered=rony.filter(r=>canon(r.vendor)===canon(vf)); julioFiltered=julio.filter(r=>canon(r.vendor)===canon(vf)); }

  renderRonyCategorized(rGrid, ronyFiltered);
  renderJulioClassic(jGrid, julioFiltered);

  const sep=document.getElementById('rjSep');
  if(sep) sep.classList.toggle('hidden', !(ronyFiltered.length && julioFiltered.length));
}

/* Save/Submit */
async function persistCreateEdits(){
  const dateISO=$("#orderDate").value || todayYMD();
  async function walk(container, user){
    for(const card of container.querySelectorAll("[data-product]")){
      const product=card.dataset.product;
      const vendorSel=card.querySelector(".vendor-select");
      const qtyInp=card.querySelector(".order-input");
      const patch={};
      if(vendorSel) patch.vendor = vendorSel.value || null;
      if(qtyInp && !qtyInp.readOnly){ const raw=qtyInp.value; patch.tentative=(raw===''||raw==null)?0:Number(raw); }
      if(Object.keys(patch).length){
        await supabase.from("inventory_check").update(patch).eq("order_date", dateISO).eq("product_name", product).eq("user", user);
      }
    }
  }
  await walk($("#gridRony"), "Rony");
  await walk($("#gridJulio"), "Julio");
}
async function submitOrder(){
  if(cooldownMs()>0){ showModal("Pedido ya enviado","Por favor espere 5 minutos antes de volver a intentarlo."); return; }
  await persistCreateEdits();
  localStorage.setItem(SUBMIT_KEY, String(Date.now()));
  applyCooldown();
  showModal("Order sent","Your order has been confirmed. We avoid duplicate emails for 5 minutes.");
}

/* Edit / Reports (unchanged) */
function computeQty(row){ return (row.user && row.user.toLowerCase()==='julio') ? Number(row.on_hand||0) : Number(row.tentative||0); }
async function renderEdit(dateISO, vendor){
  const tbody=$("#editRows"); tbody.innerHTML="";
  let { data, error } = await supabase.from("inventory_check").select('*').eq("order_date", dateISO);
  if(error){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-red-600">Error loading.</td></tr>`; return; }
  if(!data?.length){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-gray-500">No rows.</td></tr>`; return; }
  const shown=data.map(r=>({...r,__qty:computeQty(r)})).filter(r=>r.__qty>0);
  if(!shown.length){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-gray-500">No items with Qty &gt; 0.</td></tr>`; return; }
  
  // Fetch enrichment data for vendor options
  const { data: enrichmentData } = await supabase.from("inventory_management").select("product_name,vendors");
  const enrichmentMap = new Map();
  (enrichmentData || []).forEach(r => enrichmentMap.set(norm(r.product_name), r));
  
  shown.forEach(r=>{
    const tr=document.createElement('tr'); tr.className="border-b";
    const onHandCell=isRony(r.user)?fmt2(r.on_hand||0):Number(r.on_hand||0);
    const productInfo = enrichmentMap.get(norm(r.product_name));
    const vendorOptions = vendorsForProduct(r.product_name, productInfo?.vendors);
    const vendorSelect=vendorSelectCellHtml(r.vendor||"", vendorOptions);
    tr.innerHTML=`
      <td class="py-2 px-3">${r.product_name}</td>
      <td class="py-2 px-3">${onHandCell}</td>
      <td class="py-2 px-3"><input type="number" step="0.01" min="0" value="${r.__qty}" class="field w-28 edit-qty"></td>
      <td class="py-2 px-3">${vendorSelect}</td>
      <td class="py-2 px-3">${r.user||''}</td>
      <td class="py-2 px-3"><button class="btn btn-light">Delete</button></td>`;
    tr.querySelector("button").onclick=async()=>{
      await supabase.from("inventory_check").delete().eq("order_date", dateISO).eq("product_name", r.product_name).eq("user", r.user);
      tr.remove();
    };
    tbody.appendChild(tr);
  });
}
async function saveEdits(){
  const dateISO=$("#editDate").value || todayYMD();
  for(const tr of document.querySelectorAll("#editRows tr")){
    const product=tr.children[0].textContent;
    const onUser=tr.children[4].textContent;
    const raw=tr.querySelector(".edit-qty").value;
    const qty=(raw===''||raw==null)?0:Number(raw);
    const vendorSel=tr.querySelector(".edit-vendor");
    const vendor=vendorSel?vendorSel.value||null:null;
    await supabase.from("inventory_check").update({ tentative:qty, vendor }).eq("order_date", dateISO).eq("product_name", product).eq("user", onUser);
  }
  showModal("Saved","Changes updated.");
}

/* Reports (preview saving) */
async function loadReportRows(){
  const dateISO=$("#reportDate").value || todayYMD();
  let { data:rows, error } = await supabase.from("inventory_check").select("product_name,on_hand,tentative,user,vendor").eq("order_date", dateISO);
  const tbody=$("#reportRows"); tbody.innerHTML="";
  if(error){ tbody.innerHTML=`<tr><td colspan="4" class="py-3 text-red-600">Error loading.</td></tr>`; return; }
  if(!rows?.length){ tbody.innerHTML=`<tr><td colspan="4" class="py-3 text-gray-500">No rows for that date.</td></tr>`; return; }
  
  // Fetch enrichment data for vendor options
  const { data: enrichmentData } = await supabase.from("inventory_management").select("product_name,vendors");
  const enrichmentMap = new Map();
  (enrichmentData || []).forEach(r => enrichmentMap.set(norm(r.product_name), r));

  const filtered=rows.map(r=>({...r, qty:computeQty(r)})).filter(r=>r.qty>0);
  if(!filtered.length){ tbody.innerHTML=`<tr><td colspan="4" class="py-3 text-gray-500">No ordered items (Qty &gt; 0).</td></tr>`; return; }
  
  filtered.forEach(r=>{
    const tr=document.createElement('tr'); tr.className="border-b";
    const productInfo = enrichmentMap.get(norm(r.product_name));
    const opts=vendorsForProduct(r.product_name, productInfo?.vendors);
    tr.dataset.product=r.product_name; tr.dataset.user=r.user||'';
    tr.innerHTML=`<td class="py-2 px-3">${r.product_name}</td>
                  <td class="py-2 px-3">${r.qty}</td>
                  <td class="py-2 px-3">${vendorSelectCellHtml(r.vendor||'', opts)}</td>
                  <td class="py-2 px-3">${r.user||''}</td>`;
    tbody.appendChild(tr);
  });
}
async function saveReportVendorChanges(){
  const dateISO=$("#reportDate").value || todayYMD();
  const rows=document.querySelectorAll("#reportRows tr");
  if(!rows.length){ showModal("Nothing to save","Load the preview first."); return; }
  for(const tr of rows){
    const product=tr.dataset.product; const onUser=tr.dataset.user;
    const vendorSel=tr.querySelector(".edit-vendor"); const vendor=vendorSel?vendorSel.value||null:null;
    await supabase.from("inventory_check").update({ vendor }).eq("order_date", dateISO).eq("product_name", product).eq("user", onUser);
  }
  showModal("Saved","Vendor changes updated for ordered items.");
}

/* ===== PDFs (Executive, medium photos, no URL text) ===== */
async function generatePDFs(){
  const dateISO = $("#reportDate").value || todayYMD();
  const { jsPDF } = window.jspdf;

  // sizing
  const IMG_COL_WIDTH    = 110;    // image column width (pt)
  const ROW_MIN_HEIGHT   = 100;    // row height (pt)
  const IMG_TARGET       = 84;     // image size (pt)
  const CELL_PADDING     = 10;

  // rows for date
  const { data: rows } = await supabase
    .from("inventory_check")
    .select("product_name,on_hand,tentative,user,vendor")
    .eq("order_date", dateISO);
  if (!rows?.length) { showModal("No data","No rows for that date."); return; }

  // logos
  logoData.company = await toDataUrl(COMPANY_LOGO);
  for (const [k,u] of Object.entries(vendorLogos)) logoData[k] = await toDataUrl(u);

  // only image URLs from inventory_management (item code is vendor-mapped)
  const infoMap = new Map();
  if (enrich.has) {
    const { data: info } = await supabase.from("inventory_management").select("product_name,image_url");
    (info||[]).forEach(r => infoMap.set(norm(r.product_name), r));
  }

  // group by vendor
  const byVendor = {};
  rows.forEach(r => {
    const qty = (r.user && r.user.toLowerCase()==='julio') ? Number(r.on_hand||0) : Number(r.tentative||0);
    if (qty <= 0) return;
    const v = r.vendor ? canon(r.vendor) : "Unknown Vendor";
    if (!byVendor[v]) byVendor[v] = [];
    const ex = infoMap.get(norm(r.product_name)) || {};
    byVendor[v].push({
      ...r,
      item_code: (typeof codeFor === "function" ? codeFor(r.product_name, v) : "-------"),
      image_url: ex.image_url || null,
      qty
    });
  });

  const vendors = Object.keys(byVendor);
  if (!vendors.length) { showModal("Nothing to print","No ordered items (Qty > 0)."); return; }

  for (const vendor of vendors) {
    const list = byVendor[vendor];
    const doc = new jsPDF({ unit:'pt', format:'letter' });
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const M = 42;

    // header
    let y = M;
    if (logoData.company?.data) doc.addImage(logoData.company.data, logoData.company.fmt, M, y, 72, 54);
    const vlogo = logoData[vendor];
    if (vlogo?.data) doc.addImage(vlogo.data, vlogo.fmt, pageW - M - 72, y + 6, 72, 42);
    doc.setFont('helvetica','bold'); doc.setFontSize(20);
    doc.text("Inventory Order", pageW/2, y + 18, {align:'center'});
    doc.setFont('helvetica','normal'); doc.setFontSize(11);
    doc.text(`Order date: ${formatPDFDate(dateISO)}`, pageW/2, y + 36, {align:'center'});
    y += 64;

    // cache product images
    const imgCache = {};
    const uniqueUrls = [...new Set(list.map(r => r.image_url).filter(Boolean))];
    for (const u of uniqueUrls) imgCache[u] = await toDataUrl(u);

    // table body
    const columns = [
      { header: "Image",      dataKey: "img"     },
      { header: "Item Code", dataKey: "code"    },
      { header: "Product",    dataKey: "product" },
      { header: "Qty",      dataKey: "qty"     }
    ];
    const body = list.map(r => ({
      img:      r.image_url ? { url: r.image_url } : null,
      code:     r.item_code || "-------",
      product: r.product_name,
      qty:      String(r.qty)
    }));

    const ink=[17,24,39], line=[226,232,240], zebra=[247,249,252];

    doc.autoTable({
      startY: y,
      margin: { left: M, right: M },
      theme: 'grid',
      rowPageBreak: 'auto',
      styles: {
        font: 'helvetica',
        fontSize: 10,
        cellPadding: { top: 6, right: 6, bottom: 6, left: 6 },
        lineColor: line, lineWidth: 0.25,
        minCellHeight: ROW_MIN_HEIGHT,
        overflow: 'linebreak'
      },
      headStyles: { fillColor: ink, textColor: [255,255,255], fontStyle:'bold' },
      alternateRowStyles: { fillColor: zebra },
      columnStyles: {
        img:     { cellWidth: IMG_COL_WIDTH, halign:'center' },
        code:    { cellWidth: 120, font: 'courier' },
        product: { cellWidth: 'auto' },
        qty:     { cellWidth: 52, halign:'right' }
      },
      columns,
      body,
      didParseCell: (data) => {
        if (data.section === 'body' && data.column.dataKey === 'img') {
          data.cell.text = ''; // prevent URL text from printing under image
        }
      },
      didDrawCell: (data) => {
        if (data.section === 'body' && data.column.dataKey === 'img') {
          const payload = data.row.raw.img;
          const url = payload && payload.url ? payload.url : null;
          const cached = url ? imgCache[url] : null;
          if (cached?.data) {
            const maxW = Math.max(20, data.cell.width  - CELL_PADDING);
            const maxH = Math.max(20, data.cell.height - CELL_PADDING);
            const size = Math.min(IMG_TARGET, maxW, maxH); // medium & contained
            const x = data.cell.x + (data.cell.width  - size)/2;
            const yy = data.cell.y + (data.cell.height - size)/2;
            try { doc.addImage(cached.data, cached.fmt, x, yy, size, size); } catch(e){}
          }
        }
      },
      didDrawPage: () => {
        doc.setFontSize(9); doc.setTextColor(99);
        doc.text(`Vendor: ${vendor}`, M, pageH - 14);
        doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW - M, pageH - 14, {align:'right'});
      }
    });

    doc.save(`${vendor.replace(/\s+/g,'_')}_${formatPDFDate(dateISO)}.pdf`);
    await new Promise(r => setTimeout(r, 180));
  }

  showModal("Done","Executive PDFs generated with medium product images (no URL text).");
}

/* ===== Event Listeners ===== */
document.addEventListener("DOMContentLoaded", async () => {
  // Set today's date on both date pickers
  const today = todayYMD();
  $("#orderDate").value = today;
  $("#editDate").value = today;
  $("#reportDate").value = today;
  
  // Tab functionality
  const panels = document.querySelectorAll('section[id^="panel-"]');
  document.querySelectorAll('.tab').forEach(tab => {
    tab.addEventListener('click', () => {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      tab.classList.add('active');
      panels.forEach(panel => panel.classList.add('hidden'));
      $(`#${tab.dataset.tab}`).classList.remove('hidden');
    });
  });

  // Buttons
  $("#btnSubmit").addEventListener('click', submitOrder);
  $("#btnLoadEdit").addEventListener('click', () => renderEdit($("#editDate").value, $("#editVendor").value));
  $("#btnSaveEdits").addEventListener('click', saveEdits);
  $("#btnReportPreview").addEventListener('click', loadReportRows);
  $("#btnSaveReportVendor").addEventListener('click', saveReportVendorChanges);
  $("#btnReport").addEventListener('click', generatePDFs);

  // Initial load data
  await detectEnrichment();
  await loadVendorsForFilters();
  await buildVendorCodeMap();
  await loadCreate(today);
  applyCooldown();
});
</script>
</body>
</html>
