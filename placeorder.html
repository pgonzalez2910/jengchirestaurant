<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>JENG CHI — Inventory Orders</title>

  <!-- Libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{ --ink:#0f172a; --muted:#6b7280; --ring:#111827; }
    body{ font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f6f7fb; color:var(--ink); }
    .tab{ padding:.7rem 1rem; font-weight:800; border-bottom:2px solid transparent; }
    .tab.active{ border-bottom-color:#111827; color:#111827; }
    .card{ background:#fff; border:1px solid #e5e7eb; border-radius:1rem; padding:1rem; box-shadow:0 6px 22px rgba(15,23,42,.06); }
    .badge{ background:#eef2ff; border:1px solid #e5e7eb; border-radius:.5rem; padding:.2rem .55rem; font-weight:700; font-size:.8rem; }
    .field{ border:1px solid #e5e7eb; border-radius:.65rem; padding:.6rem .7rem; }
    .field:focus{ outline:none; box-shadow:0 0 0 3px rgba(17,24,39,.15); border-color:#111827; }
    .btn{ border-radius:.75rem; padding:.7rem 1rem; font-weight:900; }
    .btn-dark{ background:#111827; color:#fff; }
    .btn-light{ background:#fff; border:1px solid #e5e7eb; }
    .btn:disabled{ opacity:.55; cursor:not-allowed; }
    .img-wrap{ width:120px; height:120px; background:#f3f4f6; border-radius:.75rem; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .img-wrap img{ height:100%; width:auto; object-fit:contain; }
    .shine{ background:linear-gradient(90deg,#000 0%,#333 40%,#000 100%); -webkit-background-clip:text; background-clip:text; color:transparent; text-shadow:0 0 0 #000; }
    .section-title{ display:none; }
  </style>
</head>
<body>
  <div class="max-w-6xl mx-auto py-8 px-4">
    <header class="text-center mb-6">
      <img id="logoTop" class="mx-auto h-16 mb-2" alt="Jeng Chi Logo">
      <h1 class="text-4xl md:text-5xl font-extrabold tracking-tight">JENG CHI RESTAURANT</h1>
      <p class="text-sm text-gray-500">Inventory Orders</p>
    </header>

    <div class="flex items-center gap-6 border-b mb-6">
      <button class="tab active" data-tab="panel-order">Create Order</button>
      <button class="tab" data-tab="panel-edit">Edit Order</button>
      <button class="tab" data-tab="panel-report">Reports</button>
    </div>

    <!-- CREATE ORDER -->
    <section id="panel-order">
      <div class="card mb-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Order date</label>
            <input id="orderDate" type="date" class="field w-full"/>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Filter by vendor (optional)</label>
            <select id="vendorFilter" class="field w-full">
              <option value="">— All —</option>
            </select>
          </div>
        </div>
      </div>

      <h3 class="section-title">Rony — Order</h3>
      <div id="gridRony" class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-8"></div>

      <h3 class="section-title">Julio — Order</h3>
      <div id="gridJulio" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>

      <div class="mt-6 flex items-center justify-between card">
        <p class="text-sm text-gray-600">Review vendors and click submit. In Julio, “Order” equals “On Hand”.</p>
        <button id="btnSubmit" class="btn btn-dark">Submit Order</button>
      </div>
    </section>

    <!-- EDIT ORDER -->
    <section id="panel-edit" class="hidden">
      <div class="card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Order date</label>
            <input id="editDate" type="date" class="field w-full"/>
          </div>
          <div>
            <label class="block text-sm font-semibold mb-1">Filter by vendor (optional)</label>
            <select id="editVendor" class="field w-full">
              <option value="">— All —</option>
            </select>
          </div>
          <div class="flex items-end">
            <button id="btnLoadEdit" class="btn btn-light w-full">Load</button>
          </div>
        </div>
      </div>

      <div class="overflow-x-auto card">
        <table class="min-w-full text-sm">
          <thead class="border-b bg-gray-50">
            <tr>
              <th class="text-left py-2 px-3">Product</th>
              <th class="text-left py-2 px-3">On Hand</th>
              <th class="text-left py-2 px-3">Order Qty</th>
              <th class="text-left py-2 px-3">Vendor</th>
              <th class="text-left py-2 px-3">User</th>
              <th class="text-left py-2 px-3">Actions</th>
            </tr>
          </thead>
          <tbody id="editRows"></tbody>
        </table>
      </div>

      <div class="mt-4 flex gap-3">
        <button id="btnSaveEdits" class="btn btn-dark">Save Changes</button>
      </div>
    </section>

    <!-- REPORTS -->
    <section id="panel-report" class="hidden">
      <div class="card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
          <div>
            <label class="block text-sm font-semibold mb-1">Order date</label>
            <input id="reportDate" type="date" class="field w-full"/>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnReportPreview" class="btn btn-light w-full">Preview / Edit Vendors</button>
          </div>
          <div class="flex items-end gap-2">
            <button id="btnReport" class="btn btn-dark w-full">Generate PDFs (one per vendor)</button>
          </div>
        </div>
      </div>
      <p class="text-sm text-gray-600 mb-3">Preview shows only items actually ordered (Qty &gt; 0). Edit vendors inline and save before generating PDFs.</p>

      <div class="overflow-x-auto card mb-3">
        <table class="min-w-full text-sm">
          <thead class="border-b bg-gray-50">
            <tr>
              <th class="text-left py-2 px-3">Product</th>
              <th class="text-left py-2 px-3">Qty</th>
              <th class="text-left py-2 px-3">Vendor</th>
              <th class="text-left py-2 px-3">User</th>
            </tr>
          </thead>
          <tbody id="reportRows"></tbody>
        </table>
      </div>
      <div class="mt-2 flex gap-3">
        <button id="btnSaveReportVendor" class="btn btn-dark">Save Vendor Changes</button>
      </div>
    </section>
  </div>

  <!-- Modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white rounded-xl p-6 w-[92%] max-w-md">
      <h3 id="mTitle" class="text-lg font-extrabold mb-2"></h3>
      <p id="mMsg" class="text-sm text-gray-700 mb-4"></p>
      <div class="text-right">
        <button id="mOk" class="btn btn-dark">OK</button>
      </div>
    </div>
  </div>

<script>
/* ===== CONFIG ===== */
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
const COMPANY_LOGO = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
document.getElementById("logoTop").src = COMPANY_LOGO;

/* Logos used in PDFs */
const vendorLogos = {
  "Formosa Foods":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg",
  "North Food Group":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg",
  "Pacific Plus":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg",
  "Delta Office Products":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg",
  "Supermarket":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg"
};
const logoData = {};

/* ===== Vendor aliases → canonical ===== */
const VENDOR_ALIASES = {
  'delta office product': 'Delta Office Products',
  'delta office products': 'Delta Office Products',
  'pacific': 'Pacific Plus',
  'pacific plus': 'Pacific Plus',
  'formosa foods': 'Formosa Foods',
  'north food group': 'North Food Group',
  'supermarket': 'Supermarket'
};
const canon = v => VENDOR_ALIASES[(v||'').trim().toLowerCase()] || (v||'').trim();

/* Restrict selects to these vendors globally */
const ALLOWED_VENDORS = [
  "Supermarket",
  "Pacific Plus",
  "Formosa Foods",
  "North Food Group",
  "Delta Office Products"
];

/* ===== UTIL ===== */
const $ = s => document.querySelector(s);
const norm = s => (s||"").trim();
function todayYMD(){ const d = new Date(); return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; }
function showModal(t,m){ $("#mTitle").textContent=t; $("#mMsg").textContent=m; const md=$("#modal"); md.classList.remove("hidden"); md.classList.add("flex"); }
$("#mOk").onclick=()=>{ const md=$("#modal"); md.classList.add("hidden"); md.classList.remove("flex"); };

const SUBMIT_KEY="jengchi_submit_lock";
function cooldownMs(){ const v=localStorage.getItem(SUBMIT_KEY); if(!v) return 0; const el=Date.now()-Number(v); return Math.max(0, 5*60*1000 - el); }
function applyCooldown(){ $("#btnSubmit").disabled = cooldownMs()>0; }
function sleep(ms){ return new Promise(r=>setTimeout(r,ms)); }

async function toDataUrl(url){ try{ const res=await fetch(url); const blob=await res.blob(); return await new Promise(r=>{ const fr=new FileReader(); fr.onloadend=()=>r({data:fr.result, fmt: (blob.type.includes('png')?'PNG':'JPEG')}); fr.readAsDataURL(blob); }); }catch{ return {data:null, fmt:'JPEG'}; }}

/* ===== Enrichment flags (optional columns) ===== */
const enrich = { has:false, item_code:false, image_url:false, par:false, avg:false, conv:false, vendor:false, vendors:false };
let convColumn = null;

async function detectEnrichment(){
  try{
    let { error } = await supabase.from("inventory_management").select("product_name").limit(1);
    if(error) { enrich.has=false; return; }
    enrich.has=true;

    const probe = async (col)=> (await supabase.from("inventory_management").select(col).limit(1)).error ? false : true;
    enrich.item_code = await probe("item_code");
    enrich.image_url = await probe("image_url");
    enrich.par       = await probe("par");
    enrich.avg       = await probe("avg_daily_usage");
    enrich.vendor    = await probe("vendor");
    enrich.vendors   = await probe("vendors");

    const convCandidates = ["conversion_factor","case_size","units_per_case","uom_per_case","pack_size"];
    for(const c of convCandidates){
      const ok = await probe(c);
      if(ok){ convColumn=c; enrich.conv=true; break; }
    }
  }catch{ enrich.has=false; }
}

/* ===== Filters’ vendor list (restricted) ===== */
async function loadVendorsForFilters(){
  const opts = ['<option value="">— All —</option>']
      .concat(ALLOWED_VENDORS.map(v => `<option>${v}</option>`))
      .join("");
  $("#vendorFilter").innerHTML = opts;
  $("#editVendor").innerHTML  = opts;
}

/* ===== PRODUCT × VENDOR → ITEM CODE (built from `vendors` column) ===== */
let PRODUCT_VENDOR_CODES = new Map();

async function buildVendorCodeMap(){
  PRODUCT_VENDOR_CODES = new Map();
  if(!enrich.has) return;

  const { data, error } = await supabase
    .from("inventory_management")
    .select("product_name,vendors,item_code");
  if (error || !Array.isArray(data)) return;

  data.forEach(r => {
    const pn = norm(r.product_name); if(!pn) return;
    if (!PRODUCT_VENDOR_CODES.has(pn)) PRODUCT_VENDOR_CODES.set(pn, {});
    const map = PRODUCT_VENDOR_CODES.get(pn);

    const vendors = (r.vendors || "").split(",").map(v => canon(v)).filter(Boolean);
    if (vendors.length){
      vendors.forEach(v => { map[v] = (r.item_code || "").trim(); });
    }
  });

  window.PRODUCT_VENDOR_CODES = PRODUCT_VENDOR_CODES;
}

function vendorsForProduct(productName, currentVendor){
  const list = [...ALLOWED_VENDORS];
  const cur = canon(currentVendor);
  if (cur && !list.includes(cur)) list.unshift(cur);
  return [...new Set(list)];
}

function codeFor(productName, vendor){
  const pn = norm(productName);
  const v = canon(vendor);
  const map = PRODUCT_VENDOR_CODES.get(pn) || {};
  const code = map[v];
  return (code && code !== "") ? code : "-------";
}

/* Vendor selects (card + table cell) */
function vendorSelectHtml(current, options){
  const displayCurrent = current ? canon(current) : '';
  const set = new Set([displayCurrent, ...options.map(canon)].filter(Boolean));
  const opts = ['<option value="">— pick —</option>']
    .concat([...set].map(v => `<option value="${v}" ${v===displayCurrent?'selected':''}>${v}</option>`))
    .join('');
  return `<label class="block text-sm font-semibold mb-1">Vendor</label>
            <select class="field w-full vendor-select">${opts}</select>`;
}
function vendorSelectCellHtml(current, options){
  const displayCurrent = current ? canon(current) : '';
  const set = new Set([displayCurrent, ...options.map(canon)].filter(Boolean));
  const opts = ['<option value="">— pick —</option>']
    .concat([...set].map(v => `<option value="${v}" ${v===displayCurrent?'selected':''}>${v}</option>`))
    .join('');
  return `<select class="field w-full edit-vendor">${opts}</select>`;
}

/* ===== Create Order helpers ===== */
function recommendedCases(parUnits, onHand, conv){
  if(parUnits==null) return null;
  const unitsNeeded = Math.max(0, Number(parUnits) - Number(onHand||0));
  const perCase = Math.max(1, Number(conv||1));
  return Math.ceil(unitsNeeded / perCase);
}

function buildCard(row, vendorOptions, readOnly){
  const imgHtml = row.image_url ? `<img src="${row.image_url}" alt="product">` : `<div class="text-xs text-gray-400">No Image</div>`;
  const wrap = document.createElement('div');
  wrap.className = "card";
  wrap.dataset.product = row.product_name;

  // Input value logic: show blank when 0
  const readonlyQty = Number(row.on_hand||0);
  const orderValue = readOnly ? (readonlyQty === 0 ? '' : readonlyQty) : '';

  wrap.innerHTML = `
    <div class="flex gap-4">
      <div class="img-wrap">${imgHtml}</div>
      <div class="flex-1">
        <h4 class="text-lg font-extrabold mb-1 shine">${row.product_name}</h4>
        <div class="text-xs text-gray-500 -mt-1">
          Item Code: <span class="font-semibold item-code">-------</span>
        </div>
        <div class="flex flex-wrap gap-2 mt-2">
          <span class="badge">On Hand: ${Number(row.on_hand||0)}</span>
          ${row.par!=null ? `<span class="badge">Par: ${Number(row.par)}</span>` : ''}
          ${(row.conv && row.conv>1) ? `<span class="badge">Units/Case: ${row.conv}</span>` : ''}
          ${row.vendor ? `<span class="badge">Vendor: ${canon(row.vendor)}</span>` : ''}
        </div>
        <div class="mt-3 grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>${vendorSelectHtml(row.vendor||'', vendorOptions)}</div>
          <div>
            <label class="block text-sm font-semibold mb-1">Order</label>
            <input type="number" min="0" value="${orderValue}" class="field w-full order-input" ${readOnly?'readonly':''}/>
          </div>
        </div>
        <div class="mt-2 text-gray-700">${(recommendedCases(row.par, row.on_hand, row.conv)!=null) ? `<div class="text-sm"><span class="font-semibold">Recommended (cases):</span> ${recommendedCases(row.par, row.on_hand, row.conv)}</div>` : ''}</div>
      </div>
    </div>`;

  const sel = wrap.querySelector(".vendor-select");
  const codeSpan = wrap.querySelector(".item-code");
  function updateItemCode() {
      const chosen = sel.value;
      const code = codeFor(row.product_name, chosen);
      codeSpan.textContent = code;
  }
  if (sel) sel.addEventListener("change", updateItemCode);
  updateItemCode();
  return wrap;
}

/* ===== Load Create tab ===== */
async function loadCreate(dateISO){
  await loadVendorsForFilters();
  await buildVendorCodeMap();

  let cols = "product_name,on_hand,tentative,user,vendor";
  const { data: base, error } = await supabase
    .from("inventory_check")
    .select(cols)
    .eq("order_date", dateISO)
    .order("user",{ascending:true})
    .order("product_name",{ascending:true});

  const rGrid=$("#gridRony"), jGrid=$("#gridJulio"); rGrid.innerHTML=""; jGrid.innerHTML="";
  if(error){ rGrid.innerHTML='<p class="text-red-600">Error loading.</p>'; return; }
  if(!base?.length){ rGrid.innerHTML='<p class="text-gray-500">No items to show.</p>'; return; }

  // optional enrichment (images/par/conv)
  let extraMap = new Map();
  if(enrich.has){
    let sel="product_name";
    if(enrich.item_code) sel+=",item_code";
    if(enrich.image_url) sel+=",image_url";
    if(enrich.par)       sel+=",par";
    if(enrich.avg)       sel+=",avg_daily_usage";
    if(enrich.conv && convColumn) sel+=","+convColumn;
    const { data: info } = await supabase.from("inventory_management").select(sel);
    (info||[]).forEach(r=> extraMap.set(norm(r.product_name), r));
  }

  const rows = base.map(r=>{
    const ex = extraMap.get(norm(r.product_name)) || {};
    return {
      ...r,
      item_code: ex.item_code,
      image_url: ex.image_url,
      par: (ex.par!=null ? Number(ex.par) : null),
      avg_day: (ex.avg_daily_usage!=null ? Math.round(Number(ex.avg_daily_usage)||0) : null),
      conv: (convColumn && ex[convColumn]!=null ? Math.max(1, Number(ex[convColumn])||1) : 1)
    };
  });

  const rony  = rows.filter(x=>(x.user||'').toLowerCase()==='rony');
  const julio = rows.filter(x=>(x.user||'').toLowerCase()==='julio');

  const vf = $("#vendorFilter").value;
  let ronyFiltered = rony;
  let julioFiltered = julio;
  if (vf) {
    ronyFiltered = rony.filter(r => canon(r.vendor) === canon(vf));
    julioFiltered = julio.filter(r => canon(r.vendor) === canon(vf));
  }

  if(ronyFiltered.length) ronyFiltered.forEach(r=>{
    const opts = vendorsForProduct(r.product_name, r.vendor);
    const cardRow = {...r};
    $("#gridRony").appendChild(buildCard(cardRow, opts, false));
  }); else $("#gridRony").innerHTML='<p class="text-gray-500">No Rony products to show.</p>';

  if(julioFiltered.length) julioFiltered.forEach(r=>{
    const cardRow = {...r};
    const opts = vendorsForProduct(cardRow.product_name, cardRow.vendor);
    $("#gridJulio").appendChild(buildCard(cardRow, opts, true));
  }); else $("#gridJulio").innerHTML='<p class="text-gray-500">No Julio products to show.</p>';
}

/* ===== Save/Submit ===== */
async function persistCreateEdits(){
  const dateISO = $("#orderDate").value || todayYMD();
  async function walk(container, user){
    for(const card of container.querySelectorAll(".card")){
      const product = card.dataset.product;
      const vendorSel = card.querySelector(".vendor-select");
      const qtyInp = card.querySelector(".order-input");
      const patch = {};
      if(vendorSel) patch.vendor = vendorSel.value || null;
      if(qtyInp && !qtyInp.readOnly){
        const raw = qtyInp.value;
        patch.tentative = (raw === '' || raw == null) ? 0 : Number(raw);
      }
      if(Object.keys(patch).length){
        await supabase.from("inventory_check").update(patch)
          .eq("order_date", dateISO).eq("product_name", product).eq("user", user);
      }
    }
  }
  await walk($("#gridRony"), "Rony");
  await walk($("#gridJulio"), "Julio");
}

async function submitOrder(){
  if(cooldownMs()>0){ showModal("Pedido ya enviado","Por favor espere 5 minutos antes de volver a intentarlo."); return; }
  await persistCreateEdits();
  localStorage.setItem(SUBMIT_KEY, String(Date.now()));
  applyCooldown();
  showModal("Order sent","Your order has been confirmed. We avoid duplicate emails for 5 minutes.");
}

/* ===== Edit tab ===== */
function computeQty(row){
  return (row.user && row.user.toLowerCase()==='julio')
    ? Number(row.on_hand||0)                   // Julio's order = on_hand
    : Number(row.tentative||0);                // Rony's order = tentative
}

async function renderEdit(dateISO, vendor){
  let cols="product_name,on_hand,tentative,user,vendor";
  const sel = supabase.from("inventory_check").select(cols).eq("order_date", dateISO);
  const { data, error } = vendor ? await sel.eq("vendor", canon(vendor)) : await sel;

  const tbody=$("#editRows"); tbody.innerHTML="";
  if(error){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-red-600">Error loading.</td></tr>`; return; }
  if(!data?.length){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-gray-500">No rows.</td></tr>`; return; }

  // Keep only items with Qty > 0 (Rony→tentative, Julio→on_hand)
  const shown = data.map(r => ({...r, __qty: computeQty(r)})).filter(r => r.__qty > 0);
  if(!shown.length){ tbody.innerHTML=`<tr><td colspan="6" class="py-4 text-gray-500">No items with Qty &gt; 0.</td></tr>`; return; }

  shown.forEach(r=>{
    const tr=document.createElement('tr'); tr.className="border-b";
    const vendorSelect = vendorSelectCellHtml(r.vendor || "", vendorsForProduct(r.product_name, r.vendor));
    tr.innerHTML=`
      <td class="py-2 px-3">${r.product_name}</td>
      <td class="py-2 px-3">${Number(r.on_hand||0)}</td>
      <td class="py-2 px-3"><input type="number" min="0" value="${r.__qty}" class="field w-28 edit-qty"></td>
      <td class="py-2 px-3">${vendorSelect}</td>
      <td class="py-2 px-3">${r.user||''}</td>
      <td class="py-2 px-3"><button class="btn btn-light btn-del">Delete</button></td>`;
    tr.querySelector(".btn-del").onclick = async ()=>{
      await supabase.from("inventory_check").delete()
        .eq("order_date", dateISO).eq("product_name", r.product_name).eq("user", r.user);
      tr.remove();
    };
    tbody.appendChild(tr);
  });
}

async function saveEdits(){
  const dateISO = $("#editDate").value || todayYMD();
  for(const tr of document.querySelectorAll("#editRows tr")){
    const product = tr.children[0].textContent;
    const onUser  = tr.children[4].textContent;

    const raw = tr.querySelector(".edit-qty").value;
    const qty = (raw === '' || raw == null) ? 0 : Number(raw);

    const vendorSel = tr.querySelector(".edit-vendor");
    const vendor = vendorSel ? vendorSel.value || null : null;

    await supabase.from("inventory_check")
      .update({ tentative: qty, vendor }) // tentative used for Rony; harmless for Julio
      .eq("order_date", dateISO).eq("product_name", product).eq("user", onUser);
  }
  showModal("Saved","Changes updated.");
}

/* ===== Reports: preview + edit vendors ===== */
async function loadReportRows(){
  const dateISO = $("#reportDate").value || todayYMD();
  let cols="product_name,on_hand,tentative,user,vendor";
  const { data: rows, error } = await supabase.from("inventory_check").select(cols).eq("order_date", dateISO);
  const tbody = $("#reportRows"); tbody.innerHTML="";
  if(error){ tbody.innerHTML=`<tr><td colspan="4" class="py-3 text-red-600">Error loading.</td></tr>`; return; }
  if(!rows?.length){ tbody.innerHTML=`<tr><td colspan="4" class="py-3 text-gray-500">No rows for that date.</td></tr>`; return; }

  const filtered = rows.map(r=>{
      const qty = computeQty(r);
      return { ...r, qty };
    })
    .filter(r=> r.qty > 0);

  if(!filtered.length){
    tbody.innerHTML = `<tr><td colspan="4" class="py-3 text-gray-500">No ordered items (Qty &gt; 0).</td></tr>`;
    return;
  }

  filtered.forEach(r=>{
    const tr = document.createElement('tr'); tr.className="border-b";
    const opts = vendorsForProduct(r.product_name, r.vendor);
    tr.dataset.product = r.product_name;
    tr.dataset.user = r.user || '';
    tr.innerHTML = `
      <td class="py-2 px-3">${r.product_name}</td>
      <td class="py-2 px-3">${r.qty}</td>
      <td class="py-2 px-3">${vendorSelectCellHtml(r.vendor||'', opts)}</td>
      <td class="py-2 px-3">${r.user||''}</td>
    `;
    tbody.appendChild(tr);
  });
}

async function saveReportVendorChanges(){
  const dateISO = $("#reportDate").value || todayYMD();
  const rows = document.querySelectorAll("#reportRows tr");
  if(!rows.length){ showModal("Nothing to save","Load the preview first."); return; }
  for(const tr of rows){
    const product = tr.dataset.product;
    const onUser = tr.dataset.user;
    const vendorSel = tr.querySelector(".edit-vendor");
    const vendor = vendorSel ? vendorSel.value || null : null;
    await supabase.from("inventory_check")
      .update({ vendor })
      .eq("order_date", dateISO).eq("product_name", product).eq("user", onUser);
  }
  showModal("Saved","Vendor changes updated for ordered items.");
}

/* ===== Reports: PDFs ===== */
async function generatePDFs(){
  const dateISO = $("#reportDate").value || todayYMD();
  const { jsPDF } = window.jspdf;

  let cols="product_name,on_hand,tentative,user,vendor";
  const { data: rows } = await supabase.from("inventory_check").select(cols).eq("order_date", dateISO);
  if(!rows?.length){ showModal("No data","No rows for that date."); return; }

  logoData.company = await toDataUrl(COMPANY_LOGO);
  for(const [k,u] of Object.entries(vendorLogos)) logoData[k] = await toDataUrl(u);

  let infoMap = new Map();
  if(enrich.has){
    let sel="product_name";
    if(enrich.item_code) sel+=",item_code";
    if(enrich.image_url) sel+=",image_url";
    const { data: info } = await supabase.from("inventory_management").select(sel);
    (info||[]).forEach(r=> infoMap.set(norm(r.product_name), r));
  }

  const byVendor={};
  rows.forEach(r=>{
    const qty = computeQty(r);
    if(qty <= 0) return;

    const v= r.vendor ? canon(r.vendor) : "Unknown Vendor";
    if(!byVendor[v]) byVendor[v]=[];
    const ex = infoMap.get(norm(r.product_name))||{};
    byVendor[v].push({
      ...r,
      item_code: ex.item_code,
      image_url: ex.image_url,
      qty
    });
  });

  const vendors = Object.keys(byVendor);
  if(!vendors.length){ showModal("Nothing to print","No ordered items (Qty > 0)."); return; }

  for(const [vendor, list] of Object.entries(byVendor)){
    const doc = new jsPDF({unit:'pt', format:'letter'});
    const pageW = doc.internal.pageSize.getWidth(); const M=42; let y=M;

    if(logoData.company?.data) doc.addImage(logoData.company.data, logoData.company.fmt, pageW/2-60, y, 120, 90), y+=110;
    doc.setFont('helvetica','bold'); doc.setFontSize(22); doc.text("Inventory Order", pageW/2, y, {align:'center'}); y+=18;
    doc.setFont('helvetica','normal'); doc.setFontSize(12); doc.text(`Order date: ${dateISO}`, pageW/2, y, {align:'center'}); y+=24;

    doc.setDrawColor(17,24,39); doc.line(M,y,pageW-M,y); y+=16;
    doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.text(vendor, M, y);
    const vlogo = logoData[vendor]; if(vlogo?.data) doc.addImage(vlogo.data, vlogo.fmt, pageW-M-80, y-26, 60, 40);

    const head = ["Product","Qty"];
    const body = list.map(r=>[r.product_name, r.qty]);

    doc.autoTable({ startY: y+6, margin:{left:M,right:M},
      head:[head], body,
      styles:{font:'helvetica', fontSize:10, cellPadding:4},
      headStyles:{fillColor:[17,24,39], textColor:[255,255,255], fontStyle:'bold'},
      columnStyles: {0:{cellWidth:'auto'},1:{cellWidth:60,halign:'right'}}
    });

    doc.save(`JengChi_Order_${dateISO}_${vendor.replace(/\s+/g,'_')}.pdf`);
    await sleep(250);
  }
  showModal("Done","PDFs generated per vendor.");
}

/* ===== NAV + EVENTS ===== */
document.querySelectorAll(".tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll(".tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    ["panel-order","panel-edit","panel-report"].forEach(id=>{
      document.getElementById(id).classList.toggle("hidden", id!==btn.dataset.tab);
    });
  };
});
$("#vendorFilter").addEventListener("change", ()=> loadCreate($("#orderDate").value || todayYMD()));
$("#orderDate").addEventListener("change", ()=> loadCreate($("#orderDate").value || todayYMD()));
$("#btnSubmit").addEventListener("click", submitOrder);

// Edit
$("#btnLoadEdit").addEventListener("click", ()=> renderEdit($("#editDate").value || todayYMD(), $("#editVendor").value));
$("#btnSaveEdits").addEventListener("click", saveEdits);

// Reports
$("#btnReportPreview").addEventListener("click", loadReportRows);
$("#btnSaveReportVendor").addEventListener("click", saveReportVendorChanges);
$("#btnReport").addEventListener("click", generatePDFs);

/* ===== INIT ===== */
(async function init(){
  logoData.company = await toDataUrl(COMPANY_LOGO);
  for(const [k,u] of Object.entries(vendorLogos)) logoData[k] = await toDataUrl(u);

  await detectEnrichment();
  await loadVendorsForFilters();

  const t=todayYMD();
  $("#orderDate").value=t; $("#editDate").value=t; $("#reportDate").value=t;

  await loadCreate(t);
  applyCooldown();
})();
</script>
</body>
</html>
