<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake 2025 Pre-Order</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --jc-primary:#7A3D36; --jc-primary-dark:#5c2e29;
      --ink:#fff;
    }
    html,body{height:100%}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:#120706;color:var(--ink);margin:0}

    /* Glossy animated background */
    .bg-waves{position:fixed;inset:0;z-index:-1;overflow:hidden;background:
      radial-gradient(1200px 800px at 50% 20%, rgba(255,219,200,.18), transparent 60%),
      radial-gradient(1200px 800px at 50% 80%, rgba(255,219,200,.12), transparent 60%),
      radial-gradient(circle at center, #7A3D36 0%, #2B0F0D 60%, #120706 100%);
    }
    .bg-waves::before,.bg-waves::after{content:"";position:absolute;inset:-20%;background:conic-gradient(from 0deg,#ffd7be22,#ffffff11,#ffd7be22,#ffffff00);filter:blur(40px);animation:spin 28s linear infinite}
    .bg-waves::after{animation-duration:40s;mix-blend-mode:overlay;opacity:.6}
    @keyframes spin{to{transform:rotate(360deg)}}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.07));border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(8px);box-shadow:0 18px 48px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.22);border-radius:22px}
    .logo-glow{filter:drop-shadow(0 0 28px rgba(255,228,204,.85)) drop-shadow(0 0 6px rgba(255,255,255,.6))}
    .btn{background:var(--jc-primary);color:#fff;border-radius:12px;padding:.65rem .9rem;font-weight:700;box-shadow:0 10px 24px rgba(122,61,54,.38);transition:.2s ease}
    .btn:hover{transform:translateY(-1px);background:var(--jc-primary-dark);box-shadow:0 16px 36px rgba(122,61,54,.5)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:12px;padding:.55rem .85rem}
    .qty{width:64px;text-align:center}
    .row{display:grid;grid-template-columns: 1.4fr 0.6fr 0.9fr 1fr;gap:14px;align-items:center}
    @media (max-width: 640px){ .row{grid-template-columns: 1fr 0.5fr 1fr} .hide-sm{display:none} }
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent)}
    .price{font-weight:800}
    .anchor-nav a{opacity:.9}
    .anchor-nav a:hover{opacity:1;text-decoration:underline}

    /* Delete button style */
    .btn-ghost[aria-label="remove"]{ border-color: rgba(255,120,120,.45); }
    .btn-ghost[aria-label="remove"]:hover{
      background: rgba(255,120,120,.12);
      border-color: rgba(255,120,120,.7);
    }
  </style>
</head>
<body class="min-h-full">
  <div class="bg-waves" aria-hidden="true"></div>

  <!-- HEADER -->
  <header class="w-full pt-8 pb-4 flex flex-col items-center gap-3">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-20 w-auto logo-glow" />
    <h1 class="text-3xl md:text-4xl font-extrabold">Mooncake 2025 — Pre-Order</h1>
    <p class="opacity-90 text-center px-4">Enterprise list view with quantity controls. Reserve now — pay later (or use “Buy Now” per item).</p>

    <!-- Quick anchors -->
    <nav class="anchor-nav flex gap-4 text-sm opacity-95">
      <a href="#Canton Style">Canton Style</a>
      <span>•</span>
      <a href="#Thousand Layers">Thousand Layers</a>
      <span>•</span>
      <a href="#Northern Style">Northern Style</a>
      <span>•</span>
      <a href="#Special Style">Special Style</a>
    </nav>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-7xl px-5 pb-24">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT: Grouped Sections -->
      <section class="lg:col-span-2 space-y-8" id="groupedRoot">
        <!-- sections injected -->
      </section>

      <!-- RIGHT: Cart / Preorder -->
      <aside class="panel p-6 h-max sticky top-6">
        <h3 class="text-xl font-bold">Order Summary</h3>
        <div id="cartList" class="mt-3 space-y-2 text-sm"></div>
        <div class="mt-3 divider"></div>
        <div class="mt-3 flex items-center justify-between text-lg">
          <span>Subtotal</span>
          <span id="cartTotal" class="price">$0.00</span>
        </div>

        <div class="mt-6 grid gap-3">
          <button id="btnSavePreorder" class="btn">Reserve (no payment)</button>
          <p class="text-xs opacity-80">Or buy a single item with its <em>Buy Now</em> link.</p>
        </div>

        <form id="customerForm" class="mt-6 grid grid-cols-1 gap-3 text-sm">
          <input id="custName" class="panel px-3 py-2" placeholder="Full name / Nombre" required />
          <input id="custPhone" class="panel px-3 py-2" placeholder="Phone / Teléfono" />
          <input id="custEmail" type="email" class="panel px-3 py-2" placeholder="Email" />
          <label class="text-xs opacity-90">Pickup date (YYYY-MM-DD)</label>
          <input id="pickupDate" type="date" class="panel px-3 py-2" />
          <textarea id="custNotes" class="panel px-3 py-2" rows="3" placeholder="Notes (flavors, packaging)"></textarea>
        </form>

        <div id="status" class="mt-3 text-xs opacity-90"></div>
      </aside>
    </div>
  </main>

  <footer class="py-8 text-center text-xs opacity-80">© <span id="y"></span> Jeng Chi Restaurant</footer>

  <script>
    // ===== Supabase setup =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    const cart = new Map();
    let allProducts = [];

    const fmtUSD = cents => `$${(cents/100).toFixed(2)}`;

    function addToCart(p, qty){
      if(qty <= 0) return;
      const current = cart.get(p.id) || { product: p, qty: 0 };
      current.qty += qty;
      cart.set(p.id, current);
      updateCartUI();
    }

    function updateCartUI(){
      const list = document.getElementById('cartList');
      const totalEl = document.getElementById('cartTotal');
      list.innerHTML = '';
      let total = 0;

      for (const [id, item] of cart){
        total += item.product.price_cents * item.qty;

        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="font-semibold">${item.product.name}</div>
          <div class="price">${fmtUSD(item.product.price_cents)}</div>
          <div class="flex items-center gap-2">
            <button class="btn-ghost px-2" aria-label="dec">−</button>
            <input class="panel qty py-2" type="number" min="0" step="1" value="${item.qty}" />
            <button class="btn-ghost px-2" aria-label="inc">+</button>
            <button class="btn-ghost px-3" aria-label="remove" title="Remove">×</button>
          </div>
          <div class="text-right">${fmtUSD(item.product.price_cents * item.qty)}</div>
        `;

        const btnDec   = row.querySelector('button[aria-label="dec"]');
        const qtyInput = row.querySelector('input[type="number"]');
        const btnInc   = row.querySelector('button[aria-label="inc"]');
        const btnRem   = row.querySelector('button[aria-label="remove"]');

        const commitQty = (q) => {
          if (q <= 0 || Number.isNaN(q)) {
            cart.delete(id);
          } else {
            item.qty = q;
            cart.set(id, item);
          }
          updateCartUI();
        };

        btnDec.onclick   = () => commitQty((item.qty|0) - 1);
        btnInc.onclick   = () => commitQty((item.qty|0) + 1);
        qtyInput.onchange= () => commitQty(parseInt(qtyInput.value, 10));
        btnRem.onclick   = () => { cart.delete(id); updateCartUI(); };

        list.appendChild(row);
      }
      totalEl.textContent = fmtUSD(total);
    }

    function sectionBanner(category){
      if (category === 'Canton Style')
        return 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/cantonese.jpg';
      if (category === 'Northern Style')
        return 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/nothern.jpg';
      if (category === 'Thousand Layers')
        return 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/thousand.jpg';
      return '';
    }

    function renderSection(category, products){
      const wrap = document.createElement('section');
      wrap.className = 'panel overflow-hidden';

      let banner = sectionBanner(category);
      let headerHTML = '';
      if (banner) {
        headerHTML = `
          <div class="relative">
            <img src="${banner}" class="w-full h-44 md:h-56 object-cover" alt="${category}">
            <div class="absolute inset-0 bg-black/45 flex items-center justify-center">
              <h2 class="text-2xl md:text-3xl font-extrabold text-white">${category}</h2>
            </div>
          </div>`;
      } else {
        headerHTML = `
          <div class="w-full h-20 md:h-24 bg-[var(--jc-primary)] flex items-center justify-center">
            <h2 class="text-2xl md:text-3xl font-extrabold text-white">${category}</h2>
          </div>`;
      }

      wrap.innerHTML = `
        <a id="${category}">${headerHTML}</a>
        <div class="p-5">
          <div class="row text-sm opacity-80 pb-2">
            <div>Product</div>
            <div class="hide-sm">Price</div>
            <div>Quantity</div>
            <div class="hide-sm text-right">Line Total</div>
          </div>
          <div class="divider mb-3"></div>
          <div data-rows></div>
        </div>
      `;

      const rows = wrap.querySelector('[data-rows]');

      for (const p of products){
        const row = document.createElement('div');
        row.className = 'row items-center py-3';
        row.innerHTML = `
          <div class="font-semibold leading-tight">${p.name}
            <div class="text-xs opacity-80">${p.description || ''}</div>
          </div>
          <div class="price hide-sm">${fmtUSD(p.price_cents)}</div>
          <div class="flex items-center gap-2">
            <button class="btn-ghost px-3" aria-label="minus">−</button>
            <input class="panel qty py-2" type="number" min="1" step="1" value="1"/>
            <button class="btn-ghost px-3" aria-label="plus">+</button>
            <button class="btn" aria-label="add">Add</button>
            <a class="btn-ghost hide-sm ${p.stripe_payment_link ? '' : 'opacity-50 pointer-events-none'}"
               href="${p.stripe_payment_link || '#'}" target="_blank" rel="noopener">Buy Now</a>
          </div>
          <div class="hide-sm text-right opacity-80">${fmtUSD(p.price_cents)}</div>
        `;

        const btnMinus = row.querySelector('button[aria-label="minus"]');
        const btnPlus  = row.querySelector('button[aria-label="plus"]');
        const qtyInput = row.querySelector('input[type="number"]');
        const btnAdd   = row.querySelector('button[aria-label="add"]');

        btnMinus.onclick = ()=>{ qtyInput.value = Math.max(1, parseInt(qtyInput.value||'1',10)-1); };
        btnPlus.onclick  = ()=>{ qtyInput.value = Math.max(1, parseInt(qtyInput.value||'1',10)+1); };
        btnAdd.onclick   = ()=>{ addToCart(p, Math.max(1, parseInt(qtyInput.value||'1',10))); };

        rows.appendChild(row);
        const divider = document.createElement('div');
        divider.className = 'divider';
        rows.appendChild(divider);
      }
      return wrap;
    }

    function renderGrouped(products){
      const root = document.getElementById('groupedRoot');
      root.innerHTML = '';

      const groups = {};
      for (const p of products){
        const cat = p.category || 'Uncategorized';
        (groups[cat] ||= []).push(p);
      }

      const order = ['Canton Style','Thousand Layers','Northern Style','Special Style'];
      const cats = Object.keys(groups).sort((a,b)=>{
        const ia = order.indexOf(a), ib = order.indexOf(b);
        if (ia !== -1 && ib !== -1) return ia-ib;
        if (ia !== -1) return -1;
        if (ib !== -1) return 1;
        return a.localeCompare(b);
      });

      for (const cat of cats){
        groups[cat].sort((a,b)=>{
          const so = (a.sort_order ?? 1e9) - (b.sort_order ?? 1e9);
          if (so !== 0) return so;
          return a.name.localeCompare(b.name);
        });
        root.appendChild(renderSection(cat, groups[cat]));
      }
    }

    async function loadProducts(){
      const { data, error } = await supabaseClient
        .from('mooncake_products')
        .select('*')
        .eq('is_active', true)
        .order('category', { ascending: true, nullsFirst: true })
        .order('sort_order', { ascending: true, nullsFirst: true })
        .order('name', { ascending: true });

      if (error){
        console.error(error);
        document.getElementById('groupedRoot').innerHTML =
          `<div class="panel p-6 text-sm">Error loading products: ${error.message}</div>`;
        return;
      }

      allProducts = data || [];
      renderGrouped(allProducts);
    }

    async function savePreorder(){
      const name = document.getElementById('custName').value.trim();
      if(!name){ alert('Please enter your name.'); return; }
      if(cart.size === 0){ alert('Add at least one item.'); return; }

      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail').value.trim();
      const pickup_date = document.getElementById('pickupDate').value || null;
      const notes = document.getElementById('custNotes').value.trim();

      const status = document.getElementById('status');
      status.textContent = 'Saving your preorder...';

      const { data: preorder, error: e1 } = await supabaseClient
        .from('mooncake_preorders')
        .insert([{ customer_name: name, phone, email, pickup_date, notes }])
        .select()
        .single();
      if(e1){ status.textContent = 'Error: ' + e1.message; return; }

      const items = Array.from(cart.values()).map(i=>({
        preorder_id: preorder.id,
        product_id: i.product.id,
        quantity: i.qty
      }));
      const { error: e2 } = await supabaseClient.from('mooncake_preorder_items').insert(items);
      if(e2){ status.textContent = 'Error: ' + e2.message; return; }

      cart.clear(); updateCartUI();
      status.innerHTML = `✅ Preorder saved! Reference: <strong>${preorder.id}</strong>`;
    }

    document.getElementById('btnSavePreorder').addEventListener('click', savePreorder);
    document.getElementById('y').textContent = new Date().getFullYear();
    loadProducts();
  </script>
</body>
</html>
