<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake 2025 Pre‑Order</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --jc-primary:#7A3D36; /* brand color */
      --jc-primary-dark:#5c2e29;
      --ink:#0f0b0a;
      --paper:#ffffff;
    }
    html,body{height:100%}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:#120706;color:#fff;margin:0}

    /* Glossy animated background (matches your under‑construction theme) */
    .bg-waves{position:fixed;inset:0;z-index:-1;overflow:hidden;background:
      radial-gradient(1200px 800px at 50% 20%, rgba(255,219,200,.18), transparent 60%),
      radial-gradient(1200px 800px at 50% 80%, rgba(255,219,200,.12), transparent 60%),
      radial-gradient(circle at center, #7A3D36 0%, #2B0F0D 60%, #120706 100%);
    }
    .bg-waves::before,.bg-waves::after{content:"";position:absolute;inset:-20%;background:conic-gradient(from 0deg,#ffd7be22,#ffffff11,#ffd7be22,#ffffff00);filter:blur(40px);animation:spin 28s linear infinite}
    .bg-waves::after{animation-duration:40s;mix-blend-mode:overlay;opacity:.6}
    @keyframes spin{to{transform:rotate(360deg)}}

    .glass{background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.07));border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(8px);box-shadow:0 18px 48px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.22)}
    .logo-glow{filter:drop-shadow(0 0 28px rgba(255,228,204,.85)) drop-shadow(0 0 6px rgba(255,255,255,.6))}
    .btn{background:var(--jc-primary);color:#fff;border-radius:1rem;padding:.75rem 1rem;font-weight:700;box-shadow:0 12px 28px rgba(122,61,54,.38);transition:.25s ease}
    .btn:hover{transform:translateY(-2px) scale(1.01);background:var(--jc-primary-dark);box-shadow:0 18px 40px rgba(122,61,54,.5)}
    .btn-outline{background:transparent;border:1px solid rgba(255,255,255,.4);color:#fff;border-radius:1rem;padding:.6rem .9rem}
    .badge{display:inline-block;background:rgba(255,255,255,.15);border:1px solid rgba(255,255,255,.25);border-radius:9999px;padding:.2rem .6rem;font-size:.75rem}
    .price{font-weight:800}
  </style>
</head>
<body class="min-h-full">
  <div class="bg-waves" aria-hidden="true"></div>

  <!-- HEADER -->
  <header class="w-full pt-8 pb-4 flex flex-col items-center gap-3">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-24 w-auto logo-glow" />
    <h1 class="text-3xl md:text-4xl font-extrabold">Mooncake 2025 — Pre‑Order</h1>
    <p class="opacity-90 text-center px-4">Celebrate the season with authentic Jeng Chi mooncakes. Reserve now — pay later or buy instantly per item.</p>
  </header>

  <main class="mx-auto max-w-7xl px-5 pb-24">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Product Grid -->
      <section class="lg:col-span-2 glass rounded-3xl p-6">
        <div class="flex items-center justify-between">
          <h2 class="text-2xl font-bold">Menu</h2>
          <span id="productCount" class="badge">0 items</span>
        </div>
        <div id="productGrid" class="mt-4 grid sm:grid-cols-2 xl:grid-cols-3 gap-5"></div>
      </section>

      <!-- Cart / Preorder Pane -->
      <aside class="glass rounded-3xl p-6 h-max sticky top-6">
        <h3 class="text-xl font-bold">Your Order</h3>
        <div id="cartList" class="mt-3 space-y-3 text-sm"></div>
        <div class="mt-4 flex items-center justify-between text-lg">
          <span>Total</span>
          <span id="cartTotal" class="price">$0.00</span>
        </div>

        <div class="mt-6 grid gap-3">
          <button id="btnSavePreorder" class="btn">Reserve (no payment yet)</button>
          <p class="text-xs opacity-80">Or buy a single item instantly using its <em>Buy Now</em> button in the menu.</p>
        </div>

        <form id="customerForm" class="mt-6 grid grid-cols-1 gap-3 text-sm">
          <input id="custName" class="glass rounded-xl px-3 py-2" placeholder="Full name / Nombre" required />
          <input id="custPhone" class="glass rounded-xl px-3 py-2" placeholder="Phone / Teléfono" />
          <input id="custEmail" type="email" class="glass rounded-xl px-3 py-2" placeholder="Email" />
          <label class="text-xs opacity-90">Pickup date (YYYY-MM-DD)</label>
          <input id="pickupDate" type="date" class="glass rounded-xl px-3 py-2" />
          <textarea id="custNotes" class="glass rounded-xl px-3 py-2" rows="3" placeholder="Notes (e.g., flavors, packaging)"></textarea>
        </form>

        <div id="status" class="mt-3 text-xs opacity-90"></div>
      </aside>
    </div>
  </main>

  <footer class="py-8 text-center text-xs opacity-80">© <span id="y"></span> Jeng Chi Restaurant</footer>

  <script>
    // ===== Supabase setup (from your message) =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== State =====
    const cart = new Map(); // productId -> { product, qty }

    function fmtUSD(cents){ return `$${(cents/100).toFixed(2)}` }

    function updateCartUI(){
      const list = document.getElementById('cartList');
      const totalEl = document.getElementById('cartTotal');
      list.innerHTML = '';
      let total = 0;
      for(const [id, item] of cart){
        total += item.product.price_cents * item.qty;
        const row = document.createElement('div');
        row.className = 'flex items-center justify-between gap-3';
        row.innerHTML = `
          <div class="flex-1">
            <div class="font-semibold">${item.product.name}</div>
            <div class="opacity-80">${item.qty} × ${fmtUSD(item.product.price_cents)}</div>
          </div>
          <div class="flex items-center gap-2">
            <button class="btn-outline px-3" aria-label="decrease">−</button>
            <button class="btn-outline px-3" aria-label="increase">+</button>
            <button class="btn-outline px-3" aria-label="remove">×</button>
          </div>
        `;
        const [btnMinus, btnPlus, btnRemove] = row.querySelectorAll('button');
        btnMinus.onclick = ()=>{ item.qty=Math.max(1,item.qty-1); cart.set(id,item); updateCartUI(); };
        btnPlus.onclick  = ()=>{ item.qty=item.qty+1; cart.set(id,item); updateCartUI(); };
        btnRemove.onclick= ()=>{ cart.delete(id); updateCartUI(); };
        list.appendChild(row);
      }
      totalEl.textContent = fmtUSD(total);
    }

    async function loadProducts(){
      const { data, error } = await supabaseClient
        .from('mooncake_products')
        .select('*')
        .eq('is_active', true)
        .order('sort_order', { ascending: true, nullsFirst: false })
        .order('name', { ascending: true });
      if(error){
        console.error(error);
        document.getElementById('productGrid').innerHTML = `<div class="text-sm">Error loading products: ${error.message}</div>`;
        return;
      }
      document.getElementById('productCount').textContent = `${data.length} items`;
      renderProducts(data);
    }

    function renderProducts(products){
      const grid = document.getElementById('productGrid');
      grid.innerHTML = '';
      for(const p of products){
        const card = document.createElement('div');
        card.className = 'glass rounded-2xl overflow-hidden flex flex-col';
        card.innerHTML = `
          <div class="aspect-[4/3] bg-black/20 overflow-hidden">
            <img src="${p.image_url || 'https://images.unsplash.com/photo-1604909052315-9b86ca8c7f5f?q=80&w=1200&auto=format&fit=crop'}" alt="${p.name}" class="w-full h-full object-cover"/>
          </div>
          <div class="p-4 flex-1 flex flex-col">
            <div class="flex items-start justify-between gap-3">
              <h3 class="text-lg font-bold">${p.name}</h3>
              <div class="price">${fmtUSD(p.price_cents)}</div>
            </div>
            <p class="mt-1 text-sm opacity-90">${p.description || ''}</p>
            <div class="mt-4 flex gap-2">
              <button class="btn flex-1" aria-label="add">Add</button>
              <a class="btn-outline flex-1 text-center ${p.stripe_payment_link ? '' : 'opacity-50 pointer-events-none'}" href="${p.stripe_payment_link || '#'}" target="_blank" rel="noopener">Buy Now</a>
            </div>
          </div>
        `;
        const btnAdd = card.querySelector('button[aria-label="add"]');
        btnAdd.onclick = ()=>{
          const existing = cart.get(p.id) || { product:p, qty:0 };
          existing.qty += 1; cart.set(p.id, existing); updateCartUI();
        };
        grid.appendChild(card);
      }
    }

    async function savePreorder(){
      const name = document.getElementById('custName').value.trim();
      if(!name){ alert('Please enter your name.'); return; }
      if(cart.size === 0){ alert('Add at least one item.'); return; }

      const phone = document.getElementById('custPhone').value.trim();
      const email = document.getElementById('custEmail').value.trim();
      const pickup_date = document.getElementById('pickupDate').value || null;
      const notes = document.getElementById('custNotes').value.trim();

      const status = document.getElementById('status');
      status.textContent = 'Saving your preorder...';

      const { data: preorder, error: e1 } = await supabaseClient
        .from('mooncake_preorders')
        .insert([{ customer_name: name, phone, email, pickup_date, notes }])
        .select()
        .single();
      if(e1){ status.textContent = 'Error: ' + e1.message; return; }

      const items = Array.from(cart.values()).map(i=>({ preorder_id: preorder.id, product_id: i.product.id, quantity: i.qty }));
      const { error: e2 } = await supabaseClient.from('mooncake_preorder_items').insert(items);
      if(e2){ status.textContent = 'Error: ' + e2.message; return; }

      cart.clear(); updateCartUI();
      status.innerHTML = `✅ Preorder saved! Your reference: <strong>${preorder.id}</strong>`;
    }

    document.getElementById('btnSavePreorder').addEventListener('click', savePreorder);
    document.getElementById('y').textContent = new Date().getFullYear();
    loadProducts();
  </script>
</body>
</html>