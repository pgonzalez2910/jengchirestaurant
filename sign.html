<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jeng Chi â€” Employee Benefits Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <!-- Add PDF.js library for rendering multi-page PDFs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    // Set worker source for PDF.js
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <style>
    /* Custom Styling for Corporate Look */
    .navy { background-color: #2C3E50; } 
    .accent { background-color: #2980B9; } 
    .accent:hover { background-color: #1A6F97; }
    .card { background-color: white; border-radius: 1rem; box-shadow: 0px 4px 12px rgba(0, 0, 0, 0.1); padding: 2rem; }
    .signature-canvas { height: 200px; width: 100%; } 
    /* Style for rendered PDF pages */
    #pdfContainer canvas {
        display: block;
        margin: 20px auto;
        border: 1px solid #ddd;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        width: 100%;
        max-width: 800px; /* Optional: limit max width of the page */
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Modern Corporate Header -->
  <header class="bg-white text-black shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
      <div class="flex items-center space-x-5">
        <!-- Company Logo -->
        <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Logo" class="h-14">
        <div>
          <h1 class="text-2xl font-bold text-black">Jeng Chi Dental & Vision</h1>
          <p class="text-sm text-black opacity-90">Employee Benefits Enrollment Portal</p>
        </div>
      </div>
      <div class="flex items-center space-x-4 text-sm text-gray-600">
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
          </svg> Secure
        </span>
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-1 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"/>
          </svg> Confidential
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-6 py-12">
    
    <!-- Login Card -->
    <div id="login" class="card p-12">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-10">Employee Portal Access</h2>
      <div class="space-y-6 max-w-md mx-auto">
        <input id="username" class="w-full px-5 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="Username">
        <input id="pin" type="password" class="w-full px-5 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="PIN (Last 4 digits)">
        <button id="loginBtn" class="w-full accent text-white py-4 rounded-xl font-semibold text-lg transition hover:shadow-lg">Enter Portal</button>
        <p id="loginMsg" class="text-red-600 text-center font-medium"></p>
      </div>
    </div>

    <!-- Main App -->
    <div id="app" class="hidden space-y-10">
      
      <div class="text-center">
        <h2 class="text-4xl font-bold text-gray-800" id="empName"></h2>
        <p class="text-lg text-gray-600 mt-3">Please review the document and provide your electronic signature</p>
      </div>

      <!-- PDF Viewer (Now uses PDF.js to render all pages into the container) -->
      <div class="card overflow-hidden">
        <div class="bg-gray-100 p-4 border-b border-gray-200">
          <h3 class="font-semibold text-gray-700">Benefit Enrollment Document</h3>
        </div>
        <div id="pdfContainer" class="p-4">
          <!-- PDF pages will be rendered as <canvas> elements here -->
        </div> 
        <p id="pdfError" class="text-red-600 text-center p-4 hidden">Unable to load document.</p>
      </div>

      <!-- Signature Card -->
      <div class="card p-10">
        <h3 class="text-xl font-semibold text-gray-800 mb-6">Electronic Signature</h3>
        <div class="space-y-8">
          <input id="signerName" class="w-full px-5 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="Full Legal Name (as on ID)" required>
          
          <div class="bg-gray-50 p-6 rounded-xl">
            <canvas id="sigPad" class="w-full signature-canvas"></canvas>
            <p class="text-sm text-gray-500 mt-3 text-center">Draw your signature above</p>
          </div>

          <div class="flex gap-4">
            <button id="clearBtn" class="flex-1 border-2 border-gray-400 text-gray-700 py-4 rounded-xl font-medium hover:bg-gray-50 transition">Clear Signature</button>
            <button id="signBtn" class="flex-1 accent text-white py-4 rounded-xl font-medium transition hover:shadow-lg">Sign & Submit</button>
          </div>

          <p id="result" class="text-center text-lg font-bold min-h-6 text-indigo-700"></p>
        </div>
      </div>
    </div>
  </main>

  <script>
    // --- Configuration ---
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const FN_URL = `${SUPABASE_URL}/functions/v1/employee-benefits`;
    let empId = null, pad = null;

    // --- DOM REFERENCES ---
    const loginBtn = document.getElementById("loginBtn");
    const loginMsgEl = document.getElementById("loginMsg");
    const loginEl = document.getElementById("login");
    const appEl = document.getElementById("app");
    const empNameEl = document.getElementById("empName");
    const pdfContainerEl = document.getElementById("pdfContainer"); // New element for PDF.js
    const pdfErrorEl = document.getElementById("pdfError");
    const signerNameEl = document.getElementById("signerName");
    const canvas = document.getElementById("sigPad");
    const clearBtn = document.getElementById("clearBtn");
    const signBtn = document.getElementById("signBtn");
    const resultEl = document.getElementById("result");

    /* --- PDF.js RENDERING FUNCTION --- */
    async function loadPDF(pdfUrl) {
      // Helper to correctly append a cache-buster or other query params to a URL that might already have query params (like a Supabase signed URL)
      function appendCacheBuster(url) {
        const separator = url.includes('?') ? '&' : '?';
        return url + separator + 't=' + Date.now();
      }

      pdfContainerEl.innerHTML = ''; // Clear previous content
      pdfErrorEl.classList.add('hidden');
      
      const cacheBustedUrl = appendCacheBuster(pdfUrl);
      
      const loadingTask = pdfjsLib.getDocument(cacheBustedUrl);
      try {
        const pdf = await loadingTask.promise;
        const totalPages = pdf.numPages;
        
        for (let pageNumber = 1; pageNumber <= totalPages; pageNumber++) {
          const page = await pdf.getPage(pageNumber);
          const scale = 1.5; 
          const viewport = page.getViewport({ scale: scale });
          const canvasEl = document.createElement('canvas');
          const context = canvasEl.getContext('2d');
          
          // Set canvas dimensions
          canvasEl.height = viewport.height;
          canvasEl.width = viewport.width;
          
          pdfContainerEl.appendChild(canvasEl);
          
          // Render the page
          await page.render({
            canvasContext: context,
            viewport: viewport
          }).promise;
        }
      } catch (error) {
        console.error("Error loading PDF:", error);
        pdfErrorEl.textContent = "Error loading document (400 Bad Request). Please ensure the PDF URL is valid and accessible.";
        pdfErrorEl.classList.remove("hidden");
      }
    }


    /* --- CRITICAL FIX: SIGNATURE PAD Resizing Function --- */
    function resizeCanvas() {
        if (!canvas) return; 
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        canvas.width = canvas.offsetWidth * ratio;
        const cssHeight = 200; 
        canvas.height = cssHeight * ratio;
        canvas.getContext('2d').scale(ratio, ratio);
        if (pad) pad.clear(); 
    }
    
    // Attach resize listener globally once
    window.addEventListener('resize', resizeCanvas);


    // --- CLEAR Signature Handler ---
    function handleClearSignature() {
      if (pad) pad.clear();
      resultEl.textContent = "";
    };

    // --- SIGN and Submit Handler ---
    async function handleSubmitSignature() {
      const name = signerNameEl.value.trim();
      
      if (!pad || pad.isEmpty() || !name) {
        resultEl.textContent = "Please provide a name and signature.";
        return;
      }

      resultEl.textContent = "Processing...";
      resultEl.classList.remove('text-red-600');
      resultEl.classList.add('text-indigo-700');
      signBtn.disabled = true;

      try {
        // 1. Request Token
        const tokenRes = await fetch(`${FN_URL}/request`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ employee_id: empId })
        });
        
        if (!tokenRes.ok) {
            const errorText = await tokenRes.text();
            console.error("Token Request Error:", errorText); // Log error
            throw new Error(`Token Request failed: ${errorText}`);
        }
        
        const { token } = await tokenRes.json();
        if (!token) throw new Error("Could not get submission token.");

        // 2. Finalize Submission
        const finalRes = await fetch(`${FN_URL}/finalize`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
                token,
                signer_name: name,
                signature_data_url: pad.toDataURL("image/png") 
            })
        });

        if (!finalRes.ok) {
            const errorText = await finalRes.text();
            console.error("Finalize Request Raw Error:", errorText); // Log raw error
            try {
                const errorJson = JSON.parse(errorText);
                throw new Error(errorJson.error || `Finalize failed: ${errorText}`);
            } catch {
                throw new Error(`Finalize failed: ${errorText}`);
            }
        }
        
        const response = await finalRes.json();

        if (response.url) { 
            resultEl.textContent = "Signed successfully! Document is ready. Opening PDF in new tab...";
            
            // --- CORE CHANGE: Open signed PDF in a new tab ---
            window.open(response.url, "_blank"); 
            
            // Optionally reload the document viewer on the main page to show the signed version
            await loadPDF(response.url); 
            
            resultEl.textContent = "Signed successfully! The updated document is available in a new tab.";
        } else {
            // Log response if URL is missing for debugging
            console.error("Submission successful, but PDF URL missing in response:", response); 
            resultEl.textContent = response.error || "Submission failed with no specific PDF URL returned.";
        }
      } catch (e) {
        // Display the specific error caught from the fetch checks
        resultEl.textContent = `Error: ${e.message}`;
        resultEl.classList.remove('text-indigo-700');
        resultEl.classList.add('text-red-600');
        console.error("Submission Catch Block Error:", e); // Log final error
      } finally {
        signBtn.disabled = false;
      }
    };

    // --- LOGIN LOGIC ---
    loginBtn.onclick = async () => {
      const u = document.getElementById("username").value.trim().toUpperCase();
      const p = document.getElementById("pin").value.trim();
      
      if (!u || !p) return loginMsgEl.textContent = "Enter username and PIN";

      loginMsgEl.textContent = "Authenticating...";
      loginBtn.disabled = true;

      try {
        const { data: emp, error } = await supabase.from("employees2025")
          .select("id, first_name, last_name, pin, pdf_url").eq("username", u).single();

        if (error || !emp || emp.pin !== p) throw new Error("Invalid credentials");

        empId = emp.id;
        loginEl.classList.add("hidden");
        appEl.classList.remove("hidden");
        empNameEl.textContent = `${emp.first_name} ${emp.last_name}`;
        
        // Load PDF document using the new function
        await loadPDF(emp.pdf_url); // loadPDF handles the cache buster now

        // ** CORE FIX: Initialize Pad and attach handlers here **
        if (canvas) {
           pad = new SignaturePad(canvas, {
              backgroundColor: "white",
              penColor: "black",
              minWidth: 0.8,
              maxWidth: 2.5 
           });
           resizeCanvas(); // Call initial resize immediately
           
           // Attach button handlers now
           clearBtn.onclick = handleClearSignature;
           signBtn.onclick = handleSubmitSignature;
        }


      } catch (err) {
        loginMsgEl.textContent = err.message;
      } finally {
        loginBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
