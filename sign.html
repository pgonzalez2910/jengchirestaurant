<!doctype html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <title>Jeng Chi – Sign Enrollment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body {
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(185,150,90,.10), transparent 60%),
        radial-gradient(1000px 700px at -20% 20%, rgba(14,165,233,.08), transparent 55%),
        #F8FAFC;
    }
  </style>
</head>
<body class="h-full">
<header class="bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-5xl mx-auto px-6 py-3 flex items-center justify-between">
    <div>
      <div class="text-[11px] font-semibold tracking-widest text-amber-600 uppercase">Jeng Chi • Enrollment</div>
      <h1 class="font-serif text-2xl text-slate-900 -mt-0.5">Employee Signature Portal</h1>
    </div>
    <span class="text-sm text-slate-500">Secure</span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-6 py-6 space-y-6">
  <!-- Login -->
  <section id="loginBox" class="bg-white border rounded-2xl p-5 shadow-sm">
    <div class="grid sm:grid-cols-3 gap-3">
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Username</label>
        <input id="username" class="w-full border rounded-lg p-2" placeholder="Username" autocomplete="username">
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">PIN</label>
        <input id="pin" class="w-full border rounded-lg p-2" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password">
      </div>
      <div class="flex items-end">
        <button id="btnLogin" class="rounded-lg bg-slate-900 text-white px-4 py-2 w-full">Sign in</button>
      </div>
    </div>
    <p id="loginMsg" class="text-sm text-slate-600 mt-2"></p>
  </section>

  <!-- App -->
  <section id="app" class="hidden space-y-6">
    <div class="bg-white border rounded-2xl p-5">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-600">Welcome, <b id="empName">—</b></div>
          <div class="text-xs text-slate-500">Review your enrollment PDF and sign below.</div>
        </div>
      </div>
      <iframe id="pdf" class="w-full h-[70vh] mt-4 border rounded" title="PDF Preview"></iframe>
    </div>

    <div class="bg-white border rounded-2xl p-5">
      <div class="mb-3 text-sm text-slate-700">Type your full legal name, then draw your signature.</div>
      <input id="sigName" class="border rounded-lg p-2 w-full mb-3" placeholder="Full legal name" />
      <div class="border rounded-lg bg-slate-100">
        <!-- Shrunk from 220px to 140px -->
        <canvas id="sigPad" class="bg-white block w-full" style="height:140px"></canvas>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="btnClear" class="rounded border px-3 py-1">Clear</button>
        <button id="btnSubmit" class="rounded bg-slate-900 text-white px-4 py-1">Submit Signature</button>
      </div>
      <p id="msg" class="text-sm text-slate-700 mt-2"></p>
    </div>
  </section>
</main>

<script>
/* -------------------- CONFIG -------------------- */
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const FN_URL = `${SUPABASE_URL}/functions/v1/employee-benefits`;
const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

/* -------------------- STATE -------------------- */
let EMP = null;
let TOKEN = null;
let pad = null;
let pdfRefreshInterval = null;

/* -------------------- DOM -------------------- */
const loginBox = document.getElementById("loginBox");
const app = document.getElementById("app");
const empName = document.getElementById("empName");
const pdf = document.getElementById("pdf");
const sigName = document.getElementById("sigName");
const sigPadEl = document.getElementById("sigPad");
const btnClear = document.getElementById("btnClear");
const btnSubmit = document.getElementById("btnSubmit");
const msg = document.getElementById("msg");
const loginMsg = document.getElementById("loginMsg");
const username = document.getElementById("username");
const pin = document.getElementById("pin");
const btnLogin = document.getElementById("btnLogin");

/* -------------------- PDF LOADING -------------------- */
/* -------------------- PDF LOADING -------------------- */
async function loadPdfForEmployee(emp) {
  const t = Date.now(); // cache-buster
  if (emp.pdf_url) {
    const sep = emp.pdf_url.includes("?") ? "&" : "?";
    pdf.src = emp.pdf_url + sep + "t=" + t;
    return;
  }
  const employeeId = emp.employee_id || emp.employee_uuid; // Accept both employee_id or employee_uuid
  if (!employeeId) throw new Error("Missing employee_id for PDF generation");
  pdf.src = `${FN_URL}?employee_id=${encodeURIComponent(employeeId)}&t=${t}`; // Send the proper employee ID
}


function startPdfRefresh() {
  if (pdfRefreshInterval) clearInterval(pdfRefreshInterval);
  pdfRefreshInterval = setInterval(() => { if (EMP) loadPdfForEmployee(EMP); }, 5000);
}
function stopPdfRefresh() {
  if (pdfRefreshInterval) { clearInterval(pdfRefreshInterval); pdfRefreshInterval = null; }
}

/* -------------------- LOGIN -------------------- */
btnLogin.addEventListener("click", async () => {
  const u = username.value.trim();
  const p = pin.value.trim();
  if (!u || !p) { loginMsg.textContent = "Enter username and PIN."; return; }

  loginMsg.textContent = "Logging in…";
  btnLogin.disabled = true;

  try {
    const { data, error } = await sb.rpc("hb_login", { p_username: u, p_pin: p });
    if (error || !data?.[0]) throw new Error("Invalid credentials");

    EMP = data[0]; // { employee_id, username, full_name, email, pdf_url }
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    empName.textContent = EMP.full_name || EMP.username;

    // init signature pad
    pad = new SignaturePad(sigPadEl, { minWidth: 0.8, maxWidth: 2.0 });
    resizeCanvas();

    await loadPdfForEmployee(EMP);
    startPdfRefresh();
  } catch (e) {
    loginMsg.textContent = e.message || "Login error";
  } finally {
    btnLogin.disabled = false;
  }
});

/* -------------------- CANVAS SIZING -------------------- */
function resizeCanvas() {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  sigPadEl.width = sigPadEl.offsetWidth * ratio;
  sigPadEl.height = 140 * ratio; // keep JS height in sync with CSS
  sigPadEl.getContext("2d").scale(ratio, ratio);
  if (pad) pad.clear();
}
window.addEventListener("resize", () => {
  if (!app.classList.contains("hidden")) resizeCanvas();
});

/* -------------------- UTIL: TRIM SIGNATURE PNG -------------------- */
/* Crops transparent margins so the stroke fills its box.
   This keeps long or small signatures looking right on the PDF line. */
function getTrimmedPNG(canvas, padding = 8) {
  const w = canvas.width;
  const h = canvas.height;
  const ctx = canvas.getContext("2d");
  const img = ctx.getImageData(0, 0, w, h);
  const data = img.data;

  let minX = w, minY = h, maxX = -1, maxY = -1;

  for (let y = 0; y < h; y++) {
    for (let x = 0; x < w; x++) {
      const a = data[(y * w + x) * 4 + 3]; // alpha
      if (a > 0) {
        if (x < minX) minX = x;
        if (x > maxX) maxX = x;
        if (y < minY) minY = y;
        if (y > maxY) maxY = y;
      }
    }
  }

  if (maxX < minX || maxY < minY) return null; // empty

  minX = Math.max(minX - padding, 0);
  minY = Math.max(minY - padding, 0);
  maxX = Math.min(maxX + padding, w - 1);
  maxY = Math.min(maxY + padding, h - 1);

  const cw = maxX - minX + 1;
  const ch = maxY - minY + 1;

  const off = document.createElement("canvas");
  off.width = cw;
  off.height = ch;
  off.getContext("2d").drawImage(canvas, minX, minY, cw, ch, 0, 0, cw, ch);
  return off.toDataURL("image/png");
}

/* -------------------- SIGNATURE ACTIONS -------------------- */
btnClear.addEventListener("click", () => pad && pad.clear());

btnSubmit.addEventListener("click", async () => {
  if (!EMP || !pad || pad.isEmpty() || !sigName.value.trim()) {
    msg.textContent = "Complete name and signature.";
    return;
  }
  msg.textContent = "Creating signature request…";
  btnSubmit.disabled = true;

  try {
    // 1) Create Sign Request (get token)
    const reqRes = await fetch(`${FN_URL}/request`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({
        employee_id: EMP.employee_id,
        signer_name: sigName.value.trim(),
        signer_email: EMP.email
      })
    });
    const reqJson = await reqRes.json();
    if (!reqRes.ok) throw new Error(reqJson.error || "Request failed");
    TOKEN = reqJson.token;

    // 2) Finalize (send TRIMMED PNG)
    msg.textContent = "Submitting signature…";
    const trimmed = getTrimmedPNG(sigPadEl) || pad.toDataURL("image/png");
    const finRes = await fetch(`${FN_URL}/finalize`, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({
        token: TOKEN,
        signer_name: sigName.value.trim(),
        signature_data_url: trimmed
      })
    });
    const finJson = await finRes.json();
    if (!finRes.ok) throw new Error(finJson.error || "Finalize failed");

    msg.textContent = "Signed! Email sent to you and HR.";
    stopPdfRefresh();
    if (finJson.url) window.open(finJson.url, "_blank");
    loadPdfForEmployee(EMP); // refresh preview

  } catch (e) {
    msg.textContent = e.message || "Network error";
  } finally {
    btnSubmit.disabled = false;
  }
});
</script>
</body>
</html>

