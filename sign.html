<!doctype html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <title>Jeng Chi – Sign Enrollment</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <style>
    body{
      background:
        radial-gradient(1200px 800px at 80% -10%, rgba(185,150,90,.10), transparent 60%),
        radial-gradient(1000px 700px at -20% 20%, rgba(14,165,233,.08), transparent 55%),
        #F8FAFC;

<iframe id="pdf" class="w-full h-screen" style="border:none"></iframe>

<script>
  const params = new URLSearchParams(location.search);
  const pdfUrl = params.get('pdf');
  
  if (pdfUrl) {
    const iframe = document.getElementById('pdf');
    iframe.src = pdfUrl;
    
    // Auto-refresh every 5 seconds to show latest PDF
    setInterval(() => {
      iframe.src = pdfUrl + "?t=" + Date.now();
    }, 5000);
  }
</script>

    }
  </style>
</head>
<body class="h-full">
<header class="bg-white/90 backdrop-blur border-b border-slate-200">
  <div class="max-w-5xl mx-auto px-6 py-3 flex items-center justify-between">
    <div>
      <div class="text-[11px] font-semibold tracking-widest text-amber-600 uppercase">Jeng Chi • Enrollment</div>
      <h1 class="font-serif text-2xl text-slate-900 -mt-0.5">Employee Signature Portal</h1>
    </div>
    <span class="text-sm text-slate-500">Secure</span>
  </div>
</header>

<main class="max-w-5xl mx-auto px-6 py-6 space-y-6">
  <!-- Login -->
  <section id="loginBox" class="bg-white border rounded-2xl p-5 shadow-sm">
    <div class="grid sm:grid-cols-3 gap-3">
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">Username</label>
        <input id="username" class="w-full border rounded-lg p-2" placeholder="Username" autocomplete="username">
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-600 mb-1">PIN</label>
        <input id="pin" class="w-full border rounded-lg p-2" placeholder="PIN" type="password" inputmode="numeric" autocomplete="current-password">
      </div>
      <div class="flex items-end">
        <button id="btnLogin" class="rounded-lg bg-slate-900 text-white px-4 py-2 w-full">Sign in</button>
      </div>
    </div>
    <p id="loginMsg" class="text-sm text-slate-600 mt-2"></p>
  </section>

  <!-- App -->
  <section id="app" class="hidden space-y-6">
    <div class="bg-white border rounded-2xl p-5">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm text-slate-600">Welcome, <b id="empName">—</b></div>
          <div class="text-xs text-slate-500">Review your enrollment PDF and sign below.</div>
        </div>
      </div>
      <iframe id="pdf" class="w-full h-[70vh] mt-4 border rounded" title="PDF Preview"></iframe>
    </div>

    <div class="bg-white border rounded-2xl p-5">
      <div class="mb-3 text-sm text-slate-700">Type your full legal name, then draw your signature.</div>
      <input id="sigName" class="border rounded-lg p-2 w-full mb-3" placeholder="Full legal name" />
      <div class="border rounded-lg bg-slate-100">
        <canvas id="sigPad" class="bg-white block w-full" style="height:220px"></canvas>
      </div>
      <div class="flex gap-2 mt-2">
        <button id="btnClear" class="rounded border px-3 py-1">Clear</button>
        <button id="btnSubmit" class="rounded bg-slate-900 text-white px-4 py-1">Submit Signature</button>
      </div>
      <p id="msg" class="text-sm text-slate-700 mt-2"></p>
    </div>
  </section>
</main>

<script>
const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const FN_URL = `${SUPABASE_URL}/functions/v1/employee-benefits`;

const { createClient } = window.supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

let EMP = null;
let TOKEN = null; // Declared missing global variable
let pad = null;
let pdfRefreshInterval = null; // For the auto-refresh feature

const loginBox = document.getElementById("loginBox");
const app = document.getElementById("app");
const empName = document.getElementById("empName");
const pdf = document.getElementById("pdf");
const sigName = document.getElementById("sigName");
const sigPadEl = document.getElementById("sigPad");
const btnClear = document.getElementById("btnClear");
const btnSubmit = document.getElementById("btnSubmit");
const msg = document.getElementById("msg");
const loginMsg = document.getElementById("loginMsg");
const username = document.getElementById("username");
const pin = document.getElementById("pin");
const btnLogin = document.getElementById("btnLogin");

/**
 * Load PDF for the employee, adding a cache-buster timestamp.
 */
async function loadPdfForEmployee(emp) {
  const timestamp = Date.now(); // Cache buster

  // If login RPC already handed us a URL, use it
  if (emp.pdf_url) {
    // Add cache buster to the URL
    const sep = emp.pdf_url.includes('?') ? '&' : '?';
    pdf.src = emp.pdf_url + sep + 't=' + timestamp;
    return;
  }
  
  // Otherwise, load inline via Edge Function, with cache buster
  if (!emp.employee_id) throw new Error("Missing employee_id for PDF generation");
  pdf.src = `${FN_URL}?employee_id=${encodeURIComponent(emp.employee_id)}&t=${timestamp}`;
}

/**
 * Starts the interval timer to refresh the PDF content every 5 seconds.
 */
function startPdfRefresh() {
  if (pdfRefreshInterval) clearInterval(pdfRefreshInterval);

  pdfRefreshInterval = setInterval(() => {
    // Only refresh if the user is logged in
    if (EMP) {
      loadPdfForEmployee(EMP);
    }
  }, 5000); // Refresh every 5 seconds (5000ms)
}

// Login
btnLogin.addEventListener("click", async () => {
  const u = username.value.trim();
  const p = pin.value.trim();
  if (!u || !p) {
    loginMsg.textContent = "Enter username and PIN.";
    return;
  }

  loginMsg.textContent = "Logging in…";
  btnLogin.disabled = true;

  try {
    // RPC call to login function (assumed to return employee data)
    const { data, error } = await sb.rpc('hb_login', { p_username: u, p_pin: p });
    if (error || !data?.[0]) throw new Error("Invalid credentials");

    EMP = data[0]; // { employee_id, username, full_name, email, pdf_url }
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    empName.textContent = EMP.full_name || EMP.username;

    // Init signature pad before resize
    pad = new SignaturePad(sigPadEl, { minWidth: 0.7, maxWidth: 1.8 });
    resizeCanvas();

    // Load (or generate) their PDF
    await loadPdfForEmployee(EMP);
    
    // Start the automatic refresh timer
    startPdfRefresh();

  } catch (e) {
    // If the PDF loading failed, or login failed, report it
    loginMsg.textContent = e.message;
  } finally {
    // Always re-enable button
    btnLogin.disabled = false;
  }
});

function resizeCanvas() {
  const ratio = Math.max(window.devicePixelRatio || 1, 1);
  sigPadEl.width = sigPadEl.offsetWidth * ratio;
  sigPadEl.height = 220 * ratio;
  sigPadEl.getContext("2d").scale(ratio, ratio);
  if (pad) pad.clear();
}
window.addEventListener("resize", () => { if (!app.classList.contains("hidden")) resizeCanvas(); });

btnClear.addEventListener("click", () => pad.clear());
btnSubmit.addEventListener("click", async () => {
  if (!EMP || !pad || pad.isEmpty() || !sigName.value.trim()) {
    msg.textContent = "Complete name and signature.";
    return;
  }
  msg.textContent = "Creating signature request…";
  // Disable button during submission
  btnSubmit.disabled = true;

  try {
    // 1. Create Sign Request (to get a token)
    const reqRes = await fetch(`${FN_URL}/request`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, 
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({
        employee_id: EMP.employee_id,
        signer_name: sigName.value.trim(),
        signer_email: EMP.email
      })
    });
    const reqJson = await reqRes.json();
    if (!reqRes.ok) throw new Error(reqJson.error || "Request failed");
    
    // Store the token for use in the next step
    TOKEN = reqJson.token; 

    // 2. Finalize Signature (using the token)
    msg.textContent = "Submitting signature…";
    const dataUrl = pad.toDataURL("image/png");
    const finRes = await fetch(`${FN_URL}/finalize`, {
      method: "POST",
      headers: { 
        "Content-Type": "application/json",
        "Authorization": `Bearer ${SUPABASE_ANON_KEY}`, 
        "apikey": SUPABASE_ANON_KEY
      },
      body: JSON.stringify({
        token: TOKEN,
        signer_name: sigName.value.trim(),
        signature_data_url: dataUrl
      })
    });
    const finJson = await finRes.json();
    if (!finRes.ok) throw new Error(finJson.error || "Finalize failed");

    msg.textContent = "Signed! Email sent to you and HR.";
    if (finJson.url) window.open(finJson.url, "_blank");

    // Stop refreshing the PDF once the document is signed
    if (pdfRefreshInterval) clearInterval(pdfRefreshInterval);

  } catch (e) {
    msg.textContent = e.message || "Network error";
  } finally {
    // Re-enable button after submission attempt
    btnSubmit.disabled = false;
  }
});

</script>
</body>
</html>
