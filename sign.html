<!DOCTYPE html>
<html lang="en" class="h-full bg-gradient-to-br from-blue-50 via-gray-50 to-white">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jeng Chi â€” Employee Benefits Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7"></script>
  <style>
    .gradient-btn {
      background: linear-gradient(135deg, #1E40AF, #4F46E5);
    }
    .gradient-btn:hover {
      background: linear-gradient(135deg, #2563EB, #7C3AED);
    }
    .logo {
      width: 200px;
      margin-bottom: 2rem;
    }
    .signature-section {
      border: 2px solid #D1D5DB;
      border-radius: 12px;
      padding: 2rem;
      background-color: #F3F4F6;
    }
    .signature-canvas {
      border: 2px dashed #A5B4FC;
      border-radius: 10px;
      background-color: #ffffff;
      padding: 1rem;
    }
    .pdf-viewer {
      height: 600px;
      width: 100%;
      border: none;
    }
    .form-input {
      width: 100%;
      padding: 0.75rem;
      border: 1px solid #E5E7EB;
      border-radius: 8px;
      margin-bottom: 1rem;
      font-size: 1rem;
      background-color: #FFFFFF;
    }
    .form-button {
      width: 100%;
      padding: 1rem;
      background-color: #4F46E5;
      color: white;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      font-size: 1.125rem;
    }
    .form-button:hover {
      background-color: #2563EB;
    }
  </style>
</head>
<body class="h-full flex items-center justify-center p-6 bg-gradient-to-br from-blue-50 via-gray-50 to-white">
  <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-2xl w-full">
    <!-- HEADER -->
    <div class="text-center mb-12">
      <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Jeng Chi Logo" class="logo">
      <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
        Jeng Chi Employee Benefits Portal
      </h1>
      <p class="text-2xl font-semibold text-gray-700 mt-2">Secure Employee Benefits Portal</p>
    </div>

    <!-- LOGIN -->
    <div id="login" class="space-y-8">
      <div>
        <input id="username" class="form-input" placeholder="Username (e.g. PG)" autocomplete="username">
      </div>
      <div>
        <input id="pin" class="form-input" placeholder="PIN (last 4 digits)" type="password" inputmode="numeric" autocomplete="current-password">
      </div>
      <button id="loginBtn" class="form-button">
        Enter Portal
      </button>
      <p id="loginMsg" class="text-red-600 text-center text-xl font-medium min-h-8"></p>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden space-y-12 mt-10">
      <div class="text-center">
        <p class="text-4xl font-bold text-indigo-900" id="empName"></p>
        <p class="text-lg text-gray-600 mt-2">Welcome back! Please review and sign the document below.</p>
      </div>

      <!-- PDF VIEWER -->
      <div class="signature-section">
        <iframe id="pdf" class="pdf-viewer" title="Benefit Enrollment PDF"></iframe>
      </div>

      <!-- SIGNATURE SECTION -->
      <div class="signature-section space-y-8 mt-8">
        <input id="signerName" class="form-input" placeholder="Full Legal Name (as appears on ID)" required>

        <div class="signature-canvas">
          <canvas id="sigPad" class="w-full bg-white rounded-2xl shadow-inner" height="240"></canvas>
        </div>

        <div class="flex gap-6">
          <button id="clearBtn" class="flex-1 border-2 border-purple-600 text-purple-600 py-5 rounded-2xl text-xl font-bold hover:bg-purple-50 transition">
            Clear Signature
          </button>
          <button id="signBtn" class="flex-1 gradient-btn text-white py-5 rounded-2xl text-xl font-bold shadow-lg hover:scale-105 transition">
            Sign & Submit
          </button>
        </div>

        <p id="result" class="text-center text-3xl font-bold min-h-12"></p>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://kpldzwlftkvjjntgsqxx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
    );

    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-benefits";

    let empId = null;
    let pad = null;

    // LOGIN
    document.getElementById("loginBtn").onclick = async () => {
      const username = document.getElementById("username").value.trim().toUpperCase();
      const pin = document.getElementById("pin").value.trim();
      if (!username || !pin) return document.getElementById("loginMsg").textContent = "Please enter username and PIN";

      document.getElementById("loginMsg").textContent = "Authenticating...";

      try {
        const { data: emp, error } = await supabase
          .from("employees2025")
          .select("id, first_name, last_name, pin, pdf_url")
          .eq("username", username)
          .single();

        if (error || !emp) throw new Error("Username not found");
        if (emp.pin !== pin) throw new Error("Incorrect PIN");

        empId = emp.id;
        document.getElementById("login").classList.add("hidden");
        document.getElementById("app").classList.remove("hidden");
        document.getElementById("empName").textContent = `${emp.first_name} ${emp.last_name}`;

        // Load PDF document
        document.getElementById("pdf").src = emp.pdf_url;

        // Initialize signature pad
        pad = new SignaturePad(document.getElementById("sigPad"), {
          backgroundColor: 'rgb(255,255,255)',  // White background for better contrast
          penColor: 'rgb(0, 0, 0)'               // Black pen color for signature
        });
      } catch (err) {
        document.getElementById("loginMsg").textContent = err.message;
      }
    };

    // CLEAR Signature
    document.getElementById("clearBtn").onclick = () => {
      pad.clear();
      document.getElementById("result").textContent = "";
    };

    // SIGN and Submit
    document.getElementById("signBtn").onclick = async () => {
      const signerName = document.getElementById("signerName").value.trim();
      if (pad.isEmpty() || !signerName) {
        document.getElementById("result").textContent = "Please provide name and signature";
        return;
      }

      document.getElementById("result").textContent = "Submitting...";
      document.getElementById("signBtn").disabled = true;

      try {
        const req = await fetch(`${FN_URL}/request`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ employee_id: empId })
        });
        const { token } = await req.json();

        const fin = await fetch(`${FN_URL}/finalize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token,
            signer_name: signerName,
            signature_data_url: pad.toDataURL() // Capture the signature data as an image URL
          })
        });
        const res = await fin.json();

        document.getElementById("result").textContent = res.ok ? "SIGNED SUCCESSFULLY!" : res.error || "Submission failed";
        if (res.ok) document.getElementById("pdf").src = res.pdf_url;
      } catch (e) {
        document.getElementById("result").textContent = "Error: " + e.message;
      } finally {
        document.getElementById("signBtn").disabled = false;
      }
    };
  </script>
</body>
</html>
