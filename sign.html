<!DOCTYPE html>
<html lang="en" class="h-full bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50">
<head>
  <meta charset="utf-8">
  <title>Jeng Chi â€“ Enterprise Signature Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7"></script>
  <style>
    .gradient-btn {
      background: linear-gradient(135deg, #6366f1, #8b5cf6, #ec4899);
    }
    .gradient-btn:hover {
      background: linear-gradient(135deg, #4f46e5, #7c3aed, #db2777);
    }
  </style>
</head>
<body class="h-full flex items-center justify-center p-6 font-sans">
  <div class="bg-white rounded-3xl shadow-2xl p-12 max-w-2xl w-full">
    <!-- HEADER -->
    <div class="text-center mb-12">
      <h1 class="text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-600 to-purple-600">
        Jeng Chi
      </h1>
      <p class="text-2xl font-semibold text-gray-700 mt-2">Enterprise Signature Portal</p>
    </div>

    <!-- LOGIN -->
    <div id="login" class="space-y-8">
      <div>
        <input id="username" class="w-full px-6 py-5 border-2 border-indigo-200 rounded-2xl text-2xl focus:border-indigo-600 focus:outline-none transition" 
               placeholder="Username (e.g. PG)" autocomplete="username">
      </div>
      <div>
        <input id="pin" class="w-full px-6 py-5 border-2 border-indigo-200 rounded-2xl text-2xl focus:border-indigo-600 focus:outline-none transition" 
               placeholder="PIN (last 4 digits)" type="password" inputmode="numeric" autocomplete="current-password">
      </div>
      <button id="loginBtn" class="w-full gradient-btn text-white py-6 rounded-2xl text-2xl font-bold shadow-lg transform hover:scale-105 transition">
        Enter Portal
      </button>
      <p id="loginMsg" class="text-red-600 text-center text-xl font-medium min-h-8"></p>
    </div>

    <!-- MAIN APP -->
    <div id="app" class="hidden space-y-12 mt-10">
      <div class="text-center">
        <p class="text-4xl font-bold text-indigo-900" id="empName"></p>
        <p class="text-lg text-gray-600 mt-2">Welcome back! Please review and sign below.</p>
      </div>

      <!-- PDF VIEWER -->
      <div class="border-4 border-indigo-200 rounded-3xl overflow-hidden shadow-xl">
        <iframe id="pdf" class="w-full h-96" title="Benefit Enrollment PDF"></iframe>
      </div>

      <!-- SIGNATURE SECTION -->
      <div class="space-y-8">
        <input id="signerName" class="w-full px-6 py-5 border-2 border-purple-200 rounded-2xl text-xl focus:border-purple-600 focus:outline-none" 
               placeholder="Full Legal Name (as appears on ID)">

        <div class="border-4 border-dashed border-purple-300 rounded-3xl bg-purple-50 p-8">
          <canvas id="sigPad" class="w-full bg-white rounded-2xl shadow-inner" height="240"></canvas>
        </div>

        <div class="flex gap-6">
          <button id="clearBtn" class="flex-1 border-2 border-purple-600 text-purple-600 py-5 rounded-2xl text-xl font-bold hover:bg-purple-50 transition">
            Clear Signature
          </button>
          <button id="signBtn" class="flex-1 gradient-btn text-white py-5 rounded-2xl text-xl font-bold shadow-lg hover:scale-105 transition">
            Sign & Submit
          </button>
        </div>

        <p id="result" class="text-center text-3xl font-bold min-h-12"></p>
      </div>
    </div>
  </div>

  <script>
    const supabase = window.supabase.createClient(
      "https://kpldzwlftkvjjntgsqxx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
    );
    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-benefits";

    let empId = null;
    let pad = null;

    // LOGIN
  document.getElementById("loginBtn").onclick = async () => {
  const username = document.getElementById("username").value.trim().toUpperCase();
  const pin = document.getElementById("pin").value.trim();
  if (!username || !pin) return document.getElementById("loginMsg").textContent = "Please enter username and PIN";

  document.getElementById("loginMsg").textContent = "Authenticating...";

  try {
    const { data: emp, error } = await supabase
      .from("employees2025")
      .select("id, first_name, last_name, pin")
      .eq("username", username)  // Ensure this matches correctly
      .single();

    if (error || !emp) {
      console.error("Error:", error);
      throw new Error("Username not found");
    }

    // Check if the PIN is valid
    if (emp.pin !== pin) {
      throw new Error("Incorrect PIN");
    }

    empId = emp.id;
    document.getElementById("login").classList.add("hidden");
    document.getElementById("app").classList.remove("hidden");
    document.getElementById("empName").textContent = `${emp.first_name} ${emp.last_name}`;

    // Initialize signature pad and load the PDF
    pad = new SignaturePad(document.getElementById("sigPad"), {
      backgroundColor: 'rgb(255,255,255)',
      penColor: 'rgb(0, 0, 0)'
    });
    loadPDF();
    setInterval(loadPDF, 5000);
  } catch (err) {
    console.error("Login Error:", err);
    document.getElementById("loginMsg").textContent = err.message;
  }
};


    // PDF LOADER
    function loadPDF() {
      if (empId) {
        document.getElementById("pdf").src = `${FN_URL}?employee_id=${empId}&t=${Date.now()}`;
      }
    }

    // CLEAR
    document.getElementById("clearBtn").onclick = () => {
      pad.clear();
      document.getElementById("result").textContent = "";
    };

    // SUBMIT
    document.getElementById("signBtn").onclick = async () => {
      const signerName = document.getElementById("signerName").value.trim();
      if (pad.isEmpty() || !signerName) {
        document.getElementById("result").textContent = "Please provide name and signature";
        return;
      }

      document.getElementById("result").textContent = "Submitting...";
      document.getElementById("signBtn").disabled = true;

      try {
        // Request token
        const req = await fetch(`${FN_URL}/request`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ employee_id: empId })
        });
        const { token } = await req.json();

        // Finalize with signature
        const fin = await fetch(`${FN_URL}/finalize`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            token,
            signer_name: signerName,
            signature_data_url: pad.toDataURL()
          })
        });
        const res = await fin.json();

        document.getElementById("result").textContent = res.ok ? "SIGNED SUCCESSFULLY!" : res.error || "Submission failed";
        if (res.ok) loadPDF();
      } catch (e) {
        document.getElementById("result").textContent = "Error: " + e.message;
      } finally {
        document.getElementById("signBtn").disabled = false;
      }
    };
  </script>
</body>
</html>
