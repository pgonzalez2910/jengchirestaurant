<!DOCTYPE html>
<html lang="en" class="h-full bg-gray-50">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jeng Chi â€” Employee Benefits Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.min.js"></script>
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.4.120/pdf.worker.min.js';
  </script>
  <style>
    .navy { background-color: #2C3E50; } 
    .accent { background-color: #2980B9; } 
    .accent:hover { background-color: #1A6F97; }
    .card { background-color: white; border-radius: 1rem; box-shadow: 0px 4px 12px rgba(0,0,0,0.1); padding: 2rem; }
    .signature-canvas { height: 200px; width: 100%; border: 2px dashed #cbd5e0; border-radius: 1rem; background: #f9fafb; }
    #pdfContainer canvas { display: block; margin: 20px auto; border: 1px solid #ddd; box-shadow: 0 2px 5px rgba(0,0,0,0.1); width: 100%; max-width: 800px; }
  </style>
</head>
<body class="min-h-screen">

  <header class="bg-white text-black shadow-md">
    <div class="max-w-7xl mx-auto px-6 py-5 flex justify-between items-center">
      <div class="flex items-center space-x-5">
        <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Logo" class="h-14">
        <div>
          <h1 class="text-2xl font-bold text-black">Jeng Chi Dental & Vision</h1>
          <p class="text-sm text-black opacity-90">Employee Benefits Enrollment Portal</p>
        </div>
      </div>
      <div class="flex items-center space-x-4 text-sm text-gray-600">
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-1 text-green-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5.05 4.05a7 7 0 119.9 9.9L10 18.9l-4.95-4.95a7 7 0 010-9.9zM10 11a2 2 0 100-4 2 2 0 000 4z"/>
          </svg> Secure
        </span>
        <span class="flex items-center">
          <svg class="w-4 h-4 mr-1 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M5 9V7a5 5 0 0110 0v2a2 2 0 012 2v5a2 2 0 01-2 2H5a2 2 0 01-2-2v-5a2 2 0 012-2zm8-2v2H7V7a3 3 0 016 0z"/>
          </svg> Confidential
        </span>
      </div>
    </div>
  </header>

  <main class="max-w-5xl mx-auto px-6 py-12">
    
    <!-- Login -->
    <div id="login" class="card p-12">
      <h2 class="text-3xl font-bold text-center text-gray-800 mb-10">Employee Portal Access</h2>
      <div class="space-y-6 max-w-md mx-auto">
        <input id="username" class="w-full px-5 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="Username">
        <input id="pin" type="password" class="w-full px-5 py-4 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-600" placeholder="PIN (Last 4 digits)">
        <button id="loginBtn" class="w-full accent text-white py-4 rounded-xl font-semibold text-lg transition hover:shadow-lg">Enter Portal</button>
        <p id="loginMsg" class="text-red-600 text-center font-medium"></p>
      </div>
    </div>

    <!-- App -->
    <div id="app" class="hidden space-y-10">
      <div class="text-center">
        <h2 class="text-4xl font-bold text-gray-800" id="empName"></h2>
        <p class="text-lg text-gray-600 mt-3">Please review the document and sign below</p>
      </div>

      <!-- PDF Viewer -->
      <div class="card overflow-hidden">
        <div class="bg-gray-100 p-4 border-b border-gray-200">
          <h3 class="font-semibold text-gray-700">Benefit Enrollment Document</h3>
        </div>
        <div id="pdfContainer" class="p-4"></div>
        <p id="pdfError" class="text-red-600 text-center p-4 hidden">Unable to load document.</p>
      </div>

      <!-- ONLY SIGNATURE PAD -->
      <div class="card p-10">
        <h3 class="text-xl font-semibold text-gray-800 mb-6">Draw Your Signature</h3>
        <div class="bg-gray-50 p-6 rounded-xl">
          <canvas id="sigPad" class="signature-canvas"></canvas>
          <p class="text-sm text-gray-500 mt-3 text-center">Draw your signature above</p>
        </div>

        <div class="flex gap-4 mt-6">
          <button id="clearBtn" class="flex-1 border-2 border-gray-400 text-gray-700 py-4 rounded-xl font-medium hover:bg-gray-50 transition">Clear</button>
          <button id="signBtn" class="flex-1 accent text-white py-4 rounded-xl font-medium transition hover:shadow-lg">Sign & Submit</button>
        </div>

        <p id="result" class="text-center text-lg font-bold min-h-6 mt-4"></p>
      </div>
    </div>
  </main>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    const FN_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-signature";
    let empId = null, pad = null;

 

    const loginBtn = document.getElementById("loginBtn");
    const loginMsgEl = document.getElementById("loginMsg");
    const loginEl = document.getElementById("login");
    const appEl = document.getElementById("app");
    const empNameEl = document.getElementById("empName");
    const pdfContainerEl = document.getElementById("pdfContainer");
    const pdfErrorEl = document.getElementById("pdfError");
    const canvas = document.getElementById("sigPad");
    const clearBtn = document.getElementById("clearBtn");
    const signBtn = document.getElementById("signBtn");
    const resultEl = document.getElementById("result");

    function appendCacheBuster(url) {
      const separator = url.includes('?') ? '&' : '?';
      return url + separator + 't=' + Date.now();
    }

    async function loadPDF(pdfUrl) {
      pdfContainerEl.innerHTML = '';
      pdfErrorEl.classList.add('hidden');
      if (!pdfUrl) { pdfErrorEl.textContent = "No document available."; pdfErrorEl.classList.remove("hidden"); return; }
      try {
        const pdf = await pdfjsLib.getDocument(appendCacheBuster(pdfUrl)).promise;
        for (let i = 1; i <= pdf.numPages; i++) {
          const page = await pdf.getPage(i);
          const scale = 1.5;
          const viewport = page.getViewport({ scale });
          const canvasEl = document.createElement('canvas');
          const ctx = canvasEl.getContext('2d');
          canvasEl.height = viewport.height;
          canvasEl.width = viewport.width;
          pdfContainerEl.appendChild(canvasEl);
          await page.render({ canvasContext: ctx, viewport }).promise;
        }
      } catch (e) {
        pdfErrorEl.textContent = "Failed to load PDF.";
        pdfErrorEl.classList.remove("hidden");
      }
    }

    function resizeCanvas() {
      if (!canvas) return;
      const ratio = Math.max(window.devicePixelRatio || 1, 1);
      canvas.width = canvas.offsetWidth * ratio;
      canvas.height = 200 * ratio;
      canvas.getContext('2d').scale(ratio, ratio);
      if (pad) pad.clear();
    }
    window.addEventListener('resize', resizeCanvas);

    function handleClearSignature() {
      if (pad) pad.clear();
      resultEl.textContent = "";
    }

async function handleSubmitSignature() {
  if (!pad?.toDataURL) return alert("Draw signature");

  resultEl.textContent = "Signing...";
  signBtn.disabled = true;

  try {
    const res = await fetch(FN_URL, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        employee_id: empId,
        signature_data_url: pad.toDataURL("image/png")
      })
    });

    const data = await res.json();
    if (!data.url) throw new Error("No URL");

    resultEl.textContent = "DONE!";
    resultEl.className = "text-green-600";
    window.open(data.url, "_blank");
    loadPDF(data.url);

  } catch (e) {
    resultEl.textContent = "Error";
    resultEl.className = "text-red-600";
    console.error(e);
  } finally {
    signBtn.disabled = false;
  }
}
    loginBtn.onclick = async () => {
      const u = document.getElementById("username").value.trim().toUpperCase();
      const p = document.getElementById("pin").value.trim();
      if (!u || !p) return loginMsgEl.textContent = "Enter username and PIN";

      loginMsgEl.textContent = "Authenticating...";
      loginBtn.disabled = true;

      try {
        const { data: emp, error } = await supabase.from("employees2025")
          .select("id, first_name, last_name, pin, pdf_url").eq("username", u).single();

        if (error || !emp || emp.pin !== p) throw new Error("Invalid credentials");

        empId = emp.id;
        loginEl.classList.add("hidden");
        appEl.classList.remove("hidden");
        empNameEl.textContent = `${emp.first_name} ${emp.last_name}`;
        await loadPDF(emp.pdf_url);

        pad = new SignaturePad(canvas, {
          backgroundColor: "white",
          penColor: "black",
          minWidth: 0.8,
          maxWidth: 2.5
        });
        resizeCanvas();
        clearBtn.onclick = handleClearSignature;
        signBtn.onclick = handleSubmitSignature;

      } catch (err) {
        loginMsgEl.textContent = err.message;
      } finally {
        loginBtn.disabled = false;
      }
    };
  </script>
</body>
</html>
