<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <title>Jeng Chi - Kitchen Prep List</title>
Â  Â  <!-- Load Tailwind CSS -->
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <!-- Use Inter font from Google Fonts -->
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
Â  Â  <!-- Lucide Icons for a clean, modern look -->
Â  Â  <script src="https://unpkg.com/lucide@latest"></script>
Â  Â  <style>
Â  Â  Â  Â  body {
Â  Â  Â  Â  Â  Â  font-family: 'Inter', sans-serif;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom styles to override Tailwind for specific components */
Â  Â  Â  Â  .product-card-hover:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-5px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
Â  Â  Â  Â  }
Â  Â  Â  Â  .btn-hover:hover {
Â  Â  Â  Â  Â  Â  transform: scale(1.05);
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal {
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.5);
Â  Â  Â  Â  }
Â  Â  Â  Â  .modal-content {
Â  Â  Â  Â  Â  Â  animation: fadeIn 0.3s ease-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  @keyframes fadeIn {
Â  Â  Â  Â  Â  Â  from { opacity: 0; transform: translateY(-20px); }
Â  Â  Â  Â  Â  Â  to { opacity: 1; transform: translateY(0); }
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Hide number input spinners */
Â  Â  Â  Â  input[type="number"]::-webkit-outer-spin-button,
Â  Â  Â  Â  input[type="number"]::-webkit-inner-spin-button {
Â  Â  Â  Â  Â  Â  -webkit-appearance: none;
Â  Â  Â  Â  Â  Â  margin: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  input[type="number"] {
Â  Â  Â  Â  Â  Â  -moz-appearance: textfield;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Custom card styling for order summary */
Â  Â  Â  Â  .last-order-card {
Â  Â  Â  Â  Â  Â  background-color: #fff;
Â  Â  Â  Â  Â  Â  padding: 1.5rem;
Â  Â  Â  Â  Â  Â  border-radius: 1rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  Â  Â  margin-top: 2rem;
Â  Â  Â  Â  Â  Â  border: 1px solid #e5e7eb;
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .last-order-card:hover {
Â  Â  Â  Â  Â  Â  box-shadow: 0 6px 20px rgba(0, 0, 0, 0.1);
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-summary-title {
Â  Â  Â  Â  Â  Â  font-size: 1.25rem;
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  color: #1f2937;
Â  Â  Â  Â  Â  Â  margin-bottom: 1rem;
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-summary-list {
Â  Â  Â  Â  Â  Â  list-style: none;
Â  Â  Â  Â  Â  Â  padding: 0;
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-summary-item {
Â  Â  Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  Â  Â  justify-content: space-between;
Â  Â  Â  Â  Â  Â  padding: 0.5rem 0;
Â  Â  Â  Â  Â  Â  border-bottom: 1px solid #e5e7eb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .order-summary-item:last-child {
Â  Â  Â  Â  Â  Â  border-bottom: none;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-100 text-gray-800">

Â  Â  <div class="container mx-auto p-0 md:p-4 lg:p-6 max-w-7xl">

Â  Â  Â  Â  <!-- Header -->
Â  Â  Â  Â  <header class="bg-white p-6 md:p-8 lg:p-12 text-center rounded-b-3xl shadow-lg border-b-8 border-blue-500">
Â  Â  Â  Â  Â  Â  <img class="logo w-[323px] mx-auto mb-4 rounded-xl shadow-md transform hover:rotate-y-6 transition-transform duration-300"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
Â  Â  Â  Â  Â  Â  <h1 class="text-2xl md:text-3xl font-extrabold text-black mb-1 drop-shadow-md">JENG CHI RESTAURANT</h1>
Â  Â  Â  Â  Â  Â  <p class="text-base md:text-lg font-bold text-black mb-1 drop-shadow-md">INVENTORY MANAGEMENT APP</p>
Â  Â  Â  Â  Â  Â  <p class="text-xl md:text-2xl font-bold text-gray-700 mt-2"><b>KITCHEN PREP LIST</b></p>
Â  Â  Â  Â  </header>
Â  Â  Â  Â  <button class="logout-btn bg-red-500 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-200 btn-hover" onclick="logoutUser()">Logout</button>
function logoutUser() {
  localStorage.removeItem('userPermissions');
  window.location.assign('https://portal.jengchirestaurant.com/index.html');
}


Â  Â  Â  Â  <!-- Filter and Search Bar -->
Â  Â  Â  Â  <div id="filter-bar" class="flex flex-col md:flex-row justify-center items-center flex-wrap gap-2 md:gap-4 my-8 p-4 bg-white rounded-xl shadow-lg">
Â  Â  Â  Â  Â  Â  <!-- Julio's specific tabs will be rendered here -->
Â  Â  Â  Â  Â  Â  <button id="supermarket-tab" class="filter-btn bg-blue-500 text-white font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-200 btn-hover" onclick="loadVendorList('Supermarket')">Supermarket</button>
Â  Â  Â  Â  Â  Â  <button id="general-list-tab" class="filter-btn bg-gray-200 text-gray-700 font-semibold py-2 px-6 rounded-full shadow-md transition-all duration-200 btn-hover" onclick="loadVendorList('General List')">General List</button>
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  <div class="relative w-full md:w-auto md:flex-grow-0 md:max-w-xs flex items-center bg-gray-200 rounded-full px-4 py-2 mt-4 md:mt-0 shadow-inner">
Â  Â  Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2300/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search text-gray-500 mr-2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" placeholder="Search products..." id="search-input" class="bg-transparent outline-none w-full text-gray-800">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <!-- Main content area -->
Â  Â  Â  Â  <main id="main-content" class="p-4 md:p-6">
Â  Â  Â  Â  Â  Â  <!-- Product sections will be dynamically loaded here -->
Â  Â  Â  Â  Â  Â  <p class="text-center text-gray-500">Loading inventory...</p>
Â  Â  Â  Â  </main>
Â  Â  </div>
Â  Â Â 
Â  Â  <!-- Footer for order history -->
Â  Â  <footer id="footer-history" class="container mx-auto p-4 md:p-6 lg:p-8 max-w-7xl">
Â  Â  Â  Â  <div id="last-order-confirmation" class="mt-8"></div>
Â  Â  </footer>

Â  Â  <!-- Floating Action Buttons -->
Â  Â  <div class="fixed bottom-6 right-6 flex flex-col items-center space-y-4 z-50">
Â  Â  Â  Â  <button id="download-btn" class="download-btn bg-blue-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl btn-hover transition-all duration-200" onclick="downloadCurrentOrder()">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-download"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
Â  Â  Â  Â  </button>
Â  Â  Â  Â  <button id="submit-btn" class="submit-btn bg-green-500 text-white w-16 h-16 rounded-full shadow-lg flex items-center justify-center text-2xl btn-hover transition-all duration-200" onclick="openModal('confirm-submit', 'Confirm Submission', 'Are you sure you want to submit this order? This will reset the quantities on this list to zero.', submitInventory)">
Â  Â  Â  Â  Â  Â  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 19-3-8-3-3L2 14l19-7z"/></svg>
Â  Â  Â  Â  </button>
Â  Â  </div>

Â  Â  <!-- Modals -->
Â  Â  <div id="confirmation-modal" class="modal fixed inset-0 flex items-center justify-center p-4 z-[100] hidden">
Â  Â  Â  Â  <div class="modal-content bg-white p-8 rounded-2xl shadow-2xl max-w-md w-full text-center">
Â  Â  Â  Â  Â  Â  <h3 id="modal-title" class="text-xl font-bold mb-2"></h3>
Â  Â  Â  Â  Â  Â  <p id="modal-message" class="text-gray-600 mb-6"></p>
Â  Â  Â  Â  Â  Â  <div id="modal-icon" class="mb-6"></div>
Â  Â  Â  Â  Â  Â  <div id="modal-buttons" class="flex justify-center space-x-4">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-ok-btn" onclick="closeModal()" class="bg-blue-500 text-white px-6 py-2 rounded-full font-semibold transition-colors duration-200 hover:bg-blue-600">OK</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-cancel-btn" onclick="closeModal()" class="bg-gray-300 text-gray-800 px-6 py-2 rounded-full font-semibold transition-colors duration-200 hover:bg-gray-400">Cancel</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Image Zoom Modal -->
Â  Â  <div id="image-modal" class="fixed inset-0 flex items-center justify-center p-4 z-[90] modal hidden" onclick="this.classList.add('hidden')">
Â  Â  Â  Â  <img id="zoomed-image" class="max-w-full max-h-full object-contain rounded-lg shadow-xl" onclick="event.stopPropagation();">
Â  Â  </div>

Â  Â  <!-- Supabase Client -->
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <script>
Â  Â  Â  Â  // ðŸ”‘ Supabase credentials - IMPORTANT: Replace these with your project's details
Â  Â  Â  Â  // The URL and anonymous key are a public and non-sensitive way to connect to your Supabase project.
Â  Â  Â  Â  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
Â  Â  Â  Â  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
Â  Â  Â  Â  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Supabase Edge Function URL for sending emails. You will need to deploy this function.
Â  Â  Â  Â  // https://supabase.com/docs/guides/functions/quickstarts/resend
Â  Â  Â  Â  const RESEND_FUNCTION_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/send-email";

Â  Â  Â  Â  // Cache DOM elements
Â  Â  Â  Â  const mainContentContainer = document.getElementById("main-content");
Â  Â  Â  Â  const searchInput = document.getElementById("search-input");
Â  Â  Â  Â  const confirmationModal = document.getElementById('confirmation-modal');
Â  Â  Â  Â  const modalTitle = document.getElementById('modal-title');
Â  Â  Â  Â  const modalMessage = document.getElementById('modal-message');
Â  Â  Â  Â  const modalIcon = document.getElementById('modal-icon');
Â  Â  Â  Â  const modalOkBtn = document.getElementById('modal-ok-btn');
Â  Â  Â  Â  const modalCancelBtn = document.getElementById('modal-cancel-btn');
Â  Â  Â  Â  const imageModal = document.getElementById('image-modal');
Â  Â  Â  Â  const zoomedImage = document.getElementById('zoomed-image');
Â  Â  Â  Â  const filterBar = document.getElementById("filter-bar");
Â  Â  Â  Â  const lastOrderConfirmation = document.getElementById("last-order-confirmation");


Â  Â  Â  Â  let debounceTimer;
Â  Â  Â  Â  let products = [];
Â  Â  Â  Â  let unsubscribe = null; // To store the unsubscribe function for the real-time listener
Â  Â  Â  Â  let currentUser = 'Julio';
Â  Â  Â  Â  let currentVendorList = 'Supermarket';

Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  Â  Â  loadVendorList('Supermarket');
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Listen for changes in the search input
Â  Â  Â  Â  searchInput.addEventListener('input', (event) => {
Â  Â  Â  Â  Â  Â  const query = event.target.value.toLowerCase();
Â  Â  Â  Â  Â  Â  const filteredProducts = Object.values(products).flat().filter(p => p.product_name.toLowerCase().includes(query));
Â  Â  Â  Â  Â  Â  renderProducts(aggregateProducts(filteredProducts));
Â  Â  Â  Â  });

Â  Â  Â  Â  // Event listener for a dynamic input field that may not exist on page load
Â  Â  Â  Â  mainContentContainer.addEventListener('input', (event) => {
Â  Â  Â  Â  Â  Â  if (event.target.tagName === 'INPUT' && event.target.type === 'number') {
Â  Â  Â  Â  Â  Â  Â  Â  const productName = event.target.dataset.product_name;
Â  Â  Â  Â  Â  Â  Â  Â  if (productName) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  debounceSave(productName, event.target.value);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Opens the image zoom modal.
Â  Â  Â  Â  Â * @param {string} imageUrl - The URL of the image to display.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function zoomImage(imageUrl) {
Â  Â  Â  Â  Â  Â  zoomedImage.src = imageUrl;
Â  Â  Â  Â  Â  Â  imageModal.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Dynamically fetches unique users from the database and renders filter buttons.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function renderUserButtons() {
Â  Â  Â  Â  Â  Â  // This function is not needed in julio.html, as the tabs are hardcoded.
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Loads a specific vendor list for the user "Julio".
Â  Â  Â  Â  Â * @param {string} vendorName - 'Supermarket' or 'General List'.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function loadVendorList(vendorName) {
Â  Â  Â  Â  Â  Â  currentVendorList = vendorName;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Update active button state for vendor lists
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active', 'bg-blue-500', 'text-white'));
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.add('bg-gray-200', 'text-gray-700'));
Â  Â  Â  Â  Â  Â  const activeBtn = document.querySelector(`#${vendorName.toLowerCase().replace(' ', '-')}-tab`);
Â  Â  Â  Â  Â  Â  if (activeBtn) {
Â  Â  Â  Â  Â  Â  Â  Â  activeBtn.classList.remove('bg-gray-200', 'text-gray-700');
Â  Â  Â  Â  Â  Â  Â  Â  activeBtn.classList.add('active', 'bg-blue-500', 'text-white');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Unsubscribe from previous listener
Â  Â  Â  Â  Â  Â  if (unsubscribe) {
Â  Â  Â  Â  Â  Â  Â  Â  unsubscribe();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  mainContentContainer.innerHTML = `<p class="text-center text-gray-500 p-8">Loading inventory...</p>`;

Â  Â  Â  Â  Â  Â  // Create a query based on the selected user and vendor list
Â  Â  Â  Â  Â  Â  let query = supabaseClient.from("inventory_management").select('*').eq('user', 'Julio');

Â  Â  Â  Â  Â  Â  if (vendorName === 'Supermarket') {
Â  Â  Â  Â  Â  Â  Â  Â  query = query.eq('vendors', 'Supermarket');
Â  Â  Â  Â  Â  Â  } else if (vendorName === 'General List') {
Â  Â  Â  Â  Â  Â  Â  Â  query = query.neq('vendors', 'Supermarket');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  query = query.order('position');

Â  Â  Â  Â  Â  Â  const { data, error } = await query;
Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching initial data:", error);
Â  Â  Â  Â  Â  Â  Â  Â  mainContentContainer.innerHTML = `<p class="text-center text-red-500 p-8">Error loading inventory. Please check the console.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Aggregate the fetched data to show one product per name, with combined quantities
Â  Â  Â  Â  Â  Â  products = aggregateProducts(data);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Render the products, which will now be grouped by position
Â  Â  Â  Â  Â  Â  renderProducts(products);

Â  Â  Â  Â  Â  Â  // Subscribe to real-time changes
Â  Â  Â  Â  Â  Â  const channel = supabaseClient.channel('inventory_changes');
Â  Â  Â  Â  Â  Â  channel.on('postgres_changes', { event: '*', schema: 'public', table: 'inventory_management' }, async (payload) => {
Â  Â  Â  Â  Â  Â  Â  Â  const { new: newData, old: oldData } = payload;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const { data: updatedData, error: updateError } = await query;
Â  Â  Â  Â  Â  Â  Â  Â  if (!updateError) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  products = aggregateProducts(updatedData);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderProducts(updatedData);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }).subscribe();

Â  Â  Â  Â  Â  Â  // Store the unsubscribe function to clean up when the category changes
Â  Â  Â  Â  Â  Â  unsubscribe = () => {
Â  Â  Â  Â  Â  Â  Â  Â  supabaseClient.removeChannel(channel);
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Aggregates a list of products by name, summing the 'on_hand' quantity.
Â  Â  Â  Â  Â * @param {Array<Object>} rawProducts - The raw list of products from the database.
Â  Â  Â  Â  Â * @returns {Object} - An object with keys as positions and values as arrays of aggregated products.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function aggregateProducts(rawProducts) {
Â  Â  Â  Â  Â  Â  const aggregatedByPosition = {};
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  rawProducts.forEach(p => {
Â  Â  Â  Â  Â  Â  Â  Â  const position = p.position || 'No Position';
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!aggregatedByPosition[position]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aggregatedByPosition[position] = {};
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (!aggregatedByPosition[position][p.product_name]) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Create a new entry for a unique product name within this position group
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aggregatedByPosition[position][p.product_name] = {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  product_name: p.product_name,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  image_url: p.image_url,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vendors: p.vendors,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on_hand: p.on_hand,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  position: p.position
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Add the quantity to an existing entry for this product name and position
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  aggregatedByPosition[position][p.product_name].on_hand += p.on_hand;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // Convert the nested object structure into a more render-friendly format
Â  Â  Â  Â  Â  Â  const finalResult = {};
Â  Â  Â  Â  Â  Â  Object.keys(aggregatedByPosition).sort((a,b) => a - b).forEach(position => {
Â  Â  Â  Â  Â  Â  Â  Â  finalResult[position] = Object.values(aggregatedByPosition[position]);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  return finalResult;
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Renders product cards based on the provided data grouped by position.
Â  Â  Â  Â  Â * @param {Object} productsData - An object with keys as positions and values as arrays of aggregated products.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function renderProducts(productsData) {
Â  Â  Â  Â  Â  Â  mainContentContainer.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (Object.keys(productsData).length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  mainContentContainer.innerHTML = `<p class="text-center text-gray-500 p-8">No products found for this category.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Iterate over the positions (which are already sorted)
Â  Â  Â  Â  Â  Â  Object.keys(productsData).forEach(position => {
Â  Â  Â  Â  Â  Â  Â  Â  const positionSection = document.createElement('section');
Â  Â  Â  Â  Â  Â  Â  Â  positionSection.classList.add('py-4');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  const positionTitle = document.createElement('h2');
Â  Â  Â  Â  Â  Â  Â  Â  positionTitle.classList.add('text-2xl', 'font-bold', 'text-gray-700', 'mb-4', 'border-b-2', 'border-gray-300', 'pb-2');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Now only show the Position title, without the vendor name prefix
Â  Â  Â  Â  Â  Â  Â  Â  positionTitle.textContent = position;
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  positionSection.appendChild(positionTitle);

Â  Â  Â  Â  Â  Â  Â  Â  const productGrid = document.createElement('div');
Â  Â  Â  Â  Â  Â  Â  Â  productGrid.classList.add('grid', 'grid-cols-1', 'sm:grid-cols-2', 'md:grid-cols-3', 'lg:grid-cols-4', 'gap-6');
Â  Â  Â  Â  Â  Â  Â  Â  positionSection.appendChild(productGrid);

Â  Â  Â  Â  Â  Â  Â  Â  const productsInPosition = productsData[position];
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  productsInPosition.forEach(product => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const card = document.createElement("div");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.classList.add("bg-white", "p-6", "rounded-2xl", "shadow-md", "flex", "flex-col", "items-center", "text-center", "space-y-4", "transition-transform", "duration-200", "product-card-hover");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  card.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="cursor-pointer" onclick="zoomImage('${product.image_url || 'https://placehold.co/200x200/e5e7eb/6b7280?text=No+Image'}')">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <img src="${product.image_url || 'https://placehold.co/200x200/e5e7eb/6b7280?text=No+Image'}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â alt="${product.product_name}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="w-40 h-40 object-contain rounded-lg border border-gray-200">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-lg font-semibold text-gray-800">${product.product_name}</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex items-center justify-between w-full p-2 bg-gray-100 rounded-lg">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateQuantity('${product.product_name}', -1)"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-blue-500 text-white w-8 h-8 rounded-md flex items-center justify-center font-bold text-xl hover:bg-blue-600 transition-colors duration-200">-</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input type="number"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  data-product-name="${product.product_name}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  value="${product.on_hand > 0 ? product.on_hand : ''}"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  min="0"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="text-center w-20 bg-transparent text-xl font-medium outline-none"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  placeholder="0">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button onclick="updateQuantity('${product.product_name}', 1)"Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  class="bg-blue-500 text-white w-8 h-8 rounded-md flex items-center justify-center font-bold text-xl hover:bg-blue-600 transition-colors duration-200">+</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  productGrid.appendChild(card);
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  mainContentContainer.appendChild(positionSection);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Updates the quantity and saves it to the database.
Â  Â  Â  Â  Â * This function now updates ALL entries for a given product name, not just one.
Â  Â  Â  Â  Â * @param {string} productName - The name of the product to update.
Â  Â  Â  Â  Â * @param {number|null} change - The change in quantity (-1, 1, or null for manual input).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function updateQuantity(productName, change) {
Â  Â  Â  Â  Â  Â  // Find the product in the aggregated local state
Â  Â  Â  Â  Â  Â  const allProducts = Object.values(products).flat();
Â  Â  Â  Â  Â  Â  const product = allProducts.find(p => p.product_name === productName);
Â  Â  Â  Â  Â  Â  if (!product) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Product with name ${productName} not found.`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const input = document.querySelector(`input[data-product-name="${product.product_name}"]`);
Â  Â  Â  Â  Â  Â  if (!input) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error(`Input field not found for product name: ${product.product_name}`);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let newValue = parseFloat(input.value);
Â  Â  Â  Â  Â  Â  if (isNaN(newValue)) {
Â  Â  Â  Â  Â  Â  Â  Â  newValue = 0;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (change !== null) {
Â  Â  Â  Â  Â  Â  Â  Â  newValue = newValue + change;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (newValue < 0) {
Â  Â  Â  Â  Â  Â  Â  Â  newValue = 0;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  input.value = newValue > 0 ? newValue : '';

Â  Â  Â  Â  Â  Â  // Update the local state
Â  Â  Â  Â  Â  Â  product.on_hand = newValue;

Â  Â  Â  Â  Â  Â  // Save to Supabase
Â  Â  Â  Â  Â  Â  const { error } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from("inventory_management")
Â  Â  Â  Â  Â  Â  Â  Â  .update({ on_hand: newValue })
Â  Â  Â  Â  Â  Â  Â  Â  .eq("product_name", productName);

Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error updating quantity:", error);
Â  Â  Â  Â  Â  Â  Â  Â  openModal('error', 'Update Failed', 'An error occurred while saving your changes to the database. Check the console for more info.');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Debounces the save function to prevent excessive API calls while typing.
Â  Â  Â  Â  Â * @param {string} productName - The product name to update.
Â  Â  Â  Â  Â * @param {string} value - The input value.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function debounceSave(productName, value) {
Â  Â  Â  Â  Â  Â  clearTimeout(debounceTimer);
Â  Â  Â  Â  Â  Â  debounceTimer = setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  updateQuantity(productName, null);
Â  Â  Â  Â  Â  Â  }, 500);
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Generates and downloads a CSV file of the current order.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function downloadCurrentOrder() {
Â  Â  Â  Â  Â  Â  const productsInOrder = Object.values(products).flat().filter(p => p.on_hand > 0);
Â  Â  Â  Â  Â  Â  if (productsInOrder.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  openModal('info', 'No Items', 'There are no items in your current order to download.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  let csvContent = "data:text/csv;charset=utf-8,";
Â  Â  Â  Â  Â  Â  csvContent += "Product Name,Quantity\r\n";
Â  Â  Â  Â  Â  Â  productsInOrder.forEach(product => {
Â  Â  Â  Â  Â  Â  Â  Â  csvContent += `${product.product_name},${product.on_hand}\r\n`;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  const encodedUri = encodeURI(csvContent);
Â  Â  Â  Â  Â  Â  const link = document.createElement("a");
Â  Â  Â  Â  Â  Â  link.setAttribute("href", encodedUri);
Â  Â  Â  Â  Â  Â  link.setAttribute("download", `${currentVendorList.replace(/\s+/g, '_')}_order.csv`);
Â  Â  Â  Â  Â  Â  document.body.appendChild(link);
Â  Â  Â  Â  Â  Â  link.click();
Â  Â  Â  Â  Â  Â  document.body.removeChild(link);

Â  Â  Â  Â  Â  Â  openModal('success', 'Download Complete', 'Your order list has been downloaded as a CSV file.');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Handles the form submission by preparing data, saving it to a new Supabase table,
Â  Â  Â  Â  Â * and calling the server-side function to send an email.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function submitInventory() {
Â  Â  Â  Â  Â  Â  // Get the latest values directly from the DOM input fields before submitting
Â  Â  Â  Â  Â  Â  const allProducts = Object.values(products).flat();
Â  Â  Â  Â  Â  Â  const productsToSubmit = [];
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  allProducts.forEach(product => {
Â  Â  Â  Â  Â  Â  Â  Â  const input = document.querySelector(`input[data-product-name="${product.product_name}"]`);
Â  Â  Â  Â  Â  Â  Â  Â  if (input && parseFloat(input.value) > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  productsToSubmit.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...product,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  on_hand: parseFloat(input.value)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  if (productsToSubmit.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  openModal('info', 'No Items', 'There are no items in your current order to submit.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 1. Insert the order into the "submitted_orders" table
Â  Â  Â  Â  Â  Â  const { error: insertError } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from('submitted_orders')
Â  Â  Â  Â  Â  Â  Â  Â  .insert([
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_date: new Date().toISOString(),
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  order_details: productsToSubmit,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  vendor_list: currentVendorList
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  ]);

Â  Â  Â  Â  Â  Â  if (insertError) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error submitting order to database:", insertError);
Â  Â  Â  Â  Â  Â  Â  Â  openModal('error', 'Submission Failed', 'An error occurred while saving your order. Please check the console.');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Call the server-side Resend function to send an email
Â  Â  Â  Â  Â  Â  const emailResult = await sendEmail(productsToSubmit, currentVendorList);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Reset the "on-hand" quantity for the items on the current list
Â  Â  Â  Â  Â  Â  const productNamesToReset = productsToSubmit.map(p => p.product_name);
Â  Â  Â  Â  Â  Â  const { error: resetError } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  .from("inventory_management")
Â  Â  Â  Â  Â  Â  Â  Â  .update({ on_hand: 0 })
Â  Â  Â  Â  Â  Â  Â  Â  .in('product_name', productNamesToReset);

Â  Â  Â  Â  Â  Â  if (resetError) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Failed to reset quantities:", resetError);
Â  Â  Â  Â  Â  Â  Â  Â  // Even if reset fails, show a success modal for the submission
Â  Â  Â  Â  Â  Â  Â  Â  openModal('warning', 'Reset Failed', 'The order was submitted, but there was an error resetting quantities. Please check the console.');
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 4. Show final status
Â  Â  Â  Â  Â  Â  if (emailResult.success) {
Â  Â  Â  Â  Â  Â  Â  Â  openCustomSuccessModal('GRACIAS RONY POR COLOCAR LA ORDEN', 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  openModal('error', 'Email Failed', `Your order was submitted to the database, but the email notification failed. Cause: ${emailResult.message}`);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Sends an email using the Resend API via a Supabase Edge Function.
Â  Â  Â  Â  Â * @param {array} orderList - The list of products to order.
Â  Â  Â  Â  Â * @returns {object} - An object with a 'success' boolean and a 'message' string.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function sendEmail(orderList, vendorList) {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const htmlBody = formatOrderForEmail(orderList, vendorList);
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(RESEND_FUNCTION_URL, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: {Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Content-Type': 'application/json',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'apikey': SUPABASE_ANON_KEY,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  to: "admin@jengchirestaurant.com",
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  subject: `New Jeng Chi Inventory Order from the ${vendorList} List`,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  html: htmlBody
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }),
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const errorDetails = await response.text();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error from Supabase function:", errorDetails);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return { success: false, message: `Server responded with a non-OK status. Details: ${errorDetails}` };
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const result = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  console.log("Email sent successfully:", result);
Â  Â  Â  Â  Â  Â  Â  Â  return { success: true, message: 'Email sent successfully.' };

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Network or other error when calling Edge Function:", error);
Â  Â  Â  Â  Â  Â  Â  Â  return { success: false, message: `Network error. The app could not reach the email server. Cause: ${error.message}` };
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Formats the order details into an HTML string for the email body.
Â  Â  Â  Â  Â * @param {array} orderList - The list of products to order.
Â  Â  Â  Â  Â * @param {string} vendorList - The name of the vendor list.
Â  Â  Â  Â  Â * @returns {string} - The formatted HTML string.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function formatOrderForEmail(orderList, vendorList) {
Â  Â  Â  Â  Â  Â  let tableRows = '';
Â  Â  Â  Â  Â  Â  orderList.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  tableRows += `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd;">${item.product_name}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td style="padding: 8px; border: 1px solid #ddd;">${item.on_hand}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  return `
Â  Â  Â  Â  Â  Â  Â  Â  <div style="font-family: sans-serif; padding: 20px; color: #333; max-width: 600px; margin: auto; border: 1px solid #eee; border-radius: 8px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 style="color: #007bff;">New Jeng Chi Inventory Order</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p>A new order has been submitted for the <strong>${vendorList}</strong> list:</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table style="width:100%; border-collapse: collapse; margin-top: 20px;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr style="background-color: #f2f2f2;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Product</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th style="padding: 8px; border: 1px solid #ddd; text-align: left;">Quantity</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${tableRows}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p style="margin-top: 20px; font-size: 12px; color: #666;">This order was submitted automatically by the Inventory App.</p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Shows the confirmation modal.
Â  Â  Â  Â  Â * @param {string} type - 'success', 'error', 'warning', 'confirm-admin', 'confirm-submit'
Â  Â  Â  Â  Â * @param {string} title - The modal title.
Â  Â  Â  Â  Â * @param {string} message - The modal message.
Â  Â  Â  Â  Â * @param {Function} [onConfirm] - Callback to execute on confirmation.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function openModal(type, title, message, onConfirm) {
Â  Â  Â  Â  Â  Â  modalTitle.textContent = title;
Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  Â  Â  modalOkBtn.onclick = closeModal;
Â  Â  Â  Â  Â  Â  modalCancelBtn.style.display = 'none';

Â  Â  Â  Â  Â  Â  // Clear previous modal icon/content
Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = '';
Â  Â  Â  Â  Â  Â  modalTitle.style.display = '';
Â  Â  Â  Â  Â  Â  modalMessage.style.display = '';

Â  Â  Â  Â  Â  Â  if (type === 'success') {
Â  Â  Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-green-500"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>`;
Â  Â  Â  Â  Â  Â  } else if (type === 'error') {
Â  Â  Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-red-500"><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>`;
Â  Â  Â  Â  Â  Â  } else if (type === 'info') {
Â  Â  Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-blue-500"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4"/><path d="M12 8h.01"/></svg>`;
Â  Â  Â  Â  Â  Â  } else if (type === 'warning') {
Â  Â  Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-yellow-500"><path d="m21.73 18.27-8.94-15.02c-.89-1.5-3.13-1.5-4.02 0L2.27 18.27c-.89 1.5.23 3.32 2.01 3.32h15.44c1.78 0 2.9-1.82 2.01-3.32z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>`;
Â  Â  Â  Â  Â  Â  } else if (type.startsWith('confirm')) {
Â  Â  Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mx-auto mb-4 text-gray-500"><path d="M4 14.899A7 7 0 1 1 15.71 8h1.79a4.5 4.5 0 0 1 2.5 8.242"/><path d="M12 12v6h6"/></svg>`;
Â  Â  Â  Â  Â  Â  Â  Â  modalCancelBtn.style.display = 'block';
Â  Â  Â  Â  Â  Â  Â  Â  modalOkBtn.onclick = () => { onConfirm(); closeModal(); };
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  confirmationModal.classList.remove('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Shows a custom success modal with a specific image and message.
Â  Â  Â  Â  Â * @param {string} message - The modal message.
Â  Â  Â  Â  Â * @param {string} imageUrl - The URL of the image to display.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function openCustomSuccessModal(message) {
Â  Â  Â  Â  Â  Â  modalTitle.textContent = "Â¡Orden Completada!";
Â  Â  Â  Â  Â  Â  modalMessage.textContent = message;
Â  Â  Â  Â  Â  Â  modalOkBtn.onclick = async () => {
Â  Â  Â  Â  Â  Â  Â  Â  await resetAllQuantities();
Â  Â  Â  Â  Â  Â  Â  Â  displayLastOrder();
Â  Â  Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById("footer-history").scrollIntoView({ behavior: "smooth" });
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  modalCancelBtn.style.display = 'none';

Â  Â  Â  Â  Â  Â  // Clear previous modal icon/content and remove the image
Â  Â  Â  Â  Â  Â  modalIcon.innerHTML = '';
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  confirmationModal.classList.remove('hidden');
Â  Â  Â  Â  }
Â  Â  Â  Â Â 
Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Resets all quantities to 0 (both UI and database).
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function resetAllQuantities() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  // Reset all inputs on the page to 0
Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('input[type="number"]').forEach(input => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  input.value = 0;
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  // Reset all products in the database
Â  Â  Â  Â  Â  Â  Â  Â  const { error } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from("inventory_management")
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .update({ on_hand: 0 })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .neq('product_name', '');
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error resetting quantities:", error);
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (err) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Unexpected error resetting quantities:", err);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }


Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Hides the confirmation modal.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  confirmationModal.classList.add('hidden');
Â  Â  Â  Â  }

Â  Â  Â  Â  /**
Â  Â  Â  Â  Â * Fetches and displays the last submitted order from the database.
Â  Â  Â  Â  Â */
Â  Â  Â  Â  async function displayLastOrder() {
Â  Â  Â  Â  Â  Â  lastOrderConfirmation.innerHTML = `<p class="text-center text-gray-500 p-8">Cargando el Ãºltimo pedido...</p>`;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const { data, error } = await supabaseClient
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .from('submitted_orders')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .select('order_date, order_details, vendor_list')
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .order('order_date', { ascending: false })
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  .limit(1);

Â  Â  Â  Â  Â  Â  Â  Â  if (error) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  console.error("Error fetching last order:", error);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastOrderConfirmation.innerHTML = `<p class="text-center text-red-500 p-8">No se pudo recuperar los detalles del Ãºltimo pedido.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  if (data && data.length > 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const lastOrder = data[0];
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const orderDate = new Date(lastOrder.order_date).toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  let orderDetailsHtml = '';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastOrder.order_details.forEach(item => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderDetailsHtml += `<li class="order-summary-item"><span class="font-semibold">${item.product_name}</span><span>${item.on_hand}</span></li>`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastOrderConfirmation.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="last-order-card">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="order-summary-title">Resumen del Ãºltimo pedido</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-2"><strong>Lista del proveedor:</strong> ${lastOrder.vendor_list}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm text-gray-600 mb-4"><strong>Fecha de envÃ­o:</strong> ${orderDate}</p>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <ul class="order-summary-list">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${orderDetailsHtml}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </ul>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  lastOrderConfirmation.innerHTML = `<p class="text-center text-gray-500 p-8">No se encontraron pedidos anteriores.</p>`;
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("An unexpected error occurred:", e);
Â  Â  Â  Â  Â  Â  Â  Â  lastOrderConfirmation.innerHTML = `<p class="text-center text-red-500 p-8">OcurriÃ³ un error inesperado al recuperar el Ãºltimo pedido.</p>`;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </script>
</body>
</html>
