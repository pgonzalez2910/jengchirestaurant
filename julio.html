<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi Inventory - Julio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: "Inter", sans-serif; background:#f3f4f6; margin:0; color:#1f2937; }
    header { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:1rem 2rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:0; z-index:50; }
    .logo { display:flex; flex-direction:column; align-items:center; text-align:center; }
    .logo img { height:70px; margin-bottom:.25rem; }
    .logo h1 { font-size:1.5rem; font-weight:700; color:#3b82f6; background:linear-gradient(90deg,#2563eb,#3b82f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .logo h3 { font-size:1.2rem; font-weight:600; color:#111; }
    .app-name { font-size:.9rem; color:#6b7280; font-weight:500; }
    .filter-bar { display:flex; justify-content:center; gap:1rem; margin:1rem 0 2rem; }
    .filter-btn { padding:.5rem 1rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff; font-weight:600; cursor:pointer; transition:.2s; }
    .filter-btn.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .category-section h2 { font-size:1.25rem; font-weight:700; margin:1.5rem 0; border-bottom:2px solid #e5e7eb; padding-bottom:.25rem; color:#2563eb; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:1.5rem; }
    .product-card { background:#fff; border-radius:15px; padding:1.5rem; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; box-shadow:0 6px 12px rgba(0,0,0,0.1); transition:all .3s ease; border:1px solid #e5e7eb; }
    .product-card:hover { transform:translateY(-6px); box-shadow:0 12px 24px rgba(0,0,0,0.25), inset 0 3px 8px rgba(255,255,255,0.8); border-color:#3b82f6; }
    .product-card img { width:120px; height:120px; object-fit:contain; border-radius:12px; padding:.5rem; background:linear-gradient(145deg,#ffffff,#f0f0f0); box-shadow:0 4px 10px rgba(0,0,0,0.15), inset 0 4px 6px rgba(255,255,255,0.7); margin-bottom:.75rem; }
    .product-name { font-weight:700; font-size:1.1rem; margin-top:.5rem; background:linear-gradient(180deg,#111,#444,#000); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 1px 3px rgba(0,0,0,.2); }
    .counter { display:flex; justify-content:center; gap:.5rem; }
    .counter input { width:70px; text-align:center; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; }
    .counter button { padding:.5rem 1rem; border:none; background:#3b82f6; color:#fff; font-weight:700; border-radius:8px; cursor:pointer; }
    .counter button:hover { background:#2563eb; }
    .fab-container { position:fixed; bottom:2rem; right:2rem; }
    .submit-btn-img { width:100px; height:100px; cursor:pointer; transition:.2s; }
    .submit-btn-img:hover { transform:scale(1.1); }
    footer { max-width:1000px; margin:2rem auto; background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:none; }
    footer h2 { font-size:1.25rem; font-weight:700; margin-bottom:1rem; }
    .order-summary-list { list-style:none; padding:0; margin:0; }
    .order-summary-item { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid #e5e7eb; }
    .logout-btn-img { height:100px; margin-top:1rem; cursor:pointer; }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:2rem; border-radius:12px; max-width:400px; width:90%; text-align:center; }
  </style>
</head>
<body>
  <header>
    <div>
      <input type="date" id="order-date" class="border p-2 rounded-lg text-sm" />
    </div>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo" />
      <h1>JENG CHI RESTAURANT</h1>
      <h3>ORDER LIST</h3>
    </div>
    <div class="app-name">JENG CHI MANAGEMENT APP</div>
  </header>

  <div class="filter-bar">
    <button id="supermarket-btn" class="filter-btn active" onclick="loadInventory('Supermarket')">Supermarket</button>
    <button id="general-list-btn" class="filter-btn" onclick="loadInventory('General List')">General List</button>
  </div>

  <main class="main-container">
    <section id="inventory-list">
      <p style="text-align:center; color:#6b7280;">Cargando inventario...</p>
    </section>
  </main>

  <footer id="order-history-footer">
    <h2>Última orden enviada (<span id="footer-vendor"></span>)</h2>
    <div id="last-order-details">
      <p style="text-align:center; color:#6b7280;">Ninguna orden enviada todavía.</p>
    </div>
    <div class="logout-section" style="text-align:center;">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/logout.jpg" alt="Logout" class="logout-btn-img" onclick="logoutUser()" />
    </div>
  </footer>

  <div class="fab-container">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/submit.jpg" alt="Submit" class="submit-btn-img" onclick="submitInventory()" />
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title"></h3>
      <p id="modal-message"></p>
      <button onclick="closeModal()" style="margin-top:1rem; padding:.5rem 1rem; background:#3b82f6; color:white; border:none; border-radius:8px;">OK</button>
    </div>
  </div>

  <script>
    // ── Config
    const currentUser = "Julio";
    const TZ = "America/Chicago"; // CST/CDT
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const SEND_EMAIL_FUNCTION = "send-email";
    const SEND_TO = "admin@jengchirestaurant.com";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Build an ISO string with the correct offset for a given time zone.
    // Example output: "2025-09-01T12:34:56-05:00"
    function zonedISOWithOffset(timeZone, date = new Date()) {
      const fmt = new Intl.DateTimeFormat("en-US", {
        timeZone,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      const parts = fmt.formatToParts(date).reduce((acc, p) => (acc[p.type] = p.value, acc), {});
      const y = parts.year;
      const m = parts.month;
      const d = parts.day;
      const hh = parts.hour;
      const mm = parts.minute;
      const ss = parts.second;

      // UTC timestamp constructed as if the parts were UTC
      const millisInTz = Date.UTC(+y, +m - 1, +d, +hh, +mm, +ss);
      // Offset minutes = local(TZ) - actual(UTC)
      const offsetMin = Math.round((millisInTz - date.getTime()) / 60000);
      const sign = offsetMin >= 0 ? "-" : "+"; // Note: because millisInTz > date => TZ behind UTC (e.g., -05:00)
      const abs = Math.abs(offsetMin);
      const offHH = String(Math.floor(abs / 60)).padStart(2, "0");
      const offMM = String(abs % 60).padStart(2, "0");

      return `${y}-${m}-${d}T${hh}:${mm}:${ss}${sign}${offHH}:${offMM}`;
    }

    // Nice CST/CDT display string
    function fmtCST(value) {
      const d = typeof value === "string" ? new Date(value) : value;
      return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ, year: "numeric", month: "numeric", day: "numeric",
        hour: "numeric", minute: "2-digit"
      }).format(d);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      // Initialize date input to today in CST/CDT
      const todayCST = new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
      document.getElementById("order-date").valueAsDate = todayCST;
      await loadInventory("Supermarket");
    });

    function logoutUser() { window.location.href = "https://portal.jengchirestaurant.com/index.html"; }
    function openModal(title, message) {
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-message").textContent = message;
      document.getElementById("custom-modal").style.display = "flex";
    }
    function closeModal() { document.getElementById("custom-modal").style.display = "none"; }

    async function loadInventory(vendorList) {
      // Fix: use getElementById (no undefined vars)
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      if (vendorList === "Supermarket") {
        document.getElementById("supermarket-btn").classList.add("active");
      } else {
        document.getElementById("general-list-btn").classList.add("active");
      }

      const container = document.getElementById("inventory-list");
      container.innerHTML = "<p style='text-align:center;color:#6b7280;'>Cargando...</p>";

      let query = supabaseClient
        .from("inventory_management")
        .select("product_name,image_url,on_hand,vendors,category")
        .eq("user", currentUser);

      if (vendorList === "Supermarket") query = query.eq("vendors", "Supermarket");
      else query = query.neq("vendors", "Supermarket");

      const { data, error } = await query;
      if (error || !data) {
        container.innerHTML = "<p style='text-align:center;color:red;'>Error cargando productos.</p>";
        return;
      }

      // Group by category → single row per product
      const groupedByCategory = data.reduce((acc, item) => {
        const category = item.category || "Sin Categoría";
        acc[category] ??= {};
        const slot = acc[category][item.product_name] ??= { totalOnHand: 0, image_url: item.image_url };
        slot.totalOnHand += item.on_hand || 0;
        return acc;
      }, {});

      container.innerHTML = "";
      for (const cat of Object.keys(groupedByCategory)) {
        const sec = document.createElement("div");
        sec.className = "category-section";
        sec.innerHTML = `<h2>${cat}</h2>`;

        const grid = document.createElement("div");
        grid.className = "product-grid";

        for (const [productName, product] of Object.entries(groupedByCategory[cat])) {
          const valueAttr = Number(product.totalOnHand) > 0 ? `value="${product.totalOnHand}"` : "";
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <img src="${product.image_url || "https://placehold.co/120x120?text=IMG"}" alt="${productName}">
            <div class="product-name">${productName}</div>
            <div class="counter">
              <button onclick="updateQty('${productName.replace(/'/g, "\\'")}',-1)">-</button>
              <input id="qty-${productName}" type="number" ${valueAttr} min="0" placeholder="">
              <button onclick="updateQty('${productName.replace(/'/g, "\\'")}',1)">+</button>
            </div>
          `;
          grid.appendChild(card);
        }

        sec.appendChild(grid);
        container.appendChild(sec);
      }

      await displayLastOrder(vendorList);
    }

    async function updateQty(name, delta) {
      const input = document.getElementById(`qty-${name}`);
      const current = parseInt(input.value || "0", 10);
      let val = (isNaN(current) ? 0 : current) + delta;
      if (val < 0) val = 0;
      input.value = val === 0 ? "" : String(val); // keep empty instead of 0

      await supabaseClient.from("inventory_management")
        .update({ on_hand: val })
        .eq("product_name", name)
        .eq("user", currentUser);
    }

    async function submitInventory() {
      const products = [...document.querySelectorAll(".product-card")].map(card => {
        const name = card.querySelector(".product-name").textContent;
        const raw = card.querySelector("input").value;
        const qty = parseInt(raw || "0", 10);
        return { name, quantity: isNaN(qty) ? 0 : qty };
      }).filter(p => p.quantity > 0);

      if (!products.length) {
        openModal("Error", "No seleccionaste ningún producto.");
        return;
      }

      const vendor = document.getElementById("supermarket-btn").classList.contains("active")
        ? "Supermarket" : "General List";

      // ⏰ Create a CST/CDT timestamp string to store in DB (with proper offset)
      const orderDateCST = zonedISOWithOffset(TZ, new Date());

      // Save the whole order using the CST string
      const { error: submitError } = await supabaseClient.from("submitted_orders").insert([{
        order_date: orderDateCST,       // <-- stored as CST/CDT string (e.g., 2025-09-01T12:34:56-05:00)
        vendor_list: vendor,
        summary_details: products
      }]);
      if (submitError) {
        console.error(submitError);
        openModal("Error", "No se pudo guardar la orden.");
        return;
      }

      // Save line items also with CST/CDT timestamp
      for (const p of products) {
        await supabaseClient.from("inventory_check").insert([{
          order_date: orderDateCST,     // <-- CST/CDT string
          product_name: p.name,
          on_hand: p.quantity,
          tentative: p.quantity,
          user: currentUser
        }]);
      }

      // Reset on-hand for just the affected products
      await supabaseClient.from("inventory_management")
        .update({ on_hand: 0 })
        .in("product_name", products.map(p => p.name))
        .eq("user", currentUser);

      // 🔔 Email confirmation (show friendly CST text in body)
      try {
        await supabaseClient.functions.invoke(SEND_EMAIL_FUNCTION, {
          body: {
            to: SEND_TO,
            vendor,
            orderDate: fmtCST(orderDateCST), // human-friendly CST/CDT
            items: products
          }
        });
      } catch (e) {
        console.warn("Email error:", e);
      }

      await displayLastOrder(vendor);
      await loadInventory(vendor);
      document.getElementById("order-history-footer").scrollIntoView({ behavior: "smooth" });
      openModal("¡Éxito!", "Gracias Julio por enviar tu orden.");
    }

    async function displayLastOrder(vendor) {
  const cont = document.getElementById("last-order-details");
  const footer = document.getElementById("order-history-footer");
  document.getElementById("footer-vendor").textContent = vendor;
  cont.innerHTML = "<p>Cargando última orden...</p>";

  // 1) Try latest order for this vendor
  let { data, error } = await supabaseClient
    .from("submitted_orders")
    .select("order_date,summary_details,vendor_list")
    .eq("vendor_list", vendor)
    .order("order_date", { ascending: false })
    .limit(1);

  console.log("[submitted_orders by vendor]", { vendor, error, data });

  // If RLS blocked or some error, show it clearly and show the footer
  if (error) {
    cont.innerHTML = `<p style="color:#b91c1c;">Error al leer órdenes: ${error.message}</p>`;
    footer.style.display = "block";
    return;
  }

  // 2) If none for this vendor, fall back to latest across all vendors
  if (!data || data.length === 0) {
    const res2 = await supabaseClient
      .from("submitted_orders")
      .select("order_date,summary_details,vendor_list")
      .order("order_date", { ascending: false })
      .limit(1);
    console.log("[submitted_orders any vendor]", res2);
    if (res2.error) {
      cont.innerHTML = `<p style="color:#b91c1c;">Error al leer órdenes: ${res2.error.message}</p>`;
      footer.style.display = "block";
      return;
    }
    data = res2.data;
  }

  if (!data || data.length === 0) {
    cont.innerHTML = "<p>No hay órdenes aún.</p>";
    footer.style.display = "block";
    return;
  }

  const last = data[0];
  let details = [];
  if (Array.isArray(last.summary_details)) {
    details = last.summary_details;
  } else if (typeof last.summary_details === "string") {
    try { details = JSON.parse(last.summary_details); } catch {}
  }

  const items = details
    .map(i => `<li class="order-summary-item"><span>${i.name}</span><span>${i.quantity}</span></li>`)
    .join("");

  cont.innerHTML = `
    <p><strong>Proveedor:</strong> ${last.vendor_list ?? "(sin proveedor)"}</p>
    <p><strong>Fecha (CST/CDT):</strong> ${fmtCST(last.order_date)}</p>
    <ul class="order-summary-list">${items || "<li>(sin artículos)</li>"}</ul>
  `;
  footer.style.display = "block";
}

  </script>
</body>
</html>
