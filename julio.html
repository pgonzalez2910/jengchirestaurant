<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi Inventory - Julio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <style>
    body { font-family: "Inter", sans-serif; background:#f3f4f6; margin:0; color:#1f2937; }
    header { display:flex; justify-content:space-between; align-items:center; background:#fff; padding:1rem 2rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); position:sticky; top:0; z-index:50; }
    .logo { display:flex; flex-direction:column; align-items:center; text-align:center; }
    .logo img { height:70px; margin-bottom:.25rem; }
    .logo h1 { font-size:1.5rem; font-weight:700; color:#3b82f6; background:linear-gradient(90deg,#2563eb,#3b82f6); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
    .logo h3 { font-size:1.2rem; font-weight:600; color:#111; }
    .app-name { font-size:.9rem; color:#6b7280; font-weight:500; }
    .filter-bar { display:flex; justify-content:center; gap:1rem; margin:1rem 0 2rem; flex-wrap: wrap; }
    .filter-btn { padding:.5rem 1rem; border-radius:8px; border:1px solid #e5e7eb; background:#fff; font-weight:600; cursor:pointer; transition:.2s; }
    .filter-btn.active { background:#3b82f6; color:#fff; border-color:#3b82f6; }
    .category-section { margin-bottom: 2rem; }
    .category-section h2 { font-size:1.25rem; font-weight:700; margin:1.5rem 0; border-bottom:2px solid #e5e7eb; padding-bottom:.25rem; color:#2563eb; }
    .product-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(260px,1fr)); gap:1.5rem; }
    .product-card { background:#fff; border-radius:15px; padding:1.5rem; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; box-shadow:0 6px 12px rgba(0,0,0,0.1); transition:all .3s ease; border:1px solid #e5e7eb; }
    .product-card:hover { transform:translateY(-6px); box-shadow:0 12px 24px rgba(0,0,0,0.25), inset 0 3px 8px rgba(255,255,255,0.8); border-color:#3b82f6; }
    .product-card img { width:120px; height:120px; object-fit:contain; border-radius:12px; padding:.5rem; background:linear-gradient(145deg,#ffffff,#f0f0f0); box-shadow:0 4px 10px rgba(0,0,0,0.15), inset 0 4px 6px rgba(255,255,255,0.7); margin-bottom:.75rem; }
    .product-name { font-weight:700; font-size:1.1rem; margin-top:.5rem; background:linear-gradient(180deg,#111,#444,#000); -webkit-background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 1px 3px rgba(0,0,0,.2); }
    .counter { display:flex; justify-content:center; gap:.5rem; margin-top: 1rem; }
    .counter input { width:70px; text-align:center; padding:.5rem; border:1px solid #e5e7eb; border-radius:8px; font-size: 1rem; font-weight: 600; }
    .counter button { padding:.5rem 1rem; border:none; background:#3b82f6; color:#fff; font-weight:700; border-radius:8px; cursor:pointer; transition: all .2s; }
    .counter button:hover { background:#2563eb; transform: scale(1.05); }
    .fab-container { position:fixed; bottom:2rem; right:2rem; z-index: 9999; }
    .submit-btn-img { width:100px; height:100px; cursor:pointer; transition:.2s; }
    .submit-btn-img:hover { transform:scale(1.1); }
    footer { max-width:1000px; margin:2rem auto; background:#fff; padding:1.5rem; border-radius:12px; box-shadow:0 2px 8px rgba(0,0,0,0.1); display:none; }
    footer h2 { font-size:1.25rem; font-weight:700; margin-bottom:1rem; }
    .order-summary-list { list-style:none; padding:0; margin:0; }
    .order-summary-item { display:flex; justify-content:space-between; padding:.5rem 0; border-bottom:1px solid #e5e7eb; }
    .logout-btn-img { height:100px; margin-top:1rem; cursor:pointer; transition: all .2s; }
    .logout-btn-img:hover { transform: scale(1.05); }
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.4); justify-content:center; align-items:center; z-index: 10000; }
    .modal-content { background:#fff; padding:2rem; border-radius:12px; max-width:400px; width:90%; text-align:center; box-shadow: 0 10px 25px rgba(0,0,0,0.3); }
  </style>
</head>
<body>
  <header>
    <div>
      <input type="date" id="order-date" class="border p-2 rounded-lg text-sm" />
    </div>
    <div class="logo">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo" />
      <h1>JENG CHI RESTAURANT</h1>
      <h3>ORDER LIST - JULIO</h3>
    </div>
    <div class="app-name">JENG CHI MANAGEMENT APP</div>
  </header>

  <div class="filter-bar">
    <button id="supermarket-btn" class="filter-btn active" onclick="loadInventory('Supermarket')">
      <i class="fas fa-shopping-cart"></i> Supermarket
    </button>
    <button id="general-list-btn" class="filter-btn" onclick="loadInventory('General List')">
      <i class="fas fa-list"></i> General List
    </button>
  </div>

  <main class="main-container" style="max-width: 1400px; margin: 0 auto; padding: 0 1rem 4rem 1rem;">
    <section id="inventory-list">
      <p style="text-align:center; color:#6b7280;">Cargando inventario...</p>
    </section>
  </main>

  <footer id="order-history-footer">
    <h2>Ãšltima orden enviada (<span id="footer-vendor"></span>)</h2>
    <div id="last-order-details">
      <p style="text-align:center; color:#6b7280;">Ninguna orden enviada todavÃ­a.</p>
    </div>
    <div class="logout-section" style="text-align:center;">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/logout.jpg" alt="Logout" class="logout-btn-img" onclick="logoutUser()" />
    </div>
  </footer>

  <div class="fab-container submit-order-btn">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/submit.jpg" alt="Submit" class="submit-btn-img" onclick="submitInventory()" />
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 1rem;"></h3>
      <p id="modal-message" style="font-size: 1.125rem; color: #6b7280; margin-bottom: 1.5rem;"></p>
      <button onclick="closeModal()" style="margin-top:1rem; padding:.75rem 2rem; background:#3b82f6; color:white; border:none; border-radius:8px; font-weight: 600; cursor: pointer;">OK</button>
    </div>
  </div>

  <script>
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    // âœ… FIXED: Uses EXACT same filtering as Julio tab
    // â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    
    const currentUser = "Julio";
    const TZ = "America/Chicago"; // CST/CDT
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const SEND_EMAIL_FUNCTION = "send-email";
    const SEND_TO = "admin@jengchirestaurant.com";
    const GITHUB_IMAGE_BASE = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/';
    const DEFAULT_IMAGE = GITHUB_IMAGE_BASE + 'ys.jpg';

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let currentVendor = 'Supermarket';

    // âœ… Image resolver function (matches inventory2026.html)
    function resolveImage(imageName) {
      if (!imageName || imageName.trim() === '') return DEFAULT_IMAGE;
      const trimmed = imageName.trim();
      if (trimmed.includes('supabase.co/storage') || trimmed.startsWith('http')) {
        const parts = trimmed.split('/');
        const filename = parts[parts.length - 1].split('?')[0];
        return GITHUB_IMAGE_BASE + filename;
      }
      return GITHUB_IMAGE_BASE + trimmed;
    }

    function zonedISOWithOffset(timeZone, date = new Date()) {
      const fmt = new Intl.DateTimeFormat("en-US", {
        timeZone,
        year: "numeric", month: "2-digit", day: "2-digit",
        hour: "2-digit", minute: "2-digit", second: "2-digit",
        hour12: false
      });
      const parts = fmt.formatToParts(date).reduce((acc, p) => (acc[p.type] = p.value, acc), {});
      const y = parts.year;
      const m = parts.month;
      const d = parts.day;
      const hh = parts.hour;
      const mm = parts.minute;
      const ss = parts.second;

      const millisInTz = Date.UTC(+y, +m - 1, +d, +hh, +mm, +ss);
      const offsetMin = Math.round((millisInTz - date.getTime()) / 60000);
      const sign = offsetMin >= 0 ? "-" : "+";
      const abs = Math.abs(offsetMin);
      const offHH = String(Math.floor(abs / 60)).padStart(2, "0");
      const offMM = String(abs % 60).padStart(2, "0");

      return `${y}-${m}-${d}T${hh}:${mm}:${ss}${sign}${offHH}:${offMM}`;
    }

    function fmtCST(value) {
      const d = typeof value === "string" ? new Date(value) : value;
      return new Intl.DateTimeFormat("en-US", {
        timeZone: TZ, year: "numeric", month: "numeric", day: "numeric",
        hour: "numeric", minute: "2-digit"
      }).format(d);
    }

    document.addEventListener("DOMContentLoaded", async () => {
      const todayCST = new Date(new Date().toLocaleString("en-US", { timeZone: TZ }));
      document.getElementById("order-date").valueAsDate = todayCST;
      await loadInventory("Supermarket");
    });

    function logoutUser() { 
      window.location.href = "https://portal.jengchirestaurant.com/index.html"; 
    }
    
    function openModal(title, message) {
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-message").textContent = message;
      document.getElementById("custom-modal").style.display = "flex";
    }
    
    function closeModal() { 
      document.getElementById("custom-modal").style.display = "none"; 
    }

    // âœ… FIXED: Uses EXACT same filtering logic as Julio tab in inventory2026.html
    async function loadInventory(vendorList) {
      currentVendor = vendorList;
      
      document.querySelectorAll(".filter-btn").forEach((b) => b.classList.remove("active"));
      if (vendorList === "Supermarket") {
        document.getElementById("supermarket-btn").classList.add("active");
      } else {
        document.getElementById("general-list-btn").classList.add("active");
      }

      const container = document.getElementById("inventory-list");
      container.innerHTML = "<p style='text-align:center;color:#6b7280; font-size: 1.125rem; padding: 3rem;'><i class='fas fa-spinner fa-spin'></i> Loading products...</p>";

      // âœ… LOAD ALL PRODUCTS FIRST (same as Julio tab)
      const { data: allProducts, error } = await supabaseClient
        .from("inventory_management")
        .select("product_name, image_url, on_hand, vendors, category, assigned_to")
        .order('product_name');
      
      if (error || !allProducts) {
        container.innerHTML = "<p style='text-align:center;color:red;'>Error cargando productos.</p>";
        console.error('Load error:', error);
        return;
      }

      // âœ… FILTER FOR JULIO (case-insensitive - EXACT SAME AS JULIO TAB)
      let julioProducts = allProducts.filter(p => {
        const assigned = String(p.assigned_to || '').toLowerCase();
        return assigned.includes('julio');
      });

      console.log('Total products:', allProducts.length);
      console.log('Julio products:', julioProducts.length);

      // âœ… APPLY VENDOR FILTER
      let data = julioProducts;
      if (vendorList === "Supermarket") {
        data = data.filter(item => item.vendors === "Supermarket");
      } else {
        data = data.filter(item => item.vendors !== "Supermarket");
      }

      console.log('After vendor filter:', data.length);

      if (data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
            <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">ðŸ“¦</div>
            <h3 style="color: #6b7280; margin-bottom: 0.5rem;">No products found</h3>
            <p style="color: #9ca3af;">Try selecting a different vendor filter</p>
          </div>
        `;
        return;
      }

      // âœ… GROUP BY CATEGORY (same as original julio.html)
      const groupedByCategory = data.reduce((acc, item) => {
        const category = item.category || "Sin CategorÃ­a";
        acc[category] ??= {};
        const slot = acc[category][item.product_name] ??= { 
          totalOnHand: 0, 
          image_url: item.image_url 
        };
        slot.totalOnHand += item.on_hand || 0;
        return acc;
      }, {});

      container.innerHTML = "";
      
      const categories = Object.keys(groupedByCategory).sort();
      
      for (const cat of categories) {
        const sec = document.createElement("div");
        sec.className = "category-section";
        sec.innerHTML = `<h2><i class="fas fa-folder-open"></i> ${cat}</h2>`;

        const grid = document.createElement("div");
        grid.className = "product-grid";

        const products = Object.entries(groupedByCategory[cat]).sort((a, b) => 
          a[0].localeCompare(b[0])
        );

        for (const [productName, product] of products) {
          const imageUrl = resolveImage(product.image_url);
          const valueAttr = Number(product.totalOnHand) > 0 ? `value="${product.totalOnHand}"` : "";
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <img src="${imageUrl}" alt="${productName}" onerror="this.src='${DEFAULT_IMAGE}'">
            <div class="product-name">${productName}</div>
            <div class="counter">
              <button onclick="updateQty('${productName.replace(/'/g, "\\'")}',-1)">
                <i class="fas fa-minus"></i>
              </button>
              <input id="qty-${productName.replace(/[^a-zA-Z0-9]/g, '_')}" type="number" ${valueAttr} min="0" placeholder="0">
              <button onclick="updateQty('${productName.replace(/'/g, "\\'")}',1)">
                <i class="fas fa-plus"></i>
              </button>
            </div>
          `;
          grid.appendChild(card);
        }

        sec.appendChild(grid);
        container.appendChild(sec);
      }

      await displayLastOrder(vendorList);
    }

    async function updateQty(name, delta) {
      const sanitizedName = name.replace(/[^a-zA-Z0-9]/g, '_');
      const input = document.getElementById(`qty-${sanitizedName}`);
      if (!input) return;
      
      const current = parseInt(input.value || "0", 10);
      let val = (isNaN(current) ? 0 : current) + delta;
      if (val < 0) val = 0;
      input.value = val === 0 ? "" : String(val);

      // âœ… Update in database with case-insensitive filter
      await supabaseClient.from("inventory_management")
        .update({ on_hand: val })
        .eq("product_name", name)
        .ilike("assigned_to", "%julio%");
    }

    async function submitInventory() {
      const products = [...document.querySelectorAll(".product-card")].map(card => {
        const name = card.querySelector(".product-name").textContent;
        const raw = card.querySelector("input").value;
        const qty = parseInt(raw || "0", 10);
        return { name, quantity: isNaN(qty) ? 0 : qty };
      }).filter(p => p.quantity > 0);

      if (!products.length) {
        openModal("âš ï¸ Error", "No seleccionaste ningÃºn producto.");
        return;
      }

      const vendor = currentVendor;
      const orderDateCST = zonedISOWithOffset(TZ, new Date());

      // Save to submitted_orders
      const { error: submitError } = await supabaseClient.from("submitted_orders").insert([{
        order_date: orderDateCST,
        vendor_list: vendor,
        summary_details: products
      }]);
      
      if (submitError) {
        console.error(submitError);
        openModal("âŒ Error", "No se pudo guardar la orden.");
        return;
      }

      // Save to inventory_check
      for (const p of products) {
        await supabaseClient.from("inventory_check").insert([{
          order_date: orderDateCST,
          product_name: p.name,
          on_hand: p.quantity,
          tentative: p.quantity,
          user: "Julio"  // Use "Julio" for inventory_check
        }]);
      }

      // Reset on-hand values
      await supabaseClient.from("inventory_management")
        .update({ on_hand: 0 })
        .in("product_name", products.map(p => p.name))
        .ilike("assigned_to", "%julio%");

      // Send email
      try {
        await supabaseClient.functions.invoke(SEND_EMAIL_FUNCTION, {
          body: {
            to: SEND_TO,
            vendor,
            orderDate: fmtCST(orderDateCST),
            items: products
          }
        });
      } catch (e) {
        console.warn("Email error:", e);
      }

      await displayLastOrder(vendor);
      await loadInventory(vendor);
      document.getElementById("order-history-footer").scrollIntoView({ behavior: "smooth" });
      openModal("âœ… Â¡Ã‰xito!", "Gracias Julio por enviar tu orden.");
    }

    async function displayLastOrder(vendor) {
      const cont = document.getElementById("last-order-details");
      const footer = document.getElementById("order-history-footer");
      document.getElementById("footer-vendor").textContent = vendor;
      cont.innerHTML = "<p>Cargando Ãºltima orden...</p>";

      let { data, error } = await supabaseClient
        .from("submitted_orders")
        .select("order_date,summary_details,vendor_list")
        .eq("vendor_list", vendor)
        .order("order_date", { ascending: false })
        .limit(1);

      if (error) {
        cont.innerHTML = `<p style="color:#b91c1c;">Error: ${error.message}</p>`;
        footer.style.display = "block";
        return;
      }

      if (!data || data.length === 0) {
        const res2 = await supabaseClient
          .from("submitted_orders")
          .select("order_date,summary_details,vendor_list")
          .order("order_date", { ascending: false })
          .limit(1);
        if (res2.error) {
          cont.innerHTML = `<p style="color:#b91c1c;">Error: ${res2.error.message}</p>`;
          footer.style.display = "block";
          return;
        }
        data = res2.data;
      }

      if (!data || data.length === 0) {
        cont.innerHTML = "<p>No hay Ã³rdenes aÃºn.</p>";
        footer.style.display = "block";
        return;
      }

      const last = data[0];
      let details = [];
      if (Array.isArray(last.summary_details)) {
        details = last.summary_details;
      } else if (typeof last.summary_details === "string") {
        try { details = JSON.parse(last.summary_details); } catch {}
      }

      const items = details
        .map(i => `<li class="order-summary-item"><span>${i.name}</span><span>${i.quantity}</span></li>`)
        .join("");

      cont.innerHTML = `
        <p><strong>Proveedor:</strong> ${last.vendor_list ?? "(sin proveedor)"}</p>
        <p><strong>Fecha (CST/CDT):</strong> ${fmtCST(last.order_date)}</p>
        <ul class="order-summary-list">${items || "<li>(sin artÃ­culos)</li>"}</ul>
      `;
      footer.style.display = "block";
    }

  </script>
</body>
</html>
