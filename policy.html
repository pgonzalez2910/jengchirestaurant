<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#2D3748',
            'jc-secondary': '#4A5568',
            'jc-gold': '#744B3A',
            'jc-border': '#E2E8F0',
            'jc-danger': '#EF4444',
            'jc-green': '#059669'
          },
          boxShadow: { soft: '0 8px 30px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    [x-cloak]{display:none!important;}
    .pdf-frame { background:#fff; border:1px solid #E2E8F0; border-radius:16px; box-shadow:0 8px 30px rgba(0,0,0,.06); }
  </style>
</head>

<body class="h-full text-slate-800 font-sans">
  <!-- ===== Header ===== -->
  <header class="border-b border-jc-border bg-white/90 backdrop-blur sticky top-0 z-50">
    <div class="mx-auto w-full max-w-[1600px] px-6 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo"
             class="h-14 w-auto rounded bg-white shadow-soft object-contain"/>
        <div>
          <h1 class="font-serif-head text-[28px] leading-tight text-jc-primary">Jeng Chi</h1>
          <p class="text-sm text-slate-500 leading-none">Enterprise Portal • Executive Access</p>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <select id="sectionSelect" class="hidden lg:block rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30"></select>

        <a id="btnPdf" href="#" target="_blank"
           class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Download PDF</a>
        <a id="btnDocx" href="#" target="_blank"
           class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Download DOCX</a>
        <button id="btnPrint"
           class="rounded-xl border px-3 py-2 text-sm hover:bg-slate-50">Print</button>

        <span id="whoLabel" class="hidden text-sm text-slate-700 bg-slate-100 rounded-xl px-3 py-1"></span>
        <button id="logoutBtn" type="button" class="hidden rounded-xl border border-jc-border px-3 py-2 text-sm hover:bg-slate-50">Sign out</button>
      </div>
    </div>
  </header>

  <!-- ===== Main ===== -->
  <main class="mx-auto w-full max-w-[1600px] px-6 pt-4 pb-24">
    <!-- LOCKED placeholder -->
    <div id="lockedCard" class="h-[calc(100vh-200px)] grid place-items-center pdf-frame">
      <div class="text-center max-w-md">
        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
          <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 116 0v3z"/>
        </svg>
        <h3 class="mt-4 font-serif-head text-2xl text-jc-primary">Handbook Locked</h3>
        <p class="mt-2 text-slate-600">Use the User & Password panel to unlock the handbook.</p>
      </div>
    </div>

    <!-- PDF viewer (visible after login) -->
    <div id="viewerWrap" class="hidden">
      <iframe id="pdfFrame" class="pdf-frame w-full h-[calc(100vh-200px)]" title="Handbook PDF"></iframe>
    </div>

    <!-- Connection footer (PG/owners only) -->
    <div id="sessionBar" class="mt-3 text-xs text-slate-600 text-center hidden">
      © <span id="year"></span> Jeng Chi Restaurant — All rights reserved. Internal reference only.
      <div id="sessionInfo" class="mt-1"></div>
    </div>
  </main>

  <!-- ===== Floating Login Panel (left) ===== -->
  <aside id="loginPanel" class="fixed top-20 left-6 z-40 w-[340px]">
    <div class="bg-white border border-jc-border rounded-2xl p-5 shadow-soft">
      <h2 class="font-serif-head text-xl text-jc-primary mb-1">Editor Sign In</h2>
      <p class="text-sm text-slate-600 mb-4">Use your HR user code and password.</p>
      <div class="space-y-3">
        <div>
          <label class="block text-sm font-semibold mb-1">User</label>
          <input id="loginUser" class="w-full rounded-xl border border-jc-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="" />
        </div>
        <div>
          <label class="block text-sm font-semibold mb-1">Password</label>
          <input id="loginPass" type="password" maxlength="32" class="w-full rounded-xl border border-jc-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-jc-gold/30" placeholder="" />
        </div>
        <div class="flex items-center gap-3">
          <button id="loginBtn" class="rounded-xl px-4 py-2 text-sm bg-jc-gold text-white hover:opacity-90">Enter</button>
          <div id="loginMsg" class="text-sm"></div>
        </div>
        <p class="text-[11px] text-slate-500">No emails are collected. Your credentials come from HR’s access list.</p>
      </div>
    </div>
  </aside>

  <!-- ===== Notes Dock ===== -->
  <button id="notesFab" class="fixed right-6 bottom-6 z-40 rounded-full bg-jc-gold text-white px-4 py-2 shadow-soft">Notes</button>

  <div id="notesPanel" class="hidden fixed right-6 bottom-20 z-40 w-[360px] bg-white border border-jc-border rounded-2xl shadow-soft">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div id="notesTitle" class="font-semibold">Notes for page p.-</div>
        <div id="notesHint" class="text-xs text-slate-500"></div>
      </div>
      <button id="notesClose" class="rounded-lg border px-2 py-1 text-sm hover:bg-slate-50">Close</button>
    </div>
    <div class="max-h-[360px] overflow-y-auto divide-y" id="notesList"></div>
    <div class="p-4 space-y-2 border-t">
      <label class="text-xs font-medium">Add a note (confirm your password to save):</label>
      <textarea id="noteBody" class="w-full h-24 rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30"></textarea>
      <div class="flex gap-2">
        <input id="notePin" type="password" maxlength="32" placeholder="Password"
               class="flex-1 rounded-xl border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-gold/30">
        <button id="noteSave" class="rounded-xl px-4 py-2 text-sm bg-jc-gold text-white hover:opacity-90">Save note</button>
      </div>
      <div id="noteMsg" class="text-sm"></div>
    </div>
  </div>

  <!-- ===== Policy Acknowledgment Dock ===== -->
  <button id="ackFab" class="fixed right-6 bottom-24 z-40 rounded-full bg-slate-800 text-white px-4 py-2 shadow-soft">Acks</button>

  <div id="ackPanel" class="hidden fixed right-6 bottom-40 z-40 w-[620px] bg-white border border-jc-border rounded-2xl shadow-soft">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div class="font-semibold">Executive Policy Acknowledgment</div>
        <div class="text-xs text-slate-500">Sign each policy for the page you're viewing. Progress auto-saves.</div>
      </div>
      <button id="ackClose" class="rounded border px-2 py-1 text-sm hover:bg-slate-50">Close</button>
    </div>

    <div class="p-4 space-y-3 border-b">
      <div class="grid grid-cols-2 gap-3 text-sm">
        <div><div class="text-xs text-slate-500">Employee</div><div id="ackEmpName" class="font-medium">—</div></div>
        <div><div class="text-xs text-slate-500">User</div><div id="ackEmpInit" class="font-medium">—</div></div>
        <div><div class="text-xs text-slate-500">Position</div><div id="ackEmpPos" class="font-medium">—</div></div>
        <div><div class="text-xs text-slate-500">Department</div><div id="ackEmpDept" class="font-medium">—</div></div>
        <div><div class="text-xs text-slate-500">Session started</div><div id="ackDate" class="font-medium">—</div></div>
      </div>

      <!-- Progress -->
      <div>
        <div class="flex items-center justify-between text-xs mb-1">
          <span class="text-slate-500">Progress</span>
          <span id="ackPct" class="font-medium">0%</span>
        </div>
        <div class="h-3 bg-slate-200 rounded-full overflow-hidden">
          <div id="ackBar" class="h-3 bg-emerald-600" style="width:0%"></div>
        </div>
      </div>

      <div class="flex items-center justify-between text-xs">
        <label class="inline-flex items-center gap-2">
          <input id="followPage" type="checkbox" class="rounded" checked>
          <span>Show policies for current page only</span>
        </label>
        <div class="text-slate-500">Page <span id="ackPage">—</span></div>
      </div>
      <div id="ackMsg" class="text-sm"></div>
    </div>

    <div class="max-h-[360px] overflow-y-auto divide-y" id="ackList"></div>

    <div class="p-4 border-t flex items-center justify-between">
      <div class="text-xs text-slate-500">Saved items are tied to this session.</div>
      <button id="ackFinalize" class="rounded-xl px-3 py-2 text-sm bg-emerald-600 text-white hover:opacity-90">Finalize</button>
    </div>
  </div>

  <!-- ===== Admin History (owners only) ===== -->
  <button id="historyFab" class="hidden fixed right-6 bottom-40 z-40 rounded-full bg-slate-700 text-white px-4 py-2 shadow-soft">History</button>

  <div id="historyPanel" class="hidden fixed right-6 bottom-56 z-40 w-[560px] bg-white border border-jc-border rounded-2xl shadow-soft">
    <div class="p-4 border-b flex items-center justify-between">
      <div>
        <div class="font-semibold">Connection History</div>
        <div class="text-xs text-slate-500">Only visible to PG/owners</div>
      </div>
      <div class="flex items-center gap-2">
        <select id="histWho" class="rounded border px-2 py-1 text-sm">
          <option value="">All</option>
          <option value="JT">JT</option>
          <option value="PG">PG</option>
        </select>
        <button id="histRefresh" class="rounded border px-2 py-1 text-sm hover:bg-slate-50">Refresh</button>
        <button id="histClose" class="rounded border px-2 py-1 text-sm hover:bg-slate-50">Close</button>
      </div>
    </div>
    <div class="max-h-[420px] overflow-y-auto">
      <table class="w-full text-sm">
        <thead class="sticky top-0 bg-slate-50">
          <tr class="text-left text-slate-600">
            <th class="px-3 py-2">User</th>
            <th class="px-3 py-2">Started</th>
            <th class="px-3 py-2">Ended</th>
            <th class="px-3 py-2">Duration</th>
          </tr>
        </thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    /* ========= CONFIG ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PDF_URL  = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";
    const DOCX_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.docx";
    const PDF_VIEWER = "https://mozilla.github.io/pdf.js/web/viewer.html";

    const LOGIN_RPC = "hb_login_access";     // (p_user text, p_password text)
    const ACK_RPC   = "hb_ack_policy";       // (p_initials, p_policy_id, p_signed_initials, p_session_id, p_agreed)
    const START_RPC = "hb_start_session";
    const END_RPC   = "hb_end_session";

    const PAGE_OFFSET = 0;

    // ===== Section Index (title + starting page) =====
    const SECTION_INDEX = [
      { title:'SECTION I – INTRODUCTION', page:6 },
      { title:'1.1 WELCOME TO JENG CHI RESTAURANT', page:6 },
      { title:'1.2 EMPLOYEE HANDBOOK', page:6 },
      { title:'1.3 DISCLAIMER, EMPLOYMENT-AT-WILL & MANAGEMENT APPROVAL AUTHORITY', page:6 },
      { title:'1.4 APPROVAL AUTHORITY FOR POSITION & PAY CHANGES', page:7 },
      { title:'1.5 ADMINISTRATION AND CHANGES', page:8 },
      { title:'1.6 INTERPRETATION; DEVIATION; NO PAST-PRACTICE RIGHTS', page:8 },
      { title:'1.7 CONFLICTS WITH LAW OR OTHER DOCUMENTS', page:8 },

      { title:'SECTION II - EMPLOYMENT POLICIES', page:9 },
      { title:'2.1 EMPLOYEE CLASSIFICATIONS', page:9 },
      { title:'2.2 EEO & AMERICANS WITH DISABILITIES ACT (ADA)', page:9 },
      { title:'2.3 INTRODUCTORY PERIOD', page:10 },
      { title:'2.4 REPORTING DISCRIMINATION/HARASSMENT', page:10 },
      { title:'2.5 REQUIRED CERTIFICATIONS & PAID TRAINING', page:10 },
      { title:'2.5.1 FOOD SAFETY (FOOD HANDLER – TXDSHS)', page:10 },
      { title:'2.5.2 ALCOHOL SERVICE (TABC SELLER-SERVER)', page:11 },
      { title:'2.6 PAID TRAINING – FLSA/TWC COMPLIANCE RULES', page:11 },
      { title:'2.7 PARKING', page:11 },
      { title:'2.8 REQUIRED NOTICES AND POSTINGS', page:12 },

      { title:'SECTION III - HOURS OF WORK & PAYROLL PRACTICES', page:13 },
      { title:'3.1 PAY PERIODS & PAYDAYS (TEXAS PAYDAY LAW)', page:13 },
      { title:'3.2 WORKWEEK & HOURS OF WORK', page:13 },
      { title:'3.3 TIMEKEEPING (ALL EMPLOYEES)', page:14 },
      { title:'3.4 TIMEKEEPING: RECORD ALL TRAINING TIME ON YOUR TIMECARD', page:14 },
      { title:'3.5 TIMEKEEPING & WAGE COMPLIANCE', page:14 },
      { title:'3.6 OVERTIME (NONEXEMPT)', page:15 },
      { title:'3.7 OVERTIME FOR TIPPED EMPLOYEES (SERVERS)', page:15 },
      { title:'3.8 MEAL & REST BREAKS', page:16 },
      { title:'3.9 PAYROLL DEDUCTIONS (TEXAS PAYDAY LAW)', page:16 },
      { title:'3.10 UNIFORMS & WORK EQUIPMENT (DEDUCTIONS)', page:16 },
      { title:'3.11 WAGE GARNISHMENTS', page:17 },
      { title:'3.12 DIRECT DEPOSIT & LOST/RETURNED PAYMENTS', page:17 },
      { title:'3.13 PAY STATEMENTS & ACCESS (MYTOAST)', page:17 },
      { title:'3.14 PAYROLL QUESTIONS & DISPUTES', page:18 },
      { title:'3.15 TIPS & GRATUITIES POLICY (TEXAS)', page:18 },

      { title:'SECTION IV — STANDARDS OF CONDUCT', page:20 },
      { title:'4.1 ZERO-TOLERANCE POLICY', page:20 },
      { title:'4.2 ANTI-HARASSMENT / ANTI-DISCRIMINATION & DIVERSITY', page:21 },
      { title:'4.3 DIVERSITY & INCLUSION COMMITMENT', page:21 },
      { title:'4.4 EXAMPLES OF PROHIBITED CONDUCT', page:21 },
      { title:'4.5 SPEAK-UP & INVESTIGATION POLICY', page:22 },
      { title:'4.6 OUR INVESTIGATION', page:22 },
      { title:'4.7 ANTI-RETALIATION', page:22 },
      { title:'4.8 PROFESSIONAL BOUNDARIES & NO HORSEPLAY', page:23 },
      { title:'4.9 WORKPLACE SEARCHES & MONITORING', page:24 },
      { title:'4.10 PERSONAL CELL PHONE & EARBUD POLICY', page:25 },
      { title:'4.11 NO SMOKING / VAPING / GUM / DIPPING', page:25 },
      { title:'4.12 PERSONAL ERRANDS WHILE ON THE CLOCK', page:26 },
      { title:'4.13 EMPLOYEE BAR POLICY', page:26 },
      { title:'4.14 FOH ORDER INTEGRITY & GUEST SERVICE', page:26 },

      { title:'SECTION V - DISCIPLINE & CORRECTIVE ACTION', page:29 },
      { title:'5.1 STANDARD PROGRESSIVE PATH', page:29 },
      { title:'5.2 CROSS-POLICY PROGRESSION (NO RESET)', page:29 },
      { title:'5.3 DOCUMENTATION & TIMELINES', page:30 },
      { title:'5.4 ZERO-TOLERANCE / IMMEDIATE-TERMINATION OFFENSES', page:30 },
      { title:'5.5 ATTENDANCE & PUNCTUALITY – SPECIFIC LADDER', page:30 },
      { title:'5.6 FIGHTS, THREATS & WORKPLACE VIOLENCE', page:31 },
      { title:'5.7 DISHONESTY, THEFT & FRAUD', page:31 },
      { title:'5.8 UNPROFESSIONAL / DISRESPECTFUL CONDUCT', page:31 },
      { title:'5.9 SOCIAL MEDIA & COMMUNICATIONS', page:32 },
      { title:'5.10 DRUGS, ALCOHOL & IMPAIRMENT', page:32 },
      { title:'5.11 HARASSMENT, DISCRIMINATION & RETALIATION', page:32 },
      { title:'5.12 CORRECTIVE ACTION PLANS (CAPS)', page:32 },
      { title:'5.13 BENEFITS & PTO ON SEPARATION', page:33 },
      { title:'5.14 RESIGNATION (TWO-WEEKS’ NOTICE)', page:33 },
      { title:'5.15 COMPANY ACCEPTANCE / SCHEDULING DURING NOTICE', page:33 },
      { title:'5.16 CONDUCT DURING NOTICE', page:33 },
      { title:'5.17 JOB ABANDONMENT (NO-CALL/NO-SHOW)', page:34 },
      { title:'5.18 DISCIPLINE & CORRECTIVE ACTION (FOH: ORDER INTEGRITY & GUEST SERVICE)', page:34 },

      { title:'FMLA OVERVIEW', page:37 },
      { title:'DOCTOR’S NOTICE & MEDICAL LEAVE DOCS', page:41 },

      { title:'SECTION VIII – EMPLOYEE BENEFITS & SERVICES', page:45 },
      { title:'8.1 ELIGIBILITY & WAITING PERIOD', page:45 },
      { title:'8.2 PTO — ACCRUAL START', page:46 },
      { title:'8.3 COORDINATION WITH LEAVE & PAYROLL', page:46 },
      { title:'8.4 PAYROLL ADVANCE POLICY', page:46 },
      { title:'8.5 CONDITIONS FOR REQUESTING A PAYROLL ADVANCE', page:46 },
      { title:'8.6 EMPLOYEE MEAL', page:47 },
      { title:'8.7 WORKER COMPENSATION INSURANCE', page:48 },
      { title:'8.8 EMPLOYEE TIME OFF', page:48 },
      { title:'8.9 VACATION POLICY', page:48 },
      { title:'8.10 USE AND MANAGEMENT OF PTO', page:49 },
      { title:'8.11 REQUEST TO USE PTO', page:50 },
      { title:'8.12 PTO – FULL-TIME (≥30 HRS./WK.)', page:50 },
      { title:'8.13 REQUESTING & SCHEDULING PTO', page:52 },
      { title:'8.14 PAY & FLSA GUARDRAILS', page:52 }
    ];

    /* ========= DOM ========= */
    const yearEl = document.getElementById('year');
    const whoLabel = document.getElementById('whoLabel');
    const logoutBtn = document.getElementById('logoutBtn');

    const sectionSelect = document.getElementById('sectionSelect');
    const btnPdf = document.getElementById('btnPdf');
    const btnDocx = document.getElementById('btnDocx');
    const btnPrint = document.getElementById('btnPrint');

    const lockedCard = document.getElementById('lockedCard');
    const viewerWrap = document.getElementById('viewerWrap');
    const pdfFrame = document.getElementById('pdfFrame');

    // login
    const loginPanel = document.getElementById('loginPanel');
    const loginUser = document.getElementById('loginUser');
    const loginPass = document.getElementById('loginPass');
    const loginBtn  = document.getElementById('loginBtn');
    const loginMsg  = document.getElementById('loginMsg');

    const sessionBar = document.getElementById('sessionBar');
    const sessionInfo = document.getElementById('sessionInfo');

    // Notes
    const notesFab   = document.getElementById('notesFab');
    const notesPanel = document.getElementById('notesPanel');
    const notesClose = document.getElementById('notesClose');
    const notesTitle = document.getElementById('notesTitle');
    const notesHint  = document.getElementById('notesHint');
    const notesList  = document.getElementById('notesList');
    const noteBody   = document.getElementById('noteBody');
    const notePin    = document.getElementById('notePin');
    const noteSave   = document.getElementById('noteSave');
    const noteMsg    = document.getElementById('noteMsg');

    // Acks
    const ackFab   = document.getElementById('ackFab');
    const ackPanel = document.getElementById('ackPanel');
    const ackClose = document.getElementById('ackClose');
    const ackEmpName = document.getElementById('ackEmpName');
    const ackEmpInit = document.getElementById('ackEmpInit');
    const ackEmpPos  = document.getElementById('ackEmpPos');
    const ackEmpDept = document.getElementById('ackEmpDept');
    const ackDate    = document.getElementById('ackDate');
    const ackList    = document.getElementById('ackList');
    const followPage = document.getElementById('followPage');
    const ackMsg     = document.getElementById('ackMsg');
    const ackPage    = document.getElementById('ackPage');
    const ackBar     = document.getElementById('ackBar');
    const ackPct     = document.getElementById('ackPct');
    const ackFinalize= document.getElementById('ackFinalize');

    // History
    const historyFab   = document.getElementById('historyFab');
    const historyPanel = document.getElementById('historyPanel');
    const histClose    = document.getElementById('histClose');
    const histRefresh  = document.getElementById('histRefresh');
    const histWho      = document.getElementById('histWho');
    const histBody     = document.getElementById('histBody');

    /* ========= State ========= */
    yearEl && (yearEl.textContent = new Date().getFullYear());
    let session = null;          // { user, employee_name, position, department, is_owner }
    let currentPage = 6;
    let currentSectionTitle = 'SECTION I – INTRODUCTION';
    let sessionId = null;        // bigint from hb_start_session
    let sessionStartedAt = null; // ISO string
    let sessionTimer = null;

    // ack state
    let ackPolicies = [];        // current list (filtered)
    let totalPolicies = 0;       // active policies overall
    let serverDoneCount = 0;     // best-effort pull from server
    const localKey = (user)=>`hb_ack_state_${user}`;
    const savedLocally = ()=> {
      try{ return JSON.parse(localStorage.getItem(localKey(session?.user||''))||'{}'); }catch{ return {}; }
    };
    const setSavedLocally = (map)=>{
      try{ localStorage.setItem(localKey(session.user), JSON.stringify(map||{})); }catch{}
    };

    /* ========= Utils ========= */
    const show = el => el.classList.remove('hidden');
    const hide = el => el.classList.add('hidden');
    const toast = (el, msg, ok=false)=>{
      el.textContent = msg;
      el.className = `text-sm ${ok ? 'text-green-700' : 'text-jc-danger'}`;
      setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 3500);
    };
    const pad2 = n => String(n).padStart(2,'0');

    function buildSectionSelect(){
      sectionSelect.innerHTML = '';
      const opt0 = document.createElement('option');
      opt0.textContent = 'Jump to…';
      opt0.value = '';
      sectionSelect.appendChild(opt0);
      SECTION_INDEX.forEach(s=>{
        const o = document.createElement('option');
        o.value = String(s.page);
        o.textContent = `${s.title} (p.${s.page})`;
        sectionSelect.appendChild(o);
      });
    }

    function pdfSrcFor(page){
      const p = page + PAGE_OFFSET;
      return `${PDF_VIEWER}?file=${encodeURIComponent(PDF_URL)}#page=${p}&zoom=page-width&pagemode=none`;
    }

    function goToPage(page, title=''){
      currentPage = page;
      currentSectionTitle = title || (SECTION_INDEX.find(s=>s.page===page)?.title || '');
      pdfFrame.src = pdfSrcFor(page);
      updateNotesHeader();
      if (followPage.checked) loadPoliciesForPage();
    }

    function setSession(s){
      session = s;
      if(s){
        localStorage.setItem('hb_session', JSON.stringify(s));
        whoLabel.textContent = `Logged in: ${s.user}`;
        show(whoLabel); show(logoutBtn);
        show(sectionSelect);
        btnPdf.href = PDF_URL; btnDocx.href = DOCX_URL;

        hide(lockedCard); show(viewerWrap);
        hide(loginPanel);

        goToPage(currentPage, currentSectionTitle);

        if (s.is_owner) { show(sessionBar); show(historyFab); } 
        else { hide(sessionBar); hide(historyFab); hide(historyPanel); }
      }else{
        localStorage.removeItem('hb_session');
        hide(whoLabel); hide(logoutBtn);
        hide(sectionSelect);
        show(lockedCard); hide(viewerWrap);
        show(loginPanel);
        hide(sessionBar); hide(historyFab); hide(historyPanel);
        if (pdfFrame) pdfFrame.src = '';
        stopSessionTimer();
        sessionInfo.textContent = '';
      }
    }

    function restoreSession(){
      try{
        const raw = localStorage.getItem('hb_session');
        const sid = localStorage.getItem('hb_session_id');
        const sStart = localStorage.getItem('hb_session_started_at');
        if(raw){
          setSession(JSON.parse(raw));
          if(sid && sStart){ sessionId = Number(sid); sessionStartedAt = sStart; startSessionTimer(); }
        }else{
          setSession(null);
        }
      }catch{ setSession(null); }
    }

    /* ========= Session footer (owners) ========= */
    function startSessionTimer(){
      if(!sessionStartedAt){ sessionStartedAt = new Date().toISOString(); }
      renderSessionInfo();
      stopSessionTimer();
      sessionTimer = setInterval(renderSessionInfo, 1000);
    }
    function stopSessionTimer(){
      if(sessionTimer){ clearInterval(sessionTimer); sessionTimer = null; }
    }
    function renderSessionInfo(){
      if(!session || !session.is_owner || !sessionStartedAt){ sessionInfo.textContent = ''; return; }
      const started = new Date(sessionStartedAt);
      const elapsed = Date.now() - started.getTime();
      const hrs = Math.floor(elapsed/3600000);
      const mins = Math.floor((elapsed%3600000)/60000);
      const secs = Math.floor((elapsed%60000)/1000);
      sessionInfo.textContent = `${session.user} connected at ${started.toLocaleString()} • duration ${pad2(hrs)}:${pad2(mins)}:${pad2(secs)}`;
    }

    async function startRemoteSession(user){
      try{
        const { data, error } = await client.rpc(START_RPC, { p_initials: user });
        if(error) { console.warn('hb_start_session error', error); }
        sessionId = data || sessionId;
        sessionStartedAt = new Date().toISOString();
        localStorage.setItem('hb_session_id', String(sessionId || ''));
        localStorage.setItem('hb_session_started_at', sessionStartedAt);
        startSessionTimer();
      }catch(e){ console.warn('start session threw', e); }
    }
    async function endRemoteSession(){
      try{
        const sid = Number(localStorage.getItem('hb_session_id') || sessionId || 0);
        if(sid){ await client.rpc(END_RPC, { p_session_id: sid }); }
      }catch(e){ console.warn('hb_end_session error', e); }
      finally{
        localStorage.removeItem('hb_session_id');
        localStorage.removeItem('hb_session_started_at');
        sessionId = null; sessionStartedAt = null;
        stopSessionTimer();
      }
    }
    window.addEventListener('beforeunload', ()=>{ endRemoteSession(); });

    /* ========= Auth ========= */
    async function doLogin(){
      const user = (loginUser.value || '').trim().toUpperCase();
      const pass = (loginPass.value || '').trim();
      if(!user || !pass){ toast(loginMsg, 'Enter user and password.'); return; }

      try{
        const { data: rows, error } = await client.rpc(LOGIN_RPC, { p_user: user, p_password: pass });
        if(error){ toast(loginMsg, error.message); return; }
        if(!rows || rows.length === 0){ toast(loginMsg, 'Invalid user or password.'); return; }

        const row = rows[0] || {};
        const is_owner = !!row.is_owner;
        setSession({
          user,
          employee_name: row.employee_name || '',
          position: row.position || '',
          department: row.department || '',
          is_owner
        });
        toast(loginMsg, 'Unlocked.', true);

        await startRemoteSession(user);
        await loadAckContext();
        ackPanel.classList.remove('hidden');
      }catch(e){
        toast(loginMsg, 'Login error.'); console.error(e);
      }
    }

    loginBtn.addEventListener('click', doLogin);
    loginPass.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doLogin(); } });

    logoutBtn.addEventListener('click', async () => {
      await endRemoteSession();
      setSession(null);
    });

    /* ========= Top bar ========= */
    sectionSelect.addEventListener('change', (e)=>{
      const v = Number(e.target.value || '0');
      if(!v) return;
      const sec = SECTION_INDEX.find(s=>s.page===v);
      goToPage(v, sec?.title||'');
    });

    btnPrint.addEventListener('click', ()=>{
      const url = `${PDF_VIEWER}?file=${encodeURIComponent(PDF_URL)}#page=${currentPage}&zoom=page-width&pagemode=none`;
      window.open(url, '_blank');
    });

    /* ========= Notes ========= */
    function updateNotesHeader(){
      notesTitle.textContent = `Notes for page p.${currentPage}`;
      notesHint.textContent  = currentSectionTitle || '';
      loadNotesForPage(currentPage);
    }
    function renderNotes(list){
      notesList.innerHTML = '';
      if(!list || list.length === 0){
        const div = document.createElement('div');
        div.className = 'p-4 text-sm text-slate-500';
        div.textContent = 'No notes on this page yet.';
        notesList.appendChild(div);
        return;
      }
      list.forEach(n=>{
        const row = document.createElement('div');
        row.className = 'p-4 text-sm space-y-1';
        const head = document.createElement('div');
        head.className = 'flex items-center justify-between';
        head.innerHTML = `
          <div class="text-xs text-slate-500">${n.author_initials} • ${new Date(n.created_at).toLocaleString()}</div>
          <button data-id="${n.id}" class="resolveBtn text-xs rounded border px-2 py-1 ${n.resolved ? 'bg-green-50 border-green-200' : 'hover:bg-slate-50'}">
            ${n.resolved ? 'Open' : 'Mark resolved'}
          </button>
        `;
        const body = document.createElement('div');
        body.textContent = n.body;
        row.appendChild(head); row.appendChild(body);
        notesList.appendChild(row);
      });
      [...notesList.querySelectorAll('.resolveBtn')].forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = Number(btn.getAttribute('data-id'));
          const pin = prompt('Enter password to toggle resolve:') || '';
          if(!session || !pin) return;
          try{
            await client.rpc('hb_resolve_note', { p_initials: session.user, p_pin: pin, p_id: id, p_resolved: true });
          }catch(e){ console.warn(e); }
          loadNotesForPage(currentPage);
        });
      });
    }
    async function loadNotesForPage(page){
      try{
        const { data, error } = await client.from('hb_notes')
            .select('*').eq('page', page).order('created_at', { ascending: false });
        if(error){ console.error(error); return; }
        renderNotes(data || []);
      }catch(e){ console.warn(e); }
    }
    notesFab.addEventListener('click', ()=>{ notesPanel.classList.toggle('hidden'); updateNotesHeader(); });
    notesClose.addEventListener('click', ()=> notesPanel.classList.add('hidden'));
    noteSave.addEventListener('click', async ()=>{
      if(!session){ noteMsg.textContent = 'Login first.'; return; }
      const body = (noteBody.value || '').trim();
      const pin  = (notePin.value || '').trim();
      if(!body || !pin){ toast(noteMsg,'Write a note and enter password.'); return; }
      const sel = sectionSelect.options[sectionSelect.selectedIndex];
      const sectionLabel = sel && sel.value ? sel.textContent : '';
      try{
        const { error } = await client.rpc('hb_add_note', {
          p_initials: session.user,
          p_pin: pin,
          p_page: currentPage,
          p_section: sectionLabel,
          p_body: body
        });
        if(error){ throw error; }
        noteBody.value=''; notePin.value='';
        toast(noteMsg, 'Saved.', true);
        loadNotesForPage(currentPage);
      }catch(e){ toast(noteMsg, e.message||'Save failed'); }
    });

    /* ========= Policy Acknowledgment ========= */
    function rowSavedMap(){ return savedLocally(); }

    function policyRow(p, savedNow){
      const saved = !!savedNow[p.id];
      return `
        <div class="p-3">
          <div class="flex items-start gap-3">
            <div class="flex-1">
              <div class="font-medium text-sm">${p.code ? p.code + ' — ' : ''}${p.title}</div>
              <div class="text-[11px] text-slate-500">Policy ID: ${p.id} • Page ${p.page}</div>
            </div>
            <div class="w-44">
              <input data-pid="${p.id}" data-role="sig" class="w-full rounded-lg border border-jc-border px-2 py-1 text-sm" placeholder="initials" value="${session?.user||''}">
            </div>
            <div>
              <button data-pid="${p.id}" data-role="save" class="rounded-lg px-3 py-1 text-sm ${saved ? 'bg-emerald-600 text-white' : 'bg-slate-800 text-white'}">
                ${saved ? 'Saved' : 'Save'}
              </button>
            </div>
          </div>
        </div>
      `;
    }

    function renderAckList(){
      ackPage.textContent = currentPage;
      ackList.innerHTML = '';
      const map = rowSavedMap();
      if(!ackPolicies.length){
        ackList.innerHTML = `<div class="p-4 text-sm text-slate-500">No active policies for page p.${currentPage}.</div>`;
        updateProgressUI();
        return;
      }
      ackPolicies.forEach(p=>{
        const row = document.createElement('div');
        row.innerHTML = policyRow(p, map);
        ackList.appendChild(row);
      });
      // Bind buttons
      [...ackList.querySelectorAll('button[data-role="save"]')].forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const pid = Number(btn.getAttribute('data-pid'));
          const sig = (ackList.querySelector(`input[data-role="sig"][data-pid="${pid}"]`)?.value || '').trim().toUpperCase();
          if(!sig){ toast(ackMsg,'Enter initials next to the policy.'); return; }
          try{
            const { error } = await client.rpc(ACK_RPC, {
              p_initials: session.user,
              p_policy_id: pid,
              p_signed_initials: sig,
              p_session_id: sessionId || null,
              p_agreed: true
            });
            if(error){ throw error; }
            const map = rowSavedMap(); map[pid] = true; setSavedLocally(map);
            btn.textContent = 'Saved'; btn.className = 'rounded-lg px-3 py-1 text-sm bg-emerald-600 text-white';
            updateProgressUI(true);
          }catch(e){ toast(ackMsg, e.message || 'Save failed'); }
        });
      });
      updateProgressUI();
    }

    async function loadAckContext(){
      if(!session) return;

      // Fill employee card
      ackEmpName.textContent = session.employee_name || '—';
      ackEmpInit.textContent = session.user || '—';
      ackEmpPos.textContent  = session.position || '—';
      ackEmpDept.textContent = session.department || '—';
      if(sessionStartedAt){ ackDate.textContent = new Date(sessionStartedAt).toLocaleString(); }

      // Count total active policies (for progress denominator)
      try{
        const { count } = await client.from('hb_policies')
          .select('id', { count: 'exact', head: true })
          .eq('is_active', true);
        totalPolicies = count || 0;
      }catch{ totalPolicies = 0; }

      // Try to pull already-saved count from a view/table if present
      try{
        // Adjust these names to your actual view if different
        const { count } = await client
          .from('hb_ack_latest')                // OPTIONAL view: (initials, policy_id, agreed)
          .select('policy_id', { count:'exact', head:true })
          .eq('initials', session.user)
          .eq('agreed', true);
        serverDoneCount = count || 0;
      }catch{ serverDoneCount = 0; }

      await loadPoliciesForPage();
    }

    async function loadPoliciesForPage(){
      try{
        const base = client.from('hb_policies')
          .select('id,code,title,page,sort_order')
          .eq('is_active', true);
        const { data, error } = followPage.checked
          ? await base.eq('page', currentPage).order('sort_order', {ascending:true})
          : await base.order('page', {ascending:true}).order('sort_order', {ascending:true});
        if(error){ throw error; }
        ackPolicies = data || [];
        renderAckList();
      }catch(e){
        ackPolicies = [];
        renderAckList();
        toast(ackMsg, e.message || 'Failed to load policies');
      }
    }

    function updateProgressUI(incrementLocal=false){
      const saved = rowSavedMap();
      const localCount = Object.keys(saved).length;
      const best = Math.max(serverDoneCount, localCount);
      const denom = Math.max(totalPolicies, best);
      const pct = denom ? Math.round((best/denom)*100) : 0;
      ackBar.style.width = `${pct}%`;
      ackPct.textContent = `${pct}%`;
    }

    ackFab.addEventListener('click', ()=>{ ackPanel.classList.toggle('hidden'); if(!ackPanel.classList.contains('hidden')) loadAckContext(); });
    ackClose.addEventListener('click', ()=> ackPanel.classList.add('hidden'));
    followPage.addEventListener('change', loadPoliciesForPage);

    ackFinalize.addEventListener('click', async ()=>{
      if(!session){ toast(ackMsg, 'Login first.'); return; }
      try{
        const { error } = await client.from('hb_ack_forms').insert({
          initials: session.user,
          session_id: sessionId || null,
          pdf_url: null
        });
        if(error) { throw error; }
        toast(ackMsg, 'Finalized. Admin will be notified.', true);
      }catch(e){
        toast(ackMsg, 'Finalize failed.'); console.error(e);
      }
    });

    /* ========= Admin History (owners only) ========= */
    function fmtDur(startISO, endISO){
      const start = new Date(startISO).getTime();
      const end = endISO ? new Date(endISO).getTime() : Date.now();
      const d = Math.max(0, end - start);
      const h = Math.floor(d/3600000);
      const m = Math.floor((d%3600000)/60000);
      const s = Math.floor((d%60000)/1000);
      return `${pad2(h)}:${pad2(m)}:${pad2(s)}${endISO?'':' (live)'}`;
    }
    function renderHistory(rows){
      histBody.innerHTML = '';
      if(!rows || rows.length === 0){
        histBody.innerHTML = `<tr><td colspan="4" class="px-3 py-3 text-center text-slate-500">No sessions found.</td></tr>`;
        return;
      }
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.className = 'border-b last:border-b-0';
        tr.innerHTML = `
          <td class="px-3 py-2">${r.initials}</td>
          <td class="px-3 py-2">${new Date(r.started_at).toLocaleString()}</td>
          <td class="px-3 py-2">${r.ended_at ? new Date(r.ended_at).toLocaleString() : ''}</td>
          <td class="px-3 py-2">${fmtDur(r.started_at, r.ended_at)}</td>
        `;
        histBody.appendChild(tr);
      });
    }
    async function loadHistory(){
      const who = (histWho.value || '').toUpperCase();
      try{
        let q = client.from('hb_sessions').select('*').order('started_at',{ascending:false}).limit(200);
        if(who){ q = q.eq('initials', who); }
        const { data, error } = await q;
        if(error){ throw error; }
        renderHistory(data || []);
      }catch(e){ console.warn(e); }
    }
    historyFab.addEventListener('click', ()=>{ if(!session?.is_owner) return; historyPanel.classList.toggle('hidden'); if(!historyPanel.classList.contains('hidden')) loadHistory(); });
    histClose.addEventListener('click', ()=> historyPanel.classList.add('hidden'));
    histRefresh.addEventListener('click', loadHistory);
    histWho.addEventListener('change', loadHistory);

    /* ========= Init ========= */
    (function init(){
      buildSectionSelect();
      btnPdf.href = PDF_URL;
      btnDocx.href = DOCX_URL;

      restoreSession();
      if(localStorage.getItem('hb_session')){ loadAckContext(); }
    })();

    // Safety: quiet unhandled promise rejections in console
    window.addEventListener('unhandledrejection', (e)=>{ console.warn('[UNHANDLED]', e.reason); });
  </script>
</body>
</html>

