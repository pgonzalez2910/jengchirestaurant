<!DOCTYPE html>
<html lang="en" class="h-full bg-[#f5f6f5]">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi Employee Benefits Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .accent-gold { background: linear-gradient(135deg, #FFD700, #FFB300); color: #1a1a1a; }
        .accent-gold:hover { background: linear-gradient(135deg, #FFCA28, #FFA000); }
        .spinner { border: 4px solid #e0e0e0; border-top: 4px solid #FFD700; border-radius: 50%; width: 40px; height: 40px; animation: spin .8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0); } 100% { transform: rotate(360deg); } }
        .modal-bg { background: rgba(0,0,0,0.5); }
        @media print { #dashboard, #loginScreen, #spinnerOverlay, #feedbackModal, #userModal { display: none !important; } #printView { display: block !important; } .print-iframe { page-break-after: always; } iframe { width: 100%; height: 95vh; border: none; } }
        .transition-all { transition: all 0.3s ease; }
        .section-header { font-weight: 600; letter-spacing: 1px; color: #1a1a1a; }
        .card { background: #ffffff; border: 1px solid #e0e0e0; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .input-focus { transition: all 0.3s ease; }
        .input-focus:focus { border-color: #FFD700; box-shadow: 0 0 0 3px rgba(255,215,0,0.2); }
        .btn-icon { display: inline-flex; align-items: center; gap: 8px; }
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .glossy-logo { filter: brightness(1.1) contrast(1.2); transition: filter 0.3s ease; }
        .glossy-logo:hover { filter: brightness(1.2) contrast(1.3); }
    </style>
</head>
<body class="min-h-screen">
    <div id="spinnerOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-white rounded-2xl p-8 flex flex-col items-center card">
            <div class="spinner mb-4"></div>
            <p class="text-gray-700 font-medium text-lg">Processing...</p>
        </div>
    </div>
    <div id="feedbackModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-white rounded-2xl card w-full max-w-lg p-8 fade-in">
            <h3 id="feedbackModalTitle" class="text-2xl font-semibold mb-4 text-gray-900 section-header"></h3>
            <p id="feedbackModalMessage" class="text-gray-600 mb-6"></p>
            <textarea id="feedbackModalPromptInput" class="hidden border border-gray-300 bg-gray-50 w-full p-3 rounded-lg text-sm h-32 resize-none input-focus" placeholder="Enter selection..."></textarea>
            <div id="feedbackModalButtons" class="flex justify-end gap-4"></div>
        </div>
    </div>
    <div id="loginScreen" class="flex flex-col items-center justify-center h-screen bg-[#f5f6f5]">
        <div class="bg-white rounded-2xl card p-10 w-full max-w-md text-center fade-in">
            <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="mx-auto w-40 mb-6 glossy-logo" alt="Jeng Chi Logo" />
            <h2 class="text-3xl font-bold mb-8 text-gray-900 section-header">Benefits Enrollment Portal</h2>
            <input id="username" type="text" placeholder="Username (e.g., PG)" class="border border-gray-300 bg-gray-50 w-full p-4 rounded-lg mb-6 text-base input-focus" />
            <input id="pin" type="password" placeholder="PIN" class="border border-gray-300 bg-gray-50 w-full p-4 rounded-lg mb-8 text-base input-focus" />
            <button id="loginBtn" class="w-full accent-gold font-semibold py-4 rounded-lg card hover:shadow-xl transition-all btn-icon">
                <i class="fas fa-sign-in-alt"></i> Sign In
            </button>
            <p id="loginError" class="text-red-500 text-sm mt-4 hidden"></p>
        </div>
    </div>
    <div id="dashboard" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-12">
        <header class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 pb-6 mb-10">
            <div class="flex items-center gap-6 mb-6 sm:mb-0">
                <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="w-16 glossy-logo" alt="Jeng Chi Logo" />
                <div>
                    <h1 class="text-3xl font-bold text-gray-900 section-header">Jeng Chi Benefits Portal</h1>
                    <p id="portalRole" class="text-base text-gray-600 mt-2"></p>
                </div>
            </div>
            <div class="flex items-center gap-6">
                <div id="printContainer" class="relative hidden">
                    <button id="printMenuBtn" class="p-3 rounded-lg bg-gray-100 hover:bg-gray-200 flex items-center gap-3 transition-all btn-icon" title="Print Options">
                        <i class="fas fa-print"></i> <span class="hidden sm:inline text-gray-700">Print</span>
                    </button>
                    <div id="printMenu" class="hidden absolute right-0 mt-3 bg-white border border-gray-200 rounded-xl card z-40 w-64 overflow-hidden">
                        <button id="printAll" class="block w-full text-left px-6 py-3 text-base text-gray-700 hover:bg-gray-100 transition-all">Print All Documents</button>
                        <button id="printByEmployee" class="block w-full text-left px-6 py-3 text-base text-gray-700 hover:bg-gray-100 transition-all">Print by Employee</button>
                    </div>
                </div>
                <button id="logoutBtn" class="accent-gold px-8 py-3 rounded-lg card transition-all btn-icon">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>
        <nav class="flex gap-4 mb-10 overflow-x-auto">
            <button id="tabDocs" class="px-6 py-3 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium whitespace-nowrap transition-all text-gray-700 btn-icon">
                <i class="fas fa-file-alt"></i> Signed Documents
            </button>
            <button id="tabSummary" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium whitespace-nowrap hidden transition-all text-gray-700 btn-icon">
                <i class="fas fa-chart-bar"></i> Benefit Summary
            </button>
            <button id="tabUsers" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium whitespace-nowrap hidden transition-all text-gray-700 btn-icon">
                <i class="fas fa-users"></i> Authorized Users
            </button>
            <button id="tabLogs" class="px-4 py-2 rounded-lg bg-gray-100 hover:bg-gray-200 font-medium whitespace-nowrap hidden transition-all text-gray-700 btn-icon">
                <i class="fas fa-clock"></i> Access Logs
            </button>
        </nav>
        <section id="docsSection" class="card rounded-2xl p-8 overflow-x-auto fade-in">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 section-header">Employee Signed Documents</h2>
            <table class="w-full min-w-[700px] text-base">
                <thead>
                    <tr class="border-b border-gray-200 text-gray-600 font-medium">
                        <th class="text-left py-3 px-2">First Name</th>
                        <th class="text-left px-2">Last Name</th>
                        <th class="text-left px-2">Username</th>
                        <th class="text-left px-2">Document Actions</th>
                    </tr>
                </thead>
                <tbody id="docBody">
                    <tr><td colspan="4" class="text-center py-6 text-gray-400">Loading documents...</td></tr>
                </tbody>
            </table>
        </section>
        <section id="summarySection" class="card rounded-2xl p-8 overflow-x-auto hidden fade-in">
            <h2 class="text-2xl font-bold text-gray-900 mb-6 border-b pb-3 border-gray-200 section-header">Employee Benefit Summary</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <input id="employeeSearch" type="text" placeholder="Search by Name or Username..." class="col-span-full md:col-span-1 border border-gray-300 bg-gray-50 w-full p-3 rounded-lg text-base input-focus" />
            </div>
            <div id="employeeSelectionArea" class="grid grid-cols-1 md:grid-cols-3 gap-8">
                <div class="md:col-span-1 bg-gray-50 p-6 rounded-2xl border border-gray-200 max-h-[600px] overflow-y-auto">
                    <h3 class="font-bold text-gray-900 mb-4 section-header">Select Employee:</h3>
                    <div id="employeeList" class="space-y-2">
                        <p class="text-gray-400 text-base py-3">Loading users...</p>
                    </div>
                </div>
                <div id="summaryCardContainer" class="md:col-span-2 min-h-[300px] flex items-center justify-center">
                    <p class="text-gray-400 text-center text-lg">Select an employee to view their benefit summary.</p>
                </div>
            </div>
        </section>
        <section id="usersSection" class="card rounded-2xl p-8 overflow-x-auto hidden fade-in">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-900 section-header">Authorized Users & Credentials</h2>
                <button id="addUser" class="accent-gold px-6 py-3 rounded-lg transition-all btn-icon">
                    <i class="fas fa-user-plus"></i> Add User
                </button>
            </div>
            <table class="w-full min-w-[700px] text-base">
                <thead>
                    <tr class="border-b border-gray-200 text-gray-600 font-medium">
                        <th class="text-left py-3 px-2">Full Name</th>
                        <th class="text-left px-2">Username</th>
                        <th class="text-left px-2">PIN</th>
                        <th class="text-left px-2">Role</th>
                    </tr>
                </thead>
                <tbody id="userBody">
                    <tr><td colspan="6" class="text-center py-6 text-gray-400">Loading users...</td></tr>
                </tbody>
            </table>
        </section>
        <section id="logsSection" class="card rounded-2xl p-8 overflow-x-auto hidden fade-in">
            <h2 class="text-2xl font-bold mb-6 text-gray-900 section-header">Access Log History (Chicago CST)</h2>
            <table class="w-full min-w-[700px] text-base">
                <thead>
                    <tr class="border-b border-gray-200 text-gray-600 font-medium">
                        <th class="text-left py-3 px-2">Username</th>
                        <th class="text-left px-2">Login Time</th>
                        <th class="text-left px-2">Logout Time</th>
                        <th class="text-left px-2">Duration (min)</th>
                    </tr>
                </thead>
                <tbody id="logBody">
                    <tr><td colspan="4" class="text-center py-6 text-gray-400">No logs available</td></tr>
                </tbody>
            </table>
        </section>
    </div>
    <div id="userModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-white rounded-2xl card w-full max-w-md p-8 fade-in">
            <h3 id="modalTitle" class="text-2xl font-bold text-gray-900 mb-6 section-header"></h3>
            <div class="space-y-4">
                <input id="modalFullName" type="text" placeholder="Full Name" class="border border-gray-300 bg-gray-50 w-full p-3 rounded text-base input-focus" />
                <input id="modalUsername" type="text" placeholder="Username (2-3 initials)" class="border border-gray-300 bg-gray-50 w-full p-3 rounded text-base input-focus" />
                <input id="modalPin" type="number" placeholder="PIN (4 digits)" class="border border-gray-300 bg-gray-50 w-full p-3 rounded text-base input-focus" />
                <select id="modalRole" class="border border-gray-300 bg-gray-50 w-full p-3 rounded text-base input-focus">
                    <option value="user">Standard User</option>
                    <option value="admin">Administrator</option>
                </select>
                <label id="modalActiveContainer" class="flex items-center gap-3 text-base text-gray-600">
                    <input id="modalActive" type="checkbox" class="form-checkbox h-5 w-5 text-[#FFD700]" /> Portal Active
                </label>
            </div>
            <div class="flex justify-end gap-4 mt-8">
                <button id="modalCancel" class="px-6 py-3 rounded-lg bg-gray-100 hover:bg-gray-200 text-gray-700 border border-gray-200 transition-all btn-icon">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button id="modalSave" class="px-6 py-3 rounded-lg accent-gold transition-all btn-icon">
                    <i class="fas fa-save"></i> Save
                </button>
            </div>
        </div>
    </div>
    <section id="printView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-12 bg-white rounded-2xl card">
        <h1 class="text-4xl font-bold mb-8 text-center text-gray-900 section-header">Jeng Chi Employee Documents (Print View)</h1>
        <p class="text-center text-gray-600 mb-8 print:hidden text-lg">The browser's print dialog should have appeared. All documents are embedded below. Click 'Close' when done printing.</p>
        <button id="closePrintView" class="mb-10 accent-gold px-6 py-3 rounded-lg block mx-auto print:hidden transition-all btn-icon">
            <i class="fas fa-times-circle"></i> Close Print View
        </button>
        <div id="printContainerContent" class="space-y-12"></div>
    </section>
    <script>
        // --- CONFIGURATION ---
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        const RATE_SCHEDULE_ID = '10729793-8776-423e-a4e4-b7532c64031b';

        // --- GLOBAL STATE ---
        let currentUser = null;
        let employeeDataCache = [];
        let authorizedUsersCache = [];
        let docSubscription = null;
        const TIMEZONE = 'America/Chicago';
        const LOCALE = 'en-US';
        let ACCESS_LOGS = [];
        let nextAuthUserId = 5;

        // --- AUTH/SESSION STATE ---
        const storedUser = sessionStorage.getItem("auth_user");

        // --- DATA ARRAYS (Mock data for initial load/CRUD simulation) ---
        let AUTHORIZED_USERS = [
            { id: 1, full_name: "Francisco Teng", username: "FT", pin: "9094", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 2, full_name: "Pablo Gonzalez", username: "PG", pin: "9367", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 3, full_name: "Garret Moore", username: "GM", pin: "1740", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
            { id: 4, full_name: "Janelle Teng", username: "JT", pin: "2316", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" }
        ];

        const STATIC_PLAN_NAMES = {
            "F_PLAN_2W": "F-PLAN 2W / Base MAC",
            "F_PLAN_3W": "F-PLAN 3W / Buy Up MAC",
            "HMO": "HMO / ATBAB303",
            "HMO_HSA": "HMO / ATBAP393 HSA",
            "LIFE_CORE": "Allstate Term Life & AD&D (Employer-Paid)",
            "PLAN_1": "UC ClearVision Plan 1",
            "PPO": "PPO / ATBCB402",
        };
        let planDisplayNames = STATIC_PLAN_NAMES;

        // --- FETCHERS (LIVE DATABASE CALLS) ---
        async function fetchPlanRates(planCodes, tier) {
            if (RATE_SCHEDULE_ID === 'YOUR_ACTIVE_RATE_SCHEDULE_UUID') {
                console.warn("RATE_SCHEDULE_ID is not configured. Using $0.00 placeholders for premiums.");
                return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }
            const { data, error } = await supabase
                .from('benefit2_rates')
                .select('plan_code, amount, per_year_periods')
                .eq('schedule_id', RATE_SCHEDULE_ID)
                .eq('tier', tier)
                .in('plan_code', planCodes);
            
            if (error) {
                console.error("Error fetching plan rates:", error);
                return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }
            const perPeriodRates = data.map(rate => ({
                plan_code: rate.plan_code,
                per_period_cost: parseFloat(rate.amount) // Changed to flat rate (monthly assume)
            }));
            return perPeriodRates;
        }

    async function fetchEmployeeDetails(username) {
    const { data: employee, error: empError } = await supabase
        .from('employees2025')
        .select('id, first_name, last_name, job_title, original_hire_date, username')
        .eq('username', username)
        .single();

    if (empError || !employee) return { employee: null, enrollment: null };

    const { data: enrollments, error: enrollError } = await supabase
        .from('benefit_enrollments')
        .select('tier_election, medical_plan, dental_plan, vision_plan, dependents, beneficiaries, spouse, signed_at')
        .eq('username', username)
        .order('created_at', { ascending: false })
        .limit(1);

    const enrollment = enrollments?.[0] || null;
    if (enrollError) console.error("Enrollment error:", enrollError);

    return { employee, enrollment };
}
        async function fetchEmployeeData() {
            const { data, error } = await supabase
                .from('employees2025')
                .select(`
                    id,
                    first_name,
                    last_name,
                    username,
                    pin,
                    signed_pdf_url,
                    job_title
                `)
                .neq('signed_pdf_url', null);
            if (error) {
                console.error("Error fetching employee data:", error);
                document.getElementById("docBody").innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-500">ERROR: Could not connect to database or fetch employee list.</td></tr>`;
                return [];
            }
            const employees = data.map(e => ({
                id: e.id,
                first_name: e.first_name,
                last_name: e.last_name,
                username: e.username,
                pin: e.pin,
                signed_pdf_url: e.signed_pdf_url,
                job_title: e.job_title || 'N/A'
            }));
            const uniqueEmployees = Array.from(new Map(employees.map(item => [item.id, item])).values());
            employeeDataCache = uniqueEmployees;
            return uniqueEmployees;
        }

        async function fetchAuthorizedUsers() {
            authorizedUsersCache = AUTHORIZED_USERS;
            nextAuthUserId = authorizedUsersCache.reduce((max, user) => Math.max(max, user.id), 0) + 1;
            return authorizedUsersCache;
        }

        // --- REAL-TIME SUBSCRIPTION ---
        function unsubscribeFromDocs() {
            if (docSubscription) {
                supabase.removeChannel(docSubscription);
                docSubscription = null;
            }
        }

        async function subscribeToDocs() {
            unsubscribeFromDocs();
            await fetchEmployeeData();
            renderDocBody();
            docSubscription = supabase.channel('signed_documents')
                .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'employees2025', filter: 'signed_pdf_url=neq.null' }, (payload) => {
                    console.log('Real-time change:', payload);
                    fetchEmployeeData().then(renderDocBody);
                })
                .subscribe((status, err) => {
                    if (status === 'SUBSCRIBED') console.log('Real-time active');
                    if (err) showAlert('Real-time error.', 'Error');
                });
        }

        // --- UTILITY FUNCTIONS ---
        const formatCurrency = (amount) => {
            return new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'USD' }).format(amount || 0);
        };

        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString(LOCALE);
        };

        const esc = (t) => String(t ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

        const formatTime = (date) => date.toLocaleString(LOCALE, {
            timeZone: TIMEZONE,
            year: 'numeric', month: 'numeric', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true
        });

        const calculateDuration = (loginTime, logoutTime) => {
            if (!logoutTime) return 'Active';
            const diffMs = new Date(logoutTime) - new Date(loginTime);
            return (diffMs / (1000 * 60)).toFixed(1);
        };

        // Custom Modal Logic
        const fModal = document.getElementById('feedbackModal');
        const fTitle = document.getElementById('feedbackModalTitle');
        const fMessage = document.getElementById('feedbackModalMessage');
        const fInput = document.getElementById('feedbackModalPromptInput');
        const fButtons = document.getElementById('feedbackModalButtons');
        function showCustomModal(title, message, type = 'alert', promptPlaceholder = '') {
            return new Promise((resolve) => {
                fTitle.textContent = title;
                fMessage.innerHTML = message.replace(/\n/g, '<br>');
                fButtons.innerHTML = '';
                fInput.value = '';
                fInput.placeholder = promptPlaceholder;
                if (type === 'prompt') {
                    fInput.classList.remove('hidden');
                    fInput.focus();
                } else {
                    fInput.classList.add('hidden');
                }
                const setupButton = (text, className, action) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.className = `px-4 py-2 rounded-lg shadow-sm transition duration-150 ${className}`;
                    btn.onclick = () => {
                        fModal.classList.add('hidden');
                        action();
                    };
                    fButtons.appendChild(btn);
                };
                if (type === 'confirm' || type === 'prompt') {
                    setupButton('Cancel', 'bg-gray-200 hover:bg-gray-300 text-gray-700', () => resolve(type === 'confirm' ? false : null));
                }
                const primaryText = type === 'prompt' ? 'Select' : 'OK';
                setupButton(primaryText, 'accent-gold', () => {
                    if (type === 'prompt') {
                        resolve(fInput.value.trim());
                    } else {
                        resolve(type === 'confirm' ? true : true);
                    }
                });
                fModal.classList.remove('hidden');
            });
        }
        const showAlert = (message, title = 'Notification') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'alert');
        const showConfirm = (message, title = 'Confirm Action') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'confirm');
        const showPrompt = (message, title = 'Input Required') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'prompt', 'Enter selection...');

        const spinner = document.getElementById("spinnerOverlay");
        const showSpinner = () => spinner.classList.remove("hidden");
        const hideSpinner = () => spinner.classList.add("hidden");

        // --- TAB CONTROL ---
        const tabDocs = document.getElementById("tabDocs");
        const tabSummary = document.getElementById("tabSummary");
        const tabLogs = document.getElementById("tabLogs");
        const tabUsers = document.getElementById("tabUsers");
        const docsSection = document.getElementById("docsSection");
        const summarySection = document.getElementById("summarySection");
        const logsSection = document.getElementById("logsSection");
        const usersSection = document.getElementById("usersSection");
        function switchTab(tab) {
            unsubscribeFromDocs();
            [tabDocs, tabSummary, tabLogs, tabUsers].forEach(b => {
                b.classList.remove("bg-gray-900","text-white");
                b.classList.add("bg-gray-100","text-gray-700");
            });
            [docsSection, summarySection, logsSection, usersSection].forEach(s => s.classList.add("hidden"));
            if (tab === "docs") {
                tabDocs.classList.add("bg-gray-900","text-white");
                tabDocs.classList.remove("bg-gray-100","text-gray-700");
                docsSection.classList.remove("hidden");
                loadDocs();
            } else if (tab === "summary" && currentUser.role === 'admin') {
                tabSummary.classList.add("bg-gray-900","text-white");
                tabSummary.classList.remove("bg-gray-100","text-gray-700");
                summarySection.classList.remove("hidden");
                loadSummary();
            } else if (tab === "logs" && currentUser.role === 'admin') {
                tabLogs.classList.add("bg-gray-900","text-white");
                tabLogs.classList.remove("bg-gray-100","text-gray-700");
                logsSection.classList.remove("hidden");
                loadLogs();
            } else if (tab === "users" && currentUser.role === 'admin') {
                tabUsers.classList.add("bg-gray-900","text-white");
                tabUsers.classList.remove("bg-gray-100","text-gray-700");
                usersSection.classList.remove("hidden");
                loadUsers();
            }
        }
        tabDocs.onclick = () => switchTab("docs");
        tabSummary.onclick = () => switchTab("summary");
        tabLogs.onclick = () => switchTab("logs");
        tabUsers.onclick = () => switchTab("users");

        // --- AUTHENTICATION & SESSION MANAGEMENT ---
        const loginScreen = document.getElementById("loginScreen");
        const dashboard = document.getElementById("dashboard");
        const printView = document.getElementById("printView");
        const printContainerContent = document.getElementById("printContainerContent");
        const closePrintView = document.getElementById("closePrintView");
        const loginBtn = document.getElementById("loginBtn");
        // --- ENTER KEY SUBMIT FOR LOGIN ---
const usernameInput = document.getElementById("username");
const pinInput = document.getElementById("pin");

function handleLoginEnter(event) {
  if (event.key === "Enter") {
    event.preventDefault();      // stop form from reloading page
    loginBtn.click();            // trigger the existing login logic
  }
}

usernameInput.addEventListener("keydown", handleLoginEnter);
pinInput.addEventListener("keydown", handleLoginEnter);

        const logoutBtn = document.getElementById("logoutBtn");
        const loginError = document.getElementById("loginError");
        const printContainer = document.getElementById("printContainer");
        const portalRole = document.getElementById("portalRole");

        closePrintView.onclick = () => {
            printView.classList.add("hidden");
            dashboard.classList.remove("hidden");
            printContainerContent.innerHTML = '';
        };

        loginBtn.onclick = async () => {
            const u = document.getElementById("username").value.trim().toUpperCase();
            const p = document.getElementById("pin").value.trim();
            loginError.classList.add("hidden");
            showSpinner();
            await fetchAuthorizedUsers();
            const user = authorizedUsersCache.find(e => e.username === u && String(e.pin) === p && e.active);
            await fetchEmployeeData();
            const employeeRecord = employeeDataCache.find(e => e.username === u);
            if (user) {
                currentUser = { ...user, full_name: user.full_name, role: user.role || 'user' };
                if (employeeRecord) {
                    const { data: logData, error: logError } = await supabase
                        .from('portal_logs')
                        .insert([
                            {
                                employee_id: employeeRecord.id,
                                login_time: new Date().toISOString(),
                            },
                        ]).select('id');
                    if (logError) {
                        console.error("Failed to record login to DB:", logError);
                        showAlert(`Login recorded, but DB log insert failed. Error: ${logError.message}`, "Log Error");
                    } else {
                        currentUser.log_id = logData[0].id;
                    }
                } else {
                    console.error(`Employee record (and ID) not found for username ${u}. Cannot log access.`);
                    showAlert(`Login successful for ${u}, but log tracking failed (Employee ID not found).`, "Log Error");
                }
                sessionStorage.setItem("auth_user", JSON.stringify(currentUser));
                await fetchEmployeeData();
                showDashboard();
            } else {
                loginError.textContent = "Invalid username, PIN, or inactive account.";
                loginError.classList.remove("hidden");
            }
            hideSpinner();
        };

        logoutBtn.onclick = async () => {
            const user = currentUser;
            const logoutTime = new Date();
            if (user && user.log_id) {
                const { data: logEntry, error: fetchError } = await supabase
                    .from('portal_logs')
                    .select('login_time')
                    .eq('id', user.log_id)
                    .single();
                let durationMin = 0;
                if (!fetchError && logEntry && logEntry.login_time) {
                    const loginTime = new Date(logEntry.login_time);
                    const durationMs = logoutTime.getTime() - loginTime.getTime();
                    durationMin = Math.round(durationMs / (1000 * 60));
                } else {
                    console.warn("Could not retrieve login time for duration calculation.");
                }
                const { error: updateError } = await supabase
                    .from('portal_logs')
                    .update({
                        logout_time: logoutTime.toISOString(),
                        duration_minutes: durationMin
                    })
                    .eq('id', user.log_id);
                if (updateError) {
                    console.error("Failed to record manual logout/duration to DB:", updateError);
                    showAlert(`Error logging out session ID ${user.log_id}. See console for details.`, "Logout Failed");
                }
            }
            unsubscribeFromDocs();
            currentUser = null;
            sessionStorage.removeItem("auth_user");
            loginScreen.classList.remove("hidden");
            dashboard.classList.add("hidden");
            document.getElementById("username").value = '';
            document.getElementById("pin").value = '';
        };

        function showDashboard() {
            loginScreen.classList.add("hidden");
            dashboard.classList.remove("hidden");
            const isAdmin = currentUser.role === 'admin';
            const isJT = currentUser.username === 'JT';
            portalRole.textContent = `Portal Access ‚Äî ${isAdmin ? 'Administrator' : 'Standard User'}`;
            if (isAdmin) {
                tabSummary.classList.remove("hidden");
                tabUsers.classList.remove("hidden");
                printContainer.classList.remove("hidden");
                if (isJT) {
                    tabLogs.classList.add("hidden");
                    logsSection.classList.add("hidden");
                } else {
                    tabLogs.classList.remove("hidden");
                }
                switchTab("docs");
            } else {
                tabSummary.classList.add("hidden");
                tabUsers.classList.add("hidden");
                tabLogs.classList.add("hidden");
                printContainer.classList.add("hidden");
                switchTab("docs");
            }
        }

        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showSpinner();
            fetchAuthorizedUsers().then(() => fetchEmployeeData().then(showDashboard));
        }

        function recordLogout() {
            const user = currentUser || JSON.parse(sessionStorage.getItem("auth_user"));
            if (!user || !user.log_id) return;
            const logoutTime = new Date();
            const payload = {
                logout_time: logoutTime.toISOString(),
                duration_minutes: -1
            };
            const syncXhr = new XMLHttpRequest();
            syncXhr.open('PUT', `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${user.log_id}`, false);
            syncXhr.setRequestHeader('apikey', SUPABASE_KEY);
            syncXhr.setRequestHeader('Authorization', `Bearer ${SUPABASE_KEY}`);
            syncXhr.setRequestHeader('Content-Type', 'application/json');
            try {
                syncXhr.send(JSON.stringify(payload));
                console.log(`Synchronous auto-logout signal sent for ID: ${user.log_id}`);
            } catch (e) {
                console.error("Failed synchronous DB update on close:", e);
            }
            sessionStorage.removeItem("auth_user");
        }

        window.addEventListener('beforeunload', recordLogout);

        // --- DATA LOADERS ---
        function loadDocs() {
            subscribeToDocs();
        }

        async function loadSummary() {
            const container = document.getElementById('summaryCardContainer');
            const searchInput = document.getElementById('employeeSearch');
            showSpinner();
            await fetchEmployeeData();
            hideSpinner();
            if (employeeDataCache.length === 0) {
                container.innerHTML = `<p class="text-red-500 text-center">No signed documents found. Cannot generate summary card.</p>`;
                return;
            }
            searchInput.oninput = () => renderEmployeeList(searchInput.value.toLowerCase());
            renderEmployeeList('');
            container.innerHTML = `<p class="text-gray-500 text-center">Select an employee from the list to view their detailed summary card.</p>`;
        }

        function renderEmployeeList(filterText) {
            const employeeListEl = document.getElementById('employeeList');
            employeeListEl.innerHTML = '';
            const filteredUsers = employeeDataCache.filter(u =>
                u.first_name.toLowerCase().includes(filterText) ||
                u.last_name.toLowerCase().includes(filterText) ||
                u.username.toLowerCase().includes(filterText)
            ).sort((a, b) => a.last_name.localeCompare(b.last_name));
            if (filteredUsers.length === 0) {
                employeeListEl.innerHTML = `<p class="text-gray-500 text-sm py-2">No employees match your search.</p>`;
                return;
            }
            filteredUsers.forEach(u => {
                const userButton = document.createElement('button');
                userButton.className = 'w-full text-left p-2 rounded-lg hover:bg-gray-100 transition duration-150 text-gray-800 text-sm';
                userButton.textContent = `${u.first_name} ${u.last_name} (${u.username})`;
                userButton.dataset.username = u.username;
                userButton.onclick = () => handleEmployeeSelect(u.username);
                employeeListEl.appendChild(userButton);
            });
        }

        async function handleEmployeeSelect(username) {
            const container = document.getElementById('summaryCardContainer');
            container.innerHTML = `<div class="spinner"></div><p class="mt-4 text-gray-500">Loading benefits data...</p>`;
            showSpinner();
            const { employee, enrollment } = await fetchEmployeeDetails(username);
            if (!employee || !enrollment) {
                hideSpinner();
                container.innerHTML = `
                    <div class="p-6 text-center bg-yellow-50 rounded-xl border border-yellow-200">
                        <p class="font-semibold text-gray-800">Employee data not fully available for ${username}.</p>
                        <p class="text-sm text-gray-500">Could not find employee record or completed enrollment form.</p>
                    </div>`;
                return;
            }
            const chosenPlans = [];
            if (enrollment.medical_plan && !enrollment.medical_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.medical_plan);
            if (enrollment.dental_plan && !enrollment.dental_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.dental_plan);
            if (enrollment.vision_plan && !enrollment.vision_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.vision_plan);
            const rates = await fetchPlanRates(chosenPlans, enrollment.tier_election);
            renderSummaryCard(employee, enrollment, rates);
            hideSpinner();
        }

        function loadUsers() {
            if (currentUser.role !== 'admin') return;
            const userBody = document.getElementById("userBody");
            userBody.innerHTML = "";
            if (authorizedUsersCache.length === 0) {
                userBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-400">No authorized users found</td></tr>`;
                return;
            }
            authorizedUsersCache.sort((a, b) => a.username.localeCompare(b.username)).forEach(u => {
                const isActive = u.active ? "Yes" : "No";
                userBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50" data-id="${u.id}">
                        <td class="py-2 px-1">${esc(u.full_name)}</td>
                        <td class="px-1">${esc(u.username)}</td>
                        <td class="px-1">${esc(u.pin)}</td>
                        <td class="px-1">${esc(u.role)}</td>
                        <td class="px-1">${isActive}</td>
                        <td class="space-x-3 px-1">
                            <button class="text-blue-600 hover:underline js-edit">Edit</button>
                            <button class="text-red-600 hover:underline js-del">Delete</button>
                        </td>
                    </tr>
                `);
            });
        }

        function loadLogs() {
            if (currentUser.role !== 'admin') return;
            const logBody = document.getElementById("logBody");
            logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">Fetching logs from database...</td></tr>`;
            supabase
                .from('portal_logs')
                .select(`
                    login_time,
                    logout_time,
                    duration_minutes,
                    employee_data:employee_id (username)
                `)
                .order('login_time', { ascending: false })
                .limit(50)
                .then(({ data: logData, error }) => {
                    if (error) {
                        console.error("DB Error fetching logs:", error);
                        logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-600">Error fetching logs from database. Check RLS policies.</td></tr>`;
                        return;
                    }
                    if (!logData || logData.length === 0) {
                        logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No logs available.</td></tr>`;
                        return;
                    }
                    logBody.innerHTML = "";
                    logData.forEach(l => {
                        const username = l.employee_data?.username || 'N/A';
                        const loginTimeCST = formatTime(new Date(l.login_time));
                        const logoutTimeCST = l.logout_time ? formatTime(new Date(l.logout_time)) : 'Active';
                        let durationDisplay = 'N/A';
                        if (l.logout_time) {
                            durationDisplay = (typeof l.duration_minutes === 'number' && l.duration_minutes >= 0)
                                ? `${l.duration_minutes} min`
                                : 'N/A';
                        } else {
                            durationDisplay = 'Active';
                        }
                        logBody.insertAdjacentHTML("beforeend", `
                            <tr class="border-b hover:bg-gray-50">
                                <td class="py-2 px-1">${esc(username)}</td>
                                <td class="px-1">${esc(loginTimeCST)}</td>
                                <td class="px-1">${esc(logoutTimeCST)}</td>
                                <td class="px-1">${durationDisplay}</td>
                            </tr>
                        `);
                    });
                })
                .catch(e => {
                    console.error("Unknown error during log fetch:", e);
                    logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-600">Unknown client error occurred.</td></tr>`;
                });
        }

        // --- PRINTING LOGIC ---
        function renderDocBody() {
            const docBody = document.getElementById("docBody");
            docBody.innerHTML = "";
            const signedDocs = employeeDataCache.filter(d => d.signed_pdf_url);
            if (signedDocs.length === 0) {
                docBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No signed documents available.</td></tr>`;
                return;
            }
            signedDocs.forEach(d => {
                const docActions = d.signed_pdf_url ? `
                    <a href="${esc(d.signed_pdf_url)}" target="_blank" class="text-blue-600 hover:underline mr-3">View PDF</a>
                    <button data-url="${esc(d.signed_pdf_url)}" class="text-gray-600 hover:text-gray-900 js-print" title="Print Document">üñ®Ô∏è</button>
                ` : '<span class="text-gray-400">N/A</span>';
                docBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-1">${esc(d.first_name)}</td>
                        <td class="px-1">${esc(d.last_name)}</td>
                        <td class="px-1">${esc(d.username)}</td>
                        <td class="px-1">${docActions}</td>
                    </tr>
                `);
            });
        }

        // --- SUMMARY CARD RENDERING LOGIC ---
        function renderSummaryCard(employee, enrollment, rates) {
            const container = document.getElementById('summaryCardContainer');
            const renderList = (items, isBeneficiaries = false) => {
                if (!items || items.length === 0 || JSON.stringify(items) === '[]') {
                    return `<span class="text-gray-500">None declared</span>`;
                }
                const listHtml = items.map((item, index) => {
                    const name = item.first ? `${item.first} ${item.last || ''}` : `Covered Individual ${index + 1}`;
                    const details = item.relationship || item.role || 'N/A';
                    const percentage = isBeneficiaries ? (items.length === 2 ? '50%' : '100%') : '';
                    return `<li class="flex justify-between py-1 border-b border-dashed border-gray-100">
                                <span>${esc(name)}</span>
                                <span class="text-gray-600 text-sm">${esc(details)} ${percentage}</span>
                            </li>`;
                }).join('');
                return `<ul class="space-y-1 mt-2">${listHtml}</ul>`;
            };
            const getPlanText = (planCode) => {
                const code = esc(planCode);
                const upperCaseCode = code.toUpperCase();
                let displayValue = planCode;
                if (upperCaseCode.includes('WAIVE') || upperCaseCode === 'NO' || !code) {
                    displayValue = planCode || 'WAIVE';
                } else {
                    displayValue = planDisplayNames[upperCaseCode] || planCode;
                }
                const escapedDisplay = esc(displayValue);
                return `<span class="text-green-600 font-semibold">${escapedDisplay}</span>`;
            };
            const getPerPeriodCost = (planCode, enrollmentPlan, rates) => {
                if (enrollmentPlan.toUpperCase().includes('WAIVE') || enrollmentPlan.toUpperCase() === 'NO') {
                    return 0;
                }
                const rateItem = rates.find(r => r.plan_code === planCode);
                return rateItem ? rateItem.per_period_cost : 0;
            };
            const medicalPlanCode = enrollment.medical_plan;
            const dentalPlanCode = enrollment.dental_plan;
            const visionPlanCode = enrollment.vision_plan;
            const costMedical = getPerPeriodCost(medicalPlanCode, medicalPlanCode, rates);
            const costDental = getPerPeriodCost(dentalPlanCode, dentalPlanCode, rates);
            const costVision = getPerPeriodCost(visionPlanCode, visionPlanCode, rates);
            const totalMonthlyPremium = costMedical + costDental + costVision;
            const cardHtml = `
            <div class="w-full bg-white border border-gray-200 rounded-xl shadow-2xl overflow-hidden my-4">
                <div class="accent-gold p-6 text-gray-900">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-3xl font-extrabold tracking-tight">${esc(employee.first_name)} ${esc(employee.last_name)}</h3>
                            <p class="text-sm font-light opacity-80 mt-1">Benefit Enrollment Summary ‚Äî Signed ${formatDate(enrollment.signed_at)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-base font-medium">${esc(employee.username)}</p>
                            <p class="text-xs opacity-70">${esc(employee.job_title)}</p>
                        </div>
                    </div>
                </div>
                <div class="p-6 space-y-8">
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 border-b pb-6">
                        <div class="p-3 bg-gray-50 rounded-lg shadow-inner col-span-full">
                            <p class="text-sm font-medium text-gray-500">Tier Election</p>
                            <p class="text-lg font-bold text-gray-800">${esc(enrollment.tier_election || 'N/A')}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg shadow-inner col-span-full sm:col-span-3">
                           <p class="text-sm font-medium text-gray-500">Total Flat Rate</p>
                           <p class="text-xl font-bold text-gray-800">${formatCurrency(totalMonthlyPremium)} flat rate</p>
                        </div>
                    </div>
                    <div class="space-y-4">
                        <h4 class="text-xl font-semibold text-gray-800 border-b pb-2">Plan Choices & Employee Flat Rate Cost</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div class="p-3 border rounded-lg ${costMedical > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium btn-icon"><i class="fas fa-heartbeat text-red-500"></i> Medical Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.medical_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costMedical)} flat rate</p>
                            </div>
                            <div class="p-3 border rounded-lg ${costDental > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium btn-icon"><i class="fas fa-tooth text-blue-500"></i> Dental Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.dental_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costDental)} flat rate</p>
                            </div>
                            <div class="p-3 border rounded-lg ${costVision > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium btn-icon"><i class="fas fa-eye text-green-500"></i> Vision Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.vision_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costVision)} flat rate</p>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 pt-4 border-t">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Dependents/Spouse</h4>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                ${enrollment.spouse ? `<p class="text-sm font-medium text-gray-800 mb-1">Spouse: ${enrollment.spouse.full_name || 'Covered'}</p>` : ''}
                                ${renderList(enrollment.dependents)}
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Beneficiaries</h4>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                ${renderList(enrollment.beneficiaries, true)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            container.innerHTML = cardHtml;
        }

        const docBody = document.getElementById("docBody");
        docBody.addEventListener("click", (e) => {
            if (e.target.classList.contains("js-print")) {
                const url = e.target.dataset.url;
                if (url) {
                    window.open(url, "_blank");
                    showAlert(`Print window opened for document: ${url.substring(url.lastIndexOf('/') + 1)}`, "Print Initiated");
                }
            }
        });

        const printMenuBtn = document.getElementById("printMenuBtn");
        const printMenu = document.getElementById("printMenu");
        printMenuBtn.onclick = () => printMenu.classList.toggle("hidden");
        document.addEventListener("click", (e) => {
            if (!printMenu.contains(e.target) && e.target !== printMenuBtn) printMenu.classList.add("hidden");
        });

        document.getElementById("printAll").onclick = async () => {
    printMenu.classList.add("hidden");

    const docsToPrint = employeeDataCache.filter(d => d.signed_pdf_url);
    if (docsToPrint.length === 0) {
        return showAlert("No signed documents found to print.");
    }

    // Use all employee IDs that have a signed PDF
    const employeeIds = docsToPrint.map(d => d.id);

    showSpinner();

    try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "apikey": SUPABASE_KEY,
                "Authorization": `Bearer ${SUPABASE_KEY}`
            },
            body: JSON.stringify({ employee_ids: employeeIds })
        });

        if (!res.ok) {
            const txt = await res.text();
            console.error("merge-signed-pdfs error:", txt);
            hideSpinner();
            return showAlert("Error generating combined PDF. Check console for details.", "Merge Failed");
        }

        const blob = await res.blob();
        const url = URL.createObjectURL(blob);

        // Open ONE combined file in a new tab; admin just prints that file
        window.open(url, "_blank");

        hideSpinner();
        showAlert(
            "Combined PDF has been generated and opened in a new tab. Use your browser's Print function to print all pages at once.",
            "Ready to Print"
        );
    } catch (e) {
        console.error("Unexpected error:", e);
        hideSpinner();
        showAlert("Unexpected error calling merge function. See console for details.", "Merge Failed");
    }
};


        document.getElementById("printByEmployee").onclick = async () => {
            printMenu.classList.add("hidden");
            const docsWithPDFs = employeeDataCache.filter(d => d.signed_pdf_url);
            if (docsWithPDFs.length === 0) {
                return showAlert("No signed documents found.");
            }
            const choices = docsWithPDFs.map(d => `${d.first_name} ${d.last_name} (${d.username})`).sort();
            const choiceList = choices.map((c, i) => `[${i + 1}] ${c}`).join("\n");
            const selPrompt = `Select an employee by entering their name/username or the corresponding number.\n\n${choiceList}`;
            const selectedValue = await showPrompt(selPrompt, "Print by Employee");
            if (!selectedValue) return;
            let selectedUser;
            const index = parseInt(selectedValue);
            if (!isNaN(index) && index >= 1 && index <= choices.length) {
                selectedUser = choices[index - 1];
            } else {
                selectedUser = choices.find(c => c.toLowerCase().includes(selectedValue.toLowerCase()));
            }
            if (!selectedUser) {
                return showAlert("Invalid selection. Please enter a valid name/username or number from the list.");
            }
            const usernameMatch = selectedUser.match(/\((.*?)\)/);
            if (!usernameMatch) return showAlert("Internal error: Could not parse username.");
            const targetUsername = usernameMatch[1];
            const documentsToPrint = employeeDataCache.filter(d => d.username === targetUsername && d.signed_pdf_url);
            if (documentsToPrint.length === 0) {
                return showAlert(`No signed documents found for **${selectedUser}**.`);
            }
            documentsToPrint.forEach(d => window.open(d.signed_pdf_url, "_blank"));
            showAlert(`Opened ${documentsToPrint.length} document(s) for **${selectedUser}** in new tabs.`, "Print Initiated");
        };

        // --- USER CRUD LOGIC ---
        const userBody = document.getElementById("userBody");
        userBody.addEventListener("click", async (e) => {
            if (currentUser.role !== 'admin') return;
            const row = e.target.closest("tr[data-id]");
            if (!row) return;
            const id = parseInt(row.dataset.id);
            const user = authorizedUsersCache.find(u => u.id === id);
            if (!user) return;
            if (e.target.classList.contains("js-edit")) {
                openModal(user);
                return;
            }
            if (e.target.classList.contains("js-del")) {
                const isConfirmed = await showConfirm(`Are you sure you want to delete the user: **${esc(user.full_name)} (${esc(user.username)})**?`);
                if (!isConfirmed) return;
                showSpinner();
                const index = AUTHORIZED_USERS.findIndex(u => u.id === id);
                if (index > -1) {
                    authorizedUsersCache.splice(index, 1);
                    showAlert(`User **${esc(user.full_name)}** deleted successfully.`, "User Deleted");
                }
                loadUsers();
                hideSpinner();
            }
        });

        const userModal = document.getElementById("userModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalFullName = document.getElementById("modalFullName");
        const modalUsername = document.getElementById("modalUsername");
        const modalPin = document.getElementById("modalPin");
        const modalRole = document.getElementById("modalRole");
        const modalActive = document.getElementById("modalActive");
        const modalCancel = document.getElementById("modalCancel");
        const modalSave = document.getElementById("modalSave");
        let editingId = null;

        document.getElementById("addUser").onclick = () => openModal(null);

        function openModal(user) {
            editingId = user ? user.id : null;
            modalTitle.textContent = editingId ? "Edit Authorized User" : "Add New Authorized User";
            modalFullName.value = user?.full_name || "";
            modalUsername.value = user?.username || "";
            modalPin.value = user?.pin || "";
            modalRole.value = user?.role || "user";
            modalActive.checked = user ? !!user.active : true;
            const isPg = user?.id === 2;
            modalUsername.disabled = isPg;
            modalRole.disabled = isPg;
            modalActive.disabled = isPg;
            userModal.classList.remove("hidden");
            modalFullName.focus();
        }

        modalCancel.onclick = () => userModal.classList.add("hidden");

        modalSave.onclick = async () => {
            if (currentUser.role !== 'admin') return;
            showSpinner();
            await new Promise(r => setTimeout(r, 200));
            const fullName = modalFullName.value.trim();
            const pinString = String(modalPin.value).trim();
            const payload = {
                full_name: fullName,
                username: modalUsername.value.trim().toUpperCase(),
                pin: pinString,
                role: modalRole.value,
                active: modalActive.checked,
            };
            if (!payload.username || !payload.pin || !fullName) {
                hideSpinner();
                return showAlert("All fields (Full Name, Username, PIN) are required.", "Input Error");
            }
            if (payload.pin.length !== 4 || isNaN(payload.pin)) {
                hideSpinner();
                return showAlert("PIN must be exactly 4 digits.", "Input Error");
            }
            let action = "Updated";
            if (editingId) {
                const index = AUTHORIZED_USERS.findIndex(u => u.id === editingId);
                if (index > -1) {
                    const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username && u.id !== editingId);
                    const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin && u.id !== editingId);
                    if (isUsernameTaken) {
                        hideSpinner();
                        return showAlert(`The username **${payload.username}** is already in use by another user.`, "Update Failed");
                    }
                    if (isPinTaken) {
                        hideSpinner();
                        return showAlert(`The PIN **${payload.pin}** is already in use by another user.`, "Update Failed");
                    }
                    AUTHORIZED_USERS[index] = { ...AUTHORIZED_USERS[index], ...payload };
                }
            } else {
                action = "Created";
                const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username);
                const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin);
                if (isUsernameTaken) {
                    hideSpinner();
                    return showAlert(`The username **${payload.username}** is already in use.`, "Creation Failed");
                }
                if (isPinTaken) {
                    hideSpinner();
                    return showAlert(`The PIN **${payload.pin}** is already in use.`, "Creation Failed");
                }
                AUTHORIZED_USERS.push({
                    id: nextAuthUserId++,
                    ...payload,
                    created_at: new Date().toISOString()
                });
            }
            loadUsers();
            showAlert(`User **${esc(payload.username)}** ${action.toLowerCase()} successfully. The user list has been updated.`, `${action} Success`);
            hideSpinner();
            userModal.classList.add("hidden");
        };

        AUTHORIZED_USERS.forEach(u => {
            if (u.id >= nextAuthUserId) {
                nextAuthUserId = u.id + 1;
            }
        });
    </script>
</body>
</html>


