<html lang="en" class="h-full bg-slate-50">
<head>
Â  Â  <meta charset="utf-8" />
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
Â  Â  <title>Jeng Chi â€” Benefit Portal</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
Â  Â  <style>
Â  Â  Â  Â  .font-\[Inter\] { font-family: 'Inter', sans-serif; }
Â  Â  Â  Â  .spinner{border:4px solid #e5e7eb;border-top:4px solid #b9965a;border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite}
Â  Â  Â  Â  @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
Â  Â  Â  Â  .modal-bg{background:rgba(0,0,0,0.6)}
Â  Â  Â  Â  /* Jeng Chi Gold Accent */
Â  Â  Â  Â  .accent-gold{background:#B9965A;color:#fff}
Â  Â  Â  Â  .accent-gold:hover{background:#a9874e}
Â  Â  Â  Â  .accent-gold-text { color: #B9965A; }

Â  Â  Â  Â  /* Print Styles: Hide everything except the print view when printing */
Â  Â  Â  Â  @media print {
Â  Â  Â  Â  Â  Â  #dashboard, #loginScreen, #spinnerOverlay, #feedbackModal, #userModal { display: none !important; }
Â  Â  Â  Â  Â  Â  #printView { display: block !important; }
Â  Â  Â  Â  Â  Â  /* Force iframes to take up page space for printing */
Â  Â  Â  Â  Â  Â  .print-iframe { page-break-after: always; margin-bottom: 0 !important; }
Â  Â  Â  Â  Â  Â  iframe {
Â  Â  Â  Â  Â  Â  Â  Â  width: 100%;
Â  Â  Â  Â  Â  Â  Â  Â  /* Use a height close to a full page (e.g., 95% of viewport height) */
Â  Â  Â  Â  Â  Â  Â  Â  height: 95vh;
Â  Â  Â  Â  Â  Â  Â  Â  border: none !important;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  </style>
</head>

<body class="font-[Inter] bg-gray-50 text-gray-800 min-h-screen">
Â  Â  <!-- Global Spinner -->
Â  Â  <div id="spinnerOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
Â  Â  Â  Â  <div class="bg-white rounded-xl p-6 flex flex-col items-center shadow-2xl">
Â  Â  Â  Â  Â  Â  <div class="spinner mb-3"></div>
Â  Â  Â  Â  Â  Â  <p class="text-gray-700 font-medium">Processing...</p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- Custom Feedback/Prompt Modal (Replaces alert/confirm/prompt) -->
Â  Â  <div id="feedbackModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative transform transition-all scale-100">
Â  Â  Â  Â  Â  Â  <h3 id="feedbackModalTitle" class="text-xl font-semibold text-gray-800 mb-3 accent-gold-text"></h3>
Â  Â  Â  Â  Â  Â  <p id="feedbackModalMessage" class="text-gray-600 mb-4"></p>
Â  Â  Â  Â  Â  Â  <textarea id="feedbackModalPromptInput" class="hidden border border-gray-300 w-full p-2 rounded text-sm h-32 resize-none focus:outline-none focus:ring-2 focus:ring-[#B9965A] mb-4" placeholder="Enter selection..."></textarea>
Â  Â  Â  Â  Â  Â  <div id="feedbackModalButtons" class="flex justify-end gap-3 mt-4">
Â  Â  Â  Â  Â  Â  Â  Â  <!-- Buttons injected by JS -->
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- LOGIN -->
Â  Â  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
Â  Â  Â  Â  <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center" onkeydown="if (event.key === 'Enter') document.getElementById('loginBtn').click()">
Â  Â  Â  Â  Â  Â  <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="mx-auto w-24 mb-6 rounded-full" alt="Jeng Chi Logo" />
Â  Â  Â  Â  Â  Â  <h2 class="text-2xl font-bold mb-6 text-gray-800">Benefit Portal Login</h2>
Â  Â  Â  Â  Â  Â  <input id="username" type="text" placeholder="Username (e.g., PG)" class="border w-full p-3 rounded-lg mb-4 text-base focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
Â  Â  Â  Â  Â  Â  <input id="pin" type="password" placeholder="PIN" class="border w-full p-3 rounded-lg mb-6 text-base focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
Â  Â  Â  Â  Â  Â  <button id="loginBtn" class="w-full accent-gold font-semibold py-3 rounded-lg shadow-md hover:shadow-lg transition duration-150">Sign In</button>
Â  Â  Â  Â  Â  Â  <p id="loginError" class="text-red-600 text-sm mt-4 hidden"></p>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- DASHBOARD -->
Â  Â  <div id="dashboard" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-8">
Â  Â  Â  Â  <header class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 pb-4 mb-8">
Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4 mb-4 sm:mb-0">
Â  Â  Â  Â  Â  Â  Â  Â  <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="w-14 rounded-full " alt="Jeng Chi Logo" />
Â  Â  Â  Â  Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h1 class="text-2xl font-bold accent-gold-text">Jeng Chi Restaurant</h1>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <p id="portalRole" class="text-sm text-gray-600"></p>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex items-center gap-4">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="printContainer" class="relative hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="printMenuBtn" class="p-2 rounded-lg hover:bg-gray-200 flex items-center gap-2" title="Print Options">ğŸ–¨ï¸ <span class="hidden sm:inline">Print</span></button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="printMenu" class="hidden absolute right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-xl z-40 w-52 overflow-hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="printAll" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition duration-100">Print All Documents</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="printByEmployee" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition duration-100">Print by Employee</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="logoutBtn" class="accent-gold px-5 py-2 rounded-lg shadow-md transition duration-150">Logout</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </header>

Â  Â  Â  Â  <!-- NAV -->
Â  Â  Â  Â  <nav class="flex gap-3 mb-6 overflow-x-auto">
Â  Â  Â  Â  Â  Â  <button id="tabDocs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap">Signed Documents</button>
            <button id="tabSummary" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap hidden">Benefit Summary</button>
Â  Â  Â  Â  Â  Â  <button id="tabUsers" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap hidden">Authorized Users</button>
Â  Â  Â  Â  Â  Â  <button id="tabLogs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap hidden">Access Logs</button>
Â  Â  Â  Â  </nav>

Â  Â  Â  Â  <!-- DOCUMENTS SECTION (Available to all users) -->
Â  Â  Â  Â  <section id="docsSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold text-gray-800 mb-4">Employee Signed Documents</h2>
Â  Â  Â  Â  Â  Â  <table class="w-full min-w-[700px] text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b text-gray-600 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left py-2 px-1">First Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Last Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Username</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Updated header for actions -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Document Actions</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="docBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading documents...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </section>

        <!-- SUMMARY SECTION (Admin only) -->
        <section id="summarySection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto hidden">
            <h2 class="text-lg font-semibold text-gray-800 mb-4 border-b pb-2">Employee Benefit Summary</h2>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                <input id="employeeSearch" type="text" placeholder="Search by Name or Username..." class="col-span-full md:col-span-1 border w-full p-2 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
            </div>

            <div id="employeeSelectionArea" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Employee List for Selection -->
                <div class="md:col-span-1 bg-gray-50 p-4 rounded-xl shadow-inner max-h-[500px] overflow-y-auto">
                    <h3 class="font-semibold text-gray-800 mb-2">Select Employee:</h3>
                    <div id="employeeList" class="space-y-1">
                        <p class="text-gray-500 text-sm py-2">Loading users...</p>
                    </div>
                </div>

                <!-- Summary Card Container -->
                <div id="summaryCardContainer" class="md:col-span-2 min-h-[200px] flex items-center justify-center">
                    <p class="text-gray-500 text-center">Select an employee from the list to view their detailed summary card.</p>
                </div>
            </div>
        </section>


Â  Â  Â  Â  <!-- USERS SECTION (Admin only) -->
Â  Â  Â  Â  <section id="usersSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto hidden">
Â  Â  Â  Â  Â  Â  <div class="flex justify-between items-center mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold text-gray-800">Authorized Users & Credentials</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="addUser" class="accent-gold px-4 py-2 rounded-lg transition duration-150">+ Add User</button>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <table class="w-full min-w-[700px] text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b text-gray-600 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left py-2 px-1">Full Name</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Username</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">PIN</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Role</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="userBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading users...</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </section>

Â  Â  Â  Â  <!-- LOGS SECTION (Admin only) -->
Â  Â  Â  Â  <section id="logsSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto hidden">
Â  Â  Â  Â  Â  Â  <h2 class="text-lg font-semibold mb-4 text-gray-800">Access Log History (Chicago CST)</h2>
Â  Â  Â  Â  Â  Â  <table class="w-full min-w-[700px] text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  <thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b text-gray-600 font-medium">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left py-2 px-1">Username</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Login Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Logout Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th class="text-left px-1">Duration (min)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="logBody">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="4" class="text-center py-4 text-gray-400">No logs available</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  </section>
Â  Â  </div>

Â  Â  <!-- USER MODAL (for Add/Edit User) -->
Â  Â  <div id="userModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
Â  Â  Â  Â  <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
Â  Â  Â  Â  Â  Â  <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
Â  Â  Â  Â  Â  Â  <div class="space-y-3">
Â  Â  Â  Â  Â  Â  Â  Â  <input id="modalFullName" type="text" placeholder="Full Name" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
Â  Â  Â  Â  Â  Â  Â  Â  <input id="modalUsername" type="text" placeholder="Username (2-3 initials)" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
Â  Â  Â  Â  Â  Â  Â  Â  <input id="modalPin" type="number" placeholder="PIN (4 digits)" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
Â  Â  Â  Â  Â  Â  Â  Â  <select id="modalRole" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="user">Standard User</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="admin">Administrator</option>
Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  <label id="modalActiveContainer" class="flex items-center gap-2 text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <input id="modalActive" type="checkbox" /> Portal Active
Â  Â  Â  Â  Â  Â  Â  Â  </label>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="flex justify-end gap-3 mt-6">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition duration-150">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modalSave" class="px-4 py-2 rounded-lg accent-gold transition duration-150">Save</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  </div>

Â  Â  <!-- PRINT ALL DOCUMENTS VIEW -->
Â  Â  <section id="printView" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-8">
Â  Â  Â  Â  <h1 class="text-3xl font-bold mb-6 text-center">Jeng Chi Employee Documents (Print View)</h1>
Â  Â  Â  Â  <p class="text-center text-gray-600 mb-6 print:hidden">The browser's print dialog should have appeared. All documents are embedded below. Click 'Close' when done printing.</p>
Â  Â  Â  Â  <button id="closePrintView" class="mb-8 accent-gold px-4 py-2 rounded-lg block mx-auto print:hidden">Close Print View</button>
Â  Â  Â  Â  <div id="printContainerContent" class="space-y-8">
Â  Â  Â  Â  Â  Â  <!-- IFRAMES will be injected here -->
Â  Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <script>
Â  Â  Â  Â  // --- CONFIGURATION ---
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- IMPORTANT RATE CONFIGURATION ---
        // !!! UPDATE THIS VALUE WITH YOUR ACTUAL ACTIVE SCHEDULE ID !!!
        const RATE_SCHEDULE_ID = '10729793-8776-423e-a4e4-b7532c64031b';
        // --- END RATE CONFIGURATION ---

Â  Â  Â  Â  // --- GLOBAL STATE ---
        let currentUser = null;
        let employeeDataCache = []; // Global cache for employee data (Signed Docs List)
        let authorizedUsersCache = []; // Global cache for authorized users (Login/CRUD List)
        let docSubscription = null; // Real-time subscription handle

Â  Â  Â  Â  const TIMEZONE = 'America/Chicago';
Â  Â  Â  Â  const LOCALE = 'en-US';
        
        let ACCESS_LOGS = []; // Access logs (Simulated in memory)
        let nextAuthUserId = 5; 
        
        // --- AUTH/SESSION STATE ---
        const storedUser = sessionStorage.getItem("auth_user"); 
        
        // --- DATA ARRAYS (Mock data for initial load/CRUD simulation) ---
Â  Â  Â  Â  let AUTHORIZED_USERS = [
Â  Â  Â  Â  Â  Â  { id: 1, full_name: "Francisco Teng", username: "FT", pin: "9094", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
Â  Â  Â  Â  Â  Â  { id: 2, full_name: "Pablo Gonzalez", username: "PG", pin: "9367", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" },
Â  Â  Â  Â  Â  Â  { id: 3, full_name: "Garret Moore", username: "GM", pin: "1740", role: "user", active: true, created_at: "2025-11-11T17:53:22.499Z" },
Â  Â  Â  Â  Â  Â  { id: 4, full_name: "Janelle Teng", username: "JT", pin: "2316", role: "admin", active: true, created_at: "2025-11-11T17:53:22.499Z" }
Â  Â  Â  Â  ];
        
        // NEW: Static plan names for better readability in the summary card
        const STATIC_PLAN_NAMES = {
            "F_PLAN_2W": "F-PLAN 2W / Base MAC",
            "F_PLAN_3W": "F-PLAN 3W / Buy Up MAC",
            "HMO": "HMO / ATBAB303",
            "HMO_HSA": "HMO / ATBAP393 HSA",
            "LIFE_CORE": "Allstate Term Life & AD&D (Employer-Paid)",
            "PLAN_1": "UC ClearVision Plan 1",
            "PPO": "PPO / ATBCB402",
        };
        let planDisplayNames = STATIC_PLAN_NAMES; // Global dictionary for plan names


        // --- FETCHERS (LIVE DATABASE CALLS) ---

        // NEW: Fetches the plan rate (employee cost) for a given plan code and tier
        async function fetchPlanRates(planCodes, tier) {
            if (RATE_SCHEDULE_ID === 'YOUR_ACTIVE_RATE_SCHEDULE_UUID') {
                 console.warn("RATE_SCHEDULE_ID is not configured. Using $0.00 placeholders for premiums.");
                 // Return zero rates if configuration is missing
                 return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }

            const { data, error } = await supabase
                .from('benefit2_rates')
                .select('plan_code, amount, per_year_periods')
                .eq('schedule_id', RATE_SCHEDULE_ID)
                .eq('tier', tier)
                .in('plan_code', planCodes);
            
            if (error) {
                console.error("Error fetching plan rates:", error);
                return planCodes.map(code => ({ plan_code: code, per_period_cost: 0 }));
            }

            // Calculate per period cost: amount / per_year_periods 
            const perPeriodRates = data.map(rate => ({
                plan_code: rate.plan_code,
               per_period_cost: parseFloat(rate.amount)
            }));
            
            return perPeriodRates;
        }

        // NEW: Fetches full employee details and their latest enrollment for the Summary Card
        async function fetchEmployeeDetails(username) {
            // 1. Fetch employee record (employees2025) - Basic details
            const { data: employees, error: empError } = await supabase
                .from('employees2025')
                .select(`id, first_name, last_name, job_title, original_hire_date, username`)
                .eq('username', username);
            
            const employee = employees ? employees[0] : null;

            if (empError || !employee) {
                console.error("Error fetching employee details:", empError);
                return { employee: null, enrollment: null };
            }

            // 2. Fetch the LATEST benefit enrollment record for the employee (Includes required plans and tier)
            const { data: enrollments, error: enrollError } = await supabase
                .from('benefit_enrollments')
                .select(`
                    tier_election, medical_plan, dental_plan, vision_plan, 
                    dependents, beneficiaries,
                    spouse, signed_at 
                `)
                .eq('username', username)
                .order('created_at', { ascending: false }) // Get the most recent
                .limit(1);

            const enrollment = enrollments ? enrollments[0] : null;

            if (enrollError) {
                console.error("Error fetching enrollment details:", enrollError);
            }

            return { employee, enrollment };
        }


        async function fetchEmployeeData() {
            // Fetch employees who have a signed document (simplest reliable filter)
            const { data, error } = await supabase
                .from('employees2025')
                .select(`
                    id, 
                    first_name, 
                    last_name, 
                    username, 
                    pin, 
                    signed_pdf_url,
                    job_title 
                `)
                .neq('signed_pdf_url', null); 

            if (error) {
                console.error("Error fetching employee data:", error);
                // Display error message in the document body if data fetch fails entirely
                document.getElementById("docBody").innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-600">ERROR: Could not connect to database or fetch employee list.</td></tr>`;
                return [];
            }
            
            // Map and flatten data
            const employees = data.map(e => ({
                id: e.id,
                first_name: e.first_name,
                last_name: e.last_name,
                username: e.username,
                pin: e.pin,
                signed_pdf_url: e.signed_pdf_url,
                job_title: e.job_title || 'N/A' // Include job_title
            }));
            
            const uniqueEmployees = Array.from(new Map(employees.map(item => [item.id, item])).values());
            employeeDataCache = uniqueEmployees;
            return uniqueEmployees;
        }

        async function fetchAuthorizedUsers() {
            // NOTE: This remains mock data for the portal login credentials
            authorizedUsersCache = AUTHORIZED_USERS;
            
            // Calculate next ID based on mock data
            nextAuthUserId = authorizedUsersCache.reduce((max, user) => Math.max(max, user.id), 0) + 1;
            
            return authorizedUsersCache;
        }
        
        // --- REAL-TIME SUBSCRIPTION ---

        function unsubscribeFromDocs() {
            if (docSubscription) {
                supabase.removeChannel(docSubscription);
                docSubscription = null;
            }
        }

       async function subscribeToDocs() {
    unsubscribeFromDocs();

    // Initial fetch BEFORE subscribing
    await fetchEmployeeData();
    renderDocBody();

    docSubscription = supabase.channel('signed_documents')
        .on('postgres_changes', { event: 'UPDATE', schema: 'public', table: 'employees2025', filter: 'signed_pdf_url=neq.null' }, (payload) => {
            console.log('Real-time change:', payload);
            fetchEmployeeData().then(renderDocBody);
        })
        .subscribe((status, err) => {
            if (status === 'SUBSCRIBED') console.log('Real-time active');
            if (err) showAlert('Real-time error.', 'Error');
        });
}

Â  Â  Â  Â  // --- UTILITY FUNCTIONS ---

        const formatCurrency = (amount) => {
            return new Intl.NumberFormat(LOCALE, { style: 'currency', currency: 'USD' }).format(amount || 0);
        };
        const formatDate = (dateString) => {
            if (!dateString) return 'N/A';
            return new Date(dateString).toLocaleDateString(LOCALE);
        };

Â  Â  Â  Â  // HTML Escaping
Â  Â  Â  Â  const esc = (t) => String(t ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

Â  Â  Â  Â  // Time formatting
Â  Â  Â  Â  const formatTime = (date) => date.toLocaleString(LOCALE, {
Â  Â  Â  Â  Â  Â  timeZone: TIMEZONE,
Â  Â  Â  Â  Â  Â  year: 'numeric', month: 'numeric', day: 'numeric',
Â  Â  Â  Â  Â  Â  hour: '2-digit', minute: '2-digit', second: '2-digit',
Â  Â  Â  Â  Â  Â  hour12: true
Â  Â  Â  Â  });
Â  Â  Â  Â Â // NEW: Fetches all plan display names for lookup
// NEW: Fetches all plan display names for lookup


                
// --------------------------------------------------------------------------------
// ... rest of the code (fetchEmployeeData starts here)
Â  Â  Â  Â  // Duration calculation
Â  Â  Â  Â  const calculateDuration = (loginTime, logoutTime) => {
Â  Â  Â  Â  Â  Â  if (!logoutTime) return 'Active';
Â  Â  Â  Â  Â  Â  const diffMs = new Date(logoutTime) - new Date(loginTime);
Â  Â  Â  Â  Â  Â  return (diffMs / (1000 * 60)).toFixed(1);
Â  Â  Â  Â  };

Â  Â  Â  Â  // Custom Modal Logic (Replaces alert, confirm, prompt)
Â  Â  Â  Â  const fModal = document.getElementById('feedbackModal');
Â  Â  Â  Â  const fTitle = document.getElementById('feedbackModalTitle');
Â  Â  Â  Â  const fMessage = document.getElementById('feedbackModalMessage');
Â  Â  Â  Â  const fInput = document.getElementById('feedbackModalPromptInput');
Â  Â  Â  Â  const fButtons = document.getElementById('feedbackModalButtons');

Â  Â  Â  Â  function showCustomModal(title, message, type = 'alert', promptPlaceholder = '') {
Â  Â  Â  Â  Â  Â  return new Promise((resolve) => {
Â  Â  Â  Â  Â  Â  Â  Â  fTitle.textContent = title;
Â  Â  Â  Â  Â  Â  Â  Â  fMessage.innerHTML = message;
Â  Â  Â  Â  Â  Â  Â  Â  fButtons.innerHTML = '';
Â  Â  Â  Â  Â  Â  Â  Â  fInput.value = '';
Â  Â  Â  Â  Â  Â  Â  Â  fInput.placeholder = promptPlaceholder;

Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'prompt') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fInput.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fInput.focus();
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fInput.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const setupButton = (text, className, action) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const btn = document.createElement('button');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.textContent = text;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.className = `px-4 py-2 rounded-lg shadow-sm transition duration-150 ${className}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  btn.onclick = () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fModal.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  action();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  fButtons.appendChild(btn);
Â  Â  Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'confirm' || type === 'prompt') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setupButton('Cancel', 'bg-gray-200 hover:bg-gray-300', () => resolve(type === 'confirm' ? false : null));
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  const primaryText = type === 'prompt' ? 'Select' : 'OK';
Â  Â  Â  Â  Â  Â  Â  Â  setupButton(primaryText, 'accent-gold', () => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (type === 'prompt') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(fInput.value.trim());
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else { // Alert or Confirm
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  resolve(type === 'confirm' ? true : true);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  fModal.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

Â  Â  Â  Â  const showAlert = (message, title = 'Notification') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'alert');
Â  Â  Â  Â  const showConfirm = (message, title = 'Confirm Action') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'confirm');
Â  Â  Â  Â  const showPrompt = (message, title = 'Input Required') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'prompt', 'Enter selection...');
Â  Â  Â  Â Â 
Â  Â  Â  Â  // Spinner helpers
Â  Â  Â  Â  const spinner = document.getElementById("spinnerOverlay");
Â  Â  Â  Â  const showSpinner = () => spinner.classList.remove("hidden");
Â  Â  Â  Â  const hideSpinner = () => spinner.classList.add("hidden");


Â  Â  Â  Â  // --- TAB CONTROL ---
Â  Â  Â  Â  const tabDocs = document.getElementById("tabDocs");
        const tabSummary = document.getElementById("tabSummary");
Â  Â  Â  Â  const tabLogs = document.getElementById("tabLogs");
Â  Â  Â  Â  const tabUsers = document.getElementById("tabUsers");

Â  Â  Â  Â  const docsSection = document.getElementById("docsSection");
        const summarySection = document.getElementById("summarySection");
Â  Â  Â  Â  const logsSection = document.getElementById("logsSection");
Â  Â  Â  Â  const usersSection = document.getElementById("usersSection");

Â  Â  Â  Â  function switchTab(tab) {
Â  Â  Â  Â  Â  Â  // Crucial: Unsubscribe from real-time updates if leaving the Documents tab
            unsubscribeFromDocs(); 

Â  Â  Â  Â  Â  Â  // Remove active state from all tabs and add default gray background
Â  Â  Â  Â  Â  Â  [tabDocs, tabSummary, tabLogs, tabUsers].forEach(b => {
Â  Â  Â  Â  Â  Â  Â  Â  b.classList.remove("bg-gray-900","text-white");
Â  Â  Â  Â  Â  Â  Â  Â  b.classList.add("bg-gray-200","text-gray-800");
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Hide all sections
Â  Â  Â  Â  Â  Â  [docsSection, summarySection, logsSection, usersSection].forEach(s => s.classList.add("hidden"));

Â  Â  Â  Â  Â  Â  // Set active state for selected tab and load data
Â  Â  Â  Â  Â  Â  if (tab === "docs") {
Â  Â  Â  Â  Â  Â  Â  Â  tabDocs.classList.add("bg-gray-900","text-white");
Â  Â  Â  Â  Â  Â  Â  Â  tabDocs.classList.remove("bg-gray-200","text-gray-800");
Â  Â  Â  Â  Â  Â  Â  Â  docsSection.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  loadDocs(); // Initiates subscription
Â  Â  Â  Â  Â  Â  } else if (tab === "summary" && currentUser.role === 'admin') {
                tabSummary.classList.add("bg-gray-900","text-white");
                tabSummary.classList.remove("bg-gray-200","text-gray-800");
                summarySection.classList.remove("hidden");
                loadSummary();
            } else if (tab === "logs" && currentUser.role === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  tabLogs.classList.add("bg-gray-900","text-white");
Â  Â  Â  Â  Â  Â  Â  Â  tabLogs.classList.remove("bg-gray-200","text-gray-800");
Â  Â  Â  Â  Â  Â  Â  Â  logsSection.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  loadLogs();
            } else if (tab === "users" && currentUser.role === 'admin') {
Â  Â  Â  Â  Â  Â  Â  Â  tabUsers.classList.add("bg-gray-900","text-white");
Â  Â  Â  Â  Â  Â  Â  Â  tabUsers.classList.remove("bg-gray-200","text-gray-800");
Â  Â  Â  Â  Â  Â  Â  Â  usersSection.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  Â  Â  loadUsers();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  tabDocs.onclick = () => switchTab("docs");
        tabSummary.onclick = () => switchTab("summary");
Â  Â  Â  Â  tabLogs.onclick = () => switchTab("logs");
Â  Â  Â  Â  tabUsers.onclick = () => switchTab("users");


Â  Â  Â  Â  // --- AUTHENTICATION & SESSION MANAGEMENT ---
Â  Â  Â  Â  const loginScreen = document.getElementById("loginScreen");
Â  Â  Â  Â  const dashboard = document.getElementById("dashboard");
Â  Â  Â  Â  const printView = document.getElementById("printView");
Â  Â  Â  Â  const printContainerContent = document.getElementById("printContainerContent");
Â  Â  Â  Â  const closePrintView = document.getElementById("closePrintView");
Â  Â  Â  Â  const loginBtn = document.getElementById("loginBtn");
Â  Â  Â  Â  const logoutBtn = document.getElementById("logoutBtn");
Â  Â  Â  Â  const loginError = document.getElementById("loginError");
Â  Â  Â  Â  const printContainer = document.getElementById("printContainer");
Â  Â  Â  Â  const portalRole = document.getElementById("portalRole");
Â  Â  Â  Â Â 
Â  Â  Â  Â  closePrintView.onclick = () => {
Â  Â  Â  Â  Â  Â  printView.classList.add("hidden");
Â  Â  Â  Â  Â  Â  dashboard.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  printContainerContent.innerHTML = ''; // Clear embedded documents
Â  Â  Â  Â  };


Â  Â  Â  Â  loginBtn.onclick = async () => {
    const u = document.getElementById("username").value.trim().toUpperCase();
    const p = document.getElementById("pin").value.trim();
    loginError.classList.add("hidden");
    showSpinner();

    // 1. Authenticate against local users
    await fetchAuthorizedUsers();
    const user = authorizedUsersCache.find(e => e.username === u && String(e.pin) === p && e.active);
    
    // 2. Fetch employee ID required for logging BEFORE proceeding
    await fetchEmployeeData(); // Ensure employeeDataCache is up-to-date
    const employeeRecord = employeeDataCache.find(e => e.username === u); // <--- Re-find record after cache update

    if (user) {
        currentUser = { ...user, full_name: user.full_name, role: user.role || 'user' };
        
        if (!employeeRecord) { // <-- Check for required ID before logging attempt
            console.error(`Employee record (and ID) not found for username ${u}. Cannot log access.`);
            // Log this error to the user interface:
            showAlert(`Login successful for ${u}, but log tracking failed (Employee ID not found).`, "Log Error");
        } else {
            // --- DB INSERT LOG ---
            const { data: logData, error: logError } = await supabase
                .from('portal_logs')
                .insert([
                    { 
                        employee_id: employeeRecord.id, // Use the required ID
                        login_time: new Date().toISOString(),
                    },
                ]).select('id');

            if (logError) {
                console.error("Failed to record login to DB:", logError);
                showAlert(`Login recorded, but DB log insert failed. Error: ${logError.message}`, "Log Error");
            } else {
                // Store the ID of the new log entry in the currentUser session for the later update (logout)
                currentUser.log_id = logData[0].id; // Store the ID column from the new row
            }
            // --- END DB INSERT LOG ---
        }
        
        sessionStorage.setItem("auth_user", JSON.stringify(currentUser));
        await fetchEmployeeData(); 
        showDashboard();
    } else {
        loginError.textContent = "Invalid username, PIN, or inactive account.";
        loginError.classList.remove("hidden");
    }
    hideSpinner();
};

Â  Â  Â  Â  logoutBtn.onclick = () => {
Â  Â  Â  Â  Â  Â  const user = JSON.parse(localStorage.getItem("auth_user") || "{}");

Â  Â  Â  Â  Â  Â  // Log logout time
Â  Â  Â  Â  Â  Â  const activeLog = ACCESS_LOGS.find(l => l.username === user.username && l.logout_time === null);
Â  Â  Â  Â  Â  Â  if (activeLog) {
Â  Â  Â  Â  Â  Â  Â  Â  activeLog.logout_time = new Date().toISOString();
Â  Â  Â  Â  Â  Â  }

            // Crucial: Unsubscribe from real-time updates on logout
            unsubscribeFromDocs();

Â  Â  Â  Â  Â  Â  currentUser = null;
Â  Â  Â  Â  Â   Â sessionStorage.removeItem("auth_user");
Â  Â  Â  Â  Â  Â  loginScreen.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  dashboard.classList.add("hidden");
Â  Â  Â  Â  Â  Â  // Clear input fields
Â  Â  Â  Â  Â  Â  document.getElementById("username").value = '';
Â  Â  Â  Â  Â  Â  document.getElementById("pin").value = '';
Â  Â  Â  Â  };

Â  Â function showDashboard() {
    loginScreen.classList.add("hidden");
    dashboard.classList.remove("hidden");

    // Check if the current user has general admin role
    const isAdmin = currentUser.role === 'admin';
    // Check if the current user is JT (username is stored in uppercase)
    const isJT = currentUser.username === 'JT'; // User JT should have limited admin access

    portalRole.textContent = `Portal Access â€” ${isAdmin ? 'Administrator' : 'Standard User'}`;

    if (isAdmin) {
        // All admins get these tabs by default
        tabSummary.classList.remove("hidden");
        tabUsers.classList.remove("hidden");
        printContainer.classList.remove("hidden");

        // RESTRICTED TABS LOGIC
        if (isJT) {
            tabLogs.classList.add("hidden");    // HIDE Logs for JT
            logsSection.classList.add("hidden"); // Ensure Logs section is hidden
        } else {
            tabLogs.classList.remove("hidden"); // Show Logs for all other true admins (PG, etc.)
        }
        
        switchTab("docs"); 
    } else {
        // Standard User Logic (Already correct)
        tabSummary.classList.add("hidden");
        tabUsers.classList.add("hidden");
        tabLogs.classList.add("hidden");
        printContainer.classList.add("hidden");
        switchTab("docs"); // Standard default tab
    }
}

Â  Â  Â  Â  // Check for existing session on load
Â  Â  Â  Â  if (storedUser) {
Â  Â  Â  Â  Â  Â  currentUser = JSON.parse(storedUser);
Â  Â  Â  Â  Â  Â  // Need to re-fetch data to ensure documents/users are up to date
Â  Â  Â  Â  Â  Â  showSpinner();
Â  Â  Â  Â  Â  Â  fetchAuthorizedUsers().then(() => fetchEmployeeData().then(showDashboard));
Â  Â  Â  Â  }

// --- SESSION LOGOUT HOOK ---

// Function to record the exact logout time before the window closes
function recordLogout() {
    const user = JSON.parse(sessionStorage.getItem("auth_user"));
    if (!user) return; 

    // Find the current active log entry for this user
    const activeLog = ACCESS_LOGS.find(l => l.username === user.username && l.logout_time === null);

    if (activeLog) {
        // Set the logout time to the current time just before closing/navigating away
        activeLog.logout_time = new Date().toISOString();
        console.log(`Auto-Logout recorded for ${user.username}.`);
    }
}

// Attach the function to run just before the user leaves the page.
window.addEventListener('beforeunload', recordLogout);

// --- END SESSION LOGOUT HOOK ---
Â  Â  Â  Â  // --- DATA LOADERS ---
        
        function loadDocs() {
            // Start the subscription and let the subscription handle the initial rendering.
            subscribeToDocs(); 
        }

        // NEW: Live search functionality
        async function loadSummary() {
            const container = document.getElementById('summaryCardContainer');
            const searchInput = document.getElementById('employeeSearch');
            
            // 1. Initial Load: Fetch employees who have signed documents
            showSpinner();
            await fetchEmployeeData(); 
            hideSpinner();
            
            if (employeeDataCache.length === 0) {
                container.innerHTML = `<p class="text-red-500 text-center">No signed documents found. Cannot generate summary card.</p>`;
                return;
            }

            // 2. Set up event listeners for real-time filtering
            searchInput.oninput = () => renderEmployeeList(searchInput.value.toLowerCase());

            // 3. Render the full list initially
            renderEmployeeList('');

            // 4. Default message cleared by list or selection
            container.innerHTML = `<p class="text-gray-500 text-center">Select an employee from the list to view their detailed summary card.</p>`;
        }

        function renderEmployeeList(filterText) {
            const employeeListEl = document.getElementById('employeeList');
            employeeListEl.innerHTML = '';
            
            // FIX: Use employeeDataCache (signed employees) for the list
            const filteredUsers = employeeDataCache.filter(u => 
                u.first_name.toLowerCase().includes(filterText) || 
                u.last_name.toLowerCase().includes(filterText) ||
                u.username.toLowerCase().includes(filterText)
            ).sort((a, b) => a.last_name.localeCompare(b.last_name));

            if (filteredUsers.length === 0) {
                employeeListEl.innerHTML = `<p class="text-gray-500 text-sm py-2">No employees match your search.</p>`;
                return;
            }

            filteredUsers.forEach(u => {
                const userButton = document.createElement('button');
                userButton.className = 'w-full text-left p-2 rounded-lg hover:bg-[#B9965A]/20 transition duration-150 text-gray-800 text-sm';
                userButton.textContent = `${u.first_name} ${u.last_name} (${u.username})`;
                userButton.dataset.username = u.username;
                userButton.onclick = () => handleEmployeeSelect(u.username);
                employeeListEl.appendChild(userButton);
            });
        }
        
        async function handleEmployeeSelect(username) {
            const container = document.getElementById('summaryCardContainer');
            container.innerHTML = `<div class="spinner"></div><p class="mt-4 text-gray-500">Loading benefits data...</p>`;
            
            showSpinner();
            
            // 1. Fetch employee details and enrollment
            const { employee, enrollment } = await fetchEmployeeDetails(username);
            
            if (!employee || !enrollment) {
                hideSpinner();
                container.innerHTML = `
                    <div class="p-6 text-center bg-yellow-50 rounded-xl border border-yellow-200">
                        <p class="font-semibold text-gray-800">Employee data not fully available for ${username}.</p>
                        <p class="text-sm text-gray-500">Could not find employee record or completed enrollment form.</p>
                    </div>`;
                return;
            }

            // 2. Determine which plans were chosen
            const chosenPlans = [];
            if (enrollment.medical_plan && !enrollment.medical_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.medical_plan);
            if (enrollment.dental_plan && !enrollment.dental_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.dental_plan);
            if (enrollment.vision_plan && !enrollment.vision_plan.toUpperCase().includes('WAIVE')) chosenPlans.push(enrollment.vision_plan);

            // 3. Fetch rates based on chosen plans and employee tier
            const rates = await fetchPlanRates(chosenPlans, enrollment.tier_election);
            
            // 4. Render the final card
            renderSummaryCard(employee, enrollment, rates); // PASS RATES HERE
            
            hideSpinner();
        }


Â  Â  Â  Â  function loadUsers() {
Â  Â  Â  Â  Â  Â  if (currentUser.role !== 'admin') return;

Â  Â  Â  Â  Â  Â  const userBody = document.getElementById("userBody");
Â  Â  Â  Â  Â  Â  userBody.innerHTML = "";

Â  Â  Â  Â  Â  Â  // *** Use authorizedUsersCache for user table ***
Â  Â  Â  Â  Â  Â  if (authorizedUsersCache.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  userBody.innerHTML = `<tr><td colspan="6" class="py-4 text-center text-gray-400">No authorized users found</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  authorizedUsersCache.sort((a, b) => a.username.localeCompare(b.username)).forEach(u => {
Â  Â  Â  Â  Â  Â  Â  Â  const isActive = u.active ? "Yes" : "No";
Â  Â  Â  Â  Â  Â  Â  Â  userBody.insertAdjacentHTML("beforeend", `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b hover:bg-gray-50" data-id="${u.id}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-2 px-1">${esc(u.full_name)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${esc(u.username)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${esc(u.pin)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${esc(u.role)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${isActive}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="space-x-3 px-1">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="text-blue-600 hover:underline js-edit">Edit</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button class="text-red-600 hover:underline js-del">Delete</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }

function loadLogs() {
    if (currentUser.role !== 'admin') return;

    const logBody = document.getElementById("logBody");
    logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">Fetching logs from database...</td></tr>`;

    supabase
        .from('portal_logs')
        .select(`
            login_time, 
            logout_time, 
            duration_minutes,
            employee_data:employee_id (username)  /* <-- RENAMED ALIAS for safety */
        `)
        .order('login_time', { ascending: false })
        .limit(50) 
        .then(({ data: logData, error }) => {
            if (error) {
                console.error("DB Error fetching logs:", error);
                logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-600">Error fetching logs from database. Check RLS policies.</td></tr>`;
                return;
            }

            if (!logData || logData.length === 0) {
                logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No logs available.</td></tr>`;
                return;
            }
            
            logBody.innerHTML = "";
            logData.forEach(l => {
                // Access the username via the alias we created: l.employee_data.username
                const username = l.employee_data?.username || 'N/A';
                const loginTimeCST = formatTime(new Date(l.login_time));
                const logoutTimeCST = l.logout_time ? formatTime(new Date(l.logout_time)) : 'Active';
                
                // Display duration from the database field
                let durationDisplay = 'N/A';
                if (l.logout_time) {
                    // Check if duration_minutes is a valid number (non-null and non-negative)
                    durationDisplay = (typeof l.duration_minutes === 'number' && l.duration_minutes >= 0) 
                                      ? `${l.duration_minutes} min` 
                                      : 'N/A';
                } else {
                    durationDisplay = 'Active';
                }

                logBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-1">${esc(username)}</td>
                        <td class="px-1">${esc(loginTimeCST)}</td>
                        <td class="px-1">${esc(logoutTimeCST)}</td>
                        <td class="px-1">${durationDisplay}</td>
                    </tr>
                `);
            });
        })
        .catch(e => {
            console.error("Unknown error during log fetch:", e);
            logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-red-600">Unknown client error occurred.</td></tr>`;
        });
} Â Â 
Â  Â  Â  Â  // --- PRINTING LOGIC ---

Â  Â  Â  Â  // Helper function to render the actual table content
        function renderDocBody() {
            const docBody = document.getElementById("docBody");
            docBody.innerHTML = "";

            const signedDocs = employeeDataCache.filter(d => d.signed_pdf_url);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (signedDocs.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  docBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No signed documents available.</td></tr>`;
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  signedDocs.forEach(d => {
Â  Â  Â  Â  Â  Â  Â  Â  // Generate the actions column content
Â  Â  Â  Â  Â  Â  Â  Â  const docActions = d.signed_pdf_url ? `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <a href="${esc(d.signed_pdf_url)}" target="_blank" class="text-blue-600 hover:underline mr-3">View PDF</a>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-url="${esc(d.signed_pdf_url)}" class="text-gray-600 hover:text-gray-900 js-print" title="Print Document">ğŸ–¨ï¸</button>
Â  Â  Â  Â  Â  Â  Â  Â  ` : '<span class="text-gray-400">N/A</span>';

Â  Â  Â  Â  Â  Â  Â  Â  docBody.insertAdjacentHTML("beforeend", `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr class="border-b hover:bg-gray-50">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-2 px-1">${esc(d.first_name)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${esc(d.last_name)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${esc(d.username)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="px-1">${docActions}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  `);
Â  Â  Â  Â  Â  Â  });
        }

        // --- NEW SUMMARY CARD RENDERING LOGIC ---

        function renderSummaryCard(employee, enrollment, rates) {
            const container = document.getElementById('summaryCardContainer');
            
            // Helper function to format dependent and beneficiary lists
            const renderList = (items) => {
                if (!items || items.length === 0 || JSON.stringify(items) === '[]') {
                    return `<span class="text-gray-500">None declared</span>`;
                }
                const listHtml = items.map((item, index) => {
                    const name = item.first ? `${item.first} ${item.last || ''}` : `Covered Individual ${index + 1}`;
                    const details = item.relationship || item.role || 'N/A';
                    return `<li class="flex justify-between py-1 border-b border-dashed border-gray-100">
                                <span>${esc(name)}</span>
                                <span class="text-gray-600 text-sm">${esc(details)}</span>
                            </li>`;
                }).join('');
                return `<ul class="space-y-1 mt-2">${listHtml}</ul>`;
            };

            // Helper for plan display
            const getPlanText = (planCode) => {
                const code = esc(planCode);
                // Use the uppercase version for lookups and checks
                const upperCaseCode = code.toUpperCase(); 
                
                // Fallback variable for the display value (used if lookup fails or for WAIVE)
                let displayValue = planCode; 
                
                // Check for waiver/no selection first (using the uppercase code)
                if (upperCaseCode.includes('WAIVE') || upperCaseCode === 'NO' || !code) {
                    // If it's a waiver, use the original (unescaped) code/planCode as the value
                    displayValue = planCode || 'WAIVE';
                } else {
                    // Lookup the full display name using the normalized code. This now uses the static map.
                    displayValue = planDisplayNames[upperCaseCode] || planCode; 
                }
                
                // HTML-escape the final output string just before returning
                const escapedDisplay = esc(displayValue);

                // Return the formatted HTML using the escaped value
                return `<span class="text-green-600 font-semibold">${escapedDisplay}</span>`;
            };
                    
                    
            const getPerPeriodCost = (planCode, enrollmentPlan, rates) => {
                if (enrollmentPlan.toUpperCase().includes('WAIVE') || enrollmentPlan.toUpperCase() === 'NO') {
                    return 0;
                }
                
                const rateItem = rates.find(r => r.plan_code === planCode);
                return rateItem ? rateItem.per_period_cost : 0;
            };

            const medicalPlanCode = enrollment.medical_plan;
            const dentalPlanCode = enrollment.dental_plan;
            const visionPlanCode = enrollment.vision_plan;

            const costMedical = getPerPeriodCost(medicalPlanCode, medicalPlanCode, rates);
            const costDental = getPerPeriodCost(dentalPlanCode, dentalPlanCode, rates);
            const costVision = getPerPeriodCost(visionPlanCode, visionPlanCode, rates);
            
            const totalMonthlyPremium = costMedical + costDental + costVision;

            const cardHtml = `
            <div class="w-full bg-white border border-gray-200 rounded-xl shadow-2xl overflow-hidden my-4">
                <div class="accent-gold p-6 text-white">
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="text-3xl font-extrabold tracking-tight">${esc(employee.first_name)} ${esc(employee.last_name)}</h3>
                            <p class="text-sm font-light opacity-80 mt-1">Benefit Enrollment Summary â€” Signed ${formatDate(enrollment.signed_at)}</p>
                        </div>
                        <div class="text-right">
                            <p class="text-base font-medium">${esc(employee.username)}</p>
                            <p class="text-xs opacity-70">${esc(employee.job_title)}</p>
                        </div>
                    </div>
                </div>

                <div class="p-6 space-y-8">
                    <!-- SECTION 1: FINANCIAL & TIER -->
                    <div class="grid grid-cols-1 sm:grid-cols-3 gap-6 border-b pb-6">
                        <div class="p-3 bg-gray-50 rounded-lg shadow-inner col-span-full">
                            <p class="text-sm font-medium text-gray-500">Tier Election</p>
                            <p class="text-lg font-bold text-gray-800">${esc(enrollment.tier_election || 'N/A')}</p>
                        </div>
                        <div class="p-3 bg-gray-50 rounded-lg shadow-inner col-span-full sm:col-span-3">
                           <p class="text-sm font-medium text-gray-500">Total Per Pay Period</p>
                           <p class="text-xl font-bold text-gray-800">${formatCurrency(totalMonthlyPremium)} per pay period</p>
                        </div>
                    </div>

                    <!-- SECTION 2: PLAN CHOICES & COSTS -->
                    <div class="space-y-4">
                        <h4 class="text-xl font-semibold text-gray-800 border-b pb-2">Plan Choices & Employee Monthly Cost</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <!-- MEDICAL -->
                            <div class="p-3 border rounded-lg ${costMedical > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium">Medical Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.medical_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costMedical)} / pay period</p>
                            </div>
                            <!-- DENTAL -->
                            <div class="p-3 border rounded-lg ${costDental > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium">Dental Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.dental_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costDental)} / pay period</p>
                            </div>
                            <!-- VISION -->
                            <div class="p-3 border rounded-lg ${costVision > 0 ? 'border-green-300 bg-green-50' : 'border-gray-300 bg-gray-50'}">
                                <p class="font-medium">Vision Plan</p>
                                <p class="text-sm">${getPlanText(enrollment.vision_plan)}</p>
                                <p class="text-sm mt-1 font-semibold text-gray-700">Cost: ${formatCurrency(costVision)} / pay period</p>
                            </div>
                        </div>
                    </div>

                    <!-- SECTION 3: COVERED INDIVIDUALS -->
                    <div class="grid grid-cols-1 sm:grid-cols-2 gap-8 pt-4 border-t">
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Dependents/Spouse</h4>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                ${enrollment.spouse ? `<p class="text-sm font-medium text-gray-800 mb-1">Spouse: ${enrollment.spouse.full_name || 'Covered'}</p>` : ''}
                                ${renderList(enrollment.dependents)}
                            </div>
                        </div>
                        <div>
                            <h4 class="text-lg font-semibold text-gray-800 mb-2">Beneficiaries</h4>
                            <div class="bg-gray-50 p-3 rounded-lg">
                                ${renderList(enrollment.beneficiaries)}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            `;
            container.innerHTML = cardHtml;
        }


Â  Â  Â  Â  // Event listener for per-employee print button in Documents table
Â  Â  Â  Â  const docBody = document.getElementById("docBody");
Â  Â  Â  Â  docBody.addEventListener("click", (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.classList.contains("js-print")) {
Â  Â  Â  Â  Â  Â  Â  Â  const url = e.target.dataset.url;
Â  Â  Â  Â  Â  Â  Â  Â  if (url) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  window.open(url, "_blank");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`Print window opened for document: ${url.substring(url.lastIndexOf('/') + 1)}`, "Print Initiated");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  Â  Â Â 
Â  Â  Â  Â  const printMenuBtn = document.getElementById("printMenuBtn");
Â  Â  Â  Â  const printMenu = document.getElementById("printMenu");

Â  Â  Â  Â  printMenuBtn.onclick = () => printMenu.classList.toggle("hidden");
Â  Â  Â  Â  document.addEventListener("click", (e) => {
Â  Â  Â  Â  Â  Â  if (!printMenu.contains(e.target) && e.target !== printMenuBtn) printMenu.classList.add("hidden");
Â  Â  Â  Â  });

Â  Â  Â  Â  document.getElementById("printAll").onclick = async () => {
Â  Â  Â  Â  Â  Â  printMenu.classList.add("hidden");
Â  Â  Â  Â  Â  Â  const docsToPrint = employeeDataCache.filter(d => d.signed_pdf_url);

Â  Â  Â  Â  Â  Â  if (docsToPrint.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return showAlert("No signed documents found to print.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  showSpinner(); // Show spinner while preparing view

Â  Â  Â  Â  Â  Â  // 1. Prepare HTML content
Â  Â  Â  Â  Â  Â  const iframeHtml = docsToPrint.map((doc, index) => `
Â  Â  Â  Â  Â  Â  Â  Â  <div class="print-iframe p-4 bg-white rounded-lg shadow-md mb-8">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-semibold mb-2 accent-gold-text">Document ${index + 1}: ${doc.first_name} ${doc.last_name} (${doc.username})</h2>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <!-- Embed PDF using iframe -->
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <iframe src="${esc(doc.signed_pdf_url)}" class="w-full" style="height: 80vh; border: 1px solid #ccc;"></iframe>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  `).join('');
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  printContainerContent.innerHTML = iframeHtml;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 2. Switch to print view
Â  Â  Â  Â  Â  Â  dashboard.classList.add("hidden");
Â  Â  Â  Â  Â  Â  printView.classList.remove("hidden");

Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // 3. Trigger print (with slight delay to ensure view renders)
Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 50));Â 
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  window.print();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Inform the user about the next step
Â  Â  Â  Â  Â  Â  showAlert("The Print View is now open. Please use your browser's Print function (Ctrl+P or Cmd+P). Click **'Close Print View'** when done to return to the dashboard.", "Print View Ready");
Â  Â  Â  Â  };

Â  Â  Â  Â  document.getElementById("printByEmployee").onclick = async () => {
Â  Â  Â  Â  Â  Â  printMenu.classList.add("hidden");
Â  Â  Â  Â  Â  Â  const docsWithPDFs = employeeDataCache.filter(d => d.signed_pdf_url);

Â  Â  Â  Â  Â  Â  if (docsWithPDFs.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  return showAlert("No signed documents found.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const choices = docsWithPDFs.map(d => `${d.first_name} ${d.last_name} (${d.username})`).sort();
Â  Â  Â  Â  Â  Â  const choiceList = choices.map((c, i) => `[${i + 1}] ${c}`).join("\n");

Â  Â  Â  Â  Â  Â  const selPrompt = `Select an employee by entering their name/username or the corresponding number.\n\n${choiceList}`;

Â  Â  Â  Â  Â  Â  const selectedValue = await showPrompt(selPrompt, "Print by Employee");

Â  Â  Â  Â  Â  Â  if (!selectedValue) return; // Cancelled or empty input

Â  Â  Â  Â  Â  Â  let selectedUser;

Â  Â  Â  Â  Â  Â  // Try to match by number index
Â  Â  Â  Â  Â  Â  const index = parseInt(selectedValue);
Â  Â  Â  Â  Â  Â  if (!isNaN(index) && index >= 1 && index <= choices.length) {
Â  Â  Â  Â  Â  Â  Â  Â  selectedUser = choices[index - 1];
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // Try to match by name or username (case-insensitive)
Â  Â  Â  Â  Â  Â  Â  Â  selectedUser = choices.find(c => c.toLowerCase().includes(selectedValue.toLowerCase()));
Â  Â  Â  Â  Â  Â  }


Â  Â  Â  Â  Â  Â  if (!selectedUser) {
Â  Â  Â  Â  Â  Â  Â  Â  return showAlert("Invalid selection. Please enter a valid name/username or number from the list.");
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  const usernameMatch = selectedUser.match(/\((.*?)\)/);
Â  Â  Â  Â  Â  Â  if (!usernameMatch) return showAlert("Internal error: Could not parse username.");

Â  Â  Â  Â  Â  Â  const targetUsername = usernameMatch[1];
Â  Â  Â  Â  Â  Â  const documentsToPrint = employeeDataCache.filter(d => d.username === targetUsername && d.signed_pdf_url);

Â  Â  Â  Â  Â  Â  if (documentsToPrint.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  Â return showAlert(`No signed documents found for **${selectedUser}**.`);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // Since only one user is selected, opening in a new tab is efficient and reliable
Â  Â  Â  Â  Â  Â  documentsToPrint.forEach(d => window.open(d.signed_pdf_url, "_blank"));
Â  Â  Â  Â  Â  Â  showAlert(`Opened ${documentsToPrint.length} document(s) for **${selectedUser}** in new tabs.`, "Print Initiated");
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- USER CRUD LOGIC ---

Â  Â  Â  Â  const userBody = document.getElementById("userBody");
Â  Â  Â  Â  userBody.addEventListener("click", async (e) => {
Â  Â  Â  Â  Â  Â  if (currentUser.role !== 'admin') return;

Â  Â  Â  Â  Â  Â  const row = e.target.closest("tr[data-id]");
Â  Â  Â  Â  Â  Â  if (!row) return;
Â  Â  Â  Â  Â  Â  const id = parseInt(row.dataset.id);
Â  Â  Â  Â  Â  Â  // *** Find user in authorizedUsersCache ***
Â  Â  Â  Â  Â  Â  const user = authorizedUsersCache.find(u => u.id === id);
Â  Â  Â  Â  Â  Â  if (!user) return;

Â  Â  Â  Â  Â  Â  if (e.target.classList.contains("js-edit")) {
Â  Â  Â  Â  Â  Â  Â  Â  openModal(user);
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (e.target.classList.contains("js-del")) {
Â  Â  Â  Â  Â  Â  Â  Â  const isConfirmed = await showConfirm(`Are you sure you want to delete the user: **${esc(user.full_name)} (${esc(user.username)})**?`);

Â  Â  Â  Â  Â  Â  Â  Â  if (!isConfirmed) return;

Â  Â  Â  Â  Â  Â  Â  Â  showSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  // Simulate Delete
                // NOTE: This should be a Supabase DELETE call in a production app.
Â  Â  Â  Â  Â  Â  Â  Â  const index = AUTHORIZED_USERS.findIndex(u => u.id === id);
Â  Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  authorizedUsersCache.splice(index, 1);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showAlert(`User **${esc(user.full_name)}** deleted successfully.`, "User Deleted");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  loadUsers();
Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  // User Modal Logic (Add/Edit)
Â  Â  Â  Â  const userModal = document.getElementById("userModal");
Â  Â  Â  Â  const modalTitle = document.getElementById("modalTitle");
Â  Â  Â  Â  const modalFullName = document.getElementById("modalFullName");
Â  Â  Â  Â  const modalUsername = document.getElementById("modalUsername");
Â  Â  Â  Â  const modalPin = document.getElementById("modalPin");
Â  Â  Â  Â  const modalRole = document.getElementById("modalRole");
Â  Â  Â  Â  const modalActive = document.getElementById("modalActive"); // Added active checkbox
Â  Â  Â  Â  const modalCancel = document.getElementById("modalCancel");
Â  Â  Â  Â  const modalSave = document.getElementById("modalSave");
Â  Â  Â  Â  let editingId = null;

Â  Â  Â  Â  document.getElementById("addUser").onclick = () => openModal(null);

Â  Â  Â  Â  function openModal(user) {
Â  Â  Â  Â  Â  Â  editingId = user ? user.id : null;
Â  Â  Â  Â  Â  Â  modalTitle.textContent = editingId ? "Edit Authorized User" : "Add New Authorized User";
Â  Â  Â  Â  Â  Â  modalFullName.value = user?.full_name || "";
Â  Â  Â  Â  Â  Â  modalUsername.value = user?.username || "";
Â  Â  Â  Â  Â  Â  modalPin.value = user?.pin || "";
Â  Â  Â  Â  Â  Â  modalRole.value = user?.role || "user";
Â  Â  Â  Â  Â  Â  modalActive.checked = user ? !!user.active : true;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Disable editing username/role for the admin PG (id 2)
Â  Â  Â  Â  Â  Â  const isPg = user?.id === 2;Â 
Â  Â  Â  Â  Â  Â  modalUsername.disabled = isPg;
Â  Â  Â  Â  Â  Â  modalRole.disabled = isPg;
Â  Â  Â  Â  Â  Â  modalActive.disabled = isPg;

Â  Â  Â  Â  Â  Â  userModal.classList.remove("hidden");
Â  Â  Â  Â  Â  Â  modalFullName.focus();
Â  Â  Â  Â  }

Â  Â  Â  Â  modalCancel.onclick = () => userModal.classList.add("hidden");

Â  Â  Â  Â  modalSave.onclick = async () => {
Â  Â  Â  Â  Â  Â  if (currentUser.role !== 'admin') return;
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showSpinner();
Â  Â  Â  Â  Â  Â  await new Promise(r => setTimeout(r, 200)); // Simulate save delay

Â  Â  Â  Â  Â  Â  const fullName = modalFullName.value.trim();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  // Ensure pin is converted to string for storage matching
Â  Â  Â  Â  Â  Â  const pinString = String(modalPin.value).trim();

Â  Â  Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  Â  Â  Â  full_name: fullName,
Â  Â  Â  Â  Â  Â  Â  Â  username: modalUsername.value.trim().toUpperCase(),
Â  Â  Â  Â  Â  Â  Â  Â  pin: pinString,
Â  Â  Â  Â  Â  Â  Â  Â  role: modalRole.value,
Â  Â  Â  Â  Â  Â  Â  Â  active: modalActive.checked,
Â  Â  Â  Â  Â  Â  };

Â  Â  Â  Â  Â  Â  if (!payload.username || !payload.pin || !fullName) {
Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  return showAlert("All fields (Full Name, Username, PIN) are required.", "Input Error");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  if (payload.pin.length !== 4 || isNaN(payload.pin)) {
Â  Â  Â  Â  Â  Â  Â  Â  Â hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  Â return showAlert("PIN must be exactly 4 digits.", "Input Error");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  let action = "Updated";

Â  Â  Â  Â  Â  Â  if (editingId) {
Â  Â  Â  Â  Â  Â  Â  Â  // UPDATE
Â  Â  Â  Â  Â  Â  Â  Â  const index = AUTHORIZED_USERS.findIndex(u => u.id === editingId);
Â  Â  Â  Â  Â  Â  Â  Â  if (index > -1) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Uniqueness checks for PIN/Username during update (must ignore current user)
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username && u.id !== editingId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin && u.id !== editingId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isUsernameTaken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showAlert(`The username **${payload.username}** is already in use by another user.`, "Update Failed");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (isPinTaken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showAlert(`The PIN **${payload.pin}** is already in use by another user.`, "Update Failed");
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  AUTHORIZED_USERS[index] = { ...AUTHORIZED_USERS[index], ...payload };
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  // CREATE
Â  Â  Â  Â  Â  Â  Â  Â  action = "Created";
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  // Uniqueness checks for new user
Â  Â  Â  Â  Â  Â  Â  Â  const isUsernameTaken = AUTHORIZED_USERS.some(u => u.username === payload.username);
Â  Â  Â  Â  Â  Â  Â  Â  const isPinTaken = AUTHORIZED_USERS.some(u => u.pin === payload.pin);

Â  Â  Â  Â  Â  Â  Â  Â  if (isUsernameTaken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showAlert(`The username **${payload.username}** is already in use.`, "Creation Failed");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (isPinTaken) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  return showAlert(`The PIN **${payload.pin}** is already in use.`, "Creation Failed");
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  Â  Â  AUTHORIZED_USERS.push({
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  id: nextAuthUserId++,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ...payload,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  created_at: new Date().toISOString()
Â  Â  Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // *** Load the user list automatically after save/create ***
Â  Â  Â  Â  Â  Â  loadUsers();
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  showAlert(`User **${esc(payload.username)}** ${action.toLowerCase()} successfully. The user list has been updated.`, `${action} Success`);
Â  Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  Â  Â  hideSpinner();
Â  Â  Â  Â  Â  Â  userModal.classList.add("hidden");
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  // Ensure nextAuthUserId is higher than any existing ID for new users
Â  Â  Â  Â  AUTHORIZED_USERS.forEach(u => {
Â  Â  Â  Â  Â  Â  if (u.id >= nextAuthUserId) {
Â  Â  Â  Â  Â  Â  Â  Â  nextAuthUserId = u.id + 1;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  </script>
</body>
</html>


