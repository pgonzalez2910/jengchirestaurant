<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <title>Jeng Chi — Executive Benefits Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <style>
    :root {
      --jc-red: #8a1619;
      --jc-red-soft: #c53030;
      --jc-navy: #003366;
      --jc-navy-soft: #0b3c73;
      --jc-gray-bg: #f4f5f7;
    }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
    }
    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
    }
    .input-border {
      border: 1px solid #111827;
    }
    .toast {
      position: fixed;
      inset-inline: 0;
      top: 1rem;
      margin-inline: auto;
      max-width: 22rem;
      z-index: 50;
    }
    .pill-badge {
      border-radius: 9999px;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }
    .tab-btn-active {
      border-bottom: 2px solid var(--jc-red);
      color: #111827;
      font-weight: 600;
    }
    .tab-btn-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }
    .cost-bar-track {
      height: 0.5rem;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
    }
    .cost-bar-med {
      background: var(--jc-red);
    }
    .cost-bar-den {
      background: #1d4ed8;
    }
    .cost-bar-vis {
      background: #4b5563;
    }
    .login-bg {
      background-color: #ffffff;
      background-image: none;
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
<div id="toast" class="toast hidden">
  <div id="toastInner" class="card px-4 py-3 flex items-start gap-3">
    <div id="toastIcon" class="mt-1">
      <i class="fa-solid fa-circle-check text-emerald-600"></i>
    </div>
    <div class="flex-1">
      <p id="toastTitle" class="font-semibold text-sm">Title</p>
      <p id="toastMessage" class="text-xs text-slate-600 mt-0.5">Message</p>
    </div>
    <button class="text-slate-400 hover:text-slate-600 text-xs" onclick="hideToast()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
</div>
<main id="loginView" class="login-bg min-h-screen flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-5xl grid lg:grid-cols-2 gap-10 items-center">
    <section class="space-y-8">
      <div class="space-y-6">
        <div class="flex flex-col items-center text-center gap-4">
          <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Jeng Chi Logo" class="h-20 w-auto" />
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-[color:var(--jc-navy)]">
              Executive Benefits Portal
            </h1>
            <p class="mt-2 text-sm md:text-base text-slate-600 max-w-xl mx-auto">
              Secure workspace for Jeng Chi executives and HR to review signed benefit elections,
              analytics, and access controls.
            </p>
          </div>
        </div>
      </div>
    </section>
    <section class="card px-6 py-7 space-y-6">
      <header class="space-y-1 text-center">
        <p class="text-[0.75rem] uppercase tracking-[0.24em] text-slate-500">
          Executive sign-in
        </p>
        <h2 class="text-xl font-semibold text-slate-900">
          Enter your portal credentials
        </h2>
        <p class="text-xs text-slate-500">
          Use the initials and PIN issued to you by HR or Ownership.
        </p>
      </header>
      <div class="space-y-4">
        <div>
          <label for="loginInitials" class="block text-xs font-semibold text-slate-700 mb-1">
            Initials
          </label>
          <input
            id="loginInitials"
            type="text"
            autocomplete="off"
            class="w-full rounded-md px-3 py-2 input-border bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label for="loginPin" class="block text-xs font-semibold text-slate-700 mb-1">
            PIN
          </label>
          <div class="relative">
            <input
              id="loginPin"
              type="password"
              autocomplete="off"
              maxlength="4"
              class="w-full rounded-md px-3 py-2 input-border bg-white text-sm pr-10 focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
            />
            <button
              id="togglePin"
              type="button"
              class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700"
            >
              <i class="fa-regular fa-eye text-xs"></i>
            </button>
          </div>
        </div>
      </div>
      <button
        id="loginButton"
        type="button"
        class="w-full inline-flex justify-center items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white text-sm font-semibold py-2.5 hover:bg-[color:var(--jc-red-soft)] transition-shadow shadow-sm hover:shadow"
      >
        <i class="fa-solid fa-right-to-bracket"></i>
        <span>Sign In</span>
      </button>
      <p class="mt-2 text-[0.7rem] text-slate-500 text-center">
        This is a secure executive benefits portal. Unauthorized access is prohibited.
      </p>
    </section>
  </div>
</main>
<div id="dashboardView" class="hidden min-h-screen bg-slate-50">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Jeng Chi Logo" class="h-11 w-auto" />
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Jeng Chi Restaurant
          </p>
          <h1 class="text-lg sm:text-xl font-semibold text-[color:var(--jc-navy)]">
            Executive Benefits Portal
          </h1>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden sm:flex flex-col items-end text-right">
          <span id="headerUserName" class="text-sm font-semibold text-slate-900"></span>
          <span id="headerUserRole" class="text-[0.7rem] text-slate-500"></span>
        </div>
        <button
          id="logoutButton"
          class="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50"
        >
          <i class="fa-solid fa-arrow-right-from-bracket"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </header>
  <section class="bg-slate-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 grid md:grid-cols-4 gap-4">
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Total Signed Employees
        </p>
        <p id="summarySignedEmployees" class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">0</p>
        <p class="text-xs text-slate-500 mt-1">
          Employees with finalized benefit packets.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Current Plan Year
        </p>
        <p class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">2026</p>
        <p class="text-xs text-slate-500 mt-1">
          Active comparison window for plan elections.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Active Benefit Cycle
        </p>
        <p id="cycleStatusLabel" class="mt-2 text-base font-semibold text-red-600">Under Review</p>
        <p id="cycleStatusDescription" class="text-xs text-slate-500 mt-1">
          Use the analytics tab for renewal discussions and budgeting.
        </p>
      </div>
      <div class="card px-4 py-3 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Cycle Status Control
          </p>
          <p class="text-xs text-slate-500 mt-1">
            Admins (Pablo, Garrett, Janelle) can update the cycle status.
          </p>
        </div>
        <div class="mt-3">
          <select
            id="cycleStatusSelect"
            class="w-full rounded-md border border-slate-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          >
            <option value="under_review">Under Review</option>
            <option value="received">Received</option>
            <option value="verified">Verified</option>
            <option value="finalized">Finalized</option>
          </select>
        </div>
      </div>
    </div>
  </section>
  <section class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-6 text-sm">
        <button id="tabDocs" class="py-3 tab-btn-active">
          Signed Documents
        </button>
        <button id="tabAnalytics" class="py-3 tab-btn-inactive">
          Benefit Summary
        </button>
        <button id="tabComparison" class="py-3 tab-btn-inactive">
          Employee Comparison
        </button>
        <button id="tabEmployeeList" class="py-3 tab-btn-inactive">
          2026 Employee Elections
        </button>
        <button id="tabAudit" class="py-3 tab-btn-inactive">
          Audit Logs
        </button>
        <button id="tabUsers" class="py-3 tab-btn-inactive">
          Authorized Users &amp; Portal Credentials
        </button>
      </nav>
    </div>
  </section>
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <section id="tabDocsContent" class="space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Signed Documents</h2>
          <p class="text-xs text-slate-500 mt-1">
            Alphabetical index of employees with completed, signed benefit packets.
          </p>
        </div>
        <div class="flex gap-2">
          <button
            id="printAllButton"
            class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
          >
            <i class="fa-solid fa-print"></i>
            <span>Print All</span>
          </button>
          <button
            id="mergeAllButton"
            class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
          >
            <i class="fa-solid fa-file-pdf"></i>
            <span>Merge &amp; Download All</span>
          </button>
        </div>
      </header>
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search employee by last name
          </label>
          <input
            id="docSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Total signed employees: <span id="docSignedCount">0</span>
        </p>
      </div>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5 w-10">#</th>
              <th class="text-left px-4 py-2.5">Employee</th>
              <th class="text-left px-4 py-2.5">Initials</th>
              <th class="text-left px-4 py-2.5">Actions</th>
            </tr>
          </thead>
          <tbody id="docBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading signed documents...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section id="tabAnalyticsContent" class="hidden space-y-8">
      <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="space-y-1.5">
          <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
            Benefit summary workspace
          </p>
          <h2 class="text-lg md:text-xl font-semibold text-slate-900">
            Employee Benefit Analytics
          </h2>
          <p class="text-xs text-slate-500 max-w-2xl">
            Executive view of enrollment trends, plan mix, and employee cost share across benefit years.
            Use this workspace live with your broker or CPA during renewal discussions.
          </p>
        </div>
        <div class="flex flex-wrap items-center gap-2 justify-start md:justify-end">
          <span class="pill-badge inline-flex items-center bg-red-50 text-red-700 border border-red-100 px-3 py-1">
            <span class="w-1.5 h-1.5 rounded-full bg-[color:var(--jc-red)] mr-1.5"></span>
            Cycle: under review
          </span>
          <span
            id="planYearBadge"
            class="pill-badge inline-flex items-center bg-slate-100 text-slate-700 border border-slate-200 px-3 py-1"
          >
            Plan years: 2025 · 2026
          </span>
          <label class="flex items-center gap-2 text-[0.7rem] text-slate-600 cursor-pointer">
            <input
              type="checkbox"
              id="toggle2027"
              class="rounded border-slate-300 text-[color:var(--jc-red)]"
            />
            <span>Show 2027 analytics (when data exists)</span>
          </label>
          <button
            type="button"
            class="inline-flex items-center gap-1.5 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-[0.7rem] font-medium text-slate-700 shadow-sm hover:bg-slate-50"
          >
            <i class="fa-solid fa-download text-[0.65rem]"></i>
            <span>Export snapshot</span>
          </button>
        </div>
      </header>
      <section class="space-y-3">
        <div class="flex flex-col gap-1 md:flex-row md:items-end md:justify-between">
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500">
              Plan year overview
            </p>
            <p class="text-xs text-slate-500">
              Counts by health, dental, and vision plan for each enrollment year.
            </p>
          </div>
          <p class="text-[0.65rem] text-slate-400 max-w-sm md:text-right">
            High-level metrics for leadership; detailed breakdowns appear inside each year card.
          </p>
        </div>
        <div class="grid lg:grid-cols-3 gap-4">
          <article id="planCard2025" class="card h-full px-4 py-4 md:px-5 md:py-5"></article>
          <article id="planCard2026" class="card h-full px-4 py-4 md:px-5 md:py-5">
            <div class="flex items-start justify-between gap-3 mb-4">
              <div>
                <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
                <h3 class="mt-1 text-sm font-semibold text-slate-900">2026 Elections</h3>
                <p class="mt-1 text-[0.72rem] text-slate-500">Current year mix by plan.</p>
              </div>
              <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span> Active year
              </span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartMedical2026" height="180"></canvas></div>
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartDental2026" height="180"></canvas></div>
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartVision2026" height="180"></canvas></div>
            </div>
            <div id="coverageSections2026"></div>
          </article>
          <article id="planCardFuture" class="card h-full px-4 py-4 md:px-5 md:py-5 hidden"></article>
        </div>
      </section>
      <section class="space-y-4">
        <h3 class="text-lg font-semibold text-slate-900">Total Employee Cost Breakdown (2026)</h3>
        <div class="card overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
              <tr>
                <th class="text-left px-4 py-2.5">Coverage</th>
                <th class="text-left px-4 py-2.5">Plan</th>
                <th class="text-right px-4 py-2.5">Count</th>
                <th class="text-right px-4 py-2.5">Total Annual Cost</th>
              </tr>
            </thead>
            <tbody id="costBreakdownBody" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>
    </section>
    <section id="tabComparisonContent" class="hidden space-y-6">
      <header class="border-b border-slate-200 pb-4">
        <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
          Per-employee analysis
        </p>
        <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">
          Employee Year-over-Year Comparison
        </h2>
        <p class="text-sm text-slate-600 max-w-3xl">
          Search by last name, then select an employee to compare their prior-year and current-year
          elections, including per-pay and annual cost impact. Use this workspace when reviewing upgrades,
          downgrades, or flat renewals with leadership.
        </p>
      </header>
      <div class="grid xl:grid-cols-[minmax(0,380px),minmax(0,1fr)] gap-6 items-start">
        <aside class="card px-5 py-5 sticky top-4">
          <div class="space-y-4">
            <div>
              <p class="text-xs font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider mb-2">
                Employee Navigator
              </p>
              <p class="text-xs text-slate-500 mb-3">
                Select an employee to view their benefit comparison
              </p>
            </div>
           
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                Search by last name
              </label>
              <input
                id="comparisonSearch"
                type="text"
                class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2
                       placeholder:text-slate-400 focus:outline-none focus:ring-2
                       focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
                placeholder="Type to filter employees..."
              />
            </div>
          </div>
         
          <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 overflow-hidden max-h-[500px]">
            <ul
              id="comparisonEmployeeList"
              class="overflow-y-auto text-sm divide-y divide-slate-200"
            >
              <li class="px-4 py-3 text-xs text-slate-500 text-center">
                Loading employees...
              </li>
            </ul>
          </div>
         
          <p class="mt-4 text-[0.65rem] text-slate-500 leading-relaxed">
            <i class="fa-solid fa-info-circle text-slate-400 mr-1"></i>
            Only employees with signed packets appear in this list to ensure analytics align with finalized enrollments.
          </p>
        </aside>
        <section
          id="employeeComparisonDisplay"
          class="card px-6 py-6 min-h-[500px]"
        >
          <div class="flex items-center justify-center h-full text-center">
            <div class="max-w-md space-y-3">
              <i class="fa-solid fa-user-chart text-4xl text-slate-300"></i>
              <p class="text-sm text-slate-600">
                Select an employee from the list to generate a detailed year-over-year comparison,
                including bi-weekly costs, annual totals, and change analysis.
              </p>
            </div>
          </div>
        </section>
      </div>
    </section>
   <section id="tabEmployeeListContent" class="hidden space-y-6">
      <!-- Header -->
      <header class="border-b border-slate-200 pb-6">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
              Corporate benefits registry
            </p>
            <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">
              2026 Benefit Elections
            </h2>
            <p class="text-sm text-slate-600 max-w-2xl">
              Complete enrollment registry for plan year 2026. Use filters and search to locate specific
              employees or analyze plan distribution across the organization.
            </p>
          </div>
          <div class="flex items-center gap-3">
            <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-4 py-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
              Active Plan Year
            </span>
            <button
              id="exportToExcel"
              class="inline-flex items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white px-4 py-2.5 text-sm font-medium hover:bg-[color:var(--jc-red-soft)] shadow-sm transition-all"
            >
              <i class="fa-solid fa-download"></i>
              Export to Excel
            </button>
          </div>
        </div>
      </header>
      <!-- Summary Statistics -->
    <!-- 2026 Employee Elections — KPI Cards (FINAL FIXED) -->
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
  <!-- Total Enrolled -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Total Enrolled</p>
        <p id="gridTotalEnrolled" class="text-3xl font-bold text-[color:var(--jc-navy)]">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
        <i class="fa-solid fa-users text-slate-600"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Employees with 2026 elections</p>
  </div>

  <!-- Medical -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Medical Coverage</p>
        <p id="gridMedicalCoverage" class="text-3xl font-bold text-[color:var(--jc-red)]">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
        <i class="fa-solid fa-heart-pulse text-[color:var(--jc-red)]"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active medical plan elections</p>
  </div>

  <!-- Dental -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Dental Coverage</p>
        <p id="gridDentalCoverage" class="text-3xl font-bold text-blue-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
        <i class="fa-solid fa-tooth text-blue-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active dental plan elections</p>
  </div>

  <!-- Vision -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Vision Coverage</p>
        <p id="gridVisionCoverage" class="text-3xl font-bold text-slate-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
        <i classsc="fa-solid fa-eye text-slate-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active vision plan elections</p>
  </div>

  <!-- Life & AD&D -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Life &amp; AD&amp;D</p>
        <p id="gridLifeCoverage" class="text-3xl font-bold text-emerald-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center">
        <i class="fa-solid fa-shield-heart text-emerald-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Employees with beneficiary designation</p>
  </div>
</div>
             <!-- Search and Filters -->
      <div class="card px-5 py-4">
        <div class="flex flex-col md:flex-row gap-4">
          <div class="flex-1">
            <label class="block text-xs font-semibold text-slate-700 mb-2">
              <i class="fa-solid fa-search mr-1"></i> Search Employees
            </label>
            <input
              id="gridSearch"
              type="text"
              placeholder="Search by name..."
              class="w-full rounded-md border border-slate-300 bg-white px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
            />
          </div>
          <div class="md:w-64">
            <label class="block text-xs font-semibold text-slate-700 mb-2">
              <i class="fa-solid fa-filter mr-1"></i> Filter by Coverage
            </label>
            <select
              id="gridCoverageFilter"
              class="w-full rounded-md border border-slate-300 bg-white px-4 py-2.5 text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
            >
              <option value="all">All Coverage Types</option>
              <option value="medical">Medical Plans</option>
              <option value="dental">Dental Plans</option>
              <option value="vision">Vision Plans</option>
              <option value="life">Life & AD&D</option>
            </select>
          </div>
        </div>
      </div>
      <!-- Tabbed Coverage View -->
      <div class="card overflow-hidden">
        <div class="border-b border-slate-200 bg-slate-50">
          <nav class="flex px-5">
            <button
              id="gridTabMedical"
              class="px-6 py-4 text-sm font-medium border-b-2 border-[color:var(--jc-red)] text-[color:var(--jc-red)]"
            >
              <i class="fa-solid fa-heart-pulse mr-2"></i>
              Medical Plans
            </button>
            <button
              id="gridTabDental"
              class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900"
            >
              <i class="fa-solid fa-tooth mr-2"></i>
              Dental Plans
            </button>
            <button
              id="gridTabVision"
              class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900"
            >
              <i class="fa-solid fa-eye mr-2"></i>
              Vision Plans
            </button>
            <button
              id="gridTabLife"
              class="px-6 py-4 text-sm font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-900"
            >
              <i class="fa-solid fa-shield-halved mr-2"></i>
              Life & AD&D
            </button>
          </nav>
        </div>
        <!-- Medical Tab Content -->
        <div id="gridContentMedical" class="p-6 space-y-6">
          <!-- Waived Coverage -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                Waived Coverage
              </h3>
              <span class="pill-badge bg-slate-100 text-slate-700 px-3 py-1" id="countWaived">35 employees</span>
            </div>
            <div id="gridWaived" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- HMO / ATBAB303 -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-[color:var(--jc-red)]"></span>
                HMO / ATBAB303
              </h3>
              <span class="pill-badge bg-red-50 text-red-700 border border-red-100 px-3 py-1" id="count303">4 employees</span>
            </div>
            <div id="grid303" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- HMO HSA / ATBAP393 -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-emerald-600"></span>
                HMO HSA / ATBAP393
              </h3>
              <span class="pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1" id="count393">2 employees</span>
            </div>
            <div id="grid393" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- PPO / ATBCB402 -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-blue-600"></span>
                PPO / ATBCB402
              </h3>
              <span class="pill-badge bg-blue-50 text-blue-700 border border-blue-100 px-3 py-1" id="count402">2 employees</span>
            </div>
            <div id="grid402" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
        </div>
        <!-- Dental Tab Content -->
        <div id="gridContentDental" class="hidden p-6 space-y-6">
          <!-- Waived Dental -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                Waived Coverage
              </h3>
              <span class="pill-badge bg-slate-100 text-slate-700 px-3 py-1" id="countDentalWaive">3 employees</span>
            </div>
            <div id="gridDentalWaive" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- F-PLAN 2W -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-blue-600"></span>
                F-PLAN 2W / Base MAC
              </h3>
              <span class="pill-badge bg-blue-50 text-blue-700 border border-blue-100 px-3 py-1" id="countF2W">23 employees</span>
            </div>
            <div id="gridF2W" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- F-PLAN 3W -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-indigo-600"></span>
                F-PLAN 3W / Buy Up MAC
              </h3>
              <span class="pill-badge bg-indigo-50 text-indigo-700 border border-indigo-100 px-3 py-1" id="countF3W">17 employees</span>
            </div>
            <div id="gridF3W" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
        </div>
        <!-- Vision Tab Content -->
        <div id="gridContentVision" class="hidden p-6 space-y-6">
          <!-- Waived Vision -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                Waived Coverage
              </h3>
              <span class="pill-badge bg-slate-100 text-slate-700 px-3 py-1" id="countVisionWaive">3 employees</span>
            </div>
            <div id="gridVisionWaive" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- Vision Plan 1 -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-slate-700"></span>
                Vision Plan 1
              </h3>
              <span class="pill-badge bg-slate-100 text-slate-700 border border-slate-200 px-3 py-1" id="countVision1">40 employees</span>
            </div>
            <div id="gridVision1" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
        </div>
        <!-- Life & AD&D Tab Content -->
        <div id="gridContentLife" class="hidden p-6 space-y-6">
          <!-- With Designation -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-emerald-600"></span>
                With Designation (Taken)
              </h3>
              <span class="pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1" id="countWithDes">0 employees</span>
            </div>
            <div id="gridWithDes" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
          <!-- Without Designation -->
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <h3 class="text-sm font-bold text-slate-900 uppercase tracking-wider flex items-center gap-3">
                <span class="w-3 h-3 rounded-full bg-slate-400"></span>
                Without Designation (Waived)
              </h3>
              <span class="pill-badge bg-slate-100 text-slate-700 px-3 py-1" id="countWithoutDes">0 employees</span>
            </div>
            <div id="gridWithoutDes" class="grid sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-3"></div>
          </div>
        </div>
      </div>
    </section>
    <section id="tabAuditContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Audit Logs</h2>
          <p class="text-xs text-slate-500 mt-1">Track portal access and actions (admin only).</p>
        </div>
      </header>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5">Portal User</th>
              <th class="text-left px-4 py-2.5">Login Time</th>
              <th class="text-left px-4 py-2.5">Logout Time</th>
              <th class="text-left px-4 py-2.5">Duration (min)</th>
              <th class="text-left px-4 py-2.5">Tab History</th>
            </tr>
          </thead>
          <tbody id="auditBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading audit logs...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section id="tabUsersContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">
            Authorized Users &amp; Portal Credentials
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Manage who can access this Executive Benefits Portal. Changes write directly to the
            <span class="font-mono">portal_users</span> table.
          </p>
        </div>
        <button
          id="addUserButton"
          class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
        >
          <i class="fa-solid fa-user-plus"></i>
          <span>Add User</span>
        </button>
      </header>
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search by last name
          </label>
          <input
            id="userSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Role legend: <span class="font-semibold">Administrator</span> can view analytics and manage users;
          <span class="font-semibold">Standard User</span> can only view Signed Documents.
        </p>
      </div>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
          <tr>
            <th class="text-left px-4 py-2.5">Full name</th>
            <th class="text-left px-4 py-2.5">Initials</th>
            <th class="text-left px-4 py-2.5">Role</th>
            <th class="text-left px-4 py-2.5">Last login</th>
            <th class="text-left px-4 py-2.5">Status</th>
            <th class="text-left px-4 py-2.5">Actions</th>
          </tr>
          </thead>
          <tbody id="userBody" class="divide-y divide-slate-100">
          <tr>
            <td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">
              Loading users...
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>
<div
  id="userModal"
  class="fixed inset-0 bg-black/30 hidden items-center justify-center z-40 px-4"
>
  <div class="card w-full max-w-md px-6 py-5">
    <h3 id="userModalTitle" class="text-base font-semibold text-slate-900 mb-4">
      Add User
    </h3>
    <div class="space-y-3 text-sm">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Full name</label>
        <input
          id="modalFullName"
          type="text"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        />
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Initials</label>
          <input
            id="modalInitials"
            type="text"
            maxlength="3"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">PIN (4 digits)</label>
          <input
            id="modalPin"
            type="password"
            maxlength="4"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Role</label>
        <select
          id="modalRole"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        >
          <option value="user">Standard User</option>
          <option value="admin">Administrator</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <input id="modalActive" type="checkbox" class="rounded border-slate-300 text-[color:var(--jc-red)]" checked />
        <label for="modalActive" class="text-xs text-slate-700">Portal active</label>
      </div>
    </div>
    <div class="mt-5 flex justify-end gap-3">
      <button
        id="modalCancel"
        class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
      >
        Cancel
      </button>
      <button
        id="modalSave"
        class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
      >
        Save
      </button>
    </div>
  </div>
</div>
<script>
  // ======================== ERROR HANDLERS (MUST BE FIRST) ========================
  window.addEventListener('error', function(e) {
    console.error('Global error caught:', {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      error: e.error
    });
  });
  window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
  });
  // ------------------------ SUPABASE CONFIG ------------------------
  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
  let supabase = null;
 
  try {
    if (window.supabase) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      console.error("Supabase script not loaded");
    }
  } catch (err) {
    console.error("Supabase initialization failed:", err);
  }
  // Verify Supabase connection
  (async function verifySupa() {
    if (!supabase) return;
    try {
      const { data, error } = await supabase
        .from("portal_users")
        .select("count")
        .limit(1);
     
      if (error) {
        console.error("Supabase connection failed:", error);
        alert("Database connection error. Please check your configuration.");
      } else {
        console.log("✓ Supabase connected successfully");
      }
    } catch (err) {
      console.error("Supabase initialization error:", err);
    }
  })();
  // ------------------------ GLOBAL STATE ------------------------
  let currentUser = null;
  let currentLogId = null;
  let docsCache = [];
  let portalUsersCache = [];
  let analyticsEmployees = [];
  let benefitRates = [];
  let planYearStats = null;
  let analyticsHas2027 = false;
  let analyticsRendered = false;
  let comparisonEmployees = [];
  let comparisonRendered = false;
  let fullEnrollments = [];
  let RATES = {};
  const YEARS = [2025, 2026, 2027];
  // ------------------------ TOASTS ------------------------
  function showToast({ title, message, type }) {
    const toast = document.getElementById("toast");
    const inner = document.getElementById("toastInner");
    const titleEl = document.getElementById("toastTitle");
    const msgEl = document.getElementById("toastMessage");
    const iconEl = document.getElementById("toastIcon");
    titleEl.textContent = title || "";
    msgEl.textContent = message || "";
    iconEl.innerHTML = "";
    inner.classList.remove("border-emerald-200", "border-red-200", "border-slate-200");
    if (type === "success") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-emerald-600"></i>';
      inner.classList.add("border", "border-emerald-200");
    } else if (type === "error") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';
      inner.classList.add("border", "border-red-200");
    } else {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-info text-slate-500"></i>';
      inner.classList.add("border", "border-slate-200");
    }
    toast.classList.remove("hidden");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => {
      hideToast();
    }, 3500);
  }
  function hideToast() {
    document.getElementById("toast").classList.add("hidden");
  }
  // ------------------------ HELPERS ------------------------
  function esc(str) {
    return String(str ?? "").replace(/[&<>"']/g, (s) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    })[s]);
  }
  const formatCurrency = (value) =>
    new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
    }).format(value || 0);
  const formatDate = (value) =>
    value ? new Date(value).toLocaleString("en-US", { dateStyle: "short", timeStyle: "short" }) : "—";
  async function safeSupabaseQuery(queryPromise, errorContext) {
    try {
      const { data, error } = await queryPromise;
     
      if (error) {
        console.error(`${errorContext}:`, error);
        throw error;
      }
     
      return data;
    } catch (err) {
      console.error(`${errorContext} - Unexpected error:`, err);
      showToast({
        title: "Database Error",
        message: `${errorContext}: ${err.message}`,
        type: "error",
      });
      throw err;
    }
  }
  // ------------------------ LOGIN VIEW ------------------------
  const loginView = document.getElementById("loginView");
  const dashboardView = document.getElementById("dashboardView");
  const loginBtn = document.getElementById("loginButton");
  const loginInitials = document.getElementById("loginInitials");
  const loginPin = document.getElementById("loginPin");
  const togglePinBtn = document.getElementById("togglePin");
  togglePinBtn.addEventListener("click", () => {
    const type = loginPin.type === "password" ? "text" : "password";
    loginPin.type = type;
    togglePinBtn.innerHTML =
      type === "password"
        ? '<i class="fa-regular fa-eye text-xs"></i>'
        : '<i class="fa-regular fa-eye-slash text-xs"></i>';
  });
  loginInitials.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginPin.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginBtn.addEventListener("click", login);
  async function login() {
    if (!supabase) {
      alert("Supabase connection failed. Please reload the page.");
      return;
    }
    const initials = loginInitials.value.trim().toUpperCase();
    const pin = loginPin.value.trim();
    if (!initials || !pin) {
      showToast({
        title: "Invalid credentials",
        message: "Initials and PIN are required.",
        type: "error",
      });
      return;
    }
    if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }
    try {
      const { data: user, error } = await supabase
        .from("portal_users")
        .select("*")
        .eq("initials", initials)
        .eq("pin", pin)
        .eq("active", true)
        .maybeSingle();
      if (error) throw error;
      if (!user) {
        showToast({
          title: "Invalid credentials",
          message: "Check your initials and PIN.",
          type: "error",
        });
        return;
      }
      currentUser = user;
      await supabase.from("portal_users").update({ last_login: new Date().toISOString() }).eq("id", user.id);
      // Create a log row linked to portal_user_id (MANDATORY)
      const { data: logRow, error: logError } = await supabase
        .from("portal_logs")
        .insert([{
          portal_user_id: user.id,
          employee_id: null,
          tab_history: ["Dashboard"] // Initialize history
        }])
        .select("id")
        .single();
      if (logError) {
        console.error("Failed to create portal log:", logError);
        showToast({ title: "Warning", message: "Logged in but audit log failed", type: "error" });
      } else if (logRow) {
        currentLogId = logRow.id;
      }
     
      sessionStorage.setItem(
        "portal_user",
        JSON.stringify({ ...currentUser, log_id: currentLogId || null })
      );
      showToast({
        title: "Login successful",
        message: "Redirecting to the Executive Benefits Portal.",
        type: "success",
      });
      setTimeout(() => showDashboard(), 700);
    } catch (err) {
      console.error("Login error", err);
      showToast({
        title: "Login error",
        message: "Unexpected error. See console for details.",
        type: "error",
      });
    }
  }
  // ------------------------ DASHBOARD SETUP ------------------------
  const logoutButton = document.getElementById("logoutButton");
  logoutButton.addEventListener("click", handleLogout);
  async function handleLogout() {
    if (currentLogId) {
      try {
        const { data: logRow } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", currentLogId)
          .maybeSingle();
        let duration = null;
        if (logRow && logRow.login_time) {
          const loginTime = new Date(logRow.login_time);
          const now = new Date();
          duration = Math.round((now - loginTime) / (1000 * 60));
        }
        await supabase
          .from("portal_logs")
          .update({
            logout_time: new Date().toISOString(),
            duration_minutes: duration,
          })
          .eq("id", currentLogId);
      } catch (err) {
        console.error("Error recording logout", err);
      }
    }
    currentUser = null;
    currentLogId = null;
    sessionStorage.removeItem("portal_user");
    dashboardView.classList.add("hidden");
    loginView.classList.remove("hidden");
  }
  // ------------------------ AUTO LOGOUT ON PAGE CLOSE ------------------------
  window.addEventListener('beforeunload', function(e) {
    if (currentLogId && currentUser) {
      const confirmationMessage = 'You are still logged in. Would you like to log out before closing?';
      e.preventDefault();
      e.returnValue = confirmationMessage;
     
      const logoutData = {
        logout_time: new Date().toISOString(),
        duration_minutes: null
      };
      navigator.sendBeacon(
        `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}&select=login_time`,
        new Blob([JSON.stringify({})], { type: 'application/json' })
      );
      const blob = new Blob([JSON.stringify({
        logout_time: logoutData.logout_time,
        duration_minutes: logoutData.duration_minutes
      })], { type: 'application/json' });
      navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`, blob);
      fetch(`${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(logoutData),
        keepalive: true
      }).catch(err => console.error("Auto-logout error:", err));
     
      return confirmationMessage;
    }
  });
  document.addEventListener('visibilitychange', async function() {
    if (document.visibilityState === 'hidden' && currentLogId) {
      try {
        const { data: logRow } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", currentLogId)
          .maybeSingle();
        let duration = null;
        if (logRow && logRow.login_time) {
          const loginTime = new Date(logRow.login_time);
          const now = new Date();
          duration = Math.round((now - loginTime) / (1000 * 60));
        }
        await supabase
          .from("portal_logs")
          .update({
            logout_time: new Date().toISOString(),
            duration_minutes: duration,
          })
          .eq("id", currentLogId);
       
        console.log("Auto-logged out due to tab close/hide");
      } catch (err) {
        console.error("Visibility change logout error:", err);
      }
    }
  });
  window.addEventListener('pagehide', function(e) {
    if (currentLogId) {
      navigator.sendBeacon(
        `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`,
        new Blob([JSON.stringify({
          logout_time: new Date().toISOString()
        })], { type: 'application/json' })
      );
    }
  });
  function showDashboard() {
    loginView.classList.add("hidden");
    dashboardView.classList.remove("hidden");
    updateHeaderUser();
    updateCycleStatusUI();
    applyRoleVisibility();
    loadSignedDocuments();
    loadPortalUsers();
  }
  function updateHeaderUser() {
    const nameEl = document.getElementById("headerUserName");
    const roleEl = document.getElementById("headerUserRole");
    if (!currentUser) {
      nameEl.textContent = "";
      roleEl.textContent = "";
      return;
    }
    nameEl.textContent = currentUser.full_name || currentUser.initials;
    const roleLabel = currentUser.role === "admin" ? "Administrator" : "Standard User";
    roleEl.textContent = `Logged in as ${roleLabel} (${currentUser.initials})`;
  }
  // ------------------------ CYCLE STATUS ------------------------
  const cycleStatusSelect = document.getElementById("cycleStatusSelect");
  const cycleStatusLabel = document.getElementById("cycleStatusLabel");
  const cycleStatusDescription = document.getElementById("cycleStatusDescription");
  function getCycleStatusMeta(value) {
    switch (value) {
      case "under_review":
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
      case "received":
        return {
          label: "Received",
          color: "text-amber-600",
          description: "All enrollment packets have been collected and are being checked.",
        };
      case "verified":
        return {
          label: "Verified",
          color: "text-emerald-600",
          description:
            "Enrollment data, premiums, and plan mappings have been validated with the broker.",
        };
      case "finalized":
        return {
          label: "Finalized",
          color: "text-slate-700",
          description:
            "The benefit cycle is complete. Elections have been transmitted and confirmed.",
        };
      default:
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
    }
  }
  function updateCycleStatusUI() {
    const stored = localStorage.getItem("jc_cycle_status") || "under_review";
    cycleStatusSelect.value = stored;
    const meta = getCycleStatusMeta(stored);
    cycleStatusLabel.textContent = meta.label;
    cycleStatusLabel.className = "mt-2 text-base font-semibold " + meta.color;
    cycleStatusDescription.textContent = meta.description;
  }
  cycleStatusSelect.addEventListener("change", () => {
    if (
      !currentUser ||
      (!["PG", "GM", "JT"].includes(currentUser.initials) && currentUser.role !== "admin")
    ) {
      showToast({
        title: "Not allowed",
        message: "Only designated admins can change the cycle status.",
        type: "error",
      });
      cycleStatusSelect.value = localStorage.getItem("jc_cycle_status") || "under_review";
      return;
    }
    const value = cycleStatusSelect.value;
    localStorage.setItem("jc_cycle_status", value);
    updateCycleStatusUI();
  });
  // ------------------------ ROLE-BASED VISIBILITY ------------------------
  function applyRoleVisibility() {
    const tabAnalytics = document.getElementById("tabAnalytics");
    const tabComparison = document.getElementById("tabComparison");
    const tabAudit = document.getElementById("tabAudit");
    const tabUsers = document.getElementById("tabUsers");
    const isAdmin = currentUser && currentUser.role === "admin";
    if (!isAdmin) {
      tabAnalytics.classList.add("hidden");
      tabComparison.classList.add("hidden");
      tabAudit.classList.add("hidden");
      tabUsers.classList.add("hidden");
      activateTab("docs");
    } else {
      tabAnalytics.classList.remove("hidden");
      tabComparison.classList.remove("hidden");
      tabAudit.classList.remove("hidden");
      tabUsers.classList.remove("hidden");
    }
  }
  // ------------------------ TABS ------------------------
  const tabDocs = document.getElementById("tabDocs");
  const tabAnalytics = document.getElementById("tabAnalytics");
  const tabComparison = document.getElementById("tabComparison");
  const tabEmployeeList = document.getElementById("tabEmployeeList");
  const tabAudit = document.getElementById("tabAudit");
  const tabUsers = document.getElementById("tabUsers");
  const tabDocsContent = document.getElementById("tabDocsContent");
  const tabAnalyticsContent = document.getElementById("tabAnalyticsContent");
  const tabComparisonContent = document.getElementById("tabComparisonContent");
  const tabEmployeeListContent = document.getElementById("tabEmployeeListContent");
  const tabAuditContent = document.getElementById("tabAuditContent");
  const tabUsersContent = document.getElementById("tabUsersContent");
  function activateTab(key) {
    const tabs = {
      docs: { btn: tabDocs, content: tabDocsContent },
      analytics: { btn: tabAnalytics, content: tabAnalyticsContent },
      comparison: { btn: tabComparison, content: tabComparisonContent },
      employeelist: { btn: tabEmployeeList, content: tabEmployeeListContent },
      audit: { btn: tabAudit, content: tabAuditContent },
      users: { btn: tabUsers, content: tabUsersContent },
    };
    Object.entries(tabs).forEach(([k, v]) => {
      if (k === key) {
        v.btn.classList.remove("tab-btn-inactive");
        v.btn.classList.add("tab-btn-active");
        v.content.classList.remove("hidden");
      } else {
        v.btn.classList.remove("tab-btn-active");
        v.btn.classList.add("tab-btn-inactive");
        v.content.classList.add("hidden");
      }
    });
  }
  // Tab click listeners
  tabDocs.addEventListener("click", () => {
    activateTab("docs");
    loadSignedDocuments();
    logTabAccess("Signed Documents");
  });
  tabAnalytics.addEventListener("click", () => {
    activateTab("analytics");
    if (!analyticsRendered) loadAnalytics().then(() => analyticsRendered = true);
    logTabAccess("Benefit Summary");
  });
  tabComparison.addEventListener("click", () => {
    activateTab("comparison");
    loadComparisonTab();
    logTabAccess("Employee Comparison");
  });
  tabEmployeeList.addEventListener("click", () => {
    activateTab("employeelist");
    load2026EmployeeList();
    logTabAccess("2026 Employee Elections");
  });
  tabAudit.addEventListener("click", () => {
    activateTab("audit");
    loadAuditLogs();
    logTabAccess("Audit Logs");
  });
  tabUsers.addEventListener("click", () => {
    activateTab("users");
    logTabAccess("Authorized Users & Portal Credentials");
  });
  // ------------------------ SIGNED DOCUMENTS ------------------------
  async function loadSignedDocuments() {
    const tbody = document.getElementById("docBody");
    tbody.innerHTML =
      '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">Loading signed documents...</td></tr>';
   
    try {
      const data = await safeSupabaseQuery(
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null),
        "Loading signed documents"
      );
     
      docsCache = (data || []).sort((a, b) =>
        a.last_name.localeCompare(b.last_name)
      );
      renderDocsTable();
      document.getElementById("summarySignedEmployees").textContent =
        docsCache.length;
    } catch (err) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-red-500">Error loading documents.</td></tr>';
    }
  }
  function renderDocsTable() {
    const tbody = document.getElementById("docBody");
    const search = document.getElementById("docSearch").value.trim().toLowerCase();
    let rows = docsCache;
    if (search) {
      rows = rows.filter((r) => r.last_name.toLowerCase().includes(search));
    }
    document.getElementById("docSignedCount").textContent = docsCache.length;
    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">No employees match your search.</td></tr>';
      return;
    }
    tbody.innerHTML = "";
    rows.forEach((row, index) => {
      const rowNumber = index + 1;
      const fullName = `${row.last_name}, ${row.first_name}`;
      const pdfActions = row.signed_pdf_url
        ? `
        <button
          class="inline-flex items-center gap-1 text-xs text-[color:var(--jc-red)] hover:underline mr-3"
          onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
        >
          <i class="fa-solid fa-file-pdf"></i><span>View PDF</span>
        </button>
        <button
          class="inline-flex items-center gap-1 text-xs text-slate-600 hover:text-slate-900"
          onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
        >
          <i class="fa-solid fa-print"></i><span>Print</span>
        </button>`
        : `<span class="text-xs text-slate-400">N/A</span>`;
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50">
          <td class="px-4 py-2.5 text-xs text-slate-500">${rowNumber}</td>
          <td class="px-4 py-2.5 text-sm">${esc(fullName)}</td>
          <td class="px-4 py-2.5 text-sm">${esc(row.username || "")}</td>
          <td class="px-4 py-2.5 text-sm">${pdfActions}</td>
        </tr>`
      );
    });
  }
  document.getElementById("docSearch").addEventListener("input", renderDocsTable);
  document.getElementById("printAllButton").addEventListener("click", () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to print.",
        type: "error",
      });
      return;
    }
    docsCache.forEach((d) => {
      if (d.signed_pdf_url) window.open(d.signed_pdf_url, "_blank");
    });
    showToast({
      title: "Print initiated",
      message: "Opened all PDFs in new tabs. Use browser print to continue.",
      type: "success",
    });
  });
  document.getElementById("mergeAllButton").addEventListener("click", async () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to merge.",
        type: "error",
      });
      return;
    }
    showToast({
      title: "Processing...",
      message: "Merging all signed documents. This may take a moment.",
      type: "info",
    });
    try {
      const employeeIds = docsCache.map((d) => d.id);
      const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
        body: JSON.stringify({ employee_ids: employeeIds }),
      });
      const contentType = res.headers.get("content-type");
     
      if (!res.ok) {
        let errorMessage = "Edge function returned an error.";
       
        if (contentType?.includes("application/json")) {
          const errorData = await res.json();
          errorMessage = errorData.message || errorMessage;
        } else {
          const errorText = await res.text();
          console.error("Non-JSON error response:", errorText);
          errorMessage = `Server error: ${res.status}`;
        }
       
        showToast({
          title: "Merge failed",
          message: errorMessage,
          type: "error",
        });
        return;
      }
      if (contentType?.includes("application/pdf") || contentType?.includes("application/octet-stream")) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showToast({
          title: "Merge complete",
          message: "Combined PDF is ready and opened in a new tab.",
          type: "success",
        });
      } else {
        throw new Error(`Unexpected content type: ${contentType}`);
      }
    } catch (err) {
      console.error("merge error", err);
      showToast({
        title: "Merge failed",
        message: err.message || "Unexpected error. See console for details.",
        type: "error",
      });
    }
  });
  // ------------------------ ANALYTICS ------------------------
  async function ensureBenefitRatesLoaded() {
    if (benefitRates.length) return;
    const { data, error } = await supabase
      .from("benefit_rates")
      .select("plan_code, tier, coverage, amount, effective_year");
    if (!error && data) benefitRates = data;
  }
  function getRateAmount(year, coverage, tier, planCode) {
    if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
    const row = benefitRates.find(
      (r) =>
        String(r.effective_year) === String(year) &&
        (r.coverage || "").toLowerCase() === coverage &&
        r.tier === tier &&
        r.plan_code === planCode
    );
    return row ? parseFloat(row.amount) || 0 : 0;
  }
  function summarizePlanCounts(enrollments) {
    const stats = {};
    YEARS.forEach((y) => {
      stats[y] = { medical: {}, dental: {}, vision: {} };
    });
    enrollments.forEach((e) => {
      if (!YEARS.includes(e.benefit_year)) return;
      const yearStats = stats[e.benefit_year];
      const normalize = (p) =>
        !p || p === "NO" || (p + "").toUpperCase().includes("WAIVE") ? "WAIVE" : p;
      const mp = normalize(e.medical_plan);
      const dp = normalize(e.dental_plan);
      const vp = normalize(e.vision_plan);
      yearStats.medical[mp] = (yearStats.medical[mp] || 0) + 1;
      yearStats.dental[dp] = (yearStats.dental[dp] || 0) + 1;
      yearStats.vision[vp] = (yearStats.vision[vp] || 0) + 1;
    });
    return stats;
  }
  function prettyPlanName(coverage, code) {
    if (!code || code === "WAIVE" || code === "NO") return "Waived Coverage";
    const healthMap = {
      ATBAB303: "HMO / ATBAB303",
      ATBCB402: "PPO / ATBCB402",
      ATBAP393: "HMO HSA / ATBAP393",
    };
    const dentalMap = {
      F_PLAN_2W: "F-PLAN 2W / Base MAC",
      F_PLAN_3W: "F-PLAN 3W / Buy Up MAC",
    };
    const visionMap = {
      PLAN_1: "Vision Plan 1",
    };
    if (coverage === "medical") return healthMap[code] || code;
    if (coverage === "dental") return dentalMap[code] || code;
    if (coverage === "vision") return visionMap[code] || code;
    return code;
  }
  function buildCoverageSection(title, yearLabel, coverageKey, countsObj) {
    const entries = Object.entries(countsObj || {});
    if (!entries.length) return "";
    const waived = entries.filter(([code]) => code === "WAIVE");
    const others = entries
      .filter(([code]) => code !== "WAIVE")
      .sort((a, b) =>
        prettyPlanName(coverageKey, a[0]).localeCompare(
          prettyPlanName(coverageKey, b[0])
        )
      );
    const rows = [...waived, ...others]
      .map(
        ([code, count]) => `
        <tr class="border-t border-slate-100">
          <td class="py-1.5 pr-2 text-slate-700">
            ${esc(prettyPlanName(coverageKey, code))}
          </td>
          <td class="py-1.5 pl-2 text-right text-slate-800 font-semibold">
            ${count}
          </td>
        </tr>`
      )
      .join("");
    return `
      <section class="mt-4">
        <h4 class="text-xs font-semibold text-slate-700">
          ${title} (${yearLabel})
        </h4>
        <table class="w-full mt-2 text-xs">
          <thead>
            <tr class="text-slate-500">
              <th class="text-left font-semibold tracking-[0.12em] uppercase">Plan</th>
              <th class="text-right font-semibold tracking-[0.12em] uppercase">Employees</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </section>`;
  }
  function renderPlanCards(stats) {
    const card2025 = document.getElementById("planCard2025");
    const card2026 = document.getElementById("planCard2026");
    const cardFuture = document.getElementById("planCardFuture");
    const toggle = document.getElementById("toggle2027");
    const badge = document.getElementById("planYearBadge");
    if (!card2025 || !card2026 || !cardFuture) return;
    card2025.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
          <h3 class="mt-1 text-sm font-semibold text-slate-900">2025 Elections</h3>
          <p class="mt-1 text-[0.72rem] text-slate-500">Snapshot of health, dental, and vision participation for the 2025 plan year.</p>
        </div>
        <span class="pill-badge inline-flex items-center bg-slate-900 text-slate-50 px-3 py-1">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 mr-1.5"></span>
          Baseline year
        </span>
      </div>
      ${buildCoverageSection("Health Plans", "2025", "medical", stats[2025]?.medical || {})}
      ${buildCoverageSection("Dental Plans", "2025", "dental", stats[2025]?.dental || {})}
      ${buildCoverageSection("Vision Plans", "2025", "vision", stats[2025]?.vision || {})}
    `;
    card2026.innerHTML = `
      <div class="flex items-start justify-between gap-3 mb-4">
        <div>
          <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
          <h3 class="mt-1 text-sm font-semibold text-slate-900">2026 Elections</h3>
          <p class="mt-1 text-[0.72rem] text-slate-500">Current year mix by plan.</p>
        </div>
        <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1">
          <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span> Active year
        </span>
      </div>
      ${buildCoverageSection("Health Plans", "2026", "medical", stats[2026]?.medical || {})}
      ${buildCoverageSection("Dental Plans", "2026", "dental", stats[2026]?.dental || {})}
      ${buildCoverageSection("Vision Plans", "2026", "vision", stats[2026]?.vision || {})}
    `;
    initCharts(stats[2026]);
    const stats2027 = stats[2027] || { medical: {}, dental: {}, vision: {} };
    analyticsHas2027 =
      Object.keys(stats2027.medical || {}).length ||
      Object.keys(stats2027.dental || {}).length ||
      Object.keys(stats2027.vision || {}).length;
    const show2027 = !!(toggle && toggle.checked && analyticsHas2027);
    if (!show2027) {
      cardFuture.classList.add("hidden");
      cardFuture.innerHTML = "";
      if (badge) badge.textContent = "Plan years: 2025 · 2026";
      return;
    }
    cardFuture.classList.remove("hidden");
    cardFuture.innerHTML = `
      <div class="flex items-start justify-between gap-3">
        <div>
          <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
          <h3 class="mt-1 text-sm font-semibold text-slate-900">2027 Elections</h3>
          <p class="mt-1 text-[0.72rem] text-slate-500">When open enrollment is finalized, this card reflects the actual 2027 plan mix.</p>
        </div>
        <span class="pill-badge inline-flex items-center bg-sky-50 text-sky-700 border border-sky-100 px-3 py-1">
          <span class="w-1.5 h-1.5 rounded-full bg-sky-500 mr-1.5"></span> 2027 data
        </span>
      </div>
      ${buildCoverageSection("Health Plans", "2027", "medical", stats2027.medical || {})}
      ${buildCoverageSection("Dental Plans", "2027", "dental", stats2027.dental || {})}
      ${buildCoverageSection("Vision Plans", "2027", "vision", stats2027.vision || {})}
    `;
    if (badge) badge.textContent = "Plan years: 2025 · 2026 · 2027";
  }
  function initCharts(stats) {
    const charts = [
      { id: "chartMedical2026", data: stats.medical, title: "Medical Distribution" },
      { id: "chartDental2026", data: stats.dental, title: "Dental Distribution" },
      { id: "chartVision2026", data: stats.vision, title: "Vision Distribution" }
    ];
    charts.forEach(chart => {
      const ctx = document.getElementById(chart.id);
      if (!ctx) return;
     
      if (ctx.chart) ctx.chart.destroy();
     
      const labels = Object.keys(chart.data).map(k => prettyPlanName(
        chart.id.includes('Medical') ? 'medical' :
        chart.id.includes('Dental') ? 'dental' : 'vision', k
      ));
      const values = Object.values(chart.data);
     
      ctx.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#8a1619', '#c53030', '#003366', '#1d4ed8', '#4b5563', '#e5e7eb'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
            title: { display: true, text: chart.title, font: { size: 12 } }
          }
        }
      });
    });
  }
  async function loadAnalytics() {
    try {
      const [{ data: employees }, { data: enrollments }] = await Promise.all([
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null)
          .order("last_name", { ascending: true }),
        supabase
          .from("benefit_enrollments")
          .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
          .in("benefit_year", YEARS),
      ]);
      const byUsername = new Map();
      (employees || []).forEach((emp) => {
        byUsername.set(emp.username, {
          employee: emp,
          byYear: { 2025: null, 2026: null },
        });
      });
      (enrollments || []).forEach((enr) => {
        const rec = byUsername.get(enr.username);
        if (!rec) return;
        rec.byYear[enr.benefit_year] = enr;
      });
      analyticsEmployees = Array.from(byUsername.values()).filter(
        (x) => x.byYear[2025] || x.byYear[2026]
      );
      const validUsernames = new Set(
        analyticsEmployees.map((r) => r.employee.username)
      );
      const filteredEnrollments = (enrollments || []).filter((e) =>
        validUsernames.has(e.username)
      );
      const stats = summarizePlanCounts(filteredEnrollments);
      planYearStats = stats;
      renderPlanCards(planYearStats);
      const toggle2027 = document.getElementById("toggle2027");
      if (toggle2027) {
        const newToggle = toggle2027.cloneNode(true);
        toggle2027.parentNode.replaceChild(newToggle, toggle2027);
        newToggle.addEventListener("change", () => {
          if (!planYearStats) return;
          if (newToggle.checked && !analyticsHas2027) {
            showToast({
              title: "No 2027 data",
              message: "Once 2027 elections are loaded, this option will show that year.",
              type: "info",
            });
          }
          renderPlanCards(planYearStats);
        });
      }
      await ensureBenefitRatesLoaded();
      renderCostBreakdown(filteredEnrollments.filter(e => e.benefit_year === 2026));
    } catch (err) {
      console.error("Analytics load error", err);
      showToast({
        title: "Analytics error",
        message: "Failed to load analytics data.",
        type: "error",
      });
    }
  }
  function renderCostBreakdown(enrollments) {
    const tbody = document.getElementById("costBreakdownBody");
    tbody.innerHTML = '';
    const costs = { medical: {}, dental: {}, vision: {} };
    enrollments.forEach(e => {
      const tier = e.tier_election || 'EO';
      ['medical', 'dental', 'vision'].forEach(cov => {
        const plan = e[`${cov}_plan`] || 'WAIVE';
        if (plan !== 'WAIVE') {
          const amount = getRateAmount(2026, cov, tier, plan) * 26;
          costs[cov][plan] = (costs[cov][plan] || 0) + amount;
        }
      });
    });
    ['medical', 'dental', 'vision'].forEach(cov => {
      Object.entries(costs[cov]).forEach(([plan, total]) => {
        const count = planYearStats[2026][cov][plan] || 0;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td class="px-4 py-2">${cov.charAt(0).toUpperCase() + cov.slice(1)}</td>
            <td class="px-4 py-2">${prettyPlanName(cov, plan)}</td>
            <td class="text-right px-4 py-2">${count}</td>
            <td class="text-right px-4 py-2">${formatCurrency(total)}</td>
          </tr>
        `);
      });
    });
  }
  // ------------------------ EMPLOYEE COMPARISON TAB ------------------------
  async function loadComparisonTab() {
    if (comparisonRendered) {
      return;
    }
    const listEl = document.getElementById("comparisonEmployeeList");
    listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">Loading employees...</li>';
    try {
      const [{ data: employees }, { data: enrollments }] = await Promise.all([
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null)
          .order("last_name", { ascending: true }),
        supabase
          .from("benefit_enrollments")
          .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
          .in("benefit_year", [2025, 2026]),
      ]);
      const byUsername = new Map();
      (employees || []).forEach((emp) => {
        byUsername.set(emp.username, {
          employee: emp,
          byYear: { 2025: null, 2026: null },
        });
      });
      (enrollments || []).forEach((enr) => {
        const rec = byUsername.get(enr.username);
        if (!rec) return;
        rec.byYear[enr.benefit_year] = enr;
      });
      comparisonEmployees = Array.from(byUsername.values()).filter(
        (x) => x.byYear[2025] || x.byYear[2026]
      );
      await ensureBenefitRatesLoaded();
      renderComparisonEmployeeList();
      comparisonRendered = true;
    } catch (err) {
      console.error("Comparison load error", err);
      listEl.innerHTML = '<li class="px-4 py-3 text-xs text-red-500 text-center">Error loading data.</li>';
    }
  }
  function renderComparisonEmployeeList() {
    const listEl = document.getElementById("comparisonEmployeeList");
    const search = document.getElementById("comparisonSearch").value.trim().toLowerCase();
    let rows = comparisonEmployees;
    if (search) {
      rows = rows.filter((r) => r.employee.last_name.toLowerCase().includes(search));
    }
    if (!rows.length) {
      listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">No employees match your search.</li>';
      return;
    }
    listEl.innerHTML = "";
    rows.forEach((rec) => {
      const { employee } = rec;
      const hasChange = rec.byYear[2025] && rec.byYear[2026];
     
      listEl.insertAdjacentHTML("beforeend", `
        <li>
          <button
            type="button"
            class="w-full text-left px-4 py-3 hover:bg-slate-100 transition-colors
                   focus:outline-none focus:bg-slate-100 group"
            data-username="${esc(employee.username)}"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-900 group-hover:text-[color:var(--jc-red)]">
                  ${esc(employee.last_name)}, ${esc(employee.first_name)}
                </p>
                <p class="text-xs text-slate-500 mt-0.5">
                  ${esc(employee.username)}
                  ${hasChange ? '<span class="ml-2 text-emerald-600">• Has comparison data</span>' : ''}
                </p>
              </div>
              <i class="fa-solid fa-chevron-right text-xs text-slate-400 group-hover:text-[color:var(--jc-red)]"></i>
            </div>
          </button>
        </li>
      `);
    });
  }
  document.getElementById("comparisonSearch").addEventListener("input", renderComparisonEmployeeList);
  document.getElementById("comparisonEmployeeList").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-username]");
    if (!btn) return;
    const username = btn.dataset.username;
    const rec = comparisonEmployees.find((r) => r.employee.username === username);
    if (rec) {
      displayEmployeeComparison(rec);
    }
  });
  function displayEmployeeComparison(rec) {
    const container = document.getElementById("employeeComparisonDisplay");
    const { employee, byYear } = rec;
    const enr2025 = byYear[2025];
    const enr2026 = byYear[2026];
    if (!enr2025 && !enr2026) {
      container.innerHTML = `
        <div class="flex items-center justify-center h-full">
          <p class="text-sm text-slate-500">No enrollment data available for this employee.</p>
        </div>
      `;
      return;
    }
    const calc = (year, enr) => {
      if (!enr) return { medical: 0, dental: 0, vision: 0, total: 0, biweekly: 0 };
      const tier = enr.tier_election || 'EO';
      const medical = getRateAmount(year, 'medical', tier, enr.medical_plan);
      const dental = getRateAmount(year, 'dental', tier, enr.dental_plan);
      const vision = getRateAmount(year, 'vision', tier, enr.vision_plan);
      const total = medical + dental + vision;
      return { medical, dental, vision, total, biweekly: total };
    };
    const cost2025 = calc(2025, enr2025);
    const cost2026 = calc(2026, enr2026);
    const annualCost2025 = cost2025.total * 26;
    const annualCost2026 = cost2026.total * 26;
    const annualDiff = annualCost2026 - annualCost2025;
    const percentChange = annualCost2025 > 0 ? ((annualDiff / annualCost2025) * 100) : 0;
    let changeType = "flat renewal";
    let changeColor = "text-slate-700";
    let changeIcon = "fa-minus";
   
    if (annualDiff > 100) {
      changeType = "upgrade";
      changeColor = "text-emerald-600";
      changeIcon = "fa-arrow-up";
    } else if (annualDiff < -100) {
      changeType = "downgrade";
      changeColor = "text-red-600";
      changeIcon = "fa-arrow-down";
    }
    const planRow = (label, plan2025, plan2026) => {
      const name2025 = plan2025 && plan2025 !== 'WAIVE' ? prettyPlanName(label.toLowerCase(), plan2025) : 'Waived';
      const name2026 = plan2026 && plan2026 !== 'WAIVE' ? prettyPlanName(label.toLowerCase(), plan2026) : 'Waived';
      const changed = name2025 !== name2026;
     
      return `
        <tr class="border-b border-slate-100">
          <td class="py-3 px-4 text-sm font-medium text-slate-700">${label}</td>
          <td class="py-3 px-4 text-sm ${changed ? 'text-slate-500' : 'text-slate-700'}">${name2025}</td>
          <td class="py-3 px-4 text-sm ${changed ? 'font-semibold text-[color:var(--jc-red)]' : 'text-slate-700'}">${name2026}</td>
          <td class="py-3 px-4 text-center">
            ${changed ? '<i class="fa-solid fa-circle-exclamation text-amber-500"></i>' : '<i class="fa-solid fa-check text-emerald-500"></i>'}
          </td>
        </tr>
      `;
    };
    container.innerHTML = `
      <div class="space-y-6">
        <header class="border-b border-slate-200 pb-4">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h3 class="text-xl font-bold text-[color:var(--jc-navy)]">
                ${esc(employee.last_name)}, ${esc(employee.first_name)}
              </h3>
              <p class="text-sm text-slate-500 mt-1">
                Username: ${esc(employee.username)} • Tier: ${enr2026?.tier_election || enr2025?.tier_election || 'N/A'}
              </p>
            </div>
            <span class="pill-badge inline-flex items-center ${changeColor === 'text-emerald-600' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' : changeColor === 'text-red-600' ? 'bg-red-50 text-red-700 border-red-100' : 'bg-slate-100 text-slate-700 border-slate-200'} border px-4 py-2">
              <i class="fa-solid ${changeIcon} mr-2"></i>
              ${changeType.toUpperCase()}
            </span>
          </div>
        </header>
         <div class="grid md:grid-cols-3 gap-4">
          <div class="card bg-slate-50 px-4 py-4">
            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2025 Bi-weekly Cost</p>
            <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2025.biweekly)}</p>
            <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2025)}</p>
          </div>
         
          <div class="card bg-slate-50 px-4 py-4">
            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2026 Bi-weekly Cost</p>
            <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2026.biweekly)}</p>
            <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2026)}</p>
          </div>
         
          <div class="card bg-slate-50 px-4 py-4">
            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Cost Difference</p>
            <p class="text-2xl font-bold ${changeColor}">
              ${(cost2026.biweekly - cost2025.biweekly) >= 0 ? '+' : ''}${formatCurrency(cost2026.biweekly - cost2025.biweekly)}
            </p>
            <p class="text-xs ${changeColor} mt-1 font-semibold">
              Per pay period
            </p>
            <p class="text-xs text-slate-500 mt-1">
              Annual: ${annualDiff >= 0 ? '+' : ''}${formatCurrency(annualDiff)} (${Math.abs(percentChange).toFixed(1)}%)
            </p>
          </div>
        </div>
        <div class="space-y-3">
          <h4 class="text-sm font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider">
            Plan Elections Comparison
          </h4>
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead class="bg-slate-100 border-b-2 border-slate-200">
                <tr>
                  <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Coverage</th>
                  <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2025 Plan</th>
                  <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2026 Plan</th>
                  <th class="py-2 px-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Status</th>
                </tr>
              </thead>
              <tbody>
                ${planRow('Medical', enr2025?.medical_plan, enr2026?.medical_plan)}
                ${planRow('Dental', enr2025?.dental_plan, enr2026?.dental_plan)}
                ${planRow('Vision', enr2025?.vision_plan, enr2026?.vision_plan)}
              </tbody>
            </table>
          </div>
        </div>
        <div class="card bg-blue-50 border-blue-100 px-4 py-3">
          <div class="flex items-start gap-3">
            <i class="fa-solid fa-lightbulb text-blue-600 mt-0.5"></i>
            <div class="flex-1">
              <p class="text-xs font-semibold text-blue-900 mb-1">Analysis Summary</p>
              <p class="text-xs text-blue-700 leading-relaxed">
                ${employee.first_name} ${employee.last_name}'s benefit elections show a <strong>${changeType}</strong>
                with an annual cost ${annualDiff >= 0 ? 'increase' : 'decrease'} of ${formatCurrency(Math.abs(annualDiff))}.
                ${annualDiff > 100 ? 'This represents enhanced coverage selections for 2026.' :
                  annualDiff < -100 ? 'This reflects reduced coverage or cost-saving plan changes.' :
                  'Benefit selections remain relatively stable year-over-year.'}
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
  }
  // ------------------------ PORTAL USERS ------------------------
  async function loadPortalUsers() {
    const tbody = document.getElementById("userBody");
    tbody.innerHTML =
      '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';
    try {
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, role, active, last_login")
        .order("full_name", { ascending: true });
      if (error) throw error;
      portalUsersCache = data || [];
      renderPortalUsersTable();
    } catch (err) {
      console.error("Portal users error", err);
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-red-500">Error loading users.</td></tr>';
    }
  }
  function renderPortalUsersTable() {
    const tbody = document.getElementById("userBody");
    const search = document.getElementById("userSearch").value.trim().toLowerCase();
    let rows = portalUsersCache;
    if (search) {
      rows = rows.filter((u) =>
        u.full_name.toLowerCase().includes(search)
      );
    }
    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">No users match your search.</td></tr>';
      return;
    }
    tbody.innerHTML = "";
    rows.forEach((u) => {
      const roleBadge =
        u.role === "admin"
          ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-red-50 text-red-700 border border-red-100">ADMIN</span>'
          : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-700 border border-slate-200">STANDARD</span>';
      const statusBadge = u.active
        ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100">ACTIVE</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-500 border border-slate-200">INACTIVE</span>';
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50 text-sm" data-id="${u.id}">
          <td class="px-4 py-2.5">${esc(u.full_name)}</td>
          <td class="px-4 py-2.5">${esc(u.initials)}</td>
          <td class="px-4 py-2.5">${roleBadge}</td>
          <td class="px-4 py-2.5 text-xs text-slate-500">${formatDate(u.last_login)}</td>
          <td class="px-4 py-2.5">${statusBadge}</td>
          <td class="px-4 py-2.5 text-xs">
            <button class="text-[color:var(--jc-red)] hover:underline mr-3" data-action="edit">Edit</button>
            <button class="text-slate-500 hover:text-red-600" data-action="delete">Delete</button>
          </td>
        </tr>`
      );
    });
  }
  document
    .getElementById("userSearch")
    .addEventListener("input", renderPortalUsersTable);
  document.getElementById("userBody").addEventListener("click", async (e) => {
    const row = e.target.closest("tr[data-id]");
    if (!row) return;
    const id = Number(row.dataset.id);
    const user = portalUsersCache.find((u) => u.id === id);
    if (!user) return;
    const action = e.target.dataset.action;
    if (action === "edit") {
      openUserModal(user);
    } else if (action === "delete") {
      if (user.initials === "PG") {
        showToast({
          title: "Protected account",
          message: "You cannot delete the primary owner account.",
          type: "error",
        });
        return;
      }
      if (!confirm(`Delete portal user ${user.full_name}?`)) return;
      try {
        const { error } = await supabase.from("portal_users").delete().eq("id", id);
        if (error) throw error;
        portalUsersCache = portalUsersCache.filter((u) => u.id !== id);
        renderPortalUsersTable();
        showToast({
          title: "User deleted",
          message: `${user.full_name} was removed from portal access.`,
          type: "success",
        });
      } catch (err) {
        console.error("Delete user error", err);
        showToast({
          title: "Delete failed",
          message: "Could not delete this user.",
          type: "error",
        });
      }
    }
  });
  const userModal = document.getElementById("userModal");
  const modalTitle = document.getElementById("userModalTitle");
  const modalFullName = document.getElementById("modalFullName");
  const modalInitials = document.getElementById("modalInitials");
  const modalPin = document.getElementById("modalPin");
  const modalRole = document.getElementById("modalRole");
  const modalActive = document.getElementById("modalActive");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");
  let editingUserId = null;
  document
    .getElementById("addUserButton")
    .addEventListener("click", () => openUserModal(null));
  function openUserModal(user) {
    if (!currentUser || currentUser.role !== "admin") {
      showToast({
        title: "Not allowed",
        message: "Only administrators can manage portal users.",
        type: "error",
      });
      return;
    }
    editingUserId = user ? user.id : null;
    modalTitle.textContent = editingUserId ? "Edit user" : "Add user";
    modalFullName.value = user?.full_name || "";
    modalInitials.value = user?.initials || "";
    modalPin.value = "";
    modalRole.value = user?.role || "user";
    modalActive.checked = user ? !!user.active : true;
    userModal.classList.remove("hidden");
    userModal.classList.add("flex");
  }
  modalCancel.addEventListener("click", () => {
    userModal.classList.add("hidden");
    userModal.classList.remove("flex");
  });
  modalSave.addEventListener("click", async () => {
    const fullName = modalFullName.value.trim();
    const initials = modalInitials.value.trim().toUpperCase();
    const pin = modalPin.value.trim();
    const role = modalRole.value;
    const active = modalActive.checked;
    if (!fullName || !initials || !pin) {
      showToast({
        title: "Missing fields",
        message: "Full name, initials, and PIN are required.",
        type: "error",
      });
      return;
    }
    if (!/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }
    try {
      if (editingUserId) {
        const { error } = await supabase
          .from("portal_users")
          .update({
            full_name: fullName,
            initials,
            pin,
            role,
            active,
          })
          .eq("id", editingUserId);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("portal_users").insert([
          {
            full_name: fullName,
            initials,
            username: initials,
            pin,
            role,
            active,
          },
        ]);
        if (error) throw error;
      }
      userModal.classList.add("hidden");
      userModal.classList.remove("flex");
      await loadPortalUsers();
      showToast({
        title: "Saved",
        message: "Portal user changes have been saved.",
        type: "success",
      });
    } catch (err) {
      console.error("Save user error", err);
      showToast({
        title: "Save failed",
        message: "Could not save this portal user.",
        type: "error",
      });
    }
  });
  async function loadAuditLogs() {
    const tbody = document.getElementById("auditBody");
    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">Loading audit logs...</td></tr>';
   
    try {
      const { data: logs, error } = await supabase
        .from("portal_logs")
        .select("id, portal_user_id, login_time, logout_time, duration_minutes, tab_accessed, tab_history")
        .order("login_time", { ascending: false });
      if (error) throw error;
      // Ensure portal users are loaded for lookup
      if (portalUsersCache.length === 0) {
          await loadPortalUsers();
      }
      const userMap = Object.fromEntries(portalUsersCache.map(u => [u.id, u]));
     
      tbody.innerHTML = "";
      (logs || []).forEach(log => {
        const user = log.portal_user_id ? userMap[log.portal_user_id] : null;
        const name = user ? `${user.full_name} (${user.initials})` : "Unknown";
        const duration = log.duration_minutes ? `${log.duration_minutes} min` : "—";
       
        // Show full tab history (last 5 entries, newest first)
        const history = (log.tab_history || [])
          .slice(-5)
          .reverse()
          .map(entry => `<div class="text-xs text-slate-700">${esc(entry)}</div>`)
          .join("") || '<span class="text-slate-400">Dashboard</span>';
        tbody.insertAdjacentHTML("beforeend", `
          <tr class="hover:bg-slate-50">
            <td class="px-4 py-2.5">${esc(name)}</td>
            <td class="px-4 py-2.5">${formatDate(log.login_time)}</td>
            <td class="px-4 py-2.5">${log.logout_time ? formatDate(log.logout_time) : '<span class="text-amber-600">Active</span>'}</td>
            <td class="px-4 py-2.5">${duration}</td>
            <td class="px-4 py-2.5 space-y-1 max-w-xs">${history}</td>
          </tr>
        `);
      });
    } catch (err) {
      console.error("Audit logs failed:", err);
      tbody.innerHTML = '<tr><td colspan="5" class="text-red-600 text-center">Failed to load</td></tr>';
    }
  }
  async function logTabAccess(tabName) {
    if (!currentUser || !currentUser.id || !currentLogId) {
      console.error("No valid currentUser, user.id, or log ID. Cannot log tab access.");
      return;
    }
    const timestampedEntry = `${new Date().toLocaleTimeString()} - ${tabName}`;
    try {
      // 1. Fetch current history array (safest method for array manipulation)
      const { data: currentLog, error: fetchError } = await supabase
          .from("portal_logs")
          .select("tab_history")
          .eq("id", currentLogId)
          .maybeSingle();
      if (fetchError || !currentLog) throw fetchError || new Error("Log not found");
      const existingHistory = currentLog.tab_history || [];
     
      // 2. Append the new entry and limit size (e.g., to 20 entries)
      const newHistory = [...existingHistory, timestampedEntry].slice(-20);
     
      // 3. Update the log row
      await supabase
        .from("portal_logs")
        .update({
          tab_accessed: tabName, // Update the last accessed tab field (for quick lookup)
          tab_history: newHistory, // Update the history array
        })
        .eq("id", currentLogId);
    
    } catch (err) {
      console.error("Failed to log tab access:", err);
    }
  }
 // ------------------------ 2026 EMPLOYEE LIST (CLEAN VERSION) ------------------------
  async function loadRates() {
    const { data, error } = await supabase
      .from("benefit_rates")
      .select("coverage,plan_code,tier,amount,per_year_periods,effective_year");
    if (error) return console.error(error);
    RATES = {};
    for (const r of data) {
      const cov = r.coverage.toLowerCase();
      const year = r.effective_year;
      RATES[year] ??= {};
      RATES[year][cov] ??= {};
      RATES[year][cov][r.plan_code] ??= {};
      RATES[year][cov][r.plan_code][r.tier] = { amt: Number(r.amount), ppp: r.per_year_periods || 26 };
    }
  }
  function getRateAmount(year, coverage, tier, planCode) {
    if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
    return RATES?.[year]?.[coverage]?.[planCode]?.[tier]?.amt ?? 0;
  }
  async function load2026EmployeeList() {
    await loadRates();
    try {
      showToast({
        title: "Loading...",
        message: "Loading 2026 benefit elections...",
        type: "info",
      });
      // 1) Load enrollments for 2026
      const { data: enrollments, error: enrError } = await supabase
        .from("benefit_enrollments")
        .select("*")
        .eq("benefit_year", 2026);
      if (enrError) throw enrError;
      if (!enrollments || !enrollments.length) {
        throw new Error("No enrollment data found for 2026.");
      }
      fullEnrollments = enrollments;
      // 2) Load basic employee info for those usernames
      const usernames = [...new Set(enrollments.map((e) => e.username).filter(Boolean))];
      const { data: employees, error: empError } = await supabase
        .from("employees2025")
        .select("username, first_name, last_name")
        .in("username", usernames);
      if (empError) throw empError;
      const empMap = Object.fromEntries(
        (employees || []).map((e) => [e.username, `${e.last_name}, ${e.first_name}`])
      );
      // 3) Clear all grid containers
      const gridIds = [
        "gridWaived",
        "grid303",
        "grid393",
        "grid402",
        "gridDentalWaive",
        "gridF2W",
        "gridF3W",
        "gridVisionWaive",
        "gridVision1",
        "gridWithDes",
        "gridWithoutDes"
      ];
      gridIds.forEach((id) => {
        const el = document.getElementById(id);
        if (el) {
          el.innerHTML = "";
        } else {
          console.warn(`Grid element not found: ${id}`);
        }
      });
      // 4) Counters
      let medicalActive = 0,
        dentalActive = 0,
        visionActive = 0;
      const counts = {
        waived: 0,
        p303: 0,
        p393: 0,
        p402: 0,
        dentalWaive: 0,
        f2w: 0,
        f3w: 0,
        visionWaive: 0,
        vision1: 0,
        withDes: 0,
        withoutDes: 0
      };
      // Helper to append a small employee card into a specific grid section
      function appendEmployeeCard(targetId, fullName) {
        const el = document.getElementById(targetId);
        if (!el) return;
        const safeName = fullName || "";
        const parts = safeName.split(", ");
        const initials =
          parts.length >= 2
            ? (parts[0].charAt(0) + parts[1].charAt(0)).toUpperCase()
            : safeName.substring(0, 2).toUpperCase();
        el.insertAdjacentHTML(
          "beforeend",
          `
          <div class="card px-3 py-3 hover:shadow-md transition-shadow">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-full bg-[color:var(--jc-navy)] text-white flex items-center justify-center text-xs font-bold">
                ${esc(initials)}
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-sm font-medium text-slate-900 truncate">${esc(safeName)}</p>
              </div>
            </div>
          </div>
        `
        );
      }
      // 5) Distribute enrollments into buckets into buckets
      enrollments.forEach((e) => {
        const name = empMap[e.username] || e.full_name || e.username || "Unknown";
        // MEDICAL
        if (!e.medical_plan || e.medical_plan === "WAIVE") {
          appendEmployeeCard("gridWaived", name);
          counts.waived++;
        } else {
          medicalActive++;
          if (e.medical_plan === "ATBAB303") {
            appendEmployeeCard("grid303", name);
            counts.p303++;
          } else if (e.medical_plan === "ATBAP393") {
            appendEmployeeCard("grid393", name);
            counts.p393++;
          } else if (e.medical_plan === "ATBCB402") {
            appendEmployeeCard("grid402", name);
            counts.p402++;
          }
        }
        // DENTAL
        if (!e.dental_plan || e.dental_plan === "WAIVE") {
          appendEmployeeCard("gridDentalWaive", name);
          counts.dentalWaive++;
        } else {
          dentalActive++;
          if (e.dental_plan === "F_PLAN_2W") {
            appendEmployeeCard("gridF2W", name);
            counts.f2w++;
          } else if (e.dental_plan === "F_PLAN_3W") {
            appendEmployeeCard("gridF3W", name);
            counts.f3w++;
          }
        }
        // VISION
        if (!e.vision_plan || e.vision_plan === "WAIVE") {
          appendEmployeeCard("gridVisionWaive", name);
          counts.visionWaive++;
        } else {
          visionActive++;
          appendEmployeeCard("gridVision1", name);
          counts.vision1++;
        }
        // LIFE & AD&D (Section 10)
        if (e.beneficiaries && e.beneficiaries.length > 0) {
          appendEmployeeCard("gridWithDes", name);
          counts.withDes++;
        } else {
          appendEmployeeCard("gridWithoutDes", name);
          counts.withoutDes++;
        }
      });
      // 6) Update KPI summary cards
      document.getElementById("gridTotalEnrolled").textContent = enrollments.length;
      document.getElementById("gridMedicalCoverage").textContent = medicalActive;
      document.getElementById("gridDentalCoverage").textContent = dentalActive;
      document.getElementById("gridVisionCoverage").textContent = visionActive;
      // 7) Update badges
      document.getElementById("countWaived").textContent = `${counts.waived} employees`;
      document.getElementById("count303").textContent = `${counts.p303} employees`;
      document.getElementById("count393").textContent = `${counts.p393} employees`;
      document.getElementById("count402").textContent = `${counts.p402} employees`;
      document.getElementById("countDentalWaive").textContent = `${counts.dentalWaive} employees`;
      document.getElementById("countF2W").textContent = `${counts.f2w} employees`;
      document.getElementById("countF3W").textContent = `${counts.f3w} employees`;
      document.getElementById("countVisionWaive").textContent = `${counts.visionWaive} employees`;
      document.getElementById("countVision1").textContent = `${counts.vision1} employees`;
      document.getElementById("countWithDes").textContent = `${counts.withDes} employees`;
      document.getElementById("countWithoutDes").textContent = `${counts.withoutDes} employees`;
      document.getElementById("gridLifeCoverage").textContent = counts.withDes;
      showToast({
        title: "Loaded successfully",
        message: `Loaded ${enrollments.length} employee elections for 2026.`,
        type: "success",
      });
    } catch (err) {
      console.error("Load 2026 list error:", err);
      showToast({
        title: "Load Error",
        message: "Failed to load 2026 benefit elections. " + (err.message || ""),
        type: "error",
      });
    }
  }
  // ------------------------ GRID TABS / EXPORT / SEARCH (SINGLE SOURCE OF TRUTH) ------------------------
  // Tab buttons & content containers
  const medicalTab = document.getElementById("gridTabMedical");
  const dentalTab = document.getElementById("gridTabDental");
  const visionTab = document.getElementById("gridTabVision");
  const lifeTab = document.getElementById("gridTabLife");
  const medicalContent = document.getElementById("gridContentMedical");
  const dentalContent = document.getElementById("gridContentDental");
  const visionContent = document.getElementById("gridContentVision");
  const lifeContent = document.getElementById("gridContentLife");
  function switchGridTab(activeTab, activeContent) {
    [medicalTab, dentalTab, visionTab, lifeTab].forEach((tab) => {
      tab.classList.remove("border-[color:var(--jc-red)]", "text-[color:var(--jc-red)]");
      tab.classList.add("border-transparent", "text-slate-600");
    });
    [medicalContent, dentalContent, visionContent, lifeContent].forEach((content) => {
      content.classList.add("hidden");
    });
    activeTab.classList.add("border-[color:var(--jc-red)]", "text-[color:var(--jc-red)]");
    activeTab.classList.remove("border-transparent", "text-slate-600");
    activeContent.classList.remove("hidden");
    // Log the current tab the user is viewing
    logTabAccess(activeTab.textContent.trim());
  }
  // Attach tab handlers once
  if (medicalTab && dentalTab && visionTab && lifeTab) {
    medicalTab.addEventListener("click", () => switchGridTab(medicalTab, medicalContent));
    dentalTab.addEventListener("click", () => switchGridTab(dentalTab, dentalContent));
    visionTab.addEventListener("click", () => switchGridTab(visionTab, visionContent));
    lifeTab.addEventListener("click", () => switchGridTab(lifeTab, lifeContent));
  }
  // Export to Excel
  <!-- Export to Excel -->
document.getElementById("exportToExcel").addEventListener("click", async () => {
  if (!fullEnrollments.length) {
    showToast({title: "No data", message: "No enrollments to export.", type: "error"});
    return;
  }

  showToast({title: "Generating Report", message: "Creating executive Excel report...", type: "info"});

  const fmt = n => n != null ? `$${Number(n).toFixed(2)}` : "$0.00";

  const data = fullEnrollments.map(d => {
    const address = d.address || {};
    const addr = [address.street, address.city, address.state, address.zip].filter(Boolean).join(", ");
    const deps = (d.dependents || []).map(dep => `${dep.first || ''} ${dep.last || ''}`.trim()).filter(Boolean).join("; ") || "None";

    const beneficiaries = (d.beneficiaries || [])
      .map(b => ({
        name: `${b.first || ''} ${b.last || ''}`.trim(),
        relationship: b.relationship || "Not specified",
        percentage: b.pct != null ? b.pct + "%" : "Not specified"
      }))
      .sort((a, b) => a.name.localeCompare(b.name));

    const tier = d.tier_election || 'EO';
    const medAmt = getRateAmount(2026, 'medical', tier, d.medical_plan);
    const denAmt = getRateAmount(2026, 'dental', tier, d.dental_plan);
    const visAmt = getRateAmount(2026, 'vision', tier, d.vision_plan);

    const [last = '', first = ''] = (d.full_name || ', ').split(', ');

    return {
      "First Name": first.trim(),
      "Last Name": last.trim(),
      "Coverage Tier": tier,
      "SSN": d.ssn || '',
      "Date of Birth": d.dob || '',
      "Gender": d.gender || '',
      "Marital Status": d.marital_status || '',
      "Date of Hire": d.hire_date || '',
      "Address": addr,
      "Phone": d.phone || '',
      "Email": d.email || '',
      "Job Title": d.job_title || '',
      "Annual Salary": d.annual_salary || 0,
      "Dependents": deps,
      "Medical Plan": prettyPlanName("medical", d.medical_plan || "WAIVE"),
      "Medical Per Pay": medAmt,
      "Dental Plan": prettyPlanName("dental", d.dental_plan || "WAIVE"),
      "Dental Per Pay": denAmt,
      "Vision Plan": prettyPlanName("vision", d.vision_plan || "WAIVE"),
      "Vision Per Pay": visAmt,
      "Life & AD&D Designated": d.beneficiaries?.length > 0 ? "Yes" : "No",
      "Beneficiary Name(s)": beneficiaries.map(b => b.name).join("; ") || "None",
      "Relationship(s)": beneficiaries.map(b => b.relationship).join("; ") || "None",
      "Allocation %": beneficiaries.map(b => b.percentage).join("; ") || "None"
    };
  });

  const ws = XLSX.utils.json_to_sheet(data, { origin: 'A10' });
  const wb = XLSX.utils.book_new();

  // Styling (same as before)
  ws['!cols'] = Array(24).fill().map((_, i) => ({ wch: [14,14,12,14,12,8,14,12,30,14,25,18,14,25,22,16,16,16,16,16,20,28,20,20][i] || 16 }));

  const range = XLSX.utils.decode_range(ws['!ref']);
  for (let C = range.s.c; C <= range.e.c; ++C) {
    const cell = ws[XLSX.utils.encode_cell({r:9, c:C})];
    if (cell) cell.s = { font: {name:"Arial",sz:9,bold:true,color:{rgb:"FFFFFF"}}, fill:{fgColor:{rgb:"003366"}}, alignment:{horizontal:"center"}, border:{top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}} };
  }
  for (let R = 10; R <= range.e.r; ++R) {
    for (let C = 0; C <= range.e.c; ++C) {
      const addr = XLSX.utils.encode_cell({r:R,c:C});
      if (!ws[addr]) continue;
      ws[addr].s = {
        font: {name:"Arial",sz:9},
        fill: {fgColor:{rgb: R%2===0 ? "F5F7FA" : "FFFFFF"}},
        alignment: {wrapText:true, vertical:"top"},
        border: {top:{style:"thin"},bottom:{style:"thin"},left:{style:"thin"},right:{style:"thin"}}
      };
      if (typeof ws[addr].v === "number" || (ws[addr].v+"").includes("$")) ws[addr].s.alignment.horizontal = "right";
    }
  }

  XLSX.utils.sheet_add_aoa(ws, [["Jeng Chi Restaurant - 2026 Benefit Elections Report"]], {origin:"A1"});
  XLSX.utils.sheet_add_aoa(ws, [["Generated on: " + new Date().toLocaleDateString("en-US")]], {origin:"A2"});
  XLSX.utils.sheet_add_aoa(ws, [["Total Employees: " + fullEnrollments.length]], {origin:"A3"});
  ["A1","A2","A3"].forEach(a => ws[a] && (ws[a].s = {font:{name:"Arial",sz:14,bold:true,color:{rgb:"003366"}}}));

  ws['!pageSetup'] = {orientation:"landscape"};

  XLSX.utils.book_append_sheet(wb, ws, "2026 Elections");
  XLSX.writeFile(wb, `JengChi_Executive_Benefits_Report_2026_${new Date().toISOString().slice(0,10)}.xlsx`);

  showToast({title: "Success", message: "Executive report generated!", type: "success"});
});
  // Search by name across all cards
  const gridSearchInput = document.getElementById("gridSearch");
  if (gridSearchInput) {
    gridSearchInput.addEventListener("input", (e) => {
      const query = e.target.value.toLowerCase();
      document.querySelectorAll('[id^="grid"] > div.card').forEach((card) => {
        const nameEl = card.querySelector("p.text-sm");
        if (!nameEl) return;
        const name = nameEl.textContent.toLowerCase();
        card.style.display = name.includes(query) ? "" : "none";
      });
    });
  }
  // Coverage filter dropdown -> switches visible tab
  const coverageFilterSelect = document.getElementById("gridCoverageFilter");
  if (coverageFilterSelect) {
    coverageFilterSelect.addEventListener("change", (e) => {
      const value = e.target.value;
      if (value === "all" || value === "medical") {
        switchGridTab(medicalTab, medicalContent);
      } else if (value === "dental") {
        switchGridTab(dentalTab, dentalContent);
      } else if (value === "vision") {
        switchGridTab(visionTab, visionContent);
      } else if (value === "life") {
        switchGridTab(lifeTab, lifeContent);
      }
    });
  }
  (function initFromSession() {
    const stored = sessionStorage.getItem("portal_user");
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        currentUser = parsed;
        currentLogId = parsed.log_id || null;
        showDashboard();
      } catch {
        sessionStorage.removeItem("portal_user");
      }
    }
  })();
</script>
</body>
</html>
