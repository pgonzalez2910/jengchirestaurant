<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jeng Chi — Executive Benefits Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <!-- Tailwind for quick layout + typography -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

  <style>
    :root {
      --jc-blue: #003366;    /* from logo */
      --jc-blue-soft: #335c85;
      --jc-red: #b22222;     /* from logo */
      --jc-gray-bg: #f3f4f6;
      --jc-border: #111827;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: #ffffff;
      color: #111827;
    }

    .card {
      background-color: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
    }

    .kpi-label {
      font-size: 0.7rem;
      letter-spacing: 0.2em;
      text-transform: uppercase;
      color: #6b7280;
    }

    .kpi-value {
      font-size: 1.6rem;
      font-weight: 700;
      color: var(--jc-blue);
    }

    .kpi-subtitle {
      font-size: 0.85rem;
      color: #6b7280;
    }

    .tab-button {
      border-bottom: 2px solid transparent;
      padding: 0.75rem 1.25rem;
      font-size: 0.9rem;
      font-weight: 500;
      color: #4b5563;
      background-color: transparent;
      cursor: pointer;
    }

    .tab-button.active {
      border-color: var(--jc-blue);
      color: var(--jc-blue);
      background-color: #e5effa;
    }

    .input-label {
      font-size: 0.85rem;
      font-weight: 500;
      color: #111827;
      margin-bottom: 0.25rem;
    }

    .input-field {
      width: 100%;
      padding: 0.5rem 0.75rem;
      border-radius: 0.5rem;
      border: 1px solid var(--jc-border); /* solid black / dark border */
      background-color: #ffffff;
      font-size: 0.95rem;
      color: #111827;
      outline: none;
    }

    .input-field:focus {
      border-color: var(--jc-blue);
      box-shadow: 0 0 0 1px var(--jc-blue-soft);
    }

    .pill {
      border-radius: 9999px;
      padding: 0.2rem 0.7rem;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .pill-admin {
      background-color: #e0f2fe;
      color: #075985;
    }

    .pill-user {
      background-color: #e5e7eb;
      color: #374151;
    }

    .pill-active {
      background-color: #dcfce7;
      color: #166534;
    }

    .pill-inactive {
      background-color: #fee2e2;
      color: #991b1b;
    }

    .status-pill {
      border-radius: 9999px;
      padding: 0.25rem 0.75rem;
      font-size: 0.75rem;
      font-weight: 600;
    }

    .status-under-review {
      background-color: #fef2f2;
      color: #b91c1c;
    }

    .status-received {
      background-color: #eff6ff;
      color: #1d4ed8;
    }

    .status-verified {
      background-color: #ecfdf5;
      color: #047857;
    }

    .status-finalized {
      background-color: #f5f3ff;
      color: #6d28d9;
    }

    .toast {
      position: fixed;
      right: 1.5rem;
      top: 1.5rem;
      z-index: 50;
      display: none;
      min-width: 260px;
    }

    .toast.show {
      display: flex;
    }

    .toast-success {
      border-left: 4px solid #16a34a;
    }

    .toast-error {
      border-left: 4px solid #b91c1c;
    }

    .table-header {
      background-color: #f9fafb;
      font-size: 0.8rem;
      text-transform: uppercase;
      color: #6b7280;
      letter-spacing: 0.08em;
    }

    .table-row:hover {
      background-color: #f3f4f6;
    }

    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15,23,42,0.25);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 40;
    }

    .modal-backdrop.show {
      display: flex;
    }

    .status-legend-item {
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: #4b5563;
    }

    .status-dot {
      width: 0.75rem;
      height: 0.75rem;
      border-radius: 9999px;
      display: inline-block;
    }

    .status-dot-under-review {
      background-color: #fecaca;
    }

    .status-dot-received {
      background-color: #bfdbfe;
    }

    .status-dot-verified {
      background-color: #bbf7d0;
    }

    .status-dot-finalized {
      background-color: #ddd6fe;
    }

    .grid-badge {
      font-size: 0.75rem;
      color: #4b5563;
    }

    .disabled {
      opacity: 0.6;
      pointer-events: none;
    }

    .bg-soft {
      background-color: var(--jc-gray-bg);
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast -->
  <div id="toast" class="toast card px-4 py-3 items-start gap-3">
    <div id="toastIcon" class="mt-1">
      <!-- icon gets injected -->
    </div>
    <div>
      <div id="toastTitle" class="font-semibold text-sm mb-0.5"></div>
      <div id="toastMessage" class="text-xs text-gray-600"></div>
    </div>
  </div>

  <!-- LOGIN SCREEN -->
  <main id="loginScreen" class="min-h-screen flex items-center justify-center bg-soft px-4 py-10">
    <div class="max-w-5xl w-full grid md:grid-cols-2 gap-10 items-stretch">
      <!-- Left side: logo / copy -->
      <section class="flex flex-col justify-center">
        <div class="mb-6">
          <img
            src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
            alt="Jeng Chi Logo"
            class="w-24 h-auto mb-4"
          />
          <h1 class="text-2xl md:text-3xl font-bold text-[var(--jc-blue)]">
            Executive Benefits Portal
          </h1>
          <p class="mt-2 text-sm text-gray-600 max-w-md">
            Secure workspace for Jeng Chi executives and HR to review signed benefit elections,
            analytics, and access controls.
          </p>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-xs">
          <div class="card px-4 py-3">
            <div class="kpi-label mb-1">Signed Documents</div>
            <div class="font-semibold text-gray-800 text-sm">
              View finalized enrollment PDFs per employee.
            </div>
          </div>
          <div class="card px-4 py-3">
            <div class="kpi-label mb-1">Analytics</div>
            <div class="font-semibold text-gray-800 text-sm">
              Compare plan elections between 2025 and 2026.
            </div>
          </div>
          <div class="card px-4 py-3">
            <div class="kpi-label mb-1">Governance</div>
            <div class="font-semibold text-gray-800 text-sm">
              Manage portal users and monitor login history.
            </div>
          </div>
          <div class="card px-4 py-3">
            <div class="kpi-label mb-1">Cycle Status</div>
            <div class="font-semibold text-gray-800 text-sm">
              Under Review, Received, Verified, or Finalized.
            </div>
          </div>
        </div>
      </section>

      <!-- Right side: login card -->
      <section class="card px-6 py-7">
        <h2 class="text-xl font-semibold text-gray-900 mb-1">
          Enter your portal credentials
        </h2>
        <p class="text-xs text-gray-600 mb-6">
          Use the initials and PIN issued to you by HR or Ownership.
        </p>

        <form id="loginForm" class="space-y-4">
          <div>
            <label for="initials" class="input-label">Initials</label>
            <input id="initials" type="text" class="input-field" autocomplete="off" />
          </div>

          <div>
            <label for="pin" class="input-label">PIN</label>
            <div class="relative">
              <input
                id="pin"
                type="password"
                class="input-field pr-10"
                autocomplete="off"
              />
              <button
                type="button"
                id="togglePin"
                class="absolute inset-y-0 right-0 flex items-center pr-3 text-gray-500 hover:text-gray-700"
                aria-label="Toggle PIN visibility"
              >
                <i class="fa-regular fa-eye"></i>
              </button>
            </div>
            <p class="text-[0.7rem] text-gray-500 mt-1">
              PIN must be exactly 4 digits.
            </p>
          </div>

          <button
            type="submit"
            id="loginButton"
            class="mt-2 w-full inline-flex justify-center items-center gap-2 rounded-md bg-[var(--jc-blue)] text-white text-sm font-semibold py-2.5 hover:bg-[var(--jc-blue-soft)] transition"
          >
            <i class="fa-solid fa-right-to-bracket"></i>
            <span>Sign In</span>
          </button>
        </form>

        <p class="mt-6 text-[0.7rem] text-gray-500 border-t border-gray-200 pt-4">
          This is a secure executive benefits portal. Unauthorized access is prohibited.
          Activity may be monitored and logged.
        </p>
      </section>
    </div>
  </main>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden min-h-screen bg-soft">
    <!-- Top nav -->
    <header class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
        <div class="flex items-center gap-4">
          <img
            src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
            alt="Jeng Chi Logo"
            class="w-12 h-auto"
          />
          <div>
            <p class="text-xs tracking-[0.22em] uppercase text-gray-500">
              Jeng Chi Restaurant
            </p>
            <h1 class="text-lg md:text-xl font-semibold text-[var(--jc-blue)]">
              Executive Benefits Portal
            </h1>
            <p class="text-[0.75rem] text-gray-500">
              HR & Benefits command center for leadership.
            </p>
          </div>
        </div>
        <div class="flex items-center gap-4">
          <div class="text-right text-xs">
            <div id="loggedInAs" class="font-semibold text-gray-900"></div>
            <div id="currentRoleLabel" class="text-gray-500 text-[0.7rem]"></div>
          </div>
          <button
            id="logoutButton"
            class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
          >
            <i class="fa-solid fa-arrow-right-from-bracket"></i>
            <span>Logout</span>
          </button>
        </div>
      </div>
    </header>

    <!-- KPIs -->
    <section class="border-b border-gray-200 bg-white">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-5 grid grid-cols-1 md:grid-cols-3 gap-4">
        <!-- Total signed -->
        <div class="card px-4 py-3">
          <div class="kpi-label">Total Signed Employees</div>
          <div id="kpiSignedEmployees" class="kpi-value mt-1">0</div>
          <p class="kpi-subtitle mt-1">
            Employees with finalized benefit packets.
          </p>
        </div>

        <!-- Plan year -->
        <div class="card px-4 py-3">
          <div class="kpi-label">Current Plan Year</div>
          <div id="kpiPlanYear" class="kpi-value mt-1">2026</div>
          <p class="kpi-subtitle mt-1">
            Active plan year currently in effect.
          </p>
        </div>

        <!-- Cycle status -->
        <div class="card px-4 py-3 flex flex-col gap-2">
          <div class="flex items-center justify-between">
            <div>
              <div class="kpi-label">Benefit Cycle Status</div>
              <div class="mt-1 flex items-center gap-2">
                <span id="kpiCycleStatusPill" class="status-pill status-under-review">
                  Under Review
                </span>
              </div>
            </div>
            <div id="cycleStatusControl" class="hidden">
              <label class="text-[0.7rem] text-gray-500 block mb-1">Set status</label>
              <select
                id="cycleStatusSelect"
                class="border border-gray-300 rounded-md text-xs px-2 py-1"
              >
                <option value="under_review">Under Review</option>
                <option value="received">Information Received</option>
                <option value="verified">Verified</option>
                <option value="finalized">Finalized</option>
              </select>
            </div>
          </div>
          <p id="kpiCycleStatusDesc" class="kpi-subtitle mt-1">
            Working session: Garrett, Pablo, and Janelle are reviewing and validating benefit data.
          </p>
        </div>
      </div>
    </section>

    <!-- Tabs -->
    <nav class="bg-white border-b border-gray-200">
      <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex flex-wrap gap-2">
        <button id="tabDocs" class="tab-button active">
          Signed Documents
        </button>
        <button id="tabSummary" class="tab-button hidden">
          Benefit Summary
        </button>
        <button id="tabUsers" class="tab-button hidden">
          Authorized Users &amp; Portal Credentials
        </button>
      </div>
    </nav>

    <!-- Main content -->
    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 space-y-8">

      <!-- Signed Documents Tab -->
      <section id="sectionDocs" class="card px-6 py-5">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-5">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Signed Documents</h2>
            <p class="text-sm text-gray-600">
              Browse employees with completed benefit packets. View or print each finalized PDF.
            </p>
          </div>
          <div class="flex items-center gap-2">
            <button
              id="btnPrintAll"
              class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
            >
              <i class="fa-solid fa-print"></i>
              <span>Print All</span>
            </button>
            <button
              id="btnMergeAll"
              class="inline-flex items-center gap-2 rounded-md bg-[var(--jc-blue)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[var(--jc-blue-soft)]"
            >
              <i class="fa-solid fa-file-pdf"></i>
              <span>Merge &amp; Download All</span>
            </button>
          </div>
        </div>

        <div class="mb-4 max-w-sm">
          <label class="input-label" for="searchDocs">Search employee by last name</label>
          <input
            id="searchDocs"
            type="text"
            class="input-field"
          />
          <p class="text-[0.7rem] text-gray-500 mt-1">
            Live filter applies to the table below.
          </p>
        </div>

        <div class="overflow-x-auto border border-gray-200 rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="table-header">
              <tr>
                <th class="px-4 py-2 text-left">Employee Name</th>
                <th class="px-4 py-2 text-left">View</th>
                <th class="px-4 py-2 text-left">Print</th>
              </tr>
            </thead>
            <tbody id="docsTableBody" class="divide-y divide-gray-200">
              <tr>
                <td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">
                  Loading signed employees...
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      </section>

      <!-- Benefit Summary Tab -->
      <section id="sectionSummary" class="card px-6 py-5 hidden">
        <div class="mb-5">
          <h2 class="text-lg font-semibold text-gray-900">Employee Benefit Analytics</h2>
          <p class="text-sm text-gray-600">
            Overview of health, dental, and vision plan elections across 2025 and 2026.
            Use the grid below for high-level counts, then search by last name to see an employee’s
            2025 vs 2026 elections.
          </p>
        </div>

        <!-- Status legend -->
        <div class="mb-6 bg-gray-50 border border-gray-200 rounded-lg px-4 py-3">
          <p class="text-xs font-semibold text-gray-700 mb-2">Benefit Cycle Status Legend</p>
          <div class="grid gap-2 md:grid-cols-2 lg:grid-cols-4">
            <div class="status-legend-item">
              <span class="status-dot status-dot-under-review"></span>
              <span><strong>Under Review:</strong> Data is being checked by Garrett, Pablo, and Janelle.</span>
            </div>
            <div class="status-legend-item">
              <span class="status-dot status-dot-received"></span>
              <span><strong>Information Received:</strong> Data has been transferred to Garrett for processing.</span>
            </div>
            <div class="status-legend-item">
              <span class="status-dot status-dot-verified"></span>
              <span><strong>Verified:</strong> Elections have been cross-checked and validated.</span>
            </div>
            <div class="status-legend-item">
              <span class="status-dot status-dot-finalized"></span>
              <span><strong>Finalized:</strong> No known errors; data is ready for long-term recordkeeping.</span>
            </div>
          </div>
        </div>

        <!-- Aggregated grid: 2025 vs 2026 -->
        <div class="grid md:grid-cols-2 gap-5">
          <!-- 2025 column -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-3">
            <h3 class="text-sm font-semibold text-gray-800 mb-1">2025 Plan Elections</h3>
            <p class="grid-badge mb-3">Counts by plan and coverage type.</p>

            <div class="mb-3">
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Health Plans (2025)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2025Health" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <div class="mb-3">
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Dental Plans (2025)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2025Dental" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <div>
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Vision Plans (2025)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2025Vision" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
          </div>

          <!-- 2026 column -->
          <div class="bg-gray-50 border border-gray-200 rounded-lg px-4 py-3">
            <h3 class="text-sm font-semibold text-gray-800 mb-1">2026 Plan Elections</h3>
            <p class="grid-badge mb-3">Counts by plan and coverage type.</p>

            <div class="mb-3">
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Health Plans (2026)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2026Health" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <div class="mb-3">
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Dental Plans (2026)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2026Dental" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>

            <div>
              <h4 class="text-xs font-semibold text-gray-700 mb-1">Vision Plans (2026)</h4>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs">
                  <thead class="table-header">
                    <tr>
                      <th class="px-2 py-1 text-left">Plan</th>
                      <th class="px-2 py-1 text-right">Employees</th>
                    </tr>
                  </thead>
                  <tbody id="grid2026Vision" class="divide-y divide-gray-200"></tbody>
                </table>
              </div>
            </div>
          </div>
        </div>

        <!-- Per-employee comparison -->
        <div class="mt-8 border-t border-gray-200 pt-4">
          <h3 class="text-sm font-semibold text-gray-900 mb-2">
            Per-Employee 2025 vs 2026 Comparison
          </h3>
          <p class="text-xs text-gray-600 mb-3">
            Search by last name, then select an employee to view their health, dental, and vision
            elections for 2025 and 2026.
          </p>

          <div class="grid md:grid-cols-[220px,1fr] gap-4 items-start">
            <div>
              <label for="summaryEmployeeSearch" class="input-label">
                Search employee by last name
              </label>
              <input
                id="summaryEmployeeSearch"
                type="text"
                class="input-field mb-3"
              />
              <div class="border border-gray-200 rounded-md max-h-64 overflow-y-auto text-xs" id="summaryEmployeeList">
                <div class="px-3 py-2 text-gray-500 text-xs">
                  Type at least 2 letters to begin.
                </div>
              </div>
            </div>

            <div id="employeeSummaryDetail" class="border border-dashed border-gray-300 rounded-md px-4 py-4 text-sm text-gray-600">
              Select an employee from the left list to view their side-by-side comparison.
            </div>
          </div>
        </div>
      </section>

      <!-- Users Tab -->
      <section id="sectionUsers" class="card px-6 py-5 hidden">
        <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-4 mb-5">
          <div>
            <h2 class="text-lg font-semibold text-gray-900">Authorized Users &amp; Portal Credentials</h2>
            <p class="text-sm text-gray-600 max-w-xl">
              Maintain which executives and managers can enter the Executive Benefits Portal.
              Changes here write to the <code>portal_users</code> table in Supabase.
            </p>
          </div>
          <button
            id="btnAddUser"
            class="inline-flex items-center gap-2 rounded-md bg-[var(--jc-blue)] px-3 py-1.5 text-xs font-medium text-white hover:bg-[var(--jc-blue-soft)]"
          >
            <i class="fa-solid fa-user-plus"></i>
            <span>Add User</span>
          </button>
        </div>

        <div class="mb-4 max-w-sm">
          <label for="userSearch" class="input-label">Search users by last name</label>
          <input id="userSearch" type="text" class="input-field" />
        </div>

        <div class="overflow-x-auto border border-gray-200 rounded-lg mb-6">
          <table class="min-w-full text-sm">
            <thead class="table-header">
              <tr>
                <th class="px-3 py-2 text-left">Full Name</th>
                <th class="px-3 py-2 text-left">Initials</th>
                <th class="px-3 py-2 text-left">PIN</th>
                <th class="px-3 py-2 text-left">Role</th>
                <th class="px-3 py-2 text-left">Status</th>
                <th class="px-3 py-2 text-left">Last Login</th>
                <th class="px-3 py-2 text-left">Actions</th>
              </tr>
            </thead>
            <tbody id="usersTableBody" class="divide-y divide-gray-200">
              <tr>
                <td colspan="7" class="px-4 py-4 text-center text-sm text-gray-500">
                  Loading portal users...
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Simple log view from portal_logs -->
        <div class="mt-4">
          <h3 class="text-sm font-semibold text-gray-900 mb-2">Recent Access Log (portal_logs)</h3>
          <p class="text-xs text-gray-600 mb-3">
            Shows recent sessions recorded in <code>portal_logs</code>. Duration is calculated from login to logout.
          </p>
          <div class="overflow-x-auto border border-gray-200 rounded-lg">
            <table class="min-w-full text-xs">
              <thead class="table-header">
                <tr>
                  <th class="px-3 py-2 text-left">Username</th>
                  <th class="px-3 py-2 text-left">Login Time</th>
                  <th class="px-3 py-2 text-left">Logout Time</th>
                  <th class="px-3 py-2 text-left">Duration (min)</th>
                </tr>
              </thead>
              <tbody id="logsTableBody" class="divide-y divide-gray-200">
                <tr>
                  <td colspan="4" class="px-4 py-4 text-center text-gray-500">
                    Loading logs...
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>

    </main>
  </div>

  <!-- Add/Edit User Modal -->
  <div id="userModalBackdrop" class="modal-backdrop">
    <div class="card w-full max-w-md px-6 py-5">
      <h3 id="userModalTitle" class="text-lg font-semibold text-gray-900 mb-4">Add User</h3>
      <div class="space-y-3 mb-4">
        <div>
          <label class="input-label" for="modalFullName">Full Name</label>
          <input id="modalFullName" type="text" class="input-field" />
        </div>
        <div>
          <label class="input-label" for="modalInitials">Initials</label>
          <input id="modalInitials" type="text" class="input-field" />
        </div>
        <div>
          <label class="input-label" for="modalPin">PIN (4 digits)</label>
          <input id="modalPin" type="password" class="input-field" />
        </div>
        <div>
          <label class="input-label" for="modalRole">Role</label>
          <select id="modalRole" class="input-field">
            <option value="admin">Administrator</option>
            <option value="user">Standard User</option>
          </select>
        </div>
        <label class="flex items-center gap-2 text-xs text-gray-700">
          <input id="modalActive" type="checkbox" class="h-4 w-4 border-gray-400" checked />
          <span>Portal access is active</span>
        </label>
      </div>
      <div class="flex justify-end gap-2">
        <button
          id="btnUserModalCancel"
          class="inline-flex items-center gap-2 rounded-md border border-gray-300 bg-white px-3 py-1.5 text-xs font-medium text-gray-700 hover:bg-gray-50"
        >
          Cancel
        </button>
        <button
          id="btnUserModalSave"
          class="inline-flex items-center gap-2 rounded-md bg-[var(--jc-blue)] px-3 py-1.5 text-xs font-medium text-white hover:bg-[var(--jc-blue-soft)]"
        >
          Save
        </button>
      </div>
    </div>
  </div>

  <!-- SCRIPT -->
  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    const PLAN_LABELS = {
      "WAIVE": "Waived Coverage",
      "ATBAB303": "HMO / ATBAB303",
      "ATBCB402": "PPO / ATBCB402",
      "ATBAP393": "HMO HSA / ATBAP393",
      "F_PLAN_2W": "F-PLAN 2W / Base MAC",
      "F_PLAN_3W": "F-PLAN 3W / Buy Up MAC",
      "PLAN_1": "Vision Plan 1"
    };

    const CYCLE_STATUS = {
      under_review: {
        label: "Under Review",
        pillClass: "status-under-review",
        desc: "Working session: Garrett, Pablo, and Janelle are reviewing and validating benefit data."
      },
      received: {
        label: "Information Received",
        pillClass: "status-received",
        desc: "All information has been transferred to Garrett for processing."
      },
      verified: {
        label: "Verified",
        pillClass: "status-verified",
        desc: "Benefits data has been cross-checked and verified by leadership."
      },
      finalized: {
        label: "Finalized",
        pillClass: "status-finalized",
        desc: "Cycle is complete. No known errors; data is ready for records."
      }
    };

    let currentUser = null;   // portal_users row
    let currentLogId = null;  // portal_logs id for this session
    let signedEmployees = [];
    let portalUsers = [];
    let benefitEnrollments = [];

    // ====== UTILITIES ======
    function showToast(type, title, message) {
      const toast = document.getElementById("toast");
      const titleEl = document.getElementById("toastTitle");
      const messageEl = document.getElementById("toastMessage");
      const iconEl = document.getElementById("toastIcon");

      toast.classList.remove("toast-success", "toast-error");
      toast.classList.add(type === "success" ? "toast-success" : "toast-error");

      iconEl.innerHTML = type === "success"
        ? '<i class="fa-solid fa-circle-check text-green-600"></i>'
        : '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';

      titleEl.textContent = title;
      messageEl.textContent = message;

      toast.classList.add("show");
      setTimeout(() => toast.classList.remove("show"), 3500);
    }

    function formatDateTime(str) {
      if (!str) return "—";
      const d = new Date(str);
      if (isNaN(d.getTime())) return "—";
      return d.toLocaleString("en-US", {
        year: "numeric",
        month: "2-digit",
        day: "2-digit",
        hour: "2-digit",
        minute: "2-digit",
        hour12: true
      });
    }

    function escapeHtml(text) {
      return String(text ?? "")
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function setCycleStatus(key) {
      const status = CYCLE_STATUS[key] || CYCLE_STATUS.under_review;
      const pill = document.getElementById("kpiCycleStatusPill");
      const desc = document.getElementById("kpiCycleStatusDesc");

      pill.className = "status-pill " + status.pillClass;
      pill.textContent = status.label;
      desc.textContent = status.desc;

      const select = document.getElementById("cycleStatusSelect");
      if (select && select.value !== key) {
        select.value = key;
      }
      // You can persist this later with a portal_settings table if desired
      localStorage.setItem("jc_cycle_status", key);
    }

    function getStoredCycleStatus() {
      return localStorage.getItem("jc_cycle_status") || "under_review";
    }

    // ====== LOGIN & SESSION ======
    const loginScreen = document.getElementById("loginScreen");
    const dashboard = document.getElementById("dashboard");
    const loginForm = document.getElementById("loginForm");
    const togglePin = document.getElementById("togglePin");
    const logoutButton = document.getElementById("logoutButton");

    togglePin.addEventListener("click", () => {
      const pinInput = document.getElementById("pin");
      if (pinInput.type === "password") {
        pinInput.type = "text";
        togglePin.innerHTML = '<i class="fa-regular fa-eye-slash"></i>';
      } else {
        pinInput.type = "password";
        togglePin.innerHTML = '<i class="fa-regular fa-eye"></i>';
      }
    });

    async function findPortalUser(initials, pin) {
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, username, pin, role, active, last_login")
        .eq("initials", initials)
        .eq("pin", pin)
        .eq("active", true)
        .maybeSingle();

      if (error) {
        console.error("Error loading portal_users:", error);
        return null;
      }
      return data || null;
    }

    async function recordLoginLog(initials) {
      try {
        const { data: emp, error: empErr } = await supabase
          .from("employees2025")
          .select("id, username")
          .eq("username", initials)
          .maybeSingle();

        if (empErr) {
          console.warn("Could not find employees2025 row for log:", empErr);
          return null;
        }
        if (!emp) return null;

        const { data, error } = await supabase
          .from("portal_logs")
          .insert({ employee_id: emp.id })
          .select("id")
          .maybeSingle();

        if (error) {
          console.error("Error inserting portal_logs:", error);
          return null;
        }
        return data ? data.id : null;
      } catch (e) {
        console.error("Unexpected error in recordLoginLog:", e);
        return null;
      }
    }

    async function updateLogoutLog(id) {
      if (!id) return;
      try {
        const logoutTime = new Date();
        // Fetch login_time to compute duration
        const { data: log, error: logErr } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", id)
          .maybeSingle();

        let duration = null;
        if (!logErr && log && log.login_time) {
          const loginTime = new Date(log.login_time);
          duration = Math.round((logoutTime - loginTime) / 60000);
        }

        const { error } = await supabase
          .from("portal_logs")
          .update({
            logout_time: logoutTime.toISOString(),
            duration_minutes: duration
          })
          .eq("id", id);

        if (error) {
          console.error("Error updating portal_logs on logout:", error);
        }
      } catch (e) {
        console.error("Unexpected error updating logout log:", e);
      }
    }

    async function handleLogin(event) {
      event.preventDefault();
      const initialsInput = document.getElementById("initials");
      const pinInput = document.getElementById("pin");
      const initials = initialsInput.value.trim().toUpperCase();
      const pin = pinInput.value.trim();

      if (!initials || !pin) {
        showToast("error", "Missing Fields", "Please enter both initials and PIN.");
        return;
      }
      if (!/^[0-9]{4}$/.test(pin)) {
        showToast("error", "Invalid PIN", "PIN must be exactly 4 digits.");
        return;
      }

      const loginButton = document.getElementById("loginButton");
      loginButton.classList.add("disabled");
      loginButton.disabled = true;

      const user = await findPortalUser(initials, pin);

      if (!user) {
        showToast("error", "Invalid credentials", "Initials or PIN are not valid, or account is inactive.");
        loginButton.classList.remove("disabled");
        loginButton.disabled = false;
        return;
      }

      // Record last_login
      await supabase
        .from("portal_users")
        .update({ last_login: new Date().toISOString() })
        .eq("id", user.id);

      const logId = await recordLoginLog(initials);
      currentUser = user;
      currentLogId = logId;

      sessionStorage.setItem("jc_portal_auth", JSON.stringify({
        user,
        logId
      }));

      showToast("success", "Login successful", "Redirecting to dashboard...");
      setTimeout(() => {
        showDashboard();
        loginButton.classList.remove("disabled");
        loginButton.disabled = false;
      }, 500);
    }

    loginForm.addEventListener("submit", handleLogin);

    async function handleLogout() {
      try {
        const stored = sessionStorage.getItem("jc_portal_auth");
        if (stored) {
          const parsed = JSON.parse(stored);
          if (parsed.logId) {
            await updateLogoutLog(parsed.logId);
          }
        }
      } catch (e) {
        console.error("Logout error:", e);
      } finally {
        sessionStorage.removeItem("jc_portal_auth");
        window.location.reload();
      }
    }

    logoutButton.addEventListener("click", handleLogout);

    function showDashboard() {
      loginScreen.classList.add("hidden");
      dashboard.classList.remove("hidden");
      const nameEl = document.getElementById("loggedInAs");
      const roleEl = document.getElementById("currentRoleLabel");
      nameEl.textContent = `Logged in as ${currentUser.full_name}`;
      roleEl.textContent = currentUser.role === "admin" ? "Administrator" : "Standard User";

      // Admin-only tabs
      const tabSummary = document.getElementById("tabSummary");
      const tabUsers = document.getElementById("tabUsers");
      const statusControl = document.getElementById("cycleStatusControl");

      if (currentUser.role === "admin") {
        tabSummary.classList.remove("hidden");
        tabUsers.classList.remove("hidden");
        statusControl.classList.remove("hidden");
      } else {
        tabSummary.classList.add("hidden");
        tabUsers.classList.add("hidden");
        statusControl.classList.add("hidden");
      }

      // Restore cycle status
      setCycleStatus(getStoredCycleStatus());

      // Load data
      loadSignedEmployees();
      if (currentUser.role === "admin") {
        loadPortalUsers();
        loadLogs();
        loadEnrollments();
      }
    }

    // Auto login if session present
    (function initFromSession() {
      const stored = sessionStorage.getItem("jc_portal_auth");
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        currentUser = parsed.user;
        currentLogId = parsed.logId;
        showDashboard();
      } catch (e) {
        console.error("Error parsing stored session:", e);
        sessionStorage.removeItem("jc_portal_auth");
      }
    })();

    // ====== Tabs ======
    const tabDocs = document.getElementById("tabDocs");
    const tabSummary = document.getElementById("tabSummary");
    const tabUsers = document.getElementById("tabUsers");
    const sectionDocs = document.getElementById("sectionDocs");
    const sectionSummary = document.getElementById("sectionSummary");
    const sectionUsers = document.getElementById("sectionUsers");

    function setActiveTab(tab) {
      [tabDocs, tabSummary, tabUsers].forEach(btn => btn && btn.classList.remove("active"));
      [sectionDocs, sectionSummary, sectionUsers].forEach(sec => sec && sec.classList.add("hidden"));

      if (tab === "docs") {
        tabDocs.classList.add("active");
        sectionDocs.classList.remove("hidden");
      } else if (tab === "summary") {
        tabSummary.classList.add("active");
        sectionSummary.classList.remove("hidden");
      } else if (tab === "users") {
        tabUsers.classList.add("active");
        sectionUsers.classList.remove("hidden");
      }
    }

    tabDocs.addEventListener("click", () => setActiveTab("docs"));
    tabSummary.addEventListener("click", () => {
      if (currentUser.role === "admin") setActiveTab("summary");
    });
    tabUsers.addEventListener("click", () => {
      if (currentUser.role === "admin") setActiveTab("users");
    });

    // ====== Cycle status select ======
    const cycleStatusSelect = document.getElementById("cycleStatusSelect");
    cycleStatusSelect.addEventListener("change", () => {
      setCycleStatus(cycleStatusSelect.value);
    });

    // ====== Signed Documents ======
    async function loadSignedEmployees() {
      const body = document.getElementById("docsTableBody");
      body.innerHTML = `
        <tr>
          <td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">
            Loading signed employees...
          </td>
        </tr>
      `;

      const { data, error } = await supabase
        .from("employees2025")
        .select("id, first_name, last_name, username, signed_pdf_url")
        .not("signed_pdf_url", "is", null);

      if (error) {
        console.error("Error loading employees2025:", error);
        body.innerHTML = `
          <tr>
            <td colspan="3" class="px-4 py-4 text-center text-sm text-red-600">
              Error loading signed employees.
            </td>
          </tr>
        `;
        return;
      }

      signedEmployees = (data || []).filter(e => e.signed_pdf_url);
      signedEmployees.sort((a, b) => {
        const lnA = (a.last_name || "").toLowerCase();
        const lnB = (b.last_name || "").toLowerCase();
        if (lnA < lnB) return -1;
        if (lnA > lnB) return 1;
        const fnA = (a.first_name || "").toLowerCase();
        const fnB = (b.first_name || "").toLowerCase();
        return fnA.localeCompare(fnB);
      });

      document.getElementById("kpiSignedEmployees").textContent = signedEmployees.length;
      renderDocsTable();
    }

    function renderDocsTable(filterLastName = "") {
      const body = document.getElementById("docsTableBody");
      const term = filterLastName.trim().toLowerCase();

      let list = signedEmployees;
      if (term) {
        list = list.filter(e =>
          (e.last_name || "").toLowerCase().includes(term)
        );
      }

      if (list.length === 0) {
        body.innerHTML = `
          <tr>
            <td colspan="3" class="px-4 py-4 text-center text-sm text-gray-500">
              No employees match that last name.
            </td>
          </tr>
        `;
        return;
      }

      body.innerHTML = "";
      list.forEach(emp => {
        const fullName = `${emp.last_name || ""}, ${emp.first_name || ""}`.trim();
        const pdfUrl = emp.signed_pdf_url;
        body.insertAdjacentHTML("beforeend", `
          <tr class="table-row">
            <td class="px-4 py-2 text-sm text-gray-900">${escapeHtml(fullName)}</td>
            <td class="px-4 py-2 text-sm">
              ${pdfUrl
                ? `<a href="${escapeHtml(pdfUrl)}" target="_blank" class="text-[var(--jc-blue)] hover:underline text-xs inline-flex items-center gap-1">
                     <i class="fa-regular fa-file-pdf"></i><span>View PDF</span>
                   </a>`
                : `<span class="text-xs text-gray-400">N/A</span>`}
            </td>
            <td class="px-4 py-2 text-sm">
              ${pdfUrl
                ? `<button data-url="${escapeHtml(pdfUrl)}" class="btn-print-one inline-flex items-center gap-1 text-xs text-gray-700 hover:text-black">
                     <i class="fa-solid fa-print"></i><span>Print</span>
                   </button>`
                : `<span class="text-xs text-gray-400">N/A</span>`}
            </td>
          </tr>
        `);
      });
    }

    document.getElementById("searchDocs").addEventListener("input", (e) => {
      renderDocsTable(e.target.value);
    });

    document.getElementById("docsTableBody").addEventListener("click", (e) => {
      const btn = e.target.closest(".btn-print-one");
      if (!btn) return;
      const url = btn.getAttribute("data-url");
      if (url) {
        window.open(url, "_blank");
        showToast("success", "Print opened", "The PDF has been opened in a new tab. Use browser print to print.");
      }
    });

    document.getElementById("btnPrintAll").addEventListener("click", () => {
      if (!signedEmployees.length) {
        showToast("error", "No documents", "There are no signed documents to print.");
        return;
      }
      signedEmployees.forEach(emp => {
        if (emp.signed_pdf_url) {
          window.open(emp.signed_pdf_url, "_blank");
        }
      });
      showToast("success", "Print initiated", "All signed PDFs have been opened in new tabs.");
    });

    document.getElementById("btnMergeAll").addEventListener("click", async () => {
      if (!signedEmployees.length) {
        showToast("error", "No documents", "There are no signed documents to merge.");
        return;
      }
      const employeeIds = signedEmployees.map(e => e.id);
      try {
        const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "apikey": SUPABASE_KEY,
            "Authorization": `Bearer ${SUPABASE_KEY}`
          },
          body: JSON.stringify({ employee_ids: employeeIds })
        });
        if (!res.ok) {
          const text = await res.text();
          console.error("merge-signed-pdfs error:", text);
          showToast("error", "Merge failed", "Edge function merge-signed-pdfs returned an error.");
          return;
        }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showToast("success", "Merged PDF ready", "Combined PDF opened in a new tab.");
      } catch (err) {
        console.error("Unexpected merge error:", err);
        showToast("error", "Merge failed", "Unexpected error calling merge-signed-pdfs.");
      }
    });

    // ====== Benefit Summary / Enrollments ======
    async function loadEnrollments() {
      const { data, error } = await supabase
        .from("benefit_enrollments")
        .select("username, benefit_year, medical_plan, dental_plan, vision_plan");

      if (error) {
        console.error("Error loading benefit_enrollments:", error);
        return;
      }
      benefitEnrollments = data || [];
      renderAggregatedGrids();
      prepareEmployeeSummarySearch();
    }

    function getPlanLabel(code) {
      if (!code) return "No election";
      const key = code.toUpperCase();
      if (key === "NO" || key === "NONE") return "No election";
      return PLAN_LABELS[key] || key;
    }

    function countPlans(year, key) {
      const counts = {};
      benefitEnrollments
        .filter(e => e.benefit_year === year)
        .forEach(e => {
          const planCode = (e[key] || "NO").toUpperCase();
          counts[planCode] = (counts[planCode] || 0) + 1;
        });
      return counts;
    }

    function renderCountsToTable(counts, tbodyId) {
      const tbody = document.getElementById(tbodyId);
      tbody.innerHTML = "";
      const entries = Object.entries(counts);
      if (!entries.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="2" class="px-2 py-2 text-center text-gray-500 text-xs">
              No enrollments found.
            </td>
          </tr>
        `;
        return;
      }
      entries.sort((a, b) => b[1] - a[1]);
      entries.forEach(([code, count]) => {
        tbody.insertAdjacentHTML("beforeend", `
          <tr>
            <td class="px-2 py-1 text-xs text-gray-800">
              <span class="font-semibold">${escapeHtml(getPlanLabel(code))}</span>
            </td>
            <td class="px-2 py-1 text-xs text-right text-gray-800">
              ${count}
            </td>
          </tr>
        `);
      });
    }

    function renderAggregatedGrids() {
      // 2025
      const c2025Health = countPlans(2025, "medical_plan");
      const c2025Dental = countPlans(2025, "dental_plan");
      const c2025Vision = countPlans(2025, "vision_plan");
      renderCountsToTable(c2025Health, "grid2025Health");
      renderCountsToTable(c2025Dental, "grid2025Dental");
      renderCountsToTable(c2025Vision, "grid2025Vision");

      // 2026
      const c2026Health = countPlans(2026, "medical_plan");
      const c2026Dental = countPlans(2026, "dental_plan");
      const c2026Vision = countPlans(2026, "vision_plan");
      renderCountsToTable(c2026Health, "grid2026Health");
      renderCountsToTable(c2026Dental, "grid2026Dental");
      renderCountsToTable(c2026Vision, "grid2026Vision");
    }

    function prepareEmployeeSummarySearch() {
      const searchInput = document.getElementById("summaryEmployeeSearch");
      const listContainer = document.getElementById("summaryEmployeeList");
      const detail = document.getElementById("employeeSummaryDetail");

      function renderList(term) {
        listContainer.innerHTML = "";
        const trimmed = term.trim().toLowerCase();
        if (trimmed.length < 2) {
          listContainer.innerHTML = `
            <div class="px-3 py-2 text-gray-500 text-xs">
              Type at least 2 letters to begin.
            </div>
          `;
          return;
        }

        const byUsername = {};
        signedEmployees.forEach(e => { byUsername[e.username] = e; });

        const candidates = benefitEnrollments
          .map(e => e.username)
          .filter((v, i, arr) => arr.indexOf(v) === i)
          .map(username => {
            const emp = byUsername[username];
            return {
              username,
              last_name: emp ? emp.last_name : "",
              first_name: emp ? emp.first_name : ""
            };
          })
          .filter(emp => (emp.last_name || "").toLowerCase().includes(trimmed));

        if (!candidates.length) {
          listContainer.innerHTML = `
            <div class="px-3 py-2 text-gray-500 text-xs">
              No employees found for that last name.
            </div>
          `;
          return;
        }

        candidates.sort((a, b) => (a.last_name || "").localeCompare(b.last_name || ""));
        candidates.forEach(emp => {
          const label = `${emp.last_name || ""}, ${emp.first_name || ""} (${emp.username})`;
          const btn = document.createElement("button");
          btn.type = "button";
          btn.className = "w-full text-left px-3 py-2 text-xs border-b border-gray-100 hover:bg-gray-100";
          btn.textContent = label;
          btn.addEventListener("click", () => {
            renderEmployeeDetail(emp.username);
          });
          listContainer.appendChild(btn);
        });
      }

      searchInput.addEventListener("input", (e) => renderList(e.target.value));
    }

    function renderEmployeeDetail(username) {
      const detail = document.getElementById("employeeSummaryDetail");
      const emp = signedEmployees.find(e => e.username === username);
      const lastFirst = emp ? `${emp.last_name || ""}, ${emp.first_name || ""}` : username;

      const enroll2025 = benefitEnrollments.find(e => e.username === username && e.benefit_year === 2025);
      const enroll2026 = benefitEnrollments.find(e => e.username === username && e.benefit_year === 2026);

      if (!enroll2025 && !enroll2026) {
        detail.innerHTML = `
          <div class="text-sm text-gray-700">
            <p class="font-semibold mb-1">${escapeHtml(lastFirst)}</p>
            <p>No benefit elections found for 2025 or 2026.</p>
          </div>
        `;
        return;
      }

      detail.innerHTML = `
        <div class="text-sm text-gray-800 space-y-3">
          <p class="font-semibold text-gray-900">
            ${escapeHtml(lastFirst)} — ${escapeHtml(username)}
          </p>

          <div class="grid md:grid-cols-2 gap-4">
            <div class="border border-gray-200 rounded-md px-3 py-3">
              <p class="text-xs font-semibold text-gray-500 mb-1">2025 Elections</p>
              ${enroll2025 ? `
                <ul class="text-xs text-gray-700 space-y-1">
                  <li><strong>Health:</strong> ${escapeHtml(getPlanLabel(enroll2025.medical_plan))}</li>
                  <li><strong>Dental:</strong> ${escapeHtml(getPlanLabel(enroll2025.dental_plan))}</li>
                  <li><strong>Vision:</strong> ${escapeHtml(getPlanLabel(enroll2025.vision_plan))}</li>
                </ul>
              ` : `
                <p class="text-xs text-gray-500">No 2025 elections on file.</p>
              `}
            </div>

            <div class="border border-gray-200 rounded-md px-3 py-3">
              <p class="text-xs font-semibold text-gray-500 mb-1">2026 Elections</p>
              ${enroll2026 ? `
                <ul class="text-xs text-gray-700 space-y-1">
                  <li><strong>Health:</strong> ${escapeHtml(getPlanLabel(enroll2026.medical_plan))}</li>
                  <li><strong>Dental:</strong> ${escapeHtml(getPlanLabel(enroll2026.dental_plan))}</li>
                  <li><strong>Vision:</strong> ${escapeHtml(getPlanLabel(enroll2026.vision_plan))}</li>
                </ul>
              ` : `
                <p class="text-xs text-gray-500">No 2026 elections on file.</p>
              `}
            </div>
          </div>

          <p class="text-xs text-gray-600">
            Use this comparison to confirm if the employee upgraded, downgraded, or kept the same coverage between years.
          </p>
        </div>
      `;
    }

    // ====== Authorized Users ======
    const userSearchInput = document.getElementById("userSearch");
    const usersTableBody = document.getElementById("usersTableBody");

    async function loadPortalUsers() {
      usersTableBody.innerHTML = `
        <tr>
          <td colspan="7" class="px-4 py-4 text-center text-sm text-gray-500">
            Loading portal users...
          </td>
        </tr>
      `;
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, username, pin, role, active, last_login")
        .order("full_name", { ascending: true });

      if (error) {
        console.error("Error loading portal_users:", error);
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-sm text-red-600">
              Error loading portal users.
            </td>
          </tr>
        `;
        return;
      }
      portalUsers = data || [];
      renderUsersTable();
    }

    function renderUsersTable(filterLastName = "") {
      const term = filterLastName.trim().toLowerCase();
      let list = portalUsers;
      if (term) {
        list = list.filter(u =>
          (u.full_name || "").toLowerCase().includes(term)
        );
      }
      if (!list.length) {
        usersTableBody.innerHTML = `
          <tr>
            <td colspan="7" class="px-4 py-4 text-center text-sm text-gray-500">
              No users found.
            </td>
          </tr>
        `;
        return;
      }

      usersTableBody.innerHTML = "";
      list.forEach(u => {
        const isAdmin = u.role === "admin";
        const rolePill = isAdmin
          ? `<span class="pill pill-admin">Administrator</span>`
          : `<span class="pill pill-user">Standard User</span>`;
        const activePill = u.active
          ? `<span class="pill pill-active">Active</span>`
          : `<span class="pill pill-inactive">Inactive</span>`;

        usersTableBody.insertAdjacentHTML("beforeend", `
          <tr class="table-row" data-id="${u.id}">
            <td class="px-3 py-2 text-sm text-gray-900">${escapeHtml(u.full_name || "")}</td>
            <td class="px-3 py-2 text-sm text-gray-700">${escapeHtml(u.initials || "")}</td>
            <td class="px-3 py-2 text-sm text-gray-700">
              <span class="text-xs tracking-[0.25em]">${escapeHtml(u.pin || "")}</span>
            </td>
            <td class="px-3 py-2 text-sm">${rolePill}</td>
            <td class="px-3 py-2 text-sm">${activePill}</td>
            <td class="px-3 py-2 text-xs text-gray-600">${formatDateTime(u.last_login)}</td>
            <td class="px-3 py-2 text-xs">
              <button class="btn-edit-user text-[var(--jc-blue)] hover:underline mr-3">
                Edit
              </button>
              <button class="btn-toggle-active text-gray-700 hover:underline">
                ${u.active ? "Deactivate" : "Activate"}
              </button>
            </td>
          </tr>
        `);
      });
    }

    userSearchInput.addEventListener("input", (e) => {
      renderUsersTable(e.target.value);
    });

    usersTableBody.addEventListener("click", async (e) => {
      const row = e.target.closest("tr[data-id]");
      if (!row) return;
      const id = Number(row.getAttribute("data-id"));
      const user = portalUsers.find(u => u.id === id);
      if (!user) return;

      if (e.target.classList.contains("btn-edit-user")) {
        openUserModal(user);
      } else if (e.target.classList.contains("btn-toggle-active")) {
        await toggleUserActive(user);
      }
    });

    async function toggleUserActive(user) {
      const newActive = !user.active;
      const { error } = await supabase
        .from("portal_users")
        .update({ active: newActive })
        .eq("id", user.id);

      if (error) {
        console.error("Error updating active:", error);
        showToast("error", "Update failed", "Could not update user status.");
        return;
      }
      user.active = newActive;
      showToast("success", "Status updated", `User ${user.initials} is now ${newActive ? "active" : "inactive"}.`);
      renderUsersTable(userSearchInput.value);
    }

    // Modal logic
    const userModalBackdrop = document.getElementById("userModalBackdrop");
    const userModalTitle = document.getElementById("userModalTitle");
    const modalFullName = document.getElementById("modalFullName");
    const modalInitials = document.getElementById("modalInitials");
    const modalPin = document.getElementById("modalPin");
    const modalRole = document.getElementById("modalRole");
    const modalActive = document.getElementById("modalActive");
    const btnUserModalCancel = document.getElementById("btnUserModalCancel");
    const btnUserModalSave = document.getElementById("btnUserModalSave");
    let editingUserId = null;

    function openUserModal(user) {
      editingUserId = user ? user.id : null;
      userModalTitle.textContent = editingUserId ? "Edit User" : "Add User";
      modalFullName.value = user ? user.full_name || "" : "";
      modalInitials.value = user ? user.initials || "" : "";
      modalPin.value = user ? user.pin || "" : "";
      modalRole.value = user ? user.role || "user" : "admin";
      modalActive.checked = user ? !!user.active : true;

      userModalBackdrop.classList.add("show");
    }

    function closeUserModal() {
      userModalBackdrop.classList.remove("show");
    }

    document.getElementById("btnAddUser").addEventListener("click", () => openUserModal(null));
    btnUserModalCancel.addEventListener("click", closeUserModal);

    btnUserModalSave.addEventListener("click", async () => {
      const fullName = modalFullName.value.trim();
      const initials = modalInitials.value.trim().toUpperCase();
      const pin = modalPin.value.trim();
      const role = modalRole.value;
      const active = modalActive.checked;

      if (!fullName || !initials || !pin) {
        showToast("error", "Missing fields", "Full Name, Initials, and PIN are required.");
        return;
      }
      if (!/^[0-9]{4}$/.test(pin)) {
        showToast("error", "Invalid PIN", "PIN must be exactly 4 digits.");
        return;
      }

      const payload = {
        full_name: fullName,
        initials,
        username: initials,
        pin,
        role,
        active
      };

      let error = null;
      if (editingUserId) {
        const { error: errUpdate } = await supabase
          .from("portal_users")
          .update(payload)
          .eq("id", editingUserId);
        error = errUpdate || null;
      } else {
        const { error: errInsert } = await supabase
          .from("portal_users")
          .insert(payload);
        error = errInsert || null;
      }

      if (error) {
        console.error("Error saving portal_users:", error);
        showToast("error", "Save failed", "Could not save user. Check console for details.");
        return;
      }

      closeUserModal();
      showToast("success", "User saved", "Portal user record has been saved.");
      await loadPortalUsers();
    });

    // ====== Logs ======
    async function loadLogs() {
      const tbody = document.getElementById("logsTableBody");
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-4 py-4 text-center text-xs text-gray-500">
            Loading logs...
          </td>
        </tr>
      `;
      const { data, error } = await supabase
        .from("portal_logs")
        .select("id, login_time, logout_time, duration_minutes, employee_id, employees2025:employee_id(username)")
        .order("login_time", { ascending: false })
        .limit(50);

      if (error) {
        console.error("Error loading portal_logs:", error);
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-xs text-red-600">
              Error loading logs.
            </td>
          </tr>
        `;
        return;
      }

      if (!data || !data.length) {
        tbody.innerHTML = `
          <tr>
            <td colspan="4" class="px-4 py-4 text-center text-xs text-gray-500">
              No logs available.
            </td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = "";
      data.forEach(log => {
        const username = log.employees2025?.username || "—";
        const loginStr = formatDateTime(log.login_time);
        const logoutStr = log.logout_time ? formatDateTime(log.logout_time) : "Active / not captured";
        let dur = "—";
        if (typeof log.duration_minutes === "number") {
          dur = `${log.duration_minutes} min`;
        } else if (!log.logout_time) {
          dur = "Active";
        }
        tbody.insertAdjacentHTML("beforeend", `
          <tr class="table-row">
            <td class="px-3 py-2 text-xs text-gray-800">${escapeHtml(username)}</td>
            <td class="px-3 py-2 text-xs text-gray-700">${escapeHtml(loginStr)}</td>
            <td class="px-3 py-2 text-xs text-gray-700">${escapeHtml(logoutStr)}</td>
            <td class="px-3 py-2 text-xs text-gray-700">${escapeHtml(dur)}</td>
          </tr>
        `);
      });
    }

    // ====== beforeunload auto logout (best-effort) ======
    window.addEventListener("beforeunload", async (e) => {
      const stored = sessionStorage.getItem("jc_portal_auth");
      if (!stored) return;
      try {
        const parsed = JSON.parse(stored);
        if (parsed.logId) {
          // Fire and forget; we don't block unload
          updateLogoutLog(parsed.logId);
        }
      } catch (err) {
        console.error("beforeunload error:", err);
      }
    });
  </script>
</body>
</html>
