<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <title>Jeng Chi — Executive Benefits Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
  <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <!-- NEW: ExcelJS and FileSaver for advanced Excel export -->
  <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
  <style>
    :root {
      --jc-red: #8a1619;
      --jc-red-soft: #c53030;
      --jc-navy: #003366;
      --jc-navy-soft: #0b3c73;
      --jc-gray-bg: #f4f5f7;
    }
    body { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; color: #111827; }
    .card { background: #ffffff; border-radius: 0.75rem; border: 1px solid #e5e7eb; box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08); }
    .input-border { border: 1px solid #111827; }
    .toast { position: fixed; inset-inline: 0; top: 1rem; margin-inline: auto; max-width: 22rem; z-index: 50; }
    .pill-badge { border-radius: 9999px; font-size: 0.7rem; letter-spacing: 0.12em; text-transform: uppercase; }
    .tab-btn-active { border-bottom: 2px solid var(--jc-red); color: #111827; font-weight: 600; }
    .tab-btn-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
    .cost-bar-track { height: 0.5rem; border-radius: 9999px; background: #e5e7eb; }
    .cost-bar-med { background: var(--jc-red); }
    .cost-bar-den { background: #1d4ed8; }
    .cost-bar-vis { background: #4b5563; }
    .login-bg { background-color: #ffffff; background-image: none; }
    /* Custom styles for the Comprehensive Report Grid */
    .report-grid-container {
        max-height: 70vh;
        overflow: auto;
    }
    .report-grid-table {
      width: 100%;
      border-collapse: collapse;
    }
    .report-grid-table th,
    .report-grid-table td {
      border: 1px solid #e5e7eb;
      padding: 8px;
      text-align: left;
    }
    .report-grid-table th {
        white-space: nowrap;
        background-color: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        color: #111827;
    }
    .report-grid-table td {
      background-color: #ffffff;
    }
    .report-grid-table tr:nth-child(even) td {
      background-color: #f9fafb;
    }
    /* Style for the new employee list table */
    #employeeListTableBody td { white-space: nowrap; }
    #employeeListTableBody td:nth-child(1) { white-space: normal; }
    .tab-section { width: 100%; }
  </style>
</head>
<body class="min-h-screen bg-slate-50">
<div id="toast" class="toast hidden">
  <div id="toastInner" class="card px-4 py-3 flex items-start gap-3">
    <div id="toastIcon" class="mt-1">
      <i class="fa-solid fa-circle-check text-emerald-600"></i>
    </div>
    <div class="flex-1">
      <p id="toastTitle" class="font-semibold text-sm">Title</p>
      <p id="toastMessage" class="text-xs text-slate-600 mt-0.5">Message</p>
    </div>
    <button class="text-slate-400 hover:text-slate-600 text-xs" onclick="hideToast()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
</div>
<main id="loginView" class="login-bg min-h-screen flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-5xl grid lg:grid-cols-2 gap-10 items-center">
    <section class="space-y-8">
      <div class="space-y-6">
        <div class="flex flex-col items-center text-center gap-4">
          <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Jeng Chi Logo" class="h-20 w-auto" />
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-[color:var(--jc-navy)]">
              Executive Benefits Portal
            </h1>
            <p class="mt-2 text-sm md:text-base text-slate-600 max-w-xl mx-auto">
              Secure workspace for Jeng Chi executives and HR to review signed benefit elections,
              analytics, and access controls.
            </p>
          </div>
        </div>
      </div>
    </section>
    <section class="card px-6 py-7 space-y-6">
      <header class="space-y-1 text-center">
        <p class="text-[0.75rem] uppercase tracking-[0.24em] text-slate-500">
          Executive sign-in
        </p>
        <h2 class="text-xl font-semibold text-slate-900">
          Enter your portal credentials
        </h2>
        <p class="text-xs text-slate-500 mt-0.5">
          Use the initials and PIN issued to you by HR or Ownership.
        </p>
      </header>
      <div class="space-y-4">
        <div>
          <label for="loginInitials" class="block text-xs font-semibold text-slate-700 mb-1">
            Initials
          </label>
          <input
            id="loginInitials"
            type="text"
            autocomplete="off"
            class="w-full rounded-md px-3 py-2 input-border bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label for="loginPin" class="block text-xs font-semibold text-slate-700 mb-1">
            PIN
          </label>
          <div class="relative">
            <input
              id="loginPin"
              type="password"
              autocomplete="off"
              maxlength="4"
              class="w-full rounded-md px-3 py-2 input-border bg-white text-sm pr-10 focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
            />
            <button
              id="togglePin"
              type="button"
              class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700"
            >
              <i class="fa-regular fa-eye text-xs"></i>
            </button>
          </div>
        </div>
      </div>
      <button
        id="loginButton"
        type="button"
        class="w-full inline-flex justify-center items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white text-sm font-semibold py-2.5 hover:bg-[color:var(--jc-red-soft)] transition-shadow shadow-sm hover:shadow"
      >
        <i class="fa-solid fa-right-to-bracket"></i>
        <span>Sign In</span>
      </button>
      <p class="mt-2 text-[0.7rem] text-slate-500 text-center">
        This is a secure executive benefits portal. Unauthorized access is prohibited.
      </p>
    </section>
  </div>
</main>
<div id="dashboardView" class="hidden min-h-screen bg-slate-50">
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Jeng Chi Logo" class="h-11 w-auto" />
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Jeng Chi Restaurant
          </p>
          <h1 class="text-lg sm:text-xl font-semibold text-[color:var(--jc-navy)]">
            Executive Benefits Portal
          </h1>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden sm:flex flex-col items-end text-right">
          <span id="headerUserName" class="text-sm font-semibold text-slate-900"></span>
          <span id="headerUserRole" class="text-[0.7rem] text-slate-500"></span>
        </div>
        <button
          id="logoutButton"
          class="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50"
        >
          <i class="fa-solid fa-arrow-right-from-bracket"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </header>
  <section class="bg-slate-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 grid md:grid-cols-4 gap-4">
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Total Signed Employees
        </p>
        <p id="summarySignedEmployees" class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">0</p>
        <p class="text-xs text-slate-500 mt-1">
          Employees with finalized benefit packets.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Current Plan Year
        </p>
        <p class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">2026</p>
        <p class="text-xs text-slate-500 mt-1">
          Active comparison window for plan elections.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Active Benefit Cycle
        </p>
        <p id="cycleStatusLabel" class="mt-2 text-base font-semibold text-red-600">Under Review</p>
        <p id="cycleStatusDescription" class="text-xs text-slate-500 mt-1">
          Use the analytics tab for renewal discussions and budgeting.
        </p>
      </div>
      <div class="card px-4 py-3 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Cycle Status Control
          </p>
          <p class="text-xs text-slate-500 mt-1">
            Admins (Pablo, Garrett, Janelle) can update the cycle status.
          </p>
        </div>
        <div class="mt-3">
          <select
            id="cycleStatusSelect"
            class="w-full rounded-md border border-slate-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          >
            <option value="under_review">Under Review</option>
            <option value="received">Received</option>
            <option value="verified">Verified</option>
            <option value="finalized">Finalized</option>
          </select>
        </div>
      </div>
    </div>
  <section class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-6 text-sm">
        <button id="tabDocs" class="py-3 tab-btn-active">
          Signed Documents
        </button>
        <button id="tabAnalytics" class="py-3 tab-btn-inactive">
          Benefit Summary
        </button>
        <button id="tabComparison" class="py-3 tab-btn-inactive">
          Employee Comparison
        </button>
        <button id="tabEmployeeList" class="py-3 tab-btn-inactive">
          2026 Employee Elections
        </button>
        <button id="tabAudit" class="py-3 tab-btn-inactive">
          Audit Logs
        </button>
        <button id="tabUsers" class="py-3 tab-btn-inactive">
          Authorized Users
        </button>
        <button id="tabPermissions" class="py-3 tab-btn-inactive">
          Permissions
        </button>
      </nav>
    </div>
  </section>
  <main class="max-w-full mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">
    <section id="tabDocsContent" class="space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Signed Documents</h2>
          <p class="text-xs text-slate-500 mt-1">
            Alphabetical index of employees with completed, signed benefit packets.
          </p>
        </div>
        <div class="flex gap-2">
          <button
            id="printAllButton"
            class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
          >
            <i class="fa-solid fa-print"></i>
            <span>Print All</span>
          </button>
          <button
            id="mergeAllButton"
            class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
          >
            <i class="fa-solid fa-file-pdf"></i>
            <span>Merge &amp; Download All</span>
          </button>
        </div>
      </header>
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search employee by last name
          </label>
          <input
            id="docSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Total signed employees: <span id="docSignedCount">0</span>
        </p>
      </div>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5 w-10">#</th>
              <th class="text-left px-4 py-2.5">Employee</th>
              <th class="text-left px-4 py-2.5">Initials</th>
              <th class="text-left px-4 py-2.5">Actions</th>
            </tr>
          </thead>
          <tbody id="docBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading signed documents...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <section id="tabAnalyticsContent" class="hidden space-y-8">
      <header class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="space-y-1.5">
          <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
            Benefit summary workspace
          </p>
          <h2 class="text-lg md:text-xl font-semibold text-slate-900">
            Employee Benefit Analytics
          </h2>
        </div>
        <div class="flex flex-wrap items-center gap-2 justify-start md:justify-end">
          <span class="pill-badge inline-flex items-center bg-red-50 text-red-700 border border-red-100 px-3 py-1">
            <span class="w-1.5 h-1.5 rounded-full bg-[color:var(--jc-red)] mr-1.5"></span>
            Cycle: under review
          </span>
          <span
            id="planYearBadge"
            class="pill-badge inline-flex items-center bg-slate-100 text-slate-700 border border-slate-200 px-3 py-1"
          >
            Plan years: 2025 · 2026
          </span>
          <label class="flex items-center gap-2 text-[0.7rem] text-slate-600 cursor-pointer">
            <input
              type="checkbox"
              id="toggle2027"
              class="rounded border-slate-300 text-[color:var(--jc-red)]"
            />
            <span>Show 2027 analytics (when data exists)</span>
          </label>
          <button
            type="button"
            class="inline-flex items-center gap-1.5 rounded-full border border-slate-200 bg-white px-3 py-1.5 text-[0.7rem] font-medium text-slate-700 shadow-sm hover:bg-slate-50"
          >
            <i class="fa-solid fa-download text-[0.65rem]"></i>
            <span>Export snapshot</span>
          </button>
        </div>
      </header>
      <section class="space-y-3">
        <div class="grid lg:grid-cols-3 gap-4">
          <article id="planCard2025" class="card h-full px-4 py-4 md:px-5 md:py-5"></article>
          <article id="planCard2026" class="card h-full px-4 py-4 md:px-5 md:py-5">
            <div class="flex items-start justify-between gap-3 mb-4">
              <div>
                <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
                <h3 class="mt-1 text-sm font-semibold text-slate-900">2026 Elections</h3>
                <p class="mt-1 text-[0.72rem] text-slate-500">Current year mix by plan.</p>
              </div>
              <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span> Active year
              </span>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartMedical2026" height="180"></canvas></div>
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartDental2026" height="180"></canvas></div>
              <div class="bg-slate-50 rounded-lg p-3"><canvas id="chartVision2026" height="180"></canvas></div>
            </div>
            <div id="coverageSections2026"></div>
          </article>
          <article id="planCardFuture" class="card h-full px-4 py-4 md:px-5 md:py-5 hidden"></article>
        </div>
      </section>
      <section class="space-y-4">
        <h3 class="text-lg font-semibold text-slate-900">Total Employee Cost Breakdown (2026)</h3>
        <div class="card overflow-x-auto">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
              <tr>
                <th class="text-left px-4 py-2.5">Coverage</th>
                <th class="text-left px-4 py-2.5">Plan</th>
                <th class="text-right px-4 py-2.5">Count</th>
                <th class="text-right px-4 py-2.5">Total Annual Cost</th>
              </tr>
            </thead>
            <tbody id="costBreakdownBody" class="divide-y divide-slate-100"></tbody>
          </table>
        </div>
      </section>
    </section>
    <section id="tabComparisonContent" class="hidden space-y-6">
      <header class="border-b border-slate-200 pb-4">
        <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
          Per-employee analysis
        </p>
        <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">
          Employee Year-over-Year Comparison
        </h2>
        <p class="text-sm text-slate-600 max-w-3xl">
          Search by last name, then select an employee to compare their prior-year and current-year
          elections, including per-pay and annual cost impact. Use this workspace when reviewing upgrades,
          downgrades, or flat renewals with leadership.
        </p>
      </header>
      <div class="grid xl:grid-cols-[minmax(0,380px),minmax(0,1fr)] gap-6 items-start">
        <aside class="card px-5 py-5 sticky top-4">
          <div class="space-y-4">
            <div>
              <p class="text-xs font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider mb-2">
                Employee Navigator
              </p>
              <p class="text-xs text-slate-500 mb-3">
                Select an employee to view their benefit comparison
              </p>
            </div>
     
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-2">
                Search by last name
              </label>
              <input
                id="comparisonSearch"
                type="text"
                class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2
                       placeholder:text-slate-400 focus:outline-none focus:ring-2
                       focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
                placeholder="Type to filter employees..."
              />
            </div>
          </div>
   
          <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 overflow-hidden max-h-[500px]">
            <ul
              id="comparisonEmployeeList"
              class="overflow-y-auto text-sm divide-y divide-slate-200"
            >
              <li class="px-4 py-3 text-xs text-slate-500 text-center">
                Loading employees...
              </li>
            </ul>
          </div>
   
          <p class="mt-4 text-[0.65rem] text-slate-500 leading-relaxed">
            <i class="fa-solid fa-info-circle text-slate-400 mr-1"></i>
            Only employees with signed packets appear in this list to ensure analytics align with finalized enrollments.
          </p>
        </aside>
        <section
          id="employeeComparisonDisplay"
          class="card px-6 py-6 min-h-[500px]"
        >
          <div class="flex items-center justify-center h-full text-center">
            <div class="max-w-md space-y-3">
              <i class="fa-solid fa-user-chart text-4xl text-slate-300"></i>
              <p class="text-sm text-slate-600">
                Select an employee from the list to generate a detailed year-over-year comparison,
                including bi-weekly costs, annual totals, and change analysis.
              </p>
            </div>
          </div>
        </section>
      </div>
    </section>
   <section id="tabEmployeeListContent" class="hidden space-y-6">
      <!-- Header -->
      <header class="border-b border-slate-200 pb-6">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
          <div>
            <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
              Corporate benefits registry
            </p>
         <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">
              2026 Employee Elections
            </h2>
            <p class="text-sm text-slate-600 max-w-2xl">
              Complete enrollment registry for plan year 2026. Use filters and search to locate specific
              employees or analyze plan distribution across the organization.
            </p>
          </div>
          <div class="flex items-center gap-3">
            <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-4 py-2">
              <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span>
              Active Plan Year
            </span>
            <button
              id="exportToExcel"
              class="inline-flex items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white px-4 py-2.5 text-sm font-medium hover:bg-[color:var(--jc-red-soft)] shadow-sm transition-all"
            >
              <i class="fa-solid fa-download"></i>
              Export to Excel
            </button>
          </div>
        </div>
      </header>
      <!-- Summary Statistics -->
    <!-- 2026 Employee Elections — KPI Cards (FINAL FIXED) -->
<div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
  <!-- Total Enrolled -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Total Enrolled</p>
        <p id="gridTotalEnrolled" class="text-3xl font-bold text-[color:var(--jc-navy)]">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
        <i class="fa-solid fa-users text-slate-600"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Employees with 2026 elections</p>
  </div>
  <!-- Medical -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Medical Coverage</p>
        <p id="gridMedicalCoverage" class="text-3xl font-bold text-[color:var(--jc-red)]">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
        <i class="fa-solid fa-heart-pulse text-[color:var(--jc-red)]"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active medical plan elections</p>
  </div>
  <!-- Dental -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Dental Coverage</p>
        <p id="gridDentalCoverage" class="text-3xl font-bold text-blue-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
        <i class="fa-solid fa-tooth text-blue-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active dental plan elections</p>
  </div>
  <!-- Vision -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Vision Coverage</p>
        <p id="gridVisionCoverage" class="text-3xl font-bold text-slate-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
        <i class="fa-solid fa-eye text-slate-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Active vision plan elections</p>
  </div>
  <!-- Life & AD&D -->
  <div class="card px-5 py-4">
    <div class="flex items-start justify-between">
      <div>
        <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Life &amp; AD&amp;D</p>
        <p id="gridLifeCoverage" class="text-3xl font-bold text-emerald-700">0</p>
      </div>
      <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center">
        <i class="fa-solid fa-shield-heart text-emerald-700"></i>
      </div>
    </div>
    <p class="text-xs text-slate-500 mt-2">Employees with beneficiary designation</p>
  </div>
</div>
             <!-- Filters and Search UI (Section 3.3) -->
      <div class="mb-4 card p-4">
        <p class="text-sm font-semibold text-slate-700 mb-3">Filter & Search 2026 Employees</p>
        <div class="flex flex-wrap gap-3 items-end text-xs">
          <div class="flex flex-col">
            <label for="employeeSearch" class="mb-1 font-semibold text-slate-600">
              Search Employee
            </label>
            <input id="employeeSearch"
                   type="text"
                   placeholder="Name, SSN, or Username"
                   class="border border-slate-300 rounded-md px-2 py-1.5 text-xs focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-navy-soft)]" />
          </div>
          <div class="flex flex-col">
            <label for="filterTier" class="mb-1 font-semibold text-slate-600">Tier</label>
            <select id="filterTier" class="border border-slate-300 rounded-md px-2 py-1.5 text-xs">
              <option value="">All Tiers</option>
              <option value="EO">Employee Only (EO)</option>
              <option value="ES">E + Spouse (ES)</option>
              <option value="EC">E + Child(ren) (EC)</option>
              <option value="EF">E + Family (EF)</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="filterMed" class="mb-1 font-semibold text-slate-600">Medical Plan</label>
            <select id="filterMed" class="border border-slate-300 rounded-md px-2 py-1.5 text-xs">
              <option value="">All Plans</option>
              <option value="WAIVE">Waived</option>
              <option value="ATBCB402">PPO / ATBCB402</option>
              <option value="ATBAB303">HMO / ATBAB303</option>
              <option value="ATBAP393">HMO HSA / ATBAP393</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="filterDental" class="mb-1 font-semibold text-slate-600">Dental Plan</label>
            <select id="filterDental" class="border border-slate-300 rounded-md px-2 py-1.5 text-xs">
              <option value="">All Plans</option>
              <option value="WAIVE">Waived</option>
              <option value="F_PLAN_2W">F-PLAN 2W / Base MAC</option>
              <option value="F_PLAN_3W">F-PLAN 3W / Buy Up MAC</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="filterLife" class="mb-1 font-semibold text-slate-600">Life</label>
            <select id="filterLife" class="border border-slate-300 rounded-md px-2 py-1.5 text-xs">
              <option value="">All</option>
              <option value="yes">Has Designation</option>
              <option value="no">Waived/No Designation</option>
            </select>
          </div>
          <div class="flex flex-col">
            <label for="filterCity" class="mb-1 font-semibold text-slate-600">City</label>
            <input id="filterCity"
                   type="text"
                   placeholder="Filter by City"
                   class="border border-slate-300 rounded-md px-2 py-1.5 text-xs" />
          </div>
          <button id="clearFilters"
                  class="ml-auto px-3 py-1.5 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-300 text-[11px] font-semibold">
            Clear Filters
          </button>
        </div>
      </div>
      <!-- Employee List Table (Section 3.1) -->
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 text-xs font-semibold text-slate-600 uppercase tracking-wide border-b border-slate-200">
  <tr>
    <th class="px-4 py-2 text-left">Employee Name</th>
    <th class="px-4 py-2 text-left">Job Title</th>
    <th class="px-4 py-2 text-left">Status</th>
    <th class="px-4 py-2 text-left">Annual Salary</th>
    <th class="px-4 py-2 text-left">Hire Date</th>
    <th class="px-4 py-2 text-left">Phone</th>
    <th class="px-4 py-2 text-left">Address</th>
    <th class="px-4 py-2 text-left">City</th>
    <th class="px-4 py-2 text-left">ZIP Code</th>
    <th class="px-4 py-2 text-left">Tier</th>
    <th class="px-4 py-2 text-left">Medical Plan</th>
    <th class="px-4 py-2 text-left">Dental Plan</th>
    <th class="px-4 py-2 text-left">Vision Plan</th>
    <th class="px-4 py-2 text-left">Life</th>
    <th class="px-4 py-2 text-left">Actions</th>
  </tr>
</thead>
          <tbody id="employeeListTableBody" class="divide-y divide-slate-100">
  <tr>
    <td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">
      Loading employee census...
    </td>
  </tr>
</tbody>
        </table>
      </div>
      <footer class="mt-6 border-t border-slate-200 pt-3 text-[11px] text-slate-500">
        <p class="font-semibold uppercase tracking-wide text-slate-600">
          Benefits Census Disclaimer
        </p>
        <p class="mt-1">
          CONFIDENTIAL: This benefits census is for internal use by Jeng Chi Restaurant and authorized broker/benefit partners only.
        </p>
        <p class="mt-1">
          This report does not guarantee coverage or eligibility. Final determinations of eligibility, premium, and benefits are made by the insurance carrier(s).
        </p>
      </footer>
    </section>
    <section id="tabAuditContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Audit Logs</h2>
          <p class="text-xs text-slate-500 mt-1">Track portal access and actions (admin only).</p>
        </div>
      </header>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5">Portal User</th>
              <th class="text-left px-4 py-2.5">Login Time</th>
              <th class="text-left px-4 py-2.5">Logout Time</th>
              <th class="text-left px-4 py-2.5">Duration (min)</th>
              <th class="text-left px-4 py-2.5">Tab History</th>
            </tr>
          </thead>
          <tbody id="auditBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading audit logs...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
       <section id="tabUsersContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">
            Authorized Users &amp; Portal Credentials
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Manage who can access this Executive Benefits Portal. Changes write directly to the
            <span class="font-mono">portal_users</span> table.
          </p>
        </div>
        <button
          id="addUserButton"
          class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
        >
          <i class="fa-solid fa-user-plus"></i>
          <span>Add User</span>
        </button>
      </header>
      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search by last name
          </label>
          <input
            id="userSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Role legend: <span class="font-semibold">Administrator</span> can view analytics and manage users;
          <span class="font-semibold">Standard User</span> can only view Signed Documents.
        </p>
      </div>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5">Full name</th>
              <th class="text-left px-4 py-2.5">Initials</th>
              <th class="text-left px-4 py-2.5">Role</th>
              <th class="text-left px-4 py-2.5">Last login</th>
              <th class="text-left px-4 py-2.5">Status</th>
              <th class="text-left px-4 py-2.5">Actions</th>
            </tr>
          </thead>
          <tbody id="userBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
    <!-- Tier / Medical / Dental / Vision row -->
<div class="grid grid-cols-1 md:grid-cols-2 gap-4">
  <div>
    <label class="block text-xs font-medium text-slate-700 mb-1">Tier election</label>
    <select id="modalTier" class="jc-select">
      <!-- EO / ES / EC / EF options -->
    </select>
  </div>
  <div>
    <label class="block text-xs font-medium text-slate-700 mb-1">Medical plan</label>
    <select id="modalMedicalPlan" class="jc-select">
      <!-- options -->
    </select>
    <div id="modalMedicalCost" class="mt-1 text-[11px] text-slate-600 italic"></div>
  </div>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4">
  <div>
    <label class="block text-xs font-medium text-slate-700 mb-1">Dental plan</label>
    <select id="modalDentalPlan" class="jc-select"></select>
    <div id="modalDentalCost" class="mt-1 text-[11px] text-slate-600 italic"></div>
  </div>
  <div>
    <label class="block text-xs font-medium text-slate-700 mb-1">Vision plan</label>
    <select id="modalVisionPlan" class="jc-select"></select>
    <div id="modalVisionCost" class="mt-1 text-[11px] text-slate-600 italic"></div>
  </div>
</div>
<!-- Life option row -->
<div class="mt-4">
  <label class="block text-xs font-medium text-slate-700 mb-1">Life option</label>
  <select id="modalLifeOption" class="jc-select">
    <option value="">-- Select --</option>
    <option value="WAIVED">Waived</option>
    <option value="EMPLOYER_PAID">Employer Paid Life</option>
  </select>
  <div id="modalLifeCost" class="mt-1 text-[11px] text-slate-600 italic"></div>
</div>
    <!-- ✅ Permissions is now its OWN sibling section, not nested inside Users -->
    <section id="tabPermissionsContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">
            Portal Permissions
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Manage tab access for portal users. Changes save automatically.
          </p>
        </div>
      </header>
      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
            <tr>
              <th class="text-left px-4 py-2.5">Full name</th>
              <th class="text-left px-4 py-2.5">Initials</th>
              <th class="text-center px-4 py-2.5">Signed Docs</th>
              <th class="text-center px-4 py-2.5">Benefit Summary</th>
              <th class="text-center px-4 py-2.5">Employee Comparison</th>
              <th class="text-center px-4 py-2.5">2026 Elections</th>
              <th class="text-center px-4 py-2.5">Audit Logs</th>
              <th class="text-center px-4 py-2.5">Authorized Users</th>
              <th class="text-center px-4 py-2.5">Reports</th>
            </tr>
          </thead>
          <tbody id="permissionsBody" class="divide-y divide-slate-100">
            <tr>
              <td colspan="9" class="px-4 py-4 text-center text-xs text-slate-500">
                Loading users...
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </section>
  
</div>
<div id="modalPanelHistory" data-section-panel="history" class="hidden">
  <h3 class="text-sm font-semibold text-slate-800 mb-3">Change History</h3>
  <div id="modalChangeHistory" class="space-y-2"></div>
</div>
<!-- START: Employee Details Modal (Unified) -->
<div
  id="employeeModal"
  class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50 px-4"
>
  <div class="card w-full max-w-4xl p-6 space-y-6">
    <header class="flex items-center justify-between border-b border-slate-200 pb-3">
      <h3 id="employeeModalTitle" class="text-xl font-bold text-[color:var(--jc-navy)]">Employee Details & Editing</h3>
      <button id="modalClose" class="text-slate-400 hover:text-slate-700"><i class="fa-solid fa-xmark text-lg"></i></button>
    </header>
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
      <aside class="md:col-span-1 space-y-3">
        <button data-tab="details" class="w-full text-left p-3 rounded-lg bg-slate-100 font-semibold text-sm hover:bg-slate-100 transition-colors">Personal & Employment</button>
        <button data-tab="elections" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">Benefit Elections</button>
        <button data-tab="family" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">Family & Dependents</button>
        <button data-tab="history" class="w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">Change History</button>
        <div id="modalStatus" class="mt-4 text-xs text-slate-500"></div>
      </aside>
      <section id="modalContent" class="md:col-span-3 space-y-6">
        <!-- Content will be injected here -->
      </section>
    </div>
    <footer class="flex justify-end gap-3 border-t border-slate-200 pt-3">
      <button id="modalSaveEmployee" class="inline-flex items-center gap-2 rounded-md bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700 transition">
        <i class="fa-solid fa-save"></i> Save Changes
      </button>
    </footer>
  </div>
</div>
<!-- END: Employee Details Modal (Unified) -->
<div
  id="userModal"
  class="fixed inset-0 bg-black/30 hidden items-center justify-center z-40 px-4"
>
  <div class="card w-full max-w-md px-6 py-5">
    <h3 id="userModalTitle" class="text-base font-semibold text-slate-900 mb-4">
      Add User
    </h3>
    <div class="space-y-3 text-sm">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Full name</label>
        <input
          id="modalFullName"
          type="text"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        />
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Initials</label>
          <input
            id="modalInitials"
            type="text"
            maxlength="3"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">PIN (4 digits)</label>
          <input
            id="modalPin"
            type="password"
            maxlength="4"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Role</label>
        <select
          id="modalRole"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        >
          <option value="user">Standard User</option>
          <option value="admin">Administrator</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <input id="modalActive" type="checkbox" class="rounded border-slate-300 text-[color:var(--jc-red)]" checked />
        <label for="modalActive" class="text-xs text-slate-700">Portal active</label>
      </div>
    </div>
    <div class="mt-5 flex justify-end gap-3">
      <button
        id="modalCancel"
        class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
      >
        Cancel
      </button>
      <button
        id="modalSave"
        class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
      >
        Save
      </button>
    </div>
  </div>
</div>
<script>
let portalUsersCache = [];
document.addEventListener('DOMContentLoaded', () => {
  // All your JS code here
  // ======================== ERROR HANDLERS (MUST BE FIRST) ========================
  window.addEventListener('error', function(e) {
    console.error('Global error caught:', {
      message: e.message,
      filename: e.filename,
      lineno: e.lineno,
      colno: e.colno,
      error: e.error
    });
  });
  window.addEventListener('unhandledrejection', function(e) {
    console.error('Unhandled promise rejection:', e.reason);
  });
  // ------------------------ SUPABASE CONFIG ------------------------
  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
  const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
  let supabase = null;
  try {
    if (window.supabase) {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
    } else {
      console.error("Supabase script not loaded");
    }
  } catch (err) {
    console.error("Supabase initialization failed:", err);
  }
  // Verify Supabase connection
  (async function verifySupa() {
    if (!supabase) return;
    try {
     const { data, error } = await supabase
  .from("portal_users")
  .select("id")
  .limit(1);
      if (error) {
        console.error("Supabase connection failed:", error);
        alert("Database connection error. Please check your configuration.");
      } else {
        console.log("✓ Supabase connected successfully");
      }
    } catch (err) {
      console.error("Supabase initialization error:", err);
    }
  })();
 // ------------------------ GLOBAL STATE ------------------------
  let currentUser = null;
  let currentLogId = null;
  let docsCache = [];
  let portalUsersCache = [];
  let analyticsEmployees = [];
  let benefitRates = [];
  let planYearStats = null;
  let analyticsHas2027 = false;
  let analyticsRendered = false;
  let comparisonEmployees = [];
  let comparisonRendered = false;
  let fullEnrollments = [];
  let currentTabHistory = []; // <-- ADD THIS
  let RATES = {};
  let comprehensiveData = []; // New array to hold combined report data
  let currentEditingEnrollment = null; // Stores data for the modal
  let allEmployees = []; // New state variable for Employee List Grid
  let modalOriginalEnrollment = null; // snapshot before edits
  const YEARS = [2025, 2026, 2027];
  // CORPORATE DISCLAIMER TEXT
  const BENEFITS_DISCLAIMER_1 = 'CONFIDENTIAL: This benefits census is for internal use by Jeng Chi Restaurant and authorized broker/benefit partners only.';
  const BENEFITS_DISCLAIMER_2 = 'Disclaimer: This report does not guarantee coverage or eligibility. Final determinations of eligibility, premium, and benefits are made by the insurance carrier(s).';
  // ------------------------ TOASTS ------------------------
  function showToast({ title, message, type }) {
    const toast = document.getElementById("toast");
    const inner = document.getElementById("toastInner");
    const titleEl = document.getElementById("toastTitle");
    const msgEl = document.getElementById("toastMessage");
    const iconEl = document.getElementById("toastIcon");
    titleEl.textContent = title || "";
    msgEl.textContent = message || "";
    iconEl.innerHTML = "";
    inner.classList.remove("border-emerald-200", "border-red-200", "border-slate-200");
    if (type === "success") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-emerald-600"></i>';
      inner.classList.add("border", "border-emerald-200");
    } else if (type === "error") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';
      inner.classList.add("border", "border-red-200");
    } else {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-info text-slate-500"></i>';
      inner.classList.add("border", "border-slate-200");
    }
    toast.classList.remove("hidden");
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => {
      hideToast();
    }, 3500);
  }
  function hideToast() {
    document.getElementById("toast").classList.add("hidden");
  }
  // ← ADD THIS FUNCTION RIGHT HERE ↓
async function logTabAccess(tabName) {
  if (!currentLogId || !currentUser || !supabase) return;
  try {
    const ts = new Date().toLocaleString("en-US", {
      timeZone: "America/Chicago",
      month: "2-digit",
      day: "2-digit",
      year: "numeric",
      hour: "2-digit",
      minute: "2-digit",
      hour12: true,
    });
    if (!Array.isArray(currentTabHistory)) {
      currentTabHistory = [];
    }
    // Example entry: "Benefit Summary · 11/26/2025, 03:42 PM"
    currentTabHistory.push(`${tabName} · ${ts}`);
    await supabase
      .from("portal_logs")
      .update({
        tab_accessed: tabName,
        tab_history: currentTabHistory,
      })
      .eq("id", currentLogId);
  } catch (err) {
    console.warn("Failed to log tab access:", err);
  }
}
  // ------------------------ HELPERS ------------------------
function getRate(planType, planCode, tier, planYear = 2026) {
  if (!Array.isArray(benefitRates)) return null;
  return benefitRates.find(r =>
    (r.plan_year === planYear || r.plan_year === String(planYear)) &&
    r.plan_type === planType &&
    r.plan_code === planCode &&
    r.tier === tier
  ) || null;
}
function formatMoney(n) {
  if (n == null || isNaN(n)) return "$0.00";
  return `$${Number(n).toFixed(2)}`;
}
// Robust way to parse an ID for .eq("id", value)
function toIntOrNull(value) {
  if (value == null || value === "undefined") return null;
  const n = Number(value);
  if (!Number.isFinite(n)) return null;
  return n;
}
// Try to find benefit_rates row for this combo
function getBenefitRatesArray() {
  const w = window;
  if (Array.isArray(w.benefitRates2026)) return w.benefitRates2026;
  if (Array.isArray(w.benefitRates)) return w.benefitRates;
  if (Array.isArray(w.BENEFIT_PLAN_RATES_2026)) return w.BENEFIT_PLAN_RATES_2026;
  return [];
}
function getBenefitRate(planType, planCode, tier, planYear = 2026) {
  const all = getBenefitRatesArray();
  if (!all.length || !planCode || !tier) return null;
  const normalizedType = (planType || "").toUpperCase().startsWith("MED")
    ? "MEDICAL"
    : (planType || "").toUpperCase().startsWith("DEN")
    ? "DENTAL"
    : (planType || "").toUpperCase().startsWith("VIS")
    ? "VISION"
    : (planType || "").toUpperCase();
  const codeTrim = String(planCode).trim();
  const tierUpper = String(tier).toUpperCase();
  return (
    all.find((r) => {
      const yearMatches =
        !r.plan_year || String(r.plan_year) === String(planYear);
      const typeVal = (r.plan_type || r.coverage_type || "").toUpperCase();
      const codeVal = (r.plan_code || r.plan_name || "").trim();
      const tierVal = (
        r.tier ||
        r.coverage_tier ||
        r.coverage_level ||
        ""
      ).toUpperCase();
      return (
        yearMatches &&
        typeVal === normalizedType &&
        codeVal === codeTrim &&
        tierVal === tierUpper
      );
    }) || null
  );
}

function getPlanCostCaption(planType, planCode, tier, planLabel) {
  if (!planCode || String(planCode).toUpperCase().includes("WAIV")) {
    return `${planLabel}: Waived (no employee cost)`;
  }
  
  const rate = getBenefitRate(planType, planCode, tier, 2026);
  if (!rate) return `${planLabel}: rate not configured for this plan / tier.`;
  
  const empCost =
    rate.employee_pp ||
    rate.employee_cost_pp ||
    rate.employee_cost ||
    rate.employee ||
    0;
    
  const erCost =
    rate.employer_pp ||
    rate.employer_cost_pp ||
    rate.employer_cost ||
    rate.employer ||
    0;
    
  const total =
    rate.total_pp ||
    rate.total_cost_pp ||
    (Number(empCost || 0) + Number(erCost || 0));
    
  return `${planLabel} per pay period — Employee ${formatMoney(
    empCost
  )} · Employer ${formatMoney(erCost)} · Total ${formatMoney(total)}`;
}





// Compare old vs new enrollment values for Change History
function buildEnrollmentChangeList(oldData, newData) {
  const changes = [];
  function add(field, label) {
    const before = oldData ? oldData[field] : undefined;
    const after = newData ? newData[field] : undefined;
    if (JSON.stringify(before) === JSON.stringify(after)) return;
    changes.push({
      field,
      label,
      from: before,
      to: after,
    });
  }
  add("tier_election", "Tier election");
  add("medical_plan", "Medical plan");
  add("dental_plan", "Dental plan");
  add("vision_plan", "Vision plan");
  add("life_option", "Life option");
  add("dependents", "Family & Dependents");
  add("beneficiaries", "Beneficiaries");
  return changes;
}
  const tbody = document.getElementById("empDependentsBody");
  if (!tbody) return;
  const list = Array.isArray(deps) ? deps : [];
  if (!list.length) {
    tbody.innerHTML = `
      <tr class="text-xs text-slate-500">
        <td colspan="4" class="px-3 py-2 italic">No dependents on file.</td>
      </tr>`;
    return;
  }
  tbody.innerHTML = list
    .map(
      (d) => `
      <tr class="dependent-row border-b border-slate-100">
        <td class="px-2 py-1">
          <input
            type="text"
            class="dep-first w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(d.first_name || "")}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="date"
            class="dep-dob w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${(d.dob || "").substring(0, 10)}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="text"
            maxlength="4"
            class="dep-ssn w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(d.ssn_last4 || d.ssn || "")}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="text"
            class="dep-rel w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(d.relationship || "")}"
          />
        </td>
      </tr>`
    )
    .join("");
}
function renderModalBeneficiariesTable(benes) {
  const tbody = document.getElementById("empBeneficiariesBody");
  if (!tbody) return;
  const list = Array.isArray(benes) ? benes : [];
  if (!list.length) {
    tbody.innerHTML = `
      <tr class="text-xs text-slate-500">
        <td colspan="4" class="px-3 py-2 italic">No beneficiaries on file.</td>
      </tr>`;
    return;
  }
  tbody.innerHTML = list
    .map(
      (b) => `
      <tr class="bene-row border-b border-slate-100">
        <td class="px-2 py-1">
          <input
            type="text"
            class="bene-first w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(b.first_name || "")}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="date"
            class="bene-dob w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${(b.dob || "").substring(0, 10)}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="text"
            maxlength="4"
            class="bene-ssn w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(b.ssn_last4 || b.ssn || "")}"
          />
        </td>
        <td class="px-2 py-1">
          <input
            type="text"
            class="bene-rel w-full text-xs border border-slate-200 rounded px-1 py-0.5"
            value="${escapeHtml(b.relationship || "")}"
          />
        </td>
      </tr>`
    )
    .join("");
}
function collectDependentsFromModal() {
  const tbody = document.getElementById("empDependentsBody");
  if (!tbody) return [];
  const rows = tbody.querySelectorAll("tr.dependent-row");
  const out = [];
  rows.forEach((tr) => {
    const first =
      tr.querySelector(".dep-first")?.value.trim() || "";
    const dob = tr.querySelector(".dep-dob")?.value || "";
    const ssn =
      tr.querySelector(".dep-ssn")?.value.trim() || "";
    const rel =
      tr.querySelector(".dep-rel")?.value.trim() || "";
    if (first || dob || ssn || rel) {
      out.push({
        first_name: first,
        dob,
        ssn_last4: ssn,
        relationship: rel,
      });
    }
  });
  return out;
}
function collectBeneficiariesFromModal() {
  const tbody = document.getElementById("empBeneficiariesBody");
  if (!tbody) return [];
  const rows = tbody.querySelectorAll("tr.bene-row");
  const out = [];
  rows.forEach((tr) => {
    const first =
      tr.querySelector(".bene-first")?.value.trim() || "";
    const dob = tr.querySelector(".bene-dob")?.value || "";
    const ssn =
      tr.querySelector(".bene-ssn")?.value.trim() || "";
    const rel =
      tr.querySelector(".bene-rel")?.value.trim() || "";
    if (first || dob || ssn || rel) {
      out.push({
        first_name: first,
        dob,
        ssn_last4: ssn,
        relationship: rel,
      });
    }
  });
  return out;
}
// ====== CHANGE HISTORY RENDERER ======
function renderModalChangeHistory() {
  const container = document.getElementById("empChangeHistoryContainer");
  if (!container) return;
  const enr =
    (currentEditingEnrollment && currentEditingEnrollment.rawEnrollmentData) ||
    modalOriginalEnrollment ||
    {};
  const history = Array.isArray(enr.change_history)
    ? enr.change_history
    : [];
  if (!history.length) {
    container.innerHTML =
      '<p class="text-xs text-slate-500 italic">No changes recorded yet.</p>';
    return;
  }
  const html = history
    .slice()
    .reverse()
    .map((entry) => {
      const who = entry.by_user || "Unknown user";
      const when = entry.display || entry.at;
      const list = (entry.changes || [])
        .map((ch) => {
          const before =
            typeof ch.from === "object"
              ? JSON.stringify(ch.from)
              : ch.from ?? "";
          const after =
            typeof ch.to === "object"
              ? JSON.stringify(ch.to)
              : ch.to ?? "";
          return `<li class="leading-snug">
            <span class="font-medium">${escapeHtml(
              ch.label
            )}:</span>
            <span class="ml-1">"${escapeHtml(
              before
            )}" → "${escapeHtml(after)}"</span>
          </li>`;
        })
        .join("");
      return `
        <div class="border border-slate-200 rounded-lg p-3 bg-slate-50">
          <div class="text-[11px] text-slate-600 mb-1">
            <span class="font-semibold">${escapeHtml(
              who
            )}</span>
            <span class="mx-1">•</span>
            <span>${escapeHtml(when)}</span>
          </div>
          <ul class="text-[11px] text-slate-700 space-y-0.5">
            ${list}
          </ul>
        </div>
      `;
    })
    .join("");
  container.innerHTML = html;
}
function updateModalPlanCosts() {
  if (!currentEditingEnrollment) return;
  const rec = currentEditingEnrollment;
  const enr = rec.rawEnrollmentData || {};
  const tier =
    document.getElementById("empTierSelect")?.value ||
    enr.tier_election ||
    rec.tier_election ||
    "EO";
  // Medical
  const medSel = document.getElementById("empMedPlanSelect");
  const medLbl = document.getElementById("empMedPlanCostLabel");
  if (medSel && medLbl) {
    const code = medSel.value || "";
    medLbl.textContent = getPlanCostCaption(
      "Medical",
      "MEDICAL",
      code,
      tier
    );
  }
  // Dental
  const denSel = document.getElementById("empDentalPlanSelect");
  const denLbl = document.getElementById("empDentalPlanCostLabel");
  if (denSel && denLbl) {
    const code = denSel.value || "";
    denLbl.textContent = getPlanCostCaption(
      "Dental",
      "DENTAL",
      code,
      tier
    );
  }
  // Vision
  const visSel = document.getElementById("empVisionPlanSelect");
  const visLbl = document.getElementById("empVisionPlanCostLabel");
  if (visSel && visLbl) {
    const code = visSel.value || "";
    visLbl.textContent = getPlanCostCaption(
      "Vision",
      "VISION",
      code,
      tier
    );
  }
  // Life option (employer-paid vs waived)
  const lifeSel = document.getElementById("empLifeSelect");
  const lifeLbl = document.getElementById("empLifeCostLabel");
  if (lifeSel && lifeLbl) {
    const val = (lifeSel.value || "").toUpperCase();
    if (!val || val.startsWith("WAIV")) {
      lifeLbl.textContent = "Life: waived.";
    } else if (val === "EMPLOYER_PAID") {
      lifeLbl.textContent =
        "Employer-paid basic life benefit (no employee contribution).";
    } else {
      lifeLbl.textContent = "";
    }
  }
}
  function esc(str) {
    return String(str ?? "").replace(/[&<>"']/g, (s) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    })[s]);
  }
  const formatCurrency = (value) =>
    new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
    }).format(value || 0);
  const formatDate = (value) =>
    value ? new Date(value).toLocaleString("en-US", { dateStyle: "short", timeStyle: "short" }) : "—";
  function formatPhone(raw) {
    if (!raw) return "—";
    const d = raw.replace(/\D/g, "");
    return d.length !== 10 ? raw : `(${d.slice(0, 3)}) ${d.slice(3, 6)}-${d.slice(6)}`;
  }
  function formatSSN(raw) {
    if (!raw || raw.length < 9) return 'N/A';
    return `${raw.slice(0,3)}-${raw.slice(3,5)}-${raw.slice(5)}`;
  }
  async function safeSupabaseQuery(queryPromise, errorContext) {
    try {
      const { data, error } = await queryPromise;
      if (error) {
        console.error(`${errorContext}:`, error);
        throw error;
      }
      return data;
    } catch (err) {
      console.error(`${errorContext} - Unexpected error:`, err);
      showToast({
        title: "Database Error",
        message: `${errorContext}: ${err.message}`,
        type: "error",
      });
      throw err;
    }
  }
  // ------------------------ LOGIN VIEW ------------------------
  const loginView = document.getElementById("loginView");
  const dashboardView = document.getElementById("dashboardView");
  const loginBtn = document.getElementById("loginButton");
  const loginInitials = document.getElementById("loginInitials");
  const loginPin = document.getElementById("loginPin");
  const togglePinBtn = document.getElementById("togglePin");
  togglePinBtn.addEventListener("click", () => {
    const type = loginPin.type === "password" ? "text" : "password";
    loginPin.type = type;
    togglePinBtn.innerHTML =
      type === "password"
        ? '<i class="fa-regular fa-eye text-xs"></i>'
        : '<i class="fa-regular fa-eye-slash text-xs"></i>';
  });
  loginInitials.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginPin.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginBtn.addEventListener("click", login);
  async function login() {
    if (!supabase) {
      alert("Supabase connection failed. Please reload the page.");
      return;
    }
    const initials = loginInitials.value.trim().toUpperCase();
    const pin = loginPin.value.trim();
    if (!initials || !pin) {
      showToast({
        title: "Invalid credentials",
        message: "Initials and PIN are required.",
        type: "error",
      });
      return;
    }
    if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }
    try {
      const { data: user, error } = await supabase
        .from("portal_users")
        .select("*")
        .eq("initials", initials)
        .eq("pin", pin)
        .eq("active", true)
        .maybeSingle();
      if (error) throw error;
      if (!user) {
        showToast({
          title: "Invalid credentials",
          message: "Check your initials and PIN.",
          type: "error",
        });
        return;
      }
      currentUser = user;
      // Update last login
      await supabase
        .from("portal_users")
        .update({ last_login: new Date().toISOString() })
        .eq("id", user.id);
      // Create a log row linked to portal_user_id
      const { data: logRow, error: logError } = await supabase
        .from("portal_logs")
        .insert([
          {
            portal_user_id: user.id,
            employee_id: null,
            tab_accessed: "Dashboard",
            tab_history: [], // start empty, we'll push with timestamp below
          },
        ])
        .select("id")
        .single();
      if (logError) {
        console.error("Failed to create portal log:", logError);
        showToast({
          title: "Warning",
          message: "Logged in but audit log failed.",
          type: "error",
        });
      } else if (logRow) {
        currentLogId = logRow.id;
        const firstEntryTime = new Date().toLocaleString("en-US", {
          timeZone: "America/Chicago",
          month: "2-digit",
          day: "2-digit",
          year: "numeric",
          hour: "2-digit",
          minute: "2-digit",
          hour12: true,
        });
        // Initialize current tab history with Dashboard + timestamp
        currentTabHistory = [`Dashboard · ${firstEntryTime}`];
        // Save initial tab history into the log row
        await supabase
          .from("portal_logs")
          .update({ tab_history: currentTabHistory })
          .eq("id", currentLogId);
      }
      sessionStorage.setItem(
        "portal_user",
        JSON.stringify({ ...currentUser, log_id: currentLogId || null })
      );
      showToast({
        title: "Login successful",
        message: "Redirecting to the Executive Benefits Portal.",
        type: "success",
      });
      setTimeout(() => showDashboard(), 700);
    } catch (err) {
      console.error("Login error", err);
      showToast({
        title: "Login error",
        message: "Unexpected error. See console for details.",
        type: "error",
      });
    }
  }
  // ------------------------ DASHBOARD SETUP ------------------------
  const logoutButton = document.getElementById("logoutButton");
  logoutButton.addEventListener("click", handleLogout);
  async function handleLogout() {
    if (currentLogId) {
      try {
        const { data: logRow } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", currentLogId)
          .maybeSingle();
        let duration = null;
        if (logRow && logRow.login_time) {
          const loginTime = new Date(logRow.login_time);
          const now = new Date();
          duration = Math.round((now - loginTime) / (1000 * 60));
        }
        await supabase
          .from("portal_logs")
          .update({
            logout_time: new Date().toISOString(),
            duration_minutes: duration,
          })
          .eq("id", currentLogId);
      } catch (err) {
        console.error("Error recording logout", err);
      }
    }
    currentUser = null;
    currentLogId = null;
    sessionStorage.removeItem("portal_user");
    dashboardView.classList.add("hidden");
    loginView.classList.remove("hidden");
  }
  // ------------------------ AUTO LOGOUT ON PAGE CLOSE ------------------------
  window.addEventListener('beforeunload', function(e) {
    if (currentLogId && currentUser) {
      const confirmationMessage = 'You are still logged in. Would you like to log out before closing?';
      e.preventDefault();
      e.returnValue = confirmationMessage;
      const logoutData = {
        logout_time: new Date().toISOString(),
        duration_minutes: null
      };
      navigator.sendBeacon(
        `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}&select=login_time`,
        new Blob([JSON.stringify({})], { type: 'application/json' })
      );
      const blob = new Blob([JSON.stringify({
        logout_time: logoutData.logout_time,
        duration_minutes: logoutData.duration_minutes
      })], { type: 'application/json' });
      navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`, blob);
      fetch(`${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`, {
        method: 'PATCH',
        headers: {
          'Content-Type': 'application/json',
          'apikey': SUPABASE_KEY,
          'Authorization': `Bearer ${SUPABASE_KEY}`,
          'Prefer': 'return=minimal'
        },
        body: JSON.stringify(logoutData),
        keepalive: true
      }).catch(err => console.error("Auto-logout error:", err));
      return confirmationMessage;
    }
  });
  document.addEventListener('visibilitychange', async function() {
    if (document.visibilityState === 'hidden' && currentLogId) {
      try {
        const { data: logRow } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", currentLogId)
          .maybeSingle();
        let duration = null;
        if (logRow && logRow.login_time) {
          const loginTime = new Date(logRow.login_time);
          const now = new Date();
          duration = Math.round((now - loginTime) / (1000 * 60));
        }
        await supabase
          .from("portal_logs")
          .update({
            logout_time: new Date().toISOString(),
            duration_minutes: duration,
          })
          .eq("id", currentLogId);
        console.log("Auto-logged out due to tab close/hide");
      } catch (err) {
        console.error("Visibility change logout error:", err);
      }
    }
  });
  window.addEventListener('pagehide', function(e) {
    if (currentLogId) {
      navigator.sendBeacon(
        `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`,
        new Blob([JSON.stringify({
          logout_time: new Date().toISOString()
        })], { type: 'application/json' })
      );
    }
  });
  function showDashboard() {
    loginView.classList.add("hidden");
    dashboardView.classList.remove("hidden");
    updateHeaderUser();
    updateCycleStatusUI();
    applyRoleVisibility();
    loadSignedDocuments();
    loadPortalUsers();
  }
  function updateHeaderUser() {
    const nameEl = document.getElementById("headerUserName");
    const roleEl = document.getElementById("headerUserRole");
    if (!currentUser) {
      nameEl.textContent = "";
      roleEl.textContent = "";
      return;
    }
    nameEl.textContent = currentUser.full_name || currentUser.initials;
    const roleLabel = currentUser.role === "admin" ? "Administrator" : "Standard User";
    roleEl.textContent = `Logged in as ${roleLabel} (${currentUser.initials})`;
  }
  // ------------------------ CYCLE STATUS ------------------------
  const cycleStatusSelect = document.getElementById("cycleStatusSelect");
  const cycleStatusLabel = document.getElementById("cycleStatusLabel");
  const cycleStatusDescription = document.getElementById("cycleStatusDescription");
  function getCycleStatusMeta(value) {
    switch (value) {
      case "under_review":
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
      case "received":
        return {
          label: "Received",
          color: "text-amber-600",
          description: "All enrollment packets have been collected and are being checked.",
        };
      case "verified":
        return {
          label: "Verified",
          color: "text-emerald-600",
          description:
            "Enrollment data, premiums, and plan mappings have been validated with the broker.",
        };
      case "finalized":
        return {
          label: "Finalized",
          color: "text-slate-700",
          description:
            "The benefit cycle is complete. Elections have been transmitted and confirmed.",
        };
      default:
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
    }
  }
  function updateCycleStatusUI() {
    const stored = localStorage.getItem("jc_cycle_status") || "under_review";
    cycleStatusSelect.value = stored;
    const meta = getCycleStatusMeta(stored);
    cycleStatusLabel.textContent = meta.label;
    cycleStatusLabel.className = "mt-2 text-base font-semibold " + meta.color;
    cycleStatusDescription.textContent = meta.description;
  }
  cycleStatusSelect.addEventListener("change", () => {
    if (
      !currentUser ||
      (!["PG", "GM", "JT"].includes(currentUser.initials) && currentUser.role !== "admin")
    ) {
      showToast({
        title: "Not allowed",
        message: "Only designated admins can change the cycle status.",
        type: "error",
      });
      cycleStatusSelect.value = localStorage.getItem("jc_cycle_status") || "under_review";
      return;
    }
    const value = cycleStatusSelect.value;
    localStorage.setItem("jc_cycle_status", value);
    updateCycleStatusUI();
  });
  // ------------------------ ROLE-BASED VISIBILITY ------------------------
  function applyRoleVisibility() {
  const tabAnalytics = document.getElementById("tabAnalytics");
  const tabComparison = document.getElementById("tabComparison");
  const tabEmployeeList = document.getElementById("tabEmployeeList");
  const tabAudit = document.getElementById("tabAudit");
  const tabUsers = document.getElementById("tabUsers");
  const tabReports = document.getElementById("tabReports"); // may be null
  const tabPermissions = document.getElementById("tabPermissions"); // may be null
  const isAdmin = currentUser && currentUser.role === "admin";
  if (isAdmin) {
    // Show all admin tabs that actually exist
    [tabAnalytics, tabComparison, tabEmployeeList, tabAudit, tabUsers, tabReports]
      .filter(Boolean) // ← removes any nulls
      .forEach(t => t.classList.remove("hidden"));
    if (tabPermissions) {
      if (["PG", "JT"].includes(currentUser.initials)) {
        tabPermissions.classList.remove("hidden");
      } else {
        tabPermissions.classList.add("hidden");
      }
    }
  } else {
    if (tabPermissions) {
      tabPermissions.classList.add("hidden");
    }
    const allowed = (currentUser && currentUser.allowed_tabs) || ["docs"];
    if (tabAnalytics) {
      tabAnalytics.classList.toggle("hidden", !allowed.includes("summary"));
    }
    if (tabComparison) {
      tabComparison.classList.toggle("hidden", !allowed.includes("comparison"));
    }
    if (tabEmployeeList) {
      tabEmployeeList.classList.toggle("hidden", !allowed.includes("elections"));
    }
    if (tabAudit) {
      tabAudit.classList.toggle("hidden", !allowed.includes("audit"));
    }
    if (tabUsers) {
      tabUsers.classList.toggle("hidden", !allowed.includes("users"));
    }
    // Optional: control Reports via allowed_tabs too
    if (tabReports) {
      tabReports.classList.toggle("hidden", !allowed.includes("reports"));
    }
  }
}
  // ------------------------ TABS ------------------------
  const tabDocs = document.getElementById("tabDocs");
  const tabAnalytics = document.getElementById("tabAnalytics");
  const tabComparison = document.getElementById("tabComparison");
  const tabEmployeeList = document.getElementById("tabEmployeeList");
  const tabAudit = document.getElementById("tabAudit");
  const tabUsers = document.getElementById("tabUsers");
  const tabReports = document.getElementById("tabReports");
  const tabPermissions = document.getElementById("tabPermissions");
  const tabDocsContent = document.getElementById("tabDocsContent");
  const tabAnalyticsContent = document.getElementById("tabAnalyticsContent");
  const tabComparisonContent = document.getElementById("tabComparisonContent");
  const tabEmployeeListContent = document.getElementById("tabEmployeeListContent");
  const tabAuditContent = document.getElementById("tabAuditContent");
  const tabUsersContent = document.getElementById("tabUsersContent");
  const tabReportsContent = document.getElementById("tabReportsContent");
  const tabPermissionsContent = document.getElementById("tabPermissionsContent");
 function activateTab(key) {
  const tabs = {
    docs: { btn: tabDocs, content: tabDocsContent },
    analytics: { btn: tabAnalytics, content: tabAnalyticsContent },
    comparison: { btn: tabComparison, content: tabComparisonContent },
    employeelist: { btn: tabEmployeeList, content: tabEmployeeListContent },
    audit: { btn: tabAudit, content: tabAuditContent },
    users: { btn: tabUsers, content: tabUsersContent },
    reports: { btn: tabReports, content: tabReportsContent },
    permissions: { btn: tabPermissions, content: tabPermissionsContent },
  };
  Object.entries(tabs).forEach(([k, v]) => {
    if (!v.btn || !v.content) return; // ← Critical null guard
    if (k === key) {
      v.btn.classList.remove("tab-btn-inactive");
      v.btn.classList.add("tab-btn-active");
      v.content.classList.remove("hidden");
    } else {
      v.btn.classList.remove("tab-btn-active");
      v.btn.classList.add("tab-btn-inactive");
      v.content.classList.add("hidden");
    }
  });
}
  // Tab click listeners
  if (tabDocs) {
  tabDocs.addEventListener("click", () => {
    activateTab("docs");
    loadSignedDocuments();
    logTabAccess("Signed Documents");
  });
}
if (tabAnalytics) {
  tabAnalytics.addEventListener("click", () => {
    activateTab("analytics");
    if (!analyticsRendered) loadAnalytics().then(() => (analyticsRendered = true));
    logTabAccess("Benefit Summary");
  });
}
if (tabComparison) {
  tabComparison.addEventListener("click", () => {
    activateTab("comparison");
    loadComparisonTab();
    logTabAccess("Employee Comparison");
  });
}
if (tabEmployeeList) {
  tabEmployeeList.addEventListener("click", () => {
    activateTab("employeelist");
    load2026EmployeeList();
    logTabAccess("2026 Employee Elections");
  });
}
if (tabAudit) {
  tabAudit.addEventListener("click", () => {
    activateTab("audit");
    loadAuditLogs();
    logTabAccess("Audit Logs");
  });
}
if (tabUsers) {
  tabUsers.addEventListener("click", () => {
    activateTab("users");
    logTabAccess("Authorized Users & Portal Credentials");
  });
}
if (tabReports) {
  tabReports.addEventListener("click", () => {
    activateTab("reports");
    loadComprehensiveReportData();
    logTabAccess("Reports");
  });
}
if (tabPermissions) {
  tabPermissions.addEventListener("click", () => {
    activateTab("permissions");
    loadPermissionsTab();
    logTabAccess("Permissions");
  });
}
  // ------------------------ SIGNED DOCUMENTS ------------------------
  async function loadSignedDocuments() {
    const tbody = document.getElementById("docBody");
    tbody.innerHTML =
      '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">Loading signed documents...</td></tr>';
    try {
      const data = await safeSupabaseQuery(
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null),
        "Loading signed documents"
      );
      docsCache = (data || []).sort((a, b) =>
        a.last_name.localeCompare(b.last_name)
      );
      renderDocsTable();
      document.getElementById("summarySignedEmployees").textContent =
        docsCache.length;
    } catch (err) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-red-500">Error loading documents.</td></tr>';
    }
  }
  function renderDocsTable() {
    const tbody = document.getElementById("docBody");
    const search = document.getElementById("docSearch").value.trim().toLowerCase();
    let rows = docsCache;
    if (search) {
      rows = rows.filter((r) => r.last_name.toLowerCase().includes(search));
    }
    document.getElementById("docSignedCount").textContent = docsCache.length;
    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">No employees match your search.</td></tr>';
      return;
    }
    tbody.innerHTML = "";
    rows.forEach((row, index) => {
      const rowNumber = index + 1;
      const fullName = `${row.last_name}, ${row.first_name}`;
      const pdfActions = row.signed_pdf_url
        ? `
        <button
          class="inline-flex items-center gap-1 text-xs text-[color:var(--jc-red)] hover:underline mr-3"
          onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
        >
          <i class="fa-solid fa-file-pdf"></i><span>View PDF</span>
        </button>
        <button
          class="inline-flex items-center gap-1 text-xs text-slate-600 hover:text-slate-900"
          onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
        >
          <i class="fa-solid fa-print"></i><span>Print</span>
        </button>`
        : `<span class="text-xs text-slate-400">N/A</span>`;
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50">
          <td class="px-4 py-2.5 text-xs text-slate-500">${rowNumber}</td>
          <td class="px-4 py-2.5 text-sm">${esc(fullName)}</td>
          <td class="px-4 py-2.5 text-sm">${esc(row.username || "")}</td>
          <td class="px-4 py-2.5 text-sm">${pdfActions}</td>
        </tr>`
      );
    });
  }
  document.getElementById("docSearch").addEventListener("input", renderDocsTable);
  document.getElementById("printAllButton").addEventListener("click", () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to print.",
        type: "error",
      });
      return;
    }
    docsCache.forEach((d) => {
      if (d.signed_pdf_url) window.open(d.signed_pdf_url, "_blank");
    });
    showToast({
      title: "Print initiated",
      message: "Opened all PDFs in new tabs. Use browser print to continue.",
      type: "success",
    });
  });
  document.getElementById("mergeAllButton").addEventListener("click", async () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to merge.",
        type: "error",
      });
      return;
    }
    showToast({
      title: "Processing...",
      message: "Merging all signed documents. This may take a moment.",
      type: "info",
    });
    try {
      const employeeIds = docsCache.map((d) => d.id);
      const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
        body: JSON.stringify({ employee_ids: employeeIds }),
      });
      const contentType = res.headers.get("content-type");
      if (!res.ok) {
        let errorMessage = "Edge function returned an error.";
        if (contentType?.includes("application/json")) {
          const errorData = await res.json();
          errorMessage = errorData.message || errorMessage;
        } else {
          const errorText = await res.text();
          console.error("Non-JSON error response:", errorText);
          errorMessage = `Server error: ${res.status}`;
        }
        showToast({
          title: "Merge failed",
          message: errorMessage,
          type: "error",
        });
        return;
      }
      if (contentType?.includes("application/pdf") || contentType?.includes("application/octet-stream")) {
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        window.open(url, "_blank");
        showToast({
          title: "Merge complete",
          message: "Combined PDF is ready and opened in a new tab.",
          type: "success",
        });
      } else {
        throw new Error(`Unexpected content type: ${contentType}`);
      }
    } catch (err) {
      console.error("merge error", err);
      showToast({
        title: "Merge failed",
        message: err.message || "Unexpected error. See console for details.",
        type: "error",
      });
    }
  });
  // ------------------------ ANALYTICS ------------------------
  async function ensureBenefitRatesLoaded() {
    if (benefitRates.length) return;
    const { data, error } = await supabase
      .from("benefit_rates")
      .select("plan_code, tier, coverage, amount, effective_year");
    if (!error && data) benefitRates = data;
  }
  // This is the kept version of getRateAmount
  function getRateAmount(year, coverage, tier, planCode) {
    if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
    const row = benefitRates.find(
      (r) =>
        String(r.effective_year) === String(year) &&
        (r.coverage || "").toLowerCase() === coverage &&
        r.tier === tier &&
        r.plan_code === planCode
    );
    return row ? parseFloat(row.amount) || 0 : 0;
  }
  function summarizePlanCounts(enrollments) {
    const stats = {};
    YEARS.forEach((y) => {
      stats[y] = { medical: {}, dental: {}, vision: {} };
    });
    enrollments.forEach((e) => {
      if (!YEARS.includes(e.benefit_year)) return;
      const yearStats = stats[e.benefit_year];
      const normalize = (p) =>
        !p || p === "NO" || (p + "").toUpperCase().includes("WAIVE") ? "WAIVE" : p;
      const mp = normalize(e.medical_plan);
      const dp = normalize(e.dental_plan);
      const vp = normalize(e.vision_plan);
      yearStats.medical[mp] = (yearStats.medical[mp] || 0) + 1;
      yearStats.dental[dp] = (yearStats.dental[dp] || 0) + 1;
      yearStats.vision[vp] = (yearStats.vision[vp] || 0) + 1;
    });
    return stats;
  }
  function prettyPlanName(coverage, code) {
    if (!code || code === "WAIVE" || code === "NO") return "Waived Coverage";
    const healthMap = {
      ATBAB303: "HMO / ATBAB303",
      ATBCB402: "PPO / ATBCB402",
      ATBAP393: "HMO HSA / ATBAP393",
    };
    const dentalMap = {
      F_PLAN_2W: "F-PLAN 2W / Base MAC",
      F_PLAN_3W: "F-PLAN 3W / Buy Up MAC",
    };
    const visionMap = {
      PLAN_1: "Vision Plan 1",
    };
    if (coverage === "medical") return healthMap[code] || code;
    if (coverage === "dental") return dentalMap[code] || code;
    if (coverage === "vision") return visionMap[code] || code;
    return code;
  }
  function buildCoverageSection(title, yearLabel, coverageKey, countsObj) {
    const entries = Object.entries(countsObj || {});
    if (!entries.length) return "";
    const waived = entries.filter(([code]) => code === "WAIVE");
    const others = entries
      .filter(([code]) => code !== "WAIVE")
      .sort((a, b) =>
        prettyPlanName(coverageKey, a[0]).localeCompare(
          prettyPlanName(coverageKey, b[0])
        )
      );
    const rows = [...waived, ...others]
      .map(
        ([code, count]) => `
        <tr class="border-t border-slate-100">
          <td class="py-1.5 pr-2 text-slate-700">
            ${esc(prettyPlanName(coverageKey, code))}
          </td>
          <td class="py-1.5 pl-2 text-right text-slate-800 font-semibold">
            ${count}
          </td>
        </tr>`
      )
      .join("");
    return `
      <section class="mt-4">
        <h4 class="text-xs font-semibold text-slate-700">
          ${title} (${yearLabel})
        </h4>
        <table class="w-full mt-2 text-xs">
          <thead>
            <tr class="text-slate-500">
              <th class="text-left font-semibold tracking-[0.12em] uppercase">Plan</th>
              <th class="text-right font-semibold tracking-[0.12em] uppercase">Employees</th>
            </tr>
          </thead>
          <tbody>
            ${rows}
          </tbody>
        </table>
      </section>`;
  }
  function renderPlanCards(stats) {
  const card2025 = document.getElementById("planCard2025");
  const card2026 = document.getElementById("planCard2026");
  const cardFuture = document.getElementById("planCardFuture");
  const toggle = document.getElementById("toggle2027");
  const badge = document.getElementById("planYearBadge");
  if (!card2025 || !card2026 || !cardFuture) return;
  card2025.innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
        <h3 class="mt-1 text-sm font-semibold text-slate-900">2025 Elections</h3>
        <p class="mt-1 text-[0.72rem] text-slate-500">Snapshot of health, dental, and vision participation for the 2025 plan year.</p>
      </div>
      <span class="pill-badge inline-flex items-center bg-slate-900 text-slate-50 px-3 py-1">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 mr-1.5"></span>
        Baseline year
      </span>
    </div>
    ${buildCoverageSection("Health Plans", "2025", "medical", stats[2025]?.medical || {})}
    ${buildCoverageSection("Dental Plans", "2025", "dental", stats[2025]?.dental || {})}
    ${buildCoverageSection("Vision Plans", "2025", "vision", stats[2025]?.vision || {})}
  `;
  card2026.innerHTML = `
    <div class="flex items-start justify-between gap-3 mb-4">
      <div>
        <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
        <h3 class="mt-1 text-sm font-semibold text-slate-900">2026 Elections</h3>
        <p class="mt-1 text-[0.72rem] text-slate-500">Current year mix by plan.</p>
      </div>
      <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span> Active year
      </span>
    </div>
    ${buildCoverageSection("Health Plans", "2026", "medical", stats[2026]?.medical || {})}
    ${buildCoverageSection("Dental Plans", "2026", "dental", stats[2026]?.dental || {})}
    ${buildCoverageSection("Vision Plans", "2026", "vision", stats[2026]?.vision || {})}
  `;
  initCharts(stats[2026]);
  const stats2027 = stats[2027] || { medical: {}, dental: {}, vision: {} };
  analyticsHas2027 =
    !!(Object.keys(stats2027.medical || {}).length ||
       Object.keys(stats2027.dental || {}).length ||
       Object.keys(stats2027.vision || {}).length);
  const show2027 = !!(toggle && toggle.checked && analyticsHas2027);
  if (!show2027) {
    cardFuture.classList.add("hidden");
    if (badge) badge.textContent = "Plan years: 2025 · 2026";
    return;
  }
  cardFuture.classList.remove("hidden");
  cardFuture.innerHTML = `
    <div class="flex items-start justify-between gap-3">
      <div>
        <p class="text-[0.6rem] uppercase tracking-[0.2em] text-slate-500">Plan year</p>
        <h3 class="mt-1 text-sm font-semibold text-slate-900">2027 Elections</h3>
        <p class="mt-1 text-[0.72rem] text-slate-500">When open enrollment is finalized, this card reflects the actual 2027 plan mix.</p>
      </div>
      <span class="pill-badge inline-flex items-center bg-sky-50 text-sky-700 border border-sky-100 px-3 py-1">
        <span class="w-1.5 h-1.5 rounded-full bg-sky-500 mr-1.5"></span> 2027 data
      </span>
    </div>
    ${buildCoverageSection("Health Plans", "2027", "medical", stats2027.medical || {})}
    ${buildCoverageSection("Dental Plans", "2027", "dental", stats2027.dental || {})}
    ${buildCoverageSection("Vision Plans", "2027", "vision", stats2027.vision || {})}
  `;
  if (badge) badge.textContent = "Plan years: 2025 · 2026 · 2027";
}
  function initCharts(stats) {
    const charts = [
      { id: "chartMedical2026", data: stats.medical, title: "Medical Distribution" },
      { id: "chartDental2026", data: stats.dental, title: "Dental Distribution" },
      { id: "chartVision2026", data: stats.vision, title: "Vision Distribution" }
    ];
    charts.forEach(chart => {
      const ctx = document.getElementById(chart.id);
      if (!ctx) return;
      if (ctx.chart) ctx.chart.destroy();
      const labels = Object.keys(chart.data).map(k => prettyPlanName(
        chart.id.includes('Medical') ? 'medical' :
        chart.id.includes('Dental') ? 'dental' : 'vision', k
      ));
      const values = Object.values(chart.data);
      ctx.chart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: labels,
          datasets: [{
            data: values,
            backgroundColor: ['#8a1619', '#c53030', '#003366', '#1d4ed8', '#4b5563', '#e5e7eb'],
            borderWidth: 2,
            borderColor: '#fff'
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom', labels: { boxWidth: 10, font: { size: 10 } } },
            title: { display: true, text: chart.title, font: { size: 12 } }
          }
        }
      });
    });
  }
  async function loadAnalytics() {
    try {
      const [{ data: employees }, { data: enrollments }] = await Promise.all([
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null)
          .order("last_name", { ascending: true }),
        supabase
          .from("benefit_enrollments")
          .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
          .in("benefit_year", YEARS),
      ]);
      const byUsername = new Map();
      (employees || []).forEach((emp) => {
        byUsername.set(emp.username, {
          employee: emp,
          byYear: { 2025: null, 2026: null },
        });
      });
      (enrollments || []).forEach((enr) => {
        const rec = byUsername.get(enr.username);
        if (!rec) return;
        rec.byYear[enr.benefit_year] = enr;
      });
      analyticsEmployees = Array.from(byUsername.values()).filter(
        (x) => x.byYear[2025] || x.byYear[2026]
      );
      const validUsernames = new Set(
        analyticsEmployees.map((r) => r.employee.username)
      );
      const filteredEnrollments = (enrollments || []).filter((e) =>
        validUsernames.has(e.username)
      );
      const stats = summarizePlanCounts(filteredEnrollments);
      planYearStats = stats;
      renderPlanCards(planYearStats);
  const toggle2027 = document.getElementById("toggle2027");
if (toggle2027) {
  const newToggle = toggle2027.cloneNode(true);
  toggle2027.parentNode.replaceChild(newToggle, toggle2027); // FIX: The newToggle must replace the original toggle2027 element
  newToggle.addEventListener("change", () => {
    if (!planYearStats) return;
   if (newToggle.checked && !analyticsHas2027) {
      showToast({
        title: "No 2027 data",
        message: "Once 2027 elections are loaded, this option will show that year.",
        type: "info",
      });
    }
    renderPlanCards(planYearStats);
  });
}
      await ensureBenefitRatesLoaded();
      renderCostBreakdown(filteredEnrollments.filter(e => e.benefit_year === 2026));
    } catch (err) {
      console.error("Analytics load error", err);
      showToast({
        title: "Analytics error",
        message: "Failed to load analytics data.",
        type: "error",
      });
    }
  }
  function renderCostBreakdown(enrollments) {
    const tbody = document.getElementById("costBreakdownBody");
    tbody.innerHTML = '';
    const costs = { medical: {}, dental: {}, vision: {} };
    enrollments.forEach(e => {
      const tier = e.tier_election || 'EO';
      ['medical', 'dental', 'vision'].forEach(cov => {
        const plan = e[`${cov}_plan`] || 'WAIVE';
        if (plan !== 'WAIVE') {
          const amount = getRateAmount(2026, cov, tier, plan) * 26;
          costs[cov][plan] = (costs[cov][plan] || 0) + amount;
        }
      });
    });
    ['medical', 'dental', 'vision'].forEach(cov => {
      Object.entries(costs[cov]).forEach(([plan, total]) => {
        const count = planYearStats[2026][cov][plan] || 0;
        tbody.insertAdjacentHTML('beforeend', `
          <tr>
            <td class="px-4 py-2">${cov.charAt(0).toUpperCase() + cov.slice(1)}</td>
            <td class="px-4 py-2">${prettyPlanName(cov, plan)}</td>
            <td class="text-right px-4 py-2">${count}</td>
            <td class="text-right px-4 py-2">${formatCurrency(total)}</td>
          </tr>
        `);
      });
    });
  }
  // ------------------------ EMPLOYEE COMPARISON TAB ------------------------
  async function loadComparisonTab() {
    if (comparisonRendered) {
      return;
    }
    const listEl = document.getElementById("comparisonEmployeeList");
    listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">Loading employees...</li>';
    try {
      const [{ data: employees }, { data: enrollments }] = await Promise.all([
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username, signed_pdf_url")
          .not("signed_pdf_url", "is", null)
          .order("last_name", { ascending: true }),
        supabase
          .from("benefit_enrollments")
          .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
          .in("benefit_year", [2025, 2026]),
      ]);
      const byUsername = new Map();
      (employees || []).forEach((emp) => {
        byUsername.set(emp.username, {
          employee: emp,
          byYear: { 2025: null, 2026: null },
        });
      });
      (enrollments || []).forEach((enr) => {
        const rec = byUsername.get(enr.username);
        if (!rec) return;
        rec.byYear[enr.benefit_year] = enr;
      });
      comparisonEmployees = Array.from(byUsername.values()).filter(
        (x) => x.byYear[2025] || x.byYear[2026]
      );
      await ensureBenefitRatesLoaded();
      renderComparisonEmployeeList();
      comparisonRendered = true;
    } catch (err) {
      console.error("Comparison load error", err);
      listEl.innerHTML = '<li class="px-4 py-3 text-xs text-red-500 text-center">Error loading data.</li>';
    }
  }
  function renderComparisonEmployeeList() {
    const listEl = document.getElementById("comparisonEmployeeList");
    // === FIX 1: Clear list before re-rendering to prevent duplication ===
    listEl.innerHTML = '';
  
    const search = document.getElementById("comparisonSearch").value.trim().toLowerCase();
    let rows = comparisonEmployees;
    if (search) {
      rows = rows.filter((r) => r.employee.last_name.toLowerCase().includes(search));
    }
    if (!rows.length) {
      listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">No employees match your search.</li>';
      return;
    }
    rows.forEach((rec) => {
      const { employee } = rec;
      const hasChange = rec.byYear[2025] && rec.byYear[2026];
  
      listEl.insertAdjacentHTML("beforeend", `
        <li>
          <button
            type="button"
            class="w-full text-left px-4 py-3 hover:bg-slate-100 transition-colors
                   focus:outline-none focus:bg-slate-100 group"
            data-username="${esc(employee.username)}"
          >
            <div class="flex items-center justify-between">
              <div class="flex-1">
                <p class="text-sm font-medium text-slate-900 group-hover:text-[color:var(--jc-red)]">
                  ${esc(employee.last_name)}, ${esc(employee.first_name)}
                </p>
                <p class="text-xs text-slate-500 mt-0.5">
                  ${esc(employee.username)}
                  ${hasChange ? '<span class="ml-2 text-emerald-600">• Has comparison data</span>' : ''}
                </p>
              </div>
              <i class="fa-solid fa-chevron-right text-xs text-slate-400 group-hover:text-[color:var(--jc-red)]"></i>
            </div>
          </button>
        </li>
      `);
    });
  }
  document.getElementById("comparisonSearch").addEventListener("input", renderComparisonEmployeeList);
  document.getElementById("comparisonEmployeeList").addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-username]");
    if (!btn) return;
    const username = btn.dataset.username;
    const rec = comparisonEmployees.find((r) => r.employee.username === username);
    if (rec) {
      displayEmployeeComparison(rec);
    }
  });
  function displayEmployeeComparison(rec) {
  const container = document.getElementById("employeeComparisonDisplay");
  const { employee, byYear } = rec;
  const enr2025 = byYear[2025];
  const enr2026 = byYear[2026];
 
  if (!enr2025 && !enr2026) {
    container.innerHTML = `
      <div class="flex items-center justify-center h-full">
        <p class="text-sm text-slate-600">No enrollment data available for this employee.</p>
      </div>
    `;
    return;
  }
  const calc = (year, enr) => {
    if (!enr) return { medical: 0, dental: 0, vision: 0, total: 0, biweekly: 0 };
    const tier = enr.tier_election || 'EO';
    const medical = getRateAmount(year, 'medical', tier, enr.medical_plan);
    const dental = getRateAmount(year, 'dental', tier, enr.dental_plan);
    const vision = getRateAmount(year, 'vision', tier, enr.vision_plan);
    const total = medical + dental + vision;
    return { medical, dental, vision, total, biweekly: total };
  };
  const cost2025 = calc(2025, enr2025);
  const cost2026 = calc(2026, enr2026);
  const annualCost2025 = cost2025.total * 26;
  const annualCost2026 = cost2026.total * 26;
  const annualDiff = annualCost2026 - annualCost2025;
  const percentChange = annualCost2025 > 0 ? ((annualDiff / annualCost2025) * 100) : 0;
  let changeType = "flat renewal";
  let changeColor = "text-slate-700";
  let changeIcon = "fa-minus";
  if (annualDiff > 100) {
    changeType = "upgrade";
    changeColor = "text-emerald-600";
    changeIcon = "fa-arrow-up";
  } else if (annualDiff < -100) {
    changeType = "downgrade";
    changeColor = "text-red-600";
    changeIcon = "fa-arrow-down";
  }
  const planRow = (label, plan2025, plan2026) => {
    const name2025 = plan2025 && plan2025 !== 'WAIVE' ? prettyPlanName(label.toLowerCase(), plan2025) : 'Waived';
    const name2026 = plan2026 && plan2026 !== 'WAIVE' ? prettyPlanName(label.toLowerCase(), plan2026) : 'Waived';
    const changed = name2025 !== name2026;
    return `
      <tr class="border-b border-slate-100">
        <td class="py-3 px-4 text-sm font-medium text-slate-700">${label}</td>
        <td class="py-3 px-4 text-sm ${changed ? 'text-slate-500' : 'text-slate-700'}">${name2025}</td>
        <td class="py-3 px-4 text-sm ${changed ? 'font-semibold text-[color:var(--jc-red)]' : 'text-slate-700'}">${name2026}</td>
        <td class="py-3 px-4 text-center">
          ${changed ? '<i class="fa-solid fa-circle-exclamation text-amber-500"></i>' : '<i class="fa-solid fa-check text-emerald-500"></i>'}
        </td>
      </tr>
    `;
  };
  container.innerHTML = `
    <div class="space-y-6">
      <header class="border-b border-slate-200 pb-4">
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="text-xl font-bold text-[color:var(--jc-navy)]">
              ${escapeHtml(employee.last_name)}, ${escapeHtml(employee.first_name)}
            </h3>
            <p class="text-sm text-slate-500 mt-1">
              Username: ${escapeHtml(employee.username)} • Tier: ${enr2026?.tier_election || enr2025?.tier_election || 'N/A'}
            </p>
          </div>
          <span class="pill-badge inline-flex items-center ${
            changeColor === 'text-emerald-600' ? 'bg-emerald-50 text-emerald-700 border-emerald-100' :
            changeColor === 'text-red-600' ? 'bg-red-50 text-red-700 border-red-100' :
            'bg-slate-100 text-slate-700 border-slate-200'
          } border px-4 py-2">
            <i class="fa-solid ${changeIcon} mr-2"></i>
            ${changeType.toUpperCase()}
          </span>
        </div>
      </header>
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card bg-slate-50 px-4 py-4">
          <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2025 Bi-weekly Cost</p>
          <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2025.biweekly)}</p>
          <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2025)}</p>
        </div>
        <div class="card bg-slate-50 px-4 py-4">
          <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2026 Bi-weekly Cost</p>
          <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2026.biweekly)}</p>
          <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2026)}</p>
        </div>
        <div class="card bg-slate-50 px-4 py-4">
          <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Cost Difference</p>
          <p class="text-2xl font-bold ${changeColor}">
            ${(cost2026.biweekly - cost2025.biweekly) >= 0 ? '+' : ''}${formatCurrency(cost2026.biweekly - cost2025.biweekly)}
          </p>
          <p class="text-xs ${changeColor} mt-1 font-semibold">Per pay period</p>
          <p class="text-xs text-slate-500 mt-1">
            Annual: ${annualDiff >= 0 ? '+' : ''}${formatCurrency(annualDiff)} (${Math.abs(percentChange).toFixed(1)}%)
          </p>
        </div>
      </div>
      <div class="space-y-3">
        <h4 class="text-sm font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider">
          Plan Elections Comparison
        </h4>
        <div class="overflow-x-auto">
          <table class="w-full">
            <thead class="bg-slate-100 border-b-2 border-slate-200">
              <tr>
                <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Coverage</th>
                <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2025 Plan</th>
                <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2026 Plan</th>
                <th class="py-2 px-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Status</th>
              </tr>
            </thead>
            <tbody>
              ${planRow('Medical', enr2025?.medical_plan, enr2026?.medical_plan)}
              ${planRow('Dental', enr2025?.dental_plan, enr2026?.dental_plan)}
              ${planRow('Vision', enr2025?.vision_plan, enr2026?.vision_plan)}
            </tbody>
          </table>
        </div>
      </div>
      <div class="card bg-blue-50 border-blue-100 px-4 py-3">
        <div class="flex items-start gap-3">
          <i class="fa-solid fa-lightbulb text-blue-600 mt-0.5"></i>
          <div class="flex-1">
            <p class="text-xs font-semibold text-blue-900 mb-1">Analysis Summary</p>
            <p class="text-xs text-blue-700 leading-relaxed">
              ${escapeHtml(employee.first_name)} ${escapeHtml(employee.last_name)}'s benefit elections show a <strong>${changeType}</strong>
              with an annual cost ${annualDiff >= 0 ? 'increase' : 'decrease'} of ${formatCurrency(Math.abs(annualDiff))}.
              ${annualDiff > 100 ? 'This represents enhanced coverage selections for 2026.' :
                (annualDiff < -100 ? 'This reflects reduced coverage or cost-saving plan changes.' :
                'Benefit selections remain relatively stable year-over-year.')}
            </p>
          </div>
        </div>
      </div>
    </div>
  `;
}
  // ------------------------ PORTAL USERS ------------------------
  async function loadPortalUsers() {
    const tbody = document.getElementById("userBody");
    tbody.innerHTML =
      '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';
    try {
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, role, active, last_login, allowed_tabs")
        .order("full_name", { ascending: true });
      if (error) throw error;
      portalUsersCache = data || [];
      renderPortalUsersTable();
    } catch (err) {
      console.error("Portal users error", err);
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-red-500">Error loading users.</td></tr>';
    }
  }
  function renderPortalUsersTable() {
    const tbody = document.getElementById("userBody");
    const search = document.getElementById("userSearch").value.trim().toLowerCase();
    let rows = portalUsersCache;
    if (search) {
      rows = rows.filter((u) =>
        u.full_name.toLowerCase().includes(search)
      );
    }
    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">No users match your search.</td></tr>';
      return;
    }
    tbody.innerHTML = "";
    rows.forEach((u) => {
      const roleBadge =
        u.role === "admin"
          ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-red-50 text-red-700 border border-red-100">ADMIN</span>'
          : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-700 border border-slate-200">STANDARD</span>';
      const statusBadge = u.active
        ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100">ACTIVE</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-500 border border-slate-200">INACTIVE</span>';
      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50 text-sm" data-id="${u.id}">
          <td class="px-4 py-2.5">${esc(u.full_name)}</td>
          <td class="px-4 py-2.5">${esc(u.initials)}</td>
          <td class="px-4 py-2.5">${roleBadge}</td>
          <td class="px-4 py-2.5 text-xs text-slate-500">${formatDate(u.last_login)}</td>
          <td class="px-4 py-2.5">${statusBadge}</td>
          <td class="px-4 py-2.5 text-xs">
            <button class="text-[color:var(--jc-red)] hover:underline mr-3" data-action="edit">Edit</button>
            <button class="text-slate-500 hover:text-red-600" data-action="delete">Delete</button>
          </td>
        </tr>`
      );
    });
  }
  document
    .getElementById("userSearch")
    .addEventListener("input", renderPortalUsersTable);
  document.getElementById("userBody").addEventListener("click", async (e) => {
    const row = e.target.closest("tr[data-id]");
    if (!row) return;
    const id = Number(row.dataset.id);
    const user = portalUsersCache.find((u) => u.id === id);
    if (!user) return;
    const action = e.target.dataset.action;
    if (action === "edit") {
      openUserModal(user);
    } else if (action === "delete") {
      if (user.initials === "PG") {
        showToast({
          title: "Protected account",
          message: "You cannot delete the primary owner account.",
          type: "error",
        });
        return;
      }
      if (!confirm(`Delete portal user ${user.full_name}?`)) return;
      try {
        const { error } = await supabase.from("portal_users").delete().eq("id", id);
        if (error) throw error;
        portalUsersCache = portalUsersCache.filter((u) => u.id !== id);
        renderPortalUsersTable();
        showToast({
          title: "User deleted",
          message: `${user.full_name} was removed from portal access.`,
          type: "success",
        });
      } catch (err) {
        console.error("Delete user error", err);
        showToast({
          title: "Delete failed",
          message: "Could not delete this user.",
          type: "error",
        });
      }
    }
  });
  const userModal = document.getElementById("userModal");
  const modalTitle = document.getElementById("userModalTitle");
  const modalFullName = document.getElementById("modalFullName");
  const modalInitials = document.getElementById("modalInitials");
  const modalPin = document.getElementById("modalPin");
  const modalRole = document.getElementById("modalRole");
  const modalActive = document.getElementById("modalActive");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");
  let editingUserId = null;
  document
    .getElementById("addUserButton")
    .addEventListener("click", () => openUserModal(null));
  function openUserModal(user) {
    if (!currentUser || currentUser.role !== "admin") {
      showToast({
        title: "Not allowed",
        message: "Only administrators can manage portal users.",
        type: "error",
      });
      return;
    }
    editingUserId = user ? user.id : null;
    modalTitle.textContent = editingUserId ? "Edit user" : "Add user";
    modalFullName.value = user?.full_name || "";
    modalInitials.value = user?.initials || "";
    modalPin.value = "";
    modalRole.value = user?.role || "user";
    modalActive.checked = user ? !!user.active : true;
    userModal.classList.remove("hidden");
    userModal.classList.add("flex");
  }
  modalCancel.addEventListener("click", () => {
    userModal.classList.add("hidden");
    userModal.classList.remove("flex");
  });
  modalSave.addEventListener("click", async () => {
    const fullName = modalFullName.value.trim();
    const initials = modalInitials.value.trim().toUpperCase();
    const pin = modalPin.value.trim();
    const role = modalRole.value;
    const active = modalActive.checked;
    if (!fullName || !initials || !pin) {
      showToast({
        title: "Missing fields",
        message: "Full name, initials, and PIN are required.",
        type: "error",
      });
      return;
    }
    if (!/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }
    try {
      if (editingUserId) {
        const { error } = await supabase
          .from("portal_users")
          .update({
            full_name: fullName,
            initials,
            pin,
            role,
            active,
          })
          .eq("id", editingUserId);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("portal_users").insert([
          {
            full_name: fullName,
            initials,
            username: initials,
            pin,
            role,
            active,
          },
        ]);
        if (error) throw error;
      }
      userModal.classList.add("hidden");
      userModal.classList.remove("flex");
      await loadPortalUsers();
      showToast({
        title: "Saved",
        message: "Portal user changes have been saved.",
        type: "success",
      });
    } catch (err) {
      console.error("Save user error", err);
      showToast({
        title: "Save failed",
        message: "Could not save this portal user.",
        type: "error",
      });
    }
  });
  async function loadAuditLogs() {
  const tbody = document.getElementById("auditBody");
  tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">Loading audit logs...</td></tr>';
  try {
    const { data: logs, error } = await supabase
      .from("portal_logs")
      .select("id, portal_user_id, login_time, logout_time, duration_minutes, tab_accessed, tab_history")
      .order("login_time", { ascending: false });
    if (error) throw error;
    // Ensure portal users are loaded for lookup
    if (!portalUsersCache.length) {
      await loadPortalUsers();
    }
    const userMap = Object.fromEntries(portalUsersCache.map(u => [u.id, u]));
    tbody.innerHTML = "";
    (logs || []).forEach(log => {
      const user = log.portal_user_id ? userMap[log.portal_user_id] : null;
      const name = user ? `${user.full_name} (${user.initials})` : "Unknown";
      const duration = log.duration_minutes != null ? `${log.duration_minutes} min` : "—";
      // SAFE history array
      const historyArray = Array.isArray(log.tab_history) ? log.tab_history : [];
      const historyHtml =
        historyArray.length
          ? historyArray
              .slice(-5) // last 5
              .reverse() // newest first
              .map(entry => `<div class="text-xs text-slate-700">${esc(entry)}</div>`)
              .join("")
          : '<span class="text-slate-400">Dashboard</span>';
      tbody.insertAdjacentHTML("beforeend", `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-2.5">${esc(name)}</td>
          <td class="px-4 py-2.5">${formatDate(log.login_time)}</td>
          <td class="px-4 py-2.5">${
            log.logout_time ? formatDate(log.logout_time) : '<span class="text-amber-600">Active</span>'
          }</td>
          <td class="px-4 py-2.5">${duration}</td>
          <td class="px-4 py-2.5 space-y-1 max-w-xs">${historyHtml}</td>
        </tr>
      `);
    });
    if (!logs || !logs.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
            No audit history yet.
          </td>
        </tr>`;
    }
  } catch (err) {
    console.error("Audit logs failed:", err);
    tbody.innerHTML = '<tr><td colspan="5" class="text-red-600 text-center text-xs px-4 py-4">Failed to load</td></tr>';
  }
}
  async function loadRates() {
    const { data, error } = await supabase
      .from("benefit_rates")
      .select("coverage,plan_code,tier,amount,per_year_periods,effective_year");
    if (error) return console.error(error);
    RATES = {};
    for (const r of data) {
      const cov = r.coverage.toLowerCase();
      const year = r.effective_year;
      RATES[year] = RATES[year] || {};
      RATES[year][cov] = RATES[year][cov] || {};
      RATES[year][cov][r.plan_code] = RATES[year][cov][r.plan_code] || {};
      RATES[year][cov][r.plan_code][r.tier] = { amt: Number(r.amount), ppp: r.per_year_periods || 26 };
    }
  }
  /*
  // REMOVED: Duplicate definition of getRateAmount (Issue #2)
  function getRateAmount(year, coverage, tier, planCode) {
    if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
    const row = benefitRates.find(
      (r) =>
        String(r.effective_year) === String(year) &&
        (r.coverage || "").toLowerCase() === coverage &&
        r.tier === tier &&
        r.plan_code === planCode
    );
    return row ? parseFloat(row.amount) || 0 : 0;
  }
  */
  async function load2026EmployeeList() {
     await ensureBenefitRatesLoaded();
    try {
      showToast({
        title: "Loading...",
        message: "Loading 2026 benefit elections...",
        type: "info",
      });
      // 1) Load enrollments for 2026
      const { data: enrollments, error: enrError } = await supabase
        .from("benefit_enrollments")
        .select("*")
        .eq("benefit_year", 2026);
      if (enrError) throw enrError;
      if (!enrollments || !enrollments.length) {
        throw new Error("No enrollment data found for 2026.");
      }
        fullEnrollments = enrollments;
      // 2) Load employee master data for all enrolled users
      const usernames = [...new Set(enrollments.map((e) => e.username).filter(Boolean))];
      const { data: employees, error: empError } = await supabase
        .from("employees2025")
        .select("id, username, first_name, last_name, primary_phone, sssn, job_title, annual_salary, hourly_rate, employment_status, original_hire_date, address_line_1, city, state, zip_code") // FIX: Removed trailing comment/unnecessary code
        .in("username", usernames);
      if (empError) throw empError;
      const empMap = Object.fromEntries((employees || []).map((e) => [e.username, e]));
      // 3) Consolidate data for the new table structure
      allEmployees = fullEnrollments.map(enr => {
        const emp = empMap[enr.username] || {};
        const tier = enr.tier_election || 'EO';
        const medicalPlan = enr.medical_plan || 'WAIVE';
        const dentalPlan = enr.dental_plan || 'WAIVE';
        const visionPlan = enr.vision_plan || 'WAIVE';
     
        const hasLife = Array.isArray(enr.beneficiaries) && enr.beneficiaries.length > 0;
     
        return {
          id: enr.id,
          employee_id_fk: emp.id,
          first_name: emp.first_name,
          last_name: emp.last_name,
          job_title: enr.job_title || emp.job_title,
          employment_status: enr.employment_status || emp.employment_status || 'ACTIVE',
          original_hire_date: enr.hire_date || emp.original_hire_date,
          primary_phone: enr.phone || emp.primary_phone,
          address_line_1: enr.address?.street || emp.address_line_1 || '',
          city: enr.address?.city || emp.city || '',
          state: enr.address?.state || emp.state || '',
          zip_code: enr.address?.zip || emp.zip_code || '',
          annual_salary: enr.annual_salary || emp.annual_salary || 0,
          hourly_rate: emp.hourly_rate || 0,
          tier_election: tier,
          medical_plan: prettyPlanName('medical', medicalPlan),
          dental_plan: prettyPlanName('dental', dentalPlan),
          vision_plan: prettyPlanName('vision', visionPlan),
          life_plan: (emp.employer_life || false) ? 'Employer Paid' : (hasLife ? 'Elected' : null),
          has_life: hasLife,
          ssn_full: emp.sssn,
          rawEmployeeData: emp,
          rawEnrollmentData: enr
        };
      }).sort((a, b) => a.last_name.localeCompare(b.last_name));
      // 4) Update KPI summary cards (Counts based on allEmployees data)
      const enrolledCount = allEmployees.length;
      const medCount = allEmployees.filter(e => e.medical_plan !== 'Waived Coverage').length;
      const denCount = allEmployees.filter(e => e.dental_plan !== 'Waived Coverage').length;
      const visCount = allEmployees.filter(e => e.vision_plan !== 'Waived Coverage').length;
      const lifeCount = allEmployees.filter(e => e.has_life || e.life_plan).length;
   
      document.getElementById("gridTotalEnrolled").textContent = enrolledCount;
      document.getElementById("gridMedicalCoverage").textContent = medCount;
      document.getElementById("gridDentalCoverage").textContent = denCount;
      document.getElementById("gridVisionCoverage").textContent = visCount;
      document.getElementById("gridLifeCoverage").textContent = lifeCount;
      // 5) Render the full table and initialize filters
      applyFiltersAndRender();
      initFilters();
   
      showToast({
        title: "Loaded successfully",
        message: `Loaded ${enrolledCount} employee census records for 2026.`,
        type: "success",
      });
    } catch (err) {
      console.error("Load 2026 list error:", err);
      showToast({
        title: "Load Error",
        message: "Failed to load 2026 benefit elections. " + (err.message || ""),
        type: "error",
      });
    }
  }
function openEmployeeModalFromRow(row) {
  if (!row) return;
  currentEditingEnrollment = row;
  const emp = row.rawEmployeeData || {};
  const enr = row.rawEnrollmentData || {};
  // snapshot used for Change History comparison
  modalOriginalEnrollment = JSON.parse(JSON.stringify(enr || {}));
  const firstName = row.first_name || emp.first_name || "";
  const lastName = row.last_name || emp.last_name || "";
  // Header like: Aguilar, Daira — 2026 Elections
  const titleEl = document.getElementById("employeeModalTitle");
  if (titleEl) {
    titleEl.textContent = `${lastName}, ${firstName} — 2026 Elections`.trim();
  }
  // Helper to safely set values
  const setValue = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.value = value != null ? value : "";
  };
  // PERSONAL & EMPLOYMENT TAB
  setValue(
    "empJobTitleInput",
    emp.job_title || row.job_title || enr.job_title || ""
  );
  setValue(
    "empStatusSelect",
    emp.employment_status ||
      row.employment_status ||
      enr.employment_status ||
      "ACTIVE"
  );
  setValue(
    "empHireDateInput",
    emp.original_hire_date || enr.hire_date || row.hire_date || ""
  );
  setValue(
    "empSalaryInput",
    emp.annual_salary ??
      enr.annual_salary ??
      row.annual_salary ??
      ""
  );
  setValue("empHourlyRateInput", emp.hourly_rate || "");
  setValue(
    "empPhoneInput",
    emp.primary_phone || enr.phone || row.primary_phone || ""
  );
  const addr = enr.address || {};
  setValue(
    "empAddressInput",
    emp.address_line_1 || addr.street || row.address_line_1 || ""
  );
  setValue("empCityInput", emp.city || addr.city || row.city || "");
  setValue("empStateInput", emp.state || addr.state || row.state || "");
  setValue(
    "empZipInput",
    emp.zip_code || addr.zip || row.zip_code || ""
  );
  // BENEFIT ELECTIONS TAB
  setValue(
    "empTierSelect",
    enr.tier_election || row.tier_election || "EO"
  );
  setValue(
    "empMedPlanSelect",
    enr.medical_plan ||
      row.medical_plan_code ||
      row.medical_plan ||
      "WAIVE"
  );
  setValue(
    "empDentalPlanSelect",
    enr.dental_plan ||
      row.dental_plan_code ||
      row.dental_plan ||
      "WAIVE"
  );
  setValue(
    "empVisionPlanSelect",
    enr.vision_plan ||
      row.vision_plan_code ||
      row.vision_plan ||
      "WAIVE"
  );
  setValue("empLifeSelect", enr.life_option || "");
  // FAMILY & DEPENDENTS / BENEFICIARIES
  renderModalDependentsTable(enr.dependents || []);
  renderModalBeneficiariesTable(enr.beneficiaries || []);
  // CHANGE HISTORY
  renderModalChangeHistory();
  // PRICES
  updateModalPlanCosts();
  const modal = document.getElementById("employeeModal");
  if (modal) {
    modal.classList.remove("hidden");
  }
}
function renderElections2026Table(rows) {
  const tbody = document.getElementById('elections2026Body'); // or electionsBody2026
  if (!tbody) {
    console.warn('[renderElections2026Table] tbody not found');
    return;
  }
  tbody.innerHTML = '';
  (rows || []).forEach(r => {
    tbody.innerHTML += `
      <tr class="border-b border-slate-100 text-xs">
        <td class="px-3 py-2 font-medium text-slate-800">${r.full_name || ''}</td>
        <td class="px-3 py-2 text-slate-500">${r.job_title || ''}</td>
        <td class="px-3 py-2 text-center">${r.tier_election || ''}</td>
        <td class="px-3 py-2 text-center">${r.medical_plan || ''}</td>
        <td class="px-3 py-2 text-center">${r.dental_plan || ''}</td>
        <td class="px-3 py-2 text-center">${r.vision_plan || ''}</td>
        <td class="px-3 py-2 text-right">
          <input
            type="number"
            step="100"
            min="0"
            class="w-24 text-right border border-slate-200 rounded px-1 py-0.5 text-xs annual-salary-input"
            value="${r.annual_salary ?? ''}"
            data-enrollment-id="${r.enrollment_id || ''}"
            data-employee-id="${r.employee_id}"
            data-employee-name="${r.full_name || ''}"
            data-old-value="${r.annual_salary ?? ''}"
          />
        </td>
      </tr>
    `;
  });
}
  // --- Filtering and Rendering Logic for Employee List ---
function renderEmployeeRow(emp) {
  const annualSalaryDisplay = emp.annual_salary
    ? `$${Number(emp.annual_salary).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0})}`
    : '—';
  return `
    <tr class="border-b border-slate-200 hover:bg-slate-50 text-xs">
      <td class="px-4 py-3">${escapeHtml(emp.last_name)}, ${escapeHtml(emp.first_name)}</td>
      <td class="px-4 py-3">${escapeHtml(emp.job_title || '—')}</td>
      <td class="px-4 py-3">
        <span class="font-semibold ${emp.employment_status === 'ACTIVE' ? 'text-emerald-700' : 'text-red-700'}">
          ${escapeHtml(emp.employment_status || 'ACTIVE')}
        </span>
      </td>
      <td class="px-4 py-3 text-right">${annualSalaryDisplay}</td>
      <td class="px-4 py-3">${emp.original_hire_date ? new Date(emp.original_hire_date).toLocaleDateString() : '—'}</td>
      <td class="px-4 py-3">${formatPhone(emp.primary_phone) || '—'}</td>
      <td class="px-4 py-3">${escapeHtml(emp.address_line_1 || '—')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.city || '—')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.zip_code || '—')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.tier_election || 'EO')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.medical_plan || '—')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.dental_plan || '—')}</td>
      <td class="px-4 py-3">${escapeHtml(emp.vision_plan || '—')}</td>
      <td class="px-4 py-3">${emp.life_plan ? 'Yes' : '—'}</td>
      <td class="px-4 py-3">
        <button
          class="text-[color:var(--jc-red)] hover:underline text-sm font-medium"
          onclick="openEmployeeModalFromRow(${JSON.stringify(emp)})"
        >
          View/Edit
        </button>
      </td>
    </tr>
  `;
}
  const tbody = document.getElementById('employeeListTableBody');
  if (!tbody) return;
 
  if (!rows || rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">No employees found</td></tr>';
    return;
  }
 
  tbody.innerHTML = rows.map(emp => `
    <tr class="border-b border-slate-200 hover:bg-slate-50 text-xs">
      <td class="px-4 py-3">${emp.last_name}, ${emp.first_name}</td>
      <td class="px-4 py-3">${emp.job_title || '—'}</td>
      <td class="px-4 py-3">ACTIVE</td>
      <td class="px-4 py-3">$${emp.annual_salary || 0}</td>
      <td class="px-4 py-3">${emp.original_hire_date || '—'}</td>
      <td class="px-4 py-3">${emp.primary_phone || '—'}</td>
      <td class="px-4 py-3">${emp.address_line_1 || '—'}</td>
      <td class="px-4 py-3">${emp.city || '—'}</td>
      <td class="px-4 py-3">${emp.zip_code || '—'}</td>
      <td class="px-4 py-3">${emp.tier_election || 'EO'}</td>
      <td class="px-4 py-3">${emp.medical_plan || '—'}</td>
      <td class="px-4 py-3">${emp.dental_plan || '—'}</td>
      <td class="px-4 py-3">${emp.vision_plan || '—'}</td>
      <td class="px-4 py-3">${emp.life_plan || '—'}</td>
      <td class="px-4 py-3">
        <button onclick="openEmployeeModalFromRow(${JSON.stringify(emp)})" class="text-red-600 hover:underline">
          View/Edit
        </button>
      </td>
    </tr>
  `).join(''); // ✅ This one is OK
}
function renderEmployeesTable(rows) {
  const tbody = document.getElementById('employeeListTableBody');
  if (!tbody) return;
  if (!rows || rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">No employees found</td></tr>';
    return;
  }
  tbody.innerHTML = rows.map(emp => renderEmployeeRow(emp)).join('');
}
function formatPhone(phone) {
  if (!phone) return '—';
  const digits = phone.replace(/\D/g, '');
  if (digits.length === 10) {
    return `(${digits.slice(0,3)}) ${digits.slice(3,6)}-${digits.slice(6)}`;
  }
  return phone;
}
  function applyFiltersAndRender() {
  const search = document.getElementById('employeeSearch')?.value.trim().toLowerCase() || '';
  const tier = document.getElementById('filterTier')?.value || '';
  const med = document.getElementById('filterMed')?.value || '';
  const dental = document.getElementById('filterDental')?.value || '';
  const life = document.getElementById('filterLife')?.value || '';
  const city = document.getElementById('filterCity')?.value.trim().toLowerCase() || '';
  let filtered = allEmployees;
  if (search) {
    filtered = filtered.filter(emp => {
      const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.toLowerCase();
      return fullName.includes(search);
    });
  }
  if (tier) filtered = filtered.filter(emp => emp.tier_election === tier);
  if (med) filtered = filtered.filter(emp => emp.rawEnrollmentData?.medical_plan === med);
  if (dental) filtered = filtered.filter(emp => emp.rawEnrollmentData?.dental_plan === dental);
  if (life) filtered = filtered.filter(emp => life === 'yes' ? emp.has_life : !emp.has_life);
  if (city) filtered = filtered.filter(emp => (emp.city || '').toLowerCase().includes(city));
  renderEmployeesTable(filtered);
}
  function initFilters() {
    // Only bind once
    if (window.filtersInitialized) return;
    window.filtersInitialized = true;
 
    const elements = ['employeeSearch', 'filterTier', 'filterMed', 'filterDental', 'filterLife', 'filterCity'];
 
    elements.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.addEventListener('input', applyFiltersAndRender);
            el.addEventListener('change', applyFiltersAndRender);
        }
    });
    const clearBtn = document.getElementById('clearFilters');
    if (clearBtn) {
      clearBtn.addEventListener('click', () => {
        elements.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.value = el.tagName === 'SELECT' ? '' : '';
        });
        applyFiltersAndRender();
      });
    }
  }
  // Initial Filter Setup for the Employee List tab
  if (document.getElementById('tabEmployeeList')) {
      document.getElementById('tabEmployeeList').addEventListener('click', () => {
          // Re-load data if coming from another tab/not loaded yet
          if (allEmployees.length === 0) {
            load2026EmployeeList();
          } else {
            applyFiltersAndRender();
          }
      });
  }
  // --- END Filtering and Rendering Logic for Employee List ---
// FINAL REPORT LOGIC
document
  .getElementById("loadReportDataButton")
  ?.addEventListener("click", loadComprehensiveReportData);
document
  .getElementById("exportComprehensiveExcel")
  ?.addEventListener("click", exportFullCensusToExcel);
// Simple date-only formatter for census / report views
function formatDateOnly(value) {
  if (!value) return "—";
  return new Date(value).toLocaleDateString("en-US");
}
async function loadComprehensiveReportData() {
  if (!supabase) {
    showToast({
      title: "DB Error",
      message: "Supabase client not initialized.",
      type: "error",
    });
    return;
  }
  const tbody = document.getElementById("reportBody");
  if (!tbody) {
    console.error("loadComprehensiveReportData: #reportBody not found.");
    showToast({
      title: "UI Error",
      message: "Report grid failed to initialize.",
      type: "error",
    });
    return;
  }
  tbody.innerHTML = `
    <tr>
      <td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">
        Loading comprehensive data...
      </td>
    </tr>`;
  showToast({
    title: "Loading Data",
    message: "Fetching all 2026 census and enrollment data...",
    type: "info",
  });
  try {
    // Make sure benefitRates is ready for cost calculations
    await ensureBenefitRatesLoaded();
    // 1) All 2026 enrollments
    const { data: enrollments, error: enrError } = await supabase
      .from("benefit_enrollments")
      .select("*")
      .eq("benefit_year", 2026);
    if (enrError) throw enrError;
    if (!enrollments || !enrollments.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">
            No 2026 enrollment data found.
          </td>
        </tr>`;
      comprehensiveData = [];
      showToast({
        title: "No Data",
        message: "No 2026 enrollments are available yet.",
        type: "info",
      });
      return;
    }
    // 2) Pull employee master data for matching usernames
    const usernames = [...new Set(enrollments.map(e => e.username).filter(Boolean))];
    let employees = [];
    if (usernames.length) {
      const { data: empData, error: empError } = await supabase
        .from("employees2025")
        .select(
          "id, username, first_name, last_name, primary_phone, email, job_title, " +
          "annual_salary, hourly_rate, employment_status, original_hire_date, " +
          "address_line_1, address_line_2, city, state, zip_code, sssn"
        )
        .in("username", usernames);
      if (empError) throw empError;
      employees = empData || [];
    }
    const empMap = Object.fromEntries(employees.map(e => [e.username, e]));
    // 3) Combine + enrich into a flat "census row" per enrollment
    comprehensiveData = enrollments.map(enr => {
      const emp = enr.username ? empMap[enr.username] : null;
      const tier = enr.tier_election || "EO";
      const medPlanCode = enr.medical_plan || "WAIVE";
      const dentalPlanCode = enr.dental_plan || "WAIVE";
      const visionPlanCode = enr.vision_plan || "WAIVE";
      const medBi = getRateAmount(2026, "medical", tier, medPlanCode);
      const denBi = getRateAmount(2026, "dental", tier, dentalPlanCode);
      const visBi = getRateAmount(2026, "vision", tier, visionPlanCode);
      const totalBi = medBi + denBi + visBi;
      const employeeName = emp
        ? `${emp.last_name}, ${emp.first_name}`
        : (enr.full_name || enr.username || "Unknown");
      const jobTitle = enr.job_title || (emp && emp.job_title) || "";
      const employmentStatus =
        enr.employment_status || (emp && emp.employment_status) || "";
      const salary = enr.annual_salary || (emp && emp.annual_salary) || null;
      const hourlyRate = emp && emp.hourly_rate ? Number(emp.hourly_rate) : null;
      const hireDate = enr.hire_date || (emp && emp.original_hire_date) || null;
      const rawPhone =
        enr.phone ||
        (emp && (emp.primary_phone || emp.phone)) ||
        "";
      const phone = rawPhone;
      const email = enr.email || (emp && emp.email) || "";
      // Address from enrollment.address (JSON) or employees table
      let addressParts = [];
      let city = "";
      let state = "";
      let zip = "";
   
      if (enr.address && typeof enr.address === "object") {
        const addr = enr.address;
        if (addr.street || addr.address_line_1) {
          addressParts.push(addr.street || addr.address_line_1);
        }
        if (addr.address_line_2) addressParts.push(addr.address_line_2);
        city = addr.city || "";
        state = addr.state || "";
        zip = addr.zip || "";
        const cityStateZip = [city, state, zip]
          .filter(Boolean)
          .join(" ");
        if (cityStateZip) addressParts.push(cityStateZip);
      } else if (emp) {
        if (emp.address_line_1) addressParts.push(emp.address_line_1);
        if (emp.address_line_2) addressParts.push(emp.address_line_2);
        city = emp.city || "";
        state = emp.state || "";
        zip = emp.zip_code || "";
        const cityStateZip = [city, state, zip]
          .filter(Boolean)
          .join(" ");
        if (cityStateZip) addressParts.push(cityStateZip);
      }
      const fullAddress = addressParts.join(", ");
      const rawSSN = (enr.ssn || (emp && emp.sssn) || "").replace(/\D/g, "");
      const ssnFormatted = rawSSN ? formatSSN(rawSSN) : "N/A";
      const dependentsSummary =
        Array.isArray(enr.dependents) && enr.dependents.length
          ? enr.dependents
              .map(d => {
                const name = [d.first, d.last].filter(Boolean).join(" ");
                return d.relationship ? `${name} (${d.relationship})` : name;
              })
              .join("; ")
          : "None";
      const lifeDesignated =
        Array.isArray(enr.beneficiaries) && enr.beneficiaries.length > 0 // FIX: Corrected ArrayOf typo
          ? "Yes"
          : "No";
      return {
        enrollmentId: enr.id,
        employeeName,
        jobTitle,
        employmentStatus,
        salary,
        hourlyRate,
        hireDate,
        phone,
        email,
        address: fullAddress,
        city,
        state,
        zip,
        ssn: ssnFormatted,
        tier,
        medPlanCode,
        medPlanLabel: prettyPlanName("medical", medPlanCode),
        medBi,
        dentalPlanCode,
        dentalPlanLabel: prettyPlanName("dental", dentalPlanCode),
        denBi,
        visionPlanCode,
        visionPlanLabel: prettyPlanName("vision", visionPlanCode),
        visBi,
        totalBi,
        annualTotal: totalBi * 26,
        dependentsSummary,
        lifeDesignated,
        rawEmployeeData: emp,
        rawEnrollmentData: enr,
        employee_id_fk: emp ? emp.id : null,
      };
    });
    // Sort by last name
    comprehensiveData.sort((a, b) =>
      a.employeeName.localeCompare(b.employeeName)
    );
    renderComprehensiveTable();
    showToast({
      title: "Report Ready",
      message: `Loaded ${comprehensiveData.length} records into the 2026 census grid.`,
      type: "success",
    });
  } catch (err) {
    console.error("loadComprehensiveReportData error:", err);
    tbody.innerHTML = `
      <tr>
        <td colspan="15" class="px-4 py-4 text-center text-xs text-red-500">
          Failed to load comprehensive report.
        </td>
      </tr>`;
    comprehensiveData = [];
    showToast({
      title: "Load Error",
      message: err.message || "Could not load comprehensive report data.",
      type: "error",
    });
  }
}
function renderComprehensiveTable() {
  const tbody = document.getElementById("reportBody");
  if (!tbody) return;
  if (!comprehensiveData.length) {
    tbody.innerHTML = `
      <tr>
        <td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">
          No data loaded. Click "Load Report Data" to retrieve the 2026 census.
        </td>
      </tr>`;
    return;
  }
  tbody.innerHTML = "";
  comprehensiveData.forEach(row => {
    const employmentBits = [];
    if (row.employmentStatus) employmentBits.push(row.employmentStatus);
    if (row.annualSalary) employmentBits.push(`${formatCurrency(row.annualSalary)} / yr`);
    if (!row.annualSalary && row.hourlyRate)
      employmentBits.push(`$${row.hourlyRate.toFixed(2)} / hr`);
    if (row.hireDate) employmentBits.push(`Hire: ${formatDateOnly(row.hireDate)}`);
    const employmentCell = employmentBits.join(" \n ");
    const contactBits = [];
    if (row.phone) contactBits.push(formatPhone(row.phone));
    if (row.email) contactBits.push(row.email);
    if (row.address) contactBits.push(row.address);
    const contactCell = contactBits.join(" \n ");
    const tr = document.createElement("tr");
    tr.className = "hover:bg-slate-50 align-top";
    tr.innerHTML = `
      <td class="px-3 py-2.5 text-sm">
        <div class="font-semibold text-slate-900">${esc(row.employeeName)}</div>
        <div class="text-xs text-slate-500">${esc(row.jobTitle || "")}</div>
      </td>
      <td class="px-3 py-2.5 text-xs text-slate-700 whitespace-pre-line">
        ${esc(employmentCell)}
      </td>
      <td class="px-3 py-2.5 text-xs text-slate-700 whitespace-pre-line">
        ${esc(contactCell)}
      </td>
      <td class="px-3 py-2.5 text-xs text-slate-700">
        ${esc(row.ssn)}
      </td>
      <td class="px-3 py-2.5 text-xs text-slate-700">
        ${esc(row.tier)}
      </td>
      <td class="px-3 py-2.5 text-xs">
        ${esc(row.medPlanLabel)}
      </td>
      <td class="px-3 py-2.5 text-xs text-right">
        ${row.medBi ? formatCurrency(row.medBi) : "—"}
      </td>
      <td class="px-3 py-2.5 text-xs">
        ${esc(row.dentalPlanLabel)}
      </td>
      <td class="px-3 py-2.5 text-xs text-right">
        ${row.denBi ? formatCurrency(row.denBi) : "—"}
      </td>
      <td class="px-3 py-2.5 text-xs">
        ${esc(row.visionPlanLabel)}
      </td>
      <td class="px-3 py-2.5 text-xs text-right">
        ${row.visBi ? formatCurrency(row.visBi) : "—"}
      </td>
      <td class="px-3 py-2.5 text-xs text-right font-semibold">
        ${row.totalBi ? formatCurrency(row.totalBi) : "—"}
      </td>
      <td class="px-3 py-2.5 text-xs text-slate-700 max-w-xs">
        ${esc(row.dependentsSummary)}
      </td>
      <td class="px-3 py-2.5 text-xs text-center">
        ${
          row.lifeDesignated === "Yes"
            ? '<span class="inline-flex px-2 py-0.5 rounded-full bg-emerald-50 text-emerald-700 text-[0.7rem] font-semibold">YES</span>'
            : '<span class="inline-flex px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 text-[0.7rem] font-semibold">NO</span>'
        }
      </td>
      <td class="px-3 py-2.5 text-xs text-[color:var(--jc-red)]">
        <!-- Reserved for future "open modal" wiring -->
        <button type="button" class="hover:underline" onclick="openEmployeeModal(${row.enrollmentId})">
          View
        </button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}
// CHANGE: Added function for exporting Full Census with corporate styling
async function exportFullCensusToExcel() {
  if (!comprehensiveData || !comprehensiveData.length) {
    showToast({
      title: "No Data",
      message: "Load report data first, then export.",
      type: "error",
    });
    return;
  }
  showToast({
    title: "Exporting...",
    message: "Building full 2026 census workbook...",
    type: "info",
  });
  const wb = XLSX.utils.book_new();
  wb.Props = {
    Title: "Full Census",
    Subject: "Jeng Chi – 2026 Enrollment Census",
    Author: "Executive Benefits Portal",
    Company: "Jeng Chi Restaurant",
    CreatedDate: new Date(),
  };
  const data = comprehensiveData.map(row => ({
    "Employee ID / External ID": row.rawEnrollmentData?.external_id || row.employee_id_fk,
    "Last Name": row.employeeName.split(', ')[0],
    "First Name": row.employeeName.split(', ')[1],
    "Job Title": row.jobTitle,
    "Department": row.rawEnrollmentData?.department || '',
    "Employment Status": row.employmentStatus,
    "Date of Birth (DOB)": row.rawEnrollmentData?.dob ? formatDateOnly(row.rawEnrollmentData.dob) : '',
    "Hire Date": row.hireDate ? formatDateOnly(row.hireDate) : '',
    "Address": row.address,
    "City": row.city,
    "State": row.state,
    "ZIP": row.zip,
    "Phone": row.phone ? formatPhone(row.phone) : '',
    "Email": row.email,
    "Tier Election": row.tier,
    "Medical Plan": row.medPlanLabel,
    "Dental Plan": row.dentalPlanLabel,
    "Vision Plan": row.visionPlanLabel,
    "HSA Amount": row.rawEnrollmentData?.hsa_amount || 0,
    "Employer-Paid Life Eligible (Yes/No)": row.rawEmployeeData?.employer_life ? 'Yes' : 'No'
  }));
  const ws = XLSX.utils.json_to_sheet(data);
  // Styling: header + zebra rows (enterprise look)
  const range = XLSX.utils.decode_range(ws["!ref"]);
  for (let R = range.s.r; R <= range.e.r; ++R) {
    for (let C = range.s.c; C <= range.e.c; ++C) {
      const addr = XLSX.utils.encode_cell({ r: R, c: C });
      const cell = ws[addr];
      if (!cell) continue;
      if (R === 0) {
        // Header row
        cell.s = {
          font: {
            name: "Calibri",
            sz: 11,
            bold: true,
            color: { rgb: "FFFFFF" },
          },
          alignment: {
            horizontal: "center",
            vertical: "center",
            wrapText: true,
          },
          fill: { fgColor: { rgb: "003366" } },
          border: {
            top: { style: "thin", color: { rgb: "D1D5DB" } },
            bottom: { style: "thin", color: { rgb: "D1D5DB" } },
            left: { style: "thin", color: { rgb: "D1D5DB" } },
            right: { style: "thin", color: { rgb: "D1D5DB" } },
          },
        };
      } else {
        // Data rows
        cell.s = cell.s || {};
        cell.s.font = { name: "Calibri", sz: 10 };
        cell.s.alignment = {
          horizontal: typeof cell.v === "number" ? "right" : "left",
          vertical: "center",
          wrapText: true,
        };
        cell.s.border = {
          top: { style: "thin", color: { rgb: "D1D5DB" } },
          bottom: { style: "thin", color: { rgb: "D1D5DB" } },
          left: { style: "thin", color: { rgb: "D1D5DB" } },
          right: { style: "thin", color: { rgb: "D1D5DB" } },
        };
        // Zebra stripe
        if (R % 2 === 1) {
          cell.s.fill = { fgColor: { rgb: "F3F4F6" } };
        }
        if (typeof cell.v === "number") {
          cell.z = "$#,##0.00";
        }
      }
    }
  }
  // Freeze header
  ws["!freezes"] = { ySplit: 1 };
  // Add filters
  ws["!autofilter"] = { ref: "A1:U1" };
  // Auto-fit columns
  ws["!cols"] = [
    { wch: 12 },
    { wch: 15 },
    { wch: 15 },
    { wch: 15 },
    { wch: 15 },
    { wch: 15 },
    { wch: 12 },
    { wch: 12 },
    { wch: 30 },
    { wch: 15 },
    { wch: 10 },
    { wch: 10 },
    { wch: 12 },
    { wch: 25 },
    { wch: 15 },
    { wch: 20 },
    { wch: 20 },
    { wch: 20 },
    { wch: 10 },
    { wch: 25 },
    { wch: 20 }
  ];
  XLSX.utils.book_append_sheet(wb, ws, "2026 Full Census");
  const filename = `jengchi_full_census_2026.xlsx`;
  XLSX.writeFile(wb, filename);
  showToast({
    title: "Export complete",
    message: "Full census workbook downloaded.",
    type: "success",
  });
}
function renderComprehensiveReportGrid(data) {
    const tbody = document.getElementById("reportBody");
     // Fix: Added null check
    if (!tbody) return;
    tbody.innerHTML = '';
    if (!data.length) {
        tbody.innerHTML = '<tr><td colspan="15" class="px-4 py-4 text-center text-xs text-slate-500">No 2026 enrollment records found.</td></tr>';
        return;
    }
    data.forEach(d => {
        const row = `
            <tr class="hover:bg-slate-50" data-id="${d.enrollmentId}" data-fk="${d.employee_id_fk}">
                <td class="px-3 py-2.5 font-semibold text-slate-900">${esc(d.employeeName)}</td>
                <td class="px-3 py-2.5 text-xs text-slate-700">
                    ${esc(d.jobTitle || 'N/A')}<br>
                    <span class="font-mono text-[11px]">${formatCurrency(d.annualSalary)}</span>
                </td>
                <td class="px-3 py-2.5 text-xs text-slate-600">
                    ${esc(d.phone ? formatPhone(d.phone) : 'N/A')}<br>
                    ${esc(d.address || 'N/A')}
                </td>
                <td class="px-3 py-2.5 text-xs font-mono text-slate-700">${esc(d.ssn)}</td>
                <td class="px-3 py-2.5 text-xs font-semibold">${esc(d.tier)}</td>
                <td class="px-3 py-2.5 text-xs text-slate-700">
                    <span class="pill-badge bg-red-50 text-red-700">${esc(d.medPlanLabel)}</span>
                </td>
                <td class="px-3 py-2.5 text-xs text-right font-mono text-xs">${formatCurrency(d.medBi)}</td>
                <td class="px-3 py-2.5 text-xs text-slate-700">
                    <span class="pill-badge bg-blue-50 text-blue-700">${esc(d.dentalPlanLabel)}</span>
                </td>
                <td class="px-3 py-2.5 text-xs text-right">
                    ${formatCurrency(d.denBi)}
                </td>
                <td class="px-3 py-2.5 text-xs text-slate-700">
                    <span class="pill-badge bg-slate-100 text-slate-700">${esc(d.visionPlanLabel)}</span>
                </td>
                <td class="px-3 py-2.5 text-xs text-right">
                    ${formatCurrency(d.visBi)}
                </td>
                <td class="px-3 py-2.5 text-right font-bold text-slate-900">${formatCurrency(d.totalBi)}</td>
                <td class="px-3 py-2.5 text-xs text-slate-700 max-w-xs whitespace-normal">${esc(d.dependentsSummary)}</td>
                <td class="px-3 py-2.5 text-center">
                    ${d.lifeDesignated === 'Yes' ?
                        '<i class="fa-solid fa-check text-emerald-600"></i>' :
                        '<i class="fa-solid fa-times text-red-500"></i>'}
                </td>
                <td class="px-3 py-2.5 text-xs">
                    <button class="text-[color:var(--jc-red)] hover:underline" onclick="openEmployeeModal(${d.enrollmentId})">Edit/View</button>
                </td>
            </tr>
        `;
        tbody.insertAdjacentHTML("beforeend", row);
    });
}
/* === EMPLOYEE MODAL LOGIC (NEW) === */
 // ------------------------ EMPLOYEE MODAL (DETAILS / ELECTIONS) ------------------------
  const employeeModal = document.getElementById("employeeModal");
  const employeeModalTitle = document.getElementById("employeeModalTitle");
  const employeeModalContent = document.getElementById("modalContent");
  const employeeModalStatus = document.getElementById("modalStatus");
  const employeeModalCloseBtn = document.getElementById("modalClose");
  const employeeModalSaveBtn = document.getElementById("modalSaveEmployee");
  let employeeModalCurrentTab = "details";
  let employeeModalTabsInitialized = false;
  function closeEmployeeModal() {
    if (!employeeModal) return;
    employeeModal.classList.add("hidden");
    employeeModal.classList.remove("flex");
    currentEditingEnrollment = null;
  }
  if (employeeModalCloseBtn) {
    employeeModalCloseBtn.addEventListener("click", closeEmployeeModal);
  }
  if (employeeModal) {
    // close when clicking the dark backdrop
    employeeModal.addEventListener("click", (e) => {
      if (e.target === employeeModal) {
        closeEmployeeModal();
      }
    });
  }
  function initEmployeeModalTabs() {
    if (employeeModalTabsInitialized) return;
    employeeModalTabsInitialized = true;
    document
      .querySelectorAll("#employeeModal [data-tab]")
      .forEach((btn) => {
        btn.addEventListener("click", () => {
          const tab = btn.getAttribute("data-tab");
          if (!tab) return;
          renderEmployeeModalSection(tab);
        });
      });
  }
  function renderEmployeeModalSection(tab) {
    if (!currentEditingEnrollment || !employeeModalContent) return;
    employeeModalCurrentTab = tab;
    const rec = currentEditingEnrollment;
    const emp = rec.rawEmployeeData || {};
    const enr = rec.rawEnrollmentData || {};
    // Highlight nav buttons
    document
      .querySelectorAll("#employeeModal [data-tab]")
      .forEach((btn) => {
        const btnTab = btn.getAttribute("data-tab");
        if (btnTab === tab) {
          btn.classList.add("bg-slate-100", "font-semibold");
        } else {
          btn.classList.remove("bg-slate-100", "font-semibold");
        }
      });
    // ---- TAB: Personal & Employment ----
    if (tab === "details") {
      employeeModalContent.innerHTML = `
        <div class="space-y-4 text-sm">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">First name</label>
              <input type="text" disabled
                     class="w-full rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm"
                     value="${esc(rec.first_name || emp.first_name || "")}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Last name</label>
              <input type="text" disabled
                     class="w-full rounded-md border border-slate-200 bg-slate-50 px-3 py-2 text-sm"
                     value="${esc(rec.last_name || emp.last_name || "")}" />
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Job title</label>
              <input id="empJobTitleInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(rec.job_title || enr.job_title || emp.job_title || "")}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Status</label>
              <select id="empStatusSelect"
                      class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                ${["ACTIVE", "LOA", "SEASONAL", "TERMINATED"].map((opt) => {
                  const v = (rec.employment_status || enr.employment_status || emp.employment_status || "ACTIVE").toUpperCase();
                  const selected = v === opt ? "selected" : "";
                  return `<option value="${opt}" ${selected}>${opt}</option>`;
                }).join("")}
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Original hire date</label>
              <input id="empHireDateInput" type="date"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${(rec.original_hire_date || enr.hire_date || emp.original_hire_date || "").slice(0,10)}" />
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Annual salary</label>
              <input id="empSalaryInput" type="number" min="0" step="500"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${rec.annual_salary || enr.annual_salary || emp.annual_salary || ""}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Hourly rate</label>
              <input id="empHourlyRateInput" type="number" min="0" step="0.25"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${emp.hourly_rate || ""}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Primary phone</label>
              <input id="empPhoneInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(enr.phone || emp.primary_phone || "")}" />
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Street address</label>
              <input id="empAddressInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(rec.address_line_1 || enr.address?.street || emp.address_line_1 || "")}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">City</label>
              <input id="empCityInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(rec.city || enr.address?.city || emp.city || "")}" />
            </div>
          </div>
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">State</label>
              <input id="empStateInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(rec.state || enr.address?.state || emp.state || "")}" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">ZIP code</label>
              <input id="empZipInput" type="text"
                     class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm"
                     value="${esc(rec.zip_code || enr.address?.zip || emp.zip_code || "")}" />
            </div>
          </div>
        </div>
      `;
      return;
    }
    // ---- TAB: Benefit Elections ----
    if (tab === "elections") {
      const tierVal = enr.tier_election || rec.tier_election || "EO";
      const medCode = enr.medical_plan || "WAIVE";
      const denCode = enr.dental_plan || "WAIVE";
      const visCode = enr.vision_plan || "WAIVE";
      employeeModalContent.innerHTML = `
        <div class="space-y-4 text-sm">
          <div class="grid md:grid-cols-2 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Tier election</label>
              <select id="empTierSelect"
                      class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                ${["EO","ES","EC","EF"].map((opt) =>
                  `<option value="${opt}" ${tierVal === opt ? "selected" : ""}>${opt}</option>`
                ).join("")}
              </select>
            </div>
          </div>
          <div class="grid md:grid-cols-3 gap-4">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Medical plan</label>
              <select id="empMedPlanSelect"
                      class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                ${["WAIVE","ATBCB402","ATBAB303","ATBAP393"].map((code) =>
                  `<option value="${code}" ${medCode === code ? "selected" : ""}>${esc(prettyPlanName("medical", code))}</option>`
                ).join("")}
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Dental plan</label>
              <select id="empDentalPlanSelect"
                      class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                ${["WAIVE","F_PLAN_2W","F_PLAN_3W"].map((code) =>
                  `<option value="${code}" ${denCode === code ? "selected" : ""}>${esc(prettyPlanName("dental", code))}</option>`
                ).join("")}
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">Vision plan</label>
              <select id="empVisionPlanSelect"
                      class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                ${["WAIVE","PLAN_1"].map((code) =>
                  `<option value="${code}" ${visCode === code ? "selected" : ""}>${esc(prettyPlanName("vision", code))}</option>`
                ).join("")}
              </select>
            </div>
          </div>
        </div>
      `;
      return;
    }
    // ---- TAB: Family & Dependents (read-only) ----
    if (tab === "family") {
      const dependentsSummary =
        Array.isArray(enr.dependents) && enr.dependents.length
          ? enr.dependents
              .map((d) => {
                const name = [d.first, d.last].filter(Boolean).join(" ");
                return d.relationship ? `${name} (${d.relationship})` : name;
              })
              .join("; ")
          : "None on file";
      const lifeDesignated =
        Array.isArray(enr.beneficiaries) && enr.beneficiaries.length ? "Yes" : "No";
      employeeModalContent.innerHTML = `
        <div class="space-y-4 text-sm">
          <div>
            <p class="text-xs font-semibold text-slate-700 mb-1">Dependents on file</p>
            <p class="text-xs text-slate-700 border border-slate-200 rounded-md px-3 py-2 bg-slate-50 min-h-[44px]">
              ${esc(dependentsSummary)}
            </p>
          </div>
          <div>
            <p class="text-xs font-semibold text-slate-700 mb-1">Life / AD&D beneficiary designation</p>
            <p class="text-xs text-slate-700 border border-slate-200 rounded-md px-3 py-2 bg-slate-50">
              ${lifeDesignated === "Yes"
                ? "Beneficiaries on file for this employee."
                : "No beneficiary designation on file."}
            </p>
          </div>
          <p class="text-[11px] text-slate-500">
            Editing of dependents and beneficiary details can be done in a separate workflow
            or carrier form. This tab is read-only in the Executive Census view.
          </p>
        </div>
      `;
      return;
    }
    // ---- TAB: Change History (informational) ----
    if (tab === "history") {
      employeeModalContent.innerHTML = `
        <div class="space-y-2 text-xs text-slate-600">
          <p>
            Detailed per-employee change history is tracked at the session level via the
            portal audit log. Use the <span class="font-semibold">Audit Logs</span> tab
            to see activity, including when this employee's 2026 enrollment was edited.
          </p>
          <p class="text-[11px] text-slate-500">
            Later we can add a dedicated <code>employee_change_logs</code> table if you
            want a permanent, per-employee timeline.
          </p>
        </div>
      `;
    }
  }
  // Expose modal opener globally (for inline onclick in the grid)
  window.openEmployeeModal = async function(enrollmentId) {
  const idNum = Number(enrollmentId);
 
  // Find in allEmployees first (Employee List tab)
  let rec = allEmployees.find(r => Number(r.id) === idNum);
 
  // Fallback to comprehensiveData (Reports tab)
  if (!rec) {
    rec = comprehensiveData.find(d => Number(d.enrollmentId) === idNum);
  }
 
  if (!rec) {
    showToast({title: "Error", message: "Employee record not found", type: "error"});
    return;
  }
 
  currentEditingEnrollment = rec;
  initEmployeeModalTabs();
 
  // Set title
  const titleEl = document.getElementById("employeeModalTitle");
  if (titleEl) {
    const lastName = rec.last_name || rec.employeeName?.split(', ')[0] || '';
    const firstName = rec.first_name || rec.employeeName?.split(', ')[1] || '';
    titleEl.textContent = `${lastName}, ${firstName} — 2026 Elections`;
  }
 
  // Render first tab
  renderEmployeeModalSection("details");
 
  // Show modal
  const modal = document.getElementById("employeeModal");
  if (modal) {
    modal.classList.remove("hidden");
    modal.classList.add("flex");
  }
};
function switchModalTab(key) {
  document.querySelectorAll('.tab-section').forEach(el => el.classList.add('hidden'));
  const activeTab = document.getElementById(`modal-tab-${key}`);
  if (activeTab) activeTab.classList.remove('hidden');
  if (key === 'history') loadEmployeeChangeHistory(currentEditingEnrollment.employee_id_fk);
}
async function openEmployeeModal(enrollmentId) {
  let enrollment = comprehensiveData.find(d => d.enrollmentId === enrollmentId);
  if (!enrollment) {
    try {
      const { data: enrData } = await supabase
        .from('benefit_enrollments')
        .select('*')
        .eq('id', enrollmentId)
        .single();
      const username = enrData.username;
      const { data: empData } = await supabase
        .from('employees2025')
        .select('*')
        .eq('username', username)
        .single();
      const tier = enrData.tier_election || "EO";
      const medPlanCode = enrData.medical_plan || "WAIVE";
      const dentalPlanCode = enrData.dental_plan || "WAIVE";
      const visionPlanCode = enrData.vision_plan || "WAIVE";
      const medBi = getRateAmount(2026, "medical", tier, medPlanCode);
      const denBi = getRateAmount(2026, "dental", tier, dentalPlanCode);
      const visBi = getRateAmount(2026, "vision", tier, visionPlanCode);
      const totalBi = medBi + denBi + visBi;
      const employeeName = empData ? `${empData.last_name}, ${empData.first_name}` : (enrData.full_name || enrData.username || "Unknown");
      const jobTitle = enrData.job_title || (empData && empData.job_title) || "";
      const employmentStatus = enrData.employment_status || (empData && empData.employment_status) || "";
      const salary = enrData.annual_salary || (empData && empData.annual_salary) || null;
      const hourlyRate = empData && empData.hourly_rate ? Number(empData.hourly_rate) : null;
      const hireDate = enrData.hire_date || (empData && empData.original_hire_date) || null;
      const rawPhone = enrData.phone || (empData && (empData.primary_phone || empData.phone)) || "";
      const phone = rawPhone;
      const email = enrData.email || (empData && empData.email) || "";
      let addressParts = [];
      let city = "";
      let state = "";
      let zip = "";
      if (enrData.address && typeof enrData.address === "object") {
        const addr = enrData.address;
        if (addr.street || addr.address_line_1) {
          addressParts.push(addr.street || addr.address_line_1);
        }
        if (addr.address_line_2) addressParts.push(addr.address_line_2);
        city = addr.city || "";
        state = addr.state || "";
        zip = addr.zip || "";
        const cityStateZip = [city, state, zip].filter(Boolean).join(" ");
        if (cityStateZip) addressParts.push(cityStateZip);
      } else if (empData) {
        if (empData.address_line_1) addressParts.push(empData.address_line_1);
        if (empData.address_line_2) addressParts.push(empData.address_line_2);
        city = empData.city || "";
        state = empData.state || "";
        zip = empData.zip_code || "";
        const cityStateZip = [city, state, zip].filter(Boolean).join(" ");
        if (cityStateZip) addressParts.push(cityStateZip);
      }
      const fullAddress = addressParts.join(", ");
      const rawSSN = (enrData.ssn || (empData && empData.sssn) || "").replace(/\D/g, "");
      const ssnFormatted = rawSSN ? formatSSN(rawSSN) : "N/A";
      const dependentsSummary = Array.isArray(enrData.dependents) && enrData.dependents.length ? enrData.dependents.map(d => {
        const name = [d.first, d.last].filter(Boolean).join(" ");
        return d.relationship ? `${name} (${d.relationship})` : name;
      }).join("; ") : "None";
      const lifeDesignated = Array.isArray(enrData.beneficiaries) && enrData.beneficiaries.length > 0 ? "Yes" : "No";
      enrollment = {
        enrollmentId: enrData.id,
        employeeName,
        jobTitle,
        employmentStatus,
        salary,
        hourlyRate,
        hireDate,
        phone,
        email,
        address: fullAddress,
        city,
        state,
        zip,
        ssn: ssnFormatted,
        tier,
        medPlanCode,
        medPlanLabel: prettyPlanName("medical", medPlanCode),
        medBi,
        dentalPlanCode,
        dentalPlanLabel: prettyPlanName("dental", dentalPlanCode),
        denBi,
        visionPlanCode,
        visionPlanLabel: prettyPlanName("vision", visionPlanCode),
        visBi,
        totalBi,
        annualTotal: totalBi * 26,
        dependentsSummary,
        lifeDesignated,
        rawEmployeeData: empData,
        rawEnrollmentData: enrData,
        employee_id_fk: empData ? empData.id : null,
      };
    } catch (err) {
      console.error('Fetch enrollment error:', err);
      showToast({title: "Load Error", message: "Failed to load enrollment data.", type: "error"});
      return;
    }
  }
  if (!enrollment) {
    showToast({title: "Error", message: "Enrollment record not found.", type: "error"});
    return;
  }
  currentEditingEnrollment = enrollment;
  employeeModalTitle.textContent = `${enrollment.employeeName} — Enrollment Details`;
  const detailsHtml = renderDetailsTabHtml();
  const electionsHtml = renderElectionsTabHtml();
  const familyHtml = renderFamilyTabHtml();
  const historyHtml = renderHistoryTabHtml();
  modalContent.innerHTML = `
    <div id="modal-tab-details" class="tab-section">${detailsHtml}</div>
    <div id="modal-tab-elections" class="tab-section hidden">${electionsHtml}</div>
    <div id="modal-tab-family" class="tab-section hidden">${familyHtml}</div>
    <div id="modal-tab-history" class="tab-section hidden">${historyHtml}</div>
  `;
  attachModalListeners();
  employeeModal.classList.remove('hidden');
  employeeModal.classList.add('flex');
  switchModalTab('details');
}
function attachModalListeners() {
  ['modal-tier', 'modal-med-plan', 'modal-den-plan', 'modal-vis-plan'].forEach(id => {
    const el = document.getElementById(id);
    if (el) el.addEventListener('change', recalc);
  });
  recalc();
  document.getElementById('addDependent')?.addEventListener('click', addDependentRow);
  document.getElementById('addBeneficiary')?.addEventListener('click', addBeneficiaryRow);
  modalContent.addEventListener('click', e => {
    if (e.target.matches('.remove-dependent')) e.target.closest('.dependent-row').remove();
    if (e.target.matches('.remove-beneficiary')) e.target.closest('.beneficiary-row').remove();
  });
}
function renderDetailsTabHtml() {
  const d = currentEditingEnrollment;
  return `
    <div class="space-y-4">
      <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Employment & Personal Data</h4>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Full Name</label>
          <input id="modal-full-name" type="text" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.employeeName)}" disabled>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Job Title</label>
          <input id="modal-job-title" type="text" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.jobTitle || '')}">
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Annual Salary</label>
          <input id="modal-salary" type="number" step="0.01" class="w-full rounded-md px-3 py-2 border text-sm" value="${d.annualSalary || ''}">
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">SSN (Full)</label>
          <input id="modal-ssn" type="text" class="w-full rounded-md px-3 py-2 border text-sm font-mono" value="${esc(d.ssn || '')}">
        </div>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="modalHireDate" class="block text-xs font-medium text-slate-600 uppercase tracking-wide">Hire Date</label>
          <input id="modalHireDate" type="date" class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-[var(--jc-navy)] focus:ring-[var(--jc-navy)]" value="${d.hireDate ? d.hireDate.slice(0, 10) : ''}" />
        </div>
        <div>
          <label for="modalEmploymentStatus" class="block text-xs font-medium text-slate-600 uppercase tracking-wide">Employment Status</label>
          <select id="modalEmploymentStatus" class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm bg-white focus:border-[var(--jc-navy)] focus:ring-[var(--jc-navy)]">
            <option value="ACTIVE" ${d.employmentStatus === 'ACTIVE' ? 'selected' : ''}>Active</option>
            <option value="INACTIVE" ${d.employmentStatus === 'INACTIVE' ? 'selected' : ''}>Inactive</option>
            <option value="TERMINATED" ${d.employmentStatus === 'TERMINATED' ? 'selected' : ''}>Terminated</option>
            <option value="ON_LEAVE" ${d.employmentStatus === 'ON_LEAVE' ? 'selected' : ''}>On Leave</option>
          </select>
        </div>
        <div></div>
      </div>
      <h4 class="text-lg font-semibold text-slate-800 border-b pb-2 pt-4">Contact Information</h4>
      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Phone</label>
          <input id="modal-phone" type="tel" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.phone || '')}">
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Email</label>
          <input id="modal-email" type="email" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.email || '')}">
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Address Line 1</label>
        <input id="modal-address" type="text" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.rawEmployeeData?.address_line_1 || '')}">
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
        <div>
          <label for="modalCity" class="block text-xs font-medium text-slate-600 uppercase tracking-wide">City</label>
          <input id="modalCity" type="text" class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-[var(--jc-navy)] focus:ring-[var(--jc-navy)]" value="${esc(d.city || '')}" />
        </div>
        <div>
          <label for="modalState" class="block text-xs font-medium text-slate-600 uppercase tracking-wide">State</label>
          <input id="modalState" type="text" maxlength="2" class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-[var(--jc-navy)] focus:ring-[var(--jc-navy)]" value="${esc(d.state || 'TX')}" />
        </div>
        <div>
          <label for="modalZip" class="block text-xs font-medium text-slate-600 uppercase tracking-wide">ZIP Code</label>
          <input id="modalZip" type="text" class="mt-1 block w-full rounded-md border border-slate-200 px-3 py-2 text-sm focus:border-[var(--jc-navy)] focus:ring-[var(--jc-navy)]" value="${esc(d.zip || '')}" />
        </div>
      </div>
    </div>
  `;
}
function renderElectionsTabHtml() {
  const d = currentEditingEnrollment;
  const enr = d.rawEnrollmentData;
  return `
    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">
      Plan Elections (2026)
    </h4>
    <div class="space-y-4">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">
          Coverage Tier
        </label>
        <select id="modal-tier" class="w-full rounded-md px-3 py-2 border text-sm">
          <option value="EO" ${d.tier === "EO" ? "selected" : ""}>Employee Only (EO)</option>
          <option value="ES" ${d.tier === "ES" ? "selected" : ""}>Employee + Spouse (ES)</option>
          <option value="EC" ${d.tier === "EC" ? "selected" : ""}>Employee + Child(ren) (EC)</option>
          <option value="EF" ${d.tier === "EF" ? "selected" : ""}>Employee + Family (EF)</option>
        </select>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        ${renderPlanSelect("Medical", "med", enr?.medical_plan)}
        ${renderPlanSelect("Dental", "den", enr?.dental_plan)}
        ${renderPlanSelect("Vision", "vis", enr?.vision_plan)}
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">
          Life Plan
        </label>
        <select id="modal-life-plan" class="w-full rounded-md px-3 py-2 border text-sm">
          <option value="WAIVE" ${d.lifeDesignated === 'No' ? "selected" : ""}>Waive Coverage</option>
          <option value="YES" ${d.lifeDesignated === 'Yes' ? "selected" : ""}>Employer Paid Life</option>
        </select>
      </div>
    </div>
    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2 pt-4">
      Cost Summary
    </h4>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm font-mono mt-2">
      <div>Med Cost: <span id="modal-med-cost">${formatCurrency(d.medBi)}</span></div>
      <div>Den Cost: <span id="modal-den-cost">${formatCurrency(d.denBi)}</span></div>
      <div>Vis Cost: <span id="modal-vis-cost">${formatCurrency(d.visBi)}</span></div>
      <div class="font-bold text-slate-900">
        Total Bi-Wkly: <span id="modal-total-cost">${formatCurrency(d.totalBi)}</span>
      </div>
      <div class="col-span-2 md:col-span-4 text-xs text-slate-600">
        Annual (×26): <span id="modal-annual-cost">${formatCurrency(d.annualTotal)}</span>
      </div>
    </div>
  `;
  // hook up live recalculation
  const recalc = async () => {
    // FIX: Using RATES cache data to prevent excessive Supabase lookups
    await ensureBenefitRatesLoaded();
    const tier = document.getElementById("modal-tier")?.value || "EO";
    const medPlanCode = document.getElementById("modal-med-plan")?.value || "WAIVE";
    const denPlanCode = document.getElementById("modal-den-plan")?.value || "WAIVE";
    const visPlanCode = document.getElementById("modal-vis-plan")?.value || "WAIVE";
    const med = getRateAmount(2026, "medical", tier, medPlanCode);
    const den = getRateAmount(2026, "dental", tier, denPlanCode);
    const vis = getRateAmount(2026, "vision", tier, visPlanCode);
    const total = med + den + vis;
    const annual = total * 26;
    document.getElementById("modal-med-cost").textContent = formatCurrency(med);
    document.getElementById("modal-den-cost").textContent = formatCurrency(den);
    document.getElementById("modal-vis-cost").textContent = formatCurrency(vis);
    document.getElementById("modal-total-cost").textContent = formatCurrency(total);
    document.getElementById("modal-annual-cost").textContent= formatCurrency(annual);
    // Update currentEditingEnrollment in-memory (CRITICAL for save handler)
    currentEditingEnrollment.medPlanCode = medPlanCode;
    currentEditingEnrollment.denPlanCode = denPlanCode;
    currentEditingEnrollment.visPlanCode = visPlanCode;
    currentEditingEnrollment.tier = tier;
    currentEditingEnrollment.medBi = med;
    currentEditingEnrollment.denBi = den;
    currentEditingEnrollment.visBi = vis;
    currentEditingEnrollment.totalBi = total;
    currentEditingEnrollment.annualTotal = annual;
  };
  ["modal-tier", "modal-med-plan", "modal-den-plan", "modal-vis-plan"].forEach((id) => {
    const el = document.getElementById(id);
    if (el) el.addEventListener("change", recalc);
  });
  // initial calculation
  recalc().catch(console.error);
}
function renderPlanSelect(label, key, selectedPlanCode) {
    const options = [
        { code: 'WAIVE', name: 'Waive Coverage' },
    ];
    if (label === 'Medical') options.push(
        { code: 'ATBAB303', name: 'HMO / ATBAB303' },
        { code: 'ATBAP393', name: 'HMO HSA / ATBAP393' },
        { code: 'ATBCB402', name: 'PPO / ATBCB402' },
    );
    if (label === 'Dental') options.push(
        { code: 'F_PLAN_2W', name: 'F-PLAN 2W / Base MAC' },
        { code: 'F_PLAN_3W', name: 'F-PLAN 3W / Buy Up MAC' },
    );
    if (label === 'Vision') options.push(
        { code: 'PLAN_1', name: 'Vision Plan 1' },
    );
    const optionHtml = options.map(opt =>
        `<option value="${opt.code}" ${opt.code === selectedPlanCode ? 'selected' : ''}>${opt.name}</option>`
    ).join('');
    return `
        <div>
            <label class="block text-xs font-semibold text-slate-700 mb-1">${label} Plan</label>
            <select id="modal-${key}-plan" class="w-full rounded-md px-3 py-2 border text-sm">
                ${optionHtml}
            </select>
        </div>
    `;
}
// CHANGE: Added dynamic add for beneficiaries and dependents
function renderFamilyTab() {
    const enr = currentEditingEnrollment.rawEnrollmentData;
    const d = currentEditingEnrollment;
 
    // Spouse/Partner Details
    let spouseHtml = '';
    const spouse = enr.spouse || {};
    spouseHtml = `
      <div class="rounded-lg border border-slate-200 bg-slate-50 p-4 space-y-2">
        <h5 class="font-semibold text-sm">Spouse / Partner</h5>
        <div class="grid grid-cols-3 gap-2">
          <input type="text" placeholder="First Name" class="border rounded px-2 py-1 text-xs spouse-first" value="${esc(spouse.first || '')}">
          <input type="text" placeholder="Last Name" class="border rounded px-2 py-1 text-xs spouse-last" value="${esc(spouse.last || '')}">
          <input type="date" placeholder="DOB" class="border rounded px-2 py-1 text-xs spouse-dob" value="${spouse.dob || ''}">
        </div>
        <input type="text" placeholder="SSN" class="w-full border rounded px-2 py-1 text-xs font-mono spouse-ssn" value="${esc(spouse.ssn || '')}">
      </div>
    `;
    // Dependents Details
    let dependentsHtml = '';
    if (Array.isArray(enr.dependents) && enr.dependents.length > 0) {
      dependentsHtml = enr.dependents.map((dep, index) => `
        <div class="dependent-row rounded-lg border border-slate-200 bg-white p-4 space-y-2" data-index="${index}">
          <h5 class="font-semibold text-sm">Dependent ${index + 1} (${esc(dep.relationship || 'Child')})</h5>
          <div class="grid grid-cols-3 gap-2">
            <input type="text" placeholder="First Name" class="border rounded px-2 py-1 text-xs" value="${esc(dep.first)}">
            <input type="text" placeholder="Last Name" class="border rounded px-2 py-1 text-xs" value="${esc(dep.last)}">
            <input type="date" placeholder="DOB" class="border rounded px-2 py-1 text-xs" value="${dep.dob || ''}">
          </div>
          <div class="grid grid-cols-2 gap-2">
            <input type="text" placeholder="Relationship" class="border rounded px-2 py-1 text-xs" value="${esc(dep.relationship)}">
            <input type="text" placeholder="SSN" class="border rounded px-2 py-1 text-xs font-mono" value="${esc(dep.ssn)}">
          </div>
          <button class="text-red-600 hover:underline text-xs remove-dependent">Remove</button>
        </div>
      `).join('');
    } else {
      dependentsHtml = `<p class="text-sm text-slate-500">No dependent children enrolled.</p>`;
    }
    // Beneficiaries Details
    let beneficiariesHtml = '';
    if (Array.isArray(enr.beneficiaries) && enr.beneficiaries.length > 0) {
      beneficiariesHtml = enr.beneficiaries.map((bene, index) => `
        <div class="beneficiary-row rounded-lg border border-slate-200 bg-slate-50 p-4 space-y-2" data-index="${index}">
          <h5 class="font-semibold text-sm">${bene.role || 'Primary'} Beneficiary ${index + 1}</h5>
          <div class="grid grid-cols-3 gap-2">
            <input type="text" placeholder="First Name" class="border rounded px-2 py-1 text-xs" value="${esc(bene.first)}">
            <input type="text" placeholder="Last Name" class="border rounded px-2 py-1 text-xs" value="${esc(bene.last)}">
            <input type="text" placeholder="% Share" class="border rounded px-2 py-1 text-xs" value="${bene.pct || ''}">
          </div>
          <input type="text" placeholder="Relationship" class="w-full border rounded px-2 py-1 text-xs" value="${esc(bene.relationship)}">
          <button class="text-red-600 hover:underline text-xs remove-beneficiary">Remove</button>
        </div>
      `).join('');
    } else {
      beneficiariesHtml = `<p class="text-sm text-slate-500">No beneficiaries designated.</p>`;
    }
    modalContent.innerHTML = `
        <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Family Enrollment Snapshot</h4>
        ${spouseHtml}
        <h4 class="text-lg font-semibold text-slate-800 border-b pb-2 pt-4">Children/Other Dependents</h4>
        <div id="dependentsContainer" class="space-y-3">${dependentsHtml}</div>
        <button id="addDependent" class="mt-2 text-blue-600 hover:underline text-xs">+ Add Dependent</button>
        <h4 class="text-lg font-semibold text-slate-800 border-b pb-2 pt-4">Life & AD&D Beneficiaries</h4>
        <div id="beneficiariesContainer" class="space-y-3">${beneficiariesHtml}</div>
        <button id="addBeneficiary" class="mt-2 text-blue-600 hover:underline text-xs">+ Add Beneficiary</button>
        <p class="text-xs text-red-600 mt-4">Note: To fully edit dependent/beneficiary SSNs or names, please contact HR/Payroll directly. This portal provides read/write access to core employee enrollment data only.</p>
    `;
    // Dynamic add/remove handlers
    document.getElementById('addDependent').addEventListener('click', addDependentRow);
    document.getElementById('addBeneficiary').addEventListener('click', addBeneficiaryRow);
    document.querySelectorAll('.remove-dependent').forEach(btn => btn.addEventListener('click', removeRow));
    document.querySelectorAll('.remove-beneficiary').forEach(btn => btn.addEventListener('click', removeRow));
}
function addDependentRow() {
  const container = document.querySelector('#modal-tab-family #dependentsContainer');
  const index = container.querySelectorAll('.dependent-row').length;
  const newRow = `
    <div class="dependent-row rounded-lg border border-slate-200 bg-white p-4 space-y-2" data-index="${index}">
      <h5 class="font-semibold text-sm">Dependent ${index + 1} (Child)</h5>
      <div class="grid grid-cols-3 gap-2">
        <input type="text" placeholder="First Name" class="border rounded px-2 py-1 text-xs">
        <input type="text" placeholder="Last Name" class="border rounded px-2 py-1 text-xs">
        <input type="date" placeholder="DOB" class="border rounded px-2 py-1 text-xs">
      </div>
      <div class="grid grid-cols-2 gap-2">
        <input type="text" placeholder="Relationship" class="border rounded px-2 py-1 text-xs" value="Child">
        <input type="text" placeholder="SSN" class="border rounded px-2 py-1 text-xs font-mono">
      </div>
      <button class="text-red-600 hover:underline text-xs remove-dependent">Remove</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', newRow);
}
function addBeneficiaryRow() {
  const container = document.querySelector('#modal-tab-family #beneficiariesContainer');
  const index = container.querySelectorAll('.beneficiary-row').length;
  const newRow = `
    <div class="beneficiary-row rounded-lg border border-slate-200 bg-slate-50 p-4 space-y-2" data-index="${index}">
      <h5 class="font-semibold text-sm">Primary Beneficiary ${index + 1}</h5>
      <div class="grid grid-cols-3 gap-2">
        <input type="text" placeholder="First Name" class="border rounded px-2 py-1 text-xs">
        <input type="text" placeholder="Last Name" class="border rounded px-2 py-1 text-xs">
        <input type="text" placeholder="% Share" class="border rounded px-2 py-1 text-xs" value="100">
      </div>
      <input type="text" placeholder="Relationship" class="w-full border rounded px-2 py-1 text-xs">
      <button class="text-red-600 hover:underline text-xs remove-beneficiary">Remove</button>
    </div>
  `;
  container.insertAdjacentHTML('beforeend', newRow);
}
function removeRow(e) {
  const row = e.target.closest('[data-index]');
  row.remove();
}
function renderHistoryTab() {
  if (!currentEditingEnrollment) return;
  modalContent.innerHTML = `
    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">
      Enrollment Change History
    </h4>
    <p class="text-xs text-slate-600 mt-1">
      Every time you click <strong>Save Changes</strong> in this modal, a row is written to
      <span class="font-mono">employee_history</span>.
    </p>
    <div class="mt-3 border border-slate-200 rounded-lg overflow-hidden">
      <table class="w-full text-xs">
        <thead class="bg-slate-50 text-slate-500">
          <tr>
            <th class="text-left px-3 py-2.5">When</th>
            <th class="text-left px-3 py-2.5">Who</th>
            <th class="text-left px-3 py-2.5">Type</th>
            <th class="text-left px-3 py-2.5">Field / Change</th>
          </tr>
        </thead>
        <tbody id="changeHistoryBody">
          <tr>
            <td colspan="4" class="px-3 py-3 text-center text-slate-500">
              Loading change history...
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  `;
  loadEmployeeChangeHistory(currentEditingEnrollment.employee_id_fk);
}
async function loadEmployeeChangeHistory(employeeId) {
  const tbody = document.getElementById("changeHistoryBody");
  if (!tbody) return;
  tbody.innerHTML = `
    <tr>
      <td colspan="4" class="px-3 py-3 text-center text-xs text-slate-500">
        Loading change history...
      </td>
    </tr>
  `;
  try {
    // Select changed_by field from employee_history
    const { data, error } = await supabase
      .from("employee_history")
      .select(`
        changed_at,
        changed_by,
        field,
        old_value,
        new_value,
        action
      `)
      .eq("employee_id", employeeId)
      .order("changed_at", { ascending: false });
    if (error) throw error;
    if (!data || !data.length) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-3 text-center text-xs text-slate-500">
            No changes recorded yet for this employee.
          </td>
        </tr>
      `;
      return;
    }
    tbody.innerHTML = data
      .map((row) => {
        const when = new Date(row.changed_at).toLocaleString("en-US", {
          timeZone: "America/Chicago",
          dateStyle: "short",
          timeStyle: "short",
        });
     
        // Use changed_by which should be initials/name of the portal user
        const who = row.changed_by || "System";
        const actionType = row.action || "UPDATE";
        return `
          <tr class="border-b border-slate-100">
            <td class="px-3 py-2.5 whitespace-nowrap">${esc(when)}</td>
            <td class="px-3 py-2.5 whitespace-nowrap">${esc(who)}</td>
            <td class="px-3 py-2.5 whitespace-nowrap">${esc(actionType)}</td>
            <td class="px-3 py-2.5">
              <div class="font-semibold text-slate-800">${esc(row.field || "")}</div>
              <div class="text-slate-600 mt-0.5">
                "${esc(row.old_value || "—")}" → "${esc(row.new_value || "—")}"
              </div>
            </td>
          </tr>
        `;
      })
      .join("");
  } catch (err) {
    console.error("Error loading change history:", err);
    tbody.innerHTML = `
      <tr>
        <td colspan="4" class="px-3 py-3 text-center text-xs text-red-600">
          Error loading change history.
        </td>
      </tr>
    `;
  }
}
// Global Save Handler
modalSaveEmployee.addEventListener('click', async () => {
  if (!currentEditingEnrollment) return;
  const enrId = currentEditingEnrollment.enrollmentId;
  const empIdFk = currentEditingEnrollment.employee_id_fk;
  if (!currentUser || currentUser.role !== "admin") {
    showToast({title: "Unauthorized", message: "Only administrators can save employee changes.", type: "error"});
    return;
  }
  const ssnInput = document.getElementById("modal-ssn");
  const salaryInput = document.getElementById("modal-salary");
  const newAnnualSalary = parseFloat(salaryInput?.value.replace(/[$,]/g, '')) || 0;
  const updatedEmployeeFields = {
    sssn: ssnInput ? ssnInput.value.trim().replace(/-/g, "") : (currentEditingEnrollment.ssn || "").replace(/-/g, ""),
    job_title: document.getElementById("modal-job-title")?.value.trim() || currentEditingEnrollment.jobTitle,
    primary_phone: document.getElementById("modal-phone")?.value.trim() || currentEditingEnrollment.phone,
    annual_salary: newAnnualSalary,
    address_line_1: document.getElementById("modal-address")?.value.trim() || currentEditingEnrollment.rawEmployeeData?.address_line_1,
    city: document.getElementById("modalCity")?.value.trim() || currentEditingEnrollment.city,
    state: document.getElementById("modalState")?.value.trim() || currentEditingEnrollment.state,
    zip_code: document.getElementById("modalZip")?.value.trim() || currentEditingEnrollment.zip,
    original_hire_date: document.getElementById("modalHireDate")?.value || currentEditingEnrollment.hireDate,
    employment_status: document.getElementById("modalEmploymentStatus")?.value || currentEditingEnrollment.employmentStatus,
    hourly_rate: newAnnualSalary / 2080,
  };
  const updatedEnrollmentFields = {
    tier_election: currentEditingEnrollment.tier,
    medical_plan: currentEditingEnrollment.medPlanCode,
    dental_plan: currentEditingEnrollment.denPlanCode,
    vision_plan: currentEditingEnrollment.visPlanCode,
    email: document.getElementById("modal-email")?.value.trim() || currentEditingEnrollment.email,
    address: {
      street: updatedEmployeeFields.address_line_1,
      city: updatedEmployeeFields.city,
      state: updatedEmployeeFields.state,
      zip: updatedEmployeeFields.zip_code
    },
    job_title: updatedEmployeeFields.job_title,
    annual_salary: updatedEmployeeFields.annual_salary,
    hire_date: updatedEmployeeFields.original_hire_date,
    employment_status: updatedEmployeeFields.employment_status,
    updated_at: new Date().toISOString(),
    dependents: collectDependents(),
    beneficiaries: collectBeneficiaries(),
    spouse: collectSpouse()
  };
  const normalizePlan = (p) => (p === "WAIVE" ? null : p);
  updatedEnrollmentFields.medical_plan = normalizePlan(updatedEnrollmentFields.medical_plan);
  updatedEnrollmentFields.dental_plan = normalizePlan(updatedEnrollmentFields.dental_plan);
  updatedEnrollmentFields.vision_plan = normalizePlan(updatedEnrollmentFields.vision_plan);
  const empChanges = [];
  const enrChanges = [];
  const currentEmp = currentEditingEnrollment.rawEmployeeData || {};
  const currentEnr = currentEditingEnrollment.rawEnrollmentData || {};
  const logChange = (field, oldVal, newVal, bucket) => {
    if (String(oldVal ?? "") !== String(newVal ?? "")) bucket.push({ field, old: oldVal, new: newVal });
  };
  logChange("sssn", String(currentEmp.sssn || "").replace(/\D/g, ''), String(updatedEmployeeFields.sssn || "").replace(/\D/g, ''), empChanges);
  logChange("job_title", currentEmp.job_title, updatedEmployeeFields.job_title, empChanges);
  logChange("primary_phone", currentEmp.primary_phone, updatedEmployeeFields.primary_phone, empChanges);
  logChange("annual_salary", currentEditingEnrollment.annualSalary, updatedEmployeeFields.annual_salary, empChanges);
  logChange("address_line_1", currentEmp.address_line_1, updatedEmployeeFields.address_line_1, empChanges);
  logChange("city", currentEmp.city, updatedEmployeeFields.city, empChanges);
  logChange("state", currentEmp.state, updatedEmployeeFields.state, empChanges);
  logChange("zip_code", currentEmp.zip_code, updatedEmployeeFields.zip_code, empChanges);
  logChange("original_hire_date", currentEmp.original_hire_date, updatedEmployeeFields.original_hire_date, empChanges);
  logChange("employment_status", currentEmp.employment_status, updatedEmployeeFields.employment_status, empChanges);
  logChange("tier_election", currentEnr.tier_election, updatedEnrollmentFields.tier_election, enrChanges);
  logChange("medical_plan", currentEnr.medical_plan, updatedEnrollmentFields.medical_plan, enrChanges);
  logChange("dental_plan", currentEnr.dental_plan, updatedEnrollmentFields.dental_plan, enrChanges);
  logChange("vision_plan", currentEnr.vision_plan, updatedEnrollmentFields.vision_plan, enrChanges);
  logChange("email", currentEnr.email, updatedEnrollmentFields.email, enrChanges);
  const allChanges = [...empChanges, ...enrChanges];
  if (!allChanges.length) {
    showToast({title: "No Change", message: "No fields were modified. Save cancelled.", type: "info"});
    employeeModal.classList.add("hidden");
    return;
  }
  try {
    const { error: empError } = await supabase.from("employees2025").update(updatedEmployeeFields).eq("id", empIdFk);
    if (empError) throw empError;
    const { error: enrError } = await supabase.from("benefit_enrollments").update(updatedEnrollmentFields).eq("id", enrId);
    if (enrError) throw enrError;
    const historyRows = allChanges.map(c => ({
      employee_id: empIdFk,
      changed_at: new Date().toISOString(),
      changed_by: currentUser.full_name,
      field: c.field,
      old_value: String(c.old ?? "—"),
      new_value: String(c.new ?? "—"),
      action: c.field.includes("_plan") || c.field.includes("tier") ? "ELECTION_UPDATE" : "DEMO_UPDATE",
    }));
    const { error: histError } = await supabase.from("employee_history").insert(historyRows);
    if (histError) console.warn("History insert failed:", histError);
    employeeModal.classList.add("hidden");
    await Promise.all([loadComprehensiveReportData(), load2026EmployeeList()]);
    showToast({title: "Saved", message: `${currentEditingEnrollment.employeeName} updated with ${allChanges.length} changes.`, type: "success"});
  } catch (err) {
    console.error("Employee Save Error:", err);
    showToast({title: "Save Failed", message: "Error updating Supabase.", type: "error"});
  }
});
// CHANGE: Added functions to collect dynamic dependents and beneficiaries
function collectDependents() {
  const rows = document.querySelectorAll('#dependentsContainer .dependent-row');
  return Array.from(rows).map(row => ({
    first: row.querySelector('input[placeholder="First Name"]').value.trim(),
    last: row.querySelector('input[placeholder="Last Name"]').value.trim(),
    dob: row.querySelector('input[type="date"]').value,
    relationship: row.querySelector('input[placeholder="Relationship"]').value.trim(),
    ssn: row.querySelector('input[placeholder="SSN"]').value.trim().replace(/\D/g, '')
  })).filter(d => d.first || d.last);
}
function collectBeneficiaries() {
  const rows = document.querySelectorAll('#beneficiariesContainer .beneficiary-row');
  return Array.from(rows).map(row => ({
    first: row.querySelector('input[placeholder="First Name"]').value.trim(),
    last: row.querySelector('input[placeholder="Last Name"]').value.trim(),
    pct: parseInt(row.querySelector('input[placeholder="% Share"]').value) || 0,
    relationship: row.querySelector('input[placeholder="Relationship"]').value.trim(),
    role: 'Primary' // Default, can add select later
  })).filter(b => b.first || b.last);
}
// CHANGE: Added spouse collection
function collectSpouse() {
  const first = document.querySelector('.spouse-first')?.value.trim() || '';
  const last = document.querySelector('.spouse-last')?.value.trim() || '';
  const dob = document.querySelector('.spouse-dob')?.value || '';
  const ssn = document.querySelector('.spouse-ssn')?.value.trim().replace(/\D/g, '') || '';
  if (!first && !last) return null;
  return { first, last, dob, ssn };
}
// CHANGE: Added report tab filters and auto-load
document.addEventListener('DOMContentLoaded', () => {
  // Auto-load on tab activate
  if (tabReports) {
    tabReports.addEventListener('click', () => {
      if (comprehensiveData.length === 0) {
        loadComprehensiveReportData();
      } else {
        applyReportFiltersAndRender();
      }
    });
    const costWatchIds = [
  'modalTier',
  'modalMedicalPlan',
  'modalDentalPlan',
  'modalVisionPlan',
  'modalLifeOption',
];
costWatchIds.forEach(id => {
  const el = document.getElementById(id);
  if (el) {
    el.addEventListener('change', updateModalPlanCosts);
  }
});
  }
  //
  // Report filters
  const reportFilterElements = ['reportFilterEmploymentStatus', 'reportFilterMedicalPlan', 'reportFilterDentalPlan', 'reportFilterTier'];
  reportFilterElements.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.addEventListener('change', applyReportFiltersAndRender);
    }
  });
  const reportClearBtn = document.getElementById('reportClearFilters');
  if (reportClearBtn) {
    reportClearBtn.addEventListener('click', () => {
      reportFilterElements.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      applyReportFiltersAndRender();
    });
  }
});
function collectDependentsFromModal() {
  const rows = document.querySelectorAll('#modalDependentsTable tbody tr.dependent-row');
  const result = [];
  rows.forEach(tr => {
    const first = tr.querySelector('.dep-first')?.value.trim() || '';
    const last = tr.querySelector('.dep-last')?.value.trim() || '';
    const dob = tr.querySelector('.dep-dob')?.value.trim() || '';
    const ssn = tr.querySelector('.dep-ssn')?.value.trim() || '';
    const rel = tr.querySelector('.dep-rel')?.value.trim() || '';
    if (first || last || dob || ssn || rel) {
      result.push({ first_name: first, last_name: last, dob, ssn_last4: ssn, relationship: rel });
    }
  });
  return result;
}
function collectBeneficiariesFromModal() {
  const rows = document.querySelectorAll('#modalBeneficiariesTable tbody tr.bene-row');
  const result = [];
  rows.forEach(tr => {
    const first = tr.querySelector('.bene-first')?.value.trim() || '';
    const last = tr.querySelector('.bene-last')?.value.trim() || '';
    const dob = tr.querySelector('.bene-dob')?.value.trim() || '';
    const ssn = tr.querySelector('.bene-ssn')?.value.trim() || '';
    const rel = tr.querySelector('.bene-rel')?.value.trim() || '';
    if (first || last || dob || ssn || rel) {
      result.push({ first_name: first, last_name: last, dob, ssn_last4: ssn, relationship: rel });
    }
  });
  return result;
}
  async function saveEmployeeChanges() {
  if (!currentEditingEnrollment) {
    showToast({title: "Error", message: "No employee selected", type: "error"});
    return;
  }
  const rec = currentEditingEnrollment;
  const emp = rec.rawEmployeeData || {};
  const enr = rec.rawEnrollmentData || {};
  try {
    showToast({title: "Saving...", message: "Updating records...", type: "info"});
    // Collect form values safely
    const jobTitle = document.getElementById("empJobTitleInput")?.value?.trim() || "";
    const status = document.getElementById("empStatusSelect")?.value || "ACTIVE";
    const hireDate = document.getElementById("empHireDateInput")?.value || null;
    const salary = parseFloat(document.getElementById("empSalaryInput")?.value) || null;
    const phone = document.getElementById("empPhoneInput")?.value?.trim() || "";
    const tier = document.getElementById("empTierSelect")?.value || "EO";
    const medPlan = document.getElementById("empMedPlanSelect")?.value || "WAIVE";
    const dentalPlan = document.getElementById("empDentalPlanSelect")?.value || "WAIVE";
    const visionPlan = document.getElementById("empVisionPlanSelect")?.value || "WAIVE";
    // Update employees2025
    if (rec.employee_id_fk) {
      const { error } = await supabase
        .from("employees2025")
        .update({
          job_title: jobTitle || null,
          employment_status: status,
          original_hire_date: hireDate || null,
          annual_salary: salary,
          primary_phone: phone || null
        })
        .eq("id", rec.employee_id_fk);
      if (error) throw error;
    }
    // Update benefit_enrollments
    const { error } = await supabase
      .from("benefit_enrollments")
      .update({
        job_title: jobTitle || null,
        employment_status: status,
        hire_date: hireDate || null,
        annual_salary: salary,
        phone: phone || null,
        tier_election: tier,
        medical_plan: medPlan,
        dental_plan: dentalPlan,
        vision_plan: visionPlan
      })
      .eq("id", rec.id);
   
    if (error) throw error;
    // Update in-memory data
    rec.job_title = jobTitle;
    rec.employment_status = status;
    rec.tier_election = tier;
    rec.medical_plan = prettyPlanName("medical", medPlan);
    rec.dental_plan = prettyPlanName("dental", dentalPlan);
    rec.vision_plan = prettyPlanName("vision", visionPlan);
    // Refresh grid
    applyFiltersAndRender();
   
    showToast({title: "Saved", message: "Employee updated successfully", type: "success"});
    closeEmployeeModal();
  } catch (err) {
    console.error("Save error:", err);
    showToast({title: "Save failed", message: err.message, type: "error"});
  }
}
function applyReportFiltersAndRender() {
  const status = document.getElementById('reportFilterEmploymentStatus')?.value || '';
  const med = document.getElementById('reportFilterMedicalPlan')?.value || '';
  const dental = document.getElementById('reportFilterDentalPlan')?.value || '';
  const tier = document.getElementById('reportFilterTier')?.value || '';
  let filtered = comprehensiveData;
  if (status) {
    filtered = filtered.filter(d => d.employmentStatus === status);
  }
  if (med) {
    filtered = filtered.filter(d => d.medPlanCode === med);
  }
  if (dental) {
    filtered = filtered.filter(d => d.dentalPlanCode === dental);
  }
  if (tier) {
    filtered = filtered.filter(d => d.tier === tier);
  }
  renderComprehensiveTable(filtered);
}
// Permissions Tab Load
async function loadPermissionsTab() {
  const tbody = document.getElementById("permissionsBody");
  tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';
  try {
    const { data, error } = await supabase
      .from("portal_users")
      .select("id, full_name, initials, role, allowed_tabs")
      .order("full_name", { ascending: true });
    if (error) throw error;
const tabs = ['docs', 'summary', 'comparison', 'elections', 'audit', 'users']; // 'reports' removed
    tbody.innerHTML = "";
    (data || []).forEach(u => {
      const isAdmin = u.role === 'admin';
      const allowed = u.allowed_tabs || (isAdmin ? tabs : ['docs']);
      const checkboxes = tabs.map(tab => `
        <td class="px-4 py-2.5 text-center">
          <input type="checkbox" data-user="${u.id}" data-tab="${tab}" ${allowed.includes(tab) ? 'checked' : ''} ${isAdmin ? 'disabled' : ''}>
        </td>
      `).join('');
      tbody.insertAdjacentHTML('beforeend', `
        <tr class="hover:bg-slate-50">
          <td class="px-4 py-2.5">${esc(u.full_name)}</td>
          <td class="px-4 py-2.5">${esc(u.initials)}</td>
          ${checkboxes}
        </tr>
      `);
    });
    portalUsersCache = data || [];
    const permissionsBody = document.getElementById("permissionsBody");
if (permissionsBody) {
  permissionsBody.addEventListener("change", async (e) => {
    const checkbox = e.target.closest("input[type='checkbox']");
    if (!checkbox) return;
    const userId = Number(checkbox.dataset.user);
    const tabKey = checkbox.dataset.tab;
    const isChecked = checkbox.checked;
    // 🔐 Safety: make sure we have a cache
    if (!Array.isArray(portalUsersCache) || !portalUsersCache.length) {
      await loadPortalUsers(); // this fills portalUsersCache
    }
    const user = portalUsersCache.find(u => u.id === userId);
    if (!user) return;
    const tabs = new Set(user.allowed_tabs || []);
    if (isChecked) {
      tabs.add(tabKey);
    } else {
      tabs.delete(tabKey);
    }
    const newAllowed = Array.from(tabs);
    try {
      const { error } = await supabase
        .from("portal_users")
        .update({ allowed_tabs: newAllowed })
        .eq("id", userId);
      if (error) throw error;
      // ✅ update local cache copy
      user.allowed_tabs = newAllowed;
      showToast({
        title: "Permissions updated",
        message: `${user.full_name} now has access to: ${
          newAllowed.length ? newAllowed.join(", ") : "Signed Documents only"
        }`,
        type: "success",
      });
    } catch (err) {
      console.error("Permissions update failed", err);
      showToast({
        title: "Update failed",
        message: "We couldn't save that permission change.",
        type: "error",
      });
      checkbox.checked = !isChecked; // revert
    }
  });
}
 
    // Add change listener
    tbody.querySelectorAll('input[type="checkbox"]').forEach(chk => {
      chk.addEventListener('change', async (e) => {
        const userId = e.target.dataset.user;
        const tab = e.target.dataset.tab;
        const checked = e.target.checked;
        try {
          const { data: user } = await supabase
            .from('portal_users')
            .select('allowed_tabs')
            .eq('id', userId)
            .single();
          let allowed = user.allowed_tabs || [];
          if (checked) {
            if (!allowed.includes(tab)) allowed.push(tab);
          } else {
            allowed = allowed.filter(t => t !== tab);
          }
          const { error } = await supabase
            .from('portal_users')
            .update({ allowed_tabs: allowed })
            .eq('id', userId);
          if (error) throw error;
          showToast({title: "Updated", message: "Permission saved.", type: "success"});
        } catch (err) {
          console.error('Permission update error', err);
          e.target.checked = !checked; // revert
          showToast({title: "Error", message: "Failed to update permission.", type: "error"});
        }
      });
    });
  } catch (err) {
    console.error('Load permissions error', err);
    tbody.innerHTML = '<tr><td colspan="9" class="px-4 py-4 text-center text-xs text-red-500">Error loading users.</td></tr>';
  }
}
// --- HOTFIX: Reports tab removed, so disable loadComprehensiveReportData ---
window.loadComprehensiveReportData = async function (showToast = true) {
  // Reports tab/table (#reportBody) no longer exists.
  // This no-op prevents '#reportBody not found' console errors.
  return;
};
});
// ------------------------ PERMISSIONS TAB ------------------------
  async function loadPermissionsTab() {
    const tbody = document.getElementById("permissionsBody");
    if (!tbody) return;
    tbody.innerHTML =
      '<tr><td colspan="9" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';
    try {
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, role, allowed_tabs")
        .order("full_name", { ascending: true });
      if (error) throw error;
      const tabs = ["docs", "summary", "comparison", "elections", "audit", "users", "reports"];
      tbody.innerHTML = "";
      (data || []).forEach((u) => {
        const isAdmin = u.role === "admin";
        const allowed = u.allowed_tabs || (isAdmin ? tabs : ["docs"]);
        const checkboxCells = tabs
          .map(
            (tab) => `
            <td class="px-4 py-2.5 text-center">
              <input
                type="checkbox"
                class="permission-checkbox"
                data-user="${u.id}"
                data-tab="${tab}"
                ${allowed.includes(tab) ? "checked" : ""}
              />
            </td>`
          )
          .join("");
        tbody.insertAdjacentHTML(
          "beforeend",
          `
          <tr class="hover:bg-slate-50 text-sm">
            <td class="px-4 py-2.5">${esc(u.full_name || "")}</td>
            <td class="px-4 py-2.5">${esc(u.initials || "")}</td>
            ${checkboxCells}
          </tr>`
        );
      });
      // Also refresh portalUsersCache so allowed_tabs stays in sync
      portalUsersCache = data || [];
    } catch (err) {
      console.error("Permissions load error", err);
      tbody.innerHTML =
        '<tr><td colspan="9" class="px-4 py-4 text-center text-xs text-red-500">Error loading permissions.</td></tr>';
    }
  }
  // When a permission checkbox is toggled, update portal_users.allowed_tabs
  const permissionsBodyEl = document.getElementById("permissionsBody");
  if (permissionsBodyEl) {
    permissionsBodyEl.addEventListener("change", async (e) => {
      const cb = e.target;
      if (!(cb instanceof HTMLInputElement)) return;
      if (cb.type !== "checkbox") return;
      const userId = Number(cb.dataset.user);
      const tabKey = cb.dataset.tab;
      if (!userId || !tabKey) return;
      const user = portalUsersCache.find((u) => u.id === userId);
      if (!user) return;
      // Only allow PG/JT (and admins) to actually change things
      if (!currentUser || (currentUser.role !== "admin" && !["PG", "JT"].includes(currentUser.initials))) {
        showToast({
          title: "Not allowed",
          message: "Only PG or JT can edit portal permissions.",
          type: "error",
        });
        cb.checked = !cb.checked;
        return;
      }
      let allowed = Array.isArray(user.allowed_tabs) ? [...user.allowed_tabs] : [];
      if (cb.checked) {
        if (!allowed.includes(tabKey)) allowed.push(tabKey);
      } else {
        allowed = allowed.filter((t) => t !== tabKey);
      }
      try {
        const { error } = await supabase
          .from("portal_users")
          .update({ allowed_tabs: allowed })
          .eq("id", userId);
        if (error) throw error;
        user.allowed_tabs = allowed; // keep cache in sync
        showToast({
          title: "Permissions updated",
          message: `Updated access for ${user.full_name}.`,
          type: "success",
        });
      } catch (err) {
        console.error("Update permissions error", err);
        showToast({
          title: "Update failed",
          message: "Could not update permissions. Reverting change.",
          type: "error",
        });
        cb.checked = !cb.checked; // revert UI
      }
    });
  }
// Small helpers
function escapeHtml(str) {
  if (str == null) return "";
  return String(str)
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#39;");
}
function renderModalChangeHistory() {
  const container = document.getElementById('modalChangeHistory');
  if (!container) return;
  const history = currentEditingEnrollment?.change_history;
  if (!Array.isArray(history) || !history.length) {
    container.innerHTML = '<p class="text-xs text-slate-500 italic">No changes recorded yet.</p>';
    return;
  }
  const html = history
    .slice()
    .reverse()
    .map(entry => {
      const who = entry.by_user || 'Unknown user';
      const when = entry.display || entry.at;
      const list = (entry.changes || [])
        .map(ch => {
          const before = escapeHtml(
            typeof ch.from === 'object' ? JSON.stringify(ch.from) : ch.from ?? ''
          );
          const after = escapeHtml(
            typeof ch.to === 'object' ? JSON.stringify(ch.to) : ch.to ?? ''
          );
          return `<li class="leading-snug">
              <span class="font-medium">${escapeHtml(ch.label)}:</span>
              <span class="ml-1">"${before}" → "${after}"</span>
            </li>`;
        })
        .join('');
      return `
        <div class="border border-slate-200 rounded-lg p-3 bg-slate-50">
          <div class="text-[11px] text-slate-600 mb-1">
            <span class="font-semibold">${escapeHtml(who)}</span>
            <span class="mx-1">•</span>
            <span>${escapeHtml(when)}</span>
          </div>
          <ul class="text-[11px] text-slate-700 space-y-0.5">
            ${list}
          </ul>
        </div>
      `;
    })
    .join('');
  container.innerHTML = html;
}
if (employeeModalSaveBtn) {
  employeeModalSaveBtn.removeEventListener("click", saveEmployeeChanges); // Remove duplicates
  employeeModalSaveBtn.addEventListener("click", saveEmployeeChanges);
}
// ✅ CRITICAL: Fix filters
function initEmployeeFilters() {
  const filterIds = ['employeeSearch', 'filterTier', 'filterMed', 'filterDental', 'filterLife', 'filterCity'];
  filterIds.forEach(id => {
    const el = document.getElementById(id);
    if (el) {
      el.removeEventListener('input', applyFiltersAndRender);
      el.removeEventListener('change', applyFiltersAndRender);
      el.addEventListener('input', applyFiltersAndRender);
      el.addEventListener('change', applyFiltersAndRender);
    }
  });
 
  const clearBtn = document.getElementById('clearFilters');
  if (clearBtn) {
    clearBtn.removeEventListener('click', clearFiltersHandler);
    clearBtn.addEventListener('click', () => {
      filterIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = '';
      });
      applyFiltersAndRender();
    });
  }
}
// Initialize after DOM loads
document.addEventListener('DOMContentLoaded', initEmployeeFilters);
const exportToExcel = async () => {
  if (!allEmployees || allEmployees.length === 0) {
    showToast({
      title: "No Data",
      message: "There are no employee records to export.",
      type: "error",
    });
    return;
  }

  const workbook = new ExcelJS.Workbook();
  workbook.creator = 'Jeng Chi Executive Benefits Portal';
  workbook.lastModifiedBy = currentUser ? currentUser.full_name : 'System';
  workbook.created = new Date();
  workbook.modified = new Date();

  const sheet = workbook.addWorksheet('2026 Employee Elections');

  // Add headers matching your table columns
  sheet.addRow([
    'Employee Name',
    'Job Title',
    'Status',
    'Annual Salary',
    'Hire Date',
    'Phone',
    'Address',
    'City',
    'ZIP Code',
    'Tier',
    'Medical Plan',
    'Dental Plan',
    'Vision Plan',
    'Life',
    'Actions'  // Optional, but included for completeness; can be omitted if not needed
  ]);

  // Add data rows from allEmployees (or filtered data if you have a filtered array)
  allEmployees.forEach(emp => {
    sheet.addRow([
      `${emp.last_name}, ${emp.first_name}`,
      emp.job_title || '—',
      emp.employment_status || 'ACTIVE',
      emp.annual_salary ? `$${emp.annual_salary.toLocaleString()}` : '—',
      emp.original_hire_date ? new Date(emp.original_hire_date).toLocaleDateString() : '—',
      formatPhone(emp.primary_phone) || '—',
      emp.address_line_1 || '—',
      emp.city || '—',
      emp.zip_code || '—',
      emp.tier_election || 'EO',
      emp.medical_plan || '—',
      emp.dental_plan || '—',
      emp.vision_plan || '—',
      emp.life_plan || '—',
      ''  // Actions column is empty in export
    ]);
  });

  // Add disclaimer rows at the bottom
  sheet.addRow([]);  // Empty row for spacing
  sheet.addRow([BENEFITS_DISCLAIMER_1]);
  sheet.addRow([BENEFITS_DISCLAIMER_2]);

  // Basic styling: bold headers, auto-width columns, zebra stripes
  sheet.getRow(1).font = { bold: true, color: { argb: 'FFFFFFFF' } };
  sheet.getRow(1).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FF003366' } };
  sheet.columns.forEach(column => {
    let maxLength = 0;
    column.eachCell({ includeEmpty: true }, cell => {
      const columnLength = cell.value ? cell.value.toString().length : 10;
      if (columnLength > maxLength) maxLength = columnLength;
    });
    column.width = maxLength < 10 ? 10 : maxLength + 2;
  });
  for (let i = 2; i <= sheet.rowCount; i++) {
    if (i % 2 === 0) {
      sheet.getRow(i).fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: 'FFF3F4F6' } };
    }
  }

  // Generate and save the file
  const buf = await workbook.xlsx.writeBuffer();
  const blob = new Blob([buf], { type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' });
  saveAs(blob, 'jeng-chi-2026-employee-elections.xlsx');

  showToast({
    title: "Export Complete",
    message: "2026 Employee Elections exported to Excel.",
    type: "success",
  });
};

document.getElementById('exportToExcel').addEventListener('click', exportToExcel);
</script>
</body>
</html>
