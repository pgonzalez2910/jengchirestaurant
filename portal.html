<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Jeng Chi ‚Äî Benefit Portal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
    <style>
        .font-\[Inter\] { font-family: 'Inter', sans-serif; }
        .spinner{border:4px solid #e5e7eb;border-top:4px solid #b9965a;border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite}
        @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
        .modal-bg{background:rgba(0,0,0,0.6)}
        /* Jeng Chi Gold Accent */
        .accent-gold{background:#B9965A;color:#fff}
        .accent-gold:hover{background:#a9874e}
        .accent-gold-text { color: #B9965A; }
    </style>
</head>

<body class="font-[Inter] bg-gray-50 text-gray-800 min-h-screen">
    <!-- Global Spinner -->
    <div id="spinnerOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
        <div class="bg-white rounded-xl p-6 flex flex-col items-center shadow-2xl">
            <div class="spinner mb-3"></div>
            <p class="text-gray-700 font-medium">Processing...</p>
        </div>
    </div>

    <!-- Custom Feedback/Prompt Modal (Replaces alert/confirm/prompt) -->
    <div id="feedbackModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative transform transition-all scale-100">
            <h3 id="feedbackModalTitle" class="text-xl font-semibold text-gray-800 mb-3 accent-gold-text"></h3>
            <p id="feedbackModalMessage" class="text-gray-600 mb-4"></p>
            <textarea id="feedbackModalPromptInput" class="hidden border border-gray-300 w-full p-2 rounded text-sm h-32 resize-none focus:outline-none focus:ring-2 focus:ring-[#B9965A] mb-4" placeholder="Enter selection..."></textarea>
            <div id="feedbackModalButtons" class="flex justify-end gap-3 mt-4">
                <!-- Buttons injected by JS -->
            </div>
        </div>
    </div>

    <!-- LOGIN -->
    <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
        <div class="bg-white rounded-2xl shadow-xl p-8 w-full max-w-sm text-center">
            <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="mx-auto w-24 mb-6 rounded-full border-4 border-[#B9965A] p-1" alt="Jeng Chi Logo" />
            <h2 class="text-2xl font-bold mb-6 text-gray-800">Benefit Portal Login</h2>
            <input id="username" type="text" placeholder="Username (e.g., PG)" class="border w-full p-3 rounded-lg mb-4 text-base focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
            <input id="pin" type="password" placeholder="PIN" class="border w-full p-3 rounded-lg mb-6 text-base focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
            <button id="loginBtn" class="w-full accent-gold font-semibold py-3 rounded-lg shadow-md hover:shadow-lg transition duration-150">Sign In</button>
            <p id="loginError" class="text-red-600 text-sm mt-4 hidden"></p>
        </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard" class="hidden max-w-7xl mx-auto px-4 sm:px-6 py-8">
        <header class="flex flex-col sm:flex-row justify-between items-center border-b border-gray-200 pb-4 mb-8">
            <div class="flex items-center gap-4 mb-4 sm:mb-0">
                <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="w-14 rounded-full border-2 border-[#B9965A]" alt="Jeng Chi Logo" />
                <div>
                    <h1 class="text-2xl font-bold accent-gold-text">Jeng Chi Restaurant</h1>
                    <p id="portalRole" class="text-sm text-gray-600"></p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div id="printContainer" class="relative hidden">
                    <button id="printMenuBtn" class="p-2 rounded-lg hover:bg-gray-200 flex items-center gap-2" title="Print Options">üñ®Ô∏è <span class="hidden sm:inline">Print</span></button>
                    <div id="printMenu" class="hidden absolute right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-xl z-40 w-52 overflow-hidden">
                        <button id="printAll" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition duration-100">Print All Documents</button>
                        <button id="printByEmployee" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100 transition duration-100">Print by Employee</button>
                    </div>
                </div>
                <button id="logoutBtn" class="accent-gold px-5 py-2 rounded-lg shadow-md transition duration-150">Logout</button>
            </div>
        </header>

        <!-- NAV -->
        <nav class="flex gap-3 mb-6 overflow-x-auto">
            <button id="tabDocs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap">Signed Documents</button>
            <button id="tabUsers" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap hidden">Authorized Users</button>
            <button id="tabLogs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium whitespace-nowrap hidden">Access Logs</button>
        </nav>

        <!-- DOCUMENTS SECTION (Available to all users) -->
        <section id="docsSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto">
            <h2 class="text-lg font-semibold text-gray-800 mb-4">Employee Signed Documents</h2>
            <table class="w-full min-w-[700px] text-sm">
                <thead>
                    <tr class="border-b text-gray-600 font-medium">
                        <th class="text-left py-2 px-1">First Name</th>
                        <th class="text-left px-1">Last Name</th>
                        <th class="text-left px-1">Username</th>
                        <th class="text-left px-1">PDF URL</th>
                    </tr>
                </thead>
                <tbody id="docBody">
                    <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading documents...</td></tr>
                </tbody>
            </table>
        </section>

        <!-- USERS SECTION (Admin only) -->
        <section id="usersSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto hidden">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-semibold text-gray-800">Authorized Users & Credentials</h2>
                <button id="addUser" class="accent-gold px-4 py-2 rounded-lg transition duration-150">+ Add User</button>
            </div>

            <table class="w-full min-w-[700px] text-sm">
                <thead>
                    <tr class="border-b text-gray-600 font-medium">
                        <th class="text-left py-2 px-1">Full Name</th>
                        <th class="text-left px-1">Username</th>
                        <th class="text-left px-1">PIN</th>
                        <th class="text-left px-1">Role</th>
                        <th class="text-left px-1">Actions</th>
                    </tr>
                </thead>
                <tbody id="userBody">
                    <tr><td colspan="5" class="text-center py-4 text-gray-400">Loading users...</td></tr>
                </tbody>
            </table>
        </section>

        <!-- LOGS SECTION (Admin only) -->
        <section id="logsSection" class="bg-white rounded-xl shadow-lg p-6 overflow-x-auto hidden">
            <h2 class="text-lg font-semibold mb-4 text-gray-800">Access Log History (Chicago CST)</h2>
            <table class="w-full min-w-[700px] text-sm">
                <thead>
                    <tr class="border-b text-gray-600 font-medium">
                        <th class="text-left py-2 px-1">Username</th>
                        <th class="text-left px-1">Login Time</th>
                        <th class="text-left px-1">Logout Time</th>
                        <th class="text-left px-1">Duration (min)</th>
                    </tr>
                </thead>
                <tbody id="logBody">
                    <tr><td colspan="4" class="text-center py-4 text-gray-400">No logs available</td></tr>
                </tbody>
            </table>
        </section>
    </div>

    <!-- USER MODAL (for Add/Edit User) -->
    <div id="userModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-md p-6 relative">
            <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
            <div class="space-y-3">
                <input id="modalFullName" type="text" placeholder="Full Name" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
                <input id="modalUsername" type="text" placeholder="Username (2-3 initials)" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
                <input id="modalPin" type="number" placeholder="PIN (4 digits)" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
                <select id="modalRole" class="border w-full p-2 rounded text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]">
                    <option value="user">Standard User</option>
                    <option value="admin">Administrator</option>
                </select>
            </div>
            <div class="flex justify-end gap-3 mt-6">
                <button id="modalCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition duration-150">Cancel</button>
                <button id="modalSave" class="px-4 py-2 rounded-lg accent-gold transition duration-150">Save</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA SIMULATION ---
        const EMPLOYEE_DATA = [
            // Note: I'm adding a 'role' field for portal access control.
            { id: 187, first_name: "Pablo", last_name: "Gonzalez", username: "PG", pin: "9367", signed_pdf_url: null, role: "admin" },
            { id: 3, first_name: "Shoko", last_name: "Teng", username: "ST", pin: "3764", signed_pdf_url: null, role: "user" },
            { id: 314, first_name: "Rony", last_name: "Carranza", username: "RC", pin: "5288", signed_pdf_url: "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/employee-pdfs/enrollment_pdfs/signed_314.pdf?t=1762899036085", role: "user" },
            { id: 298, first_name: "Wilson", last_name: "Sanchez", username: "WS", pin: "5657", signed_pdf_url: "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/employee-pdfs/enrollment_pdfs/signed_298.pdf?t=1762899552052", role: "user" },
            { id: 7572, first_name: "Jenifer", last_name: "Herring", username: "JH", pin: "7572", signed_pdf_url: null, role: "user" },
            { id: 1801, first_name: "Chang", last_name: "Li", username: "CL", pin: "3453", signed_pdf_url: null, role: "user" },
            { id: 8625, first_name: "Victor", last_name: "Solorzano", username: "VS", pin: "3739", signed_pdf_url: null, role: "user" },
            { id: 2010, first_name: "Eldin", last_name: "Vasquez", username: "EV", pin: "6293", signed_pdf_url: null, role: "user" },
            { id: 6442, first_name: "Nathan", last_name: "Leverett", username: "NL", pin: "6442", signed_pdf_url: null, role: "user" },
            { id: 9492, first_name: "Adriana", last_name: "Salinas", username: "AS", pin: "0302", signed_pdf_url: null, role: "user" },
            { id: 2443, first_name: "Hong", last_name: "Li", username: "HL", pin: "2371", signed_pdf_url: null, role: "user" },
            { id: 6245, first_name: "Lizbeth", last_name: "Carrera", username: "LC", pin: "6245", signed_pdf_url: null, role: "user" },
            { id: 6251, first_name: "Dilcia", last_name: "Vasquez", username: "DV", pin: "6251", signed_pdf_url: null, role: "user" },
            { id: 2444, first_name: "Yu", last_name: "Li", username: "YL", pin: "6195", signed_pdf_url: null, role: "user" },
            { id: 1021, first_name: "Xing", last_name: "Cheng", username: "XC", pin: "4559", signed_pdf_url: null, role: "user" },
            { id: 2003, first_name: "Procoro", last_name: "Tinoco", username: "PT", pin: "3989", signed_pdf_url: null, role: "user" },
            { id: 5237, first_name: "Maria", last_name: "Medina", username: "MM", pin: "9526", signed_pdf_url: null, role: "user" },
            { id: 2107, first_name: "Leydi", last_name: "Diaz", username: "LD", pin: "0907", signed_pdf_url: null, role: "user" },
            { id: 2105, first_name: "Anna", last_name: "Nichol", username: "AN", pin: "0718", signed_pdf_url: null, role: "user" },
            { id: 276, first_name: "Joshua", last_name: "Bathman", username: "JB", pin: "5387", signed_pdf_url: null, role: "user" },
            { id: 226, first_name: "Julio", last_name: "Mejia", username: "JM", pin: "4031", signed_pdf_url: null, role: "user" },
            { id: 1011, first_name: "Anh", last_name: "Mai Vu", username: "AM", pin: "9910", signed_pdf_url: null, role: "user" },
            { id: 254, first_name: "Craig", last_name: "Reeves", username: "CR", pin: "1038", signed_pdf_url: null, role: "user" },
            { id: 6265565, first_name: "Janelle", last_name: "Teng", username: "JT", pin: "9094", signed_pdf_url: null, role: "user" },
            { id: 9729, first_name: "Daniel", last_name: "Bracho", username: "DB", pin: "4608", signed_pdf_url: null, role: "user" },
            { id: 8890, first_name: "Fei", last_name: "Zheng", username: "FZ", pin: "8890", signed_pdf_url: null, role: "user" },
            { id: 8083, first_name: "Daira", last_name: "Aguilar", username: "DA", pin: "8083", role: "user" },
            { id: 2103, first_name: "Claribel", last_name: "Salinas", username: "CS", pin: "7542", signed_pdf_url: null, role: "user" },
            { id: 8295, first_name: "ALEX", last_name: "CHEN", username: "AC", pin: "8295", signed_pdf_url: null, role: "user" },
            { id: 3076, first_name: "Nate", last_name: "Munoz", username: "NM", pin: "3076", signed_pdf_url: null, role: "user" },
            { id: 4749, first_name: "Maryann", last_name: "Nguyen", username: "MN", pin: "4749", signed_pdf_url: null, role: "user" },
            { id: 9119, first_name: "Jacqueline", last_name: "StJohn", username: "JS", pin: "9119", signed_pdf_url: null, role: "user" },
            { id: 1010, first_name: "Paige", last_name: "Christensen", username: "PC", pin: "9094", signed_pdf_url: null, role: "user" },
            { id: 8788, first_name: "Adriane", last_name: "Davis", username: "AD", pin: "8788", signed_pdf_url: null, role: "user" },
            { id: 3456, first_name: "Thanh", last_name: "Duong", username: "TD", pin: "6456", signed_pdf_url: null, role: "user" },
            { id: 2006, first_name: "Minh", last_name: "Tran", username: "MT", pin: "7989", signed_pdf_url: null, role: "user" },
            { id: 2366, first_name: "Thi", last_name: "Truong", username: "TT", pin: "2366", signed_pdf_url: null, role: "user" },
            { id: 2104, first_name: "An", last_name: "Huang", username: "AH", pin: "7646", signed_pdf_url: null, role: "user" },
            { id: 306, first_name: "Jacob", last_name: "Lawson", username: "JL", pin: "7438", signed_pdf_url: null, role: "user" },
            { id: 261, first_name: "Ethan", last_name: "Tran", username: "ET", pin: "9596", signed_pdf_url: null, role: "user" },
            { id: 5626, first_name: "Joyanne", last_name: "Dyfoon", username: "JD", pin: "5626", signed_pdf_url: null, role: "user" },
            { id: 2442, first_name: "Keith", last_name: "Faulkner", username: "KF", pin: "6153", signed_pdf_url: null, role: "user" },
            { id: 251, first_name: "Qiu", last_name: "Zheng", username: "QZ", pin: "0157", signed_pdf_url: null, role: "user" },
            { id: 231, first_name: "Zhirui", last_name: "Song", username: "ZS", pin: "0866", signed_pdf_url: null, role: "user" },
            { id: 1499, first_name: "Rafael", last_name: "Damian", username: "RD", pin: "1499", signed_pdf_url: null, role: "user" },
            { id: 2008, first_name: "Nhat", last_name: "Tran", username: "NT", pin: "7479", signed_pdf_url: null, role: "user" },
            { id: 256, first_name: "Saul", last_name: "Garcia", username: "SG", pin: "3068", signed_pdf_url: null, role: "user" },
            { id: 4585568, first_name: "Francisco", last_name: "Teng", username: "FT", pin: "9094", signed_pdf_url: null, role: "user" },
            { id: 278, first_name: "Guadalupe", last_name: "Joaquin", username: "GJ", pin: "1479", signed_pdf_url: "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/employee-pdfs/enrollment_pdfs/signed_278.pdf?t=1762897641376", role: "user" }
        ];

        // Access logs (Simulated in memory)
        let ACCESS_LOGS = [];
        // Unique ID tracking for new users
        let nextUserId = 99999;
        
        // --- GLOBAL STATE ---
        let currentUser = null;
        const TIMEZONE = 'America/Chicago'; // CST/CDT
        const LOCALE = 'en-US';

        // --- UTILITY FUNCTIONS ---

        // HTML Escaping
        const esc = (t) => String(t ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

        // Time formatting
        const formatTime = (date) => date.toLocaleString(LOCALE, {
            timeZone: TIMEZONE,
            year: 'numeric', month: 'numeric', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: true
        });
        
        // Duration calculation
        const calculateDuration = (loginTime, logoutTime) => {
            if (!logoutTime) return 'Active';
            const diffMs = new Date(logoutTime) - new Date(loginTime);
            return (diffMs / (1000 * 60)).toFixed(1);
        };

        // Custom Modal Logic (Replaces alert, confirm, prompt)
        const fModal = document.getElementById('feedbackModal');
        const fTitle = document.getElementById('feedbackModalTitle');
        const fMessage = document.getElementById('feedbackModalMessage');
        const fInput = document.getElementById('feedbackModalPromptInput');
        const fButtons = document.getElementById('feedbackModalButtons');

        function showCustomModal(title, message, type = 'alert', promptPlaceholder = '') {
            return new Promise((resolve) => {
                fTitle.textContent = title;
                fMessage.innerHTML = message;
                fButtons.innerHTML = '';
                fInput.value = '';
                fInput.placeholder = promptPlaceholder;

                if (type === 'prompt') {
                    fInput.classList.remove('hidden');
                    fInput.focus();
                } else {
                    fInput.classList.add('hidden');
                }

                const setupButton = (text, className, action) => {
                    const btn = document.createElement('button');
                    btn.textContent = text;
                    btn.className = `px-4 py-2 rounded-lg shadow-sm transition duration-150 ${className}`;
                    btn.onclick = () => {
                        fModal.classList.add('hidden');
                        action();
                    };
                    fButtons.appendChild(btn);
                };

                if (type === 'confirm' || type === 'prompt') {
                    setupButton('Cancel', 'bg-gray-200 hover:bg-gray-300', () => resolve(type === 'confirm' ? false : null));
                }

                const primaryText = type === 'prompt' ? 'Select' : 'OK';
                setupButton(primaryText, 'accent-gold', () => {
                    if (type === 'prompt') {
                        resolve(fInput.value.trim());
                    } else if (type === 'confirm') {
                        resolve(true);
                    } else { // Alert
                        resolve(true);
                    }
                });

                fModal.classList.remove('hidden');
            });
        }

        const showAlert = (message, title = 'Notification') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'alert');
        const showConfirm = (message, title = 'Confirm Action') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'confirm');
        const showPrompt = (message, title = 'Input Required') => showCustomModal(title, message.replace(/\n/g, '<br>'), 'prompt', 'Enter selection...');
        
        // Spinner helpers
        const spinner = document.getElementById("spinnerOverlay");
        const showSpinner = () => spinner.classList.remove("hidden");
        const hideSpinner = () => spinner.classList.add("hidden");


        // --- TAB CONTROL ---
        const tabDocs = document.getElementById("tabDocs");
        const tabLogs = document.getElementById("tabLogs");
        const tabUsers = document.getElementById("tabUsers");
        const docsSection = document.getElementById("docsSection");
        const logsSection = document.getElementById("logsSection");
        const usersSection = document.getElementById("usersSection");

        function switchTab(tab) {
            // FIX: Removed incorrect chaining of .forEach() after classList.remove()
            [tabDocs, tabLogs, tabUsers].forEach(b => {
                b.classList.remove("bg-gray-900","text-white");
                b.classList.add("bg-gray-200","text-gray-800");
            });
            
            [docsSection, logsSection, usersSection].forEach(s => s.classList.add("hidden"));

            if (tab === "docs") {
                tabDocs.classList.add("bg-gray-900","text-white");
                tabDocs.classList.remove("bg-gray-200","text-gray-800");
                docsSection.classList.remove("hidden");
                loadDocs();
            } else if (tab === "logs" && currentUser.role === 'admin') {
                tabLogs.classList.add("bg-gray-900","text-white");
                tabLogs.classList.remove("bg-gray-200","text-gray-800");
                logsSection.classList.remove("hidden");
                loadLogs();
            } else if (tab === "users" && currentUser.role === 'admin') {
                tabUsers.classList.add("bg-gray-900","text-white");
                tabUsers.classList.remove("bg-gray-200","text-gray-800");
                usersSection.classList.remove("hidden");
                loadUsers();
            }
        }
        tabDocs.onclick = () => switchTab("docs");
        tabLogs.onclick = () => switchTab("logs");
        tabUsers.onclick = () => switchTab("users");


        // --- AUTHENTICATION & SESSION MANAGEMENT ---
        const loginScreen = document.getElementById("loginScreen");
        const dashboard = document.getElementById("dashboard");
        const loginBtn = document.getElementById("loginBtn");
        const logoutBtn = document.getElementById("logoutBtn");
        const loginError = document.getElementById("loginError");
        const printContainer = document.getElementById("printContainer");
        const portalRole = document.getElementById("portalRole");

        loginBtn.onclick = async () => {
            const u = document.getElementById("username").value.trim().toUpperCase();
            const p = document.getElementById("pin").value.trim();
            loginError.classList.add("hidden");
            showSpinner();

            // Simulate network delay
            await new Promise(r => setTimeout(r, 500));
            hideSpinner();

            const user = EMPLOYEE_DATA.find(e => e.username === u && String(e.pin) === p);

            if (user) {
                currentUser = { ...user, full_name: `${user.first_name} ${user.last_name}`, role: user.role || 'user' };
                localStorage.setItem("auth_user", JSON.stringify(currentUser));

                // Log login time
                ACCESS_LOGS.unshift({
                    username: currentUser.username,
                    login_time: new Date().toISOString(),
                    logout_time: null
                });

                showDashboard();
            } else {
                loginError.textContent = "Invalid username or PIN.";
                loginError.classList.remove("hidden");
            }
        };

        logoutBtn.onclick = () => {
            const user = JSON.parse(localStorage.getItem("auth_user") || "{}");

            // Log logout time
            const activeLog = ACCESS_LOGS.find(l => l.username === user.username && l.logout_time === null);
            if (activeLog) {
                activeLog.logout_time = new Date().toISOString();
            }

            currentUser = null;
            localStorage.removeItem("auth_user");
            loginScreen.classList.remove("hidden");
            dashboard.classList.add("hidden");
            // Clear input fields
            document.getElementById("username").value = '';
            document.getElementById("pin").value = '';
        };

        function showDashboard() {
            loginScreen.classList.add("hidden");
            dashboard.classList.remove("hidden");

            // Update UI based on role
            const isAdmin = currentUser.role === 'admin';
            portalRole.textContent = `Portal Access ‚Äî ${isAdmin ? 'Administrator' : 'Standard User'}`;

            if (isAdmin) {
                tabUsers.classList.remove("hidden");
                tabLogs.classList.remove("hidden");
                printContainer.classList.remove("hidden");
                switchTab("users"); // Admin default tab
            } else {
                tabUsers.classList.add("hidden");
                tabLogs.classList.add("hidden");
                printContainer.classList.add("hidden");
                switchTab("docs"); // Standard default tab
            }
        }

        // Check for existing session on load
        const storedUser = localStorage.getItem("auth_user");
        if (storedUser) {
            currentUser = JSON.parse(storedUser);
            showDashboard();
        }


        // --- DATA LOADERS ---

        function loadDocs() {
            const docBody = document.getElementById("docBody");
            docBody.innerHTML = "";
            
            // Filter documents that actually have a signed PDF URL
            const signedDocs = EMPLOYEE_DATA.filter(d => d.signed_pdf_url);
            
            if (signedDocs.length === 0) {
                docBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No signed documents available.</td></tr>`;
                return;
            }

            signedDocs.forEach(d => {
                docBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-1">${esc(d.first_name)}</td>
                        <td class="px-1">${esc(d.last_name)}</td>
                        <td class="px-1">${esc(d.username)}</td>
                        <td class="px-1"><a href="${esc(d.signed_pdf_url)}" target="_blank" class="text-blue-600 hover:underline">View PDF</a></td>
                    </tr>
                `);
            });
        }

        function loadUsers() {
            if (currentUser.role !== 'admin') return;

            const userBody = document.getElementById("userBody");
            userBody.innerHTML = "";

            if (EMPLOYEE_DATA.length === 0) {
                userBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-400">No authorized users found</td></tr>`;
                return;
            }

            EMPLOYEE_DATA.sort((a, b) => a.username.localeCompare(b.username)).forEach(u => {
                const fullName = `${u.first_name} ${u.last_name}`;
                userBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50" data-id="${u.id}">
                        <td class="py-2 px-1">${esc(fullName)}</td>
                        <td class="px-1">${esc(u.username)}</td>
                        <td class="px-1">${esc(u.pin)}</td>
                        <td class="px-1">${esc(u.role)}</td>
                        <td class="space-x-3 px-1">
                            <button class="text-blue-600 hover:underline js-edit">Edit</button>
                            <button class="text-red-600 hover:underline js-del">Delete</button>
                        </td>
                    </tr>
                `);
            });
        }

        function loadLogs() {
            if (currentUser.role !== 'admin') return;

            const logBody = document.getElementById("logBody");
            logBody.innerHTML = "";

            if (ACCESS_LOGS.length === 0) {
                logBody.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No access logs recorded.</td></tr>`;
                return;
            }

            ACCESS_LOGS.sort((a, b) => new Date(b.login_time) - new Date(a.login_time)).forEach(l => {
                const loginTimeCST = formatTime(new Date(l.login_time));
                const logoutTimeCST = l.logout_time ? formatTime(new Date(l.logout_time)) : 'Active';
                const duration = calculateDuration(l.login_time, l.logout_time);

                logBody.insertAdjacentHTML("beforeend", `
                    <tr class="border-b hover:bg-gray-50">
                        <td class="py-2 px-1">${esc(l.username)}</td>
                        <td class="px-1">${esc(loginTimeCST)}</td>
                        <td class="px-1">${esc(logoutTimeCST)}</td>
                        <td class="px-1">${duration}</td>
                    </tr>
                `);
            });
        }

        // --- PRINTING LOGIC ---
        const printMenuBtn = document.getElementById("printMenuBtn");
        const printMenu = document.getElementById("printMenu");

        printMenuBtn.onclick = () => printMenu.classList.toggle("hidden");
        document.addEventListener("click", (e) => {
            if (!printMenu.contains(e.target) && e.target !== printMenuBtn) printMenu.classList.add("hidden");
        });

        document.getElementById("printAll").onclick = async () => {
            printMenu.classList.add("hidden");
            const docsToPrint = EMPLOYEE_DATA.filter(d => d.signed_pdf_url);

            if (docsToPrint.length === 0) {
                return showAlert("No signed documents found to print.");
            }

            // Open all PDFs in new tabs
            docsToPrint.forEach(d => window.open(d.signed_pdf_url, "_blank"));
            showAlert(`Opened ${docsToPrint.length} document(s) in new tabs for printing.`, "Print Initiated");
        };

        document.getElementById("printByEmployee").onclick = async () => {
            printMenu.classList.add("hidden");
            const docsWithPDFs = EMPLOYEE_DATA.filter(d => d.signed_pdf_url);

            if (docsWithPDFs.length === 0) {
                return showAlert("No signed documents found.");
            }

            const choices = docsWithPDFs.map(d => `${d.first_name} ${d.last_name} (${d.username})`).sort();
            const choiceList = choices.map((c, i) => `[${i + 1}] ${c}`).join("\n");

            const selPrompt = `Select an employee by entering their name/username or the corresponding number.\n\n${choiceList}`;

            const selectedValue = await showPrompt(selPrompt, "Print by Employee");

            if (!selectedValue) return; // Cancelled or empty input

            let selectedUser;

            // Try to match by number index
            const index = parseInt(selectedValue);
            if (!isNaN(index) && index >= 1 && index <= choices.length) {
                selectedUser = choices[index - 1];
            } else {
                // Try to match by name or username (case-insensitive)
                selectedUser = choices.find(c => c.toLowerCase().includes(selectedValue.toLowerCase()));
            }


            if (!selectedUser) {
                return showAlert("Invalid selection. Please enter a valid name/username or number from the list.");
            }

            const usernameMatch = selectedUser.match(/\((.*?)\)/);
            if (!usernameMatch) return showAlert("Internal error: Could not parse username.");

            const targetUsername = usernameMatch[1];
            const documentsToPrint = EMPLOYEE_DATA.filter(d => d.username === targetUsername && d.signed_pdf_url);

            if (documentsToPrint.length === 0) {
                 return showAlert(`No signed documents found for **${selectedUser}**.`);
            }

            documentsToPrint.forEach(d => window.open(d.signed_pdf_url, "_blank"));
            showAlert(`Opened ${documentsToPrint.length} document(s) for **${selectedUser}** in new tabs.`, "Print Initiated");
        };

        // --- USER CRUD LOGIC ---

        const userBody = document.getElementById("userBody");
        userBody.addEventListener("click", async (e) => {
            if (currentUser.role !== 'admin') return;

            const row = e.target.closest("tr[data-id]");
            if (!row) return;
            const id = parseInt(row.dataset.id);
            const user = EMPLOYEE_DATA.find(u => u.id === id);
            if (!user) return;

            if (e.target.classList.contains("js-edit")) {
                openModal(user);
                return;
            }

            if (e.target.classList.contains("js-del")) {
                const fullName = `${user.first_name} ${user.last_name}`;
                const isConfirmed = await showConfirm(`Are you sure you want to delete the user: **${esc(fullName)} (${esc(user.username)})**?`);

                if (!isConfirmed) return;

                showSpinner();
                // Simulate Delete
                const index = EMPLOYEE_DATA.findIndex(u => u.id === id);
                if (index > -1) {
                    EMPLOYEE_DATA.splice(index, 1);
                    showAlert(`User **${esc(fullName)}** deleted successfully.`, "User Deleted");
                }
                
                // Update nextUserId if deleted user was the highest ID (less important for this sim)
                if (id === nextUserId - 1) {
                    nextUserId = id;
                }

                loadUsers();
                hideSpinner();
            }
        });

        // User Modal Logic (Add/Edit)
        const modal = document.getElementById("userModal");
        const modalTitle = document.getElementById("modalTitle");
        const modalFullName = document.getElementById("modalFullName");
        const modalUsername = document.getElementById("modalUsername");
        const modalPin = document.getElementById("modalPin");
        const modalRole = document.getElementById("modalRole");
        const modalCancel = document.getElementById("modalCancel");
        const modalSave = document.getElementById("modalSave");
        let editingId = null;

        document.getElementById("addUser").onclick = () => openModal(null);

        function openModal(user) {
            editingId = user ? user.id : null;
            modalTitle.textContent = editingId ? "Edit Authorized User" : "Add New Authorized User";
            modalFullName.value = user ? `${user.first_name} ${user.last_name}` : "";
            modalUsername.value = user?.username || "";
            modalPin.value = user?.pin || "";
            modalRole.value = user?.role || "user";
            
            // Disable editing username/role for the admin PG
            const isPg = user?.username === 'PG';
            modalUsername.disabled = isPg;
            modalRole.disabled = isPg;

            modal.classList.remove("hidden");
            modalFullName.focus();
        }

        modalCancel.onclick = () => modal.classList.add("hidden");

        modalSave.onclick = async () => {
            if (currentUser.role !== 'admin') return;
            
            showSpinner();
            await new Promise(r => setTimeout(r, 200)); // Simulate save delay

            const fullName = modalFullName.value.trim();
            const [firstName, ...lastNameParts] = fullName.split(' ');
            const lastName = lastNameParts.join(' ') || '';

            const payload = {
                first_name: firstName,
                last_name: lastName,
                username: modalUsername.value.trim().toUpperCase(),
                pin: modalPin.value.trim(),
                role: modalRole.value,
            };

            if (!payload.username || !payload.pin || !fullName) {
                hideSpinner();
                return showAlert("All fields (Full Name, Username, PIN) are required.", "Input Error");
            }
            
            if (payload.pin.length !== 4) {
                 hideSpinner();
                 return showAlert("PIN must be exactly 4 digits.", "Input Error");
            }
            
            let action = "Updated";

            if (editingId) {
                // UPDATE
                const index = EMPLOYEE_DATA.findIndex(u => u.id === editingId);
                if (index > -1) {
                    EMPLOYEE_DATA[index] = { ...EMPLOYEE_DATA[index], ...payload };
                }
            } else {
                // CREATE
                action = "Created";
                const isUsernameTaken = EMPLOYEE_DATA.some(u => u.username === payload.username);
                if (isUsernameTaken) {
                    hideSpinner();
                    return showAlert(`The username **${payload.username}** is already in use.`, "Creation Failed");
                }
                
                EMPLOYEE_DATA.push({
                    id: nextUserId++,
                    ...payload,
                    signed_pdf_url: null, // New users start without signed docs
                });
            }

            showAlert(`User **${esc(payload.username)}** ${action.toLowerCase()} successfully.`, `${action} Success`);
            
            loadUsers();
            hideSpinner();
            modal.classList.add("hidden");
        };

        // --- INITIALIZATION ---
        // Ensure nextUserId is higher than any existing ID for new users
        EMPLOYEE_DATA.forEach(u => {
            if (u.id >= nextUserId) {
                nextUserId = u.id + 1;
            }
        });

    </script>
</body>
</html>
