<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">

<head>
    <meta charset="UTF-8">
    <title>Jeng Chi — Executive Benefits Portal</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.7/dist/umd/supabase.min.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.2/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    
    
    </head>


<style>
  

@media (min-width: 640px) {
    header > div,
    main > section,
    .card {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
}

/* Ensure tables stretch full width */
.overflow-x-auto,
table {
    width: 100%;
}
  
    :root {
        --jc-red: #8a1619;
        --jc-red-soft: #c53030;
        --jc-navy: #003366;
        --jc-navy-soft: #0b3c73;
        --jc-gray-bg: #f4f5f7;
    }

    * {
        box-sizing: border-box;
    }

    html {
        font-size: 16px;
        height: 100%;
    }

    @media (max-width: 768px) {
        html {
            font-size: 14px;
        }
    }

body {
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    color: #111827;
    margin: 0 !important;
    padding: 0 !important;
    width: 100vw !important;
    min-height: 100vh;
    overflow-x: hidden !important;
    box-sizing: border-box;
}

    /* CONTAINER WIDTHS - Responsive */
    /* CONTAINER WIDTHS - Full Width Layout */
/* FORCE FULL WIDTH - NO WHITE BORDERS */
html, body {
    margin: 0 !important;
    padding: 0 !important;
    width: 100vw !important;
    overflow-x: hidden !important;
}

body > * {
    max-width: 100% !important;
}

#dashboardView,
#loginView {
    width: 100vw !important;
    margin: 0 !important;
    padding: 0 !important;
}



.max-w-7xl {
    max-width: 100% !important;
    width: 100% !important;
    padding-left: 0 !important;
    padding-right: 0 !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
}
/* Adjust inner content padding only */
.max-w-7xl > * {
    padding-left: 1rem;
    padding-right: 1rem;
}

/* Remove padding from specific sections */
header .max-w-7xl,
.bg-slate-50 .max-w-7xl,
.bg-white .max-w-7xl {
    padding-left: 1.5rem !important;
    padding-right: 1.5rem !important;
}


@media (min-width: 640px) {
    .max-w-7xl {
        padding-left: 1rem;
        padding-right: 1rem;
    }
}

@media (min-width: 1024px) {
    .max-w-7xl {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }
}

@media (min-width: 1280px) {
    .max-w-7xl {
        max-width: 100%;  /* ✅ FULL WIDTH - NO LIMIT */
        padding-left: 2rem;
        padding-right: 2rem;
    }
}

    /* CARDS - Responsive */
    .card {
        background: #ffffff;
        border-radius: 0.75rem;
        border: 1px solid #e5e7eb;
        box-shadow: 0 1px 3px rgba(15, 23, 42, 0.08);
        width: 100%;
    }

    @media (min-width: 1024px) {
        .card {
            box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
        }
    }

    .input-border {
        border: 1px solid #111827;
    }

    /* TOAST - Responsive */
    .toast {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        top: 1rem;
        max-width: 90vw;
        width: 22rem;
        z-index: 50;
    }

    @media (max-width: 640px) {
        .toast {
            width: calc(100vw - 2rem);
            max-width: 22rem;
        }
    }

    .pill-badge {
        border-radius: 9999px;
        font-size: 0.7rem;
        letter-spacing: 0.12em;
        text-transform: uppercase;
        white-space: nowrap;
    }

    /* TAB NAVIGATION - Scrollable on mobile */
    .tab-btn-active {
        border-bottom: 2px solid var(--jc-red);
        color: #111827;
        font-weight: 600;
    }

    .tab-btn-inactive {
        border-bottom: 2px solid transparent;
        color: #6b7280;
    }

    nav.flex {
        overflow-x: auto;
        overflow-y: hidden;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
    }

    nav.flex::-webkit-scrollbar {
        display: none;
    }

    .cost-bar-track {
        height: 0.5rem;
        border-radius: 9999px;
        background: #e5e7eb;
    }

    .cost-bar-med {
        background: var(--jc-red);
    }

    .cost-bar-den {
        background: #1d4ed8;
    }

    .cost-bar-vis {
        background: #4b5563;
    }

    .login-bg {
        background-color: #ffffff;
        background-image: none;
        min-height: 100vh;
        width: 100%;
    }

    /* TABLES - Responsive with horizontal scroll */
    .report-grid-container {
        max-height: 70vh;
        overflow: auto;
        width: 100%;
        -webkit-overflow-scrolling: touch;
    }

    .report-grid-table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
    }

    .report-grid-table th,
    .report-grid-table td {
        border: 1px solid #e5e7eb;
        padding: 0.5rem;
        text-align: left;
        font-size: 0.875rem;
    }

    @media (min-width: 768px) {
        .report-grid-table th,
        .report-grid-table td {
            padding: 8px;
        }
    }

    .report-grid-table th {
        white-space: nowrap;
        background-color: #f8fafc;
        position: sticky;
        top: 0;
        z-index: 10;
        font-weight: 600;
        color: #111827;
    }

    .report-grid-table td {
        background-color: #ffffff;
    }

    .report-grid-table tr:nth-child(even) td {
        background-color: #f9fafb;
    }

   #employeeListTableBody td {
    white-space: normal; /* <--- Allows text to wrap */
    vertical-align: middle;
    max-width: 150px;    /* <--- Optional: prevents any single column from getting too wide */
}
    #employeeListTableBody td:nth-child(1) {
        white-space: normal;
    }

    /* Overflow scroll for all tables */
    .overflow-x-auto {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        width: 100%;
    }

    /* TAB CONTENT VISIBILITY FIX */
    .tab-content {
        display: none;
    }

    .tab-content.active {
        display: block;
    }

    /* SUB-TAB STYLES */
    .sub-tab-content {
        display: none;
    }

    .sub-tab-content.active {
        display: block;
    }

    /* MODAL - Full responsive */
    .full-modal {
        display: flex !important;
        align-items: flex-start !important;
        justify-content: center !important;
        padding: 0 !important;
        z-index: 9999 !important;
        background: rgba(0,0,0,0.3) !important;
    }

    .full-modal > div {
        width: 100vw !important;
        height: 100vh !important;
        max-width: none !important;
        max-height: none !important;
        border-radius: 0 !important;
        box-shadow: none !important;
        margin: 0 !important;
        overflow-y: auto !important;
        padding: 0 !important;
    }

    /* Employee Modal - Responsive */
    #employeeModal > div {
        width: 95vw;
        max-width: 64rem;
        max-height: 90vh;
    }

    @media (max-width: 768px) {
        #employeeModal > div {
            width: 100vw;
            max-width: 100vw;
            max-height: 100vh;
            border-radius: 0;
        }
    }

    /* FULLSCREEN STYLES */
    :fullscreen, ::backdrop {
        background-color: #f8fafc;
        width: 100vw;
        height: 100vh;
        overflow-y: auto;
    }

    :-webkit-full-screen {
        background-color: #f8fafc;
        width: 100%;
        height: 100%;
    }

    :-moz-full-screen {
        background-color: #f8fafc;
        width: 100%;
        height: 100%;
    }

    :-ms-fullscreen {
        background-color: #f8fafc;
        width: 100%;
        height: 100%;
    }

    /* RESPONSIVE GRID FIXES */
    @media (max-width: 768px) {
        .grid.md\\:grid-cols-2,
        .grid.md\\:grid-cols-3,
        .grid.md\\:grid-cols-4,
        .grid.lg\\:grid-cols-5 {
            grid-template-columns: 1fr !important;
        }

        .hidden.sm\\:flex {
            display: none !important;
        }
    }

    @media (max-width: 1024px) {
        .grid.lg\\:grid-cols-2 {
            grid-template-columns: 1fr !important;
        }
    }

    /* CHART CONTAINERS - Responsive */
    canvas {
        max-width: 100%;
        height: auto !important;
    }

    /* BUTTON RESPONSIVE */
    button, .btn {
        touch-action: manipulation;
        -webkit-tap-highlight-color: transparent;
    }

    /* Ensure buttons stack on mobile */
    @media (max-width: 640px) {
        .flex.gap-2, .flex.gap-3, .flex.gap-4 {
            flex-wrap: wrap;
        }
    }

    /* PREVENT HORIZONTAL OVERFLOW */
    body, html, #dashboardView, #loginView {
        overflow-x: hidden;
        max-width: 100vw;
    }

    /* RESPONSIVE SPACING */
    @media (max-width: 640px) {
        .px-4 { padding-left: 0.75rem; padding-right: 0.75rem; }
        .py-6 { padding-top: 1rem; padding-bottom: 1rem; }
        .gap-6 { gap: 1rem; }
        .space-y-8 > * + * { margin-top: 1.5rem; }
    }

    /* STICKY HEADERS ON MOBILE */
    @media (max-width: 768px) {
        header {
            position: sticky;
            top: 0;
            z-index: 40;
            background: white;
        }
    }

    /* IMPROVED TOUCH TARGETS */
    @media (hover: none) {
        button, a, input, select, textarea {
            min-height: 44px;
            min-width: 44px;
        }
    }

/* Fullscreen improvements */
:fullscreen {
    background-color: #f8fafc;
}

:-webkit-full-screen {
    background-color: #f8fafc;
}

:-moz-full-screen {
    background-color: #f8fafc;
}

:-ms-fullscreen {
    background-color: #f8fafc;
}

/* Ensure content scrolls in fullscreen */
:fullscreen body,
:-webkit-full-screen body,
:-moz-full-screen body {
    overflow-y: auto;
    height: 100vh;
}




</style>








<body class="min-h-screen bg-slate-50">
    <!-- TOAST NOTIFICATION -->
    <div id="toast" class="toast hidden">
        <div id="toastInner" class="card px-4 py-3 flex items-start gap-3">
            <div id="toastIcon" class="mt-1">
                <i class="fa-solid fa-circle-check text-emerald-600"></i>
            </div>
            <div class="flex-1">
                <p id="toastTitle" class="font-semibold text-sm">Title</p>
                <p id="toastMessage" class="text-xs text-slate-600 mt-0.5">Message</p>
            </div>
            <button class="text-slate-400 hover:text-slate-600 text-xs" onclick="hideToast()">
                <i class="fa-solid fa-xmark"></i>
            </button>
        </div>
    </div>

  <!-- LOGIN VIEW -->
<main id="loginView" class="login-bg min-h-screen flex items-center justify-center px-4 py-10">
    <div class="w-full max-w-5xl grid lg:grid-cols-2 gap-6 lg:gap-10 items-center">
        <section class="space-y-6 lg:space-y-8">
            <div class="space-y-4 lg:space-y-6">
                <div class="flex flex-col items-center text-center gap-4">
                    <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" 
                         alt="Jeng Chi Logo" 
                         class="h-16 lg:h-20 w-auto">
                    <div>
                        <h1 class="text-2xl md:text-3xl lg:text-4xl font-extrabold tracking-tight text-[color:var(--jc-navy)]">
                            Executive Benefits Portal
                        </h1>
                        <p class="mt-2 text-xs md:text-sm lg:text-base text-slate-600 max-w-xl mx-auto px-4">
                            Secure workspace for Jeng Chi executives and HR to review signed benefit elections,
                            analytics, and access controls.
                        </p>
                    </div>
                </div>
            </div>
        </section>


            <section class="card px-6 py-7 space-y-6">
                <header class="space-y-1 text-center">
                    <p class="text-[0.75rem] uppercase tracking-[0.24em] text-slate-500">
                        Executive sign-in
                    </p>
                    <h2 class="text-xl font-semibold text-slate-900">
                        Enter your portal credentials
                    </h2>
                    <p class="text-xs text-slate-500 mt-0.5">
                        Use the initials and PIN issued to you by HR or Ownership.
                    </p>
                </header>
                <div class="space-y-4">
                    <div>
                        <label for="loginInitials" class="block text-xs font-semibold text-slate-700 mb-1">
                            Initials
                        </label>
                        <input id="loginInitials" type="text" autocomplete="off" class="w-full rounded-md px-3 py-2 input-border bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                    </div>
                    <div>
                        <label for="loginPin" class="block text-xs font-semibold text-slate-700 mb-1">
                            PIN
                        </label>
                        <div class="relative">
                            <input id="loginPin" type="password" autocomplete="off" maxlength="4" class="w-full rounded-md px-3 py-2 input-border bg-white text-sm pr-10 focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                            <button id="togglePin" type="button" class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700">
                                <i class="fa-regular fa-eye text-xs"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <button id="loginButton" type="button" class="w-full inline-flex justify-center items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white text-sm font-semibold py-2.5 hover:bg-[color:var(--jc-red-soft)] transition-shadow shadow-sm hover:shadow">
                    <i class="fa-solid fa-right-to-bracket"></i>
                    <span>Sign In</span>
                </button>
                <p class="mt-2 text-[0.7rem] text-slate-500 text-center">
                    This is a secure executive benefits portal. Unauthorized access is prohibited.
                </p>
            </section>
        </div>
    </main>




    <!-- DASHBOARD VIEW -->
    <div id="dashboardView" class="hidden min-h-screen bg-slate-50">

     <!-- HEADER -->
<header class="bg-white border-b border-slate-200 sticky top-0 z-40">
    <div class="w-full px-4 sm:px-6 lg:px-8 py-3 flex flex-wrap items-center justify-between gap-3">
        <div class="flex items-center gap-3 flex-shrink-0">
            <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" 
                 alt="Jeng Chi Logo" 
                 class="h-10 sm:h-11 w-auto">
            <div>
                <p class="text-[0.65rem] sm:text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                    Jeng Chi Restaurant
                </p>
                <h1 class="text-base sm:text-lg lg:text-xl font-semibold text-[color:var(--jc-navy)]">
                    Executive Benefits Portal
                </h1>
            </div>
        </div>
        <div class="flex items-center gap-2 sm:gap-4 flex-wrap">
            <div class="hidden md:flex flex-col items-end text-right">
                <span id="headerUserName" class="text-sm font-semibold text-slate-900"></span>
                <span id="headerUserRole" class="text-[0.7rem] text-slate-500"></span>
            </div>

            <button id="btnFullscreen" 
                    class="inline-flex items-center justify-center rounded-md border border-slate-300 bg-white w-8 h-8 sm:w-9 sm:h-9 text-slate-700 hover:bg-slate-50 transition-colors shadow-sm" 
                    title="Toggle Full Screen">
                <i class="fa-solid fa-expand text-sm"></i>
            </button>
            
            <button id="logoutButton" 
                    class="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-2 sm:px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50">
                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                <span class="hidden sm:inline">Logout</span>
            </button>
        </div>
    </div>
</header>

        <!-- SUMMARY CARDS -->


        <section class="bg-slate-50 border-b border-slate-200">
    <div class="w-full px-4 sm:px-6 lg:px-8 py-4 grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-3 sm:gap-4">
                <div class="card px-4 py-3">
                    <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                        Total Signed Employees
                    </p>
                    <p id="summarySignedEmployees" class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">0</p>
                    <p class="text-xs text-slate-500 mt-1">
                        Employees with finalized benefit packets.
                    </p>
                </div>
                <div class="card px-4 py-3">
                    <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                        Current Plan Year
                    </p>
                    <p class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">2026</p>
                    <p class="text-xs text-slate-500 mt-1">
                        Active comparison window for plan elections.
                    </p>
                </div>
                <div class="card px-4 py-3">
                    <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                        Active Benefit Cycle
                    </p>
                    <p id="cycleStatusLabel" class="mt-2 text-base font-semibold text-red-600">Under Review</p>
                    <p id="cycleStatusDescription" class="text-xs text-slate-500 mt-1">
                        Use the analytics tab for renewal discussions and budgeting.
                    </p>
                </div>
                <div class="card px-4 py-3 flex flex-col justify-between">
                    <div>
                        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                            Cycle Status Control
                        </p>
                        <p class="text-xs text-slate-500 mt-1">
                            Admins (Pablo, Garrett, Janelle) can update the cycle status.
                        </p>
                    </div>
                    <div class="mt-3">
                        <select id="cycleStatusSelect" class="w-full rounded-md border border-slate-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                            <option value="under_review">Under Review</option>
                            <option value="received">Received</option>
                            <option value="verified">Verified</option>
                            <option value="finalized">Finalized</option>
                        </select>
                    </div>
                </div>
            </div>
        </section>

        <!-- TAB NAVIGATION -->
    <section class="bg-white border-b border-slate-200">
    <div class="w-full px-4 sm:px-6 lg:px-8">
                <nav class="flex gap-6 text-sm overflow-x-auto">
                    <button id="tabDocs" class="py-3 tab-btn-active whitespace-nowrap">
                        Signed Documents
                    </button>
                    <button id="tabAnalytics" class="py-3 tab-btn-inactive whitespace-nowrap">
                        Benefit Summary
                    </button>
                    <button id="tabComparison" class="py-3 tab-btn-inactive whitespace-nowrap">
                        Employee Comparison
                    </button>
                    <button id="tabEmployeeList" class="py-3 tab-btn-inactive whitespace-nowrap">
                        2026 Employee Elections
                    </button>
                    <button id="tabAudit" class="py-3 tab-btn-inactive whitespace-nowrap">
                        Audit Logs
                    </button>
                    <button id="tabUsers" class="py-3 tab-btn-inactive whitespace-nowrap">
                        Authorized Users
                    </button>
                    <button id="tabPermissions" class="py-3 tab-btn-inactive whitespace-nowrap">
                        Permissions
                    </button>
                </nav>
            </div>
        </section>

<main class="w-full px-2 lg:px-4 py-6">
            
            <!-- ==================== SIGNED DOCUMENTS TAB ==================== -->
            <section id="tabDocsContent" class="tab-content active space-y-4">
                <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">Signed Documents</h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Alphabetical index of employees with completed, signed benefit packets.
                        </p>
                    </div>
                    <div class="flex gap-2">
                        <button id="printAllButton" class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50">
                            <i class="fa-solid fa-print"></i>
                            <span>Print All</span>
                        </button>
                        <button id="mergeAllButton" class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]">
                            <i class="fa-solid fa-file-pdf"></i>
                            <span>Merge &amp; Download All</span>
                        </button>
                    </div>
                </header>
                
                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
                    <div class="w-full md:max-w-xs">
                        <label class="block text-xs font-semibold text-slate-700 mb-1">
                            Search employee by last name
                        </label>
                        <input id="docSearch" type="text" class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                    </div>
                    <p class="text-[0.7rem] text-slate-500">
                        Total signed employees: <span id="docSignedCount">0</span>
                    </p>
                </div>
                
                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                            <tr>
                                <th class="text-left px-4 py-2.5 w-10">#</th>
                                <th class="text-left px-4 py-2.5">Employee</th>
                                <th class="text-left px-4 py-2.5">Initials</th>
                                <th class="text-left px-4 py-2.5">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="docBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">
                                    Loading signed documents...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ==================== BENEFIT SUMMARY TAB ==================== -->
            <section id="tabAnalyticsContent" class="tab-content space-y-8">
                <!-- EXECUTIVE HEADER -->
                <header class="bg-gradient-to-r from-[#003366] to-[#0b3c73] rounded-xl p-8 shadow-2xl">
                    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-6">
                        <div class="flex-1">
                            <div class="flex items-center gap-3 mb-3">
                                <div class="w-12 h-12 rounded-xl bg-white/10 backdrop-blur-sm flex items-center justify-center">
                                    <i class="fa-solid fa-chart-line text-2xl text-white"></i>
                                </div>
                                <div>
                                    <p class="text-[0.65rem] uppercase tracking-[0.3em] text-blue-200 font-semibold">Executive Analytics</p>
                                    <h2 class="text-3xl font-bold text-white">Employee Benefit Analytics</h2>
                                </div>
                            </div>
                            <p class="text-sm text-blue-100 max-w-3xl">
                                Real-time enrollment data, plan distribution charts, and cost analysis for strategic planning.
                            </p>
                        </div>
                        <div class="flex flex-col gap-3">
                            <span class="inline-flex items-center px-4 py-2 rounded-lg bg-red-500/20 border border-red-400/30 text-red-100 text-xs font-semibold">
                                <span class="w-2 h-2 rounded-full bg-red-400 mr-2 animate-pulse"></span>Under Review
                            </span>
                        </div>
                    </div>
                </header>

                <!-- KPI METRICS -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-6">
                    <div class="card relative overflow-hidden hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-500/10 to-transparent rounded-full -mr-16 -mt-16"></div>
                        <div class="relative p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center shadow-lg">
                                    <i class="fa-solid fa-users text-white text-xl"></i>
                                </div>
                                <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full">2026</span>
                            </div>
                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Total Enrolled</p>
                            <p id="kpi-total-enrolled" class="text-4xl font-bold text-slate-900 mb-1">-</p>
                            <p id="kpi-total-change" class="text-xs text-slate-500">Loading...</p>
                        </div>
                    </div>

                    <div class="card relative overflow-hidden hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-red-500/10 to-transparent rounded-full -mr-16 -mt-16"></div>
                        <div class="relative p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-red-500 to-red-600 flex items-center justify-center shadow-lg">
                                    <i class="fa-solid fa-heart-pulse text-white text-xl"></i>
                                </div>
                                <span class="text-xs font-semibold text-red-600 bg-red-50 px-3 py-1 rounded-full">Medical</span>
                            </div>
                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Medical Plans</p>
                            <p id="kpi-medical-count" class="text-4xl font-bold text-slate-900 mb-1">-</p>
                            <p id="kpi-medical-rate" class="text-xs text-slate-500">Loading...</p>
                        </div>
                    </div>

                    <div class="card relative overflow-hidden hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-blue-600/10 to-transparent rounded-full -mr-16 -mt-16"></div>
                        <div class="relative p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-600 to-blue-700 flex items-center justify-center shadow-lg">
                                    <i class="fa-solid fa-tooth text-white text-xl"></i>
                                </div>
                                <span class="text-xs font-semibold text-blue-700 bg-blue-50 px-3 py-1 rounded-full">Dental</span>
                            </div>
                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Dental Plans</p>
                            <p id="kpi-dental-count" class="text-4xl font-bold text-slate-900 mb-1">-</p>
                            <p id="kpi-dental-rate" class="text-xs text-slate-500">Loading...</p>
                        </div>
                    </div>

                    <div class="card relative overflow-hidden hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-teal-500/10 to-transparent rounded-full -mr-16 -mt-16"></div>
                        <div class="relative p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-teal-500 to-teal-600 flex items-center justify-center shadow-lg">
                                    <i class="fa-solid fa-shield-heart text-white text-xl"></i>
                                </div>
                                <span class="text-xs font-semibold text-teal-600 bg-teal-50 px-3 py-1 rounded-full">Life</span>
                            </div>
                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Life & AD&D</p>
                            <p id="kpi-life-count" class="text-4xl font-bold text-slate-900 mb-1">-</p>
                            <p id="kpi-life-rate" class="text-xs text-slate-500">Loading...</p>
                        </div>
                    </div>

                    <div class="card relative overflow-hidden hover:shadow-xl transition-all">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-gradient-to-br from-emerald-500/10 to-transparent rounded-full -mr-16 -mt-16"></div>
                        <div class="relative p-6">
                            <div class="flex items-start justify-between mb-4">
                                <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-emerald-500 to-emerald-600 flex items-center justify-center shadow-lg">
                                    <i class="fa-solid fa-dollar-sign text-white text-xl"></i>
                                </div>
                                <span class="text-xs font-semibold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full">Cost</span>
                            </div>
                            <p class="text-sm font-semibold text-slate-500 uppercase tracking-wider mb-2">Annual Cost</p>
                            <p id="kpi-total-cost" class="text-4xl font-bold text-slate-900 mb-1">-</p>
                            <p id="kpi-cost-change" class="text-xs text-slate-500">Loading...</p>
                        </div>
                    </div>
                </div>

                <!-- SUB-TABS FOR BENEFIT SUMMARY -->
                <div class="card overflow-hidden">
                    <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-6 py-4">
                        <nav class="flex gap-4 overflow-x-auto">
                            <button id="analytics-tab-charts" class="analytics-tab-btn px-6 py-3 text-sm font-semibold text-white border-b-2 border-white whitespace-nowrap">
                                <i class="fa-solid fa-chart-pie mr-2"></i>Dashboard Charts
                            </button>
                            <button id="analytics-tab-breakdown" class="analytics-tab-btn px-6 py-3 text-sm font-medium text-slate-300 border-b-2 border-transparent hover:text-white whitespace-nowrap">
                                <i class="fa-solid fa-table mr-2"></i>Cost Breakdown
                            </button>
                            <button id="analytics-tab-trends" class="analytics-tab-btn px-6 py-3 text-sm font-medium text-slate-300 border-b-2 border-transparent hover:text-white whitespace-nowrap">
                                <i class="fa-solid fa-chart-line mr-2"></i>Year Trends
                            </button>
                        </nav>
                    </div>

                    <!-- SUB-TAB: DASHBOARD CHARTS -->
                    <div id="analytics-content-charts" class="sub-tab-content active p-8 bg-gradient-to-b from-slate-50 to-white">
                        <h3 class="text-xl font-bold text-slate-900 mb-6 flex items-center gap-3">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 flex items-center justify-center">
                                <i class="fa-solid fa-chart-pie text-blue-600"></i>
                            </div>
                            2026 Plan Distribution Dashboard
                        </h3>

                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <!-- MEDICAL CHART -->
                            <div class="card bg-gradient-to-br from-red-50 to-white border-2 border-red-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl bg-red-100 flex items-center justify-center">
                                        <i class="fa-solid fa-heart-pulse text-red-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900">Medical Plans</h4>
                                        <p class="text-xs text-slate-500">2026 Enrollment Distribution</p>
                                    </div>
                                </div>
                                <div class="relative" style="height: 300px;">
                                    <canvas id="chartMedical2026"></canvas>
                                </div>
                            </div>

                            <!-- DENTAL CHART -->
                            <div class="card bg-gradient-to-br from-blue-50 to-white border-2 border-blue-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl bg-blue-100 flex items-center justify-center">
                                        <i class="fa-solid fa-tooth text-blue-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900">Dental Plans</h4>
                                        <p class="text-xs text-slate-500">2026 Enrollment Distribution</p>
                                    </div>
                                </div>
                                <div class="relative" style="height: 300px;">
                                    <canvas id="chartDental2026"></canvas>
                                </div>
                            </div>

                            <!-- VISION CHART -->
                            <div class="card bg-gradient-to-br from-slate-50 to-white border-2 border-slate-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl bg-slate-100 flex items-center justify-center">
                                        <i class="fa-solid fa-eye text-slate-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900">Vision Plans</h4>
                                        <p class="text-xs text-slate-500">2026 Enrollment Distribution</p>
                                    </div>
                                </div>
                                <div class="relative" style="height: 300px;">
                                    <canvas id="chartVision2026"></canvas>
                                </div>
                            </div>

                            <!-- LIFE CHART -->
                            <div class="card bg-gradient-to-br from-emerald-50 to-white border-2 border-emerald-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-12 h-12 rounded-xl bg-emerald-100 flex items-center justify-center">
                                        <i class="fa-solid fa-shield-heart text-emerald-600 text-xl"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-lg font-bold text-slate-900">Life & AD&D</h4>
                                        <p class="text-xs text-slate-500">2026 Coverage Status</p>
                                    </div>
                                </div>
                                <div class="relative" style="height: 300px;">
                                    <canvas id="chartLife2026"></canvas>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- SUB-TAB: COST BREAKDOWN -->
                    <div id="analytics-content-breakdown" class="sub-tab-content p-8">
                        <h3 class="text-xl font-bold text-slate-900 mb-6">Total Employee Cost Breakdown (2026)</h3>
                        <div class="overflow-x-auto">
                            <table class="min-w-full">
                                <thead class="bg-slate-100 border-b-2 border-slate-200">
                                    <tr>
                                        <th class="text-left px-6 py-4 text-xs font-bold text-slate-700 uppercase">Coverage Type</th>
                                        <th class="text-left px-6 py-4 text-xs font-bold text-slate-700 uppercase">Plan Name</th>
                                        <th class="text-right px-6 py-4 text-xs font-bold text-slate-700 uppercase">Bi-Weekly Rate</th>
                                        <th class="text-right px-6 py-4 text-xs font-bold text-slate-700 uppercase">Enrolled Count</th>
                                        <th class="text-right px-6 py-4 text-xs font-bold text-slate-700 uppercase">Annual Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="cost-breakdown-table-body" class="divide-y divide-slate-100">
                                    <!-- Populated by JavaScript -->
                                </tbody>
                                <tfoot class="bg-slate-900 text-white font-bold">
                                    <tr>
                                        <td colspan="3" class="px-6 py-4 text-left">TOTAL</td>
                                        <td id="total-enrolled" class="px-6 py-4 text-right">-</td>
                                        <td id="total-annual-cost" class="px-6 py-4 text-right">-</td>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    </div>

                    <!-- SUB-TAB: YEAR TRENDS -->
                    <div id="analytics-content-trends" class="sub-tab-content p-8">
                        <h3 class="text-xl font-bold text-slate-900 mb-6">Year-over-Year Trends</h3>
                        
                        <!-- Comparison Bar Charts -->
                        <div class="grid lg:grid-cols-3 gap-6 mb-8">
                            <div class="card bg-gradient-to-br from-red-50 to-white border-2 border-red-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-red-100 flex items-center justify-center">
                                        <i class="fa-solid fa-heart-pulse text-red-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-bold text-slate-900">Medical Plans</h4>
                                        <p class="text-xs text-slate-500">2025 vs 2026</p>
                                    </div>
                                </div>
                                <div style="height: 250px;">
                                    <canvas id="chartMedicalComparison"></canvas>
                                </div>
                            </div>

                            <div class="card bg-gradient-to-br from-blue-50 to-white border-2 border-blue-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-blue-100 flex items-center justify-center">
                                        <i class="fa-solid fa-tooth text-blue-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-bold text-slate-900">Dental Plans</h4>
                                        <p class="text-xs text-slate-500">2025 vs 2026</p>
                                    </div>
                                </div>
                                <div style="height: 250px;">
                                    <canvas id="chartDentalComparison"></canvas>
                                </div>
                            </div>

                            <div class="card bg-gradient-to-br from-slate-50 to-white border-2 border-slate-100 p-6">
                                <div class="flex items-center gap-3 mb-4">
                                    <div class="w-10 h-10 rounded-xl bg-slate-100 flex items-center justify-center">
                                        <i class="fa-solid fa-eye text-slate-600 text-lg"></i>
                                    </div>
                                    <div>
                                        <h4 class="text-base font-bold text-slate-900">Vision Plans</h4>
                                        <p class="text-xs text-slate-500">2025 vs 2026</p>
                                    </div>
                                </div>
                                <div style="height: 250px;">
                                    <canvas id="chartVisionComparison"></canvas>
                                </div>
                            </div>
                        </div>

                        <!-- Tier Breakdown Table -->
                        <div id="tier-breakdown-container" class="mt-8">
                            <div class="text-center text-slate-500 py-8">
                                <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
                                <p>Loading tier breakdown...</p>
                            </div>
                        </div>

                        <!-- Plan Year Cards -->
                        <div class="grid lg:grid-cols-2 gap-6 mt-8">
                            <div id="planCard2025" class="card p-6"></div>
                            <div id="planCard2026" class="card p-6"></div>
                        </div>
                    </div>
                </div>

                <!-- FOOTER DISCLAIMER -->
                <footer class="card p-6 bg-gradient-to-r from-slate-50 to-blue-50 border-l-4 border-blue-600">
                    <div class="flex items-start gap-4">
                        <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0">
                            <i class="fa-solid fa-info-circle text-blue-600"></i>
                        </div>
                        <div>
                            <h4 class="text-sm font-bold text-slate-900 mb-2">Executive Analytics Notice</h4>
                            <p class="text-xs text-slate-600 leading-relaxed mb-2">
                                This dashboard provides real-time enrollment analytics for strategic decision-making. All costs reflect employee-paid 
                                premiums only and do not include employer contributions. Data is updated automatically as enrollments are processed.
                            </p>
                            <p class="text-xs text-slate-500">
                                <strong>Confidential:</strong> This report is intended for executive and HR leadership use only. 
                                For detailed carrier proposals or renewal quotes, please consult with your benefits broker.
                            </p>
                        </div>
                    </div>
                </footer>
            </section>

<!-- ==================== EMPLOYEE COMPARISON TAB ==================== -->
            <section id="tabComparisonContent" class="tab-content space-y-6">
                <header class="border-b border-slate-200 pb-4">
                    <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">
                        Per-employee analysis
                    </p>
                    <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">
                        Employee Year-over-Year Comparison
                    </h2>
                    <p class="text-sm text-slate-600 max-w-3xl">
                        Search by last name, then select an employee to compare their prior-year and current-year
                        elections, including per-pay and annual cost impact. Use this workspace when reviewing upgrades,
                        downgrades, or flat renewals with leadership.
                    </p>
                </header>
                
                <div class="grid xl:grid-cols-[minmax(0,380px),minmax(0,1fr)] gap-6 items-start">
                    <aside class="card px-5 py-5 sticky top-4">
                        <div class="space-y-4">
                            <div>
                                <p class="text-xs font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider mb-2">
                                    Employee Navigator
                                </p>
                                <p class="text-xs text-slate-500 mb-3">
                                    Select an employee to view their benefit comparison
                                </p>
                            </div>

                            <div>
                                <label class="block text-xs font-semibold text-slate-700 mb-2">
                                    Search by last name
                                </label>
                                <input id="comparisonSearch" type="text" class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]" placeholder="Type to filter employees...">
                            </div>
                        </div>

                        <div class="mt-4 rounded-lg border border-slate-200 bg-slate-50 overflow-hidden max-h-[500px]">
                            <ul id="comparisonEmployeeList" class="overflow-y-auto text-sm divide-y divide-slate-200">
                                <li class="px-4 py-3 text-xs text-slate-500 text-center">
                                    Loading employees...
                                </li>
                            </ul>
                        </div>

                        <p class="mt-4 text-[0.65rem] text-slate-500 leading-relaxed">
                            <i class="fa-solid fa-info-circle text-slate-400 mr-1"></i>
                            Only employees with signed packets appear in this list to ensure analytics align with finalized enrollments.
                        </p>
                    </aside>
                    
                    <section id="employeeComparisonDisplay" class="card px-6 py-6 min-h-[500px]">
                        <div class="flex items-center justify-center h-full text-center">
                            <div class="max-w-md space-y-3">
                                <i class="fa-solid fa-user-chart text-4xl text-slate-300"></i>
                                <p class="text-sm text-slate-600">
                                    Select an employee from the list to generate a detailed year-over-year comparison,
                                    including bi-weekly costs, annual totals, and change analysis.
                                </p>
                            </div>
                        </div>
                    </section>
                </div>
            </section>

            <!-- ==================== 2026 EMPLOYEE ELECTIONS TAB ==================== -->
            <section id="tabEmployeeListContent" class="tab-content space-y-6">
                <!-- Header -->
                <header class="border-b border-slate-200 pb-6">
                    <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4">
                        <div>
                            <p class="text-[0.65rem] uppercase tracking-[0.22em] text-slate-500 mb-2">Corporate benefits registry</p>
                            <h2 class="text-2xl font-bold text-[color:var(--jc-navy)] mb-2">2026 Employee Elections</h2>
                            <p class="text-sm text-slate-600 max-w-2xl">
                                Complete enrollment registry for plan year 2026. Use filters and search to locate specific employees or analyze plan distribution across the organization.
                            </p>
                        </div>
                        <div class="flex items-center gap-3">
                            <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-4 py-2">
                                <span class="w-2 h-2 rounded-full bg-emerald-500 mr-2"></span> Active Plan Year
                            </span>
                            <button id="exportToExcel" class="inline-flex items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white px-4 py-2.5 text-sm font-medium hover:bg-[color:var(--jc-red-soft)] shadow-sm transition-all">
                                <i class="fa-solid fa-download"></i> Export to Excel
                            </button>
                        </div>
                    </div>
                </header>

                <!-- KPI Cards -->
                <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-5 gap-4">
                    <div class="card px-5 py-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Total Enrolled</p>
                                <p id="gridTotalEnrolled" class="text-3xl font-bold text-[color:var(--jc-navy)]">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                                <i class="fa-solid fa-users text-slate-600"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Employees with 2026 elections</p>
                    </div>

                    <div class="card px-5 py-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Medical Coverage</p>
                                <p id="gridMedicalCoverage" class="text-3xl font-bold text-[color:var(--jc-red)]">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-red-50 flex items-center justify-center">
                                <i class="fa-solid fa-heart-pulse text-[color:var(--jc-red)]"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Active medical plan elections</p>
                    </div>

                    <div class="card px-5 py-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Dental Coverage</p>
                                <p id="gridDentalCoverage" class="text-3xl font-bold text-blue-700">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-blue-50 flex items-center justify-center">
                                <i class="fa-solid fa-tooth text-blue-700"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Active dental plan elections</p>
                    </div>

                    <div class="card px-5 py-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Vision Coverage</p>
                                <p id="gridVisionCoverage" class="text-3xl font-bold text-slate-700">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-slate-100 flex items-center justify-center">
                                <i class="fa-solid fa-eye text-slate-700"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Active vision plan elections</p>
                    </div>

                    <div class="card px-5 py-4">
                        <div class="flex items-start justify-between">
                            <div>
                                <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Life &amp; AD&amp;D</p>
                                <p id="gridLifeCoverage" class="text-3xl font-bold text-emerald-700">0</p>
                            </div>
                            <div class="w-10 h-10 rounded-full bg-emerald-50 flex items-center justify-center">
                                <i class="fa-solid fa-shield-heart text-emerald-700"></i>
                            </div>
                        </div>
                        <p class="text-xs text-slate-500 mt-2">Employees with beneficiary designation</p>
                    </div>
                </div>

                <!-- Filters Row -->
                <div class="card p-6">
                    <div class="flex flex-col lg:flex-row lg:items-end gap-6">
                        <div class="flex-1 min-w-0">
                            <label class="block text-sm font-semibold text-slate-700 mb-2">Search Employees</label>
                            <input id="employeeSearch" type="text" placeholder="Search by name..." class="w-full rounded-md border border-slate-300 bg-white px-4 py-2 text-sm focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                        </div>

                        <div class="flex flex-wrap gap-4 items-end">
                            <div class="min-w-[140px]">
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Medical Plan</label>
                                <select id="filterMedical" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                                    <option value="all">All Medical</option>
                                    <option value="WAIVE">Waived</option>
                                    <option value="ATBCB402">PPO</option>
                                    <option value="ATBAB303">HMO</option>
                                    <option value="ATBAP393">HMO HSA</option>
                                </select>
                            </div>

                            <div class="min-w-[140px]">
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Dental Plan</label>
                                <select id="filterDental" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                                    <option value="all">All Dental</option>
                                    <option value="WAIVE">Waived</option>
                                    <option value="F_PLAN_2W">Base</option>
                                    <option value="F_PLAN_3W">Buy Up</option>
                                </select>
                            </div>

                            <div class="min-w-[120px]">
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Vision</label>
                                <select id="filterVision" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                                    <option value="all">All Vision</option>
                                    <option value="WAIVE">Waived</option>
                                    <option value="PLAN_1">Plan 1</option>
                                </select>
                            </div>

                            <div class="min-w-[120px]">
                                <label class="block text-xs font-semibold text-slate-700 mb-1">Life/AD&amp;D</label>
                                <select id="filterLife" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm">
                                    <option value="all">All</option>
                                    <option value="yes">Has Coverage</option>
                                    <option value="no">No Coverage</option>
                                </select>
                            </div>

                            <div class="flex gap-3">
                                <button id="clearFilters" class="inline-flex items-center gap-2 px-4 py-2 rounded-md border border-slate-300 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50">
                                    <i class="fa-solid fa-times"></i> Clear
                                </button>
                                <button id="applyFilters" class="inline-flex items-center gap-2 px-4 py-2 rounded-md bg-[color:var(--jc-red)] text-white text-sm font-medium hover:bg-[color:var(--jc-red-soft)]">
                                    <i class="fa-solid fa-filter"></i> Apply
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-4 border-t border-slate-200">
                        <p class="text-sm text-slate-600">
                            Showing <span id="resultsCount">0</span> of <span id="totalCount">0</span> employees
                        </p>
                    </div>
                </div>

                <!-- Employee Table -->
                <div class="card overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-slate-200">
                        <thead class="bg-slate-50">
    <tr>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider w-40">Employee</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Status</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Salary</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Hire Date</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Contact</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Tier</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Medical</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Dental</th>
        <th class="px-2 py-3 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Vision</th>
        <th class="px-2 py-3 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Life</th>
        <th class="px-2 py-3 text-right text-xs font-semibold text-slate-700 uppercase tracking-wider">Actions</th>
    </tr>
</thead>
                            <tbody id="employeeListTableBody" class="bg-white divide-y divide-slate-200">
                                <tr>
                                    <td colspan="11" class="px-6 py-12 text-center text-sm text-slate-500">
                                        Loading 2026 employee elections...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Disclaimer Footer -->
                <footer class="mt-6 border-t border-slate-200 pt-3 text-[11px] text-slate-500">
                    <p class="font-semibold uppercase tracking-wide text-slate-600">Benefits Census Disclaimer</p>
                    <p class="mt-1">
                        CONFIDENTIAL: This benefits census is for internal use by Jeng Chi Restaurant and authorized broker/benefit partners only.
                    </p>
                    <p class="mt-1">
                        This report does not guarantee coverage or eligibility. Final determinations of eligibility, premium, and benefits are made by the insurance carrier(s).
                    </p>
                </footer>
            </section>

            <!-- ==================== AUDIT LOGS TAB ==================== -->
            <section id="tabAuditContent" class="tab-content space-y-4">
                <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">Audit Logs</h2>
                        <p class="text-xs text-slate-500 mt-1">Track portal access and actions (admin only).</p>
                    </div>
                </header>

                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                            <tr>
                                <th class="text-left px-4 py-2.5">Portal User</th>
                                <th class="text-left px-4 py-2.5">Login Time</th>
                                <th class="text-left px-4 py-2.5">Logout Time</th>
                                <th class="text-left px-4 py-2.5">Duration (min)</th>
                                <th class="text-left px-4 py-2.5">Tab History</th>
                            </tr>
                        </thead>
                        <tbody id="auditBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">
                                    Loading audit logs...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ==================== AUTHORIZED USERS TAB ==================== -->
            <section id="tabUsersContent" class="tab-content space-y-4">
                <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">
                            Authorized Users &amp; Portal Credentials
                        </h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Manage who can access this Executive Benefits Portal. Changes write directly to the
                            <span class="font-mono">portal_users</span> table.
                        </p>
                    </div>
                    <button id="addUserButton" type="button" class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]">
                        <i class="fa-solid fa-user-plus"></i>
                        <span>Add User</span>
                    </button>
                </header>

                <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
                    <div class="w-full md:max-w-xs">
                        <label class="block text-xs font-semibold text-slate-700 mb-1">
                            Search by last name
                        </label>
                        <input id="userSearch" type="text" class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                    </div>
                    <p class="text-[0.7rem] text-slate-500">
                        Role legend: <span class="font-semibold">Administrator</span> can view analytics and manage users;
                        <span class="font-semibold">Standard User</span> can only view Signed Documents.
                    </p>
                </div>

                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                            <tr>
                                <th class="text-left px-4 py-2.5">Full name</th>
                                <th class="text-left px-4 py-2.5">Initials</th>
                                <th class="text-left px-4 py-2.5">Role</th>
                                <th class="text-left px-4 py-2.5">Last login</th>
                                <th class="text-left px-4 py-2.5">Status</th>
                                <th class="text-left px-4 py-2.5">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="userBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

            <!-- ==================== PERMISSIONS TAB ==================== -->
            <section id="tabPermissionsContent" class="tab-content space-y-4">
                <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
                    <div>
                        <h2 class="text-lg font-semibold text-slate-900">
                            Portal Permissions
                        </h2>
                        <p class="text-xs text-slate-500 mt-1">
                            Manage tab access for portal users. Changes save automatically.
                        </p>
                    </div>
                </header>

                <div class="card overflow-x-auto">
                    <table class="min-w-full text-sm">
                        <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
                            <tr>
                                <th class="text-left px-4 py-2.5">Full name</th>
                                <th class="text-left px-4 py-2.5">Initials</th>
                                <th class="text-left px-4 py-2.5">Signed Docs</th>
                                <th class="text-left px-4 py-2.5">Benefit Summary</th>
                                <th class="text-left px-4 py-2.5">Employee Comparison</th>
                                <th class="text-left px-4 py-2.5">2026 Elections</th>
                                <th class="text-left px-4 py-2.5">Audit Logs</th>
                                <th class="text-left px-4 py-2.5">Authorized Users</th>
                            </tr>
                        </thead>
                        <tbody id="permissionsBody" class="divide-y divide-slate-100">
                            <tr>
                                <td colspan="8" class="px-4 py-4 text-center text-xs text-slate-500">
                                    Loading users...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </section>

        </main>
    </div>

<!-- ==================== EMPLOYEE DETAILS MODAL ==================== -->
    <div id="employeeModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-50 px-4">
        <div class="card w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6 space-y-6">



<header class="flex items-center justify-between border-b border-slate-200 pb-3 sticky top-0 bg-white z-10">
    <h3 id="employeeModalTitle" class="text-xl font-bold text-[color:var(--jc-navy)]">
        Employee Details &amp; Editing
    </h3>
    <button id="modalToggleFull" type="button" class="text-slate-400 hover:text-slate-700 mr-2">
        <i class="fa-solid fa-expand text-lg"></i>
    </button>
    <button id="modalClose" type="button" class="text-slate-400 hover:text-slate-700">
        <i class="fa-solid fa-xmark text-lg"></i>
    </button>
</header>


            <div class="grid grid-cols-1 md:grid-cols-4 gap-6">
                <aside class="md:col-span-1 space-y-3">
                    <button type="button" data-tab="details" class="modal-tab-btn w-full text-left p-3 rounded-lg bg-slate-100 font-semibold text-sm hover:bg-slate-100 transition-colors">
                        Personal &amp; Employment
                    </button>
                    <button type="button" data-tab="elections" class="modal-tab-btn w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">
                        Benefit Elections
                    </button>
                    <button type="button" data-tab="family" class="modal-tab-btn w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">
                        Family &amp; Dependents
                    </button>
                    <button type="button" data-tab="history" class="modal-tab-btn w-full text-left p-3 rounded-lg hover:bg-slate-100 text-sm transition-colors">
                        Change History
                    </button>
                    <div id="modalStatus" class="mt-4 text-xs text-slate-500"></div>
                </aside>

                <section id="modalContent" class="md:col-span-3 space-y-6">
                    <!-- Content will be injected here by JavaScript -->
                </section>
            </div>

            <footer class="flex justify-end gap-3 border-t border-slate-200 pt-3 sticky bottom-0 bg-white">
                <button id="modalSaveEmployee" type="button" class="inline-flex items-center gap-2 rounded-md bg-emerald-600 text-white px-4 py-2 text-sm font-medium hover:bg-emerald-700 transition">
                    <i class="fa-solid fa-save"></i>
                    <span>Save Changes</span>
                </button>
            </footer>
        </div>
    </div>

    <!-- ==================== USER MANAGEMENT MODAL ==================== -->
    <div id="userModal" class="fixed inset-0 bg-black/30 hidden items-center justify-center z-40 px-4">
        <div class="card w-full max-w-md px-6 py-5">
            <h3 id="userModalTitle" class="text-base font-semibold text-slate-900 mb-4">
                Add User
            </h3>

            <div class="space-y-3 text-sm">
                <div>
                    <label class="block text-xs font-semibold text-slate-700 mb-1">
                        Full name
                    </label>
                    <input id="modalFullName" type="text" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">
                            Initials
                        </label>
                        <input id="modalInitials" type="text" maxlength="3" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">
                            PIN (4 digits)
                        </label>
                        <input id="modalPin" type="password" maxlength="4" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-semibold text-slate-700 mb-1">
                        Role
                    </label>
                    <select id="modalRole" class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]">
                        <option value="user">Standard User</option>
                        <option value="admin">Administrator</option>
                    </select>
                </div>

                <div class="flex items-center gap-2">
                    <input id="modalActive" type="checkbox" class="rounded border-slate-300 text-[color:var(--jc-red)]" checked>
                    <label for="modalActive" class="text-xs text-slate-700">
                        Portal active
                    </label>
                </div>
            </div>

            <div class="mt-5 flex justify-end gap-3">
                <button id="modalCancel" type="button" class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50">
                    Cancel
                </button>
                <button id="modalSave" type="button" class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]">
                    Save
                </button>
            </div>
        </div>
    </div>

    <!-- ========================================
     COMPLETE JAVASCRIPT
     ======================================== -->

    <script>
        // ======================== ERROR HANDLERS (MUST BE FIRST) ========================
        window.addEventListener('error', function(e) {
            console.error('Global error caught:', {
                message: e.message,
                filename: e.filename,
                lineno: e.lineno,
                colno: e.colno,
                error: e.error
            });
        });
        
        window.addEventListener('unhandledrejection', function(e) {
            console.error('Unhandled promise rejection:', e.reason);
        });

        // ======================== SUPABASE CONFIG ========================
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        
        let supabase = null;
        try {
            if (window.supabase) {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            } else {
                console.error("Supabase script not loaded");
            }
        } catch (err) {
            console.error("Supabase initialization failed:", err);
        }

        // Verify Supabase connection
        (async function verifySupa() {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from("portal_users")
                    .select("id")
                    .limit(1);
                if (error) {
                    console.error("Supabase connection failed:", error);
                    alert("Database connection error. Please check your configuration.");
                } else {
                    console.log("✓ Supabase connected successfully");
                }
            } catch (err) {
                console.error("Supabase initialization error:", err);
            }
        })();

        // ======================== GLOBAL STATE ========================
        let currentUser = null;
        let currentLogId = null;
        let docsCache = [];
        let portalUsersCache = [];
        let analyticsEmployees = [];
        let benefitRates = [];
        let planYearStats = null;
        let analyticsHas2027 = false;
        let analyticsRendered = false;
        let comparisonEmployees = [];
        let comparisonRendered = false;
        let fullEnrollments = [];
        let currentTabHistory = [];
        let RATES = {};
        let comprehensiveData = [];
        let currentEditingEnrollment = null;
        let allEmployees = [];
        const YEARS = [2025, 2026, 2027];

        const BENEFITS_DISCLAIMER_1 = 'CONFIDENTIAL: This benefits census is for internal use by Jeng Chi Restaurant and authorized broker/benefit partners only.';
        const BENEFITS_DISCLAIMER_2 = 'Disclaimer: This report does not guarantee coverage or eligibility. Final determinations of eligibility, premium, and benefits are made by the insurance carrier(s).';

        // ======================== TOAST NOTIFICATIONS ========================
        function showToast({ title, message, type }) {
            const toast = document.getElementById("toast");
            const inner = document.getElementById("toastInner");
            const titleEl = document.getElementById("toastTitle");
            const msgEl = document.getElementById("toastMessage");
            const iconEl = document.getElementById("toastIcon");

            titleEl.textContent = title || "";
            msgEl.textContent = message || "";
            iconEl.innerHTML = "";
            inner.classList.remove("border-emerald-200", "border-red-200", "border-slate-200");

            if (type === "success") {
                iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-emerald-600"></i>';
                inner.classList.add("border", "border-emerald-200");
            } else if (type === "error") {
                iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';
                inner.classList.add("border", "border-red-200");
            } else {
                iconEl.innerHTML = '<i class="fa-solid fa-circle-info text-slate-500"></i>';
                inner.classList.add("border", "border-slate-200");
            }

            toast.classList.remove("hidden");
            clearTimeout(window.__toastTimer);
            window.__toastTimer = setTimeout(() => {
                hideToast();
            }, 3500);
        }

        function hideToast() {
            document.getElementById("toast").classList.add("hidden");
        }

        // ======================== TAB ACCESS LOGGING ========================
        async function logTabAccess(tabName) {
            if (!currentLogId || !currentUser || !supabase) return;
            try {
                const ts = new Date().toLocaleString("en-US", {
                    timeZone: "America/Chicago",
                    month: "2-digit",
                    day: "2-digit",
                    year: "numeric",
                    hour: "2-digit",
                    minute: "2-digit",
                    hour12: true,
                });

                if (!Array.isArray(currentTabHistory)) {
                    currentTabHistory = [];
                }

                currentTabHistory.push(`${tabName} · ${ts}`);

                const { error } = await supabase
                    .from("portal_logs")
                    .update({
                        tab_accessed: tabName,
                        tab_history: currentTabHistory,
                    })
                    .eq("id", currentLogId);

                if (error) throw error;
            } catch (err) {
                console.warn("Failed to log tab access:", err);
            }
        }

        // ======================== HELPER FUNCTIONS ========================
        function esc(str) {
            return String(str ?? "").replace(/[&<>"']/g, (s) => ({
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
            })[s]);
        }

        const formatCurrency = (value) =>
            new Intl.NumberFormat("en-US", {
                style: "currency",
                currency: "USD",
                minimumFractionDigits: 2,
            }).format(value || 0);

        const formatDate = (value) =>
            value ? new Date(value).toLocaleString("en-US", {
                dateStyle: "short",
                timeStyle: "short"
            }) : "—";

        function formatDateOnly(value) {
            if (!value) return "—";
            return new Date(value).toLocaleDateString("en-US");
        }

        function formatPhone(raw) {
            if (!raw) return "—";
            const d = raw.replace(/\D/g, "");
            return d.length !== 10 ? raw : `(${d.slice(0, 3)}) ${d.slice(3, 6)}-${d.slice(6)}`;
        }

        function formatSSN(raw) {
            if (!raw || raw.length < 9) return 'N/A';
            return `${raw.slice(0,3)}-${raw.slice(3,5)}-${raw.slice(5)}`;
        }

        async function safeSupabaseQuery(queryPromise, errorContext) {
            try {
                const { data, error } = await queryPromise;
                if (error) {
                    console.error(`${errorContext}:`, error);
                    throw error;
                }
                return data;
            } catch (err) {
                console.error(`${errorContext} - Unexpected error:`, err);
                showToast({
                    title: "Database Error",
                    message: `${errorContext}: ${err.message}`,
                    type: "error",
                });
                throw err;
            }
        }

        // ======================== LOGIN LOGIC ========================
        const loginView = document.getElementById("loginView");
        const dashboardView = document.getElementById("dashboardView");
        const loginBtn = document.getElementById("loginButton");
        const loginInitials = document.getElementById("loginInitials");
        const loginPin = document.getElementById("loginPin");
        const togglePinBtn = document.getElementById("togglePin");

        togglePinBtn.addEventListener("click", () => {
            const type = loginPin.type === "password" ? "text" : "password";
            loginPin.type = type;
            togglePinBtn.innerHTML =
                type === "password"
                    ? '<i class="fa-regular fa-eye text-xs"></i>'
                    : '<i class="fa-regular fa-eye-slash text-xs"></i>';
        });

        loginInitials.addEventListener("keydown", (e) => {
            if (e.key === "Enter") login();
        });

        loginPin.addEventListener("keydown", (e) => {
            if (e.key === "Enter") login();
        });

        loginBtn.addEventListener("click", login);

        async function login() {
            if (!supabase) {
                alert("Supabase connection failed. Please reload the page.");
                return;
            }

            const initials = loginInitials.value.trim().toUpperCase();
            const pin = loginPin.value.trim();

            if (!initials || !pin) {
                showToast({
                    title: "Invalid credentials",
                    message: "Initials and PIN are required.",
                    type: "error",
                });
                return;
            }

            if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
                showToast({
                    title: "Invalid PIN",
                    message: "PIN must be exactly 4 digits.",
                    type: "error",
                });
                return;
            }

            try {
                const { data: user, error } = await supabase
                    .from("portal_users")
                    .select("*")
                    .eq("initials", initials)
                    .eq("pin", pin)
                    .eq("active", true)
                    .maybeSingle();

                if (error) throw error;

                if (!user) {
                    showToast({
                        title: "Invalid credentials",
                        message: "Check your initials and PIN.",
                        type: "error",
                    });
                    return;
                }

                currentUser = user;

                await supabase
                    .from("portal_users")
                    .update({ last_login: new Date().toISOString() })
                    .eq("id", user.id);

                const { data: logRow, error: logError } = await supabase
                    .from("portal_logs")
                    .insert([{
                        portal_user_id: user.id,
                        employee_id: null,
                        tab_accessed: "Dashboard",
                        tab_history: [],
                    }])
                    .select("id")
                    .single();

                if (logError) {
                    console.error("Failed to create portal log:", logError);
                    showToast({
                        title: "Warning",
                        message: "Logged in but audit log failed.",
                        type: "error",
                    });
                } else if (logRow) {
                    currentLogId = logRow.id;
                    const firstEntryTime = new Date().toLocaleString("en-US", {
                        timeZone: "America/Chicago",
                        month: "2-digit",
                        day: "2-digit",
                        year: "numeric",
                        hour: "2-digit",
                        minute: "2-digit",
                        hour12: true,
                    });

                    currentTabHistory = [`Dashboard · ${firstEntryTime}`];

                    await supabase
                        .from("portal_logs")
                        .update({ tab_history: currentTabHistory })
                        .eq("id", currentLogId);
                }

                sessionStorage.setItem(
                    "portal_user",
                    JSON.stringify({
                        ...currentUser,
                        log_id: currentLogId || null
                    })
                );

                showToast({
                    title: "Login successful",
                    message: "Redirecting to the Executive Benefits Portal.",
                    type: "success",
                });

                setTimeout(() => showDashboard(), 700);
            } catch (err) {
                console.error("Login error", err);
                showToast({
                    title: "Login error",
                    message: "Unexpected error. See console for details.",
                    type: "error",
                });
            }
        }

        // ======================== LOGOUT LOGIC ========================
        const logoutButton = document.getElementById("logoutButton");
        logoutButton.addEventListener("click", handleLogout);

        async function handleLogout() {
            if (currentLogId) {
                try {
                    const { data: logRow } = await supabase
                        .from("portal_logs")
                        .select("login_time")
                        .eq("id", currentLogId)
                        .maybeSingle();

                    let duration = null;
                    if (logRow && logRow.login_time) {
                        const loginTime = new Date(logRow.login_time);
                        const now = new Date();
                        duration = Math.round((now - loginTime) / (1000 * 60));
                    }

                    await supabase
                        .from("portal_logs")
                        .update({
                            logout_time: new Date().toISOString(),
                            duration_minutes: duration,
                        })
                        .eq("id", currentLogId);
                } catch (err) {
                    console.error("Error recording logout", err);
                }
            }

            currentUser = null;
            currentLogId = null;
            sessionStorage.removeItem("portal_user");
            dashboardView.classList.add("hidden");
            loginView.classList.remove("hidden");
        }

        // ======================== AUTO LOGOUT ========================
        window.addEventListener('beforeunload', function(e) {
            if (currentLogId && currentUser) {
                const confirmationMessage = 'You are still logged in. Would you like to log out before closing?';
                e.preventDefault();
                e.returnValue = confirmationMessage;

                const logoutData = {
                    logout_time: new Date().toISOString(),
                    duration_minutes: null
                };

                const blob = new Blob([JSON.stringify({
                    logout_time: logoutData.logout_time,
                    duration_minutes: logoutData.duration_minutes
                })], { type: 'application/json' });

                navigator.sendBeacon(`${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentLogId}`, blob);

                return confirmationMessage;
            }
        });

        document.addEventListener('visibilitychange', async function() {
            if (document.visibilityState === 'hidden' && currentLogId) {
                try {
                    const { data: logRow } = await supabase
                        .from("portal_logs")
                        .select("login_time")
                        .eq("id", currentLogId)
                        .maybeSingle();

                    let duration = null;
                    if (logRow && logRow.login_time) {
                        const loginTime = new Date(logRow.login_time);
                        const now = new Date();
                        duration = Math.round((now - loginTime) / (1000 * 60));
                    }

                    await supabase
                        .from("portal_logs")
                        .update({
                            logout_time: new Date().toISOString(),
                            duration_minutes: duration,
                        })
                        .eq("id", currentLogId);

                    console.log("Auto-logged out due to tab close/hide");
                } catch (err) {
                    console.error("Visibility change logout error:", err);
                }
            }
        });

        // ======================== DASHBOARD SETUP ========================
        function showDashboard() {
            loginView.classList.add("hidden");
            dashboardView.classList.remove("hidden");
            updateHeaderUser();
            updateCycleStatusUI();
            applyRoleVisibility();
            loadSignedDocuments();
            loadPortalUsers();
        }

        function updateHeaderUser() {
            const nameEl = document.getElementById("headerUserName");
            const roleEl = document.getElementById("headerUserRole");
            if (!currentUser) {
                nameEl.textContent = "";
                roleEl.textContent = "";
                return;
            }
            nameEl.textContent = currentUser.full_name || currentUser.initials;
            const roleLabel = currentUser.role === "admin" ? "Administrator" : "Standard User";
            roleEl.textContent = `Logged in as ${roleLabel} (${currentUser.initials})`;
        }

        // ======================== CYCLE STATUS ========================
        const cycleStatusSelect = document.getElementById("cycleStatusSelect");
        const cycleStatusLabel = document.getElementById("cycleStatusLabel");
        const cycleStatusDescription = document.getElementById("cycleStatusDescription");

        function getCycleStatusMeta(value) {
            switch (value) {
                case "under_review":
                    return {
                        label: "Under Review",
                        color: "text-red-600",
                        description: "Use the analytics tab for renewal discussions and budgeting.",
                    };
                case "received":
                    return {
                        label: "Received",
                        color: "text-amber-600",
                        description: "All enrollment packets have been collected and are being checked.",
                    };
                case "verified":
                    return {
                        label: "Verified",
                        color: "text-emerald-600",
                        description: "Enrollment data, premiums, and plan mappings have been validated with the broker.",
                    };
                case "finalized":
                    return {
                        label: "Finalized",
                        color: "text-slate-700",
                        description: "The benefit cycle is complete. Elections have been transmitted and confirmed.",
                    };
                default:
                    return {
                        label: "Under Review",
                        color: "text-red-600",
                        description: "Use the analytics tab for renewal discussions and budgeting.",
                    };
            }
        }

        function updateCycleStatusUI() {
            const stored = localStorage.getItem("jc_cycle_status") || "under_review";
            cycleStatusSelect.value = stored;
            const meta = getCycleStatusMeta(stored);
            cycleStatusLabel.textContent = meta.label;
            cycleStatusLabel.className = "mt-2 text-base font-semibold " + meta.color;
            cycleStatusDescription.textContent = meta.description;
        }

        cycleStatusSelect.addEventListener("change", () => {
            if (
                !currentUser ||
                (!["PG", "GM", "JT"].includes(currentUser.initials) && currentUser.role !== "admin")
            ) {
                showToast({
                    title: "Not allowed",
                    message: "Only designated admins can change the cycle status.",
                    type: "error",
                });
                cycleStatusSelect.value = localStorage.getItem("jc_cycle_status") || "under_review";
                return;
            }
            const value = cycleStatusSelect.value;
            localStorage.setItem("jc_cycle_status", value);
            updateCycleStatusUI();
        });

        // ======================== ROLE-BASED VISIBILITY ========================
        function applyRoleVisibility() {
            const tabAnalytics = document.getElementById("tabAnalytics");
            const tabComparison = document.getElementById("tabComparison");
            const tabEmployeeList = document.getElementById("tabEmployeeList");
            const tabAudit = document.getElementById("tabAudit");
            const tabUsers = document.getElementById("tabUsers");
            const tabPermissions = document.getElementById("tabPermissions");

            const isAdmin = currentUser && currentUser.role === "admin";

            if (isAdmin) {
                const adminTabs = [tabAnalytics, tabComparison, tabEmployeeList, tabAudit, tabUsers];
                adminTabs.forEach(tab => {
                    if (tab) tab.classList.remove('hidden');
                });

                if (tabPermissions && ['PG', 'JT'].includes(currentUser.initials)) {
                    tabPermissions.classList.remove("hidden");
                } else if (tabPermissions) {
                    tabPermissions.classList.add("hidden");
                }
            } else {
                if (tabPermissions) tabPermissions.classList.add("hidden");
                const allowed = currentUser.allowed_tabs || ['docs'];

                if (tabAnalytics && allowed.includes('summary')) {
                    tabAnalytics.classList.remove("hidden");
                } else if (tabAnalytics) {
                    tabAnalytics.classList.add("hidden");
                }

                if (tabComparison && allowed.includes('comparison')) {
                    tabComparison.classList.remove("hidden");
                } else if (tabComparison) {
                    tabComparison.classList.add("hidden");
                }

                if (tabEmployeeList && allowed.includes('elections')) {
                    tabEmployeeList.classList.remove("hidden");
                } else if (tabEmployeeList) {
                    tabEmployeeList.classList.add("hidden");
                }

                if (tabAudit && allowed.includes('audit')) {
                    tabAudit.classList.remove("hidden");
                } else if (tabAudit) {
                    tabAudit.classList.add("hidden");
                }

                if (tabUsers && allowed.includes('users')) {
                    tabUsers.classList.remove("hidden");
                } else if (tabUsers) {
                    tabUsers.classList.add("hidden");
                }
            }
        }

        // ======================== TAB SWITCHING (FIXED) ========================
        const tabDocs = document.getElementById("tabDocs");
        const tabAnalytics = document.getElementById("tabAnalytics");
        const tabComparison = document.getElementById("tabComparison");
        const tabEmployeeList = document.getElementById("tabEmployeeList");
        const tabAudit = document.getElementById("tabAudit");
        const tabUsers = document.getElementById("tabUsers");
        const tabPermissions = document.getElementById("tabPermissions");

        const tabDocsContent = document.getElementById("tabDocsContent");
        const tabAnalyticsContent = document.getElementById("tabAnalyticsContent");
        const tabComparisonContent = document.getElementById("tabComparisonContent");
        const tabEmployeeListContent = document.getElementById("tabEmployeeListContent");
        const tabAuditContent = document.getElementById("tabAuditContent");
        const tabUsersContent = document.getElementById("tabUsersContent");
        const tabPermissionsContent = document.getElementById("tabPermissionsContent");

        function activateTab(key) {
            const tabs = {
                docs: { btn: tabDocs, content: tabDocsContent },
                analytics: { btn: tabAnalytics, content: tabAnalyticsContent },
                comparison: { btn: tabComparison, content: tabComparisonContent },
                employeelist: { btn: tabEmployeeList, content: tabEmployeeListContent },
                audit: { btn: tabAudit, content: tabAuditContent },
                users: { btn: tabUsers, content: tabUsersContent },
                permissions: { btn: tabPermissions, content: tabPermissionsContent },
            };

            // Update tab buttons
            Object.entries(tabs).forEach(([k, v]) => {
                if (!v.btn || !v.content) return;
                if (k === key) {
                    v.btn.classList.remove("tab-btn-inactive");
                    v.btn.classList.add("tab-btn-active");
                    v.content.classList.remove("hidden");
                    v.content.classList.add("active");
                } else {
                    v.btn.classList.remove("tab-btn-active");
                    v.btn.classList.add("tab-btn-inactive");
                    v.content.classList.add("hidden");
                    v.content.classList.remove("active");
                }
            });
        }

        if (tabDocs) {
            tabDocs.addEventListener("click", () => {
                activateTab("docs");
                loadSignedDocuments();
                logTabAccess("Signed Documents");
            });
        }

        if (tabAnalytics) {
            tabAnalytics.addEventListener("click", () => {
                activateTab("analytics");
                if (!analyticsRendered) loadAnalytics().then(() => (analyticsRendered = true));
                logTabAccess("Benefit Summary");
            });
        }

        if (tabComparison) {
            tabComparison.addEventListener("click", () => {
                activateTab("comparison");
                loadComparisonTab();
                logTabAccess("Employee Comparison");
            });
        }

        if (tabEmployeeList) {
            tabEmployeeList.addEventListener("click", () => {
                activateTab("employeelist");
                load2026EmployeeList();
                logTabAccess("2026 Employee Elections");
            });
        }

        if (tabAudit) {
            tabAudit.addEventListener("click", () => {
                activateTab("audit");
                loadAuditLogs();
                logTabAccess("Audit Logs");
            });
        }

        if (tabUsers) {
            tabUsers.addEventListener("click", () => {
                activateTab("users");
                logTabAccess("Authorized Users & Portal Credentials");
            });
        }

        if (tabPermissions) {
            tabPermissions.addEventListener("click", () => {
                activateTab("permissions");
                loadPermissionsTab();
                logTabAccess("Permissions");
            });
        }

        // ======================== SUB-TAB SWITCHING (NEW - FIXED) ========================
        document.querySelectorAll('.analytics-tab-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const tabId = e.currentTarget.id.replace('analytics-tab-', '');
                
                // Update buttons
                document.querySelectorAll('.analytics-tab-btn').forEach(b => {
                    b.classList.remove('border-white', 'text-white', 'font-semibold');
                    b.classList.add('border-transparent', 'text-slate-300', 'font-medium');
                });
                e.currentTarget.classList.add('border-white', 'text-white', 'font-semibold');
                e.currentTarget.classList.remove('border-transparent', 'text-slate-300', 'font-medium');
                
                // Update content
                document.querySelectorAll('.sub-tab-content').forEach(c => {
                    c.classList.remove('active');
                    c.classList.add('hidden');
                });
                const targetContent = document.getElementById(`analytics-content-${tabId}`);
                if (targetContent) {
                    targetContent.classList.add('active');
                    targetContent.classList.remove('hidden');
                }
            });
        });

        // ======================== SIGNED DOCUMENTS FUNCTIONS ========================
        async function loadSignedDocuments() {
            const tbody = document.getElementById("docBody");
            tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">Loading signed documents...</td></tr>';

            try {
                const data = await safeSupabaseQuery(
                    supabase
                        .from("employees2025")
                        .select("id, first_name, last_name, username, signed_pdf_url")
                        .not("signed_pdf_url", "is", null),
                    "Loading signed documents"
                );

                docsCache = (data || []).sort((a, b) => a.last_name.localeCompare(b.last_name));
                renderDocsTable();
                document.getElementById("summarySignedEmployees").textContent = docsCache.length;
            } catch (err) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-red-500">Error loading documents.</td></tr>';
            }
        }

        function renderDocsTable() {
            const tbody = document.getElementById("docBody");
            const search = document.getElementById("docSearch").value.trim().toLowerCase();
            let rows = docsCache;

            if (search) {
                rows = rows.filter((r) => r.last_name.toLowerCase().includes(search));
            }

            document.getElementById("docSignedCount").textContent = docsCache.length;

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="4" class="px-4 py-4 text-center text-xs text-slate-500">No employees match your search.</td></tr>';
                return;
            }

            tbody.innerHTML = "";
            rows.forEach((row, index) => {
                const rowNumber = index + 1;
                const fullName = `${row.last_name}, ${row.first_name}`;
                const pdfActions = row.signed_pdf_url
                    ? `<button class="inline-flex items-center gap-1 text-xs text-[color:var(--jc-red)] hover:underline mr-3" onclick="window.open('${esc(row.signed_pdf_url)}','_blank')">
                         <i class="fa-solid fa-file-pdf"></i><span>View PDF</span>
                       </button>
                       <button class="inline-flex items-center gap-1 text-xs text-slate-600 hover:text-slate-900" onclick="window.open('${esc(row.signed_pdf_url)}','_blank')">
                         <i class="fa-solid fa-print"></i><span>Print</span>
                       </button>`
                    : '<span class="text-xs text-slate-400">N/A</span>';

                tbody.insertAdjacentHTML("beforeend", `
                    <tr class="hover:bg-slate-50">
                        <td class="px-4 py-2.5 text-xs text-slate-500">${rowNumber}</td>
                        <td class="px-4 py-2.5 text-sm">${esc(fullName)}</td>
                        <td class="px-4 py-2.5 text-sm">${esc(row.username || "")}</td>
                        <td class="px-4 py-2.5 text-sm">${pdfActions}</td>
                    </tr>
                `);
            });
        }

        document.getElementById("docSearch").addEventListener("input", renderDocsTable);

        document.getElementById("printAllButton").addEventListener("click", () => {
            if (!docsCache.length) {
                showToast({
                    title: "No documents",
                    message: "There are no signed PDFs to print.",
                    type: "error",
                });
                return;
            }
            docsCache.forEach((d) => {
                if (d.signed_pdf_url) window.open(d.signed_pdf_url, "_blank");
            });
            showToast({
                title: "Print initiated",
                message: "Opened all PDFs in new tabs. Use browser print to continue.",
                type: "success",
            });
        });

        document.getElementById("mergeAllButton").addEventListener("click", async () => {
            if (!docsCache.length) {
                showToast({
                    title: "No documents",
                    message: "There are no signed PDFs to merge.",
                    type: "error",
                });
                return;
            }

            showToast({
                title: "Processing...",
                message: "Merging all signed documents. This may take a moment.",
                type: "info",
            });

            try {
                const employeeIds = docsCache.map((d) => d.id);
                const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        apikey: SUPABASE_KEY,
                        Authorization: `Bearer ${SUPABASE_KEY}`,
                    },
                    body: JSON.stringify({ employee_ids: employeeIds }),
                });

                const contentType = res.headers.get("content-type");

                if (!res.ok) {
                    let errorMessage = "Edge function returned an error.";
                    if (contentType?.includes("application/json")) {
                        const errorData = await res.json();
                        errorMessage = errorData.message || errorMessage;
                    } else {
                        const errorText = await res.text();
                        console.error("Non-JSON error response:", errorText);
                        errorMessage = `Server error: ${res.status}`;
                    }
                    showToast({
                        title: "Merge failed",
                        message: errorMessage,
                        type: "error",
                    });
                    return;
                }

                if (contentType?.includes("application/pdf") || contentType?.includes("application/octet-stream")) {
                    const blob = await res.blob();
                    const url = URL.createObjectURL(blob);
                    window.open(url, "_blank");
                    showToast({
                        title: "Merge complete",
                        message: "Combined PDF is ready and opened in a new tab.",
                        type: "success",
                    });
                } else {
                    throw new Error(`Unexpected content type: ${contentType}`);
                }
            } catch (err) {
                console.error("merge error", err);
                showToast({
                    title: "Merge failed",
                    message: err.message || "Unexpected error. See console for details.",
                    type: "error",
                });
            }
        });

        // ======================== ANALYTICS FUNCTIONS ========================
        async function ensureBenefitRatesLoaded() {
            if (benefitRates.length) return;
            const { data, error } = await supabase
                .from("benefit_rates")
                .select("plan_code, tier, coverage, amount, effective_year");
            if (!error && data) benefitRates = data;
        }

        function getRateAmount(year, coverage, tier, planCode) {
            if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
            const row = benefitRates.find(
                (r) =>
                    String(r.effective_year) === String(year) &&
                    (r.coverage || "").toLowerCase() === coverage.toLowerCase() &&
                    r.tier === tier &&
                    r.plan_code === planCode
            );
            return row ? parseFloat(row.amount) || 0 : 0;
        }

        function summarizePlanCounts(enrollments) {
            const stats = {};
            YEARS.forEach((y) => {
                stats[y] = { medical: {}, dental: {}, vision: {} };
            });

            enrollments.forEach((e) => {
                if (!YEARS.includes(e.benefit_year)) return;
                const yearStats = stats[e.benefit_year];
                const normalize = (p) => (!p || p === "NO" || (p + "").toUpperCase().includes("WAIVE") ? "WAIVE" : p);
                const mp = normalize(e.medical_plan);
                const dp = normalize(e.dental_plan);
                const vp = normalize(e.vision_plan);

                yearStats.medical[mp] = (yearStats.medical[mp] || 0) + 1;
                yearStats.dental[dp] = (yearStats.dental[dp] || 0) + 1;
                yearStats.vision[vp] = (yearStats.vision[vp] || 0) + 1;
            });

            return stats;
        }

        function prettyPlanName(coverage, code) {
            if (!code || code === "WAIVE" || code === "NO") return "Waived Coverage";
            const healthMap = {
                ATBAB303: "HMO / ATBAB303",
                ATBCB402: "PPO / ATBCB402",
                ATBAP393: "HMO HSA / ATBAP393",
            };
            const dentalMap = {
                F_PLAN_2W: "F-PLAN 2W / Base MAC",
                F_PLAN_3W: "F-PLAN 3W / Buy Up MAC",
            };
            const visionMap = {
                PLAN_1: "Vision Plan 1",
            };

            if (coverage === "medical") return healthMap[code] || code;
            if (coverage === "dental") return dentalMap[code] || code;
            if (coverage === "vision") return visionMap[code] || code;
            return code;
        }

        function buildCoverageSection(title, yearLabel, coverageKey, countsObj) {
            const entries = Object.entries(countsObj || {});
            if (!entries.length) return "";

            const waived = entries.filter(([code]) => code === "WAIVE");
            const others = entries
                .filter(([code]) => code !== "WAIVE")
                .sort((a, b) => prettyPlanName(coverageKey, a[0]).localeCompare(prettyPlanName(coverageKey, b[0])));

            const rows = [...waived, ...others]
                .map(([code, count]) => `
                    <tr class="border-t border-slate-100">
                        <td class="py-1.5 pr-2 text-slate-700">${esc(prettyPlanName(coverageKey, code))}</td>
                        <td class="py-1.5 pl-2 text-right text-slate-800 font-semibold">${count}</td>
                    </tr>
                `).join("");

            return `
                <section class="mt-4">
                    <h4 class="text-xs font-semibold text-slate-700">${title} (${yearLabel})</h4>
                    <table class="w-full mt-2 text-xs">
                        <thead>
                            <tr class="text-slate-500">
                                <th class="text-left font-semibold tracking-[0.12em] uppercase">Plan</th>
                                <th class="text-right font-semibold tracking-[0.12em] uppercase">Employees</th>
                            </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                    </table>
                </section>
            `;
        }

        async function loadAnalytics() {
            try {
                showToast({
                    title: "Loading Analytics",
                    message: "Fetching enrollment data from database...",
                    type: "info"
                });

                // Fetch signed employees + enrollments
                const [{ data: employees }, { data: enrollments }] = await Promise.all([
                    supabase
                        .from("employees2025")
                        .select("id, first_name, last_name, username, signed_pdf_url")
                        .not("signed_pdf_url", "is", null)
                        .order("last_name", { ascending: true }),
                    supabase
                        .from("benefit_enrollments")
                        .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan, beneficiaries")
                        .in("benefit_year", YEARS),
                ]);

                // Build employee map
                const byUsername = new Map();
                (employees || []).forEach((emp) => {
                    byUsername.set(emp.username, {
                        employee: emp,
                        byYear: { 2025: null, 2026: null },
                    });
                });

                (enrollments || []).forEach((enr) => {
                    const rec = byUsername.get(enr.username);
                    if (!rec) return;
                    rec.byYear[enr.benefit_year] = enr;
                });

                analyticsEmployees = Array.from(byUsername.values()).filter(
                    (x) => x.byYear[2025] || x.byYear[2026]
                );

                const validUsernames = new Set(analyticsEmployees.map((r) => r.employee.username));
                const filteredEnrollments = (enrollments || []).filter((e) => validUsernames.has(e.username));

                // Generate stats
                const stats = summarizePlanCounts(filteredEnrollments);
                planYearStats = stats;

                // Update KPIs
                const enrollments2026 = filteredEnrollments.filter(e => e.benefit_year === 2026);
                const enrollments2025 = filteredEnrollments.filter(e => e.benefit_year === 2025);

                const totalEnrolled2026 = enrollments2026.length;
                const totalEnrolled2025 = enrollments2025.length;
                const enrolledChange = totalEnrolled2025 > 0 
                    ? ((totalEnrolled2026 - totalEnrolled2025) / totalEnrolled2025 * 100).toFixed(1) 
                    : 0;
                
                document.getElementById("kpi-total-enrolled").textContent = totalEnrolled2026;
                document.getElementById("kpi-total-change").innerHTML = `
                    <i class="fa-solid fa-arrow-${enrolledChange >= 0 ? 'up' : 'down'} mr-1"></i>
                    ${enrolledChange >= 0 ? '+' : ''}${enrolledChange}% vs 2025
                `;

                const medicalCount = enrollments2026.filter(e => e.medical_plan && e.medical_plan !== 'WAIVE').length;
                const medicalRate = ((medicalCount / totalEnrolled2026) * 100).toFixed(1);
                document.getElementById("kpi-medical-count").textContent = medicalCount;
                document.getElementById("kpi-medical-rate").textContent = `${medicalRate}% participation rate`;

                const dentalCount = enrollments2026.filter(e => e.dental_plan && e.dental_plan !== 'WAIVE').length;
                const dentalRate = ((dentalCount / totalEnrolled2026) * 100).toFixed(1);
                document.getElementById("kpi-dental-count").textContent = dentalCount;
                document.getElementById("kpi-dental-rate").textContent = `${dentalRate}% participation rate`;

                const lifeCount = enrollments2026.filter(e =>
                    Array.isArray(e.beneficiaries) && e.beneficiaries.length > 0
                ).length;
                const lifeRate = ((lifeCount / totalEnrolled2026) * 100).toFixed(1);
                document.getElementById("kpi-life-count").textContent = lifeCount;
                document.getElementById("kpi-life-rate").textContent = `${lifeRate}% coverage rate`;

                // Calculate costs
                await ensureBenefitRatesLoaded();
                
                let totalAnnualCost = 0;
                enrollments2026.forEach(e => {
                    const tier = e.tier_election || 'EO';
                    const medCost = getRateAmount(2026, 'medical', tier, e.medical_plan) * 26;
                    const denCost = getRateAmount(2026, 'dental', tier, e.dental_plan) * 26;
                    const visCost = getRateAmount(2026, 'vision', tier, e.vision_plan) * 26;
                    totalAnnualCost += medCost + denCost + visCost;
                });

                let totalAnnualCost2025 = 0;
                enrollments2025.forEach(e => {
                    const tier = e.tier_election || 'EO';
                    const medCost = getRateAmount(2025, 'medical', tier, e.medical_plan) * 26;
                    const denCost = getRateAmount(2025, 'dental', tier, e.dental_plan) * 26;
                    const visCost = getRateAmount(2025, 'vision', tier, e.vision_plan) * 26;
                    totalAnnualCost2025 += medCost + denCost + visCost;
                });

                const costChange = totalAnnualCost2025 > 0 
                    ? ((totalAnnualCost - totalAnnualCost2025) / totalAnnualCost2025 * 100).toFixed(1) 
                    : 0;

                document.getElementById("kpi-total-cost").textContent = 
                    `$${(totalAnnualCost / 1000).toFixed(0)}K`;
                document.getElementById("kpi-cost-change").innerHTML = `
                    <i class="fa-solid fa-arrow-${costChange >= 0 ? 'up' : 'down'} mr-1"></i>
                    ${costChange >= 0 ? '+' : ''}${costChange}% vs 2025
                `;

                // Render charts
                renderAnalyticsCharts(stats[2026], enrollments2026);
                renderComparisonBarCharts(stats);
                await renderTierBreakdownTable();
                renderPlanYearCards(stats);
                await loadCostBreakdownTable();

                showToast({
                    title: "Analytics Loaded",
                    message: `Displaying data for ${totalEnrolled2026} employees`,
                    type: "success"
                });
            } catch (err) {
                console.error("Analytics load error:", err);
                showToast({
                    title: "Load Error",
                    message: "Failed to load analytics: " + (err.message || ""),
                    type: "error"
                });
            }
        }

        // Continue with chart rendering functions...
        function renderAnalyticsCharts(stats, enrollments) {
            if (!stats) return;

            // Medical Chart
            const medicalData = stats.medical || {};
            const medicalLabels = Object.keys(medicalData)
                .filter(k => k !== 'WAIVE')
                .map(k => prettyPlanName('medical', k));
            const medicalValues = Object.keys(medicalData)
                .filter(k => k !== 'WAIVE')
                .map(k => medicalData[k]);
            
            const ctxMed = document.getElementById('chartMedical2026');
            if (ctxMed) {
                if (ctxMed.chart) ctxMed.chart.destroy();
                ctxMed.chart = new Chart(ctxMed, {
                    type: 'bar',
                    data: {
                        labels: medicalLabels,
                        datasets: [{
                            label: 'Employees Enrolled',
                            data: medicalValues,
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: 'rgba(220, 38, 38, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 30,
                                bottom: 5,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} employees`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#1f2937',
                                font: { size: 14, weight: 'bold' },
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5, font: { size: 11 } },
                                title: {
                                    display: true,
                                    text: 'Number of Employees',
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Dental Chart
            const dentalData = stats.dental || {};
            const dentalLabels = Object.keys(dentalData)
                .filter(k => k !== 'WAIVE')
                .map(k => prettyPlanName('dental', k));
            const dentalValues = Object.keys(dentalData)
                .filter(k => k !== 'WAIVE')
                .map(k => dentalData[k]);
            
            const ctxDen = document.getElementById('chartDental2026');
            if (ctxDen) {
                if (ctxDen.chart) ctxDen.chart.destroy();
                ctxDen.chart = new Chart(ctxDen, {
                    type: 'bar',
                    data: {
                        labels: dentalLabels,
                        datasets: [{
                            label: 'Employees Enrolled',
                            data: dentalValues,
                            backgroundColor: 'rgba(37, 99, 235, 0.8)',
                            borderColor: 'rgba(37, 99, 235, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 30,
                                bottom: 5,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} employees`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#1f2937',
                                font: { size: 14, weight: 'bold' },
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5, font: { size: 11 } },
                                title: {
                                    display: true,
                                    text: 'Number of Employees',
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Vision Chart
            const visionData = stats.vision || {};
            const visionLabels = Object.keys(visionData)
                .filter(k => k !== 'WAIVE')
                .map(k => prettyPlanName('vision', k));
            const visionValues = Object.keys(visionData)
                .filter(k => k !== 'WAIVE')
                .map(k => visionData[k]);
            
            const ctxVis = document.getElementById('chartVision2026');
            if (ctxVis) {
                if (ctxVis.chart) ctxVis.chart.destroy();
                ctxVis.chart = new Chart(ctxVis, {
                    type: 'bar',
                    data: {
                        labels: visionLabels,
                        datasets: [{
                            label: 'Employees Enrolled',
                            data: visionValues,
                            backgroundColor: 'rgba(71, 85, 105, 0.8)',
                            borderColor: 'rgba(71, 85, 105, 1)',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 30,
                                bottom: 5,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} employees`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#1f2937',
                                font: { size: 14, weight: 'bold' },
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5, font: { size: 11 } },
                                title: {
                                    display: true,
                                    text: 'Number of Employees',
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }

            // Life Chart
            const lifeCount = enrollments.filter(e => 
                Array.isArray(e.beneficiaries) && e.beneficiaries.length > 0
            ).length;
            const noLifeCount = enrollments.length - lifeCount;
            
            const ctxLife = document.getElementById('chartLife2026');
            if (ctxLife) {
                if (ctxLife.chart) ctxLife.chart.destroy();
                ctxLife.chart = new Chart(ctxLife, {
                    type: 'bar',
                    data: {
                        labels: ['Has Coverage', 'No Coverage'],
                        datasets: [{
                            label: 'Employees',
                            data: [lifeCount, noLifeCount],
                            backgroundColor: ['rgba(5, 150, 105, 0.8)', 'rgba(203, 213, 225, 0.8)'],
                            borderColor: ['rgba(5, 150, 105, 1)', 'rgba(203, 213, 225, 1)'],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 30,
                                bottom: 5,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.parsed.y} employees`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#1f2937',
                                font: { size: 14, weight: 'bold' },
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5, font: { size: 11 } },
                                title: {
                                    display: true,
                                    text: 'Number of Employees',
                                    font: { size: 12, weight: 'bold' }
                                }
                            },
                            x: { ticks: { font: { size: 10 } } }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            }
        }

        // Comparison bar charts
        function renderComparisonBarCharts(stats) {
            try {
                renderBarChart('chartMedicalComparison', 'Medical Plan Enrollment', stats, 'medical');
                renderBarChart('chartDentalComparison', 'Dental Plan Enrollment', stats, 'dental');
                renderBarChart('chartVisionComparison', 'Vision Plan Enrollment', stats, 'vision');
            } catch (err) {
                console.error("Error rendering bar charts:", err);
            }
        }

        function renderBarChart(canvasId, title, stats, coverage) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;

            try {
                if (ctx.chart) {
                    ctx.chart.destroy();
                }

                const plans2026 = stats[2026]?.[coverage] || {};
                const plans2025 = stats[2025]?.[coverage] || {};
                
                const allPlans = [...new Set([
                    ...Object.keys(plans2026),
                    ...Object.keys(plans2025)
                ])].filter(plan => plan !== 'WAIVE');

                const labels = allPlans.map(plan => prettyPlanName(coverage, plan));
                const data2025 = allPlans.map(plan => plans2025[plan] || 0);
                const data2026 = allPlans.map(plan => plans2026[plan] || 0);

                const colors = {
                    medical: {
                        2025: 'rgba(220, 38, 38, 0.6)',
                        2026: 'rgba(220, 38, 38, 1)',
                    },
                    dental: {
                        2025: 'rgba(37, 99, 235, 0.6)',
                        2026: 'rgba(37, 99, 235, 1)',
                    },
                    vision: {
                        2025: 'rgba(71, 85, 105, 0.6)',
                        2026: 'rgba(71, 85, 105, 1)',
                    }
                };

                const colorScheme = colors[coverage];

                ctx.chart = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: '2025',
                                data: data2025,
                                backgroundColor: colorScheme['2025'],
                                borderWidth: 0
                            },
                            {
                                label: '2026',
                                data: data2026,
                                backgroundColor: colorScheme['2026'],
                                borderWidth: 0
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        layout: {
                            padding: {
                                top: 30,
                                bottom: 5,
                                left: 10,
                                right: 10
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top',
                                labels: {
                                    font: { size: 11, weight: 'bold' },
                                    padding: 10,
                                    usePointStyle: true
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const year = context.dataset.label;
                                        const value = context.parsed.y;
                                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                        const percentage = total > 0 ? ((value / total) * 100).toFixed(1) : 0;
                                        return `${year}: ${value} employees (${percentage}%)`;
                                    }
                                }
                            },
                            datalabels: {
                                anchor: 'end',
                                align: 'top',
                                color: '#1f2937',
                                font: { size: 12, weight: 'bold' },
                                formatter: function(value) {
                                    return value;
                                }
                            }
                        },
                        scales: {
                            x: {
                                grid: { display: false },
                                ticks: { font: { size: 10 } }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { stepSize: 5, font: { size: 10 } },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' }
                            }
                        }
                    },
                    plugins: [ChartDataLabels]
                });
            } catch (err) {
                console.error(`Error rendering ${coverage} bar chart:`, err);
            }
        }

        // Tier breakdown table
        async function renderTierBreakdownTable() {
            const container = document.getElementById("tier-breakdown-container");
            if (!container) return;

            const ratesByYear = await loadBenefitRatesWithTiers();
            
            const plansByType = {
                medical: new Set(),
                dental: new Set(),
                vision: new Set()
            };

            benefitRates.forEach(rate => {
                if (rate.effective_year === 2026) {
                    const coverage = (rate.coverage || '').toLowerCase();
                    if (plansByType[coverage]) {
                        plansByType[coverage].add(rate.plan_code);
                    }
                }
            });

            let html = '<div class="space-y-8">';

            if (plansByType.medical.size > 0) {
                html += renderCoverageTypeBreakdown('medical', 'Medical Plans', plansByType.medical, ratesByYear);
            }
            if (plansByType.dental.size > 0) {
                html += renderCoverageTypeBreakdown('dental', 'Dental Plans', plansByType.dental, ratesByYear);
            }
            if (plansByType.vision.size > 0) {
                html += renderCoverageTypeBreakdown('vision', 'Vision Plans', plansByType.vision, ratesByYear);
            }

            html += '</div>';
            container.innerHTML = html;
        }

        async function loadBenefitRatesWithTiers() {
            try {
                const { data, error } = await supabase
                    .from("benefit_rates")
                    .select("*")
                    .in("effective_year", [2025, 2026])
                    .order("coverage", { ascending: true })
                    .order("plan_code", { ascending: true })
                    .order("tier", { ascending: true });

                if (error) throw error;

                benefitRates = data || [];
                
                const ratesByYear = {
                    2025: {},
                    2026: {}
                };

                benefitRates.forEach(rate => {
                    const year = rate.effective_year;
                    const coverage = (rate.coverage || '').toLowerCase();
                    const key = `${coverage}_${rate.plan_code}_${rate.tier}`;
                    ratesByYear[year][key] = rate;
                });

                return ratesByYear;
            } catch (err) {
                console.error("Failed to load benefit rates:", err);
                return { 2025: {}, 2026: {} };
            }
        }

        function renderCoverageTypeBreakdown(coverage, title, plans, ratesByYear) {
            const tiers = ['EO', 'ES', 'EC', 'EF'];
            const tierNames = {
                'EO': 'Employee Only',
                'ES': 'Employee + Spouse',
                'EC': 'Employee + Child(ren)',
                'EF': 'Employee + Family'
            };

            let html = `
                <div class="card overflow-hidden">
                    <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-6 py-4">
                        <h4 class="text-lg font-bold text-white flex items-center gap-3">
                            <i class="fa-solid fa-${coverage === 'medical' ? 'heart-pulse' : coverage === 'dental' ? 'tooth' : 'eye'}"></i>
                            ${title} - Tier Rate Breakdown
                        </h4>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="min-w-full text-sm">
                            <thead class="bg-slate-100 border-b-2 border-slate-200">
                                <tr>
                                    <th class="text-left px-4 py-3 text-xs font-bold text-slate-700 uppercase">Plan</th>
                                    <th class="text-left px-4 py-3 text-xs font-bold text-slate-700 uppercase">Tier</th>
                                    <th class="text-right px-4 py-3 text-xs font-bold text-slate-700 uppercase">2025 Bi-Weekly</th>
                                    <th class="text-right px-4 py-3 text-xs font-bold text-slate-700 uppercase">2026 Bi-Weekly</th>
                                    <th class="text-right px-4 py-3 text-xs font-bold text-slate-700 uppercase">Change</th>
                                    <th class="text-right px-4 py-3 text-xs font-bold text-slate-700 uppercase">Annual (2026)</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
            `;

            plans.forEach((planCode) => {
                const planName = prettyPlanName(coverage, planCode);
                
                tiers.forEach((tier, tierIndex) => {
                    const key = `${coverage}_${planCode}_${tier}`;
                    const rate2025 = ratesByYear[2025][key];
                    const rate2026 = ratesByYear[2026][key];

                    const amount2025 = rate2025 ? parseFloat(rate2025.amount) : 0;
                    const amount2026 = rate2026 ? parseFloat(rate2026.amount) : 0;
                    const change = amount2026 - amount2025;
                    const changePercent = amount2025 > 0 ? ((change / amount2025) * 100) : 0;
                    const annual2026 = amount2026 * 26;

                    const changeColor = change > 0 ? 'text-red-600' : change < 0 ? 'text-emerald-600' : 'text-slate-500';
                    const changeIcon = change > 0 ? 'fa-arrow-up' : change < 0 ? 'fa-arrow-down' : 'fa-minus';

                    html += `
                        <tr class="hover:bg-slate-50">
                            ${tierIndex === 0 ? `
                                <td class="px-4 py-3 font-semibold text-slate-900" rowspan="${tiers.length}">
                                    ${planName}
                                </td>
                            ` : ''}
                            <td class="px-4 py-3">
                                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-blue-50 text-blue-700 text-xs font-semibold border border-blue-200">
                                    ${tier} <span class="text-blue-500">·</span> ${tierNames[tier]}
                                </span>
                            </td>
                            <td class="text-right px-4 py-3 font-mono text-slate-700">
                                ${formatCurrency(amount2025)}
                                <div class="text-xs text-slate-500">per pay</div>
                            </td>
                            <td class="text-right px-4 py-3 font-mono font-semibold text-slate-900">
                                ${formatCurrency(amount2026)}
                                <div class="text-xs text-slate-500">per pay</div>
                            </td>
                            <td class="text-right px-4 py-3">
                                <div class="${changeColor} font-semibold flex items-center justify-end gap-1">
                                    <i class="fa-solid ${changeIcon} text-xs"></i>
                                    <span>${formatCurrency(Math.abs(change))}</span>
                                    ${changePercent !== 0 ? `<span class="text-xs">(${changePercent.toFixed(1)}%)</span>` : ''}
                                </div>
                            </td>
                            <td class="text-right px-4 py-3 font-mono font-semibold text-slate-900">
                                ${formatCurrency(annual2026)}
                                <div class="text-xs text-slate-500">per year</div>
                            </td>
                        </tr>
                    `;
                });
            });

            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;

            return html;
        }

        // Plan year cards
        function renderPlanYearCards(stats) {
            const card2025 = document.getElementById("planCard2025");
            const card2026 = document.getElementById("planCard2026");

            if (card2025) {
                card2025.innerHTML = `
                    <div class="mb-4">
                        <span class="pill-badge inline-flex items-center bg-slate-900 text-slate-50 px-3 py-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-400 mr-1.5"></span>Baseline Year
                        </span>
                        <h3 class="mt-3 text-xl font-bold text-slate-900">2025 Elections</h3>
                    </div>
                    ${buildCoverageSection("Health Plans", "2025", "medical", stats[2025]?.medical || {})}
                    ${buildCoverageSection("Dental Plans", "2025", "dental", stats[2025]?.dental || {})}
                    ${buildCoverageSection("Vision Plans", "2025", "vision", stats[2025]?.vision || {})}
                `;
            }

            if (card2026) {
                card2026.innerHTML = `
                    <div class="mb-4">
                        <span class="pill-badge inline-flex items-center bg-emerald-50 text-emerald-700 border border-emerald-100 px-3 py-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 mr-1.5"></span>Active Year
                        </span>
                        <h3 class="mt-3 text-xl font-bold text-slate-900">2026 Elections</h3>
                    </div>
                    ${buildCoverageSection("Health Plans", "2026", "medical", stats[2026]?.medical || {})}
                    ${buildCoverageSection("Dental Plans", "2026", "dental", stats[2026]?.dental || {})}
                    ${buildCoverageSection("Vision Plans", "2026", "vision", stats[2026]?.vision || {})}
                `;
            }
        }

        // Cost breakdown table
        async function loadCostBreakdownTable() {
            try {
                const { data: rates, error: ratesError } = await supabase
                    .from("benefit_rates")
                    .select("*");
                
                if (ratesError) throw ratesError;
                
                const { data: enrollments, error: enrollError } = await supabase
                    .from("benefit_enrollments")
                    .select("*")
                    .eq("benefit_year", 2026);
                
                if (enrollError) throw enrollError;

                const tableBody = document.getElementById("cost-breakdown-table-body");
                if (!tableBody) return;
                
                tableBody.innerHTML = "";

                let totalEnrolled = 0;
                let totalAnnualCost = 0;

                const coverageTypes = [
                    { type: "medical", icon: "fa-heart-pulse", color: "red", label: "Medical" },
                    { type: "dental", icon: "fa-tooth", color: "blue", label: "Dental" },
                    { type: "vision", icon: "fa-eye", color: "slate", label: "Vision" },
                    { type: "life", icon: "fa-shield-heart", color: "teal", label: "Life & AD&D" }
                ];

                for (const coverage of coverageTypes) {
                    const coverageRates = rates.filter(r => 
                        r.coverage && r.coverage.toLowerCase() === coverage.type && r.effective_year === 2026
                    );

                    const plansByTier = {};
                    coverageRates.forEach(rate => {
                        if (!plansByTier[rate.plan_code]) {
                            plansByTier[rate.plan_code] = {};
                        }
                        plansByTier[rate.plan_code][rate.tier] = parseFloat(rate.amount || 0);
                    });

                    const enrollmentCounts = {};
                    enrollments.forEach(e => {
                        let planField, tierField;
                        
                        if (coverage.type === "medical") {
                            planField = "medical_plan";
                            tierField = "tier_election";
                        } else if (coverage.type === "dental") {
                            planField = "dental_plan";
                            tierField = "tier_election";
                        } else if (coverage.type === "vision") {
                            planField = "vision_plan";
                            tierField = "tier_election";
                        } else if (coverage.type === "life") {
                            if (Array.isArray(e.beneficiaries) && e.beneficiaries.length > 0) {
                                const key = "LIFE_BASIC";
                                enrollmentCounts[key] = (enrollmentCounts[key] || 0) + 1;
                            }
                            return;
                        }
                        
                        const plan = e[planField];
                        const tier = e[tierField];

                        if (plan && plan !== "WAIVE") {
                            const key = `${plan}_${tier}`;
                            enrollmentCounts[key] = (enrollmentCounts[key] || 0) + 1;
                        }
                    });

                    Object.keys(plansByTier).sort().forEach((planCode, planIdx) => {
                        const tiers = plansByTier[planCode];
                        
                        Object.keys(tiers).sort().forEach((tier, tierIdx) => {
                            const rate = tiers[tier];
                            const key = `${planCode}_${tier}`;
                            const count = enrollmentCounts[key] || 0;
                            const annualCost = rate * 26 * count;

                            totalEnrolled += count;
                            totalAnnualCost += annualCost;

                            const row = document.createElement("tr");
                            row.className = "hover:bg-slate-50 transition-colors";
                            row.innerHTML = `
                                <td class="px-6 py-4">
                                    ${tierIdx === 0 && planIdx === 0 ? `
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-${coverage.color}-500 to-${coverage.color}-600 flex items-center justify-center">
                                                <i class="fa-solid ${coverage.icon} text-white text-xs"></i>
                                            </div>
                                            <span class="font-semibold text-slate-900">${coverage.label}</span>
                                        </div>
                                    ` : ''}
                                </td>
                                <td class="px-6 py-4">
                                    <div class="text-sm">
                                        <div class="font-medium text-slate-900">${prettyPlanName(coverage.type, planCode)}</div>
                                        <div class="text-xs text-slate-500">${tier}</div>
                                    </div>
                                </td>
                                <td class="px-6 py-4 text-right font-mono text-sm text-slate-900">
                                    $${rate.toFixed(2)}
                                </td>
                                <td class="px-6 py-4 text-right font-semibold text-slate-900">
                                    ${count}
                                </td>
                                <td class="px-6 py-4 text-right font-mono font-semibold text-slate-900">
                                    $${annualCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                </td>
                            `;
                            tableBody.appendChild(row);
                        });
                    });

                    if (coverage.type === "life") {
                        const lifeCount = enrollmentCounts["LIFE_BASIC"] || 0;
                        totalEnrolled += lifeCount;

                        const row = document.createElement("tr");
                        row.className = "hover:bg-slate-50 transition-colors";
                        row.innerHTML = `
                            <td class="px-6 py-4">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-${coverage.color}-500 to-${coverage.color}-600 flex items-center justify-center">
                                        <i class="fa-solid ${coverage.icon} text-white text-xs"></i>
                                    </div>
                                    <span class="font-semibold text-slate-900">${coverage.label}</span>
                                </div>
                            </td>
                            <td class="px-6 py-4">
                                <div class="text-sm">
                                    <div class="font-medium text-slate-900">Basic Life & AD&D</div>
                                    <div class="text-xs text-slate-500">All Tiers</div>
                                </div>
                            </td>
                            <td class="px-6 py-4 text-right">
                                <span class="inline-flex items-center gap-2 px-3 py-1 rounded-full bg-emerald-50 text-emerald-700 text-xs font-bold border border-emerald-200">
                                    <i class="fa-solid fa-gift"></i> EMPLOYER PAID
                                </span>
                            </td>
                            <td class="px-6 py-4 text-right font-semibold text-slate-900">
                                ${lifeCount}
                            </td>
                            <td class="px-6 py-4 text-right font-mono font-semibold text-slate-900">
                                $0.00
                            </td>
                        `;
                        tableBody.appendChild(row);
                    }
                }

                document.getElementById("total-enrolled").textContent = totalEnrolled.toLocaleString();
                document.getElementById("total-annual-cost").textContent = 
                    `$${totalAnnualCost.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;

            } catch (error) {
                console.error("Error loading cost breakdown:", error);
                showToast({
                    title: "Load Error",
                    message: "Failed to load cost breakdown table",
                    type: "error"
                });
            }
        }

        // Continue in next message with comparison tab, employee list, audit logs, users, permissions, and modal functions...
        
    </script>
<script>
        // ======================== COMPARISON TAB FUNCTIONS ========================
        async function loadComparisonTab() {
            if (comparisonRendered) return;

            const listEl = document.getElementById("comparisonEmployeeList");
            listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">Loading employees...</li>';

            try {
                const [{ data: employees }, { data: enrollments }] = await Promise.all([
                    supabase
                        .from("employees2025")
                        .select("id, first_name, last_name, username, signed_pdf_url")
                        .not("signed_pdf_url", "is", null)
                        .order("last_name", { ascending: true }),
                    supabase
                        .from("benefit_enrollments")
                        .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
                        .in("benefit_year", [2025, 2026]),
                ]);

                const byUsername = new Map();
                (employees || []).forEach((emp) => {
                    byUsername.set(emp.username, {
                        employee: emp,
                        byYear: { 2025: null, 2026: null },
                    });
                });

                (enrollments || []).forEach((enr) => {
                    const rec = byUsername.get(enr.username);
                    if (!rec) return;
                    rec.byYear[enr.benefit_year] = enr;
                });

                comparisonEmployees = Array.from(byUsername.values()).filter(
                    (x) => x.byYear[2025] || x.byYear[2026]
                );

                await ensureBenefitRatesLoaded();
                renderComparisonEmployeeList();
                comparisonRendered = true;
            } catch (err) {
                console.error("Comparison load error", err);
                listEl.innerHTML = '<li class="px-4 py-3 text-xs text-red-500 text-center">Error loading data.</li>';
            }
        }

        function renderComparisonEmployeeList() {
            const listEl = document.getElementById("comparisonEmployeeList");
            listEl.innerHTML = "";

            const search = document.getElementById("comparisonSearch").value.trim().toLowerCase();
            let rows = comparisonEmployees;

            if (search) {
                rows = rows.filter((r) => r.employee.last_name.toLowerCase().includes(search));
            }

            if (!rows.length) {
                listEl.innerHTML = '<li class="px-4 py-3 text-xs text-slate-500 text-center">No employees match your search.</li>';
                return;
            }

            rows.forEach((rec) => {
                const { employee } = rec;
                const hasChange = rec.byYear[2025] && rec.byYear[2026];

                listEl.insertAdjacentHTML("beforeend", `
                    <li>
                        <button type="button" class="w-full text-left px-4 py-3 hover:bg-slate-100 transition-colors focus:outline-none focus:bg-slate-100 group" data-username="${esc(employee.username)}">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <p class="text-sm font-medium text-slate-900 group-hover:text-[color:var(--jc-red)]">
                                        ${esc(employee.last_name)}, ${esc(employee.first_name)}
                                    </p>
                                    <p class="text-xs text-slate-500 mt-0.5">
                                        ${esc(employee.username)}
                                        ${hasChange ? '<span class="ml-2 text-emerald-600">• Has comparison data</span>' : ""}
                                    </p>
                                </div>
                                <i class="fa-solid fa-chevron-right text-xs text-slate-400 group-hover:text-[color:var(--jc-red)]"></i>
                            </div>
                        </button>
                    </li>
                `);
            });
        }

        document.getElementById("comparisonSearch").addEventListener("input", renderComparisonEmployeeList);

        document.getElementById("comparisonEmployeeList").addEventListener("click", (e) => {
            const btn = e.target.closest("button[data-username]");
            if (!btn) return;
            const username = btn.dataset.username;
            const rec = comparisonEmployees.find((r) => r.employee.username === username);
            if (rec) displayEmployeeComparison(rec);
        });

        function displayEmployeeComparison(rec) {
            const container = document.getElementById("employeeComparisonDisplay");
            const { employee, byYear } = rec;
            const enr2025 = byYear[2025];
            const enr2026 = byYear[2026];

            if (!enr2025 && !enr2026) {
                container.innerHTML = `
                    <div class="flex items-center justify-center h-full">
                        <p class="text-sm text-slate-600">No enrollment data available for this employee.</p>
                    </div>
                `;
                return;
            }

            const calc = (year, enr) => {
                if (!enr) return { medical: 0, dental: 0, vision: 0, total: 0, biweekly: 0 };
                const tier = enr.tier_election || "EO";
                const medical = getRateAmount(year, "medical", tier, enr.medical_plan);
                const dental = getRateAmount(year, "dental", tier, enr.dental_plan);
                const vision = getRateAmount(year, "vision", tier, enr.vision_plan);
                const total = medical + dental + vision;
                return { medical, dental, vision, total, biweekly: total };
            };

            const cost2025 = calc(2025, enr2025);
            const cost2026 = calc(2026, enr2026);
            const annualCost2025 = cost2025.total * 26;
            const annualCost2026 = cost2026.total * 26;
            const annualDiff = annualCost2026 - annualCost2025;
            const percentChange = annualCost2025 > 0 ? (annualDiff / annualCost2025) * 100 : 0;

            let changeType = "flat renewal";
            let changeColor = "text-slate-700";
            let changeIcon = "fa-minus";

            if (annualDiff > 100) {
                changeType = "upgrade";
                changeColor = "text-emerald-600";
                changeIcon = "fa-arrow-up";
            } else if (annualDiff < -100) {
                changeType = "downgrade";
                changeColor = "text-red-600";
                changeIcon = "fa-arrow-down";
            }

            const planRow = (label, plan2025, plan2026) => {
                const name2025 = plan2025 && plan2025 !== "WAIVE" ? prettyPlanName(label.toLowerCase(), plan2025) : "Waived";
                const name2026 = plan2026 && plan2026 !== "WAIVE" ? prettyPlanName(label.toLowerCase(), plan2026) : "Waived";
                const changed = name2025 !== name2026;

                return `
                    <tr class="border-b border-slate-100">
                        <td class="py-3 px-4 text-sm font-medium text-slate-700">${label}</td>
                        <td class="py-3 px-4 text-sm ${changed ? "text-slate-500" : "text-slate-700"}">${name2025}</td>
                        <td class="py-3 px-4 text-sm ${changed ? "font-semibold text-[color:var(--jc-red)]" : "text-slate-700"}">${name2026}</td>
                        <td class="py-3 px-4 text-center">
                            ${changed ? '<i class="fa-solid fa-circle-exclamation text-amber-500"></i>' : '<i class="fa-solid fa-check text-emerald-500"></i>'}
                        </td>
                    </tr>
                `;
            };

            container.innerHTML = `
                <div class="space-y-6">
                    <header class="border-b border-slate-200 pb-4">
                        <div class="flex items-start justify-between mb-3">
                            <div>
                                <h3 class="text-xl font-bold text-[color:var(--jc-navy)]">
                                    ${esc(employee.last_name)}, ${esc(employee.first_name)}
                                </h3>
                                <p class="text-sm text-slate-500 mt-1">
                                    Username: ${esc(employee.username)} • Tier: ${enr2026?.tier_election || enr2025?.tier_election || "N/A"}
                                </p>
                            </div>
                            <span class="pill-badge inline-flex items-center ${
                                changeColor === "text-emerald-600"
                                    ? "bg-emerald-50 text-emerald-700 border-emerald-100"
                                    : changeColor === "text-red-600"
                                    ? "bg-red-50 text-red-700 border-red-100"
                                    : "bg-slate-100 text-slate-700 border-slate-200"
                            } border px-4 py-2">
                                <i class="fa-solid ${changeIcon} mr-2"></i>
                                ${changeType.toUpperCase()}
                            </span>
                        </div>
                    </header>

                    <div class="grid md:grid-cols-3 gap-4">
                        <div class="card bg-slate-50 px-4 py-4">
                            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2025 Bi-weekly Cost</p>
                            <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2025.biweekly)}</p>
                            <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2025)}</p>
                        </div>

                        <div class="card bg-slate-50 px-4 py-4">
                            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">2026 Bi-weekly Cost</p>
                            <p class="text-2xl font-bold text-slate-900">${formatCurrency(cost2026.biweekly)}</p>
                            <p class="text-xs text-slate-500 mt-1">Annual: ${formatCurrency(annualCost2026)}</p>
                        </div>

                        <div class="card bg-slate-50 px-4 py-4">
                            <p class="text-xs uppercase tracking-wider text-slate-500 mb-2">Cost Difference</p>
                            <p class="text-2xl font-bold ${changeColor}">
                                ${(cost2026.biweekly - cost2025.biweekly) >= 0 ? "+" : ""}${formatCurrency(cost2026.biweekly - cost2025.biweekly)}
                            </p>
                            <p class="text-xs ${changeColor} mt-1 font-semibold">Per pay period</p>
                            <p class="text-xs text-slate-500 mt-1">
                                Annual: ${annualDiff >= 0 ? "+" : ""}${formatCurrency(annualDiff)} (${Math.abs(percentChange).toFixed(1)}%)
                            </p>
                        </div>
                    </div>

                    <div class="space-y-3">
                        <h4 class="text-sm font-semibold text-[color:var(--jc-navy)] uppercase tracking-wider">
                            Plan Elections Comparison
                        </h4>
                        <div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-slate-100 border-b-2 border-slate-200">
                                    <tr>
                                        <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">Coverage</th>
                                        <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2025 Plan</th>
                                        <th class="py-2 px-4 text-left text-xs font-semibold text-slate-700 uppercase tracking-wider">2026 Plan</th>
                                        <th class="py-2 px-4 text-center text-xs font-semibold text-slate-700 uppercase tracking-wider">Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${planRow("Medical", enr2025?.medical_plan, enr2026?.medical_plan)}
                                    ${planRow("Dental", enr2025?.dental_plan, enr2026?.dental_plan)}
                                    ${planRow("Vision", enr2025?.vision_plan, enr2026?.vision_plan)}
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="card bg-blue-50 border-blue-100 px-4 py-3">
                        <div class="flex items-start gap-3">
                            <i class="fa-solid fa-lightbulb text-blue-600 mt-0.5"></i>
                            <div class="flex-1">
                                <p class="text-xs font-semibold text-blue-900 mb-1">Analysis Summary</p>
                                <p class="text-xs text-blue-700 leading-relaxed">
                                    ${employee.first_name} ${employee.last_name}'s benefit elections show a <strong>${changeType}</strong>
                                    with an annual cost ${annualDiff >= 0 ? "increase" : "decrease"} of ${formatCurrency(Math.abs(annualDiff))}.
                                    ${
                                        annualDiff > 100
                                            ? "This represents enhanced coverage selections for 2026."
                                            : annualDiff < -100
                                            ? "This reflects reduced coverage or cost-saving plan changes."
                                            : "Benefit selections remain relatively stable year-over-year."
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // ======================== EMPLOYEE LIST (2026 ELECTIONS) ========================
        async function load2026EmployeeList() {
            await ensureBenefitRatesLoaded();

            try {
                showToast({
                    title: "Loading...",
                    message: "Loading 2026 benefit elections...",
                    type: "info",
                });

                const { data: enrollments, error: enrError } = await supabase
                    .from("benefit_enrollments")
                    .select("*")
                    .eq("benefit_year", 2026);

                if (enrError) throw enrError;
                if (!enrollments || !enrollments.length) {
                    throw new Error("No enrollment data found for 2026.");
                }

                fullEnrollments = enrollments;

                const usernames = [...new Set(enrollments.map((e) => e.username).filter(Boolean))];
                const { data: employees, error: empError } = await supabase
                    .from("employees2025")
                    .select("id, username, first_name, last_name, primary_phone, sssn, job_title, annual_salary, hourly_rate, employment_status, original_hire_date, address_line_1, city, state, zip_code")
                    .in("username", usernames);

                if (empError) throw empError;

                const empMap = Object.fromEntries((employees || []).map((e) => [e.username, e]));

                allEmployees = fullEnrollments.map((enr) => {
                    const emp = empMap[enr.username] || {};
                    const tier = enr.tier_election || "EO";
                    const medicalPlan = enr.medical_plan || "WAIVE";
                    const dentalPlan = enr.dental_plan || "WAIVE";
                    const visionPlan = enr.vision_plan || "WAIVE";
                    const hasLife = Array.isArray(enr.beneficiaries) && enr.beneficiaries.length > 0;

                    return {
                        id: enr.id,
                        employee_id_fk: emp.id,
                        first_name: emp.first_name,
                        last_name: emp.last_name,
                        job_title: enr.job_title || emp.job_title,
                        employment_status: enr.employment_status || emp.employment_status || "ACTIVE",
                        original_hire_date: enr.hire_date || emp.original_hire_date,
                        primary_phone: enr.phone || emp.primary_phone,
                        address_line_1: enr.address?.street || emp.address_line_1 || "",
                        city: enr.address?.city || emp.city || "",
                        state: enr.address?.state || emp.state || "TX",
                        zip_code: enr.address?.zip || emp.zip_code || "",
                        annual_salary: enr.annual_salary || emp.annual_salary || 0,
                        hourly_rate: emp.hourly_rate || 0,
                        tier_election: tier,
                        medical_plan: prettyPlanName("medical", medicalPlan),
                        dental_plan: prettyPlanName("dental", dentalPlan),
                        vision_plan: prettyPlanName("vision", visionPlan),
                        life_plan: emp.employer_life || false ? "Employer Paid" : hasLife ? "Elected" : null,
                        has_life: hasLife,
                        ssn_full: emp.sssn,
                        rawEmployeeData: emp,
                        rawEnrollmentData: enr,
                    };
                }).sort((a, b) => a.last_name.localeCompare(b.last_name));

                const enrolledCount = allEmployees.length;
                const medCount = allEmployees.filter((e) => e.medical_plan !== "Waived Coverage").length;
                const denCount = allEmployees.filter((e) => e.dental_plan !== "Waived Coverage").length;
                const visCount = allEmployees.filter((e) => e.vision_plan !== "Waived Coverage").length;
                const lifeCount = allEmployees.filter((e) => e.has_life || e.life_plan).length;

                document.getElementById("gridTotalEnrolled").textContent = enrolledCount;
                document.getElementById("gridMedicalCoverage").textContent = medCount;
                document.getElementById("gridDentalCoverage").textContent = denCount;
                document.getElementById("gridVisionCoverage").textContent = visCount;
                document.getElementById("gridLifeCoverage").textContent = lifeCount;

                applyFiltersAndRender();
                initEmployeeListFilters();

                showToast({
                    title: "Loaded successfully",
                    message: `Loaded ${enrolledCount} employee census records for 2026.`,
                    type: "success",
                });
            } catch (err) {
                console.error("Load 2026 list error:", err);
                showToast({
                    title: "Load Error",
                    message: "Failed to load 2026 benefit elections. " + (err.message || ""),
                    type: "error",
                });
            }
        }

        function renderEmployeeRow(emp) {
            const statusColor = emp.employment_status === "ACTIVE" 
                ? "bg-emerald-50 text-emerald-700 border-emerald-200" 
                : "bg-red-50 text-red-700 border-red-200";

            const statusBadge = `
                <span class="inline-flex px-2 py-1 rounded-full text-[10px] font-bold uppercase tracking-wider border ${statusColor}">
                    ${esc(emp.employment_status || "N/A")}
                </span>
            `;

            let salaryDisplay = "N/A";
            if (emp.annual_salary) {
                salaryDisplay = `<span class="font-mono text-sm">${formatCurrency(emp.annual_salary)}</span>`;
            } else if (emp.hourly_rate) {
                salaryDisplay = `<span class="font-mono text-sm text-blue-600">$${emp.hourly_rate.toFixed(2)}/hr</span>`;
            }

           // HERE IS THE FIX: Changed all "px-6 py-4" to "px-2 py-3"
    return `
        <tr class="border-b border-slate-100 hover:bg-slate-50 text-xs transition-colors">
            <td class="px-2 py-3">
                <div class="font-semibold text-slate-900 text-xs">
                    ${esc(emp.last_name)}, ${esc(emp.first_name)}
                </div>
                <div class="text-[10px] text-slate-500 font-medium mt-0.5">
                    ${esc(emp.job_title || "")}
                </div>
            </td>
            <td class="px-2 py-3 text-center">${statusBadge}</td>
            <td class="px-2 py-3">
                <div class="text-xs font-mono text-slate-700">${salaryDisplay}</div>
            </td>
            <td class="px-2 py-3 text-slate-600 text-xs">
                ${emp.original_hire_date ? formatDateOnly(emp.original_hire_date) : "—"}
            </td>
            <td class="px-2 py-3">
                <div class="text-xs text-slate-800">
                    ${emp.primary_phone ? formatPhone(emp.primary_phone) : "—"}
                </div>
            </td>
            <td class="px-2 py-3">
                <span class="inline-flex px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[10px] font-semibold border border-blue-200">
                    ${esc(emp.tier_election || "EO")}
                </span>
            </td>
            <td class="px-2 py-3">
                ${emp.medical_plan.includes("Waived") 
                    ? '<span class="text-slate-400 italic text-[10px]">Waived</span>' 
                    : `<span class="inline-flex px-2 py-0.5 rounded-full bg-red-50 text-red-700 text-[10px] font-semibold border border-red-200 whitespace-nowrap">
                         ${esc(emp.medical_plan.replace("HMO / ", "").replace("PPO / ", "").replace("HMO HSA / ", ""))}
                       </span>`}
            </td>
            <td class="px-2 py-3">
                ${emp.dental_plan.includes("Waived") 
                    ? '<span class="text-slate-400 italic text-[10px]">Waived</span>' 
                    : `<span class="inline-flex px-2 py-0.5 rounded-full bg-blue-50 text-blue-700 text-[10px] font-semibold border border-blue-200 whitespace-nowrap">
                         ${esc(emp.dental_plan.replace("F-PLAN ", "").replace(" / Base MAC", "").replace(" / Buy Up MAC", ""))}
                       </span>`}
            </td>
            <td class="px-2 py-3">
                ${emp.vision_plan.includes("Waived") 
                    ? '<span class="text-slate-400 italic text-[10px]">Waived</span>' 
                    : `<span class="inline-flex px-2 py-0.5 rounded-full bg-slate-100 text-slate-700 text-[10px] font-semibold border border-slate-200">Plan 1</span>`}
            </td>
            <td class="px-2 py-3 text-center">
                ${emp.life_plan || emp.has_life 
                    ? '<i class="fa-solid fa-check-circle text-emerald-500 text-sm"></i>' 
                    : '<i class="fa-solid fa-times-circle text-slate-300 text-sm"></i>'}
            </td>
            <td class="px-2 py-3 text-right">
                <button class="inline-flex items-center gap-1 px-3 py-1.5 rounded-lg border border-slate-200 bg-white text-[10px] font-semibold text-slate-700 hover:bg-slate-50 transition-all shadow-sm" onclick="openEmployeeModal(${emp.id})">
                    <i class="fa-solid fa-pen-to-square"></i>
                </button>
            </td>
        </tr>
    `;
}
        function renderEmployeesTable(rows) {
            const tbody = document.getElementById("employeeListTableBody");
            if (!tbody) return;

            if (rows.length === 0) {
                tbody.innerHTML = '<tr><td colspan="11" class="px-6 py-12 text-center text-sm text-slate-500">No employees match your current search filters.</td></tr>';
                return;
            }

            tbody.innerHTML = rows.map(renderEmployeeRow).join("");
        }

        function applyFiltersAndRender() {
            const search = document.getElementById("employeeSearch")?.value.trim().toLowerCase() || "";
            const medical = document.getElementById("filterMedical")?.value || "all";
            const dental = document.getElementById("filterDental")?.value || "all";
            const vision = document.getElementById("filterVision")?.value || "all";
            const life = document.getElementById("filterLife")?.value || "all";

            let filtered = allEmployees;

            if (search) {
                filtered = filtered.filter((emp) => {
                    const fullName = `${emp.first_name || ""} ${emp.last_name || ""}`.toLowerCase();
                    return fullName.includes(search);
                });
            }

            if (medical !== "all") {
                filtered = filtered.filter((emp) => {
                    const medicalCodes = {
                        WAIVE: ["WAIVE", "Waived Coverage"],
                        ATBCB402: ["ATBCB402", "PPO / ATBCB402"],
                        ATBAB303: ["ATBAB303", "HMO / ATBAB303"],
                        ATBAP393: ["ATBAP393", "HMO HSA / ATBAP393"],
                    };
                    return (
                        medicalCodes[medical]?.some(
                            (code) =>
                                emp.medical_plan.includes(code) || emp.rawEnrollmentData?.medical_plan === code
                        ) || false
                    );
                });
            }

            if (dental !== "all") {
                filtered = filtered.filter((emp) => {
                    const dentalCodes = {
                        WAIVE: ["WAIVE", "Waived Coverage"],
                        F_PLAN_2W: ["F_PLAN_2W", "F-PLAN 2W"],
                        F_PLAN_3W: ["F_PLAN_3W", "F-PLAN 3W"],
                    };
                    return (
                        dentalCodes[dental]?.some(
                            (code) =>
                                emp.dental_plan.includes(code) || emp.rawEnrollmentData?.dental_plan === code
                        ) || false
                    );
                });
            }

            if (vision !== "all") {
                filtered = filtered.filter((emp) => {
                    const visionCodes = {
                        WAIVE: ["WAIVE", "Waived Coverage"],
                        PLAN_1: ["PLAN_1", "Vision Plan 1"],
                    };
                    return (
                        visionCodes[vision]?.some(
                            (code) =>
                                emp.vision_plan.includes(code) || emp.rawEnrollmentData?.vision_plan === code
                        ) || false
                    );
                });
            }

            if (life !== "all") {
                if (life === "yes") {
                    filtered = filtered.filter((emp) => emp.has_life === true || emp.life_plan);
                } else if (life === "no") {
                    filtered = filtered.filter((emp) => !emp.has_life && !emp.life_plan);
                }
            }

            const resultsCountEl = document.getElementById("resultsCount");
            const totalCountEl = document.getElementById("totalCount");
            if (resultsCountEl) resultsCountEl.textContent = filtered.length;
            if (totalCountEl) totalCountEl.textContent = allEmployees.length;

            renderEmployeesTable(filtered);
        }

        function initEmployeeListFilters() {
            if (window.employeeFiltersInitialized) return;
            window.employeeFiltersInitialized = true;

            const filterElements = ["employeeSearch", "filterMedical", "filterDental", "filterVision", "filterLife"];

            filterElements.forEach((id) => {
                const el = document.getElementById(id);
                if (el) {
                    el.addEventListener("input", applyFiltersAndRender);
                    el.addEventListener("change", applyFiltersAndRender);
                }
            });

            const clearBtn = document.getElementById("clearFilters");
            if (clearBtn) {
                clearBtn.addEventListener("click", () => {
                    document.getElementById("employeeSearch").value = "";
                    document.getElementById("filterMedical").value = "all";
                    document.getElementById("filterDental").value = "all";
                    document.getElementById("filterVision").value = "all";
                    document.getElementById("filterLife").value = "all";
                    applyFiltersAndRender();
                    showToast({
                        title: "Filters Cleared",
                        message: "Showing all employees",
                        type: "success",
                    });
                });
            }

            const applyBtn = document.getElementById("applyFilters");
            if (applyBtn) {
                applyBtn.addEventListener("click", () => {
                    applyFiltersAndRender();
                    showToast({
                        title: "Filters Applied",
                        message: "Results updated",
                        type: "success",
                    });
                });
            }
        }

        // Export to Excel
    // ======================== EXCEL EXPORT - ENTERPRISE EDITION ========================
// ======================== ENTERPRISE EXCEL EXPORT - EXCELJS VERSION ========================
// This uses ExcelJS which supports FULL STYLING in the browser

/**
 * CORPORATE COLOR PALETTE
 */
const COLORS = {
    NAVY_DARK: 'FF0F172A',
    CHARCOAL: 'FF1E293B',
    WHITE: 'FFFFFFFF',
    
    MEDICAL_RED: 'FFDC2626',
    DENTAL_BLUE: 'FF2563EB',
    VISION_SLATE: 'FF475569',
    LIFE_TEAL: 'FF059669',
    
    GRAY_LIGHT: 'FFF8FAFC',
    GRAY_MEDIUM: 'FFE2E8F0',
    BLUE_LIGHT: 'FFDBEAFE',
    
    GREEN_ACTIVE: 'FF10B981',
    RED_INACTIVE: 'FFEF4444',
    GRAY_STATUS: 'FF94A3B8',
    
    BORDER_LIGHT: 'FFE5E7EB',
    BORDER_MEDIUM: 'FFD1D5DB',
    BORDER_DARK: 'FF6B7280'
};

/**
 * MAIN EXPORT FUNCTION
 */
document.getElementById("exportToExcel").addEventListener("click", async () => {
    if (!allEmployees || !allEmployees.length) {
        showToast({
            title: "No Data",
            message: "No employees to export.",
            type: "error",
        });
        return;
    }

    try {
        showToast({
            title: "Generating Report...",
            message: "Creating professional Excel workbook with full formatting...",
            type: "info",
        });

        // Create workbook with ExcelJS
        const workbook = new ExcelJS.Workbook();
        
        // Set workbook properties
        workbook.creator = 'Executive Benefits Portal';
        workbook.lastModifiedBy = 'Jeng Chi Restaurant';
        workbook.created = new Date();
        workbook.modified = new Date();
        workbook.company = 'Jeng Chi Restaurant';
        workbook.title = '2026 Employee Benefit Elections';

        // Create all sheets
        await createExecutiveSummarySheetExcelJS(workbook, allEmployees);
        await createDetailSheetExcelJS(workbook, allEmployees);
        await createPivotSheetExcelJS(workbook, allEmployees);
        await createDictionarySheetExcelJS(workbook);

        // Generate file
        const buffer = await workbook.xlsx.writeBuffer();
        const blob = new Blob([buffer], { 
            type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
        });
        
        // Download
        const timestamp = new Date().toISOString().slice(0, 10);
        const filename = `Jeng_Chi_2026_Benefit_Elections_${timestamp}.xlsx`;
        saveAs(blob, filename);

        showToast({
            title: "Export Complete",
            message: `${allEmployees.length} employees exported with full corporate formatting!`,
            type: "success",
        });

    } catch (err) {
        console.error("Excel export error:", err);
        showToast({
            title: "Export Failed",
            message: "Error: " + err.message,
            type: "error",
        });
    }
});

/**
 * SHEET 1: EXECUTIVE SUMMARY
 */
async function createExecutiveSummarySheetExcelJS(workbook, employees) {
    const sheet = workbook.addWorksheet('Executive Summary', {
        views: [{ state: 'frozen', xSplit: 0, ySplit: 3 }]
    });
    
    const exportDate = new Date().toLocaleString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    
    let row = 1;
    
    // ==================== TITLE BLOCK ====================
    
    // Row 1: Main Title
    sheet.mergeCells(`A${row}:H${row}`);
    const titleCell = sheet.getCell(`A${row}`);
    titleCell.value = 'Jeng Chi Restaurant — 2026 Employee Benefit Elections';
    titleCell.font = { name: 'Arial', size: 16, bold: true, color: { argb: COLORS.NAVY_DARK } };
    titleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    titleCell.border = {
        bottom: { style: 'medium', color: { argb: COLORS.BORDER_MEDIUM } }
    };
    sheet.getRow(row).height = 30;
    row++;
    
    // Row 2: Subtitle
    sheet.mergeCells(`A${row}:H${row}`);
    const subtitleCell = sheet.getCell(`A${row}`);
    subtitleCell.value = 'Corporate Benefits Registry • Active Plan Year 2026';
    subtitleCell.font = { name: 'Arial', size: 11, color: { argb: COLORS.CHARCOAL } };
    subtitleCell.alignment = { horizontal: 'center', vertical: 'middle' };
    sheet.getRow(row).height = 18;
    row++;
    
    // Row 3: Export info
    sheet.mergeCells(`A${row}:H${row}`);
    const infoCell = sheet.getCell(`A${row}`);
    infoCell.value = `Generated from Executive Benefits Portal on ${exportDate} — Source: Supabase`;
    infoCell.font = { name: 'Arial', size: 9, italic: true, color: { argb: COLORS.GRAY_STATUS } };
    infoCell.alignment = { horizontal: 'center', vertical: 'middle' };
    row += 2;
    
    // ==================== KPI TILES ====================
    
    const kpis = {
        totalEnrolled: employees.length,
        medicalCount: employees.filter(e => e.medical_plan && !e.medical_plan.includes("Waived")).length,
        dentalCount: employees.filter(e => e.dental_plan && !e.dental_plan.includes("Waived")).length,
        visionCount: employees.filter(e => e.vision_plan && !e.vision_plan.includes("Waived")).length,
        lifeCount: employees.filter(e => e.has_life || e.life_plan).length
    };
    
    // KPI Section Header
    sheet.mergeCells(`A${row}:H${row}`);
    const kpiHeader = sheet.getCell(`A${row}`);
    kpiHeader.value = 'KEY PERFORMANCE INDICATORS';
    kpiHeader.font = { name: 'Arial', size: 12, bold: true, color: { argb: COLORS.NAVY_DARK } };
    kpiHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_MEDIUM } };
    kpiHeader.alignment = { horizontal: 'left', vertical: 'middle' };
    kpiHeader.border = getBorder('thin');
    sheet.getRow(row).height = 22;
    row++;
    
    // KPI Tiles
    createKPITileExcelJS(sheet, row, 'A', 'D', '👥 Total Enrolled', kpis.totalEnrolled, COLORS.NAVY_DARK);
    createKPITileExcelJS(sheet, row, 'E', 'H', '❤️ Medical Coverage', kpis.medicalCount, COLORS.MEDICAL_RED);
    row += 2;
    
    createKPITileExcelJS(sheet, row, 'A', 'D', '🦷 Dental Coverage', kpis.dentalCount, COLORS.DENTAL_BLUE);
    createKPITileExcelJS(sheet, row, 'E', 'H', '👁 Vision Coverage', kpis.visionCount, COLORS.VISION_SLATE);
    row += 2;
    
    createKPITileExcelJS(sheet, row, 'A', 'D', '🛡 Life & AD&D', kpis.lifeCount, COLORS.LIFE_TEAL);
    row += 3;
    
    // ==================== PARTICIPATION TABLE ====================
    
    sheet.mergeCells(`A${row}:H${row}`);
    const partHeader = sheet.getCell(`A${row}`);
    partHeader.value = 'PARTICIPATION SUMMARY';
    partHeader.font = { name: 'Arial', size: 12, bold: true, color: { argb: COLORS.NAVY_DARK } };
    partHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_MEDIUM } };
    partHeader.alignment = { horizontal: 'left', vertical: 'middle' };
    partHeader.border = getBorder('thin');
    sheet.getRow(row).height = 22;
    row++;
    
    // Table headers
    const partHeaders = ['Coverage Type', 'Enrolled', 'Waived', 'Participation %'];
    partHeaders.forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx); // A, B, C, D
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
        cell.alignment = { horizontal: idx === 0 ? 'left' : 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    // Data rows
    const participationData = [
        { type: "Medical", enrolled: kpis.medicalCount, waived: kpis.totalEnrolled - kpis.medicalCount },
        { type: "Dental", enrolled: kpis.dentalCount, waived: kpis.totalEnrolled - kpis.dentalCount },
        { type: "Vision", enrolled: kpis.visionCount, waived: kpis.totalEnrolled - kpis.visionCount },
        { type: "Life & AD&D", enrolled: kpis.lifeCount, waived: kpis.totalEnrolled - kpis.lifeCount }
    ];
    
    participationData.forEach((item, idx) => {
        const isEven = idx % 2 === 0;
        
        sheet.getCell(`A${row}`).value = item.type;
        sheet.getCell(`B${row}`).value = item.enrolled;
        sheet.getCell(`C${row}`).value = item.waived;
        sheet.getCell(`D${row}`).value = { formula: `B${row}/(B${row}+C${row})` };
        
        ['A', 'B', 'C', 'D'].forEach((col, colIdx) => {
            const cell = sheet.getCell(`${col}${row}`);
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: isEven ? COLORS.GRAY_LIGHT : COLORS.WHITE } };
            cell.alignment = { 
                horizontal: colIdx === 0 ? 'left' : (colIdx === 3 ? 'center' : 'right'), 
                vertical: 'middle' 
            };
            cell.border = getBorder('thin');
            if (colIdx === 3) {
                cell.numFmt = '0.0%';
            }
        });
        
        row++;
    });
    row += 2;
    
    // ==================== TIER BREAKDOWN ====================
    
    sheet.mergeCells(`A${row}:H${row}`);
    const tierHeader = sheet.getCell(`A${row}`);
    tierHeader.value = 'COVERAGE TIER DISTRIBUTION';
    tierHeader.font = { name: 'Arial', size: 12, bold: true, color: { argb: COLORS.NAVY_DARK } };
    tierHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_MEDIUM } };
    tierHeader.alignment = { horizontal: 'left', vertical: 'middle' };
    tierHeader.border = getBorder('thin');
    sheet.getRow(row).height = 22;
    row++;
    
    // Tier headers
    ['Tier', 'Description', 'Employees'].forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
        cell.alignment = { horizontal: idx === 2 ? 'right' : 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    // Tier data
    const tierData = [
        { tier: "EO", desc: "Employee Only", count: employees.filter(e => e.tier_election === 'EO').length },
        { tier: "ES", desc: "Employee + Spouse", count: employees.filter(e => e.tier_election === 'ES').length },
        { tier: "EC", desc: "Employee + Child(ren)", count: employees.filter(e => e.tier_election === 'EC').length },
        { tier: "EF", desc: "Employee + Family", count: employees.filter(e => e.tier_election === 'EF').length }
    ];
    
    tierData.forEach((item, idx) => {
        const isEven = idx % 2 === 0;
        
        sheet.getCell(`A${row}`).value = item.tier;
        sheet.getCell(`B${row}`).value = item.desc;
        sheet.getCell(`C${row}`).value = item.count;
        
        ['A', 'B', 'C'].forEach((col, colIdx) => {
            const cell = sheet.getCell(`${col}${row}`);
            cell.font = { name: 'Arial', size: 10, bold: colIdx === 0 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: isEven ? COLORS.GRAY_LIGHT : COLORS.WHITE } };
            cell.alignment = { 
                horizontal: colIdx === 2 ? 'right' : (colIdx === 0 ? 'center' : 'left'), 
                vertical: 'middle' 
            };
            cell.border = getBorder('thin');
        });
        
        row++;
    });
    row += 2;
    
    // ==================== CHART DATA ====================
    
    sheet.mergeCells(`A${row}:H${row}`);
    const chartHeader = sheet.getCell(`A${row}`);
    chartHeader.value = 'CHART DATA (For Quick Excel Charts)';
    chartHeader.font = { name: 'Arial', size: 12, bold: true, color: { argb: COLORS.NAVY_DARK } };
    chartHeader.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
    chartHeader.alignment = { horizontal: 'left', vertical: 'middle' };
    chartHeader.border = getBorder('thin');
    row++;
    
    // Chart data headers
    ['Coverage Type', 'Enrolled Count'].forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.CHARCOAL } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    // Chart data
    [
        { type: "Medical", count: kpis.medicalCount },
        { type: "Dental", count: kpis.dentalCount },
        { type: "Vision", count: kpis.visionCount }
    ].forEach((item, idx) => {
        sheet.getCell(`A${row}`).value = item.type;
        sheet.getCell(`B${row}`).value = item.count;
        
        ['A', 'B'].forEach((col, colIdx) => {
            const cell = sheet.getCell(`${col}${row}`);
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: idx % 2 === 0 ? COLORS.GRAY_LIGHT : COLORS.WHITE } };
            cell.alignment = { horizontal: colIdx === 1 ? 'right' : 'left', vertical: 'middle' };
            cell.border = getBorder('thin');
        });
        
        row++;
    });
    row++;
    
    // Pie chart data
    ['Medical Status', 'Employee Count'].forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.CHARCOAL } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    [
        { status: "Covered", count: kpis.medicalCount },
        { status: "Waived", count: kpis.totalEnrolled - kpis.medicalCount }
    ].forEach((item, idx) => {
        sheet.getCell(`A${row}`).value = item.status;
        sheet.getCell(`B${row}`).value = item.count;
        
        ['A', 'B'].forEach((col, colIdx) => {
            const cell = sheet.getCell(`${col}${row}`);
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: idx % 2 === 0 ? COLORS.GRAY_LIGHT : COLORS.WHITE } };
            cell.alignment = { horizontal: colIdx === 1 ? 'right' : 'left', vertical: 'middle' };
            cell.border = getBorder('thin');
        });
        
        row++;
    });
    row += 2;
    
    // Chart instruction
    sheet.mergeCells(`A${row}:H${row}`);
    const chartNote = sheet.getCell(`A${row}`);
    chartNote.value = '📊 To create charts: Select the data range above → Insert → Chart (Column or Pie)';
    chartNote.font = { name: 'Arial', size: 9, italic: true, color: { argb: COLORS.GRAY_STATUS } };
    chartNote.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
    chartNote.alignment = { horizontal: 'left', vertical: 'middle' };
    row += 3;
    
    // ==================== DISCLAIMER ====================
    
    sheet.mergeCells(`A${row}:H${row}`);
    const disclaimer = sheet.getCell(`A${row}`);
    disclaimer.value = '⚠ CONFIDENTIAL NOTICE: This report is for internal Jeng Chi Restaurant use only and does not create any contract or guarantee of benefits. All information is subject to verification with official carrier records and HR documentation. For questions or corrections, please contact HR or the Benefits Administrator.';
    disclaimer.font = { name: 'Arial', size: 9, italic: true, color: { argb: COLORS.CHARCOAL } };
    disclaimer.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_MEDIUM } };
    disclaimer.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
    disclaimer.border = {
        top: { style: 'thin', color: { argb: COLORS.BORDER_MEDIUM } },
        bottom: { style: 'thin', color: { argb: COLORS.BORDER_MEDIUM } },
        left: { style: 'medium', color: { argb: COLORS.MEDICAL_RED } },
        right: { style: 'thin', color: { argb: COLORS.BORDER_MEDIUM } }
    };
    sheet.getRow(row).height = 50;
    
    // Set column widths
    sheet.columns = [
        { width: 20 }, { width: 15 }, { width: 12 }, { width: 18 },
        { width: 15 }, { width: 12 }, { width: 12 }, { width: 12 }
    ];
}

/**
 * SHEET 2: DETAILED ELECTIONS
 */
async function createDetailSheetExcelJS(workbook, employees) {
    const sheet = workbook.addWorksheet('2026 Elections — Detail');
    
    const exportDate = new Date().toLocaleString('en-US', {
        month: 'long', day: 'numeric', year: 'numeric',
        hour: '2-digit', minute: '2-digit'
    });
    
    let row = 1;
    
    // ==================== TITLE ROWS ====================
    
    // Row 1: Title
    sheet.mergeCells(`A${row}:L${row}`);
    const title = sheet.getCell(`A${row}`);
    title.value = '2026 Employee Benefit Elections — Complete Registry';
    title.font = { name: 'Arial', size: 14, bold: true, color: { argb: COLORS.WHITE } };
    title.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
    title.alignment = { horizontal: 'center', vertical: 'middle' };
    title.border = getBorder('medium');
    sheet.getRow(row).height = 28;
    row++;
    
    // Row 2: Subtitle
    sheet.mergeCells(`A${row}:L${row}`);
    const subtitle = sheet.getCell(`A${row}`);
    subtitle.value = 'Complete enrollment registry for plan year 2026';
    subtitle.font = { name: 'Arial', size: 11, color: { argb: COLORS.CHARCOAL } };
    subtitle.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_LIGHT } };
    subtitle.alignment = { horizontal: 'center', vertical: 'middle' };
    sheet.getRow(row).height = 18;
    row++;
    
    // Row 3: Info
    sheet.mergeCells(`A${row}:L${row}`);
    const info = sheet.getCell(`A${row}`);
    info.value = `Generated: ${exportDate} • Filters and sorting available via header row`;
    info.font = { name: 'Arial', size: 9, italic: true, color: { argb: COLORS.GRAY_STATUS } };
    info.alignment = { horizontal: 'center', vertical: 'middle' };
    row++;
    
    // ==================== COLUMN HEADERS ====================
    
    const headerRow = row;
    const headers = [
        'EMPLOYEE', 'STATUS', 'SALARY', 'HIRE DATE', 'CONTACT',
        'CITY', 'STATE', 'TIER', 'MEDICAL ❤️', 'DENTAL 🦷',
        'VISION 👁', 'LIFE / AD&D 🛡'
    ];
    
    headers.forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
        cell.alignment = { horizontal: 'center', vertical: 'middle', wrapText: true };
        cell.border = {
            top: { style: 'medium', color: { argb: COLORS.WHITE } },
            bottom: { style: 'medium', color: { argb: COLORS.WHITE } },
            left: { style: 'thin', color: { argb: COLORS.WHITE } },
            right: { style: 'thin', color: { argb: COLORS.WHITE } }
        };
    });
    sheet.getRow(row).height = 35;
    row++;
    
    // ==================== DATA ROWS ====================
    
    employees.forEach((emp, idx) => {
        const isEven = idx % 2 === 0;
        const fillColor = isEven ? COLORS.GRAY_LIGHT : COLORS.WHITE;
        
        // Column A: Employee Name
        const nameCell = sheet.getCell(`A${row}`);
        nameCell.value = `${emp.last_name || ''}, ${emp.first_name || ''}`;
        nameCell.font = { name: 'Arial', size: 10 };
        nameCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        nameCell.alignment = { horizontal: 'left', vertical: 'middle' };
        nameCell.border = getBorder('thin');
        
        // Column B: Status (with color coding)
        const status = emp.employment_status || "ACTIVE";
        let statusColor = COLORS.GREEN_ACTIVE;
        if (status === "TERMINATED" || status === "INACTIVE") {
            statusColor = COLORS.RED_INACTIVE;
        } else if (status !== "ACTIVE") {
            statusColor = COLORS.GRAY_STATUS;
        }
        
        const statusCell = sheet.getCell(`B${row}`);
        statusCell.value = status;
        statusCell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        statusCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: statusColor } };
        statusCell.alignment = { horizontal: 'center', vertical: 'middle' };
        statusCell.border = getBorder('thin');
        
        // Column C: Salary
        const salaryCell = sheet.getCell(`C${row}`);
        let salaryValue = emp.annual_salary;
        if (!salaryValue && emp.hourly_rate) {
            salaryValue = emp.hourly_rate * 2080;
        }
        
        if (salaryValue) {
            salaryCell.value = salaryValue;
            salaryCell.numFmt = '$#,##0.00';
            salaryCell.font = { name: 'Arial', size: 10 };
            salaryCell.alignment = { horizontal: 'right', vertical: 'middle' };
        } else {
            salaryCell.value = 'N/A';
            salaryCell.font = { name: 'Arial', size: 10, italic: true };
            salaryCell.alignment = { horizontal: 'center', vertical: 'middle' };
        }
        salaryCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        salaryCell.border = getBorder('thin');
        
        // Column D: Hire Date
        const dateCell = sheet.getCell(`D${row}`);
        if (emp.original_hire_date) {
            dateCell.value = new Date(emp.original_hire_date);
            dateCell.numFmt = 'mm/dd/yyyy';
            dateCell.alignment = { horizontal: 'center', vertical: 'middle' };
        } else {
            dateCell.value = '—';
            dateCell.alignment = { horizontal: 'center', vertical: 'middle' };
        }
        dateCell.font = { name: 'Arial', size: 10 };
        dateCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        dateCell.border = getBorder('thin');
        
        // Column E: Phone
        const phoneCell = sheet.getCell(`E${row}`);
        phoneCell.value = emp.primary_phone || '';
        phoneCell.font = { name: 'Arial', size: 10 };
        phoneCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        phoneCell.alignment = { horizontal: 'left', vertical: 'middle' };
        phoneCell.border = getBorder('thin');
        
        // Column F: City
        const cityCell = sheet.getCell(`F${row}`);
        cityCell.value = emp.city || '';
        cityCell.font = { name: 'Arial', size: 10 };
        cityCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        cityCell.alignment = { horizontal: 'left', vertical: 'middle' };
        cityCell.border = getBorder('thin');
        
        // Column G: State
        const stateCell = sheet.getCell(`G${row}`);
        stateCell.value = emp.state || 'TX';
        stateCell.font = { name: 'Arial', size: 10 };
        stateCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        stateCell.alignment = { horizontal: 'center', vertical: 'middle' };
        stateCell.border = getBorder('thin');
        
        // Column H: Tier
        const tierCell = sheet.getCell(`H${row}`);
        tierCell.value = emp.tier_election || 'EO';
        tierCell.font = { name: 'Arial', size: 10, bold: true };
        tierCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
        tierCell.alignment = { horizontal: 'center', vertical: 'middle' };
        tierCell.border = getBorder('thin');
        
        // Columns I-L: Plans
        [
            { col: 'I', value: emp.medical_plan || 'Waived' },
            { col: 'J', value: emp.dental_plan || 'Waived' },
            { col: 'K', value: emp.vision_plan || 'Waived' },
            { col: 'L', value: emp.life_plan || (emp.has_life ? 'Elected' : 'None') }
        ].forEach(({ col, value }) => {
            const cell = sheet.getCell(`${col}${row}`);
            cell.value = value;
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
            cell.alignment = { horizontal: col === 'L' ? 'center' : 'left', vertical: 'middle' };
            cell.border = getBorder('thin');
        });
        
        row++;
    });
    
    // ==================== TOTALS ROW ====================
    
    const totalsRow = row;
    row++;
    
    sheet.mergeCells(`A${totalsRow}:D${totalsRow}`);
    const totalCell = sheet.getCell(`A${totalsRow}`);
    totalCell.value = `TOTAL EMPLOYEES: ${employees.length}`;
    totalCell.font = { name: 'Arial', size: 11, bold: true, color: { argb: COLORS.NAVY_DARK } };
    totalCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
    totalCell.alignment = { horizontal: 'left', vertical: 'middle' };
    totalCell.border = {
        top: { style: 'medium', color: { argb: COLORS.NAVY_DARK } },
        ...getBorder('thin')
    };
    
    const medCount = employees.filter(e => e.medical_plan && !e.medical_plan.includes("Waived")).length;
    const denCount = employees.filter(e => e.dental_plan && !e.dental_plan.includes("Waived")).length;
    const visCount = employees.filter(e => e.vision_plan && !e.vision_plan.includes("Waived")).length;
    const lifeCount = employees.filter(e => e.has_life || e.life_plan).length;
    
    [
        { col: 'E', text: `Medical: ${medCount}` },
        { col: 'G', text: `Dental: ${denCount}` },
        { col: 'I', text: `Vision: ${visCount}` },
        { col: 'K', text: `Life: ${lifeCount}` }
    ].forEach(({ col, text }) => {
        const cell = sheet.getCell(`${col}${totalsRow}`);
        cell.value = text;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.NAVY_DARK } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = {
            top: { style: 'medium', color: { argb: COLORS.NAVY_DARK } },
            ...getBorder('thin')
        };
    });
    
    // ==================== COLUMN WIDTHS ====================
    
    sheet.columns = [
        { width: 28 }, { width: 12 }, { width: 14 }, { width: 12 },
        { width: 16 }, { width: 15 }, { width: 8 }, { width: 10 },
        { width: 28 }, { width: 28 }, { width: 22 }, { width: 18 }
    ];
    
    // ==================== AUTOFILTER & FREEZE ====================
    
    sheet.autoFilter = {
        from: { row: headerRow, column: 1 },
        to: { row: headerRow + employees.length - 1, column: 12 }
    };
    
    sheet.views = [
        { state: 'frozen', xSplit: 1, ySplit: headerRow }
    ];
}

/**
 * SHEET 3: PIVOT & ANALYSIS
 */
async function createPivotSheetExcelJS(workbook, employees) {
    const sheet = workbook.addWorksheet('Pivot & Analysis');
    
    let row = 1;
    
    // Title
    sheet.mergeCells(`A${row}:K${row}`);
    const title = sheet.getCell(`A${row}`);
    title.value = 'Pivot & Analysis Data Source';
    title.font = { name: 'Arial', size: 14, bold: true, color: { argb: COLORS.WHITE } };
    title.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
    title.alignment = { horizontal: 'center', vertical: 'middle' };
    title.border = getBorder('medium');
    sheet.getRow(row).height = 25;
    row++;
    
    // Subtitle
    sheet.mergeCells(`A${row}:K${row}`);
    const subtitle = sheet.getCell(`A${row}`);
    subtitle.value = 'This normalized data table is ready for creating pivot tables in Excel';
    subtitle.font = { name: 'Arial', size: 10, italic: true, color: { argb: COLORS.CHARCOAL } };
    subtitle.alignment = { horizontal: 'center', vertical: 'middle' };
    row += 2;
    
    // Headers
    const headers = [
        'Employee_Name', 'Status', 'Tier', 'City', 'State',
        'Medical_Enrolled', 'Dental_Enrolled', 'Vision_Enrolled',
        'Life_Enrolled', 'Annual_Salary', 'Hire_Year'
    ];
    
    const headerRow = row;
    headers.forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.CHARCOAL } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    // Data
    employees.forEach((emp, idx) => {
        const isEven = idx % 2 === 0;
        const fillColor = isEven ? COLORS.GRAY_LIGHT : COLORS.WHITE;
        
        const data = [
            `${emp.last_name || ''}, ${emp.first_name || ''}`,
            emp.employment_status || 'ACTIVE',
            emp.tier_election || 'EO',
            emp.city || '',
            emp.state || 'TX',
            emp.medical_plan && !emp.medical_plan.includes("Waived") ? 'Yes' : 'No',
            emp.dental_plan && !emp.dental_plan.includes("Waived") ? 'Yes' : 'No',
            emp.vision_plan && !emp.vision_plan.includes("Waived") ? 'Yes' : 'No',
            emp.has_life || emp.life_plan ? 'Yes' : 'No',
            emp.annual_salary || (emp.hourly_rate ? emp.hourly_rate * 2080 : 0),
            emp.original_hire_date ? new Date(emp.original_hire_date).getFullYear() : ''
        ];
        
        data.forEach((value, idx) => {
            const col = String.fromCharCode(65 + idx);
            const cell = sheet.getCell(`${col}${row}`);
            cell.value = value;
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: fillColor } };
            cell.alignment = { horizontal: idx === 9 ? 'right' : 'left', vertical: 'middle' };
            cell.border = getBorder('thin');
            if (idx === 9) cell.numFmt = '$#,##0.00';
        });
        
        row++;
    });
    
    // Instructions
    row += 2;
    sheet.mergeCells(`A${row}:K${row}`);
    const instructions = sheet.getCell(`A${row}`);
    instructions.value = '📊 To Create Pivot Tables: Select the data range above → Insert → PivotTable → Choose fields for analysis';
    instructions.font = { name: 'Arial', size: 10, italic: true, color: { argb: COLORS.CHARCOAL } };
    instructions.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
    instructions.alignment = { horizontal: 'left', vertical: 'middle', wrapText: true };
    instructions.border = getBorder('thin');
    sheet.getRow(row).height = 25;
    
    // Column widths
    sheet.columns = [
        { width: 25 }, { width: 12 }, { width: 10 }, { width: 15 },
        { width: 8 }, { width: 16 }, { width: 16 }, { width: 16 },
        { width: 14 }, { width: 15 }, { width: 12 }
    ];
    
    // AutoFilter
    sheet.autoFilter = {
        from: { row: headerRow, column: 1 },
        to: { row: headerRow + employees.length - 1, column: 11 }
    };
}

/**
 * SHEET 4: DATA DICTIONARY
 */
async function createDictionarySheetExcelJS(workbook) {
    const sheet = workbook.addWorksheet('Data Dictionary');
    
    let row = 1;
    
    // Title
    sheet.mergeCells(`A${row}:D${row}`);
    const title = sheet.getCell(`A${row}`);
    title.value = 'Data Dictionary';
    title.font = { name: 'Arial', size: 14, bold: true, color: { argb: COLORS.WHITE } };
    title.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.NAVY_DARK } };
    title.alignment = { horizontal: 'center', vertical: 'middle' };
    title.border = getBorder('medium');
    sheet.getRow(row).height = 25;
    row += 2;
    
    // Headers
    const headers = ['Column Name', 'Excel Header', 'Description', 'Example Values'];
    headers.forEach((header, idx) => {
        const col = String.fromCharCode(65 + idx);
        const cell = sheet.getCell(`${col}${row}`);
        cell.value = header;
        cell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.WHITE } };
        cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.CHARCOAL } };
        cell.alignment = { horizontal: 'center', vertical: 'middle' };
        cell.border = getBorder('thin');
    });
    row++;
    
    // Dictionary entries
    const dictionary = [
        ['EMPLOYEE', 'EMPLOYEE', 'Employee full name (legal)', 'Smith, John'],
        ['STATUS', 'STATUS', 'Current employment status', 'ACTIVE, INACTIVE, TERMINATED'],
        ['SALARY', 'SALARY', 'Annual salary or hourly rate converted to annual', '$52,000.00'],
        ['HIRE DATE', 'HIRE DATE', 'Original date of hire', '01/15/2020'],
        ['CONTACT', 'CONTACT', 'Primary phone number', '(214) 555-1234'],
        ['CITY', 'CITY', 'City of residence', 'Dallas'],
        ['STATE', 'STATE', 'State abbreviation', 'TX'],
        ['TIER', 'TIER', 'Coverage tier election', 'EO (Employee Only), ES (Employee + Spouse), EC (Employee + Child), EF (Employee + Family)'],
        ['MEDICAL', 'MEDICAL ❤️', 'Medical plan selection or waived', 'HMO / ATBAB303, PPO / ATBCB402, Waived Coverage'],
        ['DENTAL', 'DENTAL 🦷', 'Dental plan selection or waived', 'F-PLAN 2W / Base MAC, F-PLAN 3W / Buy Up MAC, Waived Coverage'],
        ['VISION', 'VISION 👁', 'Vision plan selection or waived', 'Vision Plan 1, Waived Coverage'],
        ['LIFE / AD&D', 'LIFE / AD&D 🛡', 'Life insurance status', 'Employer Paid, Elected, None']
    ];
    
    dictionary.forEach((entry, idx) => {
        const isEven = idx % 2 === 0;
        
        entry.forEach((value, colIdx) => {
            const col = String.fromCharCode(65 + colIdx);
            const cell = sheet.getCell(`${col}${row}`);
            cell.value = value;
            cell.font = { name: 'Arial', size: 10 };
            cell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: isEven ? COLORS.GRAY_LIGHT : COLORS.WHITE } };
            cell.alignment = { horizontal: 'left', vertical: 'top', wrapText: true };
            cell.border = getBorder('thin');
        });
        
        row++;
    });
    
    // Footer
    row += 2;
    sheet.mergeCells(`A${row}:D${row}`);
    const footer = sheet.getCell(`A${row}`);
    footer.value = 'This data dictionary provides definitions for all columns used in the 2026 Elections — Detail sheet.';
    footer.font = { name: 'Arial', size: 9, italic: true, color: { argb: COLORS.GRAY_STATUS } };
    footer.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.BLUE_LIGHT } };
    footer.alignment = { horizontal: 'left', vertical: 'middle' };
    footer.border = getBorder('thin');
    
    // Column widths
    sheet.columns = [
        { width: 18 }, { width: 18 }, { width: 45 }, { width: 50 }
    ];
}

// ======================== HELPER FUNCTIONS ========================

/**
 * Create KPI tile with ExcelJS
 */
function createKPITileExcelJS(sheet, row, startCol, endCol, label, value, accentColor) {
    // Value row
    sheet.mergeCells(`${startCol}${row}:${endCol}${row}`);
    const valueCell = sheet.getCell(`${startCol}${row}`);
    valueCell.value = value;
    valueCell.font = { name: 'Arial', size: 24, bold: true, color: { argb: accentColor } };
    valueCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.WHITE } };
    valueCell.alignment = { horizontal: 'center', vertical: 'middle' };
    valueCell.border = {
        left: { style: 'medium', color: { argb: accentColor } },
        ...getBorder('thin')
    };
    sheet.getRow(row).height = 35;
    
    // Label row
    sheet.mergeCells(`${startCol}${row + 1}:${endCol}${row + 1}`);
    const labelCell = sheet.getCell(`${startCol}${row + 1}`);
    labelCell.value = label;
    labelCell.font = { name: 'Arial', size: 10, bold: true, color: { argb: COLORS.CHARCOAL } };
    labelCell.fill = { type: 'pattern', pattern: 'solid', fgColor: { argb: COLORS.GRAY_LIGHT } };
    labelCell.alignment = { horizontal: 'center', vertical: 'middle' };
    labelCell.border = {
        left: { style: 'medium', color: { argb: accentColor } },
        ...getBorder('thin')
    };
    sheet.getRow(row + 1).height = 20;
}

/**
 * Get border style
 */
function getBorder(style) {
    const colorMap = {
        'thin': COLORS.BORDER_LIGHT,
        'medium': COLORS.BORDER_MEDIUM,
        'thick': COLORS.BORDER_DARK
    };
    
    const color = colorMap[style] || COLORS.BORDER_LIGHT;
    
    return {
        top: { style: style, color: { argb: color } },
        bottom: { style: style, color: { argb: color } },
        left: { style: style, color: { argb: color } },
        right: { style: style, color: { argb: color } }
    };
}

// ======================== END OF EXCELJS EXPORT CODE ========================
/**
 * APPLY FORMATTING TO DETAILED ELECTIONS SHEET
 * Sets fonts, colors, borders, zebra striping, and number formats
 */
function applyDetailStyles(ws, headerRow, maxRow, employeeCount) {
    const range = XLSX.utils.decode_range(ws['!ref']);
    
    for (let R = range.s.r; R <= maxRow; R++) {
        for (let C = range.s.c; C <= range.e.c; C++) {
            const cellRef = XLSX.utils.encode_cell({ r: R, c: C });
            if (!ws[cellRef]) continue;
            
            if (!ws[cellRef].s) ws[cellRef].s = {};
            
            // Base font
            ws[cellRef].s.font = { name: 'Arial', sz: 10 };
            
            // Title rows (1-2) - Bold, navy background
            if (R <= 1) {
                ws[cellRef].s.font = { name: 'Arial', sz: R === 0 ? 14 : 11, bold: true, color: { rgb: "FFFFFF" } };
                ws[cellRef].s.fill = { fgColor: { rgb: "1F2937" } };
                ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
            }
            
            // Header row - Bold white on dark navy
            if (R === headerRow - 1) {
                ws[cellRef].s.font = { name: 'Arial', sz: 10, bold: true, color: { rgb: "FFFFFF" } };
                ws[cellRef].s.fill = { fgColor: { rgb: "1E3A8A" } };
                ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center', wrapText: true };
                ws[cellRef].s.border = {
                    top: { style: 'medium', color: { rgb: "000000" } },
                    bottom: { style: 'medium', color: { rgb: "000000" } },
                    left: { style: 'thin', color: { rgb: "FFFFFF" } },
                    right: { style: 'thin', color: { rgb: "FFFFFF" } }
                };
            }
            
            // Data rows - Zebra striping
            if (R > headerRow - 1 && R < headerRow + employeeCount) {
                const isEvenRow = (R - headerRow) % 2 === 0;
                ws[cellRef].s.fill = { fgColor: { rgb: isEvenRow ? "F9FAFB" : "FFFFFF" } };
                
                // Alignment based on column
                if (C === 0) { // Employee name - left
                    ws[cellRef].s.alignment = { horizontal: 'left', vertical: 'center' };
                } else if (C === 1 || C === 7) { // Status, Tier - center
                    ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
                } else if (C === 2) { // Salary - right
                    ws[cellRef].s.alignment = { horizontal: 'right', vertical: 'center' };
                    // Currency format if numeric
                    if (ws[cellRef].v && typeof ws[cellRef].v === 'number') {
                        ws[cellRef].z = '$#,##0.00';
                    }
                } else if (C === 3) { // Date
                    ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
                    if (ws[cellRef].v && ws[cellRef].v instanceof Date) {
                        ws[cellRef].z = 'mm/dd/yyyy';
                    }
                } else {
                    ws[cellRef].s.alignment = { horizontal: 'left', vertical: 'center' };
                }
                
                // Light borders
                ws[cellRef].s.border = {
                    top: { style: 'thin', color: { rgb: "E5E7EB" } },
                    bottom: { style: 'thin', color: { rgb: "E5E7EB" } },
                    left: { style: 'thin', color: { rgb: "E5E7EB" } },
                    right: { style: 'thin', color: { rgb: "E5E7EB" } }
                };
            }
            
            // Totals row - Bold with distinct background
            if (R === maxRow - 1) {
                ws[cellRef].s.font = { name: 'Arial', sz: 10, bold: true };
                ws[cellRef].s.fill = { fgColor: { rgb: "DBEAFE" } };
                ws[cellRef].s.alignment = { horizontal: 'center', vertical: 'center' };
                ws[cellRef].s.border = {
                    top: { style: 'medium', color: { rgb: "1E3A8A" } },
                    bottom: { style: 'medium', color: { rgb: "1E3A8A" } },
                    left: { style: 'thin', color: { rgb: "93C5FD" } },
                    right: { style: 'thin', color: { rgb: "93C5FD" } }
                };
            }
        }
    }
    
    // Set row heights
    ws['!rows'] = ws['!rows'] || [];
    ws['!rows'][0] = { hpt: 25 }; // Title
    ws['!rows'][1] = { hpt: 18 }; // Subtitle
    ws['!rows'][headerRow - 1] = { hpt: 35 }; // Header row (taller for wrapped text)
}






















        // ======================== AUDIT LOGS ========================
        async function loadAuditLogs() {
            const tbody = document.getElementById("auditBody");
            tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">Loading audit logs...</td></tr>';

            try {
                const { data: logs, error } = await supabase
                    .from("portal_logs")
                    .select("id, portal_user_id, login_time, logout_time, duration_minutes, tab_accessed, tab_history")
                    .order("login_time", { ascending: false });

                if (error) throw error;

                if (!portalUsersCache.length) {
                    await loadPortalUsers();
                }

                const userMap = Object.fromEntries(portalUsersCache.map((u) => [u.id, u]));

                tbody.innerHTML = "";
                (logs || []).forEach((log) => {
                    const user = log.portal_user_id ? userMap[log.portal_user_id] : null;
                    const name = user ? `${user.full_name} (${user.initials})` : "Unknown";
                    const duration = log.duration_minutes != null ? `${log.duration_minutes} min` : "—";
                    const historyArray = Array.isArray(log.tab_history) ? log.tab_history : [];
                    const historyHtml = historyArray.length
                        ? historyArray
                              .slice(-5)
                              .reverse()
                              .map((entry) => `<div class="text-xs text-slate-700">${esc(entry)}</div>`)
                              .join("")
                        : '<span class="text-slate-400">Dashboard</span>';

                    tbody.insertAdjacentHTML("beforeend", `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-2.5">${esc(name)}</td>
                            <td class="px-4 py-2.5">${formatDate(log.login_time)}</td>
                            <td class="px-4 py-2.5">
                                ${log.logout_time ? formatDate(log.logout_time) : '<span class="text-amber-600">Active</span>'}
                            </td>
                            <td class="px-4 py-2.5">${duration}</td>
                            <td class="px-4 py-2.5 space-y-1 max-w-xs">${historyHtml}</td>
                        </tr>
                    `);
                });

                if (!logs || !logs.length) {
                    tbody.innerHTML = '<tr><td colspan="5" class="px-4 py-4 text-center text-xs text-slate-500">No audit history yet.</td></tr>';
                }
            } catch (err) {
                console.error("Audit logs failed:", err);
                tbody.innerHTML = '<tr><td colspan="5" class="text-red-600 text-center text-xs px-4 py-4">Failed to load</td></tr>';
            }
        }

        // ======================== PORTAL USERS ========================
        async function loadPortalUsers() {
            const tbody = document.getElementById("userBody");
            tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';

            try {
                const { data, error } = await supabase
                    .from("portal_users")
                    .select("id, full_name, initials, role, active, last_login, allowed_tabs")
                    .order("full_name", { ascending: true });

                if (error) throw error;

                portalUsersCache = data || [];
                renderPortalUsersTable();
            } catch (err) {
                console.error("Portal users error", err);
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-red-500">Error loading users.</td></tr>';
            }
        }

        function renderPortalUsersTable() {
            const tbody = document.getElementById("userBody");
            const search = document.getElementById("userSearch").value.trim().toLowerCase();

            let rows = portalUsersCache;
            if (search) {
                rows = rows.filter((u) => u.full_name.toLowerCase().includes(search));
            }

            if (!rows.length) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">No users match your search.</td></tr>';
                return;
            }

            tbody.innerHTML = "";
            rows.forEach((u) => {
                const roleBadge =
                    u.role === "admin"
                        ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-red-50 text-red-700 border border-red-100">ADMIN</span>'
                        : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-700 border border-slate-200">STANDARD</span>';

                const statusBadge = u.active
                    ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100">ACTIVE</span>'
                    : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-500 border border-slate-200">INACTIVE</span>';

                tbody.insertAdjacentHTML("beforeend", `
                    <tr class="hover:bg-slate-50 text-sm" data-id="${u.id}">
                        <td class="px-4 py-2.5">${esc(u.full_name)}</td>
                        <td class="px-4 py-2.5">${esc(u.initials)}</td>
                        <td class="px-4 py-2.5">${roleBadge}</td>
                        <td class="px-4 py-2.5 text-xs text-slate-500">${formatDate(u.last_login)}</td>
                        <td class="px-4 py-2.5">${statusBadge}</td>
                        <td class="px-4 py-2.5 text-xs">
                            <button class="text-[color:var(--jc-red)] hover:underline mr-3" data-action="edit">Edit</button>
                            <button class="text-slate-500 hover:text-red-600" data-action="delete">Delete</button>
                        </td>
                    </tr>
                `);
            });
        }

        document.getElementById("userSearch").addEventListener("input", renderPortalUsersTable);

        document.getElementById("userBody").addEventListener("click", async (e) => {
            const row = e.target.closest("tr[data-id]");
            if (!row) return;
            const id = Number(row.dataset.id);
            const user = portalUsersCache.find((u) => u.id === id);
            if (!user) return;

            const action = e.target.dataset.action;
            if (action === "edit") {
                openUserModal(user);
            } else if (action === "delete") {
                if (user.initials === "PG") {
                    showToast({
                        title: "Protected account",
                        message: "You cannot delete the primary owner account.",
                        type: "error",
                    });
                    return;
                }
                if (!confirm(`Delete portal user ${user.full_name}?`)) return;
                try {
                    const { error } = await supabase.from("portal_users").delete().eq("id", id);
                    if (error) throw error;
                    portalUsersCache = portalUsersCache.filter((u) => u.id !== id);
                    renderPortalUsersTable();
                    showToast({
                        title: "User deleted",
                        message: `${user.full_name} was removed from portal access.`,
                        type: "success",
                    });
                } catch (err) {
                    console.error("Delete user error", err);
                    showToast({
                        title: "Delete failed",
                        message: "Could not delete this user.",
                        type: "error",
                    });
                }
            }
        });

        // ======================== USER MODAL ========================
        const userModal = document.getElementById("userModal");
        const modalTitle = document.getElementById("userModalTitle");
        const modalFullName = document.getElementById("modalFullName");
        const modalInitials = document.getElementById("modalInitials");
        const modalPin = document.getElementById("modalPin");
        const modalRole = document.getElementById("modalRole");
        const modalActive = document.getElementById("modalActive");
        const modalCancel = document.getElementById("modalCancel");
        const modalSave = document.getElementById("modalSave");
        let editingUserId = null;

        document.getElementById("addUserButton").addEventListener("click", () => openUserModal(null));

        function openUserModal(user) {
            if (!currentUser || currentUser.role !== "admin") {
                showToast({
                    title: "Not allowed",
                    message: "Only administrators can manage portal users.",
                    type: "error",
                });
                return;
            }

            editingUserId = user ? user.id : null;
            modalTitle.textContent = editingUserId ? "Edit user" : "Add user";
            modalFullName.value = user?.full_name || "";
            modalInitials.value = user?.initials || "";
            modalPin.value = "";
            modalRole.value = user?.role || "user";
            modalActive.checked = user ? !!user.active : true;

            userModal.classList.remove("hidden");
            userModal.classList.add("flex");
        }

        modalCancel.addEventListener("click", () => {
            userModal.classList.add("hidden");
            userModal.classList.remove("flex");
        });

        modalSave.addEventListener("click", async () => {
            const fullName = modalFullName.value.trim();
            const initials = modalInitials.value.trim().toUpperCase();
            const pin = modalPin.value.trim();
            const role = modalRole.value;
            const active = modalActive.checked;

            if (!fullName || !initials || !pin) {
                showToast({
                    title: "Missing fields",
                    message: "Full name, initials, and PIN are required.",
                    type: "error",
                });
                return;
            }

            if (!/^\d{4}$/.test(pin)) {
                showToast({
                    title: "Invalid PIN",
                    message: "PIN must be exactly 4 digits.",
                    type: "error",
                });
                return;
            }

            try {
                if (editingUserId) {
                    const { error } = await supabase
                        .from("portal_users")
                        .update({ full_name: fullName, initials, pin, role, active })
                        .eq("id", editingUserId);
                    if (error) throw error;
                } else {
                    const { error } = await supabase.from("portal_users").insert([
                        {
                            full_name: fullName,
                            initials,
                            username: initials,
                            pin,
                            role,
                            active,
                        },
                    ]);
                    if (error) throw error;
                }

                userModal.classList.add("hidden");
                userModal.classList.remove("flex");
                await loadPortalUsers();
                showToast({
                    title: "Saved",
                    message: "Portal user changes have been saved.",
                    type: "success",
                });
            } catch (err) {
                console.error("Save user error", err);
                showToast({
                    title: "Save failed",
                    message: "Could not save this portal user.",
                    type: "error",
                });
            }
        });

        // ======================== PERMISSIONS TAB ========================
        async function loadPermissionsTab() {
            const tbody = document.getElementById("permissionsBody");
            tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';

            try {
                const { data, error } = await supabase
                    .from("portal_users")
                    .select("id, full_name, initials, role, allowed_tabs")
                    .order("full_name", { ascending: true });

                if (error) throw error;

                const tabs = ['docs', 'summary', 'comparison', 'elections', 'audit', 'users'];

                tbody.innerHTML = "";

                (data || []).forEach((u) => {
                    const isAdmin = u.role === "admin";
                    const allowed = u.allowed_tabs || (isAdmin ? tabs : ["docs"]);

                    const checkboxes = tabs
                        .map((tab) => {
                            const tabNames = {
                                docs: "Signed Docs",
                                summary: "Benefit Summary",
                                comparison: "Employee Comparison",
                                elections: "2026 Elections",
                                audit: "Audit Logs",
                                users: "Authorized Users",
                            };
                            const displayName = tabNames[tab] || tab;

                            return `
                                <td class="px-4 py-2.5 text-center">
                                    <input type="checkbox" 
                                           data-user="${u.id}" 
                                           data-tab="${tab}" 
                                           ${allowed.includes(tab) ? "checked" : ""} 
                                           ${isAdmin ? 'disabled title="Admins have all permissions"' : ""}
                                           class="rounded border-slate-300 text-[color:var(--jc-red)]">
                                    <div class="text-[10px] font-medium text-slate-500 mt-1">${displayName}</div>
                                </td>
                            `;
                        })
                        .join("");

                    tbody.insertAdjacentHTML("beforeend", `
                        <tr class="hover:bg-slate-50">
                            <td class="px-4 py-2.5 font-medium text-slate-900">${esc(u.full_name)}</td>
                            <td class="px-4 py-2.5 font-mono text-sm text-slate-700">${esc(u.initials)}</td>
                            ${checkboxes}
                        </tr>
                    `);
                });

                tbody.querySelectorAll('input[type="checkbox"]').forEach((chk) => {
                    chk.addEventListener("change", async (e) => {
                        const userId = e.target.dataset.user;
                        const tab = e.target.dataset.tab;
                        const checked = e.target.checked;

                        try {
                            const { data: user } = await supabase
                                .from("portal_users")
                                .select("allowed_tabs")
                                .eq("id", userId)
                                .single();

                            let allowed = user.allowed_tabs || [];

                            if (checked) {
                                if (!allowed.includes(tab)) allowed.push(tab);
                            } else {
                                allowed = allowed.filter((t) => t !== tab);
                            }

                            const { error } = await supabase
                                .from("portal_users")
                                .update({ allowed_tabs: allowed })
                                .eq("id", userId);

                            if (error) throw error;

                            showToast({
                                title: "Permission Updated",
                                message: `${tab} permission ${checked ? "granted" : "revoked"}`,
                                type: "success",
                            });
                        } catch (err) {
                            console.error("Permission update error", err);
                            e.target.checked = !checked;
                            showToast({
                                title: "Update Failed",
                                message: "Could not save permission change.",
                                type: "error",
                            });
                        }
                    });
                });

                showToast({
                    title: "Permissions Loaded",
                    message: `${data?.length || 0} users loaded`,
                    type: "success",
                });
            } catch (err) {
                console.error("Load permissions error", err);
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-4 text-center text-xs text-red-500">Error loading permissions.</td></tr>';
            }
        }





      // ======================== EMPLOYEE MODAL (COMPLETE FIX) ========================
        const employeeModal = document.getElementById("employeeModal");
        const modalContent = document.getElementById("modalContent");
        const employeeModalTitle = document.getElementById("employeeModalTitle");
        const modalClose = document.getElementById("modalClose");
        const modalSaveEmployee = document.getElementById("modalSaveEmployee")
        const modalToggleFull = document.getElementById("modalToggleFull")
modalToggleFull.addEventListener('click', () => {
    // ... modal fullscreen code ...
    const icon = modalToggleFull.querySelector('i');  // <-- This might reference btnFullscreen
    icon.classList.toggle('fa-expand');
    icon.classList.toggle('fa-compress');
})

let originalParent = null;

if (modalToggleFull && employeeModal) {
    originalParent = employeeModal.parentElement;
    
    modalToggleFull.addEventListener('click', () => {
        if (employeeModal.classList.contains('full-modal')) {
            // Compress: Remove class and move back to original parent
            employeeModal.classList.remove('full-modal');
            if (originalParent) {
                originalParent.appendChild(employeeModal);
            }
        } else {
            // Expand: Add class and move to body
            employeeModal.classList.add('full-modal');
            document.body.appendChild(employeeModal);
        }
        
        const icon = modalToggleFull.querySelector('i');
        if (icon) {
            icon.classList.toggle('fa-expand');
            icon.classList.toggle('fa-compress');
        }
    });
}

// ======================== PAGE FULLSCREEN TOGGLE ========================
const btnFullscreen = document.getElementById('btnFullscreen');

console.log('🔍 Fullscreen button found?', btnFullscreen);

if (btnFullscreen) {
    btnFullscreen.addEventListener('click', async () => {
        console.log('========================================');
        console.log('🔍 FULLSCREEN BUTTON CLICKED');
        console.log('========================================');
        
        console.log('📍 Current fullscreen element:', document.fullscreenElement);
        console.log('📍 Webkit fullscreen element:', document.webkitFullscreenElement);
        
        console.log('🌐 Browser capabilities:', {
            requestFullscreen: !!document.documentElement.requestFullscreen,
            webkitRequestFullscreen: !!document.documentElement.webkitRequestFullscreen,
            mozRequestFullScreen: !!document.documentElement.mozRequestFullScreen,
            msRequestFullscreen: !!document.documentElement.msRequestFullscreen
        });
        
        console.log('🖥️ Document element:', document.documentElement);
        console.log('📏 Screen size:', { width: screen.width, height: screen.height });
        console.log('🔒 Fullscreen enabled?', document.fullscreenEnabled || document.webkitFullscreenEnabled);
        
        const elem = document.documentElement;
        
        try {
            const isCurrentlyFullscreen = !!(
                document.fullscreenElement || 
                document.webkitFullscreenElement || 
                document.mozFullScreenElement || 
                document.msFullscreenElement
            );
            
            console.log('📊 Currently in fullscreen?', isCurrentlyFullscreen);
            
            if (!isCurrentlyFullscreen) {
                console.log('➡️ ATTEMPTING TO ENTER FULLSCREEN...');
                
                if (elem.requestFullscreen) {
                    console.log('✅ Using standard requestFullscreen()');
                    await elem.requestFullscreen();
                    console.log('✅ Standard fullscreen request sent');
                } else if (elem.webkitRequestFullscreen) {
                    console.log('✅ Using Safari webkitRequestFullscreen()');
                    await elem.webkitRequestFullscreen();
                    console.log('✅ Safari fullscreen request sent');
                } else if (elem.mozRequestFullScreen) {
                    console.log('✅ Using Firefox mozRequestFullScreen()');
                    await elem.mozRequestFullScreen();
                    console.log('✅ Firefox fullscreen request sent');
                } else if (elem.msRequestFullscreen) {
                    console.log('✅ Using IE/Edge msRequestFullscreen()');
                    await elem.msRequestFullscreen();
                    console.log('✅ IE/Edge fullscreen request sent');
                } else {
                    console.error('❌ NO FULLSCREEN METHOD AVAILABLE');
                    showToast({
                        title: "Not Supported",
                        message: "Your browser does not support fullscreen mode.",
                        type: "error"
                    });
                }
                
            } else {
                console.log('⬅️ ATTEMPTING TO EXIT FULLSCREEN...');
                
                if (document.exitFullscreen) {
                    console.log('✅ Using standard exitFullscreen()');
                    await document.exitFullscreen();
                    console.log('✅ Standard exit sent');
                } else if (document.webkitExitFullscreen) {
                    console.log('✅ Using Safari webkitExitFullscreen()');
                    await document.webkitExitFullscreen();
                    console.log('✅ Safari exit sent');
                } else if (document.mozCancelFullScreen) {
                    console.log('✅ Using Firefox mozCancelFullScreen()');
                    await document.mozCancelFullScreen();
                    console.log('✅ Firefox exit sent');
                } else if (document.msExitFullscreen) {
                    console.log('✅ Using IE/Edge msExitFullscreen()');
                    await document.msExitFullscreen();
                    console.log('✅ IE/Edge exit sent');
                }
            }
            
            console.log('✅ FULLSCREEN OPERATION COMPLETED');
            console.log('========================================');
            
        } catch (err) {
            console.error('========================================');
            console.error('❌ FULLSCREEN ERROR:');
            console.error('Error message:', err.message);
            console.error('Error stack:', err.stack);
            console.error('Error name:', err.name);
            console.error('========================================');
            
            showToast({
                title: "Fullscreen Error",
                message: `${err.name}: ${err.message}`,
                type: "error"
            });
        }
    });

    // Update icon when fullscreen state changes
    const updateFullscreenIcon = () => {
        const isFullscreen = !!(
            document.fullscreenElement || 
            document.webkitFullscreenElement || 
            document.mozFullScreenElement || 
            document.msFullscreenElement
        );
        
        console.log('🔄 Fullscreen state changed. Is fullscreen?', isFullscreen);
        
        const icon = btnFullscreen.querySelector('i');
        if (icon) {
            if (isFullscreen) {
                icon.className = 'fa-solid fa-compress text-sm';
                btnFullscreen.title = 'Exit Full Screen';
                console.log('🔽 Icon changed to COMPRESS');
            } else {
                icon.className = 'fa-solid fa-expand text-sm';
                btnFullscreen.title = 'Toggle Full Screen';
                console.log('🔼 Icon changed to EXPAND');
            }
        } else {
            console.error('❌ Icon element not found inside button');
        }
    };

    // Listen for fullscreen changes (all browsers)
    document.addEventListener('fullscreenchange', () => {
        console.log('📢 fullscreenchange event fired');
        updateFullscreenIcon();
    });
    document.addEventListener('webkitfullscreenchange', () => {
        console.log('📢 webkitfullscreenchange event fired (Safari)');
        updateFullscreenIcon();
    });
    document.addEventListener('mozfullscreenchange', () => {
        console.log('📢 mozfullscreenchange event fired (Firefox)');
        updateFullscreenIcon();
    });
    document.addEventListener('MSFullscreenChange', () => {
        console.log('📢 MSFullscreenChange event fired (IE/Edge)');
        updateFullscreenIcon();
    });
    
    // Initial icon state
    console.log('🎬 Setting initial fullscreen icon state');
    updateFullscreenIcon();
    
    console.log('✅ Fullscreen button initialized successfully');
} else {
    console.error('❌ CRITICAL: Fullscreen button with id="btnFullscreen" NOT FOUND in DOM');
}


        // ======================== SAVE CURRENT TAB DATA (NEW) ========================



        
        function saveCurrentTabData() {
    if (!currentEditingEnrollment) return;
    // Save Details Tab
    const jobTitle = document.getElementById("modal-job-title");
    const salary = document.getElementById("modal-salary");
    const phone = document.getElementById("modal-phone");
    const email = document.getElementById("modal-email");
    const address = document.getElementById("modal-address");
    const city = document.getElementById("modalCity");
    const state = document.getElementById("modalState");
    const zip = document.getElementById("modalZip");
    const hireDate = document.getElementById("modalHireDate");
    const empStatus = document.getElementById("modalEmploymentStatus");
    if (jobTitle) currentEditingEnrollment.jobTitle = jobTitle.value.trim();
    if (salary) currentEditingEnrollment.salary = parseFloat(salary.value) || null;
    if (phone) currentEditingEnrollment.phone = phone.value.trim();
    if (email) currentEditingEnrollment.email = email.value.trim();
    if (address) currentEditingEnrollment.address = address.value.trim();
    if (city) currentEditingEnrollment.city = city.value.trim();
    if (state) currentEditingEnrollment.state = state.value.trim();
    if (zip) currentEditingEnrollment.zip = zip.value.trim();
    if (hireDate) currentEditingEnrollment.hireDate = hireDate.value || null;
    if (empStatus) currentEditingEnrollment.employmentStatus = empStatus.value;
    // Save Family Tab
    const spouseFirst = document.getElementById("spouse-first");
    const spouseLast = document.getElementById("spouse-last");
    const spouseDob = document.getElementById("spouse-dob");
    const spouseSsn = document.getElementById("spouse-ssn");
    if (spouseFirst || spouseLast || spouseDob || spouseSsn) {
        currentEditingEnrollment.spouse = {
            first: spouseFirst?.value.trim() || '',
            last: spouseLast?.value.trim() || '',
            dob: spouseDob?.value || null,
            ssn: spouseSsn?.value.trim() || ''
        };
    }
    // Save Dependents
    const depRows = document.querySelectorAll('[data-dep-index]');
    if (depRows.length > 0) {
        currentEditingEnrollment.dependents = [];
        depRows.forEach(row => {
            currentEditingEnrollment.dependents.push({
                first: row.querySelector('.dep-first')?.value.trim() || '',
                last: row.querySelector('.dep-last')?.value.trim() || '',
                dob: row.querySelector('.dep-dob')?.value || null,
                relationship: row.querySelector('.dep-rel')?.value || 'Child'
            });
        });
    }
    // Save Beneficiaries
    const benRows = document.querySelectorAll('[data-ben-index]');
    if (benRows.length > 0) {
        currentEditingEnrollment.beneficiaries = [];
        benRows.forEach(row => {
            currentEditingEnrollment.beneficiaries.push({
                first: row.querySelector('.ben-first')?.value.trim() || '',
                last: row.querySelector('.ben-last')?.value.trim() || '',
                dob: row.querySelector('.ben-dob')?.value || null,
                relationship: row.querySelector('.ben-rel')?.value || 'Spouse',
                pct: parseFloat(row.querySelector('.ben-pct')?.value) || 0
            });
        });
    }
}


        async function openEmployeeModal(enrollmentId) {
            try {
                showToast({
                    title: "Loading...",
                    message: "Fetching employee details...",
                    type: "info"
                });

                const { data: enrData, error: enrError } = await supabase
                    .from('benefit_enrollments')
                    .select('*')
                    .eq('id', enrollmentId)
                    .single();

                if (enrError) throw enrError;

                const username = enrData.username;
                const { data: empData, error: empError } = await supabase
                    .from('employees2025')
                    .select('*')
                    .eq('username', username)
                    .single();

                if (empError) throw empError;

                await ensureBenefitRatesLoaded();

                const tier = enrData.tier_election || "EO";
                const medPlanCode = enrData.medical_plan || "WAIVE";
                const dentalPlanCode = enrData.dental_plan || "WAIVE";
                const visionPlanCode = enrData.vision_plan || "WAIVE";

                const medBi = getRateAmount(2026, "medical", tier, medPlanCode);
                const denBi = getRateAmount(2026, "dental", tier, dentalPlanCode);
                const visBi = getRateAmount(2026, "vision", tier, visionPlanCode);
                const lifeBi = 0;

                currentEditingEnrollment = {
                    enrollmentId: enrData.id,
                    employeeName: `${empData.last_name}, ${empData.first_name}`,
                    firstName: empData.first_name,
                    lastName: empData.last_name,
                    jobTitle: enrData.job_title || empData.job_title || "",
                    employmentStatus: enrData.employment_status || empData.employment_status || "ACTIVE",
                    salary: enrData.annual_salary || empData.annual_salary || null,
                    hourlyRate: empData.hourly_rate || 0,
                    hireDate: enrData.hire_date || empData.original_hire_date || null,
                    phone: enrData.phone || empData.primary_phone || "",
                    email: enrData.email || empData.email || "",
                    address: enrData.address?.street || empData.address_line_1 || "",
                    city: enrData.address?.city || empData.city || "",
                    state: enrData.address?.state || empData.state || "TX",
                    zip: enrData.address?.zip || empData.zip_code || "",
                    ssn: empData.sssn || empData.ssn || "",
                    tier,
                    medPlanCode,
                    dentalPlanCode,
                    visionPlanCode,
                    medBi,
                    denBi,
                    visBi,
                    lifeBi,
                    totalBi: medBi + denBi + visBi + lifeBi,
                    spouse: enrData.spouse || { first: '', last: '', dob: '', ssn: '' },
                    dependents: enrData.dependents || [],
                    beneficiaries: enrData.beneficiaries || [],
                    employerLife: empData.employer_life || enrData.employer_life || false,
                    rawEmployeeData: empData,
                    rawEnrollmentData: enrData,
                    employee_id_fk: empData.id,
                };

                employeeModalTitle.textContent = `${currentEditingEnrollment.employeeName} — Enrollment Details`;

                employeeModal.classList.remove('hidden');
                employeeModal.classList.add('flex');

                switchModalTab('details');
            } catch (err) {
                console.error('Load employee modal error:', err);
                showToast({
                    title: "Load Error",
                    message: "Failed to load employee data: " + err.message,
                    type: "error"
                });
            }
        }

        // ======================== DETAILS TAB ========================
        function renderDetailsTab() {
            const d = currentEditingEnrollment;
            modalContent.innerHTML = `
                <div class="space-y-4">
                    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Employment & Personal Data</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Full Name</label>
                            <input type="text" class="w-full rounded-md px-3 py-2 border text-sm bg-slate-50" value="${esc(d.employeeName)}" disabled>
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Job Title</label>
                            <input id="modal-job-title" type="text" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.jobTitle)}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Annual Salary</label>
                            <input id="modal-salary" type="number" step="0.01" class="w-full rounded-md px-3 py-2 border text-sm" value="${d.salary || ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">SSN (Full)</label>
                            <input id="modal-ssn" type="text" class="w-full rounded-md px-3 py-2 border text-sm font-mono bg-slate-50" value="${d.ssn ? formatSSN(d.ssn) : ''}" disabled>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 uppercase tracking-wide">Hire Date</label>
                            <input id="modalHireDate" type="date" class="mt-1 block w-full rounded-md border px-3 py-2 text-sm" value="${d.hireDate ? d.hireDate.slice(0, 10) : ''}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 uppercase tracking-wide">Employment Status</label>
                            <select id="modalEmploymentStatus" class="mt-1 block w-full rounded-md border px-3 py-2 text-sm bg-white">
                                <option value="ACTIVE" ${d.employmentStatus === 'ACTIVE' ? 'selected' : ''}>Active</option>
                                <option value="INACTIVE" ${d.employmentStatus === 'INACTIVE' ? 'selected' : ''}>Inactive</option>
                                <option value="TERMINATED" ${d.employmentStatus === 'TERMINATED' ? 'selected' : ''}>Terminated</option>
                            </select>
                        </div>
                    </div>

                    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2 pt-4">Contact Information</h4>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Phone</label>
                            <input id="modal-phone" type="tel" class="w-full rounded-md px-3 py-2 border text-sm" value="${d.phone}">
                        </div>
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Email</label>
                            <input id="modal-email" type="email" class="w-full rounded-md px-3 py-2 border text-sm" value="${d.email}">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">Address Line 1</label>
                        <input id="modal-address" type="text" class="w-full rounded-md px-3 py-2 border text-sm" value="${esc(d.address)}">
                    </div>
                    
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <label class="block text-xs font-medium text-slate-600 uppercase tracking-wide">City</label>
                            <input id="modalCity" type="text" class="mt-1 block w-full rounded-md border px-3 py-2 text-sm" value="${esc(d.city)}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 uppercase tracking-wide">State</label>
                            <input id="modalState" type="text" maxlength="2" class="mt-1 block w-full rounded-md border px-3 py-2 text-sm" value="${esc(d.state)}">
                        </div>
                        <div>
                            <label class="block text-xs font-medium text-slate-600 uppercase tracking-wide">ZIP Code</label>
                            <input id="modalZip" type="text" class="mt-1 block w-full rounded-md border px-3 py-2 text-sm" value="${esc(d.zip)}">
                        </div>
                    </div>
                </div>
            `;
        }

        // ======================== ELECTIONS TAB (WITH LIFE WAIVE OPTION) ========================
        function renderElectionsTab() {
            const d = currentEditingEnrollment;
            
            modalContent.innerHTML = `
                <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Plan Elections (2026)</h4>
                <div class="space-y-4">
                    <div>
                        <label class="block text-xs font-semibold text-slate-700 mb-1">Coverage Tier</label>
                        <select id="modal-tier" class="w-full rounded-md px-3 py-2 border text-sm">
                            <option value="EO" ${d.tier === "EO" ? "selected" : ""}>Employee Only (EO)</option>
                            <option value="ES" ${d.tier === "ES" ? "selected" : ""}>Employee + Spouse (ES)</option>
                            <option value="EC" ${d.tier === "EC" ? "selected" : ""}>Employee + Child(ren) (EC)</option>
                            <option value="EF" ${d.tier === "EF" ? "selected" : ""}>Employee + Family (EF)</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-4">
                        ${renderPlanSelect("Medical", "med", d.medPlanCode)}
                        ${renderPlanSelect("Dental", "den", d.dentalPlanCode)}
                        ${renderPlanSelect("Vision", "vis", d.visionPlanCode)}
                        
                        <!-- LIFE & AD&D WITH WAIVE OPTION -->
                        <div>
                            <label class="block text-xs font-semibold text-slate-700 mb-1">Life & AD&D</label>
                            <select id="modal-life-plan" class="w-full rounded-md px-3 py-2 border text-sm">
                                <option value="EMPLOYER_PAID" ${d.employerLife ? 'selected' : ''}>Employer Paid (Basic Coverage)</option>
                                <option value="WAIVE" ${!d.employerLife ? 'selected' : ''}>Waived</option>
                            </select>
                            <p class="text-xs text-slate-500 mt-1">
                                ${d.employerLife ? 'Basic life insurance provided by employer at no cost.' : 'Employee has waived life insurance coverage.'}
                            </p>
                        </div>
                    </div>

                    <div class="card bg-blue-50 border-blue-200 px-4 py-4 mt-6">
                        <h5 class="text-sm font-semibold text-blue-900 mb-3">Bi-Weekly Cost Summary</h5>
                        <div class="grid grid-cols-5 gap-3 text-sm">
                            <div>
                                <p class="text-xs text-blue-700">Medical</p>
                                <p id="cost-medical" class="text-lg font-bold text-blue-900">${formatCurrency(d.medBi)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-blue-700">Dental</p>
                                <p id="cost-dental" class="text-lg font-bold text-blue-900">${formatCurrency(d.denBi)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-blue-700">Vision</p>
                                <p id="cost-vision" class="text-lg font-bold text-blue-900">${formatCurrency(d.visBi)}</p>
                            </div>
                            <div>
                                <p class="text-xs text-blue-700">Life & AD&D</p>
                                <p id="cost-life" class="text-lg font-bold text-emerald-700">$0.00</p>
                                <p id="cost-life-status" class="text-[10px] text-emerald-600">${d.employerLife ? 'Employer Paid' : 'Waived'}</p>
                            </div>
                            <div class="border-l-2 border-blue-300 pl-3">
                                <p class="text-xs text-blue-700">Total</p>
                                <p id="cost-total" class="text-xl font-bold text-[color:var(--jc-red)]">${formatCurrency(d.totalBi)}</p>
                            </div>
                        </div>
                        <p class="text-xs text-blue-600 mt-3">Annual Cost: <span id="cost-annual" class="font-semibold">${formatCurrency(d.totalBi * 26)}</span></p>
                    </div>
                </div>
            `;

            const recalc = async () => {
                await ensureBenefitRatesLoaded();
                const tier = document.getElementById("modal-tier")?.value || "EO";
                const medPlanCode = document.getElementById("modal-med-plan")?.value || "WAIVE";
                const denPlanCode = document.getElementById("modal-den-plan")?.value || "WAIVE";
                const visPlanCode = document.getElementById("modal-vis-plan")?.value || "WAIVE";
                const lifePlan = document.getElementById("modal-life-plan")?.value || "EMPLOYER_PAID";

                const med = getRateAmount(2026, "medical", tier, medPlanCode);
                const den = getRateAmount(2026, "dental", tier, denPlanCode);
                const vis = getRateAmount(2026, "vision", tier, visPlanCode);
                const life = 0;
                const total = med + den + vis + life;

                document.getElementById("cost-medical").textContent = formatCurrency(med);
                document.getElementById("cost-dental").textContent = formatCurrency(den);
                document.getElementById("cost-vision").textContent = formatCurrency(vis);
                document.getElementById("cost-total").textContent = formatCurrency(total);
                document.getElementById("cost-annual").textContent = formatCurrency(total * 26);
                
                const lifeStatus = document.getElementById("cost-life-status");
                if (lifeStatus) {
                    lifeStatus.textContent = lifePlan === "EMPLOYER_PAID" ? "Employer Paid" : "Waived";
                    lifeStatus.className = lifePlan === "EMPLOYER_PAID" 
                        ? "text-[10px] text-emerald-600" 
                        : "text-[10px] text-slate-500";
                }

                currentEditingEnrollment.medPlanCode = medPlanCode;
                currentEditingEnrollment.denPlanCode = denPlanCode;
                currentEditingEnrollment.visPlanCode = visPlanCode;
                currentEditingEnrollment.employerLife = lifePlan === "EMPLOYER_PAID";
                currentEditingEnrollment.tier = tier;
                currentEditingEnrollment.medBi = med;
                currentEditingEnrollment.denBi = den;
                currentEditingEnrollment.visBi = vis;
                currentEditingEnrollment.lifeBi = life;
                currentEditingEnrollment.totalBi = total;
            };

            ["modal-tier", "modal-med-plan", "modal-den-plan", "modal-vis-plan", "modal-life-plan"].forEach((id) => {
                const el = document.getElementById(id);
                if (el) el.addEventListener("change", recalc);
            });
        }

        function renderPlanSelect(label, key, selectedPlanCode) {
            const options = [{ code: 'WAIVE', name: 'Waive Coverage' }];
            if (label === 'Medical') options.push(
                { code: 'ATBAB303', name: 'HMO / ATBAB303' },
                { code: 'ATBAP393', name: 'HMO HSA / ATBAP393' },
                { code: 'ATBCB402', name: 'PPO / ATBCB402' }
            );
            if (label === 'Dental') options.push(
                { code: 'F_PLAN_2W', name: 'F-PLAN 2W / Base MAC' },
                { code: 'F_PLAN_3W', name: 'F-PLAN 3W / Buy Up MAC' }
            );
            if (label === 'Vision') options.push({ code: 'PLAN_1', name: 'Vision Plan 1' });

            const optionHtml = options.map(opt =>
                `<option value="${opt.code}" ${opt.code === selectedPlanCode ? 'selected' : ''}>${opt.name}</option>`
            ).join('');

            return `
                <div>
                    <label class="block text-xs font-semibold text-slate-700 mb-1">${label} Plan</label>
                    <select id="modal-${key}-plan" class="w-full rounded-md px-3 py-2 border text-sm">
                        ${optionHtml}
                    </select>
                </div>
            `;
        }

        // ======================== FAMILY TAB ========================
        function renderFamilyTab() {
            const d = currentEditingEnrollment;
            const spouse = d.spouse || { first: '', last: '', dob: '', ssn: '' };
            const dependents = d.dependents || [];
            const beneficiaries = d.beneficiaries || [];

            const spouseHtml = `
                <div class="card bg-slate-50 p-4 mb-4">
                    <h5 class="font-semibold text-sm mb-3"><i class="fa-solid fa-ring text-amber-500 mr-2"></i>Spouse / Partner</h5>
                    <div class="grid grid-cols-4 gap-3">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">First Name</label>
                            <input id="spouse-first" type="text" class="w-full border rounded px-2 py-1 text-sm" value="${esc(spouse.first || '')}" placeholder="First">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Last Name</label>
                            <input id="spouse-last" type="text" class="w-full border rounded px-2 py-1 text-sm" value="${esc(spouse.last || '')}" placeholder="Last">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">DOB</label>
                            <input id="spouse-dob" type="date" class="w-full border rounded px-2 py-1 text-sm" value="${spouse.dob || ''}">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">SSN</label>
                            <input id="spouse-ssn" type="text" class="w-full border rounded px-2 py-1 text-sm font-mono" value="${esc(spouse.ssn || '')}" placeholder="XXX-XX-XXXX" maxlength="11">
                        </div>
                    </div>
                </div>
            `;

            const dependentsHtml = `
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-semibold text-sm"><i class="fa-solid fa-child text-blue-500 mr-2"></i>Dependent Children</h5>
                        <button type="button" onclick="addDependent()" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-blue-600 text-white text-xs font-medium hover:bg-blue-700">
                            <i class="fa-solid fa-plus"></i> Add Dependent
                        </button>
                    </div>
                    <div id="dependents-list">
                        ${dependents.length > 0 ? dependents.map((dep, i) => renderDependentRow(dep, i)).join('') : '<p class="text-sm text-slate-500 italic">No dependents on file.</p>'}
                    </div>
                </div>
            `;

            const beneficiariesHtml = `
                <div>
                    <div class="flex justify-between items-center mb-3">
                        <h5 class="font-semibold text-sm"><i class="fa-solid fa-users text-emerald-500 mr-2"></i>Life & AD&D Beneficiaries</h5>
                        <button type="button" onclick="addBeneficiary()" class="inline-flex items-center gap-1 px-3 py-1 rounded-md bg-emerald-600 text-white text-xs font-medium hover:bg-emerald-700">
                            <i class="fa-solid fa-plus"></i> Add Beneficiary
                        </button>
                    </div>
                    <div id="beneficiaries-list">
                        ${beneficiaries.length > 0 ? beneficiaries.map((ben, i) => renderBeneficiaryRow(ben, i)).join('') : '<p class="text-sm text-slate-500 italic">No beneficiaries designated.</p>'}
                    </div>
                    <div id="beneficiary-total" class="mt-3 text-sm font-semibold text-slate-700">
                        Total Beneficiary Share: <span id="total-share">${calculateTotalShare(beneficiaries)}%</span>
                        ${calculateTotalShare(beneficiaries) !== 100 ? '<span class="text-red-600 ml-2"><i class="fa-solid fa-exclamation-triangle"></i> Must equal 100%</span>' : '<span class="text-emerald-600 ml-2"><i class="fa-solid fa-check-circle"></i> Valid</span>'}
                    </div>
                </div>
            `;

            modalContent.innerHTML = `
                <div class="space-y-6">
                    <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Family & Dependents</h4>
                    ${spouseHtml}
                    ${dependentsHtml}
                    ${beneficiariesHtml}
                </div>
            `;
        }

        function renderDependentRow(dep, index) {
            return `
                <div class="card bg-white border p-3 mb-2" data-dep-index="${index}">
                    <div class="flex justify-between items-center mb-2">
                        <h6 class="font-semibold text-sm">Dependent ${index + 1}</h6>
                        <button type="button" onclick="removeDependent(${index})" class="text-red-600 hover:text-red-800 text-xs">
                            <i class="fa-solid fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="grid grid-cols-4 gap-2 text-sm">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">First Name</label>
                            <input type="text" class="w-full border rounded px-2 py-1 text-xs dep-first" value="${esc(dep.first || '')}" placeholder="First">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Last Name</label>
                            <input type="text" class="w-full border rounded px-2 py-1 text-xs dep-last" value="${esc(dep.last || '')}" placeholder="Last">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">DOB</label>
                            <input type="date" class="w-full border rounded px-2 py-1 text-xs dep-dob" value="${dep.dob || ''}">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Relationship</label>
                            <select class="w-full border rounded px-2 py-1 text-xs dep-rel">
                                <option value="Child" ${dep.relationship === 'Child' ? 'selected' : ''}>Child</option>
                                <option value="Stepchild" ${dep.relationship === 'Stepchild' ? 'selected' : ''}>Stepchild</option>
                                <option value="Other" ${dep.relationship === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderBeneficiaryRow(ben, index) {
            return `
                <div class="card bg-white border p-3 mb-2" data-ben-index="${index}">
                    <div class="flex justify-between items-center mb-2">
                        <h6 class="font-semibold text-sm">Beneficiary ${index + 1}</h6>
                        <button type="button" onclick="removeBeneficiary(${index})" class="text-red-600 hover:text-red-800 text-xs">
                            <i class="fa-solid fa-trash"></i> Remove
                        </button>
                    </div>
                    <div class="grid grid-cols-5 gap-2 text-sm">
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">First Name</label>
                            <input type="text" class="w-full border rounded px-2 py-1 text-xs ben-first" value="${esc(ben.first || '')}" placeholder="First">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Last Name</label>
                            <input type="text" class="w-full border rounded px-2 py-1 text-xs ben-last" value="${esc(ben.last || '')}" placeholder="Last">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">DOB</label>
                            <input type="date" class="w-full border rounded px-2 py-1 text-xs ben-dob" value="${ben.dob || ''}">
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Relationship</label>
                            <select class="w-full border rounded px-2 py-1 text-xs ben-rel">
                                <option value="Spouse" ${ben.relationship === 'Spouse' ? 'selected' : ''}>Spouse</option>
                                <option value="Child" ${ben.relationship === 'Child' ? 'selected' : ''}>Child</option>
                                <option value="Parent" ${ben.relationship === 'Parent' ? 'selected' : ''}>Parent</option>
                                <option value="Sibling" ${ben.relationship === 'Sibling' ? 'selected' : ''}>Sibling</option>
                                <option value="Other" ${ben.relationship === 'Other' ? 'selected' : ''}>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs text-slate-600 mb-1">Share %</label>
                            <input type="number" min="0" max="100" class="w-full border rounded px-2 py-1 text-xs ben-pct" value="${ben.pct || 0}" onchange="updateBeneficiaryTotal()">
                        </div>
                    </div>
                </div>
            `;
        }

        function calculateTotalShare(beneficiaries) {
            return beneficiaries.reduce((sum, ben) => sum + (parseFloat(ben.pct) || 0), 0);
        }

        window.addDependent = function() {
            const newDep = { first: '', last: '', dob: '', relationship: 'Child' };
            currentEditingEnrollment.dependents.push(newDep);
            renderFamilyTab();
        };

        window.removeDependent = function(index) {
            if (confirm('Remove this dependent?')) {
                currentEditingEnrollment.dependents.splice(index, 1);
                renderFamilyTab();
            }
        };

        window.addBeneficiary = function() {
            const newBen = { first: '', last: '', dob: '', relationship: 'Spouse', pct: 0 };
            currentEditingEnrollment.beneficiaries.push(newBen);
            renderFamilyTab();
        };

        window.removeBeneficiary = function(index) {
            if (confirm('Remove this beneficiary?')) {
                currentEditingEnrollment.beneficiaries.splice(index, 1);
                renderFamilyTab();
            }
        };

        window.updateBeneficiaryTotal = function() {
            const beneficiaries = collectBeneficiariesFromForm();
            const total = calculateTotalShare(beneficiaries);
            const totalSpan = document.getElementById('total-share');
            if (totalSpan) {
                totalSpan.textContent = total + '%';
                const parent = totalSpan.parentElement;
                const warning = parent.querySelector('span:nth-child(2)');
                if (warning) warning.remove();
                
                if (total !== 100) {
                    parent.insertAdjacentHTML('beforeend', '<span class="text-red-600 ml-2"><i class="fa-solid fa-exclamation-triangle"></i> Must equal 100%</span>');
                } else {
                    parent.insertAdjacentHTML('beforeend', '<span class="text-emerald-600 ml-2"><i class="fa-solid fa-check-circle"></i> Valid</span>');
                }
            }
        };

        // ======================== CHANGE HISTORY TAB ========================
        async function renderHistoryTab() {
            const d = currentEditingEnrollment;
            
            try {
                const { data: changes, error } = await supabase
                    .from('enrollment_changes')
                    .select('*')
                    .eq('enrollment_id', d.enrollmentId)
                    .order('changed_at', { ascending: false });

                if (error) throw error;

                const changesHtml = (changes || []).length > 0
                    ? changes.map(change => `
                        <div class="card bg-white border p-4 mb-3">
                            <div class="flex justify-between items-start mb-2">
                                <div>
                                    <p class="font-semibold text-sm text-slate-900">${esc(change.changed_by_name || 'Unknown User')}</p>
                                    <p class="text-xs text-slate-500">${formatDate(change.changed_at)}</p>
                                </div>
                                <span class="pill-badge bg-blue-50 text-blue-700 border border-blue-200 px-2 py-1">
                                    ${esc(change.change_type || 'UPDATE')}
                                </span>
                            </div>
                            <div class="mt-2 space-y-1">
                                ${renderChangeDetails(change.changes)}
                            </div>
                        </div>
                    `).join('')
                    : '<p class="text-sm text-slate-500 italic">No changes recorded yet.</p>';

                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Change History</h4>
                        <p class="text-sm text-slate-600">Complete audit trail of all modifications to this employee's enrollment record.</p>
                        ${changesHtml}
                    </div>
                `;
            } catch (err) {
                console.error('Failed to load change history:', err);
                modalContent.innerHTML = `
                    <div class="space-y-6">
                        <h4 class="text-lg font-semibold text-slate-800 border-b pb-2">Change History</h4>
                        <p class="text-sm text-red-600">Failed to load change history.</p>
                    </div>
                `;
            }
        }

        function renderChangeDetails(changes) {
            if (!changes || typeof changes !== 'object') return '<p class="text-xs text-slate-500">No details available</p>';
            
            return Object.entries(changes).map(([field, change]) => {
                const oldVal = change.old !== null && change.old !== undefined && change.old !== '' ? String(change.old) : 'Not Set';
                const newVal = change.new !== null && change.new !== undefined && change.new !== '' ? String(change.new) : 'Not Set';
                
                return `
                    <div class="text-xs">
                        <span class="font-semibold text-slate-700">${field.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())}:</span>
                        <span class="text-red-600 ${oldVal === 'Not Set' ? 'italic' : 'line-through'}">${esc(oldVal)}</span>
                        <i class="fa-solid fa-arrow-right text-slate-400 mx-1"></i>
                        <span class="text-emerald-600 font-semibold">${esc(newVal)}</span>
                    </div>
                `;
            }).join('');
        }

        // ======================== SAVE EMPLOYEE (COMPLETE FIX) ========================
        function collectDependentsFromForm() {
            const deps = [];
            document.querySelectorAll('[data-dep-index]').forEach(row => {
                deps.push({
                    first: row.querySelector('.dep-first').value.trim(),
                    last: row.querySelector('.dep-last').value.trim(),
                    dob: row.querySelector('.dep-dob').value,
                    relationship: row.querySelector('.dep-rel').value
                });
            });
            return deps;
        }

        function collectBeneficiariesFromForm() {
            const bens = [];
            document.querySelectorAll('[data-ben-index]').forEach(row => {
                bens.push({
                    first: row.querySelector('.ben-first').value.trim(),
                    last: row.querySelector('.ben-last').value.trim(),
                    dob: row.querySelector('.ben-dob').value,
                    relationship: row.querySelector('.ben-rel').value,
                    pct: parseFloat(row.querySelector('.ben-pct').value) || 0
                });
            });
            return bens;
        }

        modalSaveEmployee.addEventListener('click', async () => {
            if (!currentEditingEnrollment || !currentUser || currentUser.role !== "admin") {
                showToast({
                    title: "Unauthorized",
                    message: "Only administrators can save changes.",
                    type: "error",
                });
                return;
            }

            try {
                showToast({
                    title: "Saving...",
                    message: "Updating employee data...",
                    type: "info"
                });

                // CRITICAL: Save current tab data before final save
                saveCurrentTabData();

                // Collect data from currentEditingEnrollment (which now has all tabs' data)
                const changes = {};
                const oldData = currentEditingEnrollment.rawEnrollmentData;

                // Track changes
                if (currentEditingEnrollment.jobTitle !== (oldData.job_title || '')) {
                    changes['job_title'] = { old: oldData.job_title || null, new: currentEditingEnrollment.jobTitle };
                }
                if (currentEditingEnrollment.salary !== (oldData.annual_salary || null)) {
                    changes['annual_salary'] = { old: oldData.annual_salary || null, new: currentEditingEnrollment.salary };
                }
                if (currentEditingEnrollment.phone !== (oldData.phone || '')) {
                    changes['phone'] = { old: oldData.phone || null, new: currentEditingEnrollment.phone };
                }
                if (currentEditingEnrollment.email !== (oldData.email || '')) {
                    changes['email'] = { old: oldData.email || null, new: currentEditingEnrollment.email };
                }
                if (currentEditingEnrollment.employmentStatus !== (oldData.employment_status || 'ACTIVE')) {
                    changes['employment_status'] = { old: oldData.employment_status || 'ACTIVE', new: currentEditingEnrollment.employmentStatus };
                }
                if (currentEditingEnrollment.tier !== (oldData.tier_election || 'EO')) {
                    changes['tier_election'] = { old: oldData.tier_election || 'EO', new: currentEditingEnrollment.tier };
                }
                if (currentEditingEnrollment.medPlanCode !== (oldData.medical_plan || 'WAIVE')) {
                    changes['medical_plan'] = { old: oldData.medical_plan || 'WAIVE', new: currentEditingEnrollment.medPlanCode };
                }
                if (currentEditingEnrollment.denPlanCode !== (oldData.dental_plan || 'WAIVE')) {
                    changes['dental_plan'] = { old: oldData.dental_plan || 'WAIVE', new: currentEditingEnrollment.denPlanCode };
                }
                if (currentEditingEnrollment.visPlanCode !== (oldData.vision_plan || 'WAIVE')) {
                    changes['vision_plan'] = { old: oldData.vision_plan || 'WAIVE', new: currentEditingEnrollment.visPlanCode };
                }

                // Validate beneficiaries if life insurance is elected
                if (currentEditingEnrollment.employerLife && currentEditingEnrollment.beneficiaries.length > 0) {
                    const totalShare = calculateTotalShare(currentEditingEnrollment.beneficiaries);
                    if (totalShare !== 100) {
                        showToast({
                            title: "Validation Error",
                            message: `Beneficiary shares must total 100%. Current total: ${totalShare}%`,
                            type: "error"
                        });
                        return;
                    }
                }

                // Update employees2025 table
                if (currentEditingEnrollment.employee_id_fk) {
                    await supabase
                        .from("employees2025")
                        .update({
                            job_title: currentEditingEnrollment.jobTitle,
                            annual_salary: currentEditingEnrollment.salary,
                            primary_phone: currentEditingEnrollment.phone,
                            email: currentEditingEnrollment.email,
                            address_line_1: currentEditingEnrollment.address,
                            city: currentEditingEnrollment.city,
                            state: currentEditingEnrollment.state,
                            zip_code: currentEditingEnrollment.zip,
                            original_hire_date: currentEditingEnrollment.hireDate,
                            employment_status: currentEditingEnrollment.employmentStatus,
                            employer_life: currentEditingEnrollment.employerLife ? 'true' : 'false'
                        })
                        .eq("id", currentEditingEnrollment.employee_id_fk);
                }

                // Update benefit_enrollments table
                const updateData = {
                    job_title: currentEditingEnrollment.jobTitle,
                    annual_salary: currentEditingEnrollment.salary,
                    phone: currentEditingEnrollment.phone,
                    email: currentEditingEnrollment.email,
                    hire_date: currentEditingEnrollment.hireDate,
                    employment_status: currentEditingEnrollment.employmentStatus,
                    tier_election: currentEditingEnrollment.tier,
                    medical_plan: currentEditingEnrollment.medPlanCode === "WAIVE" ? null : currentEditingEnrollment.medPlanCode,
                    dental_plan: currentEditingEnrollment.denPlanCode === "WAIVE" ? null : currentEditingEnrollment.denPlanCode,
                    vision_plan: currentEditingEnrollment.visPlanCode === "WAIVE" ? null : currentEditingEnrollment.visPlanCode,
                    spouse: currentEditingEnrollment.spouse,
                    dependents: currentEditingEnrollment.dependents,
                    beneficiaries: currentEditingEnrollment.beneficiaries,
                    employer_life: currentEditingEnrollment.employerLife,
                    address: {
                        street: currentEditingEnrollment.address,
                        city: currentEditingEnrollment.city,
                        state: currentEditingEnrollment.state,
                        zip: currentEditingEnrollment.zip
                    }
                };

                const { error: updateError } = await supabase
                    .from("benefit_enrollments")
                    .update(updateData)
                    .eq("id", currentEditingEnrollment.enrollmentId);

                if (updateError) throw updateError;

                // Log changes if any were made
                if (Object.keys(changes).length > 0) {
                    await supabase
                        .from("enrollment_changes")
                        .insert([{
                            enrollment_id: currentEditingEnrollment.enrollmentId,
                            changed_by_user_id: currentUser.id,
                            changed_by_name: currentUser.full_name,
                            change_type: 'UPDATE',
                            changes: changes,
                            changed_at: new Date().toISOString()
                        }]);
                }

               
                await load2026EmployeeList();

                showToast({
                    title: "Saved Successfully",
                    message: "Employee data updated and changes logged.",
                    type: "success",
                });
            } catch (err) {
                console.error("Save error:", err);
                showToast({
                    title: "Save Failed",
                    message: err.message || "Failed to save changes.",
                    type: "error",
                });
            }
        });

        // Make globally accessible
        window.openEmployeeModal = openEmployeeModal;



// ======================== MOBILE & RESPONSIVE ENHANCEMENTS ========================

// Prevent zoom on input focus (iOS Safari)
document.addEventListener('touchstart', function() {}, {passive: true});

// Handle orientation change
window.addEventListener('orientationchange', function() {
    setTimeout(function() {
        window.scrollTo(0, 0);
    }, 100);
});

// Smooth scroll for all anchor links
document.querySelectorAll('a[href^="#"]').forEach(anchor => {
    anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
            target.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
    });
});

// Add resize listener to handle responsive changes
let resizeTimer;
window.addEventListener('resize', function() {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(function() {
        // Recalculate chart sizes if they exist
        if (typeof Chart !== 'undefined') {
            Chart.helpers.each(Chart.instances, function(instance) {
                instance.resize();
            });
        }
    }, 250);
});

// Touch-friendly table scrolling indicator
document.querySelectorAll('.overflow-x-auto').forEach(container => {
    if (container.scrollWidth > container.clientWidth) {
        container.classList.add('shadow-inner');
        container.title = 'Scroll horizontally to see more';
    }
});


// ======================== END OF JAVASCRIPT ========================
// ======================== MISSING MODAL LOGIC (ADD THIS) ========================

// 1. Function to switch tabs inside the modal
function switchModalTab(tabName) {
    // Update Sidebar Buttons
    document.querySelectorAll('.modal-tab-btn').forEach(btn => {
        if (btn.dataset.tab === tabName) {
            btn.classList.remove('bg-transparent', 'hover:bg-slate-100');
            btn.classList.add('bg-slate-100', 'font-semibold');
        } else {
            btn.classList.add('bg-transparent', 'hover:bg-slate-100');
            btn.classList.remove('bg-slate-100', 'font-semibold');
        }
    });

    // Render Specific Content based on the tab name
    if (tabName === 'details') renderDetailsTab();
    else if (tabName === 'elections') renderElectionsTab();
    else if (tabName === 'family') renderFamilyTab();
    else if (tabName === 'history') renderHistoryTab();
}

// 2. Event Listeners for Modal Sidebar Tabs
document.querySelectorAll('.modal-tab-btn').forEach(btn => {
    btn.addEventListener('click', () => {
        switchModalTab(btn.dataset.tab);
    });
});

// 3. Event Listener to CLOSE the modal
if (modalClose) {
    modalClose.addEventListener('click', () => {
        document.getElementById("employeeModal").classList.add('hidden');
        document.getElementById("employeeModal").classList.remove('flex');
        currentEditingEnrollment = null; // Clear data
    });
}





</script>
</body>
</html>




