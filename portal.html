<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi ‚Äî Benefit Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    .spinner{border:4px solid #e5e7eb;border-top:4px solid #b9965a;border-radius:50%;width:40px;height:40px;animation:spin .8s linear infinite}
    @keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}
    .modal-bg{background:rgba(0,0,0,.4)}
    .btn-gold{background:#B9965A;color:#fff}
    .btn-gold:hover{background:#a9874e}
  </style>
</head>

<body class="font-[Inter] bg-gray-50 text-gray-800 min-h-screen">
  <!-- Global Spinner -->
  <div id="spinnerOverlay" class="hidden fixed inset-0 z-50 flex items-center justify-center modal-bg">
    <div class="bg-white rounded-lg p-6 flex flex-col items-center shadow-lg">
      <div class="spinner mb-3"></div>
      <p class="text-gray-700 font-medium">Processing...</p>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginScreen" class="flex flex-col items-center justify-center h-screen">
    <div class="bg-white rounded-2xl shadow-lg p-8 w-full max-w-sm text-center">
      <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="mx-auto w-24 mb-4" alt="Jeng Chi Logo" />
      <h2 class="text-xl font-semibold mb-6 text-gray-800">Admin Login ‚Äî Benefit Portal</h2>
      <input id="username" type="text" placeholder="Username" class="border w-full p-2 rounded mb-3 text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
      <input id="pin" type="password" placeholder="PIN" class="border w-full p-2 rounded mb-4 text-sm focus:outline-none focus:ring-2 focus:ring-[#B9965A]" />
      <button id="loginBtn" class="w-full btn-gold font-semibold py-2 rounded-lg">Sign In</button>
      <p id="loginError" class="text-red-600 text-sm mt-3 hidden">Invalid credentials. Please try again.</p>
    </div>
  </div>

  <!-- DASHBOARD -->
  <div id="dashboard" class="hidden max-w-7xl mx-auto px-6 py-8">
    <header class="flex justify-between items-center border-b border-gray-200 pb-4 mb-8">
      <div class="flex items-center gap-4">
        <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" class="w-14" alt="Jeng Chi Logo" />
        <div>
          <h1 class="text-2xl font-bold text-[#B9965A]">Jeng Chi Restaurant</h1>
          <p class="text-sm text-gray-600">Benefit Portal ‚Äî Admin Access</p>
        </div>
      </div>
      <div class="flex items-center gap-2 relative">
        <div class="relative">
          <button id="printMenuBtn" class="p-2 rounded-lg hover:bg-gray-200" title="Print">üñ®Ô∏è</button>
          <div id="printMenu" class="hidden absolute right-0 mt-2 bg-white border border-gray-200 rounded-lg shadow-lg z-40 w-52">
            <button id="printAll" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Print All Documents</button>
            <button id="printByEmployee" class="block w-full text-left px-4 py-2 text-sm hover:bg-gray-100">Print by User</button>
          </div>
        </div>
        <button id="logoutBtn" class="btn-gold px-5 py-2 rounded-lg">Logout</button>
      </div>
    </header>

    <!-- NAV -->
    <nav class="flex gap-3 mb-6">
      <button id="tabDocs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium">Documents</button>
      <button id="tabLogs" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 font-medium">Log History</button>
      <button id="tabUsers" class="px-4 py-2 rounded-lg bg-gray-900 text-white font-medium">Authorized Users</button>
    </nav>

    <!-- DOCUMENTS -->
    <section id="docsSection" class="bg-white rounded-xl shadow-sm p-6 hidden">
      <h2 class="text-lg font-semibold text-gray-800 mb-4">Signed Documents</h2>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-gray-600 font-medium">
            <th class="text-left py-2">Username</th>
            <th class="text-left">Full Name</th>
            <th class="text-left">PDF</th>
            <th class="text-left">Signed At (CST)</th>
            <th class="text-left">Status</th>
          </tr>
        </thead>
        <tbody id="docBody">
          <tr><td colspan="5" class="text-center py-4 text-gray-400">Loading documents...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- LOG HISTORY -->
    <section id="logsSection" class="bg-white rounded-xl shadow-sm p-6 hidden">
      <h2 class="text-lg font-semibold mb-4 text-gray-800">Log History</h2>
      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-gray-600 font-medium">
            <th class="text-left py-2">Username</th>
            <th class="text-left">Login</th>
            <th class="text-left">Logout</th>
            <th class="text-left">Duration (min)</th>
          </tr>
        </thead>
        <tbody id="logBody">
          <tr><td colspan="4" class="text-center py-4 text-gray-400">Loading logs...</td></tr>
        </tbody>
      </table>
    </section>

    <!-- USERS -->
    <section id="usersSection" class="bg-white rounded-xl shadow-sm p-6">
      <div class="flex justify-between items-center mb-4">
        <h2 class="text-lg font-semibold text-gray-800">Authorized Users</h2>
        <button id="addUser" class="btn-gold text-white px-4 py-2 rounded-lg">+ Add User</button>
      </div>

      <table class="w-full text-sm">
        <thead>
          <tr class="border-b text-gray-600 font-medium">
            <th class="text-left py-2">Full Name</th>
            <th class="text-left">Username</th>
            <th class="text-left">PIN</th>
            <th class="text-left">Active</th>
            <th class="text-left">Created</th>
            <th class="text-left">Actions</th>
          </tr>
        </thead>
        <tbody id="userBody">
          <tr><td colspan="6" class="text-center py-4 text-gray-400">Loading users...</td></tr>
        </tbody>
      </table>
    </section>
  </div>

  <!-- USER MODAL -->
  <div id="userModal" class="hidden fixed inset-0 flex items-center justify-center modal-bg z-50">
    <div class="bg-white rounded-xl shadow-lg w-full max-w-md p-6 relative">
      <h3 id="modalTitle" class="text-lg font-semibold text-gray-800 mb-4"></h3>
      <div class="space-y-3">
        <input id="modalFullName" type="text" placeholder="Full Name" class="border w-full p-2 rounded text-sm" />
        <input id="modalUsername" type="text" placeholder="Username" class="border w-full p-2 rounded text-sm" />
        <input id="modalPin" type="text" placeholder="PIN" class="border w-full p-2 rounded text-sm" />
        <label class="flex items-center gap-2 text-sm"><input id="modalActive" type="checkbox" /> Active</label>
      </div>
      <div class="flex justify-end gap-3 mt-6">
        <button id="modalCancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancel</button>
        <button id="modalSave" class="px-4 py-2 rounded-lg btn-gold">Save</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ====== CONFIG ======
    const API = "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/benefit-portal";
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    // Realtime table name (CRUD still goes through the Edge Function)
    const AUTH_TABLE = "employeesbenefit";

    const authHeaders = (extra = {}) => ({
      Authorization: `Bearer ${SUPABASE_ANON_KEY}`,
      "X-Portal-Token": localStorage.getItem("auth_token") || "",
      "Content-Type": "application/json",
      ...extra,
    });

    const supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Spinner helpers
    const spinner = document.getElementById("spinnerOverlay");
    const showSpinner = () => spinner.classList.remove("hidden");
    const hideSpinner = () => spinner.classList.add("hidden");

    const esc = (t) => String(t ?? "").replace(/[&<>"']/g, s => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));

    // ====== TAB CONTROL ======
    const tabDocs = document.getElementById("tabDocs");
    const tabLogs = document.getElementById("tabLogs");
    const tabUsers = document.getElementById("tabUsers");
    const docsSection = document.getElementById("docsSection");
    const logsSection = document.getElementById("logsSection");
    const usersSection = document.getElementById("usersSection");

    function switchTab(tab) {
      [tabDocs, tabLogs, tabUsers].forEach(b => b.classList.remove("bg-gray-900","text-white"));
      [docsSection, logsSection, usersSection].forEach(s => s.classList.add("hidden"));
      if (tab === "docs") { tabDocs.classList.add("bg-gray-900","text-white"); docsSection.classList.remove("hidden"); }
      else if (tab === "logs") { tabLogs.classList.add("bg-gray-900","text-white"); logsSection.classList.remove("hidden"); }
      else { tabUsers.classList.add("bg-gray-900","text-white"); usersSection.classList.remove("hidden"); }
    }
    tabDocs.onclick = () => switchTab("docs");
    tabLogs.onclick = () => switchTab("logs");
    tabUsers.onclick = () => switchTab("users");

    // ====== LOGIN / LOGOUT ======
    const loginScreen = document.getElementById("loginScreen");
    const dashboard   = document.getElementById("dashboard");
    const loginBtn    = document.getElementById("loginBtn");
    const logoutBtn   = document.getElementById("logoutBtn");
    const loginError  = document.getElementById("loginError");

    loginBtn.onclick = async () => {
      const u = document.getElementById("username").value.trim();
      const p = document.getElementById("pin").value.trim();
      loginError.classList.add("hidden");
      showSpinner();
      try {
        const res = await fetch(`${API}/login`, { method: "POST", headers: authHeaders(), body: JSON.stringify({ username: u, pin: p }) });
        const data = await res.json().catch(() => ({}));
        hideSpinner();
        if (res.ok && data.token) {
          localStorage.setItem("auth_token", data.token);
          localStorage.setItem("auth_user", JSON.stringify(data.user || {}));
          showDashboard();
        } else {
          loginError.textContent = esc(data.error || "Invalid credentials. Please try again.");
          loginError.classList.remove("hidden");
        }
      } catch {
        hideSpinner();
        loginError.textContent = "Network error. Try again.";
        loginError.classList.remove("hidden");
      }
    };

    logoutBtn.onclick = async () => {
      const user = JSON.parse(localStorage.getItem("auth_user") || "{}");
      try {
        await fetch(`${API}/logout`, { method: "POST", headers: authHeaders(), body: JSON.stringify({ employee_id: user.id }) });
      } catch {}
      localStorage.removeItem("auth_token");
      localStorage.removeItem("auth_user");
      loginScreen.classList.remove("hidden");
      dashboard.classList.add("hidden");
    };

    function showDashboard() {
      loginScreen.classList.add("hidden");
      dashboard.classList.remove("hidden");
      switchTab("users");
      loadDocs(); loadLogs(); loadUsers();
      startRealtime();
    }
    if (localStorage.getItem("auth_token")) showDashboard();

    // ====== PRINT MENU ======
    const printMenuBtn = document.getElementById("printMenuBtn");
    const printMenu    = document.getElementById("printMenu");
    printMenuBtn.onclick = () => printMenu.classList.toggle("hidden");
    document.addEventListener("click", (e) => {
      if (!printMenu.contains(e.target) && e.target !== printMenuBtn) printMenu.classList.add("hidden");
    });
    document.getElementById("printAll").onclick = async () => {
      showSpinner();
      const res = await fetch(`${API}/docsList`, { headers: authHeaders() });
      const data = await res.json().catch(() => ({}));
      hideSpinner();
      if (!data.docs?.length) return alert("No signed documents found.");
      data.docs.forEach(d => window.open(d.pdf_url, "_blank"));
    };
    document.getElementById("printByEmployee").onclick = async () => {
      showSpinner();
      const res = await fetch(`${API}/docsList`, { headers: authHeaders() });
      const data = await res.json().catch(() => ({}));
      hideSpinner();
      if (!data.docs?.length) return alert("No signed documents found.");
      const choices = [...new Set(data.docs.map(d => `${d.full_name} (${d.username})`))];
      const sel = prompt(`Enter user to print:\n\n${choices.join("\n")}`);
      if (!sel) return;
      data.docs.filter(d => `${d.full_name} (${d.username})` === sel).forEach(d => window.open(d.pdf_url, "_blank"));
    };

    // ====== LOADERS ======
    async function loadDocs() {
      const res = await fetch(`${API}/docsList`, { headers: authHeaders() });
      const data = await res.json().catch(() => ({}));
      const body = document.getElementById("docBody");
      body.innerHTML = "";
      if (!data.docs?.length) {
        body.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-400">No signed documents</td></tr>`;
        return;
      }
      data.docs.forEach(d => {
        body.insertAdjacentHTML("beforeend", `
          <tr class="border-b hover:bg-gray-50">
            <td>${esc(d.username)}</td>
            <td>${esc(d.full_name)}</td>
            <td><a href="${esc(d.pdf_url)}" target="_blank" class="text-blue-600 underline">View</a></td>
            <td>${esc(d.signed_at)}</td>
            <td>${esc(d.status)}</td>
          </tr>
        `);
      });
    }

    async function loadLogs() {
      const res = await fetch(`${API}/logs`, { headers: authHeaders() });
      const data = await res.json().catch(() => ({}));
      const body = document.getElementById("logBody");
      body.innerHTML = "";
      if (!data.logs?.length) {
        body.innerHTML = `<tr><td colspan="4" class="py-4 text-center text-gray-400">No logs available</td></tr>`;
        return;
      }
      data.logs.forEach(l => {
        body.insertAdjacentHTML("beforeend", `
          <tr class="border-b hover:bg-gray-50">
            <td>${esc(l.username)}</td>
            <td>${esc(l.login_time)}</td>
            <td>${esc(l.logout_time)}</td>
            <td>${l.duration_minutes ?? "‚Äî"}</td>
          </tr>
        `);
      });
    }

    // ====== USERS (CRUD) ======
    let usersCache = [];
    const userBody = document.getElementById("userBody");

// This function loads authorized users from the 'employeesbenefit' table
    async function loadUsers() {
      // Fetch users, handling network errors gracefully
      const res = await fetch(`${API}/users`, { headers: authHeaders() }).catch(e => {
          console.error("User fetch network error:", e);
          return { ok: false, json: async () => ({}) }; // Return a mock response object on network failure
      });
      
      // Parse JSON, handling parsing errors gracefully
      const data = await res.json().catch(e => {
          console.error("User fetch JSON error:", e);
          return {}; // Return an empty object on JSON failure
      });

      // Safely ensure 'users' is an array, defaulting to empty array if missing or null
      const users = Array.isArray(data.users) ? data.users : [];
      
      const tbody = document.getElementById("userBody");
      tbody.innerHTML = ""; // Clear previous data
      
      if (!users.length) { // Now safely checks length
          // If no users, display a message
          tbody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-400 py-4">No authorized users found</td></tr>`;
          usersCache = []; // Also ensure cache is clear
          return;
      }

      // Dynamically add new users to the list
      users.forEach(u => {
        const row = document.createElement("tr");
        row.dataset.id = String(u.id);
        row.className = "border-b hover:bg-gray-50";
        row.innerHTML = `
          <td>${esc(u.full_name || "‚Äî")}</td>
          <td>${esc(u.username)}</td>
          <td>${esc(u.pin)}</td>
          <td>${u.active ? "Yes" : "No"}</td>
          <td>${u.created_at ? new Date(u.created_at).toLocaleDateString() : "‚Äî"}</td>
          <td class="space-x-3">
            <button class="text-blue-600 hover:underline js-edit">Edit</button>
            <button class="text-red-600 hover:underline js-del">Delete</button>
          </td>
        `;
        tbody.appendChild(row);
      });
      
      // Update cache after successful loading
      usersCache = users;
    }


    userBody.addEventListener("click", async (e) => {
      const row = e.target.closest("tr[data-id]");
      if (!row) return;
      const id = row.dataset.id;
      const user = usersCache.find(u => String(u.id) === id);
      if (!user) return;

      if (e.target.classList.contains("js-edit")) {
        openModal(user);
        return;
      }

      if (e.target.classList.contains("js-del")) {
        if (!confirm("Delete this authorized user?")) return;
        showSpinner();
        try {
          const res = await fetch(`${API}/users/${encodeURIComponent(id)}`, { method: "DELETE", headers: authHeaders() });
          if (!res.ok) {
            const t = await res.text(); alert("Delete failed: " + t);
          }
          // refresh after delete
          await loadUsers();
        } catch (err) {
          alert("Delete error: " + (err?.message || err));
        } finally {
          hideSpinner();
        }
      }
    });

    // Modal
    const modal = document.getElementById("userModal");
    const modalTitle = document.getElementById("modalTitle");
    const modalFullName = document.getElementById("modalFullName");
    const modalUsername = document.getElementById("modalUsername");
    const modalPin = document.getElementById("modalPin");
    const modalActive = document.getElementById("modalActive");
    const modalCancel = document.getElementById("modalCancel");
    const modalSave = document.getElementById("modalSave");
    let editingId = null;

    document.getElementById("addUser").onclick = () => openModal(null);

    function openModal(user) {
      editingId = user ? String(user.id) : null;
      modalTitle.textContent = editingId ? "Edit Authorized User" : "Add Authorized User";
      modalFullName.value = user?.full_name || "";
      modalUsername.value = user?.username || "";
      modalPin.value = user?.pin || "";
      modalActive.checked = user ? !!user.active : true;
      modal.classList.remove("hidden");
      modalFullName.focus();
    }

    modalCancel.onclick = () => modal.classList.add("hidden");
    
    modalSave.onclick = async () => {
      const payload = {
        full_name: modalFullName.value.trim(),
        username: modalUsername.value.trim(),
        pin: modalPin.value.trim(),
        active: modalActive.checked,
      };

      if (!payload.username || !payload.pin || !payload.full_name) return;

      showSpinner();
      try {
        if (editingId) {
          // If editing, update the user
          const res = await fetch(`${API}/users/${encodeURIComponent(editingId)}`, { method: "PUT", headers: authHeaders(), body: JSON.stringify(payload) });
          if (!res.ok) {
            const t = await res.text(); alert("Update failed: " + t);
          }
        } else {
          // If new user, create the user
const res = await fetch(`${API}/users`, {
  method: "POST",
  headers: authHeaders(),
  body: JSON.stringify(payload),
});
          if (!res.ok) {
            const t = await res.text(); alert("Create failed: " + t);
          }
        }

        // After creating or updating, refresh the user list
        await loadUsers();  // Re-load users after modification
      } catch {
        alert("Network error");
      } finally {
        hideSpinner();
        modal.classList.add("hidden");
      }
    };
async function addUser() {
  const payload = {
    full_name: modalFullName.value.trim(),
    username: modalUsername.value.trim(),
    pin: modalPin.value.trim(),
    active: modalActive.checked,
  };

  if (!payload.username || !payload.pin || !payload.full_name) return;

  showSpinner();  // Show loading spinner

  try {
    const res = await fetch(`${API}/users`, {
      method: "POST",  // Sending a POST request to add the new user
      headers: authHeaders(),
      body: JSON.stringify(payload),  // Send user data
    });

    if (!res.ok) {
      const text = await res.text();
      alert("User creation failed: " + text);
      return;
    }

    // Reload users after adding new one
    await loadUsers();  // Refresh the list to show the newly added user

  } catch (err) {
    alert("Network error");
  } finally {
    hideSpinner();  // Hide the loading spinner
    modal.classList.add("hidden");  // Close the modal
  }
}


    // ====== REALTIME (optional) ======
function startRealtime() {
  try {
    supa
      .channel("authorized-users-live")
      .on("postgres_changes", { event: "*", schema: "public", table: "employeesbenefit" }, () => {
        loadUsers();  // Reload the user list when changes are detected in employeesbenefit
      })
      .subscribe();
  } catch (error) {
    console.error("Real-time update error:", error);
  }
}




  </script>
</body>
</html>
