<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <title>Jeng Chi — Executive Benefits Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet" />

  <style>
    :root {
      --jc-red: #8a1619;
      --jc-red-soft: #c53030;
      --jc-navy: #003366;
      --jc-navy-soft: #0b3c73;
      --jc-gray-bg: #f4f5f7;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      color: #111827;
    }

    .card {
      background: #ffffff;
      border-radius: 0.75rem;
      border: 1px solid #e5e7eb;
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.08);
    }

    .input-border {
      border: 1px solid #111827;
    }

    .toast {
      position: fixed;
      inset-inline: 0;
      top: 1rem;
      margin-inline: auto;
      max-width: 22rem;
      z-index: 50;
    }

    .pill-badge {
      border-radius: 9999px;
      font-size: 0.7rem;
      letter-spacing: 0.12em;
      text-transform: uppercase;
    }

    .tab-btn-active {
      border-bottom: 2px solid var(--jc-red);
      color: #111827;
      font-weight: 600;
    }

    .tab-btn-inactive {
      border-bottom: 2px solid transparent;
      color: #6b7280;
    }

    .cost-bar-track {
      height: 0.5rem;
      border-radius: 9999px;
      background: #e5e7eb;
      overflow: hidden;
    }

    .cost-bar-med {
      background: var(--jc-red);
    }

    .cost-bar-den {
      background: #1d4ed8;
    }

    .cost-bar-vis {
      background: #4b5563;
    }

    .login-bg {
      background: radial-gradient(circle at top left, #ffffff 0, #f5f6f8 45%, #e5edf6 100%);
    }
  </style>
</head>
<body class="min-h-screen bg-slate-50">

<!-- Toast -->
<div id="toast" class="toast hidden">
  <div id="toastInner" class="card px-4 py-3 flex items-start gap-3">
    <div id="toastIcon" class="mt-1">
      <i class="fa-solid fa-circle-check text-emerald-600"></i>
    </div>
    <div class="flex-1">
      <p id="toastTitle" class="font-semibold text-sm">Title</p>
      <p id="toastMessage" class="text-xs text-slate-600 mt-0.5">Message</p>
    </div>
    <button class="text-slate-400 hover:text-slate-600 text-xs" onclick="hideToast()">
      <i class="fa-solid fa-xmark"></i>
    </button>
  </div>
</div>

<!-- LOGIN VIEW -->
<main id="loginView" class="login-bg min-h-screen flex items-center justify-center px-4 py-10">
  <div class="w-full max-w-5xl grid lg:grid-cols-2 gap-10 items-center">

    <!-- Left hero -->
    <section class="space-y-8">
      <div class="space-y-6">
        <div class="flex flex-col items-center text-center gap-4">
          <img
            src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
            alt="Jeng Chi Logo"
            class="h-20 w-auto"
          />
          <div>
            <h1 class="text-3xl md:text-4xl font-extrabold tracking-tight text-[color:var(--jc-navy)]">
              Executive Benefits Portal
            </h1>
            <p class="mt-2 text-sm md:text-base text-slate-600 max-w-xl mx-auto">
              Secure workspace for Jeng Chi executives and HR to review signed benefit elections,
              analytics, and access controls.
            </p>
          </div>
        </div>

        
    </section>

    <!-- Right login card -->
    <section class="card px-6 py-7 space-y-6">
      <header class="space-y-1 text-center">
        <p class="text-[0.75rem] uppercase tracking-[0.24em] text-slate-500">
          Executive sign-in
        </p>
        <h2 class="text-xl font-semibold text-slate-900">
          Enter your portal credentials
        </h2>
        <p class="text-xs text-slate-500">
          Use the initials and PIN issued to you by HR or Ownership.
        </p>
      </header>

      <div class="space-y-4">
        <div>
          <label for="loginInitials" class="block text-xs font-semibold text-slate-700 mb-1">
            Initials
          </label>
          <input
            id="loginInitials"
            type="text"
            autocomplete="off"
            class="w-full rounded-md px-3 py-2 input-border bg-white text-sm focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label for="loginPin" class="block text-xs font-semibold text-slate-700 mb-1">
            PIN
          </label>
          <div class="relative">
            <input
              id="loginPin"
              type="password"
              autocomplete="off"
              maxlength="4"
              class="w-full rounded-md px-3 py-2 input-border bg-white text-sm pr-10 focus:outline-none focus:ring-2 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
            />
            <button
              id="togglePin"
              type="button"
              class="absolute inset-y-0 right-0 px-3 flex items-center text-slate-500 hover:text-slate-700"
            >
              <i class="fa-regular fa-eye text-xs"></i>
            </button>
          </div>
        </div>
      </div>

      <button
        id="loginButton"
        type="button"
        class="w-full inline-flex justify-center items-center gap-2 rounded-md bg-[color:var(--jc-red)] text-white text-sm font-semibold py-2.5 hover:bg-[color:var(--jc-red-soft)] transition-shadow shadow-sm hover:shadow"
      >
        <i class="fa-solid fa-right-to-bracket"></i>
        <span>Sign In</span>
      </button>

      <p class="mt-2 text-[0.7rem] text-slate-500 text-center">
        This is a secure executive benefits portal. Unauthorized access is prohibited.
      </p>
    </section>
  </div>
</main>

<!-- DASHBOARD VIEW -->
<div id="dashboardView" class="hidden min-h-screen bg-slate-50">
  <!-- Top nav -->
  <header class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-3 flex items-center justify-between gap-4">
      <div class="flex items-center gap-3">
        <img
          src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
          alt="Logo"
          class="h-11 w-auto"
        />
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Jeng Chi Restaurant
          </p>
          <h1 class="text-lg sm:text-xl font-semibold text-[color:var(--jc-navy)]">
            Executive Benefits Portal
          </h1>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="hidden sm:flex flex-col items-end text-right">
          <span id="headerUserName" class="text-sm font-semibold text-slate-900"></span>
          <span id="headerUserRole" class="text-[0.7rem] text-slate-500"></span>
        </div>
        <button
          id="logoutButton"
          class="inline-flex items-center gap-2 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs font-medium text-slate-700 hover:bg-slate-50"
        >
          <i class="fa-solid fa-arrow-right-from-bracket"></i>
          <span>Logout</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Summary cards -->
  <section class="bg-slate-50 border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 grid md:grid-cols-4 gap-4">
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Total Signed Employees
        </p>
        <p id="summarySignedEmployees" class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">0</p>
        <p class="text-xs text-slate-500 mt-1">
          Employees with finalized benefit packets.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Current Plan Year
        </p>
        <p class="mt-2 text-2xl font-bold text-[color:var(--jc-navy)]">2026</p>
        <p class="text-xs text-slate-500 mt-1">
          Active comparison window for plan elections.
        </p>
      </div>
      <div class="card px-4 py-3">
        <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
          Active Benefit Cycle
        </p>
        <p id="cycleStatusLabel" class="mt-2 text-base font-semibold text-red-600">Under Review</p>
        <p id="cycleStatusDescription" class="text-xs text-slate-500 mt-1">
          Use the analytics tab for renewal discussions and budgeting.
        </p>
      </div>
      <div class="card px-4 py-3 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Cycle Status Control
          </p>
          <p class="text-xs text-slate-500 mt-1">
            Admins (Pablo, Garrett, Janelle) can update the cycle status.
          </p>
        </div>
        <div class="mt-3">
          <select
            id="cycleStatusSelect"
            class="w-full rounded-md border border-slate-300 bg-white text-xs px-2 py-1.5 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          >
            <option value="under_review">Under Review</option>
            <option value="received">Received</option>
            <option value="verified">Verified</option>
            <option value="finalized">Finalized</option>
          </select>
        </div>
      </div>
    </div>
  </section>

  <!-- Tabs -->
  <section class="bg-white border-b border-slate-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
      <nav class="flex gap-6 text-sm">
        <button id="tabDocs" class="py-3 tab-btn-active">
          Signed Documents
        </button>
        <button id="tabAnalytics" class="py-3 tab-btn-inactive">
          Benefit Summary
        </button>
        <button id="tabUsers" class="py-3 tab-btn-inactive">
          Authorized Users &amp; Portal Credentials
        </button>
      </nav>
    </div>
  </section>

  <!-- TAB CONTENT -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-8">

    <!-- Signed Documents -->
    <section id="tabDocsContent" class="space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">Signed Documents</h2>
          <p class="text-xs text-slate-500 mt-1">
            Alphabetical index of employees with completed, signed benefit packets.
          </p>
        </div>
        <div class="flex gap-2">
          <button
            id="printAllButton"
            class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
          >
            <i class="fa-solid fa-print"></i>
            <span>Print All</span>
          </button>
          <button
            id="mergeAllButton"
            class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
          >
            <i class="fa-solid fa-file-pdf"></i>
            <span>Merge &amp; Download All</span>
          </button>
        </div>
      </header>

      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search employee by last name
          </label>
          <input
            id="docSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Total signed employees: <span id="docSignedCount">0</span>
        </p>
      </div>

      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
          <tr>
            <th class="text-left px-4 py-2.5">Employee</th>
            <th class="text-left px-4 py-2.5">Initials</th>
            <th class="text-left px-4 py-2.5">Actions</th>
          </tr>
          </thead>
          <tbody id="docBody" class="divide-y divide-slate-100">
          <tr>
            <td colspan="3" class="px-4 py-4 text-center text-xs text-slate-500">
              Loading signed documents...
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- Benefit Analytics -->
    <section id="tabAnalyticsContent" class="hidden space-y-6">
      <header>
        <h2 class="text-lg font-semibold text-slate-900">Employee Benefit Analytics</h2>
        <p class="text-xs text-slate-500 mt-1 max-w-3xl">
          Overview of health, dental, and vision plan elections across 2025 and 2026.
          Use the per-employee comparison to confirm whether an employee upgraded, downgraded,
          or kept the same coverage between years.
        </p>
      </header>

      <!-- Aggregated plan grid (simple counts) -->
      <div class="grid md:grid-cols-3 gap-4">
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            2025 Health Plan
          </p>
          <p id="agg2025Health" class="mt-2 text-xs text-slate-700">Loading...</p>
          <p id="agg2025HealthTotal" class="mt-2 text-[0.7rem] text-slate-500"></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            2026 Health Plan
          </p>
          <p id="agg2026Health" class="mt-2 text-xs text-slate-700">Loading...</p>
          <p id="agg2026HealthTotal" class="mt-2 text-[0.7rem] text-slate-500"></p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
            Dental &amp; Vision 2025–2026
          </p>
          <p id="aggDentalVision" class="mt-2 text-xs text-slate-700">Loading...</p>
          <p id="aggDentalVisionTotal" class="mt-2 text-[0.7rem] text-slate-500"></p>
        </div>
      </div>

      <!-- Per-employee comparison -->
      <div class="card px-4 py-4 space-y-4">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
          <div>
            <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
              Per-Employee 2025 vs 2026 Comparison
            </p>
            <p class="text-xs text-slate-500 mt-1">
              Search by last name, then select an employee to view their health, dental, and vision elections for 2025 and 2026.
            </p>
          </div>
        </div>

        <div class="grid lg:grid-cols-[0.9fr,1.6fr] gap-6">
          <!-- left: search/list -->
          <div class="space-y-3">
            <div>
              <label class="block text-xs font-semibold text-slate-700 mb-1">
                Search employee by last name
              </label>
              <input
                id="analyticsSearch"
                type="text"
                class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
              />
            </div>
            <div class="border border-slate-200 rounded-md max-h-72 overflow-y-auto bg-slate-50">
              <ul id="analyticsEmployeeList" class="divide-y divide-slate-200 text-sm">
                <li class="px-3 py-2 text-xs text-slate-500">
                  Loading employees...
                </li>
              </ul>
            </div>
          </div>

          <!-- right: 2025 vs 2026 card -->
          <div id="employeeComparisonContainer" class="flex items-center justify-center min-h-[260px]">
            <p class="text-xs text-slate-500 text-center max-w-sm">
              Select an employee on the left to generate a detailed 2025 vs 2026 comparison, including
              bi-weekly totals, annual cost difference, and change summary (upgraded, downgraded, or same).
            </p>
          </div>
        </div>
      </div>
    </section>

    <!-- Users & Credentials -->
    <section id="tabUsersContent" class="hidden space-y-4">
      <header class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div>
          <h2 class="text-lg font-semibold text-slate-900">
            Authorized Users &amp; Portal Credentials
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Manage who can access this Executive Benefits Portal. Changes write directly to the
            <span class="font-mono">portal_users</span> table.
          </p>
        </div>
        <button
          id="addUserButton"
          class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
        >
          <i class="fa-solid fa-user-plus"></i>
          <span>Add User</span>
        </button>
      </header>

      <div class="flex flex-col md:flex-row md:items-end md:justify-between gap-3">
        <div class="w-full md:max-w-xs">
          <label class="block text-xs font-semibold text-slate-700 mb-1">
            Search by last name
          </label>
          <input
            id="userSearch"
            type="text"
            class="w-full rounded-md border border-slate-300 bg-white text-sm px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <p class="text-[0.7rem] text-slate-500">
          Role legend: <span class="font-semibold">Administrator</span> can view analytics and manage users;
          <span class="font-semibold">Standard User</span> can only view Signed Documents.
        </p>
      </div>

      <div class="card overflow-x-auto">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-50 border-b border-slate-200 text-xs text-slate-500">
          <tr>
            <th class="text-left px-4 py-2.5">Full name</th>
            <th class="text-left px-4 py-2.5">Initials</th>
            <th class="text-left px-4 py-2.5">Role</th>
            <th class="text-left px-4 py-2.5">Last login</th>
            <th class="text-left px-4 py-2.5">Status</th>
            <th class="text-left px-4 py-2.5">Actions</th>
          </tr>
          </thead>
          <tbody id="userBody" class="divide-y divide-slate-100">
          <tr>
            <td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">
              Loading users...
            </td>
          </tr>
          </tbody>
        </table>
      </div>
    </section>
  </main>
</div>

<!-- User Modal -->
<div
  id="userModal"
  class="fixed inset-0 bg-black/30 hidden items-center justify-center z-40 px-4"
>
  <div class="card w-full max-w-md px-6 py-5">
    <h3 id="userModalTitle" class="text-base font-semibold text-slate-900 mb-4">
      Add User
    </h3>
    <div class="space-y-3 text-sm">
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Full name</label>
        <input
          id="modalFullName"
          type="text"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        />
      </div>
      <div class="grid grid-cols-2 gap-3">
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">Initials</label>
          <input
            id="modalInitials"
            type="text"
            maxlength="3"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-700 mb-1">PIN (4 digits)</label>
          <input
            id="modalPin"
            type="password"
            maxlength="4"
            class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
          />
        </div>
      </div>
      <div>
        <label class="block text-xs font-semibold text-slate-700 mb-1">Role</label>
        <select
          id="modalRole"
          class="w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-[color:var(--jc-red)] focus:border-[color:var(--jc-red)]"
        >
          <option value="user">Standard User</option>
          <option value="admin">Administrator</option>
        </select>
      </div>
      <div class="flex items-center gap-2">
        <input id="modalActive" type="checkbox" class="rounded border-slate-300 text-[color:var(--jc-red)]" checked />
        <label for="modalActive" class="text-xs text-slate-700">Portal active</label>
      </div>
    </div>
    <div class="mt-5 flex justify-end gap-3">
      <button
        id="modalCancel"
        class="inline-flex items-center gap-1 rounded-md border border-slate-300 bg-white px-3 py-1.5 text-xs text-slate-700 hover:bg-slate-50"
      >
        Cancel
      </button>
      <button
        id="modalSave"
        class="inline-flex items-center gap-1 rounded-md bg-[color:var(--jc-red)] text-white px-3 py-1.5 text-xs font-medium hover:bg-[color:var(--jc-red-soft)]"
      >
        Save
      </button>
    </div>
  </div>
</div>

<script>
  // ------------------------ SUPABASE CONFIG ------------------------
  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  // ------------------------ GLOBAL STATE ------------------------
  let currentUser = null; // portal_users row
  let currentLogId = null; // portal_logs id
  let docsCache = [];
  let portalUsersCache = [];
  let analyticsEmployees = []; // { employee, byYear: {2025,2026} }
  let benefitRates = [];
  const YEARS = [2025, 2026];

  // ------------------------ TOASTS ------------------------
  function showToast({ title, message, type }) {
    const toast = document.getElementById("toast");
    const inner = document.getElementById("toastInner");
    const titleEl = document.getElementById("toastTitle");
    const msgEl = document.getElementById("toastMessage");
    const iconEl = document.getElementById("toastIcon");

    titleEl.textContent = title || "";
    msgEl.textContent = message || "";

    iconEl.innerHTML = "";
    inner.classList.remove("border-emerald-200", "border-red-200", "border-slate-200");
    if (type === "success") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-check text-emerald-600"></i>';
      inner.classList.add("border", "border-emerald-200");
    } else if (type === "error") {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-exclamation text-red-600"></i>';
      inner.classList.add("border", "border-red-200");
    } else {
      iconEl.innerHTML = '<i class="fa-solid fa-circle-info text-slate-500"></i>';
      inner.classList.add("border", "border-slate-200");
    }

    toast.classList.remove("hidden");
    // auto-hide
    clearTimeout(window.__toastTimer);
    window.__toastTimer = setTimeout(() => {
      hideToast();
    }, 3500);
  }

  function hideToast() {
    document.getElementById("toast").classList.add("hidden");
  }

  // ------------------------ HELPERS ------------------------
  function esc(str) {
    return String(str ?? "").replace(/[&<>"']/g, (s) => ({
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    })[s]);
  }

  const formatCurrency = (value) =>
    new Intl.NumberFormat("en-US", {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
    }).format(value || 0);

  const formatDate = (value) =>
    value ? new Date(value).toLocaleString("en-US", { dateStyle: "short", timeStyle: "short" }) : "—";

  // ------------------------ LOGIN VIEW ------------------------
  const loginView = document.getElementById("loginView");
  const dashboardView = document.getElementById("dashboardView");
  const loginBtn = document.getElementById("loginButton");
  const loginInitials = document.getElementById("loginInitials");
  const loginPin = document.getElementById("loginPin");
  const togglePinBtn = document.getElementById("togglePin");

  togglePinBtn.addEventListener("click", () => {
    const type = loginPin.type === "password" ? "text" : "password";
    loginPin.type = type;
    togglePinBtn.innerHTML =
      type === "password"
        ? '<i class="fa-regular fa-eye text-xs"></i>'
        : '<i class="fa-regular fa-eye-slash text-xs"></i>';
  });

  loginInitials.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginPin.addEventListener("keydown", (e) => {
    if (e.key === "Enter") login();
  });
  loginBtn.addEventListener("click", login);

  async function login() {
    const initials = loginInitials.value.trim().toUpperCase();
    const pin = loginPin.value.trim();

    if (!initials || !pin) {
      showToast({
        title: "Invalid credentials",
        message: "Initials and PIN are required.",
        type: "error",
      });
      return;
    }
    if (pin.length !== 4 || !/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }

    try {
      const { data: user, error } = await supabase
        .from("portal_users")
        .select("*")
        .eq("initials", initials)
        .eq("pin", pin)
        .eq("active", true)
        .maybeSingle();

      if (error) {
        console.error("Login query error", error);
        showToast({
          title: "Login error",
          message: "Unable to verify credentials. Please try again.",
          type: "error",
        });
        return;
      }

      if (!user) {
        showToast({
          title: "Invalid credentials",
          message: "Check your initials and PIN.",
          type: "error",
        });
        return;
      }

      currentUser = user;

      // Update last_login
      await supabase.from("portal_users").update({ last_login: new Date().toISOString() }).eq("id", user.id);

      // Try to map to employees2025 via username/initials
      let employee = null;
      const { data: empByUsername } = await supabase
        .from("employees2025")
        .select("id, username")
        .eq("username", user.initials)
        .maybeSingle();

      if (empByUsername) employee = empByUsername;

      if (!employee && user.username) {
        const { data: empByLegacy } = await supabase
          .from("employees2025")
          .select("id, username")
          .eq("username", user.username)
          .maybeSingle();
        if (empByLegacy) employee = empByLegacy;
      }

      if (employee) {
        const { data: logRow, error: logError } = await supabase
          .from("portal_logs")
          .insert([{ employee_id: employee.id }])
          .select("id")
          .single();
        if (!logError && logRow) {
          currentLogId = logRow.id;
        }
      }

      sessionStorage.setItem(
        "portal_user",
        JSON.stringify({ ...currentUser, log_id: currentLogId || null })
      );

      showToast({
        title: "Login successful",
        message: "Redirecting to the Executive Benefits Portal.",
        type: "success",
      });

      setTimeout(() => {
        showDashboard();
      }, 700);
    } catch (err) {
      console.error("Login error", err);
      showToast({
        title: "Login error",
        message: "Unexpected error. See console for details.",
        type: "error",
      });
    }
  }

  // ------------------------ DASHBOARD SETUP ------------------------
  const logoutButton = document.getElementById("logoutButton");
  logoutButton.addEventListener("click", handleLogout);

  async function handleLogout() {
    if (currentLogId) {
      try {
        // Fetch login_time to calculate duration
        const { data: logRow } = await supabase
          .from("portal_logs")
          .select("login_time")
          .eq("id", currentLogId)
          .maybeSingle();
        let duration = null;
        if (logRow && logRow.login_time) {
          const loginTime = new Date(logRow.login_time);
          const now = new Date();
          duration = Math.round((now - loginTime) / (1000 * 60));
        }
        await supabase
          .from("portal_logs")
          .update({
            logout_time: new Date().toISOString(),
            duration_minutes: duration,
          })
          .eq("id", currentLogId);
      } catch (err) {
        console.error("Error recording logout", err);
      }
    }
    currentUser = null;
    currentLogId = null;
    sessionStorage.removeItem("portal_user");
    dashboardView.classList.add("hidden");
    loginView.classList.remove("hidden");
  }

  function showDashboard() {
    loginView.classList.add("hidden");
    dashboardView.classList.remove("hidden");
    updateHeaderUser();
    updateCycleStatusUI();
    applyRoleVisibility();
    loadSignedDocuments();
    loadAnalytics();
    loadPortalUsers();
  }

  function updateHeaderUser() {
    const nameEl = document.getElementById("headerUserName");
    const roleEl = document.getElementById("headerUserRole");
    if (!currentUser) {
      nameEl.textContent = "";
      roleEl.textContent = "";
      return;
    }
    nameEl.textContent = currentUser.full_name || currentUser.initials;
    const roleLabel = currentUser.role === "admin" ? "Administrator" : "Standard User";
    roleEl.textContent = `Logged in as ${roleLabel} (${currentUser.initials})`;
  }

  // ------------------------ CYCLE STATUS ------------------------
  const cycleStatusSelect = document.getElementById("cycleStatusSelect");
  const cycleStatusLabel = document.getElementById("cycleStatusLabel");
  const cycleStatusDescription = document.getElementById("cycleStatusDescription");

  function getCycleStatusMeta(value) {
    switch (value) {
      case "under_review":
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
      case "received":
        return {
          label: "Received",
          color: "text-amber-600",
          description: "All enrollment packets have been collected and are being checked.",
        };
      case "verified":
        return {
          label: "Verified",
          color: "text-emerald-600",
          description:
            "Enrollment data, premiums, and plan mappings have been validated with the broker.",
        };
      case "finalized":
        return {
          label: "Finalized",
          color: "text-slate-700",
          description:
            "The benefit cycle is complete. Elections have been transmitted and confirmed.",
        };
      default:
        return {
          label: "Under Review",
          color: "text-red-600",
          description: "Use the analytics tab for renewal discussions and budgeting.",
        };
    }
  }

  function updateCycleStatusUI() {
    const stored = localStorage.getItem("jc_cycle_status") || "under_review";
    cycleStatusSelect.value = stored;
    const meta = getCycleStatusMeta(stored);
    cycleStatusLabel.textContent = meta.label;
    cycleStatusLabel.className = "mt-2 text-base font-semibold " + meta.color;
    cycleStatusDescription.textContent = meta.description;
  }

  cycleStatusSelect.addEventListener("change", () => {
    // Only allow Pablo, Garrett, Janelle (PG, GM, JT) or admins
    if (
      !currentUser ||
      !["PG", "GM", "JT"].includes(currentUser.initials) && currentUser.role !== "admin"
    ) {
      showToast({
        title: "Not allowed",
        message: "Only designated admins can change the cycle status.",
        type: "error",
      });
      cycleStatusSelect.value = localStorage.getItem("jc_cycle_status") || "under_review";
      return;
    }
    const value = cycleStatusSelect.value;
    localStorage.setItem("jc_cycle_status", value);
    updateCycleStatusUI();
  });

  // ------------------------ ROLE-BASED VISIBILITY ------------------------
  function applyRoleVisibility() {
    const tabAnalytics = document.getElementById("tabAnalytics");
    const tabUsers = document.getElementById("tabUsers");
    const isAdmin = currentUser && currentUser.role === "admin";
    if (!isAdmin) {
      tabAnalytics.classList.add("hidden");
      tabUsers.classList.add("hidden");
      activateTab("docs");
    } else {
      tabAnalytics.classList.remove("hidden");
      tabUsers.classList.remove("hidden");
    }
  }

  // ------------------------ TABS ------------------------
  const tabDocs = document.getElementById("tabDocs");
  const tabAnalytics = document.getElementById("tabAnalytics");
  const tabUsers = document.getElementById("tabUsers");

  const tabDocsContent = document.getElementById("tabDocsContent");
  const tabAnalyticsContent = document.getElementById("tabAnalyticsContent");
  const tabUsersContent = document.getElementById("tabUsersContent");

  function activateTab(key) {
    const tabs = {
      docs: { btn: tabDocs, content: tabDocsContent },
      analytics: { btn: tabAnalytics, content: tabAnalyticsContent },
      users: { btn: tabUsers, content: tabUsersContent },
    };
    Object.entries(tabs).forEach(([k, v]) => {
      if (k === key) {
        v.btn.classList.remove("tab-btn-inactive");
        v.btn.classList.add("tab-btn-active");
        v.content.classList.remove("hidden");
      } else {
        v.btn.classList.remove("tab-btn-active");
        v.btn.classList.add("tab-btn-inactive");
        v.content.classList.add("hidden");
      }
    });
  }

  tabDocs.addEventListener("click", () => activateTab("docs"));
  tabAnalytics.addEventListener("click", () => activateTab("analytics"));
  tabUsers.addEventListener("click", () => activateTab("users"));

  // ------------------------ SIGNED DOCUMENTS ------------------------
  async function loadSignedDocuments() {
    const tbody = document.getElementById("docBody");
    tbody.innerHTML =
      '<tr><td colspan="3" class="px-4 py-4 text-center text-xs text-slate-500">Loading signed documents...</td></tr>';
    try {
      const { data, error } = await supabase
        .from("employees2025")
        .select("id, first_name, last_name, username, signed_pdf_url")
        .not("signed_pdf_url", "is", null);

      if (error) throw error;
      docsCache = (data || []).sort((a, b) =>
        a.last_name.localeCompare(b.last_name)
      );

      renderDocsTable();
      document.getElementById("summarySignedEmployees").textContent =
        docsCache.length;
    } catch (err) {
      console.error("Error loading signed docs", err);
      tbody.innerHTML =
        '<tr><td colspan="3" class="px-4 py-4 text-center text-xs text-red-500">Error loading documents.</td></tr>';
    }
  }

  function renderDocsTable() {
    const tbody = document.getElementById("docBody");
    const search = document.getElementById("docSearch").value.trim().toLowerCase();
    let rows = docsCache;
    if (search) {
      rows = rows.filter((r) => r.last_name.toLowerCase().includes(search));
    }

    document.getElementById("docSignedCount").textContent = docsCache.length;

    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="3" class="px-4 py-4 text-center text-xs text-slate-500">No employees match your search.</td></tr>';
      return;
    }

    tbody.innerHTML = "";
    rows.forEach((row) => {
      const fullName = `${row.last_name}, ${row.first_name}`;
      const pdfActions = row.signed_pdf_url
        ? `
          <button
            class="inline-flex items-center gap-1 text-xs text-[color:var(--jc-red)] hover:underline mr-3"
            onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
          >
            <i class="fa-solid fa-file-pdf"></i><span>View PDF</span>
          </button>
          <button
            class="inline-flex items-center gap-1 text-xs text-slate-600 hover:text-slate-900"
            onclick="window.open('${esc(row.signed_pdf_url)}','_blank')"
          >
            <i class="fa-solid fa-print"></i><span>Print</span>
          </button>`
        : `<span class="text-xs text-slate-400">N/A</span>`;

      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50">
          <td class="px-4 py-2.5 text-sm">${esc(fullName)}</td>
          <td class="px-4 py-2.5 text-sm">${esc(row.username || "")}</td>
          <td class="px-4 py-2.5 text-sm">${pdfActions}</td>
        </tr>`
      );
    });
  }

  document.getElementById("docSearch").addEventListener("input", renderDocsTable);

  document.getElementById("printAllButton").addEventListener("click", () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to print.",
        type: "error",
      });
      return;
    }
    docsCache.forEach((d) => {
      if (d.signed_pdf_url) window.open(d.signed_pdf_url, "_blank");
    });
    showToast({
      title: "Print initiated",
      message: "Opened all PDFs in new tabs. Use browser print to continue.",
      type: "success",
    });
  });

  document.getElementById("mergeAllButton").addEventListener("click", async () => {
    if (!docsCache.length) {
      showToast({
        title: "No documents",
        message: "There are no signed PDFs to merge.",
        type: "error",
      });
      return;
    }
    try {
      const employeeIds = docsCache.map((d) => d.id);
      const res = await fetch(`${SUPABASE_URL}/functions/v1/merge-signed-pdfs`, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
        },
        body: JSON.stringify({ employee_ids: employeeIds }),
      });
      if (!res.ok) {
        console.error("merge error", await res.text());
        showToast({
          title: "Merge failed",
          message: "Edge function returned an error.",
          type: "error",
        });
        return;
      }
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      window.open(url, "_blank");
      showToast({
        title: "Merge ready",
        message: "Combined PDF opened in a new tab.",
        type: "success",
      });
    } catch (err) {
      console.error("merge error", err);
      showToast({
        title: "Merge failed",
        message: "Unexpected error. See console for details.",
        type: "error",
      });
    }
  });

  // ------------------------ ANALYTICS ------------------------
  async function ensureBenefitRatesLoaded() {
    if (benefitRates.length) return;
    const { data, error } = await supabase
      .from("benefit_rates")
      .select("plan_code, tier, coverage, amount, effective_year");
    if (!error && data) benefitRates = data;
  }

  function getRateAmount(year, coverage, tier, planCode) {
    if (!planCode || planCode === "WAIVE" || planCode === "NO") return 0;
    const row = benefitRates.find(
      (r) =>
        String(r.effective_year) === String(year) &&
        (r.coverage || "").toLowerCase() === coverage &&
        r.tier === tier &&
        r.plan_code === planCode
    );
    return row ? parseFloat(row.amount) || 0 : 0;
  }

  function summarizePlanCounts(enrollments) {
    const stats = {
      2025: { medical: {}, dental: {}, vision: {} },
      2026: { medical: {}, dental: {}, vision: {} },
    };
    enrollments.forEach((e) => {
      if (!YEARS.includes(e.benefit_year)) return;
      const yearStats = stats[e.benefit_year];
      const tier = e.tier_election;
      const normalize = (p) =>
        !p || p === "NO" || p.toUpperCase().includes("WAIVE") ? "WAIVE" : p;
      const mp = normalize(e.medical_plan);
      const dp = normalize(e.dental_plan);
      const vp = normalize(e.vision_plan);

      yearStats.medical[mp] = (yearStats.medical[mp] || 0) + 1;
      yearStats.dental[dp] = (yearStats.dental[dp] || 0) + 1;
      yearStats.vision[vp] = (yearStats.vision[vp] || 0) + 1;
    });
    return stats;
  }

  function planCountsToText(obj) {
    const entries = Object.entries(obj)
      .sort((a, b) => b[1] - a[1])
      .map(([plan, count]) => `${plan}: ${count}`);
    return { text: entries.join(" | "), total: entries.reduce((a, [, c]) => a + c, 0) };
  }

  async function loadAnalytics() {
    const listEl = document.getElementById("analyticsEmployeeList");
    listEl.innerHTML =
      '<li class="px-3 py-2 text-xs text-slate-500">Loading employees...</li>';

    try {
      const [{ data: employees }, { data: enrollments }] = await Promise.all([
        supabase
          .from("employees2025")
          .select("id, first_name, last_name, username")
          .order("last_name", { ascending: true }),
        supabase
          .from("benefit_enrollments")
          .select("username, benefit_year, tier_election, medical_plan, dental_plan, vision_plan")
          .in("benefit_year", YEARS),
      ]);

      const byUsername = new Map();
      (employees || []).forEach((emp) => {
        byUsername.set(emp.username, {
          employee: emp,
          byYear: { 2025: null, 2026: null },
        });
      });

      (enrollments || []).forEach((enr) => {
        const rec = byUsername.get(enr.username);
        if (!rec) return;
        rec.byYear[enr.benefit_year] = enr;
      });

      analyticsEmployees = Array.from(byUsername.values()).filter(
        (x) => x.byYear[2025] || x.byYear[2026]
      );

      // Aggregated counters
      const stats = summarizePlanCounts(enrollments || []);
      const h2025 = planCountsToText(stats[2025].medical);
      const h2026 = planCountsToText(stats[2026].medical);
      const dAll = planCountsToText({
        ...stats[2025].dental,
        ...stats[2026].dental,
      });
      const vAll = planCountsToText({
        ...stats[2025].vision,
        ...stats[2026].vision,
      });

      document.getElementById("agg2025Health").textContent = h2025.text || "No data";
      document.getElementById("agg2026Health").textContent = h2026.text || "No data";
      document.getElementById(
        "aggDentalVision"
      ).textContent = `${dAll.text || "Dental: N/A"} | ${vAll.text || "Vision: N/A"}`;
      document.getElementById(
        "agg2025HealthTotal"
      ).textContent = `Total elections: ${h2025.total}`;
      document.getElementById(
        "agg2026HealthTotal"
      ).textContent = `Total elections: ${h2026.total}`;
      document.getElementById(
        "aggDentalVisionTotal"
      ).textContent = `Total elections (Dental + Vision): ${dAll.total + vAll.total}`;

      renderAnalyticsEmployeeList();
      await ensureBenefitRatesLoaded();
    } catch (err) {
      console.error("Analytics load error", err);
      listEl.innerHTML =
        '<li class="px-3 py-2 text-xs text-red-500">Error loading analytics data.</li>';
    }
  }

  function renderAnalyticsEmployeeList() {
    const listEl = document.getElementById("analyticsEmployeeList");
    const search = document
      .getElementById("analyticsSearch")
      .value.trim()
      .toLowerCase();
    let rows = analyticsEmployees;
    if (search) {
      rows = rows.filter((r) =>
        r.employee.last_name.toLowerCase().includes(search)
      );
    }
    if (!rows.length) {
      listEl.innerHTML =
        '<li class="px-3 py-2 text-xs text-slate-500">No employees match your search.</li>';
      return;
    }
    listEl.innerHTML = "";
    rows.forEach((rec) => {
      const { employee } = rec;
      listEl.insertAdjacentHTML(
        "beforeend",
        `<li>
          <button
            type="button"
            class="w-full text-left px-3 py-2 text-xs hover:bg-white flex items-center justify-between"
            data-username="${esc(employee.username)}"
          >
            <span>${esc(employee.last_name)}, ${esc(employee.first_name)} (${esc(
          employee.username
        )})</span>
          </button>
        </li>`
      );
    });
  }

  document
    .getElementById("analyticsSearch")
    .addEventListener("input", renderAnalyticsEmployeeList);

  document
    .getElementById("analyticsEmployeeList")
    .addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-username]");
      if (!btn) return;
      const username = btn.dataset.username;
      const rec = analyticsEmployees.find(
        (r) => r.employee.username === username
      );
      if (rec) {
        renderEmployeeComparison(rec);
      }
    });

  function renderEmployeeComparison(rec) {
    const container = document.getElementById("employeeComparisonContainer");
    const { employee, byYear } = rec;

    const tier = (byYear[2025] || byYear[2026])?.tier_election || "EO";

    const plansForYear = (year) => {
      const enr = byYear[year];
      if (!enr) return null;
      return {
        year,
        tier: enr.tier_election,
        medical_plan: enr.medical_plan,
        dental_plan: enr.dental_plan,
        vision_plan: enr.vision_plan,
      };
    };

    const y2025 = plansForYear(2025);
    const y2026 = plansForYear(2026);

    if (!y2025 && !y2026) {
      container.innerHTML =
        '<p class="text-xs text-slate-500 text-center">No benefit elections found for 2025 or 2026.</p>';
      return;
    }

    const computeCosts = (year, enr) => {
      if (!enr) return { med: 0, den: 0, vis: 0, total: 0 };
      const coverageTier = enr.tier;
      const med = getRateAmount(year, "medical", coverageTier, enr.medical_plan);
      const den = getRateAmount(year, "dental", coverageTier, enr.dental_plan);
      const vis = getRateAmount(year, "vision", coverageTier, enr.vision_plan);
      return { med, den, vis, total: med + den + vis };
    };

    const c2025 = y2025 ? computeCosts(2025, { ...y2025, tier }) : { med: 0, den: 0, vis: 0, total: 0 };
    const c2026 = y2026 ? computeCosts(2026, { ...y2026, tier }) : { med: 0, den: 0, vis: 0, total: 0 };

    const annual2025 = c2025.total * 26;
    const annual2026 = c2026.total * 26;
    const annualDiff = annual2026 - annual2025;

    let diffLabel = "No change vs prior year";
    let diffColor = "text-slate-700";
    let diffIcon = '<i class="fa-solid fa-arrow-right-long text-slate-500"></i>';
    let summary = "Same coverage level / flat premium.";

    if (annualDiff > 5) {
      diffLabel = "Yearly cost increase";
      diffColor = "text-red-600";
      diffIcon = '<i class="fa-solid fa-arrow-up text-red-600"></i>';
      summary = "Upgraded / higher cost";
    } else if (annualDiff < -5) {
      diffLabel = "Yearly cost decrease";
      diffColor = "text-emerald-600";
      diffIcon = '<i class="fa-solid fa-arrow-down text-emerald-600"></i>';
      summary = "Downgraded / lower cost";
    }

    const pctBar = (value, max) => (max ? (value / max) * 100 : 0);
    const maxBiWeekly = Math.max(c2025.total, c2026.total, 1);

    const cardForYear = (yearLabel, yearData, costs) => {
      if (!yearData)
        return `<div class="border border-dashed border-slate-200 rounded-lg px-4 py-3 text-xs text-slate-500">
                 No elections on file for ${yearLabel}.
               </div>`;
      const medPct = pctBar(costs.med, maxBiWeekly);
      const denPct = pctBar(costs.den, maxBiWeekly);
      const visPct = pctBar(costs.vis, maxBiWeekly);

      const tierMap = {
        EO: "Employee Only",
        ES: "Employee + Spouse",
        EC: "Employee + Children",
        EF: "Employee + Family",
      };
      const tierLabel = tierMap[yearData.tier] || "Coverage tier";

      const planLabel = (code) => {
        if (!code || code === "WAIVE" || code === "NO") return "Waived";
        const map = {
          ATBAB303: "HMO / ATBAB303",
          ATBAP393: "HMO HSA / ATBAP393",
          ATBCB402: "PPO / ATBCB402",
          F_PLAN_2W: "F-PLAN 2W / Base MAC",
          F_PLAN_3W: "F-PLAN 3W / Buy Up MAC",
          PLAN_1: "Vision Plan 1",
        };
        return map[code] || code;
      };

      return `
        <div class="border border-slate-200 rounded-lg px-4 py-3 bg-slate-50">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500 mb-1">${yearLabel}</p>
          <p class="text-[0.7rem] text-slate-500 mb-1">Tier: <span class="font-semibold text-slate-700">${
            yearData.tier
          }</span> · <span class="text-slate-600">${tierLabel}</span></p>
          <div class="grid sm:grid-cols-3 gap-3 text-xs mt-2">
            <div>
              <p class="font-semibold text-slate-700">Medical</p>
              <p class="text-slate-600">${esc(planLabel(yearData.medical_plan))}</p>
              <p class="mt-1 text-[0.7rem] text-slate-500">Bi-weekly: ${formatCurrency(costs.med)}</p>
            </div>
            <div>
              <p class="font-semibold text-slate-700">Dental</p>
              <p class="text-slate-600">${esc(planLabel(yearData.dental_plan))}</p>
              <p class="mt-1 text-[0.7rem] text-slate-500">Bi-weekly: ${formatCurrency(costs.den)}</p>
            </div>
            <div>
              <p class="font-semibold text-slate-700">Vision</p>
              <p class="text-slate-600">${esc(planLabel(yearData.vision_plan))}</p>
              <p class="mt-1 text-[0.7rem] text-slate-500">Bi-weekly: ${formatCurrency(costs.vis)}</p>
            </div>
          </div>

          <div class="mt-3">
            <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500 mb-1">
              Total
            </p>
            <p class="text-sm font-semibold text-slate-800">
              ${formatCurrency(costs.total)} <span class="text-[0.7rem] text-slate-500">bi-weekly</span>
              <span class="text-[0.7rem] text-slate-500 ml-1">(${formatCurrency(
                costs.total * 26
              )} annual)</span>
            </p>
            <div class="mt-2 cost-bar-track">
              <div class="h-full flex">
                <div class="cost-bar-med" style="width:${medPct}%;"></div>
                <div class="cost-bar-den" style="width:${denPct}%;"></div>
                <div class="cost-bar-vis" style="width:${visPct}%;"></div>
              </div>
            </div>
            <div class="mt-1 flex gap-3 text-[0.65rem] text-slate-500">
              <span class="inline-flex items-center gap-1">
                <span class="w-2 h-2 rounded-full cost-bar-med"></span> Medical
              </span>
              <span class="inline-flex items-center gap-1">
                <span class="w-2 h-2 rounded-full cost-bar-den"></span> Dental
              </span>
              <span class="inline-flex items-center gap-1">
                <span class="w-2 h-2 rounded-full cost-bar-vis"></span> Vision
              </span>
            </div>
          </div>
        </div>
      `;
    };

    container.innerHTML = `
      <div class="w-full space-y-4">
        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
          <div>
            <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">Employee</p>
            <p class="text-sm font-semibold text-slate-900">
              ${esc(employee.last_name)}, ${esc(employee.first_name)} (${esc(
      employee.username
    )})
            </p>
          </div>
          <div class="text-right text-xs text-slate-500">
            <p>Use this comparison to confirm if the employee upgraded, downgraded, or kept the same coverage between years.</p>
          </div>
        </div>

        <div class="grid lg:grid-cols-[1.1fr,1.1fr,0.8fr] gap-4 mt-1">
          ${cardForYear("2025", y2025, c2025)}
          ${cardForYear("2026", y2026, c2026)}
          <div class="border border-slate-200 rounded-lg px-4 py-3 flex flex-col justify-between">
            <div>
              <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                Yearly cost difference
              </p>
              <p class="mt-2 text-sm font-semibold ${diffColor}">
                ${diffIcon}
                <span class="ml-1">${formatCurrency(Math.abs(annualDiff))}</span>
              </p>
              <p class="mt-1 text-[0.7rem] text-slate-500">
                ${annualDiff > 0 ? "2026 is higher than 2025." : annualDiff < 0 ? "2026 is lower than 2025." : "No difference between years."}
              </p>
            </div>
            <div class="mt-4">
              <p class="text-[0.7rem] uppercase tracking-[0.18em] text-slate-500">
                Change summary
              </p>
              <p class="mt-1 text-xs font-semibold text-slate-800">${summary}</p>
              <p class="mt-1 text-[0.7rem] text-slate-500">
                Consider this when discussing renewals, budgeting, or explaining coverage changes with the employee.
              </p>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  // ------------------------ PORTAL USERS ------------------------
  async function loadPortalUsers() {
    const tbody = document.getElementById("userBody");
    tbody.innerHTML =
      '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">Loading users...</td></tr>';

    try {
      const { data, error } = await supabase
        .from("portal_users")
        .select("id, full_name, initials, role, active, last_login")
        .order("full_name", { ascending: true });
      if (error) throw error;
      portalUsersCache = data || [];
      renderPortalUsersTable();
    } catch (err) {
      console.error("Portal users error", err);
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-red-500">Error loading users.</td></tr>';
    }
  }

  function renderPortalUsersTable() {
    const tbody = document.getElementById("userBody");
    const search = document.getElementById("userSearch").value.trim().toLowerCase();
    let rows = portalUsersCache;
    if (search) {
      rows = rows.filter((u) =>
        u.full_name.toLowerCase().includes(search)
      );
    }
    if (!rows.length) {
      tbody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-xs text-slate-500">No users match your search.</td></tr>';
      return;
    }
    tbody.innerHTML = "";
    rows.forEach((u) => {
      const roleBadge =
        u.role === "admin"
          ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-red-50 text-red-700 border border-red-100">ADMIN</span>'
          : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-700 border border-slate-200">STANDARD</span>';
      const statusBadge = u.active
        ? '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-emerald-50 text-emerald-700 border border-emerald-100">ACTIVE</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 pill-badge bg-slate-100 text-slate-500 border border-slate-200">INACTIVE</span>';

      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr class="hover:bg-slate-50 text-sm" data-id="${u.id}">
          <td class="px-4 py-2.5">${esc(u.full_name)}</td>
          <td class="px-4 py-2.5">${esc(u.initials)}</td>
          <td class="px-4 py-2.5">${roleBadge}</td>
          <td class="px-4 py-2.5 text-xs text-slate-500">${formatDate(u.last_login)}</td>
          <td class="px-4 py-2.5">${statusBadge}</td>
          <td class="px-4 py-2.5 text-xs">
            <button class="text-[color:var(--jc-red)] hover:underline mr-3" data-action="edit">Edit</button>
            <button class="text-slate-500 hover:text-red-600" data-action="delete">Delete</button>
          </td>
        </tr>`
      );
    });
  }

  document
    .getElementById("userSearch")
    .addEventListener("input", renderPortalUsersTable);

  document.getElementById("userBody").addEventListener("click", async (e) => {
    const row = e.target.closest("tr[data-id]");
    if (!row) return;
    const id = Number(row.dataset.id);
    const user = portalUsersCache.find((u) => u.id === id);
    if (!user) return;

    const action = e.target.dataset.action;
    if (action === "edit") {
      openUserModal(user);
    } else if (action === "delete") {
      if (user.initials === "PG") {
        showToast({
          title: "Protected account",
          message: "You cannot delete the primary owner account.",
          type: "error",
        });
        return;
      }
      if (!confirm(`Delete portal user ${user.full_name}?`)) return;
      try {
        const { error } = await supabase.from("portal_users").delete().eq("id", id);
        if (error) throw error;
        portalUsersCache = portalUsersCache.filter((u) => u.id !== id);
        renderPortalUsersTable();
        showToast({
          title: "User deleted",
          message: `${user.full_name} was removed from portal access.`,
          type: "success",
        });
      } catch (err) {
        console.error("Delete user error", err);
        showToast({
          title: "Delete failed",
          message: "Could not delete this user.",
          type: "error",
        });
      }
    }
  });

  // Modal logic
  const userModal = document.getElementById("userModal");
  const modalTitle = document.getElementById("userModalTitle");
  const modalFullName = document.getElementById("modalFullName");
  const modalInitials = document.getElementById("modalInitials");
  const modalPin = document.getElementById("modalPin");
  const modalRole = document.getElementById("modalRole");
  const modalActive = document.getElementById("modalActive");
  const modalCancel = document.getElementById("modalCancel");
  const modalSave = document.getElementById("modalSave");
  let editingUserId = null;

  document
    .getElementById("addUserButton")
    .addEventListener("click", () => openUserModal(null));

  function openUserModal(user) {
    if (!currentUser || currentUser.role !== "admin") {
      showToast({
        title: "Not allowed",
        message: "Only administrators can manage portal users.",
        type: "error",
      });
      return;
    }
    editingUserId = user ? user.id : null;
    modalTitle.textContent = editingUserId ? "Edit user" : "Add user";
    modalFullName.value = user?.full_name || "";
    modalInitials.value = user?.initials || "";
    modalPin.value = "";
    modalRole.value = user?.role || "user";
    modalActive.checked = user ? !!user.active : true;
    userModal.classList.remove("hidden");
    userModal.classList.add("flex");
  }

  modalCancel.addEventListener("click", () => {
    userModal.classList.add("hidden");
    userModal.classList.remove("flex");
  });

  modalSave.addEventListener("click", async () => {
    const fullName = modalFullName.value.trim();
    const initials = modalInitials.value.trim().toUpperCase();
    const pin = modalPin.value.trim();
    const role = modalRole.value;
    const active = modalActive.checked;

    if (!fullName || !initials || !pin) {
      showToast({
        title: "Missing fields",
        message: "Full name, initials, and PIN are required.",
        type: "error",
      });
      return;
    }
    if (!/^\d{4}$/.test(pin)) {
      showToast({
        title: "Invalid PIN",
        message: "PIN must be exactly 4 digits.",
        type: "error",
      });
      return;
    }

    try {
      if (editingUserId) {
        const { error } = await supabase
          .from("portal_users")
          .update({
            full_name: fullName,
            initials,
            pin,
            role,
            active,
          })
          .eq("id", editingUserId);
        if (error) throw error;
      } else {
        const { error } = await supabase.from("portal_users").insert([
          {
            full_name: fullName,
            initials,
            username: initials, // keep username populated (matches schema)
            pin,
            role,
            active,
          },
        ]);
        if (error) throw error;
      }
      userModal.classList.add("hidden");
      userModal.classList.remove("flex");
      await loadPortalUsers();
      showToast({
        title: "Saved",
        message: "Portal user changes have been saved.",
        type: "success",
      });
    } catch (err) {
      console.error("Save user error", err);
      showToast({
        title: "Save failed",
        message: "Could not save this portal user.",
        type: "error",
      });
    }
  });

  // ------------------------ SESSION RESTORE ------------------------
  (function initFromSession() {
    const stored = sessionStorage.getItem("portal_user");
    if (stored) {
      try {
        const parsed = JSON.parse(stored);
        currentUser = parsed;
        currentLogId = parsed.log_id || null;
        showDashboard();
      } catch {
        sessionStorage.removeItem("portal_user");
      }
    }
  })();
</script>
</body>
</html>
