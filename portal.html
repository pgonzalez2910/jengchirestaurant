<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Jeng Chi — Executive Benefits Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Icons -->
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA=="
    crossorigin="anonymous"
    referrerpolicy="no-referrer"
  />
  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>

  <style>
    :root {
      /* Approx colors sampled from Jeng Chi logo (red + deep neutral) */
      --jc-red: #b02026;
      --jc-red-dark: #85171b;
      --jc-blue: #003b73;
      --jc-blue-soft: #e3effb;
      --jc-gray-bg: #f3f4f6;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background-color: var(--jc-gray-bg);
      color: #111827;
    }

    .btn-primary {
      @apply inline-flex items-center justify-center rounded-md text-sm font-semibold px-4 py-2 transition;
      background: linear-gradient(135deg, var(--jc-red), var(--jc-red-dark));
      color: #fff;
    }
    .btn-primary:hover {
      filter: brightness(1.05);
    }
    .btn-secondary {
      @apply inline-flex items-center justify-center rounded-md text-sm font-medium px-4 py-2 transition border;
      border-color: #d1d5db;
      background-color: #ffffff;
      color: #111827;
    }
    .btn-secondary:hover {
      background-color: #f3f4f6;
    }

    .card {
      @apply bg-white rounded-xl shadow-sm border border-gray-200;
    }

    .tab-active {
      border-bottom: 2px solid var(--jc-red);
      color: var(--jc-red);
      font-weight: 600;
    }

    .input-base {
      @apply block w-full rounded-md border border-gray-300 px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-[var(--jc-red)] focus:border-[var(--jc-red)];
    }

    .toast {
      animation: slideIn 0.25s ease-out;
    }
    @keyframes slideIn {
      from {
        transform: translateY(10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Simple tiny bar "charts" */
    .chart-bar {
      height: 6px;
      border-radius: 9999px;
    }
  </style>
</head>
<body class="min-h-screen">

<!-- TOASTS -->
<div id="toastContainer" class="fixed top-4 right-4 z-50 space-y-2"></div>

<!-- LOGIN SCREEN -->
<section id="loginScreen" class="min-h-screen flex items-center justify-center px-4 py-10 bg-white">
  <div class="max-w-5xl w-full grid gap-8 md:grid-cols-[1.2fr,0.9fr] items-center">
    <!-- Left narrative -->
    <div class="space-y-6">
      <div class="flex items-center gap-4">
        <img
          src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
          alt="Jeng Chi Logo"
          class="h-14 w-auto object-contain"
        />
        <div>
          <p class="text-xs uppercase tracking-[0.25em] text-[var(--jc-red)]">Jeng Chi Restaurant</p>
          <h1 class="text-2xl md:text-3xl font-bold text-gray-900">
            Executive Benefits Portal
          </h1>
          <p class="text-sm text-gray-500 mt-1">
            Secure access to signed benefit documents and analytics for executives and HR.
          </p>
        </div>
      </div>

      <div class="space-y-3">
        <p class="text-sm text-gray-600 leading-relaxed">
          Use your assigned initials and PIN to enter the executive benefits console.
          Standard users can view signed benefit documents; administrators can also
          access benefit analytics and portal user management.
        </p>
        <ul class="text-xs text-gray-500 list-disc pl-5 space-y-1">
          <li>Review finalized enrollment PDFs per employee</li>
          <li>Compare employee benefit elections across plan years</li>
          <li>Manage authorized users and track portal access activity</li>
        </ul>
      </div>

      <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 text-xs">
        <div class="card px-4 py-3">
          <p class="text-[0.65rem] uppercase tracking-[0.18em] text-gray-400">Workspace</p>
          <p class="font-semibold text-gray-900 mt-1">Signed Documents</p>
          <p class="text-gray-500 mt-1">
            Access audit-ready PDFs for all signed employees.
          </p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[0.65rem] uppercase tracking-[0.18em] text-gray-400">Analytics</p>
          <p class="font-semibold text-gray-900 mt-1">Benefit Summary</p>
          <p class="text-gray-500 mt-1">
            Visualize plan elections and year-over-year cost changes.
          </p>
        </div>
        <div class="card px-4 py-3">
          <p class="text-[0.65rem] uppercase tracking-[0.18em] text-gray-400">Security</p>
          <p class="font-semibold text-gray-900 mt-1">Portal Credentials</p>
          <p class="text-gray-500 mt-1">
            Restrict access via initials, PIN, and role-based views.
          </p>
        </div>
      </div>
    </div>

    <!-- Right login card -->
    <div class="card px-6 py-7">
      <h2 class="text-xl font-semibold text-gray-900">
        Enter your portal credentials
      </h2>
      <p class="text-xs text-gray-500 mt-1">
        Use the initials and PIN issued to you by HR or Ownership.
      </p>

      <form id="loginForm" class="mt-6 space-y-4">
        <div>
          <label for="initialsInput" class="block text-sm font-medium text-gray-700">
            Initials
          </label>
          <input
            id="initialsInput"
            type="text"
            autocomplete="off"
            class="input-base mt-1"
          />
        </div>
        <div>
          <label for="pinInput" class="block text-sm font-medium text-gray-700">
            PIN
          </label>
          <div class="mt-1 relative">
            <input
              id="pinInput"
              type="password"
              autocomplete="off"
              class="input-base pr-10"
            />
            <button
              type="button"
              id="togglePinVisibility"
              class="absolute inset-y-0 right-0 px-3 flex items-center text-gray-400 hover:text-gray-600"
              tabindex="-1"
            >
              <i class="fa-solid fa-eye"></i>
            </button>
          </div>
        </div>

        <button
          id="loginButton"
          type="submit"
          class="btn-primary w-full mt-1"
        >
          <span class="mr-2"><i class="fa-solid fa-right-to-bracket"></i></span>
          <span>Sign In</span>
        </button>
      </form>

      <p id="loginError" class="mt-3 text-xs text-red-600 hidden">
        Invalid credentials
      </p>

      <p class="mt-6 text-[11px] text-gray-500 border-t border-gray-200 pt-4">
        This is a secure executive benefits portal. Unauthorized access is prohibited.
        Activity may be monitored and logged for audit purposes.
      </p>
    </div>
  </div>
</section>

<!-- DASHBOARD -->
<section id="dashboard" class="hidden min-h-screen bg-[var(--jc-gray-bg)]">
  <!-- Header -->
  <header class="bg-white border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 h-16 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img
          src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true"
          alt="Jeng Chi Logo"
          class="h-10 w-auto object-contain"
        />
        <div>
          <p class="text-[11px] uppercase tracking-[0.2em] text-[var(--jc-red)]">
            Jeng Chi Restaurant
          </p>
          <p class="text-sm font-semibold text-gray-900">
            Executive Benefits Portal
          </p>
        </div>
      </div>
      <div class="flex items-center gap-4">
        <div class="text-right text-xs">
          <p class="text-gray-500">Logged in as</p>
          <p id="loggedInUserLabel" class="font-semibold text-gray-900">
            —
          </p>
        </div>
        <button id="logoutButton" class="btn-secondary text-xs">
          <i class="fa-solid fa-right-from-bracket mr-2"></i>
          Logout
        </button>
      </div>
    </div>
  </header>

  <!-- Main content -->
  <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 space-y-6">
    <!-- SUMMARY CARDS -->
    <section class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <div class="card px-5 py-4 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            Total Signed Employees
          </p>
          <p id="summaryTotalSigned" class="mt-2 text-3xl font-bold text-gray-900">
            0
          </p>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          Employees with finalized benefit packets on file.
        </p>
      </div>
      <div class="card px-5 py-4 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            Current Plan Year
          </p>
          <p id="summaryPlanYears" class="mt-2 text-2xl font-bold text-gray-900">
            2025–2026
          </p>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          Active comparison window for plan elections.
        </p>
      </div>
      <div class="card px-5 py-4 flex flex-col justify-between">
        <div>
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            Active Benefit Cycle
          </p>
          <p id="summaryCycleStatus" class="mt-2 text-lg font-semibold text-[var(--jc-red)]">
            Under Review
          </p>
        </div>
        <p class="mt-1 text-xs text-gray-500">
          Use the analytics tab for renewal discussions and budgeting.
        </p>
      </div>
    </section>

    <!-- TABS -->
    <nav class="card flex items-center justify-between px-4 sm:px-6 py-3">
      <div class="flex gap-6 text-sm">
        <button
          id="tabSignedDocs"
          class="pb-2 border-b-2 border-transparent text-gray-600 hover:text-[var(--jc-red)]"
          data-tab="signedDocs"
        >
          Signed Documents
        </button>
        <button
          id="tabBenefitSummary"
          class="pb-2 border-b-2 border-transparent text-gray-600 hover:text-[var(--jc-red)] hidden"
          data-tab="benefitSummary"
        >
          Benefit Summary
        </button>
        <button
          id="tabUsers"
          class="pb-2 border-b-2 border-transparent text-gray-600 hover:text-[var(--jc-red)] hidden"
          data-tab="users"
        >
          Authorized Users &amp; Portal Credentials
        </button>
      </div>
      <p class="hidden sm:block text-[11px] text-gray-400">
        Role-based access: admins see all tabs · standard users see Signed Documents only.
      </p>
    </nav>

    <!-- SECTIONS -->
    <!-- SIGNED DOCUMENTS -->
    <section id="sectionSignedDocs" class="card px-5 sm:px-6 py-5 space-y-4">
      <div class="flex flex-col sm:flex-row sm:items-end justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">
            Signed Documents
          </h2>
          <p class="text-xs text-gray-500 mt-1">
            Search and open signed benefit packets for employees. Use print tools for
            audits or production printing.
          </p>
        </div>
        <div class="flex flex-wrap gap-2">
          <button id="btnPrintAll" class="btn-secondary text-xs">
            <i class="fa-solid fa-print mr-2"></i> Print All
          </button>
          <button id="btnMergeDownloadAll" class="btn-primary text-xs">
            <i class="fa-solid fa-file-pdf mr-2"></i> Merge &amp; Download All
          </button>
        </div>
      </div>

      <div class="grid gap-3 sm:grid-cols-[minmax(0,0.5fr),minmax(0,1.5fr)] items-start">
        <div class="space-y-2">
          <label for="docSearchInput" class="text-xs font-medium text-gray-700">
            Search employee by last name
          </label>
          <div class="relative">
            <input
              id="docSearchInput"
              type="text"
              class="input-base text-sm"
            />
            <div
              id="docSuggestions"
              class="absolute z-20 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-sm text-xs max-h-48 overflow-y-auto hidden"
            ></div>
          </div>
        </div>

        <div class="overflow-x-auto border border-gray-200 rounded-md bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-gray-50 border-b border-gray-200">
            <tr class="text-left text-[11px] uppercase tracking-wide text-gray-500">
              <th class="px-4 py-2">Employee Name</th>
              <th class="px-4 py-2">Username</th>
              <th class="px-4 py-2">Actions</th>
            </tr>
            </thead>
            <tbody id="docsTableBody" class="divide-y divide-gray-100">
            <tr>
              <td colspan="3" class="px-4 py-4 text-center text-gray-400 text-xs">
                Loading signed employees…
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- BENEFIT SUMMARY -->
    <section id="sectionBenefitSummary" class="card px-5 sm:px-6 py-5 space-y-5 hidden">
      <div>
        <h2 class="text-lg font-semibold text-gray-900">
          Employee Benefit Analytics
        </h2>
        <p class="text-xs text-gray-500 mt-1">
          Overview of health, dental, and vision plan elections across 2025 and 2026.
          Select an employee to view their side-by-side comparison.
        </p>
      </div>

      <!-- Top summary "charts" -->
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 text-xs">
        <!-- 2025 Health -->
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            2025 Health Plan
          </p>
          <div id="health2025Stats" class="mt-2 text-gray-800 text-xs">
            Loading…
          </div>
        </div>
        <!-- 2026 Health -->
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            2026 Health Plan
          </p>
          <div id="health2026Stats" class="mt-2 text-gray-800 text-xs">
            Loading…
          </div>
        </div>
        <!-- Dental -->
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            Dental Plans 2025–2026
          </p>
          <div id="dentalStats" class="mt-2 text-gray-800 text-xs">
            Loading…
          </div>
        </div>
        <!-- Vision -->
        <div class="card px-4 py-3">
          <p class="text-[0.7rem] uppercase tracking-[0.18em] text-gray-400">
            Vision Plans 2025–2026
          </p>
          <div id="visionStats" class="mt-2 text-gray-800 text-xs">
            Loading…
          </div>
        </div>
      </div>

      <!-- Employee selector + summary -->
      <div class="grid gap-4 lg:grid-cols-[0.7fr,1.3fr] items-start">
        <div class="space-y-3">
          <div>
            <label for="benefitEmployeeSearch" class="text-xs font-medium text-gray-700">
              Search employee
            </label>
            <div class="relative mt-1">
              <input
                id="benefitEmployeeSearch"
                type="text"
                class="input-base text-sm"
              />
              <div
                id="benefitEmployeeSuggestions"
                class="absolute z-20 left-0 right-0 mt-1 bg-white border border-gray-200 rounded-md shadow-sm text-xs max-h-48 overflow-y-auto hidden"
              ></div>
            </div>
          </div>
          <p class="text-[11px] text-gray-500">
            Start typing a last name or initials to select an employee and
            generate their benefit comparison card.
          </p>
        </div>

        <div
          id="benefitDetailContainer"
          class="border border-dashed border-gray-300 rounded-lg px-4 py-6 text-center text-xs text-gray-500"
        >
          Select an employee to display their 2025 vs 2026 benefits:
          plan selections, yearly cost difference, and change summary.
        </div>
      </div>
    </section>

    <!-- USERS + ACCESS LOGS -->
    <section id="sectionUsers" class="card px-5 sm:px-6 py-5 space-y-6 hidden">
      <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-4">
        <div>
          <h2 class="text-lg font-semibold text-gray-900">
            Authorized Users &amp; Portal Credentials
          </h2>
          <p class="text-xs text-gray-500 mt-1">
            Maintain which executives and managers can access this portal. User data
            is stored in the <code class="font-mono text-[10px]">portal_users</code> table.
          </p>
        </div>
        <button id="btnAddUser" class="btn-primary text-xs">
          <i class="fa-solid fa-user-plus mr-2"></i> Add User
        </button>
      </div>

      <!-- Users table -->
      <div class="border border-gray-200 rounded-lg overflow-x-auto bg-white">
        <table class="min-w-full text-xs">
          <thead class="bg-gray-50 border-b border-gray-200">
          <tr class="text-left text-[11px] uppercase tracking-wide text-gray-500">
            <th class="px-4 py-2">Full Name</th>
            <th class="px-4 py-2">Initials</th>
            <th class="px-4 py-2">Role</th>
            <th class="px-4 py-2">Active</th>
            <th class="px-4 py-2">Last Login</th>
            <th class="px-4 py-2">Actions</th>
          </tr>
          </thead>
          <tbody id="usersTableBody" class="divide-y divide-gray-100">
          <tr>
            <td colspan="6" class="px-4 py-4 text-center text-gray-400 text-xs">
              Loading users…
            </td>
          </tr>
          </tbody>
        </table>
      </div>

      <!-- ACCESS LOGS -->
      <div class="border-t border-gray-200 pt-4">
        <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3 mb-3">
          <div>
            <h3 class="text-sm font-semibold text-gray-900">
              Access Logs
            </h3>
            <p class="text-[11px] text-gray-500">
              Real-time session tracking from
              <code class="font-mono text-[10px]">portal_logs</code>, joined to employees.
            </p>
          </div>
          <p class="text-[11px] text-gray-400">
            Status legend: Active · Completed · Ended unexpectedly
          </p>
        </div>

        <div class="border border-gray-200 rounded-lg overflow-x-auto bg-white">
          <table class="min-w-full text-xs">
            <thead class="bg-gray-50 border-b border-gray-200">
            <tr class="text-left text-[11px] uppercase tracking-wide text-gray-500">
              <th class="px-4 py-2">User</th>
              <th class="px-4 py-2">Login Time</th>
              <th class="px-4 py-2">Last Activity</th>
              <th class="px-4 py-2">Duration (min)</th>
              <th class="px-4 py-2">Tabs Visited</th>
              <th class="px-4 py-2">Status</th>
            </tr>
            </thead>
            <tbody id="accessLogsTableBody" class="divide-y divide-gray-100">
            <tr>
              <td colspan="6" class="px-4 py-4 text-center text-gray-400 text-xs">
                Loading access logs…
              </td>
            </tr>
            </tbody>
          </table>
        </div>
      </div>
    </section>
  </main>
</section>

<!-- ADD/EDIT USER MODAL -->
<div
  id="userModalOverlay"
  class="fixed inset-0 bg-black/30 flex items-center justify-center z-40 hidden"
>
  <div class="card w-full max-w-md px-6 py-5">
    <h3 id="userModalTitle" class="text-lg font-semibold text-gray-900 mb-4">
      Add User
    </h3>
    <div class="space-y-3 text-sm">
      <div>
        <label for="userFullNameInput" class="block text-xs font-medium text-gray-700">
          Full Name
        </label>
        <input id="userFullNameInput" type="text" class="input-base mt-1" />
      </div>
      <div>
        <label for="userInitialsInput" class="block text-xs font-medium text-gray-700">
          Initials
        </label>
        <input id="userInitialsInput" type="text" class="input-base mt-1" />
      </div>
      <div>
        <label for="userPinInput" class="block text-xs font-medium text-gray-700">
          PIN (6 digits)
        </label>
        <input id="userPinInput" type="password" class="input-base mt-1" />
      </div>
      <div>
        <label for="userRoleSelect" class="block text-xs font-medium text-gray-700">
          Role
        </label>
        <select id="userRoleSelect" class="input-base mt-1">
          <option value="admin">Administrator</option>
          <option value="user">Standard User</option>
        </select>
      </div>
      <div class="flex items-center gap-2 mt-1">
        <input id="userActiveCheckbox" type="checkbox" class="h-4 w-4 text-[var(--jc-red)]" />
        <label for="userActiveCheckbox" class="text-xs text-gray-700">
          Portal Active
        </label>
      </div>
    </div>
    <div class="mt-6 flex justify-end gap-2">
      <button id="btnCancelUser" class="btn-secondary text-xs">
        Cancel
      </button>
      <button id="btnSaveUser" class="btn-primary text-xs">
        Save
      </button>
    </div>
  </div>
</div>

<!-- SPINNER OVERLAY -->
<div id="spinnerOverlay" class="fixed inset-0 bg-black/15 flex items-center justify-center z-30 hidden">
  <div class="bg-white rounded-md shadow px-4 py-3 text-sm flex items-center gap-3">
    <span class="inline-flex h-4 w-4 border-2 border-gray-300 border-t-[var(--jc-red)] rounded-full animate-spin"></span>
    <span id="spinnerText" class="text-gray-700">Processing…</span>
  </div>
</div>

<script>
  // ==============================
  // CONFIG
  // ==============================
  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
  const SUPABASE_KEY =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

  const PLAN_YEARS = [2025, 2026];
  const TIMEZONE = "America/Chicago";
  const LOCALE = "en-US";

  // ==============================
  // GLOBAL STATE
  // ==============================
  let currentUser = null; // { id, full_name, initials, role, active, log_id, loginTime }
  let signedEmployees = []; // employees2025 rows with signed_pdf_url
  let usersCache = []; // portal_users
  let currentSessionTabs = new Set();
  let accessLogChannel = null;

  let editingUserId = null;

  // ==============================
  // ELEMENTS
  // ==============================
  const loginScreen = document.getElementById("loginScreen");
  const dashboard = document.getElementById("dashboard");
  const loginForm = document.getElementById("loginForm");
  const loginButton = document.getElementById("loginButton");
  const loginError = document.getElementById("loginError");
  const initialsInput = document.getElementById("initialsInput");
  const pinInput = document.getElementById("pinInput");
  const togglePinVisibility = document.getElementById("togglePinVisibility");
  const loggedInUserLabel = document.getElementById("loggedInUserLabel");
  const logoutButton = document.getElementById("logoutButton");

  const summaryTotalSigned = document.getElementById("summaryTotalSigned");

  const tabSignedDocs = document.getElementById("tabSignedDocs");
  const tabBenefitSummary = document.getElementById("tabBenefitSummary");
  const tabUsers = document.getElementById("tabUsers");

  const sectionSignedDocs = document.getElementById("sectionSignedDocs");
  const sectionBenefitSummary = document.getElementById("sectionBenefitSummary");
  const sectionUsers = document.getElementById("sectionUsers");

  const docSearchInput = document.getElementById("docSearchInput");
  const docSuggestions = document.getElementById("docSuggestions");
  const docsTableBody = document.getElementById("docsTableBody");
  const btnPrintAll = document.getElementById("btnPrintAll");
  const btnMergeDownloadAll = document.getElementById("btnMergeDownloadAll");

  const health2025Stats = document.getElementById("health2025Stats");
  const health2026Stats = document.getElementById("health2026Stats");
  const dentalStats = document.getElementById("dentalStats");
  const visionStats = document.getElementById("visionStats");
  const benefitEmployeeSearch = document.getElementById("benefitEmployeeSearch");
  const benefitEmployeeSuggestions = document.getElementById("benefitEmployeeSuggestions");
  const benefitDetailContainer = document.getElementById("benefitDetailContainer");

  const usersTableBody = document.getElementById("usersTableBody");
  const accessLogsTableBody = document.getElementById("accessLogsTableBody");
  const btnAddUser = document.getElementById("btnAddUser");

  const userModalOverlay = document.getElementById("userModalOverlay");
  const userModalTitle = document.getElementById("userModalTitle");
  const userFullNameInput = document.getElementById("userFullNameInput");
  const userInitialsInput = document.getElementById("userInitialsInput");
  const userPinInput = document.getElementById("userPinInput");
  const userRoleSelect = document.getElementById("userRoleSelect");
  const userActiveCheckbox = document.getElementById("userActiveCheckbox");
  const btnCancelUser = document.getElementById("btnCancelUser");
  const btnSaveUser = document.getElementById("btnSaveUser");

  const spinnerOverlay = document.getElementById("spinnerOverlay");
  const spinnerText = document.getElementById("spinnerText");
  const toastContainer = document.getElementById("toastContainer");

  // ==============================
  // UTILITIES
  // ==============================
  function showSpinner(message = "Processing…") {
    spinnerText.textContent = message;
    spinnerOverlay.classList.remove("hidden");
  }
  function hideSpinner() {
    spinnerOverlay.classList.add("hidden");
  }

  function showToast(message, type = "info") {
    const wrapper = document.createElement("div");
    wrapper.className =
      "toast rounded-md shadow px-3 py-2 text-xs flex items-center gap-2 bg-white border";
    let iconClass = "fa-circle-info text-blue-500";
    let borderColor = "border-blue-200";
    if (type === "success") {
      iconClass = "fa-circle-check text-green-500";
      borderColor = "border-green-200";
    } else if (type === "error") {
      iconClass = "fa-circle-xmark text-red-500";
      borderColor = "border-red-200";
    } else if (type === "warning") {
      iconClass = "fa-triangle-exclamation text-yellow-500";
      borderColor = "border-yellow-200";
    }
    wrapper.classList.add(borderColor);
    wrapper.innerHTML = `
      <i class="fa-solid ${iconClass}"></i>
      <span class="text-gray-800">${message}</span>
    `;
    toastContainer.appendChild(wrapper);
    setTimeout(() => {
      wrapper.remove();
    }, 3500);
  }

  function formatCurrency(amount) {
    return new Intl.NumberFormat(LOCALE, {
      style: "currency",
      currency: "USD",
      minimumFractionDigits: 2,
    }).format(amount || 0);
  }

  function formatDateTime(dtString) {
    if (!dtString) return "—";
    const d = new Date(dtString);
    return d.toLocaleString(LOCALE, {
      timeZone: TIMEZONE,
      year: "numeric",
      month: "2-digit",
      day: "2-digit",
      hour: "2-digit",
      minute: "2-digit",
      second: "2-digit",
    });
  }

  function escapeHtml(str) {
    return String(str ?? "").replace(/[&<>"']/g, (s) => {
      const map = {
        "&": "&amp;",
        "<": "&lt;",
        ">": "&gt;",
        '"': "&quot;",
        "'": "&#39;",
      };
      return map[s] || s;
    });
  }

  function isAdmin() {
    return currentUser && currentUser.role === "admin";
  }

  function markTabVisited(label) {
    currentSessionTabs.add(label);
  }

  // ==============================
  // LOGIN / LOGOUT / SESSION LOGS
  // ==============================
async function findPortalUser(initials) {
  const { data, error } = await supabase
    .from("portal_users")
    .select("*")
    .eq("initials", initials)
    .limit(1);

  if (error) {
    console.error("Error loading portal_users:", error);
    return null;
  }
  if (!data || data.length === 0) return null;
  return data[0];
}


  async function updateLastLogin(userId) {
    await supabase
      .from("portal_users")
      .update({ last_login: new Date().toISOString() })
      .eq("id", userId);
  }

  async function createLoginLog(initials) {
    try {
      const { data: empRows, error: empError } = await supabase
        .from("employees2025")
        .select("id, username, first_name, last_name")
        .eq("username", initials)
        .limit(1);

      if (empError) {
        console.error("Error finding employee for log:", empError);
        return;
      }
      if (!empRows || empRows.length === 0) {
        console.warn(`No employees2025 row found for username=${initials} — portal_logs insert skipped.`);
        return;
      }

      const employee = empRows[0];
      const nowIso = new Date().toISOString();
      const { data: logRows, error: logError } = await supabase
        .from("portal_logs")
        .insert([{ employee_id: employee.id, login_time: nowIso }])
        .select("id, login_time")
        .limit(1);

      if (logError) {
        console.error("Error inserting portal_logs row:", logError);
        return;
      }
      if (logRows && logRows.length > 0) {
        currentUser.log_id = logRows[0].id;
        currentUser.loginTime = new Date(logRows[0].login_time || nowIso);
      }
    } catch (err) {
      console.error("Unexpected error creating login log:", err);
    }
  }

  async function logoutAndCloseSession(manual = true) {
    try {
      if (currentUser && currentUser.log_id) {
        const now = new Date();
        let durationMinutes = 0;
        if (currentUser.loginTime instanceof Date) {
          const diffMs = now.getTime() - currentUser.loginTime.getTime();
          durationMinutes = Math.max(0, Math.round(diffMs / 60000));
        }
        if (!manual) {
          // Mark as ended unexpectedly
          durationMinutes = -1;
        }

        const { error } = await supabase
          .from("portal_logs")
          .update({
            logout_time: now.toISOString(),
            duration_minutes: durationMinutes,
          })
          .eq("id", currentUser.log_id);

        if (error) {
          console.error("Error updating portal_logs on logout:", error);
        }
      }
    } catch (err) {
      console.error("Unexpected error during logout:", err);
    } finally {
      currentUser = null;
      sessionStorage.removeItem("auth_user");
      loginScreen.classList.remove("hidden");
      dashboard.classList.add("hidden");
      initialsInput.value = "";
      pinInput.value = "";
      currentSessionTabs.clear();
      unsubscribeAccessLogs();
    }
  }

  // Synchronous update for browser close / reload
  function syncLogoutOnUnload() {
    try {
      if (!currentUser || !currentUser.log_id) return;

      const now = new Date();
      let durationMinutes = -1; // ended unexpectedly
      if (currentUser.loginTime instanceof Date) {
        const diffMs = now.getTime() - currentUser.loginTime.getTime();
        durationMinutes = Math.max(0, Math.round(diffMs / 60000));
        // we still mark as -1 to differentiate
        durationMinutes = -1;
      }

      const payload = {
        logout_time: now.toISOString(),
        duration_minutes: durationMinutes,
      };
      const xhr = new XMLHttpRequest();
      xhr.open(
        "PATCH",
        `${SUPABASE_URL}/rest/v1/portal_logs?id=eq.${currentUser.log_id}`,
        false
      );
      xhr.setRequestHeader("apikey", SUPABASE_KEY);
      xhr.setRequestHeader("Authorization", `Bearer ${SUPABASE_KEY}`);
      xhr.setRequestHeader("Content-Type", "application/json");
      xhr.send(JSON.stringify(payload));
    } catch (err) {
      console.error("Sync logout on unload failed:", err);
    }
  }

  window.addEventListener("beforeunload", (event) => {
    if (currentUser && currentUser.log_id) {
      syncLogoutOnUnload();
      event.preventDefault();
      event.returnValue =
        "You are still logged in. Please log out properly.";
    }
  });

  // ==============================
  // SIGNED EMPLOYEES DATA
  // ==============================
  async function loadSignedEmployees() {
    const { data, error } = await supabase
      .from("employees2025")
      .select("id, first_name, last_name, username, signed_pdf_url")
      .neq("signed_pdf_url", null);

    if (error) {
      console.error("Error fetching signed employees:", error);
      docsTableBody.innerHTML =
        '<tr><td colspan="3" class="px-4 py-4 text-center text-red-500 text-xs">Error loading signed employees.</td></tr>';
      return;
    }

    signedEmployees = (data || []).filter((e) => !!e.signed_pdf_url);
    signedEmployees.sort((a, b) => {
      const la = (a.last_name || "").toLowerCase();
      const lb = (b.last_name || "").toLowerCase();
      if (la < lb) return -1;
      if (la > lb) return 1;
      const fa = (a.first_name || "").toLowerCase();
      const fb = (b.first_name || "").toLowerCase();
      return fa.localeCompare(fb);
    });

    summaryTotalSigned.textContent = String(signedEmployees.length);
    renderSignedDocsTable();
  }

  function renderSignedDocsTable(filterLastName = "") {
    const filter = filterLastName.trim().toLowerCase();
    let list = signedEmployees;
    if (filter) {
      list = list.filter((e) =>
        (e.last_name || "").toLowerCase().startsWith(filter)
      );
    }

    if (!list.length) {
      docsTableBody.innerHTML =
        '<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400 text-xs">No signed employees match this search.</td></tr>';
      return;
    }

    docsTableBody.innerHTML = "";
    list.forEach((e) => {
      const name = `${e.last_name || ""}, ${e.first_name || ""}`.trim();
      const row = document.createElement("tr");
      row.className = "hover:bg-gray-50";
      row.innerHTML = `
        <td class="px-4 py-2 text-xs text-gray-900">${escapeHtml(name)}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          e.username || ""
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600 space-x-2">
          <a
            href="${escapeHtml(e.signed_pdf_url)}"
            target="_blank"
            class="text-[var(--jc-blue)] hover:underline"
          >
            View PDF
          </a>
          <button
            type="button"
            class="text-gray-500 hover:text-gray-800"
            data-action="print"
            data-url="${escapeHtml(e.signed_pdf_url)}"
          >
            <i class="fa-solid fa-print"></i>
          </button>
        </td>
      `;
      docsTableBody.appendChild(row);
    });
  }

  function renderDocSuggestions(filterLastName) {
    const filter = filterLastName.trim().toLowerCase();
    if (!filter) {
      docSuggestions.classList.add("hidden");
      docSuggestions.innerHTML = "";
      return;
    }
    const matches = signedEmployees
      .filter((e) => (e.last_name || "").toLowerCase().startsWith(filter))
      .slice(0, 10);

    if (!matches.length) {
      docSuggestions.classList.add("hidden");
      docSuggestions.innerHTML = "";
      return;
    }

    docSuggestions.innerHTML = "";
    matches.forEach((e) => {
      const name = `${e.last_name || ""}, ${e.first_name || ""}`.trim();
      const item = document.createElement("button");
      item.type = "button";
      item.className =
        "w-full text-left px-3 py-1.5 hover:bg-gray-50 text-gray-700";
      item.textContent = name;
      item.dataset.lastName = e.last_name || "";
      item.addEventListener("click", () => {
        docSearchInput.value = e.last_name || "";
        docSuggestions.classList.add("hidden");
        renderSignedDocsTable(e.last_name || "");
      });
      docSuggestions.appendChild(item);
    });
    docSuggestions.classList.remove("hidden");
  }

  // ==============================
  // BENEFIT ANALYTICS
  // ==============================
  async function loadBenefitSummaryAggregates() {
    // HEALTH (medical_plan)
    await Promise.all([
      buildPlanAggregateCard(2025, "medical_plan", health2025Stats),
      buildPlanAggregateCard(2026, "medical_plan", health2026Stats),
      buildPlanAggregateCard(null, "dental_plan", dentalStats),
      buildPlanAggregateCard(null, "vision_plan", visionStats),
    ]);
  }

  async function buildPlanAggregateCard(year, fieldName, containerEl) {
    try {
      let query = supabase
        .from("benefit_enrollments")
        .select(`${fieldName}, benefit_year`);

      if (year !== null) {
        query = query.eq("benefit_year", year);
      } else {
        query = query.in("benefit_year", PLAN_YEARS);
      }

      const { data, error } = await query;
      if (error) {
        console.error("Error loading aggregate benefits:", error);
        containerEl.innerHTML =
          '<span class="text-red-500">Error loading data.</span>';
        return;
      }

      const rows = (data || []).filter((r) => r[fieldName]);
      if (!rows.length) {
        containerEl.innerHTML =
          '<span class="text-gray-400">No elections on file.</span>';
        return;
      }

      const counts = {};
      rows.forEach((r) => {
        const code = r[fieldName] || "Unknown";
        if (!counts[code]) counts[code] = 0;
        counts[code] += 1;
      });

      const total = Object.values(counts).reduce((a, b) => a + b, 0);
      const entries = Object.entries(counts)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);

      const labelPrefix =
        year !== null ? `${year}: ` : "Top Plans: ";

      const fragments = entries
        .map(([code, count]) => `${escapeHtml(code)} (${count})`)
        .join(" | ");

      const barHtml = entries
        .map(([code, count], idx) => {
          const pct = total ? Math.round((count / total) * 100) : 0;
          const colorClass =
            idx === 0
              ? "bg-[var(--jc-red)]"
              : idx === 1
              ? "bg-[var(--jc-blue)]"
              : "bg-gray-400";
          return `<div class="chart-bar ${colorClass}" style="width:${pct}%;"></div>`;
        })
        .join("");

      containerEl.innerHTML = `
        <p class="text-gray-800 text-xs">${labelPrefix}${fragments}</p>
        <div class="mt-2 w-full bg-gray-100 rounded-full flex overflow-hidden">${barHtml}</div>
        <p class="mt-1 text-[10px] text-gray-400">Total elections: ${total}</p>
      `;
    } catch (err) {
      console.error("Unexpected error in aggregate card:", err);
      containerEl.innerHTML =
        '<span class="text-red-500">Error loading data.</span>';
    }
  }

  async function loadEmployeeBenefitDetail(username) {
    benefitDetailContainer.innerHTML =
      '<div class="text-xs text-gray-500">Loading benefit data…</div>';

    try {
      const { data: enrollments, error } = await supabase
        .from("benefit_enrollments")
        .select("*")
        .eq("username", username)
        .in("benefit_year", PLAN_YEARS);

      if (error) {
        console.error("Error loading employee enrollments:", error);
        benefitDetailContainer.innerHTML =
          '<div class="text-xs text-red-500">Error loading employee enrollment data.</div>';
        return;
      }

      const perYear = {};
      (enrollments || []).forEach((e) => {
        perYear[e.benefit_year] = e;
      });

      if (!perYear[2025] && !perYear[2026]) {
        benefitDetailContainer.innerHTML =
          '<div class="text-xs text-gray-500">No benefit elections on file for 2025 or 2026.</div>';
        return;
      }

      // Load rates from benefit_rates
      const { data: rateRows, error: rateErr } = await supabase
        .from("benefit_rates")
        .select("*")
        .in("effective_year", PLAN_YEARS);

      if (rateErr) {
        console.error("Error loading benefit_rates:", rateErr);
        benefitDetailContainer.innerHTML =
          '<div class="text-xs text-red-500">Error loading rate schedule.</div>';
        return;
      }

      const cost2025 = perYear[2025]
        ? computeYearCost(perYear[2025], 2025, rateRows)
        : null;
      const cost2026 = perYear[2026]
        ? computeYearCost(perYear[2026], 2026, rateRows)
        : null;

      let diffAnnual = 0;
      let diffLabel = "No data";
      let diffColor = "text-gray-700";
      let diffIcon = "fa-minus";
      if (cost2025 && cost2026) {
        diffAnnual = cost2026.totalAnnual - cost2025.totalAnnual;
        if (diffAnnual > 0) {
          diffLabel = "Yearly cost increase";
          diffColor = "text-red-600";
          diffIcon = "fa-arrow-up";
        } else if (diffAnnual < 0) {
          diffLabel = "Yearly cost decrease";
          diffColor = "text-green-600";
          diffIcon = "fa-arrow-down";
        } else {
          diffLabel = "No change compared to prior year";
          diffColor = "text-gray-700";
          diffIcon = "fa-minus";
        }
      } else {
        diffLabel = "Partial data only";
      }

      let changeType = "No comparison";
      if (perYear[2025] && perYear[2026]) {
        const changedMed =
          perYear[2025].medical_plan !== perYear[2026].medical_plan;
        const changedTier =
          perYear[2025].tier_election !== perYear[2026].tier_election;
        if (changedMed || changedTier || diffAnnual !== 0) {
          if (diffAnnual > 0) changeType = "Upgraded / higher cost";
          else if (diffAnnual < 0) changeType = "Downgraded / lower cost";
          else changeType = "Changed plans (cost-neutral)";
        } else {
          changeType = "Same plan and tier";
        }
      }

      const yearCard = (year, enrollment, cost) => {
        if (!enrollment || !cost) {
          return `
            <div class="border border-gray-200 rounded-lg px-4 py-4 text-left text-xs text-gray-500">
              <p class="font-semibold text-gray-700 mb-1">${year}</p>
              <p>No elections on file.</p>
            </div>
          `;
        }
        return `
          <div class="border border-gray-200 rounded-lg px-4 py-4 text-left text-xs space-y-2">
            <p class="font-semibold text-gray-800 mb-1">${year}</p>
            <p class="text-[11px] text-gray-500 uppercase tracking-[0.18em]">
              Tier: ${escapeHtml(enrollment.tier_election || "")}
            </p>
            <div class="grid grid-cols-1 sm:grid-cols-3 gap-2">
              <div>
                <p class="text-[11px] text-gray-500 uppercase tracking-[0.14em]">Medical</p>
                <p class="text-gray-800">${escapeHtml(
                  enrollment.medical_plan || "Waived"
                )}</p>
                <p class="text-[11px] text-gray-500 mt-1">Bi-weekly: ${formatCurrency(
                  cost.medical
                )}</p>
              </div>
              <div>
                <p class="text-[11px] text-gray-500 uppercase tracking-[0.14em]">Dental</p>
                <p class="text-gray-800">${escapeHtml(
                  enrollment.dental_plan || "Waived"
                )}</p>
                <p class="text-[11px] text-gray-500 mt-1">Bi-weekly: ${formatCurrency(
                  cost.dental
                )}</p>
              </div>
              <div>
                <p class="text-[11px] text-gray-500 uppercase tracking-[0.14em]">Vision</p>
                <p class="text-gray-800">${escapeHtml(
                  enrollment.vision_plan || "Waived"
                )}</p>
                <p class="text-[11px] text-gray-500 mt-1">Bi-weekly: ${formatCurrency(
                  cost.vision
                )}</p>
              </div>
            </div>
            <div class="mt-2 flex items-baseline gap-2">
              <p class="text-[11px] text-gray-500 uppercase tracking-[0.14em]">Total</p>
              <p class="font-semibold text-gray-900">${formatCurrency(
                cost.totalBiWeekly
              )} bi-weekly</p>
              <p class="text-[11px] text-gray-500">(${formatCurrency(
                cost.totalAnnual
              )} annual)</p>
            </div>
            <div class="mt-2">
              <div class="w-full bg-gray-100 rounded-full h-2 flex overflow-hidden">
                <div class="h-2 bg-[var(--jc-red)]" style="width:${cost.pctMedical}%;"></div>
                <div class="h-2 bg-[var(--jc-blue)]" style="width:${cost.pctDental}%;"></div>
                <div class="h-2 bg-gray-400" style="width:${cost.pctVision}%;"></div>
              </div>
              <div class="flex justify-between mt-1 text-[10px] text-gray-500">
                <span><span class="inline-block w-2 h-2 bg-[var(--jc-red)] mr-1"></span>Medical</span>
                <span><span class="inline-block w-2 h-2 bg-[var(--jc-blue)] mr-1"></span>Dental</span>
                <span><span class="inline-block w-2 h-2 bg-gray-400 mr-1"></span>Vision</span>
              </div>
            </div>
          </div>
        `;
      };

      benefitDetailContainer.innerHTML = `
        <div class="text-left space-y-4 text-xs">
          <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
            <div>
              <p class="text-[11px] uppercase tracking-[0.18em] text-gray-400">
                Employee
              </p>
              <p class="text-sm font-semibold text-gray-900">
                ${escapeHtml(username)}
              </p>
            </div>
            <div class="text-right">
              <p class="text-[11px] uppercase tracking-[0.18em] text-gray-400">
                Yearly cost difference
              </p>
              <p class="text-sm font-semibold ${diffColor} flex items-center justify-end gap-2">
                <i class="fa-solid ${diffIcon}"></i>
                <span>${formatCurrency(Math.abs(diffAnnual))}</span>
              </p>
              <p class="text-[11px] text-gray-500 mt-1">${escapeHtml(
                diffLabel
              )}</p>
            </div>
          </div>

          <div class="grid gap-3 md:grid-cols-2">
            ${yearCard(2025, perYear[2025], cost2025)}
            ${yearCard(2026, perYear[2026], cost2026)}
          </div>

          <div class="border border-gray-200 rounded-lg px-4 py-3 bg-gray-50 flex items-center justify-between">
            <div class="text-[11px] text-gray-600">
              <p class="font-semibold text-gray-800">Change summary</p>
              <p class="mt-1">${escapeHtml(changeType)}</p>
            </div>
          </div>
        </div>
      `;
    } catch (err) {
      console.error("Unexpected error in loadEmployeeBenefitDetail:", err);
      benefitDetailContainer.innerHTML =
        '<div class="text-xs text-red-500">Error loading employee benefit data.</div>';
    }
  }

  function computeYearCost(enrollment, year, rateRows) {
    const tier = enrollment.tier_election;
    const med = findRate(rateRows, year, enrollment.medical_plan, tier, "medical");
    const den = findRate(rateRows, year, enrollment.dental_plan, tier, "dental");
    const vis = findRate(rateRows, year, enrollment.vision_plan, tier, "vision");

    const totalBiWeekly = med + den + vis;
    const totalAnnual = totalBiWeekly * 26;

    const denom = totalBiWeekly || 1;
    return {
      medical: med,
      dental: den,
      vision: vis,
      totalBiWeekly,
      totalAnnual,
      pctMedical: Math.round((med / denom) * 100),
      pctDental: Math.round((den / denom) * 100),
      pctVision: Math.max(
        0,
        100 - Math.round((med / denom) * 100) - Math.round((den / denom) * 100)
      ),
    };
  }

  function findRate(rateRows, year, planCode, tier, coverageType) {
    if (!planCode || planCode.toUpperCase() === "WAIVE") return 0;
    const row = rateRows.find(
      (r) =>
        String(r.effective_year) === String(year) &&
        r.plan_code === planCode &&
        r.tier === tier &&
        (r.coverage || "").toLowerCase() === coverageType.toLowerCase()
    );
    return row ? parseFloat(row.amount || 0) : 0;
  }

  // ==============================
  // USERS + ACCESS LOGS
  // ==============================
  async function loadUsers() {
    const { data, error } = await supabase
      .from("portal_users")
      .select("*")
      .order("full_name", { ascending: true });

    if (error) {
      console.error("Error loading portal_users:", error);
      usersTableBody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-red-500 text-xs">Error loading users.</td></tr>';
      return;
    }

    usersCache = data || [];
    if (!usersCache.length) {
      usersTableBody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-400 text-xs">No users found.</td></tr>';
      return;
    }

    usersTableBody.innerHTML = "";
    usersCache.forEach((u) => {
      const roleLabel = u.role === "admin" ? "Administrator" : "Standard User";
      const activeBadge = u.active
        ? '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-green-50 text-green-700 text-[10px] border border-green-200">Active</span>'
        : '<span class="inline-flex items-center px-2 py-0.5 rounded-full bg-gray-50 text-gray-500 text-[10px] border border-gray-200">Inactive</span>';
      const lastLogin = u.last_login ? formatDateTime(u.last_login) : "—";

      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.dataset.id = u.id;
      tr.innerHTML = `
        <td class="px-4 py-2 text-xs text-gray-900">${escapeHtml(
          u.full_name || ""
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          u.initials || ""
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          roleLabel
        )}</td>
        <td class="px-4 py-2 text-xs">${activeBadge}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          lastLogin
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600">
          <button
            type="button"
            class="text-[var(--jc-blue)] hover:underline mr-2"
            data-action="edit-user"
          >
            Edit
          </button>
        </td>
      `;
      usersTableBody.appendChild(tr);
    });
  }

  function subscribeAccessLogs() {
    if (accessLogChannel) return;
    accessLogChannel = supabase
      .channel("portal_logs_stream")
      .on(
        "postgres_changes",
        { schema: "public", table: "portal_logs", event: "*" },
        () => {
          loadAccessLogs();
        }
      )
      .subscribe((status) => {
        if (status === "SUBSCRIBED") {
          console.log("Subscribed to portal_logs changes.");
        }
      });
  }

  function unsubscribeAccessLogs() {
    if (accessLogChannel) {
      supabase.removeChannel(accessLogChannel);
      accessLogChannel = null;
    }
  }

  async function loadAccessLogs() {
    const { data, error } = await supabase
      .from("portal_logs")
      .select(
        `
        id,
        login_time,
        logout_time,
        duration_minutes,
        employee_id,
        employees2025:employee_id ( first_name, last_name, username )
      `
      )
      .order("login_time", { ascending: false })
      .limit(50);

    if (error) {
      console.error("Error loading portal_logs:", error);
      accessLogsTableBody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-red-500 text-xs">Error loading access logs.</td></tr>';
      return;
    }

    const rows = data || [];
    if (!rows.length) {
      accessLogsTableBody.innerHTML =
        '<tr><td colspan="6" class="px-4 py-4 text-center text-gray-400 text-xs">No access logs recorded yet.</td></tr>';
      return;
    }

    accessLogsTableBody.innerHTML = "";
    rows.forEach((log) => {
      const emp = log.employees2025 || {};
      const fullName = `${emp.last_name || ""}, ${emp.first_name || ""}`.trim();
      const loginTime = formatDateTime(log.login_time);
      const lastActivity = formatDateTime(log.logout_time || log.login_time);

      let status = "Unknown";
      let statusClass = "bg-gray-50 text-gray-500 border-gray-200";
      let durationDisplay = "—";
      if (typeof log.duration_minutes === "number") {
        if (log.duration_minutes === -1) {
          status = "Ended unexpectedly";
          statusClass = "bg-yellow-50 text-yellow-700 border-yellow-200";
        } else {
          status = "Completed";
          statusClass = "bg-green-50 text-green-700 border-green-200";
          durationDisplay = `${log.duration_minutes} min`;
        }
      } else if (!log.logout_time) {
        if (currentUser && currentUser.log_id === log.id) {
          status = "Active";
          statusClass = "bg-blue-50 text-blue-700 border-blue-200";
          durationDisplay = "Active";
        } else {
          status = "Ended unexpectedly";
          statusClass = "bg-yellow-50 text-yellow-700 border-yellow-200";
        }
      }

      let tabsVisited = "—";
      if (currentUser && currentUser.log_id === log.id && currentSessionTabs.size) {
        tabsVisited = Array.from(currentSessionTabs).join(", ");
      }

      const statusBadge = `
        <span class="inline-flex items-center px-2 py-0.5 rounded-full text-[10px] border ${statusClass}">
          ${escapeHtml(status)}
        </span>
      `;

      const tr = document.createElement("tr");
      tr.className = "hover:bg-gray-50";
      tr.innerHTML = `
        <td class="px-4 py-2 text-xs text-gray-900">
          ${escapeHtml(fullName || emp.username || "N/A")}
        </td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(loginTime)}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          lastActivity
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          durationDisplay
        )}</td>
        <td class="px-4 py-2 text-xs text-gray-600">${escapeHtml(
          tabsVisited
        )}</td>
        <td class="px-4 py-2 text-xs">${statusBadge}</td>
      `;
      accessLogsTableBody.appendChild(tr);
    });
  }

  // ==============================
  // USER MODAL
  // ==============================
  function openUserModal(user) {
    editingUserId = user ? user.id : null;
    userModalTitle.textContent = user ? "Edit User" : "Add User";
    userFullNameInput.value = user?.full_name || "";
    userInitialsInput.value = user?.initials || "";
    userPinInput.value = user?.pin || "";
    userRoleSelect.value = user?.role || "admin";
    userActiveCheckbox.checked = user ? !!user.active : true;

    // protect root user (PG) from deactivation / role change
    const isRoot = user && user.initials === "PG";
    userInitialsInput.disabled = isRoot;
    userRoleSelect.disabled = isRoot;
    userActiveCheckbox.disabled = isRoot;

    userModalOverlay.classList.remove("hidden");
  }

  function closeUserModal() {
    userModalOverlay.classList.add("hidden");
  }

  async function saveUserFromModal() {
    const fullName = userFullNameInput.value.trim();
    const initials = userInitialsInput.value.trim().toUpperCase();
    const pin = userPinInput.value.trim();
    const role = userRoleSelect.value;
    const active = userActiveCheckbox.checked;

    if (!fullName || !initials || !pin) {
      showToast("Full Name, Initials, and PIN are required.", "error");
      return;
    }
    if (!/^\d{6}$/.test(pin)) {
      showToast("PIN must be exactly 6 digits.", "error");
      return;
    }

    try {
      showSpinner(editingUserId ? "Updating user…" : "Creating user…");

      if (editingUserId) {
        const { error } = await supabase
          .from("portal_users")
          .update({
            full_name: fullName,
            role,
            active,
            pin,
            // initials is protected for root; for others we allow change:
            ...(userInitialsInput.disabled ? {} : { initials }),
          })
          .eq("id", editingUserId);

        if (error) {
          console.error("Error updating portal_users:", error);
          showToast("Failed to update user.", "error");
        } else {
          showToast("User updated successfully.", "success");
        }
      } else {
        const { error } = await supabase.from("portal_users").insert([
          {
            full_name: fullName,
            initials,
            pin,
            role,
            active,
          },
        ]);
        if (error) {
          console.error("Error inserting portal_users:", error);
          showToast("Failed to create user.", "error");
        } else {
          showToast("User created successfully.", "success");
        }
      }

      closeUserModal();
      await loadUsers();
    } catch (err) {
      console.error("Unexpected error saving user:", err);
      showToast("Unexpected error saving user.", "error");
    } finally {
      hideSpinner();
    }
  }

  // ==============================
  // PRINT & MERGE
  // ==============================
  function handlePrintAll() {
    if (!signedEmployees.length) {
      showToast("No signed documents available to print.", "warning");
      return;
    }
    signedEmployees.forEach((e) => {
      if (e.signed_pdf_url) {
        window.open(e.signed_pdf_url, "_blank");
      }
    });
    showToast(
      `Opened ${signedEmployees.length} PDF(s) in new tabs for printing.`,
      "info"
    );
  }

  async function handleMergeDownloadAll() {
    if (!signedEmployees.length) {
      showToast("No signed documents available to merge.", "warning");
      return;
    }

    const employeeIds = signedEmployees.map((e) => e.id);
    try {
      showSpinner("Generating combined PDF…");
      const res = await fetch(
        `${SUPABASE_URL}/functions/v1/merge-signed-pdfs`,
        {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            apikey: SUPABASE_KEY,
            Authorization: `Bearer ${SUPABASE_KEY}`,
          },
          body: JSON.stringify({ employee_ids: employeeIds }),
        }
      );

      if (!res.ok) {
        const txt = await res.text();
        console.error("merge-signed-pdfs error:", txt);
        showToast(
          "Error generating combined PDF (check Edge function deployment).",
          "error"
        );
        return;
      }

      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = "jengchi_signed_benefits_all.pdf";
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);

      showToast(
        "Combined PDF downloaded. Open it to review or print all pages.",
        "success"
      );
    } catch (err) {
      console.error("Unexpected merge error:", err);
      showToast("Unexpected error generating combined PDF.", "error");
    } finally {
      hideSpinner();
    }
  }

  // ==============================
  // TAB SWITCHING
  // ==============================
  function setActiveTab(tabId) {
    const tabMap = {
      signedDocs: {
        button: tabSignedDocs,
        section: sectionSignedDocs,
        label: "Signed Documents",
      },
      benefitSummary: {
        button: tabBenefitSummary,
        section: sectionBenefitSummary,
        label: "Benefit Summary",
      },
      users: {
        button: tabUsers,
        section: sectionUsers,
        label: "Authorized Users & Portal Credentials",
      },
    };

    Object.entries(tabMap).forEach(([key, { button, section }]) => {
      if (!button) return;
      if (key === tabId) {
        button.classList.add("tab-active");
        button.classList.remove("border-transparent");
        section.classList.remove("hidden");
        markTabVisited(tabMap[key].label);
      } else {
        button.classList.remove("tab-active");
        section.classList.add("hidden");
      }
    });

    // Refresh logs so "Tabs Visited" can show current session quickly
    if (tabId === "users" && isAdmin()) {
      loadAccessLogs();
    }
  }

  // ==============================
  // SHOW DASHBOARD AFTER LOGIN
  // ==============================
  async function showDashboardAfterLogin() {
    loginScreen.classList.add("hidden");
    dashboard.classList.remove("hidden");

    loggedInUserLabel.textContent = currentUser.full_name || currentUser.initials;

    // Role-based visibility
    if (isAdmin()) {
      tabBenefitSummary.classList.remove("hidden");
      tabUsers.classList.remove("hidden");
      subscribeAccessLogs();
      loadUsers();
      loadBenefitSummaryAggregates();
      loadAccessLogs();
    } else {
      tabBenefitSummary.classList.add("hidden");
      tabUsers.classList.add("hidden");
    }

    currentSessionTabs.clear();
    markTabVisited("Signed Documents");
    setActiveTab("signedDocs");
    loadSignedEmployees();
  }

  // ==============================
  // EVENT WIRES
  // ==============================

  // Toggle PIN visibility
  togglePinVisibility.addEventListener("click", () => {
    if (pinInput.type === "password") {
      pinInput.type = "text";
      togglePinVisibility.innerHTML = '<i class="fa-solid fa-eye-slash"></i>';
    } else {
      pinInput.type = "password";
      togglePinVisibility.innerHTML = '<i class="fa-solid fa-eye"></i>';
    }
  });

  // Login submit
  loginForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    loginError.classList.add("hidden");
    const initials = initialsInput.value.trim().toUpperCase();
    const pin = pinInput.value.trim();

    if (!initials || !pin) {
      loginError.classList.remove("hidden");
      loginError.textContent = "Invalid credentials";
      showToast("Invalid credentials", "error");
      return;
    }

    try {
      showSpinner("Verifying credentials…");
      const user = await findPortalUser(initials);
      if (!user || String(user.pin) !== pin) {
        loginError.classList.remove("hidden");
        loginError.textContent = "Invalid credentials";
        showToast("Invalid credentials", "error");
        return;
      }

      // Successful login
      currentUser = {
        id: user.id,
        full_name: user.full_name,
        initials: user.initials,
        role: user.role || "user",
        active: user.active,
        log_id: null,
        loginTime: new Date(),
      };
      sessionStorage.setItem("auth_user", JSON.stringify(currentUser));

      await updateLastLogin(user.id);
      await createLoginLog(user.initials);

      showToast("Login successful", "success");
      await showDashboardAfterLogin();
    } catch (err) {
      console.error("Login error:", err);
      loginError.classList.remove("hidden");
      loginError.textContent = "Invalid credentials";
      showToast("Invalid credentials", "error");
    } finally {
      hideSpinner();
    }
  });

  // Logout
  logoutButton.addEventListener("click", async () => {
    const confirmed = confirm(
      "You are still logged in. Please log out properly.\n\nClick OK to log out now."
    );
    if (!confirmed) return;
    await logoutAndCloseSession(true);
  });

  // Signed docs search
  docSearchInput.addEventListener("input", () => {
    const val = docSearchInput.value;
    renderSignedDocsTable(val);
    renderDocSuggestions(val);
  });

  document.addEventListener("click", (e) => {
    if (
      !docSuggestions.contains(e.target) &&
      e.target !== docSearchInput
    ) {
      docSuggestions.classList.add("hidden");
    }
    if (
      !benefitEmployeeSuggestions.contains(e.target) &&
      e.target !== benefitEmployeeSearch
    ) {
      benefitEmployeeSuggestions.classList.add("hidden");
    }
  });

  // Signed docs table print buttons
  docsTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='print']");
    if (!btn) return;
    const url = btn.dataset.url;
    if (url) {
      window.open(url, "_blank");
      showToast("Opened PDF in a new tab for printing.", "info");
    }
  });

  // Print / Merge buttons
  btnPrintAll.addEventListener("click", handlePrintAll);
  btnMergeDownloadAll.addEventListener("click", handleMergeDownloadAll);

  // Tab buttons
  tabSignedDocs.addEventListener("click", () => setActiveTab("signedDocs"));
  tabBenefitSummary.addEventListener("click", () => {
    if (!isAdmin()) return;
    setActiveTab("benefitSummary");
  });
  tabUsers.addEventListener("click", () => {
    if (!isAdmin()) return;
    setActiveTab("users");
  });

  // Benefit employee search
  benefitEmployeeSearch.addEventListener("input", () => {
    const term = benefitEmployeeSearch.value.trim().toLowerCase();
    if (!term) {
      benefitEmployeeSuggestions.classList.add("hidden");
      benefitEmployeeSuggestions.innerHTML = "";
      return;
    }
    const matches = signedEmployees
      .filter(
        (e) =>
          (e.last_name || "").toLowerCase().startsWith(term) ||
          (e.username || "").toLowerCase().startsWith(term)
      )
      .slice(0, 10);

    if (!matches.length) {
      benefitEmployeeSuggestions.classList.add("hidden");
      benefitEmployeeSuggestions.innerHTML = "";
      return;
    }

    benefitEmployeeSuggestions.innerHTML = "";
    matches.forEach((e) => {
      const name = `${e.last_name || ""}, ${e.first_name || ""} (${e.username})`;
      const item = document.createElement("button");
      item.type = "button";
      item.className =
        "w-full text-left px-3 py-1.5 hover:bg-gray-50 text-gray-700";
      item.textContent = name;
      item.dataset.username = e.username;
      item.addEventListener("click", () => {
        benefitEmployeeSearch.value = `${e.last_name || ""}, ${
          e.first_name || ""
        }`;
        benefitEmployeeSuggestions.classList.add("hidden");
        loadEmployeeBenefitDetail(e.username);
      });
      benefitEmployeeSuggestions.appendChild(item);
    });
    benefitEmployeeSuggestions.classList.remove("hidden");
  });

  // Users: open modal
  btnAddUser.addEventListener("click", () => openUserModal(null));

  // Users: edit button
  usersTableBody.addEventListener("click", (e) => {
    const btn = e.target.closest("button[data-action='edit-user']");
    if (!btn) return;
    const row = btn.closest("tr");
    const id = Number(row?.dataset.id);
    const user = usersCache.find((u) => u.id === id);
    if (user) openUserModal(user);
  });

  // Modal actions
  btnCancelUser.addEventListener("click", () => closeUserModal());
  btnSaveUser.addEventListener("click", () => saveUserFromModal());

  // ==============================
  // SESSION RESTORE
  // ==============================
  (async function restoreSessionIfAny() {
    const stored = sessionStorage.getItem("auth_user");
    if (!stored) return;

    try {
      const parsed = JSON.parse(stored);
      if (!parsed || !parsed.initials) return;
      currentUser = parsed;
      currentUser.loginTime = new Date(); // best guess for restored session
      showSpinner("Restoring session…");
      await showDashboardAfterLogin();
      hideSpinner();
    } catch (err) {
      console.error("Error restoring session:", err);
      sessionStorage.removeItem("auth_user");
      hideSpinner();
    }
  })();
</script>
</body>
</html>
