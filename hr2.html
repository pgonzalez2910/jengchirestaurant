<!-- FIXED FILE â€“ PART 1/5: DOCTYPE, HEAD, HEADER, NAVIGATION -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Discipline â€¢ Compliance â€¢ Corrective Action Management</title>

  <!-- Google Fonts: Inter + Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />
  <!-- Tailwind Configuration (must come before CDN script) -->






  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      corePlugins: {
        container: false,
      },
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            heading: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xs': ['0.96rem', { lineHeight: '1.5' }],
            'sm': ['1.12rem', { lineHeight: '1.5' }],
            'base': ['1.28rem', { lineHeight: '1.6' }],
            'lg': ['1.44rem', { lineHeight: '1.6' }],
            'xl': ['1.6rem', { lineHeight: '1.6' }],
            '2xl': ['1.92rem', { lineHeight: '1.4' }],
            '3xl': ['2.4rem', { lineHeight: '1.3' }],
          },
          colors: {
            brand: {
              50: '#f1f8ff',
              100: '#e0f0ff',
              200: '#b9ddff',
              300: '#80c3ff',
              400: '#4aa7f5',
              500: '#1d8fe3',
              600: '#136fbc',
              700: '#0b5694',
              800: '#083b66',
              900: '#062847',
            },
          },
          boxShadow: {
            subtle: '0 10px 25px rgba(15, 23, 42, 0.06)',
          },
        },
      },
    };
  </script>

  

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<script src="https://maps.googleapis.com/maps/api/js?key=YOUR_API_KEY&libraries=places"></script>

<!-- FREE Address Autocomplete - LocationIQ (10,000 requests/day free) -->
<script src="https://api.locationiq.com/v1/autocomplete?key=pk.2f6c0f8b8f8e8e8e8e8e8e8e8e8e8e8e&tag=address&limit=5&countrycodes=us"></script>


<!-- Supabase JS v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

<!-- Mapbox GL JS -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />






<script>
  // ============================================================
  // SUPABASE CLIENT (GLOBAL)
  // ============================================================
  (function initSupabaseClient() {
    if (!window.supabase || typeof window.supabase.createClient !== 'function') {
      console.error('âŒ Supabase library not loaded');
      return;
    }

    if (window.supabaseClient && typeof window.supabaseClient.from === 'function') {
      console.log('âœ… Supabase client already initialized');
      return;
    }

    window.supabaseClient = window.supabase.createClient(
      'https://kpldzwlftkvjjntgsqxx.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3MzQ5NzYyNjMsImV4cCI6MjA1MDU1MjI2M30.VEO-J7lwwVzm85p2eEYwFGcI4PHiPX_wZ1zKqKMwqgM'
    );

    console.log('âœ… Supabase client ready');
  })();
</script>



<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  
<!-- Font Awesome 6.6.0 -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">

<!-- STEP 1: Load Chart.js FIRST -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- STEP 2: Load DataLabels Plugin ONCE (after Chart.js) -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>

<!-- SheetJS Library for Excel file reading -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>




  <!-- Custom CSS -->
  <style>



    #tab-policy {
  margin-top: -1rem !important;
}


/* ============================================
   POLICY TAB - REMOVE TOP PADDING/MARGIN
   ============================================ */

/* Remove top spacing specifically for policy tab */
#tab-policy {
  margin-top: -1.5rem !important;
  padding-top: 0 !important;
}

/* Also reduce spacing in the policy tab content */
#tab-policy > div:first-child {
  margin-top: 0 !important;
  padding-top: 0 !important;
}

/* Remove space-y gap for policy tab */
#tab-policy.space-y-6 > * + * {
  margin-top: 1rem !important;
}

#tab-policy.space-y-6 > *:first-child {
  margin-top: 0 !important;
}



@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}



/* Signature canvas must accept touch + mouse */
.sig-canvas {
  touch-action: none;
  cursor: crosshair;
}




@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}
.animate-slideUp {
  animation: slideUp 0.3s ease-out;
}


/* Timeline animations */
@keyframes slideInFromLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

#employee-discipline-timeline > div {
  animation: slideInFromLeft 0.3s ease-out forwards;
}

#employee-discipline-timeline > div:nth-child(1) { animation-delay: 0.1s; }
#employee-discipline-timeline > div:nth-child(2) { animation-delay: 0.2s; }
#employee-discipline-timeline > div:nth-child(3) { animation-delay: 0.3s; }
#employee-discipline-timeline > div:nth-child(4) { animation-delay: 0.4s; }
#employee-discipline-timeline > div:nth-child(5) { animation-delay: 0.5s; }

/* Timeline item hover effect */
#employee-discipline-timeline > div:hover {
  transform: translateX(4px);
  transition: transform 0.2s ease;
}

/* Smooth height transitions */
#employee-discipline-timeline {
  transition: height 0.3s ease;
}

/* Fix address dropdown styling */
#address-suggestions-dropdown {
  background: white !important;
  border: 1px solid #cbd5e1 !important;
  box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1) !important;
}

#address-suggestions-dropdown > div {
  background: white !important;
  border: none !important;
  border-bottom: 1px solid #f1f5f9 !important;
}

#address-suggestions-dropdown > div:hover {
  background: #f8fafc !important;
}

#address-suggestions-dropdown > div:last-child {
  border-bottom: none !important;
}





/* ============================================
   SPACING FIX - Add this to your <style> section
   ============================================ */

/* Remove all top spacing between header and content */
header {
  margin-bottom: 0 !important;
  padding-bottom: 0 !important;
}

main {
  margin-top: 0 !important;
  padding-top: 1rem !important;  /* Minimal top padding */
}

#app-root {
  padding-top: 0 !important;
  margin-top: 0 !important;
}

body {
  margin: 0 !important;
  padding: 0 !important;
}

/* Fix toast positioning */
#global-toast-inner {
  margin-top: 4rem !important;  /* Reduced from mt-20 */
}




    #comp-letter-preview-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.25);
      border-color: #0284c7;
      background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
    }

    #comp-letter-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25);
      border-color: #059669;
      background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
    }

    #comp-letter-preview-btn:active,
    #comp-letter-save-btn:active {
      transform: translateY(0px);
    }





  /* ===== SCROLLBAR STYLES ===== */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 9999px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #a5b4fc;
  }

  /* ===== MAKE ALL IMPORTANT TEXT BOLD ===== */
  
  /* Navigation tabs */
  .tab-trigger span,
  nav button span,
  nav a span {
    font-weight: 700 !important;
  }

  /* All uppercase labels (KPIs, section headers) */
  .uppercase,
  .uppercase.tracking-wide {
    font-weight: 700 !important;
  }

  /* Table headers */
  th,
  thead th,
  thead tr th {
    font-weight: 700 !important;
    color: #475569 !important;
  }

  /* Section titles and subtitles */
  h1, h2, h3, h4, h5, h6 {
    font-weight: 700 !important;
  }

  /* Subtitle text and descriptions */
  p.text-xs.text-slate-500,
  p.text-sm.text-slate-500 {
    font-weight: 600 !important;
  }

  /* Form labels */
  label {
    font-weight: 700 !important;
  }

  /* Filter chips and buttons */
  .policy-filter-chip,
  .employee-filter-chip,
  button[data-policy-category],
  button[data-employee-filter] {
    font-weight: 700 !important;
  }

  /* All button text */
  button {
    font-weight: 700 !important;
  }

  /* Badge and chip text */
  .rounded-full {
    font-weight: 700 !important;
  }

  /* Card titles */
  .font-heading {
    font-weight: 700 !important;
  }

  /* KPI values */
  .text-2xl,
  .text-xl,
  .text-lg {
    font-weight: 700 !important;
  }

  /* Table cell labels in Permission matrix */
  td {
    font-weight: 600 !important;
  }

  /* Specific for "Feature / Tab" and similar headers */
  .font-bold,
  [class*="font-bold"] {
    font-weight: 700 !important;
  }

  /* Make all span elements inside headers bold */
  h1 span, h2 span, h3 span, h4 span, h5 span, h6 span {
    font-weight: 700 !important;
  }

  /* Policy library button text */
  .inline-flex.items-center.gap-1,
  .inline-flex.items-center.gap-2 {
    font-weight: 700 !important;
  }

  /* Section descriptions that appear under titles */
  .text-xs.text-slate-500.mt-1,
  .text-xs.text-slate-600 {
    font-weight: 600 !important;
  }

  /* ===== TIMELINE STYLES ===== */
  .timeline-line {
    position: absolute;
    left: 1.25rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #bfdbfe, #1d8fe3);
    opacity: 0.75;
  }

  /* ===== PRINT STYLES ===== */
  @media print {
    .no-print {
      display: none !important;
    }
  }



/* Responsive header adjustments */
@media (max-width: 768px) {
  header h1 span {
    font-size: 0.75rem !important;
    line-height: 1.2;
  }
  
  header h1 i {
    font-size: 0.75rem !important;
  }
  
  header p {
    font-size: 0.65rem !important;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  header h1 span {
    font-size: 0.9rem !important;
  }
}

/* Ensure navigation wraps properly on smaller screens */
@media (max-width: 1280px) {
  nav.flex {
    flex-wrap: wrap;
  }
}
/* Professional Tab Hover Effects */
.tab-trigger {
  transition: all 0.2s ease-in-out;
}

.tab-trigger:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.tab-trigger.active {
  background: linear-gradient(135deg, #7a1f1f 0%, #991b1b 100%);
  border-color: #7a1f1f;
  box-shadow: 0 4px 12px rgba(122, 31, 31, 0.3);
}

/* Professional Font Stack */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Enhanced Header Shadow */
header {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Professional HR Badge Pulse Effect */
@keyframes subtle-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(122, 31, 31, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(122, 31, 31, 0);
  }
}

header .rounded-full:hover {
  animation: subtle-pulse 2s infinite;
}


/* ğŸ” TEMPORARY DEBUG BORDERS */
.dashboard-grid-cell {
  border: 2px solid red !important;
  min-height: 300px;
}

@media print {
  [style*="display: grid"] {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
  }
}

:root {
  --font-xs: 9px;      /* was 6.5px */
  --font-sm: 11px;     /* was 8px */
  --font-base: 13px;   /* was 10px */
  --font-md: 14px;     /* was 11px */
  --font-lg: 16px;     /* was 12px */
  --font-xl: 18px;     /* was 14px */
  --font-2xl: 22px;    /* was 16px */
  --font-3xl: 26px;    /* was 20px */
}




</style>
</head>

<body class="h-full bg-slate-50 text-slate-900 font-sans" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">

  <!-- Root App Container -->
  <div id="app-root" class="min-h-screen flex flex-col" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">
  <!-- Top Navigation / Header -->


<!-- PROFESSIONAL ENTERPRISE HEADER - UPGRADED VERSION -->

<header class="no-print bg-white shadow-lg border-b-2 border-slate-200">
  <div class="w-full px-4 md:px-6 lg:px-8" style="max-width: 100% !important;">

    <!-- Top Row: Logo â€¢ Title â€¢ User Badge -->
    <div class="grid grid-cols-[auto_1fr_auto] items-center justify-items-start gap-4 md:gap-6 lg:gap-8 py-4 md:py-5">
      
      <!-- LEFT: Logo -->
      <div class="flex items-center justify-start">
    <!-- âœ… Logo: No border, no shadow -->
<img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
     alt="Jeng Chi Restaurant Logo"
     class="h-20 md:h-24 lg:h-28 w-auto rounded-xl object-contain">
      </div>

   <!-- CENTER: Title + Subtitle (TRUE CENTER) -->
<div class="flex flex-col items-center justify-center text-center gap-2 pl-4 pr-2">
  <h1 class="flex items-center justify-center gap-3 font-heading text-base sm:text-lg md:text-xl lg:text-2xl tracking-tight text-slate-900 font-black">
    <i class="fa-solid fa-shield-halved text-brand-600 text-lg md:text-xl lg:text-3xl drop-shadow-sm"></i>
    <span class="whitespace-nowrap">Discipline â€¢ Compliance â€¢ Corrective Action Management</span>
  </h1>
        
        <!-- Subtitle with Building Icon -->
        <p class="flex items-center justify-center gap-2 text-xs sm:text-sm md:text-base text-slate-700 font-semibold">
    <i class="fa-solid fa-building text-brand-500 text-xs md:text-sm"></i>
    <span class="hidden sm:inline">Jeng Chi Restaurant â€” Internal HR Discipline, Compliance, and Risk Governance Portal</span>
    <span class="sm:hidden">Jeng Chi Restaurant â€” HR Portal</span>
  </p>
</div>

      </div>
    </div>

    <!-- Desktop Navigation Tabs - PROFESSIONAL VERSION -->

    <div class="no-print hidden md:flex items-center justify-center py-3 border-t border-slate-200 relative">
      <!-- Centered Navigation -->
      <nav class="flex items-center gap-2 lg:gap-3 text-sm font-bold" aria-label="Primary navigation">
       
       
 <!-- âœ… Modern Tab Buttons â€” No Red, No Dark, Fully Visible -->
<nav class="flex flex-wrap items-center gap-2 lg:gap-3 text-sm font-semibold" aria-label="Primary navigation">
  <!-- Dashboard Tab -->
  <button data-tab-target="dashboard" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-chart-line text-base"></i>
    <span>Dashboard</span>
  </button>

        
        <!-- Discipline Cases Tab -->
  <button data-tab-target="discipline" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-gavel text-base"></i>
    <span>Discipline Cases</span>
  </button>

  <!-- Employees 360 Tab -->
  <button data-tab-target="employees" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-users text-base"></i>
    <span>Employees 360</span>
  </button>

  <!-- Employees Grid Tab -->
  <button data-tab-target="employees-grid" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-table-list text-base"></i>
    <span>Employees Grid</span>
  </button>

  <!-- Policy Library Tab -->
  <button data-tab-target="policy" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-scale-balanced text-base"></i>
    <span>Policy Library</span>
  </button>



  


<!-- Hourly Compensation Letter Tab -->
<button data-tab-target="compensation-letter" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
  <i class="fa-solid fa-file-invoice-dollar text-base"></i>
  <span>Compensation Letter</span>
</button>


<!-- Advanced Form Tab -->
<button data-tab-target="advanced-form" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
  <i class="fa-solid fa-money-bill-wave text-base"></i>
  <span>Advanced Form</span>
</button>




<!-- Admin & Settings Tab -->
  <button data-tab-target="admin" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-gear text-base"></i>
    <span>Admin & Settings</span>
  </button>



  <!-- Permissions Tab -->
  <button data-tab-target="permissions" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-shield-halved text-base"></i>
    <span>Permissions</span>
  </button>
</nav>






      <!-- Timestamp - Professional Badge Style -->
      <!-- âœ… Fixed: Timestamp inside right container, no overlap -->
      <!-- âœ… Keep this: Right-side HR badge + Timestamp -->
<div class="flex items-center gap-3">
  <!-- HR Badge (next step) -->
  <div class="flex items-center justify-center rounded-full bg-white text-slate-900 w-12 h-12 font-heading text-lg font-black border-2 border-slate-300">
    HR
  </div>
  <!-- Timestamp -->
  <div class="hidden lg:flex items-center gap-2 bg-slate-100 border border-slate-300 rounded-lg px-3 py-1 text-xs font-bold text-slate-700">
    <i class="fa-regular fa-clock text-brand-600"></i>
    <span>Last refreshed:</span>
    <span id="header-last-refreshed" class="text-brand-700">--</span>
  </div>
</div>




    <!-- Mobile Navigation Tabs -->
    <div class="no-print md:hidden border-t border-slate-200 py-3">
      <div class="flex items-center justify-between gap-2">
        <label for="mobile-tab-select" class="text-xs font-black text-slate-700 uppercase tracking-wide">
          <i class="fa-solid fa-bars mr-1"></i>
          Navigate
        </label>
        <select
          id="mobile-tab-select"
          class="flex-1 text-xs font-bold rounded-lg border-2 border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
        >
          <option value="dashboard">ğŸ“Š Dashboard</option>
          <option value="discipline">âš–ï¸ Discipline Cases</option>
          <option value="employees">ğŸ‘¥ Employees 360</option>
          <option value="policy">ğŸ“‹ Policy Library</option>
          <option value="compensation-letter">ğŸ’µ Compensation Letter</option>
           <option value="advanced-form">ğŸ’° Advanced Form</option>
          <option value="admin">âš™ï¸ Admin &amp; Settings</option>
          <option value="permissions">ğŸ›¡ï¸ Permissions</option>
        </select>
      </div>
    </div>
  </div>
</header>



 <!-- Toast Notification Container - REQUIRED FOR showToast() -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Toast / Status Banner -->
    <!-- Toast / Status Banner -->
    <div
      id="global-toast"
      class="no-print fixed z-40 inset-x-0 top-0 flex justify-center pointer-events-none opacity-0 transition-opacity duration-300"
      aria-live="polite"
    >
      <div
        id="global-toast-inner"
        class="mt-20 max-w-xl w-full mx-4 flex items-start gap-3 rounded-2xl border border-emerald-100 bg-white shadow-subtle px-4 py-3 text-sm text-emerald-800 pointer-events-auto"
      >
        <div class="mt-0.5">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p id="global-toast-message" class="font-medium truncate">
            Action saved successfully.
          </p>
          <p id="global-toast-subtext" class="text-xs text-emerald-700 mt-0.5">
            Employee record updated in employees2025 and risk scoring recalculated.
          </p>
        </div>
        <button
          type="button"
          id="global-toast-close"
          class="ml-2 text-xs text-emerald-600 hover:text-emerald-800"
        >
          Close
        </button>
      </div>
    </div>








   <!-- Main Content -->

<!-- âœ… DASHBOARD TAB â€” CORPORATE, CONSOLIDATED, CHART-ENABLED -->
<section id="tab-dashboard" class="tab-panel hidden space-y-6">

  <!-- ğŸ“Š GLOBAL FILTER BAR -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-4">
      <label class="text-xs font-medium text-slate-500 uppercase tracking-wide">Time Range:</label>
      <select id="global-date-filter" class="rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium">
        <option value="all-time">All Time</option>
        <option value="last-30">Last 30 Days</option>
        <option value="last-60">Last 60 Days</option>
        <option value="last-90">Last 90 Days</option>
        <option value="ytd">Year to Date</option>
        <option value="custom">Custom Range...</option>
      </select>
      <div id="custom-date-range" class="hidden flex items-center gap-2">
        <input type="date" id="custom-start-date" class="rounded border border-slate-300 px-2 py-1 text-sm">
        <span class="text-slate-500">to</span>
        <input type="date" id="custom-end-date" class="rounded border border-slate-300 px-2 py-1 text-sm">
      </div>
    </div>
    <button id="dashboard-refresh" class="inline-flex items-center gap-2 rounded-lg bg-brand-500 text-white px-4 py-2 text-sm font-bold hover:bg-brand-600 transition">
      <i class="fa-solid fa-rotate-right"></i> Refresh Data
    </button>
  </div>

  <!-- ğŸ”¢ KPI CARDS ROW -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
    <!-- Active -->
    <div class="bg-white rounded-lg border border-emerald-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-emerald-700 uppercase tracking-wide">Active</p>
          <p id="kpi-active-employees" class="mt-1 font-heading text-2xl font-bold text-emerald-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center">
          <i class="fa-solid fa-user-check text-emerald-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- Inactive -->
    <div class="bg-white rounded-lg border border-amber-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-amber-700 uppercase tracking-wide">Inactive</p>
          <p id="kpi-inactive-employees" class="mt-1 font-heading text-2xl font-bold text-amber-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-amber-100 flex items-center justify-center">
          <i class="fa-solid fa-user-slash text-amber-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- High-Risk -->
    <div class="bg-white rounded-lg border border-rose-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-rose-700 uppercase tracking-wide">High-Risk</p>
          <p id="kpi-high-risk-employees" class="mt-1 font-heading text-2xl font-bold text-rose-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-rose-100 flex items-center justify-center">
          <i class="fa-solid fa-fire-flame-curved text-rose-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- FOH Disciplines -->
    <div class="bg-white rounded-lg border border-cyan-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-cyan-700 uppercase tracking-wide">FOH Actions</p>
          <p id="kpi-foh-total-disciplines" class="mt-1 font-heading text-2xl font-bold text-cyan-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-cyan-100 flex items-center justify-center">
          <i class="fa-solid fa-utensils text-cyan-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- BOH Disciplines -->
    <div class="bg-white rounded-lg border border-orange-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-orange-700 uppercase tracking-wide">BOH Actions</p>
          <p id="kpi-boh-total-disciplines" class="mt-1 font-heading text-2xl font-bold text-orange-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-orange-100 flex items-center justify-center">
          <i class="fa-solid fa-fire-burner text-orange-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- Termination Rate -->
    <div class="bg-white rounded-lg border border-slate-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Term. Rate</p>
          <p id="kpi-termination-rate" class="mt-1 font-heading text-2xl font-bold text-slate-900">--%</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center">
          <i class="fa-solid fa-user-xmark text-slate-600 text-sm"></i>
        </div>
      </div>
    </div>
  </div>

  

  
<!-- ğŸ“Š DASHBOARD GRID - 4x4 LAYOUT WITH ALL ICONS -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x1: BOH POSITION DISTRIBUTION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x1: BOH POSITION DISTRIBUTION (WITH UNICODE ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-industry text-brand-600"></i> BOH Position Distribution
  </h3>
  <div class="space-y-1 text-xs overflow-y-auto" style="max-height: 280px;">
    <!-- Line Cook - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook" class="font-bold">0</span></div>
    <!-- Wok Chef - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef" class="font-bold">0</span></div>
    <!-- Dumpling Maker - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker" class="font-bold">0</span></div>
    <!-- Busser - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser" class="font-bold">0</span></div>
    <!-- Prep Cook - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook" class="font-bold">0</span></div>
    <!-- Pastry Chef - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef" class="font-bold">0</span></div>
    <!-- Dishwasher - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher" class="font-bold">0</span></div>
    <!-- Production Manager - Unicode Icon -->
    <!-- Fryer - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-amber-700">ğŸŸ Fryer:</span><span id="kpi-fryer" class="font-bold">0</span></div>
    <div class="flex justify-between"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager" class="font-bold">0</span></div>
    <!-- Logistic Coordinator - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator" class="font-bold">0</span></div>
  </div>
  <div class="mt-3 pt-3 border-t border-slate-200 text-xs font-bold">
    Total BOH: <span id="kpi-boh-total" class="text-indigo-800">0</span>
  </div>
</div>


  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x2: FOH POSITION DISTRIBUTION (UNCHANGED â€” already good) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-utensils text-brand-600"></i> FOH Position Distribution
    </h3>
    <div class="space-y-1 text-xs overflow-y-auto" style="max-height: 280px;">
      <div class="flex justify-between"><span class="font-medium text-emerald-700"><i class="fa-solid fa-user-tie mr-2"></i>FOH Manager:</span><span id="kpi-foh-manager" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-teal-700"><i class="fa-solid fa-wine-glass mr-2"></i>Server:</span><span id="kpi-server" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-purple-700"><i class="fa-solid fa-cocktail mr-2"></i>Bartender:</span><span id="kpi-bartender" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-cyan-700"><i class="fa-solid fa-door-open mr-2"></i>Host:</span><span id="kpi-host" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-green-700"><i class="fa-solid fa-money-bill-wave mr-2"></i>Cashier:</span><span id="kpi-cashier" class="font-bold">0</span></div>
    </div>
    <div class="mt-3 pt-3 border-t border-slate-200 text-xs font-bold">
      Total FOH: <span id="kpi-foh-total" class="text-emerald-800">0</span>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x3: FOH DISCIPLINE BY POSITION -->
 <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x3: FOH DISCIPLINE BY POSITION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-gavel text-brand-600"></i> FOH Discipline by Position
  </h3>
  <div class="text-xs space-y-2 overflow-y-auto" style="max-height: 280px;">
    <div class="flex justify-between items-center"><span class="font-medium text-emerald-700">ğŸ‘¨â€ğŸ’¼ FOH Manager:</span><span id="kpi-foh-manager-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-teal-700">ğŸ· Server:</span><span id="kpi-server-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-purple-700">ğŸ¸ Bartender:</span><span id="kpi-bartender-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-cyan-700">ğŸšª Host:</span><span id="kpi-host-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-green-700">ğŸ’° Cashier:</span><span id="kpi-cashier-discipline" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x4: BOH DISCIPLINE BY POSITION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x4: BOH DISCIPLINE BY POSITION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-gavel text-brand-600"></i> BOH Discipline by Position
  </h3>
  <div class="text-xs space-y-2 overflow-y-auto" style="max-height: 280px;">
    <div class="flex justify-between items-center"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸŸ Fryer:</span><span id="kpi-fryer-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator-discipline" class="font-bold">0</span></div>
  </div>
</div>
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x1: Disciplinary Actions by Job Title CHART -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-id-badge text-brand-600"></i> Disciplinary Actions by Job Title
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-job-title"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x2: FOH & BOH Employee Status Bar Chart -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 2x2: FOH & BOH Employee Status (Bar Chart) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-users text-brand-600"></i> FOH & BOH Employee Status
  </h3>
  <div style="height: 240px; min-height: 240px;">
    <canvas id="chart-employee-status-foh-boh"></canvas>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x3: Discipline Actions by Type (FOH) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-gavel text-brand-600"></i> Discipline Actions by Type (FOH)
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-type-foh"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x4: Discipline Actions by Type (BOH) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-gavel text-brand-600"></i> Discipline Actions by Type (BOH)
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-type-boh"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x1: Recent Disciplinary Actions Table -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-clock-rotate-left text-brand-600"></i> Recent Disciplinary Actions
    </h3>
    <div class="overflow-x-auto max-h-64">
      <table class="w-full text-xs">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-2 py-1 text-left font-bold">Date</th>
            <th class="px-2 py-1 text-left font-bold">Employee</th>
            <th class="px-2 py-1 text-left font-bold">Type</th>
          </tr>
        </thead>
        <tbody id="dashboard-discipline-table-body" class="text-slate-700 divide-y divide-slate-100">
          <!-- populated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x2: High-Risk FOH Department -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 3x2: High-Risk (FOH) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-fire-flame-curved text-rose-600"></i> High-Risk (FOH)
  </h3>
  <div class="text-xs space-y-2">
    <div class="flex justify-between items-center"><span class="font-medium text-emerald-700">ğŸ‘¨â€ğŸ’¼ FOH Manager:</span><span id="kpi-foh-manager-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-teal-700">ğŸ· Server:</span><span id="kpi-server-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-purple-700">ğŸ¸ Bartender:</span><span id="kpi-bartender-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-cyan-700">ğŸšª Host:</span><span id="kpi-host-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-green-700">ğŸ’° Cashier:</span><span id="kpi-cashier-high-risk" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 3x3: High-Risk (BOH) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-fire-flame-curved text-rose-600"></i> High-Risk (BOH)
  </h3>
  <div class="text-xs space-y-2">
    <div class="flex justify-between items-center"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸŸ Fryer:</span><span id="kpi-fryer-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator-high-risk" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x4: Employee Compensation Summary -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-money-bill-wave text-brand-600"></i> Employee Compensation
    </h3>
    <div class="text-xs space-y-2">
      <div class="flex justify-between items-center">
        <span>Total Employees on Salary:</span>
        <span id="kpi-salary-count" class="font-bold">0</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Total Employees on Hourly Wage:</span>
        <span id="kpi-hourly-count" class="font-bold">0</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Average Hourly Rate:</span>
        <span id="kpi-average-hourly-rate" class="font-bold">$0.00</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Average Annual Salary:</span>
        <span id="kpi-average-annual-salary" class="font-bold">$0.00</span>
      </div>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x1: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  

  <!-- ğŸ’¼ PAYROLL ADVANCE SUMMARY - CORPORATE STYLE -->
<div class="bg-white rounded-lg shadow border border-slate-200 p-5">
  <div class="flex items-center justify-between mb-4">
    <div>
      <h3 class="text-base font-semibold text-slate-800 flex items-center gap-2">
        <i class="fa-solid fa-chart-line text-blue-600 text-sm"></i>
        Payroll Advance Overview
      </h3>
      <p class="text-xs text-slate-500 mt-0.5">Employee advance summary and documentation</p>
    </div>
    <button 
      onclick="loadPayrollAdvanceDashboard()" 
      class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-blue-600 text-white rounded text-xs font-medium hover:bg-blue-700 transition">
      <i class="fa-solid fa-rotate-right text-xs"></i> Refresh
    </button>
  </div>

  <div class="w-full">
    <table class="w-full text-sm">
      <thead class="bg-slate-50 border-b border-slate-200">
        <tr>
          <th class="px-2 py-2 text-left text-xs font-semibold text-slate-700">Employee</th>
          <th class="px-2 py-2 text-center text-xs font-semibold text-slate-700 w-16">âœ“</th>
          <th class="px-2 py-2 text-center text-xs font-semibold text-slate-700 w-16">âœ—</th>
          <th class="px-2 py-2 text-center text-xs font-semibold text-slate-700 w-20">Used</th>
          <th class="px-2 py-2 text-right text-xs font-semibold text-slate-700 w-24">Balance</th>
          <th class="px-2 py-2 text-center text-xs font-semibold text-slate-700 w-28">Actions</th>
        </tr>
      </thead>
      <tbody id="payroll-advance-dashboard-body" class="divide-y divide-slate-100">
        <tr>
          <td colspan="6" class="px-2 py-6 text-center text-slate-400">
            <i class="fa-solid fa-spinner fa-spin text-lg mb-1"></i>
            <p class="text-xs">Loading...</p>
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x2: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 4x2: INACTIVE / LEAVE / TERMINATED EMPLOYEES -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
<h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
<i class="fa-solid fa-user-clock text-brand-600"></i> Inactive / On Leave / Terminated
</h3>
<p class="text-xs text-slate-500 mb-3">Review employees who are not currently active.</p>

<!-- Tabs for filtering -->
<div class="flex border-b border-slate-200 mb-3">
<button type="button" data-filter="inactive" class="px-4 py-2 text-xs font-bold border-b-2 border-blue-500 text-blue-700 bg-blue-50">
Inactive
</button>
<button type="button" data-filter="on-leave" class="px-4 py-2 text-xs font-bold border-b-2 border-transparent text-slate-600 hover:bg-slate-50">
On Leave
</button>
<button type="button" data-filter="terminated" class="px-4 py-2 text-xs font-bold border-b-2 border-transparent text-slate-600 hover:bg-slate-50">
Terminated
</button>
</div>

<!-- Content Area -->
<div id="inactive-employees-content" class="space-y-4">
<!-- Will be populated by JavaScript -->
</div>
</div>

 <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 4x3: Termination Rate by Department -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-file-circle-xmark text-rose-600"></i> Termination Rate (Dept)
  </h3>
  <div class="space-y-2">
    <div class="flex justify-between items-center">
      <span class="text-xs font-medium text-teal-700">ğŸ‘¨â€ğŸ’¼ FOH</span>
      <span id="kpi-termination-rate-foh" class="text-lg font-black text-teal-700">--%</span>
    </div>
    <div class="flex justify-between items-center">
      <span class="text-xs font-medium text-amber-700">ğŸ‘¨â€ğŸ³ BOH</span>
      <span id="kpi-termination-rate-boh" class="text-lg font-black text-amber-700">--%</span>
    </div>
  </div>
  <p class="text-[0.70rem] text-slate-500 mt-2">
    % of terminated vs total (non-owners)
  </p>
</div>



  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x4: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex items-center justify-center">
    <p class="text-xs text-slate-500">Cell 4x4 - Coming Soon</p>
  </div>

</div>




</section>


 <!-- ============================================================ -->
<!-- ENTERPRISE EMPLOYEE GRID â€” PROFESSIONAL DESIGN -->
<!-- ============================================================ -->
<section id="tab-employees-grid" class="tab-panel hidden space-y-6">
  
  <!-- Header & Controls -->
  <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-700">
    <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
      
      <!-- Title -->
      <div class="flex items-center gap-3">
        <div class="bg-brand-500 rounded-xl p-3 shadow-lg">
          <i class="fa-solid fa-users text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-black text-white tracking-tight">Enterprise Employee Grid</h2>
          <p class="text-slate-400 text-sm font-semibold mt-0.5">Comprehensive workforce management & real-time editing</p>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex items-center gap-3">
        <div class="relative">
          <i class="fa-solid fa-filter absolute left-3 top-1/2 -translate-y-1/2 text-slate-400 text-sm"></i>
          <select id="employee-grid-filter-status" 
                  class="appearance-none rounded-xl border-2 border-slate-600 bg-slate-700 text-white pl-10 pr-10 py-3 text-sm font-bold hover:border-brand-400 focus:outline-none focus:ring-2 focus:ring-brand-500 transition-all cursor-pointer">
            <option value="all">All Statuses</option>
            <option value="Active">âœ“ Active</option>
            <option value="On Leave">â¸ On Leave</option>
            <option value="Terminated">âŠ— Terminated</option>
            <option value="Resigned">â†’ Resigned</option>
          </select>
          <i class="fa-solid fa-chevron-down absolute right-3 top-1/2 -translate-y-1/2 text-slate-400 text-xs pointer-events-none"></i>
        </div>

        <button id="employee-grid-refresh" 
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 text-white px-5 py-3 text-sm font-black shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200">
          <i class="fa-solid fa-arrows-rotate"></i>
          <span>Refresh Data</span>
        </button>
      </div>



        <!-- Import Button -->
        <input type="file" id="employee-file-input" accept=".xlsx,.xls" class="hidden">
        <button onclick="document.getElementById('employee-file-input').click()"
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-green-500 to-green-600 text-white px-5 py-3 text-sm font-black shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200">
          <i class="fa-solid fa-file-import"></i>
          <span>Import New Employees</span>
        </button>

    </div>
  </div>

<!-- Import Results Log -->
  <div id="import-log" class="hidden bg-white rounded-2xl shadow-xl border border-slate-200 p-6">
    <div class="flex items-center gap-2 mb-4">
      <i class="fa-solid fa-list-check text-blue-600 text-xl"></i>
      <h3 class="text-lg font-bold text-slate-900">Import Results</h3>
    </div>
    <div id="import-log-content" class="text-sm space-y-1 max-h-64 overflow-y-auto"></div>
  </div>


  <!-- Grid Container -->
  <div class="bg-white rounded-2xl shadow-2xl border border-slate-200 overflow-hidden">
    
    <!-- Table Wrapper -->
    <div class="overflow-x-auto">
      <table class="min-w-full divide-y divide-slate-200">



        
        <!-- Table Header -->
        <!-- Table Header -->
<!-- ============================================================ -->
<!-- REPLACE THE TABLE HEADER (lines 1244-1313) WITH THIS -->
<!-- ============================================================ -->
<!-- ============================================================ -->
<!-- UPDATED TABLE HEADER WITH USERNAME AND PIN COLUMNS -->
<!-- REPLACE lines 1244-1313 -->
<!-- ============================================================ -->

<thead class="bg-gradient-to-r from-slate-50 to-slate-100 border-b-2 border-slate-300">
  <tr>
    <!-- Status -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-circle-check text-emerald-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Status</span>
      </div>
    </th>
    
    <!-- Last Name -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-user text-indigo-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Last Name</span>
        <button id="sort-by-lastname-btn" 
                class="ml-1 text-xs bg-indigo-100 hover:bg-indigo-200 text-indigo-700 font-bold px-1.5 py-0.5 rounded transition-all"
                title="Sort A-Z">
          <i class="fa-solid fa-arrow-down-a-z text-xs"></i>
        </button>
      </div>
    </th>
    
    <!-- First Name -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-user text-indigo-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">First Name</span>
      </div>
    </th>

    <!-- Username -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-at text-indigo-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Username</span>
      </div>
    </th>

    <!-- PIN -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-lock text-rose-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">PIN</span>
      </div>
    </th>
    
    <!-- Hire Date -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-calendar-check text-teal-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Hire Date</span>
      </div>
    </th>
    
 
    
    <!-- Job Title -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-briefcase text-blue-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Job Title</span>
      </div>
    </th>
    
    <!-- Department -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-building text-purple-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Department</span>
      </div>
    </th>
    
  
    
    <!-- Phone -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-phone text-green-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Phone</span>
      </div>
    </th>
    
    <!-- Email -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-envelope text-cyan-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Email</span>
      </div>
    </th>
    
    <!-- Edit -->
    <th class="px-3 py-3 text-left">
      <div class="flex items-center gap-1.5">
        <i class="fa-solid fa-money-check-dollar text-emerald-600 text-sm"></i>
        <span class="text-xs font-black text-slate-700 uppercase tracking-wider">Edit</span>
      </div>
    </th>
  </tr>
</thead>



        <!-- Table Body -->
        <tbody id="employee-grid-body" class="divide-y divide-slate-100 bg-white">
          <!-- Populated by JavaScript -->
        </tbody>

      </table>
    </div>

    <!-- Loading State -->
    <div id="employee-grid-loading" class="hidden py-16 text-center">
      <div class="inline-flex flex-col items-center gap-4">
        <div class="relative">
          <div class="w-16 h-16 border-4 border-slate-200 border-t-brand-500 rounded-full animate-spin"></div>
          <i class="fa-solid fa-users absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 text-brand-500 text-xl"></i>
        </div>
        <p class="text-slate-600 font-bold text-sm">Loading employee data...</p>
      </div>
    </div>

    <!-- Empty State -->
    <div id="employee-grid-empty" class="hidden py-16 text-center">
      <div class="inline-flex flex-col items-center gap-4">
        <div class="w-20 h-20 rounded-full bg-slate-100 flex items-center justify-center">
          <i class="fa-solid fa-users-slash text-slate-400 text-3xl"></i>
        </div>
        <div>
          <p class="text-slate-700 font-bold text-base mb-1">No employees found</p>
          <p class="text-slate-500 text-sm">Try adjusting your filters or refresh the data</p>
        </div>
      </div>
    </div>

  </div>

</section>















<section id="tab-compensation-letter" class="tab-panel hidden space-y-6">

 <!-- ğŸ” EMPLOYEE SEARCH SECTION -->
  <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
    <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
      <i class="fa-solid fa-magnifying-glass text-brand-600"></i>
      Search Employee for Compensation Letter
    </h3>
    <p class="text-xs text-slate-500 mb-4 font-semibold">
      Search and select an employee to pre-fill their current compensation details
    </p>

    <!-- Search Input with Autocomplete -->
    <div class="relative mb-4">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fa-solid fa-search text-slate-400"></i>
      </div>
      <input
        id="comp-letter-search"
        type="text"
        placeholder="Type employee name or ID (2+ letters)..."
        class="w-full pl-10 pr-3 py-3 rounded-xl border-2 border-slate-300 bg-slate-50 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all"
        autocomplete="off"
      />
      <!-- Autocomplete Dropdown -->
      <div
        id="comp-letter-search-dropdown"
        class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-slate-200 rounded-xl shadow-xl max-h-80 overflow-y-auto"
      ></div>
    </div>

    <!-- Selected Employee Info (Hidden until employee selected) -->
    <div id="comp-letter-employee-info" class="hidden bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200">
      <h4 class="text-sm font-black text-emerald-900 mb-3 flex items-center gap-2">
        <i class="fa-solid fa-user-check text-emerald-600"></i>
        Selected Employee
      </h4>
      <div class="grid grid-cols-3 gap-3 text-xs">
        <div>
          <p class="text-emerald-600 font-bold mb-1">Name</p>
          <p id="comp-letter-employee-name" class="font-black text-emerald-900">--</p>
        </div>
        <div>
          <p class="text-emerald-600 font-bold mb-1">Employee ID</p>
          <p id="comp-letter-employee-id" class="font-black text-emerald-900">--</p>
        </div>
        <div>
          <p class="text-emerald-600 font-bold mb-1">Department</p>
          <p id="comp-letter-employee-dept" class="font-black text-emerald-900">--</p>
        </div>
      </div>

























<!-- ğŸ’¾ CLEAN FLOATING SAVE BUTTON (FAB Style) -->
<div id="comp-letter-sticky-save" class="hidden fixed bottom-8 right-8 z-50">
  <button type="button" 
          id="sticky-comp-letter-save-btn"
          class="group relative bg-emerald-600 hover:bg-emerald-700 text-white rounded-full shadow-2xl hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-save text-2xl"></i>
    
    <!-- Tooltip -->
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Save to Database
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
</div>



        <!-- ğŸ’¾ CLEAN FLOATING SAVE BUTTON (FAB Style) -->
<div id="comp-letter-sticky-save" class="hidden fixed bottom-8 right-8 z-50 flex flex-col space-y-3">
  
  <!-- SAVE BUTTON -->
  <button type="button" 
          id="sticky-comp-letter-save-btn"
          class="group relative bg-emerald-600 hover:bg-emerald-700 text-white rounded-full shadow-2xl hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-save text-2xl"></i>
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Save to Database
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
  
  <!-- PREVIEW BUTTON (hidden until saved) -->
  <button type="button" 
          id="sticky-comp-letter-preview-btn"
          class="hidden group relative bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-2xl hover:shadow-blue-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-file-pdf text-2xl"></i>
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Preview Letter
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
  
</div>




      <!-- Current Positions & Rates -->
      <div class="mt-4 pt-4 border-t-2 border-emerald-200">
        <h5 class="text-xs font-black text-emerald-900 mb-2">Current Positions & Rates:</h5>
        <div id="comp-letter-current-positions" class="space-y-2">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

 




<!-- ============================================================================ -->
<!-- ENHANCED COMPENSATION FORM - FULL BENEFITS PACKAGE -->
<!-- ============================================================================ -->
<form id="comp-letter-form" class="space-y-6">
  <input type="hidden" id="comp-letter-selected-employee-id" />
  
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 1: EMPLOYEE CLASSIFICATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
    <h4 class="text-sm font-black text-blue-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-user-clock"></i>
      Employee Classification
    </h4>
    
    <div class="grid grid-cols-2 gap-4">
      <!-- Full Time / Part Time -->
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Employment Type <span class="text-rose-500">*</span>
        </label>
       <select id="comp-letter-employment-type" ...>
  <option value="PT">Part-Time (< 30 hours/week)</option>
  <option value="FT" selected>Full-Time (30+ hours/week)</option>
</select>
      </div>
      
      <!-- Hire Date -->
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Hire Date <span class="text-rose-500">*</span>
        </label>
        <input type="date" id="comp-letter-hire-date" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
      </div>
    </div>
  </div>



  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 2: POSITION & FINANCIAL COMPENSATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200">
    <h4 class="text-sm font-black text-emerald-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-briefcase"></i>
      Position & Financial Compensation
    </h4>
    
    <!-- ============================================ -->
    <!-- PRIMARY JOB -->
    <!-- ============================================ -->
    <div class="bg-white rounded-lg p-4 mb-4 border-2 border-emerald-400">
      <h5 class="text-xs font-black text-emerald-900 uppercase mb-3 flex items-center gap-2">
        <i class="fa-solid fa-star text-emerald-600"></i>
        Primary Job
      </h5>
      
      <div class="grid grid-cols-3 gap-4">
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Job Title <span class="text-rose-500">*</span>
          </label>
          <input type="text" 
                 id="primary-job-title" 
                 required 
                 class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                 placeholder="e.g., Server" />
        </div>
        
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Department <span class="text-rose-500">*</span>
          </label>
          <select id="primary-department" 
                  required 
                  class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="">Select...</option>
            <option value="FOH">FOH</option>
            <option value="BOH">BOH</option>
          </select>
        </div>
        
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            <span id="primary-wage-label">Hourly Wage</span> <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="primary-wage" 
                   step="0.01" 
                   min="0" 
                   required
               
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                   placeholder="0.00" />
          </div>
        </div>
      </div>
    </div>


<!-- SECONDARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<div id="secondary-job-section" class="bg-white rounded-lg p-4 mb-4 border-2 border-gray-300">
  <h5 class="text-xs font-black text-gray-700 uppercase mb-3 flex items-center gap-2">
    <i class="fa-solid fa-briefcase text-gray-600"></i>
    <span>Secondary Job (Optional)</span>
  </h5>
  <div class="grid grid-cols-3 gap-4">
    <div>
      <label for="secondary-job-title" class="block text-xs font-black text-slate-700 mb-2">
        Job Title
      </label>
      <input type="text" 
             id="secondary-job-title" 
             class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
             placeholder="e.g., Bartender" />
    </div>
    <div>
      <label for="secondary-department" class="block text-xs font-black text-slate-700 mb-2">
        Department
      </label>
      <select id="secondary-department" 
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500">
        <option value="">Select...</option>
        <option value="FOH">FOH</option>
        <option value="BOH">BOH</option>
      </select>
    </div>
    <div>
      <label for="secondary-wage" class="block text-xs font-black text-slate-700 mb-2 flex items-center justify-between">
        <span>Hourly Wage</span>
       <!-- âœ… TOGGLE: Enable/Disable Secondary Job -->
<label class="inline-flex items-center cursor-pointer">
  <input type="checkbox" id="secondary-job-enabled" checked class="sr-only peer">
  <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
  <span class="ml-2 text-xs font-bold text-slate-700">Enable</span>
</label>
      </label>
      <div class="relative">
        <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
        <input type="number" 
               id="secondary-wage" 
               step="0.01" 
               min="0"
               class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
               placeholder="0.00" />
      </div>
    </div>
  </div>
</div>



<!-- TERTIARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<!-- ============================================ -->
<!-- TERTIARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<div id="tertiary-job-section" class="bg-white rounded-lg p-4 mb-4 border-2 border-gray-300">
  <h5 class="text-xs font-black text-gray-700 uppercase mb-3 flex items-center gap-2">
    <i class="fa-solid fa-briefcase text-gray-600"></i>
    <span>Tertiary Job (Optional)</span>
  </h5>
  <div class="grid grid-cols-3 gap-4">
    <div>
      <label for="tertiary-job-title" class="block text-xs font-black text-slate-700 mb-2">
        Job Title
      </label>
      <input type="text" 
             id="tertiary-job-title" 
             class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
             placeholder="e.g., Host" />
    </div>
    <div>
      <label for="tertiary-department" class="block text-xs font-black text-slate-700 mb-2">
        Department
      </label>
      <select id="tertiary-department" 
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500">
        <option value="">Select...</option>
        <option value="FOH">FOH</option>
        <option value="BOH">BOH</option>
      </select>
    </div>
    <div>
      <label for="tertiary-wage" class="block text-xs font-black text-slate-700 mb-2 flex items-center justify-between">
        <span>Hourly Wage</span>
       <!-- âœ… TOGGLE: Enable/Disable Tertiary Job -->
<label class="inline-flex items-center cursor-pointer">
  <input type="checkbox" id="tertiary-job-enabled" checked class="sr-only peer">
  <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
  <span class="ml-2 text-xs font-bold text-slate-700">Enable</span>
</label>
      </label>
      <div class="relative">
        <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
        <input type="number" 
               id="tertiary-wage" 
               step="0.01" 
               min="0"
               class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
               placeholder="0.00" />
      </div>
    </div>
  </div>
</div>

    <!-- ============================================ -->
    <!-- ADDITIONAL COMPENSATION -->
    <!-- ============================================ -->
    <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
      <h5 class="text-xs font-black text-blue-900 uppercase mb-3 flex items-center gap-2">
        <i class="fa-solid fa-coins text-blue-600"></i>
        Additional Compensation
      </h5>
      
      <div class="grid grid-cols-2 gap-4">
        
        <!-- TRAINING PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Training Pay <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-training-pay" 
                   step="0.01" 
                   min="0" 
                   required 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- MEETING PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Meeting Hourly Pay <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-meeting-pay" 
                   step="0.01" 
                   min="0" 
                   required 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-purple-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- VACATION PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Vacation Pay (if qualified)
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-vacation-pay" 
                   step="0.01" 
                   min="0" 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-teal-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- OVERTIME PAY (DISABLED) -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            <i class="fa-solid fa-calculator"></i> Overtime Hourly Pay (Auto-calculated at 1.5x)
          </label>
          <div id="comp-letter-overtime-display" class="text-2xl font-black text-amber-900 bg-amber-50 rounded-lg p-3 border border-amber-200 text-center">
            --
          </div>
          <input type="hidden" id="comp-letter-overtime-pay" />
          <p class="text-xs text-amber-700 mt-1 font-bold" id="overtime-calculation-note">
            Will show 1.5x or BLENDED
          </p>
        </div>
        
      </div>
    </div>
    
  </div>









  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 3: TIP POOL CONFIGURATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div id="comp-letter-tip-section" class="hidden bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-200">
    <h4 class="text-sm font-black text-purple-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-money-bill-wave"></i>
      Tip Pool & Financial Responsibilities
    </h4>
    
    <!-- Included in Tip Pool (Busser, Bartender, Host, Cashier) -->
    <div id="comp-letter-tip-pool-option" class="hidden mb-4">
      <label class="flex items-center gap-3 cursor-pointer">
        <input type="checkbox" id="comp-letter-included-in-tip-pool" checked disabled class="w-5 h-5 rounded border-2 border-purple-300 text-purple-600 focus:ring-purple-500" />
        <span class="text-sm font-bold text-purple-900">
          <i class="fa-solid fa-check-circle text-purple-600"></i>
          Included in Tip Pool (Auto-set for this position)
        </span>
      </label>
    </div>
    
    <!-- Server-Specific: Tip to House Pool -->
    <div id="comp-letter-server-tips" class="hidden space-y-3">

   
<div id="tip-display" class="text-sm font-mono mt-2 px-3 py-1.5 bg-gray-50 rounded border border-gray-200"></div>


      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Tip to House Pool (%)
        </label>
        <div class="relative">
          <input type="number" id="comp-letter-tip-to-house" step="0.01" min="0" max="100" value="4.00" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
          <span class="absolute right-3 top-2.5 text-slate-500 font-bold">%</span>
        </div>
      </div>
      
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Tip Back Merchant Services (%)
        </label>
        <div class="relative">
          <input type="number" id="comp-letter-merchant-services" step="0.01" min="0" max="100" value="3.00" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
          <span class="absolute right-3 top-2.5 text-slate-500 font-bold">%</span>
        </div>
      </div>
    </div>
  </div>
<div id="tip-display" class="mt-2 px-2 py-1 bg-gray-50 rounded text-sm"></div>
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 4: CHANGE TRACKING -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-xs font-black text-slate-700 uppercase mb-2">
        Payroll Effective Date <span class="text-rose-500">*</span>
      </label>
      <input type="date" id="comp-letter-effective-date" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
    </div>
    
    <div>
      <label class="block text-xs font-black text-slate-700 uppercase mb-2">
        Change Type <span class="text-rose-500">*</span>
      </label>
      <select id="comp-letter-change-type" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
        <option value="">Select...</option>
        <option value="new_hire">New Hire</option>
        <option value="promotion">Promotion</option>
        <option value="merit_increase">Merit Increase</option>
        <option value="position_change">Position Change</option>
        <option value="cost_of_living">Cost of Living Adjustment</option>
        <option value="market_adjustment">Market Adjustment</option>
        <option value="other">Other</option>
      </select>
    </div>
  </div>

  <div>
    <label class="block text-xs font-black text-slate-700 uppercase mb-2">
      Reason for Change
    </label>
    <textarea id="comp-letter-change-reason" rows="3" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="Brief explanation..."></textarea>
  </div>

  <div>
    <label class="block text-xs font-black text-slate-700 uppercase mb-2">
      Approved By
    </label>
    <input type="text" id="comp-letter-approved-by" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="Manager/HR name" />
  </div>




<!-- ================= SIGNATURES (BEFORE WAGE & POSITION HISTORY) ================= -->
<div class="bg-white border border-slate-200 rounded-xl p-5 mt-6">
  <div class="flex items-center justify-between mb-4">
    <h3 class="text-base font-black text-slate-900 flex items-center gap-2">
      <i class="fa-solid fa-signature text-slate-700"></i>
      Signatures for This Compensation Letter
    </h3>
    <p class="text-xs text-slate-500 font-semibold">
      Saved per Effective Date (supports multiple letters per employee)
    </p>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-3 gap-4">




  <!-- EMPLOYEE SIGNATURE -->
<div class="border border-slate-200 rounded-xl p-3">
  <div class="flex items-center justify-between mb-2">
    <div class="text-xs font-black text-slate-700">EMPLOYEE SIGNATURE</div>
    <button type="button" id="comp-sig-emp-clear"
      class="text-xs font-bold px-2 py-1 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200">
      Clear
    </button>
  </div>

  <!-- ğŸ”½ ADD THIS INPUT HERE -->
  <input
    id="comp-sig-emp-name"
    class="w-full mb-2 px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold bg-slate-50"
    readonly
  />

  <canvas id="comp-sig-emp"
    class="w-full rounded-lg border border-slate-200 bg-white"
    style="height:120px; touch-action:none;">
  </canvas>

  <input type="hidden" id="comp-sig-emp-dataurl" />
</div>






    <!-- MANAGER -->
    <div class="border border-slate-200 rounded-xl p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-black text-slate-700">MANAGER SIGNATURE</div>
        <button type="button" id="comp-sig-mgr-clear"
          class="text-xs font-bold px-2 py-1 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200">
          Clear
        </button>
      </div>
      <input id="comp-sig-mgr-name" placeholder="Manager name (optional)"
        class="w-full mb-2 px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold" />
      <canvas id="comp-sig-mgr" class="w-full rounded-lg border border-slate-200 bg-white"
        style="height: 120px; touch-action: none;"></canvas>
      <input type="hidden" id="comp-sig-mgr-dataurl" />
      <div class="mt-2 text-[0.70rem] text-slate-500 font-semibold">Sign with mouse / finger.</div>
    </div>

    <!-- HR -->
    <div class="border border-slate-200 rounded-xl p-3">
      <div class="flex items-center justify-between mb-2">
        <div class="text-xs font-black text-slate-700">HR SIGNATURE</div>
        <button type="button" id="comp-sig-hr-clear"
          class="text-xs font-bold px-2 py-1 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200">
          Clear
        </button>
      </div>
      <input id="comp-sig-hr-name" placeholder="HR name (optional)"
        class="w-full mb-2 px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold" />
      <canvas id="comp-sig-hr" class="w-full rounded-lg border border-slate-200 bg-white"
        style="height: 120px; touch-action: none;"></canvas>
      <input type="hidden" id="comp-sig-hr-dataurl" />
      <div class="mt-2 text-[0.70rem] text-slate-500 font-semibold">Sign with mouse / finger.</div>
    </div>
  </div>
</div>









<!-- âœ… ACTION BUTTONS - MUST BE INSIDE THE FORM -->
<div class="flex gap-4 pt-6 px-6 pb-6">
  
  <!-- PREVIEW BUTTON -->
  <button type="button" id="comp-letter-preview-btn" 
          style="flex: 1; 
                 display: flex; 
                 flex-direction: column; 
                 align-items: center; 
                 justify-content: center; 
                 gap: 12px; 
                 padding: 28px; 
                 background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); 
                 color: #0f172a; 
                 border: 2px solid #0ea5e9; 
                 border-radius: 16px; 
                 font-size: 18px; 
                 font-weight: bold; 
                 cursor: pointer; 
                 box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
                 transition: all 0.3s ease;">
    <span style="font-size: 42px;">ğŸ‘ï¸</span>
    <span style="font-size: 18px; font-weight: bold; color: #0f172a;">Preview Letter</span>
  </button>
  
  <!-- SAVE BUTTON -->
  <button type="submit" id="comp-letter-save-btn" 
          style="flex: 1; 
                 display: flex; 
                 flex-direction: column; 
                 align-items: center; 
                 justify-content: center; 
                 gap: 12px; 
                 padding: 28px; 
                 background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); 
                 color: #0f172a; 
                 border: 2px solid #10b981; 
                 border-radius: 16px; 
                 font-size: 18px; 
                 font-weight: bold; 
                 cursor: pointer; 
                 box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                 transition: all 0.3s ease;">
    <span style="font-size: 42px;">ğŸ’¾</span>
    <span style="font-size: 18px; font-weight: bold; color: #0f172a;">Save & Generate PDF</span>
  </button>
  
</div>

</form>
</section>


<!-- ============================================================================ -->
<!-- WAGE & POSITION HISTORY SECTION (OUTSIDE THE FORM) -->
<!-- ============================================================================ -->
<section class="p-6">
<div class="mt-8 bg-white rounded-xl border-2 border-slate-300 shadow-lg overflow-hidden">
  
  <!-- HEADER with Controls -->
  <div class="bg-gradient-to-r from-blue-600 to-blue-700 px-6 py-4 border-b-2 border-blue-800">
    <div class="flex items-center justify-between">
      <h3 class="text-xl font-black text-white flex items-center gap-3">
        <i class="fa-solid fa-clock-rotate-left"></i>
        Wage & Position History
      </h3>
      
      <div class="flex items-center gap-3">
        <button onclick="refreshWageHistory()" 
                class="px-4 py-2 bg-white hover:bg-gray-100 text-blue-700 font-bold rounded-lg transition-all shadow flex items-center gap-2">
          <i class="fa-solid fa-rotate"></i>
          Refresh
        </button>
      </div>
    </div>
  </div>

  <!-- âœ… BULK DELETE CONTROLS BAR -->
  <div id="bulk-controls-bar" class="hidden bg-blue-50 border-b-2 border-blue-200 px-6 py-3">
    <div class="flex items-center justify-between">
      
      <!-- LEFT: Select All -->
      <label class="flex items-center gap-3 cursor-pointer group">
        <input type="checkbox" 
               id="select-all-compensation"
               class="w-5 h-5 text-blue-600 rounded cursor-pointer border-2 border-blue-400"
               onchange="toggleSelectAll()">
        <span class="text-blue-900 font-bold text-lg group-hover:text-blue-700">
          <i class="fa-solid fa-list-check mr-2"></i>
          Select All
        </span>
      </label>
      
      <!-- RIGHT: Delete Selected Button -->
      <button id="bulk-delete-btn"
              onclick="bulkDeleteSelected()" 
              disabled
              class="px-6 py-3 bg-red-600 text-white font-black text-lg rounded-lg transition-all shadow-lg opacity-50 cursor-not-allowed flex items-center gap-3">
        <i class="fa-solid fa-trash-can text-xl"></i>
        <span id="selected-count">Delete Selected</span>
      </button>
    </div>
  </div>

  <!-- History List Container -->
  <div id="wage-history-container" class="p-6 space-y-4">
    
    <!-- Loading State -->
    <div id="wage-history-loading" class="text-center py-12">
      <i class="fa-solid fa-spinner fa-spin text-blue-600 text-4xl mb-3"></i>
      <p class="text-slate-600 font-semibold">Loading compensation history...</p>
    </div>

    <!-- Empty State (hidden by default) -->
    <div id="wage-history-empty" class="hidden text-center py-12">
      <i class="fa-solid fa-inbox text-slate-400 text-5xl mb-3"></i>
      <p class="text-slate-600 font-semibold text-lg">No compensation history found</p>
    </div>

    <!-- History Items will be dynamically inserted here -->
    <div id="wage-history-items" class="space-y-3"></div>

  </div>
</div>
</section>














  <!-- Add other tabs here (discipline, policy, reports, etc.) as <section id="tab-xxx" class="tab-panel hidden"> -->
</main>


  <!-- End of KPI Grid -->







        <!-- Discipline Cases Tab -->
        <!-- ========================================================================
     DISCIPLINE CASES TAB - CORPORATE REDESIGN
     ======================================================================== -->
<!-- ========================================================================
     DISCIPLINE CASES TAB - ENTERPRISE PROFESSIONAL DESIGN
     ======================================================================== -->
<section id="tab-discipline" class="tab-panel hidden">
  
  <!-- Professional Page Header with Gradient -->
  <div class="relative overflow-hidden bg-gradient-to-br from-slate-50 via-blue-50 to-indigo-50 rounded-2xl shadow-sm border border-slate-200 mb-8">
    <div class="absolute top-0 right-0 w-96 h-96 bg-blue-500/5 rounded-full -translate-y-1/2 translate-x-1/2"></div>
    <div class="relative p-8">
      <div class="flex items-start justify-between">
        <div class="flex-1">
          <div class="flex items-center gap-3 mb-3">
            <div class="w-14 h-14 bg-gradient-to-br from-indigo-500 to-blue-600 rounded-xl flex items-center justify-center shadow-lg">
              <i class="fas fa-clipboard-check text-white text-2xl"></i>
            </div>
            <div>
              <h1 class="text-3xl font-heading font-bold text-slate-900">Corrective Action Management</h1>
              <p class="text-sm text-slate-600 mt-1">Professional employee development and compliance documentation system</p>
            </div>
          </div>
        </div>
        <button id="discipline-refresh-btn" class="px-4 py-2.5 bg-white border-2 border-slate-200 rounded-lg hover:border-blue-300 hover:bg-blue-50 transition-all flex items-center gap-2 font-bold text-sm text-slate-700">
          <i class="fas fa-sync-alt"></i>
          <span>Refresh</span>
        </button>
      </div>
      
      <!-- Quick Stats Bar -->
      <div class="grid grid-cols-4 gap-4 mt-6">
        <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-blue-200 p-4 shadow-sm">
          <div class="text-xs font-bold text-slate-600 uppercase mb-1 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
            Verbal Warnings
          </div>
          <div class="text-2xl font-bold text-emerald-600" id="stat-verbal">--</div>
        </div>
        <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-blue-200 p-4 shadow-sm">
          <div class="text-xs font-bold text-slate-600 uppercase mb-1 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-amber-500"></div>
            Written Warnings
          </div>
          <div class="text-2xl font-bold text-amber-600" id="stat-written">--</div>
        </div>
        <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-blue-200 p-4 shadow-sm">
          <div class="text-xs font-bold text-slate-600 uppercase mb-1 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-orange-500"></div>
            Final Warnings
          </div>
          <div class="text-2xl font-bold text-orange-600" id="stat-final">--</div>
        </div>
        <div class="bg-white/80 backdrop-blur-sm rounded-xl border border-blue-200 p-4 shadow-sm">
          <div class="text-xs font-bold text-slate-600 uppercase mb-1 flex items-center gap-2">
            <div class="w-2 h-2 rounded-full bg-slate-500"></div>
            Terminations
          </div>
          <div class="text-2xl font-bold text-slate-600" id="stat-terminations">--</div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Content Grid -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- LEFT COLUMN: Employee Search & Selection -->
    <div class="lg:col-span-1 space-y-6">
      
      <!-- Employee Search Card -->
      <div class="bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
        <div class="bg-gradient-to-r from-indigo-500 to-blue-600 px-6 py-4">
          <h3 class="text-base font-heading font-bold text-white flex items-center gap-2">
            <i class="fas fa-user-check"></i>
            Select Employee
          </h3>
        </div>
        
        <div class="p-6">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
              <i class="fas fa-search text-slate-400"></i>
            </div>
            <input 
              type="text" 
              id="discipline-employee-search" 
              placeholder="Search by name or ID..."
              class="w-full pl-10 pr-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
            />
          </div>
          
          <!-- Search Dropdown -->
          <div id="discipline-employee-dropdown" class="hidden absolute z-50 mt-2 bg-white border-2 border-slate-200 rounded-lg shadow-xl max-h-80 overflow-y-auto w-full">
            <!-- Employee options will be populated here -->
          </div>
          
          <input type="hidden" id="discipline-employee-id" />
          
          <!-- Selected Employee Display -->
          <div id="selected-employee-display" class="hidden mt-4 p-4 bg-gradient-to-r from-emerald-50 to-green-50 border-2 border-emerald-200 rounded-lg">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 bg-emerald-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                <span id="employee-initials">PG</span>
              </div>
              <div class="flex-1">
                <div class="font-bold text-slate-900" id="employee-name">--</div>
                <div class="text-sm text-slate-600" id="employee-details">--</div>
              </div>
              <button type="button" onclick="clearSelectedEmployee()" class="text-slate-400 hover:text-slate-600">
                <i class="fas fa-times"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Workflow Guidance Card -->
      <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl border-2 border-blue-200 p-6">
        <div class="flex items-start gap-3">
          <div class="w-10 h-10 bg-blue-500 rounded-lg flex items-center justify-center flex-shrink-0">
            <i class="fas fa-info-circle text-white"></i>
          </div>
          <div>
            <h4 class="font-bold text-blue-900 mb-2">Best Practices</h4>
            <ul class="text-sm text-blue-800 space-y-1.5 leading-relaxed">
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                <span>Verify employee identity in Employees 360</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                <span>Document all incident details thoroughly</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                <span>Consult current JCR policies</span>
              </li>
              <li class="flex items-start gap-2">
                <i class="fas fa-check-circle text-emerald-500 mt-0.5"></i>
                <span>Ensure TWC/DOL compliance</span>
              </li>
            </ul>
          </div>
        </div>
      </div>

      <!-- Quick Reference Card -->
      <div class="bg-white rounded-xl border-2 border-slate-200 p-6">
        <h4 class="font-bold text-slate-900 mb-3 flex items-center gap-2">
          <i class="fas fa-book text-indigo-500"></i>
          Severity Guidelines
        </h4>
        <div class="space-y-2 text-sm">
          <div class="p-2 bg-emerald-50 border border-emerald-200 rounded">
            <span class="font-bold text-emerald-700">Low:</span>
            <span class="text-slate-600 ml-1">Minor policy deviations</span>
          </div>
          <div class="p-2 bg-amber-50 border border-amber-200 rounded">
            <span class="font-bold text-amber-700">Medium:</span>
            <span class="text-slate-600 ml-1">Repeated violations</span>
          </div>
          <div class="p-2 bg-orange-50 border border-orange-200 rounded">
            <span class="font-bold text-orange-700">High:</span>
            <span class="text-slate-600 ml-1">Serious misconduct</span>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT COLUMN: Discipline Form -->
    <div class="lg:col-span-2">
      <div class="bg-white rounded-xl shadow-sm border border-slate-200">
        <div class="bg-gradient-to-r from-indigo-500 to-blue-600 px-6 py-4">
          <div class="flex items-center justify-between">
            <h3 class="text-base font-heading font-bold text-white flex items-center gap-2">
              <i class="fas fa-file-signature"></i>
              New Corrective Action Form
            </h3>
            <span class="px-3 py-1 bg-white/20 backdrop-blur-sm rounded-lg text-xs font-bold text-white">
              <i class="fas fa-lock mr-1"></i>
              Confidential HR Record
            </span>
          </div>
        </div>

        <form id="discipline-form" class="p-6 space-y-6">
          
          <!-- Action Type & Date Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Type of Action <span class="text-rose-500">*</span>
              </label>
              <select 
                id="discipline-action-type" 
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all bg-white"
                required
              >
                <option value="">-- Select Action Type --</option>
                <option value="VERBAL_WARNING">Verbal Warning</option>
                <option value="WRITTEN_WARNING">Written Warning</option>
                <option value="FINAL_WARNING">Final Warning</option>
                <option value="TERMINATION">Termination</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Incident Date <span class="text-rose-500">*</span>
              </label>
              <input 
                type="date" 
                id="discipline-action-date" 
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
                required
              />
            </div>
          </div>

          <!-- Category & Subcategory Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Main Category <span class="text-rose-500">*</span>
              </label>
              <select 
                id="discipline-main-category" 
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all bg-white"
                required
              >
                <option value="">-- Select Category --</option>
                <option value="Attendance & Punctuality">Attendance & Punctuality</option>
                <option value="Performance Issues">Performance Issues</option>
                <option value="Conduct & Behavior">Conduct & Behavior</option>
                <option value="Policy Violations">Policy Violations</option>
                <option value="Safety & Security">Safety & Security</option>
                <option value="Customer Service">Customer Service</option>
                <option value="Insubordination">Insubordination</option>
                <option value="Harassment">Harassment</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Sub-Category / Specific Issue <span class="text-rose-500">*</span>
              </label>
              <select 
                id="discipline-sub-category" 
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all bg-white"
                required
                disabled
              >
                <option value="">Select main category first...</option>
              </select>
            </div>
          </div>

          <!-- Severity & Reference Row -->
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Severity Level <span class="text-rose-500">*</span>
              </label>
              <select 
                id="discipline-severity" 
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all bg-white"
                required
              >
                <option value="">-- Select Severity --</option>
                <option value="Low">Low - Minor Issue</option>
                <option value="Medium">Medium - Moderate Concern</option>
                <option value="High">High - Serious Matter</option>
              </select>
            </div>

            <div>
              <label class="block text-sm font-bold text-slate-700 mb-2">
                Internal Reference / Incident ID
              </label>
              <input 
                type="text" 
                id="discipline-reference" 
                placeholder="e.g., INC-2025-001"
                class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
              />
            </div>
          </div>

          <!-- Description -->
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">
              Reason / Policy Violations <span class="text-rose-500">*</span>
            </label>
            <textarea 
              id="discipline-reason" 
              rows="4"
              placeholder="Provide detailed description of the incident, policy violations, and circumstances leading to this action..."
              class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all resize-none"
              required
            ></textarea>
          </div>

          <!-- Corrective Action Plan -->
          <div>
            <label class="block text-sm font-bold text-slate-700 mb-2">
              Corrective Action Plan / Notes
            </label>
            <textarea 
              id="discipline-plan" 
              rows="3"
              placeholder="Outline expectations, timelines, coaching, retraining, or final performance thresholds for the employee..."
              class="w-full px-4 py-3 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all resize-none"
            ></textarea>
          </div>

          <!-- Signatures Section -->
          <div class="bg-slate-50 border-2 border-slate-200 rounded-lg p-6">
            <h4 class="font-bold text-slate-900 mb-4 flex items-center gap-2">
              <i class="fas fa-pen-fancy text-indigo-500"></i>
              Digital Signatures
            </h4>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">
                  Manager Typed Signature <span class="text-rose-500">*</span>
                </label>
                <input 
                  type="text" 
                  id="discipline-manager-signature" 
                  placeholder="Manager full name (signing)"
                  class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
                  required
                />
              </div>

              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">
                  HR Typed Signature
                </label>
                <input 
                  type="text" 
                  id="discipline-hr-signature" 
                  placeholder="HR representative (optional)"
                  class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
                />
              </div>

              <div>
                <label class="block text-sm font-bold text-slate-700 mb-2">
                  Employee Typed Signature
                </label>
                <input 
                  type="text" 
                  id="discipline-employee-signature" 
                  placeholder="Employee full name (signing)"
                  class="w-full px-4 py-2.5 border-2 border-slate-200 rounded-lg focus:border-indigo-400 focus:outline-none transition-all"
                />
              </div>
            </div>

            <div class="mt-4 flex items-center gap-2">
              <input 
                type="checkbox" 
                id="discipline-employee-declined" 
                class="w-4 h-4 text-indigo-600 border-2 border-slate-300 rounded focus:ring-indigo-500"
              />
              <label for="discipline-employee-declined" class="text-sm text-slate-700">
                Employee declined to sign. Action is acknowledged only, and a signed copy will be provided per JCR policy.
              </label>
            </div>

            <div class="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
              <p class="text-xs text-blue-800 flex items-start gap-2">
                <i class="fas fa-shield-alt mt-0.5 text-blue-600"></i>
                <span>By submitting, you confirm this action is consistent, non-retaliatory, and based solely on documented facts.</span>
              </p>
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-4 pt-4 border-t-2 border-slate-200">
            <button 
              type="submit"
              id="discipline-form-submit"
              class="flex-1 px-6 py-4 bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-lg hover:from-indigo-700 hover:to-blue-700 transition-all flex items-center justify-center gap-3 font-bold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5"
            >
              <span id="discipline-form-submit-spinner" class="hidden">
                <i class="fas fa-spinner fa-spin"></i>
              </span>
              <span id="discipline-form-submit-text" class="flex items-center gap-2">
                <i class="fas fa-file-pdf"></i>
                <span>Record Action & Generate PDF</span>
              </span>
            </button>
            <button 
              type="button"
              id="discipline-form-reset"
              class="px-6 py-4 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-all flex items-center gap-2 font-bold border-2 border-slate-200"
            >
              <i class="fas fa-redo"></i>
              <span>Reset Form</span>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- ========================================================================
     DISCIPLINARY HISTORY TIMELINE - ADD THIS TO YOUR EMPLOYEE PROFILE
     ======================================================================== -->

<!-- Add this section in the employee profile modal or detail view -->
<div class="bg-white rounded-xl shadow-lg p-6 mt-6">
  <!-- Section Header -->
  <div class="flex items-center justify-between mb-6 pb-4 border-b-2 border-slate-200">
    <h3 class="text-xl font-bold text-slate-800 flex items-center gap-3">
      <div class="w-10 h-10 bg-indigo-100 rounded-lg flex items-center justify-center">
        <i class="fas fa-timeline text-indigo-600 text-lg"></i>
      </div>
      <span>Disciplinary History Timeline</span>
    </h3>
    
    <!-- Optional: Add filter or export buttons -->
    <div class="flex gap-2">
      <button 
        onclick="exportTimeline()"
        class="px-4 py-2 bg-slate-100 text-slate-700 rounded-lg hover:bg-slate-200 transition-colors flex items-center gap-2 font-semibold text-sm"
      >
        <i class="fas fa-download"></i>
        Export
      </button>
      <button 
        onclick="refreshTimeline()"
        class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg hover:bg-indigo-200 transition-colors flex items-center gap-2 font-semibold text-sm"
      >
        <i class="fas fa-sync-alt"></i>
        Refresh
      </button>
    </div>
  </div>
  
  <!-- Timeline Container -->
  <div id="employee-discipline-timeline" class="space-y-4">
    <!-- Timeline items will be dynamically inserted here -->
    <div class="text-center py-12 text-slate-400">
      <i class="fas fa-spinner fa-spin text-3xl mb-3"></i>
      <p class="text-base">Loading timeline...</p>
    </div>
  </div>
  
  <!-- Legend -->
  <div class="mt-6 pt-6 border-t border-slate-200">
    <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-3">Action Types</p>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-green-500 border-2 border-white shadow"></div>
        <span class="text-sm text-slate-700">Verbal Warning</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-yellow-500 border-2 border-white shadow"></div>
        <span class="text-sm text-slate-700">Written Warning</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-orange-500 border-2 border-white shadow"></div>
        <span class="text-sm text-slate-700">Final Warning</span>
      </div>
      <div class="flex items-center gap-2">
        <div class="w-4 h-4 rounded-full bg-red-500 border-2 border-white shadow"></div>
        <span class="text-sm text-slate-700">Termination</span>
      </div>
    </div>
  </div>
</div>

<!-- ========================================================================
     INTEGRATION SCRIPT
     ======================================================================== -->
<script>
// Call this function when viewing an employee's profile
function showEmployeeProfile(employeeId) {
  // ... your existing code to show employee profile ...
  
  // Render the disciplinary timeline
  renderDisciplinaryTimeline(employeeId);
}

// Refresh timeline function
function refreshTimeline() {
  const employeeId = getCurrentEmployeeId(); // Your function to get current employee ID
  if (employeeId) {
    showToast('ğŸ”„ Refreshing timeline...', 'info');
    renderDisciplinaryTimeline(employeeId);
  }
}

// Export timeline function
async function exportTimeline() {
  const employeeId = getCurrentEmployeeId();
  if (!employeeId) return;
  
  const actions = AppState.disciplinaryActions
    .filter(a => a.employee_id === employeeId)
    .sort((a, b) => new Date(b.date_issued) - new Date(a.date_issued));
    
  // Create CSV
  let csv = 'Date,Type,Reason,Notes,Issued By\n';
  actions.forEach(action => {
    csv += `"${formatDate(action.date_issued)}","${action.type}","${action.reason || ''}","${action.notes || ''}","${action.issued_by || ''}"\n`;
  });
  
  // Download
  const blob = new Blob([csv], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `disciplinary-timeline-${employeeId}-${Date.now()}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  
  showToast('âœ“ Timeline exported successfully', 'success');
}

</script>
<!-- â¬†ï¸ ADD THIS CLOSING SCRIPT TAG â¬†ï¸ -->

<!-- Discipline Audit Trail Section - WITH CHART + TABLE -->
<div class="mt-6 bg-white rounded-xl shadow-sm border border-slate-200">
  <div class="bg-gradient-to-r from-emerald-600 to-teal-600 px-6 py-4 flex items-center justify-between">
    <h3 class="text-base font-heading font-bold text-white flex items-center gap-2">
      <i class="fas fa-clipboard-check"></i>
      Discipline Audit Trail
    </h3>
    <button id="export-audit-trail" class="px-3 py-1.5 bg-white/20 backdrop-blur-sm rounded-lg text-xs font-bold text-white hover:bg-white/30 transition-all">
      <i class="fas fa-download mr-1"></i>
      Export Timeline PDF
    </button>
  </div>
  
  <div class="p-6">
    <p class="text-sm text-slate-600 mb-6">Evidence-ready list of actions, suitable for TWC hearings, DOL audits, or internal investigations.</p>
    
    <!-- â­ NEW: CHART SECTION -->
    <div id="audit-chart-container" class="mb-6 bg-slate-50 rounded-lg p-4 border-2 border-slate-200">
      <h4 class="font-bold text-slate-700 mb-3 flex items-center gap-2">
        <i class="fas fa-chart-line text-indigo-600"></i>
        Severity Progression Over Time
      </h4>
      <div class="bg-white rounded-lg p-4">
        <canvas id="discipline-audit-chart" style="max-height: 300px;"></canvas>
      </div>
    </div>

    <!-- â­ ORIGINAL: TABLE SECTION (KEPT AS IS) -->
    <div class="overflow-x-auto">
      <table class="w-full text-sm">
        <thead>
          <tr class="bg-slate-50 border-b-2 border-slate-200">
            <th class="px-4 py-3 text-left font-bold text-slate-700">Timestamp</th>
            <th class="px-4 py-3 text-left font-bold text-slate-700">Action</th>
            <th class="px-4 py-3 text-left font-bold text-slate-700">Severity</th>
            <th class="px-4 py-3 text-left font-bold text-slate-700">User</th>
            <th class="px-4 py-3 text-left font-bold text-slate-700">Reference</th>
          </tr>
        </thead>
        <tbody id="audit-trail-body" class="divide-y divide-slate-100">
          <tr>
            <td colspan="5" class="px-4 py-8 text-center text-slate-400">
              Select an employee to view audit trail
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>
</div>

</section>




















<section id="tab-employees" class="tab-panel hidden space-y-6">
  
  <input type="hidden" id="current-employee-360-id" value="" />

  <!-- HEADER WITH BUTTONS -->
  <div class="bg-gradient-to-r from-slate-800 to-slate-900 rounded-2xl shadow-2xl p-6 border border-slate-700">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="bg-brand-500 rounded-xl p-3 shadow-lg">
          <i class="fa-solid fa-user-circle text-white text-2xl"></i>
        </div>
        <div>
          <h2 class="text-2xl font-black text-white tracking-tight">Employee 360Â° Profile</h2>
          <p class="text-slate-400 text-sm font-semibold mt-0.5">Complete employee management & editing</p>
        </div>
      </div>
      
      <div class="flex items-center gap-3">
        <button id="btn-add-new-employee" 
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 text-white px-5 py-3 text-sm font-black shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200">
          <i class="fa-solid fa-user-plus"></i>
          <span>Add New Employee</span>
        </button>
        
        <button id="btn-save-employee-360" 
                class="inline-flex items-center gap-2 rounded-xl bg-gradient-to-r from-brand-500 to-brand-600 text-white px-5 py-3 text-sm font-black shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-200">
          <i class="fa-solid fa-floppy-disk"></i>
          <span>Save Changes</span>
        </button>
      </div>
    </div>
  </div>

  <!-- SEARCH PANEL -->
  <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-heading text-base font-black text-slate-900 flex items-center gap-2">
        <i class="fa-solid fa-magnifying-glass text-brand-600"></i>
        Search Employees
      </h3>
      <button id="employees-refresh-button" type="button"
              class="inline-flex items-center gap-2 rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-xs font-bold text-slate-700 hover:bg-slate-50 transition-all">
        <i class="fa-solid fa-arrows-rotate"></i>
        Refresh
      </button>
    </div>
    
    <p class="text-xs text-slate-500 mb-4 leading-relaxed font-semibold">
      Search by name, employee ID, or department to view and edit employee profile.
    </p>

    <div class="relative">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fa-solid fa-search text-slate-400"></i>
      </div>
      <input id="employees-search-input" type="text"
             placeholder="Type 3+ letters to search..."
             class="w-full pl-10 pr-3 py-3 rounded-xl border-2 border-slate-300 bg-slate-50 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all"
             autocomplete="off" />
      <div id="employees-search-dropdown"
           class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-slate-200 rounded-xl shadow-xl max-h-64 overflow-y-auto">
      </div>
    </div>
  </div>

  <!-- STATUS INDICATOR -->
  <div class="flex items-center gap-3">
    <div id="save-status-indicator" class="w-3 h-3 rounded-full bg-emerald-500"></div>
    <span id="save-status-text" class="text-sm font-bold text-slate-700">Ready to edit</span>
  </div>

  <!-- 4-COLUMN FORM -->
  <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLUMN 1: EMPLOYMENT & CONTACT -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-id-card text-brand-600"></i>
        Employment & Contact
      </h3>

      <div class="space-y-4">
        <!-- Employment Status -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-check text-brand-600"></i>
            Employment Status
          </label>
          <select id="edit-employment-status"
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
            <option value="Active">Active</option>
            <option value="On Leave">On Leave</option>
            <option value="Terminated">Terminated</option>
            <option value="Resigned">Resigned</option>
          </select>
        </div>

        <!-- First Name -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user text-brand-600"></i>
            First Name
          </label>
          <input type="text" id="edit-first-name"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="First name" />
        </div>

        <!-- Last Name -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user text-brand-600"></i>
            Last Name
          </label>
          <input type="text" id="edit-last-name"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="Last name" />
        </div>

        <!-- Department -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-building text-brand-600"></i>
            Department
          </label>
          <select id="edit-department"
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
            <option value="FOH">FOH</option>
            <option value="BOH">BOH</option>
            <option value="Management">Management</option>
            <option value="Admin">Admin</option>
          </select>
        </div>

       <!-- Job Title -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-briefcase text-brand-600"></i>
            Job Title
          </label>
          <select id="edit-job-title"
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
            <option value="">Select department first</option>
          </select>
        </div>

        <!-- Report To -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-tie text-brand-600"></i>
            Report To
          </label>
          <select id="edit-report-to"
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
            <option value="">Select Manager</option>
            <option value="Pablo Gonzalez">Pablo Gonzalez</option>
            <option value="Shoko Teng">Shoko Teng</option>
            <option value="Janelle Teng">Janelle Teng</option>
            <option value="Craig Reeves">Craig Reeves</option>
            <option value="Anh Mai Vu">Anh Mai Vu</option>
          </select>
        </div>

        <!-- Phone Number (Auto-formatted) -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-phone text-brand-600"></i>
            Phone Number
          </label>
          <input type="tel" id="edit-phone-number"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="(555) 123-4567"
                 maxlength="14" />
          <p class="text-xs text-slate-500 mt-1 font-semibold">Auto-formats as you type</p>
        </div>

        <!-- Email Address -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-envelope text-brand-600"></i>
            Email Address
          </label>
          <input type="email" id="edit-email-address"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="email@company.com" />
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLUMN 2: ADDRESS (WITH AUTOCOMPLETE) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-location-dot text-brand-600"></i>
        Address
      </h3>

      <div class="space-y-4">
        <!-- Address Line 1 (with autocomplete) -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-home text-brand-600"></i>
            Address Line 1
          </label>
          <input type="text" id="edit-address-line-1"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="Start typing address..."
                 autocomplete="off" />
          <p class="text-xs text-emerald-600 mt-1 font-bold">
            <i class="fa-solid fa-magic-wand-sparkles mr-1"></i>
            Type to get address suggestions
          </p>
        </div>

        <!-- Address Line 2 -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-building text-brand-600"></i>
            Address Line 2
          </label>
          <input type="text" id="edit-address-line-2"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="Apt, Suite (optional)" />
        </div>

        <!-- City (Auto-filled) -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-city text-brand-600"></i>
            City
          </label>
          <input type="text" id="edit-city"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                 placeholder="Auto-filled from address" />
        </div>

        <!-- State & ZIP (Auto-filled) -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-map text-brand-600"></i>
              State
            </label>
            <input type="text" id="edit-state"
                   class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="TX" maxlength="2" />
          </div>
          <div>
            <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              Zip
            </label>
            <input type="text" id="edit-zip"
                   class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="Auto-filled" maxlength="5" />
          </div>
        </div>

        <div class="bg-blue-50 rounded-lg p-3 border-2 border-blue-200">
          <p class="text-xs font-bold text-blue-900">
            <i class="fa-solid fa-info-circle mr-1"></i>
            City, State, and ZIP auto-fill when you select an address
          </p>
        </div>
      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLUMN 3: COMPENSATION (WITH AUTO-CALC) -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-money-check-dollar text-emerald-600"></i>
        Compensation
      </h3>

      <div class="space-y-4">
        <!-- Original Hire Date -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-calendar text-brand-600"></i>
            Original Hire Date
          </label>
          <input type="date" id="edit-original-hire-date"
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
        </div>

        <!-- Tenure (Calculated) -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-hourglass-half text-amber-600"></i>
            Tenure (Calculated)
          </label>
          <input type="text" id="display-tenure" readonly
                 class="w-full rounded-lg border-2 border-amber-300 bg-amber-50 px-3 py-2 text-sm font-bold text-amber-900"
                 placeholder="--" />
        </div>

        <!-- Compensation Type -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-money-bill text-emerald-600"></i>
            Compensation Type
          </label>
          <select id="edit-compensation-type"
                  class="w-full rounded-lg border-2 border-emerald-300 bg-emerald-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="hourly">Hourly</option>
            <option value="salary">Salary</option>
          </select>
        </div>

        <!-- PRIMARY JOB -->
        <div class="space-y-3 p-4 bg-blue-50 rounded-lg border-2 border-blue-200">
          <h5 class="text-xs font-black text-blue-900 uppercase flex items-center gap-2">
            <i class="fa-solid fa-star text-blue-600"></i>
            Primary Job
          </h5>
          
          <!-- Hourly Rate (always shown) -->
          <div id="primary-hourly-container">
            <label class="text-xs font-bold text-slate-700 mb-1 block">Hourly Wage</label>
            <input type="number" step="0.01" id="edit-hourly-rate"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-base font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="0.00" />
          </div>

          <!-- Annual Salary (shown when salary selected) -->
          <div id="primary-salary-container" class="hidden">
            <label class="text-xs font-bold text-slate-700 mb-1 block">Annual Salary</label>
            <input type="number" step="0.01" id="edit-annual-salary"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-base font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="0.00" />
          </div>

          <!-- Calculated Hourly (for salary employees) -->
          <div id="calculated-hourly-display" class="hidden bg-emerald-100 rounded-lg p-3 border-2 border-emerald-300">
            <label class="text-xs font-bold text-emerald-900 mb-1 block">Calculated Hourly Rate</label>
            <p id="display-calculated-hourly" class="text-2xl font-black text-emerald-700">--</p>
            <p id="calc-formula-display" class="text-xs text-emerald-700 font-semibold mt-1">--</p>
          </div>
        </div>

        <!-- ADD SECONDARY JOB BUTTON -->
        <button id="btn-add-secondary-job" type="button"
                class="w-full rounded-lg border-2 border-dashed border-purple-300 bg-purple-50 px-4 py-3 text-sm font-bold text-purple-700 hover:bg-purple-100 transition-all">
          <i class="fa-solid fa-plus-circle mr-2"></i>
          Add Secondary Job
        </button>

        <!-- SECONDARY JOB (Hidden by default) -->
        <div id="secondary-job-container" class="hidden space-y-3 p-4 bg-purple-50 rounded-lg border-2 border-purple-200">
          <div class="flex items-center justify-between mb-2">
            <h5 class="text-xs font-black text-purple-900 uppercase flex items-center gap-2">
              <i class="fa-solid fa-briefcase text-purple-600"></i>
              Secondary Job
            </h5>
            <button id="btn-remove-secondary-job" type="button"
                    class="text-xs font-bold text-rose-600 hover:text-rose-800">
              <i class="fa-solid fa-times-circle mr-1"></i>Remove
            </button>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 mb-1 block">Job Title 2</label>
            <input type="text" id="edit-job-title2"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="Secondary position" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 mb-1 block">Hourly Wage 2</label>
            <input type="number" step="0.01" id="edit-hourly-rate2"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-base font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="0.00" />
          </div>
        </div>

        <!-- ADD TERTIARY JOB BUTTON -->
        <button id="btn-add-tertiary-job" type="button"
                class="hidden w-full rounded-lg border-2 border-dashed border-pink-300 bg-pink-50 px-4 py-3 text-sm font-bold text-pink-700 hover:bg-pink-100 transition-all">
          <i class="fa-solid fa-plus-circle mr-2"></i>
          Add Tertiary Job
        </button>

        <!-- TERTIARY JOB (Hidden by default) -->
        <div id="tertiary-job-container" class="hidden space-y-3 p-4 bg-pink-50 rounded-lg border-2 border-pink-200">
          <div class="flex items-center justify-between mb-2">
            <h5 class="text-xs font-black text-pink-900 uppercase flex items-center gap-2">
              <i class="fa-solid fa-briefcase text-pink-600"></i>
              Tertiary Job
            </h5>
            <button id="btn-remove-tertiary-job" type="button"
                    class="text-xs font-bold text-rose-600 hover:text-rose-800">
              <i class="fa-solid fa-times-circle mr-1"></i>Remove
            </button>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 mb-1 block">Job Title 3</label>
            <input type="text" id="edit-job-title3"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="Tertiary position" />
          </div>
          <div>
            <label class="text-xs font-bold text-slate-700 mb-1 block">Hourly Wage 3</label>
            <input type="number" step="0.01" id="edit-hourly-rate3"
                   class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-base font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
                   placeholder="0.00" />
          </div>
        </div>

      </div>
    </div>

    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <!-- COLUMN 4: RISK & COMPLIANCE -->
    <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-shield-halved text-rose-600"></i>
        Risk & Compliance
      </h3>

      <div class="space-y-4">
        <!-- Risk Score (Calculated) -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Risk Score (Calculated)
          </label>
          <input type="text" id="display-risk-score" readonly
                 class="w-full rounded-lg border-2 border-slate-300 bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600"
                 placeholder="--" />
        </div>

        <!-- Risk Level -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-triangle-exclamation text-rose-600"></i>
            Risk Level
          </label>
          <select id="edit-risk-level" disabled
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-100 px-3 py-2 text-sm font-bold">
            <option value="LOW">LOW</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HIGH">HIGH</option>
          </select>
        </div>

        <!-- HR Witness -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-shield text-brand-600"></i>
            HR Witness
          </label>
          <select id="edit-hr-witness"
                  class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
            <option value="">Select HR Rep</option>
            <option value="Janelle Teng">Janelle Teng</option>
            <option value="Shoko Teng">Shoko Teng</option>
            <option value="Pablo Gonzalez">Pablo Gonzalez</option>
          </select>
        </div>

        <!-- Last Disciplinary Action -->
        <div>
          <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Last Disciplinary Action
          </label>
          <textarea id="display-last-discipline" readonly rows="3"
                    class="w-full rounded-lg border-2 border-slate-300 bg-slate-100 px-3 py-2 text-xs font-semibold text-slate-600 resize-none"
                    placeholder="No disciplinary actions"></textarea>
        </div>
      </div>
    </div>

  </div>
  <!-- END OF 4-COLUMN GRID -->

</section>



<!-- Policy Library Tab - NO PADDING VERSION -->
      <section id="tab-policy" class="tab-panel hidden space-y-4" style="margin: 0 !important; padding: 1rem 0 0 0 !important;">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Policy Library &amp; Reference
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Centralized view of external guidance and internal Jeng Chi Restaurant discipline policies used to inform corrective actions.
              </p>
            </div>
          </div>

          <!-- Filter Pills - ONLY 2 OPTIONS NOW -->
          <div class="flex flex-wrap gap-2 text-[0.70rem]">
            <button
              type="button"
              data-policy-category="twc-dol"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-brand-700 font-medium"
            >
              <i class="fa-solid fa-scale-balanced text-[0.70rem]"></i>
              <span>TWC / DOL Guidance</span>
            </button>
            <button
              type="button"
              data-policy-category="internal"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-building text-[0.70rem]"></i>
              <span>Internal JCR Policies</span>
            </button>
          </div>

          <!-- Policies Accordion - ONLY 2 SECTIONS NOW -->
          <div id="policy-accordion" class="space-y-4 text-xs">
            <!-- TWC / DOL Guidance -->
            <article
              data-policy-category-panel="twc-dol"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900 font-bold flex items-center gap-2">
                    <i class="fa-solid fa-scale-balanced text-brand-600 text-sm"></i>
                    <span>TWC / DOL Consistent Documentation Practices</span>
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1 flex items-center gap-2">
                    <i class="fa-solid fa-file-shield text-slate-400 text-[0.70rem]"></i>
                    <span>
                      Align disciplinary documentation with requirements commonly reviewed in Texas Workforce Commission and U.S. Department of Labor proceedings.
                    </span>
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    <i class="fa-regular fa-clock text-[0.60rem] mr-1"></i>
                    <span>Last updated: 2025-06-01</span>
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>

              <div class="policy-accordion-body space-y-2 text-slate-600">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Maintain <span class="font-medium">fact-based, contemporaneous documentation</span> for each incident, including dates, times, witnesses, and specific behaviors observed.
                  </li>
                  <li>
                    Ensure that <span class="font-medium">policies are communicated</span> to all employees, with signed acknowledgments held in personnel files or the digital portal.
                  </li>
                  <li>
                    Apply discipline <span class="font-medium">consistently across similarly situated employees</span> to mitigate allegations of disparate treatment or retaliation.
                  </li>
                  <li>
                    Use a <span class="font-medium">progressive discipline model</span> where appropriate (verbal, written, final, termination), while preserving the employer's right to accelerate steps when warranted.
                  </li>
                  <li>
                    Retain records for a reasonable period consistent with <span class="font-medium">TWC, DOL, and internal retention schedules</span>.
                  </li>
                </ul>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  This summary is provided for HR guidance and does not replace consultation with qualified legal counsel.
                </p>
              </div>
            </article>

            <!-- Internal JCR Policies with PDF Viewer -->
            <article
              data-policy-category-panel="internal"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3">
                <div>
                  <h3 class="font-heading text-sm text-slate-900 font-bold flex items-center gap-2">
                    <i class="fa-solid fa-building text-brand-600 text-sm"></i>
                    <span>JCR Employee Handbook 2026</span>
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1 flex items-center gap-2">
                    <i class="fa-solid fa-file-pdf text-slate-400 text-[0.70rem]"></i>
                    <span>
                      Complete employee handbook with policies, procedures, and expectations.
                    </span>
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    <i class="fa-regular fa-clock text-[0.60rem] mr-1"></i>
                    <span>Last updated: 2025-03-20</span>
                  </span>
                </div>
              </header>

              <!-- PDF Viewer -->
              <div class="mt-4">
                <iframe
                  src="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf"
                  class="w-full h-[600px] rounded-lg border border-slate-200"
                  title="JCR Employee Handbook 2026"
                ></iframe>
                <div class="mt-2 flex justify-end">
                  <a
                    href="https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf"
                    target="_blank"
                    class="inline-flex items-center gap-2 text-xs text-brand-600 hover:text-brand-700 font-medium"
                  >
                    <i class="fa-solid fa-external-link"></i>
                    <span>Open in New Tab</span>
                  </a>
                </div>
              </div>
            </article>
          </div>

          <!-- AI Disclaimer -->
          <div class="rounded-2xl border border-dashed border-amber-200 bg-amber-50/50 px-4 py-3 text-[0.70rem] text-amber-800">
            <p class="font-semibold">
              AI-Assisted Content &amp; Legal Review
            </p>
            <p class="mt-1">
              Some explanatory language in this Policy Library has been drafted or structured using AI-assisted tools for clarity and
              consistency. These materials are provided for <span class="font-semibold">HR reference only</span> and do not constitute legal advice.
              Jeng Chi Restaurant leadership and HR must review, adapt, and approve all policy content, and should consult qualified labor
              and employment counsel to confirm alignment with current TWC, DOL, and applicable law.
            </p>
          </div>
        </section>

      
        <!-- Admin Settings Tab -->
        <section id="tab-admin" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Admin Settings
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Configure risk thresholds, notification preferences, and system-wide defaults for the discipline portal.
              </p>
            </div>
            <button
              id="admin-save-settings"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-floppy-disk"></i>
              <span>Save All Settings</span>
            </button>
          </div>

<!-- Risk Score Thresholds -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Risk Score Thresholds
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Define the point thresholds that determine LOW, MEDIUM, and HIGH risk levels for employees based on their discipline history.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <!-- Low Risk Threshold -->
              <div>
                <label for="admin-threshold-low" class="block font-bold text-slate-700 mb-1">
                  Low Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-low"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score below this = Low Risk
                </p>
              </div>

              <!-- Medium Risk Threshold -->
              <div>
                <label for="admin-threshold-medium" class="block font-bold text-slate-700 mb-1">
                  Medium Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-medium"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 5"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = Medium Risk
                </p>
              </div>

              <!-- High Risk Threshold -->
              <div>
                <label for="admin-threshold-high" class="block font-bold text-slate-700 mb-1">
                  High Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-high"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 8"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = High Risk
                </p>
              </div>
            </div>
          </div>

          <!-- Action Point Weights -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Action Point Weights
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Assign point values to each type of disciplinary action for risk score calculation.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-xs">
              <!-- Verbal Warning Points -->
              <div>
                <label for="admin-points-verbal" class="block font-bold text-slate-700 mb-1">
                  Verbal Warning
                </label>
                <input
                  type="number"
                  id="admin-points-verbal"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="1"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per verbal warning
                </p>
              </div>

              <!-- Written Warning Points -->
              <div>
                <label for="admin-points-written" class="block font-bold text-slate-700 mb-1">
                  Written Warning
                </label>
                <input
                  type="number"
                  id="admin-points-written"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per written warning
                </p>
              </div>

              <!-- Final Warning Points -->
              <div>
                <label for="admin-points-final" class="block font-bold text-slate-700 mb-1">
                  Final Warning
                </label>
                <input
                  type="number"
                  id="admin-points-final"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="3"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per final warning
                </p>
              </div>

              <!-- Termination Points -->
              <div>
                <label for="admin-points-termination" class="block font-bold text-slate-700 mb-1">
                  Termination Letter
                </label>
                <input
                  type="number"
                  id="admin-points-termination"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="4"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per termination letter
                </p>
              </div>
            </div>
          </div>

          <!-- Notification Settings -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Notification Settings
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure when and how the system sends alerts to HR and management.
            </p>
            <div class="space-y-3 text-xs">
              <!-- Notify on High Risk -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-high-risk"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-high-risk" class="font-bold text-slate-700 cursor-pointer">
                    Notify when employee reaches High Risk
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send an alert to HR when an employee's risk score crosses the high-risk threshold.
                  </p>
                </div>
              </div>

              <!-- Notify on Final Warning -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-final-warning"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-final-warning" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Final Warning is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Alert leadership when a final warning is documented in the system.
                  </p>
                </div>
              </div>

              <!-- Notify on Termination -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-termination"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-termination" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Termination Letter is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send immediate notification to HR and legal when a termination is processed.
                  </p>
                </div>
              </div>

              <!-- Daily Summary -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-daily-summary"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-daily-summary" class="font-bold text-slate-700 cursor-pointer">
                    Send daily discipline summary
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Email a daily summary of all discipline actions to designated recipients.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Display Preferences -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Display Preferences
            </h3>
            <div class="space-y-3 text-xs">
              <!-- Show Employee Photos -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-photos"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-photos" class="font-bold text-slate-700 cursor-pointer">
                    Show employee photos in lists
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Display profile photos next to employee names throughout the portal.
                  </p>
                </div>
              </div>

              <!-- Compact Mode -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-compact"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-compact" class="font-bold text-slate-700 cursor-pointer">
                    Use compact table views
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Reduce spacing in tables and lists for more data density.
                  </p>
                </div>
              </div>

              <!-- Auto-refresh Dashboard -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-auto-refresh"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-auto-refresh" class="font-bold text-slate-700 cursor-pointer">
                    Auto-refresh dashboard every 5 minutes
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Automatically refresh dashboard data when the tab is active.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Retention -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Data Retention
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure how long the system retains discipline records and audit trails.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              <!-- Discipline Records Retention -->
              <div>
                <label for="admin-retention-discipline" class="block font-bold text-slate-700 mb-1">
                  Discipline Records Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-discipline"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Recommended: 7 years per TWC guidance
                </p>
              </div>

              <!-- Audit Trail Retention -->
              <div>
                <label for="admin-retention-audit" class="block font-bold text-slate-700 mb-1">
                  Audit Trail Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-audit"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  System logs and change history
                </p>
              </div>
            </div>
          </div>

          <!-- Save Confirmation -->
          <div id="admin-save-status" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-xs text-emerald-800">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-circle-check text-emerald-600"></i>
              <span class="font-semibold">Settings saved successfully!</span>
            </div>
          </div>
        </section>

        <!-- Permissions Tab -->
        <section id="tab-permissions" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Permissions &amp; Access Control
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Manage who can view, edit, and administer the discipline portal. Define role-based permissions for HR, managers, and administrators.
              </p>
            </div>
            <button
              id="permissions-add-admin"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-user-plus"></i>
              <span>Add Administrator</span>
            </button>
          </div>

          <!-- Current Administrators -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Portal Administrators
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Users with full administrative access to all tabs, settings, and data.
  </p>
  <div class="space-y-2 text-xs">
    <!-- Admin User 1 -->
    <div class="flex items-center justify-between rounded-lg border border-slate-100 bg-slate-50 px-3 py-2">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-500 text-white font-heading text-xs">
          PG
        </div>
        <div>
          <p class="font-bold text-slate-900">Pablo Gonzalez</p>
          <p class="text-[0.70rem] text-slate-500"><a href="/cdn-cgi/l/email-protection" class="__cf_email__" data-cfemail="631302010f0c2309060d04000b0a11061017021611020d174d000c0e">[email&#160;protected]</a></p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-200 px-2 py-1 text-[0.70rem] text-brand-700 font-medium">
          <i class="fa-solid fa-shield-halved text-[0.60rem]"></i>
          <span>Owner</span>
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Role-Based Access Matrix -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Role-Based Access Matrix
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Define what each role can view and edit across the portal. Changes save automatically.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700 min-w-[250px]">
            Feature / Tab
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-shield-halved text-brand-500 mb-1"></i>
              <span>Admin</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-user-tie text-slate-500 mb-1"></i>
              <span>Manager</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-eye text-slate-500 mb-1"></i>
              <span>Viewer</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        
        <!-- Dashboard - View KPIs & Charts -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard â€” View KPIs & Charts</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Dashboard - Export Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard â€” Export Reports & Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - View History -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” View History</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Create & Edit Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Create & Edit Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Delete Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Delete Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Export PDFs -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Export to PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - View Profiles -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” View Profiles</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Employee Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Edit Employee Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Salaries & Compensation -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Edit Salaries & Compensation</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Terminate Employees -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Terminate Employees</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Export 360 PDF -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Export 360 PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="viewer" />
          </td>
        </tr>

      <!-- Policy Library - View Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library â€” View Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Policy Library - Edit Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library â€” Edit Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - View Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports â€” View Reports & Analytics</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - Export Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports â€” Export Data & PDFs</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Admin Settings - Access -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Admin Settings â€” Access Settings</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="viewer" />
          </td>
        </tr>

        <!-- Permissions - Manage Permissions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Permissions â€” Manage User Permissions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="viewer" />
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <p class="mt-4 text-xs text-slate-500">
    ğŸ’¡ <strong>Auto-save enabled:</strong> Permission changes are saved automatically to the database and logged in the audit trail.
  </p>
</div>

<!-- Audit Log (Optional - can be added later) -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Permission Changes Audit Log
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Track all permission modifications for compliance and security review.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700">Timestamp</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Action</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">User Affected</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Changed By</th>
        </tr>
      </thead>
      <tbody id="permissions-audit-log" class="divide-y divide-slate-100">
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>











<!-- ğŸ‘† END OF PERMISSIONS TAB -->


</section>
<!-- ğŸ‘† END OF PERMISSIONS TAB -->

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
     ADVANCED FORM TAB - PAYROLL ADVANCE SYSTEM (EMBEDDED)
     â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<section id="tab-advanced-form" class="tab-panel hidden space-y-6">
  <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden" style="min-height: 90vh;">

    <!-- Header -->
    <div class="px-6 py-4 border-b border-slate-200 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-money-bill-wave text-blue-600 text-xl"></i>
        <h2 class="text-xl font-bold text-slate-900">Payroll Advance Request System</h2>
      </div>

      <!-- Fallback open in new tab -->
      <a
        href="https://portal.jengchirestaurant.com/compesation1"
        target="_blank"
        rel="noopener noreferrer"
        class="text-sm font-semibold text-blue-700 hover:text-blue-900"
      >
        Open in new tab
      </a>
    </div>

    <!-- Embedded Page -->
    <iframe
      src="https://portal.jengchirestaurant.com/compesation1"
      class="w-full"
      style="height: 85vh; border: 0;"
      loading="lazy"
    ></iframe>

  </div>
</section>




</div>
<!-- ğŸ‘† END OF TAB CONTAINER -->
</main>
<!-- ğŸ‘† END OF MAIN -->

</div>
<!-- ğŸ‘† END OF APP ROOT -->

<!-- ============================================================================ -->
<!-- ğŸ¯ MODAL MUST BE HERE - OUTSIDE ALL SECTIONS, OUTSIDE MAIN, INSIDE BODY -->
<!-- ============================================================================ -->

<!-- Warning Details Modal - FIXED FOOTER VERSION -->
<div id="warning-detail-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

    <!-- Modal panel with FIXED structure -->
    <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-h-[90vh] flex flex-col">
      
      <!-- FIXED HEADER -->
      <div class="bg-white px-6 pt-5 pb-4 border-b border-slate-200 flex-shrink-0">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-lg font-heading font-bold text-slate-900" id="modal-title">
              Edit Disciplinary Action
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Update action details and save changes
            </p>
          </div>
          
          <!-- WARNING COUNTER (Top Right) -->
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-end gap-1">
              <div class="flex items-center gap-2 text-xs">
                <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 border border-emerald-200 px-2 py-1 text-emerald-700 font-bold">
                  <i class="fa-solid fa-message text-[0.60rem]"></i>
                  <span id="modal-verbal-count">0</span> Verbal
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 border border-amber-200 px-2 py-1 text-amber-700 font-bold">
                  <i class="fa-solid fa-file-lines text-[0.60rem]"></i>
                  <span id="modal-written-count">0</span> Written
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-orange-50 border border-orange-200 px-2 py-1 text-orange-700 font-bold">
                  <i class="fa-solid fa-triangle-exclamation text-[0.60rem]"></i>
                  <span id="modal-final-count">0</span> Final
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-rose-50 border border-rose-200 px-2 py-1 text-rose-700 font-bold">
                  <i class="fa-solid fa-ban text-[0.60rem]"></i>
                  <span id="modal-termination-count">0</span> Term
                </span>
              </div>
            </div>
            
            <button type="button" id="close-warning-modal" class="rounded-lg text-slate-400 hover:text-slate-600 focus:outline-none">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="modal-action-employee-id" />
      <input type="hidden" id="modal-action-index" />

      <!-- SCROLLABLE BODY -->
      <div class="flex-1 overflow-y-auto px-6 py-4">
        <form id="modal-edit-form" class="space-y-4 text-sm">
          
          <!-- Employee Information (Read-only) -->
          <div class="bg-slate-50 rounded-lg p-3">
            <h4 class="text-xs font-bold text-slate-700 uppercase mb-2">Employee Information</h4>
            <div class="grid grid-cols-3 gap-3 text-xs">
              <div>
                <p class="text-slate-500 text-[0.70rem]">Name</p>
                <p class="font-bold text-slate-900" id="modal-employee-name">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Employee ID</p>
                <p class="font-bold text-slate-900" id="modal-employee-id">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Department</p>
                <p class="font-bold text-slate-900" id="modal-employee-dept">--</p>
              </div>
            </div>
          </div>

          <!-- Action Details - EDITABLE -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="modal-edit-type" class="block text-xs font-bold text-slate-700 mb-1">
                Action Type
              </label>
              <select
                id="modal-edit-type"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="VERBAL_WARNING">Verbal Warning</option>
                <option value="WRITTEN_WARNING">Written Warning</option>
                <option value="FINAL_WARNING">Final Warning</option>
                <option value="TERMINATION">Termination</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-severity" class="block text-xs font-bold text-slate-700 mb-1">
                Severity
              </label>
              <select
                id="modal-edit-severity"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-date" class="block text-xs font-bold text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                id="modal-edit-date"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              />
            </div>

            <div>
              <label for="modal-edit-main-category" class="block text-xs font-bold text-slate-700 mb-1">
                Main Category
              </label>
              <select
                id="modal-edit-main-category"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="">Select category...</option>
                <option value="attendance">Attendance & Punctuality</option>
                <option value="performance">Performance Issues</option>
                <option value="conduct">Conduct & Behavior</option>
                <option value="policy">Policy Violations</option>
                <option value="safety">Safety & Health</option>
                <option value="customer">Customer Service</option>
                <option value="integrity">Integrity & Honesty</option>
              </select>
            </div>
          </div>

          <!-- Sub-Category (Dynamic based on Main Category) -->
          <div>
            <label for="modal-edit-sub-category" class="block text-xs font-bold text-slate-700 mb-1">
              Sub-Category / Specific Issue
            </label>
            <select
              id="modal-edit-sub-category"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
            >
              <option value="">Select main category first...</option>
            </select>
          </div>

          <!-- Reason - EDITABLE -->
          <div>
            <label for="modal-edit-reason" class="block text-xs font-bold text-slate-700 mb-1">
              Reason for Action
            </label>
            <textarea
              id="modal-edit-reason"
              rows="4"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Describe the incident and policy violations..."
            ></textarea>
          </div>

          <!-- Corrective Action Plan - EDITABLE -->
          <div>
            <label for="modal-edit-plan" class="block text-xs font-bold text-slate-700 mb-1">
              Corrective Action Plan
            </label>
            <textarea
              id="modal-edit-plan"
              rows="3"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Outline expectations and improvement plan..."
            ></textarea>
          </div>

          <!-- Signatures - EDITABLE -->
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label for="modal-edit-manager-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Manager Signature
              </label>
              <input
                type="text"
                id="modal-edit-manager-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Manager name"
              />
            </div>

                <!-- HR Signature -->
    <div class="flex-1">
      <div class="flex items-center justify-between mb-2">
        <label class="text-xs font-black text-slate-700 uppercase">HR Signature</label>
        <button type="button" id="comp-sig-hr-clear"
          class="text-xs font-bold px-2 py-1 rounded-md bg-slate-100 hover:bg-slate-200 border border-slate-200">
          Clear
        </button>
      </div>
      <input id="comp-sig-hr-name" placeholder="HR name (optional)"
        class="w-full mb-2 px-3 py-2 border border-slate-200 rounded-lg text-sm font-semibold" />
      <canvas id="comp-sig-hr" class="w-full rounded-lg border border-slate-200 bg-white"
        style="height: 120px; touch-action: none;"></canvas>
      <input type="hidden" id="comp-sig-hr-dataurl" />
      <div class="mt-2 text-[0.70rem] text-slate-500 font-semibold">Sign with mouse / finger.</div>
    </div>
  </div>
</div>

            <div>
              <label for="modal-edit-employee-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Employee Signature
              </label>
              <input
                type="text"
                id="modal-edit-employee-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Employee name or DECLINED"
              />
            </div>
          </div>

        </form>
      </div>

      <!-- FIXED FOOTER with buttons -->
      <div class="bg-white px-6 py-4 border-t border-slate-200 flex-shrink-0">
        <div class="flex justify-between items-center gap-3">
          <button 
            type="button" 
            id="modal-delete-btn" 
            class="inline-flex items-center gap-2 rounded-full border border-rose-300 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 transition-colors"
          >
            <i class="fa-solid fa-trash"></i>
            Delete Action
          </button>

          <div class="flex gap-2">
            <button 
              type="button" 
              id="modal-close-btn" 
              class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button" 
              id="modal-export-pdf" 
              class="inline-flex items-center gap-2 rounded-full border border-brand-300 bg-white px-4 py-2 text-xs font-semibold text-brand-700 hover:bg-brand-50 transition-colors"
            >
              <i class="fa-solid fa-file-pdf"></i>
              Export PDF
            </button>
            <button 
  type="button" 
  id="modal-save-btn" 
  class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-5 py-2 text-xs font-bold text-black shadow-sm hover:bg-brand-600 transition-colors"
>
  <i class="fa-solid fa-floppy-disk"></i>
  <span>Save Changes</span>
</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

<!-- Add footer before closing </body> tag -->
<footer class="bg-slate-100 border-t border-slate-200 py-6 mt-auto">
  <div class="max-w-7xl mx-auto px-4 text-center space-y-3">
    <!-- Disclaimer -->
    <p class="text-xs text-slate-600">
      <strong>Disclaimer:</strong> This system is for authorized HR personnel only. All data is confidential and protected under applicable employment laws.
    </p>
    <!-- Copyright & Credits -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-2 text-xs text-slate-500">
      <span>Â© 2026 Jeng Chi Restaurant. All rights reserved.</span>
      <span class="hidden sm:inline">â€¢</span>
      <span>Built by <strong class="text-slate-700">PG</strong></span>
    </div>
  </div>
</footer>








<!-- ğŸ¯ EMPLOYEE 360 MODAL â€” FULL VIEW, NO MASKS -->
<div id="employee-360-modal" class="fixed inset-0 z-50 hidden bg-slate-900/70">
  <div class="fixed inset-2 md:inset-8 bg-white rounded-lg flex flex-col overflow-hidden">
    <!-- Header -->
    <div class="bg-slate-800 text-white p-4 flex justify-between items-center">
      <h2 class="text-xl font-bold" id="modal-employee-name">Loading...</h2>
      <button id="close-360" class="text-white hover:text-slate-300">
        <i class="fa-solid fa-xmark text-2xl"></i>
      </button>
    </div>

    <!-- Tab Bar -->
    <div class="border-b flex overflow-x-auto">
      <button class="px-4 py-3 font-medium border-b-2 border-blue-500 text-blue-600 bg-white" data-tab="core">Core</button>
      <button class="px-4 py-3 font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800" data-tab="discipline">Discipline</button>
      <button class="px-4 py-3 font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800" data-tab="comp">Comp</button>
      <button class="px-4 py-3 font-medium border-b-2 border-transparent text-slate-600 hover:text-slate-800" data-tab="benefits">Benefits</button>
    </div>

    <!-- Tab Content -->
    <div class="flex-1 overflow-y-auto p-6" id="tab-content">
      <!-- Will be filled by JS -->
    </div>
  </div>
</div>

















<script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script></body>
<!-- ğŸ‘† END OF BODY -->

<script>


  






        

      // ========================================================================
      // SUPABASE CLIENT INITIALIZATION
      // ========================================================================
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;


// ========================================================================
// ğŸ¯ ENHANCED CONSOLE LOGGING - START
// ========================================================================
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸš€ Jeng Chi HR Discipline Portal Starting...');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ“ Supabase URL:', SUPABASE_URL);
console.log('âœ… Database client initialized');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
// ========================================================================
// ğŸ¯ ENHANCED CONSOLE LOGGING - END
// ========================================================================
// ============================================================================
// SIGNATURE PAD INITIALIZATION
// ============================================================================
// ============================================================================
// SIGNATURE PAD INITIALIZATION - IMPROVED VERSION
// ============================================================================
// ============================================================================
// SIGNATURE PAD INITIALIZATION - IMPROVED VERSION
// ============================================================================
let empSignaturePad, mgrSignaturePad, hrSignaturePad;

function initializeSignaturePads() {
  console.log('ğŸ–Šï¸ Initializing signature pads...');
  
  // Check if SignaturePad library is loaded
  if (typeof SignaturePad === 'undefined') {
    console.error('âŒ SignaturePad library not loaded!');
    console.error('Make sure the SignaturePad script tag is in your HTML');
    return;
  }
  
  console.log('âœ… SignaturePad library is loaded');
  
  // Employee Signature
  const empCanvas = document.getElementById('comp-sig-emp');
  if (empCanvas) {
    console.log('âœ… Found employee signature canvas');
    try {
      empSignaturePad = new SignaturePad(empCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3
      });
      
      function resizeEmpCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        empCanvas.width = empCanvas.offsetWidth * ratio;
        empCanvas.height = empCanvas.offsetHeight * ratio;
        empCanvas.getContext('2d').scale(ratio, ratio);
        empSignaturePad.clear();
      }
      window.addEventListener('resize', resizeEmpCanvas);
      resizeEmpCanvas();
      console.log('âœ… Employee signature pad initialized');
    } catch (err) {
      console.error('âŒ Failed to initialize employee signature pad:', err);
    }
  } else {
    console.error('âŒ Employee signature canvas not found (comp-sig-emp)');
  }
  
  // Manager Signature
  const mgrCanvas = document.getElementById('comp-sig-mgr');
  if (mgrCanvas) {
    console.log('âœ… Found manager signature canvas');
    try {
      mgrSignaturePad = new SignaturePad(mgrCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3
      });
      
      function resizeMgrCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        mgrCanvas.width = mgrCanvas.offsetWidth * ratio;
        mgrCanvas.height = mgrCanvas.offsetHeight * ratio;
        mgrCanvas.getContext('2d').scale(ratio, ratio);
        mgrSignaturePad.clear();
      }
      window.addEventListener('resize', resizeMgrCanvas);
      resizeMgrCanvas();
      console.log('âœ… Manager signature pad initialized');
    } catch (err) {
      console.error('âŒ Failed to initialize manager signature pad:', err);
    }
  } else {
    console.error('âŒ Manager signature canvas not found (comp-sig-mgr)');
  }
  
  // HR Signature
  const hrCanvas = document.getElementById('comp-sig-hr');
  if (hrCanvas) {
    console.log('âœ… Found HR signature canvas');
    try {
      hrSignaturePad = new SignaturePad(hrCanvas, {
        backgroundColor: 'rgb(255, 255, 255)',
        penColor: 'rgb(0, 0, 0)',
        minWidth: 1,
        maxWidth: 3
      });
      
      function resizeHrCanvas() {
        const ratio = Math.max(window.devicePixelRatio || 1, 1);
        hrCanvas.width = hrCanvas.offsetWidth * ratio;
        hrCanvas.height = hrCanvas.offsetHeight * ratio;
        hrCanvas.getContext('2d').scale(ratio, ratio);
        hrSignaturePad.clear();
      }
      window.addEventListener('resize', resizeHrCanvas);
      resizeHrCanvas();
      console.log('âœ… HR signature pad initialized');
    } catch (err) {
      console.error('âŒ Failed to initialize HR signature pad:', err);
    }
  } else {
    console.error('âŒ HR signature canvas not found (comp-sig-hr)');
  }
  
  // Setup clear buttons
  const empClearBtn = document.getElementById('comp-sig-emp-clear');
  if (empClearBtn) {
    empClearBtn.addEventListener('click', () => {
      if (empSignaturePad) {
        empSignaturePad.clear();
        console.log('ğŸ§¹ Employee signature cleared');
      }
    });
    console.log('âœ… Employee clear button connected');
  }
  
  const mgrClearBtn = document.getElementById('comp-sig-mgr-clear');
  if (mgrClearBtn) {
    mgrClearBtn.addEventListener('click', () => {
      if (mgrSignaturePad) {
        mgrSignaturePad.clear();
        console.log('ğŸ§¹ Manager signature cleared');
      }
    });
    console.log('âœ… Manager clear button connected');
  }
  
  const hrClearBtn = document.getElementById('comp-sig-hr-clear');
  if (hrClearBtn) {
    hrClearBtn.addEventListener('click', () => {
      if (hrSignaturePad) {
        hrSignaturePad.clear();
        console.log('ğŸ§¹ HR signature cleared');
      }
    });
    console.log('âœ… HR clear button connected');
  }
  
  // Final status check
  console.log('ğŸ“Š Signature Pads Status:');
  console.log('  - Employee:', empSignaturePad ? 'âœ… Ready' : 'âŒ Failed');
  console.log('  - Manager:', mgrSignaturePad ? 'âœ… Ready' : 'âŒ Failed');
  console.log('  - HR:', hrSignaturePad ? 'âœ… Ready' : 'âŒ Failed');
  
  if (empSignaturePad && mgrSignaturePad && hrSignaturePad) {
    console.log('âœ… All signature pads initialized successfully');
  } else {
    console.error('âŒ Some signature pads failed to initialize');
  }
}

// Make sure function is globally accessible
window.initializeSignaturePads = initializeSignaturePads;
// ========================================================================
// APPLICATION STATE
// ========================================================================



      // ========================================================================
// APPLICATION STATE
// ========================================================================
const AppState = {
  employees: [],
  selectedEmployee: null,
  employeeFilterStatus: 'all',
  currentTab: 'dashboard',
  charts: { // ğŸ‘ˆ This should already be here
    disciplineTrend: null,
    reportsByType: null,
    reportsByDept: null,
    reportsTrend: null,
    // Add dashboard chart references
    employeeStatusChart: null,
    actionsByTypeChart: null,
    trendChart: null
  },
  settings: {
    thresholds: { low: 2, medium: 5, high: 8 },
    points: { verbal: 1, written: 2, final: 3, termination: 4 },
    notifications: {
      highRisk: true,
      finalWarning: true,
      termination: true,
      dailySummary: false
    },
    display: {
      photos: true,
      compact: false,
      autoRefresh: false
    },
    retention: {
      discipline: 7,
      audit: 7
    }
  }
};



     // âœ… FIXED & ENHANCED POSITION MAP - NOW MATCHES YOUR CSV DATA
const positionMap = {
  // FOH Positions
  'foh manager': 'foh-manager',
  'front of house manager': 'foh-manager',
  'manager': 'foh-manager', // ğŸ‘ˆ ADDED: Maps "Manager" to FOH Manager
  'server': 'server',
  'bartender': 'bartender',
  'host': 'host',
  'hostess': 'host',
  'cashier': 'cashier',
  // BOH Positions
  'line cook': 'line-cook',
  'linecook': 'line-cook',
  'wok chef': 'wok-chef',
  'wok': 'wok-chef',
  'dumpling maker': 'dumpling-maker',
  'dumplings': 'dumpling-maker',
  'prep cook': 'prep-cook',
  'prep': 'prep-cook',
  'kitchen prep': 'prep-cook',
  'pastry chef': 'pastry-chef',
  'pastry': 'pastry-chef',
  'dishwasher': 'dishwasher',
  'dish': 'dishwasher',
  'busser': 'busser',
  'busboy': 'busser',
  'fryer': 'fryer',
  'production manager': 'production-manager',
  'logistic coordinator': 'logistic-coordinator',
  'logistics': 'logistic-coordinator',
  'production manager': 'production-manager',
  'logistic coordinator': 'logistic-coordinator',
  // Also keep hyphenated & trailing-space versions for safety:
  'production-manager': 'production-manager',
  'logistic-coordinator': 'logistic-coordinator',
  'production manager ': 'production-manager',
  'logistic coordinator ': 'logistic-coordinator',
  // Add any other variations you find
  'server ': 'server', // ğŸ‘ˆ ADDED: Handles trailing space
  'wok chef ': 'wok-chef', // ğŸ‘ˆ ADDED: Handles trailing space
  'line cook ': 'line-cook', // ğŸ‘ˆ ADDED: Handles trailing space
  'bartender ': 'bartender', // ğŸ‘ˆ ADDED: Handles trailing space
  'host ': 'host', // ğŸ‘ˆ ADDED: Handles trailing space
  'cashier ': 'cashier', // ğŸ‘ˆ ADDED: Handles trailing space
  'dumpling maker ': 'dumpling-maker', // ğŸ‘ˆ ADDED: Handles trailing space
  'prep cook ': 'prep-cook', // ğŸ‘ˆ ADDED: Handles trailing space
  'pastry chef ': 'pastry-chef', // ğŸ‘ˆ ADDED: Handles trailing space
  'dishwasher ': 'dishwasher', // ğŸ‘ˆ ADDED: Handles trailing space
  'busser ': 'busser', // ğŸ‘ˆ ADDED: Handles trailing space
  'production manager ': 'production-manager', // ğŸ‘ˆ ADDED: Handles trailing space
  'logistic coordinator ': 'logistic-coordinator', // ğŸ‘ˆ ADDED: Handles trailing space
};



// âœ… Updated lists to match the fixed positionMap
const fohPositions = [
  'foh-manager', 'foh manager', 'server', 'bartender', 'host', 'cashier', 'manager'
];
const bohPositions = [
  'line-cook', 'line cook', 'wok-chef', 'wok chef', 'dumpling-maker', 'dumpling maker',
  'prep-cook', 'prep cook', 'pastry-chef', 'pastry chef', 'dishwasher',
  'production-manager', 'production manager', 'logistic-coordinator', 'logistic coordinator',
  'busser', 'fryer'
];



      // Autocomplete state for search inputs
      const AutocompleteState = {
        discipline: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        },
        employees: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        }
      };


// âœ… Safe updater â€” prevents "Cannot set properties of null"
function safeText(id, value, fallback = '--') {
  const el = document.getElementById(id);
  if (el) {
    el.textContent = value;
  } else {
    console.warn(`âš ï¸ Element #${id} not found`);
  }
}





      // ========================================================================
      // UTILITY FUNCTIONS
      // ========================================================================
// âœ… Get filtered actions based on global date filter
function getFilteredActions(filter = 'all-time') {
  let startDate = null;
  let endDate = null; // â† initialize as null, not `now`

  if (filter === 'custom') {
    const startVal = document.getElementById('custom-start-date')?.value;
    const endVal = document.getElementById('custom-end-date')?.value;
    if (startVal) startDate = new Date(startVal);
    if (endVal) endDate = new Date(endVal);
    if (startDate) startDate.setHours(0, 0, 0, 0);
    if (endDate) endDate.setHours(23, 59, 59, 999);
  } else if (filter === 'last-30' || filter === 'last-60' || filter === 'last-90') {
    const days = { 'last-30': 30, 'last-60': 60, 'last-90': 90 }[filter];
    const now = new Date();
    startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    startDate.setHours(0, 0, 0, 0);
    endDate = now;
    endDate.setHours(23, 59, 59, 999);
  } else if (filter === 'ytd') {
    const now = new Date();
    startDate = new Date(now.getFullYear(), 0, 1);
    startDate.setHours(0, 0, 0, 0);
    endDate = now;
    endDate.setHours(23, 59, 59, 999);
  }
  // For 'all-time', startDate & endDate remain null â†’ no filtering

  const actions = [];
  AppState.employees.forEach(emp => {
    const history = emp.discipline_history || [];
    history.forEach(action => {
      const d = new Date(action.date);
      // âœ… Only filter if startDate/endDate are set
      if (
        (!startDate || d >= startDate) &&
        (!endDate || d <= endDate)
      ) {
        actions.push({
          ...action,
          employeeName: `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown',
          department: emp.department || 'Unassigned',
          jobTitle: emp.job_title || emp.position_title || 'N/A'
        });
      }
    });
  });
  return actions;
}




      
    function formatDate(dateString) {
  if (!dateString) return '--';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// âœ… ADD THIS â€” GLOBAL SCOPE, BEFORE ANY FUNCTION THAT CALLS IT
function calculateTenure(hireDate) {
  if (!hireDate) return '--';
  const hire = new Date(hireDate);
  if (isNaN(hire.getTime())) return '--';
  const now = new Date();
  const diffDays = Math.floor(Math.abs(now - hire) / (1000 * 60 * 60 * 24));
  const years = Math.floor(diffDays / 365);
  const months = Math.floor((diffDays % 365) / 30);
  const yearStr = years === 1 ? 'year' : 'years';
  const monthStr = months === 1 ? 'month' : 'months';
  if (years > 0) {
    return `${years} ${yearStr}, ${months} ${monthStr}`;
  }
  return `${months} ${monthStr}`;
}





// âœ… ADD THIS FUNCTION HERE â€” BEFORE ANY CALLS TO IT
function setupDepartmentJobTitleCascade() {
  const deptField = document.getElementById('edit-department');
  const jobTitleField = document.getElementById('edit-job-title');

  if (!deptField || !jobTitleField) {
    console.warn('Department or Job Title field not found');
    return;
  }

  const JOB_TITLES_BY_DEPT = {
    'FOH': [
      { value: 'Cashier', label: 'Cashier', icon: 'fa-cash-register' },
      { value: 'Host', label: 'Host', icon: 'fa-door-open' },
      { value: 'Bartender', label: 'Bartender', icon: 'fa-martini-glass' },
      { value: 'Server', label: 'Server', icon: 'fa-plate-utensils' },
      { value: 'Manager', label: 'Manager', icon: 'fa-user-tie' }
    ],
    'BOH': [
      { value: 'Dishwasher', label: 'Dishwasher', icon: 'fa-sink' },
      { value: 'Line Cook', label: 'Line Cook', icon: 'fa-fire-burner' },
      { value: 'Wok Chef', label: 'Wok Chef', icon: 'fa-bowl-food' },
      { value: 'Dumpling Maker', label: 'Dumpling Maker', icon: 'fa-hand-holding-heart' },
      { value: 'Production Manager', label: 'Production Manager', icon: 'fa-clipboard-check' },
      { value: 'Prep Cook', label: 'Prep Cook', icon: 'fa-knife' },
      { value: 'Busser', label: 'Busser', icon: 'fa-broom' },
      { value: 'Noodle Maker', label: 'Noodle Maker', icon: 'fa-wheat' },
      { value: 'Pastry Chef', label: 'Pastry Chef', icon: 'fa-cake-slice' },
      { value: 'Cleaning', label: 'Cleaning', icon: 'fa-spray-can-sparkles' },
      { value: 'Logistic Coordinator', label: 'Logistic Coordinator', icon: 'fa-truck-fast' }
    ]
  };

  deptField.addEventListener('change', function () {
    const dept = this.value;
    jobTitleField.innerHTML = '';
    jobTitleField.disabled = false;

    if (!dept) {
      const defaultOption = document.createElement('option');
      defaultOption.value = '';
      defaultOption.textContent = 'Select department first';
      jobTitleField.appendChild(defaultOption);
      jobTitleField.disabled = true;
      return;
    }

    // Add blank option
    const blankOption = document.createElement('option');
    blankOption.value = '';
    blankOption.textContent = 'Select job title...';
    jobTitleField.appendChild(blankOption);

    // Add department-specific options
    const titles = JOB_TITLES_BY_DEPT[dept] || [];
    titles.forEach(job => {
      const option = document.createElement('option');
      option.value = job.value;
      option.textContent = job.label;
      option.dataset.icon = job.icon;
      jobTitleField.appendChild(option);
    });
  });

  console.log('âœ… Department-Job Title cascade setup complete with icons');
} // â† THIS IS CRITICAL



      function computeRiskScore(employee) {
        const { verbal_warning_count = 0, disciplinary_warning_count = 0, final_warning_count = 0, termination_letter_count = 0 } = employee;
        const { points } = AppState.settings;
        return (
          verbal_warning_count * points.verbal +
          disciplinary_warning_count * points.written +
          final_warning_count * points.final +
          termination_letter_count * points.termination
        );
      }


// ğŸ¯ EMPLOYEE 360 MODAL â€” FULL DATA, NO MASKS
function openEmployee360(emp) {
  // Build modal HTML with full raw data
  const modalHTML = `
    <div class="fixed inset-0 z-50 flex items-center justify-center bg-black/60">
      <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto p-6">
        <div class="flex justify-between items-center mb-4">
          <h2 class="text-2xl font-bold">${emp.first_name} ${emp.last_name}</h2>
          <button onclick="document.querySelector('#employee-360-modal')?.remove()" 
                  class="text-gray-500 hover:text-gray-800 text-2xl">&times;</button>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div><h3 class="font-bold mb-2">Personal</h3>
            <p><strong>ID:</strong> ${emp.employee_id || 'â€“'}</p>
            <p><strong>SSN:</strong> ${emp.ssn || 'â€“'}</p>
            <p><strong>DOB:</strong> ${emp.dob || 'â€“'}</p>
            <p><strong>Phone:</strong> ${emp.phone || 'â€“'}</p>
            <p><strong>Email:</strong> ${emp.email || 'â€“'}</p>
          </div>
          <div><h3 class="font-bold mb-2">Employment</h3>
            <p><strong>Status:</strong> ${emp.employment_status || 'â€“'}</p>
            <p><strong>Job Title:</strong> ${emp.job_title || 'â€“'}</p>
            <p><strong>Secondary:</strong> ${emp.job_title2 || 'â€“'}</p>
            <p><strong>Department:</strong> ${emp.department || 'â€“'}</p>
            <p><strong>Hire Date:</strong> ${emp.hire_date || 'â€“'}</p>
            <p><strong>Comp Type:</strong> ${emp.compensation_type || 'â€“'}</p>
            <p><strong>Annual Salary:</strong> ${emp.annual_salary || 'â€“'}</p>
            <p><strong>Hourly Rate:</strong> ${emp.hourly_rate || 'â€“'}</p>
          </div>
        </div>
      </div>
    </div>
  `;
  // Append modal to body
  document.body.insertAdjacentHTML('beforeend', `<div id="employee-360-modal">${modalHTML}</div>`);
}





















      function getRiskLevel(score) {
        const { thresholds } = AppState.settings;
        if (score >= thresholds.high) return 'HIGH';
        if (score >= thresholds.medium) return 'MEDIUM';
        return 'LOW';
      }

      function getRiskBadgeClasses(level) {
        switch (level) {
          case 'HIGH':
            return 'bg-rose-50 border-rose-200 text-rose-700';
          case 'MEDIUM':
            return 'bg-amber-50 border-amber-200 text-amber-700';
          default:
            return 'bg-emerald-50 border-emerald-200 text-emerald-700';
        }
      }

      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-rose-500' : 'bg-brand-500';
        toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-lg text-sm flex items-center gap-2`;
        toast.innerHTML = `
          <i class="fa-solid fa-circle-info"></i>
          <span>${message}</span>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ========================================================================
      // TAB SWITCHING
      // ========================================================================
      


















      
   function showTab(tabName) {
  console.log('');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('ğŸ”„ SHOWTAB CALLED WITH:', tabName);
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');

  // âœ… Hide all tab panels
  console.log('1ï¸âƒ£ Hiding all tab panels...');
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.add('hidden');
    console.log('  Hidden:', panel.id);
  });

  // âœ… Reset all tab buttons to inactive
  console.log('2ï¸âƒ£ Resetting all tab buttons...');
  document.querySelectorAll('.tab-trigger').forEach(btn => {
    btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-300');
    btn.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
    const icon = btn.querySelector('i');
    if (icon) icon.classList.remove('text-blue-600');
    console.log('  Reset button:', btn.dataset.tabTarget);
  });

  // âœ… Activate target tab panel
  console.log('3ï¸âƒ£ Looking for target panel: tab-' + tabName);
  const targetPanel = document.getElementById(`tab-${tabName}`);
  console.log('  Found panel:', targetPanel);
  
  if (targetPanel) {
    console.log('  âœ… Removing hidden class from panel');
    targetPanel.classList.remove('hidden');
    console.log('  Panel classes after:', targetPanel.className);
  } else {
    console.error('  âŒ PANEL NOT FOUND! ID should be: tab-' + tabName);
  }

  // âœ… Activate target tab button
  console.log('4ï¸âƒ£ Looking for target button: [data-tab-target="' + tabName + '"]');
  const targetButton = document.querySelector(`[data-tab-target="${tabName}"]`);
  console.log('  Found button:', targetButton);
  
  if (targetButton) {
    console.log('  âœ… Activating button');
    targetButton.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
    targetButton.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-300');
    const icon = targetButton.querySelector('i');
    if (icon) icon.classList.add('text-blue-600');
    console.log('  Button classes after:', targetButton.className);
  } else {
    console.error('  âŒ BUTTON NOT FOUND!');
  }

  // âœ… If switching to dashboard, update KPIs
  if (tabName === 'dashboard') {
    console.log('5ï¸âƒ£ Dashboard tab - updating KPIs...');
    updateDashboardKPIs();
  }

  // âœ… Compensation Letter tab: initialize/resize signature pads AFTER showing panel
  if (tabName === 'compensation-letter') {
    console.log('5ï¸âƒ£ Compensation Letter tab - initializing signature pads...');
    setTimeout(() => {
      console.log('ğŸ”„ Re-initializing signature pads (with delay)...');
      if (typeof initializeSignaturePads === 'function') {
        initializeSignaturePads();
      } else {
        console.error('âŒ initializeSignaturePads function not found!');
      }
    }, 100);
  }

  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('âœ… SHOWTAB COMPLETE');
  console.log('â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•');
  console.log('');
}


      // ========================================================================
      // EMPLOYEE DATA LOADING
      // ========================================================================
      
    async function loadEmployees() {
  console.log('');
  console.log('ğŸ“Š DATABASE OPERATION: Loading Employees');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ”„ Executing query: SELECT * FROM employees2025');

  try {
    const startTime = performance.now();

   const { data, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .order('last_name', { ascending: true });

    const endTime = performance.now();
    console.log(`â±ï¸  Query completed in ${(endTime - startTime).toFixed(2)}ms`);

    if (error) {
      console.error('âŒ DATABASE ERROR:', error);
      throw error;
    }

    // âœ… Store employees safely
    AppState.employees = Array.isArray(data) ? data : [];

    console.log(`âœ… SUCCESS: Loaded ${AppState.employees.length} employees`);

    // ğŸ”„ Update header timestamp
    const refreshEl = document.getElementById('header-last-refreshed');
    if (refreshEl) {
      const now = new Date();
      refreshEl.textContent = now.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // âœ…âœ…âœ… CRITICAL FIX: Always update KPIs after loading data â€” regardless of tab visibility
    updateDashboardKPIs(); // ğŸ‘ˆ THIS LINE WAS MISSING

    // ğŸ§  Also update full dashboard if visible
    const dashboardTab = document.getElementById('tab-dashboard');
    if (dashboardTab && !dashboardTab.classList.contains('hidden')) {
      updateDashboard?.(); // re-renders charts
    }

    showToast(`Loaded ${AppState.employees.length} employees`, 'success');

    return AppState.employees;

  } catch (err) {
    console.error('ğŸ’¥ CRITICAL ERROR in loadEmployees()', err);
    showToast('Failed to load employees: ' + err.message, 'error');
    return [];
  }
}


      function filterEmployees(filterType) {
        AppState.employeeFilterStatus = filterType;
        
        let filtered = [...AppState.employees];
        
        if (filterType === 'Active') {
          filtered = filtered.filter(emp => emp.employment_status === 'Active');
        } else if (filterType === 'Terminated') {
          filtered = filtered.filter(emp => emp.employment_status === 'Terminated');
        } else if (filterType === 'HighRisk') {
          filtered = filtered.filter(emp => {
            const score = computeRiskScore(emp);
            return getRiskLevel(score) === 'HIGH';
          });
        }
        
        return filtered;
      }

      // ========================================================================
      // DASHBOARD TAB FUNCTIONS




      // ========================================================================







function updateDashboard() {
  const filter = document.getElementById('global-date-filter')?.value || 'all-time';
  const actions = getFilteredActions(filter);
  
  updateDashboardKPIs(actions); // âœ… pass `actions`
  populateDashboardWarningsByDept(actions);
  populateDashboardDisciplineList(actions);
  renderDashboardCharts(actions); // âœ… This will now work safely
}



// âœ… FINAL CORRECTED updateDashboardKPIs â€” NO duplicate loops, NO unsafe .textContent
// ========================================================================
// DASHBOARD KPIs - UPDATED FOR 3x3 GRID
// ========================================================================




function updateDashboardKPIs(actions = []) {
// âœ… STEP 1: Filter out owners AND inactive employees (now 3 owners)
const owners = ['janelle teng', 'francisco teng', 'shoko teng'];
const fohPositions = ['foh-manager', 'foh manager', 'server', 'bartender', 'host', 'cashier', 'manager'];
const bohPositions = ['line-cook', 'line cook', 'wok-chef', 'wok chef', 'dumpling-maker', 'dumpling maker', 'prep-cook', 'prep cook', 'pastry-chef', 'pastry chef', 'dishwasher', 'fryer', 'production-manager', 'production manager', 'logistic-coordinator', 'logistic coordinator', 'busser'];

const activeNonOwners = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    const isOwner = owners.includes(fullName);
    const isActive = emp.employment_status?.toLowerCase() === 'active';
    return !isOwner && isActive;
});

  // âœ… STEP 2: Active / Inactive counts - FIXED
  const activeCount = activeNonOwners.length;
  
  // Calculate REAL inactive count (non-owners who are not active)
  const inactiveCount = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    const isOwner = owners.includes(fullName);
    const isActive = emp.employment_status?.toLowerCase() === 'active';
    return !isOwner && !isActive; // â† NOT active = inactive
  }).length;
  
  safeText('kpi-active-employees', activeCount);
  safeText('kpi-inactive-employees', inactiveCount); // âœ… NOW SHOWS REAL COUNT

  // âœ… STEP 3: Position Counts - WITH DEBUGGING
  const positionCounts = {
    'foh-manager': 0, 'server': 0, 'bartender': 0, 'host': 0, 'cashier': 0,
    'line-cook': 0, 'wok-chef': 0, 'dumpling-maker': 0, 'prep-cook': 0,
    'pastry-chef': 0, 'dishwasher': 0, 'fryer': 0, 'production-manager': 0,
    'logistic-coordinator': 0, 'busser': 0
  };

  const unmatchedEmployees = []; // â† TRACK UNMATCHED

  activeNonOwners.forEach(emp => {
    let title = (emp.job_title || '').trim();
    if (!title) {
      unmatchedEmployees.push({ name: `${emp.first_name} ${emp.last_name}`, reason: 'No job title', id: emp.employee_id });
      return;
    }
    title = title.toLowerCase();

    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }
    
    if (mapped && positionCounts[mapped] !== undefined) {
      positionCounts[mapped]++;
    } else {
      unmatchedEmployees.push({ 
        name: `${emp.first_name} ${emp.last_name}`, 
        title: emp.job_title,
        reason: 'Job title not in positionMap',
        id: emp.employee_id 
      });
    }
  });

  // âœ… LOG UNMATCHED EMPLOYEES
  if (unmatchedEmployees.length > 0) {
    console.warn('âš ï¸ EMPLOYEES NOT COUNTED IN POSITION DISTRIBUTION:');
    console.table(unmatchedEmployees);
  }

  // Update position KPIs
  Object.keys(positionCounts).forEach(key => {
    safeText(`kpi-${key}`, positionCounts[key]);
  });

  // âœ… STEP 4: FOH / BOH Totals
  // Calculate active FOH/BOH totals from position counts
  const fohActiveTotal = (positionCounts['foh-manager'] || 0) + 
                         (positionCounts['server'] || 0) + 
                         (positionCounts['bartender'] || 0) + 
                         (positionCounts['host'] || 0) + 
                         (positionCounts['cashier'] || 0);
  
  const bohActiveTotal = (positionCounts['line-cook'] || 0) + 
                         (positionCounts['wok-chef'] || 0) + 
                         (positionCounts['dumpling-maker'] || 0) + 
                         (positionCounts['prep-cook'] || 0) + 
                         (positionCounts['pastry-chef'] || 0) + 
                         (positionCounts['dishwasher'] || 0) + 
                         (positionCounts['fryer'] || 0) + 
                         (positionCounts['production-manager'] || 0) + 
                         (positionCounts['logistic-coordinator'] || 0) + 
                         (positionCounts['busser'] || 0);

  safeText('kpi-foh-total', fohActiveTotal);
  safeText('kpi-boh-total', bohActiveTotal);

  // âœ… STEP 5: Discipline Counts (same as before)
  const fohDisciplines = { verbal: 0, written: 0, final: 0, termination: 0 };
  const bohDisciplines = { verbal: 0, written: 0, final: 0, termination: 0 };

  actions.forEach(action => {
    const emp = activeNonOwners.find(e => e.id == action.employee_id);
    if (!emp) return;

    const title = (emp.job_title || '').toLowerCase().trim().trim().trim();
    let mapped = positionMap[title] ||
                 positionMap[title.replace(/[-\s]+/g, ' ')] ||
                 Object.keys(positionMap).find(k => title.includes(k.replace(/\s+/g, '')))?.then(k => positionMap[k]);

    const isFOH = mapped && fohPositions.includes(mapped);
    const isBOH = mapped && bohPositions.includes(mapped);
    const target = isFOH ? fohDisciplines : isBOH ? bohDisciplines : null;
    if (!target) return;

    const type = (action.type || '').toLowerCase();
    if (type.includes('verbal')) target.verbal++;
    else if (type.includes('written')) target.written++;
    else if (type.includes('final')) target.final++;
    else if (type.includes('termination')) target.termination++;
  });

  safeText('kpi-foh-verbal', fohDisciplines.verbal);
  safeText('kpi-foh-written', fohDisciplines.written);
  safeText('kpi-foh-final', fohDisciplines.final);
  safeText('kpi-foh-termination', fohDisciplines.termination);
  safeText('kpi-boh-verbal', bohDisciplines.verbal);
  safeText('kpi-boh-written', bohDisciplines.written);
  safeText('kpi-boh-final', bohDisciplines.final);
  safeText('kpi-boh-termination', bohDisciplines.termination);
// ===================================================================
  // REPLACE LINES 5327-5340 WITH THIS COMPLETE SECTION
  // This counts FOH/BOH disciplines from employee records (same method as position breakdown)
  // ===================================================================

  // âœ… CALCULATE TOTAL FOH & BOH DISCIPLINES FROM EMPLOYEE RECORDS
  let fohTotalDisciplines = 0;
  let bohTotalDisciplines = 0;

  activeNonOwners.forEach(emp => {
    let title = (emp.job_title || '').trim();
    if (!title) return;
    title = title.toLowerCase();

    // Map the job title to a standardized position key (same logic as position breakdown)
    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }

    // Calculate total disciplines for this employee from their warning counts
    const empTotal = (emp.verbal_warning_count || 0) + 
                     (emp.disciplinary_warning_count || 0) + 
                     (emp.final_warning_count || 0) + 
                     (emp.termination_letter_count || 0);

    // Add to FOH or BOH total based on position
    if (mapped && fohPositions.includes(mapped)) {
      fohTotalDisciplines += empTotal;
    } else if (mapped && bohPositions.includes(mapped)) {
      bohTotalDisciplines += empTotal;
    }
  });

  // Update the KPI displays
  safeText('kpi-foh-total-disciplines', fohTotalDisciplines);
  safeText('kpi-boh-total-disciplines', bohTotalDisciplines);

  console.log('ğŸ“Š FOH Total Disciplines:', fohTotalDisciplines, '(from', activeNonOwners.filter(e => {
    const title = (e.job_title || '').toLowerCase().trim();
    let mapped = positionMap[title] || positionMap[title.replace(/[-\s]+/g, ' ')];
    return mapped && fohPositions.includes(mapped);
  }).length, 'FOH employees)');
  
  console.log('ğŸ“Š BOH Total Disciplines:', bohTotalDisciplines, '(from', activeNonOwners.filter(e => {
    const title = (e.job_title || '').toLowerCase().trim();
    let mapped = positionMap[title] || positionMap[title.replace(/[-\s]+/g, ' ')];
    return mapped && bohPositions.includes(mapped);
  }).length, 'BOH employees)');



  // âœ… STEP 6: Compensation Summary (same as before)
  const salaryEmployees = activeNonOwners.filter(e => e.compensation_type === 'salary');
  const hourlyEmployees = activeNonOwners.filter(e => e.compensation_type === 'hourly');
  safeText('kpi-salary-count', salaryEmployees.length);
  safeText('kpi-hourly-count', hourlyEmployees.length);

  const avgHourly = hourlyEmployees.length > 0
    ? (hourlyEmployees.reduce((sum, e) => sum + (parseFloat(e.hourly_rate) || 0), 0) / hourlyEmployees.length).toFixed(2)
    : '0.00';
  const avgSalary = salaryEmployees.length > 0
    ? (salaryEmployees.reduce((sum, e) => sum + (parseFloat(e.annual_salary) || 0), 0) / salaryEmployees.length).toFixed(2)
    : '0.00';

  safeText('kpi-average-hourly-rate', `$${avgHourly}`);
  safeText('kpi-average-annual-salary', `$${avgSalary}`);

  // âœ… STEP 7: High-Risk
  const highRiskCount = activeNonOwners.filter(e => {
    const score = computeRiskScore(e);
    return getRiskLevel(score) === 'HIGH';
  }).length;
  safeText('kpi-high-risk-employees', highRiskCount);




// âœ… STEP 8: Termination Rate â€” Overall, FOH, BOH
const nonOwnerEmployees = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    return !owners.includes(fullName);
});

const getPositionKey = (jobTitle) => {
    if (!jobTitle) return null;
    const title = jobTitle.toLowerCase().trim();
    return positionMap[title] ||
           positionMap[title.replace(/[-\s]+/g, ' ')] ||
           Object.keys(positionMap).find(k => title.includes(k.replace(/\s+/g, '')))?.then(k => positionMap[k]);
};

// Group employees
const fohEmployees = nonOwnerEmployees.filter(e => fohPositions.includes(getPositionKey(e.job_title)));
const bohEmployees = nonOwnerEmployees.filter(e => bohPositions.includes(getPositionKey(e.job_title)));

// Count terminated
const fohTerminated = fohEmployees.filter(e => e.employment_status?.toLowerCase() === 'terminated').length;
const bohTerminated = bohEmployees.filter(e => e.employment_status?.toLowerCase() === 'terminated').length;
const overallTerminated = nonOwnerEmployees.filter(e => e.employment_status?.toLowerCase() === 'terminated').length;

// Denominators (total non-owners in each group)
const fohTotal = fohEmployees.length;
const bohTotal = bohEmployees.length;
const overallTotal = nonOwnerEmployees.length;

// Safe division
const calcRate = (num, den) => den > 0 ? ((num / den) * 100).toFixed(1) : '0.0';
const fohRate = calcRate(fohTerminated, fohTotal);
const bohRate = calcRate(bohTerminated, bohTotal);
const overallRate = calcRate(overallTerminated, overallTotal);

// âœ… Update DOM â€” keep overall in Cell 1x4, add new ones for Cell 4x3
safeText('kpi-termination-rate', `${overallRate}%`);           // â† Cell 1x4 (unchanged ID)
safeText('kpi-termination-rate-foh', `${fohRate}%`);           // â† NEW â€” for Cell 4x3
safeText('kpi-termination-rate-boh', `${bohRate}%`);           // â† NEW â€” for Cell 4x3

  // âœ… STEP 9: High-Risk Breakdown by Position (FOH & BOH)
  const highRiskByPosition = {
    // FOH positions
    'foh-manager': 0, 'server': 0, 'bartender': 0, 'host': 0, 'cashier': 0,
    // BOH positions
    'line-cook': 0, 'wok-chef': 0, 'dumpling-maker': 0, 'busser': 0,
    'prep-cook': 0, 'pastry-chef': 0, 'dishwasher': 0, 'fryer': 0,
    'production-manager': 0, 'logistic-coordinator': 0
  };

  // Count high-risk employees by position
  activeNonOwners.forEach(emp => {
    const score = computeRiskScore(emp);
    if (getRiskLevel(score) === 'HIGH') {
      let title = (emp.job_title || '').trim();
      if (!title) return;
      title = title.toLowerCase();

      let mapped = positionMap[title];
      if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
      if (!mapped) {
        for (const [pattern, key] of Object.entries(positionMap)) {
          if (title.includes(pattern.replace(/\s+/g, ''))) {
            mapped = key;
            break;
          }
        }
      }
      
      if (mapped && highRiskByPosition[mapped] !== undefined) {
        highRiskByPosition[mapped]++;
      }
    }
  });

  // Update High-Risk KPIs for each position

// Update High-Risk KPIs for each position
  Object.keys(highRiskByPosition).forEach(key => {
    safeText(`kpi-${key}-high-risk`, highRiskByPosition[key]);
  });

  // âœ… STEP 10: DISCIPLINE BREAKDOWN BY POSITION (FOR BOH/FOH DISCIPLINE SECTIONS)
  const disciplineByPosition = {
    // FOH positions
    'foh-manager': 0, 'server': 0, 'bartender': 0, 'host': 0, 'cashier': 0,
    // BOH positions
    'line-cook': 0, 'wok-chef': 0, 'dumpling-maker': 0, 'busser': 0,
    'prep-cook': 0, 'pastry-chef': 0, 'dishwasher': 0, 'fryer': 0,
    'production-manager': 0, 'logistic-coordinator': 0
  };

  // Count ALL discipline actions by position (from employees directly, not actions)
  activeNonOwners.forEach(emp => {
    let title = (emp.job_title || '').trim();
    if (!title) return;
    title = title.toLowerCase();

    // Map the job title to a standardized position key
    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }
    
    if (mapped && disciplineByPosition[mapped] !== undefined) {
      // Sum ALL discipline counts for this employee
      const totalDisciplines = 
        (emp.verbal_warning_count || 0) + 
        (emp.disciplinary_warning_count || 0) + 
        (emp.final_warning_count || 0) + 
        (emp.termination_letter_count || 0);
      
      disciplineByPosition[mapped] += totalDisciplines;
    }
  });

  // Update Discipline KPIs for each position
  Object.keys(disciplineByPosition).forEach(key => {
    safeText(`kpi-${key}-discipline`, disciplineByPosition[key]);
  });

  console.log('ğŸ“Š Discipline by position updated:', disciplineByPosition);
}










    function populateDashboardWarningsByDept(actions) {
  const tbody = document.getElementById('table-dashboard-warnings-by-dept');
  if (!tbody) return;
  tbody.innerHTML = '';
  const deptMap = {};
  actions.forEach(action => {
    const dept = action.department || 'Unassigned';
    if (!deptMap[dept]) deptMap[dept] = { V: 0, W: 0, F: 0, T: 0 };
    const type = (action.type || '').toUpperCase();
    if (type.includes('VERBAL')) deptMap[dept].V++;
    else if (type.includes('WRITTEN')) deptMap[dept].W++;
    else if (type.includes('FINAL')) deptMap[dept].F++;
    else if (type.includes('TERMINATION')) deptMap[dept].T++;
  });
  Object.entries(deptMap).forEach(([dept, counts]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-2 py-2 font-medium">${dept}</td>
      <td class="px-2 py-2 text-center">${counts.V}</td>
      <td class="px-2 py-2 text-center">${counts.W}</td>
      <td class="px-2 py-2 text-center">${counts.F}</td>
      <td class="px-2 py-2 text-center">${counts.T}</td>
    `;
    tbody.appendChild(row);
  });
}








    function populateDashboardDisciplineList(actions) {
  const tbody = document.getElementById('dashboard-discipline-table-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  const recent = actions.slice(0, 10).reverse();
  if (recent.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3" class="px-2 py-3 text-center text-slate-500">No actions in selected range</td></tr>`;
    return;
  }
  recent.forEach(a => {
    const row = document.createElement('tr');
    const date = new Date(a.date);
    row.innerHTML = `
      <td class="px-2 py-2 text-slate-600">${date.toLocaleDateString()}</td>
      <td class="px-2 py-2 text-slate-900 font-medium">${a.employeeName}</td>
      <td class="px-2 py-2 text-slate-700">${a.type || 'â€”'}</td>
    `;
    tbody.appendChild(row);
  });
}

// ========================================================================
// MODAL FUNCTIONS - EDITABLE VERSION
// ========================================================================

// Show modal with action data (FAST VERSION - no database calls)
function showWarningDetailModal(action) {
  console.log('ğŸ¯ Opening modal for action:', action);
  
  const modal = document.getElementById('warning-detail-modal');
  if (!modal) {
    console.error('âŒ Modal element not found!');
    return;
  }
  
  // Store IDs for save operation
  document.getElementById('modal-action-employee-id').value = action.employeeId;
  document.getElementById('modal-action-index').value = action.originalIndex || 0;
  
  // Populate read-only employee info
  document.getElementById('modal-employee-name').textContent = action.employeeName;
  document.getElementById('modal-employee-id').textContent = action.employeeNumber || 'N/A';
  document.getElementById('modal-employee-dept').textContent = action.department;
  
  // âœ… POPULATE WARNING COUNTERS
  const employee = AppState.employees.find(e => e.id === action.employeeId);
  if (employee) {
    document.getElementById('modal-verbal-count').textContent = employee.verbal_warning_count || 0;
    document.getElementById('modal-written-count').textContent = employee.disciplinary_warning_count || 0;
    document.getElementById('modal-final-count').textContent = employee.final_warning_count || 0;
    document.getElementById('modal-termination-count').textContent = employee.termination_letter_count || 0;
  }
  
  // Populate editable fields
  const actionType = action.type?.toUpperCase().replace(/\s+/g, '_') || 'VERBAL_WARNING';
  document.getElementById('modal-edit-type').value = actionType;
  
  document.getElementById('modal-edit-severity').value = action.severity || 'MEDIUM';
  
  // Fix date format
  let dateValue = '';
  if (action.date) {
    const d = new Date(action.date);
    if (!isNaN(d.getTime())) {
      dateValue = d.toISOString().split('T')[0];
    }
  }
  document.getElementById('modal-edit-date').value = dateValue;
  
  // âœ… Populate category fields
  document.getElementById('modal-edit-main-category').value = action.main_category || '';
  
  // Trigger sub-category population
  const mainCategoryDropdown = document.getElementById('modal-edit-main-category');
  const event = new Event('change');
  mainCategoryDropdown.dispatchEvent(event);
  
  // Set sub-category after options are loaded
  setTimeout(() => {
    document.getElementById('modal-edit-sub-category').value = action.sub_category || '';
  }, 10);
  
  document.getElementById('modal-edit-reason').value = action.reason || '';
  document.getElementById('modal-edit-plan').value = action.corrective_plan || '';
  document.getElementById('modal-edit-manager-sig').value = action.manager_signature || '';
  document.getElementById('modal-edit-hr-sig').value = action.hr_signature || '';
  document.getElementById('modal-edit-employee-sig').value = action.employee_signature || '';
  
  // Show modal
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  console.log('âœ… Modal opened successfully');
}



// Close modal
function closeWarningModal() {
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }
}

// Save updated action to database
async function saveWarningModal() {
  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const saveBtn = document.getElementById('modal-save-btn');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

 // Get updated values from form
const updatedAction = {
  type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
  date: document.getElementById('modal-edit-date').value,
  severity: document.getElementById('modal-edit-severity').value,
  main_category: document.getElementById('modal-edit-main-category').value,  // â† ADD
  sub_category: document.getElementById('modal-edit-sub-category').value,    // â† ADD
  reason: document.getElementById('modal-edit-reason').value,
  corrective_plan: document.getElementById('modal-edit-plan').value,
  manager_signature: document.getElementById('modal-edit-manager-sig').value,
  hr_signature: document.getElementById('modal-edit-hr-sig').value,
  employee_signature: document.getElementById('modal-edit-employee-sig').value,
  timestamp: employee.discipline_history?.[actionIndex]?.timestamp || new Date().toISOString()
};
    // Update the specific action in history array
    const history = [...(employee.discipline_history || [])];
    if (actionIndex >= 0 && actionIndex < history.length) {
      history[actionIndex] = updatedAction;
    }

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history[history.length - 1]
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('âœ… Action updated successfully!', 'success');
    closeWarningModal();
    
    // Reload data and refresh display
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error saving action:', error);
    showToast('âŒ Failed to save changes', 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
  }
}

// Delete action from database
async function deleteWarningModal() {
  if (!confirm('Are you sure you want to delete this disciplinary action? This cannot be undone.')) {
    return;
  }

  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const deleteBtn = document.getElementById('modal-delete-btn');
  deleteBtn.disabled = true;
  deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

    // Remove action from history
    const history = [...(employee.discipline_history || [])];
    history.splice(actionIndex, 1);

    // Recalculate counts
    const counts = {
      verbal_warning_count: 0,
      disciplinary_warning_count: 0,
      final_warning_count: 0,
      termination_letter_count: 0
    };

    history.forEach(action => {
      const type = action.type.toUpperCase();
      if (type.includes('VERBAL')) counts.verbal_warning_count++;
      else if (type.includes('WRITTEN')) counts.disciplinary_warning_count++;
      else if (type.includes('FINAL')) counts.final_warning_count++;
      else if (type.includes('TERMINATION')) counts.termination_letter_count++;
    });

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history.length > 0 ? history[history.length - 1] : null,
        ...counts
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('âœ… Action deleted successfully', 'success');
    closeWarningModal();
    
    // Reload data
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error deleting action:', error);
    showToast('âŒ Failed to delete action', 'error');
  } finally {
    deleteBtn.disabled = false;
    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Action';
  }
}

// Generate PDF from modal data
function generateWarningPDF() {
  const action = {
    employeeName: document.getElementById('modal-employee-name').textContent,
    employeeNumber: document.getElementById('modal-employee-id').textContent,
    department: document.getElementById('modal-employee-dept').textContent,
    type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
    date: document.getElementById('modal-edit-date').value,
    severity: document.getElementById('modal-edit-severity').value,
    reference: document.getElementById('modal-edit-reference').value,
    reason: document.getElementById('modal-edit-reason').value,
    corrective_plan: document.getElementById('modal-edit-plan').value,
    manager_signature: document.getElementById('modal-edit-manager-sig').value,
    hr_signature: document.getElementById('modal-edit-hr-sig').value,
    employee_signature: document.getElementById('modal-edit-employee-sig').value
  };

  const actionDate = new Date(action.date);
  const dateStr = actionDate.toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
  
  const content = `
    <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #7a1f1f; padding-bottom: 20px;">
        <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
        <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
        <p><strong>Name:</strong> ${action.employeeName}</p>
        <p><strong>Employee ID:</strong> ${action.employeeNumber}</p>
        <p><strong>Department:</strong> ${action.department}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Action Details</h3>
        <p><strong>Action Type:</strong> ${action.type}</p>
        <p><strong>Date:</strong> ${dateStr}</p>
        <p><strong>Severity:</strong> ${action.severity}</p>
        <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Reason for Action</h3>
        <p style="white-space: pre-wrap;">${action.reason || 'No reason provided'}</p>
      </div>
      
      ${action.corrective_plan ? `
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Corrective Action Plan</h3>
        <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
      </div>
      ` : ''}
      
      <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
        <h3 style="color: #333;">Signatures</h3>
        <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
        <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
        <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
      </div>
    </div>
  `;

  const element = document.createElement('div');
  element.innerHTML = content;
  
  html2pdf()
    .from(element)
    .set({
      margin: 0.5,
      filename: `warning-${action.employeeNumber}-${action.date}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    })
    .save();
}



// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================
const DISCIPLINE_CATEGORIES = {
  attendance: [
    { value: 'late', label: 'Late Arrival' },
    { value: 'early-leave', label: 'Early Departure' },
    { value: 'no-call-no-show', label: 'No Call / No Show' },
    { value: 'excessive-absences', label: 'Excessive Absences' },
    { value: 'unapproved-absence', label: 'Unapproved Absence' },
    { value: 'break-violation', label: 'Extended Breaks' }
  ],
  performance: [
    { value: 'quality', label: 'Work Quality Below Standard' },
    { value: 'productivity', label: 'Low Productivity' },
    { value: 'missed-deadline', label: 'Missed Deadlines' },
    { value: 'failure-to-follow', label: 'Failure to Follow Instructions' },
    { value: 'incomplete-tasks', label: 'Incomplete Tasks' }
  ],
  conduct: [
    { value: 'unprofessional', label: 'Unprofessional Behavior' },
    { value: 'disrespectful', label: 'Disrespectful to Staff/Management' },
    { value: 'inappropriate-language', label: 'Inappropriate Language' },
    { value: 'conflict', label: 'Conflict with Coworkers' },
    { value: 'insubordination', label: 'Insubordination' },
    { value: 'horseplay', label: 'Horseplay / Roughhousing' }
  ],
  policy: [
    { value: 'uniform', label: 'Uniform Violation' },
    { value: 'cell-phone', label: 'Cell Phone / Earbuds Use' },
    { value: 'eating-drinking', label: 'Eating/Drinking in Wrong Area' },
    { value: 'smoking', label: 'Smoking/Vaping Violation' },
    { value: 'unauthorized-discount', label: 'Unauthorized Discount/Comp' },
    { value: 'confidentiality', label: 'Confidentiality Breach' },
    { value: 'social-media', label: 'Social Media Policy Violation' }
  ],
  safety: [
    { value: 'food-safety', label: 'Food Safety Violation' },
    { value: 'sanitation', label: 'Sanitation/Cleanliness Issue' },
    { value: 'unsafe-practice', label: 'Unsafe Work Practice' },
    { value: 'equipment-misuse', label: 'Equipment Misuse' },
    { value: 'injury-report', label: 'Failure to Report Injury' }
  ],
  customer: [
    { value: 'rude-to-guest', label: 'Rude to Guest' },
    { value: 'poor-service', label: 'Poor Service Quality' },
    { value: 'order-error', label: 'Repeated Order Errors' },
    { value: 'complaint', label: 'Guest Complaint' },
    { value: 'refusal-to-serve', label: 'Refusal to Serve Guest' }
  ],
  integrity: [
    { value: 'theft', label: 'Theft' },
    { value: 'dishonesty', label: 'Dishonesty / Lying' },
    { value: 'timecard-fraud', label: 'Timecard Fraud' },
    { value: 'tip-theft', label: 'Tip Theft / Manipulation' },
    { value: 'falsifying-records', label: 'Falsifying Records' }
  ]
};





// Attach modal event listeners (call this in bootstrap)
function setupModalEventListeners() {
  console.log('ğŸ¯ Setting up modal event listeners...');
  setupCategoryDropdowns();
  
  const closeBtn = document.getElementById('close-warning-modal');
  const closeBtnFooter = document.getElementById('modal-close-btn');
  const saveBtn = document.getElementById('modal-save-btn');
  const deleteBtn = document.getElementById('modal-delete-btn');
  const exportBtn = document.getElementById('modal-export-pdf');
  
  
  if (closeBtn) {
    closeBtn.addEventListener('click', closeWarningModal);
    console.log('âœ… Close button (X) listener attached');
  }
  
  if (closeBtnFooter) {
    closeBtnFooter.addEventListener('click', closeWarningModal);
    console.log('âœ… Cancel button listener attached');
  }
  
  if (saveBtn) {
    saveBtn.addEventListener('click', saveWarningModal);
    console.log('âœ… Save button listener attached');
  } else {
    console.error('âŒ Save button NOT FOUND!');
  }
  
  if (deleteBtn) {
    deleteBtn.addEventListener('click', deleteWarningModal);
    console.log('âœ… Delete button listener attached');
  }
  
  if (exportBtn) {
    exportBtn.addEventListener('click', generateWarningPDF);
    console.log('âœ… Export PDF button listener attached');
  }
  
  // Close on background click
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeWarningModal();
      }
    });
    console.log('âœ… Background click listener attached');
  }
}

// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================


// Setup dynamic sub-category dropdown
function setupCategoryDropdowns() {
  const mainCategory = document.getElementById('modal-edit-main-category');
  const subCategory = document.getElementById('modal-edit-sub-category');
  
  if (!mainCategory || !subCategory) return;
  
  mainCategory.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategory.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategory.appendChild(option);
      });
      subCategory.disabled = false;
    } else {
      subCategory.disabled = true;
      subCategory.innerHTML = '<option value="">Select main category first...</option>';
    }
  });
}




    function generate12MonthChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    }
  ];

  // Try to get data from discipline_history
  let hasHistoryData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history) && emp.discipline_history.length > 0) {
      emp.discipline_history.forEach(action => {
        hasHistoryData = true;
        const actionDate = new Date(action.date);
        const monthStr = actionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        const monthIndex = months.indexOf(monthStr);
        
        if (monthIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING':
              datasets[0].data[monthIndex]++; 
              break;
            case 'WRITTEN_WARNING':
              datasets[1].data[monthIndex]++; 
              break;
            case 'FINAL_WARNING':
              datasets[2].data[monthIndex]++; 
              break;
            case 'TERMINATION':
              datasets[3].data[monthIndex]++; 
              break;
          }
        }
      });
    }
  });

  // If no history data, aggregate current counts in current month
  if (!hasHistoryData) {
    const currentMonthIndex = 11; // Last month in array
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentMonthIndex] = totalVerbal;
    datasets[1].data[currentMonthIndex] = totalWritten;
    datasets[2].data[currentMonthIndex] = totalFinal;
    datasets[3].data[currentMonthIndex] = totalTermination;
    
    console.log('ğŸ“Š Chart Data (Current Month):', {
      verbal: totalVerbal,
      written: totalWritten,
      final: totalFinal,
      termination: totalTermination
    });
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: { 
          enabled: true,
          mode: 'index', 
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          bodyFont: {
            size: 13,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            padding: 8
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)',
            drawBorder: false
          },
          title: {
            display: true,
            text: 'Number of Actions',
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function generateYearlyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const currentYear = new Date().getFullYear();
  const years = [currentYear - 4, currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(String);
  
  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#10b981',
      borderColor: '#10b981',
      borderWidth: 2
    },
    { 
      label: 'Written Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#f59e0b',
      borderColor: '#f59e0b',
      borderWidth: 2
    },
    { 
      label: 'Final Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#ef4444',
      borderColor: '#ef4444',
      borderWidth: 2
    },
    { 
      label: 'Terminations', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#991b1b',
      borderColor: '#991b1b',
      borderWidth: 2
    }
  ];

  // Try to get data from history
  let hasData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history)) {
      emp.discipline_history.forEach(action => {
        hasData = true;
        const year = new Date(action.date).getFullYear().toString();
        const yearIndex = years.indexOf(year);
        if (yearIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING': datasets[0].data[yearIndex]++; break;
            case 'WRITTEN_WARNING': datasets[1].data[yearIndex]++; break;
            case 'FINAL_WARNING': datasets[2].data[yearIndex]++; break;
            case 'TERMINATION': datasets[3].data[yearIndex]++; break;
          }
        }
      });
    }
  });

  // If no history, put current totals in current year
  if (!hasData) {
    const currentYearIndex = 4;
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentYearIndex] = totalVerbal;
    datasets[1].data[currentYearIndex] = totalWritten;
    datasets[2].data[currentYearIndex] = totalFinal;
    datasets[3].data[currentYearIndex] = totalTermination;
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

function generateWeeklyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const weeks = [];
  for (let i = 1; i <= 12; i++) {
    weeks.push(`Week ${i}`);
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      tension: 0.4,
      fill: true
    }
  ];

  // Put current totals in last week if no history
  const lastWeekIndex = 11;
  let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
  
  AppState.employees.forEach(emp => {
    totalVerbal += emp.verbal_warning_count || 0;
    totalWritten += emp.disciplinary_warning_count || 0;
    totalFinal += emp.final_warning_count || 0;
    totalTermination += emp.termination_letter_count || 0;
  });
  
  datasets[0].data[lastWeekIndex] = totalVerbal;
  datasets[1].data[lastWeekIndex] = totalWritten;
  datasets[2].data[lastWeekIndex] = totalFinal;
  datasets[3].data[lastWeekIndex] = totalTermination;

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: weeks, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

      // ========================================================================
      // DISCIPLINE CASES TAB FUNCTIONS
      // ========================================================================
      
      function setupAutocomplete(inputId, dropdownId, tabName) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        if (!input || !dropdown) return;

        input.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          const state = AutocompleteState[tabName];
          
          clearTimeout(state.searchTimeout);
          
          if (query.length < 3) {
            dropdown.classList.add('hidden');
            dropdown.innerHTML = '';
            return;
          }

          state.searchTimeout = setTimeout(() => {
            const results = AppState.employees.filter(emp => {
              const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
              const empId = (emp.employee_id || '').toLowerCase();
              const dept = (emp.department || '').toLowerCase();
              return fullName.includes(query.toLowerCase()) || 
                     empId.includes(query.toLowerCase()) || 
                     dept.includes(query.toLowerCase());
            }).slice(0, 10);

            dropdown.innerHTML = '';
            
            if (results.length === 0) {
              dropdown.innerHTML = '<div class="px-3 py-2 text-xs text-slate-400">No employees found</div>';
            } else {
              results.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer text-xs';
                item.innerHTML = `
                  <div class="font-bold text-slate-900">${emp.first_name} ${emp.last_name}</div>
                  <div class="text-slate-500 text-[0.70rem]">${emp.employee_id || '--'} &bull; ${emp.department || '--'}</div>
                `;
                item.addEventListener('click', () => {
                  input.value = `${emp.first_name} ${emp.last_name}`;
                  dropdown.classList.add('hidden');
                  selectEmployee(emp, tabName);
                });
                dropdown.appendChild(item);
              });
            }
            
            dropdown.classList.remove('hidden');
          }, 300);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
        });
      }



function selectEmployee(employee, context = 'discipline') {
  console.log('ğŸ¯ selectEmployee called with:', employee, 'context:', context);
  
  // â­ CLEAR ALL TOASTS FIRST - but only in toast container
  const toastContainer = document.getElementById('toast-container');
  if (toastContainer) {
    // Only look inside the toast container, not the entire page
    toastContainer.querySelectorAll('div').forEach(toast => {
      if (toast.textContent && toast.textContent.includes('Please select an employee')) {
        toast.remove();
        console.log('âœ… Removed error toast');
      }
    });
  }
  
  if (context === 'discipline') {
    AppState.selectedEmployee = employee;
    console.log('âœ… AppState.selectedEmployee set to:', AppState.selectedEmployee);
    
    // Update hidden field
    const employeeIdField = document.getElementById('discipline-employee-id');
    console.log('ğŸ“ Setting employee ID field to:', employee.id);
    employeeIdField.value = employee.id;
    console.log('âœ… Employee ID field now contains:', employeeIdField.value);
    
    // Update selected employee chip
    const chip = document.getElementById('discipline-selected-employee-chip');
    chip.innerHTML = `
      <span class="font-bold">${employee.first_name} ${employee.last_name}</span>
      <span class="text-slate-500">&bull;</span>
      <span>${employee.department || '--'}</span>
    `;
    chip.classList.remove('hidden');
    console.log('âœ… Employee chip updated and shown');
    
    // Render discipline history
    renderDisciplineHistory(employee);
    renderAuditTrail(employee);
    
    console.log('ğŸ‰ Employee selection complete!');
  } else if (context === 'employees') {
    loadEmployee360(employee);
  }
}

























      function renderDisciplineHistory(employee) {
        const container = document.getElementById('discipline-history-timeline');
        if (!container) return;

        container.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          container.innerHTML = '<p class="text-xs text-slate-400">No discipline history recorded for this employee.</p>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((action, index) => {
          const item = document.createElement('div');
          item.className = 'timeline-item relative pl-6 pb-6';
          if (index === history.length - 1) item.classList.remove('pb-6');
          
          let iconBg = 'bg-slate-400';
          if (action.type === 'Verbal Warning') iconBg = 'bg-emerald-400';
          if (action.type === 'Written Warning') iconBg = 'bg-amber-400';
          if (action.type === 'Final Warning') iconBg = 'bg-rose-400';
          if (action.type === 'Termination') iconBg = 'bg-rose-600';
          
          item.innerHTML = `
            <div class="absolute left-0 top-1 w-3 h-3 rounded-full ${iconBg} border-2 border-white"></div>
            <div class="text-xs">
              <p class="font-bold text-slate-900">${action.type}</p>
              <p class="text-[0.70rem] text-slate-500">${formatDate(action.date)}</p>
              <p class="text-[0.70rem] text-slate-600 mt-1">${action.reason || 'No reason provided'}</p>
              ${action.reference ? `<p class="text-[0.65rem] text-slate-400 mt-0.5">Ref: ${action.reference}</p>` : ''}
            </div>
          `;
          container.appendChild(item);
        });
      }

      function renderAuditTrail(employee) {
        const tbody = document.getElementById('discipline-audit-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-slate-400 text-xs">No audit trail available</td></tr>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach(action => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
            <td class="px-3 py-2 text-slate-900 font-medium">${action.type}</td>
            <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.manager_signature || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.reference || '--'}</td>
          `;
          tbody.appendChild(row);
        });
      }


// ========================================================================
// RENDER AUDIT TRAIL CHART
// ========================================================================

let disciplineAuditChart = null;

function renderAuditChart(employee) {
  const history = employee.discipline_history || [];
  const chartCanvas = document.getElementById('discipline-audit-chart');
  const chartContainer = document.getElementById('audit-chart-container');
  
  if (!chartCanvas || !chartContainer) return;

  if (history.length === 0) {
    // Hide chart if no data
    chartContainer.classList.add('hidden');
    return;
  }

  // Show chart container
  chartContainer.classList.remove('hidden');

  // Destroy existing chart
  if (disciplineAuditChart) {
    disciplineAuditChart.destroy();
  }

  // Sort by date ascending
  const sorted = [...history].sort((a, b) => 
    new Date(a.date || a.timestamp) - new Date(b.date || b.timestamp)
  );

  // Prepare data
  const labels = sorted.map((action, index) => {
    const date = new Date(action.date || action.timestamp);
    return date.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric',
      year: '2-digit'
    });
  });

  const severityValues = sorted.map(action => {
    const severity = (action.severity || '').toUpperCase();
    if (severity === 'LOW') return 1;
    if (severity === 'MEDIUM') return 2;
    if (severity === 'HIGH') return 3;
    return 0;
  });

  const pointColors = sorted.map(action => {
    const type = (action.type || '').toUpperCase();
    if (type.includes('VERBAL')) return '#10b981'; // Emerald
    if (type.includes('WRITTEN')) return '#f59e0b'; // Amber
    if (type.includes('FINAL')) return '#f97316'; // Orange
    if (type.includes('TERMINATION')) return '#ef4444'; // Red
    return '#64748b'; // Slate
  });

  const ctx = chartCanvas.getContext('2d');

  // Create gradient background
  const gradient = ctx.createLinearGradient(0, 0, 0, 300);
  gradient.addColorStop(0, 'rgba(99, 102, 241, 0.2)');
  gradient.addColorStop(1, 'rgba(99, 102, 241, 0)');

  disciplineAuditChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Severity Level',
        data: severityValues,
        borderColor: '#6366f1',
        backgroundColor: gradient,
        borderWidth: 3,
        fill: true,
        tension: 0.3,
        pointBackgroundColor: pointColors,
        pointBorderColor: '#ffffff',
        pointBorderWidth: 3,
        pointRadius: 8,
        pointHoverRadius: 12,
        pointHoverBorderWidth: 4
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: true,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#1e293b',
            padding: 15
          }
        },
        tooltip: {
          enabled: true,
          backgroundColor: 'rgba(15, 23, 42, 0.95)',
          titleColor: '#fff',
          bodyColor: '#e2e8f0',
          borderColor: '#475569',
          borderWidth: 1,
          padding: 12,
          displayColors: true,
          callbacks: {
            title: function(context) {
              const action = sorted[context[0].dataIndex];
              return `${action.type || 'Unknown Action'} - ${labels[context[0].dataIndex]}`;
            },
            label: function(context) {
              const action = sorted[context.dataIndex];
              return [
                `Severity: ${action.severity || 'N/A'}`,
                `Category: ${action.main_category || action.category || 'N/A'}`,
                `Issued by: ${action.manager_signature || 'N/A'}`
              ];
            },
            afterLabel: function(context) {
              const action = sorted[context.dataIndex];
              if (action.reference) {
                return `Reference: ${action.reference}`;
              }
              return '';
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          min: 0,
          max: 3.5,
          ticks: {
            stepSize: 1,
            callback: function(value) {
              if (value === 0) return '';
              if (value === 1) return 'Low';
              if (value === 2) return 'Medium';
              if (value === 3) return 'High';
              return '';
            },
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(148, 163, 184, 0.1)',
            drawBorder: false
          },
          border: {
            display: false
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 11,
              weight: '500'
            },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 0
          },
          border: {
            display: false
          }
        }
      },
      layout: {
        padding: {
          top: 10,
          bottom: 10
        }
      }
    }
  });

  console.log('âœ… Audit chart rendered with', history.length, 'data points');
}








   async function handleDisciplineSubmit(event) {
  event.preventDefault();

  // ===============================
  // STEP 1: Resolve Employee ID
  // ===============================
  const employeeIdField = document.getElementById('discipline-employee-id');
  let employeeId = employeeIdField?.value || null;

  console.log('ğŸ” DEBUG: Employee ID field element:', employeeIdField);
  console.log('ğŸ” DEBUG: Employee ID from field:', employeeId);
  console.log('ğŸ” DEBUG: AppState.selectedEmployee:', AppState.selectedEmployee);
  console.log('ğŸ” DEBUG: AppState.selectedEmployee.id:', AppState.selectedEmployee?.id);

  // Fallback to AppState (SINGLE SOURCE OF TRUTH)
  if (!employeeId) {
    if (AppState.selectedEmployee?.id) {
      employeeId = AppState.selectedEmployee.id;
      if (employeeIdField) {
        employeeIdField.value = employeeId;
      }
      console.log('âœ… Using employee ID from AppState:', employeeId);
    } else {
      showToast('Please select an employee first', 'error');
      return;
    }
  }

  // ===============================
  // STEP 2: Lock Submit Button
  // ===============================
  const submitBtn = document.getElementById('discipline-form-submit');
  const submitSpinner = document.getElementById('discipline-form-submit-spinner');
  const submitText = document.getElementById('discipline-form-submit-text');

  submitBtn.disabled = true;
  submitSpinner.classList.remove('hidden');
  submitText.classList.add('hidden');

  try {
    // ===============================
    // STEP 3: Collect Form Data
    // ===============================
    const actionType = document.getElementById('discipline-action-type').value;
    const actionDate = document.getElementById('discipline-action-date').value;
    const severity = document.getElementById('discipline-severity').value;
    const mainCategory = document.getElementById('discipline-main-category').value;
    const subCategory = document.getElementById('discipline-sub-category').value;
    const reference = document.getElementById('discipline-reference').value;
    const reason = document.getElementById('discipline-reason').value;
    const plan = document.getElementById('discipline-plan').value;
    const managerSig = document.getElementById('discipline-manager-signature').value;
    const hrSig = document.getElementById('discipline-hr-signature').value;
    const empSig = document.getElementById('discipline-employee-signature').value;
    const empDeclined = document.getElementById('discipline-employee-declined').checked;

    if (!mainCategory || !subCategory) {
      showToast('Please select both main category and sub-category', 'error');
      submitBtn.disabled = false;
      submitSpinner.classList.add('hidden');
      submitText.classList.remove('hidden');
      return;
    }

    // ===============================
    // STEP 4: Fetch Current Employee
    // ===============================
    console.log('ğŸ“Š Fetching employee data for ID:', employeeId);
    const { data: currentEmp, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;
    console.log('âœ… Employee data fetched:', currentEmp);

    // ===============================
    // STEP 5: Build Action Object
    // ===============================
    const newAction = {
      type: actionType,
      date: actionDate,
      severity,
      main_category: mainCategory,
      sub_category: subCategory,
      reference,
      reason,
      corrective_plan: plan,
      manager_signature: managerSig,
      hr_signature: hrSig,
      employee_signature: empDeclined ? 'DECLINED' : empSig,
      timestamp: new Date().toISOString()
    };

    console.log('ğŸ“ New action object:', newAction);

    // ===============================
    // STEP 6 & 7: Update Counts & Risk Score (WITH EDIT MODE SUPPORT)
    // ===============================
    const updates = { last_disciplinary_action: newAction };
    const { points } = AppState.settings;
    let newScore;

    // â­ CHECK IF WE'RE EDITING
    if (window.disciplineEditMode && window.disciplineEditMode.isEditing) {
      console.log('ğŸ“ EDIT MODE: Updating existing action at index', window.disciplineEditMode.historyIndex);
      
      // Replace the action at the specific index
      const history = currentEmp.discipline_history || [];
      history[window.disciplineEditMode.historyIndex] = newAction;
      updates.discipline_history = history;
      
      // Recalculate counts based on entire history
      updates.verbal_warning_count = history.filter(a => a.type === 'VERBAL_WARNING' || a.type === 'VERBAL WARNING').length;
      updates.disciplinary_warning_count = history.filter(a => a.type === 'WRITTEN_WARNING' || a.type === 'WRITTEN WARNING').length;
      updates.final_warning_count = history.filter(a => a.type === 'FINAL_WARNING' || a.type === 'FINAL WARNING').length;
      updates.termination_letter_count = history.filter(a => a.type === 'TERMINATION').length;
      
      newScore = 
        updates.verbal_warning_count * points.verbal +
        updates.disciplinary_warning_count * points.written +
        updates.final_warning_count * points.final +
        updates.termination_letter_count * points.termination;
        
    } else {
      console.log('â• CREATE MODE: Adding new action');
      
      // Original logic for new actions
      if (actionType === 'VERBAL_WARNING') {
        updates.verbal_warning_count = (currentEmp.verbal_warning_count || 0) + 1;
      } else if (actionType === 'WRITTEN_WARNING') {
        updates.disciplinary_warning_count = (currentEmp.disciplinary_warning_count || 0) + 1;
      } else if (actionType === 'FINAL_WARNING') {
        updates.final_warning_count = (currentEmp.final_warning_count || 0) + 1;
      } else if (actionType === 'TERMINATION') {
        updates.termination_letter_count = (currentEmp.termination_letter_count || 0) + 1;
        updates.employment_status = 'Terminated';
        updates.termination_status = 'Complete';
      }

      const history = currentEmp.discipline_history || [];
      history.push(newAction);
      updates.discipline_history = history;

      newScore = 
        (updates.verbal_warning_count || currentEmp.verbal_warning_count || 0) * points.verbal +
        (updates.disciplinary_warning_count || currentEmp.disciplinary_warning_count || 0) * points.written +
        (updates.final_warning_count || currentEmp.final_warning_count || 0) * points.final +
        (updates.termination_letter_count || currentEmp.termination_letter_count || 0) * points.termination;
    }

    updates.risk_score = newScore;
    updates.risk_level = getRiskLevel(newScore);

    console.log('ğŸ“Š Updated counts and risk score:', updates);

    // ===============================
    // STEP 8: Save to employees2025
    // ===============================
    console.log('ğŸ’¾ Saving to employees2025...');
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update(updates)
      .eq('id', employeeId);

    if (updateError) throw updateError;
    console.log('âœ… Saved to employees2025');

    // ===============================
    // STEP 9: Save to discipline_actions (ONLY IF NOT EDITING)
    // ===============================
  // ===============================
     // ===============================
    // STEP 9: Save to discipline_actions (ONLY IF NOT EDITING)
    // ===============================
    if (!window.disciplineEditMode || !window.disciplineEditMode.isEditing) {
      
      // Build discipline record with only valid columns
      const disciplineRecord = {
        employee_id: parseInt(employeeId),
        action_type: getProperActionType(actionType),
        incident_date: actionDate,
        category: mainCategory,
        subcategory: subCategory,
        severity: severity,
        issued_by: 'HR',
        manager_name: managerSig || null,
        hr_witness: hrSig || null,
        description: reason,
        corrective_action: plan || null,
        department: currentEmp.department || null,
        status: getProperStatus(),
        employee_signature: empDeclined ? 'DECLINED' : (empSig || null),
        manager_signature: managerSig || null,
        hr_signature: hrSig || null,
        employee_declined_to_sign: empDeclined
      };

      console.log('ğŸ’¾ Saving to discipline_actions table:', disciplineRecord);

      const { data: disciplineData, error: disciplineError } = await supabaseClient
        .from('discipline_actions')
        .insert([disciplineRecord])
        .select()
        .single();

      if (disciplineError) {
        console.error('âš ï¸ Failed to save to discipline_actions:', disciplineError);
        console.error('âš ï¸ Full error details:', JSON.stringify(disciplineError, null, 2));
        showToast('âš ï¸ Warning: Saved to employees2025 but failed to save to discipline_actions: ' + disciplineError.message, 'warning');
      } else {
        console.log('âœ… Discipline action also saved to discipline_actions table');
        console.log('ğŸ“„ Discipline data:', disciplineData);

        // Generate PDF using the new system
        if (disciplineData && disciplineData.id) {
          console.log('ğŸ”¥ Attempting to generate PDF for ID:', disciplineData.id);
          try {
            await generateDisciplinePDFNew(disciplineData.id);
          } catch (pdfError) {
            console.error('âŒ PDF generation failed:', pdfError);
            showToast('âš ï¸ Action saved but PDF generation failed. You can generate it later.', 'warning');
          }
        } else {
          console.error('âŒ No discipline data ID found!', disciplineData);
        }
      }
    } else {
      console.log('â­ï¸ Skipping discipline_actions insert (edit mode)');
    }


    // ===============================
    // STEP 10: Success & Cleanup
    // ===============================
    
    // â­ SHOW SUCCESS MESSAGE BASED ON MODE
    if (window.disciplineEditMode && window.disciplineEditMode.isEditing) {
      showToast('âœ… Discipline action updated successfully!', 'success');
    } else {
      showToast('âœ… Discipline action recorded successfully!', 'success');
    }

    // â­ RESET EDIT MODE
    if (window.disciplineEditMode) {
      window.disciplineEditMode = {
        isEditing: false,
        employeeId: null,
        historyIndex: null
      };
    }

    // â­ RESET BUTTON TEXT AND COLOR
    const submitTextSpan = submitText.querySelector('span');
    if (submitTextSpan) {
      submitTextSpan.innerHTML = '<i class="fas fa-file-pdf"></i> <span>Record Action & Generate PDF</span>';
    }
    submitBtn.classList.remove('from-amber-600', 'to-orange-600', 'hover:from-amber-700', 'hover:to-orange-700');
    submitBtn.classList.add('from-indigo-600', 'to-blue-600', 'hover:from-indigo-700', 'hover:to-blue-700');

    // Reset form
    document.getElementById('discipline-form').reset();
    document.getElementById('discipline-sub-category').disabled = true;
    document.getElementById('discipline-sub-category').innerHTML = '<option value="">Select main category first...</option>';

    // ===============================
    // STEP 11: Reload Data & Refresh UI
    // ===============================
    console.log('ğŸ”„ Reloading employee data...');
    await loadEmployees();

    // â­ RELOAD EMPLOYEE DATA TO GET UPDATED HISTORY
    if (AppState.selectedEmployee && AppState.selectedEmployee.id) {
      console.log('ğŸ”„ Reloading selected employee to refresh history...');

      const { data: updatedEmployee, error: reloadError } = await supabaseClient
        .from('employees2025')
        .select('*')
        .eq('id', AppState.selectedEmployee.id)
        .single();

      if (!reloadError && updatedEmployee) {
        AppState.selectedEmployee = updatedEmployee;
        DisciplineState.selectedEmployee = updatedEmployee;

        // â­ REFRESH TIMELINE AND AUDIT TRAIL
        console.log('ğŸ”„ Refreshing timeline and audit trail...');
        renderDisciplineHistory(updatedEmployee);
        renderAuditTrail(updatedEmployee);
        console.log('âœ… Timeline and audit trail refreshed');
      } else {
        console.error('âš ï¸ Failed to reload employee:', reloadError);
      }
    }

    // Update stats
    updateDisciplineStats();

    console.log('âœ… All updates complete!');

  } catch (error) {
    console.error('âŒ Error submitting discipline action:', error);
    showToast('âŒ Failed to submit discipline action: ' + error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitSpinner.classList.add('hidden');
    submitText.classList.remove('hidden');
  }
}




// Convert action types to database-compatible format
// Convert action types to database-compatible format
function getProperActionType(actionType) {
  const typeMap = {
    'VERBAL_WARNING': 'Verbal Warning',
    'WRITTEN_WARNING': 'Written Warning',
    'FINAL_WARNING': 'Final Warning',
    'TERMINATION': 'Termination Letter' // â­ Database expects "Termination Letter" not "Termination"
  };
  
  return typeMap[actionType] || actionType;
}

// Get proper status for database
function getProperStatus() {
  // Database accepts: 'Active', 'Resolved', 'Archived'
  return 'Active'; // New discipline actions are "Active"
}










      function generateDisciplinePDF(employee, action) {
        const content = `
          <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
              <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
              <p><strong>Name:</strong> ${employee.first_name} ${employee.last_name}</p>
              <p><strong>Employee ID:</strong> ${employee.employee_id || 'N/A'}</p>
              <p><strong>Department:</strong> ${employee.department || 'N/A'}</p>
              <p><strong>Position:</strong> ${employee.job_title || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Action Details</h3>
              <p><strong>Action Type:</strong> ${action.type}</p>
              <p><strong>Date:</strong> ${formatDate(action.date)}</p>
              <p><strong>Severity:</strong> ${action.severity}</p>
              <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Reason for Action</h3>
              <p style="white-space: pre-wrap;">${action.reason}</p>
            </div>
            
            ${action.corrective_plan ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Corrective Action Plan</h3>
              <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
            </div>
            ` : ''}
            
            <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
              <h3 style="color: #333;">Signatures</h3>
              <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
              <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
              <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
            </div>
          </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = content;
        
        html2pdf()
          .from(element)
          .set({
            margin: 0.5,
            filename: `discipline-${employee.employee_id}-${action.date}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          })
          .save();
      }


      // ========================================================================
      // EMPLOYEES 360 TAB FUNCTIONS
      // ========================================================================
      
      function renderEmployeeList() {
        const container = document.getElementById('employee-list');
        if (!container) return;

        const filtered = filterEmployees(AppState.employeeFilterStatus);
        container.innerHTML = '';

        if (filtered.length === 0) {
          container.innerHTML = '<div class="text-xs text-slate-400 px-3 py-2">No employees match the current filter.</div>';
          return;
        }

        filtered.forEach(emp => {
          const score = computeRiskScore(emp);
          const level = getRiskLevel(score);
          const badgeClasses = getRiskBadgeClasses(level);
          
          const item = document.createElement('div');
          item.className = 'rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 hover:bg-white hover:border-brand-200 cursor-pointer transition-all';
          item.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="flex-1">
                <p class="font-bold text-slate-900 text-xs">${emp.first_name} ${emp.last_name}</p>
                <p class="text-[0.70rem] text-slate-500">${emp.employee_id || '--'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full ${badgeClasses} border px-2 py-0.5 text-[0.65rem] font-medium">
                ${level}
              </span>
            </div>
          `;


        item.addEventListener('click', () => {
  selectEmployee(emp, 'employees');  // existing behavior
  openEmployee360(emp);             // âœ… NEW: open 360 modal
});
          container.appendChild(item);
        });
      }



      function loadEmployee360(employee) {
  const currentEmp360 = document.getElementById('current-employee-360-id');
  if (currentEmp360) currentEmp360.value = employee.id;
  AppState.selectedEmployee = employee;
  
  // Use enhanced profile population
  populateEmployeeProfileCard(employee);

  // Profile header - with null checks
  const profileName = document.getElementById('employee-profile-name');
  const profileTitle = document.getElementById('employee-profile-title');
  const profileStatus = document.getElementById('employee-profile-status');
  
  if (profileName) profileName.textContent = `${employee.first_name} ${employee.last_name}`;
  if (profileTitle) profileTitle.textContent = `${employee.job_title || 'N/A'} â€¢ ${employee.department || 'N/A'}`;
  if (profileStatus) profileStatus.textContent = `${employee.employment_status || 'N/A'} â€¢ Hired ${formatDate(employee.hire_date)} â€¢ Reports to ${employee.report_to || 'N/A'}`;
  
  // Risk badge - with null checks
  const score = computeRiskScore(employee);
  const level = getRiskLevel(score);
  const badgeClasses = getRiskBadgeClasses(level);
  const riskBadge = document.getElementById('employee-profile-risk-badge');
  
  if (riskBadge) {
    riskBadge.className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
    riskBadge.innerHTML = `
      <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
      <span>Risk Score: ${score}</span>
    `;
  }
  
  // IDs - with null checks
  const profileEmpId = document.getElementById('employee-profile-employee-id');
  const profileUsername = document.getElementById('employee-profile-username');
  
  if (profileEmpId) profileEmpId.innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
  if (profileUsername) profileUsername.innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${employee.username || '--'}</span>`;
  
  // KPIs - with null checks
  const kpiVerbal = document.getElementById('employee-kpi-verbal');
  const kpiWritten = document.getElementById('employee-kpi-written');
  const kpiFinal = document.getElementById('employee-kpi-final');
  const kpiTermination = document.getElementById('employee-kpi-termination');
  
  if (kpiVerbal) kpiVerbal.textContent = employee.verbal_warning_count || 0;
  if (kpiWritten) kpiWritten.textContent = employee.disciplinary_warning_count || 0;
  if (kpiFinal) kpiFinal.textContent = employee.final_warning_count || 0;
  if (kpiTermination) kpiTermination.textContent = employee.termination_letter_count || 0;

  // Editable fields - with null checks
  const editStatus = document.getElementById('edit-employment-status');
  const editFirstName = document.getElementById('edit-first-name');
  const editLastName = document.getElementById('edit-last-name');
  const editEmail = document.getElementById('edit-email');
  const editPhone = document.getElementById('edit-phone');
  const editAddr1 = document.getElementById('edit-address-line-1');
  const editAddr2 = document.getElementById('edit-address-line-2');
  const editCity = document.getElementById('edit-city');
  const editState = document.getElementById('edit-state');
  const editZip = document.getElementById('edit-zip-code');
  const editOrigHire = document.getElementById('edit-original-hire-date');
  const editReportTo = document.getElementById('edit-report-to');
  const editRiskLevel = document.getElementById('edit-risk-level');
  const editHrWitness = document.getElementById('edit-hr-witness');
  
  if (editStatus) editStatus.value = employee.employment_status || 'Active';
  if (editFirstName) editFirstName.value = employee.first_name || '';
  if (editLastName) editLastName.value = employee.last_name || '';
  if (editEmail) editEmail.value = employee.email || '';
  if (editPhone) editPhone.value = employee.phone || '';
  if (editAddr1) editAddr1.value = employee.address_line_1 || '';
  if (editAddr2) editAddr2.value = employee.address_line_2 || '';
  if (editCity) editCity.value = employee.city || '';
  if (editState) editState.value = employee.state || '';
  if (editZip) editZip.value = employee.zip_code || '';
  if (editOrigHire) editOrigHire.value = employee.original_hire_date || '';
  if (editReportTo) editReportTo.value = employee.report_to || '';
  if (editRiskLevel) editRiskLevel.value = employee.risk_level || 'LOW';
  if (editHrWitness) editHrWitness.value = employee.hr_witness || '';
  
  // Department and job title cascade
  const deptField = document.getElementById('edit-department');
  if (deptField) {
    deptField.value = employee.department || '';
    const changeEvent = new Event('change', { bubbles: true });
    deptField.dispatchEvent(changeEvent);
    
    setTimeout(() => {
      const jobTitleField = document.getElementById('edit-job-title');
      if (jobTitleField) jobTitleField.value = employee.job_title || '';
    }, 50);
  }
  
  // Compensation type detection
  const compTypeField = document.getElementById('edit-compensation-type');
  const hourlyRateField = document.getElementById('edit-hourly-rate');
  const annualSalaryField = document.getElementById('edit-annual-salary');
  const hourlyContainer = document.getElementById('hourly-rate-container');
  const salaryContainer = document.getElementById('annual-salary-container');
  const calculatedContainer = document.getElementById('calculated-hourly-container');
  
  let compensationType = 'hourly';
  
  if (employee.compensation_type) {
    compensationType = employee.compensation_type;
  } else if (employee.annual_salary && employee.annual_salary > 0) {
    compensationType = 'salary';
  } else if (employee.hourly_rate && employee.hourly_rate > 0) {
    compensationType = 'hourly';
  }
  
  if (compTypeField) compTypeField.value = compensationType;
  
  const badge = document.getElementById('comp-type-badge-text');
  if (badge) {
    badge.textContent = compensationType === 'hourly' 
      ? 'âœ“ Hourly employee (from database)' 
      : 'âœ“ Salary employee (from database)';
  }
  
  if (compensationType === 'hourly') {
    if (hourlyContainer) hourlyContainer.classList.remove('hidden');
    if (salaryContainer) salaryContainer.classList.add('hidden');
    if (calculatedContainer) calculatedContainer.classList.add('hidden');
    if (hourlyRateField) hourlyRateField.value = employee.hourly_rate || '';
    if (annualSalaryField) annualSalaryField.value = '';
  } else {
    if (hourlyContainer) hourlyContainer.classList.add('hidden');
    if (salaryContainer) salaryContainer.classList.remove('hidden');
    if (calculatedContainer) calculatedContainer.classList.remove('hidden');
    if (annualSalaryField) annualSalaryField.value = employee.annual_salary || '';
    if (hourlyRateField) hourlyRateField.value = '';
    
    if (employee.annual_salary && employee.annual_salary > 0) {
      calculateAndDisplayHourlyRate(employee);
    }
  }
  
  console.log(`ğŸ’° Loaded ${employee.first_name} - Type: ${compensationType}, Hourly: ${employee.hourly_rate}, Salary: ${employee.annual_salary}`);
  
  // Calculated fields
  const displayTenure = document.getElementById('display-tenure');
  const displayRiskScore = document.getElementById('display-risk-score');
  const displayLastAction = document.getElementById('display-last-action');
  
  if (displayTenure) displayTenure.textContent = calculateTenure(employee.hire_date);
  if (displayRiskScore) displayRiskScore.textContent = score;
  if (displayLastAction) {
    displayLastAction.textContent = employee.last_disciplinary_action 
      ? `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}` 
      : 'None';
  }

  // Summary
  const summaryContainer = document.getElementById('employee-summary-history');
  if (summaryContainer) {
    if (employee.discipline_history && employee.discipline_history.length > 0) {
      summaryContainer.innerHTML = `
        <p class="text-slate-700">
          ${employee.first_name} ${employee.last_name} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
          with a current risk score of <strong>${score}</strong> (${level} risk). 
          The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
          issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
        </p>
      `;
    } else {
      summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
    }
  }
}




      // ========================================================================
// ENHANCED EMPLOYEE PROFILE POPULATION
// ========================================================================
function populateEmployeeProfileCard(employee) {
  if (!employee) return;

 



  // --- Helpers ------------------------------------------------------
  const safe = (v, fallback = '') =>
    v === null || v === undefined ? fallback : v;

  const safeText = (id, value, fallback = '--') => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value !== undefined && value !== null && value !== ''
      ? value
      : fallback;
  };

  const safeValue = (id, value) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      if (el.type === 'date' && value) {
        el.value = value;
      } else {
        el.value = value ?? '';
      }
    } else {
      el.textContent = value ?? '';
    }
  };

// âœ… NOW safe to call calculateTenure (assuming it's defined globally *before* this function)
  const tenureDisplayEl = document.getElementById('display-tenure');
  if (tenureDisplayEl) {
    tenureDisplayEl.textContent = calculateTenure(employee.hire_date);
  }


  // --- BASIC DERIVED FIELDS -----------------------------------------
  const fullName = `${safe(employee.first_name)} ${safe(employee.last_name)}`.trim() || 'Employee';
  const jobTitle = safe(employee.job_title || employee.position_title, 'N/A');
  const department = safe(employee.department, 'N/A');
  const employmentStatus = safe(employee.employment_status, 'Active');
  const hireDate = employee.hire_date || employee.original_hire_date || null;
  const reportsTo = safe(employee.report_to, 'N/A');

  // --- PROFILE HEADER (top of Employee 360) -------------------------
  safeText('employee-profile-name', fullName, 'Employee');

  const profileTitleEl = document.getElementById('employee-profile-title');
  if (profileTitleEl) {
    profileTitleEl.textContent = `${jobTitle} â€¢ ${department}`;
  }

  const profileStatusEl = document.getElementById('employee-profile-status');
  if (profileStatusEl) {
    const tenure = typeof calculateTenure === 'function' && hireDate
      ? calculateTenure(hireDate)
      : '';
    const pieces = [employmentStatus];
    if (tenure) pieces.push(tenure);
    pieces.push(`Reports to ${reportsTo}`);
    profileStatusEl.textContent = pieces.join(' â€¢ ');
  }

  // ID + Username line
  const empIdEl = document.getElementById('employee-profile-employee-id');
  if (empIdEl) {
    empIdEl.innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
  }

  const usernameEl = document.getElementById('employee-profile-username');
  if (usernameEl) {
    const username = employee.username || employee.email || '--';
    usernameEl.innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${username}</span>`;
  }

  // --- RISK BADGE ---------------------------------------------------
  const riskBadge = document.getElementById('employee-profile-risk-badge');
  if (riskBadge && typeof computeRiskScore === 'function' && typeof getRiskLevel === 'function') {
    const score = computeRiskScore(employee);
    const level = getRiskLevel(score);
    const badgeClasses = getRiskBadgeClasses(level);

    riskBadge.className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
    riskBadge.innerHTML = `
      <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
      <span>Risk Score: ${score}</span>
    `;
  }

  // --- KPIs (Verbal / Written / Final / Termination) ---------------
  const kpiMap = {
    'employee-kpi-verbal': employee.verbal_warning_count,
    'employee-kpi-written': employee.disciplinary_warning_count,
    'employee-kpi-final': employee.final_warning_count,
    'employee-kpi-termination': employee.termination_letter_count
  };

  Object.entries(kpiMap).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value != null ? value : 0;
  });

  // --- EDITABLE FIELDS ---------------------------------------------
  safeValue('edit-employment-status', employmentStatus);
  safeValue('edit-first-name', employee.first_name || '');
  safeValue('edit-last-name', employee.last_name || '');
  safeValue('edit-job-title', employee.job_title || employee.position_title || '');
  safeValue('edit-department', employee.department || '');
  safeValue('edit-report-to', employee.report_to || '');
  safeValue('edit-email', employee.email || '');
  safeValue('edit-phone', employee.phone || '');
  safeValue('edit-address-line-1', employee.address_line_1 || '');
  safeValue('edit-address-line-2', employee.address_line_2 || '');
  safeValue('edit-city', employee.city || '');
  safeValue('edit-state', employee.state || '');
  safeValue('edit-zip-code', employee.zip_code || '');
  safeValue('edit-original-hire-date', employee.original_hire_date || '');
  safeValue('edit-hire-date', employee.hire_date || '');
  safeValue('edit-hourly-rate', employee.hourly_rate ?? '');
  safeValue('edit-annual-salary', employee.annual_salary ?? '');
  safeValue('edit-risk-level', employee.risk_level || 'LOW');
  safeValue('edit-hr-witness', employee.hr_witness || '');

  














  const scoreDisplayEl = document.getElementById('display-risk-score');
  if (scoreDisplayEl && typeof computeRiskScore === 'function') {
    const score = computeRiskScore(employee);
    scoreDisplayEl.textContent = score;
  }

  const lastActionEl = document.getElementById('display-last-action');
  if (lastActionEl) {
    if (employee.last_disciplinary_action) {
      lastActionEl.textContent = `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}`;
    } else {
      lastActionEl.textContent = 'None';
    }
  }

  // --- SUMMARY HISTORY ---------------------------------------------
  const summaryContainer = document.getElementById('employee-summary-history');
  if (summaryContainer) {
    if (employee.discipline_history && employee.discipline_history.length > 0) {
      const score = computeRiskScore(employee);
      const level = getRiskLevel(score);
      summaryContainer.innerHTML = `
        <p class="text-slate-700">
          ${fullName} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
          with a current risk score of <strong>${score}</strong> (${level} risk). 
          The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
          issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
        </p>
      `;
    } else {
      summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
    }
  }
}




// ========================================================================
// HELPER: Filter out owners (Francisco & Janelle Teng)
// ========================================================================
function excludeOwners(employees) {
  const owners = [
    { first_name: 'Francisco', last_name: 'Teng' },
    { first_name: 'Janelle', last_name: 'Teng' }
  ];

  return employees.filter(emp => {
    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase().trim();
    return !owners.some(owner => {
      const ownerName = `${owner.first_name} ${owner.last_name}`.toLowerCase().trim();
      return fullName === ownerName;
    });
  });
}












       async function saveEmployee360() {
        const employeeId = document.getElementById('current-employee-360-id').value;
        if (!employeeId) {
          showToast('Please select an employee first', 'error');
          return;
        }

        const saveBtn = document.getElementById('btn-save-employee-360');
        const statusIndicator = document.getElementById('save-status-indicator');
        const statusText = document.getElementById('save-status-text');
        
        saveBtn.disabled = true;
        statusIndicator.className = 'w-3 h-3 rounded-full bg-amber-500 animate-pulse';
        statusText.textContent = 'Saving...';

        try {
          const compensationType = document.getElementById('edit-compensation-type').value;
          
          const updates = {
            employment_status: document.getElementById('edit-employment-status').value,
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
            job_title: document.getElementById('edit-job-title').value,
            department: document.getElementById('edit-department').value,
            report_to: document.getElementById('edit-report-to').value,
            email: document.getElementById('edit-email-address').value,
            primary_phone: document.getElementById('edit-phone-number').value,
            address_line_1: document.getElementById('edit-address-line-1').value,
            address_line_2: document.getElementById('edit-address-line-2').value,
            city: document.getElementById('edit-city').value,
            state: document.getElementById('edit-state').value,
            zip_code: document.getElementById('edit-zip').value,
            original_hire_date: document.getElementById('edit-original-hire-date').value,
            compensation_type: compensationType,
            risk_level: document.getElementById('edit-risk-level').value,
            hr_witness: document.getElementById('edit-hr-witness').value,
            job_title2: document.getElementById('edit-job-title2')?.value || null,
            hourly_rate2: parseFloat(document.getElementById('edit-hourly-rate2')?.value) || null,
            job_title3: document.getElementById('edit-job-title3')?.value || null,
            hourly_rate3: parseFloat(document.getElementById('edit-hourly-rate3')?.value) || null
          };

          // Handle compensation based on type
          if (compensationType === 'hourly') {
            updates.hourly_rate = parseFloat(document.getElementById('edit-hourly-rate').value) || null;
            updates.annual_salary = null;
          } else {
            updates.annual_salary = parseFloat(document.getElementById('edit-annual-salary').value) || null;
            // Keep the calculated hourly rate
            const calculatedHourly = parseFloat(document.getElementById('edit-hourly-rate').value);
            if (calculatedHourly) {
              updates.hourly_rate = calculatedHourly;
            }
          }

          console.log('ğŸ’¾ Saving employee data:', updates);

         const { data, error } = await window.supabaseClient
            .from('employees2025')
            .update(updates)
            .eq('id', employeeId)
            .select();

          if (error) throw error;

          statusIndicator.className = 'w-3 h-3 rounded-full bg-emerald-500';
          statusText.textContent = 'Saved successfully';
          showToast('âœ“ Employee data saved successfully', 'success');
          
          await loadEmployees();
          if (typeof renderEmployeeGrid === 'function') {
            renderEmployeeGrid();
          }

        } catch (error) {
          console.error('âŒ Error saving employee:', error);
          statusIndicator.className = 'w-3 h-3 rounded-full bg-rose-500';
          statusText.textContent = 'Save failed';
          showToast('âŒ Failed to save: ' + error.message, 'error');
        } finally {
          saveBtn.disabled = false;
        }
      }









      // ========================================================================
      // POLICY LIBRARY TAB FUNCTIONS
      // ========================================================================
      
      function setupPolicyAccordion() {
        document.querySelectorAll('.policy-accordion-header').forEach(header => {
          header.addEventListener('click', () => {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.policy-accordion-toggle i');
            
            if (body.classList.contains('hidden')) {
              body.classList.remove('hidden');
              toggle.classList.remove('fa-chevron-down');
              toggle.classList.add('fa-chevron-up');
            } else {
              body.classList.add('hidden');
              toggle.classList.remove('fa-chevron-up');
              toggle.classList.add('fa-chevron-down');
            }
          });
        });

        document.querySelectorAll('.policy-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const category = chip.dataset.policyCategory;
            
            // Update chip styles
            document.querySelectorAll('.policy-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            // Show/hide panels
            document.querySelectorAll('[data-policy-category-panel]').forEach(panel => {
              if (panel.dataset.policyCategoryPanel === category) {
                panel.classList.remove('hidden');
              } else {
                panel.classList.add('hidden');
              }
            });
          });
        });
      }

     
      // ========================================================================
      // ADMIN SETTINGS TAB FUNCTIONS
      // ========================================================================
      
  function loadAdminSettings() {
  // Check if admin settings elements exist before trying to load them
  const adminThresholdLow = document.getElementById('admin-threshold-low');
  if (!adminThresholdLow) {
    console.log('â„¹ï¸ Admin settings panel not present on this page - skipping');
    return;
  }

  // Now safely set all values
  document.getElementById('admin-threshold-low').value = AppState.settings.thresholds.low;
  document.getElementById('admin-threshold-medium').value = AppState.settings.thresholds.medium;
  document.getElementById('admin-threshold-high').value = AppState.settings.thresholds.high;
  document.getElementById('admin-points-verbal').value = AppState.settings.points.verbal;
  document.getElementById('admin-points-written').value = AppState.settings.points.written;
  document.getElementById('admin-points-final').value = AppState.settings.points.final;
  document.getElementById('admin-points-termination').value = AppState.settings.points.termination;
  document.getElementById('admin-notify-high-risk').checked = AppState.settings.notifications.highRisk;
  document.getElementById('admin-notify-final-warning').checked = AppState.settings.notifications.finalWarning;
  document.getElementById('admin-notify-termination').checked = AppState.settings.notifications.termination;
  document.getElementById('admin-notify-daily-summary').checked = AppState.settings.notifications.dailySummary;
  document.getElementById('admin-display-photos').checked = AppState.settings.display.photos;
  document.getElementById('admin-display-compact').checked = AppState.settings.display.compact;
  document.getElementById('admin-display-auto-refresh').checked = AppState.settings.display.autoRefresh;
  document.getElementById('admin-retention-discipline').value = AppState.settings.retention.discipline;
  document.getElementById('admin-retention-audit').value = AppState.settings.retention.audit;
  
  console.log('âœ… Admin settings loaded successfully');
}

      function saveAdminSettings() {
        AppState.settings.thresholds.low = parseInt(document.getElementById('admin-threshold-low').value) || 2;
        AppState.settings.thresholds.medium = parseInt(document.getElementById('admin-threshold-medium').value) || 5;
        AppState.settings.thresholds.high = parseInt(document.getElementById('admin-threshold-high').value) || 8;
        AppState.settings.points.verbal = parseFloat(document.getElementById('admin-points-verbal').value) || 1;
        AppState.settings.points.written = parseFloat(document.getElementById('admin-points-written').value) || 2;
        AppState.settings.points.final = parseFloat(document.getElementById('admin-points-final').value) || 3;
        AppState.settings.points.termination = parseFloat(document.getElementById('admin-points-termination').value) || 4;
        AppState.settings.notifications.highRisk = document.getElementById('admin-notify-high-risk').checked;
        AppState.settings.notifications.finalWarning = document.getElementById('admin-notify-final-warning').checked;
        AppState.settings.notifications.termination = document.getElementById('admin-notify-termination').checked;
        AppState.settings.notifications.dailySummary = document.getElementById('admin-notify-daily-summary').checked;
        AppState.settings.display.photos = document.getElementById('admin-display-photos').checked;
        AppState.settings.display.compact = document.getElementById('admin-display-compact').checked;
        AppState.settings.display.autoRefresh = document.getElementById('admin-display-auto-refresh').checked;
        AppState.settings.retention.discipline = parseInt(document.getElementById('admin-retention-discipline').value) || 7;
        AppState.settings.retention.audit = parseInt(document.getElementById('admin-retention-audit').value) || 7;

        localStorage.setItem('jcr-hr-settings', JSON.stringify(AppState.settings));
        
        const statusDiv = document.getElementById('admin-save-status');
        statusDiv.classList.remove('hidden');
        setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        
        showToast('Settings saved successfully', 'success');
      }


// FIND your PDF download button code and replace with:
async function download360PDF(employeeId) {
  try {
    const response = await fetch('https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-360-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ employee_id: employeeId })
    });

    if (!response.ok) {
      throw new Error('Failed to generate PDF');
    }

    const htmlContent = await response.text();
    
    // Open HTML in new window - user can print to PDF
    const newWindow = window.open('', '_blank');
    newWindow.document.write(htmlContent);
    newWindow.document.close();
    
    // Optionally trigger print dialog
    setTimeout(() => {
      newWindow.print();
    }, 500);

  } catch (error) {
    console.error('Error downloading 360 PDF:', error);
    alert('Failed to generate PDF. Please try again.');
  }
}



      // ========================================================================
      // EVENT LISTENERS
      // ========================================================================
      
      function attachEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-trigger').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tabTarget;  // âœ… CORRECT!
    showTab(tab);
  });
});
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
        const mobileMenu = document.getElementById('mobile-nav-menu');
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
          });

          document.querySelectorAll('#mobile-nav-menu .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              mobileMenu.classList.add('hidden');
            });
          });
        }


         // Mobile tab select dropdown
        const mobileTabSelect = document.getElementById('mobile-tab-select');
        if (mobileTabSelect) {
          mobileTabSelect.addEventListener('change', (e) => {
            showTab(e.target.value);
          });
        }




        // Dashboard chart timeframe
        const chartSelector = document.getElementById('chart-timeframe-selector');
        if (chartSelector) {
          chartSelector.addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'monthly') generate12MonthChart();
            else if (value === 'yearly') generateYearlyChart();
            else if (value === 'weekly') generateWeeklyChart();
          });
        }







        // Discipline form
        //const disciplineForm = document.getElementById('discipline-form');
        //if (disciplineForm) {
         // disciplineForm.addEventListener('submit', handleDisciplineSubmit);
       // }//

        //**const disciplineResetBtn = document.getElementById('discipline-form-reset');
        //if (disciplineResetBtn) {
         // disciplineResetBtn.addEventListener('click', () => {
            //disciplineForm.reset();
           // document.getElementById('discipline-selected-employee-chip').classList.add('hidden');
        //  });
       // }//**

        // Discipline refresh
       // const disciplineRefresh = document.getElementById('discipline-refresh-employees');
       // if (disciplineRefresh) {
       //   disciplineRefresh.addEventListener('click', () => loadEmployees());
       // }

        // Employees 360 refresh
        const employeesRefresh = document.getElementById('employees-refresh-button');
        if (employeesRefresh) {
          employeesRefresh.addEventListener('click', () => {
            loadEmployees().then(() => renderEmployeeList());
          });
        }

        // Employees 360 save
        const saveEmployee360Btn = document.getElementById('btn-save-employee-360');
        if (saveEmployee360Btn) {
          saveEmployee360Btn.addEventListener('click', saveEmployee360);
        }

        // Employee filter chips
        document.querySelectorAll('.employee-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.employee-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            renderEmployeeList();
          });
        });

        // Reports refresh
        const reportsRefresh = document.getElementById('reports-refresh-data');
        if (reportsRefresh) {
          reportsRefresh.addEventListener('click', () => {
            loadEmployees().then(() => updateReports());
          });
        }
const mainCategoryDropdown = document.getElementById('discipline-main-category');
const subCategoryDropdown = document.getElementById('discipline-sub-category');

if (mainCategoryDropdown && subCategoryDropdown) {
  mainCategoryDropdown.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategoryDropdown.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategoryDropdown.appendChild(option);
      });
      subCategoryDropdown.disabled = false;
    } else {
      subCategoryDropdown.disabled = true;
    }
  });
}

        // Admin settings save
        const adminSaveBtn = document.getElementById('admin-save-settings');
        if (adminSaveBtn) {
          adminSaveBtn.addEventListener('click', saveAdminSettings);
        }
const employee360PdfBtn = document.getElementById('employee-summary-pdf');
if (employee360PdfBtn) {
  employee360PdfBtn.addEventListener('click', () => {
    const employeeId = document.getElementById('current-employee-360-id').value;
    if (!employeeId) {
      showToast('Please select an employee first', 'error');
      return;
    }
    download360PDF(employeeId);
  });
}
        // Setup autocomplete for both search inputs
        setupAutocomplete('discipline-employee-search', 'discipline-search-dropdown', 'discipline');
        setupAutocomplete('employees-search-input', 'employees-search-dropdown', 'employees');
      }

      // ========================================================================
      // INITIALIZATION
      // ========================================================================
      // ========================================================================
// PERMISSIONS MANAGEMENT
// ========================================================================

// Load permissions from database
async function loadPermissions() {
  try {
const { data, error } = await window.supabaseClient
      .from('permissions_config')
      .select('*')
      .single();

    if (error && error.code !== 'PGRST116') throw error;

    if (data) {
      // Apply permissions to checkboxes
      Object.entries(data.permissions || {}).forEach(([feature, roles]) => {
        Object.entries(roles).forEach(([role, allowed]) => {
          const checkbox = document.querySelector(
            `.permission-checkbox[data-feature="${feature}"][data-role="${role}"]`
          );
          if (checkbox) checkbox.checked = allowed;
        });
      });
    }
  } catch (error) {
    console.error('Error loading permissions:', error);
  }
}

// Save permissions to database
async function savePermissions() {
  try {
    const permissions = {};
    
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
      const feature = checkbox.dataset.feature;
      const role = checkbox.dataset.role;
      
      if (!permissions[feature]) permissions[feature] = {};
      permissions[feature][role] = checkbox.checked;
    });

    const { error } = await supabaseClient
      .from('permissions_config')
      .upsert({
        id: 1,
        permissions,
        updated_at: new Date().toISOString()
      });

    if (error) throw error;

    // Log the change
    await logPermissionChange('Permissions matrix updated', 'HR Admin');
    
    showToast('Permissions saved automatically', 'success');
  } catch (error) {
    console.error('Error saving permissions:', error);
    showToast('Failed to save permissions', 'error');
  }
}

// Log permission changes
async function logPermissionChange(action, changedBy) {
  try {
    const { error } = await supabaseClient
      .from('permissions_audit_log')
      .insert({
        action,
        changed_by: changedBy,
        timestamp: new Date().toISOString()
      });

    if (error) throw error;
    
    // Refresh audit log display
    await loadPermissionsAuditLog();
  } catch (error) {
    console.error('Error logging permission change:', error);
  }
}

// Load and display audit log
async function loadPermissionsAuditLog() {
  try {
    const { data, error } = await supabaseClient
      .from('permissions_audit_log')
      .select('*')
      .order('timestamp', { ascending: false })
      .limit(50);

    if (error) throw error;

    const tbody = document.getElementById('permissions-audit-log');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      `;
      return;
    }

    data.forEach(log => {
      const row = document.createElement('tr');
      const timestamp = new Date(log.timestamp);
      row.innerHTML = `
        <td class="px-3 py-2 text-slate-600">
          ${timestamp.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}
        </td>
        <td class="px-3 py-2 text-slate-700">${log.action}</td>
        <td class="px-3 py-2 text-slate-600">${log.user_affected || '--'}</td>
        <td class="px-3 py-2 text-slate-600">${log.changed_by}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading audit log:', error);
  }
}

// Setup auto-save for permission checkboxes
function setupPermissionsAutoSave() {
  document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      // Debounce save
      clearTimeout(window.permissionsSaveTimeout);
      window.permissionsSaveTimeout = setTimeout(() => {
        savePermissions();
      }, 1000);
    });
  });
}
    

// Get filtered date range based on global filter
function getFilteredDateRange() {
  const filter = document.getElementById('global-reports-filter')?.value || 'all-time';
  const now = new Date();
  let startDate = null;
  let endDate = now;

  // ğŸ†• CHECK IF CUSTOM DATE RANGE IS SELECTED
  if (filter === 'custom') {
    const customStart = document.getElementById('custom-start-date')?.value;
    const customEnd = document.getElementById('custom-end-date')?.value;
    
    if (customStart) {
      startDate = new Date(customStart);
      startDate.setHours(0, 0, 0, 0); // Start of day
    }
    
    if (customEnd) {
      endDate = new Date(customEnd);
      endDate.setHours(23, 59, 59, 999); // End of day
    }
    
    return { startDate, endDate };
  }

  // EXISTING PREDEFINED FILTERS
  switch (filter) {
    case 'this-month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'last-month':
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 0);
      break;
    case 'last-30':
      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      break;
    case 'last-90':
      startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      break;
    case 'ytd':
      startDate = new Date(now.getFullYear(), 0, 1);
      break;
    case 'all-time':
    default:
      startDate = null;
      break;
  }

  return { startDate, endDate };
}


// Update date range display text
// Update date range display text
function updateDateRangeDisplay() {
  const filter = document.getElementById('global-reports-filter')?.value || 'all-time';
  const displayEl = document.getElementById('reports-date-range-text');
  if (!displayEl) return;

  const { startDate, endDate } = getFilteredDateRange();
  
  let displayText = '';
  
  if (!startDate) {
    displayText = 'All Time';
  } else {
    const formatDate = (d) => d.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });
    displayText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
  }
  
  displayEl.textContent = displayText;
}



// Normalize employment status for robust counting
function normalizeStatus(status) {
  if (!status) return 'Active';
  const cleaned = status.trim().toLowerCase();
  if (cleaned === 'active') return 'Active';
  if (cleaned === 'inactive' || cleaned === 'terminated' || cleaned === 'on leave' || cleaned === 'suspended') {
    return 'Inactive'; // Group all non-active as 'Inactive' for high-level counts
  }
  return 'Active'; // fallback
}




// Update KPIs for Reports Tab
function updateReportsKPIs() {
  const actions = getFilteredActions();
  document.getElementById('reports-kpi-total-actions').textContent = actions.length;

  // âœ… Define ALL counts using normalized status
  const terminatedCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Inactive' && e.employment_status?.trim().toLowerCase() === 'terminated'
  ).length;

  const activeCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Active'
  ).length;

  const inactiveCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Inactive' && e.employment_status?.trim().toLowerCase() !== 'terminated'
  ).length;

  const totalCount = activeCount + terminatedCount;
  const terminationRate = totalCount > 0 
    ? ((terminatedCount / totalCount) * 100).toFixed(1) 
    : '0.0';

  // âœ… Safely update DOM
  const safeText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  safeText('reports-kpi-termination-rate', `${terminationRate}%`);
  safeText('reports-kpi-avg-resolution', '3.2 days');

  // High-risk count
  const highRiskCount = AppState.employees.filter(e => {
    const score = computeRiskScore(e);
    return getRiskLevel(score) === 'HIGH';
  }).length;

  safeText('reports-kpi-high-risk-count', highRiskCount);

  // Optional: update risk distribution counters
  updateRiskDistribution(); // ensures "Low/Medium/High" boxes stay in sync
}






// Chart 2: Actions by Type
// Chart 2: Actions by Type - BAR CHART
function generateActionsByTypeChart() {
  const canvas = document.getElementById('reports-chart-by-type');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byType) {
    ReportsCharts.byType.destroy();
  }

  const actions = getFilteredActions();
  
  let verbal = 0, written = 0, final = 0, termination = 0;
  actions.forEach(action => {
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) verbal++;
    else if (type.includes('WRITTEN')) written++;
    else if (type.includes('FINAL')) final++;
    else if (type.includes('TERMINATION')) termination++;
  });

  ReportsCharts.byType = new Chart(ctx, {
    type: 'bar', // âœ… CHANGED TO BAR
    data: {
      labels: ['Verbal', 'Written', 'Final', 'Termination'],
      datasets: [{
        label: 'Action Count',
        data: [verbal, written, final, termination],
        backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444'],
        borderColor: ['#059669', '#d97706', '#ea580c', '#dc2626'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false // Hide legend for bar chart
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' },
          callbacks: {
            label: function(context) {
              const total = verbal + written + final + termination;
              const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : '0';
              return `${context.label}: ${context.parsed.y} (${percentage}%)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' },
          title: {
            display: true,
            text: 'Number of Actions',
            font: { size: 13, weight: 'bold' },
            color: '#334155'
          }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          }
        }
      }
    }
  });
}

// Chart 3: Actions by Department
function generateActionsByDepartmentChart() {
  const canvas = document.getElementById('reports-chart-by-department');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byDepartment) {
    ReportsCharts.byDepartment.destroy();
  }

  const actions = getFilteredActions();
  const deptData = {};

  actions.forEach(action => {
    const dept = action.department;
    if (!deptData[dept]) {
      deptData[dept] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) deptData[dept].verbal++;
    else if (type.includes('WRITTEN')) deptData[dept].written++;
    else if (type.includes('FINAL')) deptData[dept].final++;
    else if (type.includes('TERMINATION')) deptData[dept].termination++;
  });

  const departments = Object.keys(deptData);
  
  ReportsCharts.byDepartment = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: departments,
      datasets: [
        {
          label: 'Verbal',
          data: departments.map(d => deptData[d].verbal),
          backgroundColor: '#10b981',
          borderColor: '#10b981',
          borderWidth: 2
        },
        {
          label: 'Written',
          data: departments.map(d => deptData[d].written),
          backgroundColor: '#f59e0b',
          borderColor: '#f59e0b',
          borderWidth: 2
        },
        {
          label: 'Final',
          data: departments.map(d => deptData[d].final),
          backgroundColor: '#fb923c',
          borderColor: '#fb923c',
          borderWidth: 2
        },
        {
          label: 'Termination',
          data: departments.map(d => deptData[d].termination),
          backgroundColor: '#ef4444',
          borderColor: '#ef4444',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          stacked: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        x: {
          stacked: true,
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

// Chart 4: Actions by Job Title
function generateActionsByJobTitleChart() {
  const canvas = document.getElementById('reports-chart-by-job-title');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byJobTitle) {
    ReportsCharts.byJobTitle.destroy();
  }

  const actions = getFilteredActions();
  const jobData = {};

  actions.forEach(action => {
    const job = action.jobTitle;
    if (!jobData[job]) {
      jobData[job] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) jobData[job].verbal++;
    else if (type.includes('WRITTEN')) jobData[job].written++;
    else if (type.includes('FINAL')) jobData[job].final++;
    else if (type.includes('TERMINATION')) jobData[job].termination++;
  });

  const jobs = Object.keys(jobData);
  
  ReportsCharts.byJobTitle = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: jobs,
      datasets: [
        {
          label: 'Verbal',
          data: jobs.map(j => jobData[j].verbal),
          backgroundColor: '#10b981',
          borderColor: '#10b981',
          borderWidth: 2
        },
        {
          label: 'Written',
          data: jobs.map(j => jobData[j].written),
          backgroundColor: '#f59e0b',
          borderColor: '#f59e0b',
          borderWidth: 2
        },
        {
          label: 'Final',
          data: jobs.map(j => jobData[j].final),
          backgroundColor: '#fb923c',
          borderColor: '#fb923c',
          borderWidth: 2
        },
        {
          label: 'Termination',
          data: jobs.map(j => jobData[j].termination),
          backgroundColor: '#ef4444',
          borderColor: '#ef4444',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y', // Horizontal bars
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          stacked: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        y: {
          stacked: true,
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b'
          }
        }
      }
    }
  });
}

// Chart 5: Trend Over Time
function generateTrendChart() {
  const canvas = document.getElementById('reports-trend-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.trend) {
    ReportsCharts.trend.destroy();
  }

  // Generate last 12 months
  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
  }

  const datasets = [
    { label: 'Verbal', data: new Array(12).fill(0), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', tension: 0.4, fill: true },
    { label: 'Written', data: new Array(12).fill(0), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.2)', tension: 0.4, fill: true },
    { label: 'Final', data: new Array(12).fill(0), borderColor: '#fb923c', backgroundColor: 'rgba(251, 146, 60, 0.2)', tension: 0.4, fill: true },
    { label: 'Termination', data: new Array(12).fill(0), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', tension: 0.4, fill: true }
  ];

  const actions = getFilteredActions();
  
  actions.forEach(action => {
    const actionDate = new Date(action.date);
    const monthStr = actionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
    const monthIndex = months.indexOf(monthStr);
    
    if (monthIndex >= 0) {
      const type = action.type.toUpperCase();
      if (type.includes('VERBAL')) datasets[0].data[monthIndex]++;
      else if (type.includes('WRITTEN')) datasets[1].data[monthIndex]++;
      else if (type.includes('FINAL')) datasets[2].data[monthIndex]++;
      else if (type.includes('TERMINATION')) datasets[3].data[monthIndex]++;
    }
  });

  ReportsCharts.trend = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

// Update Risk Distribution
function updateRiskDistribution() {
  let low = 0, medium = 0, high = 0;
  
  AppState.employees.forEach(emp => {
    const score = computeRiskScore(emp);
    const level = getRiskLevel(score);
    if (level === 'LOW') low++;
    else if (level === 'MEDIUM') medium++;
    else high++;
  });

  document.getElementById('reports-risk-low-count').textContent = low;
  document.getElementById('reports-risk-medium-count').textContent = medium;
  document.getElementById('reports-risk-high-count').textContent = high;
}

// Populate Reports Table
function populateReportsTable() {
  const tbody = document.getElementById('reports-table-body');
  if (!tbody) return;

  const actions = getFilteredActions();
  actions.sort((a, b) => new Date(b.date) - new Date(a.date));

  tbody.innerHTML = '';

  if (actions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-center text-slate-400">No actions found for selected filter</td></tr>';
    return;
  }

  actions.slice(0, 100).forEach(action => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
      <td class="px-3 py-2 text-slate-900 font-bold">${action.employeeName}</td>
      <td class="px-3 py-2 text-slate-600">${action.department}</td>
      <td class="px-3 py-2 text-slate-600">${action.jobTitle}</td>
      <td class="px-3 py-2 text-slate-900">${action.type}</td>
      <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
      <td class="px-3 py-2 text-slate-600 text-xs">${(action.reason || '').substring(0, 60)}${action.reason && action.reason.length > 60 ? '...' : ''}</td>
    `;
    tbody.appendChild(row);
  });
}

// Attach global filter listener
const globalFilter = document.getElementById('global-reports-filter');
if (globalFilter) {
  globalFilter.addEventListener('change', () => {
    console.log('ğŸ”„ Global filter changed, updating all charts...');
    updateReports();
  });
}

// CSV Export
const csvExportBtn = document.getElementById('reports-table-export-csv');
if (csvExportBtn) {
  csvExportBtn.addEventListener('click', () => {
    const actions = getFilteredActions();
    
    let csv = 'Date,Employee,Department,Job Title,Action Type,Severity,Reason\n';
    
    actions.forEach(action => {
      const reason = (action.reason || '').replace(/"/g, '""').replace(/\n/g, ' ');
      csv += `"${formatDate(action.date)}","${action.employeeName}","${action.department}","${action.jobTitle}","${action.type}","${action.severity || ''}","${reason}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `discipline-actions-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('CSV exported successfully', 'success');
  });
}
// Master function to update all reports
function updateReports() {
  console.log('ğŸ“Š Updating Reports & Analytics...');
  
  updateReportsKPIs();
  updateDateRangeDisplay();
  
  generateActionsByTypeChart();
  generateActionsByDepartmentChart();
  generateActionsByJobTitleChart();
  generateTrendChart();
  
  updateRiskDistribution();
  populateReportsTable();
  
  console.log('âœ… Reports updated successfully');
}

// ========================================================================
// EMPLOYEES 360: DEPARTMENT â†’ JOB TITLE CASCADE
// ========================================================================
const JOB_TITLES_BY_DEPARTMENT = {
  'FOH': [
    'FOH Manager',
    'Server',
    'Bartender',
    'Host',
    'Cashier',
    'Busser'
  ],
  'BOH': [
    'Line Cook',
    'Wok Chef',
    'Dumpling Maker',
    'Prep Cook',
    'Pastry Chef',
    'Dishwasher',
    'Production Manager',
    'Logistic Coordinator'
  ]
};



// ========================================================================
// EMPLOYEES 360: COMPENSATION TYPE SWITCHER
// ========================================================================
function setupCompensationTypeSwitcher() {
  const compTypeField = document.getElementById('edit-compensation-type');
  const hourlyContainer = document.getElementById('hourly-rate-container');
  const salaryContainer = document.getElementById('annual-salary-container');
  const calculatedContainer = document.getElementById('calculated-hourly-container');
  const hourlyRateField = document.getElementById('edit-hourly-rate');
  const annualSalaryField = document.getElementById('edit-annual-salary');
  const calculatedDisplay = document.getElementById('display-calculated-hourly');
  const formulaDisplay = document.getElementById('calc-formula-display');
  const firstNameField = document.getElementById('edit-first-name');
  const lastNameField = document.getElementById('edit-last-name');
  const jobTitleField = document.getElementById('edit-job-title');

  // Safe check - if ANY required element is missing, skip setup
  if (!compTypeField || !hourlyContainer || !salaryContainer || !hourlyRateField || !annualSalaryField) {
    console.warn('âš ï¸ Compensation switcher skipped - elements not found (OK for Employee 360)');
    return;
  }

  // Calculate hourly rate for salary employees based on special rules
  function calculateHourlyFromSalary() {
    const salary = parseFloat(annualSalaryField.value) || 0;
    if (salary === 0) {
      calculatedDisplay.textContent = '--';
      formulaDisplay.textContent = 'Enter annual salary to calculate';
      return;
    }

    const firstName = firstNameField.value.trim();
    const lastName = lastNameField.value.trim();
    const jobTitle = jobTitleField.value;
    const fullName = `${firstName} ${lastName}`.trim();

    let weeklyHours = 40; // Default
    let formula = 'Annual Salary Ã· 52 weeks Ã· 40 hours';

    // Special rules based on job title
    if (jobTitle === 'Wok Chef') {
      weeklyHours = 50;
      formula = 'Annual Salary Ã· 52 weeks Ã· 50 hours (Wok Chef rate)';
    } else if (jobTitle === 'Logistic Coordinator' || jobTitle === 'Production Manager') {
      weeklyHours = 40;
      formula = `Annual Salary Ã· 52 weeks Ã· 40 hours (${jobTitle} rate)`;
    }
    // Special rules based on employee name
    else if (fullName === 'Yu Li') {
      weeklyHours = 48;
      formula = 'Annual Salary Ã· 52 weeks Ã· 48 hours (Yu Li special rate)';
    } else if (fullName === 'Xing Cheng') {
      weeklyHours = 45;
      formula = 'Annual Salary Ã· 52 weeks Ã· 45 hours (Xing Cheng special rate)';
    } else if (fullName === 'Cesar Ramirez') {
      weeklyHours = 50;
      formula = 'Annual Salary Ã· 52 weeks Ã· 50 hours (Cesar Ramirez special rate)';
    }

    const hourlyRate = salary / 52 / weeklyHours;
    calculatedDisplay.textContent = `$${hourlyRate.toFixed(2)}/hr`;
    formulaDisplay.textContent = formula;

    console.log(`ğŸ’° Calculated hourly for ${fullName || jobTitle}: $${hourlyRate.toFixed(2)}`);
  }

  // Toggle visibility based on compensation type
  function toggleCompensationFields() {
    const compType = compTypeField.value;

    // Update badge
    const badge = document.getElementById('comp-type-badge-text');
    if (badge) {
      if (compType === 'hourly') {
        badge.textContent = 'âœ“ Hourly employee (from database)';
      } else {
        badge.textContent = 'âœ“ Salary employee (from database)';
      }
    }

    if (compType === 'hourly') {
      hourlyContainer.classList.remove('hidden');
      salaryContainer.classList.add('hidden');
      calculatedContainer.classList.add('hidden');
    } else if (compType === 'salary') {
      hourlyContainer.classList.add('hidden');
      salaryContainer.classList.remove('hidden');
      calculatedContainer.classList.remove('hidden');
      calculateHourlyFromSalary();
    }
  }

  // Event listeners
  compTypeField.addEventListener('change', toggleCompensationFields);
  annualSalaryField.addEventListener('input', calculateHourlyFromSalary);
  jobTitleField.addEventListener('change', calculateHourlyFromSalary);
  firstNameField.addEventListener('input', calculateHourlyFromSalary);
  lastNameField.addEventListener('input', calculateHourlyFromSalary);

  // Initial toggle
  toggleCompensationFields();

  console.log('âœ… Compensation type switcher setup complete');
}
  



// Calculate hourly rate for salary employees with special rules
function calculateAndDisplayHourlyRate(employee) {
  const salary = employee.annual_salary || 0;
  if (salary === 0) {
    document.getElementById('display-calculated-hourly').textContent = '--';
    document.getElementById('calc-formula-display').textContent = 'No salary data';
    return;
  }

  const firstName = employee.first_name || '';
  const lastName = employee.last_name || '';
  const jobTitle = employee.job_title || '';
  const fullName = `${firstName} ${lastName}`.trim();

  let weeklyHours = 40; // Default
  let formula = 'Annual Salary Ã· 52 weeks Ã· 40 hours';

  // Special rules based on job title
  if (jobTitle === 'Wok Chef') {
    weeklyHours = 50;
    formula = 'Annual Salary Ã· 52 weeks Ã· 50 hours (Wok Chef)';
  } else if (jobTitle === 'Logistic Coordinator' || jobTitle === 'Production Manager') {
    weeklyHours = 40;
    formula = `Annual Salary Ã· 52 weeks Ã· 40 hours (${jobTitle})`;
  }
  // Special rules based on employee name
  else if (fullName === 'Yu Li') {
    weeklyHours = 48;
    formula = 'Annual Salary Ã· 52 weeks Ã· 48 hours (Yu Li)';
  } else if (fullName === 'Xing Cheng') {
    weeklyHours = 45;
    formula = 'Annual Salary Ã· 52 weeks Ã· 45 hours (Xing Cheng)';
  } else if (fullName === 'Cesar Ramirez') {
    weeklyHours = 50;
    formula = 'Annual Salary Ã· 52 weeks Ã· 50 hours (Cesar Ramirez)';
  }

  const hourlyRate = salary / 52 / weeklyHours;
  
  const displayElement = document.getElementById('display-calculated-hourly');
  const formulaElement = document.getElementById('calc-formula-display');
  
  if (displayElement) {
    displayElement.textContent = `$${hourlyRate.toFixed(2)}/hr`;
  }
  if (formulaElement) {
    formulaElement.textContent = formula;
  }

  console.log(`ğŸ’° Calculated hourly for ${fullName}: $${hourlyRate.toFixed(2)} (${weeklyHours} hrs/week)`);
}




// ========================================================================
// RENDER DASHBOARD CHARTS â€” USING SAME LOGIC AS updateDashboardKPIs()
// ========================================================================
function renderDashboardCharts(actions = []) {
  console.log('ğŸ“Š Rendering Dashboard Charts (Aligned with KPI logic)...');

  // Reuse global position mapping
  const fohPositions = ['foh-manager', 'foh manager', 'server', 'bartender', 'host', 'cashier', 'manager'];
  const bohPositions = [
    'line-cook', 'line cook', 'wok-chef', 'wok chef', 'dumpling-maker', 'dumpling maker',
    'prep-cook', 'prep cook', 'pastry-chef', 'pastry chef', 'dishwasher', 'fryer',
    'production-manager', 'production manager', 'logistic-coordinator', 'logistic coordinator', 'busser'
  ];

  // Helper to map job title â†’ standardized key (same as KPIs)
  function getMappedPosition(jobTitle) {
    if (!jobTitle) return null;
    let title = jobTitle.toLowerCase().trim();
    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }
    return mapped;
  }

  // Helper to exclude owners
  const excludeOwners = (employees) => {
    const owners = ['janelle teng', 'francisco teng', 'shoko teng'];
    return employees.filter(emp => {
      const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
      return !owners.includes(fullName);
    });
  };

  const nonOwnerEmployees = excludeOwners(AppState.employees || []);

  // ===== CHART 1: Actions by Job Title =====
 // ===== CHART 1: Actions by Job Title (2x1) - UPDATED WITH NEW COLORS AND BAR SEPARATION =====

// ===== CHART 1: Actions by Job Title (WITH MAXIMUM BAR SEPARATION) =====
// Beautiful color palette: Sunshine Yellow, Teal, Midnight Green, Ocean Blue
const jobTitleCtx = document.getElementById('chart-actions-by-job-title')?.getContext('2d');
if (jobTitleCtx) {
  if (AppState.charts?.actionsByJobTitleChart) {
    AppState.charts.actionsByJobTitleChart.destroy();
  }

  // Create a map to aggregate counts by job title
  const jobTitleMap = {};

  // Iterate over ALL employees to aggregate their warning counts
  AppState.employees.forEach(emp => {
    const jobTitle = emp.job_title || 'Unknown';
    if (!jobTitleMap[jobTitle]) {
      jobTitleMap[jobTitle] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    // Add the employee's warning counts to the total for their job title
    jobTitleMap[jobTitle].verbal += emp.verbal_warning_count || 0;
    jobTitleMap[jobTitle].written += emp.disciplinary_warning_count || 0;
    jobTitleMap[jobTitle].final += emp.final_warning_count || 0;
    jobTitleMap[jobTitle].termination += emp.termination_letter_count || 0;
  });

  // FILTER: Only include job titles that have at least ONE disciplinary action
  const filteredJobTitles = Object.keys(jobTitleMap).filter(jobTitle => {
    const totals = jobTitleMap[jobTitle];
    return (totals.verbal + totals.written + totals.final + totals.termination) > 0;
  });

  if (!AppState.charts) AppState.charts = {};

  AppState.charts.actionsByJobTitleChart = new Chart(jobTitleCtx, {
    type: 'bar',
    data: {
      labels: filteredJobTitles,
      datasets: [
        { 
          label: 'Verbal', 
          data: filteredJobTitles.map(j => jobTitleMap[j].verbal), 
          backgroundColor: '#fbbf24',  // Sunshine Yellow
          borderWidth: 3,
          borderColor: '#f59e0b',  // Golden Yellow
          borderRadius: 6,
          barPercentage: 0.6,  // REDUCED: More space between bars
          categoryPercentage: 0.8  // Controls spacing between categories
        },
        { 
          label: 'Written', 
          data: filteredJobTitles.map(j => jobTitleMap[j].written), 
          backgroundColor: '#14b8a6',  // Teal
          borderWidth: 3,
          borderColor: '#0d9488',  // Dark Teal
          borderRadius: 6,
          barPercentage: 0.6,
          categoryPercentage: 0.8
        },
        { 
          label: 'Final', 
          data: filteredJobTitles.map(j => jobTitleMap[j].final), 
          backgroundColor: '#059669',  // Midnight Green
          borderWidth: 3,
          borderColor: '#047857',  // Forest Green
          borderRadius: 6,
          barPercentage: 0.6,
          categoryPercentage: 0.8
        },
        { 
          label: 'Termination', 
          data: filteredJobTitles.map(j => jobTitleMap[j].termination), 
          backgroundColor: '#0284c7',  // Ocean Blue
          borderWidth: 3,
          borderColor: '#0369a1',  // Deep Ocean Blue
          borderRadius: 6,
          barPercentage: 0.6,
          categoryPercentage: 0.8
        }
      ]
    },
    plugins: [ChartDataLabels],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y',
      layout: {
        padding: {
          left: 15,
          right: 25,
          top: 5,
          bottom: 5
        }
      },
      plugins: {
        legend: { 
          position: 'top',
          labels: {
            font: { size: 13, weight: 'bold' },
            padding: 18,
            usePointStyle: true,
            pointStyle: 'rectRounded',
            boxWidth: 15,
            boxHeight: 15
          }
        },
        title: {
          display: true,
          text: 'Disciplinary Actions by Job Title',
          font: { size: 15, weight: 'bold' },
          color: '#1e293b',
          padding: { bottom: 18 }
        },
        datalabels: {
          display: true,
          color: '#ffffff',
          font: { size: 15, weight: 'bold' },
          anchor: 'center',
          align: 'center',
          formatter: (value) => value > 0 ? value : '',
          textShadowColor: 'rgba(0, 0, 0, 0.3)',
          textShadowBlur: 4
        }
      },
      scales: {
        x: { 
          beginAtZero: true, 
          stacked: true,
          ticks: { 
            stepSize: 1,
            font: { size: 12, weight: '600' },
            color: '#475569'
          },
          grid: { 
            color: '#e2e8f0',
            drawBorder: true,
            lineWidth: 1
          }
        },
        y: { 
          stacked: true,
          ticks: {
            font: { size: 12, weight: 'bold' },
            padding: 12,
            color: '#1e293b'
          },
          grid: { 
            display: false 
          }
        }
      }
    }
  });
}

  // ===== CHART 2: FOH Actions by Type =====
  const fohTypeCtx = document.getElementById('chart-actions-by-type-foh')?.getContext('2d');
  if (fohTypeCtx) {
    if (AppState.charts?.actionsByTypeFohChart) {
      AppState.charts.actionsByTypeFohChart.destroy();
    }

    const counts = { Verbal: 0, Written: 0, Final: 0, Termination: 0 };
    actions.forEach(a => {
      const mapped = getMappedPosition(a.jobTitle);
      if (mapped && fohPositions.includes(mapped)) {
        const t = (a.type || '').toLowerCase();
        if (t.includes('verbal')) counts.Verbal++;
        else if (t.includes('written')) counts.Written++;
        else if (t.includes('final')) counts.Final++;
        else if (t.includes('termination')) counts.Termination++;
      }
    });

    AppState.charts.actionsByTypeFohChart = new Chart(fohTypeCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'FOH Actions',
          data: Object.values(counts),
          backgroundColor: ['#10b981', '#fbbf24', '#fb923c', '#dc2626'],
          borderWidth: 2,
          borderColor: ['#059669', '#f59e0b', '#ea580c', '#b91c1c']
        }]
      },
      plugins: [ChartDataLabels],
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'FOH Disciplinary Actions', font: { size: 14, weight: 'bold' }, color: '#1e293b', padding: { bottom: 15 } },
          datalabels: { display: true, color: '#fff', font: { size: 16, weight: 'bold' }, anchor: 'center', align: 'center', formatter: (value) => value > 0 ? value : '' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#e5e7eb' } },
          x: { ticks: { font: { size: 11, weight: 'bold' } }, grid: { display: false } }
        }
      }
    });
  }

  // ===== CHART 3: BOH Actions by Type =====
  const bohTypeCtx = document.getElementById('chart-actions-by-type-boh')?.getContext('2d');
  if (bohTypeCtx) {
    if (AppState.charts?.actionsByTypeBohChart) {
      AppState.charts.actionsByTypeBohChart.destroy();
    }

    const counts = { Verbal: 0, Written: 0, Final: 0, Termination: 0 };
    actions.forEach(a => {
      const mapped = getMappedPosition(a.jobTitle);
      if (mapped && bohPositions.includes(mapped)) {
        const t = (a.type || '').toLowerCase();
        if (t.includes('verbal')) counts.Verbal++;
        else if (t.includes('written')) counts.Written++;
        else if (t.includes('final')) counts.Final++;
        else if (t.includes('termination')) counts.Termination++;
      }
    });

    AppState.charts.actionsByTypeBohChart = new Chart(bohTypeCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(counts),
        datasets: [{
          label: 'BOH Actions',
          data: Object.values(counts),
          backgroundColor: ['#0ea5e9', '#14b8a6', '#8b5cf6', '#ec4899'],
          borderWidth: 2,
          borderColor: ['#0284c7', '#0d9488', '#7c3aed', '#db2777']
        }]
      },
      plugins: [ChartDataLabels],
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          title: { display: true, text: 'BOH Disciplinary Actions', font: { size: 14, weight: 'bold' }, color: '#1e293b', padding: { bottom: 15 } },
          datalabels: { display: true, color: '#fff', font: { size: 16, weight: 'bold' }, anchor: 'center', align: 'center', formatter: (value) => value > 0 ? value : '' }
        },
        scales: {
          y: { beginAtZero: true, ticks: { stepSize: 1, font: { size: 11 } }, grid: { color: '#e5e7eb' } },
          x: { ticks: { font: { size: 11, weight: 'bold' } }, grid: { display: false } }
        }
      }
    });
  }

  // ===== CHART 4: FOH vs BOH Employee Status (THE FIX) =====
// ===== CHART 4: FOH vs BOH Employee Status (UPDATED COLORS + BIGGER INACTIVE BARS) =====
  const fohBohCtx = document.getElementById('chart-employee-status-foh-boh')?.getContext('2d');
  if (fohBohCtx) {
    if (AppState.charts?.employeeStatusFohBohChart) {
      AppState.charts.employeeStatusFohBohChart.destroy();
    }

    let fohActive = 0, fohInactive = 0, bohActive = 0, bohInactive = 0;

    nonOwnerEmployees.forEach(emp => {
      const isActive = emp.employment_status?.toLowerCase() === 'active';
      const mappedPos = getMappedPosition(emp.job_title);

      if (mappedPos && fohPositions.includes(mappedPos)) {
        if (isActive) fohActive++;
        else fohInactive++;
      } else if (mappedPos && bohPositions.includes(mappedPos)) {
        if (isActive) bohActive++;
        else bohInactive++;
      }
    });

    console.log('âœ… Aligned FOH/BOH Counts:', { fohActive, fohInactive, bohActive, bohInactive });

    AppState.charts.employeeStatusFohBohChart = new Chart(fohBohCtx, {
      type: 'bar',
      data: {
        labels: ['FOH', 'BOH'],
        datasets: [
          { 
            label: 'Active', 
            data: [fohActive, bohActive], 
            backgroundColor: '#06b6d4',  // Cyan/Turquoise (Beautiful & Unique)
            borderWidth: 3,
            borderColor: '#0891b2',  // Darker Cyan
            borderRadius: 8,
            barThickness: 60  // Fixed width for consistent look
          },
          { 
            label: 'Inactive', 
            data: [fohInactive, bohInactive], 
            backgroundColor: '#f97316',  // Vibrant Orange (Easy to see!)
            borderWidth: 3,
            borderColor: '#ea580c',  // Darker Orange
            borderRadius: 8,
            barThickness: 60,  // Same width as Active
            minBarLength: 15  // FORCE minimum bar height so small values are visible!
          }
        ]
      },
      plugins: [ChartDataLabels],
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { 
            display: true, 
            position: 'top', 
            labels: { 
              font: { size: 13, weight: 'bold' }, 
              padding: 18, 
              usePointStyle: true,
              pointStyle: 'rectRounded',
              boxWidth: 15,
              boxHeight: 15
            } 
          },
          title: { 
            display: true, 
            text: 'Employee Status: FOH vs BOH', 
            font: { size: 15, weight: 'bold' }, 
            color: '#1e293b', 
            padding: { bottom: 18 } 
          },
          datalabels: { 
            display: true, 
            color: '#ffffff', 
            font: { size: 16, weight: 'bold' }, 
            anchor: 'center', 
            align: 'center', 
            formatter: (value) => value > 0 ? value : '',
            textShadowColor: 'rgba(0, 0, 0, 0.3)',
            textShadowBlur: 4
          }
        },
        scales: {
          y: { 
            beginAtZero: true,
            // IMPORTANT: Don't let max scale hide small bars
            suggestedMax: Math.max(fohActive, bohActive, fohInactive + 5, bohInactive + 5),
            ticks: { 
              stepSize: 5, 
              font: { size: 12, weight: '600' },
              color: '#475569'
            }, 
            grid: { 
              color: '#e2e8f0',
              lineWidth: 1
            } 
          },
          x: { 
            ticks: { 
              font: { size: 13, weight: 'bold' },
              color: '#1e293b'
            }, 
            grid: { 
              display: false 
            } 
          }
        }
      }
    });
  }

  console.log('âœ… All charts rendered with aligned logic!');
}


// ========================================================================
// DELETE FUNCTION (CONFLICT-FREE)
// ========================================================================
async function deleteDisciplinaryAction(actionId) {
  if (!confirm('âš ï¸ Are you sure you want to delete this disciplinary action?\n\nThis cannot be undone.')) {
    return;
  }

  try {
    const { error } = await window.supabaseClient
      .from('disciplinary_actions')
      .delete()
      .eq('id', actionId);

    if (error) throw error;

    if (typeof showToast === 'function') {
      showToast('âœ“ Action deleted successfully', 'success');
    }
    
    if (typeof loadDisciplinaryActions === 'function') await loadDisciplinaryActions();
    if (typeof loadEmployees === 'function') await loadEmployees();
    if (typeof updateDashboard === 'function') updateDashboard();
    
    console.log('âœ… Action deleted:', actionId);
    
  } catch (err) {
    console.error('âŒ Delete error:', err);
    if (typeof showToast === 'function') {
      showToast('âœ— Failed to delete action', 'error');
    }
  }
}

console.log('âœ… Conflict-free dashboard charts loaded');






// ========================================================================
// RENDER ONLY THE FOH & BOH EMPLOYEE STATUS CHART (2x1)
// ========================================================================
function renderFohBohStatusChart() {
  console.log('ğŸ“Š Rendering FOH & BOH Employee Status Chart...');

  // Get the canvas element
  const fohBohCtx = document.getElementById('chart-employee-status-foh-boh')?.getContext('2d');
  if (!fohBohCtx) {
    console.warn('âŒ Canvas for FOH/BOH status chart not found.');
    return;
  }

  // Destroy existing chart if it exists
  if (AppState.charts?.employeeStatusFohBohChart) {
    AppState.charts.employeeStatusFohBohChart.destroy();
  }

  // ===== STEP 1: Define Owners to Exclude =====
  const owners = ['janelle teng', 'francisco teng', 'shoko teng'];

  // ===== STEP 2: Filter out owners =====
  const nonOwnerEmployees = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    return !owners.includes(fullName);
  });

  // ===== STEP 3: Use Global Position Mapping (Same as KPIs) =====
  const fohPositions = ['foh-manager', 'foh manager', 'server', 'bartender', 'host', 'cashier', 'manager'];
  const bohPositions = [
    'line-cook', 'line cook', 'wok-chef', 'wok chef', 'dumpling-maker', 'dumpling maker',
    'prep-cook', 'prep cook', 'pastry-chef', 'pastry chef', 'dishwasher', 'fryer',
    'production-manager', 'production manager', 'logistic-coordinator', 'logistic coordinator', 'busser'
  ];

  // Helper function to map job title to standardized key
  function getMappedPosition(jobTitle) {
    if (!jobTitle) return null;
    let title = jobTitle.toLowerCase().trim();
    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }
    return mapped;
  }

  // ===== STEP 4: Calculate Active/Inactive Counts =====
  let fohActive = 0, fohInactive = 0, bohActive = 0, bohInactive = 0;

  nonOwnerEmployees.forEach(emp => {
    const isActive = emp.employment_status?.toLowerCase() === 'active';
    const mappedPos = getMappedPosition(emp.job_title);

    if (mappedPos && fohPositions.includes(mappedPos)) {
      if (isActive) fohActive++;
      else fohInactive++;
    } else if (mappedPos && bohPositions.includes(mappedPos)) {
      if (isActive) bohActive++;
      else bohInactive++;
    }
  });

  console.log('âœ… Calculated FOH/BOH Status:', { fohActive, fohInactive, bohActive, bohInactive });

  // ===== STEP 5: Create the Chart with Unique Colors =====
  AppState.charts.employeeStatusFohBohChart = new Chart(fohBohCtx, {
    type: 'bar',
    data: {
      labels: ['FOH', 'BOH'],
      datasets: [
        {
          label: 'Active',
          data: [fohActive, bohActive],
          backgroundColor: '#0f172a', // Midnight Blue (Tailwind's slate-950)
          borderColor: '#1e293b',     // Slightly lighter for border
          borderWidth: 2,
          hoverBackgroundColor: '#1e293b' // Darker on hover
        },
        {
          label: 'Inactive',
          data: [fohInactive, bohInactive],
          backgroundColor: '#f59e0b', // Sunshine Yellow (Tailwind's amber-500)
          borderColor: '#d97706',     // Slightly darker for border
          borderWidth: 2,
          hoverBackgroundColor: '#d97706' // Darker on hover
        }
      ]
    },
    plugins: [ChartDataLabels],
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: true,
          position: 'top',
          labels: {
            font: { size: 12, weight: 'bold' },
            padding: 15,
            usePointStyle: true,
            boxWidth: 15,
            boxHeight: 15,
            generateLabels: function(chart) {
              return chart.data.datasets.map((dataset, i) => {
                const meta = chart.getDatasetMeta(i);
                const style = meta.controller.getStyle(i);
                return {
                  text: dataset.label,
                  fillStyle: style.backgroundColor,
                  strokeStyle: style.borderColor,
                  lineWidth: style.borderWidth,
                  hidden: meta.hidden,
                  index: i
                };
              });
            }
          }
        },
        title: {
          display: true,
          text: 'Employee Status: FOH vs BOH',
          font: { size: 14, weight: 'bold' },
          color: '#1e293b',
          padding: { bottom: 15 }
        },
        datalabels: {
          display: true,
          color: '#ffffff', // White text for contrast
          font: { size: 16, weight: 'bold' },
          anchor: 'center',
          align: 'center',
          formatter: (value) => value > 0 ? value : ''
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: { size: 11 }
          },
          grid: { color: '#e5e7eb' }
        },
        x: {
          ticks: {
            font: { size: 12, weight: 'bold' }
          },
          grid: { display: false }
        }
      }
    }
  });

  console.log('âœ… FOH & BOH Status Chart rendered successfully!');
}







// ============================================================================
// COMPENSATION LETTER TAB - COMPLETE ENHANCED IMPLEMENTATION
// ============================================================================

const CompensationState = {
  selectedEmployee: null,
  wageHistory: [],
  searchTimeout: null,
  tipPositions: ['server', 'bartender', 'busser', 'host', 'hostess', 'cashier']
};

// ============================================================================
// SALARY EMPLOYEE CONFIGURATIONS
// ============================================================================
const SALARY_CONFIGS = {
  // Position-based rules
  'wok chef': {
    weeklyHours: 50,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 50,
  },
  'production manager': {
    weeklyHours: 40,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 40,
  },
  'logistic coordinator': {
    weeklyHours: 40,
    hasOvertime: false, // IMPORTANT: overtime = 0.00 for Logistic Coordinator
    calculateRate: (annualSalary) => annualSalary / 52 / 40,
  },

  // Employee-name overrides
  'cesar ramirez': {
    weeklyHours: 50,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 50,
    isEmployee: true,
  },
  'wilson sanchez': {
    weeklyHours: 50,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 50,
    isEmployee: true,
  },
  'yu li': {
    weeklyHours: 48,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 48,
    isEmployee: true,
  },
  'xing zheng': {
    weeklyHours: 45,
    hasOvertime: true,
    calculateRate: (annualSalary) => annualSalary / 52 / 45,
    isEmployee: true,
  },
};

function normalizeKey(s) {
  return (s || '')
    .toLowerCase()
    .trim()
    .replace(/[-\s]+/g, ' ');
}


// Helper function to get salary config




function getSalaryConfig(employee) {
  if (!employee) return null;
  
  const fullName = `${employee.first_name} ${employee.last_name}`.toLowerCase().trim();
  const position = (employee.job_title?.toLowerCase() || '').trim();
  
  console.log('ğŸ” Checking salary config for:', fullName, 'Position:', position);
  
  // Check by employee name first
  if (SALARY_CONFIGS[fullName]) {
    console.log('âœ… Found salary config by name:', fullName);
    return SALARY_CONFIGS[fullName];
  }
  
  // Then check by position
  if (SALARY_CONFIGS[position]) {
    console.log('âœ… Found salary config by position:', position);
    return SALARY_CONFIGS[position];
  }
  
  console.log('âŒ No salary config found');
  return null;
}





// Helper function to check if employee is salary
function isSalaryEmployee(employee) {
  return getSalaryConfig(employee) !== null;
}

// ============================================================================
// 1. SEARCH EMPLOYEE FOR COMPENSATION LETTER
// ============================================================================
function setupCompensationLetterSearch() {
  const searchInput = document.getElementById('comp-letter-search');
  const dropdown = document.getElementById('comp-letter-search-dropdown');
  
  if (!searchInput || !dropdown) {
    console.warn('âš ï¸ Compensation search elements not found');
    return;
  }

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    
    clearTimeout(CompensationState.searchTimeout);
    
    if (query.length < 2) {
      dropdown.classList.add('hidden');
      return;
    }

    CompensationState.searchTimeout = setTimeout(() => {
      const results = AppState.employees.filter(emp => {
        const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
        const empId = (emp.employee_id || '').toLowerCase();
        return fullName.includes(query.toLowerCase()) || empId.includes(query.toLowerCase());
      }).slice(0, 10);

      dropdown.innerHTML = '';
      
      if (results.length === 0) {
        dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400">No employees found</div>';
      } else {
        results.forEach(emp => {
          const item = document.createElement('div');
          item.className = 'px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors';
          item.innerHTML = `
            <div class="font-bold text-slate-900 text-sm">${emp.first_name} ${emp.last_name}</div>
            <div class="text-xs text-slate-500 mt-1">${emp.employee_id || '--'} â€¢ ${emp.job_title || '--'} â€¢ ${emp.department || '--'}</div>
            <div class="text-xs text-emerald-600 font-bold mt-1">
              Current: $${emp.hourly_rate || '0.00'}/hr
              ${emp.job_title2 ? ` | Pos2: $${emp.hourly_rate2}/hr` : ''}
              ${emp.job_title3 ? ` | Pos3: $${emp.hourly_rate3}/hr` : ''}
            </div>
          `;
          item.addEventListener('click', () => {
            selectEmployeeForCompLetter(emp);
            searchInput.value = `${emp.first_name} ${emp.last_name}`;
            dropdown.classList.add('hidden');
          });
          dropdown.appendChild(item);
        });
      }
      
      dropdown.classList.remove('hidden');
    }, 300);
  });

  // Close dropdown on outside click
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  console.log('âœ… Compensation search initialized');
}




// ============================================================================
// 2. SELECT EMPLOYEE & LOAD DATA - FIXED VERSION
// ============================================================================
// ============================================================================
// 2. SELECT EMPLOYEE & PRE-FILL FORM
// ============================================================================
function preloadCompSignatureNames(employee) {
  const fullName = [employee?.first_name, employee?.last_name]
    .filter(Boolean)
    .join(' ')
    .trim();

  const empNameEl = document.getElementById('comp-sig-emp-name');
  const mgrNameEl = document.getElementById('comp-sig-mgr-name');
  const hrNameEl  = document.getElementById('comp-sig-hr-name');

  if (empNameEl) empNameEl.value = fullName;
  if (mgrNameEl) mgrNameEl.value = employee?.report_to || '';
  if (hrNameEl)  hrNameEl.value  = employee?.hr_witness || '';
}











async function selectEmployeeForCompLetter(employee) {
  console.log('ğŸ“ Loading employee for compensation letter:', employee);

  // -------------------------------
  // Helpers (local, safe)
  // -------------------------------
  const norm = (s) => (s || '').toString().toLowerCase().trim();

  const getSalaryHoursPerWeek = (fullName, jobTitle) => {
    const fullNameN = norm(fullName);
    const jobTitleN = norm(jobTitle);

    // Rules (exactly as you described)
    // Wok Chef + Cesar Ramirez + Wilson Sanchez â†’ /52/50
    if (
      jobTitleN.includes('wok chef') ||
      fullNameN === 'cesar ramirez' ||
      fullNameN === 'wilson sanchez'
    ) return 50;

    // Production Manager â†’ /52/40
    if (jobTitleN.includes('production manager')) return 40;

    // Yu Li â†’ /52/48
    if (fullNameN === 'yu li') return 48;

    // Xing Zheng â†’ /52/45
    if (fullNameN === 'xing zheng') return 45;

    // Logistic Coordinator â†’ /52/40
    if (jobTitleN.includes('logistic coordinator') || jobTitleN.includes('logistics coordinator')) return 40;

    // default
    return 40;
  };

  const calcSalaryHourlyEq = (annualSalary, fullName, jobTitle) => {
    const annual = parseFloat(annualSalary || 0);
    if (!annual || annual <= 0) return null;
    const hours = getSalaryHoursPerWeek(fullName, jobTitle);
    if (!hours || hours <= 0) return null;
    return annual / 52 / hours;
  };

  const getMeetingPay = (meetingPayData) => {
    if (!meetingPayData) return null;
    if (typeof meetingPayData === 'object' && meetingPayData.rate != null) return parseFloat(meetingPayData.rate);
    if (typeof meetingPayData === 'number') return meetingPayData;
    if (typeof meetingPayData === 'string') {
      const n = parseFloat(meetingPayData);
      return isNaN(n) ? null : n;
    }
    return null;
  };

  // -------------------------------
  // State + signature pads
  // -------------------------------
  CompensationState.selectedEmployee = employee;
  ensureCompSignaturePadsReady();
  preloadCompSignatureNames(employee);

  // Clear previous signatures when loading a new employee
  document.getElementById('comp-sig-emp-dataurl').value = '';
  document.getElementById('comp-sig-mgr-dataurl').value = '';
  document.getElementById('comp-sig-hr-dataurl').value = '';

  CompSigPads?.emp?.clear?.();
  CompSigPads?.mgr?.clear?.();
  CompSigPads?.hr?.clear?.();

  // -------------------------------
  // Show employee info section
  // -------------------------------
  const infoSection = document.getElementById('comp-letter-employee-info');
  if (infoSection) infoSection.classList.remove('hidden');

  const fullName = `${employee.first_name || ''} ${employee.last_name || ''}`.trim();

  const nameEl = document.getElementById('comp-letter-employee-name');
  if (nameEl) nameEl.textContent = fullName;

  const idEl = document.getElementById('comp-letter-employee-id');
  if (idEl) idEl.textContent = employee.employee_id || '--';

  const deptEl = document.getElementById('comp-letter-employee-dept');
  if (deptEl) deptEl.textContent = employee.department || '--';

  // Set hidden employee ID for form submission
  const hiddenIdEl = document.getElementById('comp-letter-selected-employee-id');
  if (hiddenIdEl) hiddenIdEl.value = employee.id;

  // =====================================================================
  // CURRENT COMPENSATION STATUS (TABLE)
  // =====================================================================
  const positionsContainer = document.getElementById('comp-letter-current-positions');
  if (positionsContainer) {
    positionsContainer.innerHTML = '';

    const primaryTitle = employee.job_title || '';
    const primaryTitleN = norm(primaryTitle);

    // âœ… Salary detection (simple & reliable)
    const isSalary = !!employee.annual_salary && parseFloat(employee.annual_salary) > 0;

    // Base hourly rate:
    // - salary: derived hourlyEq
    // - hourly: employee.hourly_rate
    let baseHourlyRate = null;
    if (isSalary) {
      baseHourlyRate = calcSalaryHourlyEq(employee.annual_salary, fullName, primaryTitle);
    } else if (employee.hourly_rate) {
      const hr = parseFloat(employee.hourly_rate);
      baseHourlyRate = isNaN(hr) ? null : hr;
    }

    // Training/Meeting/Vacation:
    // - salary: hourlyEq always
    // - hourly: from DB (your current behavior)
    let trainingPay = null;
    let meetingPay = null;
    let vacationPay = null;

    if (isSalary) {
      trainingPay = baseHourlyRate;
      meetingPay = baseHourlyRate;
      vacationPay = baseHourlyRate;
    } else {
      trainingPay = employee.trainning ? parseFloat(employee.trainning) : null;
      meetingPay = getMeetingPay(employee.meetingpay);
      vacationPay = employee.vacation ? parseFloat(employee.vacation) : null;
    }

    // Overtime:
    // - salary: hourlyEq except logistic coordinator = 0.00
    // - hourly: 1.5x (or DB overtime if you want; I keep your rule but only for hourly)
    let overtimeRate = null;
    if (isSalary) {
      const isLogistics =
        primaryTitleN.includes('logistic coordinator') || primaryTitleN.includes('logistics coordinator');
      overtimeRate = isLogistics ? 0 : baseHourlyRate;
    } else {
      // Hourly:
      // prefer stored overtime IF present, else compute 1.5x
      if (employee.overtime != null && employee.overtime !== '') {
        const ot = parseFloat(employee.overtime);
        overtimeRate = isNaN(ot) ? (baseHourlyRate != null ? baseHourlyRate * 1.5 : null) : ot;
      } else {
        overtimeRate = baseHourlyRate != null ? baseHourlyRate * 1.5 : null;
      }
    }

    // Build positions array (supports up to 3 like your current UI)
    const positions = [];

    if (employee.job_title && (employee.hourly_rate || employee.annual_salary)) {
      positions.push({
        badge: 'POS 1',
        badgeColor: 'emerald',
        title: employee.job_title,
        isSalary,
        baseHourlyRate,                 // hourly equivalent for salary
        annualSalary: employee.annual_salary ? parseFloat(employee.annual_salary) : null,
        hourlyRate: employee.hourly_rate ? parseFloat(employee.hourly_rate) : null
      });
    }

    if (employee.job_title2 && employee.hourly_rate2) {
      positions.push({
        badge: 'POS 2',
        badgeColor: 'blue',
        title: employee.job_title2,
        isSalary: false,
        baseHourlyRate: parseFloat(employee.hourly_rate2),
        annualSalary: null,
        hourlyRate: parseFloat(employee.hourly_rate2)
      });
    }

    if (employee.job_title3 && employee.hourly_rate3) {
      positions.push({
        badge: 'POS 3',
        badgeColor: 'purple',
        title: employee.job_title3,
        isSalary: false,
        baseHourlyRate: parseFloat(employee.hourly_rate3),
        annualSalary: null,
        hourlyRate: parseFloat(employee.hourly_rate3)
      });
    }

    const hasMultiplePositions = positions.length > 1;

    if (positions.length > 0) {
      const table = document.createElement('div');
      table.className = 'bg-white rounded-lg border border-gray-300 overflow-hidden shadow-sm';

      const fmt = (n) => (n == null || isNaN(n)) ? null : Number(n).toFixed(2);

      table.innerHTML = `
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-300">
          <div class="grid grid-cols-7 gap-4 px-4 py-3">
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide">Position</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide">Title</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Base Rate</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Training</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Meeting</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Overtime</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Vacation</div>
          </div>
        </div>

        <div class="divide-y divide-gray-200">
          ${positions.map((pos, index) => {
            const baseHourly = pos.baseHourlyRate;

            // For salary employees, show annual salary + hourly equivalent as a helper line
            const baseRateCell = pos.isSalary
              ? `
                <div class="text-right">
                  <div class="font-bold text-gray-900 text-sm">
                    $${(pos.annualSalary || 0).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                  </div>
                  <div class="text-xs text-gray-500 italic">
                    Annual Salary
                    ${fmt(baseHourly) ? ` Â· Hourly Eq: $${fmt(baseHourly)}` : ''}
                  </div>
                </div>
              `
              : `<span class="font-bold text-gray-900 text-sm">$${fmt(baseHourly) || '0.00'}</span>`;

            const trainingCell = (index === 0 && trainingPay != null)
              ? `<span class="font-semibold text-gray-700 text-sm">$${fmt(trainingPay)}</span>`
              : '<span class="text-gray-400 text-xs">N/A</span>';

            const meetingCell = (meetingPay != null)
              ? `<span class="font-semibold text-gray-700 text-sm">$${fmt(meetingPay)}</span>`
              : '<span class="text-gray-400 text-xs">N/A</span>';

            const vacationCell = (vacationPay != null)
              ? `<span class="font-semibold text-gray-700 text-sm">$${fmt(vacationPay)}</span>`
              : '<span class="text-gray-400 text-xs">N/A</span>';

            // IMPORTANT: overtimeRate comes from the rules above (salary vs hourly)
            const overtimeCell = (index === 0)
              ? (
                  overtimeRate == null
                    ? '<span class="text-gray-400 text-xs">N/A</span>'
                    : hasMultiplePositions
                      ? `<span class="text-xs font-bold text-amber-900 bg-amber-100 px-2.5 py-1.5 rounded border border-amber-300 shadow-sm whitespace-nowrap">
                          Blended: $${fmt(overtimeRate)}
                        </span>`
                      : `<span class="font-semibold text-emerald-700 text-sm">$${fmt(overtimeRate)}</span>`
                )
              : '<span class="text-gray-300 text-xs">â†‘</span>';

            return `
              <div class="grid grid-cols-7 gap-4 px-4 py-3 hover:bg-gray-50 transition-colors">
                <div class="col-span-1 flex items-center">
                  <span class="inline-flex items-center bg-${pos.badgeColor}-600 text-white px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                    ${pos.badge}
                  </span>
                </div>

                <div class="col-span-1 flex items-center">
                  <span class="font-semibold text-gray-900 text-sm">${pos.title}</span>
                </div>

                <div class="col-span-1 flex items-center justify-end">
                  ${baseRateCell}
                </div>

                <div class="col-span-1 flex items-center justify-end">
                  ${trainingCell}
                </div>

                <div class="col-span-1 flex items-center justify-end">
                  ${meetingCell}
                </div>

                <div class="col-span-1 flex items-center justify-end">
                  ${overtimeCell}
                </div>

                <div class="col-span-1 flex items-center justify-end">
                  ${vacationCell}
                </div>
              </div>
            `;
          }).join('')}
        </div>

        ${hasMultiplePositions ? `
          <div class="bg-amber-50 border-t border-amber-200 px-4 py-2.5">
            <div class="flex items-center space-x-2 text-xs text-amber-900">
              <i class="fas fa-info-circle"></i>
              <span class="font-semibold">
                Multi-position employee: Overtime rate of $${(overtimeRate == null ? 'N/A' : Number(overtimeRate).toFixed(2))}/hr applies (blended methodology).
              </span>
            </div>
          </div>
        ` : ''}
      `;

      positionsContainer.appendChild(table);
    } else {
      positionsContainer.innerHTML = `
        <div class="bg-gray-50 border border-gray-300 rounded-lg p-6 text-center">
          <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
          <div class="text-gray-500 text-sm font-semibold">No active positions found</div>
        </div>
      `;
    }
  }

  // ğŸ†• LOAD ALL POSITIONS INTO EDITABLE FORM
  loadPositionsIntoForm(employee);

  // Pre-fill hire date
  const hireDateInput = document.getElementById('comp-letter-hire-date');
  if (hireDateInput && employee.original_hire_date) {
    hireDateInput.value = employee.original_hire_date;
  }

  // Set effective date to today
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('comp-letter-effective-date');
  if (dateInput) dateInput.value = today;

  // Load wage history from database
  await loadWageHistory(employee.id);

  // Scroll to form
  const form = document.getElementById('comp-letter-form');
  if (form) {
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  showToast(`âœ… Loaded: ${employee.first_name} ${employee.last_name}`, 'success');

  if (window.showStickySaveButton) {
    window.showStickySaveButton();
  }

  // âœ… LOAD EMPLOYEE COMPENSATION DATA
  loadEmployeeCompensationData(employee);

  setTimeout(() => {
    autoCalculatePayRates();
  }, 500);
}


// ============================================================================
// ğŸ†• LOAD ALL POSITIONS INTO EDITABLE FORM
// ============================================================================
// Add this to the END of loadPositionsIntoForm() function
// ============================================================================
// LOAD POSITIONS INTO FORM (AUTO-FILL ALL FIELDS)
// ============================================================================
// ============================================================================
// LOAD POSITIONS INTO FORM (SEPARATE FUNCTION)
// ============================================================================
function loadPositionsIntoForm(employee) {
  if (!employee) return;
  
  console.log('ğŸ“‹ Loading positions into form:', employee);
  
  // PRIMARY JOB (always exists)
  document.getElementById('primary-job-title').value = employee.job_title || '';
  document.getElementById('primary-department').value = employee.department || '';
  document.getElementById('primary-wage').value = employee.hourly_rate || '';
  
  // SECONDARY JOB (if exists)
  if (employee.job_title2 && employee.hourly_rate2) {
    document.getElementById('secondary-job-title').value = employee.job_title2;
    document.getElementById('secondary-department').value = employee.department || '';
    document.getElementById('secondary-wage').value = employee.hourly_rate2;
  } else {
    // Clear if no secondary job
    document.getElementById('secondary-job-title').value = '';
    document.getElementById('secondary-department').value = '';
    document.getElementById('secondary-wage').value = '';
  }
  
  // TERTIARY JOB (if exists)
  if (employee.job_title3 && employee.hourly_rate3) {
    document.getElementById('tertiary-job-title').value = employee.job_title3;
    document.getElementById('tertiary-department').value = employee.department || '';
    document.getElementById('tertiary-wage').value = employee.hourly_rate3;
  } else {
    // Clear if no tertiary job
    document.getElementById('tertiary-job-title').value = '';
    document.getElementById('tertiary-department').value = '';
    document.getElementById('tertiary-wage').value = '';
  }
  
  // ADDITIONAL COMPENSATION
  const trainingPay = employee.trainning || '';
  const meetingPay = employee.meetingpay?.rate || employee.meetingpay || '';
  const vacationPay = employee.vacation || '';
  
  document.getElementById('comp-letter-training-pay').value = trainingPay;
  document.getElementById('comp-letter-meeting-pay').value = meetingPay;
  document.getElementById('comp-letter-vacation-pay').value = vacationPay;
  
  // EMPLOYMENT INFO
 const employmentType = employee.employment_type || 'PT';
document.getElementById('comp-letter-employment-type').value = employmentType;
  
  const hireDate = employee.original_hire_date || employee.hire_date || '';
  document.getElementById('comp-letter-hire-date').value = hireDate;
  
  // Calculate overtime after loading all data
  setTimeout(() => {
    calculateOvertimeRate();
  }, 100);
  
  console.log('âœ… Positions loaded into form successfully');
}

// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================
// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================
function clearSecondaryPosition() {
  console.log('ğŸ”´ clearSecondaryPosition called!');
  alert('Delete button clicked!');
  
  if (confirm('âš ï¸ Are you sure you want to delete the Secondary position?')) {
    console.log('âœ… User confirmed delete');
    
    const jobField = document.getElementById('secondary-job-title');
    const deptField = document.getElementById('secondary-department');
    const wageField = document.getElementById('secondary-wage');
    
    console.log('Fields found:', { jobField, deptField, wageField });
    
    if (jobField) jobField.value = '';
    if (deptField) deptField.value = '';
    if (wageField) wageField.value = '';
    
    calculateOvertimeRate();
    showToast('âœ… Secondary position cleared', 'success');
  }
}

function clearTertiaryPosition() {
  console.log('ğŸ”´ clearTertiaryPosition called!');
  alert('Delete button clicked!');
  
  if (confirm('âš ï¸ Are you sure you want to delete the Tertiary position?')) {
    console.log('âœ… User confirmed delete');
    
    const jobField = document.getElementById('tertiary-job-title');
    const deptField = document.getElementById('tertiary-department');
    const wageField = document.getElementById('tertiary-wage');
    
    console.log('Fields found:', { jobField, deptField, wageField });
    
    if (jobField) jobField.value = '';
    if (deptField) deptField.value = '';
    if (wageField) wageField.value = '';
    
    calculateOvertimeRate();
    showToast('âœ… Tertiary position cleared', 'success');
  }
}

// â­ ADD THESE 2 LINES RIGHT HERE â­
window.clearSecondaryPosition = clearSecondaryPosition;
window.clearTertiaryPosition = clearTertiaryPosition;

// ============================================================================
// ğŸ†• ADD NEW POSITION
// ============================================================================
function addNewPosition(slot, meetingPay, vacationPay, overtimePay) {
  const newPosition = {
    slot: slot,
    jobTitle: '',
    hourlyRate: '',
    department: 'FOH'
  };
  
  const formContainer = document.getElementById('comp-letter-positions-form-container');
  if (!formContainer) return;
  
  // Remove "Add Position" button
  const addBtn = formContainer.querySelector('button[onclick*="addNewPosition"]');
  if (addBtn) addBtn.remove();
  
  // Get current position count
  const currentPositions = formContainer.querySelectorAll('[data-position-slot]').length;
  
  // Add new position card
  const card = createPositionCard(newPosition, currentPositions, '', meetingPay, vacationPay, overtimePay, currentPositions + 1);
  formContainer.appendChild(card);
  
  // Re-add "Add Position" button if still under 3
  if (currentPositions + 1 < 3) {
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg py-4 px-6 flex items-center justify-center space-x-2 text-blue-700 font-bold transition-all';
    addBtn.innerHTML = `
      <i class="fas fa-plus-circle text-xl"></i>
      <span>Add Another Position (${currentPositions + 1}/3)</span>
    `;
    addBtn.onclick = () => addNewPosition(currentPositions + 2, meetingPay, vacationPay, overtimePay);
    formContainer.appendChild(addBtn);
  }
  
  showToast('âœ… Position added', 'success');
  recalculateOvertimeRate();
}

// ============================================================================
// ğŸ†• REMOVE POSITION
// ============================================================================


// ============================================================================
// ğŸ†• RECALCULATE OVERTIME RATE (Blended if 2+ positions)
// ============================================================================
function recalculateOvertimeRate() {
  const positions = document.querySelectorAll('[data-position-slot]');
  const overtimeDisplay = document.getElementById('overtime-rate-display');
  
  if (positions.length > 1) {
    // Multi-position: Show "Blended OT" message
    if (overtimeDisplay) {
      overtimeDisplay.innerHTML = `
        <div class="bg-amber-100 border border-amber-300 rounded-lg p-4 text-center">
          <span class="text-amber-900 font-bold text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Blended Overtime Rate will be calculated based on all positions
          </span>
        </div>
      `;
    }
  } else {
    // Single position: Calculate 1.5x
    const hourlyRate = document.getElementById('hourly-rate-1')?.value;
    if (hourlyRate && overtimeDisplay) {
      const ot = (parseFloat(hourlyRate) * 1.5).toFixed(2);
      overtimeDisplay.innerHTML = `
        <div class="bg-emerald-100 border border-emerald-300 rounded-lg p-4 text-center">
          <span class="text-emerald-900 font-bold text-lg">
            Overtime Rate: $${ot}/hr <span class="text-sm font-normal">(1.5x Base)</span>
          </span>
        </div>
      `;
    }
  }
}














// ============================================================================
// DISPLAY CURRENT COMPENSATION STATUS - READ ONLY
// ============================================================================
function displayCurrentCompensationStatus(employee) {
  console.log('ğŸ“Š Displaying current compensation status for:', employee);
  
  const statusSection = document.getElementById('comp-letter-current-status');
  if (!statusSection) return;
  
  // Show the status section
  statusSection.classList.remove('hidden');
  
  // âœ… POSITION 1 - PRIMARY (Green)
  const pos1Container = document.getElementById('current-position-1');
  if (employee.job_title && employee.hourly_rate) {
    pos1Container.classList.remove('hidden');
    
    document.getElementById('current-pos1-title').textContent = employee.job_title || '--';
    document.getElementById('current-pos1-dept').textContent = employee.department || '--';
    document.getElementById('current-pos1-type').textContent = employee.compensation_type || 'hourly';
    document.getElementById('current-pos1-training').textContent = employee.training_pay ? `$${parseFloat(employee.training_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-hourly').textContent = `$${parseFloat(employee.hourly_rate).toFixed(2)}`;
    document.getElementById('current-pos1-meeting').textContent = employee.meeting_pay ? `$${parseFloat(employee.meeting_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-overtime').textContent = employee.overtime_pay ? `$${parseFloat(employee.overtime_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-vacation').textContent = employee.vacation_pay ? `$${parseFloat(employee.vacation_pay).toFixed(2)}` : '--';
  } else {
    pos1Container.classList.add('hidden');
  }
  
  // âœ… POSITION 2 - SECONDARY (Blue)
  const pos2Container = document.getElementById('current-position-2');
  if (employee.job_title2 && employee.hourly_rate2) {
    pos2Container.classList.remove('hidden');
    
    document.getElementById('current-pos2-title').textContent = employee.job_title2 || '--';
    document.getElementById('current-pos2-dept').textContent = employee.department || '--';
    document.getElementById('current-pos2-type').textContent = 'hourly';
    document.getElementById('current-pos2-training').textContent = employee.training_pay2 ? `$${parseFloat(employee.training_pay2).toFixed(2)}` : '--';
    document.getElementById('current-pos2-hourly').textContent = `$${parseFloat(employee.hourly_rate2).toFixed(2)}`;
    document.getElementById('current-pos2-meeting').textContent = employee.meeting_pay2 ? `$${parseFloat(employee.meeting_pay2).toFixed(2)}` : '--';
    document.getElementById('current-pos2-overtime').textContent = 'Blended OT';
    document.getElementById('current-pos2-vacation').textContent = employee.vacation_pay2 ? `$${parseFloat(employee.vacation_pay2).toFixed(2)}` : '--';
  } else {
    pos2Container.classList.add('hidden');
  }
  
  // âœ… POSITION 3 - TERTIARY (Purple)
  const pos3Container = document.getElementById('current-position-3');
  if (employee.job_title3 && employee.hourly_rate3) {
    pos3Container.classList.remove('hidden');
    
    document.getElementById('current-pos3-title').textContent = employee.job_title3 || '--';
    document.getElementById('current-pos3-dept').textContent = employee.department || '--';
    document.getElementById('current-pos3-type').textContent = 'hourly';
    document.getElementById('current-pos3-training').textContent = employee.training_pay3 ? `$${parseFloat(employee.training_pay3).toFixed(2)}` : '--';
    document.getElementById('current-pos3-hourly').textContent = `$${parseFloat(employee.hourly_rate3).toFixed(2)}`;
    document.getElementById('current-pos3-meeting').textContent = employee.meeting_pay3 ? `$${parseFloat(employee.meeting_pay3).toFixed(2)}` : '--';
    document.getElementById('current-pos3-overtime').textContent = 'Blended OT';
    document.getElementById('current-pos3-vacation').textContent = employee.vacation_pay3 ? `$${parseFloat(employee.vacation_pay3).toFixed(2)}` : '--';
  } else {
    pos3Container.classList.add('hidden');
  }
  
  console.log('âœ… Current status displayed');
}






























// ============================================================================
// STICKY SAVE BUTTON - CLEAN FAB STYLE
// ============================================================================
function setupStickySaveButton() {
  const stickyBtn = document.getElementById('sticky-comp-letter-save-btn');
  const form = document.getElementById('comp-letter-form');
  const stickyContainer = document.getElementById('comp-letter-sticky-save');
  
  if (!stickyBtn || !form) return;
  
  // SAVE button click
  stickyBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    
    // Validate form first
    if (!form.checkValidity()) {
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
      showToast('âš ï¸ Please fill in all required fields', 'error');
      return;
    }
    
    // Show loading state
    stickyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    stickyBtn.disabled = true;
    
    // Trigger the existing save function
    await saveCompensationLetter();
    
    // Reset button
    stickyBtn.innerHTML = '<i class="fas fa-check"></i>';
    stickyBtn.disabled = false;
    
    // Reset after 2 seconds
    setTimeout(() => {
      stickyBtn.innerHTML = '<i class="fas fa-save"></i>';
    }, 2000);
  });
  
  // Show sticky button when employee selected
  window.showStickySaveButton = () => {
    if (CompensationState.selectedEmployee && stickyContainer) {
      stickyContainer.classList.remove('hidden');
    }
  };
  
  // Hide sticky button when form reset
  window.hideStickySaveButton = () => {
    if (stickyContainer) {
      stickyContainer.classList.add('hidden');
    }
  };
}

// ============================================================================
// INITIALIZE - Call this in initCompensationLetterTab()
// ============================================================================
// Add this line at the END of your initCompensationLetterTab() function:
// setupStickySaveButton();















// ============================================================================
// 3. LOAD WAGE HISTORY FROM DATABASE
// ============================================================================
// ============================================================================
// 3. LOAD WAGE HISTORY FROM DATABASE
// ============================================================================
// ============================================================================
// LOAD WAGE HISTORY
// ============================================================================
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   REPLACE YOUR EXISTING loadWageHistory FUNCTION WITH THIS VERSION
   
   Location: Around line 11011 in your hr2.txt file
   
   This version:
   - Works with your actual table structure (compensation_letters)
   - Handles the 'hourly' type constraint
   - Shows PDF links from storage
   - Works for ANY employee
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

let currentEmployeeId = null; // Store current employee ID

/**
 * Load wage & position history for any employee
 * @param {number} employeeId - The employee's ID from employees2025 table
 */
async function loadWageHistory(employeeId) {
  console.log('ğŸ” Loading wage history for employee ID:', employeeId);
  currentEmployeeId = employeeId;
  
  const loadingDiv = document.getElementById('wage-history-loading');
  const emptyDiv = document.getElementById('wage-history-empty');
  const itemsDiv = document.getElementById('wage-history-items');
  const bulkControlsBar = document.getElementById('bulk-controls-bar');
  
  if (!loadingDiv || !emptyDiv || !itemsDiv) {
    console.error('âŒ Wage history container elements not found');
    return;
  }
  
  // Show loading state
  loadingDiv.classList.remove('hidden');
  emptyDiv.classList.add('hidden');
  itemsDiv.innerHTML = '';
  if (bulkControlsBar) bulkControlsBar.classList.add('hidden');
  
  try {
    // âœ… FIXED: Query wage_history table and group by effective_date
    // Get unique compensation letters (one per effective_date)
    const { data, error } = await window.supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', employeeId)
      .order('effective_date', { ascending: false });
    
    if (error) {
      console.error('âŒ Database error:', error);
      throw error;
    }
    
    console.log(`âœ… Found ${data?.length || 0} wage history records`);
    
    // âœ… Group records by effective_date (since each letter has multiple position records)
    const groupedByDate = {};
    if (data) {
      data.forEach(record => {
        const dateKey = record.effective_date;
        if (!groupedByDate[dateKey]) {
          groupedByDate[dateKey] = {
            effective_date: record.effective_date,
            created_at: record.created_at || record.letter_generated_at,
            pdf_url: record.pdf_url,
            change_type: record.change_type,
            employment_type: record.employment_type,
            positions: []
          };
        }
        groupedByDate[dateKey].positions.push({
          position_number: record.position_number,
          position_title: record.position_title,
          hourly_rate: record.hourly_rate,
          department: record.department
        });
      });
    }
    
    // Convert to array and sort by date
    const groupedData = Object.values(groupedByDate).sort((a, b) => 
      new Date(b.effective_date) - new Date(a.effective_date)
    );
    
    console.log(`âœ… Grouped into ${groupedData.length} compensation letters`);
    
    // Hide loading
    loadingDiv.classList.add('hidden');
    
    // Check if empty
    if (!groupedData || groupedData.length === 0) {
      emptyDiv.classList.remove('hidden');
      if (bulkControlsBar) bulkControlsBar.classList.add('hidden');
      return;
    }
    
    // âœ… SHOW BULK CONTROLS BAR
    if (bulkControlsBar) bulkControlsBar.classList.remove('hidden');
    
    // Render history items
    itemsDiv.innerHTML = groupedData.map((item, index) => {
      const isCurrent = index === 0;
      const typeIcon = 'fa-solid fa-file-contract';
      const typeColor = 'blue';
      
      // Build positions display
      const positionsHtml = item.positions
        .sort((a, b) => a.position_number - b.position_number)
        .map((pos, idx) => {
          const posLabel = idx === 0 ? 'Primary' : idx === 1 ? 'Secondary' : 'Tertiary';
          const posColor = idx === 0 ? 'green' : idx === 1 ? 'blue' : 'purple';
          return `
            <div class="flex items-center gap-2 text-xs">
              <span class="bg-${posColor}-100 text-${posColor}-800 px-2 py-1 rounded font-bold">${posLabel}</span>
              <span class="font-bold">${pos.position_title}</span>
              <span class="text-slate-600">$${parseFloat(pos.hourly_rate).toFixed(2)}/hr</span>
            </div>
          `;
        })
        .join('');
      
      return `
        <div class="bg-slate-50 rounded-lg border-2 border-slate-200 p-5 hover:border-blue-400 hover:shadow-md transition-all">
          <div class="flex items-center gap-4">
            
            <!-- âœ… CHECKBOX -->
            <div class="flex-shrink-0 pl-2">
              <input type="checkbox" 
                     class="compensation-checkbox w-6 h-6 text-blue-600 rounded-lg cursor-pointer border-2 border-slate-400"
                     data-date="${item.effective_date}"
                     data-url="${item.pdf_url || ''}"
                     onchange="updateBulkDeleteButton()">
            </div>
            
            <div class="flex-1">
              <!-- Type Badge -->
              <div class="flex items-center gap-3 mb-2">
                <span class="bg-${typeColor}-600 text-white px-3 py-1 rounded-full text-xs font-black uppercase flex items-center gap-2">
                  <i class="${typeIcon}"></i>
                  ${item.change_type || 'Compensation Letter'}
                </span>
                ${isCurrent ? '<span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-black">CURRENT</span>' : ''}
              </div>
              
              <!-- Positions -->
              <div class="mb-3 space-y-1">
                ${positionsHtml}
              </div>
              
              <!-- Date Information -->
              <div class="grid grid-cols-2 gap-4 mt-3">
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">
                    <i class="fa-solid fa-calendar-days mr-1"></i>
                    Effective Date
                  </p>
                  <p class="text-sm font-black text-slate-800">${formatDate(item.effective_date)}</p>
                </div>
                <div>
                  <p class="text-xs font-bold text-slate-500 uppercase tracking-wide mb-1">
                    <i class="fa-solid fa-clock mr-1"></i>
                    Created
                  </p>
                  <p class="text-sm font-bold text-slate-700">${formatDate(item.created_at)}</p>
                </div>
              </div>
            </div>
            
            <!-- Action Buttons -->
            <div class="flex items-center gap-3">
              ${item.pdf_url ? `
                <a href="${item.pdf_url}" target="_blank" 
                   class="px-5 py-3 bg-blue-600 hover:bg-blue-700 text-white font-black rounded-lg transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
                  <i class="fa-solid fa-file-pdf"></i>
                  View PDF
                </a>
              ` : `
                <button disabled 
                        class="px-5 py-3 bg-slate-400 text-white font-black rounded-lg cursor-not-allowed flex items-center gap-2">
                  <i class="fa-solid fa-file-pdf"></i>
                  No PDF
                </button>
              `}
              <button onclick="deleteCompensationLetter(${employeeId}, '${item.effective_date}')" 
                      class="px-4 py-3 bg-red-600 hover:bg-red-700 text-white font-black rounded-lg transition-all shadow-lg hover:shadow-xl">
                <i class="fa-solid fa-trash"></i>
              </button>
            </div>
          </div>
        </div>
      `;
    }).join('');
    
  } catch (err) {
    console.error('âŒ Error loading wage history:', err);
    loadingDiv.classList.add('hidden');
    emptyDiv.classList.remove('hidden');
    if (bulkControlsBar) bulkControlsBar.classList.add('hidden');
    
    const errorMessage = document.createElement('div');
    errorMessage.className = 'bg-red-50 border-2 border-red-200 rounded-lg p-4 text-center';
    errorMessage.innerHTML = `
      <i class="fa-solid fa-exclamation-triangle text-red-600 text-3xl mb-2"></i>
      <p class="text-red-800 font-bold">Error loading compensation history</p>
      <p class="text-red-600 text-sm mt-1">${err.message}</p>
    `;
    itemsDiv.innerHTML = '';
    itemsDiv.appendChild(errorMessage);
  }
}

// Make sure function is globally accessible
window.loadWageHistory = loadWageHistory;
console.log('âœ… loadWageHistory function loaded (FIXED VERSION)');

// ============================================================================
// STEP 2: ADD BULK DELETE FUNCTIONS
// ============================================================================
// Add these new functions after your existing functions

/**
 * Toggle all checkboxes
 */
function toggleSelectAll() {
  const selectAllCheckbox = document.getElementById('select-all-compensation');
  const checkboxes = document.querySelectorAll('.compensation-checkbox');
  
  console.log(`${selectAllCheckbox.checked ? 'âœ… Selecting' : 'â¬œ Deselecting'} all ${checkboxes.length} items`);
  
  checkboxes.forEach(checkbox => {
    checkbox.checked = selectAllCheckbox.checked;
  });
  
  updateBulkDeleteButton();
}

/**
 * Update the bulk delete button state
 */
function updateBulkDeleteButton() {
  const checkboxes = document.querySelectorAll('.compensation-checkbox:checked');
  const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
  const selectedCount = document.getElementById('selected-count');
  
  console.log(`ğŸ“Š ${checkboxes.length} items selected`);
  
  if (bulkDeleteBtn) {
    if (checkboxes.length > 0) {
      // ENABLE button
      bulkDeleteBtn.disabled = false;
      bulkDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
      bulkDeleteBtn.classList.add('hover:bg-red-700', 'hover:scale-105');
      
      if (selectedCount) {
        selectedCount.textContent = `Delete Selected (${checkboxes.length})`;
      }
    } else {
      // DISABLE button
      bulkDeleteBtn.disabled = true;
      bulkDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');
      bulkDeleteBtn.classList.remove('hover:bg-red-700', 'hover:scale-105');
      
      if (selectedCount) {
        selectedCount.textContent = 'Delete Selected';
      }
    }
  }
}
/**
 * Bulk delete selected compensation letters
 */
async function bulkDeleteSelected() {
  const checkboxes = document.querySelectorAll('.compensation-checkbox:checked');
  
  if (checkboxes.length === 0) {
    alert('âš ï¸ Please select at least one compensation letter to delete');
    return;
  }
  
  // Confirm deletion
  const confirmMessage = 
    `âš ï¸ DELETE ${checkboxes.length} COMPENSATION LETTER${checkboxes.length > 1 ? 'S' : ''}\n\n` +
    `This will permanently delete:\n` +
    `â€¢ ${checkboxes.length} database record${checkboxes.length > 1 ? 's' : ''}\n` +
    `â€¢ ${checkboxes.length} PDF file${checkboxes.length > 1 ? 's' : ''} from storage\n\n` +
    `âš ï¸ THIS ACTION CANNOT BE UNDONE! âš ï¸\n\n` +
    `Are you absolutely sure you want to continue?`;
  
  if (!confirm(confirmMessage)) {
    return;
  }
  
  console.log(`ğŸ—‘ï¸ Starting bulk deletion of ${checkboxes.length} items...`);
  
  // Show progress on button
  const bulkDeleteBtn = document.getElementById('bulk-delete-btn');
  const originalHTML = bulkDeleteBtn ? bulkDeleteBtn.innerHTML : '';
  if (bulkDeleteBtn) {
    bulkDeleteBtn.disabled = true;
    bulkDeleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin mr-2"></i>Deleting...';
  }
  
  let successCount = 0;
  let failCount = 0;
  const errors = [];
  
  // Process each selected item
  for (const checkbox of checkboxes) {
    const id = parseInt(checkbox.dataset.id);
    const pdfUrl = checkbox.dataset.url;
    
    try {
      // Extract filename from URL
      let filename = null;
      if (pdfUrl) {
        if (pdfUrl.includes('/COMPENSATION_LETTERS/')) {
          filename = pdfUrl.split('/COMPENSATION_LETTERS/')[1];
        } else {
          const parts = pdfUrl.split('/');
          filename = parts[parts.length - 1];
        }
        
        if (filename && filename.includes('?')) {
          filename = filename.split('?')[0];
        }
      }
      
      // Delete from storage
      if (filename) {
        const { error: storageError } = await window.supabaseClient
          .storage
          .from('COMPENSATION_LETTERS')
          .remove([filename]);
        
        if (storageError) {
          console.warn(`âš ï¸ Storage deletion warning for ${filename}:`, storageError);
        } else {
          console.log(`âœ… Deleted file: ${filename}`);
        }
      }
      
      // Delete from database
      const { error: dbError } = await window.supabaseClient
        .from('compensation_letters')
        .delete()
        .eq('id', id);
      
      if (dbError) {
        throw dbError;
      }
      
      successCount++;
      console.log(`âœ… Deleted record ID: ${id}`);
      
    } catch (error) {
      failCount++;
      errors.push(`ID ${id}: ${error.message}`);
      console.error(`âŒ Failed to delete ID ${id}:`, error);
    }
  }
  
  // Restore button
  if (bulkDeleteBtn) {
    bulkDeleteBtn.innerHTML = originalHTML;
  }
  
  // Show results
  console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
  console.log(`ğŸ“Š BULK DELETE COMPLETE`);
  console.log(`   âœ… Success: ${successCount}`);
  console.log(`   âŒ Failed: ${failCount}`);
  console.log(`â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”`);
  
  let message = '';
  if (successCount > 0) {
    message += `âœ… Successfully deleted ${successCount} compensation letter${successCount > 1 ? 's' : ''}!\n\n`;
  }
  if (failCount > 0) {
    message += `âŒ Failed to delete ${failCount} letter${failCount > 1 ? 's' : ''}\n\n`;
    message += `Errors:\n${errors.slice(0, 5).join('\n')}`;
    if (errors.length > 5) {
      message += `\n... and ${errors.length - 5} more`;
    }
  }
  
  alert(message || 'âœ… Deletion complete!');
  
  // Refresh the list
  console.log('ğŸ”„ Refreshing wage history...');
  refreshWageHistory();
}

// Make functions globally accessible
if (typeof window !== 'undefined') {
  window.toggleSelectAll = toggleSelectAll;
  window.updateBulkDeleteButton = updateBulkDeleteButton;
  window.bulkDeleteSelected = bulkDeleteSelected;
}

console.log('âœ… Improved bulk delete functions loaded');




/**
 * Refresh wage history for current employee
 */
function refreshWageHistory() {
  if (currentEmployeeId) {
    console.log('ğŸ”„ Refreshing wage history for employee:', currentEmployeeId);
    loadWageHistory(currentEmployeeId);
  } else {
    console.warn('âš ï¸ No employee ID set for refresh');
  }
}

/**
 * View compensation PDF
 * @param {number} compensationId - The ID of the compensation letter
 */
async function viewCompensationPDF(compensationId) {
  console.log('ğŸ“„ Opening PDF for compensation ID:', compensationId);
  
  try {
    // Fetch the PDF URL from database
    const { data, error } = await window.supabaseClient
      .from('compensation_letters')
      .select('pdf_url')
      .eq('id', compensationId)
      .single();
    
    if (error) throw error;
    
    if (data && data.pdf_url) {
      console.log('âœ… Opening PDF:', data.pdf_url);
      // Open PDF in new tab
      window.open(data.pdf_url, '_blank');
    } else {
      alert('âŒ PDF not found for this compensation letter');
    }
  } catch (error) {
    console.error('âŒ Error viewing PDF:', error);
    alert('Error loading PDF: ' + error.message);
  }
}

/**
 * Delete compensation history entry
 * @param {number} compensationId - The ID of the compensation letter to delete
 */
async function deleteCompensationHistory(compensationId) {
  // Confirm deletion
  if (!confirm(
    'âš ï¸ DELETE COMPENSATION LETTER\n\n' +
    'This will permanently delete:\n' +
    'â€¢ The database record\n' +
    'â€¢ The PDF file from storage\n\n' +
    'This action CANNOT be undone!\n\n' +
    'Are you sure you want to continue?'
  )) {
    return;
  }
  
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ—‘ï¸ Starting deletion process for ID:', compensationId);
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  
  let deletedFromStorage = false;
  let deletedFromDatabase = false;
  
  try {
    // ========== STEP 1: FETCH RECORD ==========
    console.log('ğŸ“‹ Step 1: Fetching record from database...');
    const { data: record, error: fetchError } = await window.supabaseClient
      .from('compensation_letters')
      .select('*')
      .eq('id', compensationId)
      .single();
    
    if (fetchError) throw new Error('Failed to fetch record: ' + fetchError.message);
    if (!record) throw new Error('Record not found in database');
    
    console.log('âœ… Record found:', record);
    
    // ========== STEP 2: EXTRACT FILENAME ==========
    console.log('ğŸ“ Step 2: Extracting filename from URL...');
    const pdfUrl = record.pdf_url;
    
    if (!pdfUrl) {
      console.warn('âš ï¸ No PDF URL in record - skipping storage deletion');
    } else {
      // Extract filename from URL
      let filename = null;
      
      // Try different URL formats
      if (pdfUrl.includes('/object/public/COMPENSATION_LETTERS/')) {
        // Format: https://.../storage/v1/object/public/COMPENSATION_LETTERS/filename.pdf
        filename = pdfUrl.split('/COMPENSATION_LETTERS/')[1];
      } else if (pdfUrl.includes('COMPENSATION_LETTERS/')) {
        // Simpler format
        filename = pdfUrl.split('COMPENSATION_LETTERS/')[1];
      } else {
        // Fallback: just get last part of URL
        const parts = pdfUrl.split('/');
        filename = parts[parts.length - 1];
      }
      
      // Remove any query parameters
      if (filename && filename.includes('?')) {
        filename = filename.split('?')[0];
      }
      
      console.log('ğŸ“„ Extracted filename:', filename);
      
      if (!filename) {
        console.warn('âš ï¸ Could not extract filename - skipping storage deletion');
      } else {
        // ========== STEP 3: DELETE FROM STORAGE ==========
        console.log('ğŸ—‘ï¸ Step 3: Deleting file from storage bucket...');
        const { data: storageData, error: storageError } = await window.supabaseClient
          .storage
          .from('COMPENSATION_LETTERS')
          .remove([filename]);
        
        if (storageError) {
          console.error('âŒ Storage deletion error:', storageError);
          console.warn('âš ï¸ Will continue with database deletion anyway');
        } else {
          console.log('âœ… File deleted from storage:', storageData);
          deletedFromStorage = true;
        }
      }
    }
    
    // ========== STEP 4: DELETE FROM DATABASE ==========
    console.log('ğŸ—‘ï¸ Step 4: Deleting record from database...');
    const { error: dbError } = await window.supabaseClient
      .from('compensation_letters')
      .delete()
      .eq('id', compensationId);
    
    if (dbError) throw new Error('Failed to delete from database: ' + dbError.message);
    
    console.log('âœ… Record deleted from database');
    deletedFromDatabase = true;
    
    // ========== STEP 5: SUCCESS MESSAGE ==========
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('âœ… DELETION COMPLETE');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    let successMessage = 'âœ… Deletion Complete!\n\n';
    if (deletedFromStorage) {
      successMessage += 'âœ“ PDF file removed from storage\n';
    }
    if (deletedFromDatabase) {
      successMessage += 'âœ“ Database record removed\n';
    }
    
    alert(successMessage);
    
    // Refresh the list
    refreshWageHistory();
    
  } catch (error) {
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.error('âŒ DELETION FAILED');
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.error('Error:', error);
    
    let errorMessage = 'âŒ Error during deletion:\n\n' + error.message + '\n\n';
    if (deletedFromStorage && !deletedFromDatabase) {
      errorMessage += 'âš ï¸ WARNING: PDF was deleted from storage but database record still exists!';
    } else if (!deletedFromStorage && deletedFromDatabase) {
      errorMessage += 'âš ï¸ WARNING: Database record was deleted but PDF file may still exist in storage!';
    }
    errorMessage += '\n\nCheck browser console (F12) for details.';
    
    alert(errorMessage);
  }
}



/**
 * Helper: Get icon for compensation type
 * @param {string} type - The compensation type
 * @returns {string} Font Awesome icon class
 */
function getTypeIcon(type) {
  const typeStr = (type || '').toLowerCase();
  
  // Check for specific types
  if (typeStr.includes('hire')) return 'fa-solid fa-user-plus';
  if (typeStr.includes('promotion')) return 'fa-solid fa-arrow-trend-up';
  if (typeStr.includes('raise')) return 'fa-solid fa-money-bill-trend-up';
  if (typeStr.includes('merit')) return 'fa-solid fa-star';
  if (typeStr.includes('adjustment')) return 'fa-solid fa-sliders';
  if (typeStr.includes('transfer')) return 'fa-solid fa-arrows-turn-right';
  if (typeStr.includes('hourly')) return 'fa-solid fa-clock';
  if (typeStr.includes('salary')) return 'fa-solid fa-money-bill';
  
  // Default icon
  return 'fa-solid fa-file-lines';
}

/**
 * Helper: Get color for compensation type
 * @param {string} type - The compensation type
 * @returns {string} Tailwind color name
 */
function getTypeColor(type) {
  const typeStr = (type || '').toLowerCase();
  
  // Check for specific types
  if (typeStr.includes('hire')) return 'blue';
  if (typeStr.includes('promotion')) return 'purple';
  if (typeStr.includes('raise')) return 'green';
  if (typeStr.includes('merit')) return 'yellow';
  if (typeStr.includes('adjustment')) return 'orange';
  if (typeStr.includes('transfer')) return 'indigo';
  if (typeStr.includes('hourly')) return 'cyan';
  if (typeStr.includes('salary')) return 'emerald';
  
  // Default color
  return 'slate';
}

/**
 * Helper: Format date
 * @param {string} dateString - ISO date string
 * @returns {string} Formatted date
 */
function formatDate(dateString) {
  if (!dateString) return 'N/A';
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('en-US', { 
      year: 'numeric', 
      month: 'short', 
      day: 'numeric' 
    });
  } catch (error) {
    console.error('Error formatting date:', error);
    return 'Invalid Date';
  }
}

// Export for use in other functions
window.loadWageHistory = loadWageHistory;
window.refreshWageHistory = refreshWageHistory;
window.viewCompensationPDF = viewCompensationPDF;
window.deleteCompensationHistory = deleteCompensationHistory;

console.log('âœ… Wage history functions loaded');


// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
async function deleteCompensationLetter(employeeId, effectiveDate) {
  if (!confirm('âš ï¸ Are you sure you want to delete this entire compensation letter?\n\nThis will delete ALL positions (Primary, Secondary, Tertiary) for this effective date AND the PDF file from storage.')) {
    return;
  }
  
  try {
    console.log('ğŸ—‘ï¸ Starting deletion process...');
    console.log('Employee ID:', employeeId);
    console.log('Effective Date:', effectiveDate);
    
    // STEP 1: Get all wage_history records to find PDF URLs
    const { data: records, error: fetchError } = await supabaseClient
      .from('wage_history')
      .select('pdf_url')
      .eq('employee_id', employeeId)
      .eq('effective_date', effectiveDate);
    
    if (fetchError) {
      console.error('âŒ Fetch error:', fetchError);
      throw fetchError;
    }
    
    console.log('ğŸ“‹ Found records:', records?.length || 0);
    
    // STEP 2: Delete PDF files from Storage (if they exist)
    if (records && records.length > 0) {
      const pdfUrl = records[0].pdf_url; // All records share the same PDF
      
      if (pdfUrl) {
        // Extract filename from URL
        const fileName = pdfUrl.split('/COMPENSATION_LETTERS/').pop();
        
        console.log('ğŸ—‘ï¸ Deleting file from storage:', fileName);
        
        const { error: storageError } = await supabaseClient
          .storage
          .from('COMPENSATION_LETTERS')
          .remove([fileName]);
        
        if (storageError) {
          console.error('âš ï¸ Storage deletion error:', storageError);
          // Continue even if storage deletion fails
        } else {
          console.log('âœ… File deleted from storage');
        }
      }
    }
    
    // STEP 3: Delete ALL wage_history records with this employee_id and effective_date
    console.log('ğŸ—‘ï¸ Deleting database records...');
    const { error: deleteError } = await supabaseClient
      .from('wage_history')
      .delete()
      .eq('employee_id', employeeId)
      .eq('effective_date', effectiveDate);
    
    if (deleteError) {
      console.error('âŒ Delete error:', deleteError);
      throw deleteError;
    }
    
    console.log('âœ… Database records deleted');
    
    showToast('âœ… Compensation letter deleted successfully (from database AND storage)', 'success');
    
    // STEP 4: Reload wage history to refresh the UI
    console.log('ğŸ”„ Refreshing wage history...');
    if (typeof loadWageHistory === 'function') {
      await loadWageHistory(employeeId);
      console.log('âœ… Wage history refreshed');
    } else {
      console.warn('âš ï¸ loadWageHistory function not found');
    }
    
  } catch (err) {
    console.error('âŒ Error deleting compensation letter:', err);
    console.error('Error stack:', err.stack);
    showToast('âŒ Failed to delete compensation letter: ' + err.message, 'error');
  }
}

// Make the function globally accessible
window.deleteCompensationLetter = deleteCompensationLetter;
console.log('âœ… deleteCompensationLetter function loaded');
// ============================================================================
// GROUP WAGE HISTORY BY COMPENSATION LETTER (DATE + EMPLOYEE)
// ============================================================================
// ============================================================================
// GROUP WAGE HISTORY BY COMPENSATION LETTER (DATE + EMPLOYEE)
// ============================================================================
function groupWageHistoryByLetter(wageRecords) {
  const grouped = {};
  
  wageRecords.forEach(record => {
    // Create unique key: employee_id + effective_date
    const key = `${record.employee_id}_${record.effective_date}`;
    
    if (!grouped[key]) {
      grouped[key] = {
        employeeId: record.employee_id,
        effectiveDate: record.effective_date,
        changeType: record.change_type,
        changeReason: record.change_reason,
        approvedBy: record.approved_by,
        employmentType: record.employment_type,
        hireDate: record.hire_date,
        isCurrent: record.is_current,
        letterGenerated: record.letter_generated,
        pdfUrl: record.pdf_url,
        positions: []
      };
    }
    
   // Add this position to the group
grouped[key].positions.push({
  positionNumber: record.position_number,
  positionTitle: record.position_title,
  department: record.department,
  hourlyRate: record.hourly_rate,
  training_pay: record.training_pay,
  meeting_pay: record.meeting_pay,
  vacation_pay: record.vacation_pay,
  overtime_pay: record.overtime_pay,
  recordId: record.id
});
  });
  
  // Convert to array and sort positions
  return Object.values(grouped).map(letter => {
    letter.positions.sort((a, b) => a.positionNumber - b.positionNumber);
    return letter;
  });
}



// ============================================================================
// TOGGLE LETTER EXPANSION
// ============================================================================
window.toggleLetterExpansion = function(letterIndex) {
  const positionsContainer = document.getElementById(`letter-positions-${letterIndex}`);
  const toggleIcon = document.getElementById(`toggle-icon-${letterIndex}`);
  
  if (positionsContainer.classList.contains('hidden')) {
    // EXPAND
    positionsContainer.classList.remove('hidden');
    toggleIcon.innerHTML = '<i class="fas fa-minus-circle text-blue-600"></i>';
  } else {
    // COLLAPSE
    positionsContainer.classList.add('hidden');
    toggleIcon.innerHTML = '<i class="fas fa-plus-circle text-blue-600"></i>';
  }
};








// RENDER GROUPED WAGE HISTORY
// ============================================================================
// ============================================================================
// RENDER GROUPED WAGE HISTORY
// ============================================================================
function renderWageHistory() {
  const container = document.getElementById('comp-letter-history-body');
  
  if (!container) {
    console.error('âŒ Wage history container not found!');
    return;
  }
  
  if (!CompensationState.wageHistory || CompensationState.wageHistory.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="8" class="px-6 py-12 text-center">
          <div class="flex flex-col items-center justify-center space-y-3">
            <i class="fas fa-inbox text-5xl text-gray-300"></i>
            <p class="text-gray-500 font-semibold">No wage history records found</p>
            <p class="text-gray-400 text-sm">Compensation letters will appear here after creation</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  const groupedLetters = groupWageHistoryByLetter(CompensationState.wageHistory);
  let html = '';
  
  groupedLetters.forEach((letter, letterIndex) => {
    const formattedDate = new Date(letter.effectiveDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    
    const changeTypeLabels = {
      'new_hire': 'New Hire',
      'promotion': 'Promotion',
      'merit_increase': 'Merit Increase',
      'position_change': 'Position Change',
      'cost_of_living': 'Cost of Living',
      'market_adjustment': 'Market Adjustment',
      'other': 'Other'
    };
    
    html += `
      <tr class="border-b-4 border-gray-200 bg-gray-50">
        <td colspan="8" class="px-0 py-0">
          <div class="bg-white rounded-lg shadow-sm border-2 border-gray-200 overflow-hidden m-2">
            
            <!-- COLLAPSIBLE HEADER -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b-2 border-indigo-200">
              <div class="flex items-center justify-between">
                
                <!-- LEFT: Toggle + Info -->
                <div class="flex items-center space-x-3">
                  <!-- TOGGLE BUTTON -->
                  <button type="button" 
                          onclick="toggleLetterExpansion(${letterIndex})"
                          id="toggle-icon-${letterIndex}"
                          class="text-2xl hover:scale-110 transition-transform">
                    <i class="fas fa-plus-circle text-blue-600"></i>
                  </button>
                  
                  <h3 class="text-base font-bold text-gray-900">
  ${changeTypeLabels[letter.changeType] || 'Compensation Letter'}
</h3>
<p class="text-sm text-gray-600">
  <i class="far fa-calendar-alt mr-1"></i>
  Effective: <span class="font-semibold">${formattedDate}</span>
  ${letter.isCurrent ? '<span class="ml-2 px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">CURRENT</span>' : ''}
</p>
<p class="text-xs text-gray-500 mt-1">
  <i class="far fa-clock mr-1"></i>
  Created: <span class="font-semibold">${new Date(letter.positions[0].createdAt || letter.effectiveDate).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'})}</span>
  <span class="mx-2">â€¢</span>
  <i class="fas fa-user-check mr-1"></i>
  Approved By: <span class="font-semibold">${letter.approvedBy || 'Pending'}</span>
</p>
                  </div>
                </div>
                
                <!-- RIGHT: Action Buttons -->
                <div class="flex items-center space-x-2">
                  
                  <!-- VIEW PDF BUTTON -->
                  ${letter.pdfUrl ? `
                  <button type="button" onclick="window.open('${letter.pdfUrl}', '_blank')"
                          class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-file-pdf"></i>
                    <span>View PDF</span>
                  </button>
                  ` : `
                  <button type="button" onclick="viewCompensationLetter(${letter.positions[0].recordId})"
                          class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-eye"></i>
                    <span>View PDF</span>
                  </button>
                  `}
                  
                  <!-- DELETE LETTER BUTTON -->
                  <button type="button" onclick="deleteAllPositions(${letter.employeeId}, '${letter.effectiveDate.replace(/'/g, "\\'")}')"
                          class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-trash-alt"></i>
                    <span>Delete</span>
                  </button>

                </div>
              </div>
            </div>
            
            <!-- COLLAPSIBLE POSITIONS TABLE (HIDDEN BY DEFAULT) -->
            <div id="letter-positions-${letterIndex}" class="hidden p-4 bg-gray-50">
              <h4 class="text-xs font-bold text-gray-700 uppercase mb-2 flex items-center">
                <i class="fas fa-briefcase text-amber-600 mr-2"></i>
                Positions (${letter.positions.length})
              </h4>
              
              <table class="w-full bg-white rounded-lg overflow-hidden shadow-sm">
                <thead>
                  <tr class="bg-gray-100 border-b-2 border-gray-200">
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Position</th>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Job Title</th>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Department</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Hourly Rate</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Training</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Meeting</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Vacation</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Overtime</th>
                  </tr>
                </thead>
                <tbody>



                 ${letter.positions.map(pos => `
  <tr class="border-b border-gray-100 hover:bg-blue-50 transition-colors">
    <td class="px-3 py-2">
      <span class="px-2 py-1 rounded-full text-xs font-bold ${
        pos.positionNumber === 1 ? 'bg-emerald-100 text-emerald-700' :
        pos.positionNumber === 2 ? 'bg-blue-100 text-blue-700' :
        'bg-purple-100 text-purple-700'
      }">
        POS ${pos.positionNumber}
      </span>
    </td>
    <td class="px-3 py-2 font-semibold text-gray-900">${pos.positionTitle}</td>
    <td class="px-3 py-2 text-gray-600">${pos.department}</td>
    <td class="px-3 py-2 text-right font-bold text-gray-900">$${parseFloat(pos.hourlyRate).toFixed(2)}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.training_pay ? '$' + parseFloat(pos.training_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.meeting_pay ? '$' + parseFloat(pos.meeting_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.vacation_pay ? '$' + parseFloat(pos.vacation_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600 font-bold">${letter.positions.length > 1 ? '<span class="text-purple-700">BLENDED</span>' : (pos.overtime_pay ? '$' + parseFloat(pos.overtime_pay).toFixed(2) : '--')}</td>
  </tr>
`).join('')}
                </tbody>
              </table>
              
              <!-- ADDITIONAL INFO -->
              ${letter.positions[0].notes ? `
              <div class="mt-3 p-3 bg-amber-50 border-l-4 border-amber-400 rounded">
                <p class="text-xs font-bold text-amber-900 mb-1">
                  <i class="fas fa-sticky-note mr-1"></i> NOTES:
                </p>
                <p class="text-sm text-amber-800">${letter.positions[0].notes}</p>
              </div>
              ` : ''}
            </div>
            
          </div>
        </td>
      </tr>
    `;
  });
  
  container.innerHTML = html;
  
  console.log('âœ… Wage history displayed with collapsible format');
}



// ============================================================================
// DELETE ALL POSITIONS (ENTIRE LETTER)
// ============================================================================
window.deleteAllPositions = async function(employeeId, effectiveDate) {
  if (!confirm('âš ï¸ Delete ENTIRE compensation letter?\n\nThis will delete ALL positions for this date.')) {
    return;
  }
  
  try {
    const { error } = await window.supabaseClient
      .from('wage_history')
      .delete()
      .eq('employee_id', employeeId)
      .eq('effective_date', effectiveDate);
    
    if (error) throw error;
    
    showToast('âœ… Compensation letter deleted', 'success');
    await loadWageHistory(employeeId);
    
  } catch (err) {
    console.error('Error deleting:', err);
    showToast('âŒ Failed to delete', 'error');
  }
};





// ============================================================================
// 5. DYNAMIC FORM BEHAVIOR - TIP POSITION DETECTION & OVERTIME CALC
// ============================================================================
function setupCompensationFormLogic() {
  console.log('ğŸ”¥ Setting up NEW compensation form logic');
  
  // Fields that should trigger recalculation
  const fieldsToWatch = [
    'comp-letter-hourly-rate',
    'comp-letter-position-title',
    'comp-letter-secondary-wage',
    'comp-letter-secondary-job-title',
    'comp-letter-tertiary-wage',
    'comp-letter-tertiary-job-title'
  ];
  
  fieldsToWatch.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (field) {
      // Remove old listeners (if any)
      field.removeEventListener('input', calculateAdditionalCompensation);
      field.removeEventListener('change', calculateAdditionalCompensation);
      
      // Add new listeners
      field.addEventListener('input', calculateAdditionalCompensation);
      field.addEventListener('change', calculateAdditionalCompensation);
      console.log('âœ… Added listeners to:', fieldId);
    }
  });
  
  // Enable/disable checkboxes
  const enableCheckboxes = [
    'secondary-job-enabled',
    'tertiary-job-enabled'
  ];
  
  enableCheckboxes.forEach(checkboxId => {
    const checkbox = document.getElementById(checkboxId);
    if (checkbox) {
      checkbox.removeEventListener('change', calculateAdditionalCompensation);
      checkbox.addEventListener('change', calculateAdditionalCompensation);
      console.log('âœ… Added listener to:', checkboxId);
    }
  });
  
  // Run initial calculation
  console.log('ğŸ”¥ Running initial calculation');
  calculateAdditionalCompensation();
}




  







  
  
  

// ============================================================================
// 6. PREVIEW COMPENSATION LETTER - FIXED TO OPEN IN NEW WINDOW
// ============================================================================
function previewCompensationLetter() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) {
    showToast('Please select an employee first', 'error');
    return;
  }

  // Collect all form data
  const formData = collectCompensationFormData();
  
  if (!formData) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  const letterHTML = generateCompensationLetterHTML(formData);
  
  // âœ… Open preview in new window instead of modal
  const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes');
  
  if (!previewWindow) {
    showToast('Please allow pop-ups to preview the letter', 'error');
    return;
  }
  
  previewWindow.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Compensation Letter Preview - ${employee.first_name} ${employee.last_name}</title>
        <style>
          body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Inter', Arial, sans-serif;
            background: #f8fafc;
          }
          .preview-header {
            background: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-bottom: 3px solid #7a1f1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          .preview-header h1 {
            margin: 0;
            font-size: 18px;
            color: #7a1f1f;
          }
          .preview-actions {
            display: flex;
            gap: 10px;
          }
          .btn {
            padding: 8px 16px;
            border: 2px solid #7a1f1f;
            background: white;
            color: #7a1f1f;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          }
          .btn:hover {
            background: #7a1f1f;
            color: white;
          }
          @media print {
            .preview-header { display: none; }
            body { padding: 0; background: white; }
          }
        </style>
      </head>
      <body>
        <div class="preview-header">
          <h1>ğŸ“„ Compensation Letter Preview</h1>
          <div class="preview-actions">
            <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            <button class="btn" onclick="window.close()">âœ–ï¸ Close</button>
          </div>
        </div>
        ${letterHTML}
      </body>
    </html>
  `);
  
  previewWindow.document.close();
  
  showToast('âœ… Preview opened in new window', 'success');
}

// ============================================================================
// VIEW COMPENSATION LETTER PDF (FROM SAVED RECORD)
// ============================================================================
async function viewCompensationLetter(recordId) {
  try {
    showToast('ğŸ“„ Generating compensation letter...', 'info');
    
    // Fetch the specific record
    const { data: record, error } = await window.supabaseClient
      .from('wage_history')
      .select('*')
      .eq('id', recordId)
      .single();
    
    if (error) throw error;
    
    // Fetch employee details
    const { data: employee, error: empError } = await window.supabaseClient
      .from('employees')
      .select('*')
      .eq('id', record.employee_id)
      .single();
    
    if (empError) throw empError;
    
    // Fetch all positions for this letter (same employee_id + effective_date)
    const { data: allPositions, error: posError } = await window.supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', record.employee_id)
      .eq('effective_date', record.effective_date)
      .order('position_number', { ascending: true });
    
    if (posError) throw posError;
    
    // Calculate years of service for PTO
    const hireDate = new Date(employee.original_hire_date || employee.hire_date);
    const effectiveDate = new Date(record.effective_date);
    const yearsOfService = (effectiveDate - hireDate) / (1000 * 60 * 60 * 24 * 365.25);
    const is60DaysPassed = (effectiveDate - hireDate) / (1000 * 60 * 60 * 24) >= 60;
    const isFullTime = record.employment_type === 'full_time';
    
    // Determine PTO hours
    let ptoHours = '--';
    if (isFullTime && is60DaysPassed) {
      if (yearsOfService < 4) {
        ptoHours = '<strong style="color: #000; font-weight: 700;">8 mo - 4 years up to 40 hours</strong>';
      } else {
        ptoHours = '<strong style="color: #000; font-weight: 700;">4 years or more up to 48 hours</strong>';
      }
    }
    
    // Build positions table
    let positionsTableRows = '';
    allPositions.forEach((pos, index) => {
      const posLabel = index === 0 ? 'Primary' : index === 1 ? 'Secondary' : 'Tertiary';
      const posColor = index === 0 ? '#10b981' : index === 1 ? '#3b82f6' : '#a855f7';
      
      positionsTableRows += `
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd; background: ${posColor}22; color: ${posColor}; font-weight: 700; font-size: 13px;">${posLabel}</td>
          <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600; font-size: 14px;">${pos.position_title}</td>
          <td style="padding: 10px; border: 1px solid #ddd; font-size: 14px;">${pos.department}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 700; font-size: 14px;">$${parseFloat(pos.hourly_rate).toFixed(2)}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.training_pay ? '$' + parseFloat(pos.training_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.meeting_pay ? '$' + parseFloat(pos.meeting_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.vacation_pay ? '$' + parseFloat(pos.vacation_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.overtime_pay ? '$' + parseFloat(pos.overtime_pay).toFixed(2) : '--'}</td>
        </tr>
      `;
    });
    
    // Determine manager based on primary position
    const primaryPosition = allPositions[0].position_title.toLowerCase();
    let managerName = 'Management';
    if (primaryPosition.includes('server') || primaryPosition.includes('busser') || primaryPosition.includes('host')) {
      managerName = 'Iris Ying (FOH Manager)';
    } else if (primaryPosition.includes('cook') || primaryPosition.includes('prep') || primaryPosition.includes('dishwasher')) {
      managerName = 'Peiqin Lin (BOH Manager)';
    }
    
    const formattedEffectiveDate = new Date(record.effective_date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    const formattedCreatedDate = new Date(record.created_at || record.effective_date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Generate PDF HTML
    const pdfHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          @page {
            size: letter;
            margin: 0.5in 0.75in 0.75in 0.75in;
          }
          
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: 'Arial', sans-serif;
            font-size: 13px;
            line-height: 1.4;
            color: #1f2937;
          }
          
          .header {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1e40af;
          }
          
          .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 4px;
          }
          
          .header p {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
          }
          
          .section {
            margin-bottom: 14px;
          }
          
          .section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #bfdbfe;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
          }
          
          th {
            background: #1e40af;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
          }
          
          td {
            padding: 8px;
            border: 1px solid #e2e8f0;
          }
          
          .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
          }
          
          .info-item {
            font-size: 12px;
          }
          
          .info-label {
            font-weight: 700;
            color: #475569;
          }
          
          .info-value {
            color: #1f2937;
            font-weight: 600;
          }
          
          .benefits-table {
            margin-top: 8px;
            font-size: 12px;
          }
          
          .benefits-table td {
            padding: 8px;
          }
          
          .benefits-table th {
            font-size: 11px;
          }
          
          .signature-section {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
          }
          
          .signature-box {
            text-align: center;
          }
          
          .signature-line {
            border-top: 2px solid #000;
            margin-bottom: 4px;
            padding-top: 4px;
          }
          
          .signature-label {
            font-size: 11px;
            font-weight: 700;
            color: #000;
          }
          
          .disclaimer {
            margin-top: 20px;
            padding: 10px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            font-size: 10px;
            line-height: 1.5;
            font-weight: 700;
            color: #000;
          }
          
          .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            color: #64748b;
            padding: 8px;
            border-top: 1px solid #e2e8f0;
            background: white;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>JENG CHI RESTAURANT</h1>
          <p>2550 N. Belt Line Rd., Irving, TX 75062 â€¢ (469) 941-6677</p>
          <p style="margin-top: 8px; font-size: 13px; font-weight: 700; color: #1e40af;">COMPENSATION & BENEFITS LETTER</p>
        </div>
        
        <div class="section">
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Employee:</span>
              <span class="info-value">${employee.first_name} ${employee.last_name}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Employee ID:</span>
              <span class="info-value">${employee.employee_id}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Payroll Effective Date:</span>
              <span class="info-value">${formattedEffectiveDate}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Letter Created:</span>
              <span class="info-value">${formattedCreatedDate}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Employment Type:</span>
              <span class="info-value">${record.employment_type === 'full_time' ? 'Full Time' : 'Part Time'}</span>
            </div>


            <div class="info-item">
              <span class="info-label">Hire Date:</span>
              <span class="info-value">${new Date(employee.original_hire_date || employee.hire_date).toLocaleDateString('en-US')}</span>
            </div>
            <div class="info-item">
              <span class="info-label">PTO Eligibility:</span>
              <span class="info-value" style="font-weight: 700; color: ${isFullTime && is60DaysPassed ? (yearsOfService < 4 ? '#1e40af' : '#166534') : '#64748b'};">
                ${isFullTime && is60DaysPassed 
                  ? (yearsOfService < 4 
                    ? 'âœ“ Max 40 hours/year' 
                    : 'âœ“ Max 48 hours/year')
                  : 'Not Eligible'}
              </span>
            </div>
          </div>
        </div>


           


        
        <div class="section">
          <div class="section-title">ğŸ’¼ Position(s) & Compensation</div>
          <table>
            <thead>
              <tr>
                <th>POSITION</th>
                <th>JOB TITLE</th>
                <th>DEPARTMENT</th>
                <th style="text-align: right;">HOURLY</th>
                <th style="text-align: right;">TRAINING</th>
                <th style="text-align: right;">MEETING</th>
                <th style="text-align: right;">VACATION</th>
                <th style="text-align: right;">OVERTIME</th>
              </tr>
            </thead>
            <tbody>
              ${positionsTableRows}
            </tbody>
          </table>
        </div>
        





          <<div class="section">
          <div class="section-title" style="text-align: center; background: #fbbf24; color: #78350f; padding: 10px; border-radius: 6px; margin-bottom: 14px; font-size: 14px; font-weight: 700; text-transform: uppercase;">
            ğŸ BENEFITS FOR QUALIFIED FULL TIME EMPLOYEES
          </div>
          
          <table style="width: 100%; border-collapse: collapse; margin-bottom: 14px;">
            <tr>
              <td style="width: 50%; vertical-align: top; padding-right: 8px;">
                <!-- LEFT COLUMN: HEALTH BENEFITS -->
                <div style="background: #eff6ff; padding: 14px; border-radius: 8px; border: 2px solid #3b82f6;">
                  <h3 style="color: #1e40af; font-size: 13px; font-weight: 700; margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">
                    <i class="fas fa-heart-pulse" style="color: #ef4444;"></i> Health Benefits
                  </h3>
                  
                  <table style="width: 100%; font-size: 10px; border-collapse: collapse;">
                    <tbody>
                      <!-- HEALTH INSURANCE -->
                      <tr>
                        <td colspan="2" style="padding: 6px 0; font-weight: 700; color: #1e40af; border-bottom: 2px solid #3b82f6;">
                          <i class="fas fa-hospital" style="color: #ef4444; margin-right: 6px;"></i>Health Insurance
                        </td>
                      </tr>
                      <tr>
                        <td style="padding: 4px 0 4px 12px; font-size: 9px; color: #64748b;">All tiers (EO, ES, EC, EF)</td>
                        <td style="padding: 4px 0; text-align: right; font-weight: 600; font-size: 9px;">50% ER / 50% EE</td>
                      </tr>
                      
                      <!-- DENTAL INSURANCE -->
                      <tr>
                        <td colspan="2" style="padding: 8px 0 4px 0; font-weight: 700; color: #1e40af; border-bottom: 2px solid #3b82f6;">
                          <i class="fas fa-tooth" style="color: #3b82f6; margin-right: 6px;"></i>Dental Insurance
                        </td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #16a34a; font-weight: 600;">Basic - Employee Only (EO)</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 700; font-size: 9px; color: #16a34a;">ER Paid</td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #64748b;">Basic - ES, EC, EF</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 600; font-size: 9px;">50% ER / 50% EE</td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #64748b;">Premium - All tiers</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 600; font-size: 9px;">50% ER / 50% EE</td>
                      </tr>
                      
                      <!-- VISION INSURANCE -->
                      <tr>
                        <td colspan="2" style="padding: 8px 0 4px 0; font-weight: 700; color: #1e40af; border-bottom: 2px solid #3b82f6;">
                          <i class="fas fa-eye" style="color: #8b5cf6; margin-right: 6px;"></i>Vision Insurance
                        </td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #16a34a; font-weight: 600;">Basic - Employee Only (EO)</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 700; font-size: 9px; color: #16a34a;">ER Paid</td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #64748b;">Basic - ES, EC, EF</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 600; font-size: 9px;">50% ER / 50% EE</td>
                      </tr>
                      
                      <!-- LIFE INSURANCE -->
                      <tr>
                        <td colspan="2" style="padding: 8px 0 4px 0; font-weight: 700; color: #1e40af; border-bottom: 2px solid #3b82f6;">
                          <i class="fas fa-shield-heart" style="color: #10b981; margin-right: 6px;"></i>Life Insurance
                        </td>
                      </tr>
                      <tr>
                        <td style="padding: 3px 0 3px 12px; font-size: 9px; color: #16a34a; font-weight: 600;">$25,000 term policy</td>
                        <td style="padding: 3px 0; text-align: right; font-weight: 700; font-size: 9px; color: #16a34a;">ER Paid</td>
                      </tr>
                    </tbody>
                  </table>
                  
                  <p style="margin-top: 10px; font-size: 9px; color: #64748b; font-style: italic; text-align: center; padding: 6px; background: white; border-radius: 4px;">
                    <i class="fas fa-info-circle"></i> <strong>Coverage Tiers:</strong> EO=Employee Only, ES=Employee+Spouse, EC=Employee+Children, EF=Employee+Family
                  </p>
                </div>
              </td>
              
              <td style="width: 50%; vertical-align: top; padding-left: 8px;">



                <!-- RIGHT COLUMN: PTO POLICY -->
               <!-- RIGHT COLUMN: PTO POLICY -->
              <div style="background: #fef3c7; padding: 14px; border-radius: 8px; border: 2px solid #f59e0b;">
                <h3 style="color: #92400e; font-size: 13px; font-weight: 700; margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">
                  <i class="fas fa-umbrella-beach" style="color: #f59e0b;"></i> Paid Time Off (PTO)
                </h3>
                
                <!-- 2-COLUMN GRID -->
                <table style="width: 100%; border-collapse: collapse; margin-bottom: 8px;">
                  <tr>
                    <!-- ELIGIBILITY (Left) -->
                    <td style="width: 50%; vertical-align: top; padding-right: 4px;">
                      <div style="background: white; padding: 6px; border-radius: 6px; border-left: 4px solid #10b981;">
                        <p style="font-size: 9px; font-weight: 700; color: #047857; margin: 0;">
                          <i class="fas fa-check-circle" style="color: #10b981;"></i> ELIGIBILITY:
                        </p>
                        <p style="font-size: 8px; color: #065f46; margin: 3px 0 0 0; line-height: 1.4;">
                          Full-time employees after <strong>60 days</strong> from hire date
                        </p>
                      </div>
                    </td>
                    
                    <!-- ANNUAL ACCRUAL (Right) -->
                    <td style="width: 50%; vertical-align: top; padding-left: 4px;">
                      <div style="background: white; padding: 6px; border-radius: 6px; border-left: 4px solid #3b82f6;">
                        <p style="font-size: 9px; font-weight: 700; color: #1e40af; margin: 0;">
                          <i class="fas fa-calendar-days" style="color: #3b82f6;"></i> ANNUAL ACCRUAL:
                        </p>
                        <table style="width: 100%; font-size: 8px; margin-top: 3px;">
                          <tr>
                            <td style="color: #1e40af; padding: 1px 0;"><strong>8 months - 4 years:</strong></td>
                            <td style="text-align: right; color: #1e40af; font-weight: 700;">40 hrs/yr</td>
                          </tr>
                          <tr>
                            <td style="color: #1e40af; padding: 1px 0;"><strong>4+ years tenure:</strong></td>
                            <td style="text-align: right; color: #1e40af; font-weight: 700;">48 hrs/yr</td>
                          </tr>
                        </table>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- HOW IT WORKS: ACCRUAL TIMELINE (Full width span) -->
                  <tr>
                    <td colspan="2" style="padding-top: 8px;">
                      <div style="background: white; padding: 8px; border-radius: 6px; border-left: 4px solid #8b5cf6;">
                        <p style="font-size: 9px; font-weight: 700; color: #6b21a8; margin: 0;">
                          <i class="fas fa-hourglass-half" style="color: #8b5cf6;"></i> HOW IT WORKS: ACCRUAL TIMELINE
                        </p>
                        <ul style="font-size: 8px; color: #6b21a8; margin: 4px 0 0 12px; padding: 0; line-height: 1.5;">
                          <li><strong>Days 1-60:</strong> No PTO accrual (waiting period)</li>
                          <li><strong>After 60 days:</strong> PTO begins accruing based on hours worked</li>
                          <li><strong>Accrual year:</strong> January 1 - December 31</li>
                          <li><strong>When to use:</strong> PTO earned in current year becomes available the following year</li>
                        </ul>
                      </div>
                    </td>
                  </tr>
                  
                  <tr>
                    <!-- EXAMPLE: Hired Jan-Sep (Left) -->
                    <td style="width: 50%; vertical-align: top; padding-right: 4px; padding-top: 8px;">
                      <div style="background: #dbeafe; padding: 6px; border-radius: 6px; border: 2px solid #3b82f6;">
                        <p style="font-size: 9px; font-weight: 700; color: #1e40af; margin: 0;">
                          <i class="fas fa-calendar-check" style="color: #3b82f6;"></i> HIRED JAN-SEP:
                        </p>
                        <p style="font-size: 8px; color: #1e40af; margin: 3px 0 0 0; line-height: 1.4;">
                          âœ“ Earn in <strong>current year</strong><br>
                          âœ“ Use in <strong>next year</strong>
                        </p>
                      </div>
                    </td>
                    
                    <!-- EXAMPLE: Hired Oct+ (Right) -->
                    <td style="width: 50%; vertical-align: top; padding-left: 4px; padding-top: 8px;">
                      <div style="background: #fef3c7; padding: 6px; border-radius: 6px; border: 2px solid #f59e0b;">
                        <p style="font-size: 9px; font-weight: 700; color: #92400e; margin: 0;">
                          <i class="fas fa-calendar-plus" style="color: #f59e0b;"></i> HIRED OCT+:
                        </p>
                        <p style="font-size: 8px; color: #92400e; margin: 3px 0 0 0; line-height: 1.4;">
                          âœ“ Accrual starts <strong>following year</strong><br>
                          âœ“ Use <strong>year after next</strong>
                        </p>
                      </div>
                    </td>
                  </tr>
                  
                  <!-- PAYOUT (Full width span) -->
                  <tr>
                    <td colspan="2" style="padding-top: 8px;">
                      <div style="background: #fff7ed; padding: 8px; border-radius: 6px; border: 2px solid #f97316;">
                        <p style="font-size: 9px; font-weight: 700; color: #c2410c; margin: 0;">
                          <i class="fas fa-money-bill-wave" style="color: #f97316;"></i> UNUSED PTO PAYOUT:
                        </p>
                        <p style="font-size: 8px; color: #9a3412; margin: 3px 0 0 0; line-height: 1.5;">
                          Any unused PTO hours remaining at year-end will be <strong>paid out</strong> in your final December paycheck. PTO does <strong>not</strong> roll over to the following year.
                        </p>
                      </div>
                    </td>
                  </tr>
                </table>
                
                <p style="font-size: 7px; color: #64748b; margin: 0; font-style: italic; text-align: center;">
                  <i class="fas fa-book"></i> See employee handbook for complete PTO policy details
                </p>
              </div>





            
            <!-- RIGHT COLUMN: PTO POLICY -->
            <div style="background: #fef3c7; padding: 14px; border-radius: 8px; border: 2px solid #f59e0b;">
              <h3 style="color: #92400e; font-size: 13px; font-weight: 700; margin-bottom: 10px; text-align: center; text-transform: uppercase; letter-spacing: 0.5px;">
                <i class="fas fa-umbrella-beach" style="color: #f59e0b;"></i> Paid Time Off (PTO)
              </h3>
              
              <!-- PTO ELIGIBILITY -->
              <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #f59e0b;">
                <p style="font-size: 11px; font-weight: 700; color: #92400e; margin: 0;">
                  <i class="fas fa-check-circle" style="color: #10b981;"></i> ELIGIBILITY:
                </p>
                <p style="font-size: 10px; color: #78350f; margin: 4px 0 0 0; line-height: 1.4;">
                  Full-time employees after <strong>60 days</strong> from hire date
                </p>
              </div>
              
              <!-- PTO ACCRUAL RATES -->
              <div style="background: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; border-left: 4px solid #f59e0b;">
                <p style="font-size: 11px; font-weight: 700; color: #92400e; margin: 0;">
                  <i class="fas fa-calendar-days" style="color: #3b82f6;"></i> ANNUAL ACCRUAL:
                </p>
                <table style="width: 100%; font-size: 10px; margin-top: 4px;">
                  <tr>
                    <td style="color: #78350f; padding: 2px 0;"><strong>8 months - 4 years:</strong></td>
                    <td style="text-align: right; color: #78350f; font-weight: 700;">40 hours/year</td>
                  </tr>
                  <tr>
                    <td style="color: #78350f; padding: 2px 0;"><strong>4+ years tenure:</strong></td>
                    <td style="text-align: right; color: #78350f; font-weight: 700;">48 hours/year</td>
                  </tr>
                </table>
              </div>
              
              <!-- HOW IT WORKS -->
              <div style="background: white; padding: 8px; border-radius: 6px; border-left: 4px solid #f59e0b;">
                <p style="font-size: 11px; font-weight: 700; color: #92400e; margin: 0;">
                  <i class="fas fa-hourglass-half" style="color: #8b5cf6;"></i> HOW IT WORKS:
                </p>
                <ul style="font-size: 10px; color: #78350f; margin: 4px 0 0 12px; padding: 0; line-height: 1.5;">
                  <li>PTO <strong>accrues</strong> based on hours worked in current year</li>
                  <li>Accrued PTO is <strong>available for use</strong> in the following year</li>
                  <li><strong>Example:</strong> Work in 2025 â†’ Use PTO in 2026</li>
                  <li style="margin-top: 4px; color: #dc2626; font-weight: 600;">
                    <i class="fas fa-exclamation-triangle"></i> <strong>October+ hires:</strong> PTO accrues after 60 days, available year after next
                  </li>
                </ul>
              </div>
            </div>
            
          </div>
          
          <!-- BOTTOM DISCLAIMER -->
          <p style="margin-top: 12px; font-size: 10px; color: #64748b; text-align: center; font-style: italic; padding: 8px; background: #f1f5f9; border-radius: 4px;">
            <i class="fas fa-book"></i> See employee handbook and benefits guide for complete details
          </p>
        </div>




        
        <div class="signature-section">
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">EMPLOYEE SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">${employee.first_name} ${employee.last_name}</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">MANAGER SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">${managerName}</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">OWNER SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">Pablo Chang</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
        </div>
        
        <div class="disclaimer">
          <strong>DISCLAIMER:</strong> This letter outlines your current compensation and benefits. All benefits are subject to plan terms and eligibility requirements. Employment is at-will and can be terminated by either party at any time. This letter does not constitute an employment contract. Benefits may change based on company policy updates.
        </div>
        
        <div class="footer">
          Jeng Chi Restaurant â€¢ Confidential Compensation Letter â€¢ Generated ${new Date().toLocaleDateString('en-US')}
        </div>
      </body>
      </html>
    `;
    
    // Create temporary container
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = pdfHtml;
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    document.body.appendChild(tempContainer);
    
    // Generate PDF
    const opt = {
      margin: [0.5, 0.75, 0.75, 0.75],
      filename: `Compensation_Letter_${employee.last_name}_${employee.first_name}_${record.effective_date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    await html2pdf().set(opt).from(tempContainer).save();
    
    // Cleanup
    document.body.removeChild(tempContainer);
    
    showToast('âœ… PDF generated successfully!', 'success');
    
  } catch (error) {
    console.error('âŒ Error generating PDF:', error);
    showToast('âŒ Failed to generate PDF', 'error');
  }
}











// ============================================================================
// 7. COLLECT FORM DATA
// ============================================================================
function collectCompensationFormData() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) return null;
  
  // OTHER REQUIRED FIELDS
  const effectiveDate = document.getElementById('comp-letter-effective-date')?.value;
  const changeType = document.getElementById('comp-letter-change-type')?.value;
  const employmentType = document.getElementById('comp-letter-employment-type')?.value;
  const hireDate = document.getElementById('comp-letter-hire-date')?.value;
  const changeReason = document.getElementById('comp-letter-change-reason')?.value || '';
  const approvedBy = document.getElementById('comp-letter-approved-by')?.value || 'Management';
  
  // ADDITIONAL COMPENSATION (shared across positions)
  const trainingPay = parseFloat(document.getElementById('comp-letter-training-pay')?.value) || 0;
  const meetingPay = parseFloat(document.getElementById('comp-letter-meeting-pay')?.value) || 0;
  const vacationPay = parseFloat(document.getElementById('comp-letter-vacation-pay')?.value) || 0;
  
  // ============================================================================
  // COLLECT POSITIONS (ONLY IF ENABLED)
  // ============================================================================
  const positions = [];
  
  // PRIMARY JOB (Required - always enabled)
  const primaryJobTitle = document.getElementById('primary-job-title')?.value;
  const primaryDepartment = document.getElementById('primary-department')?.value;
  const primaryWage = parseFloat(document.getElementById('primary-wage')?.value);
  
  if (!primaryJobTitle || !primaryDepartment || !primaryWage) {
    showToast('âš ï¸ Primary position is required', 'error');
    return null;
  }
  
  positions.push({
    position_number: 1,
    position_title: primaryJobTitle,
    department: primaryDepartment,
    hourly_rate: primaryWage
  });
  
  // SECONDARY JOB (Optional - check if enabled)
  const secondaryEnabled = document.getElementById('secondary-job-enabled')?.checked;
  if (secondaryEnabled) {
    const secondaryJobTitle = document.getElementById('secondary-job-title')?.value;
    const secondaryDepartment = document.getElementById('secondary-department')?.value;
    const secondaryWage = parseFloat(document.getElementById('secondary-wage')?.value);
    
    if (secondaryJobTitle && secondaryDepartment && secondaryWage) {
      positions.push({
        position_number: 2,
        position_title: secondaryJobTitle,
        department: secondaryDepartment,
        hourly_rate: secondaryWage
      });
    }
  }
  
  // TERTIARY JOB (Optional - check if enabled)
  const tertiaryEnabled = document.getElementById('tertiary-job-enabled')?.checked;
  if (tertiaryEnabled) {
    const tertiaryJobTitle = document.getElementById('tertiary-job-title')?.value;
    const tertiaryDepartment = document.getElementById('tertiary-department')?.value;
    const tertiaryWage = parseFloat(document.getElementById('tertiary-wage')?.value);
    
    if (tertiaryJobTitle && tertiaryDepartment && tertiaryWage) {
      positions.push({
        position_number: 3,
        position_title: tertiaryJobTitle,
        department: tertiaryDepartment,
        hourly_rate: tertiaryWage
      });
    }
  }
  
  // Validate required fields
  if (!effectiveDate || !changeType || !employmentType || !hireDate) {
    showToast('âš ï¸ Please fill in all required fields', 'error');
    return null;
  }
  
  // ============================================================================
  // CALCULATE OVERTIME (BLENDED IF MULTIPLE POSITIONS)
  // ============================================================================
 // CALCULATE OVERTIME (BLENDED IF MULTIPLE POSITIONS)
let overtimePay;
if (positions.length === 1) {
  // Single position: 1.5x hourly rate
  overtimePay = positions[0].hourly_rate * 1.5;
} else {
  // Multiple positions: BLENDED (average Ã— 1.5)
  const avgWage = positions.reduce((sum, pos) => sum + pos.hourly_rate, 0) / positions.length;
  overtimePay = avgWage * 1.5;
}
  
  // ============================================================================
  // TIP CONFIGURATION (YOUR EXISTING LOGIC)
  // ============================================================================
  
  // Check ALL positions for server
  const allPositions = positions.map(p => p.position_title.toLowerCase());
  const isServer = allPositions.some(pos => pos.includes('server'));
  
  // Check if ANY position is in tip pool
  const isTipPosition = allPositions.some(pos => 
    ['busser', 'cashier', 'host', 'hostess', 'bartender'].some(tp => pos.includes(tp))
  );
  
  const includedInTipPool = isTipPosition && !isServer ? true : false;
  
  // TIP PERCENTAGES - Use default values
  let tipToHouse = 4.00;  // Default 4%
  let merchantServices = 3.00;  // Default 3%
  
  // Try to read from form fields if they exist
  const tipToHouseInput = document.getElementById('comp-letter-tip-to-house');
  const merchantServicesInput = document.getElementById('comp-letter-merchant-services');
  
  if (tipToHouseInput && tipToHouseInput.value) {
    tipToHouse = parseFloat(tipToHouseInput.value);
  }
  
  if (merchantServicesInput && merchantServicesInput.value) {
    merchantServices = parseFloat(merchantServicesInput.value);
  }
  
  // If ANY position is server, ensure default values are set
  if (isServer) {
    if (!tipToHouseInput || !tipToHouseInput.value) {
      tipToHouse = 4.00;
    }
    if (!merchantServicesInput || !merchantServicesInput.value) {
      merchantServices = 3.00;
    }
  }
  
  // ============================================================================
  // ADD SHARED FIELDS TO EACH POSITION
  // ============================================================================
  positions.forEach(pos => {
    pos.employee_id = employee.id;
    pos.effective_date = effectiveDate;
    pos.employment_type = employmentType;
    pos.change_type = changeType;
    pos.change_reason = changeReason;
    pos.approved_by = approvedBy;
    pos.training_pay = trainingPay || pos.hourly_rate;
    pos.meeting_pay = meetingPay || pos.hourly_rate;
    pos.vacation_pay = vacationPay;
    pos.overtime_pay = overtimePay;
    pos.hire_date = hireDate;
    pos.is_current = true;
    pos.letter_generated = false;
  });
  
  // ============================================================================
  // RETURN DATA (for compatibility with existing code)
  // ============================================================================
  return {
    employee,
    positions: positions, // âœ… NEW: Array of positions
    // Primary job (for backward compatibility)
    position: positions[0].position_title,
    department: positions[0].department,
    hourlyRate: positions[0].hourly_rate,
    // Secondary job (for backward compatibility)
    secondaryJobTitle: positions[1]?.position_title || '',
    secondaryDepartment: positions[1]?.department || '',
    secondaryWage: positions[1]?.hourly_rate || 0,
    // Tertiary job (for backward compatibility)
    tertiaryJobTitle: positions[2]?.position_title || '',
    tertiaryDepartment: positions[2]?.department || '',
    tertiaryWage: positions[2]?.hourly_rate || 0,
    // Additional compensation
    trainingPay,
    meetingPay,
    vacationPay,
    overtimePay,
    // Dates and metadata
    effectiveDate,
    changeType,
    changeReason,
    approvedBy,
    employmentType,
    hireDate,
    positionSlot: '1', // Keep for compatibility
    // Tip info
    isTipPosition,
    isServer,
    includedInTipPool,
    tipToHouse,
    merchantServices
  };
}


// ============================================================================
// 8. GENERATE COMPREHENSIVE PDF WITH FULL BENEFITS PACKAGE
// ============================================================================
// ============================================================================
// 8. âœ… FINAL: GENERATE COMPREHENSIVE COMPENSATION LETTER PDF
// ============================================================================
// ============================================================================
// âœ… FINAL: COMPENSATION LETTER â€” ONE-PAGE OPTIMIZED VERSION
// ============================================================================
function generateCompensationLetterHTML(data) {
  const {
    employee,
    position,
    department,
    hourlyRate,
    secondaryJobTitle,
    secondaryDepartment,
    secondaryWage,
    tertiaryJobTitle,
    tertiaryDepartment,
    tertiaryWage,
    trainingPay,
    meetingPay,
    vacationPay,
    overtimePay,
    effectiveDate,
    changeType,
    changeReason,
    approvedBy,
    employmentType,
    hireDate,
    isTipPosition,
    isServer,
    includedInTipPool,
    tipToHouse,
    merchantServices
  } = data;

  function getPositionEmoji(title) {
    if (!title) return 'ğŸ‘¤';
    const t = title.toLowerCase();
    if (t.includes('server')) return 'ğŸ½ï¸';
    if (t.includes('dishwasher') || t.includes('steward')) return 'ğŸ§¼';
    if (t.includes('busser') || t.includes('bus boy')) return 'ğŸ§¹';
    if (t.includes('bartender') || t.includes('bar')) return 'ğŸ¸';
    if (t.includes('cashier')) return 'ğŸ’°';
    if (t.includes('host') || t.includes('hostess')) return 'ğŸ‘‹';
    if (t.includes('cook') || t.includes('chef') || t.includes('wok') || t.includes('line')) return 'ğŸ‘¨â€ğŸ³';
    if (t.includes('prep') || t.includes('preparation')) return 'ğŸ”ª';
    if (t.includes('pastry')) return 'ğŸ°';
    if (t.includes('production manager')) return 'ğŸ“¦';
    if (t.includes('logistic') || t.includes('coordinator')) return 'ğŸšš';
    if (t.includes('manager') && !t.includes('production')) return 'ğŸ‘”';
    if (t.includes('cleaning') || t.includes('janitor')) return 'ğŸ§½';
    if (t.includes('delivery') || t.includes('driver')) return 'ğŸš—';
    if (t.includes('expeditor')) return 'ğŸ“‹';
    return 'ğŸ‘¤';
  }

  function isTipEligible(title) {
    if (!title) return false;
    const t = title.toLowerCase();
    return ['server', 'bartender', 'busser', 'cashier', 'host', 'hostess'].some(keyword => t.includes(keyword));
  }

  // Calculate years of service for PTO
  const hireDateTime = new Date(hireDate);
  const today = new Date();
  const yearsOfService = (today - hireDateTime) / (1000 * 60 * 60 * 24 * 365.25);
  const ptoHours = yearsOfService >= 4 ? 48 : 40;

  const formattedEffectiveDate = new Date(effectiveDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const formattedHireDate = new Date(hireDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const todaysDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const isFullTime = employmentType === 'full_time';
  const hasSecondary = secondaryJobTitle && parseFloat(secondaryWage) > 0;
  const hasTertiary = tertiaryJobTitle && parseFloat(tertiaryWage) > 0;
  const positionCount = 1 + (hasSecondary ? 1 : 0) + (hasTertiary ? 1 : 0);
  
  // SPECIAL RULES FOR SERVER AND BARTENDER
  const isPrimaryServer = position.toLowerCase().includes('server');
  const isPrimaryBartender = position.toLowerCase().includes('bartender');
  
  let displayTrainingPay = trainingPay;
  let displayMeetingPay = meetingPay;
  let displayVacationPay = vacationPay;
  let displayOvertimePay = overtimePay;
  
  // âœ… COMPENSATION TYPE & SALARY LOGIC â€” MUST BE BEFORE overtimeDisplay
const compensationType = employee.compensation_type || 'hourly';
const isHourly = compensationType === 'hourly';

// Detect exempt salaried roles that get NO overtime
const isOvertimeExempt = ['production manager', 'logistic coordinator']
  .some(title => position?.toLowerCase().includes(title));

// For salaried non-exempt: show equivalent hourly rate for OT (not 1.5Ã—)
const annualSalary = employee.annual_salary ? parseFloat(employee.annual_salary) : 0;
const equivalentHourly = annualSalary ? (annualSalary / 2080).toFixed(2) : '0.00';
  
  
  
  let overtimeDisplay;
  if (!isHourly) {
    // SALARIED
    if (isOvertimeExempt) {
      overtimeDisplay = 'N/A';
    } else if (positionCount > 1) {
      overtimeDisplay = 'BLENDED';
    } else {
      overtimeDisplay = `$${equivalentHourly}/hr`;
    }
  } else {
    // HOURLY â€” keep existing behavior
    overtimeDisplay = positionCount > 1 ? 'BLENDED' : `$${parseFloat(overtimePay).toFixed(2)}/hr`;
  }
  
  // SERVER RULES
  if (isPrimaryServer) {
    displayTrainingPay = '7.25';
    displayMeetingPay = '7.25';
    displayVacationPay = '10.88';
    if (positionCount === 1) {
      // Server only - single position
      displayOvertimePay = '6.13';
      overtimeDisplay = '$6.13/hr';
    } else {
      // Server with multiple positions
      overtimeDisplay = 'BLENDED';
    }
  }
  
  // BARTENDER RULES
  if (isPrimaryBartender) {
    displayTrainingPay = '7.25';
    displayMeetingPay = '7.25';
    displayVacationPay = '10.88';
    displayOvertimePay = '10.88';
    overtimeDisplay = positionCount > 1 ? 'BLENDED' : '$10.88/hr';
  }

  const allPositions = [position, secondaryJobTitle, tertiaryJobTitle].filter(Boolean);
  const hasTipPosition = allPositions.some(pos => isTipEligible(pos));
  const isServerPosition = allPositions.some(pos => pos.toLowerCase().includes('server'));
  const isTipPoolPosition = allPositions.some(pos =>
    ['busser', 'cashier', 'host', 'hostess', 'bartender'].some(tp => pos.toLowerCase().includes(tp))
  );










  const changeTypeLabels = {
    'new_hire': 'New Employment',
    'promotion': 'Promotion',
    'merit_increase': 'Merit Increase',
    'position_change': 'Position Change',
    'cost_of_living': 'Cost of Living Adjustment',
    'market_adjustment': 'Market Adjustment',
    'other': 'Compensation Adjustment'
  };

  return `
    <div style="
      font-family: 'Inter', Arial, sans-serif;
      max-width: 850px;
      margin: 0 auto;
      padding: 6px;
      background: white;
      color: #000000;
      font-size: 12px;
      line-height: 1.25;
    ">

      <style>
        :root {
          --font-xs: 9px;
          --font-sm: 10px;
          --font-base: 12px;
          --font-md: 12px;
          --font-lg: 13px;
          --font-xl: 15px;
          --font-2xl: 17px;
          --font-3xl: 19px;
        }
        
        @media print {
          body { margin: 0; padding: 0; }
          * { 
            -webkit-print-color-adjust: exact !important; 
            print-color-adjust: exact !important;
            page-break-before: avoid !important;
            page-break-after: avoid !important;
            page-break-inside: avoid !important;
          }
        }
        
        @page {
          size: Letter;
          margin: 0.4in;
        }
      </style>

      <!-- HEADER -->
      <div style="text-align: center; margin-bottom: 4px; border-bottom: 2px solid #333333; padding-bottom: 3px;">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi Restaurant"
             style="height: 40px; margin-bottom: 2px;" />
        <h1 style="color: #000000; margin: 2px 0; font-size: var(--font-3xl); font-weight: 700; letter-spacing: 0.5px; text-transform: uppercase;">
          EMPLOYEE COMPENSATION PLAN
        </h1>
        <p style="color: #333333; margin: 1px 0 0 0; font-size: var(--font-md); font-weight: 600;">
          ${changeTypeLabels[changeType] || 'Compensation Notice'}
        </p>
      </div>

      <!-- ROW 1: EMPLOYEE INFO | POSITIONS & WAGES -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px;">
        <tr>
          <!-- LEFT: EMPLOYEE INFO -->
          <td style="width: 40%; vertical-align: top; padding-right: 3px;">
            <div style="background: #f8f9fa; padding: 6px; border: 1px solid #cccccc; border-left: 3px solid #333333; height: 100%;">
              <p style="margin: 0; color: #666666; font-size: var(--font-xs); font-weight: 700; text-transform: uppercase;">Employee Name</p>
              <p style="margin: 1px 0 4px 0; font-size: var(--font-lg); font-weight: 700; color: #000000;">${employee.first_name} ${employee.last_name}</p>
              
              <p style="margin: 0; color: #666666; font-size: var(--font-xs); font-weight: 700; text-transform: uppercase;">Hire Date</p>
              <p style="margin: 1px 0 4px 0; font-size: var(--font-base); font-weight: 600; color: #000000;">${formattedHireDate}</p>
              
              <p style="margin: 0; color: #666666; font-size: var(--font-xs); font-weight: 700; text-transform: uppercase;">Effective Date</p>
              <p style="margin: 1px 0 4px 0; font-size: var(--font-lg); font-weight: 700; color: #000000;">${formattedEffectiveDate}</p>
              
              <div style="margin-bottom: 3px;">
                <span style="
                  display: inline-block;
                  background: #ffffff;
                  color: #000000;
                  padding: 2px 6px;
                  border: 1px solid #666666;
                  font-size: var(--font-sm);
                  font-weight: 700;
                  margin-right: 3px;
                ">
                  ${isFullTime ? 'Full-Time' : 'Part-Time'}
                </span>
                <span style="
                  display: inline-block;
                  background: #ffffff;
                  color: #000000;
                  padding: 2px 6px;
                  border: 1px solid #666666;
                  font-size: var(--font-sm);
                  font-weight: 700;
                ">
                  ${isHourly ? 'â° Hourly' : 'ğŸ’¼ Salary'}
                </span>
              </div>
              
              ${isFullTime ? `
              <div>
                <span style="
                  display: inline-block;
                  background: #ffffff;
                  color: #000000;
                  padding: 2px 6px;
                  border: 1px solid #666666;
                  font-size: var(--font-sm);
                  font-weight: 700;
                ">
                  ğŸ–ï¸ PTO - <span style="font-weight: 900;">UP TO ${ptoHours} HRS</span>
                </span>
              </div>
              ` : ''}
            </div>
          </td>
          
          <!-- RIGHT: POSITIONS & WAGES -->
          <td style="width: 60%; vertical-align: top; padding-left: 3px;">
            <div style="background: #ffffff; border: 1px solid #cccccc; padding: 6px; height: 100%;">
              <h2 style="margin: 0 0 4px 0; color: #000000; font-size: var(--font-xl); font-weight: 700; text-transform: uppercase; text-align: center;">
                ğŸ‘¤ POSITIONS & WAGES
              </h2>
              <table style="width: 100%; border-collapse: collapse; font-size: var(--font-base);">
                <tr style="background: #f5f5f5; border-bottom: 2px solid #666666;">
                  <td style="padding: 3px 4px; font-weight: 700; color: #000000; width: 25%;">POSITION</td>
                  <td style="padding: 3px 4px; font-weight: 700; color: #000000; width: 45%;">JOB TITLE</td>
                  <td style="padding: 3px 4px; font-weight: 700; color: #000000; width: 30%; text-align: right;">RATE</td>
                </tr>
                <tr style="border-bottom: 1px solid #dddddd;">
                  <td style="padding: 3px 4px; font-weight: 700; color: #333333; font-size: 11px;">PRIMARY</td>
                  <td style="padding: 3px 4px; color: #000000;">${getPositionEmoji(position)} ${position}</td>



<td style="padding: 3px 4px; text-align: right; font-weight: 700; color: #000000;">
  ${isHourly 
    ? `$${parseFloat(hourlyRate).toFixed(2)}/hr` 
    : `$${annualSalary.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 })}`
  }
</td>                
                
                
                </tr>





                ${hasSecondary ? `
                <tr style="border-bottom: 1px solid #dddddd;">
                  <td style="padding: 3px 4px; font-weight: 700; color: #333333; font-size: 11px;">SECONDARY</td>
                  <td style="padding: 3px 4px; color: #000000;">${getPositionEmoji(secondaryJobTitle)} ${secondaryJobTitle}</td>
                  <td style="padding: 3px 4px; text-align: right; font-weight: 700; color: #000000;">$${parseFloat(secondaryWage).toFixed(2)}/hr</td>
                </tr>
                ` : ''}
                ${hasTertiary ? `
                <tr>
                  <td style="padding: 3px 4px; font-weight: 700; color: #333333; font-size: 11px;">TERTIARY</td>
                  <td style="padding: 3px 4px; color: #000000;">${getPositionEmoji(tertiaryJobTitle)} ${tertiaryJobTitle}</td>
                  <td style="padding: 3px 4px; text-align: right; font-weight: 700; color: #000000;">$${parseFloat(tertiaryWage).toFixed(2)}/hr</td>
                </tr>
                ` : ''}
              </table>
            </div>
          </td>
        </tr>
      </table>

      <!-- ROW 2: 3 COLUMNS -->
      <table style="width: 100%; border-collapse: collapse; margin-bottom: 4px;">
        <tr>
          <!-- COL 1: FINANCIAL -->
          <td style="width: 33%; vertical-align: top; padding-right: 3px;">
            <div style="background: #ffffff; border: 1px solid #cccccc; padding: 6px; height: 100%;">
              <h2 style="margin: 0 0 4px 0; color: #000000; font-size: var(--font-lg); font-weight: 700; text-transform: uppercase; text-align: center;">
                ğŸ’µ FINANCIAL
              </h2>
              <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ“š Training</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">$${parseFloat(displayTrainingPay).toFixed(2)}</td>
                </tr>
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ—“ï¸ Meeting</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">$${parseFloat(displayMeetingPay).toFixed(2)}</td>
                </tr>
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ–ï¸ Vacation</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">$${parseFloat(displayVacationPay).toFixed(2)}</td>
                </tr>
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">â° Overtime</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">${overtimeDisplay}</td>
                </tr>
              </table>
            </div>
          </td>
          
          <!-- COL 2: TIP POSITIONS -->
          <td style="width: 34%; vertical-align: top; padding-left: 3px; padding-right: 3px;">
            <div style="background: #f8f9fa; border: 1px solid #cccccc; padding: 6px; height: 100%;">
              <h2 style="margin: 0 0 4px 0; color: #000000; font-size: var(--font-lg); font-weight: 700; text-transform: uppercase; text-align: center;">
                ğŸ’³ TIPS
              </h2>
             ${(() => {
                // Detect position types
                const hasServer = allPositions.some(pos => pos.toLowerCase().includes('server'));
                const poolPositions = allPositions.filter(pos =>
                  ['busser', 'cashier', 'host', 'hostess', 'bartender'].some(tp => pos.toLowerCase().includes(tp))
                );
                const hasTipPoolPosition = poolPositions.length > 0;
                
                // Get all tip-eligible positions (Server OR pool positions)
                const tipEligiblePositions = allPositions.filter(pos => isTipEligible(pos));
                
                // If has any tip-eligible position
                if (tipEligiblePositions.length > 0) {
                  return `
                  <div style="padding: 4px;">
                    <!-- Position badges -->
                    <div style="display: flex; flex-wrap: wrap; gap: 4px; margin-bottom: 8px;">
                      ${tipEligiblePositions.map(pos => `
                        <span style="
                          display: inline-flex; 
                          align-items: center; 
                          gap: 3px; 
                          padding: 3px 8px; 
                          background: #1e40af; 
                          color: white; 
                          border-radius: 3px; 
                          font-size: 10px; 
                          font-weight: 700;
                          white-space: nowrap;
                        ">
                          ${getPositionEmoji(pos)} ${pos}
                        </span>
                      `).join('')}
                    </div>
                    
                    <!-- Tip structure table -->
                    <table style="width: 100%; border-collapse: collapse; font-size: 10px; margin-top: 6px;">
                      ${hasServer ? `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                          <td colspan="2" style="padding: 4px 0 2px 0; font-size: 9px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            Server Contribution
                          </td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                          <td style="padding: 3px 0; color: #374151; font-weight: 600;">House Pool</td>
                          <td style="padding: 3px 0; text-align: right; color: #1e40af; font-weight: 700;">${tipToHouse || '4'}%</td>
                        </tr>
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                          <td style="padding: 3px 0; color: #374151; font-weight: 600;">Merchant Services</td>
                          <td style="padding: 3px 0; text-align: right; color: #1e40af; font-weight: 700;">${merchantServices || '3'}%</td>
                        </tr>
                      ` : ''}
                      ${hasTipPoolPosition ? `
                        <tr style="border-bottom: 1px solid #e5e7eb;">
                          <td colspan="2" style="padding: 6px 0 2px 0; font-size: 9px; color: #6b7280; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">
                            Pool Distribution
                          </td>
                        </tr>
                        <tr>
                          <td style="padding: 3px 0; color: #374151; font-weight: 600;">${poolPositions.join(', ')}</td>
                          <td style="padding: 3px 0; text-align: right; color: #059669; font-weight: 700;">Eligible</td>
                        </tr>
                      ` : ''}
                    </table>
                  </div>
                  `;
                } else {
                  // No tip positions
                  return `
                  <div style="text-align: center; padding: 12px 6px; color: #9ca3af; font-size: 10px; font-style: italic;">
                    Not applicable
                  </div>
                  `;
                }
              })()}


            </div>
          </td>
          
          <!-- COL 3: BENEFITS -->
          <td style="width: 33%; vertical-align: top; padding-left: 3px;">
            <div style="background: #f8f9fa; border: 1px solid #cccccc; padding: 6px; height: 100%;">
              <h2 style="margin: 0 0 4px 0; color: #000000; font-size: var(--font-lg); font-weight: 700; text-transform: uppercase; text-align: center;">
                ğŸ BENEFITS
              </h2>
              <table style="width: 100%; border-collapse: collapse; font-size: 11px;">
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ½ï¸ Meal</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">Free</td>
                </tr>
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ¥¤ Drinks</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">30%</td>
                </tr>
                <tr>
                  <td style="padding: 2px 0; font-weight: 700; color: #000000;">ğŸ›¡ï¸ Worker Comp</td>
                  <td style="padding: 2px 0; text-align: right; font-weight: 700; color: #000000;">Yes</td>
                </tr>
              </table>
            </div>
          </td>
        </tr>
      </table>

      ${isFullTime ? `
      <!-- FULL-TIME HEADER -->
      <div style="text-align: center; background: #e9ecef; color: #000000; padding: 3px; border: 1px solid #666666; margin-bottom: 4px; font-size: var(--font-lg); font-weight: 700; text-transform: uppercase;">
        ğŸ FULL-TIME BENEFITS
      </div>
      
      <!-- HEALTH BENEFITS -->
      <div style="background: #ffffff; border: 1px solid #cccccc; padding: 6px; margin-bottom: 4px;">
        <h3 style="color: #000000; font-size: var(--font-md); font-weight: 700; margin: 0 0 4px 0; text-align: center;">
          â¤ï¸ HEALTH BENEFITS
        </h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <tr style="background: #f5f5f5; border-bottom: 1px solid #999999;">
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ¥ HEALTH</th>
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ¦· DENTAL<br>BASIC</th>
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ‘ï¸ VISION<br>BASIC</th>
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ¦· DENTAL<br>PREMIUM</th>
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ‘ï¸ VISION<br>PREMIUM</th>
            <th style="padding: 3px 2px; text-align: center; font-weight: 700; color: #000000; width: 16.66%;">ğŸ›¡ï¸ LIFE</th>
          </tr>
          <tr>
            <td style="padding: 4px 2px; vertical-align: top; border-right: 1px solid #e0e0e0; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 2px;">All Tiers:</div>
              <div>Employer: <strong>50%</strong></div>
              <div>Employee: <strong>50%</strong></div>
            </td>
            <td style="padding: 4px 2px; vertical-align: top; border-right: 1px solid #e0e0e0; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 1px;">Emp Only:</div>
              <div style="margin-bottom: 2px;">Emp Paid</div>
              <div style="font-weight: 700; margin-bottom: 1px;">+ Fam:</div>
              <div>Emp: <strong>50%</strong></div>
              <div>Ee: <strong>50%</strong></div>
            </td>
            <td style="padding: 4px 2px; vertical-align: top; border-right: 1px solid #e0e0e0; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 1px;">Emp Only:</div>
              <div style="margin-bottom: 2px;">Emp Paid</div>
              <div style="font-weight: 700; margin-bottom: 1px;">+ Fam:</div>
              <div>Emp: <strong>50%</strong></div>
              <div>Ee: <strong>50%</strong></div>
            </td>
            <td style="padding: 4px 2px; vertical-align: top; border-right: 1px solid #e0e0e0; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 2px;">All Tiers:</div>
              <div>Employer: <strong>50%</strong></div>
              <div>Employee: <strong>50%</strong></div>
            </td>
            <td style="padding: 4px 2px; vertical-align: top; border-right: 1px solid #e0e0e0; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 2px;">All Tiers:</div>
              <div>Employer: <strong>50%</strong></div>
              <div>Employee: <strong>50%</strong></div>
            </td>
            <td style="padding: 4px 2px; vertical-align: top; text-align: center; font-size: 9px;">
              <div style="font-weight: 700; margin-bottom: 2px;">$25K:</div>
              <div>Employer Paid</div>
            </td>
          </tr>
        </table>
      </div>
      
      <!-- PTO -->
      <div style="background: #f8f9fa; border: 1px solid #cccccc; padding: 6px; margin-bottom: 4px;">
        <h3 style="color: #000000; font-size: var(--font-md); font-weight: 700; margin: 0 0 4px 0; text-align: center;">ğŸ–ï¸ PAID TIME OFF</h3>
        <table style="width: 100%; border-collapse: collapse; font-size: 10px;">
          <tr>
            <td style="width: 33%; padding: 3px; vertical-align: top;">
              <div style="background: white; padding: 4px; border-radius: 3px; border-left: 2px solid #666666;">
                <div style="font-weight: 700; margin-bottom: 2px;">âœ… ELIGIBILITY:</div>
                <div style="line-height: 1.3;">Full-time + 60 days from hire date</div>
              </div>
            </td>
            <td style="width: 33%; padding: 3px; vertical-align: top;">
              <div style="background: white; padding: 4px; border-radius: 3px; border-left: 2px solid #666666;">
                <div style="font-weight: 700; margin-bottom: 2px;">ğŸ“… RATE:</div>
                <div style="line-height: 1.3;">
                  <div>â€¢ <4 yrs: <strong>40 hrs/yr</strong></div>
                  <div>â€¢ 4+ yrs: <strong>48 hrs/yr</strong></div>
                  <div style="margin-top: 2px; font-weight: 900;">You: ${ptoHours} HRS</div>
                </div>
              </div>
            </td>
            <td style="width: 34%; padding: 3px; vertical-align: top;">
              <div style="background: white; padding: 4px; border-radius: 3px; border-left: 2px solid #666666;">
                <div style="font-weight: 700; margin-bottom: 2px;">ğŸ’° UNUSED:</div>
                <div style="line-height: 1.3;">Paid in Dec paycheck. No rollover.</div>
              </div>
            </td>
          </tr>
        </table>
      </div>
      ` : ''}

      <!-- LETTER -->
      <div style="margin-bottom: 4px; font-size: 11px; line-height: 1.3;">
        <p style="margin: 0 0 2px 0;">Dear ${employee.first_name} ${employee.last_name},</p>
        <p style="margin: 0 0 2px 0;">We confirm your compensation plan, effective <strong>${formattedEffectiveDate}</strong>.</p>
        ${changeReason ? `
        <div style="background: #f5f5f5; padding: 4px; border-left: 2px solid #666666; margin: 2px 0;">
          <p style="margin: 0 0 1px 0; font-weight: 700; font-size: 10px;">Reason:</p>
          <p style="margin: 0; color: #333333; font-size: 10px; line-height: 1.2;">${changeReason}</p>
        </div>` : ''}
        <p style="margin: 0;">We appreciate your dedication.</p>
      </div>

      <!-- SIGNATURES -->
      <div style="border-top: 2px solid #000000; padding-top: 4px; margin-top: 4px;">
        <table style="width: 100%; border-collapse: collapse; font-size: 9px;">
          <tr>
            <td style="width: 33%; padding: 0 2px; vertical-align: top;">
              <div style="border-top: 2px solid #000; height: 18px; margin-bottom: 2px;"></div>
              <p style="margin: 0; font-weight: 700;">Employee Signature</p>
              <p style="margin: 0; color: #666666;">${employee.first_name} ${employee.last_name}</p>
              <p style="margin: 0; color: #666666;">Date: ${todaysDate}</p>
            </td>
            <td style="width: 33%; padding: 0 2px; vertical-align: top;">
              <div style="border-top: 2px solid #000; height: 18px; margin-bottom: 2px;"></div>
              <p style="margin: 0; font-weight: 700;">Owner Signature</p>
              <p style="margin: 0; color: #666666;">Janelle Teng</p>
              <p style="margin: 0; color: #666666;">Date: ${todaysDate}</p>
            </td>
            <td style="width: 33%; padding: 0 2px; vertical-align: top;">
              <div style="border-top: 2px solid #000; height: 18px; margin-bottom: 2px;"></div>
              <p style="margin: 0; font-weight: 700;">Manager Signature</p>
              <p style="margin: 0; color: #666666;">${
                position.toLowerCase().includes('server') ? 'Shoko Teng' :
                ['cashier','host'].some(k => position.toLowerCase().includes(k)) ? 'An Mai Vu' :
                position.toLowerCase().includes('bartender') ? 'Craig Reeves' :
                ['manager on duty','bar manager','logistic coordinator'].some(k => position.toLowerCase().includes(k)) ? 'Francisco Teng' :
                'Pablo Gonzalez'
              }</p>
              <p style="margin: 0; color: #666666;">Date: ${todaysDate}</p>
            </td>
          </tr>
        </table>
      </div>

      <!-- FOOTER -->
      <div style="padding-top: 4px; border-top: 1px solid #666666; font-size: 9px; color: #333333; margin-top: 4px;">
        <div style="padding: 4px; background: #f5f5f5; border: 1px solid #999999; margin-bottom: 2px;">
          <p style="margin: 0; line-height: 1.2;">
            <strong>DISCLAIMER:</strong> This confirms your compensation plan. Employment is at-will. Not a contract.
          </p>
        </div>
        <div style="text-align: center;">
          <p style="margin: 0; font-weight: 600; color: #000000;">Jeng Chi Restaurant â€¢ Richardson, TX</p>
          <p style="margin: 0; color: #666666; font-size: 8px;">Generated: ${todaysDate}</p>
        </div>
      </div>
    </div>
  `;
}




// ============================================================================
// EMPLOYEES GRID â€” COMPLETE MODULE (REPLACES OLD VERSION)
// ============================================================================

let EMP_GRID_REALTIME_CHANNEL = null;

// ---------- HELPER FUNCTIONS ----------
function empGridSafeStr(v, fallback = 'â€”') {
  const s = (v ?? '').toString().trim();
  return s.length ? s : fallback;
}

function empGridEscapeHtml(str) {
  return (str ?? '')
    .toString()
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function empGridFormatDate(d) {
  if (!d) return 'â€”';
  const dt = new Date(d);
  if (!Number.isFinite(dt.getTime())) return 'â€”';
  return dt.toISOString().split('T')[0];
}

function empGridMoney(n) {
  const num = typeof n === 'number' ? n : Number(n);
  if (!Number.isFinite(num)) return 'â€”';
  return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(num);
}

function empGridTenureLabel(hireDate) {
  if (!hireDate) return 'â€”';
  const start = new Date(hireDate);
  if (!Number.isFinite(start.getTime())) return 'â€”';
  const now = new Date();

  let months = (now.getFullYear() - start.getFullYear()) * 12 + (now.getMonth() - start.getMonth());
  if (now.getDate() < start.getDate()) months -= 1;
  if (months < 0) months = 0;

  const years = Math.floor(months / 12);
  const remMonths = months % 12;

  if (years === 0 && remMonths === 0) return '0m';
  if (years === 0) return `${remMonths}m`;
  if (remMonths === 0) return `${years}y`;
  return `${years}y ${remMonths}m`;
}

// ---------- MODAL FUNCTIONS ----------
function empGridOpenModal() {
  document.getElementById('empgrid-history-modal')?.classList.remove('hidden');
}

function empGridCloseModal() {
  document.getElementById('empgrid-history-modal')?.classList.add('hidden');
}

// GLOBAL MODAL FUNCTION (this fixes "not defined" error)
window.openCompLettersModal = async function(empId, employeeName) {
  const db = window.supabaseClient;
  if (!db) {
    console.error('Supabase client not ready');
    return;
  }

  const { data, error } = await db
    .from('employees2025')
    .select('*')
    .eq('id', empId)
    .single();

  if (error) {
    console.error('Modal load error:', error);
    showToast?.('Failed to load employee', 'error');
    return;
  }

  const title = document.getElementById('empgrid-history-title');
  const sub = document.getElementById('empgrid-history-subtitle');
  const body = document.getElementById('empgrid-history-body');

  if (title) title.textContent = `${employeeName} â€” Employee Details`;
  if (sub) sub.textContent = `Employee ID: ${empId}`;
  
  if (body) {
    const compType = (data.compensation_type || 'hourly').toLowerCase();
    const wage = compType === 'salary' 
      ? empGridMoney(data.annual_salary)
      : empGridMoney(data.hourly_rate);

    body.innerHTML = `
      <div class="space-y-3">
        <div class="grid grid-cols-2 gap-4">
          <div>
            <label class="text-xs font-bold text-slate-600">Employee ID</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.employee_id)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Name</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.first_name)} ${empGridSafeStr(data.last_name)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Job Title</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.job_title)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Department</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.department)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Email</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.email)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Phone</label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.primary_phone || data.phone)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Hire Date</label>
            <p class="text-sm font-semibold">${empGridFormatDate(data.original_hire_date || data.hire_date)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Tenure</label>
            <p class="text-sm font-semibold">${empGridTenureLabel(data.original_hire_date || data.hire_date)}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Compensation Type</label>
            <p class="text-sm font-semibold">${compType.toUpperCase()}</p>
          </div>
          <div>
            <label class="text-xs font-bold text-slate-600">Current Rate</label>
            <p class="text-sm font-semibold text-emerald-700 text-lg">${wage}</p>
          </div>
        </div>
      </div>
    `;
  }

  empGridOpenModal();
};

// ---------- SAVE FUNCTIONS ----------
async function empGridSaveField(inputEl) {
  const db = window.supabaseClient;
  if (!db) return;

  const id = Number(inputEl?.dataset?.id);
  const field = inputEl?.dataset?.field;
  if (!Number.isFinite(id) || !field) return;

  let value = inputEl.type === 'checkbox' 
    ? inputEl.checked 
    : (inputEl.value ?? '').toString().trim() || null;

  if (['hourly_rate', 'annual_salary'].includes(field) && value !== null) {
    const n = Number(value);
    value = Number.isFinite(n) ? n : null;
  }

  const { error } = await db
    .from('employees2025')
    .update({ [field]: value })
    .eq('id', id);

  if (error) {
    console.error('Save error:', error);
    inputEl.classList.add('bg-rose-50');
    showToast?.('Save failed', 'error');
    return;
  }

  const idx = (AppState.employees || []).findIndex(e => e.id === id);
  if (idx >= 0) AppState.employees[idx][field] = value;

  inputEl.classList.add('bg-emerald-50');
  setTimeout(() => inputEl.classList.remove('bg-emerald-50'), 700);
  showToast?.('Saved', 'success');
}

function empGridWireAutoSave(rowEl) {
  rowEl.querySelectorAll('.employee-grid-edit').forEach((el) => {
    el.addEventListener('blur', () => empGridSaveField(el));
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
      }
    });
  });
}





// ============================================================================
// AUTO-CALCULATE PAY RATES BASED ON EMPLOYEE TYPE AND POSITIONS
// ============================================================================
// ============================================================================
// AUTO-CALCULATE PAY RATES BASED ON EMPLOYEE TYPE AND POSITIONS
// ============================================================================
function autoCalculatePayRates() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) return;
  
  const positionNumField = document.getElementById('comp-letter-position-number');
  const compensationTypeField = document.getElementById('comp-letter-compensation-type');
  const hourlyRateInput = document.getElementById('comp-letter-hourly-rate');
  const annualSalaryInput = document.getElementById('comp-letter-annual-salary');
  const trainingPayInput = document.getElementById('comp-letter-training-pay');
  const overtimePayInput = document.getElementById('comp-letter-overtime-pay');
  const meetingPayInput = document.getElementById('comp-letter-meeting-pay');
  const vacationPayInput = document.getElementById('comp-letter-vacation-pay');
  const positionTitleField = document.getElementById('comp-letter-position-title');
  
  // âœ… NULL CHECK - Exit if any required field is missing
  if (!positionNumField || !compensationTypeField || !hourlyRateInput || !annualSalaryInput) {
    console.log('âš ï¸ Auto-calculate skipped: form fields not ready yet');
    return;
  }
  
  const positionNum = parseInt(positionNumField.value);
  const compensationType = compensationTypeField.value;
  
  // Get hourly rate or calculate from salary
  let baseHourlyRate = 0;
  
  if (compensationType === 'hourly') {
    baseHourlyRate = parseFloat(hourlyRateInput.value) || 0;
  } else {
    // SALARY EMPLOYEE - Calculate hourly equivalent
    // helper near the top of your script (once)
// inside the SALARY EMPLOYEE block:
// helpers (put near top of file once, or inside this function)
// helpers (put near top of file once, or inside this function)
const norm = (s) => (s || '').toString().toLowerCase().trim().replace(/\s+/g, ' ');

// SALARY EMPLOYEE - Calculate hourly equivalent
const annualSalary = parseFloat(annualSalaryInput.value) || 0;
const jobTitle = positionTitleField ? positionTitleField.value : '';
const firstName = employee.first_name || '';
const lastName = employee.last_name || '';
const fullName = `${firstName} ${lastName}`.trim();

const fullNameN = norm(fullName);
const jobTitleN = norm(jobTitle);

let hoursPerWeek = 40;

// Rules (exactly as you specified)
if (jobTitleN.includes('wok chef') || fullNameN === 'cesar ramirez' || fullNameN === 'wilson sanchez') {
  hoursPerWeek = 50;
} else if (jobTitleN.includes('production manager')) {
  hoursPerWeek = 40;
} else if (jobTitleN.includes('logistic coordinator') || jobTitleN.includes('logistics coordinator')) {
  hoursPerWeek = 40;
} else if (fullNameN === 'yu li') {
  hoursPerWeek = 48;
} else if (fullNameN === 'xing zheng') {
  hoursPerWeek = 45;
}

baseHourlyRate = annualSalary / 52 / hoursPerWeek;

console.log(`ğŸ’° Salary hourly equivalent for ${fullName} (${jobTitle}): ${annualSalary} / 52 / ${hoursPerWeek} = ${baseHourlyRate.toFixed(2)}`);

  }
  
  // âœ… Exit if fields don't exist
  if (!trainingPayInput || !overtimePayInput || !meetingPayInput || !vacationPayInput) {
    console.log('âš ï¸ Auto-calculate skipped: pay rate fields not ready yet');
    return;
  }
  
  // Check if employee has multiple positions
  const hasMultiplePositions = employee.job_title2 || employee.hourly_rate2;
  
  // Get all position rates
  const rate1 = employee.hourly_rate || 0;
  const rate2 = employee.hourly_rate2 || 0;
  const rate3 = employee.hourly_rate3 || 0;
  const highestRate = Math.max(rate1, rate2, rate3);
  
  if (compensationType === 'hourly') {
    if (hasMultiplePositions) {
      // HOURLY - MULTIPLE POSITIONS
      trainingPayInput.value = highestRate.toFixed(2);
      meetingPayInput.value = highestRate.toFixed(2);
      overtimePayInput.value = ''; // Leave blank for blended OT
      overtimePayInput.placeholder = 'Blended OT calculated by Toast';
      vacationPayInput.value = baseHourlyRate.toFixed(2);
      
      // Add label for blended OT
      const overtimeLabel = overtimePayInput.closest('.form-group')?.querySelector('label');
      if (overtimeLabel && !overtimeLabel.textContent.includes('Blended')) {
        overtimeLabel.innerHTML = 'Overtime Pay <span class="text-amber-600 text-xs font-bold">(Blended OT - Calculated by Toast)</span>';
      }
    } else {
      // HOURLY - SINGLE POSITION
      trainingPayInput.value = baseHourlyRate.toFixed(2);
      meetingPayInput.value = baseHourlyRate.toFixed(2);
      overtimePayInput.value = (baseHourlyRate * 1.5).toFixed(2);
      vacationPayInput.value = baseHourlyRate.toFixed(2);
    }
  } else {
    // SALARY - NO OVERTIME
    trainingPayInput.value = baseHourlyRate.toFixed(2);
    meetingPayInput.value = baseHourlyRate.toFixed(2);
    overtimePayInput.value = '0.00';
    overtimePayInput.placeholder = 'No OT for salary employees';
    vacationPayInput.value = baseHourlyRate.toFixed(2);

    // Overtime: 0 for Logistic Coordinator, otherwise same hourly equivalent
const isLogistics = jobTitleN.includes('logistic coordinator') || jobTitleN.includes('logistics coordinator');
overtimePayInput.value = isLogistics ? '0.00' : baseHourlyRate.toFixed(2);
overtimePayInput.placeholder = '';
    
    // Add label for salary - no OT
    const overtimeLabel = overtimePayInput.closest('.form-group')?.querySelector('label');
    if (overtimeLabel && !overtimeLabel.textContent.includes('No OT')) {
      overtimeLabel.innerHTML = 'Overtime Pay <span class="text-red-600 text-xs font-bold">(No OT for Salary Employees)</span>';
    }
  }
  
  console.log('âœ… Auto-calculated pay rates:', {
    compensationType,
    baseHourlyRate: baseHourlyRate.toFixed(2),
    hasMultiplePositions
  });
}



// ============================================================================
// ğŸ”„ RESET COMPENSATION FORM
// ============================================================================
function resetCompensationForm() {
  if (!confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
    return;
  }
  
  const employee = CompensationState.selectedEmployee;
  if (employee) {
    // Reload employee data to reset form
    selectEmployeeForCompLetter(employee);
    showToast('âœ… Form reset to current employee data', 'success');
  }
}


// ============================================================================
// 9. SAVE COMPENSATION LETTER & GENERATE PDF
// ============================================================================
// ============================================================================
// 9. SAVE COMPENSATION LETTER & GENERATE PDF - COMPLETE VERSION
// ============================================================================
// ============================================================================
// FIXED: saveCompensationLetter Function
// Replace your existing function (around line 14121) with this version
// ============================================================================

async function saveCompensationLetter(e) {
  console.log('ğŸš€ saveCompensationLetter CALLED!'); // Debug log
  
  if (e?.preventDefault) e.preventDefault();
  
  const employeeId = document.getElementById('comp-letter-selected-employee-id').value;
  console.log('ğŸ‘¤ Employee ID:', employeeId); // Debug log
  
  if (!employeeId) {
    console.error('âŒ No employee selected');
    showToast('Please select an employee', 'error');
    return;
  }

  // âœ… VALIDATE SIGNATURES WITH BETTER ERROR MESSAGES
  console.log('ğŸ–Šï¸ Checking signatures...');
  console.log('empSignaturePad:', empSignaturePad);
  console.log('mgrSignaturePad:', mgrSignaturePad);
  console.log('hrSignaturePad:', hrSignaturePad);
  
  if (!empSignaturePad) {
    console.error('âŒ Employee signature pad not initialized');
    showToast('âŒ Signature pads not ready. Please refresh the page.', 'error');
    return;
  }
  
  if (empSignaturePad.isEmpty()) {
    console.error('âŒ Employee signature is empty');
    showToast('âŒ Employee signature is required', 'error');
    return;
  }
  
  if (!mgrSignaturePad) {
    console.error('âŒ Manager signature pad not initialized');
    showToast('âŒ Signature pads not ready. Please refresh the page.', 'error');
    return;
  }
  
  if (mgrSignaturePad.isEmpty()) {
    console.error('âŒ Manager signature is empty');
    showToast('âŒ Manager signature is required', 'error');
    return;
  }
  
  if (!hrSignaturePad) {
    console.error('âŒ HR signature pad not initialized');
    showToast('âŒ Signature pads not ready. Please refresh the page.', 'error');
    return;
  }
  
  if (hrSignaturePad.isEmpty()) {
    console.error('âŒ HR signature is empty');
    showToast('âŒ HR signature is required', 'error');
    return;
  }

  console.log('âœ… All signatures validated');

  const saveBtn = document.getElementById('comp-letter-save-btn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating PDF...';
  }

  try {
    console.log('ğŸ“‹ Collecting form data...');
    const formData = collectCompensationFormData();
    
    if (!formData) {
      console.error('âŒ Form data collection failed');
      showToast('Please fill in all required fields', 'error');
      return;
    }
    
    console.log('âœ… Form data collected:', formData);

    // âœ… GET SIGNATURE DATA
    const empSigDataUrl = empSignaturePad.toDataURL('image/png');
    const mgrSigDataUrl = mgrSignaturePad.toDataURL('image/png');
    const hrSigDataUrl = hrSignaturePad.toDataURL('image/png');
    
    console.log('ğŸ“ Signatures captured');
    
    const empSigName = document.getElementById('comp-sig-emp-name')?.value || 
                       `${formData.employee.first_name} ${formData.employee.last_name}`;
    const mgrSigName = document.getElementById('comp-sig-mgr-name')?.value || 'Manager';
    const hrSigName = document.getElementById('comp-sig-hr-name')?.value || 'HR Representative';

    // âœ… PREPARE POSITIONS ARRAY FOR EDGE FUNCTION
    const positions = [];
    
    if (formData.positions && formData.positions.length > 0) {
      formData.positions.forEach(pos => {
        positions.push({
          title: pos.position_title,
          rate: parseFloat(pos.hourly_rate)
        });
      });
    } else {
      positions.push({
        title: formData.position,
        rate: parseFloat(formData.hourlyRate)
      });
      
      if (formData.secondaryJobTitle && formData.secondaryWage > 0) {
        positions.push({
          title: formData.secondaryJobTitle,
          rate: parseFloat(formData.secondaryWage)
        });
      }
      
      if (formData.tertiaryJobTitle && formData.tertiaryWage > 0) {
        positions.push({
          title: formData.tertiaryJobTitle,
          rate: parseFloat(formData.tertiaryWage)
        });
      }
    }

    console.log('ğŸ“¦ Positions:', positions);
    console.log('ğŸ“‹ Employment Type (Database):', formData.employmentType);

    // âœ… CALL EDGE FUNCTION
    console.log('ğŸš€ Calling Edge Function...');
    
    const { data: pdfResult, error: pdfError } = await window.supabaseClient.functions.invoke(
      'generate-compensation-letter',
      {
        body: {
          employee_id: parseInt(employeeId),
          type: 'hourly',
          effective_date: formData.effectiveDate,
          positions: positions,
          employment_type: formData.employmentType === 'FT' ? 'full_time' : 'part_time',
          change_type: formData.changeType,
          hire_date: formData.hireDate,
          staff_meeting_rate: parseFloat(formData.meetingPay) || null,
          training_rate: parseFloat(formData.trainingPay) || null,
          vacation_hourly_rate: parseFloat(formData.vacationPay) || null,
          benefit_notes: formData.changeReason || null,
          financial_responsibilities: {
            tip_to_house_pool: formData.isServer && formData.tipToHouse > 0,
            tip_back_merchant_services: formData.isServer && formData.merchantServices > 0
          },
          emp_sig_dataurl: empSigDataUrl,
          emp_sig_name: empSigName,
          mgr_sig_dataurl: mgrSigDataUrl,
          mgr_sig_name: mgrSigName,
          hr_sig_dataurl: hrSigDataUrl,
          hr_sig_name: hrSigName
        }
      }
    );

    if (pdfError) {
      console.error('âŒ Edge Function Error:', pdfError);
      throw new Error(pdfError.message || 'Failed to generate PDF');
    }
    
    if (!pdfResult || !pdfResult.success) {
      console.error('âŒ PDF Result:', pdfResult);
      throw new Error(pdfResult?.error || 'Failed to generate PDF');
    }

    console.log('âœ… PDF Generated:', pdfResult.url);

    const pdfUrl = pdfResult.url;

    // âœ… SAVE TO WAGE HISTORY - FIXED WITH window.supabaseClient
    const wageRecords = [];
    const baseRecord = {
      employee_id: parseInt(employeeId),
      training_pay: formData.trainingPay,
      overtime_pay: formData.overtimePay,
      meeting_pay: formData.meetingPay,
      vacation_pay: formData.vacationPay || null,
      compensation_type: 'hourly',
      effective_date: formData.effectiveDate,
      hire_date: formData.hireDate,
      employment_type: formData.employmentType,
      change_type: formData.changeType,
      change_reason: formData.changeReason || null,
      approved_by: formData.approvedBy,
      is_current: true,
      is_tip_position: formData.isTipPosition || false,
      included_in_tip_pool: formData.includedInTipPool || false,
      tip_to_house_pool_percent: formData.isServer ? formData.tipToHouse : null,
      tip_back_merchant_services_percent: formData.isServer ? formData.merchantServices : null,
      qualifies_for_full_time_benefits: formData.employmentType === 'FT',
      letter_generated: true,
      letter_generated_at: new Date().toISOString(),
      created_by: 'HR Admin',
      pdf_url: pdfUrl
    };
    
    if (formData.positions && formData.positions.length > 0) {
      formData.positions.forEach((pos) => {
        wageRecords.push({
          ...baseRecord,
          position_number: pos.position_number,
          position_title: pos.position_title,
          department: pos.department,
          hourly_rate: pos.hourly_rate
        });
      });
    } else {
      wageRecords.push({
        ...baseRecord,
        position_number: 1,
        position_title: formData.position,
        department: formData.department || 'FOH',
        hourly_rate: formData.hourlyRate
      });
      
      if (formData.secondaryJobTitle && formData.secondaryWage > 0) {
        wageRecords.push({
          ...baseRecord,
          position_number: 2,
          position_title: formData.secondaryJobTitle,
          department: formData.secondaryDepartment || 'FOH',
          hourly_rate: formData.secondaryWage
        });
      }
      
      if (formData.tertiaryJobTitle && formData.tertiaryWage > 0) {
        wageRecords.push({
          ...baseRecord,
          position_number: 3,
          position_title: formData.tertiaryJobTitle,
          department: formData.tertiaryDepartment || 'FOH',
          hourly_rate: formData.tertiaryWage
        });
      }
    }

    console.log('ğŸ’¾ Saving wage history:', wageRecords.length, 'records');
    console.log('ğŸ“‹ Records to save:', wageRecords);

    // âœ… FIXED: Use window.supabaseClient
    const { error: wageError } = await window.supabaseClient
      .from('wage_history')
      .insert(wageRecords);

    if (wageError) {
      console.error('âŒ Wage History Error:', wageError);
      throw new Error(`Failed to save wage history: ${wageError.message}`);
    }

    console.log('âœ… Wage history saved to database');

    // âœ… UPDATE employees2025 - FIXED WITH window.supabaseClient
    const updateData = {
      job_title: formData.positions[0].position_title,
      hourly_rate: formData.positions[0].hourly_rate,
      department: formData.positions[0].department,
      compensation_type: 'hourly',
      employment_type: formData.employmentType,
      original_hire_date: formData.hireDate
    };

    if (formData.positions.length > 1) {
      updateData.job_title2 = formData.positions[1].position_title;
      updateData.hourly_rate2 = formData.positions[1].hourly_rate;
    }

    if (formData.positions.length > 2) {
      updateData.job_title3 = formData.positions[2].position_title;
      updateData.hourly_rate3 = formData.positions[2].hourly_rate;
    }

    console.log('ğŸ“ Updating employee record with:', updateData);

    const { error: empUpdateError } = await window.supabaseClient
      .from('employees2025')
      .update(updateData)
      .eq('id', employeeId);

    if (empUpdateError) {
      console.error('âŒ Employee Update Error:', empUpdateError);
      throw new Error(`Failed to update employee: ${empUpdateError.message}`);
    }

    console.log('âœ… Employee record updated');

    showToast('âœ… Compensation letter generated successfully!', 'success');
    
    window.open(pdfUrl, '_blank');

    // âœ… AUTO-REFRESH THE PROFILE
    console.log('ğŸ”„ Refreshing employee profile...');
    
    if (typeof loadWageHistory === 'function') {
      await loadWageHistory(parseInt(employeeId));
      console.log('âœ… Wage history refreshed');
    } else {
      console.warn('âš ï¸ loadWageHistory function not found');
    }
    
    showToast('âœ… Profile refreshed with new letter', 'success');

  } catch (error) {
    console.error('âŒ Error in saveCompensationLetter:', error);
    console.error('âŒ Error stack:', error.stack);
    showToast(`âŒ Error: ${error.message}`, 'error');
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fa-solid fa-check"></i> Generate Letter';
    }
  }
}

// Make sure the function is globally accessible
window.saveCompensationLetter = saveCompensationLetter;
console.log('âœ… saveCompensationLetter function loaded (FIXED VERSION)');




// ============================================================================
// 10. GENERATE PDF FROM FORM DATA
// ============================================================================
function generateCompensationPDF(formData) {
  const letterHTML = generateCompensationLetterHTML(formData);
  const element = document.createElement('div');
  element.innerHTML = letterHTML;
  
  html2pdf()
    .from(element)
    .set({
      margin: 0.5,
      filename: `compensation-${formData.employee.employee_id}-${formData.effectiveDate}.pdf`,
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    })
    .save()
    .then(() => {
      showToast('âœ… PDF generated successfully!', 'success');
    })
    .catch(err => {
      console.error('PDF generation error:', err);
      showToast('âŒ Failed to generate PDF', 'error');
    });
}

// ============================================================================
// 11. PRINT COMPENSATION LETTER
// ============================================================================
function printCompensationLetter() {
  const formData = collectCompensationFormData();
  if (!formData) {
    showToast('Please fill in all required fields first', 'error');
    return;
  }

  const content = generateCompensationLetterHTML(formData);
  const printWindow = window.open('', '', 'height=800,width=800');
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Compensation Letter - ${formData.employee.first_name} ${formData.employee.last_name}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
          @media print {
            @page { margin: 0.5in; }
          }
        </style>
      </head>
      <body>
        ${content}
      </body>
    </html>
  `);
  
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 250);
}

// ============================================================================
// 12. VIEW EXISTING COMPENSATION LETTER
// ============================================================================
window.viewCompensationLetter = async function(wageHistoryId) {
  try {
    // Load the specific wage history record
    const { data: wageRecord, error: wageError } = await supabaseClient
      .from('wage_history')
      .select('*, employees2025(*)')
      .eq('id', wageHistoryId)
      .single();

    if (wageError) throw wageError;

    // Load ALL positions for this employee from the same effective date
    const { data: allPositions, error: positionsError } = await supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', wageRecord.employee_id)
      .eq('effective_date', wageRecord.effective_date)
      .order('position_number', { ascending: true });

    if (positionsError) throw positionsError;

    // Extract position data
    const primary = allPositions.find(p => p.position_number === 1);
    const secondary = allPositions.find(p => p.position_number === 2);
    const tertiary = allPositions.find(p => p.position_number === 3);

    // Generate the EXACT SAME format as Preview
    const letterHTML = generateCompensationLetterHTML({
      employee: wageRecord.employees2025,
      // Primary position
      position: primary?.position_title || wageRecord.position_title,
      department: primary?.department || wageRecord.department,
      hourlyRate: parseFloat(primary?.hourly_rate || wageRecord.hourly_rate),
      // Secondary position
      secondaryJobTitle: secondary?.position_title || null,
      secondaryDepartment: secondary?.department || null,
      secondaryWage: secondary ? parseFloat(secondary.hourly_rate) : 0,
      // Tertiary position
      tertiaryJobTitle: tertiary?.position_title || null,
      tertiaryDepartment: tertiary?.department || null,
      tertiaryWage: tertiary ? parseFloat(tertiary.hourly_rate) : 0,
      // Compensation
      trainingPay: parseFloat(wageRecord.training_pay),
      meetingPay: parseFloat(wageRecord.meeting_pay),
      vacationPay: parseFloat(wageRecord.vacation_pay || 0),
      overtimePay: parseFloat(wageRecord.overtime_pay),
      // Dates and metadata
      effectiveDate: wageRecord.effective_date,
      changeType: wageRecord.change_type,
      changeReason: wageRecord.change_reason,
      approvedBy: wageRecord.approved_by,
      employmentType: wageRecord.employment_type,
      hireDate: wageRecord.hire_date,
      // Tip info
      isTipPosition: wageRecord.is_tip_position,
      isServer: wageRecord.position_title?.toLowerCase().includes('server'),
      includedInTipPool: wageRecord.included_in_tip_pool,
      tipToHouse: parseFloat(wageRecord.tip_to_house_pool_percent) || 4.00,
      merchantServices: parseFloat(wageRecord.tip_back_merchant_services_percent) || 3.00
    });

    // Open in new window with SAME format as Preview
    const viewWindow = window.open('', '', 'height=800,width=900');
    viewWindow.document.write(`
      <html>
        <head>
          <title>Compensation Letter - ${wageRecord.employees2025.first_name} ${wageRecord.employees2025.last_name}</title>
          <style>
            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
            @media print {
              body { background: white; }
              @page { margin: 0.5in; }
            }
          </style>
        </head>
        <body>
          ${letterHTML}
        </body>
      </html>
    `);
    viewWindow.document.close();

  } catch (error) {
    console.error('Error loading compensation letter:', error);
    showToast('Failed to load compensation letter', 'error');
  }
}

window.downloadCompensationPDF = async function(wageHistoryId) {
  try {
    // Load the specific wage history record
    const { data: wageRecord, error: wageError } = await supabaseClient
      .from('wage_history')
      .select('*, employees2025(*)')
      .eq('id', wageHistoryId)
      .single();

    if (wageError) throw wageError;

    // Load ALL positions for this employee from the same effective date
    const { data: allPositions, error: positionsError } = await supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', wageRecord.employee_id)
      .eq('effective_date', wageRecord.effective_date)
      .order('position_number', { ascending: true });

    if (positionsError) throw positionsError;

    // Extract position data
    const primary = allPositions.find(p => p.position_number === 1);
    const secondary = allPositions.find(p => p.position_number === 2);
    const tertiary = allPositions.find(p => p.position_number === 3);

    // Generate the EXACT SAME format as Preview
    const letterHTML = generateCompensationLetterHTML({
      employee: wageRecord.employees2025,
      // Primary position
      position: primary ? primary.position_title : wageRecord.position_title,
      department: primary ? primary.department : wageRecord.department,
      hourlyRate: primary ? parseFloat(primary.hourly_rate) : parseFloat(wageRecord.hourly_rate),
      // Secondary position
      secondaryJobTitle: secondary ? secondary.position_title : null,
      secondaryDepartment: secondary ? secondary.department : null,
      secondaryWage: secondary ? parseFloat(secondary.hourly_rate) : 0,
      // Tertiary position
      tertiaryJobTitle: tertiary ? tertiary.position_title : null,
      tertiaryDepartment: tertiary ? tertiary.department : null,
      tertiaryWage: tertiary ? parseFloat(tertiary.hourly_rate) : 0,
      // Compensation
      trainingPay: parseFloat(wageRecord.training_pay),
      meetingPay: parseFloat(wageRecord.meeting_pay),
      vacationPay: parseFloat(wageRecord.vacation_pay || 0),
      overtimePay: parseFloat(wageRecord.overtime_pay),
      // Dates and metadata
      effectiveDate: wageRecord.effective_date,
      changeType: wageRecord.change_type,
      changeReason: wageRecord.change_reason,
      approvedBy: wageRecord.approved_by,
      employmentType: wageRecord.employment_type,
      hireDate: wageRecord.hire_date,
      // Tip info
      isTipPosition: wageRecord.is_tip_position,
      isServer: wageRecord.position_title && wageRecord.position_title.toLowerCase().includes('server'),
      includedInTipPool: wageRecord.included_in_tip_pool,
      tipToHouse: parseFloat(wageRecord.tip_to_house_pool_percent) || 4.00,
      merchantServices: parseFloat(wageRecord.tip_back_merchant_services_percent) || 3.00
    });

    const element = document.createElement('div');
    element.innerHTML = letterHTML;
    
    await html2pdf()
      .from(element)
      .set({
        margin: 0.5,
        filename: `compensation-${wageRecord.employees2025.employee_id}-${wageRecord.effective_date}.pdf`,
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      })
      .save();

    showToast('âœ… PDF downloaded successfully!', 'success');

  } catch (error) {
    console.error('Error downloading PDF:', error);
    showToast('Failed to download PDF', 'error');
  }
}










// ============================================================================
// AUTO-CALCULATE ADDITIONAL COMPENSATION
// ============================================================================
// ============================================================================
// AUTO-CALCULATE ADDITIONAL COMPENSATION
// ============================================================================






// ============================================================================ 
// CALCULATE OVERTIME RATE (1 position = 1.5x, Multiple = "BLENDED") 
// ============================================================================ 
function calculateOvertimeRate() {
  const primaryWageRaw = parseFloat(document.getElementById('primary-wage')?.value || 0);
  const secondaryWage = parseFloat(document.getElementById('secondary-wage')?.value || 0);
  const tertiaryWage = parseFloat(document.getElementById('tertiary-wage')?.value || 0);

  const primaryJobTitle = (document.getElementById('primary-job-title')?.value || '').trim().toLowerCase();

  const overtimeDisplay = document.getElementById('comp-letter-overtime-display');
  const overtimeHidden = document.getElementById('comp-letter-overtime-pay');
  const overtimeNote = document.getElementById('overtime-calculation-note');

  if (!overtimeDisplay) return;

  // âœ… SALARY OVERRIDE (must happen BEFORE BLENDED / 1.5x logic)
  const employee = CompensationState?.selectedEmployee;
  const salaryConfig = employee ? getSalaryConfig(employee) : null;
  const isSalary = salaryConfig !== null;

  // normalize helper
  const norm = (s) => (s || '').toString().toLowerCase().trim();

  if (isSalary && employee?.annual_salary) {
    const baseHourly = salaryConfig.calculateRate(employee.annual_salary);

    // Logistic Coordinator salary rule: overtime = 0.00
    const jt = norm(primaryJobTitle);
    const isLogistics = jt.includes('logistic coordinator') || jt.includes('logistics coordinator');

    const overtime = isLogistics ? 0 : baseHourly;

    overtimeDisplay.textContent = `$${overtime.toFixed(2)}`;
    if (overtimeHidden) overtimeHidden.value = overtime.toFixed(2);

    if (overtimeNote) {
      overtimeNote.innerHTML = isLogistics
        ? '<i class="fa-solid fa-ban text-red-600"></i> Salary rule: Logistic Coordinator overtime = $0.00'
        : '<i class="fa-solid fa-briefcase text-slate-700"></i> Salary rule: overtime shown at regular hourly equivalent';
    }

    // training/meeting/vacation = same hourly equivalent for salary
    autoFillAdditionalCompensation(baseHourly, baseHourly, baseHourly);
    return;
  }

  // -------------------------------------------------------------------
  // HOURLY LOGIC CONTINUES BELOW (your existing BLENDED / server rules)
  // -------------------------------------------------------------------

  const primaryWage = primaryWageRaw;

  // Count positions with wages
  const positions = [];
  if (primaryWage > 0) positions.push(primaryWage);
  if (secondaryWage > 0) positions.push(secondaryWage);
  if (tertiaryWage > 0) positions.push(tertiaryWage);

  if (positions.length === 0) {
    overtimeDisplay.textContent = '--';
    if (overtimeNote) overtimeNote.textContent = 'Will show 1.5x or BLENDED';
    return;
  }



  
  // ============================================================================ 
  // MULTIPLE POSITIONS: BLENDED (FLSA DOL TWC weighted average) 
  // ============================================================================ 
  if (positions.length > 1) {
    const avgWage = positions.reduce((sum, w) => sum + w, 0) / positions.length;
    const blendedOvertime = (avgWage * 1.5).toFixed(2);
    overtimeDisplay.textContent = 'BLENDED';
    if (overtimeHidden) overtimeHidden.value = blendedOvertime;
    if (overtimeNote) {
      overtimeNote.innerHTML = '<i class="fa-solid fa-blender text-purple-600"></i> BLENDED: $' + blendedOvertime + '/hr (avg Ã— 1.5)';
    }
    
    // For multiple positions: Meeting/Training/Vacation = PRIMARY rate
    autoFillAdditionalCompensation(primaryWage, primaryWage, primaryWage);
    return;
  }
  
  // ============================================================================ 
  // SINGLE POSITION: Check job title 
  // ============================================================================ 
  
  // SERVER ONLY
  if (primaryJobTitle === 'server') {
    overtimeDisplay.textContent = '$6.13';
    if (overtimeHidden) overtimeHidden.value = '6.13';
    if (overtimeNote) {
      overtimeNote.innerHTML = '<i class="fa-solid fa-utensils text-blue-600"></i> Server overtime: $6.13/hr';
    }
    autoFillAdditionalCompensation(7.25, 7.25, 10.88);
    return;
  }
  
  // BARTENDER ONLY
  if (primaryJobTitle === 'bartender') {
    overtimeDisplay.textContent = '$10.88';
    if (overtimeHidden) overtimeHidden.value = '10.88';
    if (overtimeNote) {
      overtimeNote.innerHTML = '<i class="fa-solid fa-martini-glass text-purple-600"></i> Bartender overtime: $10.88/hr';
    }
    autoFillAdditionalCompensation(7.25, 7.25, 10.88);
    return;
  }
  
  // ANY OTHER SINGLE POSITION: 1.5x and all same rate
  const overtime = (primaryWage * 1.5).toFixed(2);
  overtimeDisplay.textContent = '$' + overtime;
  if (overtimeHidden) overtimeHidden.value = overtime;
  if (overtimeNote) {
    overtimeNote.innerHTML = '<i class="fa-solid fa-check-circle text-emerald-600"></i> Calculated at 1.5x primary wage';
  }
  autoFillAdditionalCompensation(primaryWage, primaryWage, primaryWage);
  
  console.log('âœ… Compensation calculated:', {
    positions: positions.length,
    jobTitle: primaryJobTitle,
    overtime: overtimeHidden?.value
  });
}






function calculateAdditionalCompensation() {
  console.log('ğŸ”¥ NEW CALCULATION FUNCTION RUNNING');

  // Get primary position info
  const primaryJobTitle = document.getElementById('primary-job-title')?.value?.toLowerCase() || '';
  let primaryRate = parseFloat(document.getElementById('primary-wage')?.value) || 0;
  
  // âœ… CHECK IF THIS IS A SALARY EMPLOYEE
  const employee = CompensationState.selectedEmployee;
  const salaryConfig = employee ? getSalaryConfig(employee) : null;
  const isSalary = salaryConfig !== null;
  
  // âœ… For salary employees, calculate the hourly rate from annual salary
  if (isSalary && employee && employee.annual_salary) {
    primaryRate = salaryConfig.calculateRate(employee.annual_salary);
    console.log('ğŸ’¼ Salary employee detected - using calculated rate:', primaryRate);
  }

  console.log('Primary position:', primaryJobTitle, 'Rate:', primaryRate);






  // Get secondary position info (if enabled)
  const secondaryEnabled = document.getElementById('secondary-job-enabled')?.checked;
  const secondaryJobTitle = secondaryEnabled ? (document.getElementById('secondary-job-title')?.value?.toLowerCase() || '') : '';
  const secondaryRate = secondaryEnabled ? (parseFloat(document.getElementById('secondary-wage')?.value) || 0) : 0;

  // Get tertiary position info (if enabled)
  const tertiaryEnabled = document.getElementById('tertiary-job-enabled')?.checked;
  const tertiaryJobTitle = tertiaryEnabled ? (document.getElementById('tertiary-job-title')?.value?.toLowerCase() || '') : '';
  const tertiaryRate = tertiaryEnabled ? (parseFloat(document.getElementById('tertiary-wage')?.value) || 0) : 0;

  // Build positions array (only enabled positions with rates > 0)
  const positions = [
    { title: primaryJobTitle, rate: primaryRate }
  ];

  if (secondaryEnabled && secondaryRate > 0) {
    positions.push({ title: secondaryJobTitle, rate: secondaryRate });
  }

  if (tertiaryEnabled && tertiaryRate > 0) {
    positions.push({ title: tertiaryJobTitle, rate: tertiaryRate });
  }

  // Determine position characteristics
  const hasMultiplePositions = positions.length > 1;
  const isPrimaryServer = primaryJobTitle.includes('server');
  const isPrimaryCashier = primaryJobTitle.includes('cashier');
  const isPrimaryHost = primaryJobTitle.includes('host') || primaryJobTitle.includes('hostess');

  console.log('Position analysis:', { hasMultiplePositions, isPrimaryServer, isPrimaryCashier, isPrimaryHost });

 // === NEW RULES FOR TRAINING, MEETING, VACATION PAY ===
  let trainingPay = 0;
  let meetingPay = 0;
  let vacationPay = 0;

  // âœ… FOR SALARY EMPLOYEES: Use config rules (don't overwrite!)
  if (isSalary && salaryConfig) {
    trainingPay = (salaryConfig.trainingPay === 0) ? 0 : primaryRate;
    meetingPay = (salaryConfig.meetingPay === 0) ? 0 : primaryRate;
    vacationPay = primaryRate;
    console.log('âœ… Applied SALARY RULES:', { trainingPay, meetingPay, vacationPay });
  } else if (isPrimaryServer) {
    trainingPay = 7.25;
    meetingPay = 7.25;
    vacationPay = 10.88;
    console.log('âœ… Applied RULE 1: Server as primary');
  } else if (hasMultiplePositions || isPrimaryCashier || isPrimaryHost) {
    trainingPay = primaryRate;
    meetingPay = primaryRate;
    vacationPay = primaryRate;
    console.log('âœ… Applied RULE 2: Multiple positions or Cashier/Host primary');
  } else {
    trainingPay = primaryRate;
    meetingPay = primaryRate;
    vacationPay = primaryRate;
    console.log('âœ… Applied RULE 3: Single position (other)');
  }



  // === OVERTIME CALCULATION ===
 
  let overtimePay;
  let isBlended = false;
  const FULL_MIN_WAGE = 7.25;

  // âœ… FOR SALARY EMPLOYEES: Check hasOvertime rule
  if (isSalary && salaryConfig) {
    if (salaryConfig.hasOvertime === false) {
      overtimePay = null; // No overtime
      console.log('âœ… Salary employee - NO OVERTIME');
    } else if (salaryConfig.hasOvertime === true) {
      overtimePay = primaryRate; // Regular rate (NOT 1.5x)
      console.log('âœ… Salary employee - Regular rate overtime:', overtimePay);
    }
  } else if (hasMultiplePositions) {
    const avgRate = positions.reduce((sum, p) => sum + p.rate, 0) / positions.length;
    overtimePay = avgRate * 1.5;
    isBlended = true;
    console.log('âœ… BLENDED overtime (avg Ã— 1.5):', overtimePay);
  } else if (isPrimaryServer) {
    overtimePay = primaryRate + (FULL_MIN_WAGE * 0.5);
    console.log('âœ… Server OT (Tip Credit):', `${primaryRate} + Â½Ã—${FULL_MIN_WAGE} = ${overtimePay}`);
  } else {
    overtimePay = primaryRate * 1.5;
    console.log('âœ… Standard OT (1.5Ã—):', overtimePay);
  }




  // === UPDATE FORM FIELDS ===
  const trainingPayField = document.getElementById('comp-letter-training-pay');
  const meetingPayField = document.getElementById('comp-letter-meeting-pay');
  const vacationPayField = document.getElementById('comp-letter-vacation-pay');
  const overtimePayField = document.getElementById('comp-letter-overtime-pay');
  const fmt2 = (v) => (v == null || !Number.isFinite(Number(v)) ? '' : Number(v).toFixed(2));

  if (trainingPayField) trainingPayField.value = fmt2(trainingPay);
  if (meetingPayField) meetingPayField.value = fmt2(meetingPay);
  if (vacationPayField) vacationPayField.value = fmt2(vacationPay);
  if (overtimePayField) overtimePayField.value = fmt2(overtimePay);

  // === UPDATE OVERTIME DISPLAY TEXT ===
  const overtimeDisplay = document.getElementById('overtime-rate-display');
  if (overtimeDisplay) {
    if (isBlended) {
      overtimeDisplay.textContent = 'BLENDED';
      overtimeDisplay.style.color = '#9333ea';
    } else {
  overtimeDisplay.textContent = (overtimePay == null ? 'NO OVERTIME' : `$${Number(overtimePay).toFixed(2)}/hr`);
      overtimeDisplay.style.color = '#059669';
    }
    overtimeDisplay.style.fontWeight = '700';
    console.log('âœ… Updated overtime display â†’', isBlended ? 'BLENDED' : `$${overtimePay.toFixed(2)}/hr`);
  }

  // === âœ… ADD THIS BLOCK ONLY: DISPLAY EXACT TIP LABELS AS REQUESTED ===
const tipTableDisplay = document.getElementById('tip-table-display');
if (tipTableDisplay) {
  // Define which roles are tip-eligible (server, busser, cashier, host, bartender)
  const tipRoles = ['server', 'busser', 'cashier', 'host', 'hostess', 'bartender'];
  const hasTipRole = positions.some(pos => 
    tipRoles.some(role => pos.title.includes(role))
  );

  if (hasTipRole) {
    // Read values from form fields (default to 4.00 / 3.00 if empty)
    const houseInput = document.getElementById('comp-letter-tip-to-house');
    const svcInput = document.getElementById('comp-letter-merchant-services');
    const housePct = parseFloat(houseInput?.value) || 4.00;
    const svcPct = parseFloat(svcInput?.value) || 3.00;

    // Format exactly as requested
  // Format with full labels and clean percentages
tipTableDisplay.innerHTML = `
  <div style="display: flex; flex-direction: column; gap: 4px; font-weight: 700; color: #1e40af; font-size: 0.875rem;">
    <div style="display: flex; justify-content: space-between;">
      <span>Tip to House Pool</span>
      <span>${housePct.toFixed(0)}%</span>
    </div>
    <div style="display: flex; justify-content: space-between;">
      <span>Merchant Services</span>
      <span>${svcPct.toFixed(0)}%</span>
    </div>
  </div>
`;
  } else {
    // If no tip role, show nothing or N/A
    tipTableDisplay.textContent = 'N/A';
    tipTableDisplay.style.color = '#999999';
    tipTableDisplay.style.fontStyle = 'italic';
  }
}

  console.log('âœ… Calculation complete');
}



// ============================================================================
// EMPLOYEES GRID MODULE â€” FULLY EDITABLE (REPLACES OLD VERSION)
// ============================================================================

let employeesGridRealtimeChannel = null;  // â† RENAMED to avoid conflicts

// ---------- HELPER FUNCTIONS ----------
function empGridSafeStr(v, fallback = 'â€”') {
  const s = (v ?? '').toString().trim();
  return s.length ? s : fallback;
}

function empGridEscapeHtml(str) {
  return (str ?? '')
    .toString()
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function empGridFormatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  if (!Number.isFinite(dt.getTime())) return '';
  return dt.toISOString().split('T')[0];
}

function empGridMoney(n) {
  const num = typeof n === 'number' ? n : Number(n);
  if (!Number.isFinite(num)) return '';
  return new Intl.NumberFormat('en-US', { 
    style: 'currency', 
    currency: 'USD', 
    minimumFractionDigits: 2 
  }).format(num);
}

function empGridTenureLabel(hireDate) {
  if (!hireDate) return 'â€”';
  const start = new Date(hireDate);
  if (!Number.isFinite(start.getTime())) return 'â€”';
  const now = new Date();

  let months = (now.getFullYear() - start.getFullYear()) * 12 + 
               (now.getMonth() - start.getMonth());
  if (now.getDate() < start.getDate()) months -= 1;
  if (months < 0) months = 0;

  const years = Math.floor(months / 12);
  const remMonths = months % 12;

  if (years === 0 && remMonths === 0) return '0m';
  if (years === 0) return `${remMonths}m`;
  if (remMonths === 0) return `${years}y`;
  return `${years}y ${remMonths}m`;
}

// ---------- MODAL FUNCTIONS ----------
function empGridOpenModal() {
  document.getElementById('empgrid-history-modal')?.classList.remove('hidden');
}

function empGridCloseModal() {
  document.getElementById('empgrid-history-modal')?.classList.add('hidden');
}

// GLOBAL MODAL FUNCTION
window.openCompLettersModal = async function(empId, employeeName) {
  const db = window.supabaseClient;
  if (!db) {
    console.error('Supabase client not ready');
    return;
  }

  const { data, error } = await db
    .from('employees2025')
    .select('*')
    .eq('id', empId)
    .single();

  if (error) {
    console.error('Modal load error:', error);
    showToast?.('Failed to load employee', 'error');
    return;
  }

  const title = document.getElementById('empgrid-history-title');
  const sub = document.getElementById('empgrid-history-subtitle');
  const body = document.getElementById('empgrid-history-body');

  if (title) title.textContent = `${employeeName} â€” Complete Details`;
  if (sub) sub.textContent = `Employee ID: ${data.employee_id || empId}`;
  
  if (body) {
    const compType = (data.compensation_type || 'hourly').toLowerCase();
    const wage = compType === 'salary' 
      ? empGridMoney(data.annual_salary)
      : empGridMoney(data.hourly_rate);
    const hireDate = data.original_hire_date || data.hire_date;

    body.innerHTML = `
      <div class="space-y-4">
        <div class="grid grid-cols-2 gap-4">
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-id-badge mr-1"></i>Employee ID
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.employee_id)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-user mr-1"></i>Full Name
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.first_name)} ${empGridSafeStr(data.last_name)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-briefcase mr-1"></i>Job Title
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.job_title)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-building mr-1"></i>Department
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.department)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-envelope mr-1"></i>Email
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.email)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-phone mr-1"></i>Phone
            </label>
            <p class="text-sm font-semibold">${empGridSafeStr(data.primary_phone || data.phone)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-calendar-day mr-1"></i>Hire Date
            </label>
            <p class="text-sm font-semibold">${empGridFormatDate(hireDate)}</p>
          </div>
          <div class="bg-slate-50 p-3 rounded">
            <label class="text-xs font-bold text-slate-600 block mb-1">
              <i class="fa-solid fa-hourglass-half mr-1"></i>Tenure
            </label>
            <p class="text-sm font-semibold">${empGridTenureLabel(hireDate)}</p>
          </div>
          <div class="bg-emerald-50 p-3 rounded col-span-2 border border-emerald-200">
            <label class="text-xs font-bold text-emerald-700 block mb-1">
              <i class="fa-solid fa-money-check-dollar mr-1"></i>Compensation
            </label>
            <div class="flex items-center gap-2">
              <span class="text-2xl font-black text-emerald-700">${wage}</span>
              <span class="text-xs font-bold text-emerald-600 uppercase">${compType}</span>
            </div>
          </div>
        </div>
      </div>
    `;
  }

  empGridOpenModal();
};

// ---------- SAVE FUNCTIONS ----------
async function empGridSaveField(inputEl) {
  const db = window.supabaseClient;
  if (!db) {
    console.error('Supabase client not initialized');
    return;
  }

  const id = Number(inputEl?.dataset?.id);
  const field = inputEl?.dataset?.field;
  
  if (!Number.isFinite(id) || !field) {
    console.error('Invalid save data:', { id, field });
    return;
  }

  // Get value based on input type
  let value;
  if (inputEl.type === 'checkbox') {
    value = inputEl.checked;
  } else if (inputEl.tagName === 'SELECT') {
    value = inputEl.value;
  } else {
    value = (inputEl.value ?? '').toString().trim();
    if (value === '') value = null;
  }

  // Convert numeric fields
  if (['hourly_rate', 'annual_salary'].includes(field) && value !== null) {
    const n = Number(value);
    value = Number.isFinite(n) ? n : null;
  }

  // Show saving indicator
  inputEl.classList.add('border-blue-400', 'bg-blue-50');

  try {
    const { error } = await db
      .from('employees2025')
      .update({ [field]: value })
      .eq('id', id);

    if (error) throw error;

    // Update local state
    const idx = (AppState.employees || []).findIndex(e => e.id === id);
    if (idx >= 0) {
      AppState.employees[idx][field] = value;
    }

    // Success feedback
    inputEl.classList.remove('border-blue-400', 'bg-blue-50', 'bg-rose-50');
    inputEl.classList.add('bg-emerald-50', 'border-emerald-400');
    
    setTimeout(() => {
      inputEl.classList.remove('bg-emerald-50', 'border-emerald-400');
    }, 1000);

    showToast?.(`âœ“ ${field.replace(/_/g, ' ')} saved`, 'success');

  } catch (err) {
    console.error('Save error:', err);
    inputEl.classList.remove('border-blue-400', 'bg-blue-50');
    inputEl.classList.add('bg-rose-50', 'border-rose-400');
    showToast?.('Save failed', 'error');
  }
}

function empGridWireAutoSave(rowEl) {
  rowEl.querySelectorAll('.employee-grid-edit').forEach((el) => {
    // Save on blur
    el.addEventListener('blur', () => empGridSaveField(el));
    
    // Save on Enter key
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
      }
    });

    // Save on dropdown change
    if (el.tagName === 'SELECT') {
      el.addEventListener('change', () => empGridSaveField(el));
    }
  });
}



// ============================================================================
// ENTERPRISE EMPLOYEE GRID â€” PROFESSIONAL EDITION
// ============================================================================

let enterpriseGridRealtimeChannel = null;

// ---------- UTILITY FUNCTIONS ----------

function egSafe(v, fallback = '') {
  const s = (v ?? '').toString().trim();
  return s.length ? s : fallback;
}

function egEscape(str) {
  return (str ?? '')
    .toString()
    .replaceAll('&', '&amp;')
    .replaceAll('<', '&lt;')
    .replaceAll('>', '&gt;')
    .replaceAll('"', '&quot;')
    .replaceAll("'", '&#039;');
}

function egFormatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  if (!Number.isFinite(dt.getTime())) return '';
  return dt.toISOString().split('T')[0];
}

function egMoney(n) {
  const num = typeof n === 'number' ? n : Number(n);
  if (!Number.isFinite(num)) return '$0.00';
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2
  }).format(num);
}

function egTenure(hireDate) {
  if (!hireDate) return 'â€”';
  const start = new Date(hireDate);
  if (!Number.isFinite(start.getTime())) return 'â€”';
  const now = new Date();

  let months = (now.getFullYear() - start.getFullYear()) * 12 + 
               (now.getMonth() - start.getMonth());
  if (now.getDate() < start.getDate()) months -= 1;
  if (months < 0) months = 0;

  const years = Math.floor(months / 12);
  const remMonths = months % 12;

  if (years === 0 && remMonths === 0) return '<1 month';
  if (years === 0) return `${remMonths} month${remMonths > 1 ? 's' : ''}`;
  if (remMonths === 0) return `${years} year${years > 1 ? 's' : ''}`;
  return `${years}y ${remMonths}m`;
}

// ---------- MODAL FUNCTIONS ----------

function egOpenModal() {
  document.getElementById('empgrid-history-modal')?.classList.remove('hidden');
}

function egCloseModal() {
  document.getElementById('empgrid-history-modal')?.classList.add('hidden');
}

window.openCompLettersModal = async function(empId, employeeName) {
  const db = window.supabaseClient;
  if (!db) {
    console.error('Supabase client not ready');
    return;
  }

  const { data, error } = await db
    .from('employees2025')
    .select('*')
    .eq('id', empId)
    .single();

  if (error) {
    console.error('Modal error:', error);
    showToast?.('Failed to load employee details', 'error');
    return;
  }

  const modal = document.getElementById('empgrid-history-modal');
  const title = document.getElementById('empgrid-history-title');
  const sub = document.getElementById('empgrid-history-subtitle');
  const body = document.getElementById('empgrid-history-body');

  if (title) title.textContent = `${employeeName}`;
  if (sub) sub.textContent = `Employee ID: ${data.employee_id || empId} â€¢ ${data.job_title || 'N/A'} â€¢ ${data.department || 'N/A'}`;

  if (body) {
    const compType = (data.compensation_type || 'hourly').toLowerCase();
    const wage = compType === 'salary' ? egMoney(data.annual_salary) : egMoney(data.hourly_rate);
    const hireDate = data.original_hire_date || data.hire_date;

    body.innerHTML = `
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        
        <!-- Personal Info -->
        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-5 border-2 border-blue-200">
          <h4 class="text-sm font-black text-blue-900 uppercase tracking-wide mb-4 flex items-center gap-2">
            <i class="fa-solid fa-user-circle"></i> Personal Information
          </h4>
          <div class="space-y-3">
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Full Name</label>
              <p class="text-base font-bold text-slate-900">${egSafe(data.first_name)} ${egSafe(data.last_name)}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Employee ID</label>
              <p class="text-sm font-semibold text-slate-700 font-mono">${egSafe(data.employee_id, 'â€”')}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Email</label>
              <p class="text-sm font-semibold text-slate-700">${egSafe(data.email, 'â€”')}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Phone</label>
              <p class="text-sm font-semibold text-slate-700">${egSafe(data.primary_phone || data.phone, 'â€”')}</p>
            </div>
          </div>
        </div>

        <!-- Employment Info -->
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-5 border-2 border-purple-200">
          <h4 class="text-sm font-black text-purple-900 uppercase tracking-wide mb-4 flex items-center gap-2">
            <i class="fa-solid fa-briefcase"></i> Employment Details
          </h4>
          <div class="space-y-3">
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Job Title</label>
              <p class="text-sm font-bold text-slate-900">${egSafe(data.job_title, 'â€”')}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Department</label>
              <p class="text-sm font-semibold text-slate-700">${egSafe(data.department, 'â€”')}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Employment Type</label>
              <p class="text-sm font-semibold text-slate-700">${egSafe(data.employment_type, 'â€”')}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Hire Date</label>
              <p class="text-sm font-semibold text-slate-700">${egFormatDate(hireDate) || 'â€”'}</p>
            </div>
            <div>
              <label class="text-xs font-bold text-slate-600 block mb-1">Tenure</label>
              <p class="text-sm font-bold text-emerald-700">${egTenure(hireDate)}</p>
            </div>
          </div>
        </div>

        <!-- Compensation -->
        <div class="bg-gradient-to-br from-emerald-50 to-teal-50 rounded-xl p-5 border-2 border-emerald-300 md:col-span-2">
          <h4 class="text-sm font-black text-emerald-900 uppercase tracking-wide mb-4 flex items-center gap-2">
            <i class="fa-solid fa-money-check-dollar"></i> Compensation Details
          </h4>
          <div class="flex items-center justify-between">
            <div>
              <label class="text-xs font-bold text-emerald-700 block mb-1">Compensation Type</label>
              <p class="text-sm font-bold text-slate-800 uppercase">${compType}</p>
            </div>
            <div class="text-right">
              <label class="text-xs font-bold text-emerald-700 block mb-1">Current Rate</label>
              <p class="text-3xl font-black text-emerald-700">${wage}</p>
            </div>
          </div>
        </div>

      </div>
    `;
  }

  egOpenModal();
};

// ---------- AUTO-SAVE FUNCTION ----------

async function egSaveField(inputEl) {
  const db = window.supabaseClient;
  if (!db) {
    console.error('âŒ Supabase client not initialized');
    return;
  }

  const id = Number(inputEl?.dataset?.id);
  const field = inputEl?.dataset?.field;

  if (!Number.isFinite(id) || !field) {
    console.error('Invalid save parameters:', { id, field });
    return;
  }

  // Get value
  let value;
  if (inputEl.type === 'checkbox') {
    value = inputEl.checked;
  } else if (inputEl.tagName === 'SELECT') {
    value = inputEl.value;
  } else {
    value = (inputEl.value ?? '').toString().trim();
    if (value === '') value = null;
  }

  // Convert numeric fields
  if (['hourly_rate', 'annual_salary'].includes(field) && value !== null) {
    const n = Number(value);
    value = Number.isFinite(n) ? n : null;
  }

  // Visual feedback - saving
  inputEl.classList.add('ring-2', 'ring-blue-400', 'bg-blue-50');

  try {
    const { error } = await db
      .from('employees2025')
      .update({ [field]: value })
      .eq('id', id);

    if (error) throw error;

    // Update local state
    const idx = (AppState.employees || []).findIndex(e => e.id === id);
    if (idx >= 0) {
      AppState.employees[idx][field] = value;
    }

    // Visual feedback - success
    inputEl.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50');
    inputEl.classList.add('ring-2', 'ring-emerald-400', 'bg-emerald-50');

    setTimeout(() => {
      inputEl.classList.remove('ring-2', 'ring-emerald-400', 'bg-emerald-50');
    }, 1200);

    showToast?.(`âœ“ ${field.replace(/_/g, ' ')} updated`, 'success');

  } catch (err) {
    console.error('Save error:', err);
    inputEl.classList.remove('ring-2', 'ring-blue-400', 'bg-blue-50');
    inputEl.classList.add('ring-2', 'ring-rose-400', 'bg-rose-50');
    showToast?.('âŒ Save failed', 'error');
  }
}

function egWireAutoSave(rowEl) {
  rowEl.querySelectorAll('.eg-edit').forEach((el) => {
    // Save on blur
    el.addEventListener('blur', () => egSaveField(el));

    // Save on Enter
    el.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        el.blur();
      }
    });

    // Save on dropdown change
    if (el.tagName === 'SELECT') {
      el.addEventListener('change', () => egSaveField(el));
    }
  });
}

// ---------- RENDER GRID ----------

// ---------- RENDER GRID ----------


// ---------- RENDER GRID (COMPACT VERSION - NO ACTIONS COLUMN) ----------

// ============================================================
// UPDATED EMPLOYEE GRID - SEPARATE EDITABLE COLUMNS
// REPLACE renderEmployeeGrid AND renderEmployeeRow FUNCTIONS
// ============================================================

function renderEmployeeGrid() {
  if (!AppState.employees || AppState.employees.length === 0) {
    console.warn('âš ï¸ No employee data');
    return;
  }

  const tbody = document.getElementById('employee-grid-body');
  const loading = document.getElementById('employee-grid-loading');
  const empty = document.getElementById('employee-grid-empty');

  if (!tbody) {
    console.error('âŒ employee-grid-body not found');
    return;
  }

  // Show loading
  loading?.classList.remove('hidden');
  empty?.classList.add('hidden');
  tbody.innerHTML = '';

  try {
    // Filter by status
    const statusFilter = document.getElementById('employee-grid-filter-status')?.value || 'all';
    let employees = AppState.employees || [];

    if (statusFilter !== 'all') {
      employees = employees.filter(e => (e.employment_status || e.status) === statusFilter);
    }

    // SPLIT INTO ACTIVE AND INACTIVE
    const activeEmployees = employees.filter(e => {
      const status = (e.employment_status || e.status || 'Active').toLowerCase();
      return status === 'active';
    });

    const inactiveEmployees = employees.filter(e => {
      const status = (e.employment_status || e.status || 'Active').toLowerCase();
      return status !== 'active';
    });

    // SORT ALPHABETICALLY BY LAST NAME, THEN FIRST NAME
    const sortAlphabetically = (a, b) => {
      const lastA = (a.last_name || '').toLowerCase();
      const lastB = (b.last_name || '').toLowerCase();
      const firstA = (a.first_name || '').toLowerCase();
      const firstB = (b.first_name || '').toLowerCase();
      
      if (lastA === lastB) {
        return firstA.localeCompare(firstB);
      }
      return lastA.localeCompare(lastB);
    };

    activeEmployees.sort(sortAlphabetically);
    inactiveEmployees.sort(sortAlphabetically);

    // Hide loading
    loading?.classList.add('hidden');

    if (employees.length === 0) {
      empty?.classList.remove('hidden');
      return;
    }

    // RENDER ACTIVE EMPLOYEES SECTION
    if (activeEmployees.length > 0) {
      const activeSeparator = document.createElement('tr');
      activeSeparator.innerHTML = `
        <td colspan="10" class="bg-gradient-to-r from-emerald-500 to-teal-600 px-4 py-3">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-check-circle text-white text-lg"></i>
            <span class="text-white font-black text-sm uppercase tracking-wider">Active Employees (${activeEmployees.length})</span>
          </div>
        </td>
      `;
      tbody.appendChild(activeSeparator);

      // Render active employees
      activeEmployees.forEach(emp => renderEmployeeRow(emp, tbody));
    }

    // RENDER INACTIVE EMPLOYEES SECTION
    if (inactiveEmployees.length > 0) {
      const inactiveSeparator = document.createElement('tr');
      inactiveSeparator.innerHTML = `
        <td colspan="10" class="bg-gradient-to-r from-slate-500 to-slate-700 px-4 py-3">
          <div class="flex items-center gap-3">
            <i class="fa-solid fa-pause-circle text-white text-lg"></i>
            <span class="text-white font-black text-sm uppercase tracking-wider">Inactive / On Leave / Terminated (${inactiveEmployees.length})</span>
          </div>
        </td>
      `;
      tbody.appendChild(inactiveSeparator);

      // Render inactive employees
      inactiveEmployees.forEach(emp => renderEmployeeRow(emp, tbody, true));
    }

    console.log(`âœ… Rendered ${activeEmployees.length} active + ${inactiveEmployees.length} inactive employees`);

  } catch (err) {
    console.error('ğŸ’¥ renderEmployeeGrid failed:', err);
    showToast?.('Failed to render employee grid', 'error');
  }
}

// HELPER FUNCTION TO RENDER A SINGLE EMPLOYEE ROW
function renderEmployeeRow(emp, tbody, isInactive = false) {
  const firstName = egSafe(emp.first_name);
  const lastName = egSafe(emp.last_name);
  const hireDate = emp.original_hire_date || emp.hire_date;
  const compType = (emp.compensation_type || 'hourly').toLowerCase();
  const currentStatus = emp.employment_status || emp.status || 'Active';
  const empType = emp.employment_type || 'FT';
  const username = egSafe(emp.username || '');
  const pin = egSafe(emp.pin || '');

  const row = document.createElement('tr');
  row.className = `hover:bg-gradient-to-r ${isInactive ? 'hover:from-slate-50 hover:to-slate-100 bg-slate-50' : 'hover:from-slate-50 hover:to-blue-50'} transition-all duration-200 border-b border-slate-100 cursor-pointer`;
  
  // Double-click to view details
  row.addEventListener('dblclick', () => {
    const fullName = `${lastName}, ${firstName}`;
    openCompLettersModal(emp.id, fullName);
  });

  row.innerHTML = `
    <!-- Status -->
    <td class="px-3 py-3 whitespace-nowrap">
      <select class="eg-edit w-32 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-xs font-bold bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all cursor-pointer"
              data-id="${emp.id}"
              data-field="employment_status">
        <option value="Active" ${currentStatus === 'Active' ? 'selected' : ''}>âœ“ Active</option>
        <option value="On Leave" ${currentStatus === 'On Leave' ? 'selected' : ''}>â¸ Leave</option>
        <option value="Terminated" ${currentStatus === 'Terminated' ? 'selected' : ''}>âŠ— Terminated</option>
        <option value="Resigned" ${currentStatus === 'Resigned' ? 'selected' : ''}>â†’ Resigned</option>
      </select>
    </td>

    <!-- Last Name (EDITABLE) -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input class="eg-edit w-32 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-bold bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="last_name"
             placeholder="Last Name"
             value="${lastName}">
    </td>

    <!-- First Name (EDITABLE) -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input class="eg-edit w-32 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-semibold bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="first_name"
             placeholder="First Name"
             value="${firstName}">
    </td>

    <!-- Username (EDITABLE) -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input class="eg-edit w-28 rounded-lg border-2 border-indigo-200 px-2.5 py-2 text-sm font-medium bg-indigo-50 hover:border-indigo-400 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 transition-all"
             data-id="${emp.id}"
             data-field="username"
             placeholder="Username"
             value="${username}">
    </td>

    <!-- PIN (EDITABLE) -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input type="text"
             class="eg-edit w-20 rounded-lg border-2 border-rose-200 px-2.5 py-2 text-sm font-bold bg-rose-50 hover:border-rose-400 focus:border-rose-500 focus:ring-2 focus:ring-rose-200 transition-all text-center"
             data-id="${emp.id}"
             data-field="pin"
             placeholder="PIN"
             maxlength="6"
             value="${pin}">
    </td>

    <!-- Hire Date -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input type="date"
             class="eg-edit w-36 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-semibold bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="original_hire_date"
             value="${egFormatDate(hireDate)}">
    </td>

  

    <!-- Job Title -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input class="eg-edit w-34 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-medium bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="job_title"
             placeholder="Job title"
             value="${egSafe(emp.job_title)}">
    </td>

    <!-- Department -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input class="eg-edit w-24 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-medium bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="department"
             placeholder="Dept"
             value="${egSafe(emp.department)}">
    </td>

 

    <!-- Phone -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input type="tel"
             class="eg-edit w-32 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-medium bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="primary_phone"
             placeholder="Phone"
             value="${egSafe(emp.primary_phone || emp.phone)}">
    </td>

    <!-- Email -->
    <td class="px-3 py-3 whitespace-nowrap">
      <input type="email"
             class="eg-edit w-44 rounded-lg border-2 border-slate-200 px-2.5 py-2 text-sm font-medium bg-white hover:border-brand-300 focus:border-brand-500 focus:ring-2 focus:ring-brand-200 transition-all"
             data-id="${emp.id}"
             data-field="email"
             placeholder="email@company.com"
             value="${egSafe(emp.email)}">
    </td>

      <!-- Edit Employee Button -->
    <td class="px-3 py-3 whitespace-nowrap">
      <button onclick="openEmployeeEditModal(${emp.id}); event.stopPropagation();"
              class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-500 to-indigo-600 hover:from-blue-600 hover:to-indigo-700 text-white text-sm font-black rounded-lg shadow-lg hover:shadow-xl transition-all duration-200 flex items-center justify-center gap-2">
        <i class="fa-solid fa-pen-to-square"></i>
        <span>Edit</span>
      </button>
    </td>

  `;

  tbody.appendChild(row);
  egWireAutoSave(row);
}



// ---------- REALTIME SUBSCRIPTION ----------

function subscribeEmployeesGridRealtime() {
  const db = window.supabaseClient;
  if (!db) return;

  try {
    if (enterpriseGridRealtimeChannel) {
      db.removeChannel(enterpriseGridRealtimeChannel);
      enterpriseGridRealtimeChannel = null;
    }

    enterpriseGridRealtimeChannel = db
      .channel('enterprise-employee-grid')
      .on('postgres_changes', {
        event: '*',
        schema: 'public',
        table: 'employees2025'
      }, async () => {
        console.log('ğŸ“¡ Real-time update detected');
        await loadEmployees();
        renderEmployeeGrid();
      })
      .subscribe();

    console.log('âœ… Real-time subscription active');

  } catch (err) {
    console.error('Real-time error:', err);
  }
}

// ---------- INITIALIZATION ----------

function initEmployeesGridTab() {
  // Refresh button
  document.getElementById('employee-grid-refresh')?.addEventListener('click', async () => {
    console.log('ğŸ”„ Manual refresh');
    await loadEmployees();
    renderEmployeeGrid();
  });

  // Status filter
  document.getElementById('employee-grid-filter-status')?.addEventListener('change', () => {
    console.log('ğŸ” Filter changed');
    renderEmployeeGrid();
  });

  // Modal close buttons
  document.getElementById('empgrid-history-close')?.addEventListener('click', egCloseModal);
  document.getElementById('empgrid-history-close-2')?.addEventListener('click', egCloseModal);

  // Start realtime
  subscribeEmployeesGridRealtime();

  // Initial render
  renderEmployeeGrid();
}

// Auto-init
document.addEventListener('DOMContentLoaded', () => {
  console.log('ğŸš€ Enterprise Employee Grid initializing...');
  initEmployeesGridTab();
});















// ========================================================================
// TOGGLE SECONDARY & TERTIARY JOB SECTIONS BASED ON COMPENSATION TYPE
// ========================================================================


// ============================================================================
// TOGGLE SECONDARY & TERTIARY JOB SECTIONS BASED ON COMPENSATION TYPE
// ========================================================================
function setupJobToggles() {
  console.log('ğŸ”§ setupJobToggles called');
  // Handle Secondary Job toggle
  const secToggle = document.getElementById('secondary-job-enabled');
  const secInputs = document.querySelectorAll('#secondary-job-title, #secondary-department, #secondary-wage');
  console.log('Secondary toggle found:', secToggle);
  console.log('Secondary inputs found:', secInputs.length);
  if (secToggle) {
    secToggle.addEventListener('change', () => {
      const enabled = secToggle.checked;
      console.log('Secondary toggle changed:', enabled);
      secInputs.forEach(input => {
        input.disabled = !enabled;
        input.closest('.bg-white').style.opacity = enabled ? '1' : '0.5';
        input.closest('.bg-white').style.backgroundColor = enabled ? 'white' : '#f9fafb';
      });
    });
  }
  // Handle Tertiary Job toggle
  const terToggle = document.getElementById('tertiary-job-enabled');
  const terInputs = document.querySelectorAll('#tertiary-job-title, #tertiary-department, #tertiary-wage');
  console.log('Tertiary toggle found:', terToggle);
  console.log('Tertiary inputs found:', terInputs.length);
  if (terToggle) {
    terToggle.addEventListener('change', () => {
      const enabled = terToggle.checked;
      console.log('Tertiary toggle changed:', enabled);
      terInputs.forEach(input => {
        input.disabled = !enabled;
        input.closest('.bg-white').style.opacity = enabled ? '1' : '0.5';
        input.closest('.bg-white').style.backgroundColor = enabled ? 'white' : '#f9fafb';
      });
    });
  }
  console.log('âœ… setupJobToggles completed');
}
// Initialize job toggles when DOM is ready
document.addEventListener('DOMContentLoaded', () => {
  setupJobToggles();
});



// ============================================================================
// CREATE POSITION CARD WITH INDIVIDUAL FIELDS
// ============================================================================
function createPositionCard(slotNumber, positionData = {}) {
  const isPosition1 = slotNumber === 1;
  const employmentType = document.getElementById('comp-letter-employment-type')?.value || 'PT';
  const showVacationPay = employmentType === 'full_time';
  
  return `
    <div class="bg-white rounded-xl border-2 border-gray-300 p-6 mb-4 position-card" data-position-slot="${slotNumber}">
      
      <!-- Card Header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-2">
          <div class="bg-emerald-100 p-2 rounded-lg">
            <i class="fas fa-briefcase text-emerald-600"></i>
          </div>
          <h4 class="text-lg font-black text-gray-900">
            Position ${slotNumber} ${isPosition1 ? '<span class="text-xs text-emerald-600 ml-2">(PRIMARY)</span>' : ''}
          </h4>
        </div>
        ${slotNumber > 1 ? `
          <button type="button" 
                  onclick="removePosition(${slotNumber})"
                  class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 font-bold rounded-lg transition-all duration-200 flex items-center space-x-1">
            <i class="fas fa-trash-alt"></i>
            <span>Remove</span>
          </button>
        ` : ''}
      </div>

      <!-- Position Info Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        
        <!-- Job Title -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Job Title <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="job-title-${slotNumber}" 
                 value="${positionData.jobTitle || ''}"
                 placeholder="e.g., Server"
                 required
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
        </div>

        <!-- Department -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Department <span class="text-red-500">*</span>
          </label>
          <select id="department-${slotNumber}" 
                  required
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
            <option value="">Select...</option>
            <option value="FOH" ${positionData.department === 'FOH' ? 'selected' : ''}>FOH</option>
            <option value="BOH" ${positionData.department === 'BOH' ? 'selected' : ''}>BOH</option>
          </select>
        </div>

        <!-- Hourly Rate -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Hourly Rate <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="hourly-rate-${slotNumber}" 
                   value="${positionData.hourlyRate || ''}"
                   step="0.01"
                   min="0"
                   required
                  
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
          </div>
        </div>

      </div>

      <!-- Compensation Rates Grid -->
      <div class="grid grid-cols-1 md:grid-cols-${showVacationPay ? '4' : '3'} gap-4">
        
        ${isPosition1 ? `
        <!-- Training Pay (Position 1 Only) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-graduation-cap text-blue-600 mr-1"></i>
            Training Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="training-pay-${slotNumber}" 
                   value="${positionData.trainingPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">During training period</p>
        </div>
        ` : ''}


        <!-- Meeting Pay -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-users text-purple-600 mr-1"></i>
            Meeting Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="meeting-pay-${slotNumber}" 
                   value="${positionData.meetingPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">For attending meetings</p>
        </div>

        ${showVacationPay ? `
        <!-- Vacation Pay (Full-Time Only) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-umbrella-beach text-teal-600 mr-1"></i>
            Vacation Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="vacation-pay-${slotNumber}" 
                   value="${positionData.vacationPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">Accrual per hour</p>
        </div>
        ` : ''}

        <!-- Overtime Pay (DISABLED/READ-ONLY) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-clock text-orange-600 mr-1"></i>
            Overtime Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="text" 
                   id="overtime-pay-${slotNumber}" 
                   value="--"
                   disabled
                   readonly
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100 font-semibold text-orange-600">
          </div>
          <p class="text-xs text-gray-500 mt-1" id="overtime-note-${slotNumber}">Auto-calculated</p>
        </div>

      </div>

    </div>
  `;
}




// ============================================================================
// ADD NEW POSITION
// ============================================================================
function addPosition() {
  const container = document.getElementById('comp-letter-positions-form-container');
  const currentPositions = document.querySelectorAll('.position-card').length;
  
  if (currentPositions >= 3) {
    showToast('âš ï¸ Maximum 3 positions allowed', 'warning');
    return;
  }
  
  const newSlot = currentPositions + 1;
  const newCard = createPositionCard(newSlot);
  container.insertAdjacentHTML('beforeend', newCard);
  
  // Update add button visibility
  if (newSlot >= 3) {
    document.getElementById('add-position-btn')?.classList.add('hidden');
  }
  
  calculateOvertimeRate();
}

// ============================================================================
// REMOVE POSITION
// ============================================================================
function removePosition(slotNumber) {
  if (slotNumber === 1) {
    showToast('âš ï¸ Cannot remove primary position', 'error');
    return;
  }
  
  const card = document.querySelector(`[data-position-slot="${slotNumber}"]`);
  if (card) {
    card.remove();
  }
  
  // Show add button again
  document.getElementById('add-position-btn')?.classList.remove('hidden');
  
  calculateOvertimeRate();
}










// ============================================================================
// LOAD EMPLOYEE POSITIONS INTO CARDS
// ============================================================================
function loadEmployeePositions(employee) {
  const container = document.getElementById('comp-letter-positions-form-container');
  container.innerHTML = ''; // Clear existing cards
  
  // Load Position 1 (always exists)
  if (employee.job_title) {
    const card1 = createPositionCard(1, {
      jobTitle: employee.job_title,
      department: employee.department,
      hourlyRate: employee.hourly_rate,
      trainingPay: employee.trainning,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation,
      overtimePay: employee.overtime
    });
    container.insertAdjacentHTML('beforeend', card1);
  }
  
  // Load Position 2 (if exists)
  if (employee.job_title2) {
    const card2 = createPositionCard(2, {
      jobTitle: employee.job_title2,
      department: employee.department,
      hourlyRate: employee.hourly_rate2,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation
    });
    container.insertAdjacentHTML('beforeend', card2);
  }
  
  // Load Position 3 (if exists)
  if (employee.job_title3) {
    const card3 = createPositionCard(3, {
      jobTitle: employee.job_title3,
      department: employee.department,
      hourlyRate: employee.hourly_rate3,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation
    });
    container.insertAdjacentHTML('beforeend', card3);
  }
  
  // Calculate overtime
  calculateOvertimeRate();
  
  // Update add button visibility
  const positionCount = document.querySelectorAll('.position-card').length;
  const addBtn = document.getElementById('add-position-btn');
  if (positionCount >= 3) {
    addBtn?.classList.add('hidden');
  } else {
    addBtn?.classList.remove('hidden');
  }
}

// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================

// ============================================================================
// CLEAR TERTIARY POSITION
// ============================================================================
// ============================================================================
// CLEAR TERTIARY POSITION
// ============================================================================


// ============================================================================
// LOAD EXISTING EMPLOYEE DATA INTO FORM (AUTO-FILL)
// ============================================================================
function loadEmployeeCompensationData(employee) {
  if (!employee) return;
  
  console.log('ğŸ“‹ Loading employee compensation data:', employee);
  
  // âœ… CHECK IF THIS IS A SALARY EMPLOYEE
  const salaryConfig = getSalaryConfig(employee);
  const isSalary = salaryConfig !== null;
  
  // âœ… UPDATE LABEL: "Annual Salary" or "Hourly Wage"
  const wageLabel = document.getElementById('primary-wage-label');
  if (wageLabel) {
    wageLabel.textContent = isSalary ? 'Annual Salary' : 'Hourly Wage';
  }
  
  // âœ… SET EMPLOYMENT TYPE (Salary employees are always full-time)
  if (isSalary) {
document.getElementById('comp-letter-employment-type').value = 'FT';  } else {
    document.getElementById('comp-letter-employment-type').value = employee.employment_type || 'part_time';
  }
  
  // PRIMARY JOB (always exists)
  if (employee.job_title) {
    document.getElementById('primary-job-title').value = employee.job_title || '';
    document.getElementById('primary-department').value = employee.department || '';
    
    if (isSalary && employee.annual_salary) {
      // === SALARIED EMPLOYEE ===
      const calculatedHourlyRate = salaryConfig.calculateRate(employee.annual_salary);
      const hourlyRateFormatted = calculatedHourlyRate.toFixed(2);
      
      // Show full annual salary in the main wage field
      document.getElementById('primary-wage').value = employee.annual_salary;
      
      // Training & Meeting Pay â†’ Always N/A for salaried employees
      document.getElementById('comp-letter-training-pay').value = 'N/A';
      document.getElementById('comp-letter-meeting-pay').value = 'N/A';
      
      // Vacation Pay â†’ Always the hourly rate
      document.getElementById('comp-letter-vacation-pay').value = hourlyRateFormatted;
      
      // Special Overtime Rules Based on Job Title
     // Special Overtime Rules Based on Job Title
      const jobTitle = (employee.job_title || '').toLowerCase();
      const overtimeField = document.getElementById('comp-letter-overtime-pay');
      const overtimeNote = document.getElementById('overtime-note'); // May be null

      if (jobTitle.includes('production manager') || jobTitle.includes('logistics coordinator')) {
        // Special Roles: No overtime at all
        if (overtimeField) overtimeField.value = 'N/A';
        if (overtimeNote) overtimeNote.textContent = 'No overtime eligibility for this role';
        console.log(`   Special Role: No overtime | Vacation: $${hourlyRateFormatted}`);
      } else {
        // Other Salaried Employees: Overtime at straight time (same as hourly rate)
        if (overtimeField) overtimeField.value = hourlyRateFormatted;
        if (overtimeNote) overtimeNote.textContent = 'Calculated at straight time (1x primary wage)';
        console.log(`   Overtime: $${hourlyRateFormatted} (straight time) | Vacation: $${hourlyRateFormatted}`);
      }
    } else {
      // === HOURLY EMPLOYEE ===
      document.getElementById('primary-wage').value = employee.hourly_rate || '';
      document.getElementById('comp-letter-training-pay').value = employee.trainning || '';
      document.getElementById('comp-letter-meeting-pay').value = employee.meetingpay?.rate || '';
      document.getElementById('comp-letter-vacation-pay').value = employee.vacation || '';
      calculateOvertimeRate(); // Use default 1.5x for hourly
    }
  }
  
  // SECONDARY JOB (no changes needed)
  if (employee.job_title2 && employee.hourly_rate2) {
    document.getElementById('secondary-job-title').value = employee.job_title2 || '';
    document.getElementById('secondary-department').value = employee.department || '';
    document.getElementById('secondary-wage').value = employee.hourly_rate2 || '';
  } else {
    document.getElementById('secondary-job-title').value = '';
    document.getElementById('secondary-department').value = '';
    document.getElementById('secondary-wage').value = '';
  }
  
  // TERTIARY JOB (no changes needed)
  if (employee.job_title3 && employee.hourly_rate3) {
    document.getElementById('tertiary-job-title').value = employee.job_title3 || '';
    document.getElementById('tertiary-department').value = employee.department || '';
    document.getElementById('tertiary-wage').value = employee.hourly_rate3 || '';
  } else {
    document.getElementById('tertiary-job-title').value = '';
    document.getElementById('tertiary-department').value = '';
    document.getElementById('tertiary-wage').value = '';
  }
  
  // HIRE DATE
  document.getElementById('comp-letter-hire-date').value = employee.original_hire_date || employee.hire_date || '';
  
  // Trigger any additional calculations (if needed)
  if (typeof calculateAdditionalCompensation === 'function') {
    setTimeout(() => calculateAdditionalCompensation(), 100);
  }
  
  console.log('âœ… Employee compensation data loaded correctly!');
}


// ============================================================================
// ADD TO BOOTSTRAP FUNCTION
// ============================================================================
// Add this line in your existing bootstrap() function:
// initCompensationLetterTab();

/* =====================================================
   GLOBAL POSITION CLEAR FUNCTIONS (REQUIRED FOR onclick)
   ===================================================== */

window.clearSecondaryPosition = function () {
  const title = document.getElementById('secondary-job-title');
  const dept  = document.getElementById('secondary-department');
  const wage  = document.getElementById('secondary-wage');

  if (title) title.value = '';
  if (dept)  dept.value  = '';
  if (wage)  wage.value  = '';

  console.log('ğŸ—‘ï¸ Secondary position cleared');
};

window.clearTertiaryPosition = function () {
  const title = document.getElementById('tertiary-job-title');
  const dept  = document.getElementById('tertiary-department');
  const wage  = document.getElementById('tertiary-wage');

  if (title) title.value = '';
  if (dept)  dept.value  = '';
  if (wage)  wage.value  = '';

  console.log('ğŸ—‘ï¸ Tertiary position cleared');
};








// ============================================================================
// AUTO-FILL MEETING, TRAINING, VACATION PAY
// ============================================================================
function autoFillAdditionalCompensation(meetingRate, trainingRate, vacationRate) {
  const meetingInput = document.getElementById('comp-letter-meeting-pay');
  const trainingInput = document.getElementById('comp-letter-training-pay');
  const vacationInput = document.getElementById('comp-letter-vacation-pay');

  if (meetingInput) meetingInput.value = meetingRate.toFixed(2);
  if (trainingInput) trainingInput.value = trainingRate.toFixed(2);
  if (vacationInput) vacationInput.value = vacationRate.toFixed(2);
}









// ============================================================================
// 13. INITIALIZE COMPENSATION LETTER TAB
// ===============================================```=============================
function initCompensationLetterTab() {
  console.log('ğŸš€ Initializing Compensation Letter Tab...');
  
  // Setup search
  setupCompensationLetterSearch();
  
  // Setup form logic (tip detection, overtime calc)
  setupCompensationFormLogic();
  
  // Preview button
  const previewBtn = document.getElementById('comp-letter-preview-btn');
  if (previewBtn) {
    previewBtn.addEventListener('click', previewCompensationLetter);
    console.log('âœ… Preview button listener attached');
  } else {
    console.warn('âš ï¸ Preview button not found (comp-letter-preview-btn)');
  }
  
  // Save & Generate PDF button
  const form = document.getElementById('comp-letter-form');
  if (form) {
    form.addEventListener('submit', saveCompensationLetter);
    console.log('âœ… Form submit listener attached');
  } else {
    console.error('âŒ Form not found (comp-letter-form)');
  }
  
  // Print button (if you add one)
  const printBtn = document.getElementById('comp-letter-print-btn');
  if (printBtn) {
    printBtn.addEventListener('click', printCompensationLetter);
    console.log('âœ… Print button listener attached');
  }

  // âœ… AUTO-CALCULATE OVERTIME WHEN WAGE FIELDS OR JOB TITLE CHANGE
  const primaryWageField = document.getElementById('primary-wage');
  const secondaryWageField = document.getElementById('secondary-wage');
  const tertiaryWageField = document.getElementById('tertiary-wage');
  const primaryJobTitleField = document.getElementById('primary-job-title');
  
  if (primaryWageField) {
    primaryWageField.addEventListener('input', calculateOvertimeRate);
    primaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  if (secondaryWageField) {
    secondaryWageField.addEventListener('input', calculateOvertimeRate);
    secondaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  if (tertiaryWageField) {
    tertiaryWageField.addEventListener('input', calculateOvertimeRate);
    tertiaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  if (primaryJobTitleField) {
    primaryJobTitleField.addEventListener('input', calculateOvertimeRate);
    primaryJobTitleField.addEventListener('change', calculateOvertimeRate);
  }
  
  console.log('âœ… Overtime calculation listeners attached');
  
  // Refresh button
  const refreshBtn = document.getElementById('comp-letter-refresh');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      await loadEmployees();
      if (CompensationState.selectedEmployee) {
        await loadWageHistory(CompensationState.selectedEmployee.id);
      }
      showToast('Data refreshed', 'success');
    });
    console.log('âœ… Refresh button listener attached');
  }

  // âœ… Initialize signature pads
  console.log('ğŸ–Šï¸ Calling initializeSignaturePads...');
  if (typeof initializeSignaturePads === 'function') {
    initializeSignaturePads();
  } else {
    console.error('âŒ initializeSignaturePads function not found!');
  }

  // âœ… Verify form is properly set up
  setTimeout(() => {
    const verifyForm = document.getElementById('comp-letter-form');
    if (verifyForm) {
      console.log('âœ… Form verification: Form exists and should be ready');
    } else {
      console.error('âŒ Form verification failed: Form not found after init');
    }
  }, 500);

  console.log('âœ… Compensation Letter tab initialized');
}







// ğŸš€ OPEN EMPLOYEE 360 MODAL â€” FULL DATA, NO MASKS
function openEmployee360(employee) {
  // Update header
  document.getElementById('modal-employee-name').textContent = `${employee.first_name} ${employee.last_name}`;

  // Render Core Tab (full raw data)
  const coreHTML = `
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="bg-slate-50 p-4 rounded">
        <h3 class="font-bold text-slate-800 mb-2">ğŸ‘¤ Personal</h3>
        <p><strong>ID:</strong> ${employee.employee_id || 'â€“'}</p>
        <p><strong>SSN:</strong> ${employee.ssn || 'â€“'}</p>
        <p><strong>DOB:</strong> ${employee.dob || 'â€“'}</p>
        <p><strong>Phone:</strong> ${employee.phone || 'â€“'}</p>
        <p><strong>Email:</strong> ${employee.email || 'â€“'}</p>
        <p><strong>Address:</strong> ${JSON.stringify(employee.address) || 'â€“'}</p>
      </div>
      <div class="bg-slate-50 p-4 rounded">
        <h3 class="font-bold text-slate-800 mb-2">ğŸ’¼ Employment</h3>
        <p><strong>Status:</strong> ${employee.employment_status}</p>
        <p><strong>Job Title:</strong> ${employee.job_title || 'â€“'}</p>
        <p><strong>Secondary:</strong> ${employee.job_title2 || 'â€“'}</p>
        <p><strong>Tertiary:</strong> ${employee.job_title3 || 'â€“'}</p>
        <p><strong>Department:</strong> ${employee.department || 'â€“'}</p>
        <p><strong>Report To:</strong> ${employee.report_to || 'â€“'}</p>
        <p><strong>Hire Date:</strong> ${employee.hire_date}</p>
        <p><strong>Original Hire:</strong> ${employee.original_hire_date}</p>
      </div>
    </div>
  `;
  document.getElementById('tab-content').innerHTML = coreHTML;

  // Show modal
  document.getElementById('employee-360-modal').classList.remove('hidden');
}

// Close modal
// Wait for DOM to load first
document.addEventListener('DOMContentLoaded', () => {
  const closeBtn = document.getElementById('close-360');
  if (closeBtn) {
    closeBtn.onclick = () => {
      document.getElementById('employee-360-modal').classList.add('hidden');
    };
  }
});














// ========================================================================
// DISCIPLINE MANAGEMENT SYSTEM
// ========================================================================

const DisciplineState = {
  selectedEmployee: null,
  allEmployees: [],
  disciplineActions: []
};

// Initialize Discipline Tab
async function initDisciplineTab() {
  console.log('ğŸ¯ Initializing Discipline Tab...');
  
  // Load employees for dropdown
  await loadEmployeesForDiscipline();
  
  // Load existing discipline actions
  await loadDisciplineActions();
  
  // Setup event listeners
  setupDisciplineEventListeners();
  
  console.log('âœ… Discipline Tab initialized');
}

// Load employees for discipline dropdown
async function loadEmployeesForDiscipline() {
  try {
    const { data, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('employment_status', 'Active')
      .order('last_name', { ascending: true });

    if (error) throw error;
    
    DisciplineState.allEmployees = data || [];
    console.log(`âœ… Loaded ${DisciplineState.allEmployees.length} active employees for discipline`);
    
  } catch (error) {
    console.error('âŒ Error loading employees:', error);
    showToast('Failed to load employees', 'error');
  }
}

// Setup Event Listeners for Discipline Tab
function setupDisciplineEventListeners() {
  
  // Employee Search
  const searchInput = document.getElementById('discipline-employee-search');
  if (searchInput) {
    searchInput.addEventListener('input', handleEmployeeSearch);
    searchInput.addEventListener('focus', handleEmployeeSearch);
  }

  // Form submission
  const disciplineForm = document.getElementById('discipline-form');
  if (disciplineForm) {
    disciplineForm.addEventListener('submit', handleDisciplineFormSubmit);
  }

  // Clear form button
  const clearBtn = document.getElementById('discipline-clear-form');
  if (clearBtn) {
    clearBtn.addEventListener('click', clearDisciplineForm);
  }

  // Refresh button
  const refreshBtn = document.getElementById('discipline-refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      await loadEmployeesForDiscipline();
      await loadDisciplineActions();
      showToast('Data refreshed', 'success');
    });
  }

  // Close dropdown when clicking outside
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('discipline-employee-dropdown');
    const searchInput = document.getElementById('discipline-employee-search');
    
    if (dropdown && searchInput && !dropdown.contains(e.target) && e.target !== searchInput) {
      dropdown.classList.add('hidden');
    }
  });
}

// Handle Employee Search
function handleEmployeeSearch(e) {
  const searchTerm = e.target.value.toLowerCase().trim();
  const dropdown = document.getElementById('discipline-employee-dropdown');
  
  if (!dropdown) return;

  if (searchTerm.length === 0) {
    dropdown.classList.add('hidden');
    return;
  }

  // Filter employees
  const filteredEmployees = DisciplineState.allEmployees.filter(emp => {
    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
    const empId = (emp.employee_id || '').toString().toLowerCase();
    return fullName.includes(searchTerm) || empId.includes(searchTerm);
  });

  // Render dropdown
  if (filteredEmployees.length > 0) {
    dropdown.innerHTML = filteredEmployees.map(emp => `
      <div 
        class="p-3 hover:bg-blue-50 cursor-pointer border-b border-slate-200 last:border-b-0"
        onclick="selectEmployeeForDiscipline(${emp.id})"
      >
        <div class="font-bold text-slate-800">${emp.first_name} ${emp.last_name}</div>
        <div class="text-xs text-slate-500">
          ID: ${emp.employee_id || 'N/A'} | ${emp.job_title || 'N/A'} | ${emp.department || 'N/A'}
        </div>
      </div>
    `).join('');
    dropdown.classList.remove('hidden');
  } else {
    dropdown.innerHTML = `
      <div class="p-4 text-center text-slate-400">
        <i class="fas fa-search mb-2"></i>
        <p>No employees found</p>
      </div>
    `;
    dropdown.classList.remove('hidden');
  }
}

// Select Employee for Discipline
function selectEmployeeForDiscipline(employeeId) {
  const employee = DisciplineState.allEmployees.find(e => e.id === employeeId);
  
  if (!employee) return;

  DisciplineState.selectedEmployee = employee;

  // Update hidden input
  document.getElementById('selected-employee-id').value = employeeId;

  // Clear search input
  document.getElementById('discipline-employee-search').value = '';

  // Hide dropdown
  document.getElementById('discipline-employee-dropdown').classList.add('hidden');

  // Calculate tenure
  const hireDate = new Date(employee.hire_date || employee.original_hire_date);
  const today = new Date();
  const tenureDays = Math.floor((today - hireDate) / (1000 * 60 * 60 * 24));
  const tenureYears = Math.floor(tenureDays / 365);
  const tenureMonths = Math.floor((tenureDays % 365) / 30);

  // Display selected employee
  const displayDiv = document.getElementById('selected-employee-display');
  displayDiv.innerHTML = `
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-4">
        <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center text-white font-bold text-xl">
          ${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}
        </div>
        <div>
          <div class="font-bold text-slate-800 text-lg">${employee.first_name} ${employee.last_name}</div>
          <div class="text-sm text-slate-600">
            <span class="font-bold">ID:</span> ${employee.employee_id || 'N/A'} | 
            <span class="font-bold">Position:</span> ${employee.job_title || 'N/A'} | 
            <span class="font-bold">Dept:</span> ${employee.department || 'N/A'}
          </div>
          <div class="text-xs text-slate-500 mt-1">
            <span class="font-bold">Hired:</span> ${employee.hire_date || employee.original_hire_date || 'N/A'} | 
            <span class="font-bold">Tenure:</span> ${tenureYears} year(s), ${tenureMonths} month(s)
          </div>
        </div>
      </div>
      <button 
        type="button"
        onclick="clearSelectedEmployee()"
        class="px-3 py-1 bg-red-100 text-red-600 rounded hover:bg-red-200 text-sm font-bold"
      >
        <i class="fas fa-times mr-1"></i> Clear
      </button>
    </div>
  `;
  displayDiv.classList.remove('hidden');

  showToast(`Selected: ${employee.first_name} ${employee.last_name}`, 'success');
}

// Clear Selected Employee
function clearSelectedEmployee() {
  DisciplineState.selectedEmployee = null;
  document.getElementById('selected-employee-id').value = '';
  document.getElementById('selected-employee-display').classList.add('hidden');
  document.getElementById('discipline-employee-search').value = '';
}

// Handle Discipline Form Submission
async function handleDisciplineFormSubmit(e) {
  e.preventDefault();

  if (!DisciplineState.selectedEmployee) {
    showToast('Please select an employee first', 'error');
    return;
  }

  // Gather form data
  const formData = {
    employee_id: DisciplineState.selectedEmployee.id,
    action_type: document.getElementById('discipline-action-type').value,
    incident_date: document.getElementById('discipline-incident-date').value,
    incident_time: document.getElementById('discipline-incident-time').value || null,
    category: document.getElementById('discipline-category').value,
    subcategory: document.getElementById('discipline-subcategory').value || null,
    severity: document.getElementById('discipline-severity').value,
    issued_by: document.getElementById('discipline-issued-by').value,
    manager_name: document.getElementById('discipline-manager-name').value || null,
    hr_witness: document.getElementById('discipline-hr-witness').value || null,
    description: document.getElementById('discipline-description').value,
    corrective_action: document.getElementById('discipline-corrective-action').value || null,
    consequences: document.getElementById('discipline-consequences').value || null,
    department: DisciplineState.selectedEmployee.department || null,
    status: 'Pending',
    created_at: new Date().toISOString(),
    updated_at: new Date().toISOString()
  };

  try {
    showToast('Creating disciplinary action...', 'info');

    // Insert into database
    const { data, error } = await window.supabaseClient
      .from('discipline_actions')
      .insert([formData])
      .select()
      .single();

    if (error) throw error;

    showToast('âœ… Disciplinary action created successfully!', 'success');

    // Generate PDF
    await generateDisciplinePDF(data.id);

    // Reload timeline
    await loadDisciplineActions();

    // Clear form
    clearDisciplineForm();

  } catch (error) {
    console.error('âŒ Error creating discipline action:', error);
    showToast('Failed to create disciplinary action', 'error');
  }
}





// Generate Discipline PDF
// Generate Discipline PDF - CLIENT-SIDE VERSION
// Call Edge Function to generate PDF
async function generateDisciplinePDFNew(disciplineId) {
  try {
    showToast('Generating professional PDF...', 'info');

    console.log('ğŸ“ Calling Edge Function for discipline ID:', disciplineId);

    const response = await fetch(
      `${window.supabaseClient.supabaseUrl}/functions/v1/generate-discipline-pdf`,
      {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${window.supabaseClient.supabaseKey}`
        },
        body: JSON.stringify({ disciplineId })
      }
    );

    console.log('ğŸ“¡ Edge Function response status:', response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error('âŒ Edge Function error:', errorText);
      throw new Error(`Edge Function failed: ${errorText}`);
    }

    const result = await response.json();
    console.log('ğŸ“„ Edge Function result:', result);

    if (result.success) {
      showToast('âœ… PDF generated successfully!', 'success');
      console.log('ğŸ”— PDF URL:', result.pdfUrl);
      
      // Open PDF in new tab
      window.open(result.pdfUrl, '_blank');
      
      return result;
    } else {
      throw new Error(result.error || 'PDF generation failed');
    }

  } catch (error) {
    console.error('âŒ PDF generation failed:', error);
    showToast('PDF generation failed: ' + error.message, 'error');
    throw error;
  }
}













// Load Discipline Actions (Timeline)
async function loadDisciplineActions() {
  try {
    const { data, error } = await window.supabaseClient
      .from('discipline_actions')
      .select(`
        *,
        employees2025 (
          first_name,
          last_name,
          employee_id,
          job_title,
          department
        )
      `)
      .order('created_at', { ascending: false })
      .limit(50);

    if (error) throw error;

    DisciplineState.disciplineActions = data || [];
    renderDisciplineTimeline();

  } catch (error) {
    console.error('âŒ Error loading discipline actions:', error);
  }
}

// Render Discipline Timeline
function renderDisciplineTimeline() {
  const timeline = document.getElementById('discipline-timeline');
  
  if (!timeline) return;

  if (DisciplineState.disciplineActions.length === 0) {
    timeline.innerHTML = `
      <div class="text-center py-12 text-slate-400">
        <i class="fas fa-clipboard-list text-6xl mb-4"></i>
        <p class="text-lg font-bold">No disciplinary actions yet</p>
        <p class="text-sm">Actions will appear here once created</p>
      </div>
    `;
    return;
  }

  timeline.innerHTML = DisciplineState.disciplineActions.map(action => {
    const employee = action.employees2025;
    const severityColors = {
      'Low': 'bg-green-100 text-green-800 border-green-300',
      'Medium': 'bg-yellow-100 text-yellow-800 border-yellow-300',
      'High': 'bg-red-100 text-red-800 border-red-300'
    };

    return `
      <div class="border-l-4 border-blue-500 pl-6 pb-6 relative">
        <div class="absolute -left-2 top-0 w-4 h-4 bg-blue-500 rounded-full"></div>
        
        <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
          <div class="flex items-start justify-between mb-3">
            <div>
              <h4 class="font-bold text-slate-800 text-lg">
                ${action.action_type}
                <span class="ml-2 px-3 py-1 rounded-full text-xs border-2 ${severityColors[action.severity] || 'bg-slate-100 text-slate-800 border-slate-300'}">
                  ${action.severity} Severity
                </span>
              </h4>
              <p class="text-sm text-slate-600 mt-1">
                <i class="fas fa-user mr-1"></i>
                <span class="font-bold">${employee?.first_name} ${employee?.last_name}</span>
                <span class="mx-2">â€¢</span>
                <span class="font-bold">ID:</span> ${employee?.employee_id || 'N/A'}
                <span class="mx-2">â€¢</span>
                ${employee?.job_title || 'N/A'}
              </p>
            </div>
            ${action.pdf_url ? `
              <a 
                href="${action.pdf_url}" 
                target="_blank"
                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-all flex items-center gap-2 font-bold text-sm"
              >
                <i class="fas fa-file-pdf"></i>
                View PDF
              </a>
            ` : ''}
          </div>

          <div class="grid grid-cols-2 gap-4 text-sm mb-3">
            <div>
              <span class="font-bold text-slate-700">Category:</span> 
              <span class="text-slate-600">${action.category}</span>
            </div>
            <div>
              <span class="font-bold text-slate-700">Date:</span> 
              <span class="text-slate-600">${action.incident_date}</span>
            </div>
            <div>
              <span class="font-bold text-slate-700">Issued By:</span> 
              <span class="text-slate-600">${action.issued_by}</span>
            </div>
            <div>
              <span class="font-bold text-slate-700">Status:</span> 
              <span class="text-slate-600">${action.status}</span>
            </div>
          </div>

          <div class="bg-white p-3 rounded border border-slate-200">
            <p class="text-sm text-slate-700 font-bold mb-1">Description:</p>
            <p class="text-sm text-slate-600">${action.description}</p>
          </div>
        </div>
      </div>
    `;
  }).join('');
}

// Clear Discipline Form
function clearDisciplineForm() {
  document.getElementById('discipline-form').reset();
  clearSelectedEmployee();
  showToast('Form cleared', 'info');
}

//*****



// Initialize Employee 360 smart features
  if (document.getElementById('edit-compensation-type')) {
    setTimeout(() => {
      console.log('ğŸš€ Initializing Employee 360 features...');
      
      // Setup compensation type switcher
      const compType = document.getElementById('edit-compensation-type');
      const hourlyContainer = document.getElementById('primary-hourly-container');
      const salaryContainer = document.getElementById('primary-salary-container');
      const calcDisplay = document.getElementById('calculated-hourly-display');
      
      if (compType) {
        compType.addEventListener('change', function() {
          if (this.value === 'salary') {
            if (hourlyContainer) hourlyContainer.classList.add('hidden');
            if (salaryContainer) salaryContainer.classList.remove('hidden');
            if (calcDisplay) calcDisplay.classList.remove('hidden');
          } else {
            if (hourlyContainer) hourlyContainer.classList.remove('hidden');
            if (salaryContainer) salaryContainer.classList.add('hidden');
            if (calcDisplay) calcDisplay.classList.add('hidden');
          }
        });
        
        // Trigger initial state
        compType.dispatchEvent(new Event('change'));
      }
      
      // Setup salary calculator
      const salaryInput = document.getElementById('edit-annual-salary');
      if (salaryInput) {
        salaryInput.addEventListener('input', function() {
          const salary = parseFloat(this.value) || 0;
          const jobTitle = document.getElementById('edit-job-title')?.value || '';
          const firstName = document.getElementById('edit-first-name')?.value || '';
          const lastName = document.getElementById('edit-last-name')?.value || '';
          const fullName = `${firstName} ${lastName}`.trim();
          
          let hours = 40;
          if (jobTitle === 'Wok Chef') hours = 50;
          else if (jobTitle === 'Production Manager' || jobTitle === 'Logistic Coordinator') hours = 40;
          else if (fullName === 'Yu Li') hours = 48;
          else if (fullName === 'Xing Cheng' || fullName === 'Xing Cherry') hours = 45;
          
          const hourly = salary / 52 / hours;
          const display = document.getElementById('display-calculated-hourly');
          const formula = document.getElementById('calc-formula-display');
          
          if (display) display.textContent = `$${hourly.toFixed(2)}/hr`;
          if (formula) formula.textContent = `$${salary} Ã· 52 Ã· ${hours} hours`;
          
          document.getElementById('edit-hourly-rate').value = hourly.toFixed(2);
        });
      }
      
      // Setup tenure calculator
      const hireDate = document.getElementById('edit-original-hire-date');
      if (hireDate) {
        hireDate.addEventListener('change', function() {
          if (!this.value) return;
          const start = new Date(this.value);
          const now = new Date();
          let months = (now.getFullYear() - start.getFullYear()) * 12;
          months += now.getMonth() - start.getMonth();
          if (now.getDate() < start.getDate()) months--;
          if (months < 0) months = 0;
          
          const years = Math.floor(months / 12);
          const remMonths = months % 12;
          
          let tenure = '';
          if (years === 0 && remMonths === 0) tenure = 'Less than 1 month';
          else if (years === 0) tenure = `${remMonths} month${remMonths > 1 ? 's' : ''}`;
          else if (remMonths === 0) tenure = `${years} year${years > 1 ? 's' : ''}`;
          else tenure = `${years} year${years > 1 ? 's' : ''}, ${remMonths} month${remMonths > 1 ? 's' : ''}`;
          
          document.getElementById('display-tenure').value = tenure;
        });
        
        // Calculate on load
        if (hireDate.value) hireDate.dispatchEvent(new Event('change'));
      }
      
      // Setup phone formatting
      const phone = document.getElementById('edit-phone-number');
      if (phone) {
        phone.addEventListener('input', function() {
          const cleaned = this.value.replace(/\D/g, '');
          if (cleaned.length <= 3) this.value = cleaned;
          else if (cleaned.length <= 6) this.value = `(${cleaned.slice(0,3)}) ${cleaned.slice(3)}`;
          else this.value = `(${cleaned.slice(0,3)}) ${cleaned.slice(3,6)}-${cleaned.slice(6,10)}`;
        });
      }
      
      
      
      // Setup secondary/tertiary job buttons
      const btnAddSecondary = document.getElementById('btn-add-secondary-job');
      const btnAddTertiary = document.getElementById('btn-add-tertiary-job');
      const btnRemoveSecondary = document.getElementById('btn-remove-secondary-job');
      const btnRemoveTertiary = document.getElementById('btn-remove-tertiary-job');
      const secondaryContainer = document.getElementById('secondary-job-container');
      const tertiaryContainer = document.getElementById('tertiary-job-container');
      
      if (btnAddSecondary) {
        btnAddSecondary.addEventListener('click', () => {
          if (secondaryContainer) secondaryContainer.classList.remove('hidden');
          btnAddSecondary.classList.add('hidden');
          if (btnAddTertiary) btnAddTertiary.classList.remove('hidden');
        });
      }
      
      if (btnRemoveSecondary) {
        btnRemoveSecondary.addEventListener('click', () => {
          if (secondaryContainer) secondaryContainer.classList.add('hidden');
          if (btnAddSecondary) btnAddSecondary.classList.remove('hidden');
          document.getElementById('edit-job-title2').value = '';
          document.getElementById('edit-hourly-rate2').value = '';
        });
      }
      
      if (btnAddTertiary) {
        btnAddTertiary.addEventListener('click', () => {
          if (tertiaryContainer) tertiaryContainer.classList.remove('hidden');
          btnAddTertiary.classList.add('hidden');
        });
      }
      
      if (btnRemoveTertiary) {
        btnRemoveTertiary.addEventListener('click', () => {
          if (tertiaryContainer) tertiaryContainer.classList.add('hidden');
          if (btnAddTertiary) btnAddTertiary.classList.remove('hidden');
          document.getElementById('edit-job-title3').value = '';
          document.getElementById('edit-hourly-rate3').value = '';
        });
      }
      
      console.log('âœ… All Employee 360 features initialized!');
    }, 1000);
  }
























 async function bootstrap() {
  console.log('');
  console.log('ğŸ¬ BOOTSTRAP: Starting application...');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  // ğŸ†• CUSTOM DATE RANGE FUNCTIONALITY
const globalFilter = document.getElementById('global-reports-filter');
const customDateInputs = document.getElementById('custom-date-range-inputs');
const customStartDate = document.getElementById('custom-start-date');
const customEndDate = document.getElementById('custom-end-date');
const applyCustomDates = document.getElementById('apply-custom-dates');

if (globalFilter && customDateInputs) {
  // Show/hide custom date inputs when "Custom" is selected
  globalFilter.addEventListener('change', (e) => {
    if (e.target.value === 'custom') {
      customDateInputs.classList.remove('hidden');
      
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      customStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];
      customEndDate.value = today.toISOString().split('T')[0];
    } else {
      customDateInputs.classList.add('hidden');
      updateReports();
    }
  });
}

// Apply custom date range
if (applyCustomDates) {
  applyCustomDates.addEventListener('click', () => {
    const startVal = customStartDate?.value;
    const endVal = customEndDate?.value;
    
    if (!startVal || !endVal) {
      showToast('Please select both start and end dates', 'error');
      return;
    }
    
    const start = new Date(startVal);
    const end = new Date(endVal);
    
    if (start > end) {
      showToast('Start date must be before end date', 'error');
      return;
    }
    
    console.log('ğŸ“… Applying custom date range:', startVal, 'to', endVal);
    updateReports();
    showToast('Custom date range applied', 'success');
  });
}
  // Check toast container
  const toastContainer = document.getElementById('toast-container');
  if (toastContainer) {
    console.log('âœ… Toast container found');
  } else {
    console.error('âŒ Toast container NOT found!');
  }
  // Load permissions and audit log
if (AppState.currentTab === 'permissions') {
  await loadPermissions();
  await loadPermissionsAuditLog();
}
setupPermissionsAutoSave();
  // Load settings from localStorage
  const savedSettings = localStorage.getItem('jcr-hr-settings');
  if (savedSettings) {
    try {
      AppState.settings = JSON.parse(savedSettings);
      console.log('âœ… Settings loaded from localStorage');
    } catch (e) {
      console.error('âŒ Failed to parse saved settings');
    }
  }

  // Attach event listeners
  console.log('ğŸ”— Attaching event listeners...');
  attachEventListeners();
    setupModalEventListeners(); // â† ADD THIS LINE
// âœ… ADD THESE TWO LINES:
setupDepartmentJobTitleCascade();

setupCompensationTypeSwitcher();

  // Setup policy accordion
  console.log('ğŸ“‹ Setting up policy accordion...');
  setupPolicyAccordion();
  
  // Load admin settings into form
  console.log('âš™ï¸  Loading admin settings...');
  loadAdminSettings();
  
  // Load employee data
  console.log('');
  await loadEmployees();
  renderEmployeeList();
  renderEmployeeGrid();
 


  initCompensationLetterTab(); // â† ADD THIS LINE
  initDisciplineTab(); // â† ADD THIS LINE

  // Setup sticky save button
setupStickySaveButton();

  
  // Initialize dashboard (default tab)
  console.log('');
  console.log('ğŸ¨ Initializing dashboard...');
  showTab('dashboard');
  generate12MonthChart();
  
  console.log('');
  console.log('ğŸ‰ APPLICATION READY!');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}


      // Start the application
      document.addEventListener('DOMContentLoaded', () => {
  bootstrap();
});
// ========================================================================
// ENHANCED REPORTS & ANALYTICS - GLOBAL FILTER SYSTEM
// ========================================================================

// Store chart instances
const ReportsCharts = {
  employeeStatus: null,
  byType: null,
  byDepartment: null,
  byJobTitle: null,
  trend: null
};



// ğŸš€ Tab switching logic
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    // Remove active styles from all
    document.querySelectorAll('.tab-btn').forEach(b => {
      b.classList.remove('border-blue-500', 'text-blue-600');
      b.classList.add('border-transparent', 'text-slate-600');
    });
    document.querySelectorAll('.tab-panel').forEach(p => {
      p.classList.add('hidden');
    });





  // Activate clicked tab
     btn.classList.add('border-blue-500', 'text-blue-600');
    btn.classList.remove('border-transparent', 'text-slate-600');
    
    const tabTarget = btn.dataset.tab;
    document.getElementById(tabTarget).classList.remove('hidden');
  });
});




// ========================================================================
// DISCIPLINE TAB - ENTERPRISE SYSTEM WITH SUBCATEGORIES
// ========================================================================

// Subcategory mapping
const DISCIPLINE_SUBCATEGORIES = {
  'Attendance & Punctuality': [
    'Late Arrival',
    'Early Departure',
    'Unexcused Absence',
    'No Call No Show',
    'Excessive Tardiness',
    'Pattern of Absences'
  ],
  'Performance Issues': [
    'Low Productivity',
    'Quality of Work',
    'Missed Deadlines',
    'Failure to Meet Goals',
    'Lack of Initiative',
    'Skill Deficiency'
  ],
  'Conduct & Behavior': [
    'Disrespectful to Staff/Management',
    'Unprofessional Behavior',
    'Inappropriate Language',
    'Conflict with Coworkers',
    'Dress Code Violation',
    'Use of Phone/Device'
  ],
  'Policy Violations': [
    'Break Time Violation',
    'Cash Handling Error',
    'Uniform Policy',
    'Food Safety Protocol',
    'Eating/Drinking in Wrong Area',
    'Unauthorized Discounts'
  ],
  'Safety & Security': [
    'Safety Protocol Violation',
    'Equipment Misuse',
    'Failure to Report Hazard',
    'Not Wearing Required PPE',
    'Blocking Emergency Exits',
    'Fire Safety Violation'
  ],
  'Customer Service': [
    'Rude to Customer',
    'Order Error',
    'Poor Service Quality',
    'Complaint Received',
    'Refusal to Serve',
    'Argumentative with Guest'
  ],
  'Insubordination': [
    'Refusal to Follow Instructions',
    'Disrespectful to Manager',
    'Walking Out During Shift',
    'Challenging Authority',
    'Ignoring Direct Order'
  ],
  'Harassment': [
    'Verbal Harassment',
    'Sexual Harassment',
    'Bullying',
    'Discrimination',
    'Hostile Work Environment',
    'Retaliation'
  ]
};












// Initialize discipline tab
async function initDisciplineTab() {
  console.log('ğŸ¯ Initializing Discipline Tab...');
  
  // Load employees for selection
  await loadEmployeesForDiscipline();
  
  // Setup event listeners
  setupDisciplineEventListeners();
  
  // Load stats
  updateDisciplineStats();
  
  console.log('âœ… Discipline Tab initialized');
}

// Load employees for discipline dropdown
async function loadEmployeesForDiscipline() {
  try {
    const { data, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('employment_status', 'Active')
      .order('last_name', { ascending: true });

    if (error) throw error;

    DisciplineState.allEmployees = data || [];
    console.log(`âœ… Loaded ${DisciplineState.allEmployees.length} active employees for discipline`);
  } catch (error) {
    console.error('âŒ Error loading employees:', error);
    showToast('Failed to load employees', 'error');
  }
}

// Setup all discipline event listeners
function setupDisciplineEventListeners() {
  // Employee search
  const searchInput = document.getElementById('discipline-employee-search');
  if (searchInput) {
    searchInput.addEventListener('input', handleEmployeeSearch);
    searchInput.addEventListener('focus', handleEmployeeSearch);
  }

  // Main category change triggers subcategory population
  const mainCategory = document.getElementById('discipline-main-category');
  if (mainCategory) {
    mainCategory.addEventListener('change', populateSubcategories);
  }

  // Form submit
  const form = document.getElementById('discipline-form');
  if (form) {
    form.addEventListener('submit', handleDisciplineSubmit);
  }

  // Reset button
  const resetBtn = document.getElementById('discipline-form-reset');
  if (resetBtn) {
    resetBtn.addEventListener('click', () => {
      document.getElementById('discipline-form').reset();
      clearSelectedEmployee();
      showToast('Form cleared', 'info');
    });
  }

  // Refresh button
  const refreshBtn = document.getElementById('discipline-refresh-btn');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      await loadEmployeesForDiscipline();
      updateDisciplineStats();
      showToast('Data refreshed', 'success');
    });
  }

  // Export audit trail button
  const exportBtn = document.getElementById('export-audit-trail');
  if (exportBtn) {
    exportBtn.addEventListener('click', exportAuditTrailPDF);
  }

  // Click outside to close dropdown
  document.addEventListener('click', (e) => {
    const dropdown = document.getElementById('discipline-employee-dropdown');
    const searchInput = document.getElementById('discipline-employee-search');
    if (dropdown && !dropdown.contains(e.target) && e.target !== searchInput) {
      dropdown.classList.add('hidden');
    }
  });
}

// Handle employee search
function handleEmployeeSearch(e) {
  const query = e.target.value.toLowerCase().trim();
  const dropdown = document.getElementById('discipline-employee-dropdown');
  
  if (!dropdown) return;

  if (query.length < 2) {
    dropdown.classList.add('hidden');
    return;
  }

  // Filter employees
  const matches = DisciplineState.allEmployees.filter(emp => {
    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
    const empId = (emp.employee_id || '').toLowerCase();
    return fullName.includes(query) || empId.includes(query);
  });

  // Render dropdown
  if (matches.length === 0) {
    dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-500">No employees found</div>';
    dropdown.classList.remove('hidden');
    return;
  }

  dropdown.innerHTML = matches.slice(0, 10).map(emp => `
    <div 
      class="px-4 py-3 hover:bg-indigo-50 cursor-pointer border-b border-slate-100 transition-all"
      onclick="selectEmployeeForDiscipline(${emp.id})"
    >
      <div class="font-bold text-slate-900">${emp.first_name} ${emp.last_name}</div>
      <div class="text-sm text-slate-600">
        ${emp.employee_id || 'No ID'} â€¢ ${emp.job_title || 'No Title'} â€¢ ${emp.department || 'No Dept'}
      </div>
    </div>
  `).join('');

  dropdown.classList.remove('hidden');
}

// Select employee for discipline action
function selectEmployeeForDiscipline(employeeId) {
  const employee = DisciplineState.allEmployees.find(e => e.id === employeeId);
  if (!employee) return;

  console.log('âœ… Selected employee:', employee);

  // Store in state
  DisciplineState.selectedEmployee = employee;
  AppState.selectedEmployee = employee; // Also store in AppState for compatibility

  // Update hidden field
  const employeeIdField = document.getElementById('discipline-employee-id');
  if (employeeIdField) {
    employeeIdField.value = employee.id;
  }

  // Calculate tenure
  const hireDate = new Date(employee.hire_date || employee.original_hire_date);
  const today = new Date();
  const diffTime = Math.abs(today - hireDate);
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
  const years = Math.floor(diffDays / 365);
  const months = Math.floor((diffDays % 365) / 30);
  const tenure = years > 0 ? `${years}y ${months}m` : `${months}m`;

  // Get initials
  const initials = `${employee.first_name.charAt(0)}${employee.last_name.charAt(0)}`.toUpperCase();

  // Update display
  const display = document.getElementById('selected-employee-display');
  if (display) {
    document.getElementById('employee-initials').textContent = initials;
    document.getElementById('employee-name').textContent = `${employee.first_name} ${employee.last_name}`;
    document.getElementById('employee-details').textContent = 
      `${employee.employee_id || 'No ID'} â€¢ ${employee.job_title || 'No Title'} â€¢ ${employee.department || 'No Dept'} â€¢ Tenure: ${tenure}`;
    display.classList.remove('hidden');
  }

  // Hide dropdown
  const dropdown = document.getElementById('discipline-employee-dropdown');
  if (dropdown) {
    dropdown.classList.add('hidden');
  }

  // Clear search input
  const searchInput = document.getElementById('discipline-employee-search');
  if (searchInput) {
    searchInput.value = '';
  }

  // Load employee's discipline history
  renderDisciplineHistory(employee);
  renderAuditTrail(employee);

  showToast(`Selected: ${employee.first_name} ${employee.last_name}`, 'success');
}

// Clear selected employee
function clearSelectedEmployee() {
  DisciplineState.selectedEmployee = null;
  AppState.selectedEmployee = null;

  const employeeIdField = document.getElementById('discipline-employee-id');
  if (employeeIdField) {
    employeeIdField.value = '';
  }

  const display = document.getElementById('selected-employee-display');
  if (display) {
    display.classList.add('hidden');
  }

  const searchInput = document.getElementById('discipline-employee-search');
  if (searchInput) {
    searchInput.value = '';
  }

  // Clear history
  const historyContainer = document.getElementById('discipline-history-timeline');
  if (historyContainer) {
    historyContainer.innerHTML = `
      <div class="text-center py-12 text-slate-400">
        <i class="fas fa-clipboard-list text-6xl mb-4 opacity-30"></i>
        <p class="text-lg font-bold text-slate-500">No history available</p>
        <p class="text-sm text-slate-400">Select an employee to view their disciplinary history</p>
      </div>
    `;
  }

  // Clear audit trail
  const auditBody = document.getElementById('audit-trail-body');
  if (auditBody) {
    auditBody.innerHTML = `
      <tr>
        <td colspan="5" class="px-4 py-8 text-center text-slate-400">
          Select an employee to view audit trail
        </td>
      </tr>
    `;
  }
}

// Populate subcategories based on main category
function populateSubcategories(e) {
  const mainCategory = e.target.value;
  const subCategorySelect = document.getElementById('discipline-sub-category');
  
  if (!subCategorySelect) return;

  // Clear existing options
  subCategorySelect.innerHTML = '<option value="">-- Select Sub-Category --</option>';

  if (!mainCategory || !DISCIPLINE_SUBCATEGORIES[mainCategory]) {
    subCategorySelect.disabled = true;
    return;
  }

  // Enable and populate
  subCategorySelect.disabled = false;
  
  DISCIPLINE_SUBCATEGORIES[mainCategory].forEach(sub => {
    const option = document.createElement('option');
    option.value = sub;
    option.textContent = sub;
    subCategorySelect.appendChild(option);
  });
}










// Render discipline history timeline
// Render discipline history timeline with PDF options
function renderDisciplineHistory(employee) {
  const container = document.getElementById('discipline-history-timeline');
  if (!container) return;

  const history = employee.discipline_history || [];

  if (history.length === 0) {
    container.innerHTML = `
      <div class="text-center py-8 text-slate-400">
        <i class="fas fa-check-circle text-5xl mb-3 opacity-30 text-emerald-500"></i>
        <p class="text-base font-bold text-slate-500">Clean Record</p>
        <p class="text-sm text-slate-400">No disciplinary actions on file</p>
      </div>
    `;
    return;
  }

  // Sort by date descending
  const sorted = [...history].sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));

  container.innerHTML = sorted.map((action, index) => {
    const severityColors = {
      'Low': 'bg-emerald-100 text-emerald-800 border-emerald-300',
      'Medium': 'bg-amber-100 text-amber-800 border-amber-300',
      'High': 'bg-orange-100 text-orange-800 border-orange-300',
      'LOW': 'bg-emerald-100 text-emerald-800 border-emerald-300',
      'MEDIUM': 'bg-amber-100 text-amber-800 border-amber-300',
      'HIGH': 'bg-orange-100 text-orange-800 border-orange-300'
    };

const actionDate = new Date(action.date || action.timestamp).toLocaleDateString('en-US', {      month: 'short',
      day: 'numeric',
      year: 'numeric'
    });

    // Generate a unique identifier for this action (using timestamp + type)
    const actionId = `${action.timestamp || action.date}_${action.type}`.replace(/[^a-zA-Z0-9]/g, '_');

    return `
      <div class="relative pl-8 pb-8 ${index === sorted.length - 1 ? '' : 'border-l-4 border-slate-200'}">
        <div class="absolute left-0 top-0 w-4 h-4 rounded-full bg-indigo-500 border-4 border-white -translate-x-2"></div>
        <div class="bg-white border-2 border-slate-200 rounded-lg p-4 hover:shadow-md transition-all">
          <div class="flex items-start justify-between mb-3">
            <div>
              <span class="inline-block px-3 py-1 rounded-full text-xs font-bold ${severityColors[action.severity] || 'bg-slate-100 text-slate-800'} border">
                ${action.type || 'UNKNOWN'}
              </span>
            </div>
            <div class="text-sm text-slate-500">${actionDate}</div>
          </div>
          
          <div class="space-y-2 text-sm mb-3">
            <div class="text-slate-700">
              <strong>Category:</strong> ${action.main_category || action.category || 'Not specified'}
            </div>
            ${action.sub_category ? `<div class="text-slate-600"><strong>Sub-Category:</strong> ${action.sub_category}</div>` : ''}
            <div class="text-slate-600">${action.reason || 'No description provided'}</div>
            ${action.manager_signature ? `<div class="text-xs text-slate-500 mt-2">Issued by: ${action.manager_signature}</div>` : ''}
            ${action.reference ? `<div class="text-xs text-slate-500">Ref: ${action.reference}</div>` : ''}
          </div>

          <!-- Action Buttons -->
          <div class="flex gap-2 pt-3 border-t border-slate-200">
            <button 
              onclick="viewDisciplinePDF('${actionId}', ${employee.id}, ${index})"
              class="flex-1 px-3 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600 transition-all text-xs font-bold flex items-center justify-center gap-2"
            >
              <i class="fas fa-file-pdf"></i>
              <span>View PDF</span>
            </button>
            <button 
              onclick="editDisciplineAction(${employee.id}, ${index})"
              class="flex-1 px-3 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 transition-all text-xs font-bold flex items-center justify-center gap-2"
            >
              <i class="fas fa-edit"></i>
              <span>Edit</span>
            </button>
            <button 
              onclick="regenerateDisciplinePDF(${employee.id}, ${index})"
              class="px-3 py-2 bg-emerald-500 text-white rounded-lg hover:bg-emerald-600 transition-all text-xs font-bold flex items-center gap-2"
            >
              <i class="fas fa-sync-alt"></i>
              <span>Regenerate PDF</span>
            </button>
          </div>
        </div>
      </div>
    `;
  }).join('');
}



// View PDF for a specific discipline action
async function viewDisciplinePDF(actionId, employeeId, historyIndex) {
  try {
    showToast('Loading PDF...', 'info');

    // Get employee data
    const { data: employee, error: empError } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (empError) throw empError;

    const action = employee.discipline_history[historyIndex];
    
    if (!action) {
      showToast('Action not found', 'error');
      return;
    }

    // Generate PDF for this specific action
    await generateDisciplinePDFFromHistory(employee, action);

  } catch (error) {
    console.error('âŒ Error viewing PDF:', error);
    showToast('Failed to load PDF', 'error');
  }
}

// Regenerate PDF for a specific action
async function regenerateDisciplinePDF(employeeId, historyIndex) {
  try {
    showToast('Regenerating PDF...', 'info');

    const { data: employee, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (error) throw error;

    const action = employee.discipline_history[historyIndex];
    
    if (!action) {
      showToast('Action not found', 'error');
      return;
    }

    await generateDisciplinePDFFromHistory(employee, action);
    showToast('âœ… PDF regenerated successfully!', 'success');

  } catch (error) {
    console.error('âŒ Error regenerating PDF:', error);
    showToast('Failed to regenerate PDF', 'error');
  }
}




// Edit discipline action
// Edit discipline action
async function editDisciplineAction(employeeId, historyIndex) {
  try {
    const { data: employee, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (error) throw error;

    const action = employee.discipline_history[historyIndex];
    
    if (!action) {
      showToast('Action not found', 'error');
      return;
    }

    // â­ ENABLE EDIT MODE
    window.disciplineEditMode = {
      isEditing: true,
      employeeId: employeeId,
      historyIndex: historyIndex
    };

    // Populate form with existing data
    document.getElementById('discipline-action-type').value = action.type || '';
    document.getElementById('discipline-action-date').value = action.date || '';
    document.getElementById('discipline-severity').value = action.severity || '';
    document.getElementById('discipline-main-category').value = action.main_category || action.category || '';
    
    // Trigger subcategory population
    const mainCategorySelect = document.getElementById('discipline-main-category');
    const event = new Event('change');
    mainCategorySelect.dispatchEvent(event);
    
    // Set subcategory after a short delay
    setTimeout(() => {
      document.getElementById('discipline-sub-category').value = action.sub_category || '';
    }, 100);

    document.getElementById('discipline-reference').value = action.reference || '';
    document.getElementById('discipline-reason').value = action.reason || '';
    document.getElementById('discipline-plan').value = action.corrective_plan || '';
    document.getElementById('discipline-manager-signature').value = action.manager_signature || '';
    document.getElementById('discipline-hr-signature').value = action.hr_signature || '';
    document.getElementById('discipline-employee-signature').value = action.employee_signature === 'DECLINED' ? '' : (action.employee_signature || '');
    document.getElementById('discipline-employee-declined').checked = action.employee_signature === 'DECLINED';

    // â­ UPDATE BUTTON TEXT
    const submitBtn = document.getElementById('discipline-form-submit');
    const submitText = submitBtn.querySelector('#discipline-form-submit-text span');
    if (submitText) {
      submitText.innerHTML = '<i class="fas fa-save mr-2"></i>Update Action';
    }

    // Change button color to indicate edit mode
    submitBtn.classList.remove('from-indigo-600', 'to-blue-600', 'hover:from-indigo-700', 'hover:to-blue-700');
    submitBtn.classList.add('from-amber-600', 'to-orange-600', 'hover:from-amber-700', 'hover:to-orange-700');

    // Scroll to form
    document.getElementById('discipline-form').scrollIntoView({ behavior: 'smooth', block: 'start' });

    showToast('ğŸ“ Editing action - modify fields and click "Update Action" to save changes', 'info');

  } catch (error) {
    console.error('âŒ Error loading action for edit:', error);
    showToast('Failed to load action', 'error');
  }
}






// Generate PDF from history object
async function generateDisciplinePDFFromHistory(employee, action) {
  const pdfHTML = `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>
        @page { margin: 0.75in; }
        body { 
          font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
          font-size: 11pt;
          line-height: 1.6;
          color: #333;
        }
        .header {
          text-align: center;
          border-bottom: 3px solid #4F46E5;
          padding-bottom: 20px;
          margin-bottom: 30px;
        }
        .company-name {
          font-size: 24pt;
          font-weight: bold;
          color: #1E40AF;
          margin-bottom: 5px;
        }
        .document-title {
          font-size: 16pt;
          font-weight: bold;
          color: #475569;
          margin-top: 10px;
        }
        .section {
          margin-bottom: 25px;
          page-break-inside: avoid;
        }
        .section-title {
          font-size: 13pt;
          font-weight: bold;
          color: #1E40AF;
          border-bottom: 2px solid #E2E8F0;
          padding-bottom: 5px;
          margin-bottom: 15px;
        }
        .info-grid {
          display: grid;
          grid-template-columns: 1fr 1fr;
          gap: 15px;
          margin-bottom: 15px;
        }
        .info-item {
          margin-bottom: 10px;
        }
        .label {
          font-weight: bold;
          color: #64748B;
          font-size: 9pt;
          text-transform: uppercase;
          letter-spacing: 0.5px;
        }
        .value {
          color: #1E293B;
          font-size: 11pt;
          margin-top: 3px;
        }
        .description-box {
          background: #F8FAFC;
          border: 1px solid #E2E8F0;
          border-radius: 6px;
          padding: 15px;
          margin: 15px 0;
          white-space: pre-wrap;
        }
        .signature-section {
          margin-top: 40px;
          page-break-inside: avoid;
        }
        .signature-grid {
          display: grid;
          grid-template-columns: 1fr 1fr 1fr;
          gap: 30px;
          margin-top: 30px;
        }
        .signature-block {
          border-top: 2px solid #1E293B;
          padding-top: 10px;
        }
        .signature-name {
          font-weight: bold;
          font-size: 12pt;
          margin-bottom: 5px;
        }
        .signature-date {
          font-size: 9pt;
          color: #64748B;
        }
        .footer {
          margin-top: 50px;
          padding-top: 20px;
          border-top: 1px solid #E2E8F0;
          font-size: 8pt;
          color: #94A3B8;
          text-align: center;
        }
        .severity-badge {
          display: inline-block;
          padding: 4px 12px;
          border-radius: 4px;
          font-weight: bold;
          font-size: 10pt;
        }
        .severity-low { background: #D1FAE5; color: #065F46; }
        .severity-medium { background: #FEF3C7; color: #92400E; }
        .severity-high { background: #FEE2E2; color: #991B1B; }
        .watermark {
          position: fixed;
          top: 50%;
          left: 50%;
          transform: translate(-50%, -50%) rotate(-45deg);
          font-size: 72pt;
          color: rgba(79, 70, 229, 0.05);
          font-weight: bold;
          z-index: -1;
        }
      </style>
    </head>
    <body>
      <div class="watermark">CONFIDENTIAL</div>
      
      <div class="header">
        <div class="company-name">Jeng Chi Restaurant</div>
        <div style="color: #64748B; font-size: 10pt;">Richardson, Texas</div>
        <div class="document-title">Employee Corrective Action Form</div>
      </div>

      <div class="section">
        <div class="section-title">Employee Information</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Employee Name</div>
            <div class="value">${employee.first_name} ${employee.last_name}</div>
          </div>
          <div class="info-item">
            <div class="label">Employee ID</div>
            <div class="value">${employee.employee_id || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="label">Position</div>
            <div class="value">${employee.job_title || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="label">Department</div>
            <div class="value">${employee.department || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="label">Hire Date</div>
            <div class="value">${employee.hire_date ? new Date(employee.hire_date).toLocaleDateString() : 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="label">Action Date</div>
            <div class="value">${new Date(action.date || action.timestamp).toLocaleDateString()}</div>
          </div>
        </div>
      </div>

      <div class="section">
        <div class="section-title">Action Details</div>
        <div class="info-grid">
          <div class="info-item">
            <div class="label">Type of Action</div>
            <div class="value">${(action.type || 'UNKNOWN').replace(/_/g, ' ')}</div>
          </div>
          <div class="info-item">
            <div class="label">Severity Level</div>
            <div class="value">
              <span class="severity-badge severity-${(action.severity || 'low').toLowerCase()}">
                ${action.severity || 'N/A'}
              </span>
            </div>
          </div>
          <div class="info-item">
            <div class="label">Category</div>
            <div class="value">${action.main_category || action.category || 'N/A'}</div>
          </div>
          <div class="info-item">
            <div class="label">Sub-Category</div>
            <div class="value">${action.sub_category || 'N/A'}</div>
          </div>
          ${action.reference ? `
          <div class="info-item">
            <div class="label">Reference Number</div>
            <div class="value">${action.reference}</div>
          </div>
          ` : ''}
        </div>
      </div>

      <div class="section">
        <div class="section-title">Description of Incident</div>
        <div class="description-box">
          ${action.reason || 'No description provided'}
        </div>
      </div>

      ${action.corrective_plan ? `
      <div class="section">
        <div class="section-title">Corrective Action Plan</div>
        <div class="description-box">
          ${action.corrective_plan}
        </div>
      </div>
      ` : ''}

      <div class="signature-section">
        <div class="section-title">Acknowledgment & Signatures</div>
        
        <div class="signature-grid">
          <div class="signature-block">
            <div class="signature-name">${action.manager_signature || '___________________'}</div>
            <div class="label">Manager Signature</div>
            <div class="signature-date">Date: ${action.date ? new Date(action.date).toLocaleDateString() : '___________'}</div>
          </div>

          ${action.hr_signature ? `
          <div class="signature-block">
            <div class="signature-name">${action.hr_signature}</div>
            <div class="label">HR Representative</div>
            <div class="signature-date">Date: ${action.date ? new Date(action.date).toLocaleDateString() : '___________'}</div>
          </div>
          ` : ''}

          <div class="signature-block">
            <div class="signature-name">${action.employee_signature === 'DECLINED' ? 'DECLINED TO SIGN' : (action.employee_signature || '___________________')}</div>
            <div class="label">Employee Signature</div>
            <div class="signature-date">Date: ${action.date ? new Date(action.date).toLocaleDateString() : '___________'}</div>
          </div>
        </div>

        ${action.employee_signature === 'DECLINED' ? `
        <div style="margin-top: 20px; padding: 15px; background: #FEF3C7; border: 1px solid #F59E0B; border-radius: 6px;">
          <strong>Note:</strong> Employee declined to sign. Action is acknowledged only, and a signed copy will be provided per company policy.
        </div>
        ` : ''}
      </div>

      <div class="footer">
        <p>This document is confidential and protected under applicable employment laws.</p>
        <p>Jeng Chi Restaurant | Richardson, Texas | Generated: ${new Date().toLocaleString()}</p>
      </div>
    </body>
    </html>
  `;

  // Open PDF in new window
  const printWindow = window.open('', '_blank', 'width=800,height=1000');
  printWindow.document.write(pdfHTML);
  printWindow.document.close();
  
  // Wait a moment for content to load, then trigger print
  setTimeout(() => {
    printWindow.print();
  }, 500);
}










// Render audit trail table
function renderAuditTrail(employee) {
  const tbody = document.getElementById('audit-trail-body');
  if (!tbody) return;

  const history = employee.discipline_history || [];

  if (history.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" class="px-4 py-8 text-center text-slate-400">
          No audit trail entries
        </td>
      </tr>
    `;
    
    // â­ HIDE CHART IF NO DATA
    const chartContainer = document.getElementById('audit-chart-container');
    if (chartContainer) {
      chartContainer.classList.add('hidden');
    }
    return;
  }

  // Sort by date descending for table
  const sorted = [...history].sort((a, b) => new Date(b.timestamp || b.date) - new Date(a.timestamp || a.date));

  tbody.innerHTML = sorted.map(action => {
    const actionDate = new Date(action.timestamp || action.date).toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      year: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });

    const severityColors = {
      'Low': 'text-emerald-700',
      'Medium': 'text-amber-700',
      'High': 'text-orange-700',
      'LOW': 'text-emerald-700',
      'MEDIUM': 'text-amber-700',
      'HIGH': 'text-orange-700'
    };

    return `
      <tr class="hover:bg-slate-50">
        <td class="px-4 py-3 text-slate-600">${actionDate}</td>
        <td class="px-4 py-3 font-medium text-slate-900">${action.type || 'UNKNOWN'}</td>
        <td class="px-4 py-3 font-bold ${severityColors[action.severity] || 'text-slate-600'}">${action.severity || '--'}</td>
        <td class="px-4 py-3 text-slate-600">${action.manager_signature || 'System'}</td>
        <td class="px-4 py-3 text-slate-600">${action.reference || '--'}</td>
      </tr>
    `;
  }).join('');

  // â­ RENDER THE CHART
  renderAuditChart(employee);
}

// Update discipline stats
function updateDisciplineStats() {
  const employees = AppState.employees || [];

  let verbalCount = 0;
  let writtenCount = 0;
  let finalCount = 0;
  let terminationCount = 0;

  employees.forEach(emp => {
    verbalCount += emp.verbal_warning_count || 0;
    writtenCount += emp.disciplinary_warning_count || 0;
    finalCount += emp.final_warning_count || 0;
    terminationCount += emp.termination_letter_count || 0;
  });

  document.getElementById('stat-verbal').textContent = verbalCount;
  document.getElementById('stat-written').textContent = writtenCount;
  document.getElementById('stat-final').textContent = finalCount;
  document.getElementById('stat-terminations').textContent = terminationCount;
}

// Export audit trail to PDF
async function exportAuditTrailPDF() {
  if (!DisciplineState.selectedEmployee) {
    showToast('Please select an employee first', 'error');
    return;
  }

  showToast('Generating audit trail PDF...', 'info');
  
  // This would integrate with your PDF generation system
  console.log('Export audit trail for:', DisciplineState.selectedEmployee);
  
  showToast('PDF export feature coming soon', 'info');
}



document.querySelectorAll('.tab-trigger').forEach(btn => {
  btn.addEventListener('click', () => {
    const target = btn.dataset.tabTarget;

    // Hide all panels
    document.querySelectorAll('.tab-panel').forEach(p => {
      p.classList.add('hidden');
    });

    // Show selected panel
    const panel = document.getElementById(`tab-${target}`);
    if (panel) {
      panel.classList.remove('hidden');
    }
  });
});



// ============================================
// PAYROLL ADVANCE DASHBOARD
// ============================================

const payrollSupabase = window.supabase.createClient(
  'https://kpldzwlftkvjjntgsqxx.supabase.co',
"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs");

async function loadPayrollAdvanceDashboard() {
  try {
    console.log('ğŸ“Š Loading Payroll Advance Dashboard...');
    
    const { data: advances, error } = await payrollSupabase
      .from('payroll_advances')
      .select('employee_id, employee_name, status, approved_amount, requested_amount, pdf_url');
    
    if (error) throw error;
    
    // Group by employee
    const employeeMap = {};
    
    advances.forEach(adv => {
      const empId = adv.employee_id;
      
      if (!employeeMap[empId]) {
        employeeMap[empId] = {
          employee_id: empId,
          employee_name: adv.employee_name,
          approved_count: 0,
          denied_count: 0,
          total_balance: 0,
          pdf_urls: []
        };
      }
      
      if (adv.status === 'approved') {
        employeeMap[empId].approved_count++;
        employeeMap[empId].total_balance += (adv.approved_amount || adv.requested_amount || 0);
        if (adv.pdf_url) {
          employeeMap[empId].pdf_urls.push(adv.pdf_url);
        }
      } else if (adv.status === 'denied') {
        employeeMap[empId].denied_count++;
      }
    });
    
    const employees = Object.values(employeeMap)
      .filter(emp => emp.approved_count > 0 || emp.denied_count > 0)
      .sort((a, b) => b.total_balance - a.total_balance);
    
    renderPayrollAdvanceDashboard(employees);
    
  } catch (error) {
    console.error('âŒ Error:', error);
    document.getElementById('payroll-advance-dashboard-body').innerHTML = `
      <tr><td colspan="5" class="px-4 py-8 text-center text-red-500">
        <i class="fa-solid fa-exclamation-triangle text-2xl mb-2"></i>
        <p>Error: ${error.message}</p>
      </td></tr>`;
  }
}





function renderPayrollAdvanceDashboard(employees) {
  const tbody = document.getElementById('payroll-advance-dashboard-body');
  
  if (!employees || employees.length === 0) {
    tbody.innerHTML = `
      <tr><td colspan="6" class="px-1.5 py-6 text-center text-slate-400">
        <i class="fa-solid fa-inbox text-2xl mb-1"></i>
        <p class="text-xs">No payroll advances found</p>
      </td></tr>`;
    return;
  }
  
  tbody.innerHTML = employees.map(emp => {
    const approvedCount = emp.approved_count || 0;
    const deniedCount = emp.denied_count || 0;
    const totalAdvances = approvedCount + deniedCount;
    const maxAdvances = 6;
    const totalBalance = emp.total_balance || 0;
    const remaining = maxAdvances - totalAdvances;
    
    return `
      <tr class="hover:bg-slate-50 transition">
        <!-- Employee (Tighter) -->
        <td class="px-1.5 py-2.5">
          <div class="flex items-center gap-1.5">
            <div class="h-7 w-7 rounded bg-blue-100 flex items-center justify-center flex-shrink-0">
              <span class="font-semibold text-blue-700" style="font-size: 10px;">${(emp.employee_name || 'NA').substring(0, 2).toUpperCase()}</span>
            </div>
            <div class="min-w-0">
              <p class="font-medium text-slate-900 text-xs truncate">${emp.employee_name || 'Unknown'}</p>
              <p class="text-slate-500" style="font-size: 10px;">${emp.employee_id || 'N/A'}</p>
            </div>
          </div>
        </td>
        
        <!-- Approved -->
        <td class="px-1.5 py-2.5 text-center">
          <span class="inline-flex items-center justify-center w-6 h-6 rounded text-xs font-semibold ${approvedCount > 0 ? 'bg-emerald-50 text-emerald-700' : 'bg-slate-100 text-slate-400'}">
            ${approvedCount}
          </span>
        </td>
        
        <!-- Denied -->
        <td class="px-1.5 py-2.5 text-center">
          <span class="inline-flex items-center justify-center w-6 h-6 rounded text-xs font-semibold ${deniedCount > 0 ? 'bg-slate-200 text-slate-600' : 'bg-slate-100 text-slate-400'}">
            ${deniedCount}
          </span>
        </td>
        
        <!-- Used / Max -->
        <td class="px-1.5 py-2.5 text-center">
          <div class="flex flex-col items-center">
            <span class="font-semibold text-xs ${remaining <= 1 ? 'text-amber-600' : 'text-slate-900'}">
              ${totalAdvances}/6
            </span>
            <span class="text-slate-400" style="font-size: 9px;">${remaining} left</span>
          </div>
        </td>
        
        <!-- Balance -->
        <td class="px-1.5 py-2.5 text-right">
          <span class="font-semibold text-xs ${totalBalance > 0 ? 'text-slate-900' : 'text-slate-400'}">
            $${totalBalance.toFixed(2)}
          </span>
        </td>
        
        <!-- Actions -->
        <td class="px-1.5 py-2.5 text-center">
          ${approvedCount > 0 ? `
            <button 
              onclick="showAdvanceDocuments('${emp.employee_id}', '${emp.employee_name}')" 
              class="inline-flex items-center gap-0.5 px-2 py-1 bg-slate-700 text-white rounded text-xs font-semibold hover:bg-slate-800 transition"
              title="View ${approvedCount} document${approvedCount > 1 ? 's' : ''}">
              <span>${approvedCount}</span>
              <i class="fa-solid fa-file" style="font-size: 10px;"></i>
            </button>
          ` : `
            <span class="text-slate-400 text-xs">â€”</span>
          `}
        </td>
      </tr>
    `;
  }).join('');
}









// NEW FUNCTION: Show individual advance documents
async function showAdvanceDocuments(employeeId, employeeName) {
  try {
    console.log(`ğŸ“„ Loading advances for ${employeeName}...`);
    
    // Fetch all approved advances for this employee
    const { data: advances, error } = await payrollSupabase
      .from('payroll_advances')
      .select('id, approved_amount, created_at, pdf_url, payroll_period_start, payroll_period_end')
      .eq('employee_id', employeeId)
      .eq('status', 'approved')
      .order('created_at', { ascending: false });
    
    if (error) throw error;
    
    if (!advances || advances.length === 0) {
      alert('No approved advances found for this employee');
      return;
    }
    
    // Create modal content
    const modalContent = `
      <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" onclick="closeAdvanceModal(event)">
        <div class="bg-white rounded-lg shadow-xl max-w-3xl w-full mx-4 max-h-[85vh] overflow-hidden" onclick="event.stopPropagation()">
          <!-- Header -->
          <div class="bg-gradient-to-r from-slate-700 to-slate-800 px-6 py-4 flex items-center justify-between">
            <div>
              <h3 class="text-lg font-semibold text-white">${employeeName}</h3>
              <p class="text-xs text-slate-300 mt-0.5">${advances.length} Approved Advance${advances.length > 1 ? 's' : ''} â€¢ Total: $${advances.reduce((sum, a) => sum + (a.approved_amount || 0), 0).toFixed(2)}</p>
            </div>
            <button onclick="closeAdvanceModal()" class="text-white hover:text-slate-200 transition">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
          
          <!-- Content -->
          <div class="p-6 overflow-y-auto max-h-[calc(85vh-120px)]">
            <table class="w-full text-sm">
              <thead class="bg-slate-50 border-b">
                <tr>
                  <th class="px-3 py-2.5 text-left text-xs font-semibold text-slate-700">Request Date</th>
                  <th class="px-3 py-2.5 text-left text-xs font-semibold text-slate-700">Pay Period</th>
                  <th class="px-3 py-2.5 text-right text-xs font-semibold text-slate-700">Amount</th>
                  <th class="px-3 py-2.5 text-center text-xs font-semibold text-slate-700">Document</th>
                </tr>
              </thead>
              <tbody class="divide-y divide-slate-100">
                ${advances.map((adv, index) => {
                  const requestDate = new Date(adv.created_at).toLocaleDateString('en-US', { 
                    month: 'short', 
                    day: 'numeric', 
                    year: 'numeric' 
                  });
                  const periodStart = adv.payroll_period_start ? new Date(adv.payroll_period_start).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'â€”';
                  const periodEnd = adv.payroll_period_end ? new Date(adv.payroll_period_end).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }) : 'â€”';
                  
                  return `
                    <tr class="hover:bg-slate-50 transition">
                      <td class="px-3 py-3 text-sm text-slate-900 font-medium">${requestDate}</td>
                      <td class="px-3 py-3 text-xs text-slate-600">${periodStart} â€“ ${periodEnd}</td>
                      <td class="px-3 py-3 text-right font-semibold text-sm text-slate-900">$${(adv.approved_amount || 0).toFixed(2)}</td>
                      <td class="px-3 py-3 text-center">
                        ${adv.pdf_url ? `
                          <button 
                            onclick="window.open('${adv.pdf_url}', '_blank')" 
                            class="inline-flex items-center gap-1.5 px-3 py-1.5 bg-slate-700 text-white rounded text-xs font-medium hover:bg-slate-800 transition shadow-sm">
                            <i class="fa-solid fa-file-pdf"></i> View PDF
                          </button>
                        ` : `
                          <span class="text-xs text-slate-400">No PDF available</span>
                        `}
                      </td>
                    </tr>
                  `;
                }).join('')}
              </tbody>
            </table>
          </div>
          
          <!-- Footer -->
          <div class="bg-slate-50 px-6 py-4 flex justify-end border-t">
            <button 
              onclick="closeAdvanceModal()" 
              class="px-4 py-2 bg-slate-700 text-white rounded text-sm font-medium hover:bg-slate-800 transition shadow-sm">
              Close
            </button>
          </div>
        </div>
      </div>
    `;
    
    // Add modal to page
    const modalDiv = document.createElement('div');
    modalDiv.id = 'advance-modal';
    modalDiv.innerHTML = modalContent;
    document.body.appendChild(modalDiv);
    
  } catch (error) {
    console.error('âŒ Error loading documents:', error);
    alert('Failed to load documents: ' + error.message);
  }
}


// Close modal function
function closeAdvanceModal(event) {
  // Close if clicking backdrop or close button
  if (!event || event.target === event.currentTarget) {
    const modal = document.getElementById('advance-modal');
    if (modal) modal.remove();
  }
}


function openAllPDFs(pdfUrls) {
  if (!pdfUrls || pdfUrls.length === 0) return;
  pdfUrls.forEach((url, i) => {
    setTimeout(() => window.open(url, `_blank_${i}`), i * 300);
  });
}

// Auto-load
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', loadPayrollAdvanceDashboard);
} else {
  loadPayrollAdvanceDashboard();
}


// ============================================================================
// PHONE NUMBER AUTO-FORMATTING
// ============================================================================

function formatPhoneNumber(input) {
  // Remove all non-digits
  const cleaned = input.replace(/\D/g, '');
  
  // Format as (XXX) XXX-XXXX
  if (cleaned.length <= 3) {
    return cleaned;
  } else if (cleaned.length <= 6) {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3)}`;
  } else {
    return `(${cleaned.slice(0, 3)}) ${cleaned.slice(3, 6)}-${cleaned.slice(6, 10)}`;
  }
}

function setupPhoneFormatting() {
  const phoneInput = document.getElementById('edit-phone-number');
  if (!phoneInput) return;

  phoneInput.addEventListener('input', (e) => {
    const cursorPosition = e.target.selectionStart;
    const oldLength = e.target.value.length;
    
    e.target.value = formatPhoneNumber(e.target.value);
    
    const newLength = e.target.value.length;
    const lengthDiff = newLength - oldLength;
    
    // Adjust cursor position
    e.target.setSelectionRange(cursorPosition + lengthDiff, cursorPosition + lengthDiff);
  });
}


// ============================================================================
// SALARY CALCULATION WITH SPECIAL RULES
// ============================================================================

function calculateHourlyFromSalary() {
  const salaryInput = document.getElementById('edit-annual-salary');
  const displayEl = document.getElementById('display-calculated-hourly');
  const formulaEl = document.getElementById('calc-formula-display');
  
  if (!salaryInput || !displayEl) return;

  const salary = parseFloat(salaryInput.value) || 0;
  
  if (salary === 0) {
    displayEl.textContent = '--';
    formulaEl.textContent = 'Enter annual salary to calculate';
    return;
  }

  const firstName = document.getElementById('edit-first-name').value.trim();
  const lastName = document.getElementById('edit-last-name').value.trim();
  const jobTitle = document.getElementById('edit-job-title').value.trim();
  const fullName = `${firstName} ${lastName}`.trim();

  let weeklyHours = 40; // Default
  let formula = 'Annual Salary Ã· 52 weeks Ã· 40 hours';

  // Special rules
  if (jobTitle === 'Wok Chef') {
    weeklyHours = 50;
    formula = 'Annual Salary Ã· 52 weeks Ã· 50 hours (Wok Chef)';
  } else if (jobTitle === 'Production Manager' || jobTitle === 'Logistic Coordinator') {
    weeklyHours = 40;
    formula = `Annual Salary Ã· 52 weeks Ã· 40 hours (${jobTitle})`;
  } else if (fullName === 'Yu Li') {
    weeklyHours = 48;
    formula = 'Annual Salary Ã· 52 weeks Ã· 48 hours (Yu Li special)';
  } else if (fullName === 'Xing Cheng' || fullName === 'Xing Cherry') {
    weeklyHours = 45;
    formula = 'Annual Salary Ã· 52 weeks Ã· 45 hours (Xing special)';
  }

  const hourlyRate = salary / 52 / weeklyHours;
  
  displayEl.textContent = hourlyRate.toLocaleString('en-US', {
    style: 'currency',
    currency: 'USD',
    minimumFractionDigits: 2,
    maximumFractionDigits: 2
  });
  
  formulaEl.textContent = formula;

  // Auto-fill the hourly rate field
  document.getElementById('edit-hourly-rate').value = hourlyRate.toFixed(2);
}

// ============================================================================
// COMPENSATION TYPE SWITCHER
// ============================================================================

function setupCompensationSwitcher() {
  const compTypeSelect = document.getElementById('edit-compensation-type');
  const hourlyContainer = document.getElementById('primary-hourly-container');
  const salaryContainer = document.getElementById('primary-salary-container');
  const calculatedDisplay = document.getElementById('calculated-hourly-display');
  const salaryInput = document.getElementById('edit-annual-salary');

  if (!compTypeSelect) return;

  function toggleCompensationType() {
    const type = compTypeSelect.value;

    if (type === 'salary') {
      hourlyContainer?.classList.add('hidden');
      salaryContainer?.classList.remove('hidden');
      calculatedDisplay?.classList.remove('hidden');
      calculateHourlyFromSalary();
    } else {
      hourlyContainer?.classList.remove('hidden');
      salaryContainer?.classList.add('hidden');
      calculatedDisplay?.classList.add('hidden');
    }
  }

  compTypeSelect.addEventListener('change', toggleCompensationType);
  
  // Recalculate when salary changes
  salaryInput?.addEventListener('input', calculateHourlyFromSalary);
  
  // Recalculate when name or job title changes
  ['edit-first-name', 'edit-last-name', 'edit-job-title'].forEach(id => {
    document.getElementById(id)?.addEventListener('change', calculateHourlyFromSalary);
  });

  toggleCompensationType();
}

// ============================================================================
// SECONDARY/TERTIARY JOB BUTTONS
// ============================================================================

function setupJobButtons() {
  const btnAddSecondary = document.getElementById('btn-add-secondary-job');
  const btnRemoveSecondary = document.getElementById('btn-remove-secondary-job');
  const secondaryContainer = document.getElementById('secondary-job-container');
  
  const btnAddTertiary = document.getElementById('btn-add-tertiary-job');
  const btnRemoveTertiary = document.getElementById('btn-remove-tertiary-job');
  const tertiaryContainer = document.getElementById('tertiary-job-container');

  // Add Secondary Job
  btnAddSecondary?.addEventListener('click', () => {
    secondaryContainer?.classList.remove('hidden');
    btnAddSecondary?.classList.add('hidden');
    btnAddTertiary?.classList.remove('hidden');
  });

  // Remove Secondary Job
  btnRemoveSecondary?.addEventListener('click', () => {
    secondaryContainer?.classList.add('hidden');
    btnAddSecondary?.classList.remove('hidden');
    document.getElementById('edit-job-title2').value = '';
    document.getElementById('edit-hourly-rate2').value = '';
  });

  // Add Tertiary Job
  btnAddTertiary?.addEventListener('click', () => {
    tertiaryContainer?.classList.remove('hidden');
    btnAddTertiary?.classList.add('hidden');
  });

  // Remove Tertiary Job
  btnRemoveTertiary?.addEventListener('click', () => {
    tertiaryContainer?.classList.add('hidden');
    btnAddTertiary?.classList.remove('hidden');
    document.getElementById('edit-job-title3').value = '';
    document.getElementById('edit-hourly-rate3').value = '';
  });
}

// ============================================================================
// UTILITY FUNCTIONS
// ============================================================================

function e360Safe(v, fallback = '') {
  const s = (v ?? '').toString().trim();
  return s.length ? s : fallback;
}

function e360FormatDate(d) {
  if (!d) return '';
  const dt = new Date(d);
  if (!Number.isFinite(dt.getTime())) return '';
  return dt.toISOString().split('T')[0];
}

function e360CalcTenure(hireDate) {
  if (!hireDate) return 'â€”';
  const start = new Date(hireDate);
  if (!Number.isFinite(start.getTime())) return 'â€”';
  const now = new Date();

  let months = (now.getFullYear() - start.getFullYear()) * 12 + 
               (now.getMonth() - start.getMonth());
  if (now.getDate() < start.getDate()) months -= 1;
  if (months < 0) months = 0;

  const years = Math.floor(months / 12);
  const remMonths = months % 12;

  if (years === 0 && remMonths === 0) return 'Less than 1 month';
  if (years === 0) return `${remMonths} month${remMonths > 1 ? 's' : ''}`;
  if (remMonths === 0) return `${years} year${years > 1 ? 's' : ''}`;
  return `${years} year${years > 1 ? 's' : ''}, ${remMonths} month${remMonths > 1 ? 's' : ''}`;
}

function e360SetStatus(text, color) {
  const indicator = document.getElementById('save-status-indicator');
  const statusText = document.getElementById('save-status-text');
  
  if (indicator && statusText) {
    indicator.className = `w-3 h-3 rounded-full ${color}`;
    statusText.textContent = text;
  }
}

// ============================================================================
// CLEAR FORM
// ============================================================================
function e360ClearForm() {
  document.getElementById('current-employee-360-id').value = '';
  
  const fields = [
    'edit-employment-status', 'edit-first-name', 'edit-last-name',
    'edit-department', 'edit-job-title', 'edit-report-to',
    'edit-phone-number', 'edit-email-address', 'edit-address-line-1',
    'edit-address-line-2', 'edit-city', 'edit-state', 'edit-zip',
    'edit-original-hire-date', 'edit-compensation-type', 'edit-hourly-rate',
    'edit-job-title2', 'edit-hourly-rate2', 'edit-job-title3',
    'edit-hourly-rate3', 'edit-hr-witness', 'display-tenure',
    'display-risk-score', 'display-last-discipline'
  ];

  fields.forEach(fieldId => {
    const el = document.getElementById(fieldId);
    if (el) {
      if (el.tagName === 'SELECT') {
        el.selectedIndex = 0;
      } else {
        el.value = '';
      }
    }
  });

  // Reset the job title dropdown by triggering department change
  const deptField = document.getElementById('edit-department');
  const jobTitleField = document.getElementById('edit-job-title');
  if (deptField && jobTitleField) {
    jobTitleField.innerHTML = '<option value="">Select department first</option>';
    jobTitleField.disabled = true;
  }

  e360SetStatus('Ready to add new employee', 'bg-emerald-500');
}

// ============================================================================
// LOAD EMPLOYEE
// ============================================================================

function e360LoadEmployee(employee) {
  if (!employee) return;

  document.getElementById('current-employee-360-id').value = employee.id || '';
  
  document.getElementById('edit-employment-status').value = employee.employment_status || employee.status || 'Active';
  document.getElementById('edit-first-name').value = e360Safe(employee.first_name);
  document.getElementById('edit-last-name').value = e360Safe(employee.last_name);
  document.getElementById('edit-department').value = e360Safe(employee.department);
  document.getElementById('edit-job-title').value = e360Safe(employee.job_title);
  document.getElementById('edit-report-to').value = e360Safe(employee.report_to);
  document.getElementById('edit-phone-number').value = e360Safe(employee.primary_phone || employee.phone);
  document.getElementById('edit-email-address').value = e360Safe(employee.email);
  document.getElementById('edit-address-line-1').value = e360Safe(employee.address_line_1);
  document.getElementById('edit-address-line-2').value = e360Safe(employee.address_line_2);
  document.getElementById('edit-city').value = e360Safe(employee.city);
  document.getElementById('edit-state').value = e360Safe(employee.state);
  document.getElementById('edit-zip').value = e360Safe(employee.zip_code);

  const hireDate = employee.original_hire_date || employee.hire_date;
  document.getElementById('edit-original-hire-date').value = e360FormatDate(hireDate);
  document.getElementById('display-tenure').value = e360CalcTenure(hireDate);
  
  document.getElementById('edit-compensation-type').value = employee.compensation_type || 'hourly';
  document.getElementById('edit-hourly-rate').value = employee.hourly_rate || '';
  document.getElementById('edit-annual-salary').value = employee.annual_salary || '';
  
  // Show/hide secondary job
  if (employee.job_title2 || employee.hourly_rate2) {
    document.getElementById('secondary-job-container')?.classList.remove('hidden');
    document.getElementById('btn-add-secondary-job')?.classList.add('hidden');
    document.getElementById('btn-add-tertiary-job')?.classList.remove('hidden');
    document.getElementById('edit-job-title2').value = e360Safe(employee.job_title2);
    document.getElementById('edit-hourly-rate2').value = employee.hourly_rate2 || '';
  }
  
  // Show/hide tertiary job
  if (employee.job_title3 || employee.hourly_rate3) {
    document.getElementById('tertiary-job-container')?.classList.remove('hidden');
    document.getElementById('btn-add-tertiary-job')?.classList.add('hidden');
    document.getElementById('edit-job-title3').value = e360Safe(employee.job_title3);
    document.getElementById('edit-hourly-rate3').value = employee.hourly_rate3 || '';
  }
  
  document.getElementById('edit-hr-witness').value = e360Safe(employee.hr_witness);
  document.getElementById('display-risk-score').value = employee.risk_score || '0';
  document.getElementById('edit-risk-level').value = employee.risk_level || 'LOW';
  document.getElementById('display-last-discipline').value = employee.last_disciplinary_action 
    ? JSON.stringify(employee.last_disciplinary_action).substring(0, 100)
    : 'No disciplinary actions';

  // Trigger compensation type switch
  setupCompensationSwitcher();
  
  e360SetStatus(`Editing: ${employee.first_name} ${employee.last_name}`, 'bg-blue-500 animate-pulse');
}

// ============================================================================
// SAVE EMPLOYEE
// ============================================================================

// ============================================================================
// SAVE EMPLOYEE - CORRECTED VERSION (FIXES DUPLICATE CREATION)
// ============================================================================
async function e360SaveEmployee() {
    const db = window.supabaseClient;
    if (!db) {
        showToast?.('Database not connected', 'error');
        return;
    }

    // Get the current employee ID from the hidden input field
    const empId = document.getElementById('current-employee-360-id').value;

    // IMPORTANT: Check if empId is truthy to determine if this is an UPDATE
    // If empId is empty or null, it's a NEW employee.
    const isNewEmployee = !empId || empId.trim() === '';

    // Set status to "Saving..."
    e360SetStatus('Saving...', 'bg-amber-500 animate-pulse');

    // Collect data from the form
    const employeeData = {
        employment_status: document.getElementById('edit-employment-status').value,
        first_name: document.getElementById('edit-first-name').value.trim() || null,
        last_name: document.getElementById('edit-last-name').value.trim() || null,
        department: document.getElementById('edit-department').value || null,
        job_title: document.getElementById('edit-job-title').value.trim() || null,
        report_to: document.getElementById('edit-report-to').value || null,
        primary_phone: document.getElementById('edit-phone-number').value.trim() || null,
        email: document.getElementById('edit-email-address').value.trim() || null,
        address_line_1: document.getElementById('edit-address-line-1').value.trim() || null,
        address_line_2: document.getElementById('edit-address-line-2').value.trim() || null,
        city: document.getElementById('edit-city').value.trim() || null,
        state: document.getElementById('edit-state').value.trim() || null,
        zip_code: document.getElementById('edit-zip').value.trim() || null,
        original_hire_date: document.getElementById('edit-original-hire-date').value || null,
        compensation_type: document.getElementById('edit-compensation-type').value || 'hourly',
        hourly_rate: parseFloat(document.getElementById('edit-hourly-rate').value) || null,
        annual_salary: parseFloat(document.getElementById('edit-annual-salary').value) || null,
        job_title2: document.getElementById('edit-job-title2').value.trim() || null,
        hourly_rate2: parseFloat(document.getElementById('edit-hourly-rate2').value) || null,
        job_title3: document.getElementById('edit-job-title3').value.trim() || null,
        hourly_rate3: parseFloat(document.getElementById('edit-hourly-rate3').value) || null,
        hr_witness: document.getElementById('edit-hr-witness').value || null
    };

    try {
        let result;

        if (isNewEmployee) {
            // CREATE a new employee record
            console.log('ğŸš€ Creating new employee...');
            result = await db
                .from('employees2025')
                .insert([employeeData])
                .select()
                .single();

            if (result.error) throw result.error;

            // After successful creation, store the new ID
            document.getElementById('current-employee-360-id').value = result.data.id;

            showToast?.(`âœ“ New employee ${employeeData.first_name} ${employeeData.last_name} added!`, 'success');
            e360SetStatus('Employee added successfully', 'bg-emerald-500');

            // Clear the form after successful save for new employee
            setTimeout(() => {
                e360ClearForm();
            }, 1500);

        } else {
            // UPDATE the existing employee record
            console.log(`ğŸ”„ Updating existing employee (ID: ${empId})...`);
            result = await db
                .from('employees2025')
                .update(employeeData)
                .eq('id', empId) // This is the key line that ensures we update the correct record
                .select()
                .single();

            if (result.error) throw result.error;

            showToast?.(`âœ“ Employee ${employeeData.first_name} ${employeeData.last_name} updated!`, 'success');
            e360SetStatus('Changes saved successfully', 'bg-emerald-500');
        }

        // Reload the global employee list to reflect changes
        await loadEmployees();

        // Re-render the grid if the function exists
        if (typeof renderEmployeeGrid === 'function') {
            renderEmployeeGrid();
        }

        // Refresh the current view in the 360 panel
        if (result.data) {
            e360LoadEmployee(result.data);
        }

    } catch (err) {
        console.error('âŒ Save error:', err);
        showToast?.('âŒ Save failed: ' + err.message, 'error');
        e360SetStatus('Save failed', 'bg-rose-500');
    }
}

// ============================================================================
// SEARCH FUNCTIONALITY
// ============================================================================

function e360InitSearch() {
  const searchInput = document.getElementById('employees-search-input');
  const dropdown = document.getElementById('employees-search-dropdown');

  if (!searchInput || !dropdown) return;

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim().toLowerCase();

    if (query.length < 3) {
      dropdown.classList.add('hidden');
      dropdown.innerHTML = '';
      return;
    }

    const results = (AppState.employees || []).filter(emp => {
      const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.toLowerCase();
      const empId = (emp.employee_id || '').toLowerCase();
      const dept = (emp.department || '').toLowerCase();
      
      return fullName.includes(query) || empId.includes(query) || dept.includes(query);
    });

    if (results.length === 0) {
      dropdown.innerHTML = '<div class="p-4 text-center text-sm text-slate-500">No employees found</div>';
      dropdown.classList.remove('hidden');
      return;
    }

    dropdown.innerHTML = results.slice(0, 10).map(emp => `
      <div class="p-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 transition-colors"
           onclick="e360SelectEmployee(${emp.id})">
        <div class="flex items-center justify-between">
          <div>
            <p class="text-sm font-bold text-slate-900">${emp.first_name || ''} ${emp.last_name || ''}</p>
            <p class="text-xs text-slate-600">${emp.employee_id || 'No ID'} â€¢ ${emp.department || 'No Dept'}</p>
          </div>
          <i class="fa-solid fa-chevron-right text-slate-400"></i>
        </div>
      </div>
    `).join('');

    dropdown.classList.remove('hidden');
  });

  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });
}

window.e360SelectEmployee = function(empId) {
  const employee = (AppState.employees || []).find(e => e.id === empId);
  if (employee) {
    e360LoadEmployee(employee);
    document.getElementById('employees-search-dropdown').classList.add('hidden');
    document.getElementById('employees-search-input').value = '';
  }
};

// ============================================================================
// INITIALIZATION
// ============================================================================
function initEmployee360() {
  document.getElementById('btn-add-new-employee')?.addEventListener('click', () => {
    e360ClearForm();
    showToast?.('Ready to add new employee', 'info');
  });

  document.getElementById('btn-save-employee-360')?.addEventListener('click', async () => {
    await e360SaveEmployee();
  });

  document.getElementById('employees-refresh-button')?.addEventListener('click', async () => {
    await loadEmployees();
    showToast?.('Employee list refreshed', 'success');
  });

  e360InitSearch();
  setupDepartmentJobTitleCascade();  // â† ADD THIS LINE HERE

  console.log('âœ… Employee 360 initialized');
}

document.addEventListener('DOMContentLoaded', () => {
  initEmployee360();
});



// ============================================================================
// EMPLOYEE 360 - ADD/EDIT/SAVE FUNCTIONALITY
// ============================================================================

const EXCLUDED_FROM_DASHBOARD = ['Shoko Teng', 'Janelle Teng', 'Francisco Teng'];


// ============================================================================
// DASHBOARD: INACTIVE / ON LEAVE / TERMINATED EMPLOYEES SECTION
// ============================================================================
// Function to render the Inactive/Leave/Terminated section
function renderInactiveEmployeesSection(filterType = 'inactive') {
    const contentDiv = document.getElementById('inactive-employees-content');
    if (!contentDiv) return;

    // Define the filter based on the selected tab
    let filterStatus = 'Active';
    if (filterType === 'inactive') {
        filterStatus = 'Inactive';
    } else if (filterType === 'on-leave') {
        filterStatus = 'On Leave';
    } else if (filterType === 'terminated') {
        filterStatus = 'Terminated';
    }

    // Filter employees based on status
    const filteredEmployees = AppState.employees.filter(emp => {
        return emp.employment_status === filterStatus;
    });

    // Sort by last name
    filteredEmployees.sort((a, b) => {
        const nameA = `${a.first_name} ${a.last_name}`.toLowerCase();
        const nameB = `${b.first_name} ${b.last_name}`.toLowerCase();
        return nameA.localeCompare(nameB);
    });

    // Group employees by Department (FOH/BOH)
    const fohEmployees = filteredEmployees.filter(emp => emp.department === 'FOH');
    const bohEmployees = filteredEmployees.filter(emp => emp.department === 'BOH');

    // Build the HTML content
    let html = '';

    // Add FOH Section
    if (fohEmployees.length > 0) {
        html += `
        <div class="mb-4">
            <h4 class="text-xs font-black text-emerald-800 uppercase mb-2">FOH (${fohEmployees.length} Total)</h4>
            <ul class="space-y-1">
        `;
        fohEmployees.forEach(emp => {
            html += `
            <li class="flex justify-between items-center py-1 px-2 bg-emerald-50 rounded">
                <span class="text-xs font-medium text-emerald-900">${emp.first_name} ${emp.last_name}</span>
                <span class="text-xs text-emerald-600">${emp.job_title || 'N/A'}</span>
            </li>
            `;
        });
        html += `
            </ul>
        </div>
        `;
    }

    // Add BOH Section
    if (bohEmployees.length > 0) {
        html += `
        <div class="mb-4">
            <h4 class="text-xs font-black text-orange-800 uppercase mb-2">BOH (${bohEmployees.length} Total)</h4>
            <ul class="space-y-1">
        `;
        bohEmployees.forEach(emp => {
            html += `
            <li class="flex justify-between items-center py-1 px-2 bg-orange-50 rounded">
                <span class="text-xs font-medium text-orange-900">${emp.first_name} ${emp.last_name}</span>
                <span class="text-xs text-orange-600">${emp.job_title || 'N/A'}</span>
            </li>
            `;
        });
        html += `
            </ul>
        </div>
        `;
    }

    // Handle no results
    if (fohEmployees.length === 0 && bohEmployees.length === 0) {
        html = `
        <div class="text-center py-6 text-slate-400">
            <i class="fa-solid fa-inbox text-2xl mb-2"></i>
            <p class="text-xs">No ${filterType.replace('-', ' ')} employees found</p>
        </div>
        `;
    }

    contentDiv.innerHTML = html;
}

// Function to handle tab clicks in the Inactive/Leave/Terminated section
function setupInactiveEmployeesTabs() {
    const tabs = document.querySelectorAll('#tab-dashboard [data-filter]');
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs
            tabs.forEach(t => t.classList.remove('border-blue-500', 'text-blue-700', 'bg-blue-50'));
            // Add active class to clicked tab
            tab.classList.add('border-blue-500', 'text-blue-700', 'bg-blue-50');
            // Render the content for the selected filter
            const filterType = tab.dataset.filter;
            renderInactiveEmployeesSection(filterType);
        });
    });
}

// Initialize the Inactive/Leave/Terminated section
document.addEventListener('DOMContentLoaded', () => {
    // Wait for the dashboard to be fully loaded
    setTimeout(() => {
        if (document.getElementById('tab-dashboard')) {
            // Initial render
            renderInactiveEmployeesSection('inactive');
            // Setup tab event listeners
            setupInactiveEmployeesTabs();
        }
    }, 1000); // Small delay to ensure DOM is ready
});

// Re-render the section whenever the employee data is reloaded
window.addEventListener('load', async () => {
    console.log('ğŸš€ Page loaded - Initializing dashboard...');
    
    // CRITICAL FIX: Load employees FIRST!
    console.log('ğŸ“¥ Loading employees from database...');
    try {
        await loadEmployees();
        console.log('âœ… Employees loaded successfully:', AppState.employees.length);
    } catch (error) {
        console.error('âŒ Failed to load employees:', error);
    }
    
    // Then initialize dashboard with all charts and tables
    if (typeof updateDashboard === 'function') {
        setTimeout(() => {
            updateDashboard();
            console.log('âœ… Dashboard initialized successfully');
        }, 500);
    }
});

function syncTabsToPermissions() {
    // Get all tab buttons
    const allTabs = document.querySelectorAll('[data-tab]');
    const tabNames = Array.from(allTabs).map(tab => {
        const tabId = tab.getAttribute('data-tab');
        const tabText = tab.textContent.trim();
        return { id: tabId, name: tabText };
    });

    console.log('ğŸ“‹ Found tabs:', tabNames);

    // Get the permissions section container
    const permissionsContainer = document.getElementById('permissions-tabs-container');
    if (!permissionsContainer) {
        console.warn('âš ï¸ Permissions container not found');
        return;
    }

    // Clear existing checkboxes
    permissionsContainer.innerHTML = '';

    // Create checkbox for each tab
    tabNames.forEach(tab => {
        const tabRow = document.createElement('div');
        tabRow.className = 'grid grid-cols-4 gap-4 items-center py-2 border-b border-slate-100';
        tabRow.innerHTML = `
            <div class="text-xs font-medium text-slate-700">${tab.name}</div>
            <div class="flex justify-center">
                <input type="checkbox" 
                       data-permission="${tab.id}" 
                       data-role="owner" 
                       class="permission-checkbox w-4 h-4 text-brand-600 border-slate-300 rounded" 
                       checked>
            </div>
            <div class="flex justify-center">
                <input type="checkbox" 
                       data-permission="${tab.id}" 
                       data-role="manager" 
                       class="permission-checkbox w-4 h-4 text-brand-600 border-slate-300 rounded">
            </div>
            <div class="flex justify-center">
                <input type="checkbox" 
                       data-permission="${tab.id}" 
                       data-role="viewer" 
                       class="permission-checkbox w-4 h-4 text-brand-600 border-slate-300 rounded">
            </div>
        `;
        permissionsContainer.appendChild(tabRow);
    });

    console.log('âœ… Permissions synced with tabs');
}

// Run on page load and whenever tabs change
window.addEventListener('load', () => {
    setTimeout(syncTabsToPermissions, 1500);
});

// Re-sync whenever the permissions tab is opened
document.querySelector('[data-tab="permissions"]')?.addEventListener('click', () => {
    setTimeout(syncTabsToPermissions, 300);
});

console.log('âœ… All fixes initialized');





// ============================================================
// AUTO-REFRESH DASHBOARD EVERY 5 SECONDS (SILENT)
// ============================================================
// Add this code RIGHT AFTER the window.addEventListener('load') section
// (After line 17807 in your file)

let dashboardRefreshInterval = null;

// Function to silently refresh dashboard data
async function silentDashboardRefresh() {
    try {
        console.log('ğŸ”„ Auto-refreshing dashboard data...');
        
        // Reload employees from database (silent)
        await loadEmployees();
        
        // Update the dashboard with latest data
        if (typeof updateDashboard === 'function') {
            updateDashboard();
        }
        
        console.log('âœ… Dashboard auto-refresh complete');
    } catch (error) {
        console.error('âŒ Dashboard auto-refresh failed:', error);
    }
}

// Start auto-refresh when dashboard is visible
function startDashboardAutoRefresh() {
    // Clear any existing interval
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
    }
    
    // Set up 5-second auto-refresh
    dashboardRefreshInterval = setInterval(silentDashboardRefresh, 5000);
    console.log('âœ… Dashboard auto-refresh started (every 5 seconds)');
}

// Stop auto-refresh (useful when user leaves dashboard)
function stopDashboardAutoRefresh() {
    if (dashboardRefreshInterval) {
        clearInterval(dashboardRefreshInterval);
        dashboardRefreshInterval = null;
        console.log('â¹ï¸ Dashboard auto-refresh stopped');
    }
}

// Check if dashboard tab is active and start/stop refresh accordingly
function checkDashboardTab() {
    const dashboardTab = document.getElementById('tab-dashboard');
    if (dashboardTab && !dashboardTab.classList.contains('hidden')) {
        // Dashboard is visible - start auto-refresh
        startDashboardAutoRefresh();
    } else {
        // Dashboard is hidden - stop auto-refresh to save resources
        stopDashboardAutoRefresh();
    }
}

// Initialize auto-refresh when page loads and dashboard is ready
window.addEventListener('load', () => {
    // Wait for initial dashboard load
    setTimeout(() => {
        checkDashboardTab();
        
        // Also check when user switches tabs
        const allTabButtons = document.querySelectorAll('[data-tab]');
        allTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setTimeout(checkDashboardTab, 500);
            });
        });
    }, 1000);
});

// Optional: Pause refresh when browser tab is not visible (saves resources)
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopDashboardAutoRefresh();
        console.log('â¸ï¸ Dashboard auto-refresh paused (tab hidden)');
    } else {
        checkDashboardTab();
        console.log('â–¶ï¸ Dashboard auto-refresh resumed (tab visible)');
    }
});

console.log('âœ… Dashboard auto-refresh system initialized');






// Mapbox Address Autocomplete - US Only (Token from Supabase Vault)
// Mapbox Address Autocomplete - US Only
// Mapbox Address Autocomplete - US Only (Clean Design)
async function initMapboxAddressAutocomplete() {
  const MAPBOX_TOKEN = 'pk.eyJ1IjoiamVuZ2NoaTIwMjYiLCJhIjoiY21rNDFjNXo5MDJ5aDNmcHpvenN1MjE4NCJ9.wyHLjVzb9rCbsmy0ArBgQQ';
  
  const addressInput = document.getElementById('edit-address-line-1');
  const cityInput = document.getElementById('edit-city');
  const stateInput = document.getElementById('edit-state');
  const zipInput = document.getElementById('edit-zip');

  if (!addressInput) {
    console.log('Address field not ready yet');
    return;
  }

  console.log('âœ… Mapbox address autocomplete initialized');

  // Remove any existing dropdown
  const existingDropdown = document.getElementById('address-suggestions-dropdown');
  if (existingDropdown) {
    existingDropdown.remove();
  }

  // Create new clean dropdown
  const dropdown = document.createElement('div');
  dropdown.id = 'address-suggestions-dropdown';
  dropdown.style.cssText = `
    position: absolute;
    z-index: 9999;
    width: 100%;
    margin-top: 4px;
    background: white;
    border: 1px solid #cbd5e1;
    border-radius: 8px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
    max-height: 250px;
    overflow-y: auto;
    display: none;
  `;
  
  addressInput.parentElement.style.position = 'relative';
  addressInput.parentElement.appendChild(dropdown);

  let debounceTimer;

  addressInput.addEventListener('input', function () {
    const query = this.value.trim();

    clearTimeout(debounceTimer);

    if (query.length < 3) {
      dropdown.style.display = 'none';
      return;
    }

    debounceTimer = setTimeout(async () => {
      try {
        const url = `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?access_token=${MAPBOX_TOKEN}&country=us&types=address&limit=5`;
        
        const response = await fetch(url);

        if (!response.ok) {
          throw new Error('Mapbox API error');
        }

        const data = await response.json();

        if (!data.features || data.features.length === 0) {
          dropdown.innerHTML = '<div style="padding: 12px; text-align: center; color: #64748b; font-size: 14px;">No addresses found</div>';
          dropdown.style.display = 'block';
          return;
        }

        dropdown.innerHTML = '';

        data.features.forEach(place => {
          const context = place.context || [];
          
          let street = place.text || '';
          if (place.address) {
            street = `${place.address} ${place.text}`;
          }
          
          let city = '';
          let state = '';
          let zip = '';
          
          context.forEach(item => {
            if (item.id.startsWith('place')) {
              city = item.text;
            } else if (item.id.startsWith('region')) {
              state = item.short_code ? item.short_code.replace('US-', '') : item.text;
            } else if (item.id.startsWith('postcode')) {
              zip = item.text;
            }
          });

          const item = document.createElement('div');
          item.style.cssText = `
            padding: 12px 16px;
            cursor: pointer;
            border-bottom: 1px solid #f1f5f9;
            transition: background-color 0.15s;
          `;
          
          item.innerHTML = `
            <div style="font-weight: 600; color: #1e293b; font-size: 14px; margin-bottom: 2px;">${street}</div>
            <div style="font-size: 12px; color: #64748b;">${city}${city && state ? ', ' : ''}${state} ${zip}</div>
          `;

          item.addEventListener('mouseenter', () => {
            item.style.backgroundColor = '#f8fafc';
          });

          item.addEventListener('mouseleave', () => {
            item.style.backgroundColor = 'white';
          });

          item.addEventListener('click', () => {
            addressInput.value = street;
            cityInput.value = city;
            stateInput.value = state;
            zipInput.value = zip;
            
            dropdown.style.display = 'none';
            
            if (typeof showToast === 'function') {
              showToast('âœ“ Address auto-filled!', 'success');
            }
          });

          dropdown.appendChild(item);
        });

        dropdown.style.display = 'block';

      } catch (err) {
        console.error('Mapbox address error:', err);
        dropdown.innerHTML = '<div style="padding: 12px; text-align: center; color: #ef4444; font-size: 14px;">Address lookup temporarily unavailable</div>';
        dropdown.style.display = 'block';
      }
    }, 400);
  });

  // Hide dropdown on outside click
  document.addEventListener('click', (e) => {
    if (!addressInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.style.display = 'none';
    }
  });
}

// Initialize
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', initMapboxAddressAutocomplete);
} else {
  initMapboxAddressAutocomplete();
}
setTimeout(initMapboxAddressAutocomplete, 3000);



let employeeGridRefreshInterval = null;

function silentEmployeeGridRefresh() {
    try {
        console.log('ğŸ”„ Auto-refreshing employee grid...');
        
        // Reload employees from database
        if (typeof loadEmployees === 'function') {
            loadEmployees().then(() => {
                // Re-render the employee grid after loading
                if (typeof renderEmployeeGrid === 'function') {
                    renderEmployeeGrid();
                }
                console.log('âœ… Employee grid auto-refresh complete');
            });
        }
    } catch (error) {
        console.error('âŒ Employee grid auto-refresh failed:', error);
    }
}

function startEmployeeGridAutoRefresh() {
    if (employeeGridRefreshInterval) {
        clearInterval(employeeGridRefreshInterval);
    }
    
    employeeGridRefreshInterval = setInterval(silentEmployeeGridRefresh, 5000);
    console.log('âœ… Employee grid auto-refresh started (every 5 seconds)');
}

function stopEmployeeGridAutoRefresh() {
    if (employeeGridRefreshInterval) {
        clearInterval(employeeGridRefreshInterval);
        employeeGridRefreshInterval = null;
        console.log('â¹ï¸ Employee grid auto-refresh stopped');
    }
}

// Check if employees tab is active
function checkEmployeesTab() {
    const employeesTab = document.getElementById('tab-employees');
    if (employeesTab && !employeesTab.classList.contains('hidden')) {
        startEmployeeGridAutoRefresh();
    } else {
        stopEmployeeGridAutoRefresh();
    }
}

// Initialize employee grid auto-refresh
window.addEventListener('load', () => {
    setTimeout(() => {
        checkEmployeesTab();
        
        // Check when user switches tabs
        const allTabButtons = document.querySelectorAll('[data-tab]');
        allTabButtons.forEach(button => {
            button.addEventListener('click', () => {
                setTimeout(checkEmployeesTab, 500);
            });
        });
    }, 1000);
});

// Pause when browser tab is hidden
document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
        stopEmployeeGridAutoRefresh();
    } else {
        checkEmployeesTab();
    }
});

// ============================================================
// EMPLOYEE IMPORT FUNCTIONALITY
// ============================================================

// File input handler
document.getElementById('employee-file-input').addEventListener('change', async (e) => {
  const file = e.target.files[0];
  if (!file) return;

  showToast('ğŸ“– Reading Excel file...', 'info');
  
  try {
    const employeeData = await readEmployeeExcelFile(file);
    await importNewEmployees(employeeData);
  } catch (error) {
    console.error('Import error:', error);
    showToast('âŒ Import failed: ' + error.message, 'error');
  }

  e.target.value = ''; // Reset file input
});

// Read Excel file
async function readEmployeeExcelFile(file) {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const data = new Uint8Array(e.target.result);
        const workbook = XLSX.read(data, { type: 'array' });
        const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
        const jsonData = XLSX.utils.sheet_to_json(firstSheet);
        
        console.log('ğŸ“Š Excel file read:', jsonData.length, 'rows');
        resolve(jsonData);
      } catch (error) {
        reject(new Error('Failed to read Excel file'));
      }
    };
    
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsArrayBuffer(file);
  });
}

// Import new employees only (skip duplicates)
async function importNewEmployees(importedData) {
  const logContainer = document.getElementById('import-log-content');
  const logSection = document.getElementById('import-log');
  logContainer.innerHTML = '';
  logSection.classList.remove('hidden');

  let newCount = 0;
  let skippedCount = 0;

  // Get all current employees from database
  const { data: currentEmployees, error: fetchError } = await window.supabaseClient
    .from('employees2025')
    .select('first_name, last_name');

  if (fetchError) {
    showToast('âŒ Failed to load current employees', 'error');
    return;
  }

  for (const row of importedData) {
    const lastName = row.Last_name?.trim();
    const firstName = row.First_name?.trim();
    
    if (!lastName || !firstName) {
      addImportLog('âš ï¸ Skipped row with missing name', 'warning');
      continue;
    }

    // Check if employee already exists
    const exists = currentEmployees.some(emp => 
      emp.first_name?.toLowerCase() === firstName.toLowerCase() && 
      emp.last_name?.toLowerCase() === lastName.toLowerCase()
    );

    if (exists) {
      skippedCount++;
      addImportLog(`âš ï¸ Skipped: ${firstName} ${lastName} (already exists)`, 'warning');
      continue;
    }

    // Format hire date from Excel
    let hireDate = '';
    if (row.original_hire_date) {
      if (typeof row.original_hire_date === 'number') {
        const date = XLSX.SSF.parse_date_code(row.original_hire_date);
        hireDate = `${date.y}-${String(date.m).padStart(2, '0')}-${String(date.d).padStart(2, '0')}`;
      } else if (row.original_hire_date instanceof Date) {
        hireDate = row.original_hire_date.toISOString().split('T')[0];
      }
    }

    // Create new employee object
    const newEmployee = {
      first_name: firstName,
      last_name: lastName,
      original_hire_date: hireDate,
      department: row.Department || '',
      status: 'Active'
    };

    try {
      // Save to database
      const { error } = await window.supabaseClient
        .from('employees2025')
        .insert([newEmployee]);

      if (error) throw error;

      newCount++;
      addImportLog(`âœ… Added: ${firstName} ${lastName}`, 'success');
      
    } catch (error) {
      addImportLog(`âŒ Failed: ${firstName} ${lastName}`, 'error');
    }
  }

  // Show summary
  logContainer.innerHTML += `
    <div class="font-bold mt-4 pt-4 border-t border-slate-200 text-slate-900">
      ğŸ“Š Summary: <span class="text-green-600">${newCount} added</span>, 
      <span class="text-yellow-600">${skippedCount} skipped</span>
    </div>
  `;

  // Reload employee grid
  if (newCount > 0) {
    await loadEmployees();
    renderEmployeeGrid();
    showToast(`âœ… ${newCount} new employees imported!`, 'success');
  } else {
    showToast('â„¹ï¸ No new employees to import', 'info');
  }

  // Auto-hide log after 10 seconds
  setTimeout(() => logSection.classList.add('hidden'), 10000);
}

// Add log entry
function addImportLog(message, type) {
  const logContainer = document.getElementById('import-log-content');
  const entry = document.createElement('div');
  entry.className = `py-1 ${
    type === 'error' ? 'text-red-600 font-semibold' : 
    type === 'warning' ? 'text-yellow-600' : 
    'text-slate-700'
  }`;
  entry.textContent = message;
  logContainer.appendChild(entry);
}

console.log('âœ… Employee import functionality loaded');




let currentEditEmployeeId = null;
let employeeAutoSaveTimeout = null;

// Open Employee Edit Modal
async function openEmployeeEditModal(employeeId) {
  if (!employeeId) {
    showToast('âŒ Employee ID is required', 'error');
    return;
  }

  currentEditEmployeeId = employeeId;

  try {
    // Fetch employee data
    const { data: employee, error } = await window.supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (error) throw error;
    if (!employee) {
      showToast('âŒ Employee not found', 'error');
      return;
    }

    // Populate modal
    populateEmployeeEditModal(employee);

    // Show modal
    document.getElementById('employee-edit-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';

    console.log('âœ… Opened employee edit modal:', employee.first_name, employee.last_name);

  } catch (error) {
    console.error('âŒ Failed to load employee:', error);
    showToast('âŒ Failed to load employee data', 'error');
  }
}

// Populate Modal with Employee Data



// Populate Modal with Employee Data
function populateEmployeeEditModal(emp) {
  console.log('ğŸ” Loading employee data:', emp.first_name, emp.last_name);
  
  // Header
  document.getElementById('emp-edit-modal-name').textContent = 
    `${emp.first_name || ''} ${emp.last_name || ''}`;

  // Personal Information
  document.getElementById('emp-edit-last-name').value = emp.last_name || '';
  document.getElementById('emp-edit-first-name').value = emp.first_name || '';
  document.getElementById('emp-edit-username').value = emp.username || '';
  document.getElementById('emp-edit-pin').value = emp.pin || '';
  document.getElementById('emp-edit-phone').value = emp.primary_phone || emp.phone || '';
  document.getElementById('emp-edit-email').value = emp.email || '';

  // Address
  document.getElementById('emp-edit-address').value = emp.address_line_1 || '';
  document.getElementById('emp-edit-city').value = emp.city || '';
  document.getElementById('emp-edit-state').value = emp.state || '';
  document.getElementById('emp-edit-zip').value = emp.zip_code || '';

  // Employment
  document.getElementById('emp-edit-hire-date').value = emp.original_hire_date || emp.hire_date || '';
  document.getElementById('emp-edit-status').value = emp.employment_status || emp.status || 'Active';
  document.getElementById('emp-edit-job-title').value = emp.job_title || '';
  document.getElementById('emp-edit-department').value = emp.department || '';
  document.getElementById('emp-edit-employment-type').value = emp.employment_type || 'FT';

  // Compensation
  const compType = (emp.compensation_type || 'hourly').toLowerCase();
  document.getElementById('emp-edit-comp-type').value = compType;
  
  const wageInput = document.getElementById('emp-edit-wage');
  const wageLabel = document.getElementById('emp-edit-wage-label');
  
  if (compType === 'salary') {
    wageLabel.textContent = 'Annual Salary';
    wageInput.value = emp.annual_salary || '';
    wageInput.placeholder = '0.00';
  } else {
    wageLabel.textContent = 'Hourly Rate';
    wageInput.value = emp.hourly_rate || '';
    wageInput.placeholder = '0.00';
  }

  // Benefits - Check ALL possible fields
  const medicalPlan = emp.medical_plan_code || emp.medical_plan || emp.medical_plan_2026 || emp.medical_plan_2025 || '';
  const dentalPlan = emp.dental_plan_code || emp.dental_plan || emp.dental_plan_2026 || emp.dental_plan_2025 || '';
  const visionPlan = emp.vision_plan_code || emp.vision_plan || emp.vision_plan_2026 || emp.vision_plan_2025 || '';
  
  console.log('ğŸ’Š Checking ALL benefit fields for:', emp.first_name, emp.last_name);
  console.log('  medical_plan_code:', emp.medical_plan_code);
  console.log('  medical_plan:', emp.medical_plan);
  console.log('  medical_plan_2026:', emp.medical_plan_2026);
  console.log('  medical_plan_2025:', emp.medical_plan_2025);
  console.log('  â†’ Using:', medicalPlan);
  console.log('  dental_plan_code:', emp.dental_plan_code);
  console.log('  dental_plan:', emp.dental_plan);
  console.log('  dental_plan_2026:', emp.dental_plan_2026);
  console.log('  dental_plan_2025:', emp.dental_plan_2025);
  console.log('  â†’ Using:', dentalPlan);
  console.log('  vision_plan_code:', emp.vision_plan_code);
  console.log('  vision_plan:', emp.vision_plan);
  console.log('  vision_plan_2026:', emp.vision_plan_2026);
  console.log('  vision_plan_2025:', emp.vision_plan_2025);
  console.log('  â†’ Using:', visionPlan);
  
  // Set dropdown values with a small delay to ensure DOM is ready
  setTimeout(() => {
    const medicalDropdown = document.getElementById('emp-edit-medical-plan');
    const dentalDropdown = document.getElementById('emp-edit-dental-plan');
    const visionDropdown = document.getElementById('emp-edit-vision-plan');
    
    if (medicalDropdown) {
      medicalDropdown.value = medicalPlan;
      console.log('âœ… Medical set to:', medicalDropdown.value);
    }
    
    if (dentalDropdown) {
      dentalDropdown.value = dentalPlan;
      console.log('âœ… Dental set to:', dentalDropdown.value);
    }
    
    if (visionDropdown) {
      visionDropdown.value = visionPlan;
      console.log('âœ… Vision set to:', visionDropdown.value);
    }
  }, 100);

  // Load PDF
  loadEmployeePDF(emp.signed_pdf_url || emp.pdf_url);

  // Setup auto-save listeners
  setupEmployeeAutoSave();
  
  console.log('âœ… Employee modal populated');
}



// Load PDF Viewer
function loadEmployeePDF(pdfUrl) {
  const pdfViewer = document.getElementById('emp-pdf-viewer');
  const pdfLoading = document.getElementById('emp-pdf-loading');
  const downloadBtn = document.getElementById('emp-pdf-download');

  if (pdfUrl && pdfUrl.trim() !== '') {
    pdfViewer.src = pdfUrl;
    pdfViewer.classList.remove('hidden');
    pdfLoading.classList.add('hidden');
    
    downloadBtn.onclick = () => window.open(pdfUrl, '_blank');
    downloadBtn.disabled = false;
    downloadBtn.classList.remove('opacity-50', 'cursor-not-allowed');
  } else {
    pdfViewer.classList.add('hidden');
    pdfLoading.classList.remove('hidden');
    downloadBtn.disabled = true;
    downloadBtn.classList.add('opacity-50', 'cursor-not-allowed');
  }
}

// Setup Auto-Save Event Listeners
function setupEmployeeAutoSave() {
  const fieldIds = [
    'emp-edit-last-name', 'emp-edit-first-name', 'emp-edit-username', 'emp-edit-pin',
    'emp-edit-phone', 'emp-edit-email', 'emp-edit-address', 'emp-edit-city',
    'emp-edit-state', 'emp-edit-zip', 'emp-edit-hire-date', 'emp-edit-status',
    'emp-edit-job-title', 'emp-edit-department', 'emp-edit-employment-type',
    'emp-edit-comp-type', 'emp-edit-wage', 'emp-edit-medical-plan',
    'emp-edit-dental-plan', 'emp-edit-vision-plan'
  ];

  fieldIds.forEach(fieldId => {
    const field = document.getElementById(fieldId);
    if (!field) return;

    // Remove existing listeners
    const newField = field.cloneNode(true);
    field.parentNode.replaceChild(newField, field);

    // Add new listener
    newField.addEventListener('change', () => debouncedEmployeeSave());
    newField.addEventListener('input', () => debouncedEmployeeSave());
  });

  // Compensation type change handler
  document.getElementById('emp-edit-comp-type').addEventListener('change', (e) => {
    const wageLabel = document.getElementById('emp-edit-wage-label');
    if (e.target.value === 'salary') {
      wageLabel.textContent = 'Annual Salary';
    } else {
      wageLabel.textContent = 'Hourly Rate';
    }
  });
}

// Debounced Auto-Save
function debouncedEmployeeSave() {
  clearTimeout(employeeAutoSaveTimeout);
  employeeAutoSaveTimeout = setTimeout(() => {
    saveEmployeeData();
  }, 1000);
}

// Save Employee Data Now (button click)
function saveEmployeeDataNow() {
  clearTimeout(employeeAutoSaveTimeout);
  saveEmployeeData();
}

// Save Employee Data to Database
async function saveEmployeeData() {
  if (!currentEditEmployeeId) return;

  try {
    const compType = document.getElementById('emp-edit-comp-type').value;
    const wage = parseFloat(document.getElementById('emp-edit-wage').value) || null;

    // Get benefit values
    const medicalValue = document.getElementById('emp-edit-medical-plan').value;
    const dentalValue = document.getElementById('emp-edit-dental-plan').value;
    const visionValue = document.getElementById('emp-edit-vision-plan').value;

    const updates = {
      last_name: document.getElementById('emp-edit-last-name').value.trim(),
      first_name: document.getElementById('emp-edit-first-name').value.trim(),
      username: document.getElementById('emp-edit-username').value.trim(),
      pin: document.getElementById('emp-edit-pin').value.trim(),
      primary_phone: document.getElementById('emp-edit-phone').value.trim(),
      email: document.getElementById('emp-edit-email').value.trim(),
      address_line_1: document.getElementById('emp-edit-address').value.trim(),
      city: document.getElementById('emp-edit-city').value.trim(),
      state: document.getElementById('emp-edit-state').value.trim(),
      zip_code: document.getElementById('emp-edit-zip').value.trim(),
      original_hire_date: document.getElementById('emp-edit-hire-date').value,
      employment_status: document.getElementById('emp-edit-status').value,
      job_title: document.getElementById('emp-edit-job-title').value.trim(),
      department: document.getElementById('emp-edit-department').value.trim(),
      employment_type: document.getElementById('emp-edit-employment-type').value,
      compensation_type: compType,
      
      // Save to BOTH _code and regular fields
      medical_plan_code: medicalValue,
      medical_plan: medicalValue,
      dental_plan_code: dentalValue,
      dental_plan: dentalValue,
      vision_plan_code: visionValue,
      vision_plan: visionValue
    };

    // Add wage to appropriate field
    if (compType === 'salary') {
      updates.annual_salary = wage;
      updates.hourly_rate = null;
    } else {
      updates.hourly_rate = wage;
      updates.annual_salary = null;
    }

    // Update database
    const { error } = await window.supabaseClient
      .from('employees2025')
      .update(updates)
      .eq('id', currentEditEmployeeId);

    if (error) {
      console.error('âŒ Supabase error:', error);
      throw error;
    }

    // Show save indicator
    showEmployeeSaveIndicator();

    // Update AppState
    const empIndex = AppState.employees.findIndex(e => e.id === currentEditEmployeeId);
    if (empIndex !== -1) {
      AppState.employees[empIndex] = { ...AppState.employees[empIndex], ...updates };
    }

    // Refresh grid
    if (typeof renderEmployeeGrid === 'function') {
      renderEmployeeGrid();
    }

    console.log('âœ… Employee data saved successfully');
    showToast('âœ… Changes saved successfully', 'success');

  } catch (error) {
    console.error('âŒ Failed to save employee data:', error);
    showToast('âŒ Failed to save changes: ' + error.message, 'error');
  }
}

// Show Save Indicator
function showEmployeeSaveIndicator() {
  const indicator = document.getElementById('emp-save-indicator');
  if (indicator) {
    indicator.classList.remove('hidden');
    setTimeout(() => indicator.classList.add('hidden'), 3000);
  }
}

// Close Modal
function closeEmployeeEditModal() {
  const modal = document.getElementById('employee-edit-modal');
  if (modal) {
    modal.classList.add('hidden');
  }
  document.body.style.overflow = '';
  currentEditEmployeeId = null;
  clearTimeout(employeeAutoSaveTimeout);
  console.log('âœ… Employee modal closed');
}

// Close on outside click
document.getElementById('employee-edit-modal')?.addEventListener('click', (e) => {
  if (e.target.id === 'employee-edit-modal') {
    closeEmployeeEditModal();
  }
});

// Close on ESC key
document.addEventListener('keydown', (e) => {
  if (e.key === 'Escape') {
    const modal = document.getElementById('employee-edit-modal');
    if (modal && !modal.classList.contains('hidden')) {
      closeEmployeeEditModal();
    }
  }
});

console.log('âœ… Employee edit modal close functions loaded');




function initSignaturePad(canvasId, hiddenId, clearBtnId) {
  const canvas = document.getElementById(canvasId);
  const hidden = document.getElementById(hiddenId);
  const clearBtn = document.getElementById(clearBtnId);

  if (!canvas || !hidden) return null;

  const ctx = canvas.getContext('2d');

  function resizeCanvasToCSS() {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(1, Math.floor(rect.width * dpr));
    canvas.height = Math.max(1, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
    ctx.lineWidth = 2;
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = '#0f172a';
  }

  function exportDataUrl() {
    // If blank, store empty string
    hidden.value = canvas.dataset.hasInk === '1'
      ? canvas.toDataURL('image/png')
      : '';
  }

  function clear() {
    const rect = canvas.getBoundingClientRect();
    ctx.clearRect(0, 0, rect.width, rect.height);
    canvas.dataset.hasInk = '0';
    exportDataUrl();
  }

  let drawing = false;

  function getPoint(e) {
    const rect = canvas.getBoundingClientRect();
    const pt = e.touches ? e.touches[0] : e;
    return { x: pt.clientX - rect.left, y: pt.clientY - rect.top };
  }

  function start(e) {
    e.preventDefault();
    drawing = true;
    const p = getPoint(e);
    ctx.beginPath();
    ctx.moveTo(p.x, p.y);
  }

  function move(e) {
    if (!drawing) return;
    e.preventDefault();
    const p = getPoint(e);
    ctx.lineTo(p.x, p.y);
    ctx.stroke();
    canvas.dataset.hasInk = '1';
  }

  function end(e) {
    if (!drawing) return;
    e.preventDefault();
    drawing = false;
    exportDataUrl();
  }

  // Setup
  resizeCanvasToCSS();
  window.addEventListener('resize', () => {
    // keep the existing image when resizing
    const prev = hidden.value;
    resizeCanvasToCSS();
    if (prev) {
      const img = new Image();
      img.onload = () => {
        ctx.drawImage(img, 0, 0, canvas.getBoundingClientRect().width, canvas.getBoundingClientRect().height);
        canvas.dataset.hasInk = '1';
        exportDataUrl();
      };
      img.src = prev;
    } else {
      clear();
    }
  });

  canvas.addEventListener('mousedown', start);
  canvas.addEventListener('mousemove', move);
  window.addEventListener('mouseup', end);

  canvas.addEventListener('touchstart', start, { passive: false });
  canvas.addEventListener('touchmove', move, { passive: false });
  canvas.addEventListener('touchend', end, { passive: false });

  if (clearBtn) clearBtn.addEventListener('click', clear);

  // Start blank
  clear();

  return { clear, exportDataUrl };
}


let CompSigPads = null;

function initCompSignaturePads() {
  CompSigPads = {
    emp: initSignaturePad('comp-sig-emp', 'comp-sig-emp-dataurl', 'comp-sig-emp-clear'),
    mgr: initSignaturePad('comp-sig-mgr', 'comp-sig-mgr-dataurl', 'comp-sig-mgr-clear'),
    hr:  initSignaturePad('comp-sig-hr',  'comp-sig-hr-dataurl',  'comp-sig-hr-clear'),
  };
}



function ensureCompSignaturePadsReady() {
  if (!CompSigPads) initCompSignaturePads();

  // Give layout time to paint after tab becomes visible
  setTimeout(() => {
    window.dispatchEvent(new Event('resize'));
  }, 50);
}




function setValue(id, value) {
  const el = document.getElementById(id);
  if (!el) return;
  el.value = value || '';
}

function fullNameFromEmployee(emp) {
  return [emp?.first_name, emp?.last_name].filter(Boolean).join(' ').trim();
}









</script>












<!-- ============================================================ -->

<!-- Employee Edit Modal -->
<div id="employee-edit-modal" class="fixed inset-0 z-50 hidden bg-slate-900/90 backdrop-blur-sm">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-7xl max-h-[95vh] overflow-hidden flex flex-col animate-slideUp">
      
      <!-- Header - Professional Corporate Colors -->
      <div class="bg-gradient-to-r from-slate-800 via-slate-700 to-slate-900 px-6 py-5 border-b-4 border-blue-600">
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-4">
            <div class="w-14 h-14 rounded-xl bg-blue-600 shadow-lg flex items-center justify-center">
              <i class="fa-solid fa-user-tie text-white text-2xl"></i>
            </div>
            <div>
              <h2 class="text-2xl font-black text-white tracking-tight">Employee Information</h2>
              <p id="emp-edit-modal-name" class="text-slate-300 text-sm font-semibold mt-0.5"></p>
            </div>
          </div>
          <button onclick="closeEmployeeEditModal()" 
                  class="w-11 h-11 rounded-lg bg-slate-600 hover:bg-slate-500 transition-all flex items-center justify-center group">
            <i class="fa-solid fa-xmark text-white text-2xl group-hover:rotate-90 transition-transform duration-300"></i>
          </button>
        </div>
      </div>

      <!-- Content -->
      <div class="flex-1 overflow-y-auto">
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-0">
          
          <!-- LEFT COLUMN: Employee Details (2/3 width) -->
          <div class="lg:col-span-2 p-6 space-y-6 border-r border-slate-200 bg-slate-50">
            
            <!-- Personal Information -->
            <div class="bg-white rounded-xl p-5 border-2 border-slate-200 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-600">
                <i class="fa-solid fa-id-card text-blue-600"></i>
                Personal Information
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Last Name</label>
                  <input id="emp-edit-last-name" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">First Name</label>
                  <input id="emp-edit-first-name" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Username</label>
                  <input id="emp-edit-username" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">PIN</label>
                  <input id="emp-edit-pin" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-bold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Phone Number</label>
                  <input id="emp-edit-phone" type="tel" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Email</label>
                  <input id="emp-edit-email" type="email" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
              </div>
            </div>

            <!-- Address -->
            <div class="bg-white rounded-xl p-5 border-2 border-slate-200 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-600">
                <i class="fa-solid fa-location-dot text-blue-600"></i>
                Address
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div class="col-span-2">
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Street Address</label>
                  <input id="emp-edit-address" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">City</label>
                  <input id="emp-edit-city" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">State</label>
                  <input id="emp-edit-state" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div class="col-span-2">
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Zip Code</label>
                  <input id="emp-edit-zip" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
              </div>
            </div>

            <!-- Employment Details -->
            <div class="bg-white rounded-xl p-5 border-2 border-slate-200 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-600">
                <i class="fa-solid fa-briefcase text-blue-600"></i>
                Employment Details
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Hire Date</label>
                  <input id="emp-edit-hire-date" type="date" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Status</label>
                  <select id="emp-edit-status" 
                          class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-bold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                    <option value="Active">âœ“ Active</option>
                    <option value="On Leave">â¸ On Leave</option>
                    <option value="Terminated">âŠ— Terminated</option>
                    <option value="Resigned">â†’ Resigned</option>
                  </select>
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Job Title</label>
                  <input id="emp-edit-job-title" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Department</label>
                  <input id="emp-edit-department" type="text" 
                         class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-medium focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                </div>
                <div class="col-span-2">
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Employment Type</label>
                  <select id="emp-edit-employment-type" 
                          class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-bold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                    <option value="FT">Full-Time</option>
                    <option value="PT">Part-Time</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Compensation -->
            <div class="bg-white rounded-xl p-5 border-2 border-slate-200 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 pb-3 border-b-2 border-green-600">
                <i class="fa-solid fa-money-check-dollar text-green-600"></i>
                Compensation
              </h3>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Compensation Type</label>
                  <select id="emp-edit-comp-type" 
                          class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 bg-white text-sm font-bold focus:border-green-600 focus:ring-2 focus:ring-green-200 transition-all hover:border-slate-400">
                    <option value="hourly">ğŸ’µ Hourly</option>
                    <option value="salary">ğŸ’° Salary</option>
                  </select>
                </div>
                <div id="emp-edit-wage-container">
                  <label id="emp-edit-wage-label" class="block text-xs font-bold text-slate-600 mb-1.5 uppercase tracking-wide">Wage</label>
                  <div class="relative">
                    <span class="absolute left-3 top-1/2 -translate-y-1/2 text-slate-500 font-bold">$</span>
                    <input id="emp-edit-wage" type="number" step="0.01" 
                           class="w-full pl-8 pr-3 py-2.5 rounded-lg border-2 border-slate-300 bg-white text-sm font-bold focus:border-green-600 focus:ring-2 focus:ring-green-200 transition-all hover:border-slate-400">
                  </div>
                </div>
              </div>
            </div>

            <!-- Benefits -->
            <div class="bg-white rounded-xl p-5 border-2 border-slate-200 shadow-sm">
              <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2 pb-3 border-b-2 border-blue-600">
                <i class="fa-solid fa-shield-heart text-blue-600"></i>
                Benefits Package
              </h3>
              
              <!-- Medical -->
              <div class="mb-4 p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <i class="fa-solid fa-hospital text-slate-700 text-lg"></i>
                    <label class="font-bold text-slate-800 text-sm">Medical Insurance</label>
                  </div>
                </div>
                <select id="emp-edit-medical-plan" 
                        class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                  <option value="">No Coverage</option>
                  <option value="WAIVE">Waived</option>
                  <option value="ATBAP393">ATBAP393</option>
                  <option value="ATBAB303">ATBAB303</option>
                </select>
              </div>

              <!-- Dental -->
              <div class="mb-4 p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <i class="fa-solid fa-tooth text-slate-700 text-lg"></i>
                    <label class="font-bold text-slate-800 text-sm">Dental Insurance</label>
                  </div>
                </div>
                <select id="emp-edit-dental-plan" 
                        class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                  <option value="">No Coverage</option>
                  <option value="F-PLAN">F-PLAN</option>
                  <option value="F_PLAN_2W">F_PLAN_2W</option>
                  <option value="F_PLAN_3W">F_PLAN_3W</option>
                </select>
              </div>

              <!-- Vision -->
              <div class="p-4 bg-slate-50 rounded-lg border-2 border-slate-200">
                <div class="flex items-center justify-between mb-3">
                  <div class="flex items-center gap-2">
                    <i class="fa-solid fa-eye text-slate-700 text-lg"></i>
                    <label class="font-bold text-slate-800 text-sm">Vision Insurance</label>
                  </div>
                </div>
                <select id="emp-edit-vision-plan" 
                        class="w-full px-3 py-2.5 rounded-lg border-2 border-slate-300 text-sm font-semibold focus:border-blue-600 focus:ring-2 focus:ring-blue-200 transition-all bg-white hover:border-slate-400">
                  <option value="">No Coverage</option>
                  <option value="UC">UC</option>
                  <option value="PLAN_1">PLAN_1</option>
                </select>
              </div>
            </div>

          </div>

          <!-- RIGHT COLUMN: PDF Viewer (1/3 width) -->
          <div class="lg:col-span-1 p-6 bg-white">
            <div class="sticky top-6">
              <div class="bg-white rounded-xl border-2 border-slate-300 shadow-lg overflow-hidden">
                <div class="bg-slate-800 px-4 py-3 flex items-center justify-between border-b-2 border-blue-600">
                  <h3 class="text-sm font-bold text-white flex items-center gap-2">
                    <i class="fa-solid fa-file-pdf text-red-400"></i>
                    Signed Document
                  </h3>
                  <button id="emp-pdf-download" 
                          class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded-lg text-white text-xs font-bold transition-all flex items-center gap-2 shadow">
                    <i class="fa-solid fa-download"></i>
                    Download
                  </button>
                </div>
                
                <div id="emp-pdf-container" class="bg-slate-100 flex items-center justify-center" style="height: 500px;">
                  <div id="emp-pdf-loading" class="text-center p-6">
                    <i class="fa-solid fa-file-pdf text-slate-400 text-5xl mb-3"></i>
                    <p class="text-slate-600 font-semibold text-sm">No PDF available</p>
                  </div>
                  <iframe id="emp-pdf-viewer" 
                          class="hidden w-full h-full border-0"
                          style="height: 500px;">
                  </iframe>
                </div>
              </div>

              <!-- Auto-save Indicator -->
              <div id="emp-save-indicator" class="hidden mt-4 p-3 bg-green-50 border-2 border-green-500 rounded-lg text-center shadow">
                <i class="fa-solid fa-check-circle text-green-600 mr-2"></i>
                <span class="text-sm font-bold text-green-700">Saved automatically</span>
              </div>
            </div>
          </div>

        </div>
      </div>

      <!-- Footer with Save Button -->
      <div class="bg-slate-100 px-6 py-4 border-t-2 border-slate-300 flex items-center justify-between">
        <div class="flex items-center gap-2 text-sm text-slate-700">
          <i class="fa-solid fa-info-circle text-blue-600"></i>
          <span class="font-semibold">Changes save automatically after 1 second</span>
        </div>
        <div class="flex items-center gap-3">
          <button onclick="saveEmployeeDataNow()" 
                  class="px-6 py-2.5 bg-green-600 hover:bg-green-700 text-white font-black rounded-lg transition-all shadow-lg hover:shadow-xl flex items-center gap-2">
            <i class="fa-solid fa-floppy-disk"></i>
            Save Now
          </button>
          <button onclick="closeEmployeeEditModal()" 
                  class="px-6 py-2.5 bg-slate-700 hover:bg-slate-800 text-white font-bold rounded-lg transition-all shadow-lg hover:shadow-xl">
            Close
          </button>
        </div>
      </div>

    </div>
  </div>
</div>


</body>


<!-- SignaturePad Library -->
<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.1.7/dist/signature_pad.umd.min.js"></script>



</html>
