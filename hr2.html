<!-- FIXED FILE – PART 1/5: DOCTYPE, HEAD, HEADER, NAVIGATION -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Discipline • Compliance • Corrective Action Management</title>

  <!-- Google Fonts: Inter + Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind Configuration (must come before CDN script) -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      corePlugins: {
        container: false,
      },
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            heading: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xs': ['0.96rem', { lineHeight: '1.5' }],
            'sm': ['1.12rem', { lineHeight: '1.5' }],
            'base': ['1.28rem', { lineHeight: '1.6' }],
            'lg': ['1.44rem', { lineHeight: '1.6' }],
            'xl': ['1.6rem', { lineHeight: '1.6' }],
            '2xl': ['1.92rem', { lineHeight: '1.4' }],
            '3xl': ['2.4rem', { lineHeight: '1.3' }],
          },
          colors: {
            brand: {
              50: '#f1f8ff',
              100: '#e0f0ff',
              200: '#b9ddff',
              300: '#80c3ff',
              400: '#4aa7f5',
              500: '#1d8fe3',
              600: '#136fbc',
              700: '#0b5694',
              800: '#083b66',
              900: '#062847',
            },
          },
          boxShadow: {
            subtle: '0 10px 25px rgba(15, 23, 42, 0.06)',
          },
        },
      },
    };
  </script>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Font Awesome Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
        integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
        crossorigin="anonymous" referrerpolicy="no-referrer" />

  <!-- Custom CSS -->
  <style>
  /* ===== SCROLLBAR STYLES ===== */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 9999px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #a5b4fc;
  }

  /* ===== MAKE ALL IMPORTANT TEXT BOLD ===== */
  
  /* Navigation tabs */
  .tab-trigger span,
  nav button span,
  nav a span {
    font-weight: 700 !important;
  }

  /* All uppercase labels (KPIs, section headers) */
  .uppercase,
  .uppercase.tracking-wide {
    font-weight: 700 !important;
  }

  /* Table headers */
  th,
  thead th,
  thead tr th {
    font-weight: 700 !important;
    color: #475569 !important;
  }

  /* Section titles and subtitles */
  h1, h2, h3, h4, h5, h6 {
    font-weight: 700 !important;
  }

  /* Subtitle text and descriptions */
  p.text-xs.text-slate-500,
  p.text-sm.text-slate-500 {
    font-weight: 600 !important;
  }

  /* Form labels */
  label {
    font-weight: 700 !important;
  }

  /* Filter chips and buttons */
  .policy-filter-chip,
  .employee-filter-chip,
  button[data-policy-category],
  button[data-employee-filter] {
    font-weight: 700 !important;
  }

  /* All button text */
  button {
    font-weight: 700 !important;
  }

  /* Badge and chip text */
  .rounded-full {
    font-weight: 700 !important;
  }

  /* Card titles */
  .font-heading {
    font-weight: 700 !important;
  }

  /* KPI values */
  .text-2xl,
  .text-xl,
  .text-lg {
    font-weight: 700 !important;
  }

  /* Table cell labels in Permission matrix */
  td {
    font-weight: 600 !important;
  }

  /* Specific for "Feature / Tab" and similar headers */
  .font-bold,
  [class*="font-bold"] {
    font-weight: 700 !important;
  }

  /* Make all span elements inside headers bold */
  h1 span, h2 span, h3 span, h4 span, h5 span, h6 span {
    font-weight: 700 !important;
  }

  /* Policy library button text */
  .inline-flex.items-center.gap-1,
  .inline-flex.items-center.gap-2 {
    font-weight: 700 !important;
  }

  /* Section descriptions that appear under titles */
  .text-xs.text-slate-500.mt-1,
  .text-xs.text-slate-600 {
    font-weight: 600 !important;
  }

  /* ===== TIMELINE STYLES ===== */
  .timeline-line {
    position: absolute;
    left: 1.25rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #bfdbfe, #1d8fe3);
    opacity: 0.75;
  }

  /* ===== PRINT STYLES ===== */
  @media print {
    .no-print {
      display: none !important;
    }
  }
</style>
</head>

<body class="h-full bg-slate-50 text-slate-900 font-sans" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">

  <!-- Root App Container -->
  <div id="app-root" class="min-h-screen flex flex-col" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">
    
    <!-- Top Navigation / Header -->
    <header class="no-print bg-white shadow-subtle border-b border-slate-100">
      <div class="w-full px-2" style="max-width: 100% !important;">
        <div class="flex items-center justify-between py-4 md:py-5 gap-4">
          <!-- Left: Logo + Title -->
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0">
              <img
                src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
                alt="Jeng Chi Restaurant Logo"
                class="h-24 w-auto rounded-lg shadow-sm border border-slate-100 bg-white object-contain"
              />
            </div>
            <div class="flex flex-col">
              <h1 class="font-heading text-xl sm:text-2xl md:text-3xl tracking-tight text-slate-900">
                Discipline • Compliance • Corrective Action Management
              </h1>
              <p class="text-xs sm:text-sm text-slate-500 mt-1">
                Jeng Chi Restaurant &mdash; Internal HR Discipline, Compliance, and Risk Governance Portal
              </p>
            </div>
          </div>

          <!-- Right: Environment + User -->
          <div class="flex items-center gap-4">
            <div class="hidden sm:flex flex-col items-end text-xs sm:text-sm">
              <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-[0.70rem] sm:text-xs font-medium text-brand-700">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                Internal HR Portal &bull; Production View
              </span>
              <span class="mt-1 text-slate-500">
                Compliance aligned with TWC, DOL, FLSA, and internal JCR governance
              </span>
            </div>
            <div class="flex items-center gap-3">
              <div class="hidden sm:flex flex-col items-end text-xs sm:text-sm">
                <span class="font-medium text-slate-800">HR Admin</span>
                <span class="text-slate-400 text-[0.70rem]">Discipline &amp; Compliance Authority</span>
              </div>
              <div class="flex items-center justify-center rounded-full bg-gradient-to-br from-brand-100 to-brand-500 text-white w-10 h-10 font-heading text-sm shadow-md">
                HR
              </div>
            </div>
          </div>
        </div>

        <!-- Desktop Navigation Tabs -->
        <div class="no-print hidden md:flex items-center justify-between py-2 border-t border-slate-100">
          <nav class="flex items-center gap-1 text-sm font-medium" aria-label="Primary navigation">
            <button
              data-tab-target="dashboard"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full bg-brand-50 text-brand-700 border border-brand-100 shadow-sm transition-all"
            >
              <i class="fa-solid fa-chart-line text-[0.80rem]"></i>
              <span>Dashboard</span>
            </button>
            <button
              data-tab-target="discipline"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-gavel text-[0.80rem]"></i>
              <span>Discipline Cases</span>
            </button>
            <button
              data-tab-target="employees"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-users text-[0.80rem]"></i>
              <span>Employees 360</span>
            </button>
            <button
              data-tab-target="policy"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-scale-balanced text-[0.80rem]"></i>
              <span>Policy Library</span>
            </button>
            <button
              data-tab-target="reports"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-file-chart-column text-[0.80rem]"></i>
              <span>Reports &amp; Analytics</span>
            </button>
            <button
              data-tab-target="admin"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-gear text-[0.80rem]"></i>
              <span>Admin &amp; Settings</span>
            </button>
            <button
              data-tab-target="permissions"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-shield-halved text-[0.80rem]"></i>
              <span>Permissions</span>
            </button>
          </nav>
          <div class="text-[0.70rem] uppercase tracking-wide text-slate-400 font-medium">
            Last refreshed: <span id="header-last-refreshed" class="text-slate-600">--</span>

                       
          </div>

          
        </div>
    <!-- Mobile Navigation Tabs -->
        <div class="no-print md:hidden border-t border-slate-100 py-2">
          <div class="flex items-center justify-between gap-2">
            <label for="mobile-tab-select" class="text-xs font-medium text-slate-500">
              Navigate
            </label>
            <select
              id="mobile-tab-select"
              class="w-2/3 text-xs rounded-full border-slate-200 bg-white px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
            >
              <option value="dashboard">Dashboard</option>
              <option value="discipline">Discipline Cases</option>
              <option value="employees">Employees 360</option>
              <option value="policy">Policy Library</option>
              <option value="reports">Reports &amp; Analytics</option>
              <option value="admin">Admin &amp; Settings</option>
              <option value="permissions">Permissions</option>
            </select>
          </div>
        </div>
      </div>
    </header>
 <!-- Toast Notification Container - REQUIRED FOR showToast() -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Toast / Status Banner -->
    <!-- Toast / Status Banner -->
    <div
      id="global-toast"
      class="no-print fixed z-40 inset-x-0 top-0 flex justify-center pointer-events-none opacity-0 transition-opacity duration-300"
      aria-live="polite"
    >
      <div
        id="global-toast-inner"
        class="mt-20 max-w-xl w-full mx-4 flex items-start gap-3 rounded-2xl border border-emerald-100 bg-white shadow-subtle px-4 py-3 text-sm text-emerald-800 pointer-events-auto"
      >
        <div class="mt-0.5">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p id="global-toast-message" class="font-medium truncate">
            Action saved successfully.
          </p>
          <p id="global-toast-subtext" class="text-xs text-emerald-700 mt-0.5">
            Employee record updated in employees2025 and risk scoring recalculated.
          </p>
        </div>
        <button
          type="button"
          id="global-toast-close"
          class="ml-2 text-xs text-emerald-600 hover:text-emerald-800"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Main Content -->
    <main class="flex-1 w-full" style="max-width: 100% !important; overflow-x: visible;">
      <div class="w-full px-2 py-6 md:py-8 space-y-8" style="max-width: 100% !important; width: 100% !important; overflow-x: visible;">

        <!-- FIXED FILE – PART 2/5: DASHBOARD TAB + DISCIPLINE CASES TAB -->

       <!-- Dashboard Tab -->
<section id="tab-dashboard" class="tab-panel space-y-8">
  <!-- Executive Summary & KPIs -->
  <div class="grid grid-cols-1 lg:grid-cols-5 gap-4">
    
    <!-- KPI: Total Active Employees -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
            Total Active Employees
          </p>
          <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-total-employees">
            --
          </p>
        </div>
        <div class="h-10 w-10 rounded-xl bg-brand-50 flex items-center justify-center">
          <i class="fa-solid fa-users text-brand-500 text-lg"></i>
        </div>
      </div>
      <p class="text-xs text-slate-500 leading-relaxed">
        Count of employees in <span class="font-medium text-slate-700">employees2025</span> with status
        <span class="font-semibold text-emerald-600">Active</span>.
      </p>
    </div>

    <!-- KPI: Employees with Warnings -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
            Employees With Warnings
          </p>
          <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-employees-with-warnings">
            --
          </p>
        </div>
        <div class="h-10 w-10 rounded-xl bg-amber-50 flex items-center justify-center">
          <i class="fa-solid fa-exclamation-triangle text-amber-500 text-lg"></i>
        </div>
      </div>
      <p class="text-xs text-slate-500 leading-relaxed">
        Employees with at least one verbal, written, final warning, or termination letter on file.
      </p>
    </div>

    <!-- KPI: Open Terminations -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
            Open Terminations
          </p>
          <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-open-terminations">
            --
          </p>
        </div>
        <div class="h-10 w-10 rounded-xl bg-rose-50 flex items-center justify-center">
          <i class="fa-solid fa-user-slash text-rose-500 text-lg"></i>
        </div>
      </div>
      <p class="text-xs text-slate-500 leading-relaxed">
        Termination letters issued where termination status remains
        <span class="font-semibold text-rose-600">Pending</span>.
      </p>
    </div>

    <!-- KPI: High-Risk Employees -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
            High-Risk Employees
          </p>
          <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-high-risk-employees">
            --
          </p>
        </div>
        <div class="h-10 w-10 rounded-xl bg-rose-50 flex items-center justify-center">
          <i class="fa-solid fa-fire-flame-curved text-rose-500 text-lg"></i>
        </div>
      </div>
      <p class="text-xs text-slate-500 leading-relaxed">
        Employees whose calculated discipline risk level is flagged as
        <span class="font-semibold text-rose-600">HIGH</span>.
      </p>
    </div>

    <!-- KPI: Terminated Employees -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
      <div class="flex items-center justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
            Terminated Employees
          </p>
          <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-terminated-employees">
            --
          </p>
        </div>
        <div class="h-10 w-10 rounded-xl bg-slate-50 flex items-center justify-center">
          <i class="fa-solid fa-user-xmark text-slate-500 text-lg"></i>
        </div>
      </div>
      <p class="text-xs text-slate-500 leading-relaxed">
        Employees with employment status <span class="font-semibold text-slate-600">Terminated</span>.
      </p>
    </div>

  </div>
  <!-- End of KPI Grid -->

  <!-- Trends and Compliance Snapshot -->
<div class="space-y-6">
  <!-- Top Row: Employees with Actions + Warnings by Dept -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
   <!-- LEFT: Employees with Disciplinary Actions (2/3 width) -->
<div class="lg:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <div class="flex items-center justify-between mb-3">
    <div>
      <h2 class="font-heading text-lg text-slate-900">
        All Disciplinary Actions
      </h2>
      <p class="text-xs text-slate-500 mt-1">
        Click any row to view full details
      </p>
    </div>
    <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
      <i class="fa-solid fa-gavel text-[0.60rem]"></i>
      <span id="discipline-count-badge">--</span> total actions
    </span>
  </div>
  
  <!-- TABLE with individual warnings -->
  <div class="overflow-x-auto max-h-96">
    <table class="w-full text-xs">
      <thead class="sticky top-0 bg-white">
        <tr class="border-b border-slate-200">
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Date & Time</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Employee</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Action Type</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Severity</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Issued By</th>
          <th class="px-3 py-2 text-left font-semibold text-slate-700">Department</th>
        </tr>
      </thead>
      <tbody id="dashboard-discipline-table-body" class="divide-y divide-slate-100">
        <!-- Populated by JS -->
      </tbody>
    </table>
  </div>
</div>

    <!-- RIGHT: Warnings by Department (1/3 width - NARROWER) -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col">
      <div class="flex items-start justify-between mb-3 gap-4">
        <div>
          <h2 class="font-heading text-base text-slate-900">
            Warnings by Dept
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Snapshot by area
          </p>
        </div>
      </div>
      <div class="overflow-x-auto flex-1">
        <table class="min-w-full text-xs border-separate border-spacing-y-1">
          <thead>
            <tr class="text-left text-[0.70rem] text-slate-500">
              <th class="px-2 py-2 font-semibold">Dept</th>
              <th class="px-2 py-2 font-semibold text-center">V</th>
              <th class="px-2 py-2 font-semibold text-center">W</th>
              <th class="px-2 py-2 font-semibold text-center">F</th>
              <th class="px-2 py-2 font-semibold text-center">T</th>
            </tr>
          </thead>
          <tbody id="table-dashboard-warnings-by-dept" class="align-middle">
            <!-- Data will be populated dynamically -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Bottom Row: Chart (full width) -->
  <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col">
    <div class="flex items-center justify-between mb-3">
      <div>
        <h2 class="font-heading text-lg text-slate-900">
          <span id="chart-title-text">Disciplinary Actions Trend</span>
        </h2>
        <p class="text-xs text-slate-500 mt-1">
          Track discipline patterns over time across different timeframes
        </p>
      </div>
      <div class="flex items-center gap-2">
        <label for="chart-timeframe-selector" class="text-xs text-slate-500 font-medium">
          View:
        </label>
        <select 
          id="chart-timeframe-selector" 
          class="text-xs rounded-full border-slate-200 bg-white px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
        >
          <option value="monthly">Monthly (This Year)</option>
          <option value="yearly">Yearly (Last 5 Years)</option>
          <option value="weekly">Weekly (Last 12 Weeks)</option>
        </select>
      </div>
    </div>

    <!-- Chart Container -->
    <div style="width: 100%; overflow-x: auto; overflow-y: visible; margin-bottom: 20px;">
      <div style="position: relative; height: 500px; min-width: 1400px; width: 100%;">
        <canvas id="discipline-trend-chart"></canvas>
      </div>
    </div>

    <!-- Legend -->
    <div class="mt-4 flex flex-wrap items-center gap-3 text-[0.70rem] text-slate-500">
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
        Verbal Warnings
      </div>
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-amber-500"></span>
        Written Warnings
      </div>
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-orange-500"></span>
        Final Warnings
      </div>
      <div class="flex items-center gap-2">
        <span class="w-3 h-3 rounded-full bg-rose-500"></span>
        Terminations
      </div>
    </div>
  </div>
</div>

    <!-- Employees with Discipline List -->
    <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
      <div class="flex items-center justify-between mb-3">
        <div>
          <h2 class="font-heading text-lg text-slate-900">
            Employees with Disciplinary Actions
          </h2>
          <p class="text-xs text-slate-500 mt-1">
            Quick access to employees with recorded warnings or actions
          </p>
        </div>
        <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
          <i class="fa-solid fa-users text-[0.60rem]"></i>
          <span id="discipline-count-badge">--</span> with history
        </span>
      </div>
      <div id="dashboard-discipline-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
        <!-- Will be populated with employee cards -->
      </div>
    </div>
  </div>
</section>

        <!-- Discipline Cases Tab -->
        <section id="tab-discipline" class="tab-panel hidden space-y-6">
          <!-- Discipline Intro + Status Banner -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Overview -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h2 class="font-heading text-xl text-slate-900">
                    Discipline Cases &amp; Corrective Actions
                  </h2>
                  <p class="mt-1 text-xs text-slate-500 leading-relaxed">
                    Use this workspace to issue <span class="font-medium">verbal, written, final warnings</span> and
                    <span class="font-medium">termination notices</span>. Actions taken here will update the source-of-truth
                    table <span class="font-semibold text-slate-800">employees2025</span>, recalculate risk scoring, and
                    support PDF documentation for signatures and record keeping aligned with TWC/DOL guidance.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-2 text-[0.70rem]">
                  <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 border border-brand-100 px-2 py-0.5 text-brand-700 font-medium">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    Live Record Updates
                  </span>
                  <span id="discipline-selected-employee-chip" class="hidden inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    <i class="fa-solid fa-id-badge text-[0.70rem]"></i>
                    <span id="discipline-selected-employee-name" class="font-medium"></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Status Banner -->
            <div class="lg:col-span-3 bg-slate-50 border border-dashed border-slate-300 rounded-2xl px-4 py-3 flex items-start gap-3">
              <div class="mt-0.5">
                <i class="fa-solid fa-circle-info text-brand-500"></i>
              </div>
              <div class="text-xs text-slate-600">
                <p class="font-medium text-slate-800">
                  Discipline Workflow Guidance
                </p>
                <p class="mt-1 leading-relaxed">
                  Before issuing any corrective action, confirm the employee's identity in
                  <span class="font-semibold text-slate-800">Employees 360</span>, validate the facts of the incident, and consult current
                  <span class="font-semibold text-slate-800">Jeng Chi Restaurant policies</span>.
                  All actions must be applied consistently, free from discrimination or retaliation, and aligned with applicable
                  <span class="font-semibold text-slate-800">TWC / DOL</span> standards.
                </p>
              </div>
            </div>
          </div>

          <!-- Discipline Layout: Employee Selector + Form + History -->
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">
            <!-- Left: Quick Employee Picker -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  Quick Employee Selector
                </h3>
                <button
                  id="discipline-refresh-employees"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-[0.70rem] text-slate-600 hover:border-brand-200 hover:bg-brand-50 hover:text-brand-700 transition-colors"
                >
                  <i class="fa-solid fa-rotate-right text-[0.60rem]"></i>
                  <span>Refresh</span>
                </button>
              </div>
              <p class="text-xs text-slate-500">
                Search for an employee and click to load their profile into the discipline form. This ensures the action is tied to the
                correct <span class="font-semibold text-slate-700">employees2025</span> record.
              </p>

              <!-- Search with Autocomplete -->
              <div class="relative flex-1">
                <input
                  id="discipline-employee-search"
                  type="text"
                  placeholder="Search by name or Employee ID (type 3+ letters)"
                  class="w-full rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  autocomplete="off"
                />
                <!-- Autocomplete dropdown -->
                <div
                  id="discipline-search-dropdown"
                  class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg max-h-64 overflow-y-auto"
                >
                  <!-- Suggestions will appear here -->
                </div>
              </div>

              <div id="discipline-employee-results" class="mt-3 max-h-64 overflow-y-auto space-y-2">
                <!-- Populated dynamically with small employee cards -->
              </div>
            </div>

            <!-- Middle: New Disciplinary Action Form -->
            <div class="xl:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  New Disciplinary Action
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-[0.70rem] text-slate-600">
                  <i class="fa-solid fa-lock text-[0.60rem]"></i>
                  <span>Confidential HR Record</span>
                </span>
              </div>

              <form id="discipline-form" class="space-y-4">
                <!-- Hidden field for employee id -->
                <input type="hidden" id="discipline-employee-id" />

                <!-- Type + Date -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div class="sm:col-span-2">
                    <label for="discipline-action-type" class="block text-xs font-heading text-slate-800 mb-1">
                      Type of Corrective Action <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-action-type"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select action type</option>
                      <option value="VERBAL_WARNING">Verbal Warning</option>
                      <option value="WRITTEN_WARNING">Written Warning</option>
                      <option value="FINAL_WARNING">Final Warning</option>
                      <option value="TERMINATION">Termination</option>
                    </select>
                  </div>
                  <div>
                    <label for="discipline-action-date" class="block text-xs font-heading text-slate-800 mb-1">
                      Action Date <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="date"
                      id="discipline-action-date"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                </div>


                <!-- NEW: Category Selection -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
  <div>
    <label for="discipline-main-category" class="block text-xs font-heading text-slate-800 mb-1">
      Main Category <span class="text-rose-500">*</span>
    </label>
    <select
      id="discipline-main-category"
      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
      required
    >
      <option value="">Select main category...</option>
      <option value="attendance">Attendance & Punctuality</option>
      <option value="performance">Performance Issues</option>
      <option value="conduct">Conduct & Behavior</option>
      <option value="policy">Policy Violations</option>
      <option value="safety">Safety & Health</option>
      <option value="customer">Customer Service</option>
      <option value="integrity">Integrity & Honesty</option>
    </select>
  </div>
  
  <div>
    <label for="discipline-sub-category" class="block text-xs font-heading text-slate-800 mb-1">
      Sub-Category / Specific Issue <span class="text-rose-500">*</span>
    </label>
    <select
      id="discipline-sub-category"
      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
      required
      disabled
    >
      <option value="">Select main category first...</option>
    </select>
  </div>
</div>

                <!-- Severity + Reference -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-severity" class="block text-xs font-heading text-slate-800 mb-1">
                      Severity <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-severity"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select severity</option>
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                    </select>
                  </div>
                  <div class="sm:col-span-2">
                    <label for="discipline-reference" class="block text-xs font-heading text-slate-800 mb-1">
                      Internal Reference / Incident ID
                    </label>
                    <input
                      type="text"
                      id="discipline-reference"
                      placeholder="Optional reference to incident report, video log, or complaint ticket"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Reason -->
                <div>
                  <label for="discipline-reason" class="block text-xs font-heading text-slate-800 mb-1">
                    Reason / Policy Violations <span class="text-rose-500">*</span>
                  </label>
                  <textarea
                    id="discipline-reason"
                    rows="4"
                    placeholder="Describe the incident, including dates, facts, witnesses, and specific Jeng Chi policy sections and TWC/DOL standards implicated."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    required
                  ></textarea>
                </div>

                <!-- Corrective Plan -->
                <div>
                  <label for="discipline-plan" class="block text-xs font-heading text-slate-800 mb-1">
                    Corrective Action Plan / Notes
                  </label>
                  <textarea
                    id="discipline-plan"
                    rows="4"
                    placeholder="Outline expectations, timelines, coaching, retraining, or final performance thresholds for the employee."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  ></textarea>
                </div>

                <!-- Signatures -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-manager-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Manager Typed Signature <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="discipline-manager-signature"
                      placeholder="Manager full name"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                  <div>
                    <label for="discipline-hr-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      HR Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-hr-signature"
                      placeholder="HR representative (optional)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                  <div>
                    <label for="discipline-employee-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Employee Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-employee-signature"
                      placeholder="Employee full name (if signing)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Acknowledgment -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-xs">
                  <label class="inline-flex items-start gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      id="discipline-employee-declined"
                      class="mt-0.5 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                    />
                    <span class="text-slate-600">
                      Employee declined to sign. Action is acknowledged only, and a signed copy will be provided per JCR policy.
                    </span>
                  </label>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                  <div class="flex items-center gap-2 text-[0.70rem] text-slate-500">
                    <i class="fa-solid fa-scale-balanced text-brand-500"></i>
                    <span>
                      By submitting, you confirm this action is consistent, non-retaliatory, and based solely on documented facts.
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="discipline-form-reset"
                      class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
                    >
                      <i class="fa-solid fa-eraser text-[0.70rem]"></i>
                      <span>Reset Form</span>
                    </button>
                    <button
                      type="submit"
                      id="discipline-form-submit"
                      class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600 disabled:opacity-60 disabled:cursor-not-allowed"
                    >
                      <span id="discipline-form-submit-spinner" class="hidden">
                        <i class="fa-solid fa-spinner fa-spin text-[0.80rem]"></i>
                      </span>
                      <span id="discipline-form-submit-text">Record Action &amp; Generate PDF</span>
                    </button>
                  </div>
                </div>

                <!-- Inline form status -->
                <div id="discipline-form-status" class="hidden rounded-xl border px-3 py-2 text-[0.70rem] mt-2">
                  <!-- Populated dynamically -->
                </div>
              </form>
            </div>
          </div>

          <!-- Discipline History & Audit Trail -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 items-start">
            <!-- History Timeline -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 relative">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Disciplinary History Timeline
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Chronological view of all corrective actions applied to the selected employee.
                  </p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-timeline text-[0.60rem]"></i>
                  <span>Most Recent First</span>
                </span>
              </div>

              <div class="mt-4 relative">
                <div class="timeline-line"></div>
                <div id="discipline-history-timeline" class="space-y-4 pl-8">
                  <!-- Timeline entries will be rendered here -->
                  <p class="text-xs text-slate-400">
                    Select an employee in <span class="font-medium text-slate-700">Employees 360</span> or in the
                    <span class="font-medium text-slate-700">Quick Employee Selector</span> to view their discipline history.
                  </p>
                </div>
              </div>
            </div>

            <!-- Audit Trail (Tabular) -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Discipline Audit Trail
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Evidence-ready list of actions, suitable for TWC hearings, DOL audits, or internal investigations.
                  </p>
                </div>
                <button
                  type="button"
                  id="discipline-audit-export"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-[0.70rem] text-slate-600 hover:bg-brand-50 hover:border-brand-200 hover:text-brand-700"
                >
                  <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                  <span>Export Timeline PDF</span>
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="min-w-full text-xs border-separate border-spacing-y-1">
                  <thead>
                    <tr class="text-[0.70rem] text-slate-500 text-left">
                      <th class="px-3 py-2 font-semibold">Timestamp</th>
                      <th class="px-3 py-2 font-semibold">Action</th>
                      <th class="px-3 py-2 font-semibold">Severity</th>
                      <th class="px-3 py-2 font-semibold">User</th>
                      <th class="px-3 py-2 font-semibold">Reference</th>
                    </tr>
                  </thead>
                  <tbody id="discipline-audit-table-body">
                    <!-- Populated with discipline_history entries -->
                    <tr class="bg-slate-50/60">
                      <td class="px-3 py-2 text-slate-400" colspan="5">
                        Audit entries will appear here when an employee with history is selected.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="mt-4 text-[0.70rem] text-slate-500 leading-relaxed">
                For each corrective action, this table references data persisted in
                <span class="font-semibold text-slate-800">employees2025.discipline_history</span>,
                combined with front-end context such as the acting user (e.g., "HR Admin" or "Manager").
                Together with PostgreSQL triggers
                <span class="font-semibold text-slate-800">set_employees_last_modified</span> and
                <span class="font-semibold text-slate-800">trg_log_employee_changes</span>,
                this creates a layered, defensible audit model.
              </p>
            </div>
          </div>
        </section>

        <!-- FIXED FILE – PART 3/5: EMPLOYEES 360 TAB + POLICY LIBRARY TAB -->

        <!-- Employees 360 Tab -->
        <section id="tab-employees" class="tab-panel hidden space-y-6">
          <!-- Hidden field to store current employee ID being edited -->
          <input type="hidden" id="current-employee-360-id" value="" />

          <!-- Header Row -->
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Employees 360 &mdash; Discipline &amp; Risk View
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Search, select, and review an employee's full discipline profile, warnings, and risk level in one consolidated, executive-friendly card.
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button
                id="employees-refresh-button"
                type="button"
                class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
              >
                <i class="fa-solid fa-arrows-rotate text-[0.70rem]"></i>
                <span>Refresh Employees</span>
              </button>
            </div>
          </div>

          <!-- Search + Layout -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            <!-- Search + List -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3">
              <div>
                <label for="employees-search-input" class="block text-xs font-heading text-slate-800 mb-1">
                  Search Employees
                </label>
                <!-- Search input with autocomplete container -->
                <div class="relative flex-1">
                  <input
                    id="employees-search-input"
                    type="text"
                    placeholder="Search by name, employee ID, or department (type 3+ letters)"
                    class="w-full rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    autocomplete="off"
                  />
                  <!-- Autocomplete dropdown -->
                  <div
                    id="employees-search-dropdown"
                    class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg max-h-64 overflow-y-auto"
                  >
                    <!-- Suggestions will appear here -->
                  </div>
                </div>
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Uses <span class="font-medium text-slate-700">employees2025</span> as the single source of truth.
                </p>
              </div>

              <div class="mt-2 flex flex-wrap gap-2 text-[0.70rem]">
                <button
                  type="button"
                  data-employee-filter="all"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-brand-100 bg-brand-50 px-2 py-1 text-brand-700 font-medium"
                >
                  <span>All</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="Active"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-slate-600"
                >
                  <span>Active</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="Terminated"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-slate-600"
                >
                  <span>Terminated</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="HighRisk"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-rose-100 bg-rose-50 px-2 py-1 text-rose-600"
                >
                  <span>High Risk</span>
                </button>
              </div>

              <div id="employee-list" class="mt-3 max-h-[420px] overflow-y-auto space-y-2 text-xs">
                <!-- Employee list items will be rendered here -->
                <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-2 text-slate-400">
                  Run a search or refresh employees to load a list of profiles from employees2025.
                </div>
              </div>
            </div>

            <!-- Employee Profile 360 -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Overview Card -->
              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                <!-- Save Button Section -->
                <div class="flex items-center justify-between mb-4 pb-3 border-b border-slate-200">
                  <div class="flex items-center gap-2">
                    <div class="w-2 h-2 rounded-full bg-emerald-500" id="save-status-indicator"></div>
                    <span class="text-xs font-semibold text-slate-600" id="save-status-text">Ready to edit</span>
                  </div>
                  <button
                    type="button"
                    id="btn-save-employee-360"
                    class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600 disabled:opacity-60 disabled:cursor-not-allowed transition-all"
                  >
                    <i class="fa-solid fa-floppy-disk"></i>
                    <span>Save Changes to employees2025</span>
                  </button>
                </div>

                <!-- Profile Header -->
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                  <div class="flex-1">
                    <div class="flex items-center gap-3 mb-2">
                      <h3 id="employee-profile-name" class="font-heading text-lg text-slate-900">
                        Select an employee
                      </h3>
                    </div>
                    <p id="employee-profile-title" class="text-xs text-slate-500 mt-0.5">
                      Job title &bull; Department
                    </p>
                    <p id="employee-profile-status" class="mt-1 text-[0.70rem] text-slate-500">
                      Employment status, hire dates, and reporting structure will appear here.
                    </p>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    <div id="employee-profile-risk-badge" class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-[0.70rem] text-slate-600">
                      <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                      <span>Risk Score: &mdash;</span>
                    </div>
                    <div class="flex flex-wrap justify-end gap-2 text-[0.70rem]">
                      <span id="employee-profile-employee-id" class="inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-slate-600">
                        <i class="fa-solid fa-hashtag text-[0.60rem]"></i>
                        <span>Employee ID: --</span>
                      </span>
                      <span id="employee-profile-username" class="inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-slate-600">
                        <i class="fa-solid fa-user text-[0.60rem]"></i>
                        <span>Username: --</span>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- KPI Row -->
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Verbal Warnings
                    </span>
                    <span id="employee-kpi-verbal" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Written Warnings
                    </span>
                    <span id="employee-kpi-written" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Final Warnings
                    </span>
                    <span id="employee-kpi-final" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Termination Letters
                    </span>
                    <span id="employee-kpi-termination" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                </div>
              </div>

              <!-- Two-column details: Employment & Contact, Risk & Tenure -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                <!-- Employment & Contact Details - Editable -->
                <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                  <h4 class="font-heading text-sm font-bold text-slate-900 mb-3">
                    Employment &amp; Contact Details
                  </h4>
                  
                  <div class="grid grid-cols-1 gap-3 text-xs">
                    <!-- Employment Status -->
                    <div>
                      <label for="edit-employment-status" class="block font-bold text-slate-700 mb-1">
                        Employment Status
                      </label>
                      <select
                        id="edit-employment-status"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      >
                        <option value="Active">Active</option>
                        <option value="Terminated">Terminated</option>
                        <option value="On Leave">On Leave</option>
                        <option value="Suspended">Suspended</option>
                      </select>
                    </div>

                    <!-- First Name -->
                    <div>
                      <label for="edit-first-name" class="block font-bold text-slate-700 mb-1">
                        First Name
                      </label>
                      <input
                        type="text"
                        id="edit-first-name"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="First name"
                      />
                    </div>

                    <!-- Last Name -->
                    <div>
                      <label for="edit-last-name" class="block font-bold text-slate-700 mb-1">
                        Last Name
                      </label>
                      <input
                        type="text"
                        id="edit-last-name"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Last name"
                      />
                    </div>

                    <!-- Job Title -->
                    <div>
                      <label for="edit-job-title" class="block font-bold text-slate-700 mb-1">
                        Job Title
                      </label>
                      <input
                        type="text"
                        id="edit-job-title"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Job title"
                      />
                    </div>

                    <!-- Position Title -->
                    <div>
                      <label for="edit-position-title" class="block font-bold text-slate-700 mb-1">
                        Position Title
                      </label>
                      <input
                        type="text"
                        id="edit-position-title"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Position title"
                      />
                    </div>

                    <!-- Department -->
                    <div>
                      <label for="edit-department" class="block font-bold text-slate-700 mb-1">
                        Department
                      </label>
                      <select
                        id="edit-department"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      >
                        <option value="">Select department</option>
                        <option value="Management">Management</option>
                        <option value="Kitchen">Kitchen</option>
                        <option value="Front of House">Front of House</option>
                        <option value="Bar">Bar</option>
                        <option value="Host">Host</option>
                        <option value="Server">Server</option>
                        <option value="Bartender">Bartender</option>
                        <option value="Dumpling Maker">Dumpling Maker</option>
                        <option value="Kitchen Prep">Kitchen Prep</option>
                        <option value="Dishwasher">Dishwasher</option>
                        <option value="Logistic Coordinator">Logistic Coordinator</option>
                        <option value="Unassigned">Unassigned</option>
                      </select>
                    </div>

                    <!-- Manager / Reports To -->
                    <div>
                      <label for="edit-report-to" class="block font-bold text-slate-700 mb-1">
                        Manager / Reports To
                      </label>
                      <input
                        type="text"
                        id="edit-report-to"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Manager name"
                      />
                    </div>

                    <!-- Email -->
                    <div>
                      <label for="edit-email" class="block font-bold text-slate-700 mb-1">
                        Email
                      </label>
                      <input
                        type="email"
                        id="edit-email"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="email@example.com"
                      />
                    </div>

                    <!-- Phone -->
                    <div>
                      <label for="edit-phone" class="block font-bold text-slate-700 mb-1">
                        Phone
                      </label>
                      <input
                        type="tel"
                        id="edit-phone"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="(555) 123-4567"
                      />
                    </div>

                    <!-- Address Line 1 -->
                    <div>
                      <label for="edit-address-line-1" class="block font-bold text-slate-700 mb-1">
                        Address Line 1
                      </label>
                      <input
                        type="text"
                        id="edit-address-line-1"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Street address"
                      />
                    </div>

                    <!-- Address Line 2 -->
                    <div>
                      <label for="edit-address-line-2" class="block font-bold text-slate-700 mb-1">
                        Address Line 2
                      </label>
                      <input
                        type="text"
                        id="edit-address-line-2"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="Apt, suite, unit (optional)"
                      />
                    </div>

                    <!-- City -->
                    <div>
                      <label for="edit-city" class="block font-bold text-slate-700 mb-1">
                        City
                      </label>
                      <input
                        type="text"
                        id="edit-city"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="City"
                      />
                    </div>

                    <!-- State -->
                    <div>
                      <label for="edit-state" class="block font-bold text-slate-700 mb-1">
                        State
                      </label>
                      <input
                        type="text"
                        id="edit-state"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="State"
                        maxlength="2"
                      />
                    </div>

                    <!-- Zip Code -->
                    <div>
                      <label for="edit-zip-code" class="block font-bold text-slate-700 mb-1">
                        Zip Code
                      </label>
                      <input
                        type="text"
                        id="edit-zip-code"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="12345"
                      />
                    </div>
                  </div>
                </div>

                <!-- Tenure, Risk & Employment Dates - Editable -->
                <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                  <h4 class="font-heading text-sm font-bold text-slate-900 mb-3">
                    Tenure, Risk &amp; Employment Dates
                  </h4>
                  
                  <div class="grid grid-cols-1 gap-3 text-xs">
                    <!-- Original Hire Date -->
                    <div>
                      <label for="edit-original-hire-date" class="block font-bold text-slate-700 mb-1">
                        Original Hire Date
                      </label>
                      <input
                        type="date"
                        id="edit-original-hire-date"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      />
                    </div>

                    <!-- Current Hire Date -->
                    <div>
                      <label for="edit-hire-date" class="block font-bold text-slate-700 mb-1">
                        Current Hire Date
                      </label>
                      <input
                        type="date"
                        id="edit-hire-date"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      />
                    </div>

                    <!-- Tenure (Read-only, calculated) -->
                    <div>
                      <label class="block font-bold text-slate-700 mb-1">
                        Tenure (Calculated)
                      </label>
                      <div id="display-tenure" class="w-full rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 text-xs text-slate-600">
                        --
                      </div>
                    </div>

                    <!-- Hourly Rate -->
                    <div>
                      <label for="edit-hourly-rate" class="block font-bold text-slate-700 mb-1">
                        Hourly Rate
                      </label>
                      <input
                        type="number"
                        id="edit-hourly-rate"
                        step="0.01"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="0.00"
                      />
                    </div>

                    <!-- Annual Salary -->
                    <div>
                      <label for="edit-annual-salary" class="block font-bold text-slate-700 mb-1">
                        Annual Salary
                      </label>
                      <input
                        type="number"
                        id="edit-annual-salary"
                        step="0.01"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="0.00"
                      />
                    </div>

                    <!-- Risk Score (Read-only, calculated) -->
                    <div>
                      <label class="block font-bold text-slate-700 mb-1">
                        Risk Score (Calculated)
                      </label>
                      <div id="display-risk-score" class="w-full rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 text-xs text-slate-600">
                        --
                      </div>
                    </div>

                    <!-- Risk Level -->
                    <div>
                      <label for="edit-risk-level" class="block font-bold text-slate-700 mb-1">
                        Risk Level
                      </label>
                      <select
                        id="edit-risk-level"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      >
                        <option value="LOW">LOW</option>
                        <option value="MEDIUM">MEDIUM</option>
                        <option value="HIGH">HIGH</option>
                      </select>
                    </div>

                    <!-- HR Witness -->
                    <div>
                      <label for="edit-hr-witness" class="block font-bold text-slate-700 mb-1">
                        HR Witness
                      </label>
                      <input
                        type="text"
                        id="edit-hr-witness"
                        class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                        placeholder="HR witness name"
                      />
                    </div>

                    <!-- Last Disciplinary Action (Read-only) -->
                    <div>
                      <label class="block font-bold text-slate-700 mb-1">
                        Last Disciplinary Action
                      </label>
                      <div id="display-last-action" class="w-full rounded-lg border border-slate-200 bg-slate-100 px-3 py-2 text-xs text-slate-600">
                        --
                      </div>
                    </div>
                  </div>

                  <p class="mt-3 text-[0.70rem] text-slate-500 leading-relaxed">
                    Risk scoring is calculated using the JCR discipline model:
                    <span class="font-medium text-slate-700">1 point</span> per verbal warning,
                    <span class="font-medium text-slate-700">2 points</span> per written warning,
                    <span class="font-medium text-slate-700">3 points</span> per final warning,
                    and <span class="font-medium text-slate-700">4 points</span> per termination letter. Thresholds drive
                    <span class="font-semibold text-emerald-600">LOW</span>,
                    <span class="font-semibold text-amber-600">MEDIUM</span>, or
                    <span class="font-semibold text-rose-600">HIGH</span> risk flags.
                  </p>
                </div>
              </div>

              <!-- Employee History + Summary -->
              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                <div class="flex items-center justify-between gap-2">
                  <h4 class="font-heading text-sm text-slate-900">
                    Employee Discipline Summary
                  </h4>
                  <button
                    type="button"
                    id="employee-summary-pdf"
                    class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-[0.70rem] text-slate-600 hover:bg-brand-50 hover:border-brand-200 hover:text-brand-700"
                  >
                    <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                    <span>Download 360 PDF</span>
                  </button>
                </div>

                <div id="employee-summary-history" class="mt-3 text-xs text-slate-500">
                  <p>
                    Once an employee is selected, a concise narrative summary of their discipline history and risk posture will be generated here.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Policy Library Tab -->
        <section id="tab-policy" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Policy Library &amp; Reference
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Centralized view of external guidance and internal Jeng Chi Restaurant discipline policies used to inform corrective actions.
              </p>
            </div>
          </div>

          <!-- Filter Pills -->
          <div class="flex flex-wrap gap-2 text-[0.70rem]">
            <button
              type="button"
              data-policy-category="twc-dol"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-brand-700 font-medium"
            >
              <i class="fa-solid fa-scale-balanced text-[0.70rem]"></i>
              <span>TWC / DOL Guidance</span>
            </button>
            <button
              type="button"
              data-policy-category="internal"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-building text-[0.70rem]"></i>
              <span>Internal JCR Policies</span>
            </button>
            <button
              type="button"
              data-policy-category="discipline"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-gavel text-[0.70rem]"></i>
              <span>Discipline &amp; Corrective Action</span>
            </button>
            <button
              type="button"
              data-policy-category="complaint"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-comments text-[0.70rem]"></i>
              <span>Complaint &amp; Investigation Procedures</span>
            </button>
          </div>

          <!-- Policies Accordion -->
          <div id="policy-accordion" class="space-y-4 text-xs">
            <!-- TWC / DOL Guidance -->
            <article
              data-policy-category-panel="twc-dol"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    TWC / DOL Consistent Documentation Practices
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Align disciplinary documentation with requirements commonly reviewed in Texas Workforce Commission and U.S. Department of Labor proceedings.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-06-01
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Maintain <span class="font-medium">fact-based, contemporaneous documentation</span> for each incident, including dates, times, witnesses, and specific behaviors observed.
                  </li>
                  <li>
                    Ensure that <span class="font-medium">policies are communicated</span> to all employees, with signed acknowledgments held in personnel files or the digital portal.
                  </li>
                  <li>
                    Apply discipline <span class="font-medium">consistently across similarly situated employees</span> to mitigate allegations of disparate treatment or retaliation.
                  </li>
                  <li>
                    Use a <span class="font-medium">progressive discipline model</span> where appropriate (verbal, written, final, termination), while preserving the employer's right to accelerate steps when warranted.
                  </li>
                  <li>
                    Retain records for a reasonable period consistent with <span class="font-medium">TWC, DOL, and internal retention schedules</span>.
                  </li>
                </ul>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  This summary is provided for HR guidance and does not replace consultation with qualified legal counsel.
                </p>
              </div>
            </article>

            <!-- Internal JCR Policies -->
            <article
              data-policy-category-panel="internal"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    JCR Standard of Conduct &amp; Zero-Tolerance Areas
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Internal expectations for professional conduct, customer care, safety, and respect in the workplace.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-04-15
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    JCR maintains a <span class="font-medium">zero-tolerance policy</span> for violence, harassment, discrimination, and retaliation.
                  </li>
                  <li>
                    Employees must follow all <span class="font-medium">food safety, health, and cleanliness standards</span> applicable to restaurant operations.
                  </li>
                  <li>
                    Timekeeping, tip reporting, and wage-and-hour rules must be followed accurately and honestly.
                  </li>
                  <li>
                    All discipline should be documented in this portal to provide an <span class="font-medium">accurate 360° record</span>.
                  </li>
                  <li>
                    Any deviation from progressive discipline must be <span class="font-medium">approved by HR</span> and documented with rationale.
                  </li>
                </ul>
              </div>
            </article>

            <!-- Discipline & Corrective Action -->
            <article
              data-policy-category-panel="discipline"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Progressive Discipline Framework
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Structured approach guiding verbal, written, final, and termination decisions at Jeng Chi Restaurant.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-05-10
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ol class="list-decimal list-inside space-y-1">
                  <li>
                    <span class="font-medium">Coaching &amp; Verbal Feedback</span> &mdash; early-stage, non-punitive coaching that may be documented as a verbal warning when patterns emerge.
                  </li>
                  <li>
                    <span class="font-medium">Written Warning</span> &mdash; formal documentation of the issue, expectations, and timeline for improvement.
                  </li>
                  <li>
                    <span class="font-medium">Final Warning</span> &mdash; last opportunity to correct behavior, document clear consequences for non-compliance.
                  </li>
                  <li>
                    <span class="font-medium">Termination</span> &mdash; when the relationship must end, with a focus on professionalism, documentation, and consistent policy application.
                  </li>
                </ol>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  Leadership should consult HR before issuing final warnings or terminations, especially where protected activity or past complaints may be relevant.
                </p>
              </div>
            </article>

            <!-- Complaint & Investigation -->
            <article
              data-policy-category-panel="complaint"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Complaint Intake &amp; Investigation Procedures
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Processes for receiving, documenting, and investigating concerns raised by employees, guests, or vendors.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-03-20
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Complaints may be raised <span class="font-medium">verbally or in writing</span> to any manager or HR.
                  </li>
                  <li>
                    All complaints must be documented in a <span class="font-medium">central log</span>, with dates, participants, and next steps.
                  </li>
                  <li>
                    Investigations should be <span class="font-medium">prompt, impartial, and confidential</span> to the extent possible.
                  </li>
                  <li>
                    Retaliation against individuals who raise concerns or participate in investigations is strictly prohibited.
                  </li>
                  <li>
                    Outcomes of investigations should be documented and communicated appropriately, with discipline applied as needed.
                  </li>
                </ul>
              </div>
            </article>
          </div>

          <!-- AI Disclaimer -->
          <div class="rounded-2xl border border-dashed border-amber-200 bg-amber-50/50 px-4 py-3 text-[0.70rem] text-amber-800">
            <p class="font-semibold">
              AI-Assisted Content &amp; Legal Review
            </p>
            <p class="mt-1">
              Some explanatory language in this Policy Library has been drafted or structured using AI-assisted tools for clarity and
              consistency. These materials are provided for <span class="font-semibold">HR reference only</span> and do not constitute legal advice.
              Jeng Chi Restaurant leadership and HR must review, adapt, and approve all policy content, and should consult qualified labor
              and employment counsel to confirm alignment with current TWC, DOL, and applicable law.
            </p>
          </div>
        </section>
        <!-- FIXED FILE – PART 4/5: REPORTS TAB + ADMIN TAB + PERMISSIONS TAB + CLOSING TAGS -->

        <!-- Reports & Analytics Tab -->
        <section id="tab-reports" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Reports &amp; Analytics
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Comprehensive dashboards, trend analysis, and exportable reports for leadership review and compliance audits.
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button
                id="reports-refresh-data"
                type="button"
                class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
              >
                <i class="fa-solid fa-arrows-rotate text-[0.70rem]"></i>
                <span>Refresh Data</span>
              </button>
              <button
                id="reports-export-summary"
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-brand-500 px-3 py-2 text-xs font-semibold text-white hover:bg-brand-600"
              >
                <i class="fa-solid fa-file-export text-[0.70rem]"></i>
                <span>Export Summary PDF</span>
              </button>
            </div>
          </div>

          <!-- Summary KPIs -->
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <!-- Total Discipline Actions YTD -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                    Total Actions YTD
                  </p>
                  <p id="reports-kpi-total-actions" class="mt-2 font-heading text-2xl text-slate-900">
                    --
                  </p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-slate-50">
                  <i class="fa-solid fa-list-check text-slate-400 text-sm"></i>
                </div>
              </div>
              <p class="mt-2 text-[0.70rem] text-slate-500">
                All discipline actions recorded this year
              </p>
            </div>

            <!-- Average Time to Resolution -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                    Avg. Time to Resolution
                  </p>
                  <p id="reports-kpi-avg-resolution" class="mt-2 font-heading text-2xl text-slate-900">
                    --
                  </p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-amber-50">
                  <i class="fa-solid fa-clock text-amber-400 text-sm"></i>
                </div>
              </div>
              <p class="mt-2 text-[0.70rem] text-slate-500">
                Days from issue to action completion
              </p>
            </div>

            <!-- Termination Rate -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                    Termination Rate
                  </p>
                  <p id="reports-kpi-termination-rate" class="mt-2 font-heading text-2xl text-slate-900">
                    --
                  </p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-rose-50">
                  <i class="fa-solid fa-user-slash text-rose-400 text-sm"></i>
                </div>
              </div>
              <p class="mt-2 text-[0.70rem] text-slate-500">
                Percentage of employees terminated
              </p>
            </div>

            <!-- High-Risk Employee Count -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between">
                <div class="flex-1">
                  <p class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                    High-Risk Employees
                  </p>
                  <p id="reports-kpi-high-risk-count" class="mt-2 font-heading text-2xl text-slate-900">
                    --
                  </p>
                </div>
                <div class="flex items-center justify-center w-10 h-10 rounded-full bg-rose-50">
                  <i class="fa-solid fa-fire text-rose-400 text-sm"></i>
                </div>
              </div>
              <p class="mt-2 text-[0.70rem] text-slate-500">
                Employees flagged as high risk
              </p>
            </div>
          </div>

          <!-- Charts Row -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Discipline Actions by Type -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-heading text-sm text-slate-900">
                  Discipline Actions by Type
                </h3>
                <select
                  id="reports-chart-type-timeframe"
                  class="rounded-lg border border-slate-200 bg-slate-50 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                >
                  <option value="ytd">Year to Date</option>
                  <option value="last-30">Last 30 Days</option>
                  <option value="last-90">Last 90 Days</option>
                  <option value="all-time">All Time</option>
                </select>
              </div>
              <div class="h-64">
                <canvas id="reports-chart-by-type"></canvas>
              </div>
            </div>

            <!-- Discipline Actions by Department -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-heading text-sm text-slate-900">
                  Actions by Department
                </h3>
                <select
                  id="reports-chart-dept-timeframe"
                  class="rounded-lg border border-slate-200 bg-slate-50 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                >
                  <option value="ytd">Year to Date</option>
                  <option value="last-30">Last 30 Days</option>
                  <option value="last-90">Last 90 Days</option>
                  <option value="all-time">All Time</option>
                </select>
              </div>
              <div class="h-64">
                <canvas id="reports-chart-by-department"></canvas>
              </div>
            </div>
          </div>

          <!-- Trend Line Chart -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-heading text-sm text-slate-900">
                Discipline Trend Over Time
              </h3>
              <select
                id="reports-trend-timeframe"
                class="rounded-lg border border-slate-200 bg-slate-50 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="monthly">Monthly (Last 12 Months)</option>
                <option value="weekly">Weekly (Last 12 Weeks)</option>
                <option value="yearly">Yearly</option>
              </select>
            </div>
            <div style="height: 400px; min-width: 1400px; overflow-x: auto;">
              <canvas id="reports-trend-chart"></canvas>
            </div>
          </div>

          <!-- Detailed Reports Table -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <div class="flex items-center justify-between mb-3">
              <h3 class="font-heading text-sm text-slate-900">
                Detailed Action Report
              </h3>
              <div class="flex items-center gap-2">
                <select
                  id="reports-table-filter"
                  class="rounded-lg border border-slate-200 bg-slate-50 px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                >
                  <option value="all">All Actions</option>
                  <option value="verbal">Verbal Warnings</option>
                  <option value="written">Written Warnings</option>
                  <option value="final">Final Warnings</option>
                  <option value="termination">Terminations</option>
                </select>
                <button
                  id="reports-table-export-csv"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-lg border border-slate-200 bg-slate-50 px-2 py-1 text-xs text-slate-600 hover:bg-slate-100"
                >
                  <i class="fa-solid fa-file-csv text-[0.70rem]"></i>
                  <span>Export CSV</span>
                </button>
              </div>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-xs">
                <thead>
                  <tr class="border-b border-slate-200">
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Date</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Employee</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Department</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Action Type</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Severity</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Reason</th>
                    <th class="px-3 py-2 text-left font-heading text-slate-700">Reference</th>
                  </tr>
                </thead>
                <tbody id="reports-table-body" class="divide-y divide-slate-100">
                  <tr>
                    <td colspan="7" class="px-3 py-4 text-center text-slate-400">
                      No data available. Refresh to load recent discipline actions.
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>

          <!-- Risk Distribution -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Employee Risk Distribution
            </h3>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <div class="rounded-xl bg-emerald-50 border border-emerald-100 p-4">
                <div class="flex items-center justify-between">
                  <span class="font-heading text-emerald-900">Low Risk</span>
                  <span id="reports-risk-low-count" class="font-heading text-xl text-emerald-900">--</span>
                </div>
                <p class="mt-1 text-[0.70rem] text-emerald-700">
                  Minimal or no disciplinary history
                </p>
              </div>
              <div class="rounded-xl bg-amber-50 border border-amber-100 p-4">
                <div class="flex items-center justify-between">
                  <span class="font-heading text-amber-900">Medium Risk</span>
                  <span id="reports-risk-medium-count" class="font-heading text-xl text-amber-900">--</span>
                </div>
                <p class="mt-1 text-[0.70rem] text-amber-700">
                  Some warnings, require monitoring
                </p>
              </div>
              <div class="rounded-xl bg-rose-50 border border-rose-100 p-4">
                <div class="flex items-center justify-between">
                  <span class="font-heading text-rose-900">High Risk</span>
                  <span id="reports-risk-high-count" class="font-heading text-xl text-rose-900">--</span>
                </div>
                <p class="mt-1 text-[0.70rem] text-rose-700">
                  Multiple warnings or final status
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin Settings Tab -->
        <section id="tab-admin" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Admin Settings
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Configure risk thresholds, notification preferences, and system-wide defaults for the discipline portal.
              </p>
            </div>
            <button
              id="admin-save-settings"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-floppy-disk"></i>
              <span>Save All Settings</span>
            </button>
          </div>

          <!-- Risk Score Thresholds -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Risk Score Thresholds
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Define the point thresholds that determine LOW, MEDIUM, and HIGH risk levels for employees based on their discipline history.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <!-- Low Risk Threshold -->
              <div>
                <label for="admin-threshold-low" class="block font-bold text-slate-700 mb-1">
                  Low Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-low"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score below this = Low Risk
                </p>
              </div>

              <!-- Medium Risk Threshold -->
              <div>
                <label for="admin-threshold-medium" class="block font-bold text-slate-700 mb-1">
                  Medium Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-medium"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 5"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = Medium Risk
                </p>
              </div>

              <!-- High Risk Threshold -->
              <div>
                <label for="admin-threshold-high" class="block font-bold text-slate-700 mb-1">
                  High Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-high"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 8"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = High Risk
                </p>
              </div>
            </div>
          </div>

          <!-- Action Point Weights -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Action Point Weights
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Assign point values to each type of disciplinary action for risk score calculation.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-xs">
              <!-- Verbal Warning Points -->
              <div>
                <label for="admin-points-verbal" class="block font-bold text-slate-700 mb-1">
                  Verbal Warning
                </label>
                <input
                  type="number"
                  id="admin-points-verbal"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="1"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per verbal warning
                </p>
              </div>

              <!-- Written Warning Points -->
              <div>
                <label for="admin-points-written" class="block font-bold text-slate-700 mb-1">
                  Written Warning
                </label>
                <input
                  type="number"
                  id="admin-points-written"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per written warning
                </p>
              </div>

              <!-- Final Warning Points -->
              <div>
                <label for="admin-points-final" class="block font-bold text-slate-700 mb-1">
                  Final Warning
                </label>
                <input
                  type="number"
                  id="admin-points-final"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="3"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per final warning
                </p>
              </div>

              <!-- Termination Points -->
              <div>
                <label for="admin-points-termination" class="block font-bold text-slate-700 mb-1">
                  Termination Letter
                </label>
                <input
                  type="number"
                  id="admin-points-termination"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="4"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per termination letter
                </p>
              </div>
            </div>
          </div>

          <!-- Notification Settings -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Notification Settings
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure when and how the system sends alerts to HR and management.
            </p>
            <div class="space-y-3 text-xs">
              <!-- Notify on High Risk -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-high-risk"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-high-risk" class="font-bold text-slate-700 cursor-pointer">
                    Notify when employee reaches High Risk
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send an alert to HR when an employee's risk score crosses the high-risk threshold.
                  </p>
                </div>
              </div>

              <!-- Notify on Final Warning -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-final-warning"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-final-warning" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Final Warning is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Alert leadership when a final warning is documented in the system.
                  </p>
                </div>
              </div>

              <!-- Notify on Termination -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-termination"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-termination" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Termination Letter is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send immediate notification to HR and legal when a termination is processed.
                  </p>
                </div>
              </div>

              <!-- Daily Summary -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-daily-summary"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-daily-summary" class="font-bold text-slate-700 cursor-pointer">
                    Send daily discipline summary
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Email a daily summary of all discipline actions to designated recipients.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Display Preferences -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Display Preferences
            </h3>
            <div class="space-y-3 text-xs">
              <!-- Show Employee Photos -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-photos"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-photos" class="font-bold text-slate-700 cursor-pointer">
                    Show employee photos in lists
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Display profile photos next to employee names throughout the portal.
                  </p>
                </div>
              </div>

              <!-- Compact Mode -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-compact"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-compact" class="font-bold text-slate-700 cursor-pointer">
                    Use compact table views
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Reduce spacing in tables and lists for more data density.
                  </p>
                </div>
              </div>

              <!-- Auto-refresh Dashboard -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-auto-refresh"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-auto-refresh" class="font-bold text-slate-700 cursor-pointer">
                    Auto-refresh dashboard every 5 minutes
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Automatically refresh dashboard data when the tab is active.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Retention -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Data Retention
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure how long the system retains discipline records and audit trails.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              <!-- Discipline Records Retention -->
              <div>
                <label for="admin-retention-discipline" class="block font-bold text-slate-700 mb-1">
                  Discipline Records Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-discipline"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Recommended: 7 years per TWC guidance
                </p>
              </div>

              <!-- Audit Trail Retention -->
              <div>
                <label for="admin-retention-audit" class="block font-bold text-slate-700 mb-1">
                  Audit Trail Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-audit"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  System logs and change history
                </p>
              </div>
            </div>
          </div>

          <!-- Save Confirmation -->
          <div id="admin-save-status" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-xs text-emerald-800">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-circle-check text-emerald-600"></i>
              <span class="font-semibold">Settings saved successfully!</span>
            </div>
          </div>
        </section>

        <!-- Permissions Tab -->
        <section id="tab-permissions" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Permissions &amp; Access Control
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Manage who can view, edit, and administer the discipline portal. Define role-based permissions for HR, managers, and administrators.
              </p>
            </div>
            <button
              id="permissions-add-admin"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-user-plus"></i>
              <span>Add Administrator</span>
            </button>
          </div>

          <!-- Current Administrators -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Portal Administrators
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Users with full administrative access to all tabs, settings, and data.
  </p>
  <div class="space-y-2 text-xs">
    <!-- Admin User 1 -->
    <div class="flex items-center justify-between rounded-lg border border-slate-100 bg-slate-50 px-3 py-2">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-500 text-white font-heading text-xs">
          PG
        </div>
        <div>
          <p class="font-bold text-slate-900">Pablo Gonzalez</p>
          <p class="text-[0.70rem] text-slate-500">pablo@jengchirestaurant.com</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-200 px-2 py-1 text-[0.70rem] text-brand-700 font-medium">
          <i class="fa-solid fa-shield-halved text-[0.60rem]"></i>
          <span>Owner</span>
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Role-Based Access Matrix -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Role-Based Access Matrix
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Define what each role can view and edit across the portal. Changes save automatically.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700 min-w-[250px]">
            Feature / Tab
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-shield-halved text-brand-500 mb-1"></i>
              <span>Admin</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-user-tie text-slate-500 mb-1"></i>
              <span>Manager</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-eye text-slate-500 mb-1"></i>
              <span>Viewer</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        
        <!-- Dashboard - View KPIs & Charts -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard — View KPIs & Charts</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Dashboard - Export Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard — Export Reports & Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - View History -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases — View History</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Create & Edit Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases — Create & Edit Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Delete Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases — Delete Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Export PDFs -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases — Export to PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - View Profiles -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 — View Profiles</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Employee Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 — Edit Employee Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Salaries & Compensation -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 — Edit Salaries & Compensation</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Terminate Employees -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 — Terminate Employees</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Export 360 PDF -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 — Export 360 PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="viewer" />
          </td>
        </tr>

      <!-- Policy Library - View Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library — View Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Policy Library - Edit Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library — Edit Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - View Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports — View Reports & Analytics</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - Export Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports — Export Data & PDFs</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Admin Settings - Access -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Admin Settings — Access Settings</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="viewer" />
          </td>
        </tr>

        <!-- Permissions - Manage Permissions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Permissions — Manage User Permissions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="viewer" />
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <p class="mt-4 text-xs text-slate-500">
    💡 <strong>Auto-save enabled:</strong> Permission changes are saved automatically to the database and logged in the audit trail.
  </p>
</div>

<!-- Audit Log (Optional - can be added later) -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Permission Changes Audit Log
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Track all permission modifications for compliance and security review.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700">Timestamp</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Action</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">User Affected</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Changed By</th>
        </tr>
      </thead>
      <tbody id="permissions-audit-log" class="divide-y divide-slate-100">
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

</section>
<!-- 👆 END OF PERMISSIONS TAB -->

</div>
<!-- 👆 END OF TAB CONTAINER -->
</main>
<!-- 👆 END OF MAIN -->

</div>
<!-- 👆 END OF APP ROOT -->

<!-- ============================================================================ -->
<!-- 🎯 MODAL MUST BE HERE - OUTSIDE ALL SECTIONS, OUTSIDE MAIN, INSIDE BODY -->
<!-- ============================================================================ -->

<!-- Warning Details Modal - FIXED FOOTER VERSION -->
<div id="warning-detail-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

    <!-- Modal panel with FIXED structure -->
    <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-h-[90vh] flex flex-col">
      
      <!-- FIXED HEADER -->
      <div class="bg-white px-6 pt-5 pb-4 border-b border-slate-200 flex-shrink-0">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-lg font-heading font-bold text-slate-900" id="modal-title">
              Edit Disciplinary Action
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Update action details and save changes
            </p>
          </div>
          
          <!-- WARNING COUNTER (Top Right) -->
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-end gap-1">
              <div class="flex items-center gap-2 text-xs">
                <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 border border-emerald-200 px-2 py-1 text-emerald-700 font-bold">
                  <i class="fa-solid fa-message text-[0.60rem]"></i>
                  <span id="modal-verbal-count">0</span> Verbal
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 border border-amber-200 px-2 py-1 text-amber-700 font-bold">
                  <i class="fa-solid fa-file-lines text-[0.60rem]"></i>
                  <span id="modal-written-count">0</span> Written
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-orange-50 border border-orange-200 px-2 py-1 text-orange-700 font-bold">
                  <i class="fa-solid fa-triangle-exclamation text-[0.60rem]"></i>
                  <span id="modal-final-count">0</span> Final
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-rose-50 border border-rose-200 px-2 py-1 text-rose-700 font-bold">
                  <i class="fa-solid fa-ban text-[0.60rem]"></i>
                  <span id="modal-termination-count">0</span> Term
                </span>
              </div>
            </div>
            
            <button type="button" id="close-warning-modal" class="rounded-lg text-slate-400 hover:text-slate-600 focus:outline-none">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="modal-action-employee-id" />
      <input type="hidden" id="modal-action-index" />

      <!-- SCROLLABLE BODY -->
      <div class="flex-1 overflow-y-auto px-6 py-4">
        <form id="modal-edit-form" class="space-y-4 text-sm">
          
          <!-- Employee Information (Read-only) -->
          <div class="bg-slate-50 rounded-lg p-3">
            <h4 class="text-xs font-bold text-slate-700 uppercase mb-2">Employee Information</h4>
            <div class="grid grid-cols-3 gap-3 text-xs">
              <div>
                <p class="text-slate-500 text-[0.70rem]">Name</p>
                <p class="font-bold text-slate-900" id="modal-employee-name">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Employee ID</p>
                <p class="font-bold text-slate-900" id="modal-employee-id">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Department</p>
                <p class="font-bold text-slate-900" id="modal-employee-dept">--</p>
              </div>
            </div>
          </div>

          <!-- Action Details - EDITABLE -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="modal-edit-type" class="block text-xs font-bold text-slate-700 mb-1">
                Action Type
              </label>
              <select
                id="modal-edit-type"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="VERBAL_WARNING">Verbal Warning</option>
                <option value="WRITTEN_WARNING">Written Warning</option>
                <option value="FINAL_WARNING">Final Warning</option>
                <option value="TERMINATION">Termination</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-severity" class="block text-xs font-bold text-slate-700 mb-1">
                Severity
              </label>
              <select
                id="modal-edit-severity"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-date" class="block text-xs font-bold text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                id="modal-edit-date"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              />
            </div>

            <div>
              <label for="modal-edit-main-category" class="block text-xs font-bold text-slate-700 mb-1">
                Main Category
              </label>
              <select
                id="modal-edit-main-category"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="">Select category...</option>
                <option value="attendance">Attendance & Punctuality</option>
                <option value="performance">Performance Issues</option>
                <option value="conduct">Conduct & Behavior</option>
                <option value="policy">Policy Violations</option>
                <option value="safety">Safety & Health</option>
                <option value="customer">Customer Service</option>
                <option value="integrity">Integrity & Honesty</option>
              </select>
            </div>
          </div>

          <!-- Sub-Category (Dynamic based on Main Category) -->
          <div>
            <label for="modal-edit-sub-category" class="block text-xs font-bold text-slate-700 mb-1">
              Sub-Category / Specific Issue
            </label>
            <select
              id="modal-edit-sub-category"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
            >
              <option value="">Select main category first...</option>
            </select>
          </div>

          <!-- Reason - EDITABLE -->
          <div>
            <label for="modal-edit-reason" class="block text-xs font-bold text-slate-700 mb-1">
              Reason for Action
            </label>
            <textarea
              id="modal-edit-reason"
              rows="4"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Describe the incident and policy violations..."
            ></textarea>
          </div>

          <!-- Corrective Action Plan - EDITABLE -->
          <div>
            <label for="modal-edit-plan" class="block text-xs font-bold text-slate-700 mb-1">
              Corrective Action Plan
            </label>
            <textarea
              id="modal-edit-plan"
              rows="3"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Outline expectations and improvement plan..."
            ></textarea>
          </div>

          <!-- Signatures - EDITABLE -->
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label for="modal-edit-manager-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Manager Signature
              </label>
              <input
                type="text"
                id="modal-edit-manager-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Manager name"
              />
            </div>

            <div>
              <label for="modal-edit-hr-sig" class="block text-xs font-bold text-slate-700 mb-1">
                HR Signature
              </label>
              <input
                type="text"
                id="modal-edit-hr-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="HR representative"
              />
            </div>

            <div>
              <label for="modal-edit-employee-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Employee Signature
              </label>
              <input
                type="text"
                id="modal-edit-employee-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Employee name or DECLINED"
              />
            </div>
          </div>

        </form>
      </div>

      <!-- FIXED FOOTER with buttons -->
      <div class="bg-white px-6 py-4 border-t border-slate-200 flex-shrink-0">
        <div class="flex justify-between items-center gap-3">
          <button 
            type="button" 
            id="modal-delete-btn" 
            class="inline-flex items-center gap-2 rounded-full border border-rose-300 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 transition-colors"
          >
            <i class="fa-solid fa-trash"></i>
            Delete Action
          </button>

          <div class="flex gap-2">
            <button 
              type="button" 
              id="modal-close-btn" 
              class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button" 
              id="modal-export-pdf" 
              class="inline-flex items-center gap-2 rounded-full border border-brand-300 bg-white px-4 py-2 text-xs font-semibold text-brand-700 hover:bg-brand-50 transition-colors"
            >
              <i class="fa-solid fa-file-pdf"></i>
              Export PDF
            </button>
            <button 
  type="button" 
  id="modal-save-btn" 
  class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-5 py-2 text-xs font-bold text-black shadow-sm hover:bg-brand-600 transition-colors"
>
  <i class="fa-solid fa-floppy-disk"></i>
  <span>Save Changes</span>
</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

</body>
<!-- 👆 END OF BODY -->

<script type="module">
        

      // ========================================================================
      // SUPABASE CLIENT INITIALIZATION
      // ========================================================================
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;


// ========================================================================
// 🎯 ENHANCED CONSOLE LOGGING - START
// ========================================================================
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('🚀 Jeng Chi HR Discipline Portal Starting...');
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
console.log('📍 Supabase URL:', SUPABASE_URL);
console.log('✅ Database client initialized');
console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
// ========================================================================
// 🎯 ENHANCED CONSOLE LOGGING - END
// ========================================================================

// ========================================================================
// APPLICATION STATE
// ========================================================================



      // ========================================================================
      // APPLICATION STATE
      // ========================================================================
      const AppState = {
        employees: [],
        selectedEmployee: null,
        employeeFilterStatus: 'all',
        currentTab: 'dashboard',
        charts: {
          disciplineTrend: null,
          reportsByType: null,
          reportsByDept: null,
          reportsTrend: null
        },
        settings: {
          thresholds: { low: 2, medium: 5, high: 8 },
          points: { verbal: 1, written: 2, final: 3, termination: 4 },
          notifications: {
            highRisk: true,
            finalWarning: true,
            termination: true,
            dailySummary: false
          },
          display: {
            photos: true,
            compact: false,
            autoRefresh: false
          },
          retention: {
            discipline: 7,
            audit: 7
          }
        }
      };

      // Autocomplete state for search inputs
      const AutocompleteState = {
        discipline: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        },
        employees: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        }
      };

      // ========================================================================
      // UTILITY FUNCTIONS
      // ========================================================================
      
      function formatDate(dateString) {
        if (!dateString) return '--';
        const date = new Date(dateString);
        return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
      }

      function calculateTenure(hireDate) {
        if (!hireDate) return '--';
        const hire = new Date(hireDate);
        const now = new Date();
        const diffTime = Math.abs(now - hire);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        const years = Math.floor(diffDays / 365);
        const months = Math.floor((diffDays % 365) / 30);
        if (years > 0) {
          return `${years} year${years > 1 ? 's' : ''}, ${months} month${months !== 1 ? 's' : ''}`;
        }
        return `${months} month${months !== 1 ? 's' : ''}`;
      }

      function computeRiskScore(employee) {
        const { verbal_warning_count = 0, disciplinary_warning_count = 0, final_warning_count = 0, termination_letter_count = 0 } = employee;
        const { points } = AppState.settings;
        return (
          verbal_warning_count * points.verbal +
          disciplinary_warning_count * points.written +
          final_warning_count * points.final +
          termination_letter_count * points.termination
        );
      }

      function getRiskLevel(score) {
        const { thresholds } = AppState.settings;
        if (score >= thresholds.high) return 'HIGH';
        if (score >= thresholds.medium) return 'MEDIUM';
        return 'LOW';
      }

      function getRiskBadgeClasses(level) {
        switch (level) {
          case 'HIGH':
            return 'bg-rose-50 border-rose-200 text-rose-700';
          case 'MEDIUM':
            return 'bg-amber-50 border-amber-200 text-amber-700';
          default:
            return 'bg-emerald-50 border-emerald-200 text-emerald-700';
        }
      }

      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-rose-500' : 'bg-brand-500';
        toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-lg text-sm flex items-center gap-2`;
        toast.innerHTML = `
          <i class="fa-solid fa-circle-info"></i>
          <span>${message}</span>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ========================================================================
      // TAB SWITCHING
      // ========================================================================
      
      function showTab(tabName) {
  console.log('🔄 Switching to tab:', tabName);
        // Hide all tab panels
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.classList.add('hidden');
        });

        // Remove active state from all tab buttons
        document.querySelectorAll('.tab-btn').forEach(btn => {
          btn.classList.remove('bg-brand-500', 'text-white', 'shadow-subtle');
          btn.classList.add('bg-white', 'text-slate-600');
        });

        // Show selected tab panel
        const targetPanel = document.getElementById(`tab-${tabName}`);
        if (targetPanel) {
          targetPanel.classList.remove('hidden');
        }

        // Highlight active tab button
        const activeBtn = document.querySelector(`[data-tab="${tabName}"]`);
        if (activeBtn) {
          activeBtn.classList.add('bg-brand-500', 'text-white', 'shadow-subtle');
          activeBtn.classList.remove('bg-white', 'text-slate-600');
        }

        AppState.currentTab = tabName;

        // Tab-specific initialization
        if (tabName === 'dashboard') {
          updateDashboard();
        } else if (tabName === 'reports') {
          updateReports();
        }
      }

      // ========================================================================
      // EMPLOYEE DATA LOADING
      // ========================================================================
      
      async function loadEmployees() {
  console.log('');
  console.log('📊 DATABASE OPERATION: Loading Employees');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  console.log('🔄 Executing query: SELECT * FROM employees2025');
  
  try {
    const startTime = performance.now();
    
    const { data, error } = await supabaseClient
      .from('employees2025')
      .select('*')
      .order('last_name', { ascending: true });

    const endTime = performance.now();
    const duration = (endTime - startTime).toFixed(2);
    console.log(`⏱️  Query completed in ${duration}ms`);

    if (error) {
      console.error('❌ DATABASE ERROR:');
      console.error('   Message:', error.message);
      console.error('   Code:', error.code);
      console.error('   Details:', error.details);
      throw error;
    }

    AppState.employees = data || [];
    
    console.log(`✅ SUCCESS: Loaded ${data.length} employees`);
    console.log('');
    console.log('📋 First 3 employees:');
    data.slice(0, 3).forEach((emp, i) => {
      console.log(`   ${i + 1}. ${emp.first_name} ${emp.last_name} (${emp.employee_id})`);
    });
    
    console.log('');
    console.log('📈 Statistics:');
    const active = data.filter(e => e.employment_status === 'Active').length;
    const withWarnings = data.filter(e => 
      (e.verbal_warning_count || 0) > 0 || 
      (e.disciplinary_warning_count || 0) > 0
    ).length;
    console.log(`   • Total: ${data.length}`);
    console.log(`   • Active: ${active}`);
    console.log(`   • With warnings: ${withWarnings}`);
    console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    
    showToast(`Loaded ${AppState.employees.length} employees`, 'success');
    // Update last refreshed timestamp
const refreshEl = document.getElementById('header-last-refreshed');
if (refreshEl) {
  const now = new Date();
  refreshEl.textContent = now.toLocaleString('en-US', { 
    month: 'short', 
    day: 'numeric', 
    hour: '2-digit', 
    minute: '2-digit' 
  });
}
    
    // Update UI elements that depend on employee data
    if (AppState.currentTab === 'dashboard') {
      updateDashboard();
    }
    
    return data;
  } catch (error) {
    console.error('');
    console.error('💥 CRITICAL ERROR in loadEmployees()');
    console.error('   Error:', error.message);
    console.error('   Stack:', error.stack);
    console.error('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
    showToast('Failed to load employees: ' + error.message, 'error');
    return [];
  }
}

      function filterEmployees(filterType) {
        AppState.employeeFilterStatus = filterType;
        
        let filtered = [...AppState.employees];
        
        if (filterType === 'Active') {
          filtered = filtered.filter(emp => emp.employment_status === 'Active');
        } else if (filterType === 'Terminated') {
          filtered = filtered.filter(emp => emp.employment_status === 'Terminated');
        } else if (filterType === 'HighRisk') {
          filtered = filtered.filter(emp => {
            const score = computeRiskScore(emp);
            return getRiskLevel(score) === 'HIGH';
          });
        }
        
        return filtered;
      }

      // ========================================================================
      // DASHBOARD TAB FUNCTIONS
      // ========================================================================
      
      function updateDashboard() {
        updateDashboardKPIs();
        populateDashboardWarningsByDept();
        populateDashboardDisciplineList();
      }

      function updateDashboardKPIs() {
        const activeEmployees = AppState.employees.filter(e => e.employment_status === 'Active');
        const employeesWithWarnings = AppState.employees.filter(e => 
          (e.verbal_warning_count || 0) > 0 || 
          (e.disciplinary_warning_count || 0) > 0 || 
          (e.final_warning_count || 0) > 0
        );
        const openTerminations = AppState.employees.filter(e => e.termination_status === 'Open');
        const highRiskEmployees = AppState.employees.filter(e => {
          const score = computeRiskScore(e);
          return getRiskLevel(score) === 'HIGH';
        });
  const terminatedEmployees = AppState.employees.filter(e => e.employment_status === 'Terminated');

       // CHANGED: Show total count instead of just active
  document.getElementById('kpi-total-employees').textContent = AppState.employees.length; // ← Now shows 62
  document.getElementById('kpi-employees-with-warnings').textContent = employeesWithWarnings.length;
  document.getElementById('kpi-open-terminations').textContent = openTerminations.length;
  document.getElementById('kpi-high-risk-employees').textContent = highRiskEmployees.length;
    document.getElementById('kpi-terminated-employees').textContent = terminatedEmployees.length;

      }

     function populateDashboardWarningsByDept() {
  const tbody = document.getElementById('table-dashboard-warnings-by-dept');
  if (!tbody) return;

  const deptStats = {};
  
  AppState.employees.forEach(emp => {
    const dept = emp.department || 'Unassigned';
    if (!deptStats[dept]) {
      deptStats[dept] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    deptStats[dept].verbal += emp.verbal_warning_count || 0;
    deptStats[dept].written += emp.disciplinary_warning_count || 0;
    deptStats[dept].final += emp.final_warning_count || 0;
    deptStats[dept].termination += emp.termination_letter_count || 0;
  });

  tbody.innerHTML = '';
  Object.entries(deptStats).forEach(([dept, stats]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-3 py-2 text-slate-900 font-medium">${dept}</td>
      <td class="px-3 py-2 text-slate-600 text-center">${stats.verbal}</td>
      <td class="px-3 py-2 text-slate-600 text-center">${stats.written}</td>
      <td class="px-3 py-2 text-slate-600 text-center">${stats.final}</td>
      <td class="px-3 py-2 text-slate-600 text-center">${stats.termination}</td>
    `;
    tbody.appendChild(row);
  });
}
    function populateDashboardDisciplineList() {
  const tbody = document.getElementById('dashboard-discipline-table-body');
  const badge = document.getElementById('discipline-count-badge');
  if (!tbody || !badge) return;

  console.log('📋 Populating dashboard discipline list...');

  // Collect ALL individual actions from all employees
  const allActions = [];
  
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history) && emp.discipline_history.length > 0) {
      emp.discipline_history.forEach((action, index) => {
        allActions.push({
          ...action,
          employeeId: emp.id,
          employeeName: `${emp.first_name} ${emp.last_name}`,
          employeeNumber: emp.employee_id,
          department: emp.department || 'N/A',
          originalIndex: index // Store original index for editing
        });
      });
    }
  });

  // Sort by date descending (newest first)
  allActions.sort((a, b) => {
    const dateA = new Date(a.date || a.timestamp);
    const dateB = new Date(b.date || b.timestamp);
    return dateB - dateA;
  });

  badge.textContent = allActions.length;
  tbody.innerHTML = '';

  if (allActions.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="6" class="px-3 py-4 text-center text-slate-400">
          No disciplinary actions found
        </td>
      </tr>
    `;
    return;
  }

  // Render each action as a row
  allActions.forEach(action => {
    const actionDate = new Date(action.date || action.timestamp);
    const dateStr = actionDate.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });
    const timeStr = actionDate.toLocaleTimeString('en-US', { 
      hour: '2-digit', 
      minute: '2-digit' 
    });
    
    // Determine color for action type
    let typeBg = 'bg-slate-100 text-slate-700';
    const actionType = (action.type || '').toUpperCase();
    if (actionType.includes('VERBAL')) typeBg = 'bg-emerald-100 text-emerald-700';
    else if (actionType.includes('WRITTEN')) typeBg = 'bg-amber-100 text-amber-700';
    else if (actionType.includes('FINAL')) typeBg = 'bg-orange-100 text-orange-700';
    else if (actionType.includes('TERMINATION')) typeBg = 'bg-rose-100 text-rose-700';
    
    // Determine color for severity
    let severityBg = 'bg-slate-100 text-slate-700';
    const severity = (action.severity || '').toUpperCase();
    if (severity === 'LOW') severityBg = 'bg-emerald-100 text-emerald-700';
    else if (severity === 'MEDIUM') severityBg = 'bg-amber-100 text-amber-700';
    else if (severity === 'HIGH') severityBg = 'bg-rose-100 text-rose-700';
    
    const row = document.createElement('tr');
    row.className = 'hover:bg-brand-50 cursor-pointer transition-colors';
    row.innerHTML = `
      <td class="px-3 py-2">
        <div class="flex flex-col">
          <span class="font-bold text-slate-900">${dateStr}</span>
          <span class="text-[0.70rem] text-slate-500">${timeStr}</span>
        </div>
      </td>
      <td class="px-3 py-2">
        <div class="flex flex-col">
          <span class="font-bold text-slate-900">${action.employeeName}</span>
          <span class="text-[0.70rem] text-slate-500">${action.employeeNumber || '--'}</span>
        </div>
      </td>
      <td class="px-3 py-2">
        <span class="inline-flex items-center px-2 py-1 rounded-full text-[0.70rem] font-bold ${typeBg}">
          ${action.type || 'N/A'}
        </span>
      </td>
      <td class="px-3 py-2">
        <span class="inline-flex items-center px-2 py-1 rounded-full text-[0.70rem] font-bold ${severityBg}">
          ${action.severity || 'N/A'}
        </span>
      </td>
      <td class="px-3 py-2 text-slate-700">
        ${action.manager_signature || action.hr_signature || 'System'}
      </td>
      <td class="px-3 py-2 text-slate-600">
        ${action.department}
      </td>
    `;
    
    // ✅ CLICK TO OPEN MODAL - Make sure this is working
    row.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevent event bubbling
      console.log('🖱️ Row clicked, opening modal for:', action.employeeName);
      showWarningDetailModal(action);
    });
    
    tbody.appendChild(row);
  });

  console.log(`✅ Rendered ${allActions.length} actions in dashboard table`);
}


// ========================================================================
// MODAL FUNCTIONS - EDITABLE VERSION
// ========================================================================

// Show modal with action data (FAST VERSION - no database calls)
function showWarningDetailModal(action) {
  console.log('🎯 Opening modal for action:', action);
  
  const modal = document.getElementById('warning-detail-modal');
  if (!modal) {
    console.error('❌ Modal element not found!');
    return;
  }
  
  // Store IDs for save operation
  document.getElementById('modal-action-employee-id').value = action.employeeId;
  document.getElementById('modal-action-index').value = action.originalIndex || 0;
  
  // Populate read-only employee info
  document.getElementById('modal-employee-name').textContent = action.employeeName;
  document.getElementById('modal-employee-id').textContent = action.employeeNumber || 'N/A';
  document.getElementById('modal-employee-dept').textContent = action.department;
  
  // ✅ POPULATE WARNING COUNTERS
  const employee = AppState.employees.find(e => e.id === action.employeeId);
  if (employee) {
    document.getElementById('modal-verbal-count').textContent = employee.verbal_warning_count || 0;
    document.getElementById('modal-written-count').textContent = employee.disciplinary_warning_count || 0;
    document.getElementById('modal-final-count').textContent = employee.final_warning_count || 0;
    document.getElementById('modal-termination-count').textContent = employee.termination_letter_count || 0;
  }
  
  // Populate editable fields
  const actionType = action.type?.toUpperCase().replace(/\s+/g, '_') || 'VERBAL_WARNING';
  document.getElementById('modal-edit-type').value = actionType;
  
  document.getElementById('modal-edit-severity').value = action.severity || 'MEDIUM';
  
  // Fix date format
  let dateValue = '';
  if (action.date) {
    const d = new Date(action.date);
    if (!isNaN(d.getTime())) {
      dateValue = d.toISOString().split('T')[0];
    }
  }
  document.getElementById('modal-edit-date').value = dateValue;
  
  // ✅ Populate category fields
  document.getElementById('modal-edit-main-category').value = action.main_category || '';
  
  // Trigger sub-category population
  const mainCategoryDropdown = document.getElementById('modal-edit-main-category');
  const event = new Event('change');
  mainCategoryDropdown.dispatchEvent(event);
  
  // Set sub-category after options are loaded
  setTimeout(() => {
    document.getElementById('modal-edit-sub-category').value = action.sub_category || '';
  }, 10);
  
  document.getElementById('modal-edit-reason').value = action.reason || '';
  document.getElementById('modal-edit-plan').value = action.corrective_plan || '';
  document.getElementById('modal-edit-manager-sig').value = action.manager_signature || '';
  document.getElementById('modal-edit-hr-sig').value = action.hr_signature || '';
  document.getElementById('modal-edit-employee-sig').value = action.employee_signature || '';
  
  // Show modal
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  console.log('✅ Modal opened successfully');
}



// Close modal
function closeWarningModal() {
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }
}

// Save updated action to database
async function saveWarningModal() {
  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const saveBtn = document.getElementById('modal-save-btn');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

 // Get updated values from form
const updatedAction = {
  type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
  date: document.getElementById('modal-edit-date').value,
  severity: document.getElementById('modal-edit-severity').value,
  main_category: document.getElementById('modal-edit-main-category').value,  // ← ADD
  sub_category: document.getElementById('modal-edit-sub-category').value,    // ← ADD
  reason: document.getElementById('modal-edit-reason').value,
  corrective_plan: document.getElementById('modal-edit-plan').value,
  manager_signature: document.getElementById('modal-edit-manager-sig').value,
  hr_signature: document.getElementById('modal-edit-hr-sig').value,
  employee_signature: document.getElementById('modal-edit-employee-sig').value,
  timestamp: employee.discipline_history?.[actionIndex]?.timestamp || new Date().toISOString()
};
    // Update the specific action in history array
    const history = [...(employee.discipline_history || [])];
    if (actionIndex >= 0 && actionIndex < history.length) {
      history[actionIndex] = updatedAction;
    }

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history[history.length - 1]
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('✅ Action updated successfully!', 'success');
    closeWarningModal();
    
    // Reload data and refresh display
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error saving action:', error);
    showToast('❌ Failed to save changes', 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
  }
}

// Delete action from database
async function deleteWarningModal() {
  if (!confirm('Are you sure you want to delete this disciplinary action? This cannot be undone.')) {
    return;
  }

  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const deleteBtn = document.getElementById('modal-delete-btn');
  deleteBtn.disabled = true;
  deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

    // Remove action from history
    const history = [...(employee.discipline_history || [])];
    history.splice(actionIndex, 1);

    // Recalculate counts
    const counts = {
      verbal_warning_count: 0,
      disciplinary_warning_count: 0,
      final_warning_count: 0,
      termination_letter_count: 0
    };

    history.forEach(action => {
      const type = action.type.toUpperCase();
      if (type.includes('VERBAL')) counts.verbal_warning_count++;
      else if (type.includes('WRITTEN')) counts.disciplinary_warning_count++;
      else if (type.includes('FINAL')) counts.final_warning_count++;
      else if (type.includes('TERMINATION')) counts.termination_letter_count++;
    });

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history.length > 0 ? history[history.length - 1] : null,
        ...counts
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('✅ Action deleted successfully', 'success');
    closeWarningModal();
    
    // Reload data
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error deleting action:', error);
    showToast('❌ Failed to delete action', 'error');
  } finally {
    deleteBtn.disabled = false;
    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Action';
  }
}

// Generate PDF from modal data
function generateWarningPDF() {
  const action = {
    employeeName: document.getElementById('modal-employee-name').textContent,
    employeeNumber: document.getElementById('modal-employee-id').textContent,
    department: document.getElementById('modal-employee-dept').textContent,
    type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
    date: document.getElementById('modal-edit-date').value,
    severity: document.getElementById('modal-edit-severity').value,
    reference: document.getElementById('modal-edit-reference').value,
    reason: document.getElementById('modal-edit-reason').value,
    corrective_plan: document.getElementById('modal-edit-plan').value,
    manager_signature: document.getElementById('modal-edit-manager-sig').value,
    hr_signature: document.getElementById('modal-edit-hr-sig').value,
    employee_signature: document.getElementById('modal-edit-employee-sig').value
  };

  const actionDate = new Date(action.date);
  const dateStr = actionDate.toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
  
  const content = `
    <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #7a1f1f; padding-bottom: 20px;">
        <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
        <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
        <p><strong>Name:</strong> ${action.employeeName}</p>
        <p><strong>Employee ID:</strong> ${action.employeeNumber}</p>
        <p><strong>Department:</strong> ${action.department}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Action Details</h3>
        <p><strong>Action Type:</strong> ${action.type}</p>
        <p><strong>Date:</strong> ${dateStr}</p>
        <p><strong>Severity:</strong> ${action.severity}</p>
        <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Reason for Action</h3>
        <p style="white-space: pre-wrap;">${action.reason || 'No reason provided'}</p>
      </div>
      
      ${action.corrective_plan ? `
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Corrective Action Plan</h3>
        <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
      </div>
      ` : ''}
      
      <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
        <h3 style="color: #333;">Signatures</h3>
        <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
        <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
        <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
      </div>
    </div>
  `;

  const element = document.createElement('div');
  element.innerHTML = content;
  
  html2pdf()
    .from(element)
    .set({
      margin: 0.5,
      filename: `warning-${action.employeeNumber}-${action.date}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    })
    .save();
}



// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================
const DISCIPLINE_CATEGORIES = {
  attendance: [
    { value: 'late', label: 'Late Arrival' },
    { value: 'early-leave', label: 'Early Departure' },
    { value: 'no-call-no-show', label: 'No Call / No Show' },
    { value: 'excessive-absences', label: 'Excessive Absences' },
    { value: 'unapproved-absence', label: 'Unapproved Absence' },
    { value: 'break-violation', label: 'Extended Breaks' }
  ],
  performance: [
    { value: 'quality', label: 'Work Quality Below Standard' },
    { value: 'productivity', label: 'Low Productivity' },
    { value: 'missed-deadline', label: 'Missed Deadlines' },
    { value: 'failure-to-follow', label: 'Failure to Follow Instructions' },
    { value: 'incomplete-tasks', label: 'Incomplete Tasks' }
  ],
  conduct: [
    { value: 'unprofessional', label: 'Unprofessional Behavior' },
    { value: 'disrespectful', label: 'Disrespectful to Staff/Management' },
    { value: 'inappropriate-language', label: 'Inappropriate Language' },
    { value: 'conflict', label: 'Conflict with Coworkers' },
    { value: 'insubordination', label: 'Insubordination' },
    { value: 'horseplay', label: 'Horseplay / Roughhousing' }
  ],
  policy: [
    { value: 'uniform', label: 'Uniform Violation' },
    { value: 'cell-phone', label: 'Cell Phone / Earbuds Use' },
    { value: 'eating-drinking', label: 'Eating/Drinking in Wrong Area' },
    { value: 'smoking', label: 'Smoking/Vaping Violation' },
    { value: 'unauthorized-discount', label: 'Unauthorized Discount/Comp' },
    { value: 'confidentiality', label: 'Confidentiality Breach' },
    { value: 'social-media', label: 'Social Media Policy Violation' }
  ],
  safety: [
    { value: 'food-safety', label: 'Food Safety Violation' },
    { value: 'sanitation', label: 'Sanitation/Cleanliness Issue' },
    { value: 'unsafe-practice', label: 'Unsafe Work Practice' },
    { value: 'equipment-misuse', label: 'Equipment Misuse' },
    { value: 'injury-report', label: 'Failure to Report Injury' }
  ],
  customer: [
    { value: 'rude-to-guest', label: 'Rude to Guest' },
    { value: 'poor-service', label: 'Poor Service Quality' },
    { value: 'order-error', label: 'Repeated Order Errors' },
    { value: 'complaint', label: 'Guest Complaint' },
    { value: 'refusal-to-serve', label: 'Refusal to Serve Guest' }
  ],
  integrity: [
    { value: 'theft', label: 'Theft' },
    { value: 'dishonesty', label: 'Dishonesty / Lying' },
    { value: 'timecard-fraud', label: 'Timecard Fraud' },
    { value: 'tip-theft', label: 'Tip Theft / Manipulation' },
    { value: 'falsifying-records', label: 'Falsifying Records' }
  ]
};





// Attach modal event listeners (call this in bootstrap)
function setupModalEventListeners() {
  console.log('🎯 Setting up modal event listeners...');
  setupCategoryDropdowns();
  
  const closeBtn = document.getElementById('close-warning-modal');
  const closeBtnFooter = document.getElementById('modal-close-btn');
  const saveBtn = document.getElementById('modal-save-btn');
  const deleteBtn = document.getElementById('modal-delete-btn');
  const exportBtn = document.getElementById('modal-export-pdf');
  
  
  if (closeBtn) {
    closeBtn.addEventListener('click', closeWarningModal);
    console.log('✅ Close button (X) listener attached');
  }
  
  if (closeBtnFooter) {
    closeBtnFooter.addEventListener('click', closeWarningModal);
    console.log('✅ Cancel button listener attached');
  }
  
  if (saveBtn) {
    saveBtn.addEventListener('click', saveWarningModal);
    console.log('✅ Save button listener attached');
  } else {
    console.error('❌ Save button NOT FOUND!');
  }
  
  if (deleteBtn) {
    deleteBtn.addEventListener('click', deleteWarningModal);
    console.log('✅ Delete button listener attached');
  }
  
  if (exportBtn) {
    exportBtn.addEventListener('click', generateWarningPDF);
    console.log('✅ Export PDF button listener attached');
  }
  
  // Close on background click
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeWarningModal();
      }
    });
    console.log('✅ Background click listener attached');
  }
}

// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================


// Setup dynamic sub-category dropdown
function setupCategoryDropdowns() {
  const mainCategory = document.getElementById('modal-edit-main-category');
  const subCategory = document.getElementById('modal-edit-sub-category');
  
  if (!mainCategory || !subCategory) return;
  
  mainCategory.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategory.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategory.appendChild(option);
      });
      subCategory.disabled = false;
    } else {
      subCategory.disabled = true;
      subCategory.innerHTML = '<option value="">Select main category first...</option>';
    }
  });
}




    function generate12MonthChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    }
  ];

  // Try to get data from discipline_history
  let hasHistoryData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history) && emp.discipline_history.length > 0) {
      emp.discipline_history.forEach(action => {
        hasHistoryData = true;
        const actionDate = new Date(action.date);
        const monthStr = actionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        const monthIndex = months.indexOf(monthStr);
        
        if (monthIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING':
              datasets[0].data[monthIndex]++; 
              break;
            case 'WRITTEN_WARNING':
              datasets[1].data[monthIndex]++; 
              break;
            case 'FINAL_WARNING':
              datasets[2].data[monthIndex]++; 
              break;
            case 'TERMINATION':
              datasets[3].data[monthIndex]++; 
              break;
          }
        }
      });
    }
  });

  // If no history data, aggregate current counts in current month
  if (!hasHistoryData) {
    const currentMonthIndex = 11; // Last month in array
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentMonthIndex] = totalVerbal;
    datasets[1].data[currentMonthIndex] = totalWritten;
    datasets[2].data[currentMonthIndex] = totalFinal;
    datasets[3].data[currentMonthIndex] = totalTermination;
    
    console.log('📊 Chart Data (Current Month):', {
      verbal: totalVerbal,
      written: totalWritten,
      final: totalFinal,
      termination: totalTermination
    });
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: { 
          enabled: true,
          mode: 'index', 
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          bodyFont: {
            size: 13,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            padding: 8
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)',
            drawBorder: false
          },
          title: {
            display: true,
            text: 'Number of Actions',
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function generateYearlyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const currentYear = new Date().getFullYear();
  const years = [currentYear - 4, currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(String);
  
  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#10b981',
      borderColor: '#10b981',
      borderWidth: 2
    },
    { 
      label: 'Written Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#f59e0b',
      borderColor: '#f59e0b',
      borderWidth: 2
    },
    { 
      label: 'Final Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#ef4444',
      borderColor: '#ef4444',
      borderWidth: 2
    },
    { 
      label: 'Terminations', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#991b1b',
      borderColor: '#991b1b',
      borderWidth: 2
    }
  ];

  // Try to get data from history
  let hasData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history)) {
      emp.discipline_history.forEach(action => {
        hasData = true;
        const year = new Date(action.date).getFullYear().toString();
        const yearIndex = years.indexOf(year);
        if (yearIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING': datasets[0].data[yearIndex]++; break;
            case 'WRITTEN_WARNING': datasets[1].data[yearIndex]++; break;
            case 'FINAL_WARNING': datasets[2].data[yearIndex]++; break;
            case 'TERMINATION': datasets[3].data[yearIndex]++; break;
          }
        }
      });
    }
  });

  // If no history, put current totals in current year
  if (!hasData) {
    const currentYearIndex = 4;
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentYearIndex] = totalVerbal;
    datasets[1].data[currentYearIndex] = totalWritten;
    datasets[2].data[currentYearIndex] = totalFinal;
    datasets[3].data[currentYearIndex] = totalTermination;
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

function generateWeeklyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const weeks = [];
  for (let i = 1; i <= 12; i++) {
    weeks.push(`Week ${i}`);
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      tension: 0.4,
      fill: true
    }
  ];

  // Put current totals in last week if no history
  const lastWeekIndex = 11;
  let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
  
  AppState.employees.forEach(emp => {
    totalVerbal += emp.verbal_warning_count || 0;
    totalWritten += emp.disciplinary_warning_count || 0;
    totalFinal += emp.final_warning_count || 0;
    totalTermination += emp.termination_letter_count || 0;
  });
  
  datasets[0].data[lastWeekIndex] = totalVerbal;
  datasets[1].data[lastWeekIndex] = totalWritten;
  datasets[2].data[lastWeekIndex] = totalFinal;
  datasets[3].data[lastWeekIndex] = totalTermination;

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: weeks, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

      // ========================================================================
      // DISCIPLINE CASES TAB FUNCTIONS
      // ========================================================================
      
      function setupAutocomplete(inputId, dropdownId, tabName) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        if (!input || !dropdown) return;

        input.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          const state = AutocompleteState[tabName];
          
          clearTimeout(state.searchTimeout);
          
          if (query.length < 3) {
            dropdown.classList.add('hidden');
            dropdown.innerHTML = '';
            return;
          }

          state.searchTimeout = setTimeout(() => {
            const results = AppState.employees.filter(emp => {
              const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
              const empId = (emp.employee_id || '').toLowerCase();
              const dept = (emp.department || '').toLowerCase();
              return fullName.includes(query.toLowerCase()) || 
                     empId.includes(query.toLowerCase()) || 
                     dept.includes(query.toLowerCase());
            }).slice(0, 10);

            dropdown.innerHTML = '';
            
            if (results.length === 0) {
              dropdown.innerHTML = '<div class="px-3 py-2 text-xs text-slate-400">No employees found</div>';
            } else {
              results.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer text-xs';
                item.innerHTML = `
                  <div class="font-bold text-slate-900">${emp.first_name} ${emp.last_name}</div>
                  <div class="text-slate-500 text-[0.70rem]">${emp.employee_id || '--'} &bull; ${emp.department || '--'}</div>
                `;
                item.addEventListener('click', () => {
                  input.value = `${emp.first_name} ${emp.last_name}`;
                  dropdown.classList.add('hidden');
                  selectEmployee(emp, tabName);
                });
                dropdown.appendChild(item);
              });
            }
            
            dropdown.classList.remove('hidden');
          }, 300);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
        });
      }

      function selectEmployee(employee, context = 'discipline') {
        if (context === 'discipline') {
          AppState.selectedEmployee = employee;
          
          // Update hidden field
          document.getElementById('discipline-employee-id').value = employee.id;
          
          // Update selected employee chip
          const chip = document.getElementById('discipline-selected-employee-chip');
          chip.innerHTML = `
            <span class="font-bold">${employee.first_name} ${employee.last_name}</span>
            <span class="text-slate-500">&bull;</span>
            <span>${employee.department || '--'}</span>
          `;
          chip.classList.remove('hidden');
          
          // Render discipline history
          renderDisciplineHistory(employee);
          renderAuditTrail(employee);
        } else if (context === 'employees') {
          loadEmployee360(employee);
        }
      }

      function renderDisciplineHistory(employee) {
        const container = document.getElementById('discipline-history-timeline');
        if (!container) return;

        container.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          container.innerHTML = '<p class="text-xs text-slate-400">No discipline history recorded for this employee.</p>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((action, index) => {
          const item = document.createElement('div');
          item.className = 'timeline-item relative pl-6 pb-6';
          if (index === history.length - 1) item.classList.remove('pb-6');
          
          let iconBg = 'bg-slate-400';
          if (action.type === 'Verbal Warning') iconBg = 'bg-emerald-400';
          if (action.type === 'Written Warning') iconBg = 'bg-amber-400';
          if (action.type === 'Final Warning') iconBg = 'bg-rose-400';
          if (action.type === 'Termination') iconBg = 'bg-rose-600';
          
          item.innerHTML = `
            <div class="absolute left-0 top-1 w-3 h-3 rounded-full ${iconBg} border-2 border-white"></div>
            <div class="text-xs">
              <p class="font-bold text-slate-900">${action.type}</p>
              <p class="text-[0.70rem] text-slate-500">${formatDate(action.date)}</p>
              <p class="text-[0.70rem] text-slate-600 mt-1">${action.reason || 'No reason provided'}</p>
              ${action.reference ? `<p class="text-[0.65rem] text-slate-400 mt-0.5">Ref: ${action.reference}</p>` : ''}
            </div>
          `;
          container.appendChild(item);
        });
      }

      function renderAuditTrail(employee) {
        const tbody = document.getElementById('discipline-audit-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-slate-400 text-xs">No audit trail available</td></tr>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach(action => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
            <td class="px-3 py-2 text-slate-900 font-medium">${action.type}</td>
            <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.manager_signature || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.reference || '--'}</td>
          `;
          tbody.appendChild(row);
        });
      }

      async function handleDisciplineSubmit(event) {
  event.preventDefault();
  
  const employeeId = document.getElementById('discipline-employee-id').value;
  if (!employeeId) {
    showToast('Please select an employee first', 'error');
    return;
  }

  const submitBtn = document.getElementById('discipline-form-submit');
  const submitSpinner = document.getElementById('discipline-form-submit-spinner');
  const submitText = document.getElementById('discipline-form-submit-text');
  
  submitBtn.disabled = true;
  submitSpinner.classList.remove('hidden');
  submitText.textContent = 'Submitting...';

  try {
    // Collect form data
    const actionType = document.getElementById('discipline-action-type').value;
    const actionDate = document.getElementById('discipline-action-date').value;
    const severity = document.getElementById('discipline-severity').value;
    const mainCategory = document.getElementById('discipline-main-category').value;  // ⭐ NEW
    const subCategory = document.getElementById('discipline-sub-category').value;    // ⭐ NEW
    const reference = document.getElementById('discipline-reference').value;
    const reason = document.getElementById('discipline-reason').value;
    const plan = document.getElementById('discipline-plan').value;
    const managerSig = document.getElementById('discipline-manager-signature').value;
    const hrSig = document.getElementById('discipline-hr-signature').value;
    const empSig = document.getElementById('discipline-employee-signature').value;
    const empDeclined = document.getElementById('discipline-employee-declined').checked;

    // Validate required fields
    if (!mainCategory || !subCategory) {
      showToast('Please select both main category and sub-category', 'error');
      submitBtn.disabled = false;
      submitSpinner.classList.add('hidden');
      submitText.textContent = 'Record Action & Generate PDF';
      return;
    }

    // Create action object
    const newAction = {
      type: actionType,
      date: actionDate,
      severity,
      main_category: mainCategory,      // ⭐ NEW
      sub_category: subCategory,        // ⭐ NEW
      reference,
      reason,
      corrective_plan: plan,
      manager_signature: managerSig,
      hr_signature: hrSig,
      employee_signature: empDeclined ? 'DECLINED' : empSig,
      timestamp: new Date().toISOString()
    };

    console.log('📝 Submitting discipline action:', newAction);

    // Get current employee data
    const { data: currentEmp, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

    // Update warning counts based on action type
    const updates = { last_disciplinary_action: newAction };
    
    if (actionType === 'VERBAL_WARNING') {
      updates.verbal_warning_count = (currentEmp.verbal_warning_count || 0) + 1;
    } else if (actionType === 'WRITTEN_WARNING') {
      updates.disciplinary_warning_count = (currentEmp.disciplinary_warning_count || 0) + 1;
    } else if (actionType === 'FINAL_WARNING') {
      updates.final_warning_count = (currentEmp.final_warning_count || 0) + 1;
    } else if (actionType === 'TERMINATION') {
      updates.termination_letter_count = (currentEmp.termination_letter_count || 0) + 1;
      updates.employment_status = 'Terminated';
      updates.termination_status = 'Complete';
    }

    // Add to discipline history
    const history = currentEmp.discipline_history || [];
    history.push(newAction);
    updates.discipline_history = history;

    // Recalculate risk score
    const { points } = AppState.settings;
    const newScore = 
      (updates.verbal_warning_count || currentEmp.verbal_warning_count || 0) * points.verbal +
      (updates.disciplinary_warning_count || currentEmp.disciplinary_warning_count || 0) * points.written +
      (updates.final_warning_count || currentEmp.final_warning_count || 0) * points.final +
      (updates.termination_letter_count || currentEmp.termination_letter_count || 0) * points.termination;
    
    updates.risk_score = newScore;
    updates.risk_level = getRiskLevel(newScore);

    // Save to database
    console.log('💾 Updating database...');
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update(updates)
      .eq('id', employeeId);

    if (updateError) throw updateError;

    console.log('✅ Discipline action saved successfully');
    showToast('✅ Discipline action recorded successfully!', 'success');
    
    // Reset form
    document.getElementById('discipline-form').reset();
    document.getElementById('discipline-selected-employee-chip').classList.add('hidden');
    document.getElementById('discipline-sub-category').disabled = true;
    document.getElementById('discipline-sub-category').innerHTML = '<option value="">Select main category first...</option>';
    
    // Reload data and refresh display
    await loadEmployees();
    populateDashboardDisciplineList();
    
    // Generate PDF
    generateDisciplinePDF(currentEmp, newAction);

  } catch (error) {
    console.error('❌ Error submitting discipline action:', error);
    showToast('❌ Failed to submit discipline action: ' + error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitSpinner.classList.add('hidden');
    submitText.textContent = 'Record Action & Generate PDF';
  }
}



      function generateDisciplinePDF(employee, action) {
        const content = `
          <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
              <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
              <p><strong>Name:</strong> ${employee.first_name} ${employee.last_name}</p>
              <p><strong>Employee ID:</strong> ${employee.employee_id || 'N/A'}</p>
              <p><strong>Department:</strong> ${employee.department || 'N/A'}</p>
              <p><strong>Position:</strong> ${employee.job_title || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Action Details</h3>
              <p><strong>Action Type:</strong> ${action.type}</p>
              <p><strong>Date:</strong> ${formatDate(action.date)}</p>
              <p><strong>Severity:</strong> ${action.severity}</p>
              <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Reason for Action</h3>
              <p style="white-space: pre-wrap;">${action.reason}</p>
            </div>
            
            ${action.corrective_plan ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Corrective Action Plan</h3>
              <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
            </div>
            ` : ''}
            
            <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
              <h3 style="color: #333;">Signatures</h3>
              <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
              <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
              <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
            </div>
          </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = content;
        
        html2pdf()
          .from(element)
          .set({
            margin: 0.5,
            filename: `discipline-${employee.employee_id}-${action.date}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          })
          .save();
      }

      // ========================================================================
      // EMPLOYEES 360 TAB FUNCTIONS
      // ========================================================================
      
      function renderEmployeeList() {
        const container = document.getElementById('employee-list');
        if (!container) return;

        const filtered = filterEmployees(AppState.employeeFilterStatus);
        container.innerHTML = '';

        if (filtered.length === 0) {
          container.innerHTML = '<div class="text-xs text-slate-400 px-3 py-2">No employees match the current filter.</div>';
          return;
        }

        filtered.forEach(emp => {
          const score = computeRiskScore(emp);
          const level = getRiskLevel(score);
          const badgeClasses = getRiskBadgeClasses(level);
          
          const item = document.createElement('div');
          item.className = 'rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 hover:bg-white hover:border-brand-200 cursor-pointer transition-all';
          item.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="flex-1">
                <p class="font-bold text-slate-900 text-xs">${emp.first_name} ${emp.last_name}</p>
                <p class="text-[0.70rem] text-slate-500">${emp.employee_id || '--'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full ${badgeClasses} border px-2 py-0.5 text-[0.65rem] font-medium">
                ${level}
              </span>
            </div>
          `;
          item.addEventListener('click', () => selectEmployee(emp, 'employees'));
          container.appendChild(item);
        });
      }

      function loadEmployee360(employee) {
  document.getElementById('current-employee-360-id').value = employee.id;
  AppState.selectedEmployee = employee;
  
  // Use enhanced profile population
  populateEmployeeProfileCard(employee);

        // Profile header
        document.getElementById('employee-profile-name').textContent = `${employee.first_name} ${employee.last_name}`;
        document.getElementById('employee-profile-title').textContent = `${employee.job_title || 'N/A'} • ${employee.department || 'N/A'}`;
        document.getElementById('employee-profile-status').textContent = `${employee.employment_status || 'N/A'} • Hired ${formatDate(employee.hire_date)} • Reports to ${employee.report_to || 'N/A'}`;
        
        // Risk badge
        const score = computeRiskScore(employee);
        const level = getRiskLevel(score);
        const badgeClasses = getRiskBadgeClasses(level);
        document.getElementById('employee-profile-risk-badge').className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
        document.getElementById('employee-profile-risk-badge').innerHTML = `
          <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
          <span>Risk Score: ${score}</span>
        `;
        
        // IDs
        document.getElementById('employee-profile-employee-id').innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
        document.getElementById('employee-profile-username').innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${employee.username || '--'}</span>`;
        
        // KPIs
        document.getElementById('employee-kpi-verbal').textContent = employee.verbal_warning_count || 0;
        document.getElementById('employee-kpi-written').textContent = employee.disciplinary_warning_count || 0;
        document.getElementById('employee-kpi-final').textContent = employee.final_warning_count || 0;
        document.getElementById('employee-kpi-termination').textContent = employee.termination_letter_count || 0;

        // Editable fields
        document.getElementById('edit-employment-status').value = employee.employment_status || 'Active';
        document.getElementById('edit-first-name').value = employee.first_name || '';
        document.getElementById('edit-last-name').value = employee.last_name || '';
        document.getElementById('edit-job-title').value = employee.job_title || '';
        document.getElementById('edit-position-title').value = employee.position_title || '';
        document.getElementById('edit-department').value = employee.department || '';
        document.getElementById('edit-report-to').value = employee.report_to || '';
        document.getElementById('edit-email').value = employee.email || '';
        document.getElementById('edit-phone').value = employee.phone || '';
        document.getElementById('edit-address-line-1').value = employee.address_line_1 || '';
        document.getElementById('edit-address-line-2').value = employee.address_line_2 || '';
        document.getElementById('edit-city').value = employee.city || '';
        document.getElementById('edit-state').value = employee.state || '';
        document.getElementById('edit-zip-code').value = employee.zip_code || '';
        document.getElementById('edit-original-hire-date').value = employee.original_hire_date || '';
        document.getElementById('edit-hire-date').value = employee.hire_date || '';
        document.getElementById('edit-hourly-rate').value = employee.hourly_rate || '';
        document.getElementById('edit-annual-salary').value = employee.annual_salary || '';
        document.getElementById('edit-risk-level').value = employee.risk_level || 'LOW';
        document.getElementById('edit-hr-witness').value = employee.hr_witness || '';

        // Calculated fields
        document.getElementById('display-tenure').textContent = calculateTenure(employee.hire_date);
        document.getElementById('display-risk-score').textContent = score;
        document.getElementById('display-last-action').textContent = employee.last_disciplinary_action ? `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}` : 'None';

        // Summary
        const summaryContainer = document.getElementById('employee-summary-history');
        if (employee.discipline_history && employee.discipline_history.length > 0) {
          summaryContainer.innerHTML = `
            <p class="text-slate-700">
              ${employee.first_name} ${employee.last_name} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
              with a current risk score of <strong>${score}</strong> (${level} risk). 
              The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
              issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
            </p>
          `;
        } else {
          summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
        }
      }



      // ========================================================================
// ENHANCED EMPLOYEE PROFILE POPULATION
// ========================================================================
function populateEmployeeProfileCard(employee) {
  if (!employee) return;

  // --- Helpers ------------------------------------------------------
  const safe = (v, fallback = '') =>
    v === null || v === undefined ? fallback : v;

  const safeText = (id, value, fallback = '--') => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value !== undefined && value !== null && value !== ''
      ? value
      : fallback;
  };

  const safeValue = (id, value) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      if (el.type === 'date' && value) {
        el.value = value;
      } else {
        el.value = value ?? '';
      }
    } else {
      el.textContent = value ?? '';
    }
  };

  // --- BASIC DERIVED FIELDS -----------------------------------------
  const fullName = `${safe(employee.first_name)} ${safe(employee.last_name)}`.trim() || 'Employee';
  const jobTitle = safe(employee.job_title || employee.position_title, 'N/A');
  const department = safe(employee.department, 'N/A');
  const employmentStatus = safe(employee.employment_status, 'Active');
  const hireDate = employee.hire_date || employee.original_hire_date || null;
  const reportsTo = safe(employee.report_to, 'N/A');

  // --- PROFILE HEADER (top of Employee 360) -------------------------
  safeText('employee-profile-name', fullName, 'Employee');

  const profileTitleEl = document.getElementById('employee-profile-title');
  if (profileTitleEl) {
    profileTitleEl.textContent = `${jobTitle} • ${department}`;
  }

  const profileStatusEl = document.getElementById('employee-profile-status');
  if (profileStatusEl) {
    const tenure = typeof calculateTenure === 'function' && hireDate
      ? calculateTenure(hireDate)
      : '';
    const pieces = [employmentStatus];
    if (tenure) pieces.push(tenure);
    pieces.push(`Reports to ${reportsTo}`);
    profileStatusEl.textContent = pieces.join(' • ');
  }

  // ID + Username line
  const empIdEl = document.getElementById('employee-profile-employee-id');
  if (empIdEl) {
    empIdEl.innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
  }

  const usernameEl = document.getElementById('employee-profile-username');
  if (usernameEl) {
    const username = employee.username || employee.email || '--';
    usernameEl.innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${username}</span>`;
  }

  // --- RISK BADGE ---------------------------------------------------
  const riskBadge = document.getElementById('employee-profile-risk-badge');
  if (riskBadge && typeof computeRiskScore === 'function' && typeof getRiskLevel === 'function') {
    const score = computeRiskScore(employee);
    const level = getRiskLevel(score);
    const badgeClasses = getRiskBadgeClasses(level);

    riskBadge.className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
    riskBadge.innerHTML = `
      <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
      <span>Risk Score: ${score}</span>
    `;
  }

  // --- KPIs (Verbal / Written / Final / Termination) ---------------
  const kpiMap = {
    'employee-kpi-verbal': employee.verbal_warning_count,
    'employee-kpi-written': employee.disciplinary_warning_count,
    'employee-kpi-final': employee.final_warning_count,
    'employee-kpi-termination': employee.termination_letter_count
  };

  Object.entries(kpiMap).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value != null ? value : 0;
  });

  // --- EDITABLE FIELDS ---------------------------------------------
  safeValue('edit-employment-status', employmentStatus);
  safeValue('edit-first-name', employee.first_name || '');
  safeValue('edit-last-name', employee.last_name || '');
  safeValue('edit-job-title', employee.job_title || employee.position_title || '');
  safeValue('edit-department', employee.department || '');
  safeValue('edit-report-to', employee.report_to || '');
  safeValue('edit-email', employee.email || '');
  safeValue('edit-phone', employee.phone || '');
  safeValue('edit-address-line-1', employee.address_line_1 || '');
  safeValue('edit-address-line-2', employee.address_line_2 || '');
  safeValue('edit-city', employee.city || '');
  safeValue('edit-state', employee.state || '');
  safeValue('edit-zip-code', employee.zip_code || '');
  safeValue('edit-original-hire-date', employee.original_hire_date || '');
  safeValue('edit-hire-date', employee.hire_date || '');
  safeValue('edit-hourly-rate', employee.hourly_rate ?? '');
  safeValue('edit-annual-salary', employee.annual_salary ?? '');
  safeValue('edit-risk-level', employee.risk_level || 'LOW');
  safeValue('edit-hr-witness', employee.hr_witness || '');

  // --- CALCULATED FIELDS -------------------------------------------
  const tenureEl = document.getElementById('display-tenure');
  if (tenureEl && typeof calculateTenure === 'function' && hireDate) {
    tenureEl.textContent = calculateTenure(hireDate);
  }

  const scoreDisplayEl = document.getElementById('display-risk-score');
  if (scoreDisplayEl && typeof computeRiskScore === 'function') {
    const score = computeRiskScore(employee);
    scoreDisplayEl.textContent = score;
  }

  const lastActionEl = document.getElementById('display-last-action');
  if (lastActionEl) {
    if (employee.last_disciplinary_action) {
      lastActionEl.textContent = `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}`;
    } else {
      lastActionEl.textContent = 'None';
    }
  }

  // --- SUMMARY HISTORY ---------------------------------------------
  const summaryContainer = document.getElementById('employee-summary-history');
  if (summaryContainer) {
    if (employee.discipline_history && employee.discipline_history.length > 0) {
      const score = computeRiskScore(employee);
      const level = getRiskLevel(score);
      summaryContainer.innerHTML = `
        <p class="text-slate-700">
          ${fullName} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
          with a current risk score of <strong>${score}</strong> (${level} risk). 
          The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
          issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
        </p>
      `;
    } else {
      summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
    }
  }
}

      async function saveEmployee360() {
        const employeeId = document.getElementById('current-employee-360-id').value;
        if (!employeeId) {
          showToast('No employee selected', 'error');
          return;
        }

        const saveBtn = document.getElementById('btn-save-employee-360');
        const statusIndicator = document.getElementById('save-status-indicator');
        const statusText = document.getElementById('save-status-text');
        
        saveBtn.disabled = true;
        statusIndicator.className = 'w-2 h-2 rounded-full bg-amber-500';
        statusText.textContent = 'Saving...';

        try {
          const updates = {
            employment_status: document.getElementById('edit-employment-status').value,
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
            job_title: document.getElementById('edit-job-title').value,
            position_title: document.getElementById('edit-position-title').value,
            department: document.getElementById('edit-department').value,
            report_to: document.getElementById('edit-report-to').value,
            email: document.getElementById('edit-email').value,
            phone: document.getElementById('edit-phone').value,
            address_line_1: document.getElementById('edit-address-line-1').value,
            address_line_2: document.getElementById('edit-address-line-2').value,
            city: document.getElementById('edit-city').value,
            state: document.getElementById('edit-state').value,
            zip_code: document.getElementById('edit-zip-code').value,
            original_hire_date: document.getElementById('edit-original-hire-date').value,
            hire_date: document.getElementById('edit-hire-date').value,
            hourly_rate: parseFloat(document.getElementById('edit-hourly-rate').value) || null,
            annual_salary: parseFloat(document.getElementById('edit-annual-salary').value) || null,
            risk_level: document.getElementById('edit-risk-level').value,
            hr_witness: document.getElementById('edit-hr-witness').value
          };

          const { error } = await supabaseClient
            .from('employees2025')
            .update(updates)
            .eq('id', employeeId);

          if (error) throw error;

          statusIndicator.className = 'w-2 h-2 rounded-full bg-emerald-500';
          statusText.textContent = 'Saved successfully';
          showToast('Employee data saved successfully', 'success');
          
          await loadEmployees();
          renderEmployeeList();

          setTimeout(() => {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-emerald-500';
            statusText.textContent = 'Ready to edit';
          }, 2000);

        } catch (error) {
          console.error('Error saving employee:', error);
          statusIndicator.className = 'w-2 h-2 rounded-full bg-rose-500';
          statusText.textContent = 'Save failed';
          showToast('Failed to save employee data', 'error');
        } finally {
          saveBtn.disabled = false;
        }
      }

      // ========================================================================
      // POLICY LIBRARY TAB FUNCTIONS
      // ========================================================================
      
      function setupPolicyAccordion() {
        document.querySelectorAll('.policy-accordion-header').forEach(header => {
          header.addEventListener('click', () => {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.policy-accordion-toggle i');
            
            if (body.classList.contains('hidden')) {
              body.classList.remove('hidden');
              toggle.classList.remove('fa-chevron-down');
              toggle.classList.add('fa-chevron-up');
            } else {
              body.classList.add('hidden');
              toggle.classList.remove('fa-chevron-up');
              toggle.classList.add('fa-chevron-down');
            }
          });
        });

        document.querySelectorAll('.policy-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const category = chip.dataset.policyCategory;
            
            // Update chip styles
            document.querySelectorAll('.policy-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            // Show/hide panels
            document.querySelectorAll('[data-policy-category-panel]').forEach(panel => {
              if (panel.dataset.policyCategoryPanel === category) {
                panel.classList.remove('hidden');
              } else {
                panel.classList.add('hidden');
              }
            });
          });
        });
      }

      // ========================================================================
      // REPORTS TAB FUNCTIONS
      // ========================================================================
      
      function updateReports() {
        updateReportsKPIs();
        generateReportsCharts();
        populateReportsTable();
        updateRiskDistribution();
      }

      function updateReportsKPIs() {
        let totalActions = 0;
        AppState.employees.forEach(emp => {
          if (emp.discipline_history) {
            totalActions += emp.discipline_history.length;
          }
        });

        const terminatedCount = AppState.employees.filter(e => e.employment_status === 'Terminated').length;
        const activeCount = AppState.employees.filter(e => e.employment_status === 'Active').length;
        const terminationRate = activeCount > 0 ? ((terminatedCount / (activeCount + terminatedCount)) * 100).toFixed(1) : '0.0';

        const highRiskCount = AppState.employees.filter(e => {
          const score = computeRiskScore(e);
          return getRiskLevel(score) === 'HIGH';
        }).length;

        document.getElementById('reports-kpi-total-actions').textContent = totalActions;
        document.getElementById('reports-kpi-avg-resolution').textContent = '3.2 days';
        document.getElementById('reports-kpi-termination-rate').textContent = `${terminationRate}%`;
        document.getElementById('reports-kpi-high-risk-count').textContent = highRiskCount;
      }

      function generateReportsCharts() {
        // Chart by type
        const canvasByType = document.getElementById('reports-chart-by-type');
        if (canvasByType) {
          const ctx = canvasByType.getContext('2d');
          if (AppState.charts.reportsByType) AppState.charts.reportsByType.destroy();

          let verbal = 0, written = 0, final = 0, termination = 0;
          AppState.employees.forEach(emp => {
            verbal += emp.verbal_warning_count || 0;
            written += emp.disciplinary_warning_count || 0;
            final += emp.final_warning_count || 0;
            termination += emp.termination_letter_count || 0;
          });

          AppState.charts.reportsByType = new Chart(ctx, {
            type: 'doughnut',
            data: {
              labels: ['Verbal', 'Written', 'Final', 'Termination'],
              datasets: [{
                data: [verbal, written, final, termination],
                backgroundColor: ['#10b981', '#f59e0b', '#ef4444', '#991b1b']
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } }
            }
          });
        }

        // Chart by department
        const canvasByDept = document.getElementById('reports-chart-by-department');
        if (canvasByDept) {
          const ctx = canvasByDept.getContext('2d');
          if (AppState.charts.reportsByDept) AppState.charts.reportsByDept.destroy();

          const deptData = {};
          AppState.employees.forEach(emp => {
            const dept = emp.department || 'Unassigned';
            if (!deptData[dept]) deptData[dept] = 0;
            if (emp.discipline_history) {
              deptData[dept] += emp.discipline_history.length;
            }
          });

          AppState.charts.reportsByDept = new Chart(ctx, {
            type: 'bar',
            data: {
              labels: Object.keys(deptData),
              datasets: [{
                label: 'Actions',
                data: Object.values(deptData),
                backgroundColor: '#7a1f1f'
              }]
            },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { display: false } },
              scales: { y: { beginAtZero: true } }
            }
          });
        }

        // Trend chart
        const trendCanvas = document.getElementById('reports-trend-chart');
        if (trendCanvas) {
          const ctx = trendCanvas.getContext('2d');
          if (AppState.charts.reportsTrend) AppState.charts.reportsTrend.destroy();

          const months = [];
          const now = new Date();
          for (let i = 11; i >= 0; i--) {
            const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
            months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
          }

          const datasets = [
            { label: 'Verbal', data: new Array(12).fill(0), borderColor: '#10b981', fill: false },
            { label: 'Written', data: new Array(12).fill(0), borderColor: '#f59e0b', fill: false },
            { label: 'Final', data: new Array(12).fill(0), borderColor: '#ef4444', fill: false },
            { label: 'Termination', data: new Array(12).fill(0), borderColor: '#991b1b', fill: false }
          ];

          AppState.charts.reportsTrend = new Chart(ctx, {
            type: 'line',
            data: { labels: months, datasets },
            options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: { legend: { position: 'bottom' } },
              scales: { y: { beginAtZero: true } }
            }
          });
        }
      }

      function populateReportsTable() {
        const tbody = document.getElementById('reports-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        const actions = [];
        AppState.employees.forEach(emp => {
          if (emp.discipline_history) {
            emp.discipline_history.forEach(action => {
              actions.push({
                ...action,
                employeeName: `${emp.first_name} ${emp.last_name}`,
                department: emp.department
              });
            });
          }
        });

        actions.sort((a, b) => new Date(b.date) - new Date(a.date));

        if (actions.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-center text-slate-400">No discipline actions found</td></tr>';
          return;
        }

        actions.slice(0, 50).forEach(action => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
            <td class="px-3 py-2 text-slate-900 font-medium">${action.employeeName}</td>
            <td class="px-3 py-2 text-slate-600">${action.department || '--'}</td>
            <td class="px-3 py-2 text-slate-900">${action.type}</td>
            <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
            <td class="px-3 py-2 text-slate-600 text-[0.70rem]">${(action.reason || '').substring(0, 50)}...</td>
            <td class="px-3 py-2 text-slate-600">${action.reference || '--'}</td>
          `;
          tbody.appendChild(row);
        });
      }

      function updateRiskDistribution() {
        let low = 0, medium = 0, high = 0;
        AppState.employees.forEach(emp => {
          const score = computeRiskScore(emp);
          const level = getRiskLevel(score);
          if (level === 'LOW') low++;
          else if (level === 'MEDIUM') medium++;
          else high++;
        });

        document.getElementById('reports-risk-low-count').textContent = low;
        document.getElementById('reports-risk-medium-count').textContent = medium;
        document.getElementById('reports-risk-high-count').textContent = high;
      }

      // ========================================================================
      // ADMIN SETTINGS TAB FUNCTIONS
      // ========================================================================
      
      function loadAdminSettings() {
        document.getElementById('admin-threshold-low').value = AppState.settings.thresholds.low;
        document.getElementById('admin-threshold-medium').value = AppState.settings.thresholds.medium;
        document.getElementById('admin-threshold-high').value = AppState.settings.thresholds.high;
        document.getElementById('admin-points-verbal').value = AppState.settings.points.verbal;
        document.getElementById('admin-points-written').value = AppState.settings.points.written;
        document.getElementById('admin-points-final').value = AppState.settings.points.final;
        document.getElementById('admin-points-termination').value = AppState.settings.points.termination;
        document.getElementById('admin-notify-high-risk').checked = AppState.settings.notifications.highRisk;
        document.getElementById('admin-notify-final-warning').checked = AppState.settings.notifications.finalWarning;
        document.getElementById('admin-notify-termination').checked = AppState.settings.notifications.termination;
        document.getElementById('admin-notify-daily-summary').checked = AppState.settings.notifications.dailySummary;
        document.getElementById('admin-display-photos').checked = AppState.settings.display.photos;
        document.getElementById('admin-display-compact').checked = AppState.settings.display.compact;
        document.getElementById('admin-display-auto-refresh').checked = AppState.settings.display.autoRefresh;
        document.getElementById('admin-retention-discipline').value = AppState.settings.retention.discipline;
        document.getElementById('admin-retention-audit').value = AppState.settings.retention.audit;
      }

      function saveAdminSettings() {
        AppState.settings.thresholds.low = parseInt(document.getElementById('admin-threshold-low').value) || 2;
        AppState.settings.thresholds.medium = parseInt(document.getElementById('admin-threshold-medium').value) || 5;
        AppState.settings.thresholds.high = parseInt(document.getElementById('admin-threshold-high').value) || 8;
        AppState.settings.points.verbal = parseFloat(document.getElementById('admin-points-verbal').value) || 1;
        AppState.settings.points.written = parseFloat(document.getElementById('admin-points-written').value) || 2;
        AppState.settings.points.final = parseFloat(document.getElementById('admin-points-final').value) || 3;
        AppState.settings.points.termination = parseFloat(document.getElementById('admin-points-termination').value) || 4;
        AppState.settings.notifications.highRisk = document.getElementById('admin-notify-high-risk').checked;
        AppState.settings.notifications.finalWarning = document.getElementById('admin-notify-final-warning').checked;
        AppState.settings.notifications.termination = document.getElementById('admin-notify-termination').checked;
        AppState.settings.notifications.dailySummary = document.getElementById('admin-notify-daily-summary').checked;
        AppState.settings.display.photos = document.getElementById('admin-display-photos').checked;
        AppState.settings.display.compact = document.getElementById('admin-display-compact').checked;
        AppState.settings.display.autoRefresh = document.getElementById('admin-display-auto-refresh').checked;
        AppState.settings.retention.discipline = parseInt(document.getElementById('admin-retention-discipline').value) || 7;
        AppState.settings.retention.audit = parseInt(document.getElementById('admin-retention-audit').value) || 7;

        localStorage.setItem('jcr-hr-settings', JSON.stringify(AppState.settings));
        
        const statusDiv = document.getElementById('admin-save-status');
        statusDiv.classList.remove('hidden');
        setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        
        showToast('Settings saved successfully', 'success');
      }


// FIND your PDF download button code and replace with:
async function download360PDF(employeeId) {
  try {
    const response = await fetch('https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-360-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ employee_id: employeeId })
    });

    if (!response.ok) {
      throw new Error('Failed to generate PDF');
    }

    const htmlContent = await response.text();
    
    // Open HTML in new window - user can print to PDF
    const newWindow = window.open('', '_blank');
    newWindow.document.write(htmlContent);
    newWindow.document.close();
    
    // Optionally trigger print dialog
    setTimeout(() => {
      newWindow.print();
    }, 500);

  } catch (error) {
    console.error('Error downloading 360 PDF:', error);
    alert('Failed to generate PDF. Please try again.');
  }
}



      // ========================================================================
      // EVENT LISTENERS
      // ========================================================================
      
      function attachEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-trigger').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tabTarget;  // ✅ CORRECT!
    showTab(tab);
  });
});
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
        const mobileMenu = document.getElementById('mobile-nav-menu');
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
          });

          document.querySelectorAll('#mobile-nav-menu .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              mobileMenu.classList.add('hidden');
            });
          });
        }

        // Dashboard chart timeframe
        const chartSelector = document.getElementById('chart-timeframe-selector');
        if (chartSelector) {
          chartSelector.addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'monthly') generate12MonthChart();
            else if (value === 'yearly') generateYearlyChart();
            else if (value === 'weekly') generateWeeklyChart();
          });
        }

        // Discipline form
        const disciplineForm = document.getElementById('discipline-form');
        if (disciplineForm) {
          disciplineForm.addEventListener('submit', handleDisciplineSubmit);
        }

        const disciplineResetBtn = document.getElementById('discipline-form-reset');
        if (disciplineResetBtn) {
          disciplineResetBtn.addEventListener('click', () => {
            disciplineForm.reset();
            document.getElementById('discipline-selected-employee-chip').classList.add('hidden');
          });
        }

        // Discipline refresh
        const disciplineRefresh = document.getElementById('discipline-refresh-employees');
        if (disciplineRefresh) {
          disciplineRefresh.addEventListener('click', () => loadEmployees());
        }

        // Employees 360 refresh
        const employeesRefresh = document.getElementById('employees-refresh-button');
        if (employeesRefresh) {
          employeesRefresh.addEventListener('click', () => {
            loadEmployees().then(() => renderEmployeeList());
          });
        }

        // Employees 360 save
        const saveEmployee360Btn = document.getElementById('btn-save-employee-360');
        if (saveEmployee360Btn) {
          saveEmployee360Btn.addEventListener('click', saveEmployee360);
        }

        // Employee filter chips
        document.querySelectorAll('.employee-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.employee-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            renderEmployeeList();
          });
        });

        // Reports refresh
        const reportsRefresh = document.getElementById('reports-refresh-data');
        if (reportsRefresh) {
          reportsRefresh.addEventListener('click', () => {
            loadEmployees().then(() => updateReports());
          });
        }
const mainCategoryDropdown = document.getElementById('discipline-main-category');
const subCategoryDropdown = document.getElementById('discipline-sub-category');

if (mainCategoryDropdown && subCategoryDropdown) {
  mainCategoryDropdown.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategoryDropdown.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategoryDropdown.appendChild(option);
      });
      subCategoryDropdown.disabled = false;
    } else {
      subCategoryDropdown.disabled = true;
    }
  });
}

        // Admin settings save
        const adminSaveBtn = document.getElementById('admin-save-settings');
        if (adminSaveBtn) {
          adminSaveBtn.addEventListener('click', saveAdminSettings);
        }
const employee360PdfBtn = document.getElementById('employee-summary-pdf');
if (employee360PdfBtn) {
  employee360PdfBtn.addEventListener('click', () => {
    const employeeId = document.getElementById('current-employee-360-id').value;
    if (!employeeId) {
      showToast('Please select an employee first', 'error');
      return;
    }
    download360PDF(employeeId);
  });
}
        // Setup autocomplete for both search inputs
        setupAutocomplete('discipline-employee-search', 'discipline-search-dropdown', 'discipline');
        setupAutocomplete('employees-search-input', 'employees-search-dropdown', 'employees');
      }

      // ========================================================================
      // INITIALIZATION
      // ========================================================================
      // ========================================================================
// PERMISSIONS MANAGEMENT
// ========================================================================

// Load permissions from database
async function loadPermissions() {
  try {
    const { data, error } = await supabaseClient
      .from('permissions_config')
      .select('*')
      .single();

    if (error && error.code !== 'PGRST116') throw error;

    if (data) {
      // Apply permissions to checkboxes
      Object.entries(data.permissions || {}).forEach(([feature, roles]) => {
        Object.entries(roles).forEach(([role, allowed]) => {
          const checkbox = document.querySelector(
            `.permission-checkbox[data-feature="${feature}"][data-role="${role}"]`
          );
          if (checkbox) checkbox.checked = allowed;
        });
      });
    }
  } catch (error) {
    console.error('Error loading permissions:', error);
  }
}

// Save permissions to database
async function savePermissions() {
  try {
    const permissions = {};
    
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
      const feature = checkbox.dataset.feature;
      const role = checkbox.dataset.role;
      
      if (!permissions[feature]) permissions[feature] = {};
      permissions[feature][role] = checkbox.checked;
    });

    const { error } = await supabaseClient
      .from('permissions_config')
      .upsert({
        id: 1,
        permissions,
        updated_at: new Date().toISOString()
      });

    if (error) throw error;

    // Log the change
    await logPermissionChange('Permissions matrix updated', 'HR Admin');
    
    showToast('Permissions saved automatically', 'success');
  } catch (error) {
    console.error('Error saving permissions:', error);
    showToast('Failed to save permissions', 'error');
  }
}

// Log permission changes
async function logPermissionChange(action, changedBy) {
  try {
    const { error } = await supabaseClient
      .from('permissions_audit_log')
      .insert({
        action,
        changed_by: changedBy,
        timestamp: new Date().toISOString()
      });

    if (error) throw error;
    
    // Refresh audit log display
    await loadPermissionsAuditLog();
  } catch (error) {
    console.error('Error logging permission change:', error);
  }
}

// Load and display audit log
async function loadPermissionsAuditLog() {
  try {
    const { data, error } = await supabaseClient
      .from('permissions_audit_log')
      .select('*')
      .order('timestamp', { ascending: false })
      .limit(50);

    if (error) throw error;

    const tbody = document.getElementById('permissions-audit-log');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      `;
      return;
    }

    data.forEach(log => {
      const row = document.createElement('tr');
      const timestamp = new Date(log.timestamp);
      row.innerHTML = `
        <td class="px-3 py-2 text-slate-600">
          ${timestamp.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}
        </td>
        <td class="px-3 py-2 text-slate-700">${log.action}</td>
        <td class="px-3 py-2 text-slate-600">${log.user_affected || '--'}</td>
        <td class="px-3 py-2 text-slate-600">${log.changed_by}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading audit log:', error);
  }
}

// Setup auto-save for permission checkboxes
function setupPermissionsAutoSave() {
  document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      // Debounce save
      clearTimeout(window.permissionsSaveTimeout);
      window.permissionsSaveTimeout = setTimeout(() => {
        savePermissions();
      }, 1000);
    });
  });
}
     async function bootstrap() {
  console.log('');
  console.log('🎬 BOOTSTRAP: Starting application...');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
  
  // Check toast container
  const toastContainer = document.getElementById('toast-container');
  if (toastContainer) {
    console.log('✅ Toast container found');
  } else {
    console.error('❌ Toast container NOT found!');
  }
  // Load permissions and audit log
if (AppState.currentTab === 'permissions') {
  await loadPermissions();
  await loadPermissionsAuditLog();
}
setupPermissionsAutoSave();
  // Load settings from localStorage
  const savedSettings = localStorage.getItem('jcr-hr-settings');
  if (savedSettings) {
    try {
      AppState.settings = JSON.parse(savedSettings);
      console.log('✅ Settings loaded from localStorage');
    } catch (e) {
      console.error('❌ Failed to parse saved settings');
    }
  }

  // Attach event listeners
  console.log('🔗 Attaching event listeners...');
  attachEventListeners();
    setupModalEventListeners(); // ← ADD THIS LINE

  // Setup policy accordion
  console.log('📋 Setting up policy accordion...');
  setupPolicyAccordion();
  
  // Load admin settings into form
  console.log('⚙️  Loading admin settings...');
  loadAdminSettings();
  
  // Load employee data
  console.log('');
  await loadEmployees();
  
  // Initialize dashboard (default tab)
  console.log('');
  console.log('🎨 Initializing dashboard...');
  showTab('dashboard');
  generate12MonthChart();
  
  console.log('');
  console.log('🎉 APPLICATION READY!');
  console.log('━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━');
}

// ========================================================================
// DISCIPLINE FORM SUBMISSION HANDLER
// ========================================================================



        
      
      // Start the application
      bootstrap();
    </script>
  </body>
</html>


