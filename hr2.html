<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Discipline • Compliance • Corrective Action Management</title>

  <!-- Google Fonts: Inter + Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind Configuration (must come before CDN script) -->
  <script>



    
    window.tailwind = window.tailwind || {};
   window.tailwind.config = {
  corePlugins: {
    container: false,
  },
  theme: {
    extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            heading: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xs': ['0.96rem', { lineHeight: '1.5' }],
            'sm': ['1.12rem', { lineHeight: '1.5' }],
            'base': ['1.28rem', { lineHeight: '1.6' }],
            'lg': ['1.44rem', { lineHeight: '1.6' }],
            'xl': ['1.6rem', { lineHeight: '1.6' }],
            '2xl': ['1.92rem', { lineHeight: '1.4' }],
            '3xl': ['2.4rem', { lineHeight: '1.3' }],
          },
          colors: {
            brand: {
              50: '#f1f8ff',
              100: '#e0f0ff',
              200: '#b9ddff',
              300: '#80c3ff',
              400: '#4aa7f5',
              500: '#1d8fe3',
              600: '#136fbc',
              700: '#0b5694',
              800: '#083b66',
              900: '#062847',
            },
          },
          boxShadow: {
            subtle: '0 10px 25px rgba(15, 23, 42, 0.06)',
          },
        },
      },
    };
  </script>

  <!-- Tailwind CSS CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Supabase JS v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

  <!-- html2pdf.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <!-- Icons (optional, for subtle UI icons) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" 
      integrity="sha512-SnH5WK+bZxgPHs44uWIX+LLJAJ9/2PkPKZ5QiAj6Ta86w+fsb2TkcmfRyVX3pBnMFcV7oQPJkl9QevSCWr3W6A==" 
      crossorigin="anonymous" referrerpolicy="no-referrer" />
  <!-- Light custom CSS for scrollbars, timelines, and print-friendly tweaks -->
 <style>

/* ===== CHART CONTAINER FIX ===== */
#discipline-trend-chart {
  display: block !important;
  max-width: 100% !important;
  height: auto !important;
}

.chart-container {
  position: relative;
  height: 400px !important;
  width: 100% !important;
  padding-bottom: 60px;
}

/* ===== SCROLLBAR STYLES ===== */
::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}
::-webkit-scrollbar-track {
  background: #f1f5f9;
}
::-webkit-scrollbar-thumb {
  background: #cbd5e1;
  border-radius: 9999px;
}
::-webkit-scrollbar-thumb:hover {
  background: #a5b4fc;
}

/* ===== TIMELINE STYLES ===== */
.timeline-line {
  position: absolute;
  left: 1.25rem;
  top: 0;
  bottom: 0;
  width: 2px;
  background: linear-gradient(to bottom, #bfdbfe, #1d8fe3);
  opacity: 0.75;
}

/* ===== PRINT STYLES ===== */
@media print {
  .no-print {
    display: none !important;
  }
}


</style>


</head>

<body class="h-full bg-slate-50 text-slate-900 font-sans" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">

  <!-- Root App Container -->
<div id="app-root" class="min-h-screen flex flex-col" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">
    <!-- Top Navigation / Header -->
    <header class="no-print bg-white shadow-subtle border-b border-slate-100">
    <div class="w-full px-2" style="max-width: 100% !important;">
        <div class="flex items-center justify-between py-4 md:py-5 gap-4">
          <!-- Left: Logo + Title -->
          <div class="flex items-center gap-4">
            <div class="flex-shrink-0">
              <img
                src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
                alt="Jeng Chi Restaurant Logo"
                class="h-12 w-auto rounded-lg shadow-sm border border-slate-100 bg-white object-contain"
              />
            </div>
            <div class="flex flex-col">
              <h1 class="font-heading text-xl sm:text-2xl md:text-3xl tracking-tight text-slate-900">
                Discipline • Compliance • Corrective Action Management
              </h1>
              <p class="text-xs sm:text-sm text-slate-500 mt-1">
                Jeng Chi Restaurant &mdash; Internal HR Discipline, Compliance, and Risk Governance Portal
              </p>
            </div>
          </div>

          <!-- Right: Environment + User -->
          <div class="flex items-center gap-4">
            <div class="hidden sm:flex flex-col items-end text-xs sm:text-sm">
              <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-[0.70rem] sm:text-xs font-medium text-brand-700">
                <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                Internal HR Portal &bull; Production View
              </span>
              <span class="mt-1 text-slate-500">
                Compliance aligned with TWC, DOL, FLSA, and internal JCR governance
              </span>
            </div>
            <div class="flex items-center gap-3">
              <div class="hidden sm:flex flex-col items-end text-xs sm:text-sm">
                <span class="font-medium text-slate-800">HR Admin</span>
                <span class="text-slate-400 text-[0.70rem]">Discipline &amp; Compliance Authority</span>
              </div>
              <div class="flex items-center justify-center rounded-full bg-gradient-to-br from-brand-100 to-brand-500 text-white w-10 h-10 font-heading text-sm shadow-md">
                HR
              </div>
            </div>
          </div>
        </div>

        <!-- Desktop Navigation Tabs -->
        <div class="no-print hidden md:flex items-center justify-between py-2 border-t border-slate-100">
          <nav class="flex items-center gap-1 text-sm font-medium" aria-label="Primary navigation">
            <button
              data-tab-target="dashboard"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full bg-brand-50 text-brand-700 border border-brand-100 shadow-sm transition-all"
            >
              <i class="fa-solid fa-chart-line text-[0.80rem]"></i>
              <span>Dashboard</span>
            </button>
            <button
              data-tab-target="discipline"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-gavel text-[0.80rem]"></i>
              <span>Discipline Cases</span>
            </button>
            <button
              data-tab-target="employees"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-users text-[0.80rem]"></i>
              <span>Employees 360</span>
            </button>
            <button
              data-tab-target="policy"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-scale-balanced text-[0.80rem]"></i>
              <span>Policy Library</span>
            </button>
            <button
              data-tab-target="reports"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-file-chart-column text-[0.80rem]"></i>
              <span>Reports &amp; Analytics</span>
            </button>
            <button
              data-tab-target="admin"
              class="tab-trigger inline-flex items-center gap-2 px-4 py-2 rounded-full text-slate-600 hover:text-brand-700 hover:bg-brand-50 border border-transparent hover:border-brand-100 transition-all"
            >
              <i class="fa-solid fa-gear text-[0.80rem]"></i>
              <span>Admin &amp; Settings</span>
            </button>
          </nav>
          <div class="text-[0.70rem] uppercase tracking-wide text-slate-400 font-medium">
            Last refreshed: <span id="header-last-refreshed" class="text-slate-600">--</span>
          </div>
        </div>

        <!-- Mobile Navigation Tabs -->
        <div class="no-print md:hidden border-t border-slate-100 py-2">
          <div class="flex items-center justify-between gap-2">
            <label for="mobile-tab-select" class="text-xs font-medium text-slate-500">
              Navigate
            </label>
            <select
              id="mobile-tab-select"
              class="w-2/3 text-xs rounded-full border-slate-200 bg-white px-3 py-1.5 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
            >
              <option value="dashboard">Dashboard</option>
              <option value="discipline">Discipline Cases</option>
              <option value="employees">Employees 360</option>
              <option value="policy">Policy Library</option>
              <option value="reports">Reports &amp; Analytics</option>
              <option value="admin">Admin &amp; Settings</option>
            </select>
          </div>
        </div>
      </div>
    </header>

    <!-- Toast / Status Banner -->
    <div
      id="global-toast"
      class="no-print fixed z-40 inset-x-0 top-0 flex justify-center pointer-events-none opacity-0 transition-opacity duration-300"
      aria-live="polite"
    >
      <div
        id="global-toast-inner"
        class="mt-20 max-w-xl w-full mx-4 flex items-start gap-3 rounded-2xl border border-emerald-100 bg-white shadow-subtle px-4 py-3 text-sm text-emerald-800 pointer-events-auto"
      >
        <div class="mt-0.5">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p id="global-toast-message" class="font-medium truncate">
            Action saved successfully.
          </p>
          <p id="global-toast-subtext" class="text-xs text-emerald-700 mt-0.5">
            Employee record updated in employees2025 and risk scoring recalculated.
          </p>
        </div>
        <button
          type="button"
          id="global-toast-close"
          class="ml-2 text-xs text-emerald-600 hover:text-emerald-800"
        >
          Close
        </button>
      </div>
    </div>

    <!-- Main Content -->
<main class="flex-1 w-full" style="max-width: 100% !important;">
  <div class="w-full px-2 py-6 md:py-8 space-y-8" style="max-width: 100% !important; width: 100% !important;">








    

        <!-- Dashboard Tab -->
          <section id="tab-dashboard" class="tab-panel space-y-8">
          <!-- Executive Summary & KPIs -->
          <div class="grid grid-cols-1 lg:grid-cols-4 gap-4">
            <!-- KPI: Total Active Employees -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
                    Total Active Employees
                  </p>
                  <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-total-employees">
                    --
                  </p>
                </div>
                <div class="h-10 w-10 rounded-xl bg-brand-50 flex items-center justify-center">
                  <i class="fa-solid fa-users text-brand-500 text-lg"></i>
                </div>
              </div>
              <p class="text-xs text-slate-500 leading-relaxed">
                Count of employees in <span class="font-medium text-slate-700">employees2025</span> with status
                <span class="font-semibold text-emerald-600">Active</span>.
              </p>
            </div>

            <!-- KPI: Employees with Warnings -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
                    Employees With Warnings
                  </p>
                  <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-employees-with-warnings">
                    --
                  </p>
                </div>
                <div class="h-10 w-10 rounded-xl bg-amber-50 flex items-center justify-center">
                  <i class="fa-solid fa-exclamation-triangle text-amber-500 text-lg"></i>
                </div>
              </div>
              <p class="text-xs text-slate-500 leading-relaxed">
                Employees with at least one verbal, written, final warning, or termination letter on file.
              </p>
            </div>

            <!-- KPI: Open Terminations -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
                    Open Terminations
                  </p>
                  <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-open-terminations">
                    --
                  </p>
                </div>
                <div class="h-10 w-10 rounded-xl bg-rose-50 flex items-center justify-center">
                  <i class="fa-solid fa-user-slash text-rose-500 text-lg"></i>
                </div>
              </div>
              <p class="text-xs text-slate-500 leading-relaxed">
                Termination letters issued where termination status remains
                <span class="font-semibold text-rose-600">Pending</span>.
              </p>
            </div>

            <!-- KPI: High-Risk Employees -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col gap-3">
              <div class="flex items-center justify-between">
                <div>
                  <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">
                    High-Risk Employees
                  </p>
                  <p class="mt-1 font-heading text-2xl text-slate-900" id="kpi-high-risk-employees">
                    --
                  </p>
                </div>
                <div class="h-10 w-10 rounded-xl bg-rose-50 flex items-center justify-center">
                  <i class="fa-solid fa-fire-flame-curved text-rose-500 text-lg"></i>
                </div>
              </div>
              <p class="text-xs text-slate-500 leading-relaxed">
                Employees whose calculated discipline risk level is flagged as
                <span class="font-semibold text-rose-600">HIGH</span>.
              </p>
            </div>
          </div>










          <!-- Trends and Compliance Snapshot -->
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-6" style="max-width: 100% !important; width: 100% !important;">

            <!-- Disciplinary Actions - Last 12 Months -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col">
             <!-- Warnings by Department -->
         <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex flex-col">
              <div class="flex items-center justify-between mb-3">
                <div>
                  <h2 class="font-heading text-lg text-slate-900">
                    Warnings by Department
                  </h2>
                  <p class="text-xs text-slate-500 mt-1">
                    Distribution of verbal, written, and final warnings by operating area.
                  </p>
                </div>
                <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] font-medium text-slate-600">
                  Snapshot View
                </span>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-separate border-spacing-y-1">
                  <thead>
                    <tr class="text-left text-[0.70rem] text-slate-500">
                      <th class="px-3 py-2 font-semibold">Department</th>
                      <th class="px-3 py-2 font-semibold text-center">Verbal</th>
                      <th class="px-3 py-2 font-semibold text-center">Written</th>
                      <th class="px-3 py-2 font-semibold text-center">Final</th>
                      <th class="px-3 py-2 font-semibold text-center">Terminations</th>
                    </tr>
                  </thead>
                  <tbody id="table-dashboard-warnings-by-dept" class="align-middle">
                    <!-- Data will be populated dynamically -->
                  </tbody>
                </table>
              </div>
              <p class="mt-4 text-[0.70rem] text-slate-500 leading-relaxed">
                Actual values will be derived from <span class="font-semibold text-slate-700">employees2025</span>
                as the portal evolves. This table is structured to support dynamic aggregation by department.
              </p>
            </div>

              <!-- Real Chart using Chart.js -->
             <div class="chart-container">
  <canvas id="discipline-trend-chart"></canvas>
</div>

              <div class="mt-4 flex flex-wrap items-center gap-3 text-[0.70rem] text-slate-500">
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-emerald-500"></span>
                  Verbal Warnings
                </div>
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-amber-500"></span>
                  Written Warnings
                </div>
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-orange-500"></span>
                  Final Warnings
                </div>
                <div class="flex items-center gap-2">
                  <span class="w-3 h-3 rounded-full bg-rose-500"></span>
                  Terminations
                </div>
              </div>
            </div>

            

            
            
            </div>
          </div>
      

     <!-- Employees with Disciplinary Actions List -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h2 class="font-heading text-lg text-slate-900">
                  Employees with Disciplinary Actions
                </h2>
                <p class="text-xs text-slate-500 mt-1">
                  Click any employee to view their full discipline profile
                </p>
              </div>
              <span class="inline-flex items-center rounded-full bg-amber-50 border border-amber-100 px-2 py-0.5 text-[0.65rem] font-medium text-amber-700">
                <span id="discipline-count-badge">--</span> Active Cases
              </span>
            </div>

            <div id="dashboard-discipline-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-4">
              <!-- Employee cards will be populated here -->
              <div class="text-xs text-slate-400 col-span-full text-center py-4">
                Loading employees with discipline history...
              </div>
            </div>
          </div>
</section>










        <!-- Discipline Cases Tab -->
        <section id="tab-discipline" class="tab-panel hidden space-y-6">
          <!-- Discipline Intro + Status Banner -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Overview -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h2 class="font-heading text-xl text-slate-900">
                    Discipline Cases &amp; Corrective Actions
                  </h2>
                  <p class="mt-1 text-xs text-slate-500 leading-relaxed">
                    Use this workspace to issue <span class="font-medium">verbal, written, final warnings</span> and
                    <span class="font-medium">termination notices</span>. Actions taken here will update the source-of-truth
                    table <span class="font-semibold text-slate-800">employees2025</span>, recalculate risk scoring, and
                    support PDF documentation for signatures and record keeping aligned with TWC/DOL guidance.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-2 text-[0.70rem]">
                  <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 border border-brand-100 px-2 py-0.5 text-brand-700 font-medium">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    Live Record Updates
                  </span>
                  <span id="discipline-selected-employee-chip" class="hidden inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    <i class="fa-solid fa-id-badge text-[0.70rem]"></i>
                    <span id="discipline-selected-employee-name" class="font-medium"></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Status Banner -->
            <div class="bg-slate-900/0"></div>

            <div id="discipline-status-banner" class="lg:col-span-3 bg-slate-50 border border-dashed border-slate-300 rounded-2xl px-4 py-3 flex items-start gap-3">
              <div class="mt-0.5">
                <i class="fa-solid fa-circle-info text-brand-500"></i>
              </div>
              <div class="text-xs text-slate-600">
                <p class="font-medium text-slate-800">
                  Discipline Workflow Guidance
                </p>
                <p class="mt-1 leading-relaxed">
                  Before issuing any corrective action, confirm the employee's identity in
                  <span class="font-semibold text-slate-800">Employees 360</span>, validate the facts of the incident, and consult current
                  <span class="font-semibold text-slate-800">Jeng Chi Restaurant policies</span>.
                  All actions must be applied consistently, free from discrimination or retaliation, and aligned with applicable
                  <span class="font-semibold text-slate-800">TWC / DOL</span> standards.
                </p>
              </div>
            </div>
          </div>

          <!-- Discipline Layout: Employee Selector + Form + History -->
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">
            <!-- Left: Quick Employee Picker (reuses search results) -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  Quick Employee Selector
                </h3>
                <button
                  id="discipline-refresh-employees"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-[0.70rem] text-slate-600 hover:border-brand-200 hover:bg-brand-50 hover:text-brand-700 transition-colors"
                >
                  <i class="fa-solid fa-rotate-right text-[0.60rem]"></i>
                  <span>Refresh</span>
                </button>
              </div>
              <p class="text-xs text-slate-500">
                Search for an employee and click to load their profile into the discipline form. This ensures the action is tied to the
                correct <span class="font-semibold text-slate-700">employees2025</span> record.
              </p>

              <div class="mt-2 flex items-center gap-2">
                <input
                  id="discipline-employee-search"
                  type="text"
                  placeholder="Search by name or Employee ID"
                  class="flex-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                />
                <button
                  id="discipline-employee-search-button"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full bg-brand-500 px-3 py-2 text-xs font-medium text-white hover:bg-brand-600 shadow-sm"
                >
                  <i class="fa-solid fa-magnifying-glass text-[0.70rem]"></i>
                  <span>Find</span>
                </button>
              </div>

              <div id="discipline-employee-results" class="mt-3 max-h-64 overflow-y-auto space-y-2">
                <!-- Populated dynamically with small employee cards -->
              </div>
            </div>

            <!-- Middle: New Disciplinary Action Form -->
            <div class="xl:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  New Disciplinary Action
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-[0.70rem] text-slate-600">
                  <i class="fa-solid fa-lock text-[0.60rem]"></i>
                  <span>Confidential HR Record</span>
                </span>
              </div>

              <form id="discipline-form" class="space-y-4">
                <!-- Hidden field for employee id -->
                <input type="hidden" id="discipline-employee-id" />

                <!-- Type + Date -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div class="sm:col-span-2">
                    <label for="discipline-action-type" class="block text-xs font-heading text-slate-800 mb-1">
                      Type of Corrective Action <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-action-type"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select action type</option>
                      <option value="VERBAL_WARNING">Verbal Warning</option>
                      <option value="WRITTEN_WARNING">Written Warning</option>
                      <option value="FINAL_WARNING">Final Warning</option>
                      <option value="TERMINATION">Termination</option>
                    </select>
                  </div>
                  <div>
                    <label for="discipline-action-date" class="block text-xs font-heading text-slate-800 mb-1">
                      Action Date <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="date"
                      id="discipline-action-date"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                </div>

                <!-- Severity + Reference -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-severity" class="block text-xs font-heading text-slate-800 mb-1">
                      Severity <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-severity"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select severity</option>
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                    </select>
                  </div>
                  <div class="sm:col-span-2">
                    <label for="discipline-reference" class="block text-xs font-heading text-slate-800 mb-1">
                      Internal Reference / Incident ID
                    </label>
                    <input
                      type="text"
                      id="discipline-reference"
                      placeholder="Optional reference to incident report, video log, or complaint ticket"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Reason -->
                <div>
                  <label for="discipline-reason" class="block text-xs font-heading text-slate-800 mb-1">
                    Reason / Policy Violations <span class="text-rose-500">*</span>
                  </label>
                  <textarea
                    id="discipline-reason"
                    rows="4"
                    placeholder="Describe the incident, including dates, facts, witnesses, and specific Jeng Chi policy sections and TWC/DOL standards implicated."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    required
                  ></textarea>
                </div>

                <!-- Corrective Plan -->
                <div>
                  <label for="discipline-plan" class="block text-xs font-heading text-slate-800 mb-1">
                    Corrective Action Plan / Notes
                  </label>
                  <textarea
                    id="discipline-plan"
                    rows="4"
                    placeholder="Outline expectations, timelines, coaching, retraining, or final performance thresholds for the employee."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  ></textarea>
                </div>

                <!-- Signatures -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-manager-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Manager Typed Signature <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="discipline-manager-signature"
                      placeholder="Manager full name"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                  <div>
                    <label for="discipline-hr-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      HR Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-hr-signature"
                      placeholder="HR representative (optional)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                  <div>
                    <label for="discipline-employee-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Employee Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-employee-signature"
                      placeholder="Employee full name (if signing)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Acknowledgment -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-xs">
                  <label class="inline-flex items-start gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      id="discipline-employee-declined"
                      class="mt-0.5 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                    />
                    <span class="text-slate-600">
                      Employee declined to sign. Action is acknowledged only, and a signed copy will be provided per JCR policy.
                    </span>
                  </label>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                  <div class="flex items-center gap-2 text-[0.70rem] text-slate-500">
                    <i class="fa-solid fa-scale-balanced text-brand-500"></i>
                    <span>
                      By submitting, you confirm this action is consistent, non-retaliatory, and based solely on documented facts.
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="discipline-form-reset"
                      class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
                    >
                      <i class="fa-solid fa-eraser text-[0.70rem]"></i>
                      <span>Reset Form</span>
                    </button>
                    <button
                      type="submit"
                      id="discipline-form-submit"
                      class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600 disabled:opacity-60 disabled:cursor-not-allowed"
                    >
                      <span id="discipline-form-submit-spinner" class="hidden">
                        <i class="fa-solid fa-spinner fa-spin text-[0.80rem]"></i>
                      </span>
                      <span id="discipline-form-submit-text">Record Action &amp; Generate PDF</span>
                    </button>
                  </div>
                </div>

                <!-- Inline form status -->
                <div id="discipline-form-status" class="hidden rounded-xl border px-3 py-2 text-[0.70rem] mt-2">
                  <!-- Populated dynamically -->
                </div>
              </form>
            </div>
          </div>

          <!-- Discipline History & Audit Trail (will be scoped to selected employee) -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 items-start">
            <!-- History Timeline -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 relative">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Disciplinary History Timeline
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Chronological view of all corrective actions applied to the selected employee.
                  </p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-timeline text-[0.60rem]"></i>
                  <span>Most Recent First</span>
                </span>
              </div>

              <div class="mt-4 relative">
                <div class="timeline-line"></div>
                <div id="discipline-history-timeline" class="space-y-4 pl-8">
                  <!-- Timeline entries will be rendered here -->
                  <p class="text-xs text-slate-400">
                    Select an employee in <span class="font-medium text-slate-700">Employees 360</span> or in the
                    <span class="font-medium text-slate-700">Quick Employee Selector</span> to view their discipline history.
                  </p>
                </div>
              </div>
            </div>

            <!-- Audit Trail (Tabular) -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Discipline Audit Trail
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Evidence-ready list of actions, suitable for TWC hearings, DOL audits, or internal investigations.
                  </p>
                </div>
                <button
                  type="button"
                  id="discipline-audit-export"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-[0.70rem] text-slate-600 hover:bg-brand-50 hover:border-brand-200 hover:text-brand-700"
                >
                  <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                  <span>Export Timeline PDF</span>
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="min-w-full text-xs border-separate border-spacing-y-1">
                  <thead>
                    <tr class="text-[0.70rem] text-slate-500 text-left">
                      <th class="px-3 py-2 font-semibold">Timestamp</th>
                      <th class="px-3 py-2 font-semibold">Action</th>
                      <th class="px-3 py-2 font-semibold">Severity</th>
                      <th class="px-3 py-2 font-semibold">User</th>
                      <th class="px-3 py-2 font-semibold">Reference</th>
                    </tr>
                  </thead>
                  <tbody id="discipline-audit-table-body">
                    <!-- Populated with discipline_history entries -->
                    <tr class="bg-slate-50/60">
                      <td class="px-3 py-2 text-slate-400" colspan="5">
                        Audit entries will appear here when an employee with history is selected.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="mt-4 text-[0.70rem] text-slate-500 leading-relaxed">
                For each corrective action, this table references data persisted in
                <span class="font-semibold text-slate-800">employees2025.discipline_history</span>,
                combined with front-end context such as the acting user (e.g., "HR Admin" or "Manager").
                Together with PostgreSQL triggers
                <span class="font-semibold text-slate-800">set_employees_last_modified</span> and
                <span class="font-semibold text-slate-800">trg_log_employee_changes</span>,
                this creates a layered, defensible audit model.
              </p>
            </div>
          </div>
        </section>

        <!-- Employees 360 Tab -->
        <section id="tab-employees" class="tab-panel hidden space-y-6">
          <!-- Header Row -->
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Employees 360 &mdash; Discipline &amp; Risk View
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Search, select, and review an employee's full discipline profile, warnings, and risk level in one consolidated, executive-friendly card.
              </p>
            </div>
            <div class="flex items-center gap-3">
              <button
                id="employees-refresh-button"
                type="button"
                class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
              >
                <i class="fa-solid fa-arrows-rotate text-[0.70rem]"></i>
                <span>Refresh Employees</span>
              </button>
            </div>
          </div>

          <!-- Search + Layout -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start">
            <!-- Search + List -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3">
              <div>
                <label for="employees-search-input" class="block text-xs font-heading text-slate-800 mb-1">
                  Search Employees
                </label>
                <div class="flex items-center gap-2">
                  <input
                    id="employees-search-input"
                    type="text"
                    placeholder="Search by name, employee ID, or department"
                    class="flex-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  />
                  <button
                    id="employees-search-button"
                    type="button"
                    class="inline-flex items-center gap-1 rounded-full bg-brand-500 px-3 py-2 text-xs font-semibold text-white hover:bg-brand-600 shadow-sm"
                  >
                    <i class="fa-solid fa-magnifying-glass text-[0.70rem]"></i>
                    <span>Search</span>
                  </button>
                </div>
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Uses <span class="font-medium text-slate-700">employees2025</span> as the single source of truth.
                </p>
              </div>

              <div class="mt-2 flex flex-wrap gap-2 text-[0.70rem]">
                <button
                  type="button"
                  data-employee-filter="all"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-brand-100 bg-brand-50 px-2 py-1 text-brand-700 font-medium"
                >
                  <span>All</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="Active"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-slate-600"
                >
                  <span>Active</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="Terminated"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-slate-600"
                >
                  <span>Terminated</span>
                </button>
                <button
                  type="button"
                  data-employee-filter="HighRisk"
                  class="employee-filter-chip inline-flex items-center gap-1 rounded-full border border-rose-100 bg-rose-50 px-2 py-1 text-rose-600"
                >
                  <span>High Risk</span>
                </button>
              </div>

              <div id="employee-list" class="mt-3 max-h-[420px] overflow-y-auto space-y-2 text-xs">
                <!-- Employee list items will be rendered here -->
                <div class="rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-2 text-slate-400">
                  Run a search or refresh employees to load a list of profiles from employees2025.
                </div>
              </div>
            </div>

            <!-- Employee Profile 360 -->
            <div class="lg:col-span-2 space-y-6">
              <!-- Overview Card -->
              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                <div class="flex flex-col md:flex-row md:items-start md:justify-between gap-4">
                  <div class="flex items-start gap-3">
                    <div class="flex-shrink-0">
                      <div class="w-12 h-12 rounded-2xl bg-gradient-to-br from-brand-100 to-brand-500 text-white flex items-center justify-center font-heading text-lg shadow-md">
                        <span id="employee-profile-initials">--</span>
                      </div>
                    </div>
                    <div>
                      <h3 id="employee-profile-name" class="font-heading text-lg text-slate-900">
                        Select an employee
                      </h3>
                      <p id="employee-profile-title" class="text-xs text-slate-500 mt-0.5">
                        Job title &bull; Department
                      </p>
                      <p id="employee-profile-status" class="mt-1 text-[0.70rem] text-slate-500">
                        Employment status, hire dates, and reporting structure will appear here.
                      </p>
                    </div>
                  </div>
                  <div class="flex flex-col items-end gap-2">
                    <div id="employee-profile-risk-badge" class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-[0.70rem] text-slate-600">
                      <span class="w-1.5 h-1.5 rounded-full bg-slate-300"></span>
                      <span>Risk Score: &mdash;</span>
                    </div>
                    <div class="flex flex-wrap justify-end gap-2 text-[0.70rem]">
                      <span id="employee-profile-employee-id" class="inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-slate-600">
                        <i class="fa-solid fa-hashtag text-[0.60rem]"></i>
                        <span>Employee ID: --</span>
                      </span>
                      <span id="employee-profile-username" class="inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-2 py-1 text-slate-600">
                        <i class="fa-solid fa-user text-[0.60rem]"></i>
                        <span>Username: --</span>
                      </span>
                    </div>
                  </div>
                </div>

                <!-- KPI Row -->
                <div class="mt-4 grid grid-cols-2 md:grid-cols-4 gap-3 text-xs">
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Verbal Warnings
                    </span>
                    <span id="employee-kpi-verbal" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Written Warnings
                    </span>
                    <span id="employee-kpi-written" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Final Warnings
                    </span>
                    <span id="employee-kpi-final" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                  <div class="rounded-xl bg-slate-50 px-3 py-2 flex flex-col">
                    <span class="text-[0.70rem] text-slate-500 font-medium uppercase tracking-wide">
                      Termination Letters
                    </span>
                    <span id="employee-kpi-termination" class="mt-1 font-heading text-lg text-slate-900">
                      --
                    </span>
                  </div>
                </div>
              </div>

              <!-- Two-column details: Employment & Contact, Risk & Tenure -->
              <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
                <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                  <h4 class="font-heading text-sm text-slate-900 mb-2">
                    Employment &amp; Contact Details
                  </h4>
                  <dl class="space-y-1">
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Employment Status</dt>
                      <dd id="employee-detail-status" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Department</dt>
                      <dd id="employee-detail-department" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Manager / Reports To</dt>
                      <dd id="employee-detail-report-to" class="font-medium text-slate-800 text-right">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Email</dt>
                      <dd id="employee-detail-email" class="font-medium text-slate-800 text-right break-all">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Phone</dt>
                      <dd id="employee-detail-phone" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">City / State</dt>
                      <dd id="employee-detail-city-state" class="font-medium text-slate-800 text-right">--</dd>
                    </div>
                  </dl>
                </div>

                <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                  <h4 class="font-heading text-sm text-slate-900 mb-2">
                    Tenure, Risk &amp; Last Action
                  </h4>
                  <dl class="space-y-1">
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Original Hire Date</dt>
                      <dd id="employee-detail-original-hire" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Current Hire Date</dt>
                      <dd id="employee-detail-hire-date" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Tenure</dt>
                      <dd id="employee-detail-tenure" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Risk Score</dt>
                      <dd id="employee-detail-risk-score" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Risk Level</dt>
                      <dd id="employee-detail-risk-level" class="font-medium text-slate-800">--</dd>
                    </div>
                    <div class="flex justify-between gap-2">
                      <dt class="text-slate-500">Last Disciplinary Action</dt>
                      <dd id="employee-detail-last-action" class="font-medium text-slate-800 text-right">--</dd>
                    </div>
                  </dl>
                  <p class="mt-3 text-[0.70rem] text-slate-500 leading-relaxed">
                    Risk scoring is calculated using the JCR discipline model:
                    <span class="font-medium text-slate-700">1 point</span> per verbal warning,
                    <span class="font-medium text-slate-700">2 points</span> per written warning,
                    <span class="font-medium text-slate-700">3 points</span> per final warning,
                    and <span class="font-medium text-slate-700">4 points</span> per termination letter. Thresholds drive
                    <span class="font-semibold text-emerald-600">LOW</span>,
                    <span class="font-semibold text-amber-600">MEDIUM</span>, or
                    <span class="font-semibold text-rose-600">HIGH</span> risk flags.
                  </p>
                </div>
              </div>

              <!-- Employee History + Summary -->
              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                <div class="flex items-center justify-between gap-2">
                  <h4 class="font-heading text-sm text-slate-900">
                    Employee Discipline Summary
                  </h4>
                  <button
                    type="button"
                    id="employee-summary-pdf"
                    class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-[0.70rem] text-slate-600 hover:bg-brand-50 hover:border-brand-200 hover:text-brand-700"
                  >
                    <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                    <span>Download 360 PDF</span>
                  </button>
                </div>

                <div id="employee-summary-history" class="mt-3 text-xs text-slate-500">
                  <p>
                    Once an employee is selected, a concise narrative summary of their discipline history and risk posture will be generated here.
                  </p>
                </div>
              </div>
            </div>
          </div>
        </section>

        <!-- Policy Library Tab -->
        <section id="tab-policy" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Policy Library &amp; Reference
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Centralized view of external guidance and internal Jeng Chi Restaurant discipline policies used to inform corrective actions.
              </p>
            </div>
          </div>

          <!-- Filter Pills -->
          <div class="flex flex-wrap gap-2 text-[0.70rem]">
            <button
              type="button"
              data-policy-category="twc-dol"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-brand-700 font-medium"
            >
              <i class="fa-solid fa-scale-balanced text-[0.70rem]"></i>
              <span>TWC / DOL Guidance</span>
            </button>
            <button
              type="button"
              data-policy-category="internal"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-building text-[0.70rem]"></i>
              <span>Internal JCR Policies</span>
            </button>
            <button
              type="button"
              data-policy-category="discipline"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-gavel text-[0.70rem]"></i>
              <span>Discipline &amp; Corrective Action</span>
            </button>
            <button
              type="button"
              data-policy-category="complaint"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-comments text-[0.70rem]"></i>
              <span>Complaint &amp; Investigation Procedures</span>
            </button>
          </div>

          <!-- Policies Accordion -->
          <div id="policy-accordion" class="space-y-4 text-xs">
            <!-- TWC / DOL Guidance -->
            <article
              data-policy-category-panel="twc-dol"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    TWC / DOL Consistent Documentation Practices
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Align disciplinary documentation with requirements commonly reviewed in Texas Workforce Commission and U.S. Department of Labor proceedings.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-06-01
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Maintain <span class="font-medium">fact-based, contemporaneous documentation</span> for each incident, including dates, times, witnesses, and specific behaviors observed.
                  </li>
                  <li>
                    Ensure that <span class="font-medium">policies are communicated</span> to all employees, with signed acknowledgments held in personnel files or the digital portal.
                  </li>
                  <li>
                    Apply discipline <span class="font-medium">consistently across similarly situated employees</span> to mitigate allegations of disparate treatment or retaliation.
                  </li>
                  <li>
                    Use a <span class="font-medium">progressive discipline model</span> where appropriate (verbal, written, final, termination), while preserving the employer's right to accelerate steps when warranted.
                  </li>
                  <li>
                    Retain records for a reasonable period consistent with <span class="font-medium">TWC, DOL, and internal retention schedules</span>.
                  </li>
                </ul>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  This summary is provided for HR guidance and does not replace consultation with qualified legal counsel.
                </p>
              </div>
            </article>

            <!-- Internal JCR Policies -->
            <article
              data-policy-category-panel="internal"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    JCR Standard of Conduct &amp; Zero-Tolerance Areas
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Internal expectations for professional conduct, customer care, safety, and respect in the workplace.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-04-15
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    JCR maintains a <span class="font-medium">zero-tolerance policy</span> for violence, harassment, discrimination, and retaliation.
                  </li>
                  <li>
                    Employees must follow all <span class="font-medium">food safety, health, and cleanliness standards</span> applicable to restaurant operations.
                  </li>
                  <li>
                    Timekeeping, tip reporting, and wage-and-hour rules must be followed accurately and honestly.
                  </li>
                  <li>
                    All discipline should be documented in this portal to provide an <span class="font-medium">accurate 360° record</span>.
                  </li>
                  <li>
                    Any deviation from progressive discipline must be <span class="font-medium">approved by HR</span> and documented with rationale.
                  </li>
                </ul>
              </div>
            </article>

            <!-- Discipline & Corrective Action -->
            <article
              data-policy-category-panel="discipline"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Progressive Discipline Framework
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Structured approach guiding verbal, written, final, and termination decisions at Jeng Chi Restaurant.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-05-10
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ol class="list-decimal list-inside space-y-1">
                  <li>
                    <span class="font-medium">Coaching &amp; Verbal Feedback</span> &mdash; early-stage, non-punitive coaching that may be documented as a verbal warning when patterns emerge.
                  </li>
                  <li>
                    <span class="font-medium">Written Warning</span> &mdash; formal documentation of the issue, expectations, and timeline for improvement.
                  </li>
                  <li>
                    <span class="font-medium">Final Warning</span> &mdash; last opportunity to correct behavior, document clear consequences for non-compliance.
                  </li>
                  <li>
                    <span class="font-medium">Termination</span> &mdash; when the relationship must end, with a focus on professionalism, documentation, and consistent policy application.
                  </li>
                </ol>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  Leadership should consult HR before issuing final warnings or terminations, especially where protected activity or past complaints may be relevant.
                </p>
              </div>
            </article>

            <!-- Complaint & Investigation -->
            <article
              data-policy-category-panel="complaint"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Complaint Intake &amp; Investigation Procedures
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Processes for receiving, documenting, and investigating concerns raised by employees, guests, or vendors.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-03-20
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Complaints may be raised <span class="font-medium">verbally or in writing</span> to any manager or HR.
                  </li>
                  <li>
                    All complaints must be documented in a <span class="font-medium">central log</span>, with dates, participants, and next steps.
                  </li>
                  <li>
                    Investigations should be <span class="font-medium">prompt, impartial, and confidential</span> to the extent possible.
                  </li>
                  <li>
                    Retaliation against individuals who raise concerns or participate in investigations is strictly prohibited.
                  </li>
                  <li>
                    Outcomes of investigations should be documented and communicated appropriately, with discipline applied as needed.
                  </li>
                </ul>
              </div>
            </article>
          </div>

          <!-- AI Disclaimer -->
          <div class="rounded-2xl border border-dashed border-amber-200 bg-amber-50/50 px-4 py-3 text-[0.70rem] text-amber-800">
            <p class="font-semibold">
              AI-Assisted Content &amp; Legal Review
            </p>
            <p class="mt-1">
              Some explanatory language in this Policy Library has been drafted or structured using AI-assisted tools for clarity and
              consistency. These materials are provided for <span class="font-semibold">HR reference only</span> and do not constitute legal advice.
              Jeng Chi Restaurant leadership and HR must review, adapt, and approve all policy content, and should consult qualified labor
              and employment counsel to confirm alignment with current TWC, DOL, and applicable law.
            </p>
          </div>
        </section>

        <!-- Reports & Analytics Tab -->
        <section id="tab-reports" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Reports &amp; Analytics
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                High-level discipline metrics and executive reporting tools derived from the employees2025 dataset.
              </p>
            </div>
            <div class="flex items-center gap-2">
              <button
                id="reports-generate-summary"
                type="button"
                class="inline-flex items-center gap-1 rounded-full bg-brand-500 px-3 py-2 text-xs font-semibold text-white hover:bg-brand-600 shadow-sm"
              >
                <i class="fa-solid fa-file-lines text-[0.70rem]"></i>
                <span>Generate Summary Report</span>
              </button>
              <button
                id="reports-generate-summary-pdf"
                type="button"
                class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
              >
                <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                <span>Download PDF</span>
              </button>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 items-start text-xs">
            <!-- Warnings by Department (Report) -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 lg:col-span-2">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-heading text-sm text-slate-900">
                  Warnings by Department
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-table text-[0.60rem]"></i>
                  <span>Operational View</span>
                </span>
              </div>
              <div class="overflow-x-auto">
                <table class="min-w-full text-xs border-separate border-spacing-y-1">
                  <thead>
                    <tr class="text-left text-[0.70rem] text-slate-500">
                      <th class="px-3 py-2 font-semibold">Department</th>
                      <th class="px-3 py-2 font-semibold text-center">Verbal</th>
                      <th class="px-3 py-2 font-semibold text-center">Written</th>
                      <th class="px-3 py-2 font-semibold text-center">Final</th>
                      <th class="px-3 py-2 font-semibold text-center">Terminations</th>
                      <th class="px-3 py-2 font-semibold text-center">Total Points</th>
                    </tr>
                  </thead>
                  <tbody id="reports-table-warnings-by-dept" class="align-middle">
                    <!-- Data will be populated dynamically -->
                  </tbody>
                </table>
              </div>
            </div>

            <!-- Actions by Severity -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-heading text-sm text-slate-900">
                  Actions by Severity
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-circle-half-stroke text-[0.60rem]"></i>
                  <span>Severity Mix</span>
                </span>
              </div>

              <ul id="reports-actions-by-severity" class="space-y-2 text-xs">
                <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
                  <span class="text-slate-600">Low Severity</span>
                  <span class="font-heading text-base text-slate-900">--</span>
                </li>
                <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
                  <span class="text-slate-600">Medium Severity</span>
                  <span class="font-heading text-base text-slate-900">--</span>
                </li>
                <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
                  <span class="text-slate-600">High Severity</span>
                  <span class="font-heading text-base text-slate-900">--</span>
                </li>
              </ul>
            </div>
          </div>

          <!-- Open vs Completed Terminations & Summary -->
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 text-xs">
            <!-- Open vs Completed -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between mb-3">
                <h3 class="font-heading text-sm text-slate-900">
                  Open vs Completed Terminations
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-chart-pie text-[0.60rem]"></i>
                  <span>Case Status</span>
                </span>
              </div>
              <div class="grid grid-cols-2 gap-3">
                <div class="rounded-xl bg-rose-50 px-3 py-2">
                  <p class="text-[0.70rem] text-rose-700 font-medium uppercase tracking-wide">
                    Open Termination Cases
                  </p>
                  <p id="reports-open-terminations" class="mt-1 font-heading text-2xl text-rose-700">
                    --
                  </p>
                </div>
                <div class="rounded-xl bg-emerald-50 px-3 py-2">
                  <p class="text-[0.70rem] text-emerald-700 font-medium uppercase tracking-wide">
                    Completed Terminations
                  </p>
                  <p id="reports-completed-terminations" class="mt-1 font-heading text-2xl text-emerald-700">
                    --
                  </p>
                </div>
              </div>
            </div>

            <!-- Report Summary Panel -->
            <div id="reports-summary-panel" class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <h3 class="font-heading text-sm text-slate-900 mb-2">
                Executive Summary Report
              </h3>
              <div id="reports-summary-content" class="text-xs text-slate-500 space-y-1">
                <p>
                  Click <span class="font-semibold text-slate-800">Generate Summary Report</span> to assemble a concise overview
                  of discipline activity, risk concentration, and key governance metrics across the JCR workforce.
                </p>
              </div>
            </div>
          </div>
        </section>

        <!-- Admin & Settings Tab -->
        <section id="tab-admin" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Admin &amp; Settings
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Front-end configuration related to notifications, case handling, and risk scoring transparency.
              </p>
            </div>
          </div>

          <div class="grid grid-cols-1 lg:grid-cols-1 gap-6 text-xs">
            <!-- Toggles -->
            <div class="space-y-4">
              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex items-start justify-between gap-3">
                <div>
                  <p class="font-heading text-sm text-slate-900">
                    Enable Email Notifications
                  </p>
                  <p class="mt-1 text-xs text-slate-500">
                    Simulated toggle for future integration with email / messaging platforms to alert managers and HR when new discipline
                    actions are recorded or risk levels increase.
                  </p>
                </div>
                <button
                  type="button"
                  data-admin-toggle="email"
                  class="admin-toggle inline-flex items-center justify-between rounded-full bg-slate-100 px-1 py-0.5 w-12"
                  aria-pressed="false"
                >
                  <span class="sr-only">Toggle email notifications</span>
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white shadow-sm border border-slate-200 translate-x-0 transition-transform"></span>
                </button>
              </div>

              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 flex items-start justify-between gap-3">
                <div>
                  <p class="font-heading text-sm text-slate-900">
                    Lock Cases After PDF Signature
                  </p>
                  <p class="mt-1 text-xs text-slate-500">
                    Conceptual setting indicating that once a discipline PDF is generated and signed, further edits may require HR approval
                    or a new addendum rather than overwriting prior records.
                  </p>
                </div>
                <button
                  type="button"
                  data-admin-toggle="lock-cases"
                  class="admin-toggle inline-flex items-center justify-between rounded-full bg-slate-100 px-1 py-0.5 w-12"
                  aria-pressed="false"
                >
                  <span class="sr-only">Toggle lock cases setting</span>
                  <span class="inline-flex h-5 w-5 items-center justify-center rounded-full bg-white shadow-sm border border-slate-200 translate-x-0 transition-transform"></span>
                </button>
              </div>

              <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
                <p class="font-heading text-sm text-slate-900 mb-2">
                  Risk Scoring Model
                </p>
                <p class="text-xs text-slate-500 mb-2">
                  Current discipline risk score calculation used across the portal when actions are saved:
                </p>
                <div class="overflow-x-auto">
                  <table class="min-w-full text-xs border-separate border-spacing-y-1">
                    <thead>
                      <tr class="text-left text-[0.70rem] text-slate-500">
                        <th class="px-3 py-2 font-semibold">Action Type</th>
                        <th class="px-3 py-2 font-semibold text-center">Weight</th>
                        <th class="px-3 py-2 font-semibold text-center">Notes</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr class="bg-slate-50/60">
                        <td class="px-3 py-2 font-medium text-slate-700">Verbal Warning</td>
                        <td class="px-3 py-2 text-center text-slate-700">1</td>
                        <td class="px-3 py-2 text-slate-600">
                          Early-stage feedback; indicates emerging pattern if multiple occurrences.
                        </td>
                      </tr>
                      <tr class="bg-white">
                        <td class="px-3 py-2 font-medium text-slate-700">Written Warning</td>
                        <td class="px-3 py-2 text-center text-slate-700">2</td>
                        <td class="px-3 py-2 text-slate-600">
                          Formal documentation of issue and expectations, used when informal steps have not resolved the concern.
                        </td>
                      </tr>
                      <tr class="bg-slate-50/60">
                        <td class="px-3 py-2 font-medium text-slate-700">Final Warning</td>
                        <td class="px-3 py-2 text-center text-slate-700">3</td>
                        <td class="px-3 py-2 text-slate-600">
                          Indicates serious risk of separation if behavior does not change immediately.
                        </td>
                      </tr>
                      <tr class="bg-white">
                        <td class="px-3 py-2 font-medium text-slate-700">Termination</td>
                        <td class="px-3 py-2 text-center text-slate-700">4</td>
                        <td class="px-3 py-2 text-slate-600">
                          End of employment relationship; typically the result of severe misconduct, repeated issues, or business needs.
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
                <p class="mt-3 text-[0.70rem] text-slate-500">
                  Thresholds for LOW/MEDIUM/HIGH risk can be calibrated over time based on incident volume, role sensitivity, and JCR's
                  risk appetite. Current thresholds are: LOW &le; 2, MEDIUM &le; 5, HIGH &gt; 5.
                </p>
              </div>
            </div>
          </div>
        </section>
      </div>
    </main>
  </div>

  <!-- Hidden container for PDF generation -->
  <div id="pdf-generation-root" class="hidden"></div>

  <!-- Supabase Initialization & App Logic -->
  <script>
    // ------------------------------------------------------------
    // Supabase Configuration
    // ------------------------------------------------------------
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;

    // ------------------------------------------------------------
    // Global State
    // ------------------------------------------------------------
    const AppState = {
      employees: [],
      employeesLoadedAt: null,
      selectedEmployee: null,
      adminSettings: {
        emailNotificationsEnabled: false,
        lockCasesAfterSignature: false,
      },
      employeeFilterStatus: "all",
    };

    // ------------------------------------------------------------
    // Utility Functions
    // ------------------------------------------------------------

    function formatDate(dateStr) {
      if (!dateStr) return "--";
      try {
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return String(dateStr);
        return d.toLocaleDateString();
      } catch (err) {
        return String(dateStr);
      }
    }

    function formatDateTime(dateStr) {
      if (!dateStr) return "--";
      try {
        const d = new Date(dateStr);
        if (Number.isNaN(d.getTime())) return String(dateStr);
        return d.toLocaleString();
      } catch (err) {
        return String(dateStr);
      }
    }

    function calculateTenure(startDate) {
      if (!startDate) return "--";
      const start = new Date(startDate);
      if (Number.isNaN(start.getTime())) return "--";
      const now = new Date();
      let years = now.getFullYear() - start.getFullYear();
      let months = now.getMonth() - start.getMonth();
      if (months < 0) {
        years -= 1;
        months += 12;
      }
      if (years < 0) return "--";
      const parts = [];
      if (years > 0) parts.push(years + " yr" + (years > 1 ? "s" : ""));
      if (months > 0) parts.push(months + " mo" + (months > 1 ? "s" : ""));
      if (!parts.length) return "< 1 mo";
      return parts.join(" ");
    }

    function computeRiskScoreFromCounts(verbal, written, finalW, term) {
      const v = Number(verbal || 0);
      const w = Number(written || 0);
      const f = Number(finalW || 0);
      const t = Number(term || 0);
      const score = (v * 1) + (w * 2) + (f * 3) + (t * 4);
      let level = "LOW";
      if (score > 5) {
        level = "HIGH";
      } else if (score > 2) {
        level = "MEDIUM";
      }
      return { score, level };
    }

    function riskBadgeClasses(level) {
      switch ((level || "").toUpperCase()) {
        case "HIGH":
          return {
            container: "bg-rose-50 border border-rose-100 text-rose-700",
            dot: "bg-rose-500",
          };
        case "MEDIUM":
          return {
            container: "bg-amber-50 border border-amber-100 text-amber-700",
            dot: "bg-amber-500",
          };
        case "LOW":
        default:
          return {
            container: "bg-emerald-50 border border-emerald-100 text-emerald-700",
            dot: "bg-emerald-500",
          };
      }
    }

    function showToast(message, subtext, type) {
      const toast = document.getElementById("global-toast");
      const inner = document.getElementById("global-toast-inner");
      const msgEl = document.getElementById("global-toast-message");
      const subEl = document.getElementById("global-toast-subtext");

      msgEl.textContent = message || "";
      subEl.textContent = subtext || "";

      inner.classList.remove(
        "border-emerald-100",
        "bg-emerald-50",
        "text-emerald-800",
        "border-rose-100",
        "bg-rose-50",
        "text-rose-800",
        "border-amber-100",
        "bg-amber-50",
        "text-amber-800"
      );

      if (type === "error") {
        inner.classList.add("border-rose-100", "bg-rose-50", "text-rose-800");
      } else if (type === "warning") {
        inner.classList.add("border-amber-100", "bg-amber-50", "text-amber-800");
      } else {
        inner.classList.add("border-emerald-100", "bg-emerald-50", "text-emerald-800");
      }

      toast.style.opacity = "1";

      if (toast._timeoutHandle) {
        clearTimeout(toast._timeoutHandle);
      }
      toast._timeoutHandle = setTimeout(() => {
        toast.style.opacity = "0";
      }, 5000);
    }

    function hideToast() {
      const toast = document.getElementById("global-toast");
      toast.style.opacity = "0";
    }

    // ------------------------------------------------------------
    // Tab Switching
    // ------------------------------------------------------------
    function switchTab(tabId) {
      const panels = document.querySelectorAll(".tab-panel");
      panels.forEach((panel) => {
        if (panel.id === "tab-" + tabId) {
          panel.classList.remove("hidden");
        } else {
          panel.classList.add("hidden");
        }
      });

      const triggers = document.querySelectorAll(".tab-trigger");
      triggers.forEach((btn) => {
        const target = btn.getAttribute("data-tab-target");
        if (target === tabId) {
          btn.classList.remove("text-slate-600", "hover:text-brand-700", "hover:bg-brand-50", "border-transparent");
          btn.classList.add("bg-brand-50", "text-brand-700", "border", "border-brand-100", "shadow-sm");
        } else {
          btn.classList.remove("bg-brand-50", "text-brand-700", "border", "border-brand-100", "shadow-sm");
          btn.classList.add("text-slate-600", "hover:text-brand-700", "hover:bg-brand-50", "border-transparent");
        }
      });

      const mobileSelect = document.getElementById("mobile-tab-select");
      if (mobileSelect && mobileSelect.value !== tabId) {
        mobileSelect.value = tabId;
      }
    }

    // ------------------------------------------------------------
    // Employee Loading & Rendering
    // ------------------------------------------------------------
    async function fetchEmployees() {
      const { data, error } = await supabaseClient
        .from("employees2025")
        .select("*")
        .order("last_modified", { ascending: false })
        .limit(500);

      if (error) {
        console.error("Error fetching employees:", error);
        showToast("Unable to load employees", "Check Supabase connection and try again.", "error");
        return;
      }

      AppState.employees = Array.isArray(data) ? data : [];
      AppState.employeesLoadedAt = new Date();

      const headerTime = document.getElementById("header-last-refreshed");
      if (headerTime) {
        headerTime.textContent = AppState.employeesLoadedAt.toLocaleString();
      }

      updateDashboardKPIs();
      updateComplianceSnapshot();
      renderEmployeeList(AppState.employees);
      populateDashboardWarningsByDept();
      populateReportsWarningsByDept();
      populateActionsBySeverity();
      generate12MonthChart();
      populateDashboardDisciplineList();  // ← ADD THIS
    }

    function filterEmployeesByKeywordAndStatus(keyword, statusFilter) {
      const term = (keyword || "").trim().toLowerCase();
      const status = statusFilter || "all";

      return AppState.employees.filter((emp) => {
        if (status === "Active" && (emp.status || emp.employment_status) !== "Active") {
          return false;
        }
        if (status === "Terminated" && (emp.status || emp.employment_status) !== "Terminated") {
          return false;
        }
        if (status === "HighRisk" && (emp.risk_level || "").toUpperCase() !== "HIGH") {
          return false;
        }

        if (!term) return true;

        const fullName = (((emp.first_name || "") + " " + (emp.last_name || "")).trim()).toLowerCase();
        const employeeId = (emp.employee_id || "").toLowerCase();
        const dept = (emp.department || "").toLowerCase();

        return (
          fullName.includes(term) ||
          employeeId.includes(term) ||
          dept.includes(term)
        );
      });
    }

    function renderEmployeeList(list) {
      const container = document.getElementById("employee-list");
      if (!container) return;

      container.innerHTML = "";
      if (!list || !list.length) {
        const empty = document.createElement("div");
        empty.className = "rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-2 text-slate-400";
        empty.textContent = "No employees found with the current filters.";
        container.appendChild(empty);
        return;
      }

      list.forEach((emp) => {
        const fullName = (emp.first_name || "") + " " + (emp.last_name || "");
        const dept = emp.department || "Unassigned";
        const title = emp.job_title || emp.position_title || "Role not set";
        const riskLevel = (emp.risk_level || "LOW").toUpperCase();
        const riskScore = emp.risk_score != null ? Number(emp.risk_score).toFixed(1) : "--";
        const badge = riskBadgeClasses(riskLevel);
        const status = emp.status || emp.employment_status || "--";

        const card = document.createElement("button");
        card.type = "button";
        card.className = [
          "w-full text-left rounded-xl border px-3 py-2 flex items-center gap-3 hover:border-brand-200 hover:bg-brand-50/40 transition-colors",
          "border-slate-200 bg-white",
        ].join(" ");
        card.addEventListener("click", () => {
          selectEmployee(emp);
        });

        const initials =
          (emp.first_name || "?").charAt(0).toUpperCase() +
          (emp.last_name || "").charAt(0).toUpperCase();

        card.innerHTML = `
          <div class="flex-shrink-0">
            <div class="w-8 h-8 rounded-xl bg-gradient-to-br from-brand-100 to-brand-500 text-white flex items-center justify-center font-heading text-xs shadow-sm">
              ${initials}
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 truncate">${fullName || "Unnamed Employee"}</p>
            <p class="text-[0.70rem] text-slate-500 truncate">${title} &bull; ${dept}</p>
          </div>
          <div class="flex flex-col items-end gap-1 text-[0.65rem]">
            <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 ${badge.container}">
              <span class="w-1.5 h-1.5 rounded-full ${badge.dot}"></span>
              <span>${riskLevel} &bull; ${riskScore}</span>
            </span>
            <span class="text-slate-400">${status}</span>
          </div>
        `;

        container.appendChild(card);
      });
    }

    function renderDisciplineEmployeeResults(list) {
      const container = document.getElementById("discipline-employee-results");
      if (!container) return;

      container.innerHTML = "";
      if (!list || !list.length) {
        const empty = document.createElement("div");
        empty.className = "rounded-xl border border-dashed border-slate-200 bg-slate-50 px-3 py-2 text-xs text-slate-400";
        empty.textContent = "No employees found. Adjust your search or filters.";
        container.appendChild(empty);
        return;
      }

      list.forEach((emp) => {
        const fullName = (emp.first_name || "") + " " + (emp.last_name || "");
        const dept = emp.department || "Unassigned";
        const title = emp.job_title || emp.position_title || "Role not set";
        const riskLevel = (emp.risk_level || "LOW").toUpperCase();
        const riskScore = emp.risk_score != null ? Number(emp.risk_score).toFixed(1) : "--";
        const badge = riskBadgeClasses(riskLevel);

        const btn = document.createElement("button");
        btn.type = "button";
        btn.className =
          "w-full text-left rounded-xl border border-slate-200 bg-white px-3 py-2 text-xs flex items-center gap-3 hover:border-brand-200 hover:bg-brand-50/40 transition-colors";
        btn.addEventListener("click", () => {
          selectEmployee(emp);
          switchTab("discipline");
        });

        const initials =
          (emp.first_name || "?").charAt(0).toUpperCase() +
          (emp.last_name || "").charAt(0).toUpperCase();

        btn.innerHTML = `
          <div class="flex-shrink-0">
            <div class="w-7 h-7 rounded-xl bg-gradient-to-br from-brand-100 to-brand-500 text-white flex items-center justify-center font-heading text-xs shadow-sm">
              ${initials}
            </div>
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium text-slate-800 truncate">${fullName || "Unnamed Employee"}</p>
            <p class="text-[0.65rem] text-slate-500 truncate">${title} &bull; ${dept}</p>
          </div>
          <div class="flex flex-col items-end gap-1 text-[0.65rem]">
            <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 ${badge.container}">
              <span class="w-1.5 h-1.5 rounded-full ${badge.dot}"></span>
              <span>${riskLevel} &bull; ${riskScore}</span>
            </span>
          </div>
        `;

        container.appendChild(btn);
      });
    }

    function selectEmployee(emp) {
      AppState.selectedEmployee = emp;
      renderEmployeeProfile(emp);
      renderDisciplineHistory(emp);

      const chip = document.getElementById("discipline-selected-employee-chip");
      const nameSpan = document.getElementById("discipline-selected-employee-name");
      const hiddenInput = document.getElementById("discipline-employee-id");

      if (chip && nameSpan && hiddenInput) {
        nameSpan.textContent = (emp.first_name || "") + " " + (emp.last_name || "");
        hiddenInput.value = emp.id || "";
        chip.classList.remove("hidden");
      }
    }

    function renderEmployeeProfile(emp) {
      const fullName = (emp?.first_name || "") + " " + (emp?.last_name || "");
      const initials =
        (emp?.first_name || "?").charAt(0).toUpperCase() +
        (emp?.last_name || "").charAt(0).toUpperCase();

      const nameEl = document.getElementById("employee-profile-name");
      const initialsEl = document.getElementById("employee-profile-initials");
      const titleEl = document.getElementById("employee-profile-title");
      const statusEl = document.getElementById("employee-profile-status");
      const employeeIdEl = document.getElementById("employee-profile-employee-id");
      const usernameEl = document.getElementById("employee-profile-username");

      const detailStatus = document.getElementById("employee-detail-status");
      const detailDept = document.getElementById("employee-detail-department");
      const detailReportTo = document.getElementById("employee-detail-report-to");
      const detailEmail = document.getElementById("employee-detail-email");
      const detailPhone = document.getElementById("employee-detail-phone");
      const detailCityState = document.getElementById("employee-detail-city-state");
      const detailOriginalHire = document.getElementById("employee-detail-original-hire");
      const detailHireDate = document.getElementById("employee-detail-hire-date");
      const detailTenure = document.getElementById("employee-detail-tenure");
      const detailRiskScore = document.getElementById("employee-detail-risk-score");
      const detailRiskLevel = document.getElementById("employee-detail-risk-level");
      const detailLastAction = document.getElementById("employee-detail-last-action");

      const verbalKpi = document.getElementById("employee-kpi-verbal");
      const writtenKpi = document.getElementById("employee-kpi-written");
      const finalKpi = document.getElementById("employee-kpi-final");
      const termKpi = document.getElementById("employee-kpi-termination");

      const riskBadge = document.getElementById("employee-profile-risk-badge");
      const summaryHistory = document.getElementById("employee-summary-history");

      if (!emp) {
        if (nameEl) nameEl.textContent = "Select an employee";
        if (titleEl) titleEl.textContent = "Job title • Department";
        if (statusEl) statusEl.textContent = "Employment status, hire dates, and reporting structure will appear here.";
        if (initialsEl) initialsEl.textContent = "--";
        if (employeeIdEl) {
          employeeIdEl.innerHTML =
            '<i class="fa-solid fa-hashtag text-[0.60rem]"></i>' +
            '<span>Employee ID: --</span>';
        }
        if (usernameEl) {
          usernameEl.innerHTML =
            '<i class="fa-solid fa-user text-[0.60rem]"></i>' +
            '<span>Username: --</span>';
        }
        return;
      }

      const jobTitle = emp.job_title || emp.position_title || "Role not set";
      const dept = emp.department || "Unassigned";
      const status = emp.status || emp.employment_status || "Active";
      const city = emp.city || (emp.address && emp.address.city) || "";
      const state = emp.state || (emp.address && emp.address.state) || "";
      const cityState = [city, state].filter(Boolean).join(", ");

      const verbalCount = emp.verbal_warning_count || 0;
      const writtenCount = emp.disciplinary_warning_count || 0;
      const finalCount = emp.final_warning_count || 0;
      const termCount = emp.termination_letter_count || 0;

      const riskScoreRaw = emp.risk_score != null ? Number(emp.risk_score) : null;
      const riskLevelRaw = (emp.risk_level || "LOW").toUpperCase();

      const { score, level } = riskScoreRaw != null
        ? { score: riskScoreRaw, level: riskLevelRaw }
        : computeRiskScoreFromCounts(verbalCount, writtenCount, finalCount, termCount);

      const lastAction = emp.last_disciplinary_action || null;
      const lastActionType = lastAction && lastAction.action_type ? lastAction.action_type : null;
      const lastActionDate = lastAction && lastAction.action_date ? formatDate(lastAction.action_date) : "--";

      if (nameEl) nameEl.textContent = fullName || "Unnamed Employee";
      if (initialsEl) initialsEl.textContent = initials;
      if (titleEl) titleEl.textContent = jobTitle + " • " + dept;

      if (statusEl) {
        const hireDateText = formatDate(emp.hire_date || emp.original_hire_date);
        statusEl.textContent =
          "Status: " + (status || "--") + " • Hire Date: " + hireDateText;
      }

      if (employeeIdEl) {
        employeeIdEl.innerHTML =
          '<i class="fa-solid fa-hashtag text-[0.60rem]"></i>' +
          '<span>Employee ID: ' + (emp.employee_id || "--") + "</span>";
      }

      if (usernameEl) {
        usernameEl.innerHTML =
          '<i class="fa-solid fa-user text-[0.60rem]"></i>' +
          '<span>Username: ' + (emp.username || "--") + "</span>";
      }

      if (detailStatus) detailStatus.textContent = status || "--";
      if (detailDept) detailDept.textContent = dept || "--";
      if (detailReportTo) detailReportTo.textContent = emp.report_to || "--";
      if (detailEmail) detailEmail.textContent = emp.email || "--";
      if (detailPhone) detailPhone.textContent = emp.phone || emp.primary_phone || "--";
      if (detailCityState) detailCityState.textContent = cityState || "--";
      if (detailOriginalHire) detailOriginalHire.textContent = formatDate(emp.original_hire_date);
      if (detailHireDate) detailHireDate.textContent = formatDate(emp.hire_date);
      if (detailTenure) detailTenure.textContent = calculateTenure(emp.hire_date || emp.original_hire_date);

      if (detailRiskScore) detailRiskScore.textContent = score.toFixed(1);
      if (detailRiskLevel) detailRiskLevel.textContent = level;

      if (detailLastAction) {
        if (!lastActionType) {
          detailLastAction.textContent = "--";
        } else {
          detailLastAction.textContent = lastActionType + " • " + lastActionDate;
        }
      }

      if (verbalKpi) verbalKpi.textContent = verbalCount;
      if (writtenKpi) writtenKpi.textContent = writtenCount;
      if (finalKpi) finalKpi.textContent = finalCount;
      if (termKpi) termKpi.textContent = termCount;

      if (riskBadge) {
        const badge = riskBadgeClasses(level);
        riskBadge.className =
          "inline-flex items-center gap-2 rounded-full px-2 py-1 text-[0.70rem] " + badge.container;
        riskBadge.innerHTML =
          '<span class="w-1.5 h-1.5 rounded-full ' + badge.dot + '"></span>' +
          "<span>Risk Score: " + score.toFixed(1) + " • " + level + "</span>";
      }

      if (summaryHistory) {
        const description = [];
        description.push(
          "This employee has " + verbalCount + " verbal, " + writtenCount + " written, " + finalCount + " final warnings, and " + termCount + " termination letters on record."
        );
        description.push(
          "The current risk score is " + score.toFixed(1) + " (" + level + ") based on the JCR discipline model."
        );
        if (lastActionType) {
          description.push(
            "The last recorded action was a " + lastActionType + " on " + lastActionDate + "."
          );
        }
        summaryHistory.textContent = description.join(" ");
      }
    }

    function renderDisciplineHistory(emp) {
      const timeline = document.getElementById("discipline-history-timeline");
      const auditBody = document.getElementById("discipline-audit-table-body");

      if (!timeline || !auditBody) return;

      timeline.innerHTML = "";
      auditBody.innerHTML = "";

      if (!emp) {
        const p = document.createElement("p");
        p.className = "text-xs text-slate-400";
        p.textContent =
          "Select an employee in Employees 360 or Quick Employee Selector to view their discipline history.";
        timeline.appendChild(p);

        const tr = document.createElement("tr");
        tr.className = "bg-slate-50/60";
        tr.innerHTML =
          '<td class="px-3 py-2 text-slate-400" colspan="5">Audit entries will appear here when an employee with history is selected.</td>';
        auditBody.appendChild(tr);
        return;
      }

      const history = Array.isArray(emp.discipline_history) ? emp.discipline_history.slice() : [];

      history.sort((a, b) => {
        const da = new Date(a.action_date || a.created_at || 0).getTime();
        const db = new Date(b.action_date || b.created_at || 0).getTime();
        return db - da;
      });

      if (!history.length) {
        const p = document.createElement("p");
        p.className = "text-xs text-slate-400";
        p.textContent = "No disciplinary history has been recorded for this employee yet.";
        timeline.appendChild(p);

        const tr = document.createElement("tr");
        tr.className = "bg-slate-50/60";
        tr.innerHTML =
          '<td class="px-3 py-2 text-slate-400" colspan="5">No audit entries found for this employee.</td>';
        auditBody.appendChild(tr);
        return;
      }

      history.forEach((entry) => {
        const type = (entry.action_type || "").toUpperCase();
        const severity = (entry.severity || "").toUpperCase();
        const dateLabel = formatDate(entry.action_date || entry.created_at);
        const manager = entry.manager_signature || "Manager";
        const hr = entry.hr_signature || "HR";
        const employeeSig = entry.employee_signature || null;
        const declined = entry.employee_declined === true;
        const ref = entry.reference || entry.internal_reference || "";
        const user = entry.created_by || "HR Admin";

        const severityLabel = severity || "N/A";

        const badge = (() => {
          if (type === "TERMINATION") {
            return "bg-rose-50 border border-rose-100 text-rose-700";
          }
          if (type === "FINAL_WARNING") {
            return "bg-orange-50 border border-orange-100 text-orange-700";
          }
          if (type === "WRITTEN_WARNING") {
            return "bg-amber-50 border border-amber-100 text-amber-700";
          }
          if (type === "VERBAL_WARNING") {
            return "bg-emerald-50 border border-emerald-100 text-emerald-700";
          }
          return "bg-slate-50 border border-slate-200 text-slate-700";
        })();

        // Timeline card
        const wrapper = document.createElement("div");
        wrapper.className = "relative";

        const bullet = document.createElement("div");
        bullet.className =
          "absolute left-0 top-2 w-4 h-4 rounded-full border-2 border-white shadow-sm bg-brand-500";
        wrapper.appendChild(bullet);

        const card = document.createElement("div");
        card.className = "ml-3 rounded-xl bg-slate-50 border border-slate-100 px-3 py-2";
        card.innerHTML = `
          <div class="flex items-center justify-between gap-2">
            <div class="flex items-center gap-2">
              <span class="inline-flex items-center gap-2 rounded-full px-2 py-0.5 text-[0.65rem] ${badge}">
                <span class="font-semibold">${type || "ACTION"}</span>
                <span class="text-slate-500">${severityLabel}</span>
              </span>
              <span class="text-[0.70rem] text-slate-500">${dateLabel}</span>
            </div>
            <span class="text-[0.65rem] text-slate-400">${ref || ""}</span>
          </div>
          <div class="mt-1 text-xs text-slate-700">
            <p class="font-medium">Reason / Policy</p>
            <p class="text-slate-600">${entry.reason || "Not provided."}</p>
          </div>
          <div class="mt-1 text-xs text-slate-700">
            <p class="font-medium">Corrective Plan / Notes</p>
            <p class="text-slate-600">${entry.corrective_plan || "Not provided."}</p>
          </div>
          <div class="mt-2 grid grid-cols-1 sm:grid-cols-3 gap-2 text-[0.70rem] text-slate-500">
            <div>
              <span class="block text-slate-400">Manager</span>
              <span class="font-medium text-slate-700">${manager}</span>
            </div>
            <div>
              <span class="block text-slate-400">HR</span>
              <span class="font-medium text-slate-700">${hr}</span>
            </div>
            <div>
              <span class="block text-slate-400">Employee</span>
              <span class="font-medium text-slate-700">
                ${
                  declined
                    ? "Declined to sign"
                    : (employeeSig || "Signature not captured")
                }
              </span>
            </div>
          </div>
        `;
        wrapper.appendChild(card);
        timeline.appendChild(wrapper);

        // Audit row
        const tr = document.createElement("tr");
        tr.className = "bg-slate-50/60 hover:bg-slate-100 transition-colors";
        tr.innerHTML = `
          <td class="px-3 py-2 text-slate-700">${dateLabel}</td>
          <td class="px-3 py-2 text-slate-700">${type}</td>
          <td class="px-3 py-2 text-slate-700 text-center">${severityLabel}</td>
          <td class="px-3 py-2 text-slate-700 text-center">${user}</td>
          <td class="px-3 py-2 text-slate-500 text-right">${ref || ""}</td>
        `;
        auditBody.appendChild(tr);
      });
    }

    function updateDashboardKPIs() {
      const totalEmployees = AppState.employees.filter(
        (e) => (e.status || e.employment_status || "Active") === "Active"
      ).length;

      const employeesWithWarnings = AppState.employees.filter((e) => {
        const v = e.verbal_warning_count || 0;
        const w = e.disciplinary_warning_count || 0;
        const f = e.final_warning_count || 0;
        const t = e.termination_letter_count || 0;
        return v + w + f + t > 0;
      }).length;

      const openTerminations = AppState.employees.filter(
        (e) => (e.termination_status || "").toLowerCase() === "pending"
      ).length;

      const highRiskEmployees = AppState.employees.filter(
        (e) => (e.risk_level || "").toUpperCase() === "HIGH"
      ).length;

      const kpiTotal = document.getElementById("kpi-total-employees");
      const kpiWarnings = document.getElementById("kpi-employees-with-warnings");
      const kpiOpenTerm = document.getElementById("kpi-open-terminations");
      const kpiHighRisk = document.getElementById("kpi-high-risk-employees");

      if (kpiTotal) kpiTotal.textContent = totalEmployees;
      if (kpiWarnings) kpiWarnings.textContent = employeesWithWarnings;
      if (kpiOpenTerm) kpiOpenTerm.textContent = openTerminations;
      if (kpiHighRisk) kpiHighRisk.textContent = highRiskEmployees;

      const reportsOpen = document.getElementById("reports-open-terminations");
      const reportsCompleted = document.getElementById("reports-completed-terminations");
      if (reportsOpen) reportsOpen.textContent = openTerminations;
      if (reportsCompleted) {
        const completed = AppState.employees.filter(
          (e) => (e.termination_status || "").toLowerCase() === "completed"
        ).length;
        reportsCompleted.textContent = completed;
      }
    }

    function updateComplianceSnapshot() {
      const withHistory = AppState.employees.filter(
        (e) => Array.isArray(e.discipline_history) && e.discipline_history.length
      );
      const snapshotHistoryCount = document.getElementById("snapshot-employees-with-history");
      const snapshotLastUpdate = document.getElementById("snapshot-last-discipline-update");
      const snapshotActiveTermination = document.getElementById("snapshot-active-termination-count");

      if (snapshotHistoryCount) snapshotHistoryCount.textContent = withHistory.length;

      let latestDate = null;
      withHistory.forEach((emp) => {
        const hist = emp.discipline_history;
        hist.forEach((entry) => {
          const d = new Date(entry.action_date || entry.created_at || 0);
          if (!Number.isNaN(d.getTime())) {
            if (!latestDate || d > latestDate) latestDate = d;
          }
        });
      });
      if (snapshotLastUpdate) {
        snapshotLastUpdate.textContent = latestDate ? latestDate.toLocaleString() : "--";
      }

      const activeTerm = AppState.employees.filter(
        (e) => (e.termination_status || "").toLowerCase() === "pending"
      ).length;
      if (snapshotActiveTermination) snapshotActiveTermination.textContent = activeTerm;
    }

    // ------------------------------------------------------------
    // Populate Dashboard Tables with Real Data
    // ------------------------------------------------------------
    function populateDashboardWarningsByDept() {
      const tbody = document.getElementById("table-dashboard-warnings-by-dept");
      if (!tbody) return;

      tbody.innerHTML = "";

      const deptStats = {};
      
      AppState.employees.forEach((emp) => {
        const dept = emp.department || "Unassigned";
        if (!deptStats[dept]) {
          deptStats[dept] = {
            verbal: 0,
            written: 0,
            final: 0,
            terminations: 0
          };
        }
        
        deptStats[dept].verbal += emp.verbal_warning_count || 0;
        deptStats[dept].written += emp.disciplinary_warning_count || 0;
        deptStats[dept].final += emp.final_warning_count || 0;
        deptStats[dept].terminations += emp.termination_letter_count || 0;
      });

      Object.keys(deptStats).sort().forEach((dept, index) => {
        const stats = deptStats[dept];
        const rowClass = index % 2 === 0 
          ? "bg-slate-50/60 hover:bg-slate-100 transition-colors" 
          : "bg-white hover:bg-slate-50 transition-colors";

        const tr = document.createElement("tr");
        tr.className = rowClass;
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium text-slate-700">${dept}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.verbal}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.written}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.final}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.terminations}</td>
        `;
        tbody.appendChild(tr);
      });

      if (Object.keys(deptStats).length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="5" class="px-3 py-2 text-center text-slate-400">
            No discipline data available
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateReportsWarningsByDept() {
      const tbody = document.getElementById("reports-table-warnings-by-dept");
      if (!tbody) return;

      tbody.innerHTML = "";

      const deptStats = {};
      
      AppState.employees.forEach((emp) => {
        const dept = emp.department || "Unassigned";
        if (!deptStats[dept]) {
          deptStats[dept] = {
            verbal: 0,
            written: 0,
            final: 0,
            terminations: 0,
            totalPoints: 0
          };
        }
        
        const v = emp.verbal_warning_count || 0;
        const w = emp.disciplinary_warning_count || 0;
        const f = emp.final_warning_count || 0;
        const t = emp.termination_letter_count || 0;
        
        deptStats[dept].verbal += v;
        deptStats[dept].written += w;
        deptStats[dept].final += f;
        deptStats[dept].terminations += t;
        deptStats[dept].totalPoints += (v * 1) + (w * 2) + (f * 3) + (t * 4);
      });

      Object.keys(deptStats).sort().forEach((dept, index) => {
        const stats = deptStats[dept];
        const rowClass = index % 2 === 0 
          ? "bg-slate-50/60 hover:bg-slate-100 transition-colors" 
          : "bg-white hover:bg-slate-50 transition-colors";

        const tr = document.createElement("tr");
        tr.className = rowClass;
        tr.innerHTML = `
          <td class="px-3 py-2 font-medium text-slate-700">${dept}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.verbal}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.written}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.final}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.terminations}</td>
          <td class="px-3 py-2 text-center text-slate-700">${stats.totalPoints}</td>
        `;
        tbody.appendChild(tr);
      });

      if (Object.keys(deptStats).length === 0) {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td colspan="6" class="px-3 py-2 text-center text-slate-400">
            No discipline data available
          </td>
        `;
        tbody.appendChild(tr);
      }
    }

    function populateActionsBySeverity() {
      const container = document.getElementById("reports-actions-by-severity");
      if (!container) return;

      const severityCounts = {
        LOW: 0,
        MEDIUM: 0,
        HIGH: 0
      };

      AppState.employees.forEach((emp) => {
        if (Array.isArray(emp.discipline_history)) {
          emp.discipline_history.forEach((entry) => {
            const sev = (entry.severity || "LOW").toUpperCase();
            if (severityCounts[sev] !== undefined) {
              severityCounts[sev]++;
            }
          });
        }
      });

      container.innerHTML = `
        <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
          <span class="text-slate-600">Low Severity</span>
          <span class="font-heading text-base text-slate-900">${severityCounts.LOW}</span>
        </li>
        <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
          <span class="text-slate-600">Medium Severity</span>
          <span class="font-heading text-base text-slate-900">${severityCounts.MEDIUM}</span>
        </li>
        <li class="flex items-center justify-between bg-slate-50 rounded-xl px-3 py-2">
          <span class="text-slate-600">High Severity</span>
          <span class="font-heading text-base text-slate-900">${severityCounts.HIGH}</span>
        </li>
      `;
    }

    // ------------------------------------------------------------
    // Generate 12-Month Discipline Trend Chart
    // ------------------------------------------------------------







    function generate12MonthChart() {
  const canvas = document.getElementById("discipline-trend-chart");
  if (!canvas) return;
  if (window.disciplineTrendChart) {
    window.disciplineTrendChart.destroy();
  }
  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push({
      month: d.getMonth(),
      year: d.getFullYear(),
      label: d.toLocaleDateString('en-US', { month: 'short', year: '2-digit' })
    });
  }
  const chartData = {
    verbal: new Array(12).fill(0),
    written: new Array(12).fill(0),
    final: new Array(12).fill(0),
    termination: new Array(12).fill(0)
  };
  AppState.employees.forEach((emp) => {
    if (Array.isArray(emp.discipline_history)) {
      emp.discipline_history.forEach((entry) => {
        const actionDate = new Date(entry.action_date || entry.created_at);
        if (isNaN(actionDate.getTime())) return;
        const actionMonth = actionDate.getMonth();
        const actionYear = actionDate.getFullYear();
        const monthIndex = months.findIndex(
          m => m.month === actionMonth && m.year === actionYear
        );
        if (monthIndex !== -1) {
          const type = (entry.action_type || "").toUpperCase();
          switch (type) {
            case "VERBAL_WARNING":
              chartData.verbal[monthIndex]++;
              break;
            case "WRITTEN_WARNING":
              chartData.written[monthIndex]++;
              break;
            case "FINAL_WARNING":
              chartData.final[monthIndex]++;
              break;
            case "TERMINATION":
              chartData.termination[monthIndex]++;
              break;
          }
        }
      });
    }
  });
  const ctx = canvas.getContext('2d');
  window.disciplineTrendChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: months.map(m => m.label),
      datasets: [













            {
              label: 'Verbal Warnings',
              data: chartData.verbal,
              borderColor: 'rgb(34, 197, 94)',
              backgroundColor: 'rgba(34, 197, 94, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Written Warnings',
              data: chartData.written,
              borderColor: 'rgb(251, 191, 36)',
              backgroundColor: 'rgba(251, 191, 36, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Final Warnings',
              data: chartData.final,
              borderColor: 'rgb(249, 115, 22)',
              backgroundColor: 'rgba(249, 115, 22, 0.1)',
              tension: 0.4,
              fill: true
            },
            {
              label: 'Terminations',
              data: chartData.termination,
              borderColor: 'rgb(239, 68, 68)',
              backgroundColor: 'rgba(239, 68, 68, 0.1)',
              tension: 0.4,
              fill: true
            }
          ]
        },
    options: {
  responsive: true,
  maintainAspectRatio: true,
  aspectRatio: 2.5,
  layout: {
    padding: {
      bottom: 20
    }
  },
  plugins: {
    legend: {
      display: false
    },
    tooltip: {
      mode: 'index',
      intersect: false
    }
  },
  scales: {
    x: {
      ticks: {
        autoSkip: false,
        maxRotation: 45,
        minRotation: 45,
        padding: 5
      },
      grid: {
        display: false
      }
    },
    y: {
      beginAtZero: true,
      ticks: {
        precision: 0,
        padding: 10
      }
    }
  },
  interaction: {
    mode: 'nearest',
    axis: 'x',
    intersect: false
  }
}
  });
}





// ------------------------------------------------------------
// Populate Dashboard Discipline List
// ------------------------------------------------------------
function populateDashboardDisciplineList() {
  const container = document.getElementById("dashboard-discipline-list");
  const badge = document.getElementById("discipline-count-badge");
  
  if (!container) return;

  // Filter employees who have any discipline history
  const employeesWithDiscipline = AppState.employees.filter((emp) => {
    const v = emp.verbal_warning_count || 0;
    const w = emp.disciplinary_warning_count || 0;
    const f = emp.final_warning_count || 0;
    const t = emp.termination_letter_count || 0;
    return (v + w + f + t) > 0;
  });

  // Update badge count
  if (badge) {
    badge.textContent = employeesWithDiscipline.length;
  }

  container.innerHTML = "";

  if (employeesWithDiscipline.length === 0) {
    container.innerHTML = `
      <div class="text-xs text-slate-400 col-span-full text-center py-4">
        No employees with disciplinary actions found
      </div>
    `;
    return;
  }

  // Sort by risk score (highest first)
  employeesWithDiscipline.sort((a, b) => {
    const scoreA = a.risk_score || 0;
    const scoreB = b.risk_score || 0;
    return scoreB - scoreA;
  });

  // Create cards
  employeesWithDiscipline.forEach((emp) => {
    const fullName = (emp.first_name || "") + " " + (emp.last_name || "");
    const dept = emp.department || "Unassigned";
    const riskLevel = (emp.risk_level || "LOW").toUpperCase();
    const riskScore = emp.risk_score != null ? Number(emp.risk_score).toFixed(1) : "0.0";
    const badge = riskBadgeClasses(riskLevel);

    const verbalCount = emp.verbal_warning_count || 0;
    const writtenCount = emp.disciplinary_warning_count || 0;
    const finalCount = emp.final_warning_count || 0;
    const termCount = emp.termination_letter_count || 0;

    const card = document.createElement("button");
    card.type = "button";
    card.className = "text-left rounded-xl border border-slate-200 bg-white p-3 hover:border-brand-300 hover:bg-brand-50/30 hover:shadow-md transition-all";
    card.addEventListener("click", () => {
      selectEmployee(emp);
      switchTab("employees");
    });

    card.innerHTML = `
      <div class="flex items-start justify-between gap-2 mb-2">
        <div class="flex-1 min-w-0">
          <p class="font-semibold text-slate-900 truncate">${fullName}</p>
          <p class="text-xs text-slate-500 truncate">${dept}</p>
        </div>
        <span class="inline-flex items-center gap-1 rounded-full px-2 py-0.5 text-[0.65rem] ${badge.container} flex-shrink-0">
          <span class="w-1.5 h-1.5 rounded-full ${badge.dot}"></span>
          <span>${riskLevel}</span>
        </span>
      </div>
      
      <div class="grid grid-cols-4 gap-1 text-[0.65rem] text-center">
        <div class="bg-emerald-50 rounded px-1 py-1">
          <div class="font-semibold text-emerald-700">${verbalCount}</div>
          <div class="text-emerald-600">Verbal</div>
        </div>
        <div class="bg-amber-50 rounded px-1 py-1">
          <div class="font-semibold text-amber-700">${writtenCount}</div>
          <div class="text-amber-600">Written</div>
        </div>
        <div class="bg-orange-50 rounded px-1 py-1">
          <div class="font-semibold text-orange-700">${finalCount}</div>
          <div class="text-orange-600">Final</div>
        </div>
        <div class="bg-rose-50 rounded px-1 py-1">
          <div class="font-semibold text-rose-700">${termCount}</div>
          <div class="text-rose-600">Term</div>
        </div>
      </div>
    `;

    container.appendChild(card);
  });
}
    // [REMAINING JAVASCRIPT CODE CONTINUES - handleDisciplineSubmit, PDF functions, filters, event listeners, bootstrap]
    // Due to character limits, I'll note that the rest of the JavaScript continues identically from your original code
    // with all the discipline form handling, PDF generation, and event listeners intact.

   async function handleDisciplineSubmit(event) {
      event.preventDefault();

      const employeeIdInput = document.getElementById("discipline-employee-id");
      const typeSelect = document.getElementById("discipline-action-type");
      const dateInput = document.getElementById("discipline-action-date");
      const severitySelect = document.getElementById("discipline-severity");
      const referenceInput = document.getElementById("discipline-reference");
      const reasonInput = document.getElementById("discipline-reason");
      const planInput = document.getElementById("discipline-plan");
      const managerSignatureInput = document.getElementById("discipline-manager-signature");
      const hrSignatureInput = document.getElementById("discipline-hr-signature");
      const employeeSignatureInput = document.getElementById("discipline-employee-signature");
      const declinedCheckbox = document.getElementById("discipline-employee-declined");

      const statusDiv = document.getElementById("discipline-form-status");
      const submitBtn = document.getElementById("discipline-form-submit");
      const submitText = document.getElementById("discipline-form-submit-text");
      const submitSpinner = document.getElementById("discipline-form-submit-spinner");

      if (!employeeIdInput.value) {
        showToast(
          "Select an employee before recording an action",
          "Use the Quick Employee Selector or Employees 360 to pick the correct person.",
          "warning"
        );
        if (statusDiv) {
          statusDiv.className =
            "rounded-xl border border-amber-200 bg-amber-50/70 text-amber-800 text-[0.70rem] mt-2 px-3 py-2";
          statusDiv.textContent =
            "Please select an employee first. The corrective action must be attached to a specific employees2025 record.";
          statusDiv.classList.remove("hidden");
        }
        return;
      }

      const actionType = typeSelect.value;
      const actionDate = dateInput.value;
      const severity = severitySelect.value;
      const reference = referenceInput.value.trim();
      const reason = reasonInput.value.trim();
      const correctivePlan = planInput.value.trim();
      const managerSig = managerSignatureInput.value.trim();
      const hrSig = hrSignatureInput.value.trim();
      const employeeSig = employeeSignatureInput.value.trim();
      const employeeDeclined = declinedCheckbox.checked;

      if (!actionType || !actionDate || !severity || !reason || !managerSig) {
        showToast(
          "Please complete all required fields",
          "Type of action, date, severity, reason, and manager signature are mandatory.",
          "warning"
        );
        if (statusDiv) {
          statusDiv.className =
            "rounded-xl border border-amber-200 bg-amber-50/70 text-amber-800 text-[0.70rem] mt-2 px-3 py-2";
          statusDiv.textContent =
            "Missing required information. Confirm the action type, date, severity, reason/policy, and manager typed signature.";
          statusDiv.classList.remove("hidden");
        }
        return;
      }

      const employeeId = employeeIdInput.value;
      const existingEmployee = AppState.employees.find(
        (e) => String(e.id) === String(employeeId)
      );

      if (!existingEmployee) {
        showToast(
          "Employee record not found in memory",
          "Reload employees and try again.",
          "error"
        );
        if (statusDiv) {
          statusDiv.className =
            "rounded-xl border border-rose-200 bg-rose-50/80 text-rose-800 text-[0.70rem] mt-2 px-3 py-2";
          statusDiv.textContent =
            "Unable to locate this employee in the current session. Refresh employees and try again.";
          statusDiv.classList.remove("hidden");
        }
        return;
      }

      // Toggle loading state
      if (submitBtn && submitText && submitSpinner) {
        submitBtn.disabled = true;
        submitSpinner.classList.remove("hidden");
        submitText.textContent = "Saving action...";
      }
      if (statusDiv) {
        statusDiv.className =
          "rounded-xl border border-slate-200 bg-slate-50 text-slate-700 text-[0.70rem] mt-2 px-3 py-2";
        statusDiv.textContent = "Recording corrective action and updating employees2025...";
        statusDiv.classList.remove("hidden");
      }

      try {
        const nowIso = new Date().toISOString();

        const newEntry = {
          action_type: actionType,
          action_date: actionDate,
          severity,
          reference,
          internal_reference: reference,
          reason,
          corrective_plan: correctivePlan,
          manager_signature: managerSig,
          hr_signature: hrSig || null,
          employee_signature: employeeDeclined ? null : (employeeSig || null),
          employee_declined: employeeDeclined,
          created_at: nowIso,
          created_by: "HR Admin (Discipline Portal)",
        };

        const history = Array.isArray(existingEmployee.discipline_history)
          ? existingEmployee.discipline_history.slice()
          : [];
        history.push(newEntry);

        let verbalCount = existingEmployee.verbal_warning_count || 0;
        let writtenCount = existingEmployee.disciplinary_warning_count || 0;
        let finalCount = existingEmployee.final_warning_count || 0;
        let termCount = existingEmployee.termination_letter_count || 0;

        switch (actionType) {
          case "VERBAL_WARNING":
            verbalCount += 1;
            break;
          case "WRITTEN_WARNING":
            writtenCount += 1;
            break;
          case "FINAL_WARNING":
            finalCount += 1;
            break;
          case "TERMINATION":
            termCount += 1;
            break;
          default:
            break;
        }

        const { score, level } = computeRiskScoreFromCounts(
          verbalCount,
          writtenCount,
          finalCount,
          termCount
        );

        const lastAction = {
          action_type: actionType,
          action_date: actionDate,
          severity,
          reference,
          reason,
          created_at: nowIso,
        };

        let terminationStatus = existingEmployee.termination_status || null;
        if (actionType === "TERMINATION" && !terminationStatus) {
          terminationStatus = "pending";
        }

        const updatePayload = {
          discipline_history: history,
          verbal_warning_count: verbalCount,
          disciplinary_warning_count: writtenCount,
          final_warning_count: finalCount,
          termination_letter_count: termCount,
          risk_score: score,
          risk_level: level,
          last_disciplinary_action: lastAction,
          termination_status: terminationStatus,
        };

        const { data, error } = await supabaseClient
          .from("employees2025")
          .update(updatePayload)
          .eq("id", employeeId)
          .select()
          .single();

        if (error) {
          console.error("Error updating employee with discipline action:", error);
          showToast(
            "Unable to record corrective action",
            "Supabase update failed. Review console log for details.",
            "error"
          );
          if (statusDiv) {
            statusDiv.className =
              "rounded-xl border border-rose-200 bg-rose-50/80 text-rose-800 text-[0.70rem] mt-2 px-3 py-2";
            statusDiv.textContent =
              "Supabase returned an error while saving this action. The record may not have been updated.";
          }
        } else {
          // Update in-memory employee state
          const idx = AppState.employees.findIndex(
            (e) => String(e.id) === String(employeeId)
          );
          if (idx !== -1) {
            AppState.employees[idx] = data;
          }

          // Refresh UI
          if (AppState.selectedEmployee && String(AppState.selectedEmployee.id) === String(employeeId)) {
            renderEmployeeProfile(data);
            renderDisciplineHistory(data);
          }

          updateDashboardKPIs();
          updateComplianceSnapshot();

          showToast(
            "Corrective action recorded successfully",
            "employees2025 updated and discipline history refreshed. PDF will be generated next.",
            "success"
          );
          if (statusDiv) {
            statusDiv.className =
              "rounded-xl border border-emerald-200 bg-emerald-50/80 text-emerald-800 text-[0.70rem] mt-2 px-3 py-2";
            statusDiv.textContent =
              "Action recorded successfully. A PDF summary has been prepared for printing and signature.";
          }

          // Generate PDF for this specific action
          await generateDisciplinePDF(data, newEntry);

          // Optionally reset form (keep selected employee)
          const form = document.getElementById("discipline-form");
          if (form) {
            form.reset();
            document.getElementById("discipline-employee-id").value = data.id;
          }
        }
      } catch (err) {
        console.error("Unexpected error during discipline submit:", err);
        showToast(
          "Unexpected error while recording action",
          "See browser console for technical details.",
          "error"
        );
        if (statusDiv) {
          statusDiv.className =
            "rounded-xl border border-rose-200 bg-rose-50/80 text-rose-800 text-[0.70rem] mt-2 px-3 py-2";
          statusDiv.textContent =
            "An unexpected error occurred while trying to save this action.";
        }
      } finally {
        if (submitBtn && submitText && submitSpinner) {
          submitBtn.disabled = false;
          submitSpinner.classList.add("hidden");
          submitText.textContent = "Record Action & Generate PDF";
        }
      }
    }


     async function generateDisciplinePDF(employee, actionEntry) {
      try {
        const root = document.getElementById("pdf-generation-root");
        if (!root) return;

        const employeeName =
          (employee.first_name || "") + " " + (employee.last_name || "");
        const dept = employee.department || "Unassigned";
        const title = employee.job_title || employee.position_title || "Role not set";

        const actionDate = formatDate(actionEntry.action_date);
        const createdAt = formatDateTime(actionEntry.created_at);
        const type = (actionEntry.action_type || "").replace(/_/g, " ");
        const severity = actionEntry.severity || "";

        root.innerHTML = `
          <section style="font-family: Inter, system-ui, sans-serif; padding: 24px; max-width: 800px; margin: 0 auto; color: #0f172a;">
            <header style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; border-bottom: 1px solid #e2e8f0; padding-bottom: 8px;">
              <div style="display:flex; align-items:center; gap:12px;">
                <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=1"
                     alt="Jeng Chi Restaurant Logo"
                     style="height:48px; width:auto; border-radius:8px; border:1px solid #e2e8f0; object-fit:contain; background:white;" />
                <div>
                  <h1 style="margin:0; font-size:18px; font-weight:700;">Jeng Chi Restaurant</h1>
                  <p style="margin:2px 0 0; font-size:11px; color:#64748b;">
                    Discipline • Compliance • Corrective Action Management
                  </p>
                </div>
              </div>
              <div style="text-align:right; font-size:11px; color:#64748b;">
                <div>Generated: ${createdAt}</div>
              </div>
            </header>

            <h2 style="margin:16px 0 8px; font-size:16px; font-weight:700; color:#0f172a;">
              Corrective Action Notice
            </h2>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px; background:#f8fafc;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Employee Information</h3>
              <p style="margin:2px 0;"><strong>Name:</strong> ${employeeName || "--"}</p>
              <p style="margin:2px 0;"><strong>Employee ID:</strong> ${employee.employee_id || "--"}</p>
              <p style="margin:2px 0;"><strong>Position / Department:</strong> ${title} • ${dept}</p>
              <p style="margin:2px 0;"><strong>Status:</strong> ${employee.status || employee.employment_status || "--"}</p>
            </section>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Corrective Action Details</h3>
              <p style="margin:2px 0;"><strong>Type of Action:</strong> ${type}</p>
              <p style="margin:2px 0;"><strong>Severity:</strong> ${severity}</p>
              <p style="margin:2px 0;"><strong>Action Date:</strong> ${actionDate}</p>
              <p style="margin:2px 0;"><strong>Reference / Incident ID:</strong> ${actionEntry.reference || "--"}</p>
            </section>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Reason / Policy Violations</h3>
              <p style="margin:2px 0; white-space:pre-wrap;">${actionEntry.reason || "Not provided."}</p>
            </section>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Corrective Action Plan / Notes</h3>
              <p style="margin:2px 0; white-space:pre-wrap;">${actionEntry.corrective_plan || "Not provided."}</p>
            </section>

            <section style="font-size:11px; margin-bottom:16px; border-radius:12px; border:1px solid #e2e8f0; padding:12px; background:#fdf2f2;">
              <p style="margin:0 0 4px;">
                This document is intended to provide written notice of performance or conduct concerns and expectations for future behavior.
                It should be applied consistently, free from discrimination or retaliation, and aligned with Jeng Chi Restaurant policies
                and applicable TWC / DOL guidance.
              </p>
            </section>

            <section style="font-size:11px; margin-bottom:8px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Signatures</h3>
              <table style="width:100%; border-collapse:collapse; margin-top:4px; font-size:11px;">
                <tbody>
                  <tr>
                    <td style="padding:6px 4px; border-top:1px solid #e2e8f0; width:50%;">
                      <strong>Manager:</strong> ${actionEntry.manager_signature || "--"}
                    </td>
                    <td style="padding:6px 4px; border-top:1px solid #e2e8f0; width:50%;">
                      <strong>HR Representative:</strong> ${actionEntry.hr_signature || "--"}
                    </td>
                  </tr>
                  <tr>
                    <td style="padding:6px 4px; border-top:1px solid #e2e8f0;">
                      <strong>Employee:</strong>
                      ${
                        actionEntry.employee_declined
                          ? "Declined to sign (acknowledgment only)"
                          : (actionEntry.employee_signature || "--")
                      }
                    </td>
                    <td style="padding:6px 4px; border-top:1px solid #e2e8f0;">
                      <strong>Date Provided to Employee:</strong> ${actionDate}
                    </td>
                  </tr>
                </tbody>
              </table>
            </section>
          </section>
        `;

        const opt = {
          margin: 0.5,
          filename:
            "JCR_Discipline_" +
            (employee.employee_id || employee.id || "employee") +
            "_" +
            (actionEntry.action_type || "ACTION") +
            ".pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };

        await html2pdf().set(opt).from(root).save();
      } catch (err) {
        console.error("Error generating discipline PDF:", err);
        showToast(
          "PDF generation encountered an issue",
          "The action was saved, but PDF export may have failed.",
          "warning"
        );
      }
    }

    async function exportTimelinePDF() {
      const selected = AppState.selectedEmployee;
      if (!selected) {
        showToast(
          "Select an employee to export timeline",
          "Pick an employee in Employees 360 or the Discipline tab first.",
          "warning"
        );
        return;
      }

      try {
        const root = document.getElementById("pdf-generation-root");
        const timeline = document.getElementById("discipline-history-timeline");
        if (!root || !timeline) return;

        const clone = timeline.cloneNode(true);
        // Simple wrapper
        root.innerHTML = `
          <section style="font-family: Inter, system-ui, sans-serif; padding: 24px; max-width: 800px; margin:0 auto; color:#0f172a;">
            <h1 style="margin:0 0 8px; font-size:18px; font-weight:700;">Discipline Audit Timeline</h1>
            <p style="margin:0 0 12px; font-size:11px; color:#64748b;">
              Employee: ${(selected.first_name || "") + " " + (selected.last_name || "")} • ID: ${selected.employee_id || "--"}
            </p>
            <div>${clone.innerHTML}</div>
          </section>
        `;

        const opt = {
          margin: 0.5,
          filename:
            "JCR_Discipline_Timeline_" +
            (selected.employee_id || selected.id || "employee") +
            ".pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };

        await html2pdf().set(opt).from(root).save();
      } catch (err) {
        console.error("Error exporting timeline PDF:", err);
        showToast(
          "Unable to export timeline PDF",
          "The view may still be exported by printing to PDF from the browser.",
          "error"
        );
      }
    }

    async function generateEmployeeSummaryPDF() {
      const selected = AppState.selectedEmployee;
      if (!selected) {
        showToast(
          "Select an employee to download 360 PDF",
          "Choose an employee in Employees 360 first.",
          "warning"
        );
        return;
      }

      try {
        const root = document.getElementById("pdf-generation-root");
        if (!root) return;

        const summary = document.getElementById("employee-summary-history");
        const summaryText = summary ? summary.textContent : "";

        const fullName = (selected.first_name || "") + " " + (selected.last_name || "");
        const dept = selected.department || "Unassigned";
        const title = selected.job_title || selected.position_title || "Role not set";

        const { score, level } = computeRiskScoreFromCounts(
          selected.verbal_warning_count || 0,
          selected.disciplinary_warning_count || 0,
          selected.final_warning_count || 0,
          selected.termination_letter_count || 0
        );

        root.innerHTML = `
          <section style="font-family: Inter, system-ui, sans-serif; padding: 24px; max-width: 800px; margin: 0 auto; color:#0f172a;">
            <header style="display:flex; align-items:center; justify-content:space-between; margin-bottom:16px; border-bottom:1px solid #e2e8f0; padding-bottom:8px;">
              <div>
                <h1 style="margin:0; font-size:18px; font-weight:700;">Employee Discipline 360 Summary</h1>
                <p style="margin:2px 0 0; font-size:11px; color:#64748b;">Jeng Chi Restaurant • Discipline • Compliance • Corrective Action Management</p>
              </div>
              <div style="font-size:11px; color:#64748b; text-align:right;">
                Generated: ${formatDateTime(new Date().toISOString())}
              </div>
            </header>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px; background:#f8fafc;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Employee Profile</h3>
              <p style="margin:2px 0;"><strong>Name:</strong> ${fullName || "--"}</p>
              <p style="margin:2px 0;"><strong>Employee ID:</strong> ${selected.employee_id || "--"}</p>
              <p style="margin:2px 0;"><strong>Position / Department:</strong> ${title} • ${dept}</p>
              <p style="margin:2px 0;"><strong>Status:</strong> ${selected.status || selected.employment_status || "Active"}</p>
              <p style="margin:2px 0;"><strong>Hire Date:</strong> ${formatDate(selected.hire_date || selected.original_hire_date)}</p>
              <p style="margin:2px 0;"><strong>Tenure:</strong> ${calculateTenure(selected.hire_date || selected.original_hire_date)}</p>
            </section>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Discipline KPIs</h3>
              <ul style="margin:0; padding-left:16px;">
                <li>Verbal warnings: ${selected.verbal_warning_count || 0}</li>
                <li>Written warnings: ${selected.disciplinary_warning_count || 0}</li>
                <li>Final warnings: ${selected.final_warning_count || 0}</li>
                <li>Termination letters: ${selected.termination_letter_count || 0}</li>
              </ul>
              <p style="margin:6px 0 0;"><strong>Risk Score:</strong> ${score.toFixed(1)} • ${level}</p>
            </section>

            <section style="font-size:12px; margin-bottom:12px; border-radius:12px; border:1px solid #e2e8f0; padding:12px;">
              <h3 style="margin:0 0 6px; font-size:13px; font-weight:600;">Narrative Summary</h3>
              <p style="margin:2px 0; white-space:pre-wrap;">${summaryText || "A narrative summary will appear here once generated in the portal."}</p>
            </section>
          </section>
        `;

        const opt = {
          margin: 0.5,
          filename:
            "JCR_Employee_Discipline_360_" +
            (selected.employee_id || selected.id || "employee") +
            ".pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };

        await html2pdf().set(opt).from(root).save();
      } catch (err) {
        console.error("Error generating 360 employee PDF:", err);
        showToast(
          "Error generating 360 PDF",
          "The on-screen summary is still available.",
          "error"
        );
      }
    }

    async function generateReportsSummaryPDF() {
      const panel = document.getElementById("reports-summary-panel");
      if (!panel) {
        showToast(
          "Reports summary section not found",
          "Ensure the Reports & Analytics tab is present.",
          "error"
        );
        return;
      }

      try {
        const root = document.getElementById("pdf-generation-root");
        if (!root) return;

        const content = document.getElementById("reports-summary-content");
        const htmlContent = content ? content.innerHTML : "";

        root.innerHTML = `
          <section style="font-family: Inter, system-ui, sans-serif; padding: 24px; max-width: 800px; margin: 0 auto; color:#0f172a;">
            <h1 style="margin:0 0 8px; font-size:18px; font-weight:700;">Discipline Executive Summary</h1>
            <p style="margin:0 0 12px; font-size:11px; color:#64748b;">
              High-level discipline metrics and governance commentary derived from employees2025.
            </p>
            <div style="font-size:12px;">${htmlContent}</div>
          </section>
        `;

        const opt = {
          margin: 0.5,
          filename: "JCR_Discipline_Executive_Summary.pdf",
          image: { type: "jpeg", quality: 0.98 },
          html2canvas: { scale: 2, useCORS: true },
          jsPDF: { unit: "in", format: "letter", orientation: "portrait" },
        };

        await html2pdf().set(opt).from(root).save();
      } catch (err) {
        console.error("Error generating reports summary PDF:", err);
        showToast(
          "Unable to generate summary PDF",
          "Try again or use browser print to PDF.",
          "error"
        );
      }
    }

    // ------------------------------------------------------------
    // Reports: Build Executive Summary Text
    // ------------------------------------------------------------
    function buildReportsSummary() {
      const container = document.getElementById("reports-summary-content");
      if (!container) return;

      const totalEmployees = AppState.employees.length;
      const activeEmployees = AppState.employees.filter(
        (e) => (e.status || e.employment_status || "Active") === "Active"
      ).length;
      const highRiskEmployees = AppState.employees.filter(
        (e) => (e.risk_level || "").toUpperCase() === "HIGH"
      ).length;

      const withHistory = AppState.employees.filter(
        (e) => Array.isArray(e.discipline_history) && e.discipline_history.length
      ).length;

      const openTerminations = AppState.employees.filter(
        (e) => (e.termination_status || "").toLowerCase() === "pending"
      ).length;

      const completedTerminations = AppState.employees.filter(
        (e) => (e.termination_status || "").toLowerCase() === "completed"
      ).length;

      container.innerHTML = `
        <p>
          This summary reflects discipline and corrective action activity captured in the
          <strong>employees2025</strong> table for Jeng Chi Restaurant. The current dataset
          includes <strong>${totalEmployees}</strong> total employee records, of which
          <strong>${activeEmployees}</strong> are marked as active.
        </p>
        <p>
          A total of <strong>${withHistory}</strong> employees have at least one recorded
          disciplinary action on file. High-risk flags (based on the JCR discipline scoring
          model) are currently applied to <strong>${highRiskEmployees}</strong> employees,
          indicating a concentration of repeated or severe issues that may require additional
          coaching, oversight, or staffing decisions.
        </p>
        <p>
          Termination activity shows <strong>${openTerminations}</strong> open termination
          cases and <strong>${completedTerminations}</strong> completed terminations documented
          in the system. All cases should be reviewed to ensure documentation is thorough,
          fact-based, and consistent with JCR policies and TWC / DOL guidance.
        </p>
        <p>
          Leadership and HR should periodically review these metrics to confirm that discipline
          is being applied consistently across departments and roles, and that early coaching
          and corrective feedback are used wherever possible to support retention and performance
          improvement.
        </p>
      `;
    }

    // ------------------------------------------------------------
    // Filters & Search Helpers
    // ------------------------------------------------------------
    function applyEmployeeFilters() {
      const searchInput = document.getElementById("employees-search-input");
      const term = searchInput ? searchInput.value : "";
      const list = filterEmployeesByKeywordAndStatus(term, AppState.employeeFilterStatus);
      renderEmployeeList(list);
    }

    // ------------------------------------------------------------
    // Event Listeners
    // ------------------------------------------------------------
    function attachEventListeners() {
      // Toast close
      const toastClose = document.getElementById("global-toast-close");
      if (toastClose) {
        toastClose.addEventListener("click", hideToast);
      }

      // Tabs (desktop)
      const tabButtons = document.querySelectorAll(".tab-trigger");
      tabButtons.forEach((btn) => {
        btn.addEventListener("click", () => {
          const target = btn.getAttribute("data-tab-target");
          if (target) switchTab(target);
        });
      });

      // Mobile tab select
      const mobileSelect = document.getElementById("mobile-tab-select");
      if (mobileSelect) {
        mobileSelect.addEventListener("change", (e) => {
          switchTab(e.target.value);
        });
      }

      // Discipline form
      const disciplineForm = document.getElementById("discipline-form");
      if (disciplineForm) {
        disciplineForm.addEventListener("submit", handleDisciplineSubmit);
      }

      const disciplineReset = document.getElementById("discipline-form-reset");
      if (disciplineReset) {
        disciplineReset.addEventListener("click", () => {
          const form = document.getElementById("discipline-form");
          if (form) form.reset();
          const statusDiv = document.getElementById("discipline-form-status");
          if (statusDiv) statusDiv.classList.add("hidden");
        });
      }

      // Employees search
      const employeesSearchBtn = document.getElementById("employees-search-button");
      const employeesSearchInput = document.getElementById("employees-search-input");

      if (employeesSearchBtn) {
        employeesSearchBtn.addEventListener("click", applyEmployeeFilters);
      }
      if (employeesSearchInput) {
        employeesSearchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            applyEmployeeFilters();
          }
        });
      }

      // Employee filter chips
      const filterChips = document.querySelectorAll(".employee-filter-chip");
      filterChips.forEach((chip) => {
        chip.addEventListener("click", () => {
          filterChips.forEach((c) =>
            c.classList.remove("border-brand-100", "bg-brand-50", "text-brand-700")
          );
          chip.classList.add("border-brand-100", "bg-brand-50", "text-brand-700");
          AppState.employeeFilterStatus = chip.getAttribute("data-employee-filter") || "all";
          applyEmployeeFilters();
        });
      });

      // Refresh employees (Employees tab)
      const employeesRefreshBtn = document.getElementById("employees-refresh-button");
      if (employeesRefreshBtn) {
        employeesRefreshBtn.addEventListener("click", fetchEmployees);
      }

      // Quick Employee Selector (Discipline tab)
      const discSearchBtn = document.getElementById("discipline-employee-search-button");
      const discSearchInput = document.getElementById("discipline-employee-search");
      const discRefresh = document.getElementById("discipline-refresh-employees");

      function runDisciplineSearch() {
        const term = discSearchInput ? discSearchInput.value : "";
        const list = filterEmployeesByKeywordAndStatus(term, "all");
        renderDisciplineEmployeeResults(list);
      }

      if (discSearchBtn) {
        discSearchBtn.addEventListener("click", runDisciplineSearch);
      }
      if (discSearchInput) {
        discSearchInput.addEventListener("keydown", (e) => {
          if (e.key === "Enter") {
            e.preventDefault();
            runDisciplineSearch();
          }
        });
      }
      if (discRefresh) {
        discRefresh.addEventListener("click", () => {
          if (!AppState.employees.length) {
            fetchEmployees().then(runDisciplineSearch);
          } else {
            runDisciplineSearch();
          }
        });
      }

      // Employee 360 PDF
      const employeeSummaryBtn = document.getElementById("employee-summary-pdf");
      if (employeeSummaryBtn) {
        employeeSummaryBtn.addEventListener("click", generateEmployeeSummaryPDF);
      }

      // Discipline timeline export
      const disciplineAuditExport = document.getElementById("discipline-audit-export");
      if (disciplineAuditExport) {
        disciplineAuditExport.addEventListener("click", exportTimelinePDF);
      }

      // Reports summary generation
      const reportsGenerateBtn = document.getElementById("reports-generate-summary");
      if (reportsGenerateBtn) {
        reportsGenerateBtn.addEventListener("click", () => {
          buildReportsSummary();
          showToast(
            "Reports summary assembled",
            "The executive narrative has been generated from current employees2025 metrics.",
            "success"
          );
        });
      }

      const reportsSummaryPdfBtn = document.getElementById("reports-generate-summary-pdf");
      if (reportsSummaryPdfBtn) {
        reportsSummaryPdfBtn.addEventListener("click", generateReportsSummaryPDF);
      }

      // Admin toggles
      const adminToggles = document.querySelectorAll(".admin-toggle");
      adminToggles.forEach((toggle) => {
        toggle.addEventListener("click", () => {
          const pressed = toggle.getAttribute("aria-pressed") === "true";
          const nowPressed = !pressed;
          toggle.setAttribute("aria-pressed", nowPressed ? "true" : "false");

          const knob = toggle.querySelector("span.inline-flex");
          if (knob) {
            knob.style.transform = nowPressed ? "translateX(100%)" : "translateX(0)";
          }

          const key = toggle.getAttribute("data-admin-toggle");
          if (key === "email") {
            AppState.adminSettings.emailNotificationsEnabled = nowPressed;
          } else if (key === "lock-cases") {
            AppState.adminSettings.lockCasesAfterSignature = nowPressed;
          }

          showToast(
            "Admin setting updated",
            "This change is currently front-end only and documents future workflow design.",
            "success"
          );
        });
      });

      // Policy filter chips (show/hide groups)
      const policyFilterChips = document.querySelectorAll(".policy-filter-chip");
      const policyPanels = document.querySelectorAll("[data-policy-category-panel]");

      policyFilterChips.forEach((chip) => {
        chip.addEventListener("click", () => {
          const cat = chip.getAttribute("data-policy-category");

          policyFilterChips.forEach((c) =>
            c.classList.remove("bg-brand-50", "border-brand-100", "text-brand-700")
          );
          chip.classList.add("bg-brand-50", "border-brand-100", "text-brand-700");

          policyPanels.forEach((panel) => {
            const panelCat = panel.getAttribute("data-policy-category-panel");
            if (panelCat === cat) {
              panel.classList.remove("hidden");
            } else {
              panel.classList.add("hidden");
            }
          });
        });
      });

      // Policy accordion headers
      const policyHeaders = document.querySelectorAll(".policy-accordion-header");
      policyHeaders.forEach((header) => {
        header.addEventListener("click", () => {
          const body = header.parentElement.querySelector(".policy-accordion-body");
          const toggleBtn = header.parentElement.querySelector(".policy-accordion-toggle i");
          if (!body) return;
          const isHidden = body.classList.contains("hidden");
          if (isHidden) {
            body.classList.remove("hidden");
            if (toggleBtn) {
              toggleBtn.classList.remove("fa-chevron-down");
              toggleBtn.classList.add("fa-chevron-up");
            }
          } else {
            body.classList.add("hidden");
            if (toggleBtn) {
              toggleBtn.classList.remove("fa-chevron-up");
              toggleBtn.classList.add("fa-chevron-down");
            }
          }
        });
      });
    }

    // ------------------------------------------------------------
    // Bootstrap
    // ------------------------------------------------------------
    async function bootstrap() {
      attachEventListeners();
      switchTab("dashboard");
      await fetchEmployees();
    }

    document.addEventListener("DOMContentLoaded", bootstrap);
// ------------------------------------------------------------
// Simple Reports Summary content generator (optional but useful)
// ------------------------------------------------------------
function generateReportsSummary() {
  const summaryContent = document.getElementById("reports-summary-content");
  if (!summaryContent) return;

  const totalEmployees = AppState.employees.length;
  const highRisk = AppState.employees.filter(
    (e) => (e.risk_level || "").toUpperCase() === "HIGH"
  ).length;
  const withWarnings = AppState.employees.filter((e) => {
    const v = e.verbal_warning_count || 0;
    const w = e.disciplinary_warning_count || 0;
    const f = e.final_warning_count || 0;
    const t = e.termination_letter_count || 0;
    return v + w + f + t > 0;
  }).length;

  summaryContent.innerHTML = `
    <p>As of ${formatDateTime(new Date().toISOString())}, Jeng Chi Restaurant has
      <strong>${totalEmployees}</strong> employees in the discipline dataset.</p>
    <p><strong>${withWarnings}</strong> employees have at least one recorded disciplinary action,
      and <strong>${highRisk}</strong> employees are currently flagged as <span style="color:#b91c1c; font-weight:600;">HIGH</span> risk.</p>
    <p>This summary is generated from the employees2025 table, using the current risk scoring model
      displayed in the Admin & Settings tab.</p>
  `;
}

// ------------------------------------------------------------
// Bootstrap / Event Listeners
// ------------------------------------------------------------
function initTabs() {
  const triggers = document.querySelectorAll(".tab-trigger");
  triggers.forEach((btn) => {
    btn.addEventListener("click", () => {
      const target = btn.getAttribute("data-tab-target");
      if (target) switchTab(target);
    });
  });

  const mobileSelect = document.getElementById("mobile-tab-select");
  if (mobileSelect) {
    mobileSelect.addEventListener("change", (e) => {
      switchTab(e.target.value);
    });
  }

  // Default tab
  switchTab("dashboard");
}

function initEventHandlers() {
  // Toast close
  const toastClose = document.getElementById("global-toast-close");
  if (toastClose) {
    toastClose.addEventListener("click", hideToast);
  }

  // Discipline form submit
  const disciplineForm = document.getElementById("discipline-form");
  if (disciplineForm) {
    disciplineForm.addEventListener("submit", handleDisciplineSubmit);
  }

  // Timeline PDF
  const timelineExportBtn = document.getElementById("discipline-audit-export");
  if (timelineExportBtn) {
    timelineExportBtn.addEventListener("click", exportTimelinePDF);
  }

  // Employee 360 PDF
  const employeeSummaryBtn = document.getElementById("employee-summary-pdf");
  if (employeeSummaryBtn) {
    employeeSummaryBtn.addEventListener("click", generateEmployeeSummaryPDF);
  }

  // Reports summary text
  const reportsSummaryBtn = document.getElementById("reports-generate-summary");
  if (reportsSummaryBtn) {
    reportsSummaryBtn.addEventListener("click", generateReportsSummary);
  }

  // Reports summary PDF
  const reportsSummaryPdfBtn = document.getElementById("reports-generate-summary-pdf");
  if (reportsSummaryPdfBtn) {
    reportsSummaryPdfBtn.addEventListener("click", generateReportsSummaryPDF);
  }
}

async function bootstrap() {
  initTabs();
  initEventHandlers();

  // Load employees and hydrate dashboard / reports / 360 views
  await fetchEmployees();
}

// Start once DOM is ready
document.addEventListener("DOMContentLoaded", bootstrap);




  </script>
</body>
</html>


