<!-- FIXED FILE â€“ PART 1/5: DOCTYPE, HEAD, HEADER, NAVIGATION -->
<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi HR Discipline â€¢ Compliance â€¢ Corrective Action Management</title>

  <!-- Google Fonts: Inter + Poppins -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet" />

  <!-- Tailwind Configuration (must come before CDN script) -->
  <script>
    window.tailwind = window.tailwind || {};
    window.tailwind.config = {
      corePlugins: {
        container: false,
      },
      theme: {
        extend: {
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
            heading: ['Poppins', 'Inter', 'system-ui', 'sans-serif'],
          },
          fontSize: {
            'xs': ['0.96rem', { lineHeight: '1.5' }],
            'sm': ['1.12rem', { lineHeight: '1.5' }],
            'base': ['1.28rem', { lineHeight: '1.6' }],
            'lg': ['1.44rem', { lineHeight: '1.6' }],
            'xl': ['1.6rem', { lineHeight: '1.6' }],
            '2xl': ['1.92rem', { lineHeight: '1.4' }],
            '3xl': ['2.4rem', { lineHeight: '1.3' }],
          },
          colors: {
            brand: {
              50: '#f1f8ff',
              100: '#e0f0ff',
              200: '#b9ddff',
              300: '#80c3ff',
              400: '#4aa7f5',
              500: '#1d8fe3',
              600: '#136fbc',
              700: '#0b5694',
              800: '#083b66',
              900: '#062847',
            },
          },
          boxShadow: {
            subtle: '0 10px 25px rgba(15, 23, 42, 0.06)',
          },
        },
      },
    };
  </script>

  

<!-- Tailwind CSS CDN -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Supabase JS v2 UMD -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.49.1/dist/umd/supabase.js"></script>

<!-- html2pdf.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.9.3/html2pdf.bundle.min.js"></script>
  
<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>







<!-- âœ… Font Awesome 6.6.0 (ONLY ONE LINK) -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css">


<!-- Chart.js Data Labels Plugin -->
<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>








  <!-- Custom CSS -->
  <style>




    #comp-letter-preview-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(14, 165, 233, 0.25);
      border-color: #0284c7;
      background: linear-gradient(135deg, #bae6fd 0%, #7dd3fc 100%);
    }

    #comp-letter-save-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(16, 185, 129, 0.25);
      border-color: #059669;
      background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
    }

    #comp-letter-preview-btn:active,
    #comp-letter-save-btn:active {
      transform: translateY(0px);
    }





  /* ===== SCROLLBAR STYLES ===== */
  ::-webkit-scrollbar {
    width: 8px;
    height: 8px;
  }
  ::-webkit-scrollbar-track {
    background: #f1f5f9;
  }
  ::-webkit-scrollbar-thumb {
    background: #cbd5e1;
    border-radius: 9999px;
  }
  ::-webkit-scrollbar-thumb:hover {
    background: #a5b4fc;
  }

  /* ===== MAKE ALL IMPORTANT TEXT BOLD ===== */
  
  /* Navigation tabs */
  .tab-trigger span,
  nav button span,
  nav a span {
    font-weight: 700 !important;
  }

  /* All uppercase labels (KPIs, section headers) */
  .uppercase,
  .uppercase.tracking-wide {
    font-weight: 700 !important;
  }

  /* Table headers */
  th,
  thead th,
  thead tr th {
    font-weight: 700 !important;
    color: #475569 !important;
  }

  /* Section titles and subtitles */
  h1, h2, h3, h4, h5, h6 {
    font-weight: 700 !important;
  }

  /* Subtitle text and descriptions */
  p.text-xs.text-slate-500,
  p.text-sm.text-slate-500 {
    font-weight: 600 !important;
  }

  /* Form labels */
  label {
    font-weight: 700 !important;
  }

  /* Filter chips and buttons */
  .policy-filter-chip,
  .employee-filter-chip,
  button[data-policy-category],
  button[data-employee-filter] {
    font-weight: 700 !important;
  }

  /* All button text */
  button {
    font-weight: 700 !important;
  }

  /* Badge and chip text */
  .rounded-full {
    font-weight: 700 !important;
  }

  /* Card titles */
  .font-heading {
    font-weight: 700 !important;
  }

  /* KPI values */
  .text-2xl,
  .text-xl,
  .text-lg {
    font-weight: 700 !important;
  }

  /* Table cell labels in Permission matrix */
  td {
    font-weight: 600 !important;
  }

  /* Specific for "Feature / Tab" and similar headers */
  .font-bold,
  [class*="font-bold"] {
    font-weight: 700 !important;
  }

  /* Make all span elements inside headers bold */
  h1 span, h2 span, h3 span, h4 span, h5 span, h6 span {
    font-weight: 700 !important;
  }

  /* Policy library button text */
  .inline-flex.items-center.gap-1,
  .inline-flex.items-center.gap-2 {
    font-weight: 700 !important;
  }

  /* Section descriptions that appear under titles */
  .text-xs.text-slate-500.mt-1,
  .text-xs.text-slate-600 {
    font-weight: 600 !important;
  }

  /* ===== TIMELINE STYLES ===== */
  .timeline-line {
    position: absolute;
    left: 1.25rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: linear-gradient(to bottom, #bfdbfe, #1d8fe3);
    opacity: 0.75;
  }

  /* ===== PRINT STYLES ===== */
  @media print {
    .no-print {
      display: none !important;
    }
  }



/* Responsive header adjustments */
@media (max-width: 768px) {
  header h1 span {
    font-size: 0.75rem !important;
    line-height: 1.2;
  }
  
  header h1 i {
    font-size: 0.75rem !important;
  }
  
  header p {
    font-size: 0.65rem !important;
  }
}

@media (min-width: 769px) and (max-width: 1024px) {
  header h1 span {
    font-size: 0.9rem !important;
  }
}

/* Ensure navigation wraps properly on smaller screens */
@media (max-width: 1280px) {
  nav.flex {
    flex-wrap: wrap;
  }
}
/* Professional Tab Hover Effects */
.tab-trigger {
  transition: all 0.2s ease-in-out;
}

.tab-trigger:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

.tab-trigger.active {
  background: linear-gradient(135deg, #7a1f1f 0%, #991b1b 100%);
  border-color: #7a1f1f;
  box-shadow: 0 4px 12px rgba(122, 31, 31, 0.3);
}

/* Professional Font Stack */
body {
  font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', system-ui, sans-serif;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

/* Enhanced Header Shadow */
header {
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
}

/* Professional HR Badge Pulse Effect */
@keyframes subtle-pulse {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(122, 31, 31, 0.4);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(122, 31, 31, 0);
  }
}

header .rounded-full:hover {
  animation: subtle-pulse 2s infinite;
}


/* ğŸ” TEMPORARY DEBUG BORDERS */
.dashboard-grid-cell {
  border: 2px solid red !important;
  min-height: 300px;
}



</style>
</head>

<body class="h-full bg-slate-50 text-slate-900 font-sans" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">

  <!-- Root App Container -->
  <div id="app-root" class="min-h-screen flex flex-col" style="max-width: 100vw !important; width: 100vw !important; margin: 0 !important; padding: 0 !important;">
  <!-- Top Navigation / Header -->


<!-- PROFESSIONAL ENTERPRISE HEADER - UPGRADED VERSION -->

<header class="no-print bg-white shadow-lg border-b-2 border-slate-200">
  <div class="w-full px-4 md:px-6 lg:px-8" style="max-width: 100% !important;">

    <!-- Top Row: Logo â€¢ Title â€¢ User Badge -->
    <div class="grid grid-cols-[auto_1fr_auto] items-center justify-items-start gap-4 md:gap-6 lg:gap-8 py-4 md:py-5">
      
      <!-- LEFT: Logo -->
      <div class="flex items-center justify-start">
    <!-- âœ… Logo: No border, no shadow -->
<img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
     alt="Jeng Chi Restaurant Logo"
     class="h-20 md:h-24 lg:h-28 w-auto rounded-xl object-contain">
      </div>

   <!-- CENTER: Title + Subtitle (TRUE CENTER) -->
<div class="flex flex-col items-center justify-center text-center gap-2 pl-4 pr-2">
  <h1 class="flex items-center justify-center gap-3 font-heading text-base sm:text-lg md:text-xl lg:text-2xl tracking-tight text-slate-900 font-black">
    <i class="fa-solid fa-shield-halved text-brand-600 text-lg md:text-xl lg:text-3xl drop-shadow-sm"></i>
    <span class="whitespace-nowrap">Discipline â€¢ Compliance â€¢ Corrective Action Management</span>
  </h1>
        
        <!-- Subtitle with Building Icon -->
        <p class="flex items-center justify-center gap-2 text-xs sm:text-sm md:text-base text-slate-700 font-semibold">
    <i class="fa-solid fa-building text-brand-500 text-xs md:text-sm"></i>
    <span class="hidden sm:inline">Jeng Chi Restaurant â€” Internal HR Discipline, Compliance, and Risk Governance Portal</span>
    <span class="sm:hidden">Jeng Chi Restaurant â€” HR Portal</span>
  </p>
</div>

      </div>
    </div>

    <!-- Desktop Navigation Tabs - PROFESSIONAL VERSION -->

    <div class="no-print hidden md:flex items-center justify-center py-3 border-t border-slate-200 relative">
      <!-- Centered Navigation -->
      <nav class="flex items-center gap-2 lg:gap-3 text-sm font-bold" aria-label="Primary navigation">
       
       
 <!-- âœ… Modern Tab Buttons â€” No Red, No Dark, Fully Visible -->
<nav class="flex flex-wrap items-center gap-2 lg:gap-3 text-sm font-semibold" aria-label="Primary navigation">
  <!-- Dashboard Tab -->
  <button data-tab-target="dashboard" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-chart-line text-base"></i>
    <span>Dashboard</span>
  </button>

        
        <!-- Discipline Cases Tab -->
  <button data-tab-target="discipline" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-gavel text-base"></i>
    <span>Discipline Cases</span>
  </button>

  <!-- Employees 360 Tab -->
  <button data-tab-target="employees" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-users text-base"></i>
    <span>Employees 360</span>
  </button>

  <!-- Employees Grid Tab -->
  <button data-tab-target="employees-grid" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-table-list text-base"></i>
    <span>Employees Grid</span>
  </button>

  <!-- Policy Library Tab -->
  <button data-tab-target="policy" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-scale-balanced text-base"></i>
    <span>Policy Library</span>
  </button>



  <!-- Admin & Settings Tab -->
  <button data-tab-target="admin" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-gear text-base"></i>
    <span>Admin & Settings</span>
  </button>


<!-- Hourly Compensation Letter Tab -->
<button data-tab-target="compensation-letter" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
  <i class="fa-solid fa-file-invoice-dollar text-base"></i>
  <span>Compensation Letter</span>
</button>







  <!-- Permissions Tab -->
  <button data-tab-target="permissions" class="tab-trigger flex items-center gap-2 px-4 py-2.5 rounded-lg border-2 transition-all duration-200 hover:bg-blue-25 hover:-translate-y-0.5 focus:outline-none focus:ring-2 focus:ring-blue-200">
    <i class="fa-solid fa-shield-halved text-base"></i>
    <span>Permissions</span>
  </button>
</nav>






      <!-- Timestamp - Professional Badge Style -->
      <!-- âœ… Fixed: Timestamp inside right container, no overlap -->
      <!-- âœ… Keep this: Right-side HR badge + Timestamp -->
<div class="flex items-center gap-3">
  <!-- HR Badge (next step) -->
  <div class="flex items-center justify-center rounded-full bg-white text-slate-900 w-12 h-12 font-heading text-lg font-black border-2 border-slate-300">
    HR
  </div>
  <!-- Timestamp -->
  <div class="hidden lg:flex items-center gap-2 bg-slate-100 border border-slate-300 rounded-lg px-3 py-1 text-xs font-bold text-slate-700">
    <i class="fa-regular fa-clock text-brand-600"></i>
    <span>Last refreshed:</span>
    <span id="header-last-refreshed" class="text-brand-700">--</span>
  </div>
</div>




    <!-- Mobile Navigation Tabs -->
    <div class="no-print md:hidden border-t border-slate-200 py-3">
      <div class="flex items-center justify-between gap-2">
        <label for="mobile-tab-select" class="text-xs font-black text-slate-700 uppercase tracking-wide">
          <i class="fa-solid fa-bars mr-1"></i>
          Navigate
        </label>
        <select
          id="mobile-tab-select"
          class="flex-1 text-xs font-bold rounded-lg border-2 border-slate-300 bg-white px-3 py-2 focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
        >
          <option value="dashboard">ğŸ“Š Dashboard</option>
          <option value="discipline">âš–ï¸ Discipline Cases</option>
          <option value="employees">ğŸ‘¥ Employees 360</option>
          <option value="policy">ğŸ“‹ Policy Library</option>
          <option value="compensation-letter">ğŸ’µ Compensation Letter</option>
          <option value="admin">âš™ï¸ Admin &amp; Settings</option>
          <option value="permissions">ğŸ›¡ï¸ Permissions</option>
        </select>
      </div>
    </div>
  </div>
</header>



 <!-- Toast Notification Container - REQUIRED FOR showToast() -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

    <!-- Toast / Status Banner -->
    <!-- Toast / Status Banner -->
    <div
      id="global-toast"
      class="no-print fixed z-40 inset-x-0 top-0 flex justify-center pointer-events-none opacity-0 transition-opacity duration-300"
      aria-live="polite"
    >
      <div
        id="global-toast-inner"
        class="mt-20 max-w-xl w-full mx-4 flex items-start gap-3 rounded-2xl border border-emerald-100 bg-white shadow-subtle px-4 py-3 text-sm text-emerald-800 pointer-events-auto"
      >
        <div class="mt-0.5">
          <i class="fa-solid fa-circle-check"></i>
        </div>
        <div class="flex-1 min-w-0">
          <p id="global-toast-message" class="font-medium truncate">
            Action saved successfully.
          </p>
          <p id="global-toast-subtext" class="text-xs text-emerald-700 mt-0.5">
            Employee record updated in employees2025 and risk scoring recalculated.
          </p>
        </div>
        <button
          type="button"
          id="global-toast-close"
          class="ml-2 text-xs text-emerald-600 hover:text-emerald-800"
        >
          Close
        </button>
      </div>
    </div>








   <!-- Main Content -->


   
<main class="flex-1 w-full px-4 sm:px-6 lg:px-8 py-6 space-y-8">




<!-- âœ… DASHBOARD TAB â€” CORPORATE, CONSOLIDATED, CHART-ENABLED -->
<section id="tab-dashboard" class="tab-panel hidden space-y-6">

  <!-- ğŸ“Š GLOBAL FILTER BAR -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
    <div class="flex items-center gap-4">
      <label class="text-xs font-medium text-slate-500 uppercase tracking-wide">Time Range:</label>
      <select id="global-date-filter" class="rounded-lg border border-slate-300 px-3 py-1.5 text-sm font-medium">
        <option value="all-time">All Time</option>
        <option value="last-30">Last 30 Days</option>
        <option value="last-60">Last 60 Days</option>
        <option value="last-90">Last 90 Days</option>
        <option value="ytd">Year to Date</option>
        <option value="custom">Custom Range...</option>
      </select>
      <div id="custom-date-range" class="hidden flex items-center gap-2">
        <input type="date" id="custom-start-date" class="rounded border border-slate-300 px-2 py-1 text-sm">
        <span class="text-slate-500">to</span>
        <input type="date" id="custom-end-date" class="rounded border border-slate-300 px-2 py-1 text-sm">
      </div>
    </div>
    <button id="dashboard-refresh" class="inline-flex items-center gap-2 rounded-lg bg-brand-500 text-white px-4 py-2 text-sm font-bold hover:bg-brand-600 transition">
      <i class="fa-solid fa-rotate-right"></i> Refresh Data
    </button>
  </div>

  <!-- ğŸ”¢ KPI CARDS ROW -->
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-6 gap-4">
    <!-- Active -->
    <div class="bg-white rounded-lg border border-emerald-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-emerald-700 uppercase tracking-wide">Active</p>
          <p id="kpi-active-employees" class="mt-1 font-heading text-2xl font-bold text-emerald-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-emerald-100 flex items-center justify-center">
          <i class="fa-solid fa-user-check text-emerald-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- Inactive -->
    <div class="bg-white rounded-lg border border-amber-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-amber-700 uppercase tracking-wide">Inactive</p>
          <p id="kpi-inactive-employees" class="mt-1 font-heading text-2xl font-bold text-amber-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-amber-100 flex items-center justify-center">
          <i class="fa-solid fa-user-slash text-amber-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- High-Risk -->
    <div class="bg-white rounded-lg border border-rose-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-rose-700 uppercase tracking-wide">High-Risk</p>
          <p id="kpi-high-risk-employees" class="mt-1 font-heading text-2xl font-bold text-rose-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-rose-100 flex items-center justify-center">
          <i class="fa-solid fa-fire-flame-curved text-rose-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- FOH Disciplines -->
    <div class="bg-white rounded-lg border border-cyan-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-cyan-700 uppercase tracking-wide">FOH Actions</p>
          <p id="kpi-foh-total-disciplines" class="mt-1 font-heading text-2xl font-bold text-cyan-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-cyan-100 flex items-center justify-center">
          <i class="fa-solid fa-utensils text-cyan-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- BOH Disciplines -->
    <div class="bg-white rounded-lg border border-orange-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-orange-700 uppercase tracking-wide">BOH Actions</p>
          <p id="kpi-boh-total-disciplines" class="mt-1 font-heading text-2xl font-bold text-orange-900">--</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-orange-100 flex items-center justify-center">
          <i class="fa-solid fa-fire-burner text-orange-600 text-sm"></i>
        </div>
      </div>
    </div>
    <!-- Termination Rate -->
    <div class="bg-white rounded-lg border border-slate-100 p-4">
      <div class="flex justify-between">
        <div>
          <p class="text-xs font-medium text-slate-500 uppercase tracking-wide">Term. Rate</p>
          <p id="kpi-termination-rate" class="mt-1 font-heading text-2xl font-bold text-slate-900">--%</p>
        </div>
        <div class="h-8 w-8 rounded-full bg-slate-100 flex items-center justify-center">
          <i class="fa-solid fa-user-xmark text-slate-600 text-sm"></i>
        </div>
      </div>
    </div>
  </div>

  
<!-- ğŸ“Š DASHBOARD GRID - 4x4 LAYOUT WITH ALL ICONS -->
<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6">

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x1: BOH POSITION DISTRIBUTION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x1: BOH POSITION DISTRIBUTION (WITH UNICODE ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-industry text-brand-600"></i> BOH Position Distribution
  </h3>
  <div class="space-y-1 text-xs overflow-y-auto" style="max-height: 280px;">
    <!-- Line Cook - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook" class="font-bold">0</span></div>
    <!-- Wok Chef - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef" class="font-bold">0</span></div>
    <!-- Dumpling Maker - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker" class="font-bold">0</span></div>
    <!-- Busser - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser" class="font-bold">0</span></div>
    <!-- Prep Cook - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook" class="font-bold">0</span></div>
    <!-- Pastry Chef - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef" class="font-bold">0</span></div>
    <!-- Dishwasher - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher" class="font-bold">0</span></div>
    <!-- Production Manager - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager" class="font-bold">0</span></div>
    <!-- Logistic Coordinator - Unicode Icon -->
    <div class="flex justify-between"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator" class="font-bold">0</span></div>
  </div>
  <div class="mt-3 pt-3 border-t border-slate-200 text-xs font-bold">
    Total BOH: <span id="kpi-boh-total" class="text-indigo-800">0</span>
  </div>
</div>


  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x2: FOH POSITION DISTRIBUTION (UNCHANGED â€” already good) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-utensils text-brand-600"></i> FOH Position Distribution
    </h3>
    <div class="space-y-1 text-xs overflow-y-auto" style="max-height: 280px;">
      <div class="flex justify-between"><span class="font-medium text-emerald-700"><i class="fa-solid fa-user-tie mr-2"></i>FOH Manager:</span><span id="kpi-foh-manager" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-teal-700"><i class="fa-solid fa-wine-glass mr-2"></i>Server:</span><span id="kpi-server" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-purple-700"><i class="fa-solid fa-cocktail mr-2"></i>Bartender:</span><span id="kpi-bartender" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-cyan-700"><i class="fa-solid fa-door-open mr-2"></i>Host:</span><span id="kpi-host" class="font-bold">0</span></div>
      <div class="flex justify-between"><span class="font-medium text-green-700"><i class="fa-solid fa-money-bill-wave mr-2"></i>Cashier:</span><span id="kpi-cashier" class="font-bold">0</span></div>
    </div>
    <div class="mt-3 pt-3 border-t border-slate-200 text-xs font-bold">
      Total FOH: <span id="kpi-foh-total" class="text-emerald-800">0</span>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x3: FOH DISCIPLINE BY POSITION -->
 <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x3: FOH DISCIPLINE BY POSITION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-gavel text-brand-600"></i> FOH Discipline by Position
  </h3>
  <div class="text-xs space-y-2 overflow-y-auto" style="max-height: 280px;">
    <div class="flex justify-between items-center"><span class="font-medium text-emerald-700">ğŸ‘¨â€ğŸ’¼ FOH Manager:</span><span id="kpi-foh-manager-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-teal-700">ğŸ· Server:</span><span id="kpi-server-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-purple-700">ğŸ¸ Bartender:</span><span id="kpi-bartender-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-cyan-700">ğŸšª Host:</span><span id="kpi-host-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-green-700">ğŸ’° Cashier:</span><span id="kpi-cashier-discipline" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 1x4: BOH DISCIPLINE BY POSITION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 1x4: BOH DISCIPLINE BY POSITION (WITH ICONS) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-gavel text-brand-600"></i> BOH Discipline by Position
  </h3>
  <div class="text-xs space-y-2 overflow-y-auto" style="max-height: 280px;">
    <div class="flex justify-between items-center"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager-discipline" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator-discipline" class="font-bold">0</span></div>
  </div>
</div>
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x1: Disciplinary Actions by Job Title CHART -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-id-badge text-brand-600"></i> Disciplinary Actions by Job Title
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-job-title"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x2: FOH & BOH Employee Status Bar Chart -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 2x2: FOH & BOH Employee Status (Bar Chart) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-users text-brand-600"></i> FOH & BOH Employee Status
  </h3>
  <div style="height: 240px; min-height: 240px;">
    <canvas id="chart-employee-status-foh-boh"></canvas>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x3: Discipline Actions by Type (FOH) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-gavel text-brand-600"></i> Discipline Actions by Type (FOH)
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-type-foh"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 2x4: Discipline Actions by Type (BOH) -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-gavel text-brand-600"></i> Discipline Actions by Type (BOH)
    </h3>
    <div style="height: 240px; min-height: 240px;">
      <canvas id="chart-actions-by-type-boh"></canvas>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x1: Recent Disciplinary Actions Table -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-clock-rotate-left text-brand-600"></i> Recent Disciplinary Actions
    </h3>
    <div class="overflow-x-auto max-h-64">
      <table class="w-full text-xs">
        <thead class="bg-slate-50">
          <tr>
            <th class="px-2 py-1 text-left font-bold">Date</th>
            <th class="px-2 py-1 text-left font-bold">Employee</th>
            <th class="px-2 py-1 text-left font-bold">Type</th>
          </tr>
        </thead>
        <tbody id="dashboard-discipline-table-body" class="text-slate-700 divide-y divide-slate-100">
          <!-- populated by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x2: High-Risk FOH Department -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 3x2: High-Risk (FOH) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-fire-flame-curved text-rose-600"></i> High-Risk (FOH)
  </h3>
  <div class="text-xs space-y-2">
    <div class="flex justify-between items-center"><span class="font-medium text-emerald-700">ğŸ‘¨â€ğŸ’¼ FOH Manager:</span><span id="kpi-foh-manager-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-teal-700">ğŸ· Server:</span><span id="kpi-server-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-purple-700">ğŸ¸ Bartender:</span><span id="kpi-bartender-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-cyan-700">ğŸšª Host:</span><span id="kpi-host-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-green-700">ğŸ’° Cashier:</span><span id="kpi-cashier-high-risk" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<!-- CELL 3x3: High-Risk (BOH) -->
<!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
<div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
  <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
    <i class="fa-solid fa-fire-flame-curved text-rose-600"></i> High-Risk (BOH)
  </h3>
  <div class="text-xs space-y-2">
    <div class="flex justify-between items-center"><span class="font-medium text-orange-700">ğŸ‘¨â€ğŸ³ Line Cook:</span><span id="kpi-line-cook-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-yellow-700">ğŸ‘©â€ğŸ³ Wok Chef:</span><span id="kpi-wok-chef-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-pink-700">ğŸ¥Ÿ Dumpling Maker:</span><span id="kpi-dumpling-maker-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-amber-700">ğŸ§¹ Busser:</span><span id="kpi-busser-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-red-700">ğŸ”ª Prep Cook:</span><span id="kpi-prep-cook-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-blue-700">ğŸ° Pastry Chef:</span><span id="kpi-pastry-chef-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-gray-700">ğŸ½ï¸ Dishwasher:</span><span id="kpi-dishwasher-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-indigo-700">ğŸ“¦ Production Manager:</span><span id="kpi-production-manager-high-risk" class="font-bold">0</span></div>
    <div class="flex justify-between items-center"><span class="font-medium text-lime-700">ğŸšš Logistic Coordinator:</span><span id="kpi-logistic-coordinator-high-risk" class="font-bold">0</span></div>
  </div>
</div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 3x4: Employee Compensation Summary -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4">
    <h3 class="font-heading text-sm font-bold text-slate-900 mb-3 flex items-center gap-2">
      <i class="fa-solid fa-money-bill-wave text-brand-600"></i> Employee Compensation
    </h3>
    <div class="text-xs space-y-2">
      <div class="flex justify-between items-center">
        <span>Total Employees on Salary:</span>
        <span id="kpi-salary-count" class="font-bold">0</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Total Employees on Hourly Wage:</span>
        <span id="kpi-hourly-count" class="font-bold">0</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Average Hourly Rate:</span>
        <span id="kpi-average-hourly-rate" class="font-bold">$0.00</span>
      </div>
      <div class="flex justify-between items-center">
        <span>Average Annual Salary:</span>
        <span id="kpi-average-annual-salary" class="font-bold">$0.00</span>
      </div>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x1: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex items-center justify-center">
    <p class="text-xs text-slate-500">Cell 4x1 - Coming Soon</p>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x2: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex items-center justify-center">
    <p class="text-xs text-slate-500">Cell 4x2 - Coming Soon</p>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x3: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex items-center justify-center">
    <p class="text-xs text-slate-500">Cell 4x3 - Coming Soon</p>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- CELL 4x4: COMING SOON -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-white rounded-xl shadow-sm border border-slate-100 p-4 flex items-center justify-center">
    <p class="text-xs text-slate-500">Cell 4x4 - Coming Soon</p>
  </div>

</div>







</section>









  <!-- âœ… Employees Grid Tab -->
  <section id="tab-employees-grid" class="tab-panel hidden space-y-6">
    <div class="flex flex-col gap-4">
      <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
        <h2 class="text-xl font-bold text-slate-900">ğŸ‘¥ Enterprise Employee Grid</h2>
        <div class="flex items-center gap-2">
          <select id="employee-grid-filter-status" class="rounded-lg border border-slate-300 px-3 py-1.5 text-sm">
            <option value="all">All Statuses</option>
            <option value="Active">Active</option>
            <option value="Terminated">Terminated</option>
            <option value="On Leave">On Leave</option>
            <option value="Suspended">Suspended</option>
          </select>
          <button id="employee-grid-refresh" class="inline-flex items-center gap-1 rounded-lg bg-brand-500 text-white px-3 py-1.5 text-sm font-bold hover:bg-brand-600 transition">
            <i class="fa-solid fa-rotate-right"></i> Refresh
          </button>
  
        </div>
      </div>

      <div class="overflow-x-auto rounded-xl border border-slate-200 shadow-sm">
        <table class="min-w-full divide-y divide-slate-200 bg-white">
          <thead class="bg-slate-50">
            <tr>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">ID</th>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">Status</th>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">Name</th>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">Hire Date</th>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">Job / Dept</th>
              <th class="px-3 py-2 text-left text-xs font-black text-slate-700 uppercase tracking-wide">Contact</th>
              <th class="px-3 py-2 text-right text-xs font-black text-slate-700 uppercase tracking-wide">Risk</th>
            </tr>
          </thead>
          <tbody id="employee-grid-body" class="divide-y divide-slate-100">
            <!-- Populated by JS -->
          </tbody>
        </table>
      </div>

      <div id="employee-grid-loading" class="hidden text-center py-8 text-slate-500">
        <i class="fa-solid fa-spinner fa-spin text-2xl mb-2"></i>
        <p>Loading employees...</p>
      </div>
      <div id="employee-grid-empty" class="hidden text-center py-8 text-slate-400">
        <i class="fa-regular fa-folder-open text-3xl mb-2"></i>
        <p>No employees match the current filter.</p>
      </div>
    </div>
  </section>













<section id="tab-compensation-letter" class="tab-panel hidden space-y-6">

 <!-- ğŸ” EMPLOYEE SEARCH SECTION -->
  <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
    <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2">
      <i class="fa-solid fa-magnifying-glass text-brand-600"></i>
      Search Employee for Compensation Letter
    </h3>
    <p class="text-xs text-slate-500 mb-4 font-semibold">
      Search and select an employee to pre-fill their current compensation details
    </p>

    <!-- Search Input with Autocomplete -->
    <div class="relative mb-4">
      <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <i class="fa-solid fa-search text-slate-400"></i>
      </div>
      <input
        id="comp-letter-search"
        type="text"
        placeholder="Type employee name or ID (2+ letters)..."
        class="w-full pl-10 pr-3 py-3 rounded-xl border-2 border-slate-300 bg-slate-50 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all"
        autocomplete="off"
      />
      <!-- Autocomplete Dropdown -->
      <div
        id="comp-letter-search-dropdown"
        class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-slate-200 rounded-xl shadow-xl max-h-80 overflow-y-auto"
      ></div>
    </div>

    <!-- Selected Employee Info (Hidden until employee selected) -->
    <div id="comp-letter-employee-info" class="hidden bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200">
      <h4 class="text-sm font-black text-emerald-900 mb-3 flex items-center gap-2">
        <i class="fa-solid fa-user-check text-emerald-600"></i>
        Selected Employee
      </h4>
      <div class="grid grid-cols-3 gap-3 text-xs">
        <div>
          <p class="text-emerald-600 font-bold mb-1">Name</p>
          <p id="comp-letter-employee-name" class="font-black text-emerald-900">--</p>
        </div>
        <div>
          <p class="text-emerald-600 font-bold mb-1">Employee ID</p>
          <p id="comp-letter-employee-id" class="font-black text-emerald-900">--</p>
        </div>
        <div>
          <p class="text-emerald-600 font-bold mb-1">Department</p>
          <p id="comp-letter-employee-dept" class="font-black text-emerald-900">--</p>
        </div>
      </div>

























<!-- ğŸ’¾ CLEAN FLOATING SAVE BUTTON (FAB Style) -->
<div id="comp-letter-sticky-save" class="hidden fixed bottom-8 right-8 z-50">
  <button type="button" 
          id="sticky-comp-letter-save-btn"
          class="group relative bg-emerald-600 hover:bg-emerald-700 text-white rounded-full shadow-2xl hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-save text-2xl"></i>
    
    <!-- Tooltip -->
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Save to Database
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
</div>



        <!-- ğŸ’¾ CLEAN FLOATING SAVE BUTTON (FAB Style) -->
<div id="comp-letter-sticky-save" class="hidden fixed bottom-8 right-8 z-50 flex flex-col space-y-3">
  
  <!-- SAVE BUTTON -->
  <button type="button" 
          id="sticky-comp-letter-save-btn"
          class="group relative bg-emerald-600 hover:bg-emerald-700 text-white rounded-full shadow-2xl hover:shadow-emerald-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-save text-2xl"></i>
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Save to Database
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
  
  <!-- PREVIEW BUTTON (hidden until saved) -->
  <button type="button" 
          id="sticky-comp-letter-preview-btn"
          class="hidden group relative bg-blue-600 hover:bg-blue-700 text-white rounded-full shadow-2xl hover:shadow-blue-500/50 transition-all duration-300 hover:scale-110 w-16 h-16 flex items-center justify-center">
    <i class="fas fa-file-pdf text-2xl"></i>
    <span class="absolute right-full mr-3 bg-gray-900 text-white text-sm font-semibold px-3 py-2 rounded-lg shadow-lg opacity-0 group-hover:opacity-100 transition-opacity duration-200 whitespace-nowrap pointer-events-none">
      Preview Letter
      <svg class="absolute left-full top-1/2 -translate-y-1/2 -ml-1 w-2 h-4" viewBox="0 0 8 16">
        <path fill="currentColor" d="M0 8l8-8v16z" class="text-gray-900"/>
      </svg>
    </span>
  </button>
  
</div>




      <!-- Current Positions & Rates -->
      <div class="mt-4 pt-4 border-t-2 border-emerald-200">
        <h5 class="text-xs font-black text-emerald-900 mb-2">Current Positions & Rates:</h5>
        <div id="comp-letter-current-positions" class="space-y-2">
          <!-- Populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>

 




<!-- ============================================================================ -->
<!-- ENHANCED COMPENSATION FORM - FULL BENEFITS PACKAGE -->
<!-- ============================================================================ -->
<form id="comp-letter-form" class="space-y-6">
  <input type="hidden" id="comp-letter-selected-employee-id" />
  
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 1: EMPLOYEE CLASSIFICATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg p-4 border-2 border-blue-200">
    <h4 class="text-sm font-black text-blue-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-user-clock"></i>
      Employee Classification
    </h4>
    
    <div class="grid grid-cols-2 gap-4">
      <!-- Full Time / Part Time -->
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Employment Type <span class="text-rose-500">*</span>
        </label>
        <select id="comp-letter-employment-type" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
          <option value="">Select...</option>
          <option value="full_time">Full Time (30+ hours/week)</option>
          <option value="part_time">Part Time (<29 hours/week)</option>
        </select>
      </div>
      
      <!-- Hire Date -->
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Hire Date <span class="text-rose-500">*</span>
        </label>
        <input type="date" id="comp-letter-hire-date" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
      </div>
    </div>
  </div>






  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 2: POSITION & FINANCIAL COMPENSATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="bg-gradient-to-r from-emerald-50 to-teal-50 rounded-lg p-4 border-2 border-emerald-200">
    <h4 class="text-sm font-black text-emerald-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-briefcase"></i>
      Position & Financial Compensation
    </h4>
    
    <!-- ============================================ -->
    <!-- PRIMARY JOB -->
    <!-- ============================================ -->
    <div class="bg-white rounded-lg p-4 mb-4 border-2 border-emerald-400">
      <h5 class="text-xs font-black text-emerald-900 uppercase mb-3 flex items-center gap-2">
        <i class="fa-solid fa-star text-emerald-600"></i>
        Primary Job
      </h5>
      
      <div class="grid grid-cols-3 gap-4">
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Job Title <span class="text-rose-500">*</span>
          </label>
          <input type="text" 
                 id="primary-job-title" 
                 required 
                 class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                 placeholder="e.g., Server" />
        </div>
        
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Department <span class="text-rose-500">*</span>
          </label>
          <select id="primary-department" 
                  required 
                  class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500">
            <option value="">Select...</option>
            <option value="FOH">FOH</option>
            <option value="BOH">BOH</option>
          </select>
        </div>
        
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Hourly Wage <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="primary-wage" 
                   step="0.01" 
                   min="0" 
                   required
               
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-emerald-500" 
                   placeholder="0.00" />
          </div>
        </div>
      </div>
    </div>

    <!-- ============================================ -->
<!-- SECONDARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<!-- ============================================ -->
<!-- SECONDARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<!-- ============================================ -->
<!-- SECONDARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<div id="secondary-job-section" class="bg-white rounded-lg p-4 mb-4 border-2 border-gray-300">
  <h5 class="text-xs font-black text-gray-700 uppercase mb-3 flex items-center gap-2">
    <i class="fa-solid fa-briefcase text-gray-600"></i>
    <span>Secondary Job (Optional)</span>
  </h5>
  <div class="grid grid-cols-3 gap-4">
    <div>
      <label for="secondary-job-title" class="block text-xs font-black text-slate-700 mb-2">
        Job Title
      </label>
      <input type="text" 
             id="secondary-job-title" 
             class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
             placeholder="e.g., Bartender" />
    </div>
    <div>
      <label for="secondary-department" class="block text-xs font-black text-slate-700 mb-2">
        Department
      </label>
      <select id="secondary-department" 
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500">
        <option value="">Select...</option>
        <option value="FOH">FOH</option>
        <option value="BOH">BOH</option>
      </select>
    </div>
    <div>
      <label for="secondary-wage" class="block text-xs font-black text-slate-700 mb-2 flex items-center justify-between">
        <span>Hourly Wage</span>
       <!-- âœ… TOGGLE: Enable/Disable Secondary Job -->
<label class="inline-flex items-center cursor-pointer">
  <input type="checkbox" id="secondary-job-enabled" checked class="sr-only peer">
  <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
  <span class="ml-2 text-xs font-bold text-slate-700">Enable</span>
</label>
      </label>
      <div class="relative">
        <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
        <input type="number" 
               id="secondary-wage" 
               step="0.01" 
               min="0"
               class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
               placeholder="0.00" />
      </div>
    </div>
  </div>
</div>



<!-- TERTIARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<!-- ============================================ -->
<!-- TERTIARY JOB (OPTIONAL) -->
<!-- ============================================ -->
<div id="tertiary-job-section" class="bg-white rounded-lg p-4 mb-4 border-2 border-gray-300">
  <h5 class="text-xs font-black text-gray-700 uppercase mb-3 flex items-center gap-2">
    <i class="fa-solid fa-briefcase text-gray-600"></i>
    <span>Tertiary Job (Optional)</span>
  </h5>
  <div class="grid grid-cols-3 gap-4">
    <div>
      <label for="tertiary-job-title" class="block text-xs font-black text-slate-700 mb-2">
        Job Title
      </label>
      <input type="text" 
             id="tertiary-job-title" 
             class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
             placeholder="e.g., Host" />
    </div>
    <div>
      <label for="tertiary-department" class="block text-xs font-black text-slate-700 mb-2">
        Department
      </label>
      <select id="tertiary-department" 
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500">
        <option value="">Select...</option>
        <option value="FOH">FOH</option>
        <option value="BOH">BOH</option>
      </select>
    </div>
    <div>
      <label for="tertiary-wage" class="block text-xs font-black text-slate-700 mb-2 flex items-center justify-between">
        <span>Hourly Wage</span>
       <!-- âœ… TOGGLE: Enable/Disable Tertiary Job -->
<label class="inline-flex items-center cursor-pointer">
  <input type="checkbox" id="tertiary-job-enabled" checked class="sr-only peer">
  <div class="relative w-10 h-5 bg-gray-200 peer-focus:outline-none rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-4 after:w-4 after:transition-all peer-checked:bg-emerald-500"></div>
  <span class="ml-2 text-xs font-bold text-slate-700">Enable</span>
</label>
      </label>
      <div class="relative">
        <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
        <input type="number" 
               id="tertiary-wage" 
               step="0.01" 
               min="0"
               class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-gray-500" 
               placeholder="0.00" />
      </div>
    </div>
  </div>
</div>

    <!-- ============================================ -->
    <!-- ADDITIONAL COMPENSATION -->
    <!-- ============================================ -->
    <div class="bg-blue-50 rounded-lg p-4 border-2 border-blue-200">
      <h5 class="text-xs font-black text-blue-900 uppercase mb-3 flex items-center gap-2">
        <i class="fa-solid fa-coins text-blue-600"></i>
        Additional Compensation
      </h5>
      
      <div class="grid grid-cols-2 gap-4">
        
        <!-- TRAINING PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Training Pay <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-training-pay" 
                   step="0.01" 
                   min="0" 
                   required 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-blue-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- MEETING PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Meeting Hourly Pay <span class="text-rose-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-meeting-pay" 
                   step="0.01" 
                   min="0" 
                   required 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-purple-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- VACATION PAY -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            Vacation Pay (if qualified)
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-slate-500 font-bold">$</span>
            <input type="number" 
                   id="comp-letter-vacation-pay" 
                   step="0.01" 
                   min="0" 
                   class="w-full rounded-lg border-2 border-slate-300 bg-white pl-8 pr-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-teal-500" 
                   placeholder="0.00" />
          </div>
        </div>
        
        <!-- OVERTIME PAY (DISABLED) -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase mb-2">
            <i class="fa-solid fa-calculator"></i> Overtime Hourly Pay (Auto-calculated at 1.5x)
          </label>
          <div id="comp-letter-overtime-display" class="text-2xl font-black text-amber-900 bg-amber-50 rounded-lg p-3 border border-amber-200 text-center">
            --
          </div>
          <input type="hidden" id="comp-letter-overtime-pay" />
          <p class="text-xs text-amber-700 mt-1 font-bold" id="overtime-calculation-note">
            Will show 1.5x or BLENDED
          </p>
        </div>
        
      </div>
    </div>
    
  </div>









  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 3: TIP POOL CONFIGURATION -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div id="comp-letter-tip-section" class="hidden bg-gradient-to-r from-purple-50 to-pink-50 rounded-lg p-4 border-2 border-purple-200">
    <h4 class="text-sm font-black text-purple-900 uppercase mb-3 flex items-center gap-2">
      <i class="fa-solid fa-money-bill-wave"></i>
      Tip Pool & Financial Responsibilities
    </h4>
    
    <!-- Included in Tip Pool (Busser, Bartender, Host, Cashier) -->
    <div id="comp-letter-tip-pool-option" class="hidden mb-4">
      <label class="flex items-center gap-3 cursor-pointer">
        <input type="checkbox" id="comp-letter-included-in-tip-pool" checked disabled class="w-5 h-5 rounded border-2 border-purple-300 text-purple-600 focus:ring-purple-500" />
        <span class="text-sm font-bold text-purple-900">
          <i class="fa-solid fa-check-circle text-purple-600"></i>
          Included in Tip Pool (Auto-set for this position)
        </span>
      </label>
    </div>
    
    <!-- Server-Specific: Tip to House Pool -->
    <div id="comp-letter-server-tips" class="hidden space-y-3">
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Tip to House Pool (%)
        </label>
        <div class="relative">
          <input type="number" id="comp-letter-tip-to-house" step="0.01" min="0" max="100" value="4.00" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
          <span class="absolute right-3 top-2.5 text-slate-500 font-bold">%</span>
        </div>
      </div>
      
      <div>
        <label class="block text-xs font-black text-slate-700 uppercase mb-2">
          Tip Back Merchant Services (%)
        </label>
        <div class="relative">
          <input type="number" id="comp-letter-merchant-services" step="0.01" min="0" max="100" value="3.00" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
          <span class="absolute right-3 top-2.5 text-slate-500 font-bold">%</span>
        </div>
      </div>
    </div>
  </div>

  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <!-- SECTION 4: CHANGE TRACKING -->
  <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
  <div class="grid grid-cols-2 gap-4">
    <div>
      <label class="block text-xs font-black text-slate-700 uppercase mb-2">
        Effective Date <span class="text-rose-500">*</span>
      </label>
      <input type="date" id="comp-letter-effective-date" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" />
    </div>
    
    <div>
      <label class="block text-xs font-black text-slate-700 uppercase mb-2">
        Change Type <span class="text-rose-500">*</span>
      </label>
      <select id="comp-letter-change-type" required class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500">
        <option value="">Select...</option>
        <option value="new_hire">New Hire</option>
        <option value="promotion">Promotion</option>
        <option value="merit_increase">Merit Increase</option>
        <option value="position_change">Position Change</option>
        <option value="cost_of_living">Cost of Living Adjustment</option>
        <option value="market_adjustment">Market Adjustment</option>
        <option value="other">Other</option>
      </select>
    </div>
  </div>

  <div>
    <label class="block text-xs font-black text-slate-700 uppercase mb-2">
      Reason for Change
    </label>
    <textarea id="comp-letter-change-reason" rows="3" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="Brief explanation..."></textarea>
  </div>

  <div>
    <label class="block text-xs font-black text-slate-700 uppercase mb-2">
      Approved By
    </label>
    <input type="text" id="comp-letter-approved-by" class="w-full rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500" placeholder="Manager/HR name" />
  </div>

 <!-- Wage History Section -->
  <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
    <div class="flex items-center justify-between mb-4">
      <h3 class="font-heading text-lg font-black text-slate-900 flex items-center gap-2">
        <i class="fa-solid fa-clock-rotate-left text-brand-600"></i>
        Wage & Position History
      </h3>
      <button
        id="comp-letter-refresh"
        type="button"
        class="inline-flex items-center gap-2 rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-xs font-bold text-slate-700 hover:bg-slate-50 transition-all"
      >
        <i class="fa-solid fa-arrows-rotate"></i>
        Refresh
      </button>
    </div>

    <div class="overflow-x-auto">
      <table class="w-full text-xs">
       

        <tbody id="comp-letter-history-body" class="divide-y divide-slate-100">
          <tr>
            <td colspan="7" class="px-3 py-8 text-center text-slate-400">
              Select an employee to view wage history
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>







     <!-- Action Buttons -->
  <div class="flex gap-4 pt-4">
    
    <!-- PREVIEW BUTTON -->
    <button type="button" id="comp-letter-preview-btn" 
            style="flex: 1; 
                   display: flex; 
                   flex-direction: column; 
                   align-items: center; 
                   justify-content: center; 
                   gap: 12px; 
                   padding: 28px; 
                   background: linear-gradient(135deg, #e0f2fe 0%, #bae6fd 100%); 
                   color: #0f172a; 
                   border: 2px solid #0ea5e9; 
                   border-radius: 16px; 
                   font-size: 18px; 
                   font-weight: bold; 
                   cursor: pointer; 
                   box-shadow: 0 4px 12px rgba(14, 165, 233, 0.15);
                   transition: all 0.3s ease;">
      <span style="font-size: 42px;">ğŸ‘ï¸</span>
      <span style="font-size: 18px; font-weight: bold; color: #0f172a;">Preview Letter</span>
    </button>
    
    <!-- SAVE BUTTON -->
    <button type="submit" id="comp-letter-save-btn" 
            style="flex: 1; 
                   display: flex; 
                   flex-direction: column; 
                   align-items: center; 
                   justify-content: center; 
                   gap: 12px; 
                   padding: 28px; 
                   background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%); 
                   color: #0f172a; 
                   border: 2px solid #10b981; 
                   border-radius: 16px; 
                   font-size: 18px; 
                   font-weight: bold; 
                   cursor: pointer; 
                   box-shadow: 0 4px 12px rgba(16, 185, 129, 0.15);
                   transition: all 0.3s ease;">
      <span style="font-size: 42px;">ğŸ’¾</span>
      <span style="font-size: 18px; font-weight: bold; color: #0f172a;">Save & Generate PDF</span>
    </button>
    
  </div>






</form>
</section>















  <!-- Add other tabs here (discipline, policy, reports, etc.) as <section id="tab-xxx" class="tab-panel hidden"> -->
</main>


  <!-- End of KPI Grid -->







        <!-- Discipline Cases Tab -->
        <section id="tab-discipline" class="tab-panel hidden space-y-6">
          <!-- Discipline Intro + Status Banner -->
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- Overview -->
            <div class="lg:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-start justify-between gap-3">
                <div>
                  <h2 class="font-heading text-xl text-slate-900">
                    Discipline Cases &amp; Corrective Actions
                  </h2>
                  <p class="mt-1 text-xs text-slate-500 leading-relaxed">
                    Use this workspace to issue <span class="font-medium">verbal, written, final warnings</span> and
                    <span class="font-medium">termination notices</span>. Actions taken here will update the source-of-truth
                    table <span class="font-semibold text-slate-800">employees2025</span>, recalculate risk scoring, and
                    support PDF documentation for signatures and record keeping aligned with TWC/DOL guidance.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-2 text-[0.70rem]">
                  <span class="inline-flex items-center gap-2 rounded-full bg-brand-50 border border-brand-100 px-2 py-0.5 text-brand-700 font-medium">
                    <span class="w-1.5 h-1.5 rounded-full bg-emerald-500"></span>
                    Live Record Updates
                  </span>
                  <span id="discipline-selected-employee-chip" class="hidden inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    <i class="fa-solid fa-id-badge text-[0.70rem]"></i>
                    <span id="discipline-selected-employee-name" class="font-medium"></span>
                  </span>
                </div>
              </div>
            </div>

            <!-- Status Banner -->
            <div class="lg:col-span-3 bg-slate-50 border border-dashed border-slate-300 rounded-2xl px-4 py-3 flex items-start gap-3">
              <div class="mt-0.5">
                <i class="fa-solid fa-circle-info text-brand-500"></i>
              </div>
              <div class="text-xs text-slate-600">
                <p class="font-medium text-slate-800">
                  Discipline Workflow Guidance
                </p>
                <p class="mt-1 leading-relaxed">
                  Before issuing any corrective action, confirm the employee's identity in
                  <span class="font-semibold text-slate-800">Employees 360</span>, validate the facts of the incident, and consult current
                  <span class="font-semibold text-slate-800">Jeng Chi Restaurant policies</span>.
                  All actions must be applied consistently, free from discrimination or retaliation, and aligned with applicable
                  <span class="font-semibold text-slate-800">TWC / DOL</span> standards.
                </p>
              </div>
            </div>
          </div>

          <!-- Discipline Layout: Employee Selector + Form + History -->
          <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 items-start">
            <!-- Left: Quick Employee Picker -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  Quick Employee Selector
                </h3>
                <button
                  id="discipline-refresh-employees"
                  type="button"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-2 py-1 text-[0.70rem] text-slate-600 hover:border-brand-200 hover:bg-brand-50 hover:text-brand-700 transition-colors"
                >
                  <i class="fa-solid fa-rotate-right text-[0.60rem]"></i>
                  <span>Refresh</span>
                </button>
              </div>
              <p class="text-xs text-slate-500">
                Search for an employee and click to load their profile into the discipline form. This ensures the action is tied to the
                correct <span class="font-semibold text-slate-700">employees2025</span> record.
              </p>

              <!-- Search with Autocomplete -->
              <div class="relative flex-1">
                <input
                  id="discipline-employee-search"
                  type="text"
                  placeholder="Search by name or Employee ID (type 3+ letters)"
                  class="w-full rounded-full border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  autocomplete="off"
                />
                <!-- Autocomplete dropdown -->
                <div
                  id="discipline-search-dropdown"
                  class="hidden absolute z-50 w-full mt-1 bg-white border border-slate-200 rounded-xl shadow-lg max-h-64 overflow-y-auto"
                >
                  <!-- Suggestions will appear here -->
                </div>
              </div>

              <div id="discipline-employee-results" class="mt-3 max-h-64 overflow-y-auto space-y-2">
                <!-- Populated dynamically with small employee cards -->
              </div>
            </div>

            <!-- Middle: New Disciplinary Action Form -->
            <div class="xl:col-span-2 bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-4">
              <div class="flex items-center justify-between gap-2">
                <h3 class="font-heading text-base text-slate-900">
                  New Disciplinary Action
                </h3>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-[0.70rem] text-slate-600">
                  <i class="fa-solid fa-lock text-[0.60rem]"></i>
                  <span>Confidential HR Record</span>
                </span>
              </div>

              <form id="discipline-form" class="space-y-4">
                <!-- Hidden field for employee id -->
                <input type="hidden" id="discipline-employee-id" />

                <!-- Type + Date -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div class="sm:col-span-2">
                    <label for="discipline-action-type" class="block text-xs font-heading text-slate-800 mb-1">
                      Type of Corrective Action <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-action-type"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select action type</option>
                      <option value="VERBAL_WARNING">Verbal Warning</option>
                      <option value="WRITTEN_WARNING">Written Warning</option>
                      <option value="FINAL_WARNING">Final Warning</option>
                      <option value="TERMINATION">Termination</option>
                    </select>
                  </div>
                  <div>
                    <label for="discipline-action-date" class="block text-xs font-heading text-slate-800 mb-1">
                      Action Date <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="date"
                      id="discipline-action-date"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                </div>


                <!-- NEW: Category Selection -->
<div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
  <div>
    <label for="discipline-main-category" class="block text-xs font-heading text-slate-800 mb-1">
      Main Category <span class="text-rose-500">*</span>
    </label>
    <select
      id="discipline-main-category"
      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
      required
    >
      <option value="">Select main category...</option>
      <option value="attendance">Attendance & Punctuality</option>
      <option value="performance">Performance Issues</option>
      <option value="conduct">Conduct & Behavior</option>
      <option value="policy">Policy Violations</option>
      <option value="safety">Safety & Health</option>
      <option value="customer">Customer Service</option>
      <option value="integrity">Integrity & Honesty</option>
    </select>
  </div>
  
  <div>
    <label for="discipline-sub-category" class="block text-xs font-heading text-slate-800 mb-1">
      Sub-Category / Specific Issue <span class="text-rose-500">*</span>
    </label>
    <select
      id="discipline-sub-category"
      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
      required
      disabled
    >
      <option value="">Select main category first...</option>
    </select>
  </div>
</div>

                <!-- Severity + Reference -->
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-severity" class="block text-xs font-heading text-slate-800 mb-1">
                      Severity <span class="text-rose-500">*</span>
                    </label>
                    <select
                      id="discipline-severity"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    >
                      <option value="">Select severity</option>
                      <option value="LOW">Low</option>
                      <option value="MEDIUM">Medium</option>
                      <option value="HIGH">High</option>
                    </select>
                  </div>
                  <div class="sm:col-span-2">
                    <label for="discipline-reference" class="block text-xs font-heading text-slate-800 mb-1">
                      Internal Reference / Incident ID
                    </label>
                    <input
                      type="text"
                      id="discipline-reference"
                      placeholder="Optional reference to incident report, video log, or complaint ticket"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Reason -->
                <div>
                  <label for="discipline-reason" class="block text-xs font-heading text-slate-800 mb-1">
                    Reason / Policy Violations <span class="text-rose-500">*</span>
                  </label>
                  <textarea
                    id="discipline-reason"
                    rows="4"
                    placeholder="Describe the incident, including dates, facts, witnesses, and specific Jeng Chi policy sections and TWC/DOL standards implicated."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    required
                  ></textarea>
                </div>

                <!-- Corrective Plan -->
                <div>
                  <label for="discipline-plan" class="block text-xs font-heading text-slate-800 mb-1">
                    Corrective Action Plan / Notes
                  </label>
                  <textarea
                    id="discipline-plan"
                    rows="4"
                    placeholder="Outline expectations, timelines, coaching, retraining, or final performance thresholds for the employee."
                    class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                  ></textarea>
                </div>

                <!-- Signatures -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                  <div>
                    <label for="discipline-manager-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Manager Typed Signature <span class="text-rose-500">*</span>
                    </label>
                    <input
                      type="text"
                      id="discipline-manager-signature"
                      placeholder="Manager full name"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                      required
                    />
                  </div>
                  <div>
                    <label for="discipline-hr-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      HR Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-hr-signature"
                      placeholder="HR representative (optional)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                  <div>
                    <label for="discipline-employee-signature" class="block text-xs font-heading text-slate-800 mb-1">
                      Employee Typed Signature
                    </label>
                    <input
                      type="text"
                      id="discipline-employee-signature"
                      placeholder="Employee full name (if signing)"
                      class="w-full rounded-xl border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
                    />
                  </div>
                </div>

                <!-- Acknowledgment -->
                <div class="flex flex-col sm:flex-row sm:items-center gap-2 text-xs">
                  <label class="inline-flex items-start gap-2 cursor-pointer">
                    <input
                      type="checkbox"
                      id="discipline-employee-declined"
                      class="mt-0.5 rounded border-slate-300 text-brand-600 focus:ring-brand-500"
                    />
                    <span class="text-slate-600">
                      Employee declined to sign. Action is acknowledged only, and a signed copy will be provided per JCR policy.
                    </span>
                  </label>
                </div>

                <!-- Actions -->
                <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-3">
                  <div class="flex items-center gap-2 text-[0.70rem] text-slate-500">
                    <i class="fa-solid fa-scale-balanced text-brand-500"></i>
                    <span>
                      By submitting, you confirm this action is consistent, non-retaliatory, and based solely on documented facts.
                    </span>
                  </div>
                  <div class="flex items-center gap-2">
                    <button
                      type="button"
                      id="discipline-form-reset"
                      class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-2 text-xs font-medium text-slate-600 hover:bg-slate-50"
                    >
                      <i class="fa-solid fa-eraser text-[0.70rem]"></i>
                      <span>Reset Form</span>
                    </button>
                   <button
  type="submit"
  id="discipline-form-submit"
  class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-bold text-black shadow-sm hover:bg-brand-600 disabled:opacity-60 disabled:cursor-not-allowed"
>
  <!-- Spinner while saving -->
  <span id="discipline-form-submit-spinner" class="hidden">
    <i class="fa-solid fa-spinner fa-spin text-[0.80rem]"></i>
  </span>

  <!-- Default state: Save icon + text -->
  <span id="discipline-form-submit-text" class="flex items-center gap-2">
    <i class="fa-solid fa-floppy-disk text-[0.90rem] text-black"></i>
    <span>Record Action &amp; Generate PDF</span>
  </span>
</button>
                  </div>
                </div>

                <!-- Inline form status -->
                <div id="discipline-form-status" class="hidden rounded-xl border px-3 py-2 text-[0.70rem] mt-2">
                  <!-- Populated dynamically -->
                </div>
              </form>
            </div>
          </div>

          <!-- Discipline History & Audit Trail -->
          <div class="grid grid-cols-1 xl:grid-cols-2 gap-6 items-start">
            <!-- History Timeline -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 relative">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Disciplinary History Timeline
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Chronological view of all corrective actions applied to the selected employee.
                  </p>
                </div>
                <span class="inline-flex items-center gap-2 rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-[0.65rem] text-slate-600">
                  <i class="fa-solid fa-timeline text-[0.60rem]"></i>
                  <span>Most Recent First</span>
                </span>
              </div>

              <div class="mt-4 relative">
                <div class="timeline-line"></div>
                <div id="discipline-history-timeline" class="space-y-4 pl-8">
                  <!-- Timeline entries will be rendered here -->
                  <p class="text-xs text-slate-400">
                    Select an employee in <span class="font-medium text-slate-700">Employees 360</span> or in the
                    <span class="font-medium text-slate-700">Quick Employee Selector</span> to view their discipline history.
                  </p>
                </div>
              </div>
            </div>

            <!-- Audit Trail (Tabular) -->
            <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
              <div class="flex items-center justify-between">
                <div>
                  <h3 class="font-heading text-base text-slate-900">
                    Discipline Audit Trail
                  </h3>
                  <p class="mt-1 text-xs text-slate-500">
                    Evidence-ready list of actions, suitable for TWC hearings, DOL audits, or internal investigations.
                  </p>
                </div>
                <button
                  type="button"
                  id="discipline-audit-export"
                  class="inline-flex items-center gap-1 rounded-full border border-slate-200 bg-slate-50 px-3 py-1.5 text-[0.70rem] text-slate-600 hover:bg-brand-50 hover:border-brand-200 hover:text-brand-700"
                >
                  <i class="fa-solid fa-file-pdf text-[0.70rem]"></i>
                  <span>Export Timeline PDF</span>
                </button>
              </div>

              <div class="mt-3 overflow-x-auto">
                <table class="min-w-full text-xs border-separate border-spacing-y-1">
                  <thead>
                    <tr class="text-[0.70rem] text-slate-500 text-left">
                      <th class="px-3 py-2 font-semibold">Timestamp</th>
                      <th class="px-3 py-2 font-semibold">Action</th>
                      <th class="px-3 py-2 font-semibold">Severity</th>
                      <th class="px-3 py-2 font-semibold">User</th>
                      <th class="px-3 py-2 font-semibold">Reference</th>
                    </tr>
                  </thead>
                  <tbody id="discipline-audit-table-body">
                    <!-- Populated with discipline_history entries -->
                    <tr class="bg-slate-50/60">
                      <td class="px-3 py-2 text-slate-400" colspan="5">
                        Audit entries will appear here when an employee with history is selected.
                      </td>
                    </tr>
                  </tbody>
                </table>
              </div>

              <p class="mt-4 text-[0.70rem] text-slate-500 leading-relaxed">
                For each corrective action, this table references data persisted in
                <span class="font-semibold text-slate-800">employees2025.discipline_history</span>,
                combined with front-end context such as the acting user (e.g., "HR Admin" or "Manager").
                Together with PostgreSQL triggers
                <span class="font-semibold text-slate-800">set_employees_last_modified</span> and
                <span class="font-semibold text-slate-800">trg_log_employee_changes</span>,
                this creates a layered, defensible audit model.
              </p>
            </div>
          </div>
        </section>

        <!-- FIXED FILE â€“ PART 3/5: EMPLOYEES 360 TAB + POLICY LIBRARY TAB -->

        <!-- Employees 360 Tab -->
        <!-- ============================================================================ -->
<!-- EMPLOYEES 360 TAB - ENTERPRISE EXECUTIVE LAYOUT -->
<!-- ============================================================================ -->
<section id="tab-employees" class="tab-panel hidden space-y-6">
  
  <!-- Hidden field to store current employee ID -->
  <input type="hidden" id="current-employee-360-id" value="" />

  <!-- ğŸ¯ TOP ROW: Search Panel + Selected Employee Header with KPI Dashboard -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- LEFT: Search & Filter Panel (1/3 width) -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <div class="flex items-center justify-between mb-4">
        <h3 class="font-heading text-base font-black text-slate-900 flex items-center gap-2">
          <i class="fa-solid fa-magnifying-glass text-brand-600"></i>
          Search Employees
        </h3>
        <button
          id="employees-refresh-button"
          type="button"
          class="inline-flex items-center gap-2 rounded-lg border-2 border-slate-300 bg-white px-3 py-2 text-xs font-bold text-slate-700 hover:bg-slate-50 transition-all"
        >
          <i class="fa-solid fa-arrows-rotate"></i>
          Refresh
        </button>
      </div>
      
      <p class="text-xs text-slate-500 mb-4 leading-relaxed font-semibold">
        Search by name, employee ID, or department to view complete employee profile and discipline history.
      </p>

      <!-- Search Input -->
      <div class="relative mb-4">
        <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
          <i class="fa-solid fa-search text-slate-400"></i>
        </div>
        <input
          id="employees-search-input"
          type="text"
          placeholder="Type 3+ letters to search..."
          class="w-full pl-10 pr-3 py-3 rounded-xl border-2 border-slate-300 bg-slate-50 text-sm font-semibold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-all"
          autocomplete="off"
        />
        <div
          id="employees-search-dropdown"
          class="hidden absolute z-50 w-full mt-2 bg-white border-2 border-slate-200 rounded-xl shadow-xl max-h-64 overflow-y-auto"
        ></div>
      </div>

      <!-- Filter Chips -->
      <div class="flex flex-wrap gap-2 mb-4">
        <button
          type="button"
          data-employee-filter="all"
          class="employee-filter-chip inline-flex items-center gap-2 rounded-full border-2 border-brand-500 bg-brand-50 px-4 py-2 text-xs font-black text-brand-700 transition-all hover:bg-brand-100"
        >
          <i class="fa-solid fa-users"></i>
          All
        </button>
        <button
          type="button"
          data-employee-filter="Active"
          class="employee-filter-chip inline-flex items-center gap-2 rounded-full border-2 border-slate-300 bg-white px-4 py-2 text-xs font-black text-slate-600 transition-all hover:bg-slate-50"
        >
          <i class="fa-solid fa-circle-check"></i>
          Active
        </button>
        <button
          type="button"
          data-employee-filter="Terminated"
          class="employee-filter-chip inline-flex items-center gap-2 rounded-full border-2 border-slate-300 bg-white px-4 py-2 text-xs font-black text-slate-600 transition-all hover:bg-slate-50"
        >
          <i class="fa-solid fa-user-xmark"></i>
          Terminated
        </button>
        <button
          type="button"
          data-employee-filter="HighRisk"
          class="employee-filter-chip inline-flex items-center gap-2 rounded-full border-2 border-rose-300 bg-rose-50 px-4 py-2 text-xs font-black text-rose-600 transition-all hover:bg-rose-100"
        >
          <i class="fa-solid fa-fire"></i>
          High Risk
        </button>
      </div>

      <!-- Employee List -->
      <div id="employee-list" class="space-y-2 max-h-[500px] overflow-y-auto">
        <div class="rounded-xl border-2 border-dashed border-slate-200 bg-slate-50 px-4 py-8 text-center">
          <i class="fa-solid fa-user-group text-4xl text-slate-300 mb-3"></i>
          <p class="text-sm text-slate-400 font-semibold">Search or refresh to load employees</p>
        </div>
      </div>
    </div>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- RIGHT: Selected Employee Header + KPI Dashboard (2/3 width) -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="lg:col-span-2 bg-gradient-to-br from-slate-50 to-slate-100 rounded-xl shadow-lg border-2 border-slate-200 p-6">
      
      <!-- Save Button - Top Right -->
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div id="save-status-indicator" class="w-3 h-3 rounded-full bg-emerald-500 animate-pulse"></div>
          <span id="save-status-text" class="text-sm font-bold text-slate-700">Ready to edit</span>
        </div>
        <button
          type="button"
          id="btn-save-employee-360"
          class="inline-flex items-center gap-3 rounded-xl bg-gradient-to-r from-emerald-500 to-emerald-600 px-6 py-3 text-sm font-black text-white shadow-lg hover:from-emerald-600 hover:to-emerald-700 disabled:opacity-60 disabled:cursor-not-allowed transition-all transform hover:scale-105"
        >
          <i class="fa-solid fa-floppy-disk text-lg"></i>
          ğŸ’¾ SAVE ALL CHANGES
        </button>
      </div>

      <!-- Employee Header Card -->
      <div class="bg-white rounded-xl border-2 border-slate-200 p-6 mb-6 shadow-sm">
        <div class="flex items-start justify-between">
          <div class="flex-1">
            <h2 id="employee-profile-name" class="font-heading text-2xl font-black text-slate-900 mb-2">
              Select an employee
            </h2>
            <p id="employee-profile-title" class="text-sm text-slate-600 font-semibold mb-1">
              Job title â€¢ Department
            </p>
            <p id="employee-profile-status" class="text-xs text-slate-500 font-semibold">
              Employment status, hire dates, and reporting structure will appear here.
            </p>
          </div>
          <div class="flex flex-col items-end gap-2">
            <div id="employee-profile-risk-badge" class="inline-flex items-center gap-2 rounded-full bg-slate-100 border-2 border-slate-300 px-4 py-2 text-xs font-black text-slate-600">
              <span class="w-2 h-2 rounded-full bg-slate-400"></span>
              Risk Score: â€”
            </div>
            <div class="flex gap-2">
              <span id="employee-profile-employee-id" class="inline-flex items-center gap-1 rounded-lg bg-slate-100 border border-slate-300 px-3 py-1 text-xs font-bold text-slate-700">
                <i class="fa-solid fa-hashtag"></i>
                ID: --
              </span>
              <span id="employee-profile-username" class="inline-flex items-center gap-1 rounded-lg bg-slate-100 border border-slate-300 px-3 py-1 text-xs font-bold text-slate-700">
                <i class="fa-solid fa-user"></i>
                --
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- KPI Dashboard Grid -->
      <div class="grid grid-cols-4 gap-4">
        <!-- Verbal Warnings -->
        <div class="bg-white rounded-xl border-2 border-emerald-200 p-4 text-center shadow-sm hover:shadow-md transition-shadow">
          <i class="fa-solid fa-comments text-2xl text-emerald-600 mb-2"></i>
          <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-1">Verbal</p>
          <p id="employee-kpi-verbal" class="font-heading text-3xl font-black text-emerald-700">--</p>
        </div>

        <!-- Written Warnings -->
        <div class="bg-white rounded-xl border-2 border-amber-200 p-4 text-center shadow-sm hover:shadow-md transition-shadow">
          <i class="fa-solid fa-file-pen text-2xl text-amber-600 mb-2"></i>
          <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-1">Written</p>
          <p id="employee-kpi-written" class="font-heading text-3xl font-black text-amber-700">--</p>
        </div>

        <!-- Final Warnings -->
        <div class="bg-white rounded-xl border-2 border-orange-200 p-4 text-center shadow-sm hover:shadow-md transition-shadow">
          <i class="fa-solid fa-triangle-exclamation text-2xl text-orange-600 mb-2"></i>
          <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-1">Final</p>
          <p id="employee-kpi-final" class="font-heading text-3xl font-black text-orange-700">--</p>
        </div>

        <!-- Termination Letters -->
        <div class="bg-white rounded-xl border-2 border-rose-200 p-4 text-center shadow-sm hover:shadow-md transition-shadow">
          <i class="fa-solid fa-user-slash text-2xl text-rose-600 mb-2"></i>
          <p class="text-xs font-bold text-slate-600 uppercase tracking-wide mb-1">Termination</p>
          <p id="employee-kpi-termination" class="font-heading text-3xl font-black text-rose-700">--</p>
        </div>
      </div>

    </div>
  </div>

  <!-- ============================================================================ -->
  <!-- BOTTOM SECTION: Employee Details in Professional 3-Column Layout -->
  <!-- ============================================================================ -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- COLUMN 1: Employment & Contact Information -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-id-card text-brand-600"></i>
        Employment & Contact
      </h3>

      <div class="space-y-4">
        <!-- Employment Status -->
        <div>
          <label for="edit-employment-status" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-check text-brand-600"></i>
            Employment Status
          </label>
          <select
            id="edit-employment-status"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
          >
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Terminated">Terminated</option>
            <option value="On Leave">On Leave</option>
            <option value="Suspended">Suspended</option>
          </select>
        </div>

        <!-- First Name -->
        <div>
          <label for="edit-first-name" class="block text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            First Name
          </label>
          <input
            type="text"
            id="edit-first-name"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="First name"
          />
        </div>

        <!-- Last Name -->
        <div>
          <label for="edit-last-name" class="block text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Last Name
          </label>
          <input
            type="text"
            id="edit-last-name"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="Last name"
          />
        </div>

        <!-- Department -->
        <div>
          <label for="edit-department" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-building-user text-brand-600"></i>
            Department
          </label>
          <select
            id="edit-department"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
          >
            <option value="">Select department</option>
            <option value="BOH">BOH (Back of House)</option>
            <option value="FOH">FOH (Front of House)</option>
          </select>
        </div>

        <!-- Job Title -->
        <div>
          <label for="edit-job-title" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-id-badge text-brand-600"></i>
            Job Title
          </label>
          <select
            id="edit-job-title"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            disabled
          >
            <option value="">Select department first...</option>
          </select>
        </div>

        <!-- Manager -->
        <div>
          <label for="edit-report-to" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-tie text-brand-600"></i>
            Manager / Reports To
          </label>
          <select
            id="edit-report-to"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
          >
            <option value="">Select manager</option>
            <option value="Shoko Teng">Shoko Teng</option>
            <option value="Pablo Gonzalez">Pablo Gonzalez</option>
            <option value="Janelle Teng">Janelle Teng</option>
            <option value="Craig Reeves">Craig Reeves</option>
            <option value="Ahn Mai Vu">Ahn Mai Vu</option>
          </select>
        </div>

        <!-- Email -->
        <div>
          <label for="edit-email" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-envelope text-brand-600"></i>
            Email
          </label>
          <input
            type="email"
            id="edit-email"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="email@example.com"
          />
        </div>

        <!-- Phone -->
        <div>
          <label for="edit-phone" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-phone text-brand-600"></i>
            Phone
          </label>
          <input
            type="tel"
            id="edit-phone"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="(555) 123-4567"
          />
        </div>
      </div>
    </div>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- COLUMN 2: Address & Compensation -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-location-dot text-brand-600"></i>
        Address & Compensation
      </h3>

      <div class="space-y-4">
        <!-- Address Line 1 -->
        <div>
          <label for="edit-address-line-1" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-map-marker-alt text-brand-600"></i>
            Address Line 1
          </label>
          <input
            type="text"
            id="edit-address-line-1"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="Street address"
          />
        </div>

        <!-- Address Line 2 -->
        <div>
          <label for="edit-address-line-2" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-building text-brand-600"></i>
            Address Line 2
          </label>
          <input
            type="text"
            id="edit-address-line-2"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="Apt, suite (optional)"
          />
        </div>

        <!-- City -->
        <div>
          <label for="edit-city" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-city text-brand-600"></i>
            City
          </label>
          <input
            type="text"
            id="edit-city"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            placeholder="City"
          />
        </div>

        <!-- State + Zip (side by side) -->
        <div class="grid grid-cols-2 gap-3">
          <div>
            <label for="edit-state" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-map text-brand-600"></i>
              State
            </label>
            <input
              type="text"
              id="edit-state"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="TX"
              maxlength="2"
            />
          </div>

          <div>
            <label for="edit-zip-code" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-mailbox text-brand-600"></i>
              Zip Code
            </label>
            <input
              type="text"
              id="edit-zip-code"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="12345"
            />
          </div>
        </div>

        <!-- COMPENSATION SECTION -->
        <div class="pt-4 border-t-2 border-slate-200">
          <h4 class="text-sm font-black text-slate-700 uppercase tracking-wide mb-3 flex items-center gap-2">
            <i class="fa-solid fa-dollar-sign text-emerald-600"></i>
            Compensation
          </h4>

          <!-- Original Hire Date -->
          <div class="mb-4">
            <label for="edit-original-hire-date" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-calendar-check text-brand-600"></i>
              Original Hire Date
            </label>
            <input
              type="date"
              id="edit-original-hire-date"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            />
          </div>

          <!-- Compensation Type -->
          <div class="mb-4">
            <label for="edit-compensation-type" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-money-bill-wave text-emerald-600"></i>
              Compensation Type
            </label>
            <select
              id="edit-compensation-type"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
            >
              <option value="hourly">Hourly</option>
              <option value="salary">Salary</option>
            </select>
          </div>

          <!-- Hourly Rate -->
          <div id="hourly-rate-container" class="mb-4">
            <label for="edit-hourly-rate" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-clock text-emerald-600"></i>
              Hourly Rate
            </label>
            <input
              type="number"
              id="edit-hourly-rate"
              step="0.01"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="0.00"
            />
          </div>

          <!-- Annual Salary -->
          <div id="annual-salary-container" class="mb-4">
            <label for="edit-annual-salary" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-hand-holding-dollar text-emerald-600"></i>
              Annual Salary
            </label>
            <input
              type="number"
              id="edit-annual-salary"
              step="0.01"
              class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="0.00"
            />
          </div>

          <!-- Calculated Hourly (Display Only) -->
          <div>
            <label class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
              <i class="fa-solid fa-calculator text-slate-600"></i>
              Calculated Hourly Rate
            </label>
            <div id="display-calculated-hourly" class="w-full rounded-lg border-2 border-slate-200 bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600">
              --
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <!-- COLUMN 3: Risk, Tenure & Discipline Summary -->
    <!-- â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â” -->
    <div class="bg-white rounded-xl shadow-lg border-2 border-slate-200 p-6">
      <h3 class="font-heading text-lg font-black text-slate-900 mb-4 flex items-center gap-2 border-b-2 border-slate-200 pb-3">
        <i class="fa-solid fa-chart-line text-brand-600"></i>
        Risk & Compliance
      </h3>

      <div class="space-y-4">
        <!-- Tenure (Calculated) -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Tenure (Calculated)
          </label>
          <div id="display-tenure" class="w-full rounded-lg border-2 border-slate-200 bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600">
            --
          </div>
        </div>

        <!-- Risk Score (Calculated) -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Risk Score (Calculated)
          </label>
          <div id="display-risk-score" class="w-full rounded-lg border-2 border-slate-200 bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600">
            --
          </div>
        </div>

        <!-- Risk Level -->
        <div>
          <label for="edit-risk-level" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-triangle-exclamation text-rose-600"></i>
            Risk Level
          </label>
          <select
            id="edit-risk-level"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
          >
            <option value="LOW">LOW</option>
            <option value="MEDIUM">MEDIUM</option>
            <option value="HIGH">HIGH</option>
          </select>
        </div>

        <!-- HR Witness -->
        <div>
          <label for="edit-hr-witness" class="flex items-center gap-2 text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            <i class="fa-solid fa-user-shield text-brand-600"></i>
            HR Witness
          </label>
          <select
            id="edit-hr-witness"
            class="w-full rounded-lg border-2 border-slate-300 bg-slate-50 px-3 py-2 text-sm font-bold focus:outline-none focus:ring-2 focus:ring-brand-500"
          >
            <option value="">Select HR witness</option>
            <option value="Shoko Teng">Shoko Teng</option>
            <option value="Pablo Gonzalez">Pablo Gonzalez</option>
            <option value="Janelle Teng">Janelle Teng</option>
            <option value="Craig Reeves">Craig Reeves</option>
            <option value="Ahn Mai Vu">Ahn Mai Vu</option>
          </select>
        </div>

        <!-- Last Disciplinary Action (Read-only) -->
        <div>
          <label class="block text-xs font-black text-slate-700 uppercase tracking-wide mb-2">
            Last Disciplinary Action
          </label>
          <div id="display-last-action" class="w-full rounded-lg border-2 border-slate-200 bg-slate-100 px-3 py-2 text-sm font-bold text-slate-600">
            --
          </div>
        </div>

        <!-- Discipline Summary Card -->
        <div class="pt-4 border-t-2 border-slate-200">
          <h4 class="text-sm font-black text-slate-700 uppercase tracking-wide mb-3 flex items-center gap-2">
            <i class="fa-solid fa-gavel text-rose-600"></i>
            Discipline Summary
          </h4>

          <div id="employee-summary-history" class="text-xs text-slate-600 leading-relaxed">
            <p>Once an employee is selected, a concise narrative summary of their discipline history and risk posture will be generated here.</p>
          </div>

          <!-- Download PDF Button -->
          <button
            type="button"
            id="employee-summary-pdf"
            class="mt-4 w-full inline-flex items-center justify-center gap-2 rounded-lg border-2 border-brand-300 bg-brand-50 px-4 py-3 text-sm font-black text-brand-700 hover:bg-brand-100 transition-all"
          >
            <i class="fa-solid fa-file-pdf text-lg"></i>
            Download 360 PDF
          </button>
        </div>

        <!-- Risk Scoring Info -->
        <div class="rounded-lg bg-slate-50 border-2 border-slate-200 p-3">
          <p class="text-xs text-slate-600 leading-relaxed font-semibold">
            <i class="fa-solid fa-info-circle text-brand-600 mr-1"></i>
            Risk scoring: 1pt per verbal, 2pts per written, 3pts per final, 4pts per termination letter.
          </p>
        </div>
      </div>
    </div>

  </div>
  <!-- End of 3-column grid -->

</section>
<!-- ============================================================================ -->
<!-- END OF EMPLOYEES 360 TAB -->
<!-- ============================================================================ -->
















        <!-- Policy Library Tab -->
        <section id="tab-policy" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Policy Library &amp; Reference
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Centralized view of external guidance and internal Jeng Chi Restaurant discipline policies used to inform corrective actions.
              </p>
            </div>
          </div>

          <!-- Filter Pills -->
          <div class="flex flex-wrap gap-2 text-[0.70rem]">
            <button
              type="button"
              data-policy-category="twc-dol"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-100 px-3 py-1 text-brand-700 font-medium"
            >
              <i class="fa-solid fa-scale-balanced text-[0.70rem]"></i>
              <span>TWC / DOL Guidance</span>
            </button>
            <button
              type="button"
              data-policy-category="internal"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-building text-[0.70rem]"></i>
              <span>Internal JCR Policies</span>
            </button>
            <button
              type="button"
              data-policy-category="discipline"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-gavel text-[0.70rem]"></i>
              <span>Discipline &amp; Corrective Action</span>
            </button>
            <button
              type="button"
              data-policy-category="complaint"
              class="policy-filter-chip inline-flex items-center gap-1 rounded-full bg-slate-50 border border-slate-200 px-3 py-1 text-slate-600"
            >
              <i class="fa-solid fa-comments text-[0.70rem]"></i>
              <span>Complaint &amp; Investigation Procedures</span>
            </button>
          </div>

          <!-- Policies Accordion -->
          <div id="policy-accordion" class="space-y-4 text-xs">
            <!-- TWC / DOL Guidance -->
            <article
              data-policy-category-panel="twc-dol"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
    <div>
      <h3 class="font-heading text-sm text-slate-900 font-bold flex items-center gap-2">
        <i class="fa-solid fa-scale-balanced text-brand-600 text-sm"></i>
        <span>TWC / DOL Consistent Documentation Practices</span>
      </h3>
      <p class="text-[0.70rem] text-slate-500 mt-1 flex items-center gap-2">
        <i class="fa-solid fa-file-shield text-slate-400 text-[0.70rem]"></i>
        <span>
          Align disciplinary documentation with requirements commonly reviewed in Texas Workforce Commission and U.S. Department of Labor proceedings.
        </span>
      </p>
    </div>
    <div class="flex flex-col items-end gap-1 text-[0.65rem]">
      <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
        <i class="fa-regular fa-clock text-[0.60rem] mr-1"></i>
        <span>Last updated: 2025-06-01</span>
      </span>
      <button
        type="button"
        class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
      >
        <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
      </button>
    </div>
  </header>



              <div class="policy-accordion-body space-y-2 text-slate-600">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Maintain <span class="font-medium">fact-based, contemporaneous documentation</span> for each incident, including dates, times, witnesses, and specific behaviors observed.
                  </li>
                  <li>
                    Ensure that <span class="font-medium">policies are communicated</span> to all employees, with signed acknowledgments held in personnel files or the digital portal.
                  </li>
                  <li>
                    Apply discipline <span class="font-medium">consistently across similarly situated employees</span> to mitigate allegations of disparate treatment or retaliation.
                  </li>
                  <li>
                    Use a <span class="font-medium">progressive discipline model</span> where appropriate (verbal, written, final, termination), while preserving the employer's right to accelerate steps when warranted.
                  </li>
                  <li>
                    Retain records for a reasonable period consistent with <span class="font-medium">TWC, DOL, and internal retention schedules</span>.
                  </li>
                </ul>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  This summary is provided for HR guidance and does not replace consultation with qualified legal counsel.
                </p>
              </div>
            </article>

            <!-- Internal JCR Policies -->
            <article
              data-policy-category-panel="internal"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    JCR Standard of Conduct &amp; Zero-Tolerance Areas
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Internal expectations for professional conduct, customer care, safety, and respect in the workplace.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-04-15
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    JCR maintains a <span class="font-medium">zero-tolerance policy</span> for violence, harassment, discrimination, and retaliation.
                  </li>
                  <li>
                    Employees must follow all <span class="font-medium">food safety, health, and cleanliness standards</span> applicable to restaurant operations.
                  </li>
                  <li>
                    Timekeeping, tip reporting, and wage-and-hour rules must be followed accurately and honestly.
                  </li>
                  <li>
                    All discipline should be documented in this portal to provide an <span class="font-medium">accurate 360Â° record</span>.
                  </li>
                  <li>
                    Any deviation from progressive discipline must be <span class="font-medium">approved by HR</span> and documented with rationale.
                  </li>
                </ul>
              </div>
            </article>

            <!-- Discipline & Corrective Action -->
            <article
              data-policy-category-panel="discipline"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Progressive Discipline Framework
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Structured approach guiding verbal, written, final, and termination decisions at Jeng Chi Restaurant.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-05-10
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ol class="list-decimal list-inside space-y-1">
                  <li>
                    <span class="font-medium">Coaching &amp; Verbal Feedback</span> &mdash; early-stage, non-punitive coaching that may be documented as a verbal warning when patterns emerge.
                  </li>
                  <li>
                    <span class="font-medium">Written Warning</span> &mdash; formal documentation of the issue, expectations, and timeline for improvement.
                  </li>
                  <li>
                    <span class="font-medium">Final Warning</span> &mdash; last opportunity to correct behavior, document clear consequences for non-compliance.
                  </li>
                  <li>
                    <span class="font-medium">Termination</span> &mdash; when the relationship must end, with a focus on professionalism, documentation, and consistent policy application.
                  </li>
                </ol>
                <p class="mt-2 text-[0.70rem] text-slate-500">
                  Leadership should consult HR before issuing final warnings or terminations, especially where protected activity or past complaints may be relevant.
                </p>
              </div>
            </article>

            <!-- Complaint & Investigation -->
            <article
              data-policy-category-panel="complaint"
              class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4 space-y-3 hidden"
            >
              <header class="flex items-start justify-between gap-3 cursor-pointer policy-accordion-header">
                <div>
                  <h3 class="font-heading text-sm text-slate-900">
                    Complaint Intake &amp; Investigation Procedures
                  </h3>
                  <p class="text-[0.70rem] text-slate-500 mt-1">
                    Processes for receiving, documenting, and investigating concerns raised by employees, guests, or vendors.
                  </p>
                </div>
                <div class="flex flex-col items-end gap-1 text-[0.65rem]">
                  <span class="inline-flex items-center rounded-full bg-slate-50 border border-slate-200 px-2 py-0.5 text-slate-600">
                    Last updated: 2025-03-20
                  </span>
                  <button
                    type="button"
                    class="policy-accordion-toggle inline-flex items-center justify-center w-6 h-6 rounded-full bg-slate-50 border border-slate-200 text-slate-500"
                  >
                    <i class="fa-solid fa-chevron-down text-[0.60rem]"></i>
                  </button>
                </div>
              </header>
              <div class="policy-accordion-body space-y-2 text-slate-600 hidden">
                <ul class="list-disc list-inside space-y-1">
                  <li>
                    Complaints may be raised <span class="font-medium">verbally or in writing</span> to any manager or HR.
                  </li>
                  <li>
                    All complaints must be documented in a <span class="font-medium">central log</span>, with dates, participants, and next steps.
                  </li>
                  <li>
                    Investigations should be <span class="font-medium">prompt, impartial, and confidential</span> to the extent possible.
                  </li>
                  <li>
                    Retaliation against individuals who raise concerns or participate in investigations is strictly prohibited.
                  </li>
                  <li>
                    Outcomes of investigations should be documented and communicated appropriately, with discipline applied as needed.
                  </li>
                </ul>
              </div>
            </article>
          </div>

          <!-- AI Disclaimer -->
          <div class="rounded-2xl border border-dashed border-amber-200 bg-amber-50/50 px-4 py-3 text-[0.70rem] text-amber-800">
            <p class="font-semibold">
              AI-Assisted Content &amp; Legal Review
            </p>
            <p class="mt-1">
              Some explanatory language in this Policy Library has been drafted or structured using AI-assisted tools for clarity and
              consistency. These materials are provided for <span class="font-semibold">HR reference only</span> and do not constitute legal advice.
              Jeng Chi Restaurant leadership and HR must review, adapt, and approve all policy content, and should consult qualified labor
              and employment counsel to confirm alignment with current TWC, DOL, and applicable law.
            </p>
          </div>
        </section>
        <!-- FIXED FILE â€“ PART 4/5: REPORTS TAB + ADMIN TAB + PERMISSIONS TAB + CLOSING TAGS -    
      
        <!-- Admin Settings Tab -->
        <section id="tab-admin" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Admin Settings
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Configure risk thresholds, notification preferences, and system-wide defaults for the discipline portal.
              </p>
            </div>
            <button
              id="admin-save-settings"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-floppy-disk"></i>
              <span>Save All Settings</span>
            </button>
          </div>

<!-- Risk Score Thresholds -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Risk Score Thresholds
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Define the point thresholds that determine LOW, MEDIUM, and HIGH risk levels for employees based on their discipline history.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-xs">
              <!-- Low Risk Threshold -->
              <div>
                <label for="admin-threshold-low" class="block font-bold text-slate-700 mb-1">
                  Low Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-low"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score below this = Low Risk
                </p>
              </div>

              <!-- Medium Risk Threshold -->
              <div>
                <label for="admin-threshold-medium" class="block font-bold text-slate-700 mb-1">
                  Medium Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-medium"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 5"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = Medium Risk
                </p>
              </div>

              <!-- High Risk Threshold -->
              <div>
                <label for="admin-threshold-high" class="block font-bold text-slate-700 mb-1">
                  High Risk Threshold
                </label>
                <input
                  type="number"
                  id="admin-threshold-high"
                  min="0"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="e.g., 8"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Score at/above this = High Risk
                </p>
              </div>
            </div>
          </div>

          <!-- Action Point Weights -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Action Point Weights
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Assign point values to each type of disciplinary action for risk score calculation.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 text-xs">
              <!-- Verbal Warning Points -->
              <div>
                <label for="admin-points-verbal" class="block font-bold text-slate-700 mb-1">
                  Verbal Warning
                </label>
                <input
                  type="number"
                  id="admin-points-verbal"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="1"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per verbal warning
                </p>
              </div>

              <!-- Written Warning Points -->
              <div>
                <label for="admin-points-written" class="block font-bold text-slate-700 mb-1">
                  Written Warning
                </label>
                <input
                  type="number"
                  id="admin-points-written"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="2"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per written warning
                </p>
              </div>

              <!-- Final Warning Points -->
              <div>
                <label for="admin-points-final" class="block font-bold text-slate-700 mb-1">
                  Final Warning
                </label>
                <input
                  type="number"
                  id="admin-points-final"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="3"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per final warning
                </p>
              </div>

              <!-- Termination Points -->
              <div>
                <label for="admin-points-termination" class="block font-bold text-slate-700 mb-1">
                  Termination Letter
                </label>
                <input
                  type="number"
                  id="admin-points-termination"
                  min="0"
                  step="0.5"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="4"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Points per termination letter
                </p>
              </div>
            </div>
          </div>

          <!-- Notification Settings -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Notification Settings
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure when and how the system sends alerts to HR and management.
            </p>
            <div class="space-y-3 text-xs">
              <!-- Notify on High Risk -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-high-risk"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-high-risk" class="font-bold text-slate-700 cursor-pointer">
                    Notify when employee reaches High Risk
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send an alert to HR when an employee's risk score crosses the high-risk threshold.
                  </p>
                </div>
              </div>

              <!-- Notify on Final Warning -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-final-warning"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-final-warning" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Final Warning is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Alert leadership when a final warning is documented in the system.
                  </p>
                </div>
              </div>

              <!-- Notify on Termination -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-termination"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-termination" class="font-bold text-slate-700 cursor-pointer">
                    Notify when Termination Letter is issued
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Send immediate notification to HR and legal when a termination is processed.
                  </p>
                </div>
              </div>

              <!-- Daily Summary -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-notify-daily-summary"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-notify-daily-summary" class="font-bold text-slate-700 cursor-pointer">
                    Send daily discipline summary
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Email a daily summary of all discipline actions to designated recipients.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Display Preferences -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Display Preferences
            </h3>
            <div class="space-y-3 text-xs">
              <!-- Show Employee Photos -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-photos"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-photos" class="font-bold text-slate-700 cursor-pointer">
                    Show employee photos in lists
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Display profile photos next to employee names throughout the portal.
                  </p>
                </div>
              </div>

              <!-- Compact Mode -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-compact"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-compact" class="font-bold text-slate-700 cursor-pointer">
                    Use compact table views
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Reduce spacing in tables and lists for more data density.
                  </p>
                </div>
              </div>

              <!-- Auto-refresh Dashboard -->
              <div class="flex items-start gap-3">
                <input
                  type="checkbox"
                  id="admin-display-auto-refresh"
                  class="mt-1 rounded border-slate-300 text-brand-500 focus:ring-brand-500"
                />
                <div class="flex-1">
                  <label for="admin-display-auto-refresh" class="font-bold text-slate-700 cursor-pointer">
                    Auto-refresh dashboard every 5 minutes
                  </label>
                  <p class="text-[0.70rem] text-slate-500 mt-0.5">
                    Automatically refresh dashboard data when the tab is active.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <!-- Data Retention -->
          <div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
            <h3 class="font-heading text-sm text-slate-900 mb-3">
              Data Retention
            </h3>
            <p class="text-xs text-slate-600 mb-4">
              Configure how long the system retains discipline records and audit trails.
            </p>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-xs">
              <!-- Discipline Records Retention -->
              <div>
                <label for="admin-retention-discipline" class="block font-bold text-slate-700 mb-1">
                  Discipline Records Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-discipline"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  Recommended: 7 years per TWC guidance
                </p>
              </div>

              <!-- Audit Trail Retention -->
              <div>
                <label for="admin-retention-audit" class="block font-bold text-slate-700 mb-1">
                  Audit Trail Retention (Years)
                </label>
                <input
                  type="number"
                  id="admin-retention-audit"
                  min="1"
                  max="10"
                  step="1"
                  class="w-full rounded-lg border border-slate-200 bg-slate-50 px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                  placeholder="7"
                />
                <p class="mt-1 text-[0.70rem] text-slate-500">
                  System logs and change history
                </p>
              </div>
            </div>
          </div>

          <!-- Save Confirmation -->
          <div id="admin-save-status" class="hidden rounded-2xl border border-emerald-200 bg-emerald-50 px-4 py-3 text-xs text-emerald-800">
            <div class="flex items-center gap-2">
              <i class="fa-solid fa-circle-check text-emerald-600"></i>
              <span class="font-semibold">Settings saved successfully!</span>
            </div>
          </div>
        </section>

        <!-- Permissions Tab -->
        <section id="tab-permissions" class="tab-panel hidden space-y-6">
          <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <div>
              <h2 class="font-heading text-xl text-slate-900">
                Permissions &amp; Access Control
              </h2>
              <p class="text-xs text-slate-500 mt-1">
                Manage who can view, edit, and administer the discipline portal. Define role-based permissions for HR, managers, and administrators.
              </p>
            </div>
            <button
              id="permissions-add-admin"
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-4 py-2 text-xs font-semibold text-white shadow-sm hover:bg-brand-600"
            >
              <i class="fa-solid fa-user-plus"></i>
              <span>Add Administrator</span>
            </button>
          </div>

          <!-- Current Administrators -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Portal Administrators
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Users with full administrative access to all tabs, settings, and data.
  </p>
  <div class="space-y-2 text-xs">
    <!-- Admin User 1 -->
    <div class="flex items-center justify-between rounded-lg border border-slate-100 bg-slate-50 px-3 py-2">
      <div class="flex items-center gap-3">
        <div class="flex items-center justify-center w-8 h-8 rounded-full bg-brand-500 text-white font-heading text-xs">
          PG
        </div>
        <div>
          <p class="font-bold text-slate-900">Pablo Gonzalez</p>
          <p class="text-[0.70rem] text-slate-500">pablo@jengchirestaurant.com</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <span class="inline-flex items-center gap-1 rounded-full bg-brand-50 border border-brand-200 px-2 py-1 text-[0.70rem] text-brand-700 font-medium">
          <i class="fa-solid fa-shield-halved text-[0.60rem]"></i>
          <span>Owner</span>
        </span>
      </div>
    </div>
  </div>
</div>

<!-- Role-Based Access Matrix -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Role-Based Access Matrix
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Define what each role can view and edit across the portal. Changes save automatically.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700 min-w-[250px]">
            Feature / Tab
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-shield-halved text-brand-500 mb-1"></i>
              <span>Admin</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-user-tie text-slate-500 mb-1"></i>
              <span>Manager</span>
            </div>
          </th>
          <th class="px-3 py-2 text-center font-heading text-slate-700">
            <div class="flex flex-col items-center">
              <i class="fa-solid fa-eye text-slate-500 mb-1"></i>
              <span>Viewer</span>
            </div>
          </th>
        </tr>
      </thead>
      <tbody class="divide-y divide-slate-100">
        
        <!-- Dashboard - View KPIs & Charts -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard â€” View KPIs & Charts</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Dashboard - Export Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Dashboard â€” Export Reports & Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="dashboard-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - View History -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” View History</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Create & Edit Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Create & Edit Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Delete Actions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Delete Actions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-delete" data-role="viewer" />
          </td>
        </tr>

        <!-- Discipline Cases - Export PDFs -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Discipline Cases â€” Export to PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="discipline-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - View Profiles -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” View Profiles</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Employee Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Edit Employee Data</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Edit Salaries & Compensation -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Edit Salaries & Compensation</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-salary" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Terminate Employees -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Terminate Employees</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-terminate" data-role="viewer" />
          </td>
        </tr>

        <!-- Employees 360 - Export 360 PDF -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Employees 360 â€” Export 360 PDF</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="employees-export" data-role="viewer" />
          </td>
        </tr>

      <!-- Policy Library - View Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library â€” View Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Policy Library - Edit Policies -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Policy Library â€” Edit Policies</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="policy-edit" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - View Reports -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports â€” View Reports & Analytics</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-view" data-role="viewer" />
          </td>
        </tr>

        <!-- Reports - Export Data -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Reports â€” Export Data & PDFs</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="reports-export" data-role="viewer" />
          </td>
        </tr>

        <!-- Admin Settings - Access -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Admin Settings â€” Access Settings</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="admin-access" data-role="viewer" />
          </td>
        </tr>

        <!-- Permissions - Manage Permissions -->
        <tr>
          <td class="px-3 py-2 text-slate-700">Permissions â€” Manage User Permissions</td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" checked class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="admin" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="manager" />
          </td>
          <td class="px-3 py-2 text-center">
            <input type="checkbox" class="rounded border-slate-300 text-brand-500 permission-checkbox" 
                   data-feature="permissions-manage" data-role="viewer" />
          </td>
        </tr>

      </tbody>
    </table>
  </div>

  <p class="mt-4 text-xs text-slate-500">
    ğŸ’¡ <strong>Auto-save enabled:</strong> Permission changes are saved automatically to the database and logged in the audit trail.
  </p>
</div>

<!-- Audit Log (Optional - can be added later) -->
<div class="bg-white rounded-2xl shadow-subtle border border-slate-100 p-4">
  <h3 class="font-heading text-sm text-slate-900 mb-3">
    Permission Changes Audit Log
  </h3>
  <p class="text-xs text-slate-600 mb-4">
    Track all permission modifications for compliance and security review.
  </p>
  <div class="overflow-x-auto">
    <table class="w-full text-xs">
      <thead>
        <tr class="border-b-2 border-slate-200">
          <th class="px-3 py-2 text-left font-heading text-slate-700">Timestamp</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Action</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">User Affected</th>
          <th class="px-3 py-2 text-left font-heading text-slate-700">Changed By</th>
        </tr>
      </thead>
      <tbody id="permissions-audit-log" class="divide-y divide-slate-100">
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      </tbody>
    </table>
  </div>
</div>


<!-- ğŸ‘† END OF PERMISSIONS TAB -->

</div>
<!-- ğŸ‘† END OF TAB CONTAINER -->
</main>
<!-- ğŸ‘† END OF MAIN -->

</div>
<!-- ğŸ‘† END OF APP ROOT -->

<!-- ============================================================================ -->
<!-- ğŸ¯ MODAL MUST BE HERE - OUTSIDE ALL SECTIONS, OUTSIDE MAIN, INSIDE BODY -->
<!-- ============================================================================ -->

<!-- Warning Details Modal - FIXED FOOTER VERSION -->
<div id="warning-detail-modal" class="hidden fixed inset-0 z-[9999] overflow-y-auto" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Background overlay -->
    <div class="fixed inset-0 bg-slate-900 bg-opacity-75 transition-opacity" aria-hidden="true"></div>

    <!-- Modal panel with FIXED structure -->
    <div class="inline-block align-bottom bg-white rounded-2xl text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-4xl sm:w-full max-h-[90vh] flex flex-col">
      
      <!-- FIXED HEADER -->
      <div class="bg-white px-6 pt-5 pb-4 border-b border-slate-200 flex-shrink-0">
        <div class="flex items-start justify-between">
          <div>
            <h3 class="text-lg font-heading font-bold text-slate-900" id="modal-title">
              Edit Disciplinary Action
            </h3>
            <p class="mt-1 text-xs text-slate-500">
              Update action details and save changes
            </p>
          </div>
          
          <!-- WARNING COUNTER (Top Right) -->
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-end gap-1">
              <div class="flex items-center gap-2 text-xs">
                <span class="inline-flex items-center gap-1 rounded-full bg-emerald-50 border border-emerald-200 px-2 py-1 text-emerald-700 font-bold">
                  <i class="fa-solid fa-message text-[0.60rem]"></i>
                  <span id="modal-verbal-count">0</span> Verbal
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-amber-50 border border-amber-200 px-2 py-1 text-amber-700 font-bold">
                  <i class="fa-solid fa-file-lines text-[0.60rem]"></i>
                  <span id="modal-written-count">0</span> Written
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-orange-50 border border-orange-200 px-2 py-1 text-orange-700 font-bold">
                  <i class="fa-solid fa-triangle-exclamation text-[0.60rem]"></i>
                  <span id="modal-final-count">0</span> Final
                </span>
                <span class="inline-flex items-center gap-1 rounded-full bg-rose-50 border border-rose-200 px-2 py-1 text-rose-700 font-bold">
                  <i class="fa-solid fa-ban text-[0.60rem]"></i>
                  <span id="modal-termination-count">0</span> Term
                </span>
              </div>
            </div>
            
            <button type="button" id="close-warning-modal" class="rounded-lg text-slate-400 hover:text-slate-600 focus:outline-none">
              <i class="fa-solid fa-times text-xl"></i>
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden fields -->
      <input type="hidden" id="modal-action-employee-id" />
      <input type="hidden" id="modal-action-index" />

      <!-- SCROLLABLE BODY -->
      <div class="flex-1 overflow-y-auto px-6 py-4">
        <form id="modal-edit-form" class="space-y-4 text-sm">
          
          <!-- Employee Information (Read-only) -->
          <div class="bg-slate-50 rounded-lg p-3">
            <h4 class="text-xs font-bold text-slate-700 uppercase mb-2">Employee Information</h4>
            <div class="grid grid-cols-3 gap-3 text-xs">
              <div>
                <p class="text-slate-500 text-[0.70rem]">Name</p>
                <p class="font-bold text-slate-900" id="modal-employee-name">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Employee ID</p>
                <p class="font-bold text-slate-900" id="modal-employee-id">--</p>
              </div>
              <div>
                <p class="text-slate-500 text-[0.70rem]">Department</p>
                <p class="font-bold text-slate-900" id="modal-employee-dept">--</p>
              </div>
            </div>
          </div>

          <!-- Action Details - EDITABLE -->
          <div class="grid grid-cols-2 gap-4">
            <div>
              <label for="modal-edit-type" class="block text-xs font-bold text-slate-700 mb-1">
                Action Type
              </label>
              <select
                id="modal-edit-type"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="VERBAL_WARNING">Verbal Warning</option>
                <option value="WRITTEN_WARNING">Written Warning</option>
                <option value="FINAL_WARNING">Final Warning</option>
                <option value="TERMINATION">Termination</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-severity" class="block text-xs font-bold text-slate-700 mb-1">
                Severity
              </label>
              <select
                id="modal-edit-severity"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="LOW">Low</option>
                <option value="MEDIUM">Medium</option>
                <option value="HIGH">High</option>
              </select>
            </div>

            <div>
              <label for="modal-edit-date" class="block text-xs font-bold text-slate-700 mb-1">
                Date
              </label>
              <input
                type="date"
                id="modal-edit-date"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              />
            </div>

            <div>
              <label for="modal-edit-main-category" class="block text-xs font-bold text-slate-700 mb-1">
                Main Category
              </label>
              <select
                id="modal-edit-main-category"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              >
                <option value="">Select category...</option>
                <option value="attendance">Attendance & Punctuality</option>
                <option value="performance">Performance Issues</option>
                <option value="conduct">Conduct & Behavior</option>
                <option value="policy">Policy Violations</option>
                <option value="safety">Safety & Health</option>
                <option value="customer">Customer Service</option>
                <option value="integrity">Integrity & Honesty</option>
              </select>
            </div>
          </div>

          <!-- Sub-Category (Dynamic based on Main Category) -->
          <div>
            <label for="modal-edit-sub-category" class="block text-xs font-bold text-slate-700 mb-1">
              Sub-Category / Specific Issue
            </label>
            <select
              id="modal-edit-sub-category"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
            >
              <option value="">Select main category first...</option>
            </select>
          </div>

          <!-- Reason - EDITABLE -->
          <div>
            <label for="modal-edit-reason" class="block text-xs font-bold text-slate-700 mb-1">
              Reason for Action
            </label>
            <textarea
              id="modal-edit-reason"
              rows="4"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Describe the incident and policy violations..."
            ></textarea>
          </div>

          <!-- Corrective Action Plan - EDITABLE -->
          <div>
            <label for="modal-edit-plan" class="block text-xs font-bold text-slate-700 mb-1">
              Corrective Action Plan
            </label>
            <textarea
              id="modal-edit-plan"
              rows="3"
              class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
              placeholder="Outline expectations and improvement plan..."
            ></textarea>
          </div>

          <!-- Signatures - EDITABLE -->
          <div class="grid grid-cols-3 gap-3">
            <div>
              <label for="modal-edit-manager-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Manager Signature
              </label>
              <input
                type="text"
                id="modal-edit-manager-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Manager name"
              />
            </div>

            <div>
              <label for="modal-edit-hr-sig" class="block text-xs font-bold text-slate-700 mb-1">
                HR Signature
              </label>
              <input
                type="text"
                id="modal-edit-hr-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="HR representative"
              />
            </div>

            <div>
              <label for="modal-edit-employee-sig" class="block text-xs font-bold text-slate-700 mb-1">
                Employee Signature
              </label>
              <input
                type="text"
                id="modal-edit-employee-sig"
                class="w-full rounded-lg border border-slate-200 bg-white px-3 py-2 text-xs focus:outline-none focus:ring-2 focus:ring-brand-500"
                placeholder="Employee name or DECLINED"
              />
            </div>
          </div>

        </form>
      </div>

      <!-- FIXED FOOTER with buttons -->
      <div class="bg-white px-6 py-4 border-t border-slate-200 flex-shrink-0">
        <div class="flex justify-between items-center gap-3">
          <button 
            type="button" 
            id="modal-delete-btn" 
            class="inline-flex items-center gap-2 rounded-full border border-rose-300 bg-rose-50 px-4 py-2 text-xs font-semibold text-rose-700 hover:bg-rose-100 transition-colors"
          >
            <i class="fa-solid fa-trash"></i>
            Delete Action
          </button>

          <div class="flex gap-2">
            <button 
              type="button" 
              id="modal-close-btn" 
              class="inline-flex items-center gap-2 rounded-full border border-slate-300 bg-white px-4 py-2 text-xs font-semibold text-slate-700 hover:bg-slate-50 transition-colors"
            >
              Cancel
            </button>
            <button 
              type="button" 
              id="modal-export-pdf" 
              class="inline-flex items-center gap-2 rounded-full border border-brand-300 bg-white px-4 py-2 text-xs font-semibold text-brand-700 hover:bg-brand-50 transition-colors"
            >
              <i class="fa-solid fa-file-pdf"></i>
              Export PDF
            </button>
            <button 
  type="button" 
  id="modal-save-btn" 
  class="inline-flex items-center gap-2 rounded-full bg-brand-500 px-5 py-2 text-xs font-bold text-black shadow-sm hover:bg-brand-600 transition-colors"
>
  <i class="fa-solid fa-floppy-disk"></i>
  <span>Save Changes</span>
</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<!-- Toast Notification Container -->
<div id="toast-container" class="fixed top-4 right-4 z-50 space-y-2" aria-live="polite"></div>

<!-- Add footer before closing </body> tag -->
<footer class="bg-slate-100 border-t border-slate-200 py-6 mt-auto">
  <div class="max-w-7xl mx-auto px-4 text-center space-y-3">
    <!-- Disclaimer -->
    <p class="text-xs text-slate-600">
      <strong>Disclaimer:</strong> This system is for authorized HR personnel only. All data is confidential and protected under applicable employment laws.
    </p>
    <!-- Copyright & Credits -->
    <div class="flex flex-col sm:flex-row items-center justify-center gap-2 text-xs text-slate-500">
      <span>Â© 2026 Jeng Chi Restaurant. All rights reserved.</span>
      <span class="hidden sm:inline">â€¢</span>
      <span>Built by <strong class="text-slate-700">PG</strong></span>
    </div>
  </div>
</footer>

</body>
<!-- ğŸ‘† END OF BODY -->

<script>


  






        

      // ========================================================================
      // SUPABASE CLIENT INITIALIZATION
      // ========================================================================
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;


// ========================================================================
// ğŸ¯ ENHANCED CONSOLE LOGGING - START
// ========================================================================
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸš€ Jeng Chi HR Discipline Portal Starting...');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
console.log('ğŸ“ Supabase URL:', SUPABASE_URL);
console.log('âœ… Database client initialized');
console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
// ========================================================================
// ğŸ¯ ENHANCED CONSOLE LOGGING - END
// ========================================================================

// ========================================================================
// APPLICATION STATE
// ========================================================================



      // ========================================================================
// APPLICATION STATE
// ========================================================================
const AppState = {
  employees: [],
  selectedEmployee: null,
  employeeFilterStatus: 'all',
  currentTab: 'dashboard',
  charts: { // ğŸ‘ˆ This should already be here
    disciplineTrend: null,
    reportsByType: null,
    reportsByDept: null,
    reportsTrend: null,
    // Add dashboard chart references
    employeeStatusChart: null,
    actionsByTypeChart: null,
    trendChart: null
  },
  settings: {
    thresholds: { low: 2, medium: 5, high: 8 },
    points: { verbal: 1, written: 2, final: 3, termination: 4 },
    notifications: {
      highRisk: true,
      finalWarning: true,
      termination: true,
      dailySummary: false
    },
    display: {
      photos: true,
      compact: false,
      autoRefresh: false
    },
    retention: {
      discipline: 7,
      audit: 7
    }
  }
};



     // âœ… FIXED & ENHANCED POSITION MAP - NOW MATCHES YOUR CSV DATA
const positionMap = {
  // FOH Positions
  'foh manager': 'foh-manager',
  'front of house manager': 'foh-manager',
  'manager': 'foh-manager', // ğŸ‘ˆ ADDED: Maps "Manager" to FOH Manager
  'server': 'server',
  'bartender': 'bartender',
  'host': 'host',
  'hostess': 'host',
  'cashier': 'cashier',
  // BOH Positions
  'line cook': 'line-cook',
  'linecook': 'line-cook',
  'wok chef': 'wok-chef',
  'wok': 'wok-chef',
  'dumpling maker': 'dumpling-maker',
  'dumplings': 'dumpling-maker',
  'prep cook': 'prep-cook',
  'prep': 'prep-cook',
  'kitchen prep': 'prep-cook',
  'pastry chef': 'pastry-chef',
  'pastry': 'pastry-chef',
  'dishwasher': 'dishwasher',
  'dish': 'dishwasher',
  'busser': 'busser',
  'busboy': 'busser',
  'production manager': 'production-manager',
  'logistic coordinator': 'logistic-coordinator',
  'logistics': 'logistic-coordinator',
  'production manager': 'production-manager',
  'logistic coordinator': 'logistic-coordinator',
  // Also keep hyphenated & trailing-space versions for safety:
  'production-manager': 'production-manager',
  'logistic-coordinator': 'logistic-coordinator',
  'production manager ': 'production-manager',
  'logistic coordinator ': 'logistic-coordinator',
  // Add any other variations you find
  'server ': 'server', // ğŸ‘ˆ ADDED: Handles trailing space
  'wok chef ': 'wok-chef', // ğŸ‘ˆ ADDED: Handles trailing space
  'line cook ': 'line-cook', // ğŸ‘ˆ ADDED: Handles trailing space
  'bartender ': 'bartender', // ğŸ‘ˆ ADDED: Handles trailing space
  'host ': 'host', // ğŸ‘ˆ ADDED: Handles trailing space
  'cashier ': 'cashier', // ğŸ‘ˆ ADDED: Handles trailing space
  'dumpling maker ': 'dumpling-maker', // ğŸ‘ˆ ADDED: Handles trailing space
  'prep cook ': 'prep-cook', // ğŸ‘ˆ ADDED: Handles trailing space
  'pastry chef ': 'pastry-chef', // ğŸ‘ˆ ADDED: Handles trailing space
  'dishwasher ': 'dishwasher', // ğŸ‘ˆ ADDED: Handles trailing space
  'busser ': 'busser', // ğŸ‘ˆ ADDED: Handles trailing space
  'production manager ': 'production-manager', // ğŸ‘ˆ ADDED: Handles trailing space
  'logistic coordinator ': 'logistic-coordinator', // ğŸ‘ˆ ADDED: Handles trailing space
};



// âœ… Updated lists to match the fixed positionMap
const fohPositions = [
  'foh-manager', 'server', 'bartender', 'host', 'cashier'
];
const bohPositions = [
  'line-cook', 'wok-chef', 'dumpling-maker', 'prep-cook', 'pastry-chef',
  'dishwasher', 'production-manager', 'logistic-coordinator', 'busser'
];



      // Autocomplete state for search inputs
      const AutocompleteState = {
        discipline: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        },
        employees: {
          searchTimeout: null,
          currentQuery: '',
          selectedEmployeeId: null
        }
      };


// âœ… Safe updater â€” prevents "Cannot set properties of null"
function safeText(id, value, fallback = '--') {
  const el = document.getElementById(id);
  if (el) {
    el.textContent = value;
  } else {
    console.warn(`âš ï¸ Element #${id} not found`);
  }
}





      // ========================================================================
      // UTILITY FUNCTIONS
      // ========================================================================
// âœ… Get filtered actions based on global date filter
function getFilteredActions(filter = 'all-time') {
  let startDate = null;
  let endDate = null; // â† initialize as null, not `now`

  if (filter === 'custom') {
    const startVal = document.getElementById('custom-start-date')?.value;
    const endVal = document.getElementById('custom-end-date')?.value;
    if (startVal) startDate = new Date(startVal);
    if (endVal) endDate = new Date(endVal);
    if (startDate) startDate.setHours(0, 0, 0, 0);
    if (endDate) endDate.setHours(23, 59, 59, 999);
  } else if (filter === 'last-30' || filter === 'last-60' || filter === 'last-90') {
    const days = { 'last-30': 30, 'last-60': 60, 'last-90': 90 }[filter];
    const now = new Date();
    startDate = new Date(now.getTime() - days * 24 * 60 * 60 * 1000);
    startDate.setHours(0, 0, 0, 0);
    endDate = now;
    endDate.setHours(23, 59, 59, 999);
  } else if (filter === 'ytd') {
    const now = new Date();
    startDate = new Date(now.getFullYear(), 0, 1);
    startDate.setHours(0, 0, 0, 0);
    endDate = now;
    endDate.setHours(23, 59, 59, 999);
  }
  // For 'all-time', startDate & endDate remain null â†’ no filtering

  const actions = [];
  AppState.employees.forEach(emp => {
    const history = emp.discipline_history || [];
    history.forEach(action => {
      const d = new Date(action.date);
      // âœ… Only filter if startDate/endDate are set
      if (
        (!startDate || d >= startDate) &&
        (!endDate || d <= endDate)
      ) {
        actions.push({
          ...action,
          employeeName: `${emp.first_name || ''} ${emp.last_name || ''}`.trim() || 'Unknown',
          department: emp.department || 'Unassigned',
          jobTitle: emp.job_title || emp.position_title || 'N/A'
        });
      }
    });
  });
  return actions;
}




      
    function formatDate(dateString) {
  if (!dateString) return '--';
  const date = new Date(dateString);
  return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}

// âœ… ADD THIS â€” GLOBAL SCOPE, BEFORE ANY FUNCTION THAT CALLS IT
function calculateTenure(hireDate) {
  if (!hireDate) return '--';
  const hire = new Date(hireDate);
  if (isNaN(hire.getTime())) return '--';
  const now = new Date();
  const diffDays = Math.floor(Math.abs(now - hire) / (1000 * 60 * 60 * 24));
  const years = Math.floor(diffDays / 365);
  const months = Math.floor((diffDays % 365) / 30);
  const yearStr = years === 1 ? 'year' : 'years';
  const monthStr = months === 1 ? 'month' : 'months';
  if (years > 0) {
    return `${years} ${yearStr}, ${months} ${monthStr}`;
  }
  return `${months} ${monthStr}`;
}

// âœ… ADD THIS FUNCTION HERE â€” BEFORE ANY CALLS TO IT
function setupDepartmentJobTitleCascade() {
  const deptDropdown = document.getElementById('edit-department');
  const jobTitleDropdown = document.getElementById('edit-job-title');
  
  if (!deptDropdown || !jobTitleDropdown) return;
  
  deptDropdown.addEventListener('change', (e) => {
    const department = e.target.value;
    
    // Clear job title dropdown
    jobTitleDropdown.innerHTML = '<option value="">Select job title...</option>';
    
    if (department && JOB_TITLES_BY_DEPARTMENT[department]) {
      // Populate with department-specific titles
      JOB_TITLES_BY_DEPARTMENT[department].forEach(title => {
        const option = document.createElement('option');
        option.value = title;
        option.textContent = title;
        jobTitleDropdown.appendChild(option);
      });
      jobTitleDropdown.disabled = false;
    } else {
      jobTitleDropdown.disabled = true;
      jobTitleDropdown.innerHTML = '<option value="">Select department first...</option>';
    }
  });
}



      function computeRiskScore(employee) {
        const { verbal_warning_count = 0, disciplinary_warning_count = 0, final_warning_count = 0, termination_letter_count = 0 } = employee;
        const { points } = AppState.settings;
        return (
          verbal_warning_count * points.verbal +
          disciplinary_warning_count * points.written +
          final_warning_count * points.final +
          termination_letter_count * points.termination
        );
      }

// âœ… Render editable employee grid
// âœ… Render editable employee grid
function renderEmployeeGrid() {
  if (!AppState.employees || AppState.employees.length === 0) {
  console.warn('âš ï¸ No employee data â€” skipping grid render');
  return;
}
  const tbody = document.getElementById('employee-grid-body');
  const loading = document.getElementById('employee-grid-loading');
  const empty = document.getElementById('employee-grid-empty');

  // âœ… Critical safety: abort if tbody missing
  if (!tbody) {
    console.error('âŒ employee-grid-body not found â€” check HTML');
    return;
  }

  // Show loading
  if (loading) loading.classList.remove('hidden');
  if (empty) empty.classList.add('hidden');
  tbody.innerHTML = '';

  try {
    // Apply filter
    const statusFilter = document.getElementById('employee-grid-filter-status')?.value || 'all';
    let employees = AppState.employees || [];
    if (statusFilter !== 'all') {
      employees = employees.filter(e => e.employment_status === statusFilter);
    }

    // Hide loading
    if (loading) loading.classList.add('hidden');

    if (employees.length === 0) {
      if (empty) empty.classList.remove('hidden');
      return;
    }
    if (empty) empty.classList.add('hidden');

    // Render rows
    employees.forEach(emp => {
      const row = document.createElement('tr');
      row.className = 'hover:bg-slate-50 transition-colors';
      row.innerHTML = `
        <td class="px-3 py-2 text-xs font-mono">${emp.employee_id || '--'}</td>
        <td class="px-3 py-2">${emp.employment_status || 'Active'}</td>
        <td class="px-3 py-2 font-medium">${emp.first_name || ''} ${emp.last_name || ''}</td>
        <td class="px-3 py-2 text-xs">${emp.original_hire_date ? emp.original_hire_date.split('T')[0] : '--'}</td>
        <td class="px-3 py-2 text-xs">${emp.job_title || '--'} / ${emp.department || '--'}</td>
        <td class="px-3 py-2 text-xs">${emp.primary_phone || '--'}<br>${emp.email || '--'}</td>
        <td class="px-3 py-2 text-xs">${emp.compensation_type === 'salary' ? `$${emp.annual_salary || 0}/yr` : `$${emp.hourly_rate || 0}/hr`}</td>
        <td class="px-3 py-2 text-right">
          <span class="inline-flex items-center gap-1 text-xs font-bold ${emp.risk_level === 'HIGH' ? 'text-rose-600' : emp.risk_level === 'MEDIUM' ? 'text-amber-600' : 'text-emerald-600'}">
            ${emp.risk_score || 0}
          </span>
        </td>
      `;
      tbody.appendChild(row);
    });

    console.log(`âœ… Rendered ${employees.length} employees in grid`);
  } catch (err) {
    console.error('ğŸ’¥ renderEmployeeGrid failed:', err);
    showToast('Failed to load employee grid', 'error');
  }
}



// âœ… Auto-save on edit
function setupGridAutoSave() {
  document.querySelectorAll('.employee-grid-edit').forEach(input => {
    input.addEventListener('blur', saveGridCell);
    input.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') saveGridCell(e);
    });
  });

  document.querySelectorAll('.employee-grid-save').forEach(btn => {
    btn.addEventListener('click', (e) => {
      const id = e.target.closest('button').dataset.id;
      saveEmployeeById(id);
    });
  });
}  // â¬…ï¸ This closing brace is fine

// âœ… Save single cell or full row
async function saveGridCell(e) {
  const input = e.target;
  const id = input.dataset.id;
  const field = input.dataset.field;
  const value = input.type === 'checkbox' ? input.checked : input.value;

  // Skip if unchanged
  const employee = AppState.employees.find(e => e.id == id);
  if (!employee) return;
  if (employee[field] === value) return;

  try {
    // Optimistic UI update
    input.classList.add('bg-emerald-100');

    // Save to DB
    const { error } = await supabaseClient
      .from('employees2025')
      .update({ [field]: value })
      .eq('id', id);

    if (error) throw error;

    // Update AppState
    const idx = AppState.employees.findIndex(e => e.id == id);
    if (idx >= 0) {
      AppState.employees[idx][field] = value;
    }

    // Recalculate risk if needed
    if (['verbal_warning_count', 'disciplinary_warning_count', 'final_warning_count', 'termination_letter_count'].includes(field)) {
      const score = computeRiskScore(AppState.employees[idx]);
      AppState.employees[idx].risk_score = score;
      AppState.employees[idx].risk_level = getRiskLevel(score);
    }

    input.classList.remove('bg-emerald-100');
    input.classList.add('bg-emerald-50');
    setTimeout(() => input.classList.remove('bg-emerald-50'), 1000);

    showToast(`âœ… ${field} updated`, 'success');

  } catch (err) {
    console.error('Save failed:', err);
    input.classList.remove('bg-emerald-100');
    input.classList.add('bg-rose-100');
    showToast(`âŒ Failed to save ${field}`, 'error');
  }
}  // â¬…ï¸ This closing brace is fine

// âœ… Refresh button
document.getElementById('employee-grid-refresh')?.addEventListener('click', async () => {
  await loadEmployees();
  renderEmployeeGrid();
});

// âœ… Filter change
document.getElementById('employee-grid-filter-status')?.addEventListener('change', renderEmployeeGrid);

// âœ… Filter change
document.getElementById('employee-grid-filter-status')?.addEventListener('change', renderEmployeeGrid);


      function getRiskLevel(score) {
        const { thresholds } = AppState.settings;
        if (score >= thresholds.high) return 'HIGH';
        if (score >= thresholds.medium) return 'MEDIUM';
        return 'LOW';
      }

      function getRiskBadgeClasses(level) {
        switch (level) {
          case 'HIGH':
            return 'bg-rose-50 border-rose-200 text-rose-700';
          case 'MEDIUM':
            return 'bg-amber-50 border-amber-200 text-amber-700';
          default:
            return 'bg-emerald-50 border-emerald-200 text-emerald-700';
        }
      }

      function showToast(message, type = 'info') {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        const bgColor = type === 'success' ? 'bg-emerald-500' : type === 'error' ? 'bg-rose-500' : 'bg-brand-500';
        toast.className = `${bgColor} text-white px-4 py-3 rounded-xl shadow-lg text-sm flex items-center gap-2`;
        toast.innerHTML = `
          <i class="fa-solid fa-circle-info"></i>
          <span>${message}</span>
        `;
        container.appendChild(toast);
        setTimeout(() => {
          toast.classList.add('opacity-0', 'transition-opacity', 'duration-300');
          setTimeout(() => toast.remove(), 300);
        }, 3000);
      }

      // ========================================================================
      // TAB SWITCHING
      // ========================================================================
      
   function showTab(tabName) {
  console.log('ğŸ”„ Switching to tab:', tabName);

  // âœ… Hide all tab panels
  document.querySelectorAll('.tab-panel').forEach(panel => {
    panel.classList.add('hidden');
  });

  // âœ… Reset all tab buttons to inactive
  document.querySelectorAll('.tab-trigger').forEach(btn => {
    btn.classList.remove('bg-blue-50', 'text-blue-700', 'border-blue-300');
    btn.classList.add('bg-white', 'text-slate-600', 'border-slate-200');
    const icon = btn.querySelector('i');
    if (icon) icon.classList.remove('text-blue-600');
  });

  // âœ… Activate target tab panel
  const targetPanel = document.getElementById(`tab-${tabName}`);
  if (targetPanel) {
    targetPanel.classList.remove('hidden');
  }

  // âœ… Activate target tab button
  const targetButton = document.querySelector(`[data-tab-target="${tabName}"]`);
  if (targetButton) {
    targetButton.classList.remove('bg-white', 'text-slate-600', 'border-slate-200');
    targetButton.classList.add('bg-blue-50', 'text-blue-700', 'border-blue-300');
    const icon = targetButton.querySelector('i');
    if (icon) icon.classList.add('text-blue-600');
  }

  // âœ… If switching to dashboard, update KPIs
  if (tabName === 'dashboard') {
    updateDashboardKPIs(); // âœ… Ensure KPIs are fresh when user opens dashboard
  }
}



      // ========================================================================
      // EMPLOYEE DATA LOADING
      // ========================================================================
      
    async function loadEmployees() {
  console.log('');
  console.log('ğŸ“Š DATABASE OPERATION: Loading Employees');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ğŸ”„ Executing query: SELECT * FROM employees2025');

  try {
    const startTime = performance.now();

    const { data, error } = await supabaseClient
      .from('employees2025')
      .select('*')
      .order('last_name', { ascending: true });

    const endTime = performance.now();
    console.log(`â±ï¸  Query completed in ${(endTime - startTime).toFixed(2)}ms`);

    if (error) {
      console.error('âŒ DATABASE ERROR:', error);
      throw error;
    }

    // âœ… Store employees safely
    AppState.employees = Array.isArray(data) ? data : [];

    console.log(`âœ… SUCCESS: Loaded ${AppState.employees.length} employees`);

    // ğŸ”„ Update header timestamp
    const refreshEl = document.getElementById('header-last-refreshed');
    if (refreshEl) {
      const now = new Date();
      refreshEl.textContent = now.toLocaleString('en-US', {
        month: 'short',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    // âœ…âœ…âœ… CRITICAL FIX: Always update KPIs after loading data â€” regardless of tab visibility
    updateDashboardKPIs(); // ğŸ‘ˆ THIS LINE WAS MISSING

    // ğŸ§  Also update full dashboard if visible
    const dashboardTab = document.getElementById('tab-dashboard');
    if (dashboardTab && !dashboardTab.classList.contains('hidden')) {
      updateDashboard?.(); // re-renders charts
    }

    showToast(`Loaded ${AppState.employees.length} employees`, 'success');

    return AppState.employees;

  } catch (err) {
    console.error('ğŸ’¥ CRITICAL ERROR in loadEmployees()', err);
    showToast('Failed to load employees: ' + err.message, 'error');
    return [];
  }
}


      function filterEmployees(filterType) {
        AppState.employeeFilterStatus = filterType;
        
        let filtered = [...AppState.employees];
        
        if (filterType === 'Active') {
          filtered = filtered.filter(emp => emp.employment_status === 'Active');
        } else if (filterType === 'Terminated') {
          filtered = filtered.filter(emp => emp.employment_status === 'Terminated');
        } else if (filterType === 'HighRisk') {
          filtered = filtered.filter(emp => {
            const score = computeRiskScore(emp);
            return getRiskLevel(score) === 'HIGH';
          });
        }
        
        return filtered;
      }

      // ========================================================================
      // DASHBOARD TAB FUNCTIONS




      // ========================================================================







function updateDashboard() {
  const filter = document.getElementById('global-date-filter')?.value || 'all-time';
  const actions = getFilteredActions(filter);
  
  updateDashboardKPIs(actions); // âœ… pass `actions`
  populateDashboardWarningsByDept(actions);
  populateDashboardDisciplineList(actions);
  renderDashboardCharts(actions); // âœ… This will now work safely
}



// âœ… FINAL CORRECTED updateDashboardKPIs â€” NO duplicate loops, NO unsafe .textContent
// ========================================================================
// DASHBOARD KPIs - UPDATED FOR 3x3 GRID
// ========================================================================




function updateDashboardKPIs(actions = []) {
  // âœ… STEP 1: Filter out owners AND inactive employees
  const owners = ['janelle teng', 'francisco teng'];
  const activeNonOwners = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    const isOwner = owners.includes(fullName);
    const isActive = emp.employment_status?.toLowerCase() === 'active';
    return !isOwner && isActive;
  });

  // âœ… STEP 2: Active / Inactive counts - FIXED
  const activeCount = activeNonOwners.length;
  
  // Calculate REAL inactive count (non-owners who are not active)
  const inactiveCount = AppState.employees.filter(emp => {
    const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
    const isOwner = owners.includes(fullName);
    const isActive = emp.employment_status?.toLowerCase() === 'active';
    return !isOwner && !isActive; // â† NOT active = inactive
  }).length;
  
  safeText('kpi-active-employees', activeCount);
  safeText('kpi-inactive-employees', inactiveCount); // âœ… NOW SHOWS REAL COUNT

  // âœ… STEP 3: Position Counts - WITH DEBUGGING
  const positionCounts = {
    'foh-manager': 0, 'server': 0, 'bartender': 0, 'host': 0, 'cashier': 0,
    'line-cook': 0, 'wok-chef': 0, 'dumpling-maker': 0, 'prep-cook': 0,
    'pastry-chef': 0, 'dishwasher': 0, 'production-manager': 0,
    'logistic-coordinator': 0, 'busser': 0
  };

  const unmatchedEmployees = []; // â† TRACK UNMATCHED

  activeNonOwners.forEach(emp => {
    let title = (emp.job_title || '').trim();
    if (!title) {
      unmatchedEmployees.push({ name: `${emp.first_name} ${emp.last_name}`, reason: 'No job title', id: emp.employee_id });
      return;
    }
    title = title.toLowerCase();

    let mapped = positionMap[title];
    if (!mapped) mapped = positionMap[title.replace(/[-\s]+/g, ' ')];
    if (!mapped) {
      for (const [pattern, key] of Object.entries(positionMap)) {
        if (title.includes(pattern.replace(/\s+/g, ''))) {
          mapped = key;
          break;
        }
      }
    }
    
    if (mapped && positionCounts[mapped] !== undefined) {
      positionCounts[mapped]++;
    } else {
      unmatchedEmployees.push({ 
        name: `${emp.first_name} ${emp.last_name}`, 
        title: emp.job_title,
        reason: 'Job title not in positionMap',
        id: emp.employee_id 
      });
    }
  });

  // âœ… LOG UNMATCHED EMPLOYEES
  if (unmatchedEmployees.length > 0) {
    console.warn('âš ï¸ EMPLOYEES NOT COUNTED IN POSITION DISTRIBUTION:');
    console.table(unmatchedEmployees);
  }

  // Update position KPIs
  Object.keys(positionCounts).forEach(key => {
    safeText(`kpi-${key}`, positionCounts[key]);
  });

  // âœ… STEP 4: FOH / BOH Totals
  const fohPositions = ['foh-manager', 'server', 'bartender', 'host', 'cashier'];
  const bohPositions = ['line-cook', 'wok-chef', 'dumpling-maker', 'prep-cook', 'pastry-chef', 'dishwasher', 'production-manager', 'logistic-coordinator', 'busser'];
  const fohTotal = fohPositions.reduce((sum, p) => sum + positionCounts[p], 0);
  const bohTotal = bohPositions.reduce((sum, p) => sum + positionCounts[p], 0);
  safeText('kpi-foh-total', fohTotal);
  safeText('kpi-boh-total', bohTotal);

  // âœ… STEP 5: Discipline Counts (same as before)
  const fohDisciplines = { verbal: 0, written: 0, final: 0, termination: 0 };
  const bohDisciplines = { verbal: 0, written: 0, final: 0, termination: 0 };

  actions.forEach(action => {
    const emp = activeNonOwners.find(e => e.id == action.employee_id);
    if (!emp) return;

    const title = (emp.job_title || '').toLowerCase().trim();
    let mapped = positionMap[title] ||
                 positionMap[title.replace(/[-\s]+/g, ' ')] ||
                 Object.keys(positionMap).find(k => title.includes(k.replace(/\s+/g, '')))?.then(k => positionMap[k]);

    const isFOH = mapped && fohPositions.includes(mapped);
    const isBOH = mapped && bohPositions.includes(mapped);
    const target = isFOH ? fohDisciplines : isBOH ? bohDisciplines : null;
    if (!target) return;

    const type = (action.type || '').toLowerCase();
    if (type.includes('verbal')) target.verbal++;
    else if (type.includes('written')) target.written++;
    else if (type.includes('final')) target.final++;
    else if (type.includes('termination')) target.termination++;
  });

  safeText('kpi-foh-verbal', fohDisciplines.verbal);
  safeText('kpi-foh-written', fohDisciplines.written);
  safeText('kpi-foh-final', fohDisciplines.final);
  safeText('kpi-foh-termination', fohDisciplines.termination);
  safeText('kpi-boh-verbal', bohDisciplines.verbal);
  safeText('kpi-boh-written', bohDisciplines.written);
  safeText('kpi-boh-final', bohDisciplines.final);
  safeText('kpi-boh-termination', bohDisciplines.termination);

  // âœ… STEP 6: Compensation Summary (same as before)
  const salaryEmployees = activeNonOwners.filter(e => e.compensation_type === 'salary');
  const hourlyEmployees = activeNonOwners.filter(e => e.compensation_type === 'hourly');
  safeText('kpi-salary-count', salaryEmployees.length);
  safeText('kpi-hourly-count', hourlyEmployees.length);

  const avgHourly = hourlyEmployees.length > 0
    ? (hourlyEmployees.reduce((sum, e) => sum + (parseFloat(e.hourly_rate) || 0), 0) / hourlyEmployees.length).toFixed(2)
    : '0.00';
  const avgSalary = salaryEmployees.length > 0
    ? (salaryEmployees.reduce((sum, e) => sum + (parseFloat(e.annual_salary) || 0), 0) / salaryEmployees.length).toFixed(2)
    : '0.00';

  safeText('kpi-average-hourly-rate', `$${avgHourly}`);
  safeText('kpi-average-annual-salary', `$${avgSalary}`);

  // âœ… STEP 7: High-Risk
  const highRiskCount = activeNonOwners.filter(e => {
    const score = computeRiskScore(e);
    return getRiskLevel(score) === 'HIGH';
  }).length;
  safeText('kpi-high-risk-employees', highRiskCount);

  // âœ… STEP 8: Termination Rate
  const terminatedCount = AppState.employees.filter(e => {
    const fullName = `${e.first_name || ''} ${e.last_name || ''}`.trim().toLowerCase();
    return !owners.includes(fullName) && e.employment_status?.toLowerCase() === 'terminated';
  }).length;
  
  const totalCount = activeCount + terminatedCount + inactiveCount;
  const terminationRate = totalCount > 0
    ? ((terminatedCount / totalCount) * 100).toFixed(1)
    : '0.0';
  safeText('kpi-termination-rate', `${terminationRate}%`);

  console.log('âœ… Dashboard KPIs updated:', {
    active: activeCount,
    inactive: inactiveCount,
    terminated: terminatedCount,
    foh: fohTotal,
    boh: bohTotal,
    total: activeCount,
    unmatched: unmatchedEmployees.length
  });
}









    function populateDashboardWarningsByDept(actions) {
  const tbody = document.getElementById('table-dashboard-warnings-by-dept');
  if (!tbody) return;
  tbody.innerHTML = '';
  const deptMap = {};
  actions.forEach(action => {
    const dept = action.department || 'Unassigned';
    if (!deptMap[dept]) deptMap[dept] = { V: 0, W: 0, F: 0, T: 0 };
    const type = (action.type || '').toUpperCase();
    if (type.includes('VERBAL')) deptMap[dept].V++;
    else if (type.includes('WRITTEN')) deptMap[dept].W++;
    else if (type.includes('FINAL')) deptMap[dept].F++;
    else if (type.includes('TERMINATION')) deptMap[dept].T++;
  });
  Object.entries(deptMap).forEach(([dept, counts]) => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-2 py-2 font-medium">${dept}</td>
      <td class="px-2 py-2 text-center">${counts.V}</td>
      <td class="px-2 py-2 text-center">${counts.W}</td>
      <td class="px-2 py-2 text-center">${counts.F}</td>
      <td class="px-2 py-2 text-center">${counts.T}</td>
    `;
    tbody.appendChild(row);
  });
}








    function populateDashboardDisciplineList(actions) {
  const tbody = document.getElementById('dashboard-discipline-table-body');
  if (!tbody) return;
  tbody.innerHTML = '';
  const recent = actions.slice(0, 10).reverse();
  if (recent.length === 0) {
    tbody.innerHTML = `<tr><td colspan="3" class="px-2 py-3 text-center text-slate-500">No actions in selected range</td></tr>`;
    return;
  }
  recent.forEach(a => {
    const row = document.createElement('tr');
    const date = new Date(a.date);
    row.innerHTML = `
      <td class="px-2 py-2 text-slate-600">${date.toLocaleDateString()}</td>
      <td class="px-2 py-2 text-slate-900 font-medium">${a.employeeName}</td>
      <td class="px-2 py-2 text-slate-700">${a.type || 'â€”'}</td>
    `;
    tbody.appendChild(row);
  });
}

// ========================================================================
// MODAL FUNCTIONS - EDITABLE VERSION
// ========================================================================

// Show modal with action data (FAST VERSION - no database calls)
function showWarningDetailModal(action) {
  console.log('ğŸ¯ Opening modal for action:', action);
  
  const modal = document.getElementById('warning-detail-modal');
  if (!modal) {
    console.error('âŒ Modal element not found!');
    return;
  }
  
  // Store IDs for save operation
  document.getElementById('modal-action-employee-id').value = action.employeeId;
  document.getElementById('modal-action-index').value = action.originalIndex || 0;
  
  // Populate read-only employee info
  document.getElementById('modal-employee-name').textContent = action.employeeName;
  document.getElementById('modal-employee-id').textContent = action.employeeNumber || 'N/A';
  document.getElementById('modal-employee-dept').textContent = action.department;
  
  // âœ… POPULATE WARNING COUNTERS
  const employee = AppState.employees.find(e => e.id === action.employeeId);
  if (employee) {
    document.getElementById('modal-verbal-count').textContent = employee.verbal_warning_count || 0;
    document.getElementById('modal-written-count').textContent = employee.disciplinary_warning_count || 0;
    document.getElementById('modal-final-count').textContent = employee.final_warning_count || 0;
    document.getElementById('modal-termination-count').textContent = employee.termination_letter_count || 0;
  }
  
  // Populate editable fields
  const actionType = action.type?.toUpperCase().replace(/\s+/g, '_') || 'VERBAL_WARNING';
  document.getElementById('modal-edit-type').value = actionType;
  
  document.getElementById('modal-edit-severity').value = action.severity || 'MEDIUM';
  
  // Fix date format
  let dateValue = '';
  if (action.date) {
    const d = new Date(action.date);
    if (!isNaN(d.getTime())) {
      dateValue = d.toISOString().split('T')[0];
    }
  }
  document.getElementById('modal-edit-date').value = dateValue;
  
  // âœ… Populate category fields
  document.getElementById('modal-edit-main-category').value = action.main_category || '';
  
  // Trigger sub-category population
  const mainCategoryDropdown = document.getElementById('modal-edit-main-category');
  const event = new Event('change');
  mainCategoryDropdown.dispatchEvent(event);
  
  // Set sub-category after options are loaded
  setTimeout(() => {
    document.getElementById('modal-edit-sub-category').value = action.sub_category || '';
  }, 10);
  
  document.getElementById('modal-edit-reason').value = action.reason || '';
  document.getElementById('modal-edit-plan').value = action.corrective_plan || '';
  document.getElementById('modal-edit-manager-sig').value = action.manager_signature || '';
  document.getElementById('modal-edit-hr-sig').value = action.hr_signature || '';
  document.getElementById('modal-edit-employee-sig').value = action.employee_signature || '';
  
  // Show modal
  modal.classList.remove('hidden');
  document.body.style.overflow = 'hidden';
  
  console.log('âœ… Modal opened successfully');
}



// Close modal
function closeWarningModal() {
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.classList.add('hidden');
    document.body.style.overflow = '';
  }
}

// Save updated action to database
async function saveWarningModal() {
  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const saveBtn = document.getElementById('modal-save-btn');
  saveBtn.disabled = true;
  saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

 // Get updated values from form
const updatedAction = {
  type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
  date: document.getElementById('modal-edit-date').value,
  severity: document.getElementById('modal-edit-severity').value,
  main_category: document.getElementById('modal-edit-main-category').value,  // â† ADD
  sub_category: document.getElementById('modal-edit-sub-category').value,    // â† ADD
  reason: document.getElementById('modal-edit-reason').value,
  corrective_plan: document.getElementById('modal-edit-plan').value,
  manager_signature: document.getElementById('modal-edit-manager-sig').value,
  hr_signature: document.getElementById('modal-edit-hr-sig').value,
  employee_signature: document.getElementById('modal-edit-employee-sig').value,
  timestamp: employee.discipline_history?.[actionIndex]?.timestamp || new Date().toISOString()
};
    // Update the specific action in history array
    const history = [...(employee.discipline_history || [])];
    if (actionIndex >= 0 && actionIndex < history.length) {
      history[actionIndex] = updatedAction;
    }

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history[history.length - 1]
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('âœ… Action updated successfully!', 'success');
    closeWarningModal();
    
    // Reload data and refresh display
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error saving action:', error);
    showToast('âŒ Failed to save changes', 'error');
  } finally {
    saveBtn.disabled = false;
    saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> Save Changes';
  }
}

// Delete action from database
async function deleteWarningModal() {
  if (!confirm('Are you sure you want to delete this disciplinary action? This cannot be undone.')) {
    return;
  }

  const employeeId = document.getElementById('modal-action-employee-id').value;
  const actionIndex = parseInt(document.getElementById('modal-action-index').value);
  
  if (!employeeId) {
    showToast('Error: No employee ID found', 'error');
    return;
  }

  const deleteBtn = document.getElementById('modal-delete-btn');
  deleteBtn.disabled = true;
  deleteBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Deleting...';

  try {
    // Get current employee data
    const { data: employee, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

    // Remove action from history
    const history = [...(employee.discipline_history || [])];
    history.splice(actionIndex, 1);

    // Recalculate counts
    const counts = {
      verbal_warning_count: 0,
      disciplinary_warning_count: 0,
      final_warning_count: 0,
      termination_letter_count: 0
    };

    history.forEach(action => {
      const type = action.type.toUpperCase();
      if (type.includes('VERBAL')) counts.verbal_warning_count++;
      else if (type.includes('WRITTEN')) counts.disciplinary_warning_count++;
      else if (type.includes('FINAL')) counts.final_warning_count++;
      else if (type.includes('TERMINATION')) counts.termination_letter_count++;
    });

    // Update database
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update({
        discipline_history: history,
        last_disciplinary_action: history.length > 0 ? history[history.length - 1] : null,
        ...counts
      })
      .eq('id', employeeId);

    if (updateError) throw updateError;

    showToast('âœ… Action deleted successfully', 'success');
    closeWarningModal();
    
    // Reload data
    await loadEmployees();
    populateDashboardDisciplineList();

  } catch (error) {
    console.error('Error deleting action:', error);
    showToast('âŒ Failed to delete action', 'error');
  } finally {
    deleteBtn.disabled = false;
    deleteBtn.innerHTML = '<i class="fa-solid fa-trash"></i> Delete Action';
  }
}

// Generate PDF from modal data
function generateWarningPDF() {
  const action = {
    employeeName: document.getElementById('modal-employee-name').textContent,
    employeeNumber: document.getElementById('modal-employee-id').textContent,
    department: document.getElementById('modal-employee-dept').textContent,
    type: document.getElementById('modal-edit-type').value.replace(/_/g, ' '),
    date: document.getElementById('modal-edit-date').value,
    severity: document.getElementById('modal-edit-severity').value,
    reference: document.getElementById('modal-edit-reference').value,
    reason: document.getElementById('modal-edit-reason').value,
    corrective_plan: document.getElementById('modal-edit-plan').value,
    manager_signature: document.getElementById('modal-edit-manager-sig').value,
    hr_signature: document.getElementById('modal-edit-hr-sig').value,
    employee_signature: document.getElementById('modal-edit-employee-sig').value
  };

  const actionDate = new Date(action.date);
  const dateStr = actionDate.toLocaleDateString('en-US', { 
    month: 'long', 
    day: 'numeric', 
    year: 'numeric' 
  });
  
  const content = `
    <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px; margin: 0 auto;">
      <div style="text-align: center; margin-bottom: 30px; border-bottom: 3px solid #7a1f1f; padding-bottom: 20px;">
        <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
        <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
      </div>
      
      <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
        <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
        <p><strong>Name:</strong> ${action.employeeName}</p>
        <p><strong>Employee ID:</strong> ${action.employeeNumber}</p>
        <p><strong>Department:</strong> ${action.department}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Action Details</h3>
        <p><strong>Action Type:</strong> ${action.type}</p>
        <p><strong>Date:</strong> ${dateStr}</p>
        <p><strong>Severity:</strong> ${action.severity}</p>
        <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
      </div>
      
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Reason for Action</h3>
        <p style="white-space: pre-wrap;">${action.reason || 'No reason provided'}</p>
      </div>
      
      ${action.corrective_plan ? `
      <div style="margin-bottom: 20px;">
        <h3 style="color: #333;">Corrective Action Plan</h3>
        <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
      </div>
      ` : ''}
      
      <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
        <h3 style="color: #333;">Signatures</h3>
        <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
        <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
        <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
      </div>
    </div>
  `;

  const element = document.createElement('div');
  element.innerHTML = content;
  
  html2pdf()
    .from(element)
    .set({
      margin: 0.5,
      filename: `warning-${action.employeeNumber}-${action.date}.pdf`,
      html2canvas: { scale: 2 },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    })
    .save();
}



// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================
const DISCIPLINE_CATEGORIES = {
  attendance: [
    { value: 'late', label: 'Late Arrival' },
    { value: 'early-leave', label: 'Early Departure' },
    { value: 'no-call-no-show', label: 'No Call / No Show' },
    { value: 'excessive-absences', label: 'Excessive Absences' },
    { value: 'unapproved-absence', label: 'Unapproved Absence' },
    { value: 'break-violation', label: 'Extended Breaks' }
  ],
  performance: [
    { value: 'quality', label: 'Work Quality Below Standard' },
    { value: 'productivity', label: 'Low Productivity' },
    { value: 'missed-deadline', label: 'Missed Deadlines' },
    { value: 'failure-to-follow', label: 'Failure to Follow Instructions' },
    { value: 'incomplete-tasks', label: 'Incomplete Tasks' }
  ],
  conduct: [
    { value: 'unprofessional', label: 'Unprofessional Behavior' },
    { value: 'disrespectful', label: 'Disrespectful to Staff/Management' },
    { value: 'inappropriate-language', label: 'Inappropriate Language' },
    { value: 'conflict', label: 'Conflict with Coworkers' },
    { value: 'insubordination', label: 'Insubordination' },
    { value: 'horseplay', label: 'Horseplay / Roughhousing' }
  ],
  policy: [
    { value: 'uniform', label: 'Uniform Violation' },
    { value: 'cell-phone', label: 'Cell Phone / Earbuds Use' },
    { value: 'eating-drinking', label: 'Eating/Drinking in Wrong Area' },
    { value: 'smoking', label: 'Smoking/Vaping Violation' },
    { value: 'unauthorized-discount', label: 'Unauthorized Discount/Comp' },
    { value: 'confidentiality', label: 'Confidentiality Breach' },
    { value: 'social-media', label: 'Social Media Policy Violation' }
  ],
  safety: [
    { value: 'food-safety', label: 'Food Safety Violation' },
    { value: 'sanitation', label: 'Sanitation/Cleanliness Issue' },
    { value: 'unsafe-practice', label: 'Unsafe Work Practice' },
    { value: 'equipment-misuse', label: 'Equipment Misuse' },
    { value: 'injury-report', label: 'Failure to Report Injury' }
  ],
  customer: [
    { value: 'rude-to-guest', label: 'Rude to Guest' },
    { value: 'poor-service', label: 'Poor Service Quality' },
    { value: 'order-error', label: 'Repeated Order Errors' },
    { value: 'complaint', label: 'Guest Complaint' },
    { value: 'refusal-to-serve', label: 'Refusal to Serve Guest' }
  ],
  integrity: [
    { value: 'theft', label: 'Theft' },
    { value: 'dishonesty', label: 'Dishonesty / Lying' },
    { value: 'timecard-fraud', label: 'Timecard Fraud' },
    { value: 'tip-theft', label: 'Tip Theft / Manipulation' },
    { value: 'falsifying-records', label: 'Falsifying Records' }
  ]
};





// Attach modal event listeners (call this in bootstrap)
function setupModalEventListeners() {
  console.log('ğŸ¯ Setting up modal event listeners...');
  setupCategoryDropdowns();
  
  const closeBtn = document.getElementById('close-warning-modal');
  const closeBtnFooter = document.getElementById('modal-close-btn');
  const saveBtn = document.getElementById('modal-save-btn');
  const deleteBtn = document.getElementById('modal-delete-btn');
  const exportBtn = document.getElementById('modal-export-pdf');
  
  
  if (closeBtn) {
    closeBtn.addEventListener('click', closeWarningModal);
    console.log('âœ… Close button (X) listener attached');
  }
  
  if (closeBtnFooter) {
    closeBtnFooter.addEventListener('click', closeWarningModal);
    console.log('âœ… Cancel button listener attached');
  }
  
  if (saveBtn) {
    saveBtn.addEventListener('click', saveWarningModal);
    console.log('âœ… Save button listener attached');
  } else {
    console.error('âŒ Save button NOT FOUND!');
  }
  
  if (deleteBtn) {
    deleteBtn.addEventListener('click', deleteWarningModal);
    console.log('âœ… Delete button listener attached');
  }
  
  if (exportBtn) {
    exportBtn.addEventListener('click', generateWarningPDF);
    console.log('âœ… Export PDF button listener attached');
  }
  
  // Close on background click
  const modal = document.getElementById('warning-detail-modal');
  if (modal) {
    modal.addEventListener('click', (e) => {
      if (e.target === modal) {
        closeWarningModal();
      }
    });
    console.log('âœ… Background click listener attached');
  }
}

// ========================================================================
// CATEGORY SYSTEM - SUB-CATEGORIES BASED ON MAIN CATEGORY
// ========================================================================


// Setup dynamic sub-category dropdown
function setupCategoryDropdowns() {
  const mainCategory = document.getElementById('modal-edit-main-category');
  const subCategory = document.getElementById('modal-edit-sub-category');
  
  if (!mainCategory || !subCategory) return;
  
  mainCategory.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategory.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategory.appendChild(option);
      });
      subCategory.disabled = false;
    } else {
      subCategory.disabled = true;
      subCategory.innerHTML = '<option value="">Select main category first...</option>';
    }
  });
}




    function generate12MonthChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;

  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      pointBorderColor: '#fff',
      pointBorderWidth: 2,
      tension: 0.4,
      fill: true
    }
  ];

  // Try to get data from discipline_history
  let hasHistoryData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history) && emp.discipline_history.length > 0) {
      emp.discipline_history.forEach(action => {
        hasHistoryData = true;
        const actionDate = new Date(action.date);
        const monthStr = actionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
        const monthIndex = months.indexOf(monthStr);
        
        if (monthIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING':
              datasets[0].data[monthIndex]++; 
              break;
            case 'WRITTEN_WARNING':
              datasets[1].data[monthIndex]++; 
              break;
            case 'FINAL_WARNING':
              datasets[2].data[monthIndex]++; 
              break;
            case 'TERMINATION':
              datasets[3].data[monthIndex]++; 
              break;
          }
        }
      });
    }
  });

  // If no history data, aggregate current counts in current month
  if (!hasHistoryData) {
    const currentMonthIndex = 11; // Last month in array
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentMonthIndex] = totalVerbal;
    datasets[1].data[currentMonthIndex] = totalWritten;
    datasets[2].data[currentMonthIndex] = totalFinal;
    datasets[3].data[currentMonthIndex] = totalTermination;
    
    console.log('ğŸ“Š Chart Data (Current Month):', {
      verbal: totalVerbal,
      written: totalWritten,
      final: totalFinal,
      termination: totalTermination
    });
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: {
        mode: 'index',
        intersect: false,
      },
      plugins: {
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: { 
          enabled: true,
          mode: 'index', 
          intersect: false,
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          bodyFont: {
            size: 13,
            weight: 'bold',
            family: "'Inter', sans-serif"
          },
          titleColor: '#fff',
          bodyColor: '#fff',
          borderColor: 'rgba(255, 255, 255, 0.2)',
          borderWidth: 1
        }
      },
      scales: {
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            padding: 8
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)',
            drawBorder: false
          },
          title: {
            display: true,
            text: 'Number of Actions',
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        x: {
          grid: {
            display: false,
            drawBorder: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

function generateYearlyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const currentYear = new Date().getFullYear();
  const years = [currentYear - 4, currentYear - 3, currentYear - 2, currentYear - 1, currentYear].map(String);
  
  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#10b981',
      borderColor: '#10b981',
      borderWidth: 2
    },
    { 
      label: 'Written Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#f59e0b',
      borderColor: '#f59e0b',
      borderWidth: 2
    },
    { 
      label: 'Final Warnings', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#ef4444',
      borderColor: '#ef4444',
      borderWidth: 2
    },
    { 
      label: 'Terminations', 
      data: [0, 0, 0, 0, 0], 
      backgroundColor: '#991b1b',
      borderColor: '#991b1b',
      borderWidth: 2
    }
  ];

  // Try to get data from history
  let hasData = false;
  AppState.employees.forEach(emp => {
    if (emp.discipline_history && Array.isArray(emp.discipline_history)) {
      emp.discipline_history.forEach(action => {
        hasData = true;
        const year = new Date(action.date).getFullYear().toString();
        const yearIndex = years.indexOf(year);
        if (yearIndex >= 0) {
          const actionType = action.type.toUpperCase().replace(/\s+/g, '_');
          switch (actionType) {
            case 'VERBAL_WARNING': datasets[0].data[yearIndex]++; break;
            case 'WRITTEN_WARNING': datasets[1].data[yearIndex]++; break;
            case 'FINAL_WARNING': datasets[2].data[yearIndex]++; break;
            case 'TERMINATION': datasets[3].data[yearIndex]++; break;
          }
        }
      });
    }
  });

  // If no history, put current totals in current year
  if (!hasData) {
    const currentYearIndex = 4;
    let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
    
    AppState.employees.forEach(emp => {
      totalVerbal += emp.verbal_warning_count || 0;
      totalWritten += emp.disciplinary_warning_count || 0;
      totalFinal += emp.final_warning_count || 0;
      totalTermination += emp.termination_letter_count || 0;
    });
    
    datasets[0].data[currentYearIndex] = totalVerbal;
    datasets[1].data[currentYearIndex] = totalWritten;
    datasets[2].data[currentYearIndex] = totalFinal;
    datasets[3].data[currentYearIndex] = totalTermination;
  }

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'bar',
    data: { labels: years, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

function generateWeeklyChart() {
  const canvas = document.getElementById('discipline-trend-chart');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  
  if (AppState.charts.disciplineTrend) {
    AppState.charts.disciplineTrend.destroy();
  }

  const weeks = [];
  for (let i = 1; i <= 12; i++) {
    weeks.push(`Week ${i}`);
  }

  const datasets = [
    { 
      label: 'Verbal Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#10b981',
      backgroundColor: 'rgba(16, 185, 129, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#10b981',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Written Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#f59e0b',
      backgroundColor: 'rgba(245, 158, 11, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#f59e0b',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Final Warnings', 
      data: new Array(12).fill(0), 
      borderColor: '#ef4444',
      backgroundColor: 'rgba(239, 68, 68, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#ef4444',
      tension: 0.4,
      fill: true
    },
    { 
      label: 'Terminations', 
      data: new Array(12).fill(0), 
      borderColor: '#991b1b',
      backgroundColor: 'rgba(153, 27, 27, 0.2)',
      borderWidth: 3,
      pointRadius: 5,
      pointHoverRadius: 7,
      pointBackgroundColor: '#991b1b',
      tension: 0.4,
      fill: true
    }
  ];

  // Put current totals in last week if no history
  const lastWeekIndex = 11;
  let totalVerbal = 0, totalWritten = 0, totalFinal = 0, totalTermination = 0;
  
  AppState.employees.forEach(emp => {
    totalVerbal += emp.verbal_warning_count || 0;
    totalWritten += emp.disciplinary_warning_count || 0;
    totalFinal += emp.final_warning_count || 0;
    totalTermination += emp.termination_letter_count || 0;
  });
  
  datasets[0].data[lastWeekIndex] = totalVerbal;
  datasets[1].data[lastWeekIndex] = totalWritten;
  datasets[2].data[lastWeekIndex] = totalFinal;
  datasets[3].data[lastWeekIndex] = totalTermination;

  AppState.charts.disciplineTrend = new Chart(ctx, {
    type: 'line',
    data: { labels: weeks, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        legend: { 
          display: true, 
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: {
              size: 13,
              weight: 'bold',
              family: "'Inter', sans-serif"
            },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: {
            size: 14,
            weight: 'bold'
          },
          bodyFont: {
            size: 13,
            weight: 'bold'
          }
        }
      },
      scales: { 
        y: { 
          beginAtZero: true,
          ticks: { 
            stepSize: 1,
            font: {
              size: 12,
              weight: 'bold'
            },
            color: '#64748b'
          },
          grid: {
            color: 'rgba(0, 0, 0, 0.06)'
          }
        },
        x: {
          grid: {
            display: false
          },
          ticks: {
            font: {
              size: 11,
              weight: 'bold'
            },
            color: '#64748b'
          }
        }
      }
    }
  });
}

      // ========================================================================
      // DISCIPLINE CASES TAB FUNCTIONS
      // ========================================================================
      
      function setupAutocomplete(inputId, dropdownId, tabName) {
        const input = document.getElementById(inputId);
        const dropdown = document.getElementById(dropdownId);
        if (!input || !dropdown) return;

        input.addEventListener('input', (e) => {
          const query = e.target.value.trim();
          const state = AutocompleteState[tabName];
          
          clearTimeout(state.searchTimeout);
          
          if (query.length < 3) {
            dropdown.classList.add('hidden');
            dropdown.innerHTML = '';
            return;
          }

          state.searchTimeout = setTimeout(() => {
            const results = AppState.employees.filter(emp => {
              const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
              const empId = (emp.employee_id || '').toLowerCase();
              const dept = (emp.department || '').toLowerCase();
              return fullName.includes(query.toLowerCase()) || 
                     empId.includes(query.toLowerCase()) || 
                     dept.includes(query.toLowerCase());
            }).slice(0, 10);

            dropdown.innerHTML = '';
            
            if (results.length === 0) {
              dropdown.innerHTML = '<div class="px-3 py-2 text-xs text-slate-400">No employees found</div>';
            } else {
              results.forEach(emp => {
                const item = document.createElement('div');
                item.className = 'px-3 py-2 hover:bg-slate-50 cursor-pointer text-xs';
                item.innerHTML = `
                  <div class="font-bold text-slate-900">${emp.first_name} ${emp.last_name}</div>
                  <div class="text-slate-500 text-[0.70rem]">${emp.employee_id || '--'} &bull; ${emp.department || '--'}</div>
                `;
                item.addEventListener('click', () => {
                  input.value = `${emp.first_name} ${emp.last_name}`;
                  dropdown.classList.add('hidden');
                  selectEmployee(emp, tabName);
                });
                dropdown.appendChild(item);
              });
            }
            
            dropdown.classList.remove('hidden');
          }, 300);
        });

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
          if (!input.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
          }
        });
      }

      function selectEmployee(employee, context = 'discipline') {
        if (context === 'discipline') {
          AppState.selectedEmployee = employee;
          
          // Update hidden field
          document.getElementById('discipline-employee-id').value = employee.id;
          
          // Update selected employee chip
          const chip = document.getElementById('discipline-selected-employee-chip');
          chip.innerHTML = `
            <span class="font-bold">${employee.first_name} ${employee.last_name}</span>
            <span class="text-slate-500">&bull;</span>
            <span>${employee.department || '--'}</span>
          `;
          chip.classList.remove('hidden');
          
          // Render discipline history
          renderDisciplineHistory(employee);
          renderAuditTrail(employee);
        } else if (context === 'employees') {
          loadEmployee360(employee);
        }
      }

      function renderDisciplineHistory(employee) {
        const container = document.getElementById('discipline-history-timeline');
        if (!container) return;

        container.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          container.innerHTML = '<p class="text-xs text-slate-400">No discipline history recorded for this employee.</p>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach((action, index) => {
          const item = document.createElement('div');
          item.className = 'timeline-item relative pl-6 pb-6';
          if (index === history.length - 1) item.classList.remove('pb-6');
          
          let iconBg = 'bg-slate-400';
          if (action.type === 'Verbal Warning') iconBg = 'bg-emerald-400';
          if (action.type === 'Written Warning') iconBg = 'bg-amber-400';
          if (action.type === 'Final Warning') iconBg = 'bg-rose-400';
          if (action.type === 'Termination') iconBg = 'bg-rose-600';
          
          item.innerHTML = `
            <div class="absolute left-0 top-1 w-3 h-3 rounded-full ${iconBg} border-2 border-white"></div>
            <div class="text-xs">
              <p class="font-bold text-slate-900">${action.type}</p>
              <p class="text-[0.70rem] text-slate-500">${formatDate(action.date)}</p>
              <p class="text-[0.70rem] text-slate-600 mt-1">${action.reason || 'No reason provided'}</p>
              ${action.reference ? `<p class="text-[0.65rem] text-slate-400 mt-0.5">Ref: ${action.reference}</p>` : ''}
            </div>
          `;
          container.appendChild(item);
        });
      }

      function renderAuditTrail(employee) {
        const tbody = document.getElementById('discipline-audit-table-body');
        if (!tbody) return;

        tbody.innerHTML = '';
        
        if (!employee.discipline_history || employee.discipline_history.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" class="px-3 py-4 text-center text-slate-400 text-xs">No audit trail available</td></tr>';
          return;
        }

        const history = [...employee.discipline_history].sort((a, b) => new Date(b.date) - new Date(a.date));

        history.forEach(action => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
            <td class="px-3 py-2 text-slate-900 font-medium">${action.type}</td>
            <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.manager_signature || '--'}</td>
            <td class="px-3 py-2 text-slate-600">${action.reference || '--'}</td>
          `;
          tbody.appendChild(row);
        });
      }

      async function handleDisciplineSubmit(event) {
  event.preventDefault();
  
  const employeeId = document.getElementById('discipline-employee-id').value;
  if (!employeeId) {
    showToast('Please select an employee first', 'error');
    return;
  }

  const submitBtn = document.getElementById('discipline-form-submit');
  const submitSpinner = document.getElementById('discipline-form-submit-spinner');
  const submitText = document.getElementById('discipline-form-submit-text');
  
  submitBtn.disabled = true;
  submitSpinner.classList.remove('hidden');
  submitText.textContent = 'Submitting...';

  try {
    // Collect form data
    const actionType = document.getElementById('discipline-action-type').value;
    const actionDate = document.getElementById('discipline-action-date').value;
    const severity = document.getElementById('discipline-severity').value;
    const mainCategory = document.getElementById('discipline-main-category').value;  // â­ NEW
    const subCategory = document.getElementById('discipline-sub-category').value;    // â­ NEW
    const reference = document.getElementById('discipline-reference').value;
    const reason = document.getElementById('discipline-reason').value;
    const plan = document.getElementById('discipline-plan').value;
    const managerSig = document.getElementById('discipline-manager-signature').value;
    const hrSig = document.getElementById('discipline-hr-signature').value;
    const empSig = document.getElementById('discipline-employee-signature').value;
    const empDeclined = document.getElementById('discipline-employee-declined').checked;

    // Validate required fields
    if (!mainCategory || !subCategory) {
      showToast('Please select both main category and sub-category', 'error');
      submitBtn.disabled = false;
      submitSpinner.classList.add('hidden');
      submitText.textContent = 'Record Action & Generate PDF';
      return;
    }

    // Create action object
    const newAction = {
      type: actionType,
      date: actionDate,
      severity,
      main_category: mainCategory,      // â­ NEW
      sub_category: subCategory,        // â­ NEW
      reference,
      reason,
      corrective_plan: plan,
      manager_signature: managerSig,
      hr_signature: hrSig,
      employee_signature: empDeclined ? 'DECLINED' : empSig,
      timestamp: new Date().toISOString()
    };

    console.log('ğŸ“ Submitting discipline action:', newAction);

    // Get current employee data
    const { data: currentEmp, error: fetchError } = await supabaseClient
      .from('employees2025')
      .select('*')
      .eq('id', employeeId)
      .single();

    if (fetchError) throw fetchError;

    // Update warning counts based on action type
    const updates = { last_disciplinary_action: newAction };
    
    if (actionType === 'VERBAL_WARNING') {
      updates.verbal_warning_count = (currentEmp.verbal_warning_count || 0) + 1;
    } else if (actionType === 'WRITTEN_WARNING') {
      updates.disciplinary_warning_count = (currentEmp.disciplinary_warning_count || 0) + 1;
    } else if (actionType === 'FINAL_WARNING') {
      updates.final_warning_count = (currentEmp.final_warning_count || 0) + 1;
    } else if (actionType === 'TERMINATION') {
      updates.termination_letter_count = (currentEmp.termination_letter_count || 0) + 1;
      updates.employment_status = 'Terminated';
      updates.termination_status = 'Complete';
    }

    // Add to discipline history
    const history = currentEmp.discipline_history || [];
    history.push(newAction);
    updates.discipline_history = history;

    // Recalculate risk score
    const { points } = AppState.settings;
    const newScore = 
      (updates.verbal_warning_count || currentEmp.verbal_warning_count || 0) * points.verbal +
      (updates.disciplinary_warning_count || currentEmp.disciplinary_warning_count || 0) * points.written +
      (updates.final_warning_count || currentEmp.final_warning_count || 0) * points.final +
      (updates.termination_letter_count || currentEmp.termination_letter_count || 0) * points.termination;
    
    updates.risk_score = newScore;
    updates.risk_level = getRiskLevel(newScore);

    // Save to database
    console.log('ğŸ’¾ Updating database...');
    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update(updates)
      .eq('id', employeeId);

    if (updateError) throw updateError;

    console.log('âœ… Discipline action saved successfully');
    showToast('âœ… Discipline action recorded successfully!', 'success');
    
    // Reset form
    document.getElementById('discipline-form').reset();
    document.getElementById('discipline-selected-employee-chip').classList.add('hidden');
    document.getElementById('discipline-sub-category').disabled = true;
    document.getElementById('discipline-sub-category').innerHTML = '<option value="">Select main category first...</option>';
    
    // Reload data and refresh display
    await loadEmployees();
    populateDashboardDisciplineList();
    
    // Generate PDF
    generateDisciplinePDF(currentEmp, newAction);

  } catch (error) {
    console.error('âŒ Error submitting discipline action:', error);
    showToast('âŒ Failed to submit discipline action: ' + error.message, 'error');
  } finally {
    submitBtn.disabled = false;
    submitSpinner.classList.add('hidden');
    submitText.textContent = 'Record Action & Generate PDF';
  }
}



      function generateDisciplinePDF(employee, action) {
        const content = `
          <div style="font-family: Arial, sans-serif; padding: 40px; max-width: 800px;">
            <div style="text-align: center; margin-bottom: 30px;">
              <h1 style="color: #7a1f1f; margin: 0;">Jeng Chi Restaurant</h1>
              <h2 style="color: #666; margin: 10px 0 0 0;">Disciplinary Action Form</h2>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
              <h3 style="margin-top: 0; color: #333;">Employee Information</h3>
              <p><strong>Name:</strong> ${employee.first_name} ${employee.last_name}</p>
              <p><strong>Employee ID:</strong> ${employee.employee_id || 'N/A'}</p>
              <p><strong>Department:</strong> ${employee.department || 'N/A'}</p>
              <p><strong>Position:</strong> ${employee.job_title || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Action Details</h3>
              <p><strong>Action Type:</strong> ${action.type}</p>
              <p><strong>Date:</strong> ${formatDate(action.date)}</p>
              <p><strong>Severity:</strong> ${action.severity}</p>
              <p><strong>Reference:</strong> ${action.reference || 'N/A'}</p>
            </div>
            
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Reason for Action</h3>
              <p style="white-space: pre-wrap;">${action.reason}</p>
            </div>
            
            ${action.corrective_plan ? `
            <div style="margin-bottom: 20px;">
              <h3 style="color: #333;">Corrective Action Plan</h3>
              <p style="white-space: pre-wrap;">${action.corrective_plan}</p>
            </div>
            ` : ''}
            
            <div style="margin-top: 40px; border-top: 2px solid #ddd; padding-top: 20px;">
              <h3 style="color: #333;">Signatures</h3>
              <p><strong>Manager:</strong> ${action.manager_signature || 'N/A'}</p>
              <p><strong>HR:</strong> ${action.hr_signature || 'N/A'}</p>
              <p><strong>Employee:</strong> ${action.employee_signature || 'N/A'}</p>
            </div>
          </div>
        `;

        const element = document.createElement('div');
        element.innerHTML = content;
        
        html2pdf()
          .from(element)
          .set({
            margin: 0.5,
            filename: `discipline-${employee.employee_id}-${action.date}.pdf`,
            html2canvas: { scale: 2 },
            jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
          })
          .save();
      }

      // ========================================================================
      // EMPLOYEES 360 TAB FUNCTIONS
      // ========================================================================
      
      function renderEmployeeList() {
        const container = document.getElementById('employee-list');
        if (!container) return;

        const filtered = filterEmployees(AppState.employeeFilterStatus);
        container.innerHTML = '';

        if (filtered.length === 0) {
          container.innerHTML = '<div class="text-xs text-slate-400 px-3 py-2">No employees match the current filter.</div>';
          return;
        }

        filtered.forEach(emp => {
          const score = computeRiskScore(emp);
          const level = getRiskLevel(score);
          const badgeClasses = getRiskBadgeClasses(level);
          
          const item = document.createElement('div');
          item.className = 'rounded-lg border border-slate-100 bg-slate-50 px-3 py-2 hover:bg-white hover:border-brand-200 cursor-pointer transition-all';
          item.innerHTML = `
            <div class="flex items-center justify-between gap-2">
              <div class="flex-1">
                <p class="font-bold text-slate-900 text-xs">${emp.first_name} ${emp.last_name}</p>
                <p class="text-[0.70rem] text-slate-500">${emp.employee_id || '--'}</p>
              </div>
              <span class="inline-flex items-center gap-1 rounded-full ${badgeClasses} border px-2 py-0.5 text-[0.65rem] font-medium">
                ${level}
              </span>
            </div>
          `;
          item.addEventListener('click', () => selectEmployee(emp, 'employees'));
          container.appendChild(item);
        });
      }

      function loadEmployee360(employee) {
  document.getElementById('current-employee-360-id').value = employee.id;
  AppState.selectedEmployee = employee;
  
  // Use enhanced profile population
  populateEmployeeProfileCard(employee);

        // Profile header
        document.getElementById('employee-profile-name').textContent = `${employee.first_name} ${employee.last_name}`;
        document.getElementById('employee-profile-title').textContent = `${employee.job_title || 'N/A'} â€¢ ${employee.department || 'N/A'}`;
        document.getElementById('employee-profile-status').textContent = `${employee.employment_status || 'N/A'} â€¢ Hired ${formatDate(employee.hire_date)} â€¢ Reports to ${employee.report_to || 'N/A'}`;
        





        // Risk badge
        const score = computeRiskScore(employee);
        const level = getRiskLevel(score);
        const badgeClasses = getRiskBadgeClasses(level);
        document.getElementById('employee-profile-risk-badge').className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
        document.getElementById('employee-profile-risk-badge').innerHTML = `
          <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
          <span>Risk Score: ${score}</span>
        `;
        
        // IDs
        document.getElementById('employee-profile-employee-id').innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
        document.getElementById('employee-profile-username').innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${employee.username || '--'}</span>`;
        
        // KPIs
        document.getElementById('employee-kpi-verbal').textContent = employee.verbal_warning_count || 0;
        document.getElementById('employee-kpi-written').textContent = employee.disciplinary_warning_count || 0;
        document.getElementById('employee-kpi-final').textContent = employee.final_warning_count || 0;
        document.getElementById('employee-kpi-termination').textContent = employee.termination_letter_count || 0;

        // Editable fields
        document.getElementById('edit-employment-status').value = employee.employment_status || 'Active';
        document.getElementById('edit-first-name').value = employee.first_name || '';
        document.getElementById('edit-last-name').value = employee.last_name || '';
        document.getElementById('edit-job-title').value = employee.job_title || '';
     
        document.getElementById('edit-department').value = employee.department || '';
        document.getElementById('edit-report-to').value = employee.report_to || '';
        document.getElementById('edit-email').value = employee.email || '';
        document.getElementById('edit-phone').value = employee.phone || '';
        document.getElementById('edit-address-line-1').value = employee.address_line_1 || '';
        document.getElementById('edit-address-line-2').value = employee.address_line_2 || '';
        document.getElementById('edit-city').value = employee.city || '';
        document.getElementById('edit-state').value = employee.state || '';
        document.getElementById('edit-zip-code').value = employee.zip_code || '';
        document.getElementById('edit-original-hire-date').value = employee.original_hire_date || '';
        
        document.getElementById('edit-hourly-rate').value = employee.hourly_rate || '';
        document.getElementById('edit-annual-salary').value = employee.annual_salary || '';
        document.getElementById('edit-risk-level').value = employee.risk_level || 'LOW';
        document.getElementById('edit-hr-witness').value = employee.hr_witness || '';

        // Calculated fields
        document.getElementById('display-tenure').textContent = calculateTenure(employee.hire_date);
        document.getElementById('display-risk-score').textContent = score;
        document.getElementById('display-last-action').textContent = employee.last_disciplinary_action ? `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}` : 'None';

        // Summary
        const summaryContainer = document.getElementById('employee-summary-history');
        if (employee.discipline_history && employee.discipline_history.length > 0) {
          summaryContainer.innerHTML = `
            <p class="text-slate-700">
              ${employee.first_name} ${employee.last_name} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
              with a current risk score of <strong>${score}</strong> (${level} risk). 
              The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
              issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
            </p>
          `;
        } else {
          summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
        }
      }



      // ========================================================================
// ENHANCED EMPLOYEE PROFILE POPULATION
// ========================================================================
function populateEmployeeProfileCard(employee) {
  if (!employee) return;

 



  // --- Helpers ------------------------------------------------------
  const safe = (v, fallback = '') =>
    v === null || v === undefined ? fallback : v;

  const safeText = (id, value, fallback = '--') => {
    const el = document.getElementById(id);
    if (!el) return;
    el.textContent = value !== undefined && value !== null && value !== ''
      ? value
      : fallback;
  };

  const safeValue = (id, value) => {
    const el = document.getElementById(id);
    if (!el) return;
    if (el.tagName === 'INPUT' || el.tagName === 'SELECT' || el.tagName === 'TEXTAREA') {
      if (el.type === 'date' && value) {
        el.value = value;
      } else {
        el.value = value ?? '';
      }
    } else {
      el.textContent = value ?? '';
    }
  };

// âœ… NOW safe to call calculateTenure (assuming it's defined globally *before* this function)
  const tenureDisplayEl = document.getElementById('display-tenure');
  if (tenureDisplayEl) {
    tenureDisplayEl.textContent = calculateTenure(employee.hire_date);
  }


  // --- BASIC DERIVED FIELDS -----------------------------------------
  const fullName = `${safe(employee.first_name)} ${safe(employee.last_name)}`.trim() || 'Employee';
  const jobTitle = safe(employee.job_title || employee.position_title, 'N/A');
  const department = safe(employee.department, 'N/A');
  const employmentStatus = safe(employee.employment_status, 'Active');
  const hireDate = employee.hire_date || employee.original_hire_date || null;
  const reportsTo = safe(employee.report_to, 'N/A');

  // --- PROFILE HEADER (top of Employee 360) -------------------------
  safeText('employee-profile-name', fullName, 'Employee');

  const profileTitleEl = document.getElementById('employee-profile-title');
  if (profileTitleEl) {
    profileTitleEl.textContent = `${jobTitle} â€¢ ${department}`;
  }

  const profileStatusEl = document.getElementById('employee-profile-status');
  if (profileStatusEl) {
    const tenure = typeof calculateTenure === 'function' && hireDate
      ? calculateTenure(hireDate)
      : '';
    const pieces = [employmentStatus];
    if (tenure) pieces.push(tenure);
    pieces.push(`Reports to ${reportsTo}`);
    profileStatusEl.textContent = pieces.join(' â€¢ ');
  }

  // ID + Username line
  const empIdEl = document.getElementById('employee-profile-employee-id');
  if (empIdEl) {
    empIdEl.innerHTML = `<i class="fa-solid fa-hashtag text-[0.60rem]"></i><span>Employee ID: ${employee.employee_id || '--'}</span>`;
  }

  const usernameEl = document.getElementById('employee-profile-username');
  if (usernameEl) {
    const username = employee.username || employee.email || '--';
    usernameEl.innerHTML = `<i class="fa-solid fa-user text-[0.60rem]"></i><span>Username: ${username}</span>`;
  }

  // --- RISK BADGE ---------------------------------------------------
  const riskBadge = document.getElementById('employee-profile-risk-badge');
  if (riskBadge && typeof computeRiskScore === 'function' && typeof getRiskLevel === 'function') {
    const score = computeRiskScore(employee);
    const level = getRiskLevel(score);
    const badgeClasses = getRiskBadgeClasses(level);

    riskBadge.className = `inline-flex items-center gap-2 rounded-full ${badgeClasses} border px-2 py-1 text-[0.70rem]`;
    riskBadge.innerHTML = `
      <span class="w-1.5 h-1.5 rounded-full ${level === 'HIGH' ? 'bg-rose-500' : level === 'MEDIUM' ? 'bg-amber-500' : 'bg-emerald-500'}"></span>
      <span>Risk Score: ${score}</span>
    `;
  }

  // --- KPIs (Verbal / Written / Final / Termination) ---------------
  const kpiMap = {
    'employee-kpi-verbal': employee.verbal_warning_count,
    'employee-kpi-written': employee.disciplinary_warning_count,
    'employee-kpi-final': employee.final_warning_count,
    'employee-kpi-termination': employee.termination_letter_count
  };

  Object.entries(kpiMap).forEach(([id, value]) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value != null ? value : 0;
  });

  // --- EDITABLE FIELDS ---------------------------------------------
  safeValue('edit-employment-status', employmentStatus);
  safeValue('edit-first-name', employee.first_name || '');
  safeValue('edit-last-name', employee.last_name || '');
  safeValue('edit-job-title', employee.job_title || employee.position_title || '');
  safeValue('edit-department', employee.department || '');
  safeValue('edit-report-to', employee.report_to || '');
  safeValue('edit-email', employee.email || '');
  safeValue('edit-phone', employee.phone || '');
  safeValue('edit-address-line-1', employee.address_line_1 || '');
  safeValue('edit-address-line-2', employee.address_line_2 || '');
  safeValue('edit-city', employee.city || '');
  safeValue('edit-state', employee.state || '');
  safeValue('edit-zip-code', employee.zip_code || '');
  safeValue('edit-original-hire-date', employee.original_hire_date || '');
  safeValue('edit-hire-date', employee.hire_date || '');
  safeValue('edit-hourly-rate', employee.hourly_rate ?? '');
  safeValue('edit-annual-salary', employee.annual_salary ?? '');
  safeValue('edit-risk-level', employee.risk_level || 'LOW');
  safeValue('edit-hr-witness', employee.hr_witness || '');

  














  const scoreDisplayEl = document.getElementById('display-risk-score');
  if (scoreDisplayEl && typeof computeRiskScore === 'function') {
    const score = computeRiskScore(employee);
    scoreDisplayEl.textContent = score;
  }

  const lastActionEl = document.getElementById('display-last-action');
  if (lastActionEl) {
    if (employee.last_disciplinary_action) {
      lastActionEl.textContent = `${employee.last_disciplinary_action.type} on ${formatDate(employee.last_disciplinary_action.date)}`;
    } else {
      lastActionEl.textContent = 'None';
    }
  }

  // --- SUMMARY HISTORY ---------------------------------------------
  const summaryContainer = document.getElementById('employee-summary-history');
  if (summaryContainer) {
    if (employee.discipline_history && employee.discipline_history.length > 0) {
      const score = computeRiskScore(employee);
      const level = getRiskLevel(score);
      summaryContainer.innerHTML = `
        <p class="text-slate-700">
          ${fullName} has <strong>${employee.discipline_history.length} disciplinary action${employee.discipline_history.length > 1 ? 's' : ''}</strong> on record
          with a current risk score of <strong>${score}</strong> (${level} risk). 
          The most recent action was a <strong>${employee.last_disciplinary_action?.type || 'N/A'}</strong> 
          issued on <strong>${formatDate(employee.last_disciplinary_action?.date)}</strong>.
        </p>
      `;
    } else {
      summaryContainer.innerHTML = '<p class="text-slate-500">No disciplinary history on record for this employee.</p>';
    }
  }
}




// ========================================================================
// HELPER: Filter out owners (Francisco & Janelle Teng)
// ========================================================================
function excludeOwners(employees) {
  const owners = [
    { first_name: 'Francisco', last_name: 'Teng' },
    { first_name: 'Janelle', last_name: 'Teng' }
  ];

  return employees.filter(emp => {
    const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase().trim();
    return !owners.some(owner => {
      const ownerName = `${owner.first_name} ${owner.last_name}`.toLowerCase().trim();
      return fullName === ownerName;
    });
  });
}










      async function saveEmployee360() {
        const employeeId = document.getElementById('current-employee-360-id').value;
        if (!employeeId) {
          showToast('No employee selected', 'error');
          return;
        }

        const saveBtn = document.getElementById('btn-save-employee-360');
        const statusIndicator = document.getElementById('save-status-indicator');
        const statusText = document.getElementById('save-status-text');
        
        saveBtn.disabled = true;
        statusIndicator.className = 'w-2 h-2 rounded-full bg-amber-500';
        statusText.textContent = 'Saving...';

        try {
          const updates = {
            employment_status: document.getElementById('edit-employment-status').value,
            first_name: document.getElementById('edit-first-name').value,
            last_name: document.getElementById('edit-last-name').value,
            job_title: document.getElementById('edit-job-title').value,
            
            department: document.getElementById('edit-department').value,
            report_to: document.getElementById('edit-report-to').value,
            email: document.getElementById('edit-email').value,
            phone: document.getElementById('edit-phone').value,
            address_line_1: document.getElementById('edit-address-line-1').value,
            address_line_2: document.getElementById('edit-address-line-2').value,
            city: document.getElementById('edit-city').value,
            state: document.getElementById('edit-state').value,
            zip_code: document.getElementById('edit-zip-code').value,
            original_hire_date: document.getElementById('edit-original-hire-date').value,
          
            hourly_rate: parseFloat(document.getElementById('edit-hourly-rate').value) || null,
            annual_salary: parseFloat(document.getElementById('edit-annual-salary').value) || null,
            risk_level: document.getElementById('edit-risk-level').value,
            hr_witness: document.getElementById('edit-hr-witness').value
          };

          const { error } = await supabaseClient
            .from('employees2025')
            .update(updates)
            .eq('id', employeeId);

          if (error) throw error;

          statusIndicator.className = 'w-2 h-2 rounded-full bg-emerald-500';
          statusText.textContent = 'Saved successfully';
          showToast('Employee data saved successfully', 'success');
          
          await loadEmployees();
          renderEmployeeList();

          setTimeout(() => {
            statusIndicator.className = 'w-2 h-2 rounded-full bg-emerald-500';
            statusText.textContent = 'Ready to edit';
          }, 2000);

        } catch (error) {
          console.error('Error saving employee:', error);
          statusIndicator.className = 'w-2 h-2 rounded-full bg-rose-500';
          statusText.textContent = 'Save failed';
          showToast('Failed to save employee data', 'error');
        } finally {
          saveBtn.disabled = false;
        }
      }

      // ========================================================================
      // POLICY LIBRARY TAB FUNCTIONS
      // ========================================================================
      
      function setupPolicyAccordion() {
        document.querySelectorAll('.policy-accordion-header').forEach(header => {
          header.addEventListener('click', () => {
            const body = header.nextElementSibling;
            const toggle = header.querySelector('.policy-accordion-toggle i');
            
            if (body.classList.contains('hidden')) {
              body.classList.remove('hidden');
              toggle.classList.remove('fa-chevron-down');
              toggle.classList.add('fa-chevron-up');
            } else {
              body.classList.add('hidden');
              toggle.classList.remove('fa-chevron-up');
              toggle.classList.add('fa-chevron-down');
            }
          });
        });

        document.querySelectorAll('.policy-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            const category = chip.dataset.policyCategory;
            
            // Update chip styles
            document.querySelectorAll('.policy-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            // Show/hide panels
            document.querySelectorAll('[data-policy-category-panel]').forEach(panel => {
              if (panel.dataset.policyCategoryPanel === category) {
                panel.classList.remove('hidden');
              } else {
                panel.classList.add('hidden');
              }
            });
          });
        });
      }

     
      // ========================================================================
      // ADMIN SETTINGS TAB FUNCTIONS
      // ========================================================================
      
      function loadAdminSettings() {
        document.getElementById('admin-threshold-low').value = AppState.settings.thresholds.low;
        document.getElementById('admin-threshold-medium').value = AppState.settings.thresholds.medium;
        document.getElementById('admin-threshold-high').value = AppState.settings.thresholds.high;
        document.getElementById('admin-points-verbal').value = AppState.settings.points.verbal;
        document.getElementById('admin-points-written').value = AppState.settings.points.written;
        document.getElementById('admin-points-final').value = AppState.settings.points.final;
        document.getElementById('admin-points-termination').value = AppState.settings.points.termination;
        document.getElementById('admin-notify-high-risk').checked = AppState.settings.notifications.highRisk;
        document.getElementById('admin-notify-final-warning').checked = AppState.settings.notifications.finalWarning;
        document.getElementById('admin-notify-termination').checked = AppState.settings.notifications.termination;
        document.getElementById('admin-notify-daily-summary').checked = AppState.settings.notifications.dailySummary;
        document.getElementById('admin-display-photos').checked = AppState.settings.display.photos;
        document.getElementById('admin-display-compact').checked = AppState.settings.display.compact;
        document.getElementById('admin-display-auto-refresh').checked = AppState.settings.display.autoRefresh;
        document.getElementById('admin-retention-discipline').value = AppState.settings.retention.discipline;
        document.getElementById('admin-retention-audit').value = AppState.settings.retention.audit;
      }

      function saveAdminSettings() {
        AppState.settings.thresholds.low = parseInt(document.getElementById('admin-threshold-low').value) || 2;
        AppState.settings.thresholds.medium = parseInt(document.getElementById('admin-threshold-medium').value) || 5;
        AppState.settings.thresholds.high = parseInt(document.getElementById('admin-threshold-high').value) || 8;
        AppState.settings.points.verbal = parseFloat(document.getElementById('admin-points-verbal').value) || 1;
        AppState.settings.points.written = parseFloat(document.getElementById('admin-points-written').value) || 2;
        AppState.settings.points.final = parseFloat(document.getElementById('admin-points-final').value) || 3;
        AppState.settings.points.termination = parseFloat(document.getElementById('admin-points-termination').value) || 4;
        AppState.settings.notifications.highRisk = document.getElementById('admin-notify-high-risk').checked;
        AppState.settings.notifications.finalWarning = document.getElementById('admin-notify-final-warning').checked;
        AppState.settings.notifications.termination = document.getElementById('admin-notify-termination').checked;
        AppState.settings.notifications.dailySummary = document.getElementById('admin-notify-daily-summary').checked;
        AppState.settings.display.photos = document.getElementById('admin-display-photos').checked;
        AppState.settings.display.compact = document.getElementById('admin-display-compact').checked;
        AppState.settings.display.autoRefresh = document.getElementById('admin-display-auto-refresh').checked;
        AppState.settings.retention.discipline = parseInt(document.getElementById('admin-retention-discipline').value) || 7;
        AppState.settings.retention.audit = parseInt(document.getElementById('admin-retention-audit').value) || 7;

        localStorage.setItem('jcr-hr-settings', JSON.stringify(AppState.settings));
        
        const statusDiv = document.getElementById('admin-save-status');
        statusDiv.classList.remove('hidden');
        setTimeout(() => statusDiv.classList.add('hidden'), 3000);
        
        showToast('Settings saved successfully', 'success');
      }


// FIND your PDF download button code and replace with:
async function download360PDF(employeeId) {
  try {
    const response = await fetch('https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/employee-360-pdf', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
      },
      body: JSON.stringify({ employee_id: employeeId })
    });

    if (!response.ok) {
      throw new Error('Failed to generate PDF');
    }

    const htmlContent = await response.text();
    
    // Open HTML in new window - user can print to PDF
    const newWindow = window.open('', '_blank');
    newWindow.document.write(htmlContent);
    newWindow.document.close();
    
    // Optionally trigger print dialog
    setTimeout(() => {
      newWindow.print();
    }, 500);

  } catch (error) {
    console.error('Error downloading 360 PDF:', error);
    alert('Failed to generate PDF. Please try again.');
  }
}



      // ========================================================================
      // EVENT LISTENERS
      // ========================================================================
      
      function attachEventListeners() {
        // Tab switching
        document.querySelectorAll('.tab-trigger').forEach(btn => {
  btn.addEventListener('click', () => {
    const tab = btn.dataset.tabTarget;  // âœ… CORRECT!
    showTab(tab);
  });
});
        // Mobile menu toggle
        const mobileMenuBtn = document.getElementById('mobile-menu-toggle');
        const mobileMenu = document.getElementById('mobile-nav-menu');
        if (mobileMenuBtn && mobileMenu) {
          mobileMenuBtn.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
          });

          document.querySelectorAll('#mobile-nav-menu .tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
              mobileMenu.classList.add('hidden');
            });
          });
        }

        // Dashboard chart timeframe
        const chartSelector = document.getElementById('chart-timeframe-selector');
        if (chartSelector) {
          chartSelector.addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'monthly') generate12MonthChart();
            else if (value === 'yearly') generateYearlyChart();
            else if (value === 'weekly') generateWeeklyChart();
          });
        }

        // Discipline form
        const disciplineForm = document.getElementById('discipline-form');
        if (disciplineForm) {
          disciplineForm.addEventListener('submit', handleDisciplineSubmit);
        }

        const disciplineResetBtn = document.getElementById('discipline-form-reset');
        if (disciplineResetBtn) {
          disciplineResetBtn.addEventListener('click', () => {
            disciplineForm.reset();
            document.getElementById('discipline-selected-employee-chip').classList.add('hidden');
          });
        }

        // Discipline refresh
        const disciplineRefresh = document.getElementById('discipline-refresh-employees');
        if (disciplineRefresh) {
          disciplineRefresh.addEventListener('click', () => loadEmployees());
        }

        // Employees 360 refresh
        const employeesRefresh = document.getElementById('employees-refresh-button');
        if (employeesRefresh) {
          employeesRefresh.addEventListener('click', () => {
            loadEmployees().then(() => renderEmployeeList());
          });
        }

        // Employees 360 save
        const saveEmployee360Btn = document.getElementById('btn-save-employee-360');
        if (saveEmployee360Btn) {
          saveEmployee360Btn.addEventListener('click', saveEmployee360);
        }

        // Employee filter chips
        document.querySelectorAll('.employee-filter-chip').forEach(chip => {
          chip.addEventListener('click', () => {
            document.querySelectorAll('.employee-filter-chip').forEach(c => {
              c.classList.remove('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
              c.classList.add('bg-slate-50', 'border-slate-200', 'text-slate-600');
            });
            chip.classList.add('bg-brand-50', 'border-brand-100', 'text-brand-700', 'font-medium');
            chip.classList.remove('bg-slate-50', 'border-slate-200', 'text-slate-600');
            
            renderEmployeeList();
          });
        });

        // Reports refresh
        const reportsRefresh = document.getElementById('reports-refresh-data');
        if (reportsRefresh) {
          reportsRefresh.addEventListener('click', () => {
            loadEmployees().then(() => updateReports());
          });
        }
const mainCategoryDropdown = document.getElementById('discipline-main-category');
const subCategoryDropdown = document.getElementById('discipline-sub-category');

if (mainCategoryDropdown && subCategoryDropdown) {
  mainCategoryDropdown.addEventListener('change', (e) => {
    const category = e.target.value;
    subCategoryDropdown.innerHTML = '<option value="">Select sub-category...</option>';
    
    if (category && DISCIPLINE_CATEGORIES[category]) {
      DISCIPLINE_CATEGORIES[category].forEach(sub => {
        const option = document.createElement('option');
        option.value = sub.value;
        option.textContent = sub.label;
        subCategoryDropdown.appendChild(option);
      });
      subCategoryDropdown.disabled = false;
    } else {
      subCategoryDropdown.disabled = true;
    }
  });
}

        // Admin settings save
        const adminSaveBtn = document.getElementById('admin-save-settings');
        if (adminSaveBtn) {
          adminSaveBtn.addEventListener('click', saveAdminSettings);
        }
const employee360PdfBtn = document.getElementById('employee-summary-pdf');
if (employee360PdfBtn) {
  employee360PdfBtn.addEventListener('click', () => {
    const employeeId = document.getElementById('current-employee-360-id').value;
    if (!employeeId) {
      showToast('Please select an employee first', 'error');
      return;
    }
    download360PDF(employeeId);
  });
}
        // Setup autocomplete for both search inputs
        setupAutocomplete('discipline-employee-search', 'discipline-search-dropdown', 'discipline');
        setupAutocomplete('employees-search-input', 'employees-search-dropdown', 'employees');
      }

      // ========================================================================
      // INITIALIZATION
      // ========================================================================
      // ========================================================================
// PERMISSIONS MANAGEMENT
// ========================================================================

// Load permissions from database
async function loadPermissions() {
  try {
    const { data, error } = await supabaseClient
      .from('permissions_config')
      .select('*')
      .single();

    if (error && error.code !== 'PGRST116') throw error;

    if (data) {
      // Apply permissions to checkboxes
      Object.entries(data.permissions || {}).forEach(([feature, roles]) => {
        Object.entries(roles).forEach(([role, allowed]) => {
          const checkbox = document.querySelector(
            `.permission-checkbox[data-feature="${feature}"][data-role="${role}"]`
          );
          if (checkbox) checkbox.checked = allowed;
        });
      });
    }
  } catch (error) {
    console.error('Error loading permissions:', error);
  }
}

// Save permissions to database
async function savePermissions() {
  try {
    const permissions = {};
    
    document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
      const feature = checkbox.dataset.feature;
      const role = checkbox.dataset.role;
      
      if (!permissions[feature]) permissions[feature] = {};
      permissions[feature][role] = checkbox.checked;
    });

    const { error } = await supabaseClient
      .from('permissions_config')
      .upsert({
        id: 1,
        permissions,
        updated_at: new Date().toISOString()
      });

    if (error) throw error;

    // Log the change
    await logPermissionChange('Permissions matrix updated', 'HR Admin');
    
    showToast('Permissions saved automatically', 'success');
  } catch (error) {
    console.error('Error saving permissions:', error);
    showToast('Failed to save permissions', 'error');
  }
}

// Log permission changes
async function logPermissionChange(action, changedBy) {
  try {
    const { error } = await supabaseClient
      .from('permissions_audit_log')
      .insert({
        action,
        changed_by: changedBy,
        timestamp: new Date().toISOString()
      });

    if (error) throw error;
    
    // Refresh audit log display
    await loadPermissionsAuditLog();
  } catch (error) {
    console.error('Error logging permission change:', error);
  }
}

// Load and display audit log
async function loadPermissionsAuditLog() {
  try {
    const { data, error } = await supabaseClient
      .from('permissions_audit_log')
      .select('*')
      .order('timestamp', { ascending: false })
      .limit(50);

    if (error) throw error;

    const tbody = document.getElementById('permissions-audit-log');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (!data || data.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="4" class="px-3 py-4 text-center text-slate-400">
            No permission changes logged yet.
          </td>
        </tr>
      `;
      return;
    }

    data.forEach(log => {
      const row = document.createElement('tr');
      const timestamp = new Date(log.timestamp);
      row.innerHTML = `
        <td class="px-3 py-2 text-slate-600">
          ${timestamp.toLocaleString('en-US', { 
            month: 'short', 
            day: 'numeric', 
            year: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
          })}
        </td>
        <td class="px-3 py-2 text-slate-700">${log.action}</td>
        <td class="px-3 py-2 text-slate-600">${log.user_affected || '--'}</td>
        <td class="px-3 py-2 text-slate-600">${log.changed_by}</td>
      `;
      tbody.appendChild(row);
    });
  } catch (error) {
    console.error('Error loading audit log:', error);
  }
}

// Setup auto-save for permission checkboxes
function setupPermissionsAutoSave() {
  document.querySelectorAll('.permission-checkbox').forEach(checkbox => {
    checkbox.addEventListener('change', () => {
      // Debounce save
      clearTimeout(window.permissionsSaveTimeout);
      window.permissionsSaveTimeout = setTimeout(() => {
        savePermissions();
      }, 1000);
    });
  });
}
     async function bootstrap() {
  console.log('');
  console.log('ğŸ¬ BOOTSTRAP: Starting application...');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  // ğŸ†• CUSTOM DATE RANGE FUNCTIONALITY
const globalFilter = document.getElementById('global-reports-filter');
const customDateInputs = document.getElementById('custom-date-range-inputs');
const customStartDate = document.getElementById('custom-start-date');
const customEndDate = document.getElementById('custom-end-date');
const applyCustomDates = document.getElementById('apply-custom-dates');

if (globalFilter && customDateInputs) {
  // Show/hide custom date inputs when "Custom" is selected
  globalFilter.addEventListener('change', (e) => {
    if (e.target.value === 'custom') {
      customDateInputs.classList.remove('hidden');
      
      // Set default dates (last 30 days)
      const today = new Date();
      const thirtyDaysAgo = new Date(today.getTime() - 30 * 24 * 60 * 60 * 1000);
      
      customStartDate.value = thirtyDaysAgo.toISOString().split('T')[0];
      customEndDate.value = today.toISOString().split('T')[0];
    } else {
      customDateInputs.classList.add('hidden');
      updateReports();
    }
  });
}

// Apply custom date range
if (applyCustomDates) {
  applyCustomDates.addEventListener('click', () => {
    const startVal = customStartDate?.value;
    const endVal = customEndDate?.value;
    
    if (!startVal || !endVal) {
      showToast('Please select both start and end dates', 'error');
      return;
    }
    
    const start = new Date(startVal);
    const end = new Date(endVal);
    
    if (start > end) {
      showToast('Start date must be before end date', 'error');
      return;
    }
    
    console.log('ğŸ“… Applying custom date range:', startVal, 'to', endVal);
    updateReports();
    showToast('Custom date range applied', 'success');
  });
}
  // Check toast container
  const toastContainer = document.getElementById('toast-container');
  if (toastContainer) {
    console.log('âœ… Toast container found');
  } else {
    console.error('âŒ Toast container NOT found!');
  }
  // Load permissions and audit log
if (AppState.currentTab === 'permissions') {
  await loadPermissions();
  await loadPermissionsAuditLog();
}
setupPermissionsAutoSave();
  // Load settings from localStorage
  const savedSettings = localStorage.getItem('jcr-hr-settings');
  if (savedSettings) {
    try {
      AppState.settings = JSON.parse(savedSettings);
      console.log('âœ… Settings loaded from localStorage');
    } catch (e) {
      console.error('âŒ Failed to parse saved settings');
    }
  }

  // Attach event listeners
  console.log('ğŸ”— Attaching event listeners...');
  attachEventListeners();
    setupModalEventListeners(); // â† ADD THIS LINE
// âœ… ADD THESE TWO LINES:
setupDepartmentJobTitleCascade();

setupCompensationTypeSwitcher();

  // Setup policy accordion
  console.log('ğŸ“‹ Setting up policy accordion...');
  setupPolicyAccordion();
  
  // Load admin settings into form
  console.log('âš™ï¸  Loading admin settings...');
  loadAdminSettings();
  
  // Load employee data
  console.log('');
  await loadEmployees();
  renderEmployeeList();
  renderEmployeeGrid();
 


  initCompensationLetterTab(); // â† ADD THIS LINE

  // Setup sticky save button
setupStickySaveButton();

  
  // Initialize dashboard (default tab)
  console.log('');
  console.log('ğŸ¨ Initializing dashboard...');
  showTab('dashboard');
  generate12MonthChart();
  
  console.log('');
  console.log('ğŸ‰ APPLICATION READY!');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
}


      // Start the application
      bootstrap();
// ========================================================================
// ENHANCED REPORTS & ANALYTICS - GLOBAL FILTER SYSTEM
// ========================================================================

// Store chart instances
const ReportsCharts = {
  employeeStatus: null,
  byType: null,
  byDepartment: null,
  byJobTitle: null,
  trend: null
};

// Get filtered date range based on global filter
function getFilteredDateRange() {
  const filter = document.getElementById('global-reports-filter')?.value || 'all-time';
  const now = new Date();
  let startDate = null;
  let endDate = now;

  // ğŸ†• CHECK IF CUSTOM DATE RANGE IS SELECTED
  if (filter === 'custom') {
    const customStart = document.getElementById('custom-start-date')?.value;
    const customEnd = document.getElementById('custom-end-date')?.value;
    
    if (customStart) {
      startDate = new Date(customStart);
      startDate.setHours(0, 0, 0, 0); // Start of day
    }
    
    if (customEnd) {
      endDate = new Date(customEnd);
      endDate.setHours(23, 59, 59, 999); // End of day
    }
    
    return { startDate, endDate };
  }

  // EXISTING PREDEFINED FILTERS
  switch (filter) {
    case 'this-month':
      startDate = new Date(now.getFullYear(), now.getMonth(), 1);
      break;
    case 'last-month':
      startDate = new Date(now.getFullYear(), now.getMonth() - 1, 1);
      endDate = new Date(now.getFullYear(), now.getMonth(), 0);
      break;
    case 'last-30':
      startDate = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
      break;
    case 'last-90':
      startDate = new Date(now.getTime() - 90 * 24 * 60 * 60 * 1000);
      break;
    case 'ytd':
      startDate = new Date(now.getFullYear(), 0, 1);
      break;
    case 'all-time':
    default:
      startDate = null;
      break;
  }

  return { startDate, endDate };
}


// Update date range display text
// Update date range display text
function updateDateRangeDisplay() {
  const filter = document.getElementById('global-reports-filter')?.value || 'all-time';
  const displayEl = document.getElementById('reports-date-range-text');
  if (!displayEl) return;

  const { startDate, endDate } = getFilteredDateRange();
  
  let displayText = '';
  
  if (!startDate) {
    displayText = 'All Time';
  } else {
    const formatDate = (d) => d.toLocaleDateString('en-US', { 
      month: 'short', 
      day: 'numeric', 
      year: 'numeric' 
    });
    displayText = `${formatDate(startDate)} - ${formatDate(endDate)}`;
  }
  
  displayEl.textContent = displayText;
}



// Normalize employment status for robust counting
function normalizeStatus(status) {
  if (!status) return 'Active';
  const cleaned = status.trim().toLowerCase();
  if (cleaned === 'active') return 'Active';
  if (cleaned === 'inactive' || cleaned === 'terminated' || cleaned === 'on leave' || cleaned === 'suspended') {
    return 'Inactive'; // Group all non-active as 'Inactive' for high-level counts
  }
  return 'Active'; // fallback
}




// Update KPIs for Reports Tab
function updateReportsKPIs() {
  const actions = getFilteredActions();
  document.getElementById('reports-kpi-total-actions').textContent = actions.length;

  // âœ… Define ALL counts using normalized status
  const terminatedCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Inactive' && e.employment_status?.trim().toLowerCase() === 'terminated'
  ).length;

  const activeCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Active'
  ).length;

  const inactiveCount = AppState.employees.filter(e => 
    normalizeStatus(e.employment_status) === 'Inactive' && e.employment_status?.trim().toLowerCase() !== 'terminated'
  ).length;

  const totalCount = activeCount + terminatedCount;
  const terminationRate = totalCount > 0 
    ? ((terminatedCount / totalCount) * 100).toFixed(1) 
    : '0.0';

  // âœ… Safely update DOM
  const safeText = (id, value) => {
    const el = document.getElementById(id);
    if (el) el.textContent = value;
  };

  safeText('reports-kpi-termination-rate', `${terminationRate}%`);
  safeText('reports-kpi-avg-resolution', '3.2 days');

  // High-risk count
  const highRiskCount = AppState.employees.filter(e => {
    const score = computeRiskScore(e);
    return getRiskLevel(score) === 'HIGH';
  }).length;

  safeText('reports-kpi-high-risk-count', highRiskCount);

  // Optional: update risk distribution counters
  updateRiskDistribution(); // ensures "Low/Medium/High" boxes stay in sync
}






// Chart 2: Actions by Type
// Chart 2: Actions by Type - BAR CHART
function generateActionsByTypeChart() {
  const canvas = document.getElementById('reports-chart-by-type');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byType) {
    ReportsCharts.byType.destroy();
  }

  const actions = getFilteredActions();
  
  let verbal = 0, written = 0, final = 0, termination = 0;
  actions.forEach(action => {
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) verbal++;
    else if (type.includes('WRITTEN')) written++;
    else if (type.includes('FINAL')) final++;
    else if (type.includes('TERMINATION')) termination++;
  });

  ReportsCharts.byType = new Chart(ctx, {
    type: 'bar', // âœ… CHANGED TO BAR
    data: {
      labels: ['Verbal', 'Written', 'Final', 'Termination'],
      datasets: [{
        label: 'Action Count',
        data: [verbal, written, final, termination],
        backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444'],
        borderColor: ['#059669', '#d97706', '#ea580c', '#dc2626'],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          display: false // Hide legend for bar chart
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' },
          callbacks: {
            label: function(context) {
              const total = verbal + written + final + termination;
              const percentage = total > 0 ? ((context.parsed.y / total) * 100).toFixed(1) : '0';
              return `${context.label}: ${context.parsed.y} (${percentage}%)`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' },
          title: {
            display: true,
            text: 'Number of Actions',
            font: { size: 13, weight: 'bold' },
            color: '#334155'
          }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          }
        }
      }
    }
  });
}

// Chart 3: Actions by Department
function generateActionsByDepartmentChart() {
  const canvas = document.getElementById('reports-chart-by-department');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byDepartment) {
    ReportsCharts.byDepartment.destroy();
  }

  const actions = getFilteredActions();
  const deptData = {};

  actions.forEach(action => {
    const dept = action.department;
    if (!deptData[dept]) {
      deptData[dept] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) deptData[dept].verbal++;
    else if (type.includes('WRITTEN')) deptData[dept].written++;
    else if (type.includes('FINAL')) deptData[dept].final++;
    else if (type.includes('TERMINATION')) deptData[dept].termination++;
  });

  const departments = Object.keys(deptData);
  
  ReportsCharts.byDepartment = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: departments,
      datasets: [
        {
          label: 'Verbal',
          data: departments.map(d => deptData[d].verbal),
          backgroundColor: '#10b981',
          borderColor: '#10b981',
          borderWidth: 2
        },
        {
          label: 'Written',
          data: departments.map(d => deptData[d].written),
          backgroundColor: '#f59e0b',
          borderColor: '#f59e0b',
          borderWidth: 2
        },
        {
          label: 'Final',
          data: departments.map(d => deptData[d].final),
          backgroundColor: '#fb923c',
          borderColor: '#fb923c',
          borderWidth: 2
        },
        {
          label: 'Termination',
          data: departments.map(d => deptData[d].termination),
          backgroundColor: '#ef4444',
          borderColor: '#ef4444',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          stacked: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        x: {
          stacked: true,
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

// Chart 4: Actions by Job Title
function generateActionsByJobTitleChart() {
  const canvas = document.getElementById('reports-chart-by-job-title');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.byJobTitle) {
    ReportsCharts.byJobTitle.destroy();
  }

  const actions = getFilteredActions();
  const jobData = {};

  actions.forEach(action => {
    const job = action.jobTitle;
    if (!jobData[job]) {
      jobData[job] = { verbal: 0, written: 0, final: 0, termination: 0 };
    }
    
    const type = action.type.toUpperCase();
    if (type.includes('VERBAL')) jobData[job].verbal++;
    else if (type.includes('WRITTEN')) jobData[job].written++;
    else if (type.includes('FINAL')) jobData[job].final++;
    else if (type.includes('TERMINATION')) jobData[job].termination++;
  });

  const jobs = Object.keys(jobData);
  
  ReportsCharts.byJobTitle = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: jobs,
      datasets: [
        {
          label: 'Verbal',
          data: jobs.map(j => jobData[j].verbal),
          backgroundColor: '#10b981',
          borderColor: '#10b981',
          borderWidth: 2
        },
        {
          label: 'Written',
          data: jobs.map(j => jobData[j].written),
          backgroundColor: '#f59e0b',
          borderColor: '#f59e0b',
          borderWidth: 2
        },
        {
          label: 'Final',
          data: jobs.map(j => jobData[j].final),
          backgroundColor: '#fb923c',
          borderColor: '#fb923c',
          borderWidth: 2
        },
        {
          label: 'Termination',
          data: jobs.map(j => jobData[j].termination),
          backgroundColor: '#ef4444',
          borderColor: '#ef4444',
          borderWidth: 2
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      indexAxis: 'y', // Horizontal bars
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        x: {
          beginAtZero: true,
          stacked: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        y: {
          stacked: true,
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b'
          }
        }
      }
    }
  });
}

// Chart 5: Trend Over Time
function generateTrendChart() {
  const canvas = document.getElementById('reports-trend-chart');
  if (!canvas) return;
  
  const ctx = canvas.getContext('2d');
  if (ReportsCharts.trend) {
    ReportsCharts.trend.destroy();
  }

  // Generate last 12 months
  const months = [];
  const now = new Date();
  for (let i = 11; i >= 0; i--) {
    const d = new Date(now.getFullYear(), now.getMonth() - i, 1);
    months.push(d.toLocaleDateString('en-US', { year: 'numeric', month: 'short' }));
  }

  const datasets = [
    { label: 'Verbal', data: new Array(12).fill(0), borderColor: '#10b981', backgroundColor: 'rgba(16, 185, 129, 0.2)', tension: 0.4, fill: true },
    { label: 'Written', data: new Array(12).fill(0), borderColor: '#f59e0b', backgroundColor: 'rgba(245, 158, 11, 0.2)', tension: 0.4, fill: true },
    { label: 'Final', data: new Array(12).fill(0), borderColor: '#fb923c', backgroundColor: 'rgba(251, 146, 60, 0.2)', tension: 0.4, fill: true },
    { label: 'Termination', data: new Array(12).fill(0), borderColor: '#ef4444', backgroundColor: 'rgba(239, 68, 68, 0.2)', tension: 0.4, fill: true }
  ];

  const actions = getFilteredActions();
  
  actions.forEach(action => {
    const actionDate = new Date(action.date);
    const monthStr = actionDate.toLocaleDateString('en-US', { year: 'numeric', month: 'short' });
    const monthIndex = months.indexOf(monthStr);
    
    if (monthIndex >= 0) {
      const type = action.type.toUpperCase();
      if (type.includes('VERBAL')) datasets[0].data[monthIndex]++;
      else if (type.includes('WRITTEN')) datasets[1].data[monthIndex]++;
      else if (type.includes('FINAL')) datasets[2].data[monthIndex]++;
      else if (type.includes('TERMINATION')) datasets[3].data[monthIndex]++;
    }
  });

  ReportsCharts.trend = new Chart(ctx, {
    type: 'line',
    data: { labels: months, datasets },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            usePointStyle: true,
            padding: 20,
            font: { size: 13, weight: 'bold', family: "'Inter', sans-serif" },
            color: '#334155'
          }
        },
        tooltip: {
          backgroundColor: 'rgba(0, 0, 0, 0.9)',
          padding: 12,
          titleFont: { size: 14, weight: 'bold' },
          bodyFont: { size: 13, weight: 'bold' }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1,
            font: { size: 12, weight: 'bold' },
            color: '#64748b'
          },
          grid: { color: 'rgba(0, 0, 0, 0.06)' }
        },
        x: {
          grid: { display: false },
          ticks: {
            font: { size: 11, weight: 'bold' },
            color: '#64748b',
            maxRotation: 45,
            minRotation: 45
          }
        }
      }
    }
  });
}

// Update Risk Distribution
function updateRiskDistribution() {
  let low = 0, medium = 0, high = 0;
  
  AppState.employees.forEach(emp => {
    const score = computeRiskScore(emp);
    const level = getRiskLevel(score);
    if (level === 'LOW') low++;
    else if (level === 'MEDIUM') medium++;
    else high++;
  });

  document.getElementById('reports-risk-low-count').textContent = low;
  document.getElementById('reports-risk-medium-count').textContent = medium;
  document.getElementById('reports-risk-high-count').textContent = high;
}

// Populate Reports Table
function populateReportsTable() {
  const tbody = document.getElementById('reports-table-body');
  if (!tbody) return;

  const actions = getFilteredActions();
  actions.sort((a, b) => new Date(b.date) - new Date(a.date));

  tbody.innerHTML = '';

  if (actions.length === 0) {
    tbody.innerHTML = '<tr><td colspan="7" class="px-3 py-4 text-center text-slate-400">No actions found for selected filter</td></tr>';
    return;
  }

  actions.slice(0, 100).forEach(action => {
    const row = document.createElement('tr');
    row.innerHTML = `
      <td class="px-3 py-2 text-slate-600">${formatDate(action.date)}</td>
      <td class="px-3 py-2 text-slate-900 font-bold">${action.employeeName}</td>
      <td class="px-3 py-2 text-slate-600">${action.department}</td>
      <td class="px-3 py-2 text-slate-600">${action.jobTitle}</td>
      <td class="px-3 py-2 text-slate-900">${action.type}</td>
      <td class="px-3 py-2 text-slate-600">${action.severity || '--'}</td>
      <td class="px-3 py-2 text-slate-600 text-xs">${(action.reason || '').substring(0, 60)}${action.reason && action.reason.length > 60 ? '...' : ''}</td>
    `;
    tbody.appendChild(row);
  });
}

// Attach global filter listener
const globalFilter = document.getElementById('global-reports-filter');
if (globalFilter) {
  globalFilter.addEventListener('change', () => {
    console.log('ğŸ”„ Global filter changed, updating all charts...');
    updateReports();
  });
}

// CSV Export
const csvExportBtn = document.getElementById('reports-table-export-csv');
if (csvExportBtn) {
  csvExportBtn.addEventListener('click', () => {
    const actions = getFilteredActions();
    
    let csv = 'Date,Employee,Department,Job Title,Action Type,Severity,Reason\n';
    
    actions.forEach(action => {
      const reason = (action.reason || '').replace(/"/g, '""').replace(/\n/g, ' ');
      csv += `"${formatDate(action.date)}","${action.employeeName}","${action.department}","${action.jobTitle}","${action.type}","${action.severity || ''}","${reason}"\n`;
    });
    
    const blob = new Blob([csv], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `discipline-actions-${new Date().toISOString().split('T')[0]}.csv`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showToast('CSV exported successfully', 'success');
  });
}
// Master function to update all reports
function updateReports() {
  console.log('ğŸ“Š Updating Reports & Analytics...');
  
  updateReportsKPIs();
  updateDateRangeDisplay();
  
  generateActionsByTypeChart();
  generateActionsByDepartmentChart();
  generateActionsByJobTitleChart();
  generateTrendChart();
  
  updateRiskDistribution();
  populateReportsTable();
  
  console.log('âœ… Reports updated successfully');
}

// ========================================================================
// EMPLOYEES 360: DEPARTMENT â†’ JOB TITLE CASCADE
// ========================================================================
const JOB_TITLES_BY_DEPARTMENT = {
  'FOH': [
    'FOH Manager',
    'Server',
    'Bartender',
    'Host',
    'Cashier',
    'Busser'
  ],
  'BOH': [
    'Line Cook',
    'Wok Chef',
    'Dumpling Maker',
    'Prep Cook',
    'Pastry Chef',
    'Dishwasher',
    'Production Manager',
    'Logistic Coordinator'
  ]
};



// ========================================================================
// EMPLOYEES 360: COMPENSATION TYPE SWITCHER
// ========================================================================
function setupCompensationTypeSwitcher() {
  const compTypeDropdown = document.getElementById('edit-compensation-type');
  const hourlyContainer = document.getElementById('hourly-rate-container');
  const salaryContainer = document.getElementById('annual-salary-container');
  const hourlyInput = document.getElementById('edit-hourly-rate');
  const salaryInput = document.getElementById('edit-annual-salary');
  const calculatedDisplay = document.getElementById('display-calculated-hourly');

  if (!compTypeDropdown || !hourlyContainer || !salaryContainer || !calculatedDisplay) return;

  function updateDisplay() {
    const compType = compTypeDropdown.value;
    if (compType === 'hourly') {
      hourlyContainer.style.display = 'block';
      salaryContainer.style.display = 'none';
      // Hide the calculated hourly rate display for hourly employees
      calculatedDisplay.parentElement.style.display = 'none'; // This hides the entire container
    } else if (compType === 'salary') {
      hourlyContainer.style.display = 'none';
      salaryContainer.style.display = 'block';
      // Show the calculated hourly rate display for salaried employees
      calculatedDisplay.parentElement.style.display = 'block';
      // Calculate hourly rate from annual salary
      const annualSalary = parseFloat(salaryInput.value) || 0;
      if (annualSalary > 0) {
        const hourlyRate = (annualSalary / 2080).toFixed(2); // 2080 = 52 weeks * 40 hours
        calculatedDisplay.textContent = `$${hourlyRate}/hour`;
      } else {
        calculatedDisplay.textContent = '--';
      }
    }
  }

  // Listen for compensation type changes
  compTypeDropdown.addEventListener('change', updateDisplay);
  // Listen for salary input changes to update calculated hourly
  salaryInput.addEventListener('input', updateDisplay);
  // Initial display
  updateDisplay();
}

// ========================================================================
// CALL THESE FUNCTIONS IN YOUR BOOTSTRAP
// ========================================================================
// âœ… Silent auto-refresh every 10 seconds
setInterval(() => {
  const now = new Date();
  const el = document.getElementById('header-last-refreshed');
  if (el) {
    el.textContent = now.toLocaleString('en-US', {
      month: 'short',
      day: 'numeric',
      hour: '2-digit',
      minute: '2-digit'
    });
  }
}, 10000);



// âœ… Initialize tabs â€” show Dashboard first
// âœ… Initialize tabs on load
document.addEventListener('DOMContentLoaded', () => {
  // Attach tab click handlers
  document.querySelectorAll('.tab-trigger').forEach(btn => {
    btn.addEventListener('click', () => {
      const tab = btn.dataset.tabTarget;
      if (tab) showTab(tab);
    });
  });

  // âœ… CRITICAL: Show Dashboard on load
  showTab('dashboard');
});







// ========================================================================
// DASHBOARD CHARTS - FIXED VERSION
// ========================================================================
// ========================================================================
// DASHBOARD CHARTS - NEW 3x3 GRID VERSION
// ========================================================================
// ========================================================================
// DASHBOARD CHARTS - NEW 3x3 GRID VERSION
// ========================================================================
// ========================================================================
// DASHBOARD CHARTS - FIXED VERSION WITH PROPER DATALABELS HANDLING
// ========================================================================
function renderDashboardCharts(actions) {
  console.log('ğŸ“Š Rendering Dashboard Charts...');

  // ğŸ”¹ 1. Employee Status Bar Chart (1x2) - NO LABELS
  const statusCtx = document.getElementById('chart-employee-status-bar')?.getContext('2d');
  if (statusCtx) {
    if (AppState.charts.employeeStatusChart) {
      AppState.charts.employeeStatusChart.destroy();
    }

    const nonOwnerEmployees = excludeOwners(AppState.employees);
    const active = nonOwnerEmployees.filter(e => normalizeStatus(e.employment_status) === 'Active').length;
    const inactive = nonOwnerEmployees.length - active;

    AppState.charts.employeeStatusChart = new Chart(statusCtx, {
      type: 'bar',
      data: {
        labels: ['Active', 'Inactive'],
        datasets: [{
          label: 'Employee Count',
          data: [active, inactive],
          backgroundColor: ['#10b981', '#f59e0b'],
          borderWidth: 1
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: { display: false } // âœ… DISABLE LABELS
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  }

  // ğŸ”¹ 2. Disciplinary Actions by Job Title - NO LABELS
  const jobTitleCtx = document.getElementById('chart-actions-by-job-title')?.getContext('2d');
  if (jobTitleCtx) {
    if (AppState.charts.actionsByJobTitleChart) {
      AppState.charts.actionsByJobTitleChart.destroy();
    }
    const jobTitleMap = {};
    actions.forEach(a => {
      const job = a.jobTitle || 'Unknown';
      if (!jobTitleMap[job]) {
        jobTitleMap[job] = { verbal: 0, written: 0, final: 0, termination: 0 };
      }
      const t = (a.type || '').toLowerCase();
      if (t.includes('verbal')) jobTitleMap[job].verbal++;
      else if (t.includes('written')) jobTitleMap[job].written++;
      else if (t.includes('final')) jobTitleMap[job].final++;
      else if (t.includes('termination')) jobTitleMap[job].termination++;
    });
    const jobTitles = Object.keys(jobTitleMap);
    AppState.charts.actionsByJobTitleChart = new Chart(jobTitleCtx, {
      type: 'bar',
      data: {
        labels: jobTitles,
        datasets: [
          { label: 'Verbal', data: jobTitles.map(j => jobTitleMap[j].verbal), backgroundColor: '#10b981' },
          { label: 'Written', data: jobTitles.map(j => jobTitleMap[j].written), backgroundColor: '#f59e0b' },
          { label: 'Final', data: jobTitles.map(j => jobTitleMap[j].final), backgroundColor: '#fb923c' },
          { label: 'Termination', data: jobTitles.map(j => jobTitleMap[j].termination), backgroundColor: '#ef4444' }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        indexAxis: 'y',
        plugins: {
          legend: { position: 'top' },
          datalabels: { display: false }, // âœ… DISABLE LABELS
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: ${ctx.raw}`
            }
          }
        },
        scales: {
          x: { beginAtZero: true, stacked: true, ticks: { stepSize: 1 } },
          y: { stacked: true, grid: { display: false } }
        }
      }
    });
  }

  // ğŸ”¹ 3. FOH Discipline Actions - NO LABELS
  const fohTypeCtx = document.getElementById('chart-actions-by-type-foh')?.getContext('2d');
  if (fohTypeCtx) {
    if (AppState.charts.actionsByTypeFohChart) {
      AppState.charts.actionsByTypeFohChart.destroy();
    }

    const typeMap = { 'Verbal': 0, 'Written': 0, 'Final': 0, 'Termination': 0 };
    actions.forEach(a => {
      const jobTitle = (a.jobTitle || '').toLowerCase().trim();
      let mappedKey = null;
      for (const [rawKey, mapped] of Object.entries(positionMap)) {
        if (jobTitle.includes(rawKey)) {
          mappedKey = mapped;
          break;
        }
      }
      const isFOH = mappedKey && fohPositions.includes(mappedKey);
      if (!isFOH) return;

      const t = a.type?.toLowerCase() || '';
      if (t.includes('verbal')) typeMap.Verbal++;
      else if (t.includes('written')) typeMap.Written++;
      else if (t.includes('final')) typeMap.Final++;
      else if (t.includes('termination')) typeMap.Termination++;
    });

    AppState.charts.actionsByTypeFohChart = new Chart(fohTypeCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(typeMap),
        datasets: [{
          label: 'FOH Actions',
          data: Object.values(typeMap),
          backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: { display: false } // âœ… DISABLE LABELS
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  }

  // ğŸ”¹ 4. BOH Discipline Actions - NO LABELS
  const bohTypeCtx = document.getElementById('chart-actions-by-type-boh')?.getContext('2d');
  if (bohTypeCtx) {
    if (AppState.charts.actionsByTypeBohChart) {
      AppState.charts.actionsByTypeBohChart.destroy();
    }

    const typeMap = { 'Verbal': 0, 'Written': 0, 'Final': 0, 'Termination': 0 };
    actions.forEach(a => {
      const jobTitle = (a.jobTitle || '').toLowerCase().trim();
      let mappedKey = null;
      for (const [rawKey, mapped] of Object.entries(positionMap)) {
        if (jobTitle.includes(rawKey)) {
          mappedKey = mapped;
          break;
        }
      }
      const isBOH = mappedKey && bohPositions.includes(mappedKey);
      if (!isBOH) return;

      const t = a.type?.toLowerCase() || '';
      if (t.includes('verbal')) typeMap.Verbal++;
      else if (t.includes('written')) typeMap.Written++;
      else if (t.includes('final')) typeMap.Final++;
      else if (t.includes('termination')) typeMap.Termination++;
    });

    AppState.charts.actionsByTypeBohChart = new Chart(bohTypeCtx, {
      type: 'bar',
      data: {
        labels: Object.keys(typeMap),
        datasets: [{
          label: 'BOH Actions',
          data: Object.values(typeMap),
          backgroundColor: ['#10b981', '#f59e0b', '#fb923c', '#ef4444']
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { display: false },
          datalabels: { display: false } // âœ… DISABLE LABELS
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });
  }

  // ğŸ”¹ 5. FOH & BOH Employee Status Chart - WITH LABELS âœ…
  const fohBohCtx = document.getElementById('chart-employee-status-foh-boh')?.getContext('2d');
  if (fohBohCtx) {
    if (AppState.charts.employeeStatusFohBohChart) {
      AppState.charts.employeeStatusFohBohChart.destroy();
    }

    const owners = ['janelle teng', 'francisco teng'];
    const nonOwnerEmployees = AppState.employees.filter(emp => {
      const fullName = `${emp.first_name || ''} ${emp.last_name || ''}`.trim().toLowerCase();
      return !owners.includes(fullName);
    });

    const fohPositions = ['foh-manager', 'server', 'bartender', 'host', 'cashier'];
    const bohPositions = ['line-cook', 'wok-chef', 'dumpling-maker', 'prep-cook', 'pastry-chef', 'dishwasher', 'production-manager', 'logistic-coordinator', 'busser'];

    const getPositionKey = (jobTitle) => {
      const title = (jobTitle || '').toLowerCase().trim();
      for (const [rawKey, mapped] of Object.entries(positionMap)) {
        if (title.includes(rawKey)) return mapped;
      }
      return null;
    };

    const fohActive = nonOwnerEmployees.filter(e => 
      normalizeStatus(e.employment_status) === 'Active' && 
      fohPositions.includes(getPositionKey(e.job_title))
    ).length;

    const fohInactive = nonOwnerEmployees.filter(e => 
      normalizeStatus(e.employment_status) === 'Inactive' && 
      fohPositions.includes(getPositionKey(e.job_title))
    ).length;

    const bohActive = nonOwnerEmployees.filter(e => 
      normalizeStatus(e.employment_status) === 'Active' && 
      bohPositions.includes(getPositionKey(e.job_title))
    ).length;

    const bohInactive = nonOwnerEmployees.filter(e => 
      normalizeStatus(e.employment_status) === 'Inactive' && 
      bohPositions.includes(getPositionKey(e.job_title))
    ).length;

    AppState.charts.employeeStatusFohBohChart = new Chart(fohBohCtx, {
      type: 'bar',
      data: {
        labels: ['FOH', 'BOH'],
        datasets: [
          {
            label: 'Active',
            data: [fohActive, bohActive],
            backgroundColor: '#10b981',
            borderWidth: 1
          },
          {
            label: 'Inactive',
            data: [fohInactive, bohInactive],
            backgroundColor: '#f59e0b',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: { position: 'top' },
          datalabels: {
            display: true, // âœ… ENABLE LABELS FOR THIS CHART ONLY
            anchor: 'end',
            align: 'top',
            formatter: (value) => value > 0 ? value : '',
            font: { weight: 'bold', size: 12 },
            color: '#000'
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            ticks: { stepSize: 1 }
          }
        }
      }
    });

    console.log('ğŸ“Š FOH/BOH Status Chart Data â†’ FOH:', { Active: fohActive, Inactive: fohInactive }, '| BOH:', { Active: bohActive, Inactive: bohInactive });
  }
}





function renderFohBohStatusChart() {
  console.log('ğŸ“Š Rendering FOH & BOH Employee Status Chart...');

  const fohCtx = document.getElementById('chart-employee-status-foh-boh')?.getContext('2d');
  if (!fohCtx) return;

  // Destroy existing chart if it exists
  if (AppState.charts.employeeStatusFohBohChart) {
    AppState.charts.employeeStatusFohBohChart.destroy();
  }

  // Calculate counts
  const fohActive = AppState.employees.filter(e => normalizeStatus(e.employment_status) === 'Active' && fohPositions.some(p => e.job_title?.toLowerCase().includes(p))).length;
  const fohInactive = AppState.employees.filter(e => normalizeStatus(e.employment_status) !== 'Active' && fohPositions.some(p => e.job_title?.toLowerCase().includes(p))).length;
  const bohActive = AppState.employees.filter(e => normalizeStatus(e.employment_status) === 'Active' && bohPositions.some(p => e.job_title?.toLowerCase().includes(p))).length;
  const bohInactive = AppState.employees.filter(e => normalizeStatus(e.employment_status) !== 'Active' && bohPositions.some(p => e.job_title?.toLowerCase().includes(p))).length;

  AppState.charts.employeeStatusFohBohChart = new Chart(fohCtx, {
    type: 'bar',
    data: {
      labels: ['FOH', 'BOH'],
      datasets: [
        {
          label: 'Active',
          data: [fohActive, bohActive],
          backgroundColor: '#10b981',
          borderWidth: 1
        },
        {
          label: 'Inactive',
          data: [fohInactive, bohInactive],
          backgroundColor: '#f59e0b',
          borderWidth: 1
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'top'
        },
        tooltip: {
          callbacks: {
            label: function(context) {
              return `${context.dataset.label}: ${context.raw}`;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1
          }
        }
      }
    }
  });
}








// ============================================================================
// COMPENSATION LETTER TAB - COMPLETE ENHANCED IMPLEMENTATION
// ============================================================================

const CompensationState = {
  selectedEmployee: null,
  wageHistory: [],
  searchTimeout: null,
  tipPositions: ['server', 'bartender', 'busser', 'host', 'hostess', 'cashier']
};

// ============================================================================
// 1. SEARCH EMPLOYEE FOR COMPENSATION LETTER
// ============================================================================
function setupCompensationLetterSearch() {
  const searchInput = document.getElementById('comp-letter-search');
  const dropdown = document.getElementById('comp-letter-search-dropdown');
  
  if (!searchInput || !dropdown) {
    console.warn('âš ï¸ Compensation search elements not found');
    return;
  }

  searchInput.addEventListener('input', (e) => {
    const query = e.target.value.trim();
    
    clearTimeout(CompensationState.searchTimeout);
    
    if (query.length < 2) {
      dropdown.classList.add('hidden');
      return;
    }

    CompensationState.searchTimeout = setTimeout(() => {
      const results = AppState.employees.filter(emp => {
        const fullName = `${emp.first_name} ${emp.last_name}`.toLowerCase();
        const empId = (emp.employee_id || '').toLowerCase();
        return fullName.includes(query.toLowerCase()) || empId.includes(query.toLowerCase());
      }).slice(0, 10);

      dropdown.innerHTML = '';
      
      if (results.length === 0) {
        dropdown.innerHTML = '<div class="px-4 py-3 text-sm text-slate-400">No employees found</div>';
      } else {
        results.forEach(emp => {
          const item = document.createElement('div');
          item.className = 'px-4 py-3 hover:bg-slate-50 cursor-pointer border-b border-slate-100 last:border-0 transition-colors';
          item.innerHTML = `
            <div class="font-bold text-slate-900 text-sm">${emp.first_name} ${emp.last_name}</div>
            <div class="text-xs text-slate-500 mt-1">${emp.employee_id || '--'} â€¢ ${emp.job_title || '--'} â€¢ ${emp.department || '--'}</div>
            <div class="text-xs text-emerald-600 font-bold mt-1">
              Current: $${emp.hourly_rate || '0.00'}/hr
              ${emp.job_title2 ? ` | Pos2: $${emp.hourly_rate2}/hr` : ''}
              ${emp.job_title3 ? ` | Pos3: $${emp.hourly_rate3}/hr` : ''}
            </div>
          `;
          item.addEventListener('click', () => {
            selectEmployeeForCompLetter(emp);
            searchInput.value = `${emp.first_name} ${emp.last_name}`;
            dropdown.classList.add('hidden');
          });
          dropdown.appendChild(item);
        });
      }
      
      dropdown.classList.remove('hidden');
    }, 300);
  });

  // Close dropdown on outside click
  document.addEventListener('click', (e) => {
    if (!searchInput.contains(e.target) && !dropdown.contains(e.target)) {
      dropdown.classList.add('hidden');
    }
  });

  console.log('âœ… Compensation search initialized');
}




// ============================================================================
// 2. SELECT EMPLOYEE & LOAD DATA - FIXED VERSION
// ============================================================================
// ============================================================================
// 2. SELECT EMPLOYEE & PRE-FILL FORM
// ============================================================================

async function selectEmployeeForCompLetter(employee) {
  console.log('ğŸ“ Loading employee for compensation letter:', employee);
  
  CompensationState.selectedEmployee = employee;
  
  // Show employee info section
  const infoSection = document.getElementById('comp-letter-employee-info');
  if (infoSection) infoSection.classList.remove('hidden');
  
  // Update employee info display
  const nameEl = document.getElementById('comp-letter-employee-name');
  if (nameEl) nameEl.textContent = `${employee.first_name} ${employee.last_name}`;
  
  const idEl = document.getElementById('comp-letter-employee-id');
  if (idEl) idEl.textContent = employee.employee_id || '--';
  
  const deptEl = document.getElementById('comp-letter-employee-dept');
  if (deptEl) deptEl.textContent = employee.department || '--';
  
  // Set hidden employee ID for form submission
  const hiddenIdEl = document.getElementById('comp-letter-selected-employee-id');
  if (hiddenIdEl) hiddenIdEl.value = employee.id;
  
  // ============================================================================
  // ğŸ†• CORPORATE TABLE GRID - CURRENT COMPENSATION STATUS
  // ============================================================================
  const positionsContainer = document.getElementById('comp-letter-current-positions');
  if (positionsContainer) {
    positionsContainer.innerHTML = '';
    
    const getMeetingPay = (meetingPayData) => {
      if (!meetingPayData) return null;
      if (typeof meetingPayData === 'object' && meetingPayData.rate) {
        return parseFloat(meetingPayData.rate);
      }
      if (typeof meetingPayData === 'number') {
        return meetingPayData;
      }
      return null;
    };
    
    const calculateOvertimeRate = (hourlyRate) => {
      return hourlyRate ? (parseFloat(hourlyRate) * 1.5).toFixed(2) : null;
    };
    
    const trainingPay = employee.trainning ? parseFloat(employee.trainning) : null;
    const meetingPay = getMeetingPay(employee.meetingpay);
    const vacationPay = employee.vacation ? parseFloat(employee.vacation) : null;
    const overtimeRate = employee.overtime ? 
      parseFloat(employee.overtime).toFixed(2) : 
      calculateOvertimeRate(employee.hourly_rate);
    
    const positions = [];
    
    if (employee.job_title && employee.hourly_rate) {
      positions.push({
        badge: 'POS 1',
        badgeColor: 'emerald',
        title: employee.job_title,
        baseRate: parseFloat(employee.hourly_rate)
      });
    }
    
    if (employee.job_title2 && employee.hourly_rate2) {
      positions.push({
        badge: 'POS 2',
        badgeColor: 'blue',
        title: employee.job_title2,
        baseRate: parseFloat(employee.hourly_rate2)
      });
    }
    
    if (employee.job_title3 && employee.hourly_rate3) {
      positions.push({
        badge: 'POS 3',
        badgeColor: 'purple',
        title: employee.job_title3,
        baseRate: parseFloat(employee.hourly_rate3)
      });
    }
    
    const hasMultiplePositions = positions.length > 1;
    
    if (positions.length > 0) {
      const table = document.createElement('div');
      table.className = 'bg-white rounded-lg border border-gray-300 overflow-hidden shadow-sm';
      
      table.innerHTML = `
        <div class="bg-gradient-to-r from-gray-50 to-gray-100 border-b border-gray-300">
          <div class="grid grid-cols-7 gap-4 px-4 py-3">
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide">Position</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide">Title</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Base Rate</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Training</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Meeting</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Overtime</div>
            <div class="col-span-1 text-xs font-bold text-gray-700 uppercase tracking-wide text-right">Vacation</div>
          </div>
        </div>
        
        <div class="divide-y divide-gray-200">
          ${positions.map((pos, index) => `
            <div class="grid grid-cols-7 gap-4 px-4 py-3 hover:bg-gray-50 transition-colors">
              <div class="col-span-1 flex items-center">
                <span class="inline-flex items-center bg-${pos.badgeColor}-600 text-white px-2 py-1 rounded text-xs font-bold whitespace-nowrap">
                  ${pos.badge}
                </span>
              </div>
              
              <div class="col-span-1 flex items-center">
                <span class="font-semibold text-gray-900 text-sm">${pos.title}</span>
              </div>
              
              <div class="col-span-1 flex items-center justify-end">
                <span class="font-bold text-gray-900 text-sm">$${pos.baseRate.toFixed(2)}</span>
              </div>
              
              <div class="col-span-1 flex items-center justify-end">
                ${index === 0 && trainingPay ? 
                  `<span class="font-semibold text-gray-700 text-sm">$${trainingPay.toFixed(2)}</span>` : 
                  '<span class="text-gray-400 text-xs">N/A</span>'}
              </div>
              
              <div class="col-span-1 flex items-center justify-end">
                ${meetingPay ? 
                  `<span class="font-semibold text-gray-700 text-sm">$${meetingPay.toFixed(2)}</span>` : 
                  '<span class="text-gray-400 text-xs">N/A</span>'}
              </div>
              
              <div class="col-span-1 flex items-center justify-end">
                ${index === 0 ? (
                  hasMultiplePositions ? 
                    `<span class="text-xs font-bold text-amber-900 bg-amber-100 px-2.5 py-1.5 rounded border border-amber-300 shadow-sm whitespace-nowrap">
                      Blended: $${overtimeRate}
                    </span>` :
                    `<span class="font-semibold text-emerald-700 text-sm">$${overtimeRate}</span>`
                ) : '<span class="text-gray-300 text-xs">â†‘</span>'}
              </div>
              
              <div class="col-span-1 flex items-center justify-end">
                ${vacationPay ? 
                  `<span class="font-semibold text-gray-700 text-sm">$${vacationPay.toFixed(2)}</span>` : 
                  '<span class="text-gray-400 text-xs">N/A</span>'}
              </div>
            </div>
          `).join('')}
        </div>
        
        ${hasMultiplePositions ? `
          <div class="bg-amber-50 border-t border-amber-200 px-4 py-2.5">
            <div class="flex items-center space-x-2 text-xs text-amber-900">
              <i class="fas fa-info-circle"></i>
              <span class="font-semibold">Multi-position employee: Overtime rate of $${overtimeRate}/hr applies to all positions (blended rate methodology)</span>
            </div>
          </div>
        ` : ''}
      `;
      
      positionsContainer.appendChild(table);
    } else {
      positionsContainer.innerHTML = `
        <div class="bg-gray-50 border border-gray-300 rounded-lg p-6 text-center">
          <i class="fas fa-inbox text-gray-400 text-3xl mb-2"></i>
          <div class="text-gray-500 text-sm font-semibold">No active positions found</div>
        </div>
      `;
    }
  }
  // ============================================================================
  
  // ğŸ†• LOAD ALL POSITIONS INTO EDITABLE FORM
  loadPositionsIntoForm(employee);
  
  // Pre-fill hire date
  const hireDateInput = document.getElementById('comp-letter-hire-date');
  if (hireDateInput && employee.original_hire_date) {
    hireDateInput.value = employee.original_hire_date;
  }
  
  // Set effective date to today
  const today = new Date().toISOString().split('T')[0];
  const dateInput = document.getElementById('comp-letter-effective-date');
  if (dateInput) dateInput.value = today;
  
  // Load wage history from database
  await loadWageHistory(employee.id);
  
  // Scroll to form
  const form = document.getElementById('comp-letter-form');
  if (form) {
    form.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }
  
  showToast(`âœ… Loaded: ${employee.first_name} ${employee.last_name}`, 'success');
  
  if (window.showStickySaveButton) {
    window.showStickySaveButton();
  }
  
  setTimeout(() => {
    autoCalculatePayRates();
  }, 100);
}


// ============================================================================
// ğŸ†• LOAD ALL POSITIONS INTO EDITABLE FORM
// ============================================================================
// Add this to the END of loadPositionsIntoForm() function
// ============================================================================
// LOAD POSITIONS INTO FORM (AUTO-FILL ALL FIELDS)
// ============================================================================
function loadPositionsIntoForm(employee) {
  if (!employee) return;
  
  console.log('ğŸ“‹ Loading positions into form:', employee);
  
  // PRIMARY JOB (always exists)
  document.getElementById('primary-job-title').value = employee.job_title || '';
  document.getElementById('primary-department').value = employee.department || '';
  document.getElementById('primary-wage').value = employee.hourly_rate || '';
  
  // SECONDARY JOB (if exists)
  if (employee.job_title2 && employee.hourly_rate2) {
    document.getElementById('secondary-job-title').value = employee.job_title2;
    document.getElementById('secondary-department').value = employee.department || '';
    document.getElementById('secondary-wage').value = employee.hourly_rate2;
  } else {
    // Clear if no secondary job
    document.getElementById('secondary-job-title').value = '';
    document.getElementById('secondary-department').value = '';
    document.getElementById('secondary-wage').value = '';
  }
  
  // TERTIARY JOB (if exists)
  if (employee.job_title3 && employee.hourly_rate3) {
    document.getElementById('tertiary-job-title').value = employee.job_title3;
    document.getElementById('tertiary-department').value = employee.department || '';
    document.getElementById('tertiary-wage').value = employee.hourly_rate3;
  } else {
    // Clear if no tertiary job
    document.getElementById('tertiary-job-title').value = '';
    document.getElementById('tertiary-department').value = '';
    document.getElementById('tertiary-wage').value = '';
  }
  
  // ADDITIONAL COMPENSATION
  const trainingPay = employee.trainning || '';
  const meetingPay = employee.meetingpay?.rate || employee.meetingpay || '';
  const vacationPay = employee.vacation || '';
  
  document.getElementById('comp-letter-training-pay').value = trainingPay;
  document.getElementById('comp-letter-meeting-pay').value = meetingPay;
  document.getElementById('comp-letter-vacation-pay').value = vacationPay;
  
  // EMPLOYMENT INFO
  const employmentType = employee.employment_type || 'part_time';
  document.getElementById('comp-letter-employment-type').value = employmentType;
  
  const hireDate = employee.original_hire_date || employee.hire_date || '';
  document.getElementById('comp-letter-hire-date').value = hireDate;
  
  // Calculate overtime after loading all data
  setTimeout(() => {
    calculateOvertimeRate();
  }, 100);
  
  console.log('âœ… Positions loaded into form successfully');
}

// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================
// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================
function clearSecondaryPosition() {
  console.log('ğŸ”´ clearSecondaryPosition called!');
  alert('Delete button clicked!');
  
  if (confirm('âš ï¸ Are you sure you want to delete the Secondary position?')) {
    console.log('âœ… User confirmed delete');
    
    const jobField = document.getElementById('secondary-job-title');
    const deptField = document.getElementById('secondary-department');
    const wageField = document.getElementById('secondary-wage');
    
    console.log('Fields found:', { jobField, deptField, wageField });
    
    if (jobField) jobField.value = '';
    if (deptField) deptField.value = '';
    if (wageField) wageField.value = '';
    
    calculateOvertimeRate();
    showToast('âœ… Secondary position cleared', 'success');
  }
}

function clearTertiaryPosition() {
  console.log('ğŸ”´ clearTertiaryPosition called!');
  alert('Delete button clicked!');
  
  if (confirm('âš ï¸ Are you sure you want to delete the Tertiary position?')) {
    console.log('âœ… User confirmed delete');
    
    const jobField = document.getElementById('tertiary-job-title');
    const deptField = document.getElementById('tertiary-department');
    const wageField = document.getElementById('tertiary-wage');
    
    console.log('Fields found:', { jobField, deptField, wageField });
    
    if (jobField) jobField.value = '';
    if (deptField) deptField.value = '';
    if (wageField) wageField.value = '';
    
    calculateOvertimeRate();
    showToast('âœ… Tertiary position cleared', 'success');
  }
}

// â­ ADD THESE 2 LINES RIGHT HERE â­
window.clearSecondaryPosition = clearSecondaryPosition;
window.clearTertiaryPosition = clearTertiaryPosition;

// ============================================================================
// ğŸ†• ADD NEW POSITION
// ============================================================================
function addNewPosition(slot, meetingPay, vacationPay, overtimePay) {
  const newPosition = {
    slot: slot,
    jobTitle: '',
    hourlyRate: '',
    department: 'FOH'
  };
  
  const formContainer = document.getElementById('comp-letter-positions-form-container');
  if (!formContainer) return;
  
  // Remove "Add Position" button
  const addBtn = formContainer.querySelector('button[onclick*="addNewPosition"]');
  if (addBtn) addBtn.remove();
  
  // Get current position count
  const currentPositions = formContainer.querySelectorAll('[data-position-slot]').length;
  
  // Add new position card
  const card = createPositionCard(newPosition, currentPositions, '', meetingPay, vacationPay, overtimePay, currentPositions + 1);
  formContainer.appendChild(card);
  
  // Re-add "Add Position" button if still under 3
  if (currentPositions + 1 < 3) {
    const addBtn = document.createElement('button');
    addBtn.type = 'button';
    addBtn.className = 'w-full bg-blue-50 hover:bg-blue-100 border-2 border-dashed border-blue-300 rounded-lg py-4 px-6 flex items-center justify-center space-x-2 text-blue-700 font-bold transition-all';
    addBtn.innerHTML = `
      <i class="fas fa-plus-circle text-xl"></i>
      <span>Add Another Position (${currentPositions + 1}/3)</span>
    `;
    addBtn.onclick = () => addNewPosition(currentPositions + 2, meetingPay, vacationPay, overtimePay);
    formContainer.appendChild(addBtn);
  }
  
  showToast('âœ… Position added', 'success');
  recalculateOvertimeRate();
}

// ============================================================================
// ğŸ†• REMOVE POSITION
// ============================================================================


// ============================================================================
// ğŸ†• RECALCULATE OVERTIME RATE (Blended if 2+ positions)
// ============================================================================
function recalculateOvertimeRate() {
  const positions = document.querySelectorAll('[data-position-slot]');
  const overtimeDisplay = document.getElementById('overtime-rate-display');
  
  if (positions.length > 1) {
    // Multi-position: Show "Blended OT" message
    if (overtimeDisplay) {
      overtimeDisplay.innerHTML = `
        <div class="bg-amber-100 border border-amber-300 rounded-lg p-4 text-center">
          <span class="text-amber-900 font-bold text-sm">
            <i class="fas fa-info-circle mr-2"></i>
            Blended Overtime Rate will be calculated based on all positions
          </span>
        </div>
      `;
    }
  } else {
    // Single position: Calculate 1.5x
    const hourlyRate = document.getElementById('hourly-rate-1')?.value;
    if (hourlyRate && overtimeDisplay) {
      const ot = (parseFloat(hourlyRate) * 1.5).toFixed(2);
      overtimeDisplay.innerHTML = `
        <div class="bg-emerald-100 border border-emerald-300 rounded-lg p-4 text-center">
          <span class="text-emerald-900 font-bold text-lg">
            Overtime Rate: $${ot}/hr <span class="text-sm font-normal">(1.5x Base)</span>
          </span>
        </div>
      `;
    }
  }
}














// ============================================================================
// DISPLAY CURRENT COMPENSATION STATUS - READ ONLY
// ============================================================================
function displayCurrentCompensationStatus(employee) {
  console.log('ğŸ“Š Displaying current compensation status for:', employee);
  
  const statusSection = document.getElementById('comp-letter-current-status');
  if (!statusSection) return;
  
  // Show the status section
  statusSection.classList.remove('hidden');
  
  // âœ… POSITION 1 - PRIMARY (Green)
  const pos1Container = document.getElementById('current-position-1');
  if (employee.job_title && employee.hourly_rate) {
    pos1Container.classList.remove('hidden');
    
    document.getElementById('current-pos1-title').textContent = employee.job_title || '--';
    document.getElementById('current-pos1-dept').textContent = employee.department || '--';
    document.getElementById('current-pos1-type').textContent = employee.compensation_type || 'hourly';
    document.getElementById('current-pos1-training').textContent = employee.training_pay ? `$${parseFloat(employee.training_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-hourly').textContent = `$${parseFloat(employee.hourly_rate).toFixed(2)}`;
    document.getElementById('current-pos1-meeting').textContent = employee.meeting_pay ? `$${parseFloat(employee.meeting_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-overtime').textContent = employee.overtime_pay ? `$${parseFloat(employee.overtime_pay).toFixed(2)}` : '--';
    document.getElementById('current-pos1-vacation').textContent = employee.vacation_pay ? `$${parseFloat(employee.vacation_pay).toFixed(2)}` : '--';
  } else {
    pos1Container.classList.add('hidden');
  }
  
  // âœ… POSITION 2 - SECONDARY (Blue)
  const pos2Container = document.getElementById('current-position-2');
  if (employee.job_title2 && employee.hourly_rate2) {
    pos2Container.classList.remove('hidden');
    
    document.getElementById('current-pos2-title').textContent = employee.job_title2 || '--';
    document.getElementById('current-pos2-dept').textContent = employee.department || '--';
    document.getElementById('current-pos2-type').textContent = 'hourly';
    document.getElementById('current-pos2-training').textContent = employee.training_pay2 ? `$${parseFloat(employee.training_pay2).toFixed(2)}` : '--';
    document.getElementById('current-pos2-hourly').textContent = `$${parseFloat(employee.hourly_rate2).toFixed(2)}`;
    document.getElementById('current-pos2-meeting').textContent = employee.meeting_pay2 ? `$${parseFloat(employee.meeting_pay2).toFixed(2)}` : '--';
    document.getElementById('current-pos2-overtime').textContent = 'Blended OT';
    document.getElementById('current-pos2-vacation').textContent = employee.vacation_pay2 ? `$${parseFloat(employee.vacation_pay2).toFixed(2)}` : '--';
  } else {
    pos2Container.classList.add('hidden');
  }
  
  // âœ… POSITION 3 - TERTIARY (Purple)
  const pos3Container = document.getElementById('current-position-3');
  if (employee.job_title3 && employee.hourly_rate3) {
    pos3Container.classList.remove('hidden');
    
    document.getElementById('current-pos3-title').textContent = employee.job_title3 || '--';
    document.getElementById('current-pos3-dept').textContent = employee.department || '--';
    document.getElementById('current-pos3-type').textContent = 'hourly';
    document.getElementById('current-pos3-training').textContent = employee.training_pay3 ? `$${parseFloat(employee.training_pay3).toFixed(2)}` : '--';
    document.getElementById('current-pos3-hourly').textContent = `$${parseFloat(employee.hourly_rate3).toFixed(2)}`;
    document.getElementById('current-pos3-meeting').textContent = employee.meeting_pay3 ? `$${parseFloat(employee.meeting_pay3).toFixed(2)}` : '--';
    document.getElementById('current-pos3-overtime').textContent = 'Blended OT';
    document.getElementById('current-pos3-vacation').textContent = employee.vacation_pay3 ? `$${parseFloat(employee.vacation_pay3).toFixed(2)}` : '--';
  } else {
    pos3Container.classList.add('hidden');
  }
  
  console.log('âœ… Current status displayed');
}






























// ============================================================================
// STICKY SAVE BUTTON - CLEAN FAB STYLE
// ============================================================================
function setupStickySaveButton() {
  const stickyBtn = document.getElementById('sticky-comp-letter-save-btn');
  const form = document.getElementById('comp-letter-form');
  const stickyContainer = document.getElementById('comp-letter-sticky-save');
  
  if (!stickyBtn || !form) return;
  
  // SAVE button click
  stickyBtn.addEventListener('click', async (e) => {
    e.preventDefault();
    
    // Validate form first
    if (!form.checkValidity()) {
      const firstInvalid = form.querySelector(':invalid');
      if (firstInvalid) {
        firstInvalid.scrollIntoView({ behavior: 'smooth', block: 'center' });
        firstInvalid.focus();
      }
      showToast('âš ï¸ Please fill in all required fields', 'error');
      return;
    }
    
    // Show loading state
    stickyBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    stickyBtn.disabled = true;
    
    // Trigger the existing save function
    await saveCompensationLetter();
    
    // Reset button
    stickyBtn.innerHTML = '<i class="fas fa-check"></i>';
    stickyBtn.disabled = false;
    
    // Reset after 2 seconds
    setTimeout(() => {
      stickyBtn.innerHTML = '<i class="fas fa-save"></i>';
    }, 2000);
  });
  
  // Show sticky button when employee selected
  window.showStickySaveButton = () => {
    if (CompensationState.selectedEmployee && stickyContainer) {
      stickyContainer.classList.remove('hidden');
    }
  };
  
  // Hide sticky button when form reset
  window.hideStickySaveButton = () => {
    if (stickyContainer) {
      stickyContainer.classList.add('hidden');
    }
  };
}

// ============================================================================
// INITIALIZE - Call this in initCompensationLetterTab()
// ============================================================================
// Add this line at the END of your initCompensationLetterTab() function:
// setupStickySaveButton();















// ============================================================================
// 3. LOAD WAGE HISTORY FROM DATABASE
// ============================================================================
// ============================================================================
// 3. LOAD WAGE HISTORY FROM DATABASE
// ============================================================================
// ============================================================================
// LOAD WAGE HISTORY
// ============================================================================
async function loadWageHistory(employeeId) {
  console.log('ğŸ“Š Loading wage history for employee:', employeeId);
  
  try {
    const { data, error } = await supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', employeeId)
      .order('effective_date', { ascending: false })
      .order('position_number', { ascending: true });

    if (error) {
      console.error('Error loading wage history:', error);
      showToast('Failed to load wage history', 'error');
      CompensationState.wageHistory = [];
      renderWageHistory();
      return;
    }

    CompensationState.wageHistory = data || [];
    renderWageHistory();
    
    console.log(`âœ… Loaded ${CompensationState.wageHistory.length} wage history records`);

  } catch (error) {
    console.error('Critical error loading wage history:', error);
    showToast('Failed to load wage history', 'error');
    CompensationState.wageHistory = [];
    renderWageHistory();
  }
}



// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
// ============================================================================
// DELETE ENTIRE COMPENSATION LETTER (ALL POSITIONS)
// ============================================================================
async function deleteCompensationLetter(employeeId, effectiveDate) {
if (!confirm('âš ï¸ Are you sure you want to delete this entire compensation letter?\n\nThis will delete ALL positions (Primary, Secondary, Tertiary) for this effective date.')) {
  return;
}
  try {
    // Delete ALL wage_history records with this employee_id and effective_date
    const { error } = await supabaseClient
      .from('wage_history')
      .delete()
      .eq('employee_id', employeeId)
      .eq('effective_date', effectiveDate);
    if (error) throw error;
    showToast('âœ… Compensation letter deleted successfully', 'success');
    // Reload wage history
    await loadWageHistory(employeeId);
  } catch (err) {
    console.error('Error deleting compensation letter:', err);
    showToast('âŒ Failed to delete compensation letter', 'error');
  }
}

// Make the function globally accessible
window.deleteCompensationLetter = deleteCompensationLetter;





// ============================================================================
// GROUP WAGE HISTORY BY COMPENSATION LETTER (DATE + EMPLOYEE)
// ============================================================================
// ============================================================================
// GROUP WAGE HISTORY BY COMPENSATION LETTER (DATE + EMPLOYEE)
// ============================================================================
function groupWageHistoryByLetter(wageRecords) {
  const grouped = {};
  
  wageRecords.forEach(record => {
    // Create unique key: employee_id + effective_date
    const key = `${record.employee_id}_${record.effective_date}`;
    
    if (!grouped[key]) {
      grouped[key] = {
        employeeId: record.employee_id,
        effectiveDate: record.effective_date,
        changeType: record.change_type,
        changeReason: record.change_reason,
        approvedBy: record.approved_by,
        employmentType: record.employment_type,
        hireDate: record.hire_date,
        isCurrent: record.is_current,
        letterGenerated: record.letter_generated,
        pdfUrl: record.pdf_url,
        positions: []
      };
    }
    
   // Add this position to the group
grouped[key].positions.push({
  positionNumber: record.position_number,
  positionTitle: record.position_title,
  department: record.department,
  hourlyRate: record.hourly_rate,
  training_pay: record.training_pay,
  meeting_pay: record.meeting_pay,
  vacation_pay: record.vacation_pay,
  overtime_pay: record.overtime_pay,
  recordId: record.id
});
  });
  
  // Convert to array and sort positions
  return Object.values(grouped).map(letter => {
    letter.positions.sort((a, b) => a.positionNumber - b.positionNumber);
    return letter;
  });
}



// ============================================================================
// TOGGLE LETTER EXPANSION
// ============================================================================
window.toggleLetterExpansion = function(letterIndex) {
  const positionsContainer = document.getElementById(`letter-positions-${letterIndex}`);
  const toggleIcon = document.getElementById(`toggle-icon-${letterIndex}`);
  
  if (positionsContainer.classList.contains('hidden')) {
    // EXPAND
    positionsContainer.classList.remove('hidden');
    toggleIcon.innerHTML = '<i class="fas fa-minus-circle text-blue-600"></i>';
  } else {
    // COLLAPSE
    positionsContainer.classList.add('hidden');
    toggleIcon.innerHTML = '<i class="fas fa-plus-circle text-blue-600"></i>';
  }
};








// RENDER GROUPED WAGE HISTORY
// ============================================================================
// ============================================================================
// RENDER GROUPED WAGE HISTORY
// ============================================================================
function renderWageHistory() {
  const container = document.getElementById('comp-letter-history-body');
  
  if (!container) {
    console.error('âŒ Wage history container not found!');
    return;
  }
  
  if (!CompensationState.wageHistory || CompensationState.wageHistory.length === 0) {
    container.innerHTML = `
      <tr>
        <td colspan="8" class="px-6 py-12 text-center">
          <div class="flex flex-col items-center justify-center space-y-3">
            <i class="fas fa-inbox text-5xl text-gray-300"></i>
            <p class="text-gray-500 font-semibold">No wage history records found</p>
            <p class="text-gray-400 text-sm">Compensation letters will appear here after creation</p>
          </div>
        </td>
      </tr>
    `;
    return;
  }
  
  const groupedLetters = groupWageHistoryByLetter(CompensationState.wageHistory);
  let html = '';
  
  groupedLetters.forEach((letter, letterIndex) => {
    const formattedDate = new Date(letter.effectiveDate).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
    
    const changeTypeLabels = {
      'new_hire': 'New Hire',
      'promotion': 'Promotion',
      'merit_increase': 'Merit Increase',
      'position_change': 'Position Change',
      'cost_of_living': 'Cost of Living',
      'market_adjustment': 'Market Adjustment',
      'other': 'Other'
    };
    
    html += `
      <tr class="border-b-4 border-gray-200 bg-gray-50">
        <td colspan="8" class="px-0 py-0">
          <div class="bg-white rounded-lg shadow-sm border-2 border-gray-200 overflow-hidden m-2">
            
            <!-- COLLAPSIBLE HEADER -->
            <div class="bg-gradient-to-r from-blue-50 to-indigo-50 px-4 py-3 border-b-2 border-indigo-200">
              <div class="flex items-center justify-between">
                
                <!-- LEFT: Toggle + Info -->
                <div class="flex items-center space-x-3">
                  <!-- TOGGLE BUTTON -->
                  <button type="button" 
                          onclick="toggleLetterExpansion(${letterIndex})"
                          id="toggle-icon-${letterIndex}"
                          class="text-2xl hover:scale-110 transition-transform">
                    <i class="fas fa-plus-circle text-blue-600"></i>
                  </button>
                  
                  <h3 class="text-base font-bold text-gray-900">
  ${changeTypeLabels[letter.changeType] || 'Compensation Letter'}
</h3>
<p class="text-sm text-gray-600">
  <i class="far fa-calendar-alt mr-1"></i>
  Effective: <span class="font-semibold">${formattedDate}</span>
  ${letter.isCurrent ? '<span class="ml-2 px-2 py-0.5 bg-emerald-100 text-emerald-700 text-xs font-bold rounded-full">CURRENT</span>' : ''}
</p>
<p class="text-xs text-gray-500 mt-1">
  <i class="far fa-clock mr-1"></i>
  Created: <span class="font-semibold">${new Date(letter.positions[0].createdAt || letter.effectiveDate).toLocaleDateString('en-US', {year: 'numeric', month: 'short', day: 'numeric'})}</span>
  <span class="mx-2">â€¢</span>
  <i class="fas fa-user-check mr-1"></i>
  Approved By: <span class="font-semibold">${letter.approvedBy || 'Pending'}</span>
</p>
                  </div>
                </div>
                
                <!-- RIGHT: Action Buttons -->
                <div class="flex items-center space-x-2">
                  
                  <!-- VIEW PDF BUTTON -->
                  ${letter.pdfUrl ? `
                  <button type="button" onclick="window.open('${letter.pdfUrl}', '_blank')"
                          class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-file-pdf"></i>
                    <span>View PDF</span>
                  </button>
                  ` : `
                  <button type="button" onclick="viewCompensationLetter(${letter.positions[0].recordId})"
                          class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-eye"></i>
                    <span>View PDF</span>
                  </button>
                  `}
                  
                  <!-- DELETE LETTER BUTTON -->
                  <button type="button" onclick="deleteAllPositions(${letter.employeeId}, '${letter.effectiveDate.replace(/'/g, "\\'")}')"
                          class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white font-bold rounded-lg transition-colors duration-200 flex items-center space-x-2 text-sm">
                    <i class="fas fa-trash-alt"></i>
                    <span>Delete</span>
                  </button>

                </div>
              </div>
            </div>
            
            <!-- COLLAPSIBLE POSITIONS TABLE (HIDDEN BY DEFAULT) -->
            <div id="letter-positions-${letterIndex}" class="hidden p-4 bg-gray-50">
              <h4 class="text-xs font-bold text-gray-700 uppercase mb-2 flex items-center">
                <i class="fas fa-briefcase text-amber-600 mr-2"></i>
                Positions (${letter.positions.length})
              </h4>
              
              <table class="w-full bg-white rounded-lg overflow-hidden shadow-sm">
                <thead>
                  <tr class="bg-gray-100 border-b-2 border-gray-200">
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Position</th>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Job Title</th>
                    <th class="px-3 py-2 text-left text-xs font-bold text-gray-700 uppercase">Department</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Hourly Rate</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Training</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Meeting</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Vacation</th>
                    <th class="px-3 py-2 text-right text-xs font-bold text-gray-700 uppercase">Overtime</th>
                  </tr>
                </thead>
                <tbody>



                 ${letter.positions.map(pos => `
  <tr class="border-b border-gray-100 hover:bg-blue-50 transition-colors">
    <td class="px-3 py-2">
      <span class="px-2 py-1 rounded-full text-xs font-bold ${
        pos.positionNumber === 1 ? 'bg-emerald-100 text-emerald-700' :
        pos.positionNumber === 2 ? 'bg-blue-100 text-blue-700' :
        'bg-purple-100 text-purple-700'
      }">
        POS ${pos.positionNumber}
      </span>
    </td>
    <td class="px-3 py-2 font-semibold text-gray-900">${pos.positionTitle}</td>
    <td class="px-3 py-2 text-gray-600">${pos.department}</td>
    <td class="px-3 py-2 text-right font-bold text-gray-900">$${parseFloat(pos.hourlyRate).toFixed(2)}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.training_pay ? '$' + parseFloat(pos.training_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.meeting_pay ? '$' + parseFloat(pos.meeting_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600">${pos.vacation_pay ? '$' + parseFloat(pos.vacation_pay).toFixed(2) : '--'}</td>
    <td class="px-3 py-2 text-right text-gray-600 font-bold">${letter.positions.length > 1 ? '<span class="text-purple-700">BLENDED</span>' : (pos.overtime_pay ? '$' + parseFloat(pos.overtime_pay).toFixed(2) : '--')}</td>
  </tr>
`).join('')}
                </tbody>
              </table>
              
              <!-- ADDITIONAL INFO -->
              ${letter.positions[0].notes ? `
              <div class="mt-3 p-3 bg-amber-50 border-l-4 border-amber-400 rounded">
                <p class="text-xs font-bold text-amber-900 mb-1">
                  <i class="fas fa-sticky-note mr-1"></i> NOTES:
                </p>
                <p class="text-sm text-amber-800">${letter.positions[0].notes}</p>
              </div>
              ` : ''}
            </div>
            
          </div>
        </td>
      </tr>
    `;
  });
  
  container.innerHTML = html;
  
  console.log('âœ… Wage history displayed with collapsible format');
}



// ============================================================================
// DELETE ALL POSITIONS (ENTIRE LETTER)
// ============================================================================
window.deleteAllPositions = async function(employeeId, effectiveDate) {
  if (!confirm('âš ï¸ Delete ENTIRE compensation letter?\n\nThis will delete ALL positions for this date.')) {
    return;
  }
  
  try {
    const { error } = await window.supabaseClient
      .from('wage_history')
      .delete()
      .eq('employee_id', employeeId)
      .eq('effective_date', effectiveDate);
    
    if (error) throw error;
    
    showToast('âœ… Compensation letter deleted', 'success');
    await loadWageHistory(employeeId);
    
  } catch (err) {
    console.error('Error deleting:', err);
    showToast('âŒ Failed to delete', 'error');
  }
};



// ============================================================================
// TOGGLE ALL CHECKBOXES
// ============================================================================


// ============================================================================
// DELETE SELECTED POSITIONS
// ============================================================================









// ============================================================================
// DELETE WAGE HISTORY RECORD
// ============================================================================
// ========================================================================
// GLOBAL FUNCTION: deleteWageHistoryRecord (for inline onclick)
// ========================================================================






// ============================================================================
// 5. DYNAMIC FORM BEHAVIOR - TIP POSITION DETECTION & OVERTIME CALC
// ============================================================================
function setupCompensationFormLogic() {
  const positionInput = document.getElementById('comp-letter-position');
  const hourlyRateInput = document.getElementById('comp-letter-hourly-rate');
  const trainingPayInput = document.getElementById('comp-letter-training-pay');
  const meetingPayInput = document.getElementById('comp-letter-meeting-pay');
  const overtimeDisplay = document.getElementById('comp-letter-overtime-display');
  const overtimeHidden = document.getElementById('comp-letter-overtime-pay');
  const tipSection = document.getElementById('comp-letter-tip-section');
  const tipPoolOption = document.getElementById('comp-letter-tip-pool-option');
  const serverTips = document.getElementById('comp-letter-server-tips');
  
  if (!positionInput || !hourlyRateInput) return;
  
  // âœ… AUTO-CALCULATE OVERTIME (1.5x hourly rate)
  function calculateOvertime() {
    const hourlyRate = parseFloat(hourlyRateInput.value) || 0;
    const overtimeRate = (hourlyRate * 1.5).toFixed(2);
    
    if (overtimeDisplay) overtimeDisplay.textContent = hourlyRate > 0 ? `$${overtimeRate}/hr` : '--';
    if (overtimeHidden) overtimeHidden.value = overtimeRate;
  }
  
  // âœ… DETECT TIP POSITION & SHOW/HIDE TIP SECTION
  function detectTipPosition() {
    const position = positionInput.value.toLowerCase().trim();
    const isTipPosition = CompensationState.tipPositions.some(tp => position.includes(tp));
    const isServer = position.includes('server');
    
    // Show/hide tip section
    if (tipSection) {
      if (isTipPosition) {
        tipSection.classList.remove('hidden');
      } else {
        tipSection.classList.add('hidden');
      }
    }
    
    // Show tip pool checkbox for Busser, Bartender, Host, Cashier
    if (tipPoolOption) {
      if (isTipPosition && !isServer) {
        tipPoolOption.classList.remove('hidden');
        const checkbox = document.getElementById('comp-letter-included-in-tip-pool');
        if (checkbox) checkbox.checked = true; // Auto-set to Yes
      } else {
        tipPoolOption.classList.add('hidden');
      }
    }
    
    // Show server-specific tip fields
    if (serverTips) {
      if (isServer) {
        serverTips.classList.remove('hidden');
      } else {
        serverTips.classList.add('hidden');
      }
    }
  }
  
  // âœ… AUTO-FILL TRAINING & MEETING PAY (same as hourly)
  function autoFillRelatedPay() {
    const hourlyRate = hourlyRateInput.value;
    if (trainingPayInput && !trainingPayInput.value) {
      trainingPayInput.value = hourlyRate;
    }
    if (meetingPayInput && !meetingPayInput.value) {
      meetingPayInput.value = hourlyRate;
    }
  }
  
  // âœ… EVENT LISTENERS
  hourlyRateInput.addEventListener('input', () => {
    calculateOvertime();
    autoFillRelatedPay();
  });
  
  positionInput.addEventListener('input', detectTipPosition);
  positionInput.addEventListener('change', detectTipPosition);
  
  console.log('âœ… Compensation form logic initialized');
}

// ============================================================================
// 6. PREVIEW COMPENSATION LETTER - FIXED TO OPEN IN NEW WINDOW
// ============================================================================
function previewCompensationLetter() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) {
    showToast('Please select an employee first', 'error');
    return;
  }

  // Collect all form data
  const formData = collectCompensationFormData();
  
  if (!formData) {
    showToast('Please fill in all required fields', 'error');
    return;
  }

  const letterHTML = generateCompensationLetterHTML(formData);
  
  // âœ… Open preview in new window instead of modal
  const previewWindow = window.open('', '_blank', 'width=900,height=800,scrollbars=yes');
  
  if (!previewWindow) {
    showToast('Please allow pop-ups to preview the letter', 'error');
    return;
  }
  
  previewWindow.document.write(`
    <!DOCTYPE html>
    <html>
      <head>
        <title>Compensation Letter Preview - ${employee.first_name} ${employee.last_name}</title>
        <style>
          body { 
            margin: 0; 
            padding: 20px; 
            font-family: 'Inter', Arial, sans-serif;
            background: #f8fafc;
          }
          .preview-header {
            background: white;
            padding: 15px 20px;
            margin: -20px -20px 20px -20px;
            border-bottom: 3px solid #7a1f1f;
            display: flex;
            justify-content: space-between;
            align-items: center;
          }
          .preview-header h1 {
            margin: 0;
            font-size: 18px;
            color: #7a1f1f;
          }
          .preview-actions {
            display: flex;
            gap: 10px;
          }
          .btn {
            padding: 8px 16px;
            border: 2px solid #7a1f1f;
            background: white;
            color: #7a1f1f;
            font-weight: bold;
            border-radius: 6px;
            cursor: pointer;
            font-size: 13px;
          }
          .btn:hover {
            background: #7a1f1f;
            color: white;
          }
          @media print {
            .preview-header { display: none; }
            body { padding: 0; background: white; }
          }
        </style>
      </head>
      <body>
        <div class="preview-header">
          <h1>ğŸ“„ Compensation Letter Preview</h1>
          <div class="preview-actions">
            <button class="btn" onclick="window.print()">ğŸ–¨ï¸ Print</button>
            <button class="btn" onclick="window.close()">âœ–ï¸ Close</button>
          </div>
        </div>
        ${letterHTML}
      </body>
    </html>
  `);
  
  previewWindow.document.close();
  
  showToast('âœ… Preview opened in new window', 'success');
}

// ============================================================================
// VIEW COMPENSATION LETTER PDF (FROM SAVED RECORD)
// ============================================================================
async function viewCompensationLetter(recordId) {
  try {
    showToast('ğŸ“„ Generating compensation letter...', 'info');
    
    // Fetch the specific record
    const { data: record, error } = await window.supabaseClient
      .from('wage_history')
      .select('*')
      .eq('id', recordId)
      .single();
    
    if (error) throw error;
    
    // Fetch employee details
    const { data: employee, error: empError } = await window.supabaseClient
      .from('employees')
      .select('*')
      .eq('id', record.employee_id)
      .single();
    
    if (empError) throw empError;
    
    // Fetch all positions for this letter (same employee_id + effective_date)
    const { data: allPositions, error: posError } = await window.supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', record.employee_id)
      .eq('effective_date', record.effective_date)
      .order('position_number', { ascending: true });
    
    if (posError) throw posError;
    
    // Calculate years of service for PTO
    const hireDate = new Date(employee.original_hire_date || employee.hire_date);
    const effectiveDate = new Date(record.effective_date);
    const yearsOfService = (effectiveDate - hireDate) / (1000 * 60 * 60 * 24 * 365.25);
    const is60DaysPassed = (effectiveDate - hireDate) / (1000 * 60 * 60 * 24) >= 60;
    const isFullTime = record.employment_type === 'full_time';
    
    // Determine PTO hours
    let ptoHours = '--';
    if (isFullTime && is60DaysPassed) {
      if (yearsOfService < 4) {
        ptoHours = '<strong style="color: #000; font-weight: 700;">8 mo - 4 years up to 40 hours</strong>';
      } else {
        ptoHours = '<strong style="color: #000; font-weight: 700;">4 years or more up to 48 hours</strong>';
      }
    }
    
    // Build positions table
    let positionsTableRows = '';
    allPositions.forEach((pos, index) => {
      const posLabel = index === 0 ? 'Primary' : index === 1 ? 'Secondary' : 'Tertiary';
      const posColor = index === 0 ? '#10b981' : index === 1 ? '#3b82f6' : '#a855f7';
      
      positionsTableRows += `
        <tr>
          <td style="padding: 10px; border: 1px solid #ddd; background: ${posColor}22; color: ${posColor}; font-weight: 700; font-size: 13px;">${posLabel}</td>
          <td style="padding: 10px; border: 1px solid #ddd; font-weight: 600; font-size: 14px;">${pos.position_title}</td>
          <td style="padding: 10px; border: 1px solid #ddd; font-size: 14px;">${pos.department}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-weight: 700; font-size: 14px;">$${parseFloat(pos.hourly_rate).toFixed(2)}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.training_pay ? '$' + parseFloat(pos.training_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.meeting_pay ? '$' + parseFloat(pos.meeting_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.vacation_pay ? '$' + parseFloat(pos.vacation_pay).toFixed(2) : '--'}</td>
          <td style="padding: 10px; border: 1px solid #ddd; text-align: right; font-size: 14px;">${pos.overtime_pay ? '$' + parseFloat(pos.overtime_pay).toFixed(2) : '--'}</td>
        </tr>
      `;
    });
    
    // Determine manager based on primary position
    const primaryPosition = allPositions[0].position_title.toLowerCase();
    let managerName = 'Management';
    if (primaryPosition.includes('server') || primaryPosition.includes('busser') || primaryPosition.includes('host')) {
      managerName = 'Iris Ying (FOH Manager)';
    } else if (primaryPosition.includes('cook') || primaryPosition.includes('prep') || primaryPosition.includes('dishwasher')) {
      managerName = 'Peiqin Lin (BOH Manager)';
    }
    
    const formattedEffectiveDate = new Date(record.effective_date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    const formattedCreatedDate = new Date(record.created_at || record.effective_date).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
    
    // Generate PDF HTML
    const pdfHtml = `
      <!DOCTYPE html>
      <html>
      <head>
        <meta charset="UTF-8">
        <style>
          @page {
            size: letter;
            margin: 0.5in 0.75in 0.75in 0.75in;
          }
          
          * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
          }
          
          body {
            font-family: 'Arial', sans-serif;
            font-size: 13px;
            line-height: 1.4;
            color: #1f2937;
          }
          
          .header {
            text-align: center;
            margin-bottom: 18px;
            padding-bottom: 12px;
            border-bottom: 3px solid #1e40af;
          }
          
          .header h1 {
            font-size: 22px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 4px;
          }
          
          .header p {
            font-size: 11px;
            color: #64748b;
            font-weight: 600;
          }
          
          .section {
            margin-bottom: 14px;
          }
          
          .section-title {
            font-size: 13px;
            font-weight: 700;
            color: #1e40af;
            margin-bottom: 8px;
            padding-bottom: 4px;
            border-bottom: 2px solid #bfdbfe;
            text-transform: uppercase;
            letter-spacing: 0.5px;
          }
          
          table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 8px;
            font-size: 13px;
          }
          
          th {
            background: #1e40af;
            color: white;
            padding: 8px;
            text-align: left;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
          }
          
          td {
            padding: 8px;
            border: 1px solid #e2e8f0;
          }
          
          .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
          }
          
          .info-item {
            font-size: 12px;
          }
          
          .info-label {
            font-weight: 700;
            color: #475569;
          }
          
          .info-value {
            color: #1f2937;
            font-weight: 600;
          }
          
          .benefits-table {
            margin-top: 8px;
            font-size: 12px;
          }
          
          .benefits-table td {
            padding: 8px;
          }
          
          .benefits-table th {
            font-size: 11px;
          }
          
          .signature-section {
            margin-top: 24px;
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
          }
          
          .signature-box {
            text-align: center;
          }
          
          .signature-line {
            border-top: 2px solid #000;
            margin-bottom: 4px;
            padding-top: 4px;
          }
          
          .signature-label {
            font-size: 11px;
            font-weight: 700;
            color: #000;
          }
          
          .disclaimer {
            margin-top: 20px;
            padding: 10px;
            background: #fef3c7;
            border-left: 4px solid #f59e0b;
            font-size: 10px;
            line-height: 1.5;
            font-weight: 700;
            color: #000;
          }
          
          .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 9px;
            color: #64748b;
            padding: 8px;
            border-top: 1px solid #e2e8f0;
            background: white;
          }
        </style>
      </head>
      <body>
        <div class="header">
          <h1>JENG CHI RESTAURANT</h1>
          <p>2550 N. Belt Line Rd., Irving, TX 75062 â€¢ (469) 941-6677</p>
          <p style="margin-top: 8px; font-size: 13px; font-weight: 700; color: #1e40af;">COMPENSATION & BENEFITS LETTER</p>
        </div>
        
        <div class="section">
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label">Employee:</span>
              <span class="info-value">${employee.first_name} ${employee.last_name}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Employee ID:</span>
              <span class="info-value">${employee.employee_id}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Effective Date:</span>
              <span class="info-value">${formattedEffectiveDate}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Letter Created:</span>
              <span class="info-value">${formattedCreatedDate}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Employment Type:</span>
              <span class="info-value">${record.employment_type === 'full_time' ? 'Full Time' : 'Part Time'}</span>
            </div>
            <div class="info-item">
              <span class="info-label">Hire Date:</span>
              <span class="info-value">${new Date(employee.original_hire_date || employee.hire_date).toLocaleDateString('en-US')}</span>
            </div>
          </div>
        </div>
        
        <div class="section">
          <div class="section-title">ğŸ’¼ Position(s) & Compensation</div>
          <table>
            <thead>
              <tr>
                <th>POSITION</th>
                <th>JOB TITLE</th>
                <th>DEPARTMENT</th>
                <th style="text-align: right;">HOURLY</th>
                <th style="text-align: right;">TRAINING</th>
                <th style="text-align: right;">MEETING</th>
                <th style="text-align: right;">VACATION</th>
                <th style="text-align: right;">OVERTIME</th>
              </tr>
            </thead>
            <tbody>
              ${positionsTableRows}
            </tbody>
          </table>
        </div>
        
        <div class="section">
          <div class="section-title">ğŸ Benefits for Qualified Full Time Employees</div>
          <p style="background: #fef9c3; padding: 6px; font-size: 11px; font-weight: 600; margin-bottom: 8px;">
            See employee handbook and benefits guide for full details
          </p>
          <table class="benefits-table">
            <thead>
              <tr>
                <th>BENEFIT</th>
                <th>EMPLOYER CONTRIBUTION</th>
                <th>EMPLOYEE CONTRIBUTION</th>
                <th>NOTES</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td style="font-weight: 700;">Health Insurance</td>
                <td style="font-weight: 600;">50% for Employee</td>
                <td style="font-weight: 600;">50% for Employee</td>
                <td>Available for family at cost</td>
              </tr>
              <tr>
                <td style="font-weight: 700;">Dental Insurance</td>
                <td style="font-weight: 600;">Employer Paid for basic insurance Plan</td>
                <td style="font-weight: 600;">50% for Employee for Buy Up</td>
                <td>Available for family at cost</td>
              </tr>
              <tr>
                <td style="font-weight: 700;">Vision Insurance</td>
                <td style="font-weight: 600;">Employer Paid for basic insurance Plan</td>
                <td style="font-weight: 600;">--</td>
                <td>Available for family at cost</td>
              </tr>
              <tr>
                <td style="font-weight: 700;">Life Insurance $25,000 term policy</td>
                <td style="font-weight: 600;">Employer Paid</td>
                <td style="font-weight: 600;">--</td>
                <td>--</td>
              </tr>
              <tr>
                <td style="font-weight: 700;">Paid Time Off</td>
                <td colspan="3" style="text-align: center;">${ptoHours}</td>
              </tr>
            </tbody>
          </table>
        </div>
        
        <div class="signature-section">
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">EMPLOYEE SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">${employee.first_name} ${employee.last_name}</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">MANAGER SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">${managerName}</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
          <div class="signature-box">
            <div class="signature-line"></div>
            <div class="signature-label">OWNER SIGNATURE</div>
            <div class="signature-label" style="margin-top: 4px;">Pablo Chang</div>
            <div class="signature-label" style="margin-top: 4px;">DATE: _____________</div>
          </div>
        </div>
        
        <div class="disclaimer">
          <strong>DISCLAIMER:</strong> This letter outlines your current compensation and benefits. All benefits are subject to plan terms and eligibility requirements. Employment is at-will and can be terminated by either party at any time. This letter does not constitute an employment contract. Benefits may change based on company policy updates.
        </div>
        
        <div class="footer">
          Jeng Chi Restaurant â€¢ Confidential Compensation Letter â€¢ Generated ${new Date().toLocaleDateString('en-US')}
        </div>
      </body>
      </html>
    `;
    
    // Create temporary container
    const tempContainer = document.createElement('div');
    tempContainer.innerHTML = pdfHtml;
    tempContainer.style.position = 'absolute';
    tempContainer.style.left = '-9999px';
    document.body.appendChild(tempContainer);
    
    // Generate PDF
    const opt = {
      margin: [0.5, 0.75, 0.75, 0.75],
      filename: `Compensation_Letter_${employee.last_name}_${employee.first_name}_${record.effective_date}.pdf`,
      image: { type: 'jpeg', quality: 0.98 },
      html2canvas: { scale: 2, useCORS: true, letterRendering: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    };
    
    await html2pdf().set(opt).from(tempContainer).save();
    
    // Cleanup
    document.body.removeChild(tempContainer);
    
    showToast('âœ… PDF generated successfully!', 'success');
    
  } catch (error) {
    console.error('âŒ Error generating PDF:', error);
    showToast('âŒ Failed to generate PDF', 'error');
  }
}











// ============================================================================
// 7. COLLECT FORM DATA
// ============================================================================
function collectCompensationFormData() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) return null;
  
  // PRIMARY JOB (Required)
  const primaryJobTitle = document.getElementById('primary-job-title')?.value;
  const primaryDepartment = document.getElementById('primary-department')?.value;
  const primaryWage = parseFloat(document.getElementById('primary-wage')?.value);
  
  // SECONDARY JOB (Optional)
  const secondaryJobTitle = document.getElementById('secondary-job-title')?.value;
  const secondaryDepartment = document.getElementById('secondary-department')?.value;
  const secondaryWage = parseFloat(document.getElementById('secondary-wage')?.value) || 0;
  
  // TERTIARY JOB (Optional)
  const tertiaryJobTitle = document.getElementById('tertiary-job-title')?.value;
  const tertiaryDepartment = document.getElementById('tertiary-department')?.value;
  const tertiaryWage = parseFloat(document.getElementById('tertiary-wage')?.value) || 0;
  
  // OTHER REQUIRED FIELDS
  const effectiveDate = document.getElementById('comp-letter-effective-date')?.value;
  const changeType = document.getElementById('comp-letter-change-type')?.value;
  const employmentType = document.getElementById('comp-letter-employment-type')?.value;
  const hireDate = document.getElementById('comp-letter-hire-date')?.value;
  
  // Validate required fields
  if (!primaryJobTitle || !primaryDepartment || !primaryWage || !effectiveDate || !changeType || !employmentType || !hireDate) {
    return null;
  }
  
  // ADDITIONAL COMPENSATION
  const trainingPay = parseFloat(document.getElementById('comp-letter-training-pay')?.value) || primaryWage;
  const meetingPay = parseFloat(document.getElementById('comp-letter-meeting-pay')?.value) || primaryWage;
  const vacationPay = parseFloat(document.getElementById('comp-letter-vacation-pay')?.value) || 0;
  const overtimePay = parseFloat(document.getElementById('comp-letter-overtime-pay')?.value) || (primaryWage * 1.5);
  const changeReason = document.getElementById('comp-letter-change-reason')?.value || '';
  const approvedBy = document.getElementById('comp-letter-approved-by')?.value || 'Management';
  
  // ============================================================================
  // âœ… ADD THE TIP CONFIGURATION CODE RIGHT HERE
  // ============================================================================
  
  // âœ… CHECK ALL THREE POSITIONS FOR SERVER (Primary, Secondary, Tertiary)
  const allPositions = [primaryJobTitle, secondaryJobTitle, tertiaryJobTitle].filter(Boolean).map(p => p.toLowerCase());
  const isServer = allPositions.some(pos => pos.includes('server'));
  
  // Check if ANY position is in tip pool (busser, cashier, host, bartender)
  const isTipPosition = allPositions.some(pos => 
    ['busser', 'cashier', 'host', 'hostess', 'bartender'].some(tp => pos.includes(tp))
  );
  
  const includedInTipPool = isTipPosition && !isServer ? true : false;
  
  // âœ… TIP PERCENTAGES - Use default values
  let tipToHouse = 4.00;  // Default 4%
  let merchantServices = 3.00;  // Default 3%
  
  // Try to read from form fields if they exist
  const tipToHouseInput = document.getElementById('comp-letter-tip-to-house');
  const merchantServicesInput = document.getElementById('comp-letter-merchant-services');
  
  if (tipToHouseInput && tipToHouseInput.value) {
    tipToHouse = parseFloat(tipToHouseInput.value);
  }
  
  if (merchantServicesInput && merchantServicesInput.value) {
    merchantServices = parseFloat(merchantServicesInput.value);
  }
  
  // If ANY position is server, ensure default values are set
  if (isServer) {
    if (!tipToHouseInput || !tipToHouseInput.value) {
      tipToHouse = 4.00;
    }
    if (!merchantServicesInput || !merchantServicesInput.value) {
      merchantServices = 3.00;
    }
  }
  
  // ============================================================================
  // END OF TIP CONFIGURATION
  // ============================================================================
  
  return {
    employee,
    // Primary job
    position: primaryJobTitle,
    department: primaryDepartment,
    hourlyRate: primaryWage,
    // Secondary job
    secondaryJobTitle,
    secondaryDepartment,
    secondaryWage,
    // Tertiary job
    tertiaryJobTitle,
    tertiaryDepartment,
    tertiaryWage,
    // Additional compensation
    trainingPay,
    meetingPay,
    vacationPay,
    overtimePay,
    // Dates and metadata
    effectiveDate,
    changeType,
    changeReason,
    approvedBy,
    employmentType,
    hireDate,
    positionSlot: '1', // Keep for compatibility
    // Tip info
    isTipPosition,
    isServer,
    includedInTipPool,
    tipToHouse,
    merchantServices
  };
}

// ============================================================================
// 8. GENERATE COMPREHENSIVE PDF WITH FULL BENEFITS PACKAGE
// ============================================================================
// ============================================================================
// 8. âœ… FINAL: GENERATE COMPREHENSIVE COMPENSATION LETTER PDF
// ============================================================================
// ============================================================================
// âœ… FINAL: COMPENSATION LETTER â€” ONE-PAGE OPTIMIZED VERSION
// ============================================================================
function generateCompensationLetterHTML(data) {
  const {
    employee,
    position,
    department,
    hourlyRate,
    secondaryJobTitle,
    secondaryDepartment,
    secondaryWage,
    tertiaryJobTitle,
    tertiaryDepartment,
    tertiaryWage,
    trainingPay,
    meetingPay,
    vacationPay,
    overtimePay,
    effectiveDate,
    changeType,
    changeReason,
    approvedBy,
    employmentType,
    hireDate,
    isTipPosition,
    isServer,
    includedInTipPool,
    tipToHouse,
    merchantServices
  } = data;

  // âœ… EMOJI MAPPING â€” as before
  function getPositionEmoji(title) {
    if (!title) return 'ğŸ‘¤';
    const t = title.toLowerCase();
    if (t.includes('server')) return 'ğŸ½ï¸';
    if (t.includes('dishwasher') || t.includes('steward')) return 'ğŸ§¼';
    if (t.includes('busser') || t.includes('bus boy')) return 'ğŸ§¹';
    if (t.includes('bartender') || t.includes('bar')) return 'ğŸ¸';
    if (t.includes('cashier')) return 'ğŸ’°';
    if (t.includes('host') || t.includes('hostess')) return 'ğŸ‘‹';
    if (t.includes('cook') || t.includes('chef') || t.includes('wok') || t.includes('line')) return 'ğŸ‘¨â€ğŸ³';
    if (t.includes('prep') || t.includes('preparation')) return 'ğŸ”ª';
    if (t.includes('pastry')) return 'ğŸ°';
    if (t.includes('production manager')) return 'ğŸ“¦';
    if (t.includes('logistic') || t.includes('coordinator')) return 'ğŸšš';
    if (t.includes('manager') && !t.includes('production')) return 'ğŸ‘”';
    if (t.includes('cleaning') || t.includes('janitor')) return 'ğŸ§½';
    if (t.includes('delivery') || t.includes('driver')) return 'ğŸš—';
    if (t.includes('expeditor')) return 'ğŸ“‹';
    return 'ğŸ‘¤';
  }

  const formattedEffectiveDate = new Date(effectiveDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const formattedHireDate = new Date(hireDate).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const todaysDate = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
  const isFullTime = employmentType === 'full_time';
  const compTypeDisplay = employmentType === 'full_time' ? 'Hourly' : 'Salary'; // per your schema
  const hasSecondary = secondaryJobTitle && parseFloat(secondaryWage) > 0;
  const hasTertiary = tertiaryJobTitle && parseFloat(tertiaryWage) > 0;
  const positionCount = 1 + (hasSecondary ? 1 : 0) + (hasTertiary ? 1 : 0);
  const overtimeDisplay = positionCount > 1 ? 'BLENDED' : `$${overtimePay.toFixed(2)}/hr`;

  // âœ… ALL POSITIONS (for tip logic)
  const allPositions = [position, secondaryJobTitle, tertiaryJobTitle].filter(Boolean).map(p => p.toLowerCase());
  const isServerPosition = allPositions.some(pos => pos.includes('server'));
  const isTipPoolPosition = allPositions.some(pos =>
    ['busser', 'cashier', 'host', 'hostess', 'bartender'].some(tp => pos.includes(tp))
  );

  const changeTypeLabels = {
    'new_hire': 'New Employment',
    'promotion': 'Promotion',
    'merit_increase': 'Merit Increase',
    'position_change': 'Position Change',
    'cost_of_living': 'Cost of Living Adjustment',
    'market_adjustment': 'Market Adjustment',
    'other': 'Compensation Adjustment'
  };

  return `
    <div style="
      font-family: 'Inter', Arial, sans-serif;
      max-width: 800px;
      margin: 0 auto;
      padding: 6px;
      background: white;
      color: #1e293b;
      font-size: 10.5px;
      line-height: 1.25;
    ">
      <style>
        @media print {
          body { margin: 0; }
          .letter-container { padding: 8px !important; }
          table { font-size: 9.5px !important; }
          h1, h2 { font-size: 18px !important; }
          .signature-line { border-top: 1px solid #000 !important; height: 22px !important; }
        }
      </style>

      <!-- Logo & Header -->
      <div style="text-align: center; margin-bottom: 4px;">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi Restaurant"
             style="height: 40px; margin-bottom: 2px;" />
        <h1 style="color: #7a1f1f; margin: 2px 0; font-size: 18px; font-weight: bold; letter-spacing: 0.5px;">
          EMPLOYEE COMPENSATION PLAN
        </h1>
        <p style="color: #64748b; margin: 1px 0 0 0; font-size: 11px; font-weight: 600;">
          ${changeTypeLabels[changeType] || 'Compensation Notice'}
        </p>
      </div>

      <!-- Employee Info + Positions -->
      <div style="display: grid; grid-template-columns: 1fr 1.5fr; gap: 4px; margin-bottom: 4px; font-size: 10px;">
        <!-- LEFT: Employee Info -->
        <div style="background: linear-gradient(135deg, #f8fafc, #e2e8f0); padding: 5px; border-radius: 4px; border-left: 3px solid #7a1f1f;">
          <p style="margin: 2px 0 1px 0; color: #64748b; font-size: 8.5px; font-weight: bold; text-transform: uppercase;">Employee Name</p>
          <p style="margin: 0 0 3px 0; font-size: 12px; font-weight: bold;">${employee.first_name} ${employee.last_name}</p>
          
          <p style="margin: 2px 0 1px 0; color: #64748b; font-size: 8.5px; font-weight: bold; text-transform: uppercase;">Hire Date</p>
          <p style="margin: 0 0 3px 0; font-size: 10px; font-weight: 600;">${formattedHireDate}</p>
          
          <p style="margin: 2px 0 1px 0; color: #64748b; font-size: 8.5px; font-weight: bold; text-transform: uppercase;">Effective Date</p>
          <p style="margin: 0 0 3px 0; font-size: 10px; font-weight: 600;">${formattedEffectiveDate}</p>
          
          <div style="padding-top: 2px;">
            <span style="
              display: inline-block;
              background: ${employmentType === 'full_time' ? 'linear-gradient(135deg, #ecfdf5, #d1fae5)' : 'linear-gradient(135deg, #eff6ff, #dbeafe)'};
              color: ${employmentType === 'full_time' ? '#047857' : '#1d4ed8'};
              padding: 1px 6px;
              border-radius: 6px;
              font-size: 9px;
              font-weight: bold;
              border: 1px solid ${employmentType === 'full_time' ? '#10b981' : '#3b82f6'};
            ">
              ğŸ’° ${compTypeDisplay}
            </span>
          </div>
        </div>

        <!-- RIGHT: Positions & Wages -->
        <div style="background: #fefce8; border: 1px solid #eab308; border-radius: 4px; padding: 4px;">
          <h2 style="margin: 0 0 3px 0; color: #854d0e; font-size: 11px; font-weight: bold; text-transform: uppercase; text-align: center;">
            ğŸ‘¤ POSITIONS & WAGES
          </h2>
          <table style="width: 100%; border-collapse: collapse; font-size: 9.5px;">
            <tr style="background: #fef9c3; border-bottom: 1px solid #eab308;">
              <td style="padding: 2px 4px; font-weight: bold; color: #854d0e; width: 22%;">PRIMARY JOB</td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b; width: 43%;">
                <span style="font-size: 12px; margin-right: 3px;">${getPositionEmoji(position)}</span>
                ${position}
              </td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b; width: 15%;">${department}</td>
              <td style="padding: 2px 4px; text-align: right; font-weight: bold; color: #1e293b; width: 20%;">$${parseFloat(hourlyRate).toFixed(2)}/hr</td>
            </tr>
            ${hasSecondary ? `
            <tr style="background: #fefce8; border-bottom: 1px solid #eab308;">
              <td style="padding: 2px 4px; font-weight: bold; color: #854d0e;">SECONDARY JOB</td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b;">
                <span style="font-size: 12px; margin-right: 3px;">${getPositionEmoji(secondaryJobTitle)}</span>
                ${secondaryJobTitle}
              </td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b;">${secondaryDepartment}</td>
              <td style="padding: 2px 4px; text-align: right; font-weight: bold; color: #1e293b;">$${parseFloat(secondaryWage).toFixed(2)}/hr</td>
            </tr>` : ''}

            ${hasTertiary ? `
            <tr style="background: white; border-bottom: 1px solid #eab308;">
              <td style="padding: 2px 4px; font-weight: bold; color: #854d0e;">TERTIARY JOB</td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b;">
                <span style="font-size: 12px; margin-right: 3px;">${getPositionEmoji(tertiaryJobTitle)}</span>
                ${tertiaryJobTitle}
              </td>
              <td style="padding: 2px 4px; font-weight: 600; color: #1e293b;">${tertiaryDepartment}</td>
              <td style="padding: 2px 4px; text-align: right; font-weight: bold; color: #1e293b;">$${parseFloat(tertiaryWage).toFixed(2)}/hr</td>
            </tr>` : ''}
          </table>
        </div>
      </div>

      <!-- Financial Compensation -->
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 3px; margin-bottom: 4px;">
        <div style="background: #fffbeb; border: 1px solid #fbbf24; border-radius: 4px; padding: 4px;">
          <h2 style="margin: 0 0 2px 0; color: #92400e; font-size: 10.5px; font-weight: bold; text-transform: uppercase; text-align: center;">
            ğŸ’° FINANCIAL COMPENSATION
          </h2>
          <table style="width: 100%; border-collapse: collapse; font-size: 9.5px;">
            <tr style="border-bottom: 1px solid #fde68a;">
              <td style="padding: 1px 0; font-weight: bold; color: #92400e;">Training Pay</td>
              <td style="padding: 1px 0; text-align: right; font-weight: bold; color: #1e293b;">$${parseFloat(trainingPay).toFixed(2)}/hr</td>
            </tr>
            <tr style="border-bottom: 1px solid #fde68a;">
              <td style="padding: 1px 0; font-weight: bold; color: #92400e;">Overtime Pay</td>
              <td style="padding: 1px 0; text-align: right; font-weight: bold; color: #1e293b;">${overtimeDisplay}</td>
            </tr>
            <tr style="border-bottom: 1px solid #fde68a;">
              <td style="padding: 1px 0; font-weight: bold; color: #92400e;">Meeting Pay</td>
              <td style="padding: 1px 0; text-align: right; font-weight: bold; color: #1e293b;">$${parseFloat(meetingPay).toFixed(2)}/hr</td>
            </tr>
            ${vacationPay > 0 ? `
            <tr>
              <td style="padding: 1px 0; font-weight: bold; color: #92400e;">Vacation Pay</td>
              <td style="padding: 1px 0; text-align: right; font-weight: bold; color: #1e293b;">$${parseFloat(vacationPay).toFixed(2)}/hr</td>
            </tr>` : ''}
          </table>
        </div>

        <!-- Tip Section (if needed) -->
        ${(isTipPoolPosition || isServerPosition) ? `
        <div style="background: #fef3c7; border: 1px solid #fbbf24; border-radius: 4px; padding: 4px;">
          <h2 style="margin: 0 0 2px 0; background: #fef08a; color: #1e40af; font-size: 10.5px; font-weight: bold; text-transform: uppercase; text-align: center; padding: 1px; border-radius: 2px;">
            Financial Responsibilities
          </h2>
          ${isTipPoolPosition && !isServerPosition ? `
          <p style="margin: 2px 0 1px 0; font-size: 9px; font-weight: bold; color: #1e293b;">Position(s) in Tip Pool:</p>
          <p style="margin: 0 0 2px 0; font-size: 9.5px; font-weight: 600; color: #10b981;">
            ${[position, secondaryJobTitle, tertiaryJobTitle]
              .filter(Boolean)
              .filter(t => ['busser','cashier','host','hostess','bartender'].some(k => t.toLowerCase().includes(k)))
              .join(', ') || 'None'}
          </p>
          <p style="margin: 0; font-size: 9px; color: #1e293b;">Included in Tip Pool: <strong>Yes</strong></p>
          ` : ''}
          ${isServerPosition ? `
          <p style="margin: 2px 0 1px 0; font-size: 9px; font-weight: bold; color: #1e293b;">Server Position(s):</p>
          <p style="margin: 0 0 2px 0; font-size: 9.5px; font-weight: 600; color: #1e40af;">
            ${[position, secondaryJobTitle, tertiaryJobTitle]
              .filter(Boolean)
              .filter(t => t.toLowerCase().includes('server'))
              .join(', ')}
          </p>
          <p style="margin: 2px 0 0 0; font-size: 9px; color: #1e293b;">Tip to House Pool: <strong>${tipToHouse.toFixed(2)}%</strong></p>
          <p style="margin: 1px 0 0 0; font-size: 9px; color: #1e293b;">Merchant Services: <strong>${merchantServices.toFixed(2)}%</strong></p>
          ` : ''}
        </div>` : ''}
      </div>

      <!-- Benefits -->
      <div style="background: #ecfdf5; border: 1px solid #10b981; border-radius: 4px; padding: 3px; margin-bottom: 3px;">
        <h2 style="margin: 0 0 2px 0; background: #fef08a; color: #854d0e; font-size: 8.5px; font-weight: bold; text-transform: uppercase; text-align: center; padding: 1px; border-radius: 2px;">
          Benefits for all employees
        </h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 8.5px;">
          <tr style="border-bottom: 1px solid #d1fae5;">
            <td style="padding: 1px 3px; font-weight: bold; color: #047857; width: 50%;">Employee Meal</td>
            <td style="padding: 1px 3px; color: #1e293b;">No cost</td>
          </tr>
          <tr style="border-bottom: 1px solid #d1fae5;">
            <td style="padding: 1px 3px; font-weight: bold; color: #047857;">Beverage Discounts</td>
            <td style="padding: 1px 3px; color: #1e293b;">30%</td>
          </tr>
          <tr>
            <td style="padding: 1px 3px; font-weight: bold; color: #047857;">Worker Comp</td>
            <td style="padding: 1px 3px; color: #1e293b;">Yes</td>
          </tr>
        </table>
      </div>

      ${isFullTime ? `
      <div style="background: #dbeafe; border: 1px solid #3b82f6; border-radius: 4px; padding: 3px; margin-bottom: 3px;">
        <h2 style="margin: 0 0 2px 0; background: #fef08a; color: #854d0e; font-size: 8px; font-weight: bold; text-transform: uppercase; text-align: center; padding: 1px; border-radius: 2px;">
          Benefits for qualified full time employees
        </h2>
        <table style="width: 100%; border-collapse: collapse; font-size: 7.5px;">
          <tr style="border-bottom: 1px solid #bfdbfe;">
            <td style="padding: 1px 3px; font-weight: bold; color: #1e40af; width: 23%;">Health Insurance</td>
            <td style="padding: 1px 3px; color: #1e293b;">50% ER for Employee</td>
            <td style="padding: 1px 3px; color: #1e293b;">Family at cost</td>
          </tr>
          <tr style="border-bottom: 1px solid #bfdbfe;">
            <td style="padding: 1px 3px; font-weight: bold; color: #1e40af;">Dental Insurance</td>
            <td style="padding: 1px 3px; color: #1e293b;">ER Paid Basic</td>
            <td style="padding: 1px 3px; color: #1e293b;">ER 50% Buy-Up</td>
          </tr>
          <tr style="border-bottom: 1px solid #bfdbfe;">
            <td style="padding: 1px 3px; font-weight: bold; color: #1e40af;">Vision Insurance</td>
            <td style="padding: 1px 3px; color: #1e293b;">ER Paid Basic</td>
            <td style="padding: 1px 3px; color: #1e293b;">Family at cost</td>
          </tr>
          <tr style="border-bottom: 1px solid #bfdbfe;">
            <td style="padding: 1px 3px; font-weight: bold; color: #1e40af;">Life Insurance</td>
            <td style="padding: 1px 3px; color: #1e293b;">$25K ER Paid</td>
            <td style="padding: 1px 3px; color: #1e293b;">â€”</td>
          </tr>
          <tr>
            <td style="padding: 1px 3px; font-weight: bold; color: #1e40af;">Paid Time Off</td>
            <td style="padding: 1px 3px; color: #1e293b;">â‰¤4 yrs: 40 hrs</td>
            <td style="padding: 1px 3px; color: #1e293b;">4+ yrs: 48 hrs</td>
          </tr>
        </table>
      </div>` : ''}

      <!-- Letter Body -->
      <div style="margin-bottom: 6px; font-size: 9.5px; line-height: 1.3;">
        <p style="margin: 2px 0;">Dear ${employee.first_name} ${employee.last_name},</p>
        <p style="margin: 2px 0;">We confirm your compensation plan at Jeng Chi Restaurant, effective <strong>${formattedEffectiveDate}</strong>.</p>
        ${changeReason ? `
        <div style="background: #f8fafc; padding: 3px; border-left: 2px solid #7a1f1f; margin: 3px 0; border-radius: 2px;">
          <p style="margin: 0 0 1px 0; font-weight: bold; color: #1e293b; font-size: 9px;">Reason:</p>
          <p style="margin: 0; color: #475569; font-size: 9px; line-height: 1.3;">${changeReason}</p>
        </div>` : ''}
        <p style="margin: 2px 0 0 0;">We appreciate your dedication and look forward to your continued success.</p>
      </div>

      <!-- âœ… SIGNATURES WITH LINES -->
      <div style="margin-top: 3px; border-top: 1px solid #ccc; padding-top: 6px;">
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 4px; font-size: 8.5px;">
          <!-- Employee -->
          <div>
            <div class="signature-line" style="border-top: 1px solid #000; height: 22px; margin-bottom: 2px;"></div>
            <p style="margin: 0; font-weight: bold;">Employee Signature</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">${employee.first_name} ${employee.last_name}</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">Date: ${todaysDate}</p>
          </div>
          <!-- Owner -->
          <div>
            <div class="signature-line" style="border-top: 1px solid #000; height: 22px; margin-bottom: 2px;"></div>
            <p style="margin: 0; font-weight: bold;">Owner Signature</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">Janelle Teng</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">Date: ${todaysDate}</p>
          </div>
          <!-- Manager -->
          <div>
            <div class="signature-line" style="border-top: 1px solid #000; height: 22px; margin-bottom: 2px;"></div>
            <p style="margin: 0; font-weight: bold;">Manager Signature</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">${
              position.toLowerCase().includes('server') ? 'Shoko Teng' :
              ['cashier','host'].some(k => position.toLowerCase().includes(k)) ? 'An Mai Vu' :
              position.toLowerCase().includes('bartender') ? 'Craig Reeves' :
              ['manager on duty','bar manager','logistic coordinator'].some(k => position.toLowerCase().includes(k)) ? 'Francisco Teng' :
              'Pablo Gonzalez'
            }</p>
            <p style="margin: 1px 0 0 0; color: #64748b;">Date: ${todaysDate}</p>
          </div>
        </div>
      </div>

      <!-- Footer -->
      <div style="padding-top: 4px; border-top: 1px solid #e2e8f0; font-size: 7.5px; color: #94a3b8; margin-top: 2px;">
        <div style="padding: 3px; background: #fef2f2; border-left: 2px solid #ef4444; border-radius: 2px; margin-bottom: 2px;">
          <p style="margin: 0; line-height: 1.2;">
            <strong>DISCLAIMER:</strong> This confirms your compensation plan. Employment is at-will. This is not an employment contract.
          </p>
        </div>
        <div style="text-align: center;">
          <p style="margin: 0 0 1px 0; font-weight: 600;">Jeng Chi Restaurant â€¢ Richardson, Texas</p>
          <p style="margin: 0;">Generated: ${new Date().toLocaleDateString('en-US')}</p>
        </div>
      </div>
    </div>
  `;
}

// ============================================================================
// AUTO-CALCULATE PAY RATES BASED ON EMPLOYEE TYPE AND POSITIONS
// ============================================================================
// ============================================================================
// AUTO-CALCULATE PAY RATES BASED ON EMPLOYEE TYPE AND POSITIONS
// ============================================================================
function autoCalculatePayRates() {
  const employee = CompensationState.selectedEmployee;
  if (!employee) return;
  
  const positionNumField = document.getElementById('comp-letter-position-number');
  const compensationTypeField = document.getElementById('comp-letter-compensation-type');
  const hourlyRateInput = document.getElementById('comp-letter-hourly-rate');
  const annualSalaryInput = document.getElementById('comp-letter-annual-salary');
  const trainingPayInput = document.getElementById('comp-letter-training-pay');
  const overtimePayInput = document.getElementById('comp-letter-overtime-pay');
  const meetingPayInput = document.getElementById('comp-letter-meeting-pay');
  const vacationPayInput = document.getElementById('comp-letter-vacation-pay');
  const positionTitleField = document.getElementById('comp-letter-position-title');
  
  // âœ… NULL CHECK - Exit if any required field is missing
  if (!positionNumField || !compensationTypeField || !hourlyRateInput || !annualSalaryInput) {
    console.log('âš ï¸ Auto-calculate skipped: form fields not ready yet');
    return;
  }
  
  const positionNum = parseInt(positionNumField.value);
  const compensationType = compensationTypeField.value;
  
  // Get hourly rate or calculate from salary
  let baseHourlyRate = 0;
  
  if (compensationType === 'hourly') {
    baseHourlyRate = parseFloat(hourlyRateInput.value) || 0;
  } else {
    // SALARY EMPLOYEE - Calculate hourly equivalent
    const annualSalary = parseFloat(annualSalaryInput.value) || 0;
    const jobTitle = positionTitleField ? positionTitleField.value : '';
    const firstName = employee.first_name || '';
    const lastName = employee.last_name || '';
    const fullName = `${firstName} ${lastName}`.trim();
    
    // Special cases based on job title or employee name
    let hoursPerWeek = 40; // Default
    
    if (jobTitle === 'Production Manager' || jobTitle === 'Logistic Coordinator') {
      hoursPerWeek = 40;
    } else if (jobTitle === 'Wok Chef') {
      hoursPerWeek = 50;
    } else if (fullName === 'Yu Li') {
      hoursPerWeek = 48;
    } else if (fullName === 'Xing Cheng') {
      hoursPerWeek = 45;
    } else if (fullName === 'Cesar Ramirez') {
      hoursPerWeek = 50;
    }
    
    // Calculate: annual_salary / 52 weeks / hours_per_week
    baseHourlyRate = annualSalary / 52 / hoursPerWeek;
    
    console.log(`ğŸ’° Salary calculation for ${fullName}: $${annualSalary} / 52 / ${hoursPerWeek} = $${baseHourlyRate.toFixed(2)}/hr`);
  }
  
  // âœ… Exit if fields don't exist
  if (!trainingPayInput || !overtimePayInput || !meetingPayInput || !vacationPayInput) {
    console.log('âš ï¸ Auto-calculate skipped: pay rate fields not ready yet');
    return;
  }
  
  // Check if employee has multiple positions
  const hasMultiplePositions = employee.job_title2 || employee.hourly_rate2;
  
  // Get all position rates
  const rate1 = employee.hourly_rate || 0;
  const rate2 = employee.hourly_rate2 || 0;
  const rate3 = employee.hourly_rate3 || 0;
  const highestRate = Math.max(rate1, rate2, rate3);
  
  if (compensationType === 'hourly') {
    if (hasMultiplePositions) {
      // HOURLY - MULTIPLE POSITIONS
      trainingPayInput.value = highestRate.toFixed(2);
      meetingPayInput.value = highestRate.toFixed(2);
      overtimePayInput.value = ''; // Leave blank for blended OT
      overtimePayInput.placeholder = 'Blended OT calculated by Toast';
      vacationPayInput.value = baseHourlyRate.toFixed(2);
      
      // Add label for blended OT
      const overtimeLabel = overtimePayInput.closest('.form-group')?.querySelector('label');
      if (overtimeLabel && !overtimeLabel.textContent.includes('Blended')) {
        overtimeLabel.innerHTML = 'Overtime Pay <span class="text-amber-600 text-xs font-bold">(Blended OT - Calculated by Toast)</span>';
      }
    } else {
      // HOURLY - SINGLE POSITION
      trainingPayInput.value = baseHourlyRate.toFixed(2);
      meetingPayInput.value = baseHourlyRate.toFixed(2);
      overtimePayInput.value = (baseHourlyRate * 1.5).toFixed(2);
      vacationPayInput.value = baseHourlyRate.toFixed(2);
    }
  } else {
    // SALARY - NO OVERTIME
    trainingPayInput.value = baseHourlyRate.toFixed(2);
    meetingPayInput.value = baseHourlyRate.toFixed(2);
    overtimePayInput.value = '0.00';
    overtimePayInput.placeholder = 'No OT for salary employees';
    vacationPayInput.value = baseHourlyRate.toFixed(2);
    
    // Add label for salary - no OT
    const overtimeLabel = overtimePayInput.closest('.form-group')?.querySelector('label');
    if (overtimeLabel && !overtimeLabel.textContent.includes('No OT')) {
      overtimeLabel.innerHTML = 'Overtime Pay <span class="text-red-600 text-xs font-bold">(No OT for Salary Employees)</span>';
    }
  }
  
  console.log('âœ… Auto-calculated pay rates:', {
    compensationType,
    baseHourlyRate: baseHourlyRate.toFixed(2),
    hasMultiplePositions
  });
}



// ============================================================================
// ğŸ”„ RESET COMPENSATION FORM
// ============================================================================
function resetCompensationForm() {
  if (!confirm('Are you sure you want to reset the form? All unsaved changes will be lost.')) {
    return;
  }
  
  const employee = CompensationState.selectedEmployee;
  if (employee) {
    // Reload employee data to reset form
    selectEmployeeForCompLetter(employee);
    showToast('âœ… Form reset to current employee data', 'success');
  }
}


// ============================================================================
// 9. SAVE COMPENSATION LETTER & GENERATE PDF
// ============================================================================
// ============================================================================
// 9. SAVE COMPENSATION LETTER & GENERATE PDF - COMPLETE VERSION
// ============================================================================
async function saveCompensationLetter(e) {
  e.preventDefault();
  
  const employeeId = document.getElementById('comp-letter-selected-employee-id').value;
  if (!employeeId) {
    showToast('Please select an employee', 'error');
    return;
  }

  const saveBtn = document.getElementById('comp-letter-save-btn');
  if (saveBtn) {
    saveBtn.disabled = true;
    saveBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Saving...';
  }

  try {
    const formData = collectCompensationFormData();
    if (!formData) {
      showToast('Please fill in all required fields', 'error');
      return;
    }

    // âœ… GENERATE PDF FIRST
    const letterHTML = generateCompensationLetterHTML(formData);
    const element = document.createElement('div');
    element.innerHTML = letterHTML;
    
    // Generate PDF blob
    const pdfBlob = await html2pdf()
      .from(element)
      .set({
        margin: 0.5,
        filename: `compensation-${formData.employee.employee_id}-${formData.effectiveDate}.pdf`,
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      })
      .outputPdf('blob');

    // âœ… SAVE ALL THREE POSITIONS TO WAGE HISTORY
    const wageRecords = [];
    
    // Base record data
    const baseRecord = {
      employee_id: parseInt(employeeId),
      training_pay: formData.trainingPay,
      overtime_pay: formData.overtimePay,
      meeting_pay: formData.meetingPay,
      vacation_pay: formData.vacationPay || null,
      compensation_type: 'hourly',
      effective_date: formData.effectiveDate,
      hire_date: formData.hireDate,
      employment_type: formData.employmentType,
      change_type: formData.changeType,
      change_reason: formData.changeReason || null,
      approved_by: formData.approvedBy,
      is_current: true,
      is_tip_position: formData.isTipPosition,
      included_in_tip_pool: formData.includedInTipPool,
      tip_to_house_pool_percent: formData.isServer ? formData.tipToHouse : null,
      tip_back_merchant_services_percent: formData.isServer ? formData.merchantServices : null,
      qualifies_for_full_time_benefits: formData.employmentType === 'full_time',
      letter_generated: true,
      letter_generated_at: new Date().toISOString(),
      created_by: 'HR Admin'
    };
    
    // PRIMARY POSITION
    wageRecords.push({
      ...baseRecord,
      position_number: 1,
      position_title: formData.position,
      department: formData.department,
      hourly_rate: formData.hourlyRate
    });
    
    // SECONDARY POSITION (if exists)
    if (formData.secondaryJobTitle && formData.secondaryWage > 0) {
      wageRecords.push({
        ...baseRecord,
        position_number: 2,
        position_title: formData.secondaryJobTitle,
        department: formData.secondaryDepartment,
        hourly_rate: formData.secondaryWage
      });
    }
    
    // TERTIARY POSITION (if exists)
    if (formData.tertiaryJobTitle && formData.tertiaryWage > 0) {
      wageRecords.push({
        ...baseRecord,
        position_number: 3,
        position_title: formData.tertiaryJobTitle,
        department: formData.tertiaryDepartment,
        hourly_rate: formData.tertiaryWage
      });
    }

    // âœ… UPLOAD PDF TO SUPABASE STORAGE
    const pdfFileName = `compensation_${formData.employee.employee_id}_${formData.effectiveDate}_${Date.now()}.pdf`;
    
    const { data: uploadData, error: uploadError } = await supabaseClient.storage
      .from('compensation-letters')  // Make sure this bucket exists in Supabase
      .upload(pdfFileName, pdfBlob, {
        contentType: 'application/pdf',
        cacheControl: '3600',
        upsert: false
      });

    if (uploadError) {
      console.error('PDF upload error:', uploadError);
      // Continue anyway, save without PDF URL
    }

    // Get public URL for the PDF
    let pdfUrl = null;
    if (uploadData) {
      const { data: urlData } = supabaseClient.storage
        .from('compensation-letters')
        .getPublicUrl(pdfFileName);
      pdfUrl = urlData.publicUrl;
    }

    // Add PDF URL to all wage records
    if (pdfUrl) {
      wageRecords.forEach(record => {
        record.pdf_url = pdfUrl;
      });
    }

    // âœ… Save all position records to wage_history
    const { data: savedWages, error: saveError } = await supabaseClient
      .from('wage_history')
      .insert(wageRecords)
      .select();

    if (saveError) throw saveError;

    // âœ… Update employees2025 table with all positions
    const updateData = {
      job_title: formData.position,
      hourly_rate: formData.hourlyRate,
      department: formData.department,
      compensation_type: 'hourly',
      original_hire_date: formData.hireDate,
      trainning: formData.trainingPay,
      meetingpay: { rate: formData.meetingPay },
      vacation: formData.vacationPay,
      overtime: formData.overtimePay
    };
    
    if (formData.secondaryJobTitle && formData.secondaryWage > 0) {
      updateData.job_title2 = formData.secondaryJobTitle;
      updateData.hourly_rate2 = formData.secondaryWage;
    }
    
    if (formData.tertiaryJobTitle && formData.tertiaryWage > 0) {
      updateData.job_title3 = formData.tertiaryJobTitle;
      updateData.hourly_rate3 = formData.tertiaryWage;
    }

    const { error: updateError } = await supabaseClient
      .from('employees2025')
      .update(updateData)
      .eq('id', employeeId);

    if (updateError) throw updateError;

    // âœ… DOWNLOAD THE PDF AUTOMATICALLY
    const link = document.createElement('a');
    link.href = URL.createObjectURL(pdfBlob);
    link.download = `compensation-${formData.employee.employee_id}-${formData.effectiveDate}.pdf`;
    link.click();
    URL.revokeObjectURL(link.href);

    showToast('âœ… Compensation saved and PDF generated!', 'success');
    
    // âœ… Refresh data
    await loadEmployees();
    await loadWageHistory(employeeId);
    
    // âœ… Reset form
    document.getElementById('comp-letter-form').reset();
    const overtimeDisplay = document.getElementById('comp-letter-overtime-display');
    if (overtimeDisplay) overtimeDisplay.textContent = '--';

    if (window.hideStickySaveButton) {
      window.hideStickySaveButton();
    }

  } catch (error) {
    console.error('Error saving compensation:', error);
    showToast('âŒ Failed to save: ' + error.message, 'error');
  } finally {
    if (saveBtn) {
      saveBtn.disabled = false;
      saveBtn.innerHTML = '<i class="fa-solid fa-floppy-disk"></i> ğŸ’¾ SAVE ALL CHANGES';
    }
  }
}


// ============================================================================
// 10. GENERATE PDF FROM FORM DATA
// ============================================================================
function generateCompensationPDF(formData) {
  const letterHTML = generateCompensationLetterHTML(formData);
  const element = document.createElement('div');
  element.innerHTML = letterHTML;
  
  html2pdf()
    .from(element)
    .set({
      margin: 0.5,
      filename: `compensation-${formData.employee.employee_id}-${formData.effectiveDate}.pdf`,
      html2canvas: { scale: 2, useCORS: true },
      jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
    })
    .save()
    .then(() => {
      showToast('âœ… PDF generated successfully!', 'success');
    })
    .catch(err => {
      console.error('PDF generation error:', err);
      showToast('âŒ Failed to generate PDF', 'error');
    });
}

// ============================================================================
// 11. PRINT COMPENSATION LETTER
// ============================================================================
function printCompensationLetter() {
  const formData = collectCompensationFormData();
  if (!formData) {
    showToast('Please fill in all required fields first', 'error');
    return;
  }

  const content = generateCompensationLetterHTML(formData);
  const printWindow = window.open('', '', 'height=800,width=800');
  
  printWindow.document.write(`
    <html>
      <head>
        <title>Compensation Letter - ${formData.employee.first_name} ${formData.employee.last_name}</title>
        <style>
          body { font-family: Arial, sans-serif; margin: 0; padding: 20px; }
          @media print {
            @page { margin: 0.5in; }
          }
        </style>
      </head>
      <body>
        ${content}
      </body>
    </html>
  `);
  
  printWindow.document.close();
  setTimeout(() => {
    printWindow.print();
  }, 250);
}

// ============================================================================
// 12. VIEW EXISTING COMPENSATION LETTER
// ============================================================================
window.viewCompensationLetter = async function(wageHistoryId) {
  try {
    // Load the specific wage history record
    const { data: wageRecord, error: wageError } = await supabaseClient
      .from('wage_history')
      .select('*, employees2025(*)')
      .eq('id', wageHistoryId)
      .single();

    if (wageError) throw wageError;

    // Load ALL positions for this employee from the same effective date
    const { data: allPositions, error: positionsError } = await supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', wageRecord.employee_id)
      .eq('effective_date', wageRecord.effective_date)
      .order('position_number', { ascending: true });

    if (positionsError) throw positionsError;

    // Extract position data
    const primary = allPositions.find(p => p.position_number === 1);
    const secondary = allPositions.find(p => p.position_number === 2);
    const tertiary = allPositions.find(p => p.position_number === 3);

    // Generate the EXACT SAME format as Preview
    const letterHTML = generateCompensationLetterHTML({
      employee: wageRecord.employees2025,
      // Primary position
      position: primary?.position_title || wageRecord.position_title,
      department: primary?.department || wageRecord.department,
      hourlyRate: parseFloat(primary?.hourly_rate || wageRecord.hourly_rate),
      // Secondary position
      secondaryJobTitle: secondary?.position_title || null,
      secondaryDepartment: secondary?.department || null,
      secondaryWage: secondary ? parseFloat(secondary.hourly_rate) : 0,
      // Tertiary position
      tertiaryJobTitle: tertiary?.position_title || null,
      tertiaryDepartment: tertiary?.department || null,
      tertiaryWage: tertiary ? parseFloat(tertiary.hourly_rate) : 0,
      // Compensation
      trainingPay: parseFloat(wageRecord.training_pay),
      meetingPay: parseFloat(wageRecord.meeting_pay),
      vacationPay: parseFloat(wageRecord.vacation_pay || 0),
      overtimePay: parseFloat(wageRecord.overtime_pay),
      // Dates and metadata
      effectiveDate: wageRecord.effective_date,
      changeType: wageRecord.change_type,
      changeReason: wageRecord.change_reason,
      approvedBy: wageRecord.approved_by,
      employmentType: wageRecord.employment_type,
      hireDate: wageRecord.hire_date,
      // Tip info
      isTipPosition: wageRecord.is_tip_position,
      isServer: wageRecord.position_title?.toLowerCase().includes('server'),
      includedInTipPool: wageRecord.included_in_tip_pool,
      tipToHouse: parseFloat(wageRecord.tip_to_house_pool_percent) || 4.00,
      merchantServices: parseFloat(wageRecord.tip_back_merchant_services_percent) || 3.00
    });

    // Open in new window with SAME format as Preview
    const viewWindow = window.open('', '', 'height=800,width=900');
    viewWindow.document.write(`
      <html>
        <head>
          <title>Compensation Letter - ${wageRecord.employees2025.first_name} ${wageRecord.employees2025.last_name}</title>
          <style>
            body { margin: 0; padding: 20px; font-family: Arial, sans-serif; background: #f5f5f5; }
            @media print {
              body { background: white; }
              @page { margin: 0.5in; }
            }
          </style>
        </head>
        <body>
          ${letterHTML}
        </body>
      </html>
    `);
    viewWindow.document.close();

  } catch (error) {
    console.error('Error loading compensation letter:', error);
    showToast('Failed to load compensation letter', 'error');
  }
}

window.downloadCompensationPDF = async function(wageHistoryId) {
  try {
    // Load the specific wage history record
    const { data: wageRecord, error: wageError } = await supabaseClient
      .from('wage_history')
      .select('*, employees2025(*)')
      .eq('id', wageHistoryId)
      .single();

    if (wageError) throw wageError;

    // Load ALL positions for this employee from the same effective date
    const { data: allPositions, error: positionsError } = await supabaseClient
      .from('wage_history')
      .select('*')
      .eq('employee_id', wageRecord.employee_id)
      .eq('effective_date', wageRecord.effective_date)
      .order('position_number', { ascending: true });

    if (positionsError) throw positionsError;

    // Extract position data
    const primary = allPositions.find(p => p.position_number === 1);
    const secondary = allPositions.find(p => p.position_number === 2);
    const tertiary = allPositions.find(p => p.position_number === 3);

    // Generate the EXACT SAME format as Preview
    const letterHTML = generateCompensationLetterHTML({
      employee: wageRecord.employees2025,
      // Primary position
      position: primary ? primary.position_title : wageRecord.position_title,
      department: primary ? primary.department : wageRecord.department,
      hourlyRate: primary ? parseFloat(primary.hourly_rate) : parseFloat(wageRecord.hourly_rate),
      // Secondary position
      secondaryJobTitle: secondary ? secondary.position_title : null,
      secondaryDepartment: secondary ? secondary.department : null,
      secondaryWage: secondary ? parseFloat(secondary.hourly_rate) : 0,
      // Tertiary position
      tertiaryJobTitle: tertiary ? tertiary.position_title : null,
      tertiaryDepartment: tertiary ? tertiary.department : null,
      tertiaryWage: tertiary ? parseFloat(tertiary.hourly_rate) : 0,
      // Compensation
      trainingPay: parseFloat(wageRecord.training_pay),
      meetingPay: parseFloat(wageRecord.meeting_pay),
      vacationPay: parseFloat(wageRecord.vacation_pay || 0),
      overtimePay: parseFloat(wageRecord.overtime_pay),
      // Dates and metadata
      effectiveDate: wageRecord.effective_date,
      changeType: wageRecord.change_type,
      changeReason: wageRecord.change_reason,
      approvedBy: wageRecord.approved_by,
      employmentType: wageRecord.employment_type,
      hireDate: wageRecord.hire_date,
      // Tip info
      isTipPosition: wageRecord.is_tip_position,
      isServer: wageRecord.position_title && wageRecord.position_title.toLowerCase().includes('server'),
      includedInTipPool: wageRecord.included_in_tip_pool,
      tipToHouse: parseFloat(wageRecord.tip_to_house_pool_percent) || 4.00,
      merchantServices: parseFloat(wageRecord.tip_back_merchant_services_percent) || 3.00
    });

    const element = document.createElement('div');
    element.innerHTML = letterHTML;
    
    await html2pdf()
      .from(element)
      .set({
        margin: 0.5,
        filename: `compensation-${wageRecord.employees2025.employee_id}-${wageRecord.effective_date}.pdf`,
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
      })
      .save();

    showToast('âœ… PDF downloaded successfully!', 'success');

  } catch (error) {
    console.error('Error downloading PDF:', error);
    showToast('Failed to download PDF', 'error');
  }
}

// ============================================================================
// 13. INITIALIZE COMPENSATION LETTER TAB
// ============================================================================
function initCompensationLetterTab() {
  console.log('ğŸš€ Initializing Compensation Letter Tab...');
  
  // Setup search
  setupCompensationLetterSearch();
  
  // Setup form logic (tip detection, overtime calc)
  setupCompensationFormLogic();
  
  // Preview button
  const previewBtn = document.getElementById('comp-letter-preview-btn');
  if (previewBtn) {
    previewBtn.addEventListener('click', previewCompensationLetter);
  }
  
  // Save & Generate PDF button
  const form = document.getElementById('comp-letter-form');
  if (form) {
    form.addEventListener('submit', saveCompensationLetter);
  }
  
  // Print button (if you add one)
  const printBtn = document.getElementById('comp-letter-print-btn');
  if (printBtn) {
    printBtn.addEventListener('click', printCompensationLetter);
  }

  // âœ… AUTO-CALCULATE OVERTIME WHEN WAGE FIELDS CHANGE
  const primaryWageField = document.getElementById('primary-wage');
  const secondaryWageField = document.getElementById('secondary-wage');
  const tertiaryWageField = document.getElementById('tertiary-wage');
  
  if (primaryWageField) {
    primaryWageField.addEventListener('input', calculateOvertimeRate);
    primaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  if (secondaryWageField) {
    secondaryWageField.addEventListener('input', calculateOvertimeRate);
    secondaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  if (tertiaryWageField) {
    tertiaryWageField.addEventListener('input', calculateOvertimeRate);
    tertiaryWageField.addEventListener('change', calculateOvertimeRate);
  }
  
  console.log('âœ… Overtime calculation listeners attached');
  
  // Refresh button
  const refreshBtn = document.getElementById('comp-letter-refresh');
  if (refreshBtn) {
    refreshBtn.addEventListener('click', async () => {
      await loadEmployees();
      if (CompensationState.selectedEmployee) {
        await loadWageHistory(CompensationState.selectedEmployee.id);
      }
      showToast('Data refreshed', 'success');
    });
  }

  console.log('âœ… Compensation Letter tab initialized');
}

// ============================================================================
// CREATE POSITION CARD WITH INDIVIDUAL FIELDS
// ============================================================================
function createPositionCard(slotNumber, positionData = {}) {
  const isPosition1 = slotNumber === 1;
  const employmentType = document.getElementById('comp-letter-employment-type')?.value || 'part_time';
  const showVacationPay = employmentType === 'full_time';
  
  return `
    <div class="bg-white rounded-xl border-2 border-gray-300 p-6 mb-4 position-card" data-position-slot="${slotNumber}">
      
      <!-- Card Header -->
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center space-x-2">
          <div class="bg-emerald-100 p-2 rounded-lg">
            <i class="fas fa-briefcase text-emerald-600"></i>
          </div>
          <h4 class="text-lg font-black text-gray-900">
            Position ${slotNumber} ${isPosition1 ? '<span class="text-xs text-emerald-600 ml-2">(PRIMARY)</span>' : ''}
          </h4>
        </div>
        ${slotNumber > 1 ? `
          <button type="button" 
                  onclick="removePosition(${slotNumber})"
                  class="px-3 py-1.5 bg-red-100 hover:bg-red-200 text-red-700 font-bold rounded-lg transition-all duration-200 flex items-center space-x-1">
            <i class="fas fa-trash-alt"></i>
            <span>Remove</span>
          </button>
        ` : ''}
      </div>

      <!-- Position Info Grid -->
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
        
        <!-- Job Title -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Job Title <span class="text-red-500">*</span>
          </label>
          <input type="text" 
                 id="job-title-${slotNumber}" 
                 value="${positionData.jobTitle || ''}"
                 placeholder="e.g., Server"
                 required
                 class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
        </div>

        <!-- Department -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Department <span class="text-red-500">*</span>
          </label>
          <select id="department-${slotNumber}" 
                  required
                  class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
            <option value="">Select...</option>
            <option value="FOH" ${positionData.department === 'FOH' ? 'selected' : ''}>FOH</option>
            <option value="BOH" ${positionData.department === 'BOH' ? 'selected' : ''}>BOH</option>
          </select>
        </div>

        <!-- Hourly Rate -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            Hourly Rate <span class="text-red-500">*</span>
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="hourly-rate-${slotNumber}" 
                   value="${positionData.hourlyRate || ''}"
                   step="0.01"
                   min="0"
                   required
                  
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-emerald-500 focus:border-emerald-500 font-semibold">
          </div>
        </div>

      </div>

      <!-- Compensation Rates Grid -->
      <div class="grid grid-cols-1 md:grid-cols-${showVacationPay ? '4' : '3'} gap-4">
        
        ${isPosition1 ? `
        <!-- Training Pay (Position 1 Only) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-graduation-cap text-blue-600 mr-1"></i>
            Training Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="training-pay-${slotNumber}" 
                   value="${positionData.trainingPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">During training period</p>
        </div>
        ` : ''}

        <!-- Meeting Pay -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-users text-purple-600 mr-1"></i>
            Meeting Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="meeting-pay-${slotNumber}" 
                   value="${positionData.meetingPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">For attending meetings</p>
        </div>

        ${showVacationPay ? `
        <!-- Vacation Pay (Full-Time Only) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-umbrella-beach text-teal-600 mr-1"></i>
            Vacation Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="number" 
                   id="vacation-pay-${slotNumber}" 
                   value="${positionData.vacationPay || ''}"
                   step="0.01"
                   min="0"
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-teal-500 focus:border-teal-500 font-semibold">
          </div>
          <p class="text-xs text-gray-500 mt-1">Accrual per hour</p>
        </div>
        ` : ''}

        <!-- Overtime Pay (DISABLED/READ-ONLY) -->
        <div>
          <label class="block text-sm font-bold text-gray-700 mb-2">
            <i class="fas fa-clock text-orange-600 mr-1"></i>
            Overtime Pay
          </label>
          <div class="relative">
            <span class="absolute left-3 top-2.5 text-gray-500 font-bold">$</span>
            <input type="text" 
                   id="overtime-pay-${slotNumber}" 
                   value="--"
                   disabled
                   readonly
                   class="w-full pl-8 pr-4 py-2.5 border border-gray-300 rounded-lg bg-gray-100 font-semibold text-orange-600">
          </div>
          <p class="text-xs text-gray-500 mt-1" id="overtime-note-${slotNumber}">Auto-calculated</p>
        </div>

      </div>

    </div>
  `;
}

// ============================================================================
// CALCULATE OVERTIME RATE (1 position = 1.5x, Multiple = "BLENDED")
// ============================================================================
// ============================================================================
// CALCULATE OVERTIME RATE
// ============================================================================

function calculateOvertimeRate() {
  const primaryWage = parseFloat(document.getElementById('primary-wage')?.value || 0);
  const secondaryWage = parseFloat(document.getElementById('secondary-wage')?.value || 0);
  const tertiaryWage = parseFloat(document.getElementById('tertiary-wage')?.value || 0);
  
  const overtimeDisplay = document.getElementById('comp-letter-overtime-display');
  const overtimeHidden = document.getElementById('comp-letter-overtime-pay');
  const overtimeNote = document.getElementById('overtime-calculation-note');
  
  if (!overtimeDisplay) return;
  
  // Count positions with wages
  const positions = [];
  if (primaryWage > 0) positions.push(primaryWage);
  if (secondaryWage > 0) positions.push(secondaryWage);
  if (tertiaryWage > 0) positions.push(tertiaryWage);
  
  if (positions.length === 0) {
    overtimeDisplay.textContent = '--';
    if (overtimeNote) overtimeNote.textContent = 'Will show 1.5x or BLENDED';
    return;
  }
  
  if (positions.length === 1) {
    // SINGLE POSITION: 1.5x
    const overtime = (primaryWage * 1.5).toFixed(2);
    overtimeDisplay.textContent = '$' + overtime;
    if (overtimeHidden) overtimeHidden.value = overtime;
    if (overtimeNote) {
      overtimeNote.innerHTML = '<i class="fa-solid fa-check-circle text-emerald-600"></i> Calculated at 1.5x primary wage';
    }
  } else {
    // MULTIPLE POSITIONS: BLENDED
    const avgWage = positions.reduce((sum, w) => sum + w, 0) / positions.length;
    const blendedOvertime = (avgWage * 1.5).toFixed(2);
    overtimeDisplay.textContent = 'BLENDED';
    if (overtimeHidden) overtimeHidden.value = blendedOvertime;
    if (overtimeNote) {
      overtimeNote.innerHTML = '<i class="fa-solid fa-blender text-purple-600"></i> BLENDED: $' + blendedOvertime + '/hr (avg Ã— 1.5)';
    }
  }
  
  console.log('âœ… Overtime calculated:', {
    positions: positions.length,
    display: overtimeDisplay.textContent,
    hidden: overtimeHidden?.value
  });
}


// ============================================================================
// ADD NEW POSITION
// ============================================================================
function addPosition() {
  const container = document.getElementById('comp-letter-positions-form-container');
  const currentPositions = document.querySelectorAll('.position-card').length;
  
  if (currentPositions >= 3) {
    showToast('âš ï¸ Maximum 3 positions allowed', 'warning');
    return;
  }
  
  const newSlot = currentPositions + 1;
  const newCard = createPositionCard(newSlot);
  container.insertAdjacentHTML('beforeend', newCard);
  
  // Update add button visibility
  if (newSlot >= 3) {
    document.getElementById('add-position-btn')?.classList.add('hidden');
  }
  
  calculateOvertimeRate();
}

// ============================================================================
// REMOVE POSITION
// ============================================================================
function removePosition(slotNumber) {
  if (slotNumber === 1) {
    showToast('âš ï¸ Cannot remove primary position', 'error');
    return;
  }
  
  const card = document.querySelector(`[data-position-slot="${slotNumber}"]`);
  if (card) {
    card.remove();
  }
  
  // Show add button again
  document.getElementById('add-position-btn')?.classList.remove('hidden');
  
  calculateOvertimeRate();
}





// ============================================================================
// LOAD EMPLOYEE POSITIONS INTO CARDS
// ============================================================================
function loadEmployeePositions(employee) {
  const container = document.getElementById('comp-letter-positions-form-container');
  container.innerHTML = ''; // Clear existing cards
  
  // Load Position 1 (always exists)
  if (employee.job_title) {
    const card1 = createPositionCard(1, {
      jobTitle: employee.job_title,
      department: employee.department,
      hourlyRate: employee.hourly_rate,
      trainingPay: employee.trainning,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation,
      overtimePay: employee.overtime
    });
    container.insertAdjacentHTML('beforeend', card1);
  }
  
  // Load Position 2 (if exists)
  if (employee.job_title2) {
    const card2 = createPositionCard(2, {
      jobTitle: employee.job_title2,
      department: employee.department,
      hourlyRate: employee.hourly_rate2,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation
    });
    container.insertAdjacentHTML('beforeend', card2);
  }
  
  // Load Position 3 (if exists)
  if (employee.job_title3) {
    const card3 = createPositionCard(3, {
      jobTitle: employee.job_title3,
      department: employee.department,
      hourlyRate: employee.hourly_rate3,
      meetingPay: employee.meetingpay?.rate || '',
      vacationPay: employee.vacation
    });
    container.insertAdjacentHTML('beforeend', card3);
  }
  
  // Calculate overtime
  calculateOvertimeRate();
  
  // Update add button visibility
  const positionCount = document.querySelectorAll('.position-card').length;
  const addBtn = document.getElementById('add-position-btn');
  if (positionCount >= 3) {
    addBtn?.classList.add('hidden');
  } else {
    addBtn?.classList.remove('hidden');
  }
}

// ============================================================================
// CLEAR SECONDARY POSITION
// ============================================================================

// ============================================================================
// CLEAR TERTIARY POSITION
// ============================================================================
// ============================================================================
// CLEAR TERTIARY POSITION
// ============================================================================


// ============================================================================
// LOAD EXISTING EMPLOYEE DATA INTO FORM (AUTO-FILL)
// ============================================================================
function loadEmployeeCompensationData(employee) {
  if (!employee) return;
  
  console.log('ğŸ“‹ Loading employee compensation data:', employee);
  
  // PRIMARY JOB (always exists)
  if (employee.job_title) {
    document.getElementById('primary-job-title').value = employee.job_title || '';
    document.getElementById('primary-department').value = employee.department || '';
    document.getElementById('primary-wage').value = employee.hourly_rate || '';
  }
  
  // SECONDARY JOB (if exists)
  if (employee.job_title2 && employee.hourly_rate2) {
    document.getElementById('secondary-job-title').value = employee.job_title2;
    document.getElementById('secondary-department').value = employee.department || '';
    document.getElementById('secondary-wage').value = employee.hourly_rate2;
  } else {
    // Clear if no secondary job
    document.getElementById('secondary-job-title').value = '';
    document.getElementById('secondary-department').value = '';
    document.getElementById('secondary-wage').value = '';
  }
  
  // TERTIARY JOB (if exists)
  if (employee.job_title3 && employee.hourly_rate3) {
    document.getElementById('tertiary-job-title').value = employee.job_title3;
    document.getElementById('tertiary-department').value = employee.department || '';
    document.getElementById('tertiary-wage').value = employee.hourly_rate3;
  } else {
    // Clear if no tertiary job
    document.getElementById('tertiary-job-title').value = '';
    document.getElementById('tertiary-department').value = '';
    document.getElementById('tertiary-wage').value = '';
  }
  
  // ADDITIONAL COMPENSATION
  document.getElementById('comp-letter-training-pay').value = employee.trainning || '';
  document.getElementById('comp-letter-meeting-pay').value = employee.meetingpay?.rate || '';
  document.getElementById('comp-letter-vacation-pay').value = employee.vacation || '';
  
  // EMPLOYMENT INFO
  document.getElementById('comp-letter-employment-type').value = employee.employment_type || 'part_time';
  document.getElementById('comp-letter-hire-date').value = employee.original_hire_date || employee.hire_date || '';
  
  // Calculate overtime
  calculateOvertimeRate();
  
  console.log('âœ… Employee data loaded successfully');
}




// ============================================================================
// ADD TO BOOTSTRAP FUNCTION
// ============================================================================
// Add this line in your existing bootstrap() function:
// initCompensationLetterTab();

/* =====================================================
   GLOBAL POSITION CLEAR FUNCTIONS (REQUIRED FOR onclick)
   ===================================================== */

window.clearSecondaryPosition = function () {
  const title = document.getElementById('secondary-job-title');
  const dept  = document.getElementById('secondary-department');
  const wage  = document.getElementById('secondary-wage');

  if (title) title.value = '';
  if (dept)  dept.value  = '';
  if (wage)  wage.value  = '';

  console.log('ğŸ—‘ï¸ Secondary position cleared');
};

window.clearTertiaryPosition = function () {
  const title = document.getElementById('tertiary-job-title');
  const dept  = document.getElementById('tertiary-department');
  const wage  = document.getElementById('tertiary-wage');

  if (title) title.value = '';
  if (dept)  dept.value  = '';
  if (wage)  wage.value  = '';

  console.log('ğŸ—‘ï¸ Tertiary position cleared');
};

// ========================================================================
// TOGGLE SECONDARY & TERTIARY JOB SECTIONS BASED ON COMPENSATION TYPE
// ========================================================================






function setupJobToggles() {
  // Handle Secondary Job toggle
  const secToggle = document.getElementById('secondary-job-enabled');
  const secInputs = document.querySelectorAll('#secondary-job-title, #secondary-department, #secondary-wage');
  
  secToggle?.addEventListener('change', () => {
    const enabled = secToggle.checked;
    secInputs.forEach(input => {
      input.disabled = !enabled;
      input.closest('.bg-white').style.opacity = enabled ? '1' : '0.5';
      input.closest('.bg-white').style.backgroundColor = enabled ? 'white' : '#f9fafb';
    });
  });

  // Handle Tertiary Job toggle
  const terToggle = document.getElementById('tertiary-job-enabled');
  const terInputs = document.querySelectorAll('#tertiary-job-title, #tertiary-department, #tertiary-wage');
  
  terToggle?.addEventListener('change', () => {
    const enabled = terToggle.checked;
    terInputs.forEach(input => {
      input.disabled = !enabled;
      input.closest('.bg-white').style.opacity = enabled ? '1' : '0.5';
      input.closest('.bg-white').style.backgroundColor = enabled ? 'white' : '#f9fafb';
    });
  });
}

// Initialize job toggles when page loads
document.addEventListener('DOMContentLoaded', setupJobToggles);







 </script>
  </body>
</html>
