<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>JENG CHI • Executive Enterprise Dashboard (Live + Reports + Search)</title>

  <!-- Tailwind / Fonts / Icons -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet" />
  <script src="https://unpkg.com/lucide@latest"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Charts -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

  <style>
    :root{ --jc-accent:#7A3D36; --jc-ink:#0f172a; --jc-muted:#6b7280; --jc-bg:#f5f6f8; --jc-border:#e5e7eb; }
    html,body{height:100%}
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial; background:var(--jc-bg); color:var(--jc-ink)}
    .glass{background:linear-gradient(180deg,#fff,rgba(255,255,255,.92)); box-shadow:0 10px 24px rgba(16,24,40,.08),0 2px 8px rgba(16,24,40,.06); border:1px solid var(--jc-border)}
    .brand-gradient{background:linear-gradient(135deg, var(--jc-accent) 0%, #91493f 35%, #b86b61 100%)}
    .brand-chip{background:linear-gradient(180deg,rgba(255,255,255,.18),rgba(255,255,255,.06)); border:1px solid rgba(255,255,255,.35)}
    .btn{display:inline-flex; align-items:center; gap:.5rem; padding:.65rem 1rem; border-radius:.75rem; font-weight:600;}
    .btn-primary{background:var(--jc-accent); color:#fff; box-shadow:0 8px 20px rgba(122,61,54,.25)}
    .btn-outline{background:#fff; border:1px solid var(--jc-border); color:var(--jc-ink)}
    .tab-active{color:var(--jc-accent); background-color:#fff; border-color:var(--jc-border)}
    .table thead th{position:sticky; top:0; background:#fff}
    .table tr:hover{background:#fafafa}
    .ph{display:grid; place-items:center; background:repeating-linear-gradient(45deg,#fafafa,#fafafa 10px,#f0f0f0 10px,#f0f0f0 20px); border:1px dashed #d1d5db; color:#6b7280}
    @media print{ body{background:#fff} #app-shell{display:none} #report-print{display:block} @page{size:Letter; margin:0.5in} }
  </style>
</head>
<body class="min-h-screen">
  <!-- Top Bar -->
  <header class="brand-gradient text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
      <div class="flex items-center justify-between py-4">
        <div class="flex items-center gap-3">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="h-10 w-10 rounded-lg shadow-md ring-1 ring-white/40"/>
          <div>
            <h1 class="text-xl sm:text-2xl font-extrabold tracking-tight">JENG CHI • ENTERPRISE</h1>
            <div class="mt-0.5 inline-flex items-center brand-chip px-2 py-1 rounded-lg text-xs/relaxed">Inventory • Invoices • Vendors • Reports</div>
          </div>
        </div>
        <div class="hidden md:flex items-center gap-3">
          <div class="relative">
            <input type="search" placeholder="Search… (display only)" class="w-80 rounded-xl border border-white/40 bg-white/10 placeholder-white/80 text-white px-4 py-2 outline-none"/>
            <div class="absolute right-2 top-2 opacity-80"><i data-lucide="search"></i></div>
          </div>
          <button class="btn btn-primary rounded-xl" disabled id="newInvoiceBtn"><i data-lucide="file-plus"></i> New Invoice</button>
        </div>
      </div>
    </div>
  </header>

  <!-- App Shell -->
  <div id="app-shell" class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8 py-8">
    <!-- KPI Row -->
    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-5 mb-8">
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Invoices (30d)</p>
        <p id="kpi-invoices" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Total Spend (30d)</p>
        <p id="kpi-spend" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Vendors</p>
        <p id="kpi-vendors" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
      <div class="glass rounded-2xl p-5">
        <p class="text-sm text-slate-500">Catalog Items</p>
        <p id="kpi-items" class="mt-2 text-3xl font-extrabold">—</p>
        <p class="text-xs text-slate-500 mt-1">Live from Supabase</p>
      </div>
    </section>

    <!-- Tabs -->
    <nav class="flex flex-wrap gap-2 mb-6">
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="products"><i data-lucide="package"></i> Products</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="invoices"><i data-lucide="receipt"></i> Invoices</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="vendors"><i data-lucide="building-2"></i> Vendors</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="reports"><i data-lucide="bar-chart-3"></i> Reports</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="search"><i data-lucide="search"></i> Search Product</button>
      <button class="tab-btn btn btn-outline rounded-xl" data-tab="standardize"><i data-lucide="list-checks"></i> Standardize</button>
    </nav>

    <!-- PRODUCTS (live) -->
    <section id="tab-products" class="glass rounded-2xl p-6 hidden">
      <header class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-5">
        <div>
          <h2 class="text-xl font-extrabold">Product Price History</h2>
          <p class="text-sm text-slate-500">Live from <code>price_history</code>. Search & filter are client-side.</p>
        </div>
        <div class="flex flex-wrap items-center gap-3">
          <div class="relative">
            <input id="searchProducts" class="rounded-xl border border-slate-200 bg-white px-3 py-2 w-72" placeholder="Search name, vendor, item #" />
            <div class="absolute right-3 top-2.5 text-slate-400"><i data-lucide="search"></i></div>
          </div>
          <select id="vendorFilter" class="rounded-xl border border-slate-200 bg-white px-3 py-2"><option value="">All Vendors</option></select>
          <select id="sortSelect" class="rounded-xl border border-slate-200 bg-white px-3 py-2">
            <option value="date-desc">Date (Newest First)</option>
            <option value="date-asc">Date (Oldest First)</option>
            <option value="price-desc">Price (High → Low)</option>
            <option value="price-asc">Price (Low → High)</option>
          </select>
        </div>
      </header>
      <div class="overflow-hidden rounded-xl border border-slate-200">
        <table class="table w-full">
          <thead>
            <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
              <th class="p-3">Invoice Date</th>
              <th class="p-3">Invoice #</th>
              <th class="p-3">Vendor</th>
              <th class="p-3">Item #</th>
              <th class="p-3">Product</th>
              <th class="p-3 text-right">Price</th>
            </tr>
          </thead>
          <tbody id="productsTbody" class="text-sm">
            <tr><td class="p-4 text-center" colspan="6">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="productsEmpty" class="hidden text-center text-slate-500 text-sm py-4">No matches.</div>
    </section>

    <!-- INVOICES (live, grouped) -->
    <section id="tab-invoices" class="glass rounded-2xl p-6 hidden">
      <header class="flex items-center justify-between mb-4">
        <div>
          <h2 class="text-xl font-extrabold">Invoices</h2>
          <p class="text-sm text-slate-500">Grouped by invoice number (from <code>price_history</code>).</p>
        </div>
        <div class="flex items-center gap-3">
          <input id="searchInvoices" placeholder="Search invoice # or vendor" class="rounded-xl border border-slate-200 px-3 py-2" />
          <button id="exportCsv" class="btn btn-outline rounded-xl"><i data-lucide="download"></i> Export</button>
        </div>
      </header>
      <div class="overflow-hidden rounded-xl border border-slate-200">
        <table class="table w-full">
          <thead>
            <tr class="text-left text-slate-500 text-xs uppercase tracking-wide">
              <th class="p-3">Date</th>
              <th class="p-3">Invoice #</th>
              <th class="p-3">Vendor</th>
              <th class="p-3 text-right">Lines</th>
              <th class="p-3 text-right">Total</th>
            </tr>
          </thead>
          <tbody id="invoicesTbody" class="text-sm">
            <tr><td class="p-4 text-center" colspan="5">Loading…</td></tr>
          </tbody>
        </table>
      </div>
      <div id="invoicesEmpty" class="hidden text-center text-slate-500 text-sm py-4">No invoices.</div>
    </section>

    <!-- VENDORS (live summary) -->
    <section id="tab-vendors" class="glass rounded-2xl p-6 hidden">
      <header class="flex items-center justify-between mb-5">
        <div><h2 class="text-xl font-extrabold">Vendors</h2><p class="text-sm text-slate-500">Totals from last 90 days.</p></div>
      </header>
      <div id="vendorsGrid" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-5"></div>
    </section>

    <!-- REPORTS (live charts) -->
    <section id="tab-reports" class="glass rounded-2xl p-6 hidden">
      <header class="mb-4">
        <h2 class="text-xl font-extrabold">Reports</h2>
        <p class="text-sm text-slate-500">Choose a time frame and explore.</p>
      </header>

      <!-- Chart 1: Product price comparison by vendor -->
      <div class="glass rounded-xl p-4 mb-6">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-4">
          <div>
            <h3 class="font-semibold">1) Price by Vendor for a Product</h3>
            <p class="text-xs text-slate-500">Pick a product and date range. Lines = vendors, points = invoice dates.</p>
          </div>
          <div class="flex flex-wrap items-end gap-2">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">Product</label>
              <input id="rep1-product" class="rounded-xl border border-slate-300 px-3 py-2 w-64" placeholder="e.g., Large Eggs, BK-044" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">From</label>
              <input id="rep1-from" type="date" class="rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">To</label>
              <input id="rep1-to" type="date" class="rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <button id="rep1-run" class="btn btn-outline rounded-xl">Update</button>
          </div>
        </div>
        <div class="relative">
          <canvas id="chartProduct" height="110"></canvas>
        </div>
      </div>

      <!-- Chart 2: Spend by vendor -->
      <div class="glass rounded-xl p-4">
        <div class="flex flex-col lg:flex-row lg:items-end lg:justify-between gap-4 mb-4">
          <div>
            <h3 class="font-semibold">2) Spend by Vendor (Time Frame)</h3>
            <p class="text-xs text-slate-500">Totals per vendor within the date range.</p>
          </div>
          <div class="flex flex-wrap items-end gap-2">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">From</label>
              <input id="rep2-from" type="date" class="rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1">To</label>
              <input id="rep2-to" type="date" class="rounded-xl border border-slate-300 px-3 py-2" />
            </div>
            <button id="rep2-run" class="btn btn-outline rounded-xl">Update</button>
          </div>
        </div>
        <div class="relative">
          <canvas id="chartVendor" height="110"></canvas>
        </div>
      </div>
    </section>

    <!-- SEARCH PRODUCT (new tab) -->
    <section id="tab-search" class="glass rounded-2xl p-6 hidden">
      <header class="mb-4">
        <h2 class="text-xl font-extrabold">Search Product</h2>
        <p class="text-sm text-slate-500">Find product, see image, vendor, current vs previous price (with dates).</p>
      </header>
      <div class="flex flex-wrap items-end gap-3 mb-4">
        <div class="relative">
          <label class="block text-xs font-semibold text-slate-600 mb-1">Keyword</label>
          <input id="searchTerm" class="rounded-xl border border-slate-300 px-3 py-2 w-80" placeholder="Product name or item code" />
          <div class="absolute right-3 top-10 text-slate-400"><i data-lucide="search"></i></div>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-600 mb-1">Vendor (optional)</label>
          <select id="searchVendor" class="rounded-xl border border-slate-300 px-3 py-2 min-w-[220px]">
            <option value="">All Vendors</option>
          </select>
        </div>
        <button id="searchRun" class="btn btn-outline rounded-xl">Search</button>
      </div>
      <div id="searchResults" class="grid md:grid-cols-2 xl:grid-cols-3 gap-4"></div>
      <div id="searchEmpty" class="hidden text-center text-slate-500 text-sm py-4">No results.</div>
    </section>

    <!-- STANDARDIZE (static placeholder) -->
    <section id="tab-standardize" class="glass rounded-2xl p-6 hidden">
      <header class="mb-4"><h2 class="text-xl font-extrabold">Standardize Product Names</h2><p class="text-sm text-slate-500">Static form (hook up later).</p></header>
      <div class="text-sm text-slate-500">Coming soon.</div>
    </section>
  </div>

  <!-- Print-only Report sheet (static) -->
  <section id="report-print" class="hidden p-6">
    <h1 class="text-2xl font-extrabold mb-1">JENG CHI — Spend Summary</h1>
    <p class="text-sm text-slate-600 mb-4">Period: Last 30 days • Generated: <span id="print-date"></span></p>
    <table class="w-full text-sm border border-slate-300">
      <thead class="bg-slate-100">
        <tr><th class="text-left p-2 border-b border-slate-300">Vendor</th><th class="text-right p-2 border-b border-slate-300">Invoices</th><th class="text-right p-2 border-b border-slate-300">Total</th></tr>
      </thead>
      <tbody id="print-body">
        <tr><td class="p-2 border-t border-slate-200">—</td><td class="p-2 border-t border-slate-200 text-right">—</td><td class="p-2 border-t border-slate-200 text-right">—</td></tr>
      </tbody>
    </table>
  </section>

  <script>
    // Icons
    lucide.createIcons();

    // Tabs
    const tabs=["products","invoices","vendors","reports","search","standardize"];
    const btns=document.querySelectorAll('.tab-btn');
    const sections=tabs.map(t=>document.getElementById(`tab-${t}`));
    function showTab(name){
      sections.forEach(s=>s.classList.add('hidden'));
      document.getElementById(`tab-${name}`).classList.remove('hidden');
      btns.forEach(b=>{ if(b.dataset.tab===name){b.classList.add('tab-active');} else{b.classList.remove('tab-active');} });
      lucide.createIcons();
      if(name==='reports'){ drawReportDefaultsOnce(); }
    }
    showTab('products');
    btns.forEach(b=>b.addEventListener('click',()=>showTab(b.dataset.tab)));

    document.getElementById('print-date').textContent = new Date().toLocaleString();

    // ===== Supabase (live read from price_history) =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // State
    let rows = [];    // raw price_history rows (latest load)
    let viewRows = [];    // filtered/sorted
    let chartProduct, chartVendor;
    let loadedOnceReports = false;

    // DOM refs (tables)
    const productsTbody = document.getElementById('productsTbody');
    const productsEmpty = document.getElementById('productsEmpty');
    const searchProducts = document.getElementById('searchProducts');
    const vendorFilter = document.getElementById('vendorFilter');
    const sortSelect = document.getElementById('sortSelect');
    const kpiInvoices = document.getElementById('kpi-invoices');
    const kpiSpend = document.getElementById('kpi-spend');
    const kpiVendors = document.getElementById('kpi-vendors');
    const kpiItems = document.getElementById('kpi-items');

    const invoicesTbody = document.getElementById('invoicesTbody');
    const invoicesEmpty = document.getElementById('invoicesEmpty');
    const searchInvoices = document.getElementById('searchInvoices');
    const exportCsvBtn = document.getElementById('exportCsv');

    const vendorsGrid = document.getElementById('vendorsGrid');
    const printBody = document.getElementById('print-body');

    // DOM refs (reports)
    const rep1Product = document.getElementById('rep1-product');
    const rep1From = document.getElementById('rep1-from');
    const rep1To = document.getElementById('rep1-to');
    const rep1Run = document.getElementById('rep1-run');

    const rep2From = document.getElementById('rep2-from');
    const rep2To = document.getElementById('rep2-to');
    const rep2Run = document.getElementById('rep2-run');

    // DOM refs (search)
    const searchTerm = document.getElementById('searchTerm');
    const searchVendor = document.getElementById('searchVendor');
    const searchRun = document.getElementById('searchRun');
    const searchResults = document.getElementById('searchResults');
    const searchEmpty = document.getElementById('searchEmpty');

    // Helpers
    const fmtCurrency = (n)=> new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD' }).format(n||0);
    const fmtDate = (d)=> d ? new Date(d).toISOString().slice(0,10) : '';
    function debounce(fn, ms=250){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; }

    function applyFilters(){
      const q = (searchProducts.value||'').toLowerCase();
      const vend = vendorFilter.value;
      viewRows = rows.filter(r=>{
        const hay = `${r.product_name||''} ${r.standard_name||''} ${r.vendor||''} ${r.item_number||''}`.toLowerCase();
        const passQ = !q || hay.includes(q);
        const passV = !vend || r.vendor === vend;
        return passQ && passV;
      });
      const sort = sortSelect.value;
      viewRows.sort((a,b)=>{
        if(sort==='date-desc') return (new Date(b.invoice_date)-new Date(a.invoice_date));
        if(sort==='date-asc') return (new Date(a.invoice_date)-new Date(b.invoice_date));
        if(sort==='price-desc') return Number(b.price||0)-Number(a.price||0);
        if(sort==='price-asc') return Number(a.price||0)-Number(b.price||0);
        return 0;
      });
      renderProducts();
    }

    function renderProducts(){
      if(viewRows.length===0){
        productsTbody.innerHTML = '';
        productsEmpty.classList.remove('hidden');
        return;
      }
      productsEmpty.classList.add('hidden');
      const html = viewRows.map(r=>`
        <tr>
          <td class="p-3">${fmtDate(r.invoice_date)}</td>
          <td class="p-3">${r.invoice_number||''}</td>
          <td class="p-3">${r.vendor||''}</td>
          <td class="p-3">${r.item_number||''}</td>
          <td class="p-3">${r.product_name||r.standard_name||''}</td>
          <td class="p-3 text-right font-semibold">${fmtCurrency(Number(r.price||0))}</td>
        </tr>`).join('');
      productsTbody.innerHTML = html;
    }

    function renderVendorFilter(){
      const vendors = Array.from(new Set(rows.map(r=>r.vendor).filter(Boolean))).sort();
      vendorFilter.innerHTML = '<option value="">All Vendors</option>' + vendors.map(v=>`<option>${v}</option>`).join('');
      searchVendor.innerHTML = '<option value="">All Vendors</option>' + vendors.map(v=>`<option>${v}</option>`).join('');
    }

    function renderInvoices(){
      if(rows.length===0){ invoicesTbody.innerHTML=''; invoicesEmpty.classList.remove('hidden'); return; }
      invoicesEmpty.classList.add('hidden');
      const q=(searchInvoices.value||'').toLowerCase();
      // group by invoice_number + vendor + date
      const groups = new Map();
      for(const r of rows){
        const key = `${r.invoice_number||'N/A'}|${r.vendor||''}|${fmtDate(r.invoice_date)}`;
        const sum = Number(r.price||0); // NOTE: if you add qty & line_total, replace with line_total or price*qty
        const g = groups.get(key) || {date:fmtDate(r.invoice_date), inv:r.invoice_number||'N/A', vendor:r.vendor||'', lines:0, total:0};
        g.lines+=1; g.total+=sum; groups.set(key,g);
      }
      const list = [...groups.values()].filter(g=>{
        const hay = `${g.inv} ${g.vendor}`.toLowerCase();
        return !q || hay.includes(q);
      }).sort((a,b)=> new Date(b.date)-new Date(a.date));
      invoicesTbody.innerHTML = list.map(g=>`
        <tr>
          <td class="p-3">${g.date}</td>
          <td class="p-3">${g.inv}</td>
          <td class="p-3">${g.vendor}</td>
          <td class="p-3 text-right">${g.lines}</td>
          <td class="p-3 text-right font-semibold">${fmtCurrency(g.total)}</td>
        </tr>`).join('');
    }

    function renderVendorsSummary(){
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-90);
      const byVendor = new Map();
      for(const r of rows){
        if(r.invoice_date && new Date(r.invoice_date) < cutoff) continue;
        const v = r.vendor||'Unknown';
        const o = byVendor.get(v) || {vendor:v, total:0, lines:0};
        o.total += Number(r.price||0); // NOTE: switch to line_total when you add it
        o.lines += 1; byVendor.set(v,o);
      }
      const list = [...byVendor.values()].sort((a,b)=> b.total-a.total);
      vendorsGrid.innerHTML = list.map(v=>`
        <div class="glass rounded-2xl p-4">
          <div class="flex items-center justify-between mb-2">
            <div class="font-semibold">${v.vendor}</div>
            <span class="text-slate-400 text-sm">${v.lines} lines</span>
          </div>
          <div class="text-sm text-slate-600">Total (90d)</div>
          <div class="text-xl font-extrabold">${fmtCurrency(v.total)}</div>
        </div>`).join('');

      // Print sheet body
      printBody.innerHTML = list.slice(0,12).map(v=>
        `<tr><td class="p-2 border-t border-slate-200">${v.vendor}</td><td class="p-2 border-t border-slate-200 text-right">${v.lines}</td><td class="p-2 border-t border-slate-200 text-right">${fmtCurrency(v.total)}</td></tr>`
      ).join('');
    }

    function updateKpis(){
      const cutoff = new Date(); cutoff.setDate(cutoff.getDate()-30);
      const last30 = rows.filter(r=> r.invoice_date && new Date(r.invoice_date) >= cutoff);
      const invoices = new Set(last30.map(r=> `${r.invoice_number||'N/A'}|${r.vendor||''}|${fmtDate(r.invoice_date)}`));
      const vendors = new Set(rows.map(r=>r.vendor).filter(Boolean));
      const items = new Set(rows.map(r=>r.item_number).filter(Boolean));
      const spend = last30.reduce((acc,r)=> acc + Number(r.price||0), 0); // NOTE: replace with line_total when you add it
      kpiInvoices.textContent = invoices.size || '0';
      kpiSpend.textContent = fmtCurrency(spend);
      kpiVendors.textContent = vendors.size || '0';
      kpiItems.textContent = items.size || '0';
    }

    // Export CSV from "invoices" view
    exportCsvBtn.addEventListener('click', ()=>{
      const rowsCsv = [['Date','Invoice','Vendor','Lines','Total']];
      [...invoicesTbody.querySelectorAll('tr')].forEach(tr=>{
        const cells=[...tr.children].map(td=> td.textContent.trim());
        if(cells.length===5 && cells[0]!=="Loading…") rowsCsv.push(cells);
      });
      const csv = rowsCsv.map(r=> r.map(v=>`"${(v||'').replaceAll('"','""')}"`).join(',')).join('\n');
      const blob = new Blob([csv],{type:'text/csv'});
      const a = Object.assign(document.createElement('a'),{ href:URL.createObjectURL(blob), download:'invoices_summary.csv' });
      document.body.appendChild(a); a.click(); a.remove();
    });

    // Live load
    async function loadPriceHistory(limit=4000){
      productsTbody.innerHTML = '<tr><td class="p-4 text-center" colspan="6">Loading…</td></tr>';
      invoicesTbody.innerHTML = '<tr><td class="p-4 text-center" colspan="5">Loading…</td></tr>';
      try{
        const { data, error } = await sb
          .from('price_history')
          .select('item_number,product_name,standard_name,price,vendor,invoice_number,invoice_date,image_url,created_at')
          .order('invoice_date', { ascending:false })
          .limit(limit);
        if(error) throw error;
        rows = data || [];
        viewRows = rows.slice();
        renderVendorFilter();
        applyFilters();
        renderInvoices();
        renderVendorsSummary();
        updateKpis();
      }catch(err){
        console.error('[price_history load]', err);
        productsTbody.innerHTML = '<tr><td class="p-4 text-center text-rose-600" colspan="6">Failed to load data.</td></tr>';
        invoicesTbody.innerHTML = '<tr><td class="p-4 text-center text-rose-600" colspan="5">Failed to load data.</td></tr>';
      }
    }

    // ===== Reports: chart helpers =====
    function withinRange(d, from, to){
      const t = new Date(d).getTime();
      if(from && t < new Date(from).getTime()) return false;
      if(to && t > new Date(to).getTime()) return false;
      return true;
    }

    // Chart 1: Product price comparison by vendor
    function buildProductDatasets(queryText, from, to){
      const q = (queryText||'').toLowerCase();
      const pool = rows.filter(r=>{
        const hay = `${r.item_number||''} ${r.product_name||''} ${r.standard_name||''}`.toLowerCase();
        return (!q || hay.includes(q)) && r.invoice_date && withinRange(r.invoice_date, from, to);
      });
      // group by vendor -> time series (date, price)
      const byVendor = new Map();
      for(const r of pool){
        const v = r.vendor || 'Unknown';
        const list = byVendor.get(v) || [];
        list.push({ x: new Date(r.invoice_date), y: Number(r.price||0) });
        byVendor.set(v, list);
      }
      // sort by date asc
      const datasets = [];
      for(const [vendor, list] of byVendor.entries()){
        list.sort((a,b)=> a.x - b.x);
        datasets.push({
          label: vendor,
          data: list,
          tension: 0.25,
          borderWidth: 2,
          pointRadius: 3
        });
      }
      // X labels
      const allDates = Array.from(new Set(pool.map(r=> fmtDate(r.invoice_date)))).sort();
      return { labels: allDates, datasets };
    }

    function drawProductChart(queryText, from, to){
      const ctx = document.getElementById('chartProduct').getContext('2d');
      const { labels, datasets } = buildProductDatasets(queryText, from, to);
      if(chartProduct) chartProduct.destroy();
      chartProduct = new Chart(ctx, {
        type: 'line',
        data: { labels, datasets },
        options: {
          responsive: true,
          animation: false,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: { mode: 'index', intersect: false }
          },
          scales: {
            x: { ticks: { autoSkip: true, maxTicksLimit: 10 } },
            y: { beginAtZero: false, ticks: { callback: v => fmtCurrency(v) } }
          }
        }
      });
    }

    // Chart 2: Spend by vendor for time frame
    function buildVendorTotals(from, to){
      const byVendor = new Map();
      for(const r of rows){
        if(!r.invoice_date || !withinRange(r.invoice_date, from, to)) continue;
        const v = r.vendor || 'Unknown';
        const o = byVendor.get(v) || 0;
        // NOTE: if you add qty and/or line_total columns, replace Number(r.price||0) with line_total or price*qty
        byVendor.set(v, o + Number(r.price||0));
      }
      const list = [...byVendor.entries()].sort((a,b)=> b[1]-a[1]);
      return { labels: list.map(([v])=>v), totals: list.map(([,t])=>t) };
    }

    function drawVendorChart(from, to){
      const ctx = document.getElementById('chartVendor').getContext('2d');
      const { labels, totals } = buildVendorTotals(from, to);
      if(chartVendor) chartVendor.destroy();
      chartVendor = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{ label: 'Total', data: totals }]
        },
        options: {
          responsive: true,
          animation: false,
          plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => fmtCurrency(ctx.raw) } } },
          scales: { y: { beginAtZero: true, ticks: { callback: v => fmtCurrency(v) } } }
        }
      });
    }

    function drawReportDefaultsOnce(){
      if(loadedOnceReports) return;
      loadedOnceReports = true;
      // defaults: last 60 days
      const to = new Date(); const from = new Date(); from.setDate(to.getDate()-60);
      rep1From.value = from.toISOString().slice(0,10);
      rep1To.value = to.toISOString().slice(0,10);
      rep2From.value = rep1From.value;
      rep2To.value = rep1To.value;
      drawProductChart(rep1Product.value, rep1From.value, rep1To.value);
      drawVendorChart(rep2From.value, rep2To.value);
    }

    rep1Run.addEventListener('click', ()=> drawProductChart(rep1Product.value, rep1From.value, rep1To.value));
    rep2Run.addEventListener('click', ()=> drawVendorChart(rep2From.value, rep2To.value));

    // ===== Search Product tab =====
    function latestAndPrevious(list){
      // list sorted desc by date
      if(list.length===0) return null;
      const latest = list[0];
      let prev = null;
      for(let i=1;i<list.length;i++){
        if(Number(list[i].price||0) !== Number(latest.price||0)){
          prev = list[i]; break;
        }
      }
      return { latest, prev };
    }

    function renderSearchResults(items){
      if(items.length===0){ searchResults.innerHTML=''; searchEmpty.classList.remove('hidden'); return; }
      searchEmpty.classList.add('hidden');
      searchResults.innerHTML = items.map(it=>{
        const img = it.latest.image_url || 'https://placehold.co/160x160/E5E7EB/6B7280?text=No+Image';
        const latest = it.latest;
        const prev = it.prev;
        const delta = prev ? (Number(latest.price||0)-Number(prev.price||0)) : 0;
        const deltaTxt = prev ? `${delta>0?'+':''}${fmtCurrency(delta)} vs ${fmtCurrency(prev.price||0)} on ${fmtDate(prev.invoice_date)}` : '—';
        return `
          <div class="glass rounded-2xl p-4">
            <div class="flex gap-4">
              <img src="${img}" class="w-24 h-24 object-contain rounded-xl border border-slate-200" onerror="this.onerror=null;this.src='https://placehold.co/160x160/E5E7EB/6B7280?text=No+Image';" />
              <div class="flex-1">
                <div class="text-sm text-slate-500">${it.item_number || ''}</div>
                <div class="text-lg font-extrabold">${it.product_name || it.standard_name || '(Unnamed Product)'}</div>
                <div class="text-sm text-slate-600">Vendor: <span class="font-semibold">${it.vendor}</span></div>
                <div class="mt-1 text-sm">
                  <div><span class="text-slate-500">Current:</span> <span class="font-semibold">${fmtCurrency(latest.price||0)}</span> <span class="text-slate-500">on</span> ${fmtDate(latest.invoice_date)}</div>
                  <div class="text-slate-600"><span class="text-slate-500">Previous:</span> ${prev ? fmtCurrency(prev.price||0) : '—'} ${prev ? `on ${fmtDate(prev.invoice_date)}` : ''}</div>
                  <div class="${delta>0?'text-rose-600':(delta<0?'text-emerald-600':'text-slate-500')} text-xs mt-0.5">Δ ${deltaTxt}</div>
                </div>
              </div>
            </div>
          </div>`;
      }).join('');
    }

    function runProductSearch(){
      const q = (searchTerm.value||'').toLowerCase().trim();
      const vend = searchVendor.value;
      const filtered = rows.filter(r=>{
        const hay = `${r.item_number||''} ${r.product_name||''} ${r.standard_name||''}`.toLowerCase();
        const passQ = !q || hay.includes(q);
        const passV = !vend || r.vendor===vend;
        return passQ && passV;
      });
      // group by vendor + item_number (or fallback key)
      const groups = new Map();
      for(const r of filtered){
        const key = `${r.vendor||''}|${r.item_number||r.product_name||r.standard_name||''}`;
        const arr = groups.get(key) || [];
        arr.push(r);
        groups.set(key, arr);
      }
      const items = [];
      for(const [key, list] of groups.entries()){
        list.sort((a,b)=> new Date(b.invoice_date)-new Date(a.invoice_date)); // desc
        const pick = latestAndPrevious(list);
        if(!pick) continue;
        const top = pick.latest;
        items.push({
          vendor: top.vendor,
          item_number: top.item_number,
          product_name: top.product_name,
          standard_name: top.standard_name,
          latest: top,
          prev: pick.prev
        });
      }
      renderSearchResults(items);
    }

    searchRun.addEventListener('click', runProductSearch);

    // ===== Events on tables =====
    searchProducts.addEventListener('input', debounce(applyFilters, 250));
    vendorFilter.addEventListener('change', applyFilters);
    sortSelect.addEventListener('change', applyFilters);
    searchInvoices.addEventListener('input', debounce(renderInvoices, 250));

    // Kickoff
    loadPriceHistory().then(()=> {
      // set default report dates after initial load
      if(!rep1From.value || !rep1To.value) drawReportDefaultsOnce();
    });
  </script>
</body>
</html>
