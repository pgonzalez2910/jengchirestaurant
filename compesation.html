<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Compensation Letter Generator</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            serifHead: ['Playfair Display', 'serif'],
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
          colors: {
            jcGold: '#C0A06D',
            jcInk: '#0F172A',
            jcMuted: '#6B7280',
            jcBorder: '#E5E7EB',
            jcBg: '#FBF8F3',
          },
          boxShadow: {
            elevated: '0 8px 30px rgba(0,0,0,0.05)',
          },
        },
      },
    };
  </script>
</head>

<body class="font-sans bg-jcBg text-jcInk">
  <main class="max-w-3xl mx-auto px-4 py-10 space-y-6">
    <header class="flex items-center gap-4 mb-8">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
           class="h-10 rounded shadow-sm" alt="Jeng Chi Logo" />
      <div>
        <h1 class="font-serifHead text-2xl text-jcInk">Compensation Letter Generator</h1>
        <p class="text-jcMuted text-sm">For Hourly and Salary Employees</p>
      </div>
    </header>

    <form id="compForm" class="bg-white p-6 rounded-xl shadow-elevated border border-jcBorder space-y-5">

      <!-- Select Employee -->
      <div>
        <label class="block text-sm font-semibold text-jcInk mb-1">Select Employee</label>
        <select id="employeeSelect"
                class="w-full border border-jcBorder rounded-lg p-2.5 text-sm focus:ring-jcGold focus:border-jcGold">
          <option value="">Loading employees…</option>
        </select>
      </div>

      <!-- Auto-filled Info -->
      <div id="empInfo" class="hidden grid grid-cols-2 gap-4 text-sm">
        <div>
          <span class="font-medium text-jcMuted">Position</span>
          <p id="empPosition" class="font-semibold"></p>
        </div>
        <div>
          <span class="font-medium text-jcMuted">Department</span>
          <p id="empDept" class="font-semibold"></p>
        </div>
      </div>

      <!-- Compensation Type -->
      <div>
        <label class="block text-sm font-semibold text-jcInk mb-1">Compensation Type</label>
        <select id="compType"
                class="w-full border border-jcBorder rounded-lg p-2.5 text-sm focus:ring-jcGold focus:border-jcGold">
          <option value="">Select type…</option>
          <option value="hourly">Hourly</option>
          <option value="salary">Salary</option>
        </select>
      </div>

      <!-- Hourly / Salary Inputs -->
      <div id="hourlyInput" class="hidden">
        <label class="block text-sm font-semibold text-jcInk mb-1">Hourly Rate ($)</label>
        <input type="number" step="0.01" id="hourlyRate"
               class="w-full border border-jcBorder rounded-lg p-2.5 text-sm focus:ring-jcGold focus:border-jcGold" />
      </div>

      <div id="salaryInput" class="hidden">
        <label class="block text-sm font-semibold text-jcInk mb-1">Annual Salary ($)</label>
        <input type="number" step="0.01" id="salaryAmount"
               class="w-full border border-jcBorder rounded-lg p-2.5 text-sm focus:ring-jcGold focus:border-jcGold" />
      </div>

      <!-- Effective Date -->
      <div>
        <label class="block text-sm font-semibold text-jcInk mb-1">Effective Date</label>
        <input type="date" id="effectiveDate"
               class="w-full border border-jcBorder rounded-lg p-2.5 text-sm focus:ring-jcGold focus:border-jcGold" />
      </div>

      <!-- Submit -->
      <div class="pt-4 border-t border-jcBorder">
        <button id="generateBtn" type="submit"
                class="bg-jcGold text-jcInk font-semibold px-6 py-2 rounded-lg hover:brightness-95 transition">
          Generate Letter
        </button>
      </div>
    </form>

    <p id="status" class="text-sm text-jcMuted"></p>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    const supabase = createClient(
      "https://kpldzwlftkvjjntgsqxx.supabase.co",
      "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs"
    );

    const employeeSelect = document.getElementById("employeeSelect");
    const empInfo = document.getElementById("empInfo");
    const empPosition = document.getElementById("empPosition");
    const empDept = document.getElementById("empDept");
    const compType = document.getElementById("compType");
    const hourlyInput = document.getElementById("hourlyInput");
    const salaryInput = document.getElementById("salaryInput");
    const statusMsg = document.getElementById("status");

    // --- Load Employees ---
    async function loadEmployees() {
      const { data, error } = await supabase
        .from("hb_handbook_access")
        .select("id, full_name, employee_name, username, position, department, is_active")
        .eq("is_active", true)
        .order("full_name", { ascending: true });

      if (error) {
        employeeSelect.innerHTML = `<option value="">⚠️ Error loading employees</option>`;
        console.error(error);
        return;
      }

      employeeSelect.innerHTML = '<option value="">Select employee…</option>';
      for (const e of data) {
        const label = e.full_name?.trim() || e.employee_name?.trim() || e.username?.trim() || "(Unnamed Employee)";
        employeeSelect.innerHTML += `<option value="${e.id}" data-position="${e.position || ''}" data-department="${e.department || ''}">${label}</option>`;
      }
    }

    // --- Toggle Inputs ---
    compType.addEventListener("change", () => {
      const type = compType.value;
      hourlyInput.classList.toggle("hidden", type !== "hourly");
      salaryInput.classList.toggle("hidden", type !== "salary");
    });

    // --- Autofill Info ---
    employeeSelect.addEventListener("change", () => {
      const opt = employeeSelect.selectedOptions[0];
      if (opt && opt.value) {
        empInfo.classList.remove("hidden");
        empPosition.textContent = opt.dataset.position || "—";
        empDept.textContent = opt.dataset.department || "—";
      } else {
        empInfo.classList.add("hidden");
      }
    });

    // --- Submit Form ---
    document.getElementById("compForm").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "Generating letter…";

      const employee_id = employeeSelect.value;
      const type = compType.value;
      const rate = parseFloat(document.getElementById("hourlyRate").value) || null;
      const salary = parseFloat(document.getElementById("salaryAmount").value) || null;
      const effective_date = document.getElementById("effectiveDate").value;

      if (!employee_id || !type || !effective_date) {
        statusMsg.textContent = "⚠️ Please fill all required fields.";
        return;
      }

      const payload = {
        employee_id,
        compensation_type: type,
        hourly_rate: type === "hourly" ? rate : null,
        salary_amount: type === "salary" ? salary : null,
        effective_date,
      };

      try {
        const resp = await fetch(
          "https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/generate-compensation-letter",
          {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(payload),
          }
        );

        if (!resp.ok) throw new Error(`Edge Function Error: ${resp.status}`);
        const result = await resp.json();

        if (result.url) {
          statusMsg.innerHTML = `<a href="${result.url}" target="_blank" class="text-green-600 underline">✅ Letter generated — open PDF</a>`;
          window.open(result.url, "_blank");
        } else {
          statusMsg.textContent = "Letter created but no URL returned.";
        }
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "❌ Unable to reach Edge Function (check deployment or CORS settings).";
      }
    });

    loadEmployees();
  </script>
</body>
</html>
