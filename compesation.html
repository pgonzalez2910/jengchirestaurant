<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Compensation Letter Generator</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { serifHead: ['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: { jcGold:'#C0A06D', jcInk:'#0F172A', jcMuted:'#6B7280', jcBorder:'#E5E7EB', jcBg:'#FBF8F3' },
          boxShadow: { elevated: '0 8px 30px rgba(0,0,0,0.06)' }
        },
      },
    };
  </script>
</head>

<body class="font-sans bg-jcBg text-jcInk">
  <main class="max-w-3xl mx-auto px-4 py-10 space-y-6">
    <header class="flex items-center gap-4 mb-4">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
           class="h-10 rounded shadow-sm" alt="Jeng Chi Logo" />
      <div>
        <h1 class="font-serifHead text-2xl">Compensation Letter Generator</h1>
        <p class="text-jcMuted text-sm">For Hourly and Salary Employees</p>
      </div>
    </header>

    <form id="f" class="bg-white p-6 rounded-xl shadow-elevated border border-jcBorder space-y-5">
      <!-- Employee -->
      <div>
        <label class="block text-sm font-semibold">Select Employee</label>
        <select id="employeeSelect" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
          <option>Loading employees…</option>
        </select>
      </div>

      <!-- Type + Date -->
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label class="block text-sm font-semibold">Compensation Type</label>
          <select id="compType" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
            <option value="hourly">Hourly</option>
            <option value="salary">Salary</option>
          </select>
        </div>
        <div>
          <label class="block text-sm font-semibold">Effective Date</label>
          <input type="date" id="effectiveDate" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm"/>
        </div>
      </div>

      <!-- Salary input -->
      <div id="salaryWrap" class="hidden">
        <label class="block text-sm font-semibold">Annual Salary ($)</label>
        <input type="number" step="0.01" id="salaryAmount" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm"/>
      </div>

      <!-- Positions (title & rate) -->
      <fieldset id="positionsWrap" class="border border-jcBorder rounded-lg p-4">
        <legend class="text-sm font-semibold px-1">Positions (title & rate)</legend>

        <div id="positions" class="space-y-3 mt-2"></div>

        <div class="mt-3">
          <button id="addPos" type="button"
                  class="px-3 py-1.5 rounded-md border border-jcBorder text-sm hover:bg-gray-50">
            + Add position
          </button>
        </div>
      </fieldset>

      <!-- Additional Pay Categories -->
      <fieldset class="border border-jcBorder rounded-lg p-4">
        <legend class="text-sm font-semibold px-1">Additional Pay Categories</legend>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-2">
          <div>
            <label class="block text-sm font-semibold">Staff Meeting ($/hr)</label>
            <input id="staffRate" type="number" step="0.01"
                   class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm" />
          </div>
          <div>
            <label class="block text-sm font-semibold">Training Pay ($/hr)</label>
            <input id="trainRate" type="number" step="0.01"
                   class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm" />
          </div>
          <div>
            <label class="block text-sm font-semibold">Vacation Hourly ($/hr)</label>
            <input id="vacRate" type="number" step="0.01"
                   class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm" />
          </div>
        </div>

        <!-- Overtime preview -->
        <p id="otPreview" class="text-xs text-jcMuted mt-3"></p>
      </fieldset>

      <!-- Financial Responsibilities (auto-shown for servers) -->
      <fieldset id="finRespWrap" class="border border-jcBorder rounded-lg p-4 hidden">
        <legend class="text-sm font-semibold px-1">Financial Responsibilities (FOH server roles)</legend>
        <label class="flex items-center gap-2 text-sm mt-1">
          <input type="checkbox" id="fin_tip_house" class="rounded border-jcBorder" checked />
          <span>Tip to House Pool</span>
        </label>
        <label class="flex items-center gap-2 text-sm mt-2">
          <input type="checkbox" id="fin_tip_merchant" class="rounded border-jcBorder" checked />
          <span>Tip back Merchant Services</span>
        </label>
      </fieldset>

      <!-- Benefits (choose plan) -->
      <fieldset class="border border-jcBorder rounded-lg p-4">
        <legend class="text-sm font-semibold px-1">Benefits (choose plan)</legend>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-2">
          <!-- Health -->
          <div>
            <label class="block text-sm font-semibold">Health Insurance</label>
            <select id="benef_health_plan" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
              <option value="">Select…</option>
              <option value="employer_50">Employer contribution 50% for Employee</option>
              <option value="not_offered">Not offered</option>
            </select>
            <label class="mt-2 flex items-center gap-2 text-sm">
              <input type="checkbox" id="benef_health_family" class="rounded border-jcBorder">
              <span>Family available at cost</span>
            </label>
          </div>

          <!-- Dental -->
          <div>
            <label class="block text-sm font-semibold">Dental Insurance</label>
            <select id="benef_dental_basic" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
              <option value="">Select…</option>
              <option value="employer_paid_basic">Employer Paid (basic)</option>
              <option value="not_offered">Not offered</option>
            </select>
            <label class="mt-2 flex items-center gap-2 text-sm">
              <input type="checkbox" id="benef_dental_buyup_50" class="rounded border-jcBorder">
              <span>Buy-Up: Employer contribution 50% for Employee</span>
            </label>
            <label class="mt-2 flex items-center gap-2 text-sm">
              <input type="checkbox" id="benef_dental_family" class="rounded border-jcBorder">
              <span>Family available at cost</span>
            </label>
          </div>

          <!-- Vision -->
          <div>
            <label class="block text-sm font-semibold">Vision Insurance</label>
            <select id="benef_vision_basic" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
              <option value="">Select…</option>
              <option value="employer_paid_basic">Employer Paid (basic)</option>
              <option value="not_offered">Not offered</option>
            </select>
            <label class="mt-2 flex items-center gap-2 text-sm">
              <input type="checkbox" id="benef_vision_family" class="rounded border-jcBorder">
              <span>Family available at cost</span>
            </label>
          </div>

          <!-- Life -->
          <div>
            <label class="block text-sm font-semibold">Life Insurance ($25,000)</label>
            <select id="benef_life" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
              <option value="">Select…</option>
              <option value="employer_paid">Employer Paid</option>
              <option value="not_offered">Not offered</option>
            </select>
          </div>
        </div>
      </fieldset>

      <!-- PTO -->
      <div>
        <label class="block text-sm font-semibold">PTO Tier</label>
        <select id="ptoTier" class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm">
          <option value="">Select…</option>
          <option value="8 mo – 4 years up to 40 hours">8 mo – 4 years up to 40 hours</option>
          <option value="4 years or more up to 48 hours">4 years or more up to 48 hours</option>
        </select>
      </div>

      <!-- Notes -->
      <div>
        <label class="block text-sm font-semibold">Benefit Notes (optional)</label>
        <textarea id="benefitNotes" rows="3"
                  class="mt-1 w-full border border-jcBorder rounded-lg p-2.5 text-sm"
                  placeholder="Any temporary benefit exceptions or clarifications..."></textarea>
      </div>

      <div class="pt-4 border-t border-jcBorder">
        <button id="generateBtn" type="submit"
                class="bg-jcGold text-jcInk font-semibold px-6 py-2 rounded-lg hover:brightness-95 transition">
          Generate Letter
        </button>
      </div>

      <p id="status" class="text-sm text-jcMuted"></p>
    </form>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

    // ---------- CONFIG ----------
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const EDGE_URL = `${SUPABASE_URL}/functions/v1/generate-compensation-letter`;

    const sb = createClient(SUPABASE_URL, SUPABASE_ANON);

    const employeeSelect = document.getElementById("employeeSelect");
    const compType = document.getElementById("compType");
    const effectiveDate = document.getElementById("effectiveDate");
    const salaryWrap = document.getElementById("salaryWrap");
    const salaryAmount = document.getElementById("salaryAmount");
    const positionsWrap = document.getElementById("positionsWrap");
    const positionsDiv = document.getElementById("positions");
    const addPosBtn = document.getElementById("addPos");
    const staffRate = document.getElementById("staffRate");
    const trainRate = document.getElementById("trainRate");
    const vacRate = document.getElementById("vacRate");
    const otPreview = document.getElementById("otPreview");
    const finWrap = document.getElementById("finRespWrap");
    const finTipHouse = document.getElementById("fin_tip_house");
    const finTipMerchant = document.getElementById("fin_tip_merchant");
    const ptoTier = document.getElementById("ptoTier");
    const benefitNotes = document.getElementById("benefitNotes");
    const statusMsg = document.getElementById("status");

    // Benefit controls
    const benef_health_plan   = document.getElementById("benef_health_plan");
    const benef_health_family = document.getElementById("benef_health_family");

    const benef_dental_basic  = document.getElementById("benef_dental_basic");
    const benef_dental_buyup  = document.getElementById("benef_dental_buyup_50");
    const benef_dental_family = document.getElementById("benef_dental_family");

    const benef_vision_basic  = document.getElementById("benef_vision_basic");
    const benef_vision_family = document.getElementById("benef_vision_family");

    const benef_life          = document.getElementById("benef_life");

    function money(n) { if (!n && n !== 0) return "$0.00"; return `$${(+n).toFixed(2)}`; }

    // ----- positions UI -----
    function addPositionRow(title = "", rate = "") {
      const row = document.createElement("div");
      row.className = "grid grid-cols-12 gap-3";
      row.innerHTML = `
        <input placeholder="Title" class="col-span-7 border border-jcBorder rounded-lg p-2.5 text-sm pos-title" value="${title}">
        <input type="number" step="0.01" placeholder="Rate ($/hr)" class="col-span-3 border border-jcBorder rounded-lg p-2.5 text-sm pos-rate" value="${rate}">
        <button type="button" class="col-span-2 px-3 py-2 rounded-md border border-red-200 text-red-600 text-sm hover:bg-red-50 remove-pos">Remove</button>
      `;
      positionsDiv.appendChild(row);

      row.querySelector(".remove-pos").addEventListener("click", () => {
        row.remove();
        updateServerToggles();
        previewOvertime();
      });
      row.querySelector(".pos-title").addEventListener("input", () => {
        updateServerToggles();
      });
      row.querySelector(".pos-rate").addEventListener("input", previewOvertime);
    }

    addPosBtn.addEventListener("click", () => addPositionRow());

    function getPositions() {
      const rows = [...document.querySelectorAll("#positions .grid")];
      const list = rows.map(r => {
        const t = r.querySelector(".pos-title").value.trim();
        const rate = parseFloat(r.querySelector(".pos-rate").value);
        return { title: t, rate: isFinite(rate) ? rate : null };
      }).filter(p => p.title);
      return list;
    }

    function updateServerToggles() {
      const list = getPositions();
      const isServer = list.some(p => (p.title || "").toLowerCase().includes("server"));
      finWrap.classList.toggle("hidden", !isServer);
      if (isServer) { finTipHouse.checked = true; finTipMerchant.checked = true; }
    }

    function previewOvertime() {
      const list = getPositions();
      if (compType.value !== "hourly" || list.length === 0) {
        otPreview.textContent = "";
        return;
      }
      const rates = [...new Set(list.map(p => +p.rate).filter(x => isFinite(x)))];
      if (rates.length === 1) {
        const ot = rates[0] * 1.5;
        otPreview.textContent = `Overtime preview: all positions share same wage. Base ${money(rates[0])} → OT ${money(ot)}.`;
      } else {
        otPreview.textContent = "Overtime preview: blended overtime applies. Toast POS will compute the weighted average rate per law.";
      }
    }

    // ----- type toggle -----
    compType.addEventListener("change", () => {
      const isSalary = compType.value === "salary";
      salaryWrap.classList.toggle("hidden", !isSalary);
      positionsWrap.classList.toggle("hidden", isSalary);
      previewOvertime();
    });

    // ----- load employees -----
    async function loadEmployees() {
      const { data, error } = await sb.from("hb_handbook_access")
        .select("id, full_name, employee_name, username, position, department, is_active")
        .eq("is_active", true)
        .order("full_name", { ascending: true });

      if (error) {
        employeeSelect.innerHTML = '<option value="">⚠️ Error loading employees</option>';
        console.error(error);
        return;
      }
      employeeSelect.innerHTML = '<option value="">Select employee…</option>';
      for (const e of data) {
        const label = (e.full_name || e.employee_name || e.username || "(unnamed)").trim();
        const opt = document.createElement("option");
        opt.value = e.id;
        opt.textContent = label;
        opt.dataset.department = e.department || "";
        employeeSelect.appendChild(opt);
      }
    }

    // default one row
    addPositionRow();

    // ----- form submit -----
    document.getElementById("f").addEventListener("submit", async (e) => {
      e.preventDefault();
      statusMsg.textContent = "Generating letter…";

      const employee_id = employeeSelect.value;
      const type = compType.value;
      const effective_date = effectiveDate.value || new Date().toISOString().slice(0,10);
      const positions = getPositions();

      if (!employee_id || !type || !effective_date) {
        statusMsg.textContent = "⚠️ Please select employee, type and effective date.";
        return;
      }
      if (type === "hourly" && positions.length === 0) {
        statusMsg.textContent = "⚠️ Please add at least one position for hourly employees.";
        return;
      }

      const benefits = {
        health: { plan: benef_health_plan.value || null, family_at_cost: !!benef_health_family.checked },
        dental: { basic: benef_dental_basic.value || null, buyup_50: !!benef_dental_buyup.checked, family_at_cost: !!benef_dental_family.checked },
        vision: { basic: benef_vision_basic.value || null, family_at_cost: !!benef_vision_family.checked },
        life: { plan: benef_life.value || null }
      };

      const financial_responsibilities = {
        tip_to_house_pool: !!finTipHouse.checked,
        tip_back_merchant_services: !!finTipMerchant.checked
      };

      const payload = {
        employee_id,
        type,
        effective_date,
        positions: type === "hourly" ? positions : [],
        salary_amount: type === "salary" ? parseFloat(salaryAmount.value) || null : null,
        staff_meeting_rate: parseFloat(staffRate.value) || null,
        training_rate: parseFloat(trainRate.value) || null,
        vacation_hourly_rate: parseFloat(vacRate.value) || null,
        pto_tier: ptoTier.value || null,
        benefit_notes: benefitNotes.value || null,
        benefits,
        financial_responsibilities
      };

      try {
        const resp = await fetch(EDGE_URL, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${SUPABASE_ANON}`,
            "apikey": SUPABASE_ANON
          },
          body: JSON.stringify(payload)
        });
        const result = await resp.json();
        if (!resp.ok) throw new Error(result?.error || `Edge Function Error: ${resp.status}`);

        if (result?.overtime_note) {
          otPreview.textContent = result.overtime_note;
        }
        statusMsg.innerHTML = `<a href="${result.url}" target="_blank" class="text-green-700 underline">✅ Letter generated — Open PDF</a>`;
        window.open(result.url, "_blank");
      } catch (err) {
        console.error(err);
        statusMsg.textContent = "❌ Unable to generate letter (Edge Function/CORS).";
      }
    });

    positionsDiv.addEventListener("input", previewOvertime);
    await loadEmployees();
  </script>
</body>
</html>
