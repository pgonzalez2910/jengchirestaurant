<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Inventory Intelligence Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            /* ── Jeng Chi Brand Palette — Muted Wine/Maroon (50% desaturated) ── */
            --primary-900: #160D0D;   /* near black warm */
            --primary-800: #271616;   /* very dark maroon */
            --primary-700: #3E2626;   /* dark wine — header/nav */
            --primary-600: #573636;   /* rich muted maroon */
            --primary-500: #6B4444;   /* main brand tone */
            --primary-400: #8A6060;   /* medium muted rose */
            --primary-300: #AA8888;   /* soft mauve */
            --primary-200: #D0B4B4;   /* light blush-grey */
            --primary-100: #EDE4E4;   /* barely-there warm grey */
            --primary-50:  #F7F2F2;   /* near white warm */
            
            /* Gold accent — from the • dots in the logo tagline */
            --accent-600: #9A6B00;
            --accent-500: #C48A00;
            --accent-400: #D4A017;
            --accent-300: #E8C060;
            
            --success-600: #15623A;
            --success-500: #1A8050;
            --warning-600: #6B4444;
            
            --neutral-950: #120A0A;
            --neutral-900: #221414;
            --neutral-800: #362020;
            --neutral-700: #503A3A;
            --neutral-600: #6E5555;
            --neutral-500: #907575;
            --neutral-400: #B09898;
            --neutral-300: #CFBEBE;
            --neutral-200: #E5DADA;
            --neutral-100: #F0EAEA;
            --neutral-50:  #F8F4F4;
            
            --font-display: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            
            --shadow-sm: 0 1px 2px rgba(90, 20, 20, 0.06);
            --shadow-md: 0 4px 6px -1px rgba(90, 20, 20, 0.1), 0 2px 4px -1px rgba(90, 20, 20, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(90, 20, 20, 0.1), 0 4px 6px -2px rgba(90, 20, 20, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(90, 20, 20, 0.15), 0 10px 10px -5px rgba(90, 20, 20, 0.06);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-display);
            background: linear-gradient(135deg, #F7F4F2 0%, #EFE9E9 100%);
            color: var(--neutral-800);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-header {
            background: #ffffff;
            color: var(--neutral-900);
            padding: 0;
            box-shadow: 0 2px 12px rgba(0,0,0,0.10);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-400);
        }
        
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: stretch;
            min-height: 116px;
        }
        
        .header-logo-band {
            display: flex;
            align-items: center;
            background: transparent;
            padding: 0.35rem 1.5rem 0.35rem 1.25rem;
            border-right: 1px solid rgba(0,0,0,0.08);
            border-bottom-right-radius: 0;
            gap: 1rem;
            min-width: 220px;
        }
        .header-logo-band img {
            height: 116px;
            width: auto;
            object-fit: contain;
        }
        .header-right {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1.75rem;
        }
        
        .app-title h1 {
            font-size: 1.75rem;
            font-weight: 800;
            letter-spacing: -0.02em;
            color: var(--neutral-900);
        }
        
        .app-title .subtitle {
            font-size: 1.05rem;
            color: var(--neutral-500);
            font-weight: 400;
            margin-top: 0.2rem;
            font-family: var(--font-mono);
            letter-spacing: 0.02em;
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: rgba(62,38,38,0.06);
            border: 1px solid rgba(62,38,38,0.12);
            border-radius: 8px;
            color: var(--neutral-700);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        /* ── CORPORATE NAV ── */
        .corp-nav {
            background: linear-gradient(135deg, #160D0D 0%, #3E2626 60%, #573636 100%);
            border-radius: 12px;
            box-shadow: var(--shadow-xl);
            margin-bottom: 2rem;
            border-bottom: 3px solid var(--accent-400);
            position: relative;
        }
        .corp-nav-bar {
            display: flex;
            align-items: stretch;
            gap: 0;
            padding: 0 0.5rem;
        }
        .corp-nav-group {
            position: relative;
        }
        .corp-nav-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 1.25rem;
            background: transparent;
            border: none;
            color: rgba(255,255,255,0.82);
            font-family: var(--font-display);
            font-size: 1.14rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            white-space: nowrap;
            letter-spacing: 0.025em;
            border-bottom: 3px solid transparent;
        }
        .corp-nav-btn:hover, .corp-nav-btn.group-active {
            color: white;
            background: rgba(255,255,255,0.08);
            border-bottom-color: var(--accent-500);
        }
        .corp-nav-btn .chevron {
            font-size: 0.625rem;
            opacity: 0.7;
            transition: transform var(--transition-fast);
        }
        .corp-nav-group:hover .chevron {
            transform: rotate(180deg);
        }
        .corp-nav-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 2px);
            left: 0;
            min-width: 220px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.18), 0 8px 16px rgba(0,0,0,0.1);
            border: 1px solid var(--neutral-200);
            z-index: 999;
            overflow: hidden;
            animation: dropIn 120ms ease;
        }
        @keyframes dropIn {
            from { opacity: 0; transform: translateY(-6px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .corp-nav-group:hover .corp-nav-dropdown {
            display: block;
        }
        .corp-nav-dropdown-header {
            padding: 0.625rem 1rem 0.375rem;
            font-size: 0.6875rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.08em;
            color: var(--primary-400);
            border-bottom: 1px solid var(--neutral-100);
            background: var(--primary-50);
        }
        .nav-tab {
            display: flex;
            align-items: center;
            gap: 0.625rem;
            width: 100%;
            padding: 0.75rem 1rem;
            background: transparent;
            border: none;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--neutral-700);
            transition: all var(--transition-fast);
            text-align: left;
            white-space: nowrap;
        }
        .nav-tab:hover {
            background: var(--primary-50);
            color: var(--primary-600);
            padding-left: 1.25rem;
        }
        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-500) 100%);
            color: white;
            font-weight: 600;
        }
        .nav-tab.active:hover {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-500) 100%);
            color: white;
            padding-left: 1rem;
        }
        .corp-nav-active-indicator {
            padding: 0.5rem 1.25rem;
            font-size: 0.75rem;
            color: rgba(255,255,255,0.6);
            font-family: var(--font-mono);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-top: 1px solid rgba(255,255,255,0.08);
        }
        .corp-nav-active-indicator span {
            color: var(--accent-400);
            font-weight: 600;
        }
        /* legacy compat */
        .nav-tabs { display: none; }
        
        .content-section {
            display: none;
            animation: fadeIn var(--transition-slow);
        }
        
        .content-section.active {
            display: block;
            opacity: 1 !important; /* Force opacity to 1 */
            min-height: 200px !important; /* Prevent collapse to 0 height */
        }
        
        /* CRITICAL FIX: Force Office Orders to display properly ONLY when active */
        #officeOrders.active {
            min-height: 500px !important;
            height: auto !important;
            max-height: none !important;
            overflow-y: auto !important;
            display: block !important;
            padding: 20px !important;
            background: white !important;
            width: 100% !important;
            box-sizing: border-box !important;
        }
        
        #officeOrders * {
            box-sizing: border-box !important;
        }
        
        #officeOrders.active .data-table-container {
            overflow: visible !important;
            min-height: 300px !important;
            height: auto !important;
            display: block !important;
            padding: 15px !important;
            width: 100% !important;
        }
        
        #officeOrders.active .search-filter-bar {
            display: flex !important;
            min-height: 80px !important;
            height: auto !important;
            padding: 15px !important;
            width: 100% !important;
            flex-wrap: wrap !important;
        }
        
        #officeOrders.active table {
            width: 100% !important;
            display: table !important;
            min-height: 100px !important;
            table-layout: auto !important;
        }
        
        #officeOrders.active tbody {
            display: table-row-group !important;
        }
        
        #officeOrders.active tr {
            display: table-row !important;
        }
        
        #officeOrders.active td, #officeOrders.active th {
            display: table-cell !important;
            padding: 8px !important;
        }
        
        /* CRITICAL: Ensure loading overlay doesn't interfere */
        .loading-overlay:not(.active) {
            display: none !important;
            pointer-events: none !important;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-filter-bar {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-group {
            flex: 1;
            min-width: 300px;
        }
        
        .search-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            transition: all var(--transition-base);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(139, 32, 32, 0.12);
        }
        
        .filter-group {
            min-width: 200px;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-700);
            border: 2px solid var(--primary-700);
        }
        
        .btn-secondary:hover {
            background: var(--primary-700);
            color: white;
        }
        
        .btn-success {
            background: var(--success-600);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-500);
        }
        
        .btn-danger {
            background: var(--warning-600);
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
        }
        
        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .table-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-50) 100%);
            border-bottom: 2px solid var(--neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table thead {
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--neutral-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--neutral-300);
            cursor: pointer;
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table tbody tr {
            transition: all var(--transition-fast);
        }
        
        .data-table tbody tr:hover {
            background: var(--primary-100);
        }
        
        .data-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            font-size: 0.9375rem;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .vendor-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--neutral-200);
            color: var(--neutral-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        
        .price-cell {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--primary-700);
            font-size: 1rem;
        }
        
        .item-number {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
        
        .assignment-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-200);
            color: var(--primary-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-right: 0.25rem;
            position: relative;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .assignment-badge:hover {
            background: var(--primary-300);
            padding-right: 1.75rem;
        }
        
        .assignment-badge:hover::after {
            content: '×';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-800);
        }
        
        .assignment-select {
            padding: 0.5rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .assignment-select:hover {
            border-color: var(--primary-500);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-600);
            transition: all var(--transition-base);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .metric-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-900);
            font-family: var(--font-mono);
        }
        
        .metric-subtitle {
            font-size: 0.8125rem;
            color: var(--neutral-500);
            margin-top: 0.5rem;
        }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }
        
        .chart-container h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 450px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--neutral-50);
            border-radius: 12px;
        }
        
        .comparison-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--success-600);
        }
        
        .comparison-card.highest {
            border-left-color: var(--warning-600);
        }
        
        .comparison-card.lowest {
            border-left-color: var(--success-600);
        }
        
        .comparison-card.average {
            border-left-color: var(--primary-600);
        }
        
        .comparison-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .comparison-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            margin-bottom: 0.5rem;
        }
        
        .comparison-vendor {
            font-size: 0.9375rem;
            color: var(--neutral-700);
            font-weight: 600;
        }
        
        .comparison-date {
            font-size: 0.8125rem;
            color: var(--neutral-500);
        }
        
       .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 2000;
}
       .modal-overlay.active {
    display: block;
}
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    border-radius: 0;
    box-shadow: none;
    overflow-y: auto;
    margin: 0;
    padding: 0;
}
        
        .modal-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--neutral-200);
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-600);
            border-left: 4px solid var(--success-600);
        }
        
        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--warning-600);
            border-left: 4px solid var(--warning-600);
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--neutral-200);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--neutral-500);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .vendor-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--neutral-200);
        }

        .month-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .month-chip {
            padding: 0.5rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .month-chip:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .month-chip.selected {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .vendor-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border-left: 6px solid var(--primary-600);
        }

        .vendor-card-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--neutral-200);
        }

        .vendor-card-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .vendor-monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .vendor-month-card {
            background: var(--neutral-50);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--neutral-200);
            text-align: center;
            transition: all var(--transition-base);
        }

        .vendor-month-card:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: translateY(-2px);
        }

        .vendor-month-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .vendor-month-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-700);
            font-family: var(--font-mono);
        }

        .vendor-total-card {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .vendor-total-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vendor-total-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        /* VSA Period Buttons */
        .vsa-period-btn {
            display: flex;
            align-items: center;
            gap: 0.375rem;
            padding: 0.5rem 1rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            color: rgba(255,255,255,0.65);
            font-family: var(--font-display);
            font-size: 0.8125rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
        }
        .vsa-period-btn:hover { background: rgba(255,255,255,0.1); color: white; }
        .vsa-period-btn.active { background: var(--accent-500); color: var(--primary-900); }

        /* VSA Charts side by side */
        .vsa-charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-top: 1.5rem;
        }
        @media (max-width: 900px) { .vsa-charts-row { grid-template-columns: 1fr; } }

        /* All-vendors combo chart */
        .vsa-combo-section {
            background: white;
            border-radius: 12px;
            padding: 1.75rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 1.5rem;
            border-top: 4px solid var(--accent-500);
        }

        .invoice-product-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .invoice-product-item:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .invoice-product-item.selected {
            border-color: var(--success-600);
            background: rgba(16, 185, 129, 0.1);
        }

        .selected-product-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--success-600);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .selected-product-card img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .editable-field {
            padding: 0.5rem;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            background: white;
            font-family: var(--font-display);
            transition: all var(--transition-base);
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }

        input[type="number"].editable-field {
            -moz-appearance: textfield;
        }

        input[type="number"].editable-field::-webkit-outer-spin-button,
        input[type="number"].editable-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }


        /* Place Order Tab Styles */
.order-content-section {
    display: none;
}

.order-content-section.active {
    display: block;
}

.order-sub-tab:hover {
    background: var(--neutral-100) !important;
    color: var(--primary-700) !important;
}

.order-sub-tab.active {
    background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%) !important;
    color: white !important;
}
/* Executive Card Styles (from placeorder.html) */
.order-card {
    background: white;
    border: 1px solid var(--neutral-200);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.order-card-poster {
    height: 120px;
    border: 1px solid var(--neutral-200);
    border-radius: 10px;
    background: linear-gradient(180deg, #f9fafb, #f1f5f9);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 1rem;
}

.order-card-poster img {
    height: 100%;
    width: auto;
    object-fit: contain;
}

.order-kpi {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin: 1rem 0;
}

.order-kbox {
    border: 1px solid var(--neutral-200);
    border-radius: 8px;
    padding: 0.75rem;
    background: var(--neutral-50);
}

.order-kbox-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--neutral-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.order-kbox-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--neutral-900);
    font-family: var(--font-mono);
}

.order-recommendation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 999px;
    color: white;
    font-weight: 700;
    font-size: 0.875rem;
    margin-top: 1rem;
}

.order-recommendation.green {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
}

.order-recommendation.black {
    background: linear-gradient(135deg, #171717 0%, #262626 100%);
}

.order-recommendation-dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3) inset;
}

/* Enhanced Place Order Styles */
.enhanced-order-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-lg);
    border: 3px solid var(--neutral-300);
    transition: all 0.3s;
}

.enhanced-order-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-500);
}

.price-comparison-table {
    width: 100%;
    font-size: 0.875rem;
    border-collapse: collapse;
}

.price-comparison-table th {
    background: var(--neutral-100);
    padding: 0.5rem;
    font-weight: 700;
    text-align: left;
    border-bottom: 2px solid var(--neutral-300);
}

.price-comparison-table td {
    padding: 0.5rem;
    border-bottom: 1px solid var(--neutral-200);
}

.best-price {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-600);
    font-weight: 700;
}

.stock-delta-positive {
    color: var(--success-600);
    font-weight: 700;
}

.stock-delta-negative {
    color: var(--warning-600);
    font-weight: 700;
}

.vendor-option-card {
    padding: 0.75rem;
    border: 2px solid var(--neutral-300);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.vendor-option-card:hover {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.vendor-option-card.selected {
    border-color: var(--success-600);
    background: rgba(16, 185, 129, 0.1);
}


/* ========== ENHANCED PLACE ORDER CARD STYLES ========== */

/* Editable PAR input styling */
input[id^="par-input-"]:hover {
    background: rgba(255, 255, 255, 0.2) !important;
}

input[id^="par-input-"]:focus {
    background: rgba(255, 255, 255, 0.3) !important;
    outline: 2px solid white !important;
}

/* Assignment button styling */
.btn.assignment-btn {
    transition: all 0.2s ease;
}

.btn.assignment-btn:hover {
    transform: translateY(-2px);
}

/* Delete button enhanced hover */
.btn-danger:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

/* Vendor option row hover effect */
.vendor-option-row {
    transition: all 0.2s ease;
}

.vendor-option-row:hover {
    background: var(--primary-50) !important;
    transform: translateX(4px);
}

.vendor-option-row.selected {
    background: rgba(16, 185, 129, 0.1) !important;
    border-left: 4px solid var(--success-600);
}

/* Enhanced order card hover */
.enhanced-order-card {
    transition: all 0.3s ease;
}

.enhanced-order-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-500);
}

/* ========== COMPACT PLACE ORDER CARDS ========== */
.enhanced-order-card {
    background: white;
    border-radius: 8px;
    padding: 0.75rem;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--neutral-300);
    transition: all 0.3s;
    font-size: 0.75rem; /* Reduce base font size */
}

.enhanced-order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-500);
}

/* Compact product images */
.enhanced-order-card img {
    max-width: 60px !important;
    height: 60px !important;
}

/* Compact metrics */
.compact-metric {
    padding: 0.5rem;
    border-radius: 6px;
    text-align: center;
}

.compact-metric-label {
    font-size: 0.6rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.compact-metric-value {
    font-size: 1.25rem;
    font-weight: 700;
    font-family: var(--font-mono);
}

/* Compact price comparison */
.compact-price-box {
    padding: 0.5rem;
    border-radius: 6px;
}

.compact-price-label {
    font-size: 0.55rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.compact-price-value {
    font-size: 0.95rem;
    font-weight: 700;
    font-family: var(--font-mono);
}

.compact-price-vendor {
    font-size: 0.65rem;
    margin-top: 0.25rem;
}

/* Compact vendor price table */
.compact-price-table {
    font-size: 0.7rem;
}

.compact-price-table th {
    padding: 0.35rem;
    font-size: 0.65rem;
}

.compact-price-table td {
    padding: 0.35rem;
    font-size: 0.7rem;
}

/* Compact form elements */
.enhanced-order-card .search-input,
.enhanced-order-card select,
.enhanced-order-card input {
    padding: 0.4rem 0.6rem;
    font-size: 0.8rem;
}

/* Compact buttons */
.enhanced-order-card .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.75rem;
}

/* ========== MOBILE RESPONSIVE STYLES FOR JULIO'S ORDERS ========== */

/* Tablet (landscape) */
@media (max-width: 1024px) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
        gap: 1.25rem !important;
        padding: 1.5rem !important;
    }
    
    .julio-corporate-card img {
        width: 100px !important;
        height: 100px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 1rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.25rem !important;
        padding: 0.75rem !important;
    }
}

/* Tablet (portrait) and large phones */
@media (max-width: 768px) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
        gap: 1rem !important;
        padding: 1rem !important;
    }
    
    .julio-corporate-card {
        border-radius: 10px !important;
    }
    
    .julio-corporate-card img {
        width: 90px !important;
        height: 90px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.9375rem !important;
        min-height: 2.2rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.125rem !important;
        padding: 0.625rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.75rem !important;
        font-size: 0.875rem !important;
    }
    
    /* Stack search bar and buttons vertically */
    .search-filter-bar {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    .search-group, .filter-group {
        min-width: 100% !important;
    }
}

/* Mobile phones */
@media (max-width: 480px) {
    #julioProductGrid {
        grid-template-columns: 1fr !important; /* Single column on mobile */
        gap: 1rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card {
        max-width: 100% !important;
    }
    
    .julio-corporate-card img {
        width: 80px !important;
        height: 80px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.875rem !important;
        min-height: auto !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1rem !important;
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card label {
        font-size: 0.75rem !important;
    }
    
    /* Mobile header adjustments */
    .table-header h2 {
        font-size: 1.125rem !important;
    }
    
    /* Mobile buttons */
    .btn {
        padding: 0.75rem 1rem !important;
        font-size: 0.8125rem !important;
    }
    
    /* Progress bar on mobile */
    #julioProgress {
        height: 6px !important;
    }
}

/* iPhone SE / Very small phones */
@media (max-width: 375px) {
    #julioProductGrid {
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card {
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card img {
        width: 70px !important;
        height: 70px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.8125rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 0.9375rem !important;
    }
}

/* Landscape mode for phones */
@media (max-width: 812px) and (orientation: landscape) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) !important;
    }
}


/* ========== ENHANCED RESPONSIVE DESIGN FOR ALL DEVICES ========== */

/* Large Desktop (1920px+) - Default styles work fine */

/* Standard Desktop & Laptop (1024px - 1919px) */
@media (max-width: 1919px) {
    .container {
        max-width: 1400px;
    }
    
    .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

/* Tablet Landscape (768px - 1023px) */
@media (max-width: 1023px) {
    .container {
        padding: 1.5rem;
    }
    
    .app-header {
        padding: 1.25rem 1.5rem;
    }
    
    .app-title h1 {
        font-size: 1.5rem;
    }
    
    .nav-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .nav-tab {
        min-width: 120px;
        font-size: 0.875rem;
        padding: 0.875rem 1.25rem;
    }
    
    .search-filter-bar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-group,
    .filter-group {
        min-width: 100%;
    }
    
    .data-table {
        font-size: 0.875rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
    }
    
    /* Julio's Orders - Tablet */
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
        gap: 1.5rem !important;
        padding: 1.5rem !important;
    }
    
    .julio-corporate-card img {
        width: 110px !important;
        height: 110px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 1.0625rem !important;
    }
    
    /* Rony's Orders - Tablet */
    #ronyProductContainer .vendor-card {
        padding: 1.25rem;
    }
    
    /* Place Order - Tablet */
    .enhanced-order-card {
        font-size: 0.8125rem;
    }
}

/* Tablet Portrait & Large Phones (481px - 767px) */
@media (max-width: 767px) {
    .container {
        padding: 1rem;
    }
    
    .app-header {
        padding: 1rem;
    }
    
    .app-title h1 {
        font-size: 1.25rem;
    }
    
    .app-title .subtitle {
        font-size: 0.75rem;
    }
    
    .status-indicator {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .nav-tabs {
        padding: 0.375rem;
        gap: 0.375rem;
    }
    
    .nav-tab {
        min-width: 100px;
        font-size: 0.8125rem;
        padding: 0.75rem 1rem;
    }
    
    .table-header h2 {
        font-size: 1.125rem;
    }
    
    .btn {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
    }
    
    /* Julio's Orders - Tablet Portrait */
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)) !important;
        gap: 1.25rem !important;
        padding: 1.25rem !important;
    }
    
    .julio-corporate-card {
        border-radius: 10px !important;
    }
    
    .julio-corporate-card img {
        width: 100px !important;
        height: 100px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.9375rem !important;
        min-height: 2.5rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.25rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.75rem !important;
        font-size: 0.875rem !important;
    }
    
    /* Rony's Orders - Tablet Portrait */
    #ronyProductContainer > div {
        padding: 1rem;
    }
    
    #ronyProductContainer h2 {
        font-size: 1.125rem;
    }
    
    /* Metric Cards */
    .metric-card {
        padding: 1.25rem;
    }
    
    .metric-value {
        font-size: 1.75rem;
    }
    
    /* Modal adjustments */
    .modal-body {
        padding: 1.5rem;
    }
}

/* Mobile Phones (320px - 480px) */
@media (max-width: 480px) {
    body {
        font-size: 14px;
    }
    
    .container {
        padding: 0.75rem;
    }
    
    .app-header {
        padding: 0.75rem;
    }
    
    .header-content {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
    }
    
    .app-title h1 {
        font-size: 1.125rem;
    }
    
    .app-title .subtitle {
        font-size: 0.6875rem;
    }
    
    .status-indicator {
        padding: 0.375rem 0.625rem;
        font-size: 0.6875rem;
    }
    
    .nav-tabs {
        flex-direction: column;
        padding: 0.5rem;
    }
    
    .nav-tab {
        width: 100%;
        min-width: auto;
        text-align: center;
        font-size: 0.875rem;
        padding: 0.75rem;
    }
    
    .search-filter-bar {
        padding: 1rem;
    }
    
    .table-header {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
    }
    
    .table-header h2 {
        font-size: 1rem;
    }
    
    .table-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    .btn {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
    }
    
    /* Julio's Orders - Mobile */
    #julioProductGrid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card {
        max-width: 100% !important;
        border-radius: 8px !important;
    }
    
    .julio-corporate-card > div:first-child {
        padding: 1.25rem !important;
    }
    
    .julio-corporate-card img {
        width: 90px !important;
        height: 90px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.875rem !important;
        min-height: auto !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.125rem !important;
        padding: 0.625rem !important;
    }
    
    .julio-corporate-card label {
        font-size: 0.75rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.625rem !important;
        font-size: 0.8125rem !important;
    }
    
    /* Julio Progress Bar */
    #julioProgress {
        height: 6px !important;
    }
    
    /* Rony's Orders - Mobile */
    #ronyProductContainer > div {
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    #ronyProductContainer h2 {
        font-size: 1rem;
    }
    
    #ronyProductContainer > div > div:last-child {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
    }
    
    /* Place Order - Mobile */
    .enhanced-order-card {
        margin-bottom: 1rem;
    }
    
    .enhanced-order-card img {
        max-width: 80px !important;
        height: 80px !important;
    }
    
    /* Metric Cards - Mobile */
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .metric-card {
        padding: 1rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
    
    /* Chart Containers */
    .chart-wrapper {
        height: 300px;
    }
    
    /* Modal - Mobile */
    .modal {
        border-radius: 0;
    }
    
    .modal-header {
        padding: 1.25rem;
    }
    
    .modal-header h2 {
        font-size: 1.125rem;
    }
    
    .modal-body {
        padding: 1.25rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Data Tables - Mobile */
    .data-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .data-table {
        min-width: 600px;
    }
}

/* Small Mobile (iPhone SE, older devices) */
@media (max-width: 375px) {
    .app-title h1 {
        font-size: 1rem;
    }
    
    #julioProductGrid {
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card {
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card img {
        width: 80px !important;
        height: 80px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.8125rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1rem !important;
        padding: 0.5rem !important;
    }
}

/* Landscape Mode for Phones */
@media (max-width: 896px) and (orientation: landscape) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
    }
    
    #ronyProductContainer > div > div:last-child {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
    }
    
    .modal {
        max-height: 100vh;
        overflow-y: auto;
    }
}

/* iPad specific adjustments */
@media only screen 
  and (min-device-width: 768px) 
  and (max-device-width: 1024px) 
  and (-webkit-min-device-pixel-ratio: 2) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    }
}

/* Improve touch targets for mobile */
@media (hover: none) and (pointer: coarse) {
    .btn,
    .nav-tab,
    .search-input,
    button {
        min-height: 44px; /* Apple's recommended touch target size */
    }
    
    .checkbox-label input[type="checkbox"] {
        width: 24px;
        height: 24px;
    }
}




        /* Stock Alerts Styles */
        .badge-count {
            background: var(--error-600);
            color: white;
            border-radius: 12px;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }
        .filter-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .filter-chip {
            padding: 0.5rem 1rem;
            border: 2px solid var(--neutral-300);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-chip.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }
        .filter-chip:hover:not(.active) {
            border-color: var(--primary-400);
            background: var(--primary-50);
        }
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.2s;
        }
        .alert-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .alert-card.critical {
            border-left: 6px solid var(--error-600);
            animation: pulse-border 2s infinite;
        }
        .alert-card.warning {
            border-left: 6px solid #f59e0b;
        }
        .alert-card.watch {
            border-left: 6px solid #eab308;
        }
        .alert-card.declining {
            border-left: 6px solid #8b5cf6;
        }
        @keyframes pulse-border {
            0%, 100% { border-left-color: var(--error-600); }
            50% { border-left-color: #ef4444; }
        }
        .alert-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .alert-status.critical {
            background: #fee2e2;
            color: #991b1b;
        }
        .alert-status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .alert-status.watch {
            background: #fef9c3;
            color: #854d0e;
        }
        .alert-status.declining {
            background: #ede9fe;
            color: #6b21a8;
        }

        /* ── STOCK ALERT SECTION STYLES ── */
        .alert-section {
            margin-bottom: 2rem;
        }
        .alert-section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.875rem 1.25rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            font-weight: 700;
            font-size: 1rem;
            letter-spacing: 0.01em;
        }
        .alert-section-header.rony {
            background: rgba(62, 38, 38, 0.07);
            color: var(--primary-700);
            border: 1px solid rgba(62, 38, 38, 0.14);
            border-left: 4px solid var(--primary-400);
        }
        .alert-section-header.julio {
            background: rgba(20, 83, 45, 0.06);
            color: #155724;
            border: 1px solid rgba(20, 83, 45, 0.14);
            border-left: 4px solid #22c55e;
        }
        .alert-category-block {
            margin-bottom: 1.25rem;
        }
        .alert-category-label {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8125rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.07em;
            color: var(--neutral-500);
            padding: 0.25rem 0.75rem 0.25rem 0;
            margin-bottom: 0.625rem;
            border-bottom: 2px solid var(--neutral-200);
            width: 100%;
        }
        .alert-category-grid {
            display: grid;
            gap: 0.75rem;
        }
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 1.25rem 1.5rem;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 1.25rem;
            align-items: center;
            transition: all 0.2s;
        }
        .alert-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .alert-card.critical { border-left: 5px solid #dc2626; animation: pulse-border 2s infinite; }
        .alert-card.warning  { border-left: 5px solid #f59e0b; }
        .alert-card.watch    { border-left: 5px solid #eab308; }
        .alert-card.declining{ border-left: 5px solid #8b5cf6; }
        .alert-card.ok       { border-left: 5px solid #16a34a; opacity: 0.85; }
        .stock-stat-card {
            background: white;
            border-radius: 10px;
            padding: 1rem 1.25rem;
            box-shadow: var(--shadow-md);
            text-align: center;
        }
        .stock-stat-label { font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.07em; color: var(--neutral-500); margin-bottom: 0.25rem; }
        .stock-stat-value { font-size: 1.75rem; font-weight: 700; font-family: var(--font-mono); }
        .case-unit-badge {
            display: inline-flex; align-items: center; gap: 0.375rem;
            background: var(--primary-100); color: var(--primary-700);
            border-radius: 6px; padding: 0.2rem 0.5rem;
            font-size: 0.75rem; font-weight: 700; font-family: var(--font-mono);
            margin-top: 0.25rem;
        }

        /* ── STOCK ALERT BELL DROPDOWN ── */
        .alert-bell-btn {
            position: relative;
            background: rgba(255,255,255,0.12);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            border-radius: 10px;
            width: 46px;
            height: 46px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.125rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        .alert-bell-btn:hover {
            background: rgba(255,255,255,0.22);
            transform: scale(1.05);
        }
        .alert-bell-btn .bell-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #dc2626;
            color: white;
            font-size: 0.625rem;
            font-weight: 800;
            min-width: 18px;
            height: 18px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 4px;
            border: 2px solid #3E2626;
            font-family: var(--font-mono);
        }
        .alert-dropdown-panel {
            display: none;
            position: fixed;
            top: 76px;
            right: 1.5rem;
            width: 420px;
            max-height: 540px;
            background: white;
            border-radius: 14px;
            box-shadow: 0 24px 48px rgba(22,13,13,0.22), 0 8px 20px rgba(22,13,13,0.12);
            border: 1px solid var(--neutral-200);
            z-index: 1500;
            overflow: hidden;
            animation: dropIn 150ms ease;
        }
        .alert-dropdown-panel.open { display: flex; flex-direction: column; }
        .alert-dp-header {
            background: linear-gradient(135deg, #160D0D 0%, #3E2626 100%);
            color: white;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 3px solid var(--accent-400);
            flex-shrink: 0;
        }
        .alert-dp-header h3 {
            font-size: 0.9375rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        .alert-dp-close {
            background: rgba(255,255,255,0.15);
            border: none;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .alert-dp-close:hover { background: rgba(255,255,255,0.28); }
        .alert-dp-filters {
            background: var(--neutral-50);
            padding: 0.625rem 1rem;
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
            border-bottom: 1px solid var(--neutral-200);
        }
        .alert-dp-filter-btn {
            padding: 0.3rem 0.75rem;
            border-radius: 20px;
            border: 1.5px solid var(--neutral-300);
            background: white;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.15s;
            color: var(--neutral-600);
        }
        .alert-dp-filter-btn.active { background: var(--primary-700); color: white; border-color: var(--primary-700); }
        .alert-dp-filter-btn.critical.active { background: #dc2626; border-color: #dc2626; }
        .alert-dp-filter-btn.warning.active  { background: #d97706; border-color: #d97706; }
        .alert-dp-filter-btn.watch.active    { background: #ca8a04; border-color: #ca8a04; }
        .alert-dp-list {
            overflow-y: auto;
            flex: 1;
            padding: 0.5rem;
        }
        .alert-dp-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.625rem 0.875rem;
            border-radius: 8px;
            margin-bottom: 0.375rem;
            transition: background 0.15s;
            border-left: 4px solid transparent;
        }
        .alert-dp-item:hover { background: var(--neutral-50); }
        .alert-dp-item.critical { border-left-color: #dc2626; background: #fef2f2; }
        .alert-dp-item.warning  { border-left-color: #f59e0b; background: #fffbeb; }
        .alert-dp-item.watch    { border-left-color: #eab308; background: #fefce8; }
        .alert-dp-item.declining{ border-left-color: #8b5cf6; background: #faf5ff; }
        .alert-dp-item:hover.critical  { background: #fee2e2; }
        .alert-dp-item:hover.warning   { background: #fef3c7; }
        .alert-dp-img {
            width: 36px;
            height: 36px;
            border-radius: 6px;
            object-fit: cover;
            flex-shrink: 0;
            background: var(--neutral-100);
        }
        .alert-dp-name {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-900);
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .alert-dp-badge {
            font-size: 0.625rem;
            font-weight: 800;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            flex-shrink: 0;
        }
        .alert-dp-badge.critical { background: #dc2626; color: white; }
        .alert-dp-badge.warning  { background: #f59e0b; color: white; }
        .alert-dp-badge.watch    { background: #eab308; color: white; }
        .alert-dp-badge.declining{ background: #8b5cf6; color: white; }
        .alert-dp-footer {
            padding: 0.75rem 1rem;
            border-top: 1px solid var(--neutral-200);
            background: var(--neutral-50);
            font-size: 0.75rem;
            color: var(--neutral-500);
            text-align: center;
            flex-shrink: 0;
        }
        .alert-dp-empty {
            text-align: center;
            padding: 2.5rem 1rem;
            color: var(--neutral-400);
        }
        .alert-dp-empty .big-icon { font-size: 2.5rem; margin-bottom: 0.5rem; }
    </style>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="app-header">
        <div class="header-content">
            <!-- Logo band — white strip on left -->
            <div class="header-logo-band">
                <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
                     alt="Jeng Chi"
                     onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">
                <!-- Fallback text logo if image fails -->
                <div style="display:none; flex-direction:column; line-height:1.1;">
                    <span style="font-size:1.25rem; font-weight:800; color:#3E2626; letter-spacing:-0.02em;">JENG CHI</span>
                    <span style="font-size:0.625rem; color:#9A7070; letter-spacing:0.12em; text-transform:uppercase;">Food · Drink · Dessert</span>
                </div>
            </div>
            <!-- Right side — title + status -->
            <div class="header-right">
                <div class="app-title">
                    <div>
                        <h1>Inventory Intelligence Platform</h1>
                        <div class="subtitle">Multi-Vendor Product Management &amp; Analytics</div>
                    </div>
                </div>
                <div class="status-indicator">
                    <div class="status-dot"></div>
                    <span>System Online</span>
                </div>
                <!-- 🔔 Stock Alert Bell -->
                <button class="alert-bell-btn" id="alertBellBtn" onclick="toggleAlertDropdown()" title="Stock Alerts">
                    <i class="fas fa-bell"></i>
                    <span class="bell-badge" id="bellBadge" style="display:none;">0</span>
                </button>
            </div>
        </div>
    </header>

    <!-- Stock Alert Dropdown Panel -->
    <div class="alert-dropdown-panel" id="alertDropdownPanel">
        <div class="alert-dp-header">
            <h3><i class="fas fa-triangle-exclamation" style="color:#fca5a5;"></i> Stock Alerts</h3>
            <button class="alert-dp-close" onclick="toggleAlertDropdown()">×</button>
        </div>
        <div class="alert-dp-filters" id="alertDpFilters">
            <button class="alert-dp-filter-btn active" onclick="filterDropdownAlerts('all',this)">All</button>
            <button class="alert-dp-filter-btn critical" onclick="filterDropdownAlerts('critical',this)">🔴 Critical</button>
            <button class="alert-dp-filter-btn warning" onclick="filterDropdownAlerts('warning',this)">🟠 Warning</button>
            <button class="alert-dp-filter-btn watch" onclick="filterDropdownAlerts('watch',this)">🟡 Watch</button>
        </div>
        <div class="alert-dp-list" id="alertDpList">
            <div class="alert-dp-empty"><div class="big-icon">🔔</div><div>Loading alerts…</div></div>
        </div>
        <div class="alert-dp-footer" id="alertDpFooter">Auto-updates when invoices are saved</div>
    </div>

    <div class="container">
        <div id="alertContainer"></div>
<!-- hidden legacy nav for JS compat -->
<div class="nav-tabs" style="display:none;">
    <button class="nav-tab active" id="legacyTab_inventory" onclick="switchTab('inventory', event)">Inventory View</button>
    <button class="nav-tab" id="legacyTab_quickEdit" onclick="switchTab('quickEdit', event)">Quick Edit</button>
    <button class="nav-tab" id="legacyTab_analytics" onclick="switchTab('analytics', event)">Analytics & Insights</button>
    <button class="nav-tab" id="legacyTab_vendorSpending" onclick="switchTab('vendorSpending', event)">Vendor Spending</button>
    <button class="nav-tab" id="legacyTab_invoices" onclick="switchTab('invoices', event)">Invoice Tracking</button>
    <button class="nav-tab" id="legacyTab_vendors" onclick="switchTab('vendors', event)">Vendor Management</button>
    <button class="nav-tab" id="legacyTab_julioOrders" onclick="switchTab('julioOrders', event)">Julio's Orders</button>
    <button class="nav-tab" id="legacyTab_ronyOrders" onclick="switchTab('ronyOrders', event)">Rony's Orders</button>
    <button class="nav-tab" id="legacyTab_officeOrders" onclick="switchTab('officeOrders', event)">Office Orders</button>
    <button class="nav-tab" id="legacyTab_placeOrder" onclick="switchTab('placeOrder', event)">Place Order</button>
    <button class="nav-tab" id="legacyTab_inventorySettings" onclick="switchTab('inventorySettings', event)">Inventory Settings</button>
    <button class="nav-tab" id="legacyTab_submissionHistory" onclick="switchTab('submissionHistory', event)">Submission History</button>
    <button class="nav-tab" id="legacyTab_stockAlerts" onclick="switchTab('stockAlerts', event)">Stock Alerts <span id="alertBadge" class="badge-count" style="display:none;">0</span></button>
    <button class="nav-tab" id="legacyTab_consumptionTracking" onclick="switchTab('consumptionTracking', event)">Consumption & Orders</button>
    <button class="nav-tab" id="legacyTab_inventoryValuation" onclick="switchTab('inventoryValuation', event)">Valuation Reports</button>
    <button class="nav-tab" id="legacyTab_budgetTracking" onclick="switchTab('budgetTracking', event)">Budget Tracking</button>
    <button class="nav-tab" id="legacyTab_vendorPerformance" onclick="switchTab('vendorPerformance', event)">Vendor Performance</button>
    <button class="nav-tab" id="legacyTab_imageGallery" onclick="switchTab('imageGallery', event)">Image Gallery</button>
    <button class="nav-tab" id="legacyTab_rpt_purchase_summary"   onclick="switchTab('rpt_purchase_summary', event)">Purchase Summary</button>
    <button class="nav-tab" id="legacyTab_rpt_vendor_spend"       onclick="switchTab('rpt_vendor_spend', event)">Vendor Spend</button>
    <button class="nav-tab" id="legacyTab_rpt_cogs"               onclick="switchTab('rpt_cogs', event)">COGS</button>
    <button class="nav-tab" id="legacyTab_rpt_price_variance"     onclick="switchTab('rpt_price_variance', event)">Price Variance</button>
    <button class="nav-tab" id="legacyTab_rpt_stock_valuation"    onclick="switchTab('rpt_stock_valuation', event)">Stock Valuation</button>
    <button class="nav-tab" id="legacyTab_rpt_low_stock"          onclick="switchTab('rpt_low_stock', event)">Low Stock</button>
    <button class="nav-tab" id="legacyTab_rpt_par_compliance"     onclick="switchTab('rpt_par_compliance', event)">PAR Compliance</button>
    <button class="nav-tab" id="legacyTab_rpt_consumption"        onclick="switchTab('rpt_consumption', event)">Consumption</button>
    <button class="nav-tab" id="legacyTab_rpt_order_history"      onclick="switchTab('rpt_order_history', event)">Order History</button>
    <button class="nav-tab" id="legacyTab_rpt_order_frequency"    onclick="switchTab('rpt_order_frequency', event)">Order Frequency</button>
    <button class="nav-tab" id="legacyTab_rpt_delivery_accuracy"  onclick="switchTab('rpt_delivery_accuracy', event)">Delivery Accuracy</button>
    <button class="nav-tab" id="legacyTab_rpt_executive_summary"  onclick="switchTab('rpt_executive_summary', event)">Executive Summary</button>
</div>

<!-- ══ CORPORATE NAVIGATION ══ -->
<nav class="corp-nav">
    <div class="corp-nav-bar">

        <!-- INVENTORY GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_inventory">
                <i class="fas fa-boxes-stacked"></i> Inventory <span class="chevron">▼</span>
            </button>
            <div class="corp-nav-dropdown">
                <div class="corp-nav-dropdown-header">Inventory Management</div>
                <button class="nav-tab" onclick="corpNav('inventory')"><i class="fas fa-table-list" style="width:16px"></i> Inventory View</button>
                <button class="nav-tab" onclick="corpNav('quickEdit')"><i class="fas fa-pencil" style="width:16px"></i> Quick Edit</button>
                <button class="nav-tab" onclick="corpNav('imageGallery')"><i class="fas fa-images" style="width:16px"></i> Image Gallery</button>
                <button class="nav-tab" onclick="corpNav('inventorySettings')"><i class="fas fa-gear" style="width:16px"></i> Inventory Settings</button>
            </div>
        </div>

        <!-- ANALYTICS GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_analytics">
                <i class="fas fa-chart-mixed"></i> Analytics <span class="chevron">▼</span>
            </button>
            <div class="corp-nav-dropdown">
                <div class="corp-nav-dropdown-header">Analytics & Reporting</div>
                <button class="nav-tab" onclick="corpNav('analytics')"><i class="fas fa-chart-bar" style="width:16px"></i> Analytics & Insights</button>
                <button class="nav-tab" onclick="corpNav('vendorSpending')"><i class="fas fa-sack-dollar" style="width:16px"></i> Vendor Spending Analysis</button>
                <button class="nav-tab" onclick="corpNav('inventoryValuation')"><i class="fas fa-file-invoice-dollar" style="width:16px"></i> Valuation Reports</button>
                <button class="nav-tab" onclick="corpNav('budgetTracking')"><i class="fas fa-bullseye" style="width:16px"></i> Budget Tracking</button>
                <button class="nav-tab" onclick="corpNav('vendorPerformance')"><i class="fas fa-trophy" style="width:16px"></i> Vendor Performance</button>
                <button class="nav-tab" onclick="corpNav('consumptionTracking')"><i class="fas fa-arrow-trend-up" style="width:16px"></i> Consumption & Orders</button>
            </div>
        </div>

        <!-- PROCUREMENT GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_procurement">
                <i class="fas fa-file-invoice"></i> Procurement <span class="chevron">▼</span>
            </button>
            <div class="corp-nav-dropdown">
                <div class="corp-nav-dropdown-header">Procurement & Vendors</div>
                <button class="nav-tab" onclick="corpNav('invoices')"><i class="fas fa-receipt" style="width:16px"></i> Invoice Tracking</button>
                <button class="nav-tab" onclick="corpNav('vendors')"><i class="fas fa-building" style="width:16px"></i> Vendor Management</button>
                <button class="nav-tab" onclick="corpNav('placeOrder')"><i class="fas fa-clipboard-list" style="width:16px"></i> Place Order</button>
            </div>
        </div>

        <!-- ORDERS GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_orders">
                <i class="fas fa-cart-shopping"></i> Orders <span class="chevron">▼</span>
            </button>
            <div class="corp-nav-dropdown">
                <div class="corp-nav-dropdown-header">Order Management</div>
                <button class="nav-tab" onclick="corpNav('julioOrders')"><i class="fas fa-user" style="width:16px"></i> Julio's Orders</button>
                <button class="nav-tab" onclick="corpNav('ronyOrders')"><i class="fas fa-user" style="width:16px"></i> Rony's Orders</button>
                <button class="nav-tab" onclick="corpNav('officeOrders')"><i class="fas fa-building-user" style="width:16px"></i> Office Orders</button>
            </div>
        </div>

                <!-- REPORTS GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_reports">
                <i class="fas fa-file-chart-column"></i> Reports <span class="chevron">&#9660;</span>
            </button>
            <div class="corp-nav-dropdown" style="min-width:290px;">
                <div class="corp-nav-dropdown-header">&#x1F4B3; Financial Reports</div>
                <button class="nav-tab" onclick="corpNav('rpt_vendor_analysis')"><i class="fas fa-store" style="width:16px"></i> Vendor &amp; Purchase Analysis</button>
                <button class="nav-tab" onclick="corpNav('rpt_cogs')"><i class="fas fa-chart-line" style="width:16px"></i> COGS Report</button>
                <button class="nav-tab" onclick="corpNav('rpt_price_variance')"><i class="fas fa-tag" style="width:16px"></i> Price Variance &amp; Tracking</button>
                <div class="corp-nav-dropdown-header" style="margin-top:4px;">&#x1F4E6; Inventory Reports</div>
                <button class="nav-tab" onclick="corpNav('rpt_inventory_intel')"><i class="fas fa-boxes-stacked" style="width:16px"></i> Inventory Intelligence</button>
                <button class="nav-tab" onclick="corpNav('rpt_top10')"><i class="fas fa-trophy" style="width:16px"></i> Top 10 Purchased Items</button>
                <button class="nav-tab" onclick="corpNav('rpt_fast_slow')"><i class="fas fa-gauge-high" style="width:16px"></i> Fast vs Slow Moving</button>
                <button class="nav-tab" onclick="corpNav('rpt_dead_stock')"><i class="fas fa-skull" style="width:16px"></i> Dead Stock</button>
                <button class="nav-tab" onclick="corpNav('rpt_high_value')"><i class="fas fa-gem" style="width:16px"></i> High Value Exposure</button>
                <div class="corp-nav-dropdown-header" style="margin-top:4px;">&#x1F4CA; Analytics</div>
                <button class="nav-tab" onclick="corpNav('rpt_monthly_trend')"><i class="fas fa-calendar-days" style="width:16px"></i> Monthly Spend Trend</button>
                <button class="nav-tab" onclick="corpNav('rpt_turnover')"><i class="fas fa-rotate" style="width:16px"></i> Inventory Turnover</button>
                <button class="nav-tab" onclick="corpNav('rpt_price_volatility')"><i class="fas fa-chart-mixed" style="width:16px"></i> Price Volatility</button>
                <button class="nav-tab" onclick="corpNav('rpt_shrinkage')"><i class="fas fa-scale-unbalanced" style="width:16px"></i> Shrinkage &amp; Adjustments</button>
                <div class="corp-nav-dropdown-header" style="margin-top:4px;">&#x1F4CB; Order Reports</div>
                <button class="nav-tab" onclick="corpNav('rpt_order_history')"><i class="fas fa-clock-rotate-left" style="width:16px"></i> Order History</button>
                <button class="nav-tab" onclick="corpNav('rpt_order_frequency')"><i class="fas fa-repeat" style="width:16px"></i> Order Frequency</button>
                <button class="nav-tab" onclick="corpNav('rpt_delivery_accuracy')"><i class="fas fa-truck-fast" style="width:16px"></i> Delivery Accuracy</button>
                <button class="nav-tab" onclick="corpNav('rpt_executive_summary')"><i class="fas fa-star" style="width:16px"></i> Executive Summary</button>
            </div>
        </div>

        <!-- OPERATIONS GROUP -->
        <div class="corp-nav-group">
            <button class="corp-nav-btn" id="corpGroup_operations">
                <i class="fas fa-bell"></i> Operations <span class="chevron">▼</span>
            </button>
            <div class="corp-nav-dropdown">
                <div class="corp-nav-dropdown-header">Operations & Monitoring</div>
                <button class="nav-tab" onclick="corpNav('stockAlerts')">
                    <i class="fas fa-triangle-exclamation" style="width:16px"></i> Stock Alerts
                    <span id="alertBadge" class="badge-count" style="display:none; margin-left:auto;">0</span>
                </button>
                <button class="nav-tab" onclick="corpNav('submissionHistory')"><i class="fas fa-calendar-days" style="width:16px"></i> Submission History</button>
            </div>
        </div>

    </div>
    <!-- Active indicator -->
    <div class="corp-nav-active-indicator">
        <i class="fas fa-location-dot" style="color: var(--accent-400)"></i>
        Currently viewing: <span id="corpNavActiveLabel">Inventory View</span>
    </div>
</nav>

        <!-- Inventory View -->
        <div id="inventory" class="content-section active">
            <div class="search-filter-bar">
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." oninput="performSearch()">
                </div>
                <div class="filter-group">
                    <label>Vendor Filter</label>
                    <select id="vendorFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year Filter</label>
                    <select id="yearFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Assigned To</label>
                    <select id="assignedToFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category Filter</label>
                  <select id="categoryFilter" class="search-input" onchange="applyFilters()">
    <option value="">All Categories</option>
    
    <optgroup label="🥬 PRODUCE">
        <option value="Fresh Vegetables">Fresh Vegetables</option>
        <option value="Fresh Fruits">Fresh Fruits</option>
        <option value="Fresh Herbs">Fresh Herbs</option>
        <option value="Mushrooms">Mushrooms</option>
        <option value="Vegetable Powders">Vegetable Powders</option>
        <option value="Sprouts & Microgreens">Sprouts & Microgreens</option>
        <option value="Exotic Produce">Exotic Produce</option>
    </optgroup>
    
    <optgroup label="🥩 BEEF">
        <option value="Beef">Beef (All)</option>
        <option value="Ground Beef">Ground Beef</option>
        <option value="Beef Steaks">Beef Steaks</option>
        <option value="Beef Roasts">Beef Roasts</option>
    </optgroup>
    
    <optgroup label="🐖 PORK">
        <option value="Pork">Pork (All)</option>
        <option value="Pork Belly">Pork Belly</option>
        <option value="Pork Chops">Pork Chops</option>
        <option value="Ground Pork">Ground Pork</option>
        <option value="Pork Ribs">Pork Ribs</option>
        <option value="Pork Sausage">Pork Sausage</option>
    </optgroup>
    
    <optgroup label="🐔 POULTRY">
        <option value="Poultry">Poultry (All)</option>
        <option value="Chicken Breast">Chicken Breast</option>
        <option value="Chicken Thighs">Chicken Thighs</option>
        <option value="Whole Chicken">Whole Chicken</option>
        <option value="Chicken Wings">Chicken Wings</option>
        <option value="Duck">Duck</option>
        <option value="Turkey">Turkey</option>
    </optgroup>
    
    <optgroup label="🐑 LAMB">
        <option value="Lamb">Lamb (All)</option>
        <option value="Lamb Chops">Lamb Chops</option>
        <option value="Ground Lamb">Ground Lamb</option>
        <option value="Leg of Lamb">Leg of Lamb</option>
    </optgroup>
    
    <optgroup label="🐟 SEAFOOD">
        <option value="Seafood">Seafood (All)</option>
        <option value="Fresh Fish">Fresh Fish</option>
        <option value="Salmon">Salmon</option>
        <option value="White Fish">White Fish</option>
        <option value="Shellfish">Shellfish</option>
        <option value="Shrimp">Shrimp</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Squid & Octopus">Squid & Octopus</option>
    </optgroup>
    
    <optgroup label="🥛 DAIRY & EGGS">
        <option value="Milk & Cream">Milk & Cream</option>
        <option value="Cheese - Hard">Cheese - Hard</option>
        <option value="Cheese - Soft">Cheese - Soft</option>
        <option value="Cheese - Specialty">Cheese - Specialty</option>
        <option value="Butter & Margarine">Butter & Margarine</option>
        <option value="Yogurt & Sour Cream">Yogurt & Sour Cream</option>
        <option value="Eggs">Eggs</option>
    </optgroup>
    
    <optgroup label="🌾 DRY GOODS">
        <option value="Rice">Rice</option>
        <option value="Noodles & Pasta">Noodles & Pasta</option>
        <option value="Flour & Baking">Flour & Baking</option>
        <option value="Grains">Grains</option>
        <option value="Beans & Legumes">Beans & Legumes</option>
        <option value="Breadcrumbs & Coatings">Breadcrumbs & Coatings</option>
        <option value="Nuts & Specialty Items">Nuts & Specialty Items</option>
        <option value="Dried Fruits">Dried Fruits</option>
    </optgroup>
    
    <optgroup label="❄️ FROZEN">
        <option value="Frozen Vegetables">Frozen Vegetables</option>
        <option value="Frozen Fruits">Frozen Fruits</option>
        <option value="Frozen Meat">Frozen Meat</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Frozen Prepared Items">Frozen Prepared Items</option>
        <option value="Ice & Ice Cream">Ice & Ice Cream</option>
    </optgroup>
    
    <optgroup label="🥤 BEVERAGES">
        <option value="Tea">Tea</option>
        <option value="Coffee">Coffee</option>
        <option value="Soft Drinks">Soft Drinks</option>
        <option value="Alcoholic">Alcoholic</option>
        <option value="Mixers & Syrups">Mixers & Syrups</option>
    </optgroup>
    
    <optgroup label="🧂 CONDIMENTS & SEASONINGS">
        <option value="Sauces - Asian">Sauces - Asian</option>
        <option value="Sauces - Western">Sauces - Western</option>
        <option value="Sauces - Specialty">Sauces - Specialty</option>
        <option value="Oils">Oils</option>
        <option value="Vinegars">Vinegars</option>
        <option value="Spices - Whole">Spices - Whole</option>
        <option value="Spices - Ground">Spices - Ground</option>
        <option value="Spice Blends">Spice Blends</option>
        <option value="Sweeteners">Sweeteners</option>
        <option value="Cooking Ingredients">Cooking Ingredients</option>
        <option value="Candy & Mints">Candy & Mints</option>
    </optgroup>
    
    <optgroup label="🧹 CLEANING & JANITORIAL">
        <option value="Dishwashing">Dishwashing</option>
        <option value="Surface Cleaners">Surface Cleaners</option>
        <option value="Floor Care">Floor Care</option>
        <option value="AutoChlor System">AutoChlor System</option>
        <option value="Janitorial Chemicals">Janitorial Chemicals</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Disposal Supplies">Disposal Supplies</option>
        <option value="Restroom Supplies">Restroom Supplies</option>
        <option value="PPE & Gloves">PPE & Gloves</option>
    </optgroup>
    
    <optgroup label="🍽️ TO-GO & DISPOSABLE">
        <option value="Containers - Foam">Containers - Foam</option>
        <option value="Containers - Plastic">Containers - Plastic</option>
        <option value="Containers - Paper">Containers - Paper</option>
        <option value="Bags">Bags</option>
        <option value="Utensils">Utensils</option>
        <option value="Napkins & Straws">Napkins & Straws</option>
        <option value="Lids & Covers">Lids & Covers</option>
        <option value="Labels & Stickers">Labels & Stickers</option>
    </optgroup>
    
    <optgroup label="🏢 OFFICE SUPPLIES">
        <option value="Paper Products">Paper Products</option>
        <option value="Writing Instruments">Writing Instruments</option>
        <option value="Filing & Organization">Filing & Organization</option>
        <option value="Computer Supplies">Computer Supplies</option>
        <option value="Shipping Supplies">Shipping Supplies</option>
    </optgroup>
    
    <optgroup label="🍳 KITCHEN EQUIPMENT">
        <option value="Cookware">Cookware</option>
        <option value="Bakeware">Bakeware</option>
        <option value="Utensils">Utensils</option>
        <option value="Knives">Knives</option>
        <option value="Small Appliances">Small Appliances</option>
        <option value="Storage">Storage</option>
        <option value="Safety Equipment">Safety Equipment</option>
    </optgroup>
    
    <optgroup label="📦 OTHER">
        <option value="Miscellaneous">Miscellaneous</option>
        <option value="Seasonal Items">Seasonal Items</option>
        <option value="Repairs & Parts">Repairs & Parts</option>
    </optgroup>
</select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="exportToCSV()">📥 Export</button>
                    <button class="btn btn-secondary" onclick="openBulkAssignModal()">👥 Bulk Assign</button>
                    <button class="btn btn-success" onclick="openAddItemModal()">+ Add Item</button>
                    <button class="btn btn-primary" onclick="syncMissingImages()" title="Sync images from Inventory Management to items missing images">
                        🔄 Sync Missing Images
                    </button>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Product Inventory</h2>
                    <div class="table-actions" style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn" onclick="toggleBulkAssignMode()" id="bulkAssignToggleBtn" title="Bulk Assign Mode" style="background: var(--primary-600); color: white; min-width: 140px; white-space: nowrap;">
                            <i class="fas fa-user-check"></i> Bulk Assign
                        </button>
                        <button class="btn btn-success" onclick="applyBulkAssignment()" id="applyBulkAssignBtn" style="display: none;">
                            <i class="fas fa-check"></i> Assign Selected
                        </button>
                        <button class="btn btn-icon" onclick="toggleDeleteMode()" id="deleteToggleBtn" title="Delete Mode" style="background: var(--warning-600); color: white;">🗑️</button>
                        <button class="btn btn-primary" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">Delete Selected</button>
                        <span id="recordCount" style="margin-left: auto; font-weight: 600; white-space: nowrap;">Loading...</span>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th id="checkboxHeader" style="display: none; width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer; width: 18px; height: 18px;">
                            </th>
                            <th>Image</th>
                            <th>Vendor</th>
                             <th>Category</th>
                            <th>Item No.</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Purchase Date</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Quick Edit View -->
        <div id="quickEdit" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>Filter by Assignment</label>
                    <select id="quickEditAssignFilter" class="search-input" onchange="filterQuickEdit()">
                        <option value="">All Products</option>
                        <option value="rony">Rony's Products</option>
                        <option value="julio">Julio's Products</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="quickEditSearch" class="search-input" placeholder="Search by name or code..." oninput="filterQuickEdit()">
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Quick Edit - All Matching Items Update Together</h2>
                    <span id="quickEditCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Item Code</th>
                            <th>Product Name</th>
                            <th>Vendor</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quickEditTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Products</div>
                    <div class="metric-value" id="metricTotalProducts">-</div>
                    <div class="metric-subtitle">Unique products</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Vendors</div>
                    <div class="metric-value" id="metricActiveVendors">-</div>
                    <div class="metric-subtitle">Suppliers with inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Price</div>
                    <div class="metric-value" id="metricAvgPrice">-</div>
                    <div class="metric-subtitle">Across all inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Value</div>
                    <div class="metric-value" id="metricTotalValue">-</div>
                    <div class="metric-subtitle">Estimated total</div>
                </div>
            </div>

            <div class="search-filter-bar">
                <div class="search-group">
                    <label>📊 Select Product for Price Analysis</label>
                    <select id="analyticsProductSelect" class="search-input" onchange="loadProductAnalytics()">
                        <option value="">Choose a product to compare prices...</option>
                    </select>
                </div>
            </div>

            <div id="productAnalysisSection" style="display: none;">
                <div class="comparison-grid" id="priceComparison"></div>

                <div class="chart-container">
                    <h3>📈 Vendor Price Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="vendorPriceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>📉 Price History Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="priceHistoryChart"></canvas>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h2>💡 Price Variance Analysis</h2>
                    </div>
                    <div style="padding: 2rem;" id="varianceAnalysis"></div>
                </div>
            </div>

            <div class="chart-container">
                <h3>🏢 Vendor Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="vendorDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Vendor Spending Analysis -->
        <div id="vendorSpending" class="content-section">
            <!-- Period Filter Bar -->
            <div style="background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%); border-radius: 14px; padding: 1.5rem 1.75rem; margin-bottom: 1.5rem; box-shadow: var(--shadow-xl); border-bottom: 3px solid var(--accent-500);">
                <div style="display:flex; align-items:center; justify-content:space-between; flex-wrap:wrap; gap:1rem;">
                    <div>
                        <h2 style="color:white; font-size:1.375rem; font-weight:700; margin:0; letter-spacing:-0.02em;">
                            <i class="fas fa-sack-dollar" style="color:var(--accent-400); margin-right:0.5rem;"></i>
                            Vendor Spending Analysis
                        </h2>
                        <p style="color:rgba(255,255,255,0.55); font-size:0.8125rem; margin:0.25rem 0 0; font-family:var(--font-mono);">
                            Spending breakdown by vendor, period &amp; trend
                        </p>
                    </div>
                    <!-- Period Mode Tabs -->
                    <div style="display:flex; gap:0.375rem; background:rgba(255,255,255,0.08); border-radius:10px; padding:0.25rem;">
                        <button class="vsa-period-btn active" id="vsaPeriodWeek" onclick="setVSAPeriod('week')">
                            <i class="fas fa-calendar-week"></i> Week
                        </button>
                        <button class="vsa-period-btn" id="vsaPeriodRange" onclick="setVSAPeriod('range')">
                            <i class="fas fa-calendar-range"></i> Range
                        </button>
                        <button class="vsa-period-btn" id="vsaPeriodMonth" onclick="setVSAPeriod('month')">
                            <i class="fas fa-calendar"></i> Month
                        </button>
                        <button class="vsa-period-btn" id="vsaPeriodYear" onclick="setVSAPeriod('year')">
                            <i class="fas fa-calendar-days"></i> Year
                        </button>
                    </div>
                </div>

                <!-- Dynamic filter row -->
                <div id="vsaFilterRow" style="margin-top:1.25rem; display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end;">
                    <!-- Week filters -->
                    <div id="vsaWeekFilters" style="display:flex; gap:1rem; flex-wrap:wrap; align-items:flex-end;">
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">Week of</label>
                            <input type="date" id="vsaWeekDate" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                        </div>
                    </div>
                    <!-- Range filters -->
                    <div id="vsaRangeFilters" style="display:none; gap:1rem; flex-wrap:wrap; align-items:flex-end;">
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">From</label>
                            <input type="date" id="vsaRangeFrom" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                        </div>
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">To</label>
                            <input type="date" id="vsaRangeTo" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                        </div>
                    </div>
                    <!-- Month filters -->
                    <div id="vsaMonthFilters" style="display:none; gap:1rem; flex-wrap:wrap; align-items:flex-end;">
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">Month</label>
                            <select id="vsaMonth" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                                <option value="1">January</option><option value="2">February</option>
                                <option value="3">March</option><option value="4">April</option>
                                <option value="5">May</option><option value="6">June</option>
                                <option value="7">July</option><option value="8">August</option>
                                <option value="9">September</option><option value="10">October</option>
                                <option value="11">November</option><option value="12">December</option>
                            </select>
                        </div>
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">Year</label>
                            <select id="vsaMonthYear" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                                <option value="2024">2024</option><option value="2025">2025</option>
                                <option value="2026" selected>2026</option><option value="2027">2027</option>
                            </select>
                        </div>
                    </div>
                    <!-- Year filters -->
                    <div id="vsaYearFilters" style="display:none; gap:1rem; align-items:flex-end;">
                        <div class="filter-group" style="display:flex; flex-direction:column; gap:0.375rem;">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em;">Year</label>
                            <select id="vendorSpendingYear" class="search-input" style="background:rgba(255,255,255,0.12); border:1px solid rgba(255,255,255,0.2); color:white; border-radius:8px; padding:0.5rem 0.75rem;" onchange="loadVendorSpendingAnalysis()">
                                <option value="2024">2024</option><option value="2025">2025</option>
                                <option value="2026" selected>2026</option><option value="2027">2027</option>
                            </select>
                        </div>
                        <div class="search-group">
                            <label style="color:rgba(255,255,255,0.75); font-size:0.75rem; font-weight:600; text-transform:uppercase; letter-spacing:0.05em; display:block; margin-bottom:0.375rem;">Months to Analyze</label>
                            <div class="month-selector" id="vendorMonthSelector" style="background:rgba(255,255,255,0.06); border-radius:8px; padding:0.375rem;"></div>
                        </div>
                    </div>
                    <!-- Apply button -->
                    <button class="btn btn-primary" onclick="loadVendorSpendingAnalysis()" style="background:var(--accent-500); border-color:var(--accent-500); color:var(--primary-900); font-weight:700; height:fit-content;">
                        <i class="fas fa-magnifying-glass-chart"></i> Analyze
                    </button>
                </div>
            </div>

            <div id="vendorSpendingContent"></div>
        </div>

        <!-- Invoice Tracking Section -->
        <div id="invoices" class="content-section">
            <!-- FILTERS BAR -->
            <div class="search-filter-bar" style="background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: 0 4px 12px rgba(92, 21, 21, 0.2);">
                <div class="filter-group">
                    <label style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Vendor</label>
                    <select id="invoiceVendorSelect" class="search-input" onchange="filterInvoicesByVendor()" style="background: white; border: 2px solid rgba(255,255,255,0.3); font-weight: 600;">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Month</label>
                    <select id="invoiceMonthSelect" class="search-input" onchange="filterInvoicesByVendor()" style="background: white; border: 2px solid rgba(255,255,255,0.3); font-weight: 600;">
                        <option value="">All Months</option>
                        <option value="01">January</option>
                        <option value="02">February</option>
                        <option value="03">March</option>
                        <option value="04">April</option>
                        <option value="05">May</option>
                        <option value="06">June</option>
                        <option value="07">July</option>
                        <option value="08">August</option>
                        <option value="09">September</option>
                        <option value="10">October</option>
                        <option value="11">November</option>
                        <option value="12">December</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">Year</label>
                    <select id="invoiceYearSelect" class="search-input" onchange="filterInvoicesByVendor()" style="background: white; border: 2px solid rgba(255,255,255,0.3); font-weight: 600;">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label style="color: rgba(255,255,255,0.9); font-weight: 600; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em;">🔍 Invoice #</label>
                    <input type="text"
                           id="invoiceNumberSearch"
                           class="search-input"
                           placeholder="Search invoice #..."
                           oninput="filterInvoicesByVendor()"
                           style="background: white; border: 2px solid rgba(255,255,255,0.3); font-weight: 600; min-width: 155px;">
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="openAddItemFromTracking()" style="background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); border: 2px solid rgba(255,255,255,0.3); color: white; font-weight: 700; transition: all 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.3)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                        <i class="fas fa-box"></i> Add Item
                    </button>
                    <button class="btn btn-success" onclick="openAddInvoiceModal()" style="background: rgba(16, 185, 129, 0.9); border: 2px solid rgba(255,255,255,0.3); color: white; font-weight: 700; transition: all 0.2s; box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3);" onmouseover="this.style.background='#059669'" onmouseout="this.style.background='rgba(16, 185, 129, 0.9)'">
                        <i class="fas fa-file-invoice"></i> Add Invoice
                    </button>
                </div>
            </div>

            <!-- SPENDING SUMMARY DASHBOARD -->
            <div id="spendingSummary" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 1rem; margin-bottom: 1.5rem;">
                <!-- Summary cards will be rendered here by JavaScript -->
            </div>

            <!-- PROFESSIONAL TABLE LAYOUT -->
            <div style="background: white; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); overflow: hidden;">
                <!-- Table Header -->
                <div style="background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); padding: 1.25rem 1.5rem; border-bottom: 2px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: #0f172a; margin: 0; display: flex; align-items: center; gap: 0.5rem;">
                        <i class="fas fa-file-invoice-dollar" style="color: var(--primary-500);"></i>
                        Invoice Register
                    </h2>
                    <span id="invoiceCount" style="font-size: 0.875rem; color: #64748b; font-weight: 600; padding: 0.375rem 0.75rem; background: white; border-radius: 6px; border: 1px solid #e2e8f0;">Loading...</span>
                </div>
                
                <!-- SPREADSHEET-STYLE TABLE -->
                <div id="invoicesTableContainer" style="overflow-x: auto;">
                    <table style="width: 100%; border-collapse: collapse; font-size: 0.875rem;">
                        <thead>
                            <tr style="background: #f8fafc; border-bottom: 2px solid #cbd5e1;">
                                <th style="padding: 0.875rem 1rem; text-align: left; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em; white-space: nowrap;">Vendor</th>
                                <th style="padding: 0.875rem 1rem; text-align: left; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Date</th>
                                <th style="padding: 0.875rem 1rem; text-align: left; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Invoice #</th>
                                <th style="padding: 0.875rem 1rem; text-align: left; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Check #</th>
                                <th style="padding: 0.875rem 1rem; text-align: right; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Amount</th>
                                <th style="padding: 0.875rem 1rem; text-align: left; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Notes</th>
                                <th style="padding: 0.875rem 1rem; text-align: center; font-weight: 700; color: #475569; text-transform: uppercase; font-size: 0.6875rem; letter-spacing: 0.05em;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="invoicesTableBody">
                            <!-- Rows will be rendered here -->
                        </tbody>
                    </table>
                </div>
                
                <!-- Keep grid container hidden -->
                <div id="invoicesGridContainer" style="display: none;"></div>
            </div>
        </div>
                
                <!-- Keep hidden table for backwards compatibility -->
                <table class="data-table" style="display: none;">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Invoice #</th>
                            <th>Check #</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Vendor Management Section -->
        <div id="vendors" class="content-section">
            <div class="data-table-container">
                <div class="table-header">
                    <h2>Vendor Statistics</h2>
                    <span id="vendorCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vendor Logo</th>
                            <th>Vendor Name</th>
                            <th>Product Count</th>
                            <th>Last Purchase</th>
                            <th>Total Purchases</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Julio's Orders Section -->
<!-- Julio's Orders Section -->
<div id="julioOrders" class="content-section">
  <div class="search-filter-bar">
    <!-- ADD DATE PICKER -->
    <div class="filter-group">
      <label>📅 Order Date</label>
      <input type="date" id="julioOrderDate" class="search-input" onchange="loadJulioOrders()">
    </div>
    
    <div class="search-group">
      <label>🔍 Search Products</label>
      <input type="text" id="julioSearchInput" class="search-input" placeholder="Search by product name..." oninput="filterJulioProducts()">
    </div>
    <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
      <button class="btn btn-success" onclick="openAddProductModal('julio')">
        <i class="fas fa-plus"></i> Add Product
      </button>
      <button class="btn btn-primary" onclick="saveJulioOrders()">
        <i class="fas fa-save"></i> Save Order Request
      </button>
      <button class="btn btn-secondary" onclick="clearJulioOrders()">
        <i class="fas fa-eraser"></i> Clear All
      </button>
    </div>
  </div>
  
  <div class="data-table-container">
    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem;">
        <i class="fas fa-boxes" style="color: var(--accent-500);"></i>
        Julio's Target Inventory
      </h2>
      <span id="julioProductCount" style="font-size: 1.1rem; color: var(--neutral-600);">Loading...</span>
    </div>
    
    <!-- Redesigned Product Grid -->
    <div id="julioProductGrid" style="padding: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.75rem;">
      <!-- Product cards will be rendered here by JavaScript -->
    </div>
  </div>
  
  <!-- Enhanced SUBMIT BUTTON with progress visualization -->
  <div style="background: white; padding: 1.75rem; border-radius: 16px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center; position: relative;">
    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.25rem;">
      <div style="background: var(--accent-100); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent-700);">
        <i class="fas fa-boxes"></i>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 1.3rem; color: var(--neutral-900); margin: 0;">Complete Your Order</h3>
        <p style="font-size: 0.95rem; color: var(--neutral-600); margin: 0.5rem 0 0 0;">Set target quantities for all products before submitting</p>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      <div style="display: flex; justify-content: center; gap: 0.75rem; align-items: center;">
        <div style="width: 100%; height: 8px; background: var(--neutral-200); border-radius: 4px; overflow: hidden;">
          <div id="julioProgress" style="height: 100%; width: 0%; background: var(--accent-600); border-radius: 4px; transition: width 0.5s;"></div>
        </div>
        <div style="font-size: 1.1rem; font-weight: 600; color: var(--neutral-700); min-width: 80px; text-align: center;">
          <span id="julioProgressPercent">0%</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--neutral-600);">
        <span>Products with targets set: <span id="julioProductsSet">0</span> of <span id="julioTotalProducts">0</span></span>
        <span>Completion status</span>
      </div>
    </div>
    
    <button class="btn btn-success" onclick="saveJulioOrders()" style="padding: 1.25rem 3.5rem; font-size: 1.35rem; margin-top: 1.5rem; width: 100%;">
      <i class="fas fa-paper-plane"></i> Submit Julio's Order
    </button>
  </div>
</div>

<!-- Rony's Orders Section -->
<!-- Rony's Orders Section -->
<div id="ronyOrders" class="content-section">
    <div class="search-filter-bar">
        <!-- ADD DATE PICKER -->
        <div class="filter-group">
            <label>📅 Stock Count Date</label>
            <input type="date" id="ronyOrderDate" class="search-input" onchange="loadRonyOrders()">
        </div>
        
        <div class="search-group">
            <label>🔍 Search Products</label>
            <input type="text" id="ronySearchInput" class="search-input" placeholder="Search by product name..." oninput="filterRonyProducts()">
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="openAddProductModal('rony')">
                <i class="fas fa-plus"></i> Add Product
            </button>
            <button class="btn btn-primary" onclick="saveRonyOrders()">
                <i class="fas fa-save"></i> Submit Order
            </button>
            <button class="btn btn-secondary" onclick="clearRonyOrders()">
                <i class="fas fa-eraser"></i> Clear All
            </button>
        </div>
    </div>

    <!-- Global Progress Bar -->
    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
        <div style="height: 10px; background: var(--neutral-200); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem;">
            <div id="ronyGlobalProgress" style="height: 100%; width: 0%; background: var(--primary-600); transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--neutral-600);">
            <span>Overall Progress</span>
            <span id="ronyGlobalLabel">0%</span>
        </div>
    </div>

    <!-- Products Grouped by Position -->
    <div id="ronyProductContainer"></div>
    
    <!-- SUBMIT BUTTON AT BOTTOM -->
    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
        <button class="btn btn-success" onclick="saveRonyOrders()" style="padding: 1rem 3rem; font-size: 1.25rem;">
            <i class="fas fa-paper-plane"></i> Submit Rony's Stock Count
        </button>
    </div>
</div>
<!-- END RONY ORDERS -->


<!-- 🏢 OFFICE ORDERS TAB -->
<div id="officeOrders" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>📅 Order Date</label>
            <input type="date" id="officeOrderDate" class="search-input" onchange="loadOfficeOrders()">
        </div>
        <div class="search-group">
            <label>🔍 Search Products</label>
            <input type="text" id="officeSearchInput" class="search-input" placeholder="Search..." oninput="filterOfficeProducts()">
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="openAddProductModal('office')">
                <i class="fas fa-plus"></i> Add Product
            </button>
            <button class="btn btn-primary" onclick="saveOfficeOrders()">
                <i class="fas fa-paper-plane"></i> Submit Order
            </button>
            <button class="btn btn-secondary" onclick="clearOfficeOrders()">
                <i class="fas fa-eraser"></i> Clear All
            </button>
        </div>
    </div>
    
    <div class="data-table-container">
        <div class="table-header">
            <h2><i class="fas fa-building"></i> Office Supplies Order</h2>
            <span id="officeProductCount">0 products</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Image</th>
                    <th>Product</th>
                    <th>Vendor</th>
                    <th>Current Stock</th>
                    <th>Order Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="officeOrdersTableBody"></tbody>
        </table>
    </div>
</div>

<!-- Submission History Section -->
<div id="submissionHistory" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Submitted By</label>
            <select id="historyUserFilter" class="search-input" onchange="filterSubmissionHistory()">
                <option value="">All Users</option>
                <option value="julio">Julio</option>
                <option value="rony">Rony</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Date From</label>
            <input type="date" id="historyDateFrom" class="search-input" onchange="filterSubmissionHistory()">
        </div>
        <div class="filter-group">
            <label>Date To</label>
            <input type="date" id="historyDateTo" class="search-input" onchange="filterSubmissionHistory()">
        </div>
        <div class="search-group">
            <label>Search Product</label>
            <input type="text" id="historySearchInput" class="search-input" placeholder="Search by product name..." oninput="filterSubmissionHistory()">
        </div>
    </div>

    <div class="data-table-container">
        <div class="table-header">
            <h2>📅 Order Submission History</h2>
            <span id="historyCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Submission Date</th>
                    <th>Submitted By</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Type</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
        </table>
    </div>
</div>

<!-- 🚨 STOCK ALERTS TAB -->
<div id="stockAlerts" class="content-section">

    <!-- ── FILTER BAR ── -->
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>👤 Section</label>
            <select id="alertSectionFilter" class="search-input" onchange="renderStockAlerts()">
                <option value="all">All Sections</option>
                <option value="rony">🍳 Rony</option>
                <option value="julio">🛒 Julio</option>
            </select>
        </div>
        <div class="filter-group">
            <label>🚦 Alert Type</label>
            <select id="alertTypeFilter" class="search-input" onchange="filterAlerts(this.value)">
                <option value="all">All Products</option>
                <option value="critical">🔴 Critical (Out of Stock)</option>
                <option value="warning">🟠 Warning (Low Stock)</option>
                <option value="watch">🟡 Watch (Below 50%)</option>
                <option value="declining">📉 Declining</option>
                <option value="ok">✅ In Stock (OK)</option>
            </select>
        </div>
        <div class="filter-group" style="min-width:240px;">
            <label>📂 Category</label>
            <select id="alertCategoryFilter" class="search-input" onchange="renderStockAlerts()">
                <option value="">All Categories</option>
                <optgroup label="🥬 PRODUCE">
                    <option value="Fresh Vegetables">Fresh Vegetables</option>
                    <option value="Fresh Fruits">Fresh Fruits</option>
                    <option value="Fresh Herbs">Fresh Herbs</option>
                    <option value="Mushrooms">Mushrooms</option>
                    <option value="Vegetable Powders">Vegetable Powders</option>
                    <option value="Sprouts &amp; Microgreens">Sprouts &amp; Microgreens</option>
                    <option value="Exotic Produce">Exotic Produce</option>
                </optgroup>
                <optgroup label="🥩 BEEF &amp; PORK">
                    <option value="Beef">Beef</option>
                    <option value="Ground Beef">Ground Beef</option>
                    <option value="Pork">Pork</option>
                    <option value="Pork Belly">Pork Belly</option>
                    <option value="Ground Pork">Ground Pork</option>
                </optgroup>
                <optgroup label="🐔 POULTRY">
                    <option value="Poultry">Poultry</option>
                    <option value="Chicken Breast">Chicken Breast</option>
                    <option value="Chicken Thighs">Chicken Thighs</option>
                    <option value="Whole Chicken">Whole Chicken</option>
                    <option value="Chicken Wings">Chicken Wings</option>
                    <option value="Duck">Duck</option>
                    <option value="Turkey">Turkey</option>
                </optgroup>
                <optgroup label="🐟 SEAFOOD">
                    <option value="Seafood">Seafood</option>
                    <option value="Fresh Fish">Fresh Fish</option>
                    <option value="Salmon">Salmon</option>
                    <option value="Shrimp">Shrimp</option>
                    <option value="Shellfish">Shellfish</option>
                    <option value="Frozen Seafood">Frozen Seafood</option>
                    <option value="Squid &amp; Octopus">Squid &amp; Octopus</option>
                </optgroup>
                <optgroup label="🥛 DAIRY &amp; EGGS">
                    <option value="Milk &amp; Cream">Milk &amp; Cream</option>
                    <option value="Cheese - Hard">Cheese - Hard</option>
                    <option value="Cheese - Soft">Cheese - Soft</option>
                    <option value="Butter &amp; Margarine">Butter &amp; Margarine</option>
                    <option value="Eggs">Eggs</option>
                </optgroup>
                <optgroup label="🌾 DRY GOODS">
                    <option value="Rice">Rice</option>
                    <option value="Noodles &amp; Pasta">Noodles &amp; Pasta</option>
                    <option value="Flour &amp; Baking">Flour &amp; Baking</option>
                    <option value="Beans &amp; Legumes">Beans &amp; Legumes</option>
                    <option value="Nuts &amp; Specialty Items">Nuts &amp; Specialty Items</option>
                </optgroup>
                <optgroup label="❄️ FROZEN">
                    <option value="Frozen Vegetables">Frozen Vegetables</option>
                    <option value="Frozen Meat">Frozen Meat</option>
                    <option value="Frozen Seafood">Frozen Seafood</option>
                    <option value="Frozen Prepared Items">Frozen Prepared Items</option>
                </optgroup>
                <optgroup label="🥤 BEVERAGES">
                    <option value="Tea">Tea</option>
                    <option value="Coffee">Coffee</option>
                    <option value="Soft Drinks">Soft Drinks</option>
                    <option value="Alcoholic">Alcoholic</option>
                </optgroup>
                <optgroup label="🧂 CONDIMENTS &amp; SEASONINGS">
                    <option value="Sauces - Asian">Sauces - Asian</option>
                    <option value="Sauces - Western">Sauces - Western</option>
                    <option value="Oils">Oils</option>
                    <option value="Spices - Whole">Spices - Whole</option>
                    <option value="Spices - Ground">Spices - Ground</option>
                    <option value="Spice Blends">Spice Blends</option>
                    <option value="Sweeteners">Sweeteners</option>
                    <option value="Cooking Ingredients">Cooking Ingredients</option>
                </optgroup>
                <optgroup label="🧹 CLEANING &amp; JANITORIAL">
                    <option value="Dishwashing">Dishwashing</option>
                    <option value="Surface Cleaners">Surface Cleaners</option>
                    <option value="Floor Care">Floor Care</option>
                    <option value="Janitorial Chemicals">Janitorial Chemicals</option>
                    <option value="Restroom Supplies">Restroom Supplies</option>
                    <option value="PPE &amp; Gloves">PPE &amp; Gloves</option>
                    <option value="Disposal Supplies">Disposal Supplies</option>
                </optgroup>
                <optgroup label="🍽️ TO-GO &amp; DISPOSABLE">
                    <option value="Containers - Foam">Containers - Foam</option>
                    <option value="Containers - Plastic">Containers - Plastic</option>
                    <option value="Containers - Paper">Containers - Paper</option>
                    <option value="Bags">Bags</option>
                    <option value="Utensils">Utensils</option>
                    <option value="Napkins &amp; Straws">Napkins &amp; Straws</option>
                    <option value="Lids &amp; Covers">Lids &amp; Covers</option>
                    <option value="Labels &amp; Stickers">Labels &amp; Stickers</option>
                </optgroup>
                <optgroup label="🏢 OFFICE SUPPLIES">
                    <option value="Paper Products">Paper Products</option>
                    <option value="Writing Instruments">Writing Instruments</option>
                    <option value="Computer Supplies">Computer Supplies</option>
                    <option value="Shipping Supplies">Shipping Supplies</option>
                </optgroup>
                <optgroup label="🍳 KITCHEN EQUIPMENT">
                    <option value="Cookware">Cookware</option>
                    <option value="Knives">Knives</option>
                    <option value="Small Appliances">Small Appliances</option>
                    <option value="Storage">Storage</option>
                </optgroup>
                <optgroup label="📦 OTHER">
                    <option value="Miscellaneous">Miscellaneous</option>
                    <option value="Seasonal Items">Seasonal Items</option>
                    <option value="Repairs &amp; Parts">Repairs &amp; Parts</option>
                </optgroup>
            </select>
        </div>
        <div class="search-group">
            <label>🔍 Search Product</label>
            <input type="text" id="alertSearchInput" class="search-input" placeholder="Type product name..." oninput="renderStockAlerts()">
        </div>
        <div style="display:flex; align-items:flex-end;">
            <button class="btn btn-primary" onclick="loadStockAlerts()">
                <i class="fas fa-sync"></i> Refresh
            </button>
        </div>
    </div>

        <!-- ── SUMMARY STAT CARDS ── -->
    <div id="alertSummaryCards" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(160px, 1fr)); gap: 1rem; margin-bottom: 1.25rem;"></div>

    <!-- ── SECTIONED CONTAINER ── -->
    <div id="alertsContainer"></div>

</div>

<!-- 📊 CONSUMPTION TRACKING TAB -->
<div id="consumptionTracking" class="content-section">

  <!-- ══ TOP FILTER BAR ══════════════════════════════════════════ -->
  <div style="background:white;border-radius:12px;padding:1.25rem 1.5rem;box-shadow:var(--shadow-sm);border:1px solid var(--neutral-200);margin-bottom:1.5rem;">
    <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">

      <!-- Year -->
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">📅 Year</label>
        <select id="consumptionYear" class="search-input" style="min-width:90px;" onchange="ctUpdateWeeks()">
          <option value="2024">2024</option>
          <option value="2025">2025</option>
          <option value="2026" selected>2026</option>
          <option value="2027">2027</option>
        </select>
      </div>

      <!-- Month -->
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">📆 Month</label>
        <select id="consumptionMonth" class="search-input" style="min-width:120px;" onchange="ctUpdateWeeks()">
          <option value="1">January</option><option value="2">February</option>
          <option value="3">March</option><option value="4">April</option>
          <option value="5">May</option><option value="6">June</option>
          <option value="7">July</option><option value="8">August</option>
          <option value="9">September</option><option value="10">October</option>
          <option value="11">November</option><option value="12">December</option>
        </select>
      </div>

      <!-- Week -->
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">🗓️ Week</label>
        <select id="ctWeekFilter" class="search-input" style="min-width:200px;">
          <option value="all">All Weeks</option>
        </select>
      </div>

      <!-- Category -->
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">📂 Category</label>
        <select id="ctCategoryFilter" class="search-input" style="min-width:150px;" onchange="ctApplyFilters()">
          <option value="">All Categories</option>
        </select>
      </div>

      <!-- User -->
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">👤 User</label>
        <select id="consumptionUserFilter" class="search-input" style="min-width:140px;" onchange="ctApplyFilters()">
          <option value="all">All Users</option>
          <option value="rony">Rony</option>
          <option value="julio">Julio</option>
        </select>
      </div>

      <!-- Product Search (autocomplete) -->
      <div style="flex:1;min-width:220px;position:relative;">
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">🔍 Search Product</label>
        <input type="text" id="ctProductSearch" class="search-input" placeholder="Type product name…"
          autocomplete="off" oninput="ctShowSuggestions(this.value)" onblur="setTimeout(()=>document.getElementById('ctSuggestBox').style.display='none',200)"
          style="width:100%;">
        <div id="ctSuggestBox" style="display:none;position:absolute;top:100%;left:0;right:0;background:white;border:1px solid var(--neutral-200);border-radius:8px;box-shadow:var(--shadow-lg);z-index:500;max-height:200px;overflow-y:auto;margin-top:2px;"></div>
      </div>

      <!-- Load button -->
      <div style="display:flex;gap:.5rem;align-items:flex-end;">
        <button class="btn btn-primary" onclick="ctLoadData()" style="white-space:nowrap;">
          <i class="fas fa-sync"></i> Load Data
        </button>
        <button class="btn btn-secondary" onclick="ctClearSearch()" title="Clear search">
          <i class="fas fa-times"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- ══ SUMMARY CARDS ══════════════════════════════════════════ -->
  <div id="ctSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:1rem;margin-bottom:1.5rem;"></div>

  <!-- ══ DATE RANGE PILL ════════════════════════════════════════ -->
  <div id="ctDateRangeBanner" style="display:none;background:var(--primary-50);border-left:4px solid var(--primary-500);padding:.75rem 1rem;border-radius:8px;margin-bottom:1.5rem;font-size:.875rem;color:var(--primary-700);">
    <strong>📊 Analysis Period:</strong> <span id="ctDateRangeText"></span>
  </div>

  <!-- ══ PRODUCT CARDS (each with its own bar chart) ═══════════ -->
  <div id="ctProductCards" style="display:grid;gap:1.5rem;"></div>

  <!-- ══ EMPTY STATE ══════════════════════════════════════════ -->
  <div id="ctEmptyState" style="display:none;text-align:center;padding:4rem 2rem;background:white;border-radius:16px;border:2px dashed var(--neutral-300);">
    <div style="font-size:3rem;opacity:.4;">📊</div>
    <h3 style="color:var(--neutral-600);margin-top:.75rem;">No data found</h3>
    <p style="color:var(--neutral-400);">Select a period and click Load Data, or try a different filter.</p>
  </div>

  <!-- Legacy canvas IDs kept for backward compat -->
  <canvas id="consumptionTrendChart" style="display:none;"></canvas>
  <canvas id="consumptionCostChart" style="display:none;"></canvas>
  <div id="consumptionSummary" style="display:none;"></div>
  <div id="consumptionDateRange" style="display:none;"></div>
  <div id="consumptionTableBody" style="display:none;"></div>
  <tr id="consumptionTableHeader" style="display:none;"></tr>
  <span id="consumptionCount" style="display:none;"></span>
  <h2 id="consumptionTableTitle" style="display:none;"></h2>
</div>

<!-- 💰 INVENTORY VALUATION REPORTS -->
<div id="inventoryValuation" class="content-section">

  <!-- Filter Bar -->
  <div style="background:white;border-radius:12px;padding:1.25rem 1.5rem;box-shadow:var(--shadow-sm);border:1px solid var(--neutral-200);margin-bottom:1.5rem;">
    <div style="display:flex;flex-wrap:wrap;gap:1rem;align-items:flex-end;">
      <div>
        <label style="display:block;font-size:.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">📊 View</label>
        <select id="valuationReportType" class="search-input" onchange="loadValuationReport()">
          <option value="current">Current Stock Value</option>
          <option value="cogs">Purchase History (COGS)</option>
          <option value="vendor_price">Vendor Price Comparison</option>
          <option value="category">By Category</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">🗂️ Category</label>
        <select id="valCategoryFilter" class="search-input" onchange="loadValuationReport()">
          <option value="">All Categories</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">📅 Period</label>
        <select id="valuationPeriod" class="search-input" onchange="loadValuationReport()">
          <option value="month" selected>This Month</option>
          <option value="quarter">This Quarter</option>
          <option value="year">This Year</option>
          <option value="all">All Time</option>
        </select>
      </div>
      <div>
        <label style="display:block;font-size:.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:.05em;margin-bottom:.35rem;">🔍 Search</label>
        <input type="text" id="valSearch" class="search-input" placeholder="Product name…" oninput="valApplyFilters()">
      </div>
      <div style="display:flex;gap:.5rem;align-items:flex-end;">
        <button class="btn btn-primary" onclick="loadValuationReport()"><i class="fas fa-sync"></i> Refresh</button>
        <button class="btn btn-secondary" onclick="exportValuationReport()">📥 PDF</button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div id="valuationSummary" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(190px,1fr));gap:1rem;margin-bottom:1.5rem;"></div>

  <!-- Charts Row -->
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:1.5rem;margin-bottom:1.5rem;">
    <div class="chart-container" style="background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);">
      <h3 style="font-size:.9rem;font-weight:700;color:var(--neutral-700);margin-bottom:1rem;">📊 Value by Category</h3>
      <div class="chart-wrapper"><canvas id="valuationChart"></canvas></div>
    </div>
    <div class="chart-container" style="background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);">
      <h3 style="font-size:.9rem;font-weight:700;color:var(--neutral-700);margin-bottom:1rem;">📈 Spend Over Time (Weekly)</h3>
      <div class="chart-wrapper"><canvas id="valuationTrendChart"></canvas></div>
    </div>
  </div>

  <!-- Detail Table -->
  <div style="background:white;border-radius:12px;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);overflow:hidden;">
    <div style="display:flex;justify-content:space-between;align-items:center;padding:1rem 1.25rem;border-bottom:1px solid var(--neutral-200);">
      <h2 id="valuationTableTitle" style="font-size:1rem;font-weight:700;color:var(--neutral-900);margin:0;">Valuation Details</h2>
      <span id="valuationCount" style="font-size:.8rem;color:var(--neutral-500);"></span>
    </div>
    <div style="overflow-x:auto;">
      <table class="data-table" style="margin:0;">
        <thead><tr id="valuationTableHeader"></tr></thead>
        <tbody id="valuationTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- Keep legacy select IDs -->
  <select id="valuationGroupBy" style="display:none;"><option value="category">Category</option></select>
</div>

<!-- 🎯 BUDGET TRACKING -->
<div id="budgetTracking" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Budget Period</label>
            <select id="budgetPeriod" class="search-input" onchange="loadBudgetTracking()">
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="quarterly">Quarterly</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Category</label>
           <select id="budgetCategory" class="search-input" onchange="loadBudgetTracking()">
    <option value="">All Categories</option>
    
    <optgroup label="🥬 PRODUCE">
        <option value="Fresh Vegetables">Fresh Vegetables</option>
        <option value="Fresh Fruits">Fresh Fruits</option>
        <option value="Fresh Herbs">Fresh Herbs</option>
        <option value="Mushrooms">Mushrooms</option>
        <option value="Vegetable Powders">Vegetable Powders</option>
        <option value="Sprouts & Microgreens">Sprouts & Microgreens</option>
        <option value="Exotic Produce">Exotic Produce</option>
    </optgroup>
    
    <optgroup label="🥩 BEEF">
        <option value="Beef">Beef</option>
        <option value="Ground Beef">Ground Beef</option>
        <option value="Beef Steaks">Beef Steaks</option>
        <option value="Beef Roasts">Beef Roasts</option>
    </optgroup>
    
    <optgroup label="🐖 PORK">
        <option value="Pork">Pork</option>
        <option value="Pork Belly">Pork Belly</option>
        <option value="Pork Chops">Pork Chops</option>
        <option value="Ground Pork">Ground Pork</option>
        <option value="Pork Ribs">Pork Ribs</option>
        <option value="Pork Sausage">Pork Sausage</option>
    </optgroup>
    
    <optgroup label="🐔 POULTRY">
        <option value="Poultry">Poultry</option>
        <option value="Chicken Breast">Chicken Breast</option>
        <option value="Chicken Thighs">Chicken Thighs</option>
        <option value="Whole Chicken">Whole Chicken</option>
        <option value="Chicken Wings">Chicken Wings</option>
        <option value="Duck">Duck</option>
        <option value="Turkey">Turkey</option>
    </optgroup>
    
    <optgroup label="🐑 LAMB">
        <option value="Lamb">Lamb</option>
        <option value="Lamb Chops">Lamb Chops</option>
        <option value="Ground Lamb">Ground Lamb</option>
        <option value="Leg of Lamb">Leg of Lamb</option>
    </optgroup>
    
    <optgroup label="🐟 SEAFOOD">
        <option value="Seafood">Seafood</option>
        <option value="Fresh Fish">Fresh Fish</option>
        <option value="Salmon">Salmon</option>
        <option value="White Fish">White Fish</option>
        <option value="Shellfish">Shellfish</option>
        <option value="Shrimp">Shrimp</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Squid & Octopus">Squid & Octopus</option>
    </optgroup>
    
    <optgroup label="🥛 DAIRY & EGGS">
        <option value="Milk & Cream">Milk & Cream</option>
        <option value="Cheese - Hard">Cheese - Hard</option>
        <option value="Cheese - Soft">Cheese - Soft</option>
        <option value="Cheese - Specialty">Cheese - Specialty</option>
        <option value="Butter & Margarine">Butter & Margarine</option>
        <option value="Yogurt & Sour Cream">Yogurt & Sour Cream</option>
        <option value="Eggs">Eggs</option>
    </optgroup>
    
    <optgroup label="🌾 DRY GOODS">
        <option value="Rice">Rice</option>
        <option value="Noodles & Pasta">Noodles & Pasta</option>
        <option value="Flour & Baking">Flour & Baking</option>
        <option value="Grains">Grains</option>
        <option value="Beans & Legumes">Beans & Legumes</option>
        <option value="Breadcrumbs & Coatings">Breadcrumbs & Coatings</option>
        <option value="Nuts & Specialty Items">Nuts & Specialty Items</option>
        <option value="Dried Fruits">Dried Fruits</option>
    </optgroup>
    
    <optgroup label="❄️ FROZEN">
        <option value="Frozen Vegetables">Frozen Vegetables</option>
        <option value="Frozen Fruits">Frozen Fruits</option>
        <option value="Frozen Meat">Frozen Meat</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Frozen Prepared Items">Frozen Prepared Items</option>
        <option value="Ice & Ice Cream">Ice & Ice Cream</option>
    </optgroup>
    
    <optgroup label="🥤 BEVERAGES">
        <option value="Tea">Tea</option>
        <option value="Coffee">Coffee</option>
        <option value="Soft Drinks">Soft Drinks</option>
        <option value="Alcoholic">Alcoholic</option>
        <option value="Mixers & Syrups">Mixers & Syrups</option>
    </optgroup>
    
    <optgroup label="🧂 CONDIMENTS & SEASONINGS">
        <option value="Sauces - Asian">Sauces - Asian</option>
        <option value="Sauces - Western">Sauces - Western</option>
        <option value="Sauces - Specialty">Sauces - Specialty</option>
        <option value="Oils">Oils</option>
        <option value="Vinegars">Vinegars</option>
        <option value="Spices - Whole">Spices - Whole</option>
        <option value="Spices - Ground">Spices - Ground</option>
        <option value="Spice Blends">Spice Blends</option>
        <option value="Sweeteners">Sweeteners</option>
        <option value="Cooking Ingredients">Cooking Ingredients</option>
        <option value="Candy & Mints">Candy & Mints</option>
    </optgroup>
    
    <optgroup label="🧹 CLEANING & JANITORIAL">
        <option value="Dishwashing">Dishwashing</option>
        <option value="Surface Cleaners">Surface Cleaners</option>
        <option value="Floor Care">Floor Care</option>
        <option value="AutoChlor System">AutoChlor System</option>
        <option value="Janitorial Chemicals">Janitorial Chemicals</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Disposal Supplies">Disposal Supplies</option>
        <option value="Restroom Supplies">Restroom Supplies</option>
        <option value="PPE & Gloves">PPE & Gloves</option>
    </optgroup>
    
    <optgroup label="🍽️ TO-GO & DISPOSABLE">
        <option value="Containers - Foam">Containers - Foam</option>
        <option value="Containers - Plastic">Containers - Plastic</option>
        <option value="Containers - Paper">Containers - Paper</option>
        <option value="Bags">Bags</option>
        <option value="Utensils">Utensils</option>
        <option value="Napkins & Straws">Napkins & Straws</option>
        <option value="Lids & Covers">Lids & Covers</option>
        <option value="Labels & Stickers">Labels & Stickers</option>
    </optgroup>
    
    <optgroup label="🏢 OFFICE SUPPLIES">
        <option value="Paper Products">Paper Products</option>
        <option value="Writing Instruments">Writing Instruments</option>
        <option value="Filing & Organization">Filing & Organization</option>
        <option value="Computer Supplies">Computer Supplies</option>
        <option value="Shipping Supplies">Shipping Supplies</option>
    </optgroup>
    
    <optgroup label="🍳 KITCHEN EQUIPMENT">
        <option value="Cookware">Cookware</option>
        <option value="Bakeware">Bakeware</option>
        <option value="Utensils">Utensils</option>
        <option value="Knives">Knives</option>
        <option value="Small Appliances">Small Appliances</option>
        <option value="Storage">Storage</option>
        <option value="Safety Equipment">Safety Equipment</option>
    </optgroup>
    
    <optgroup label="📦 OTHER">
        <option value="Miscellaneous">Miscellaneous</option>
        <option value="Seasonal Items">Seasonal Items</option>
        <option value="Repairs & Parts">Repairs & Parts</option>
    </optgroup>
</select>
        </div>
        <button class="btn btn-success" onclick="openSetBudgetModal()">⚙️ Set Budget</button>
    </div>
    
    <div class="analytics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Budget</div>
            <div class="metric-value" id="budgetTotal">$0.00</div>
            <div class="metric-subtitle">Current period</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Actual Spend</div>
            <div class="metric-value" id="budgetActual">$0.00</div>
            <div class="metric-subtitle">To date</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Remaining</div>
            <div class="metric-value" id="budgetRemaining">$0.00</div>
            <div class="metric-subtitle">Available</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Variance</div>
            <div class="metric-value" id="budgetVariance">0%</div>
            <div class="metric-subtitle">Over/Under</div>
        </div>
    </div>
    
    <div class="chart-container" style="margin-top: 2rem;">
        <h3>📊 Budget vs Actual Spending</h3>
        <div class="chart-wrapper"><canvas id="budgetChart"></canvas></div>
    </div>
    
    <div id="budgetAlerts" style="margin-top: 2rem;"></div>
    
    <div class="data-table-container" style="margin-top: 2rem;">
        <div class="table-header">
            <h2>Budget Details by Category</h2>
            <span id="budgetDetailsCount">0 categories</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Budget</th>
                    <th>Actual</th>
                    <th>Remaining</th>
                    <th>% Used</th>
                    <th>Forecast EOD</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="budgetDetailsBody"></tbody>
        </table>
    </div>
</div>

<!-- 🏆 VENDOR PERFORMANCE SCORECARD -->
<div id="vendorPerformance" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Time Period</label>
            <select id="performancePeriod" class="search-input" onchange="loadVendorPerformance()">
                <option value="month" selected>Last 30 Days</option>
                <option value="quarter">Last Quarter</option>
                <option value="year">Last Year</option>
            </select>
        </div>
        <div class="search-group">
            <label>Search Vendor</label>
            <input type="text" id="performanceSearch" class="search-input" placeholder="Search..." oninput="filterVendorPerformance()">
        </div>
    </div>
    
    <div id="vendorPerformanceCards"></div>
    
    <div style="display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem;">
        <div class="chart-container">
            <h3>💰 Budget vs Actual Spending</h3>
            <div class="chart-wrapper"><canvas id="vendorScoreChart"></canvas></div>
        </div>
    </div>
</div>

<!-- IMAGE GALLERY SECTION -->

<!-- ══════════════════════════════════════════════════════════════════ -->
<!-- JENG CHI REPORTS HUB — All 12 reports in one section              -->
<!-- ══════════════════════════════════════════════════════════════════ -->
<div id="rpt_vendor_analysis"  class="content-section rpt-section"></div>
<div id="rpt_cogs"             class="content-section rpt-section"></div>
<div id="rpt_price_variance"   class="content-section rpt-section"></div>
<div id="rpt_inventory_intel"  class="content-section rpt-section"></div>
<div id="rpt_top10"            class="content-section rpt-section"></div>
<div id="rpt_fast_slow"        class="content-section rpt-section"></div>
<div id="rpt_dead_stock"       class="content-section rpt-section"></div>
<div id="rpt_high_value"       class="content-section rpt-section"></div>
<div id="rpt_monthly_trend"    class="content-section rpt-section"></div>
<div id="rpt_turnover"         class="content-section rpt-section"></div>
<div id="rpt_price_volatility" class="content-section rpt-section"></div>
<div id="rpt_shrinkage"        class="content-section rpt-section"></div>
<div id="rpt_order_history"    class="content-section rpt-section"></div>
<div id="rpt_order_frequency"  class="content-section rpt-section"></div>
<div id="rpt_delivery_accuracy" class="content-section rpt-section"></div>
<div id="rpt_executive_summary" class="content-section rpt-section"></div>
<!-- Legacy stubs -->
<div id="rpt_purchase_summary" class="content-section rpt-section"></div>
<div id="rpt_vendor_spend"     class="content-section rpt-section"></div>
<div id="rpt_stock_valuation"  class="content-section rpt-section"></div>
<div id="rpt_low_stock"        class="content-section rpt-section"></div>
<div id="rpt_par_compliance"   class="content-section rpt-section"></div>
<div id="rpt_consumption"      class="content-section rpt-section"></div>
<!-- Invoice Detail Modal -->
<div id="rptInvoiceModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,.55);z-index:9000;align-items:center;justify-content:center;padding:1rem;" onclick="if(event.target===this)this.style.display='none'">
  <div style="background:white;border-radius:16px;max-width:960px;width:100%;max-height:90vh;overflow-y:auto;box-shadow:0 25px 60px rgba(0,0,0,.3);">
    <div id="rptInvoiceModalContent" style="padding:1.75rem;"></div>
  </div>
</div>

<div id="imageGallery" class="content-section">
    <div class="search-filter-bar">
        <div class="search-group" style="flex: 1;">
            <label>🔍 Search Images</label>
            <input type="text" id="imageGallerySearch" class="search-input" placeholder="Search by filename..." oninput="filterImageGallery()">
        </div>
        <div style="display: flex; align-items: flex-end; gap: 1rem;">
            <span id="imageCount" style="font-weight: 600; color: var(--neutral-700);"></span>
        </div>
    </div>

    <div style="background: linear-gradient(135deg, var(--accent-600), var(--accent-500)); padding: 1.5rem; border-radius: 12px; margin-bottom: 2rem; color: white;">
        <h2 style="margin: 0 0 0.5rem 0; font-size: 1.5rem; font-weight: 700;">📸 Product Image Gallery</h2>
        <p style="margin: 0; opacity: 0.9;">Click on any image filename to copy it - then paste it when adding products to inventory</p>
    </div>

    <div id="imageGalleryGrid" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1.5rem;">
        <!-- Images will be loaded here by JavaScript -->
    </div>
</div>

<!-- PLACE ORDER SECTION - ENHANCED -->
<!-- PLACE ORDER SECTION - ENHANCED -->
<div id="placeOrder" class="content-section">
    <!-- Auto-refresh status bar -->
    <div id="placeOrderRefreshBar" style="display:flex;align-items:center;justify-content:space-between;background:linear-gradient(90deg,var(--primary-900),var(--primary-700));color:white;padding:.5rem 1.25rem;border-radius:10px;margin-bottom:1rem;font-size:.8rem;">
        <span><i class="fas fa-rotate" style="margin-right:.4rem;animation:spin 2s linear infinite;"></i> <strong>Live Mode</strong> — auto-refreshes every 60 seconds &amp; saves instantly</span>
        <span id="placeOrderCountdown" style="font-family:var(--font-mono);background:rgba(255,255,255,.15);padding:.2rem .7rem;border-radius:6px;">⏱ 60s</span>
    </div>
    <!-- Sub-tabs -->
    <div style="background: white; padding: 0.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 2rem; display: flex; gap: 0.5rem;">
        <button class="order-sub-tab active" onclick="switchOrderTab('createOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); color: white;">
            📝 1. Create Order
        </button>
        <button class="order-sub-tab" onclick="switchOrderTab('editOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: transparent; color: var(--neutral-600);">
            ✏️ 2. Edit Order
        </button>
        <button class="order-sub-tab" onclick="switchOrderTab('finalOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: transparent; color: var(--neutral-600);">
            📊 3. Final Order & PDFs
        </button>
    </div>

    <!-- CREATE ORDER TAB -->
    <div id="createOrder" class="order-content-section active">
        <!-- Keep existing create order content -->
        <!-- Date Selection -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">📅 Order Date</label>
                    <input type="date" id="createOrderDate" class="search-input">
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">👤 Filter by User</label>
                    <select id="createUserFilter" class="search-input" onchange="loadEnhancedCreateOrder()">
                        <option value="all">— All Users —</option>
                        <option value="rony">🍳 Rony Only</option>
                        <option value="julio">📦 Julio Only</option>
                        <option value="office">🏢 Office Only</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">🏢 Filter by Vendor (optional)</label>
                    <select id="createVendorFilter" class="search-input" onchange="loadEnhancedCreateOrder()">
                        <option value="">— All Vendors —</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Enhanced Product Cards Container -->
        <div id="enhancedOrderContainer"></div>

        <!-- Submit Button -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-success" onclick="submitAndMarkOrder()" style="padding: 1rem 3rem; font-size: 1.25rem; background: var(--success-600);">
                <i class="fas fa-check-circle"></i> Submit Order
            </button>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--neutral-600);">
                This will save and mark your order as submitted
            </p>
        </div>
    </div>

    <!-- EDIT ORDER TAB (NEW) -->
    <div id="editOrder" class="order-content-section">
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">📅 Order Date</label>
                    <input type="date" id="editOrderDate" class="search-input">
                </div>
                <button class="btn btn-primary" onclick="loadEditOrder()">
                    <i class="fas fa-sync"></i> Load Order
                </button>
            </div>
        </div>

        <!-- SUBMITTED ORDERS SECTION -->
        <div style="background: white; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 2rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, var(--success-600), var(--success-500)); padding: 1.5rem; color: white;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-check-circle"></i> Submitted Orders
                    <span id="submittedCount" style="background: white; color: var(--success-700); padding: 0.375rem 1rem; border-radius: 50px; font-size: 1rem;">0</span>
                </h2>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Items that have been submitted - edit qty/vendor or delete</p>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Image</th>
                            <th style="width: 120px;">Item Code</th>
                            <th>Product</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 200px;">Vendor</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submittedOrdersBody"></tbody>
                </table>
            </div>
        </div>

        <!-- UNSUBMITTED PRODUCTS SECTION -->
        <div style="background: white; border-radius: 12px; box-shadow: var(--shadow-md); overflow: hidden;">
            <div style="background: linear-gradient(135deg, var(--warning-600), var(--warning-500)); padding: 1.5rem; color: white;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> Unsubmitted Products
                    <span id="unsubmittedCount" style="background: white; color: var(--warning-700); padding: 0.375rem 1rem; border-radius: 50px; font-size: 1rem;">0</span>
                </h2>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">In case you forgot to add something - set qty & vendor to include</p>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Image</th>
                            <th style="width: 120px;">Item Code</th>
                            <th>Product</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 200px;">Vendor</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unsubmittedProductsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Update Order Button -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-primary" onclick="updateEditedOrder()" style="padding: 1rem 3rem; font-size: 1.25rem;">
                <i class="fas fa-save"></i> Update Order
            </button>
        </div>
    </div>

    <!-- FINAL ORDER TAB (NEW) -->
    <div id="finalOrder" class="order-content-section">
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: end;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">📅 Order Date</label>
                    <input type="date" id="finalOrderDate" class="search-input">
                </div>
                <button class="btn btn-secondary" onclick="loadFinalOrderPreview()">
                    <i class="fas fa-eye"></i> Preview Order
                </button>
                <button class="btn btn-success" onclick="generateFinalPDFs()" style="background: var(--success-600);">
                    <i class="fas fa-file-pdf"></i> Generate PDFs
                </button>
            </div>
        </div>

        <!-- Vendor Summary Cards -->
        <div id="vendorSummaryContainer"></div>

        <!-- PDF Generation Section -->
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--neutral-900); margin-bottom: 0.5rem;">
                    📄 Generate Purchase Order PDFs
                </h2>
                <p style="color: var(--neutral-600); font-size: 1rem;">
                    Create professional PDF purchase orders for each vendor to download and send
                </p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 2rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">📅 Order Date</label>
                    <input type="date" id="pdfOrderDate" class="search-input">
                </div>
                <button class="btn btn-success" onclick="generateAllVendorPDFs()" style="padding: 1rem 2rem; font-size: 1.125rem;">
                    <i class="fas fa-file-pdf"></i> Generate All PDFs
                </button>
            </div>
            
            <div id="pdfGenerationResults" style="margin-top: 2rem;"></div>
        </div>
    </div>
</div>

<!-- Inventory Settings Section -->
<div id="inventorySettings" class="content-section">
    <div class="search-filter-bar">
        <div class="search-group">
            <label>🔍 Search Products</label>
            <input type="text" id="settingsSearchInput" class="search-input" placeholder="Search products..." oninput="filterInventorySettings()">
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="saveAllConversions()">
                <i class="fas fa-save"></i> Save All Settings
            </button>
        </div>
    </div>

    <div class="data-table-container">
        <div class="table-header">
            <h2>⚙️ Product Conversion Factors</h2>
            <span id="settingsCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Units per Case</th>
                    <th>Unit Type</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="settingsTableBody"></tbody>
        </table>
    </div>
</div>

    <!-- MODALS START HERE -->
    
    <!-- Item Modal -->
    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="itemModalTitle">Add Item</h2>
                <button class="modal-close" onclick="closeModal('itemModal')">×</button>
            </div>
            <div class="modal-body">
                <form id="itemForm" onsubmit="saveVendorItem(event)">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="itemProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Number *</label>
                        <input type="text" id="itemNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="itemProductImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-group">
                        <label>Vendor *</label>
                        <select id="itemVendor" class="search-input" required>
                            <option value="">-- Select Vendor --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                      <select id="itemCategory" class="search-input">
    <option value="">-- Select Category --</option>
    
    <optgroup label="🥬 PRODUCE">
        <option value="Fresh Vegetables">Fresh Vegetables</option>
        <option value="Fresh Fruits">Fresh Fruits</option>
        <option value="Fresh Herbs">Fresh Herbs</option>
        <option value="Mushrooms">Mushrooms</option>
        <option value="Vegetable Powders">Vegetable Powders</option>
        <option value="Sprouts & Microgreens">Sprouts & Microgreens</option>
        <option value="Exotic Produce">Exotic Produce</option>
    </optgroup>
    
    <optgroup label="🥩 BEEF">
        <option value="Beef">Beef</option>
        <option value="Ground Beef">Ground Beef</option>
        <option value="Beef Steaks">Beef Steaks</option>
        <option value="Beef Roasts">Beef Roasts</option>
    </optgroup>
    
    <optgroup label="🐖 PORK">
        <option value="Pork">Pork</option>
        <option value="Pork Belly">Pork Belly</option>
        <option value="Pork Chops">Pork Chops</option>
        <option value="Ground Pork">Ground Pork</option>
        <option value="Pork Ribs">Pork Ribs</option>
        <option value="Pork Sausage">Pork Sausage</option>
    </optgroup>
    
    <optgroup label="🐔 POULTRY">
        <option value="Poultry">Poultry</option>
        <option value="Chicken Breast">Chicken Breast</option>
        <option value="Chicken Thighs">Chicken Thighs</option>
        <option value="Whole Chicken">Whole Chicken</option>
        <option value="Chicken Wings">Chicken Wings</option>
        <option value="Duck">Duck</option>
        <option value="Turkey">Turkey</option>
    </optgroup>
    
    <optgroup label="🐑 LAMB">
        <option value="Lamb">Lamb</option>
        <option value="Lamb Chops">Lamb Chops</option>
        <option value="Ground Lamb">Ground Lamb</option>
        <option value="Leg of Lamb">Leg of Lamb</option>
    </optgroup>
    
    <optgroup label="🐟 SEAFOOD">
        <option value="Seafood">Seafood</option>
        <option value="Fresh Fish">Fresh Fish</option>
        <option value="Salmon">Salmon</option>
        <option value="White Fish">White Fish</option>
        <option value="Shellfish">Shellfish</option>
        <option value="Shrimp">Shrimp</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Squid & Octopus">Squid & Octopus</option>
    </optgroup>
    
    <optgroup label="🥛 DAIRY & EGGS">
        <option value="Milk & Cream">Milk & Cream</option>
        <option value="Cheese - Hard">Cheese - Hard</option>
        <option value="Cheese - Soft">Cheese - Soft</option>
        <option value="Cheese - Specialty">Cheese - Specialty</option>
        <option value="Butter & Margarine">Butter & Margarine</option>
        <option value="Yogurt & Sour Cream">Yogurt & Sour Cream</option>
        <option value="Eggs">Eggs</option>
    </optgroup>
    
    <optgroup label="🌾 DRY GOODS">
        <option value="Rice">Rice</option>
        <option value="Noodles & Pasta">Noodles & Pasta</option>
        <option value="Flour & Baking">Flour & Baking</option>
        <option value="Grains">Grains</option>
        <option value="Beans & Legumes">Beans & Legumes</option>
        <option value="Breadcrumbs & Coatings">Breadcrumbs & Coatings</option>
        <option value="Nuts & Specialty Items">Nuts & Specialty Items</option>
        <option value="Dried Fruits">Dried Fruits</option>
    </optgroup>
    
    <optgroup label="❄️ FROZEN">
        <option value="Frozen Vegetables">Frozen Vegetables</option>
        <option value="Frozen Fruits">Frozen Fruits</option>
        <option value="Frozen Meat">Frozen Meat</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Frozen Prepared Items">Frozen Prepared Items</option>
        <option value="Ice & Ice Cream">Ice & Ice Cream</option>
    </optgroup>
    
    <optgroup label="🥤 BEVERAGES">
        <option value="Tea">Tea</option>
        <option value="Coffee">Coffee</option>
        <option value="Soft Drinks">Soft Drinks</option>
        <option value="Alcoholic">Alcoholic</option>
        <option value="Mixers & Syrups">Mixers & Syrups</option>
    </optgroup>
    
    <optgroup label="🧂 CONDIMENTS & SEASONINGS">
        <option value="Sauces - Asian">Sauces - Asian</option>
        <option value="Sauces - Western">Sauces - Western</option>
        <option value="Sauces - Specialty">Sauces - Specialty</option>
        <option value="Oils">Oils</option>
        <option value="Vinegars">Vinegars</option>
        <option value="Spices - Whole">Spices - Whole</option>
        <option value="Spices - Ground">Spices - Ground</option>
        <option value="Spice Blends">Spice Blends</option>
        <option value="Sweeteners">Sweeteners</option>
        <option value="Cooking Ingredients">Cooking Ingredients</option>
        <option value="Candy & Mints">Candy & Mints</option>
    </optgroup>
    
    <optgroup label="🧹 CLEANING & JANITORIAL">
        <option value="Dishwashing">Dishwashing</option>
        <option value="Surface Cleaners">Surface Cleaners</option>
        <option value="Floor Care">Floor Care</option>
        <option value="AutoChlor System">AutoChlor System</option>
        <option value="Janitorial Chemicals">Janitorial Chemicals</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Disposal Supplies">Disposal Supplies</option>
        <option value="Restroom Supplies">Restroom Supplies</option>
        <option value="PPE & Gloves">PPE & Gloves</option>
    </optgroup>
    
    <optgroup label="🍽️ TO-GO & DISPOSABLE">
        <option value="Containers - Foam">Containers - Foam</option>
        <option value="Containers - Plastic">Containers - Plastic</option>
        <option value="Containers - Paper">Containers - Paper</option>
        <option value="Bags">Bags</option>
        <option value="Utensils">Utensils</option>
        <option value="Napkins & Straws">Napkins & Straws</option>
        <option value="Lids & Covers">Lids & Covers</option>
        <option value="Labels & Stickers">Labels & Stickers</option>
    </optgroup>
    
    <optgroup label="🏢 OFFICE SUPPLIES">
        <option value="Paper Products">Paper Products</option>
        <option value="Writing Instruments">Writing Instruments</option>
        <option value="Filing & Organization">Filing & Organization</option>
        <option value="Computer Supplies">Computer Supplies</option>
        <option value="Shipping Supplies">Shipping Supplies</option>
    </optgroup>
    
    <optgroup label="🍳 KITCHEN EQUIPMENT">
        <option value="Cookware">Cookware</option>
        <option value="Bakeware">Bakeware</option>
        <option value="Utensils">Utensils</option>
        <option value="Knives">Knives</option>
        <option value="Small Appliances">Small Appliances</option>
        <option value="Storage">Storage</option>
        <option value="Safety Equipment">Safety Equipment</option>
    </optgroup>
    
    <optgroup label="📦 OTHER">
        <option value="Miscellaneous">Miscellaneous</option>
        <option value="Seasonal Items">Seasonal Items</option>
        <option value="Repairs & Parts">Repairs & Parts</option>
    </optgroup>
</select>
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="itemHasWeight" onchange="toggleWeightFields()">
                            Sold by Weight (instead of quantity)
                        </label>
                    </div>
                    
                    <!-- Quantity fields (shown when NOT sold by weight) -->
                    <div id="quantityFields">
                        <div class="form-group">
                            <label>Quantity *</label>
                            <input type="number" id="itemQuantity" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label>Price per Unit *</label>
                            <input type="number" id="itemPrice" step="0.01" required>
                        </div>
                    </div>
                    
                    <!-- Weight fields (shown when sold by weight) -->
                    <div id="weightFields" style="display: none;">
                        <div class="form-group">
                            <label>Weight (lbs) *</label>
                            <input type="number" id="itemWeight" step="0.01" min="0.01">
                        </div>
                        <div class="form-group">
                            <label>Price per Pound *</label>
                            <input type="number" id="itemPricePerUnit" step="0.01">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Purchase Date *</label>
                        <input type="date" id="itemEffectiveDate" required>
                    </div>
                    <div class="form-group" id="invoiceSelectGroup" style="display: none;">
                        <label>Select Invoice *</label>
                        <select id="itemInvoiceId" class="search-input">
                            <option value="">-- Select Invoice --</option>
                        </select>
                        <small style="color: var(--neutral-500); font-size: 0.8125rem;">Choose which invoice this item belongs to</small>
                    </div>
                    <div class="form-group">
                        <label>Assign To</label>
                        <select id="itemAssignedTo" class="search-input" multiple style="height: 120px;">
                            <option value="rony">Rony</option>
                            <option value="julio">Julio</option>
                            <option value="office">Office</option>
                        </select>
                        <small style="color: var(--neutral-500); font-size: 0.8125rem;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Edit Modal -->
    <div class="modal-overlay" id="quickEditModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="quickEditModalTitle">Quick Edit Product</h2>
                <button class="modal-close" onclick="closeModal('quickEditModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i>
                    <span>Editing this product will update <strong id="affectedCount">0</strong> matching items in the database.</span>
                </div>
                <form id="quickEditForm" onsubmit="saveQuickEditInvoice(event)">
                    <input type="hidden" id="quickEditItemCode">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="quickEditProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Code * <span style="color: var(--warning-600); font-size: 0.75rem;">(Protected - Cannot Edit)</span></label>
                        <input type="text" id="quickEditItemCodeDisplay" readonly class="search-input" style="background: var(--neutral-100); cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Assigned To</label>
                        <select id="quickEditAssignedTo" class="search-input">
                            <option value="">-- Unassigned --</option>
                            <option value="rony">Rony</option>
                            <option value="julio">Julio</option>
                            <option value="office">Office</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Vendor *</label>
                        <input type="text" id="quickEditVendor" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                       <select id="quickEditCategory" class="search-input">
    <option value="">-- Select Category --</option>
    
    <optgroup label="🥬 PRODUCE">
        <option value="Fresh Vegetables">Fresh Vegetables</option>
        <option value="Fresh Fruits">Fresh Fruits</option>
        <option value="Fresh Herbs">Fresh Herbs</option>
        <option value="Mushrooms">Mushrooms</option>
        <option value="Vegetable Powders">Vegetable Powders</option>
        <option value="Sprouts & Microgreens">Sprouts & Microgreens</option>
        <option value="Exotic Produce">Exotic Produce</option>
    </optgroup>
    
    <optgroup label="🥩 BEEF">
        <option value="Beef">Beef</option>
        <option value="Ground Beef">Ground Beef</option>
        <option value="Beef Steaks">Beef Steaks</option>
        <option value="Beef Roasts">Beef Roasts</option>
    </optgroup>
    
    <optgroup label="🐖 PORK">
        <option value="Pork">Pork</option>
        <option value="Pork Belly">Pork Belly</option>
        <option value="Pork Chops">Pork Chops</option>
        <option value="Ground Pork">Ground Pork</option>
        <option value="Pork Ribs">Pork Ribs</option>
        <option value="Pork Sausage">Pork Sausage</option>
    </optgroup>
    
    <optgroup label="🐔 POULTRY">
        <option value="Poultry">Poultry</option>
        <option value="Chicken Breast">Chicken Breast</option>
        <option value="Chicken Thighs">Chicken Thighs</option>
        <option value="Whole Chicken">Whole Chicken</option>
        <option value="Chicken Wings">Chicken Wings</option>
        <option value="Duck">Duck</option>
        <option value="Turkey">Turkey</option>
    </optgroup>
    
    <optgroup label="🐑 LAMB">
        <option value="Lamb">Lamb</option>
        <option value="Lamb Chops">Lamb Chops</option>
        <option value="Ground Lamb">Ground Lamb</option>
        <option value="Leg of Lamb">Leg of Lamb</option>
    </optgroup>
    
    <optgroup label="🐟 SEAFOOD">
        <option value="Seafood">Seafood</option>
        <option value="Fresh Fish">Fresh Fish</option>
        <option value="Salmon">Salmon</option>
        <option value="White Fish">White Fish</option>
        <option value="Shellfish">Shellfish</option>
        <option value="Shrimp">Shrimp</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Squid & Octopus">Squid & Octopus</option>
    </optgroup>
    
    <optgroup label="🥛 DAIRY & EGGS">
        <option value="Milk & Cream">Milk & Cream</option>
        <option value="Cheese - Hard">Cheese - Hard</option>
        <option value="Cheese - Soft">Cheese - Soft</option>
        <option value="Cheese - Specialty">Cheese - Specialty</option>
        <option value="Butter & Margarine">Butter & Margarine</option>
        <option value="Yogurt & Sour Cream">Yogurt & Sour Cream</option>
        <option value="Eggs">Eggs</option>
    </optgroup>
    
    <optgroup label="🌾 DRY GOODS">
        <option value="Rice">Rice</option>
        <option value="Noodles & Pasta">Noodles & Pasta</option>
        <option value="Flour & Baking">Flour & Baking</option>
        <option value="Grains">Grains</option>
        <option value="Beans & Legumes">Beans & Legumes</option>
        <option value="Breadcrumbs & Coatings">Breadcrumbs & Coatings</option>
        <option value="Nuts & Specialty Items">Nuts & Specialty Items</option>
        <option value="Dried Fruits">Dried Fruits</option>
    </optgroup>
    
    <optgroup label="❄️ FROZEN">
        <option value="Frozen Vegetables">Frozen Vegetables</option>
        <option value="Frozen Fruits">Frozen Fruits</option>
        <option value="Frozen Meat">Frozen Meat</option>
        <option value="Frozen Seafood">Frozen Seafood</option>
        <option value="Frozen Prepared Items">Frozen Prepared Items</option>
        <option value="Ice & Ice Cream">Ice & Ice Cream</option>
    </optgroup>
    
    <optgroup label="🥤 BEVERAGES">
        <option value="Tea">Tea</option>
        <option value="Coffee">Coffee</option>
        <option value="Soft Drinks">Soft Drinks</option>
        <option value="Alcoholic">Alcoholic</option>
        <option value="Mixers & Syrups">Mixers & Syrups</option>
    </optgroup>
    
    <optgroup label="🧂 CONDIMENTS & SEASONINGS">
        <option value="Sauces - Asian">Sauces - Asian</option>
        <option value="Sauces - Western">Sauces - Western</option>
        <option value="Sauces - Specialty">Sauces - Specialty</option>
        <option value="Oils">Oils</option>
        <option value="Vinegars">Vinegars</option>
        <option value="Spices - Whole">Spices - Whole</option>
        <option value="Spices - Ground">Spices - Ground</option>
        <option value="Spice Blends">Spice Blends</option>
        <option value="Sweeteners">Sweeteners</option>
        <option value="Cooking Ingredients">Cooking Ingredients</option>
        <option value="Candy & Mints">Candy & Mints</option>
    </optgroup>
    
    <optgroup label="🧹 CLEANING & JANITORIAL">
        <option value="Dishwashing">Dishwashing</option>
        <option value="Surface Cleaners">Surface Cleaners</option>
        <option value="Floor Care">Floor Care</option>
        <option value="AutoChlor System">AutoChlor System</option>
        <option value="Janitorial Chemicals">Janitorial Chemicals</option>
        <option value="Maintenance">Maintenance</option>
        <option value="Disposal Supplies">Disposal Supplies</option>
        <option value="Restroom Supplies">Restroom Supplies</option>
        <option value="PPE & Gloves">PPE & Gloves</option>
    </optgroup>
    
    <optgroup label="🍽️ TO-GO & DISPOSABLE">
        <option value="Containers - Foam">Containers - Foam</option>
        <option value="Containers - Plastic">Containers - Plastic</option>
        <option value="Containers - Paper">Containers - Paper</option>
        <option value="Bags">Bags</option>
        <option value="Utensils">Utensils</option>
        <option value="Napkins & Straws">Napkins & Straws</option>
        <option value="Lids & Covers">Lids & Covers</option>
        <option value="Labels & Stickers">Labels & Stickers</option>
    </optgroup>
    
    <optgroup label="🏢 OFFICE SUPPLIES">
        <option value="Paper Products">Paper Products</option>
        <option value="Writing Instruments">Writing Instruments</option>
        <option value="Filing & Organization">Filing & Organization</option>
        <option value="Computer Supplies">Computer Supplies</option>
        <option value="Shipping Supplies">Shipping Supplies</option>
    </optgroup>
    
    <optgroup label="🍳 KITCHEN EQUIPMENT">
        <option value="Cookware">Cookware</option>
        <option value="Bakeware">Bakeware</option>
        <option value="Utensils">Utensils</option>
        <option value="Knives">Knives</option>
        <option value="Small Appliances">Small Appliances</option>
        <option value="Storage">Storage</option>
        <option value="Safety Equipment">Safety Equipment</option>
    </optgroup>
    
    <optgroup label="📦 OTHER">
        <option value="Miscellaneous">Miscellaneous</option>
        <option value="Seasonal Items">Seasonal Items</option>
        <option value="Repairs & Parts">Repairs & Parts</option>
    </optgroup>
</select>
                    </div>
                    <div class="form-group">
                        <label>Price * <span style="color: var(--warning-600); font-size: 0.75rem;">(Protected - Cannot Edit)</span></label>
                        <input type="number" id="quickEditPrice" step="0.01" readonly style="background: var(--neutral-100); cursor: not-allowed;">
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="quickEditImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('quickEditModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update All Matching Items
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ENHANCED INVOICE MODAL WITH WEIGHT & PRICE PER UNIT -->
    <div class="modal-overlay" id="invoiceModal" style="align-items:flex-start;padding-top:40px;">
      <div id="invoiceModalBox" class="modal" style="max-width:1100px;max-height:95vh;overflow:hidden;background:#f8fafc;border-radius:12px;box-shadow:0 20px 60px rgba(0,0,0,0.35);position:fixed;top:40px;left:50%;transform:translateX(-50%);">
            <!-- COMPACT DRAGGABLE HEADER -->
            <div id="invoiceModalDragHandle" style="background:linear-gradient(135deg,var(--primary-700),var(--primary-600));padding:0 0.9rem;color:white;border-radius:12px 12px 0 0;display:flex;justify-content:space-between;align-items:center;height:40px;cursor:grab;user-select:none;-webkit-user-select:none;" title="Drag to reposition">
                <div style="display:flex;align-items:center;gap:0.5rem;pointer-events:none;">
                    <i class="fas fa-grip-horizontal" style="opacity:0.45;font-size:0.7rem;"></i>
                    <span style="font-size:0.68rem;text-transform:uppercase;letter-spacing:0.1em;opacity:0.75;">📄 Invoice Management</span>
                    <span style="opacity:0.3;font-size:0.75rem;">|</span>
                    <h2 id="invoiceModalTitle" style="font-size:0.9rem;font-weight:700;margin:0;">Add New Invoice</h2>
                </div>
                <button class="modal-close" onclick="closeModal('invoiceModal')" style="width:26px;height:26px;border-radius:50%;background:rgba(255,255,255,0.2);color:white;border:1px solid rgba(255,255,255,0.3);font-size:1rem;display:flex;align-items:center;justify-content:center;cursor:pointer;flex-shrink:0;line-height:1;" onmouseover="this.style.background='rgba(255,255,255,0.4)'" onmouseout="this.style.background='rgba(255,255,255,0.2)'">×</button>
            </div>
            
            <!-- MODAL BODY -->
            <div class="modal-body" style="max-height:calc(95vh - 42px);overflow-y:auto;background:#f8fafc;padding:0.45rem 0.7rem 0.7rem;">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">

                    <!-- SECTION 1: compact single row -->
                    <div style="background:white;border-radius:7px;padding:0.4rem 0.65rem;margin-bottom:0.45rem;box-shadow:0 1px 3px rgba(0,0,0,0.06);border:1px solid #e2e8f0;">
                        <div style="display:grid;grid-template-columns:1.8fr 1fr 1fr 1fr auto auto;gap:0.45rem;align-items:end;">
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;"><i class="fas fa-building" style="color:var(--primary-400);margin-right:0.2rem;"></i>Vendor *</label>
                                <select id="invoiceVendorDropdown" class="search-input" required onchange="updateInvoiceVendorField()" style="width:100%;padding:0.3rem 0.5rem;border:1.5px solid #e2e8f0;border-radius:5px;font-size:0.82rem;background:white;" onfocus="this.style.borderColor='var(--primary-400)'" onblur="this.style.borderColor='#e2e8f0'">
                                    <option value="">-- Select Vendor --</option>
                                </select>
                            </div>
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;"><i class="fas fa-hashtag" style="color:var(--primary-400);margin-right:0.2rem;"></i>Invoice # *</label>
                                <input type="text" id="invoiceNumber" required oninput="validateInvoiceNumber(this.value)" autocomplete="off" style="width:100%;padding:0.3rem 0.5rem;border:1.5px solid #e2e8f0;border-radius:5px;font-size:0.82rem;" onfocus="this.style.borderColor='var(--primary-400)'" onblur="this.style.borderColor='#e2e8f0'">
                                <div id="invoiceNumberValidation" style="font-size:0.66rem;margin-top:0.08rem;"></div>
                            </div>
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;"><i class="fas fa-money-check" style="color:var(--primary-400);margin-right:0.2rem;"></i>Check #</label>
                                <input type="text" id="invoiceCheckNumber" placeholder="CHK-12345" style="width:100%;padding:0.3rem 0.5rem;border:1.5px solid #e2e8f0;border-radius:5px;font-size:0.82rem;" onfocus="this.style.borderColor='var(--primary-400)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;"><i class="fas fa-calendar" style="color:var(--primary-400);margin-right:0.2rem;"></i>Date *</label>
                                <input type="date" id="invoiceDate" required style="width:100%;padding:0.3rem 0.5rem;border:1.5px solid #e2e8f0;border-radius:5px;font-size:0.82rem;" onfocus="this.style.borderColor='var(--primary-400)'" onblur="this.style.borderColor='#e2e8f0'">
                            </div>
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;">Items</label>
                                <input type="text" id="invoiceItemsCount" readonly style="width:68px;padding:0.3rem 0.4rem;background:var(--primary-100);font-weight:700;font-size:0.82rem;color:var(--primary-600);text-align:center;border:1.5px solid var(--primary-200);border-radius:5px;">
                            </div>
                            <div>
                                <label style="font-weight:700;color:#475569;font-size:0.67rem;display:block;margin-bottom:0.12rem;text-transform:uppercase;letter-spacing:0.04em;">Tax 8.25%</label>
                                <label style="display:inline-flex;align-items:center;gap:0.28rem;cursor:pointer;height:28px;">
                                    <input type="checkbox" id="invoiceTaxEnabled" checked onchange="calculateInvoiceTotals()" style="width:14px;height:14px;accent-color:var(--primary-600);cursor:pointer;">
                                    <span style="font-size:0.76rem;font-weight:700;color:var(--primary-600);">Apply</span>
                                </label>
                            </div>
                        </div>
                        <div style="margin-top:0.3rem;">
                            <textarea id="invoiceNotes" rows="1" placeholder="Notes (optional)..." style="width:100%;padding:0.25rem 0.5rem;border:1.5px solid #e2e8f0;border-radius:5px;font-size:0.76rem;resize:vertical;min-height:24px;font-family:inherit;" onfocus="this.style.borderColor='var(--primary-400)'" onblur="this.style.borderColor='#e2e8f0'"></textarea>
                        </div>
                    </div>

                    <!-- SECTION 2: PRODUCTS -->
                    <div style="background:white;border-radius:7px;padding:0.45rem 0.65rem 0.65rem;margin-bottom:0.45rem;box-shadow:0 1px 3px rgba(0,0,0,0.06);border:1px solid #e2e8f0;">
                        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.38rem;padding-bottom:0.32rem;border-bottom:1.5px solid #e2e8f0;">
                            <h3 style="font-size:0.82rem;font-weight:700;color:#1e293b;margin:0;display:flex;align-items:center;gap:0.32rem;">
                                <span style="display:inline-flex;align-items:center;justify-content:center;width:19px;height:19px;background:linear-gradient(135deg,var(--primary-400),var(--primary-500));color:white;border-radius:4px;font-size:0.66rem;">2</span>
                                Invoice Products
                                <span id="autoSaveIndicator" style="font-size:0.63rem;color:#059669;font-weight:500;opacity:0;transition:opacity 0.3s;margin-left:0.2rem;">✓ Saved</span>
                            </h3>
                            <div style="display:flex;align-items:center;gap:0.45rem;">
                                <span id="invoiceProductCount" style="color:#64748b;font-weight:600;font-size:0.72rem;padding:0.18rem 0.45rem;background:#f1f5f9;border-radius:4px;">0 items</span>
                                <button type="button" onclick="toggleNewItemPanel()" style="padding:0.25rem 0.6rem;background:linear-gradient(135deg,#059669,#047857);border:none;color:white;border-radius:5px;font-weight:700;font-size:0.72rem;cursor:pointer;display:flex;align-items:center;gap:0.28rem;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                                    <i class="fas fa-plus-circle"></i> New Item
                                </button>
                                <button type="button" onclick="toggleProductSearch()" style="padding:0.25rem 0.6rem;background:linear-gradient(135deg,var(--primary-400),var(--primary-500));border:none;color:white;border-radius:5px;font-weight:700;font-size:0.72rem;cursor:pointer;display:flex;align-items:center;gap:0.28rem;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                                    <i class="fas fa-search"></i> Add Item
                                </button>
                            </div>
                        </div>

                        <!-- ADD NEW ITEM PANEL -->
                        <div id="newItemPanel" style="display:none;margin-bottom:0.45rem;padding:0.55rem 0.65rem;background:linear-gradient(135deg,#f0fdf4,#dcfce7);border-radius:7px;border:1.5px solid #86efac;">
                            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.35rem;">
                                <div style="font-size:0.72rem;font-weight:700;color:#166534;"><i class="fas fa-plus-circle"></i> Add New Item to Catalog &amp; Invoice <span style="font-size:0.65rem;font-weight:500;color:#15803d;margin-left:0.4rem;">(panel stays open — keep adding!)</span></div>
                                <button type="button" onclick="toggleNewItemPanel()" style="background:none;border:none;color:#166534;cursor:pointer;font-size:0.78rem;padding:0;" title="Close panel"><i class="fas fa-times-circle"></i></button>
                            </div>
                            <!-- Row 1: Code + Name + Category + Assign To -->
                            <div style="display:grid;grid-template-columns:0.85fr 2fr 1.6fr 1fr;gap:0.38rem;align-items:end;margin-bottom:0.32rem;">
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Item Code</label>
                                    <input type="text" id="newItemCode" placeholder="EFF182" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;font-family:var(--font-mono);" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Product Name *</label>
                                    <input type="text" id="newItemName" placeholder="e.g. Cutter Box Film 18&quot; x 2000" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Category *</label>
                                    <select id="newItemCategory" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;background:white;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                        <option value="">-- Select Category --</option>
                                        <optgroup label="🥬 PRODUCE">
                                            <option value="Fresh Vegetables">Fresh Vegetables</option>
                                            <option value="Fresh Fruits">Fresh Fruits</option>
                                            <option value="Fresh Herbs">Fresh Herbs</option>
                                            <option value="Mushrooms">Mushrooms</option>
                                            <option value="Vegetable Powders">Vegetable Powders</option>
                                            <option value="Sprouts &amp; Microgreens">Sprouts &amp; Microgreens</option>
                                            <option value="Exotic Produce">Exotic Produce</option>
                                        </optgroup>
                                        <optgroup label="🥩 BEEF">
                                            <option value="Beef">Beef (All)</option>
                                            <option value="Ground Beef">Ground Beef</option>
                                            <option value="Beef Steaks">Beef Steaks</option>
                                            <option value="Beef Roasts">Beef Roasts</option>
                                        </optgroup>
                                        <optgroup label="🐖 PORK">
                                            <option value="Pork">Pork (All)</option>
                                            <option value="Pork Belly">Pork Belly</option>
                                            <option value="Pork Chops">Pork Chops</option>
                                            <option value="Ground Pork">Ground Pork</option>
                                            <option value="Pork Ribs">Pork Ribs</option>
                                            <option value="Pork Sausage">Pork Sausage</option>
                                        </optgroup>
                                        <optgroup label="🐔 POULTRY">
                                            <option value="Poultry">Poultry (All)</option>
                                            <option value="Chicken Breast">Chicken Breast</option>
                                            <option value="Chicken Thighs">Chicken Thighs</option>
                                            <option value="Whole Chicken">Whole Chicken</option>
                                            <option value="Chicken Wings">Chicken Wings</option>
                                            <option value="Duck">Duck</option>
                                            <option value="Turkey">Turkey</option>
                                        </optgroup>
                                        <optgroup label="🐑 LAMB">
                                            <option value="Lamb">Lamb (All)</option>
                                            <option value="Lamb Chops">Lamb Chops</option>
                                            <option value="Ground Lamb">Ground Lamb</option>
                                            <option value="Leg of Lamb">Leg of Lamb</option>
                                        </optgroup>
                                        <optgroup label="🐟 SEAFOOD">
                                            <option value="Seafood">Seafood (All)</option>
                                            <option value="Fresh Fish">Fresh Fish</option>
                                            <option value="Salmon">Salmon</option>
                                            <option value="White Fish">White Fish</option>
                                            <option value="Shellfish">Shellfish</option>
                                            <option value="Shrimp">Shrimp</option>
                                            <option value="Frozen Seafood">Frozen Seafood</option>
                                            <option value="Squid &amp; Octopus">Squid &amp; Octopus</option>
                                        </optgroup>
                                        <optgroup label="🥛 DAIRY &amp; EGGS">
                                            <option value="Milk &amp; Cream">Milk &amp; Cream</option>
                                            <option value="Cheese - Hard">Cheese - Hard</option>
                                            <option value="Cheese - Soft">Cheese - Soft</option>
                                            <option value="Cheese - Specialty">Cheese - Specialty</option>
                                            <option value="Butter &amp; Margarine">Butter &amp; Margarine</option>
                                            <option value="Yogurt &amp; Sour Cream">Yogurt &amp; Sour Cream</option>
                                            <option value="Eggs">Eggs</option>
                                        </optgroup>
                                        <optgroup label="🌾 DRY GOODS">
                                            <option value="Rice">Rice</option>
                                            <option value="Noodles &amp; Pasta">Noodles &amp; Pasta</option>
                                            <option value="Flour &amp; Baking">Flour &amp; Baking</option>
                                            <option value="Grains">Grains</option>
                                            <option value="Beans &amp; Legumes">Beans &amp; Legumes</option>
                                            <option value="Breadcrumbs &amp; Coatings">Breadcrumbs &amp; Coatings</option>
                                            <option value="Nuts &amp; Specialty Items">Nuts &amp; Specialty Items</option>
                                            <option value="Dried Fruits">Dried Fruits</option>
                                        </optgroup>
                                        <optgroup label="❄️ FROZEN">
                                            <option value="Frozen Vegetables">Frozen Vegetables</option>
                                            <option value="Frozen Fruits">Frozen Fruits</option>
                                            <option value="Frozen Meat">Frozen Meat</option>
                                            <option value="Frozen Seafood">Frozen Seafood</option>
                                            <option value="Frozen Prepared Items">Frozen Prepared Items</option>
                                            <option value="Ice &amp; Ice Cream">Ice &amp; Ice Cream</option>
                                        </optgroup>
                                        <optgroup label="🥤 BEVERAGES">
                                            <option value="Tea">Tea</option>
                                            <option value="Coffee">Coffee</option>
                                            <option value="Soft Drinks">Soft Drinks</option>
                                            <option value="Alcoholic">Alcoholic</option>
                                            <option value="Mixers &amp; Syrups">Mixers &amp; Syrups</option>
                                        </optgroup>
                                        <optgroup label="🧂 CONDIMENTS &amp; SEASONINGS">
                                            <option value="Sauces - Asian">Sauces - Asian</option>
                                            <option value="Sauces - Western">Sauces - Western</option>
                                            <option value="Sauces - Specialty">Sauces - Specialty</option>
                                            <option value="Oils">Oils</option>
                                            <option value="Vinegars">Vinegars</option>
                                            <option value="Spices - Whole">Spices - Whole</option>
                                            <option value="Spices - Ground">Spices - Ground</option>
                                            <option value="Spice Blends">Spice Blends</option>
                                            <option value="Sweeteners">Sweeteners</option>
                                            <option value="Cooking Ingredients">Cooking Ingredients</option>
                                        </optgroup>
                                        <optgroup label="🧹 CLEANING &amp; JANITORIAL">
                                            <option value="Dishwashing">Dishwashing</option>
                                            <option value="Surface Cleaners">Surface Cleaners</option>
                                            <option value="Floor Care">Floor Care</option>
                                            <option value="AutoChlor System">AutoChlor System</option>
                                            <option value="Janitorial Chemicals">Janitorial Chemicals</option>
                                            <option value="Maintenance">Maintenance</option>
                                            <option value="Disposal Supplies">Disposal Supplies</option>
                                            <option value="Restroom Supplies">Restroom Supplies</option>
                                            <option value="PPE &amp; Gloves">PPE &amp; Gloves</option>
                                        </optgroup>
                                        <optgroup label="🍽️ TO-GO &amp; DISPOSABLE">
                                            <option value="Containers - Foam">Containers - Foam</option>
                                            <option value="Containers - Plastic">Containers - Plastic</option>
                                            <option value="Containers - Paper">Containers - Paper</option>
                                            <option value="Bags">Bags</option>
                                            <option value="Utensils">Utensils</option>
                                            <option value="Napkins &amp; Straws">Napkins &amp; Straws</option>
                                            <option value="Lids &amp; Covers">Lids &amp; Covers</option>
                                            <option value="Labels &amp; Stickers">Labels &amp; Stickers</option>
                                        </optgroup>
                                        <optgroup label="🏢 OFFICE SUPPLIES">
                                            <option value="Paper Products">Paper Products</option>
                                            <option value="Writing Instruments">Writing Instruments</option>
                                            <option value="Filing &amp; Organization">Filing &amp; Organization</option>
                                            <option value="Computer Supplies">Computer Supplies</option>
                                            <option value="Shipping Supplies">Shipping Supplies</option>
                                        </optgroup>
                                        <optgroup label="🍳 KITCHEN EQUIPMENT">
                                            <option value="Cookware">Cookware</option>
                                            <option value="Bakeware">Bakeware</option>
                                            <option value="Knives">Knives</option>
                                            <option value="Small Appliances">Small Appliances</option>
                                            <option value="Storage">Storage</option>
                                        </optgroup>
                                    </select>
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Assign To</label>
                                    <select id="newItemAssignTo" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;background:white;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                        <option value="">-- Unassigned --</option>
                                        <option value="rony">🍳 Rony</option>
                                        <option value="julio">🛒 Julio</option>
                                        <option value="office">🏢 Office</option>
                                    </select>
                                </div>
                            </div>
                            <!-- Row 2: Image URL + Qty + Price + Weight + Save -->
                            <div style="display:grid;grid-template-columns:2fr 0.55fr 0.7fr auto auto;gap:0.38rem;align-items:end;">
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Image URL <span style="font-weight:400;text-transform:none;">(optional)</span></label>
                                    <input type="text" id="newItemImage" placeholder="https://..." style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Qty</label>
                                    <input type="number" id="newItemQty" value="1" min="1" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;text-align:center;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">Price *</label>
                                    <input type="number" id="newItemPrice" min="0" step="0.01" placeholder="0.00" style="width:100%;padding:0.28rem 0.42rem;border:1.5px solid #86efac;border-radius:4px;font-size:0.76rem;text-align:right;" onfocus="this.style.borderColor='#16a34a'" onblur="this.style.borderColor='#86efac'">
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;text-transform:uppercase;">⚖ Wt?</label>
                                    <label style="display:inline-flex;align-items:center;justify-content:center;cursor:pointer;height:27px;gap:0.22rem;">
                                        <input type="checkbox" id="newItemIsWeight" style="width:14px;height:14px;cursor:pointer;accent-color:#16a34a;">
                                        <span style="font-size:0.7rem;color:#166534;font-weight:600;">lbs</span>
                                    </label>
                                </div>
                                <div>
                                    <label style="font-size:0.63rem;font-weight:700;color:#166534;display:block;margin-bottom:0.1rem;">&nbsp;</label>
                                    <button type="button" onclick="saveNewItemAndAddToInvoice()" style="padding:0.28rem 0.8rem;background:linear-gradient(135deg,#059669,#047857);border:none;color:white;border-radius:4px;font-size:0.76rem;font-weight:700;cursor:pointer;white-space:nowrap;height:27px;" onmouseover="this.style.opacity='0.85'" onmouseout="this.style.opacity='1'">
                                        <i class="fas fa-save"></i> Save &amp; Add
                                    </button>
                                </div>
                            </div>
                            <div id="newItemStatus" style="margin-top:0.35rem;font-size:0.75rem;"></div>
                        </div>

<!-- Search Section -->
                        <div id="productSearchSection" style="display:none;margin-bottom:0.45rem;padding:0.6rem 0.65rem;background:linear-gradient(135deg,#eff6ff,var(--primary-100));border-radius:7px;border:1.5px solid var(--primary-200);">
                            <label style="font-weight:600;color:var(--primary-600);font-size:0.76rem;margin-bottom:0.22rem;display:block;">🔍 Search Products (by name or item code)</label>
                            <input type="text" id="invoiceProductSearch" class="search-input" placeholder="Type to search products..." oninput="searchInvoiceProducts()" style="width:100%;padding:0.42rem 0.6rem;border:1.5px solid var(--primary-200);border-radius:6px;font-size:0.84rem;background:white;">
                            <div id="invoiceProductResults" style="max-height:210px;overflow-y:auto;border:1.5px solid #cbd5e1;border-radius:6px;padding:0.5rem;background:white;display:none;margin-top:0.4rem;"></div>
                        </div>

                        <!-- Selected Products table -->
                        <div id="selectedInvoiceProducts" style="display:grid;gap:0.4rem;margin-bottom:0.5rem;"></div>

                        <!-- Invoice Totals — compact -->
                        <div id="invoiceTotalsSection" style="background:linear-gradient(135deg,#f8fafc,#f1f5f9);padding:0.55rem 0.75rem;border-radius:7px;border:1.5px solid #cbd5e1;">
                            <div style="display:grid;grid-template-columns:1fr auto;gap:0.28rem 0.65rem;max-width:320px;margin-left:auto;align-items:center;">
                                <div style="text-align:right;font-weight:600;color:#475569;font-size:0.82rem;">Subtotal:</div>
                                <div style="font-family:var(--font-mono);font-weight:700;font-size:0.92rem;color:#1e293b;" id="invoiceSubtotal">$0.00</div>
                                <div style="text-align:right;font-weight:600;color:#475569;font-size:0.82rem;" id="taxLabel">Tax (8.25%):</div>
                                <div style="font-family:var(--font-mono);font-weight:700;font-size:0.92rem;color:#1e293b;" id="invoiceTax">$0.00</div>
                                <div style="text-align:right;font-weight:700;font-size:1rem;color:#0f172a;padding-top:0.35rem;border-top:2px solid #94a3b8;">TOTAL:</div>
                                <div style="font-family:var(--font-mono);font-weight:800;font-size:1.25rem;color:var(--primary-500);padding-top:0.35rem;border-top:2px solid #94a3b8;" id="invoiceTotal">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <!-- FOOTER -->
                    <div style="display:flex;gap:0.6rem;justify-content:flex-end;position:sticky;bottom:0;background:linear-gradient(180deg,transparent 0%,#f8fafc 22%,#f8fafc 100%);padding:0.5rem 0 0.15rem;">
                        <button type="button" onclick="closeModal('invoiceModal')" style="padding:0.45rem 1.1rem;background:#e2e8f0;border:none;color:#475569;border-radius:6px;font-weight:600;font-size:0.82rem;cursor:pointer;" onmouseover="this.style.background='#cbd5e1'" onmouseout="this.style.background='#e2e8f0'">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" style="padding:0.45rem 1.5rem;background:linear-gradient(135deg,#059669,#047857);border:none;color:white;border-radius:6px;font-size:0.88rem;font-weight:700;cursor:pointer;box-shadow:0 2px 8px rgba(5,150,105,0.3);" onmouseover="this.style.transform='translateY(-1px)'" onmouseout="this.style.transform='translateY(0)'">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Assignment Modal -->
    <div class="modal-overlay" id="bulkAssignModal">
        <div class="modal">
            <div class="modal-header">
                <h2>👥 Bulk Assignment</h2>
                <button class="modal-close" onclick="closeModal('bulkAssignModal')">×</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Products</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 2px solid var(--neutral-300); border-radius: 8px; padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="selectAllProducts" onchange="toggleAllProducts()" style="width: 18px; height: 18px;">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="productCheckboxList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="bulkAssignTo" class="search-input">
                        <option value="">-- Select Person --</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                        <option value="office">Office</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mode</label>
                    <select id="assignmentMode" class="search-input">
                        <option value="replace">Replace existing</option>
                        <option value="add">Add to existing</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulkAssignModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkAssignment()">
                        <i class="fa-solid fa-floppy-disk"></i> Save Assignments
                    </button>
                </div>
            </div>
        </div>
    </div>


    <script >

        // ========== CRITICAL: GLOBAL FUNCTIONS FIRST ==========
        window.switchTab = function(tabName, evt) {
            // ✅ Persist tab for page refresh restore
            try { localStorage.setItem('jengchi_active_tab', tabName); } catch(e) {}
            // Stop Place Order auto-refresh when leaving that tab
            if (tabName !== 'placeOrder' && typeof stopPlaceOrderAutoRefresh === 'function') {
                stopPlaceOrderAutoRefresh();
            }
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }
            
            const targetSection = document.getElementById(tabName);
            console.log('🎯 [Switch Tab] Looking for section:', tabName);
            console.log('📍 [Switch Tab] Found section:', targetSection ? 'YES' : 'NO');
            
            if (targetSection) {
                targetSection.classList.add('active');
                console.log('✅ [Switch Tab] Added active class to:', tabName);
                console.log('🎨 [Switch Tab] Section display:', window.getComputedStyle(targetSection).display);
                console.log('👁️ [Switch Tab] Section visibility:', window.getComputedStyle(targetSection).visibility);
            } else {
                console.error('❌ [Switch Tab] Section not found:', tabName);
            }
            
            // Load tab content
            setTimeout(() => {
                if (tabName === 'quickEdit' && typeof renderQuickEditTable === 'function') {
                    renderQuickEditTable();
                } else if (tabName === 'vendors' && typeof loadVendorManagement === 'function') {
                    loadVendorManagement();
                } else if (tabName === 'vendorSpending' && typeof loadVendorSpendingAnalysis === 'function') {
                    loadVendorSpendingAnalysis();
                } else if (tabName === 'julioOrders' && typeof loadJulioOrders === 'function') {
                    loadJulioOrders();
                } else if (tabName === 'ronyOrders' && typeof loadRonyOrders === 'function') {
                    loadRonyOrders();
                } else if (tabName === 'officeOrders' && typeof loadOfficeOrders === 'function') {
                    console.log('🏢 [Switch Tab] Activating Office Orders tab');
                    loadOfficeOrders();
                } else if (tabName === 'officeOrders') {
                    console.error('❌ [Switch Tab] loadOfficeOrders function not found!');
                } else if (tabName === 'placeOrder' && typeof initializeEnhancedPlaceOrder === 'function') {
                    initializeEnhancedPlaceOrder();
                } else if (tabName === 'inventorySettings' && typeof loadInventorySettings === 'function') {
                    loadInventorySettings();
                } else if (tabName === 'submissionHistory' && typeof loadSubmissionHistory === 'function') {
                    loadSubmissionHistory();
                } else if (tabName === 'stockAlerts' && typeof loadStockAlerts === 'function') {
                    loadStockAlerts();
                } else if (tabName === 'consumptionTracking' && typeof loadConsumptionData === 'function') {
                    loadConsumptionData();
                } else if (tabName === 'inventoryValuation' && typeof loadValuationReport === 'function') {
                    loadValuationReport();
                } else if (tabName === 'budgetTracking' && typeof loadBudgetTracking === 'function') {
                    loadBudgetTracking();
                } else if (tabName === 'vendorPerformance' && typeof loadVendorPerformance === 'function') {
                    loadVendorPerformance();
                } else if (tabName === 'imageGallery') {
                    console.log('🖼️ [Switch Tab] Activating Image Gallery');
                    if (typeof loadImageGallery === 'function') {
                        loadImageGallery();
                    } else {
                        console.error('❌ [Switch Tab] loadImageGallery function not found!');
                    }
                } else if (tabName && tabName.startsWith('rpt_')) {
                    // ✅ Reports hub — route to loadReport engine
                    if (typeof loadReport === 'function') {
                        loadReport(tabName);
                    } else {
                        console.error('❌ loadReport not defined');
                    }
                }
            }, 0);
        };

        window.showAlert = function(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        };

        window.showLoading = function(show) {
            const loadingEl = document.getElementById('loadingOverlay');
            if (loadingEl) loadingEl.classList.toggle('active', show);
        };

        window._priceCache2026 = window._priceCache2026 || new Map();


// ========== CRITICAL: DEFINE IMAGE ERROR HANDLER FIRST ==========
const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI2MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
const GITHUB_IMAGE_BASE = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/';


// VENDOR LOGOS - Add your vendor logos here


window.PLACEHOLDER_IMAGE = PLACEHOLDER_IMAGE;
window.handleImageError = function(img) {
    if (!img) return;
    img.onerror = null; // Prevent infinite loop
    img.src = PLACEHOLDER_IMAGE;
};
// ========== END CRITICAL SECTION ==========

// ========== IMAGE RESOLUTION FUNCTION ==========
function resolveImage(imageName) {
  let s = (imageName || '').trim();
  if (!s) return PLACEHOLDER_IMAGE;

  // If it's already a full URL (Supabase, GitHub, CDN, etc) => use as-is
  if (/^https?:\/\//i.test(s)) {
    return s;
  }

  // If they paste a path, keep only the filename
  s = s.split('/').pop();

  // Remove query params
  s = s.split('?')[0];

  // If no extension, assume .jpg
  if (!/\.(png|jpe?g|webp|gif)$/i.test(s)) {
    s += '.jpg';
  }

  // Optional: remove spaces
  s = s.replace(/\s+/g, '');

  return GITHUB_IMAGE_BASE + encodeURIComponent(s);
}



function normalizeImageInput(input) {

  if (!input) return '';

  const s = String(input).trim();

  if (!s) return '';



  // If user pasted a data URL, keep it

  if (s.startsWith('data:image/')) return s;



  // If it's a full URL, extract the last path segment

  if (s.startsWith('http://') || s.startsWith('https://')) {

    try {

      const u = new URL(s);

      const filename = (u.pathname.split('/').pop() || '').split('?')[0];

      return decodeURIComponent(filename);

    } catch (e) {

      // fall through

    }

  }



  // If it's a path-like string, use last segment

  const noQuery = s.split('?')[0];

  const parts = noQuery.split('/');

  return parts[parts.length - 1];

}





async function upsertInventoryManagementImage(productName, imageInput, extra = {}) {

  const img = normalizeImageInput(imageInput); // filename OR url OR null



  // Try update first

  const { data: updated, error: upErr } = await supabaseClient

    .from("inventory_management")

    .update({ image_url: img, ...extra })

    .eq("product_name", productName)

    .select("id");



  if (upErr) throw upErr;



  // If no row existed, insert a minimal one

  if (!updated || updated.length === 0) {

    const { error: insErr } = await supabaseClient

      .from("inventory_management")

      .insert({ product_name: productName, image_url: img, ...extra });



    if (insErr) throw insErr;

  }

}









function normalizeImageForStorage(v) {

  let s = (v || "").trim();

  if (!s) return "";



  // If it's a URL, decide whether to store filename or full URL

  if (/^https?:\/\//i.test(s)) {

    // If it's GitHub raw OR Supabase storage, store ONLY the filename

    const isGithubRaw = s.includes("raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/");

    const isSupabaseStorage = s.includes("supabase.co/storage");



    const parts = s.split("/");

    let filename = parts[parts.length - 1] || "";

    filename = filename.split("?")[0];



    if (isGithubRaw || isSupabaseStorage) {

      s = filename; // store filename only

    } else {

      return s; // keep full URL for other CDNs if you want

    }

  }



  // If they pasted a path, keep only filename

  s = s.split("/").pop();

  s = s.split("?")[0];



  // Auto-add .jpg if missing extension

  if (!/\.(png|jpe?g|webp|gif)$/i.test(s)) s += ".jpg";



  // Optional: remove spaces

  s = s.replace(/\s+/g, "");



  return s;

}




// ========== END IMAGE RESOLUTION FUNCTION ==========

const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

// Initialize Supabase client - ensure library is loaded
let supabaseClient;
function getSupabaseClient() {
    if (!supabaseClient) {
        if (typeof window.supabase === 'undefined') {
            console.error('❌ Supabase library not loaded yet');
            throw new Error('Supabase library not loaded');
        }
        supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        console.log('✅ Supabase client initialized successfully');
    }
    return supabaseClient;
}

// Create client immediately if library is already loaded
if (typeof window.supabase !== 'undefined') {
    supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    console.log('✅ Supabase client created on script load');
}

// ── VENDOR LOGO URLS ─────────────────────────────────────────
const VENDOR_LOGO_URLS = {
    'Formosa Foods':         'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
    'North Food Group':      'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
    'Pacific Plus':          'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
    'BakeMark':              'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg',
    'Delta Office Products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
    'Autochlor':             'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/autochlor.jpg',
};

const COMPANY_LOGO_URL =
    'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg';

const VENDOR_TAX_RULES = {
    'Formosa Foods':         { taxAll: false },
    'North Food Group':      { taxAll: false },
    'Pacific Plus':          { taxAll: false, taxableItemCodes: ['752GO'] },
    'Delta Office Products': { taxAll: true },
    'BakeMark':              { taxAll: false },
    'Autochlor':             { taxAll: false },
};

const TAX_RATE_PDF = 0.0825;



        let inventoryData = [];
        let filteredData = [];
        let invoicesData = [];
        let filteredInvoices = [];
        let deleteMode = false;
        let selectedItems = new Set();
        let selectedVendorMonths = [];
        let vendorDistributionChart, vendorPriceChart, priceHistoryChart;
        let vendorSpendingCharts = {};
        let selectedInvoiceProducts = [];
        const TAX_RATE = 0.0825; // 8.25%

        // Vendor logos map
        const VENDOR_LOGOS = {
            'formosafoods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
            'formosa foods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
            'northfoodgroup': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
            'north food group': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
            'pacificplus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
            'pacific plus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
            'deltaofficeproducts': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
            'delta office products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
            'delta': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
            'bakemark': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg',
            'autochlor': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/autochlor.jpg',
            'supermarket': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg'
        };

        // Function to get vendor logo
        function getVendorLogo(vendorName) {
            if (!vendorName) return null;
            const key = vendorName.toLowerCase().trim().replace(/\s+/g, '');
            return VENDOR_LOGOS[key] || VENDOR_LOGOS[vendorName.toLowerCase().trim()] || null;
        }

async function initializeApp() {
    showLoading(true);
    try {
        // Ensure Supabase client is initialized
        if (!supabaseClient) {
            supabaseClient = getSupabaseClient();
        }
        
        await loadAllData();
        await loadJulioOrders();
        await loadRonyOrders();
        renderInventoryTable();
        renderQuickEditTable();
        updateRecordCount();
        initializeVendorMonthSelector();
        // 🔔 Load stock alerts for bell badge on startup
        setTimeout(() => loadDropdownAlerts(), 1500);
        showAlert('System initialized successfully', 'success');
        // ✅ Restore last visited tab (after a brief delay for DOM to settle)
        setTimeout(() => restoreLastTab(), 200);
    } catch (error) {
        console.error('Init error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

        async function loadAllData() {
            await Promise.all([
                loadInventoryData(),
                loadInvoices(),
                loadAnalytics()
            ]);
        }

        async function loadInventoryData() {
            try {
                // ✅ Load from invoice_items table (2026+ invoices)
                const { data: invoiceItems, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .select('*');
                
                if (itemsError) throw itemsError;

                // Get invoice dates
                const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
                let invDateMap = new Map();
                let invVendorMap = new Map();
                
                if (invoiceIds.length > 0) {
                    const { data: invoices } = await supabaseClient
                        .from('invoices')
                        .select('id, invoice_date, vendor')
                        .in('id', invoiceIds);
                    
                    (invoices || []).forEach(inv => {
                        invDateMap.set(inv.id, inv.invoice_date);
                        invVendorMap.set(inv.id, inv.vendor);
                    });
                }

                // ✅ Load images from inventory_management table
                const { data: inventoryMgmt } = await supabaseClient
                    .from('inventory_management')
                    .select('product_name, image_url');
                
                const imageMap = new Map();
                (inventoryMgmt || []).forEach(item => {
                    if (item.image_url) {
                        imageMap.set(item.product_name, item.image_url);
                    }
                });

                // Transform invoice_items to match purchase_history structure
                inventoryData = (invoiceItems || []).map(item => {
                    const invoiceDate = invDateMap.get(item.invoice_id);
                    const vendor = item.vendor || invVendorMap.get(item.invoice_id);
                    
                    // Calculate unit price (same as invoice logic)
                    const unitPrice = item.has_weight 
                        ? parseFloat(item.price_per_unit || 0)
                        : parseFloat(item.unit_price || 0);

                    // Get image from inventory_management or use existing image_path
                    const imagePath = imageMap.get(item.product_name) || item.image_path;

                    return {
                        id: item.id,
                        product_name: item.product_name,
                        item_code: item.item_code,
                        vendor: vendor,
                        category: item.category || 'Uncategorized',
                        unit_price: unitPrice,
                        purchase_date: invoiceDate,
                        image_path: imagePath,
                        assigned_to: item.assigned_to || [],
                        invoice_id: item.invoice_id
                    };
                })
                .filter(item => {
                    // Filter for 2026+ only
                    if (!item.purchase_date) return false;
                    return new Date(item.purchase_date).getFullYear() >= 2026;
                })
                .sort((a, b) => new Date(b.purchase_date) - new Date(a.purchase_date));

                filteredData = [...inventoryData];
                populateVendorFilter();
                populateProductSelects();
                populateInvoiceVendorSelect();
                populateInvoiceVendorDropdown();
                renderInventoryTable();
            } catch (error) {
                console.error('Load inventory error:', error);
            }
        }

        function toggleProductSearch() {
            const searchSection = document.getElementById('productSearchSection');
            const isHidden = searchSection.style.display === 'none';
            searchSection.style.display = isHidden ? 'block' : 'none';
            
            if (isHidden) {
                document.getElementById('invoiceProductSearch').focus();
            }
        }

        async function loadInvoices() {
            try {
                const { data, error } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .order('invoice_date', { ascending: false });
                if (error) throw error;
                invoicesData = data || [];
                filteredInvoices = [...invoicesData];
                renderInvoicesTable();
            } catch (error) {
                console.error('Load invoices error:', error);
            }
        }

        async function loadAnalytics() {
            // Load invoice_items data from 2026 onward for accurate metrics
            const { data: invoiceItems } = await supabaseClient
                .from('invoice_items')
                .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

            const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
            let invDateMap = new Map();
            if (invoiceIds.length > 0) {
                const { data: invoices } = await supabaseClient
                    .from('invoices')
                    .select('id, invoice_date')
                    .in('id', invoiceIds);
                (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
            }

            // Filter to 2026+ items only
            const items2026Plus = (invoiceItems || []).filter(item => {
                const invDate = invDateMap.get(item.invoice_id);
                if (!invDate) return false;
                return new Date(invDate).getFullYear() >= 2026;
            });

            const uniqueProducts = new Set(items2026Plus.map(i => i.product_name)).size;
            const activeVendors = new Set(items2026Plus.map(i => i.vendor).filter(v => v)).size;
            
            // CRITICAL: Use unit_price, NOT line totals
            const prices = items2026Plus.map(i => {
                const price = i.has_weight 
                    ? parseFloat(i.price_per_unit || 0)
                    : parseFloat(i.unit_price || 0);
                return price;
            }).filter(p => p > 0);
            
            const avgPrice = prices.length > 0 ? prices.reduce((a,b) => a+b, 0) / prices.length : 0;
            const totalValue = prices.reduce((a,b) => a+b, 0);

            document.getElementById('metricTotalProducts').textContent = uniqueProducts;
            document.getElementById('metricActiveVendors').textContent = activeVendors;
            document.getElementById('metricAvgPrice').textContent = '$' + avgPrice.toFixed(2);
            document.getElementById('metricTotalValue').textContent = '$' + totalValue.toFixed(2);

            renderVendorDistributionChart();
            renderVendorsOverviewTable();
        }


// ========== VENDOR MANAGEMENT FUNCTIONS ==========
async function loadVendorManagement() {
    showLoading(true);
    try {
        const { data: invoices, error } = await supabaseClient
            .from('invoices')
            .select('vendor, total, invoice_date')
            .order('invoice_date', { ascending: false });

        if (error) throw error;

        // Group by vendor
        const vendorStats = {};
        (invoices || []).forEach(inv => {
            if (!vendorStats[inv.vendor]) {
                vendorStats[inv.vendor] = {
                    productCount: 0,
                    totalPurchases: 0,
                    lastPurchase: null
                };
            }
            vendorStats[inv.vendor].productCount += 1;
            vendorStats[inv.vendor].totalPurchases += parseFloat(inv.total || 0);
            if (!vendorStats[inv.vendor].lastPurchase || new Date(inv.invoice_date) > new Date(vendorStats[inv.vendor].lastPurchase)) {
                vendorStats[inv.vendor].lastPurchase = inv.invoice_date;
            }
        });

        renderVendorsTable(vendorStats);

    } catch (error) {
        console.error('Load vendor management error:', error);
        showAlert('Error loading vendor data', 'error');
    } finally {
        showLoading(false);
    }
}

function renderVendorsTable(vendorStats) {
    const tbody = document.getElementById('vendorsTableBody');
    document.getElementById('vendorCount').textContent = `${Object.keys(vendorStats).length} vendors`;

    const vendors = Object.entries(vendorStats).sort((a, b) => b[1].totalPurchases - a[1].totalPurchases);

    tbody.innerHTML = vendors.map(([vendor, stats]) => {
        const logoUrl = getVendorLogo(vendor);
        const logoHtml = logoUrl 
            ? `<img src="${logoUrl}" style="width:50px;height:50px;object-fit:contain;border-radius:8px;" onerror="this.style.display='none'">`
            : `<div style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.5rem;color:var(--neutral-500);background:var(--neutral-100);border-radius:8px;">${vendor.substring(0,2).toUpperCase()}</div>`;

        return `
            <tr>
                <td>${logoHtml}</td>
                <td style="font-weight: 600;">${vendor}</td>
                <td><span class="vendor-badge">${stats.productCount}</span></td>
                <td>${formatDate(stats.lastPurchase)}</td>
                <td><span class="price-cell" style="font-weight: 700;">$${stats.totalPurchases.toFixed(2)}</span></td>
            </tr>
        `;
    }).join('');
}


        function getVendorLogo(vendorName) {
            if (!vendorName) return null;
            const vendorKey = vendorName.toLowerCase().replace(/\s+/g, '');
            return VENDOR_LOGOS[vendorKey] || VENDOR_LOGOS[vendorName.toLowerCase()] || null;
        }

        function initializeVendorMonthSelector() {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const container = document.getElementById('vendorMonthSelector');
            container.innerHTML = months.map((month, idx) => {
                return `<div class="month-chip" data-month="${idx + 1}" onclick="toggleVendorMonth(${idx + 1})">${month}</div>`;
            }).join('');
        }

        function toggleVendorMonth(monthNum) {
            const chip = document.querySelector(`#vendorMonthSelector [data-month="${monthNum}"]`);
            chip.classList.toggle('selected');
            
            const index = selectedVendorMonths.indexOf(monthNum);
            if (index > -1) {
                selectedVendorMonths.splice(index, 1);
            } else {
                selectedVendorMonths.push(monthNum);
            }
            
            loadVendorSpendingAnalysis();
        }

        // VSA period mode state
        let vsaPeriodMode = 'week';
        
        function setVSAPeriod(mode) {
            vsaPeriodMode = mode;
            ['week','range','month','year'].forEach(m => {
                document.getElementById('vsaPeriod' + m.charAt(0).toUpperCase() + m.slice(1))?.classList.toggle('active', m === mode);
                const el = document.getElementById('vsa' + m.charAt(0).toUpperCase() + m.slice(1) + 'Filters');
                if (el) el.style.display = (m === mode) ? 'flex' : 'none';
            });
            loadVendorSpendingAnalysis();
        }

        async function loadVendorSpendingAnalysis() {
            showLoading(true);
            const container = document.getElementById('vendorSpendingContent');
            
            try {
                if (!invoicesData || invoicesData.length === 0) {
                    await loadInvoices();
                }

                let dateFrom = null, dateTo = null;
                const now = new Date();
                const mode = vsaPeriodMode || 'year';

                if (mode === 'week') {
                    const weekDateVal = document.getElementById('vsaWeekDate')?.value;
                    if (weekDateVal) {
                        const d = new Date(weekDateVal);
                        const day = d.getDay();
                        dateFrom = new Date(d); dateFrom.setDate(d.getDate() - day);
                        dateTo = new Date(dateFrom); dateTo.setDate(dateFrom.getDate() + 6);
                    } else {
                        // default: current week
                        dateFrom = new Date(now); dateFrom.setDate(now.getDate() - now.getDay());
                        dateTo = new Date(dateFrom); dateTo.setDate(dateFrom.getDate() + 6);
                    }
                } else if (mode === 'range') {
                    const fromVal = document.getElementById('vsaRangeFrom')?.value;
                    const toVal = document.getElementById('vsaRangeTo')?.value;
                    if (fromVal) dateFrom = new Date(fromVal);
                    if (toVal) dateTo = new Date(toVal);
                } else if (mode === 'month') {
                    const month = parseInt(document.getElementById('vsaMonth')?.value || (now.getMonth() + 1));
                    const year = parseInt(document.getElementById('vsaMonthYear')?.value || now.getFullYear());
                    dateFrom = new Date(year, month - 1, 1);
                    dateTo = new Date(year, month, 0);
                } else {
                    // year mode - use year selector + month checkboxes
                    const year = document.getElementById('vendorSpendingYear')?.value || now.getFullYear().toString();
                    const selectedMonths = selectedVendorMonths.length > 0 ? selectedVendorMonths : [1,2,3,4,5,6,7,8,9,10,11,12];
                    dateFrom = null; dateTo = null;
                    // Filter by year + month checkboxes
                    const filteredInvoices = (invoicesData || []).filter(inv => {
                        if (!inv || !inv.invoice_date) return false;
                        const invDate = new Date(inv.invoice_date);
                        return invDate.getFullYear().toString() === year && selectedMonths.includes(invDate.getMonth() + 1);
                    });
                    const vendorData = buildVendorData(filteredInvoices);
                    renderVendorSpendingCards(vendorData, year, selectedMonths, 'year');
                    return;
                }

                const filteredInvoices = (invoicesData || []).filter(inv => {
                    if (!inv || !inv.invoice_date) return false;
                    const d = new Date(inv.invoice_date);
                    if (dateFrom && d < dateFrom) return false;
                    if (dateTo && d > dateTo) return false;
                    return true;
                });

                const vendorData = buildVendorData(filteredInvoices);
                const label = dateFrom ? `${dateFrom.toLocaleDateString()} – ${dateTo ? dateTo.toLocaleDateString() : 'now'}` : 'All';
                renderVendorSpendingCards(vendorData, label, null, mode);

            } catch (error) {
                console.error('Vendor spending analysis error:', error);
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>Error loading data</h3><p style="color:var(--error-600);">${error.message}</p></div>`;
            } finally {
                showLoading(false);
            }
        }

        function buildVendorData(invoices) {
            const vendorData = {};
            invoices.forEach(inv => {
                if (!inv.vendor) return;
                if (!vendorData[inv.vendor]) {
                    vendorData[inv.vendor] = { total: 0, months: {}, weeks: {}, dates: [], invoiceCount: 0 };
                }
                const d = new Date(inv.invoice_date);
                const month = d.getMonth() + 1;
                const weekKey = `W${getWeekNumber(d)}`;
                const dateKey = d.toISOString().slice(0, 10);
                if (!vendorData[inv.vendor].months[month]) vendorData[inv.vendor].months[month] = 0;
                if (!vendorData[inv.vendor].weeks[weekKey]) vendorData[inv.vendor].weeks[weekKey] = 0;
                const amount = parseFloat(inv.total || inv.amount || 0);
                vendorData[inv.vendor].months[month] += amount;
                vendorData[inv.vendor].weeks[weekKey] += amount;
                vendorData[inv.vendor].dates.push({ date: dateKey, amount });
                vendorData[inv.vendor].total += amount;
                vendorData[inv.vendor].invoiceCount++;
            });
            return vendorData;
        }

        function getWeekNumber(d) {
            const jan1 = new Date(d.getFullYear(), 0, 1);
            return Math.ceil(((d - jan1) / 86400000 + jan1.getDay() + 1) / 7);
        }

        function renderVendorSpendingCards(vendorData, periodLabel, selectedMonths, mode) {
            const container = document.getElementById('vendorSpendingContent');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            if (Object.keys(vendorData).length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">💰</div><h3>No Invoice Data</h3><p>No invoices found for the selected period.</p></div>`;
                return;
            }

            const sortedVendors = Object.entries(vendorData).sort((a, b) => b[1].total - a[1].total);
            const grandTotal = sortedVendors.reduce((s, [, d]) => s + d.total, 0);
            
            // ── SUMMARY CARDS ──
            let html = `
            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap:1rem; margin-bottom:1.5rem;">
                <div style="background:linear-gradient(135deg,var(--primary-800),var(--primary-700)); color:white; border-radius:12px; padding:1.25rem; box-shadow:var(--shadow-md);">
                    <div style="font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; opacity:0.75;">Total Spend</div>
                    <div style="font-size:2rem; font-weight:700; font-family:var(--font-mono); margin-top:0.25rem;">$${grandTotal.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                    <div style="font-size:0.8125rem; opacity:0.65; margin-top:0.25rem;">${periodLabel}</div>
                </div>
                <div style="background:linear-gradient(135deg,#059669,#10b981); color:white; border-radius:12px; padding:1.25rem; box-shadow:var(--shadow-md);">
                    <div style="font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; opacity:0.75;">Vendors Active</div>
                    <div style="font-size:2rem; font-weight:700; font-family:var(--font-mono); margin-top:0.25rem;">${sortedVendors.length}</div>
                    <div style="font-size:0.8125rem; opacity:0.65; margin-top:0.25rem;">distinct vendors</div>
                </div>
                <div style="background:linear-gradient(135deg,#d97706,#f59e0b); color:white; border-radius:12px; padding:1.25rem; box-shadow:var(--shadow-md);">
                    <div style="font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; opacity:0.75;">Top Vendor</div>
                    <div style="font-size:1.25rem; font-weight:700; margin-top:0.25rem; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${sortedVendors[0][0]}</div>
                    <div style="font-size:0.8125rem; opacity:0.75; margin-top:0.25rem;">$${sortedVendors[0][1].total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                </div>
                <div style="background:linear-gradient(135deg,#7c3aed,#8b5cf6); color:white; border-radius:12px; padding:1.25rem; box-shadow:var(--shadow-md);">
                    <div style="font-size:0.75rem; font-weight:700; text-transform:uppercase; letter-spacing:0.06em; opacity:0.75;">Total Invoices</div>
                    <div style="font-size:2rem; font-weight:700; font-family:var(--font-mono); margin-top:0.25rem;">${sortedVendors.reduce((s,[,d])=>s+d.invoiceCount,0)}</div>
                    <div style="font-size:0.8125rem; opacity:0.65; margin-top:0.25rem;">across all vendors</div>
                </div>
            </div>`;

            // ── ALL-VENDOR COMBINATION CHART ──
            const comboLabels = mode === 'year' && selectedMonths
                ? selectedMonths.sort((a,b)=>a-b).map(m => monthNames[m-1])
                : sortedVendors.map(([v]) => v);
            
            const vendorColors = ['#6B4444','#C48A00','#10b981','#dc2626','#8b5cf6','#ec4899','#0891b2','#65a30d'];
            
            html += `
            <div class="vsa-combo-section">
                <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:1.25rem;">
                    <h3 style="font-size:1.125rem; font-weight:700; color:var(--neutral-900); margin:0;">
                        <i class="fas fa-chart-column" style="color:var(--accent-500); margin-right:0.5rem;"></i>
                        All Vendors — Combined Overview
                    </h3>
                    <span style="font-size:0.8125rem; color:var(--neutral-500); font-family:var(--font-mono);">${periodLabel}</span>
                </div>
                <div style="height:320px; position:relative;">
                    <canvas id="vsaComboChart"></canvas>
                </div>
            </div>`;

            // ── INDIVIDUAL VENDOR CARDS ──
            sortedVendors.forEach(([vendor, data], idx) => {
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : `<div class="vendor-image" style="display:flex;align-items:center;justify-content:center;font-weight:700;font-size:2rem;color:var(--neutral-500);background:var(--neutral-100);">${vendor.substring(0,2).toUpperCase()}</div>`;
                const pct = grandTotal > 0 ? ((data.total / grandTotal) * 100).toFixed(1) : '0.0';
                const safeName = vendor.replace(/\s+/g, '_').replace(/[^a-zA-Z0-9_]/g, '');
                
                let periodBreakdown = '';
                if (mode === 'year' && selectedMonths) {
                    selectedMonths.sort((a,b)=>a-b).forEach(month => {
                        const amount = data.months[month] || 0;
                        periodBreakdown += `<div class="vendor-month-card"><div class="vendor-month-label">${monthNames[month-1]}</div><div class="vendor-month-value">$${amount.toFixed(2)}</div></div>`;
                    });
                } else {
                    // Show date-level breakdown for shorter periods
                    const sortedDates = (data.dates || []).sort((a,b) => a.date > b.date ? 1 : -1);
                    sortedDates.forEach(d => {
                        periodBreakdown += `<div class="vendor-month-card"><div class="vendor-month-label">${d.date}</div><div class="vendor-month-value">$${d.amount.toFixed(2)}</div></div>`;
                    });
                }

                html += `
                <div class="vendor-card" style="border-left-color: ${vendorColors[idx % vendorColors.length]};">
                    <div class="vendor-card-header">
                        ${logoHtml}
                        <div style="flex:1;">
                            <div class="vendor-card-title">${vendor}</div>
                            <div style="color:var(--neutral-600); font-size:0.9375rem; margin-top:0.5rem;">${data.invoiceCount} invoices · ${periodLabel}</div>
                            <!-- Share bar -->
                            <div style="margin-top:0.75rem;">
                                <div style="display:flex; justify-content:space-between; font-size:0.75rem; font-weight:600; color:var(--neutral-500); margin-bottom:0.25rem;">
                                    <span>Share of total spend</span><span>${pct}%</span>
                                </div>
                                <div style="height:6px; background:var(--neutral-200); border-radius:3px; overflow:hidden;">
                                    <div style="height:100%; width:${pct}%; background:${vendorColors[idx % vendorColors.length]}; border-radius:3px; transition:width 0.8s ease;"></div>
                                </div>
                            </div>
                        </div>
                        <div class="vendor-total-card" style="background:linear-gradient(135deg,${vendorColors[idx % vendorColors.length]},${vendorColors[(idx+1) % vendorColors.length]});">
                            <div class="vendor-total-label">Total Spent</div>
                            <div class="vendor-total-value">$${data.total.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                        </div>
                    </div>
                    
                    <div class="vendor-monthly-grid">${periodBreakdown}</div>
                    
                    <!-- Bar + Line charts side by side -->
                    <div class="vsa-charts-row">
                        <div>
                            <h4 style="font-size:0.9375rem; font-weight:700; color:var(--neutral-800); margin-bottom:0.75rem;">
                                <i class="fas fa-chart-column" style="color:${vendorColors[idx % vendorColors.length]}; margin-right:0.5rem;"></i>
                                Spending by Period (Bar)
                            </h4>
                            <div style="height:220px; position:relative;">
                                <canvas id="vsaBar_${safeName}"></canvas>
                            </div>
                        </div>
                        <div>
                            <h4 style="font-size:0.9375rem; font-weight:700; color:var(--neutral-800); margin-bottom:0.75rem;">
                                <i class="fas fa-chart-line" style="color:${vendorColors[idx % vendorColors.length]}; margin-right:0.5rem;"></i>
                                Spending Trend (Line)
                            </h4>
                            <div style="height:220px; position:relative;">
                                <canvas id="vsaLine_${safeName}"></canvas>
                            </div>
                        </div>
                    </div>
                </div>`;
            });
            
            container.innerHTML = html;
            
            setTimeout(() => {
                // Render combo chart
                renderVSAComboChart(sortedVendors, selectedMonths, monthNames, mode, vendorColors);
                // Render per-vendor bar + line charts
                sortedVendors.forEach(([vendor, data], idx) => {
                    const safeName = vendor.replace(/\s+/g,'_').replace(/[^a-zA-Z0-9_]/g,'');
                    renderVSABarChart(`vsaBar_${safeName}`, vendor, data, selectedMonths, monthNames, mode, vendorColors[idx % vendorColors.length]);
                    renderVSALineChart(`vsaLine_${safeName}`, vendor, data, selectedMonths, monthNames, mode, vendorColors[idx % vendorColors.length]);
                });
            }, 100);
        }

function calcLineTax(vendor, itemCode, lineTotal) {
    const rule = VENDOR_TAX_RULES[vendor];
    if (!rule) return 0;
    if (rule.taxAll) return lineTotal * TAX_RATE_PDF;
    if (rule.taxableItemCodes && rule.taxableItemCodes.includes((itemCode || '').trim().toUpperCase())) {
        return lineTotal * TAX_RATE_PDF;
    }
    return 0;
}
// ── IMAGE HELPER ─────────────────────────────────────────────
async function fetchImageBase64(url) {
    if (!url) return null;
    try {
        // Convert GitHub blob URLs to raw URLs
        let fetchUrl = url;
        if (fetchUrl.includes('github.com') && !fetchUrl.includes('raw.githubusercontent.com')) {
            fetchUrl = fetchUrl
                .replace('github.com', 'raw.githubusercontent.com')
                .replace('/blob/', '/');
        }
        const res = await fetch(fetchUrl);
        if (!res.ok) return null;
        const blob = await res.blob();
        return await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(blob);
        });
    } catch (e) {
        console.warn('Image fetch failed:', url, e.message);
        return null;
    }
}



        function getChartLabelsAndData(data, selectedMonths, monthNames, mode) {
            if (mode === 'year' && selectedMonths) {
                const labels = selectedMonths.sort((a,b)=>a-b).map(m => monthNames[m-1]);
                const amounts = selectedMonths.sort((a,b)=>a-b).map(m => data.months[m] || 0);
                return { labels, amounts };
            }
            // date-level
            const sortedDates = [...new Set((data.dates || []).map(d => d.date))].sort();
            const amountMap = {};
            (data.dates || []).forEach(d => { amountMap[d.date] = (amountMap[d.date] || 0) + d.amount; });
            return { labels: sortedDates, amounts: sortedDates.map(d => amountMap[d] || 0) };
        }

        function renderVSABarChart(canvasId, vendor, data, selectedMonths, monthNames, mode, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (vendorSpendingCharts[canvasId]) vendorSpendingCharts[canvasId].destroy();
            const { labels, amounts } = getChartLabelsAndData(data, selectedMonths, monthNames, mode);
            vendorSpendingCharts[canvasId] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: 'Spending',
                        data: amounts,
                        backgroundColor: color + 'CC',
                        borderColor: color,
                        borderWidth: 2,
                        borderRadius: 6,
                        borderSkipped: false
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderVSALineChart(canvasId, vendor, data, selectedMonths, monthNames, mode, color) {
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            if (vendorSpendingCharts[canvasId]) vendorSpendingCharts[canvasId].destroy();
            const { labels, amounts } = getChartLabelsAndData(data, selectedMonths, monthNames, mode);
            // cumulative line
            let cumulative = 0;
            const cumulativeAmounts = amounts.map(a => { cumulative += a; return cumulative; });
            vendorSpendingCharts[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels,
                    datasets: [
                        {
                            label: 'Period Spend',
                            data: amounts,
                            borderColor: color,
                            backgroundColor: color + '22',
                            borderWidth: 2.5,
                            tension: 0.4,
                            fill: true,
                            pointBackgroundColor: color,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Cumulative',
                            data: cumulativeAmounts,
                            borderColor: '#94a3b8',
                            borderWidth: 1.5,
                            borderDash: [5,3],
                            tension: 0.4,
                            fill: false,
                            pointRadius: 2,
                            yAxisID: 'y'
                        }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { font: { size: 11 }, boxWidth: 12 } } },
                    scales: {
                        y: { beginAtZero: true, ticks: { callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        function renderVSAComboChart(sortedVendors, selectedMonths, monthNames, mode, vendorColors) {
            const ctx = document.getElementById('vsaComboChart');
            if (!ctx) return;
            if (vendorSpendingCharts['vsaCombo']) vendorSpendingCharts['vsaCombo'].destroy();
            
            // Build shared labels
            let labels;
            if (mode === 'year' && selectedMonths) {
                labels = selectedMonths.sort((a,b)=>a-b).map(m => monthNames[m-1]);
            } else {
                const allDates = new Set();
                sortedVendors.forEach(([,d]) => (d.dates||[]).forEach(item => allDates.add(item.date)));
                labels = [...allDates].sort();
            }

            const datasets = sortedVendors.slice(0, 6).map(([vendor, data], idx) => {
                let amounts;
                if (mode === 'year' && selectedMonths) {
                    amounts = selectedMonths.sort((a,b)=>a-b).map(m => data.months[m] || 0);
                } else {
                    const amountMap = {};
                    (data.dates||[]).forEach(d => { amountMap[d.date] = (amountMap[d.date]||0) + d.amount; });
                    amounts = labels.map(l => amountMap[l] || 0);
                }
                return {
                    type: idx === 0 ? 'bar' : 'bar',
                    label: vendor,
                    data: amounts,
                    backgroundColor: vendorColors[idx % vendorColors.length] + 'BB',
                    borderColor: vendorColors[idx % vendorColors.length],
                    borderWidth: 1.5,
                    borderRadius: 4
                };
            });

            // Add a line for grand total
            const totalAmounts = labels.map((_, li) => datasets.reduce((s, ds) => s + (ds.data[li] || 0), 0));
            datasets.push({
                type: 'line',
                label: 'Grand Total',
                data: totalAmounts,
                borderColor: '#f59e0b',
                backgroundColor: 'transparent',
                borderWidth: 2.5,
                pointBackgroundColor: '#f59e0b',
                pointRadius: 4,
                tension: 0.35,
                order: -1
            });

            vendorSpendingCharts['vsaCombo'] = new Chart(ctx, {
                type: 'bar',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', labels: { font: { size: 11 }, boxWidth: 14 } },
                        tooltip: {
                            callbacks: {
                                label: ctx => `${ctx.dataset.label}: $${ctx.parsed.y.toLocaleString('en-US',{minimumFractionDigits:2,maximumFractionDigits:2})}`
                            }
                        }
                    },
                    scales: {
                        y: { beginAtZero: true, stacked: false, ticks: { callback: v => '$' + v.toLocaleString() }, grid: { color: 'rgba(0,0,0,0.05)' } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Legacy compat
        function renderVendorChart(vendor, data, selectedMonths, monthNames) {
            const safeName = vendor.replace(/\s+/g,'_');
            renderVSABarChart(`vendorChart_${safeName}`, vendor, data, selectedMonths, monthNames, 'year', '#6B4444');
        }

        // ✅ FIXED: renderInventoryTable function
function renderInventoryTable() {
    const tbody = document.getElementById('inventoryTableBody');
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">📦</div><h3>No Items Found</h3></div></td></tr>';
        return;
    }
tbody.innerHTML = filteredData.map((item, idx) => {
    const imageUrl = resolveImage(item.image_path);

    let assignedArray = [];
    try {
        if (Array.isArray(item.assigned_to)) {
            assignedArray = item.assigned_to;
        } else if (typeof item.assigned_to === 'string') {
            const s = item.assigned_to.trim();
            if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                assignedArray = JSON.parse(s);
            }
        }
    } catch (e) {
        assignedArray = [];
    }
    assignedArray = assignedArray.filter(x => typeof x === 'string' && x.trim() !== '');

    const checkboxCell = (deleteMode || bulkAssignMode) ? `
        <td>
            <input type="checkbox" 
                   class="item-checkbox" 
                   ${selectedItems.has(item.id) ? 'checked' : ''}
                   onchange="toggleItemSelection('${item.id}')" 
                   style="cursor: pointer; width: 18px; height: 18px;">
        </td>
    ` : '';

    const assignmentBadges = assignedArray.length > 0 
        ? assignedArray.map(person => `
            <span class="assignment-badge" 
                  onclick="removeSingleAssignment('${item.id}', '${person}')"
                  title="Click to remove ${person}">
                ${person.charAt(0).toUpperCase() + person.slice(1)}
            </span>`
          ).join(' ')
        : '';

    const assignmentSelect = assignedArray.length === 0 ? `
        <select class="assignment-select" 
                onchange="quickAssign('${item.item_code}', this.value); this.value='';"
                style="margin-left: 0.5rem; width: auto; min-width: 100px;">
            <option value="">+ Assign</option>
            <option value="rony">Rony</option>
            <option value="julio">Julio</option>
            <option value="office">Office</option>
        </select>`
    : '';

    return `
        <tr>
            ${checkboxCell}
            <td><img src="${imageUrl}" class="product-image" onerror="this.src='${PLACEHOLDER_IMAGE}'"></td>
            <td><span class="vendor-badge">${item.vendor || 'Unknown'}</span></td>
            <td><span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">${item.category || 'Uncategorized'}</span></td>
            <td><span class="item-number">${item.item_code || 'N/A'}</span></td>
            <td>${item.product_name || 'Unnamed'}</td>
            <td><span class="price-cell">$${parseFloat(item.unit_price || 0).toFixed(2)}</span></td>
            <td>${formatDate(item.purchase_date)}</td>
            <td>${assignmentBadges}${assignmentSelect}</td>
            <td>
                <button class="btn btn-icon btn-secondary" onclick="editItem('${item.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon btn-danger" onclick="deleteSingleItem('${item.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
}).join('');
}

// ✅ FIXED: renderQuickEditTable - show only 2026+ invoice_items, group by item_code
async function renderQuickEditTable() {
    showLoading(true);
    const tbody = document.getElementById('quickEditTableBody');
    
    try {
        // Load all invoice_items
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
        let invDateMap = new Map();
        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
        }

        // Load product images from inventory_management table
        const { data: inventoryMgmt } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, item_code');
        const imageMap = new Map();
        (inventoryMgmt || []).forEach(item => {
            if (item.image_url) {
                // Store by both product name and item code for better matching
                imageMap.set(item.product_name, item.image_url);
                if (item.item_code) imageMap.set(item.item_code, item.image_url);
            }
        });

        // Filter to 2026+ items only
        let items2026Plus = (invoiceItems || []).filter(item => {
            const invDate = invDateMap.get(item.invoice_id);
            if (!invDate) return false;
            return new Date(invDate).getFullYear() >= 2026;
        });

        // Apply filters
        const assignFilter = document.getElementById('quickEditAssignFilter')?.value;
        const searchTerm = document.getElementById('quickEditSearch')?.value.toLowerCase() || '';

        if (searchTerm) {
            items2026Plus = items2026Plus.filter(item => {
                const name = (item.product_name || '').toLowerCase();
                const code = (item.item_code || '').toLowerCase();
                return name.includes(searchTerm) || code.includes(searchTerm);
            });
        }

        // Group by item_code
        const productMap = new Map();
        items2026Plus.forEach(item => {
            if (!item.item_code) return;
            
            if (!productMap.has(item.item_code)) {
                // Get latest price/vendor for this item_code
                const price = item.has_weight 
                    ? parseFloat(item.price_per_unit || 0)
                    : parseFloat(item.unit_price || 0);
                
                productMap.set(item.item_code, {
                    code: item.item_code,
                    name: item.product_name || 'Unnamed',
                    vendor: item.vendor || 'Unknown',
                    price: price,
                    image_path: imageMap.get(item.item_code) || imageMap.get(item.product_name) || null,
                    count: 0
                });
            }
            productMap.get(item.item_code).count++;
        });

        const products = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        
        document.getElementById('quickEditCount').textContent = `${products.length} unique products (2026+)`;

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">📦</div><h3>No Products Found</h3><p>No invoice items from 2026 onward match your search</p></div></td></tr>';
            return;
        }

        tbody.innerHTML = products.map(p => {
            const imgSrc = resolveImage(p.image_path);
            return `
            <tr>
                <td><img src="${imgSrc}" class="product-image" style="width:50px;height:50px;object-fit:cover;border-radius:8px;" onerror="this.src='${PLACEHOLDER_IMAGE}'"></td>
                <td><span class="item-number">${p.code}</span></td>
                <td>${p.name}</td>
                <td><span class="vendor-badge">${p.vendor}</span></td>
                <td><span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">-</span></td>
                <td><span class="price-cell">$${parseFloat(p.price).toFixed(2)}</span></td>
                <td><span style="font-weight: 600; color: var(--primary-700);">${p.count} items</span></td>
                <td>
                    <button class="btn btn-primary" onclick="openQuickEditModalInvoice('${p.code}', ${p.count})">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                </td>
            </tr>
        `}).join('');
        
    } catch (error) {
        console.error('Quick edit load error:', error);
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">⚠️</div><h3>Error loading data</h3><p>${error.message}</p></div></td></tr>`;
    } finally {
        showLoading(false);
    }
}



        function filterQuickEdit() {
            renderQuickEditTable();
        }

       // NEW: Quick edit modal for invoice_items
       async function openQuickEditModalInvoice(itemCode, count) {
    try {
        // Load from purchase_history to get complete data
        const { data: items } = await supabaseClient
            .from('purchase_history')
            .select('product_name, vendor, item_code, unit_price, category, image_path, assigned_to')
            .eq('item_code', itemCode)
            .limit(1);
        
        if (!items || items.length === 0) return;
        
        const firstItem = items[0];
        
        document.getElementById('quickEditItemCode').value = itemCode;
        document.getElementById('quickEditItemCodeDisplay').value = itemCode;
        document.getElementById('quickEditProductName').value = firstItem.product_name || '';
        document.getElementById('quickEditVendor').value = firstItem.vendor || '';
        document.getElementById('quickEditCategory').value = firstItem.category || '';
        document.getElementById('quickEditPrice').value = parseFloat(firstItem.unit_price || 0);
        document.getElementById('quickEditImage').value = firstItem.image_path || '';
        document.getElementById('quickEditAssignedTo').value = firstItem.assigned_to || '';
        document.getElementById('affectedCount').textContent = count;
        
        openModal('quickEditModal');
    } catch (error) {
        console.error('Open quick edit error:', error);
        showAlert('Error: ' + error.message, 'error');
    }
}

async function saveQuickEditInvoice(event) {
    event.preventDefault();
    showLoading(true);
    
    try {
        const oldItemCode = document.getElementById('quickEditItemCode').value;
        const productName = document.getElementById('quickEditProductName').value;
        const vendor = document.getElementById('quickEditVendor').value;
        const category = document.getElementById('quickEditCategory').value || null;
        const imagePath = document.getElementById('quickEditImage').value.trim() || null;
        const assignedTo = document.getElementById('quickEditAssignedTo').value || null;

        // ⚠️ PROTECTED: price and item_code are NEVER updated!
        // Update purchase_history (main inventory table) - NO PRICE OR ITEM_CODE
        const { data: updated, error } = await supabaseClient
            .from('purchase_history')
            .update({
                product_name: productName,
                vendor: vendor,
                category: category,
                image_path: imagePath,
                assigned_to: assignedTo
                // ❌ item_code: NOT UPDATED
                // ❌ unit_price: NOT UPDATED
            })
            .eq('item_code', oldItemCode)
            .select();

        if (error) throw error;

        // Also update invoice_items for consistency - NO PRICE
        await supabaseClient
            .from('invoice_items')
            .update({
                product_name: productName,
                vendor: vendor
                // ❌ item_code: NOT UPDATED
                // ❌ unit_price: NOT UPDATED
                // ❌ price_per_unit: NOT UPDATED
            })
            .eq('item_code', oldItemCode);

        // Update inventory_management table - NO PRICE
        await supabaseClient
            .from('inventory_management')
            .update({
                product_name: productName,
                image_url: imagePath,
                category: category,
                assigned_to: assignedTo
                // ❌ No price field in this table anyway
            })
            .eq('product_name', productName);

        const updateCount = updated ? updated.length : 0;
        showAlert(`✅ Updated ${updateCount} items. Price & Item Code protected (not changed).`, 'success');
        closeModal('quickEditModal');
        await renderQuickEditTable();
        await loadInventoryData();
        renderInventoryTable();

    } catch (error) {
        console.error('Quick edit save error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

       async function openQuickEditModal(itemCode, count) {
    const items = inventoryData.filter(i => i.item_code === itemCode);
    if (items.length === 0) return;

    const firstItem = items[0];
    
    document.getElementById('quickEditItemCode').value = itemCode;
    document.getElementById('quickEditItemCodeDisplay').value = itemCode;
    document.getElementById('quickEditProductName').value = firstItem.product_name || '';
    document.getElementById('quickEditVendor').value = firstItem.vendor || '';
    document.getElementById('quickEditCategory').value = firstItem.category || '';
    document.getElementById('quickEditPrice').value = firstItem.unit_price || '';
    document.getElementById('quickEditImage').value = firstItem.image_path || '';
    document.getElementById('affectedCount').textContent = count;
    
    openModal('quickEditModal');
}
        async function saveQuickEdit(event) {
    event.preventDefault();
    showLoading(true);
    
    try {
        const itemCode = document.getElementById('quickEditItemCode').value;
        const productName = document.getElementById('quickEditProductName').value;
        const vendor = document.getElementById('quickEditVendor').value;
        const price = parseFloat(document.getElementById('quickEditPrice').value);
        const imagePath = document.getElementById('quickEditImage').value.trim() || null;
        const category = document.getElementById('quickEditCategory').value || null;

        const { error } = await supabaseClient
            .from('purchase_history')
            .update({
                product_name: productName,
                vendor: vendor,
                category: category,
                unit_price: price,
                image_path: imagePath
            })
            .eq('item_code', itemCode);

        if (error) throw error;

        showAlert('All matching items updated successfully!', 'success');
        closeModal('quickEditModal');
        await loadInventoryData();
        renderInventoryTable();
        renderQuickEditTable();
        applyFilters();

    } catch (error) {
        console.error('Quick edit error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

        async function quickAssign(itemCode, person) {
            if (!person || !itemCode) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => item.item_code === itemCode);
                if (itemsToUpdate.length === 0) {
                    showAlert('No items found with this item code', 'error');
                    return;
                }

                for (const item of itemsToUpdate) {
                    const currentAssigned = Array.isArray(item.assigned_to) ? item.assigned_to : [];
                    if (!currentAssigned.includes(person)) {
                      const newAssigned = [person]; // exclusive!
                        const { error } = await supabaseClient
                            .from('invoice_items')
                            .update({ assigned_to: newAssigned })
                            .eq('id', item.id);

                        if (error) throw error;
                    }
                }

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} assigned to all items with code: ${itemCode}`, 'success');
                
                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Quick assign error:', error);
                showAlert('Error updating assignment', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function removeSingleAssignment(itemId, person) {
            showLoading(true);
            try {
                const currentItem = inventoryData.find(item => item.id === itemId);
                if (!currentItem) {
                    showAlert('Item not found. Please refresh the page.', 'error');
                    return;
                }

                const existing = currentItem.assigned_to || [];
                const existingArray = Array.isArray(existing) ? existing : [];
                const newAssignment = existingArray.filter(p => p !== person);

                const { error } = await supabaseClient
                    .from('invoice_items')
                   .update({ assigned_to: newAssignment })
                    .eq('id', itemId);

                if (error) throw error;

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} removed from assignment`, 'success');

                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Remove assignment error:', error);
                showAlert('Error removing assignment: ' + (error.message || 'Unknown'), 'error');
            } finally {
                showLoading(false);
            }
        }

        function populateInvoiceVendorSelect() {
            const vendors = [...new Set(invoicesData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorSelect');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function filterInvoicesByVendor() {
            const vendorFilter = document.getElementById('invoiceVendorSelect').value;
            const monthFilter  = document.getElementById('invoiceMonthSelect').value;
            const yearFilter   = document.getElementById('invoiceYearSelect').value;
            // ✅ NEW: Invoice number search
            const invNumSearch = (document.getElementById('invoiceNumberSearch')?.value || '').trim().toLowerCase();
            
            let data = [...invoicesData];
            
            if (vendorFilter) {
                data = data.filter(i => i.vendor === vendorFilter);
            }
            
            if (monthFilter) {
                data = data.filter(i => {
                    const invoiceDate = new Date(i.invoice_date);
                    const month = String(invoiceDate.getMonth() + 1).padStart(2, '0');
                    return month === monthFilter;
                });
            }
            
            if (yearFilter) {
                data = data.filter(i => new Date(i.invoice_date).getFullYear().toString() === yearFilter);
            }

            // ✅ Filter by invoice number (partial match, case-insensitive)
            // Use String() to safely handle invoice_number stored as integer or string
            if (invNumSearch) {
                data = data.filter(i =>
                    StringString(i.invoice_number || '').toLowerCase().includes(invNumSearch)
                );
            }
            
            filteredInvoices = data;
            renderInvoicesTable();
        }

        async function loadProductAnalytics() {
            const productName = document.getElementById('analyticsProductSelect').value;
            if (!productName) {
                document.getElementById('productAnalysisSection').style.display = 'none';
                return;
            }

            showLoading(true);
            try {
                const productItems = inventoryData.filter(i => i.product_name === productName);
                
                if (productItems.length === 0) {
                    showAlert('No data found for this product', 'error');
                    return;
                }

                document.getElementById('productAnalysisSection').style.display = 'block';
                
                renderPriceComparison(productItems);
                renderVendorPriceChart(productItems);
                renderPriceHistoryChart(productItems);
                renderVarianceAnalysis(productItems);

            } catch (error) {
                console.error('Analytics error:', error);
                showAlert('Error loading analytics', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderPriceComparison(data) {
            const prices = data.map(i => parseFloat(i.unit_price));
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const avgPrice = prices.reduce((a,b) => a+b, 0) / prices.length;
            
            const minItem = data.find(i => parseFloat(i.unit_price) === minPrice);
            const maxItem = data.find(i => parseFloat(i.unit_price) === maxPrice);

            const container = document.getElementById('priceComparison');
            container.innerHTML = `
                <div class="comparison-card lowest">
                    <div class="comparison-label">💰 Lowest Price</div>
                    <div class="comparison-value" style="color: var(--success-600);">$${minPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${minItem.vendor}</div>
                    <div class="comparison-date">${formatDate(minItem.purchase_date)}</div>
                </div>
                <div class="comparison-card average">
                    <div class="comparison-label">📊 Average Price</div>
                    <div class="comparison-value" style="color: var(--primary-600);">$${avgPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">Across ${data.length} purchases</div>
                    <div class="comparison-date">All vendors</div>
                </div>
                <div class="comparison-card highest">
                    <div class="comparison-label">📈 Highest Price</div>
                    <div class="comparison-value" style="color: var(--warning-600);">$${maxPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${maxItem.vendor}</div>
                    <div class="comparison-date">${formatDate(maxItem.purchase_date)}</div>
                </div>
                <div class="comparison-card">
                    <div class="comparison-label">📉 Price Variance</div>
                    <div class="comparison-value" style="color: var(--accent-500);">${((maxPrice - minPrice) / minPrice * 100).toFixed(1)}%</div>
                    <div class="comparison-vendor">Spread: $${(maxPrice - minPrice).toFixed(2)}</div>
                    <div class="comparison-date">Max vs Min</div>
                </div>
            `;
        }

        function renderVendorPriceChart(data) {
            const vendorPrices = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorPrices[vendor]) vendorPrices[vendor] = [];
                vendorPrices[vendor].push(parseFloat(item.unit_price));
            });

            const vendors = Object.keys(vendorPrices);
            const avgPrices = vendors.map(v => {
                const sum = vendorPrices[v].reduce((a,b) => a+b, 0);
                return sum / vendorPrices[v].length;
            });
            const minPrices = vendors.map(v => Math.min(...vendorPrices[v]));
            const maxPrices = vendors.map(v => Math.max(...vendorPrices[v]));

            const ctx = document.getElementById('vendorPriceChart');
            if (vendorPriceChart) vendorPriceChart.destroy();
            vendorPriceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vendors,
                    datasets: [
                        {
                            label: 'Minimum Price',
                            data: minPrices,
                            backgroundColor: 'rgba(5, 150, 105, 0.8)',
                            borderColor: '#059669',
                            borderWidth: 2
                        },
                        {
                            label: 'Average Price',
                            data: avgPrices,
                            backgroundColor: 'rgba(44, 86, 136, 0.8)',
                            borderColor: '#6B4444',
                            borderWidth: 2
                        },
                        {
                            label: 'Maximum Price',
                            data: maxPrices,
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: '#dc2626',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderPriceHistoryChart(data) {
            const sortedData = [...data].sort((a,b) => new Date(a.purchase_date) - new Date(b.purchase_date));
            
            const vendorData = {};
            sortedData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorData[vendor]) vendorData[vendor] = [];
                vendorData[vendor].push({
                    x: item.purchase_date,
                    y: parseFloat(item.unit_price)
                });
            });

            const colors = ['#6B4444', '#f59e0b', '#10b981', '#dc2626', '#8b5cf6', '#ec4899'];
            const datasets = Object.keys(vendorData).map((vendor, idx) => ({
                label: vendor,
                data: vendorData[vendor],
                borderColor: colors[idx % colors.length],
                backgroundColor: colors[idx % colors.length] + '40',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8
            }));

            const ctx = document.getElementById('priceHistoryChart');
            if (priceHistoryChart) priceHistoryChart.destroy();
            priceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            title: { display: true, text: 'Purchase Date' }
                        },
                        y: {
                            title: { display: true, text: 'Price ($)' },
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderVarianceAnalysis(data) {
            const vendorStats = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { prices: [], count: 0 };
                }
                vendorStats[vendor].prices.push(parseFloat(item.unit_price));
                vendorStats[vendor].count++;
            });

            const analysis = Object.keys(vendorStats).map(vendor => {
                const prices = vendorStats[vendor].prices;
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const avg = prices.reduce((a,b) => a+b, 0) / prices.length;
                const variance = max - min;
                const variancePct = (variance / min * 100).toFixed(1);

                return { vendor, min, max, avg, variance, variancePct, count: prices.length };
            }).sort((a,b) => a.avg - b.avg);

            const container = document.getElementById('varianceAnalysis');
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--neutral-100); font-weight: 700;">
                            <th style="padding: 1rem; text-align: left;">Vendor</th>
                            <th style="padding: 1rem; text-align: right;">Purchases</th>
                            <th style="padding: 1rem; text-align: right;">Min Price</th>
                            <th style="padding: 1rem; text-align: right;">Avg Price</th>
                            <th style="padding: 1rem; text-align: right;">Max Price</th>
                            <th style="padding: 1rem; text-align: right;">Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.map(stat => `
                            <tr style="border-bottom: 1px solid var(--neutral-200);">
                                <td style="padding: 1rem;"><span class="vendor-badge">${stat.vendor}</span></td>
                                <td style="padding: 1rem; text-align: right;">${stat.count}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--success-600); font-weight: 600;">$${stat.min.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600;">$${stat.avg.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--warning-600); font-weight: 600;">$${stat.max.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-family: var(--font-mono); font-weight: 700; color: var(--accent-500);">
                                    ${stat.variancePct}%
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTableBody');
            const count = filteredInvoices.length;
            document.getElementById('invoiceCount').textContent = `${count} invoice${count !== 1 ? 's' : ''}`;
            
            // CALCULATE SPENDING SUMMARY
            const totalSpent = filteredInvoices.reduce((sum, inv) => sum + parseFloat(inv.total || inv.amount || 0), 0);
            const averageInvoice = count > 0 ? totalSpent / count : 0;
            const vendorSet = new Set(filteredInvoices.map(inv => inv.vendor));
            const uniqueVendors = vendorSet.size;
            
            // Find highest and lowest invoice
            const amounts = filteredInvoices.map(inv => parseFloat(inv.total || inv.amount || 0));
            const highest = count > 0 ? Math.max(...amounts) : 0;
            const lowest = count > 0 ? Math.min(...amounts) : 0;
            
            // FORMAT NUMBERS FIRST (avoid template literal issues)
            const totalSpentFormatted = '$' + totalSpent.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const averageInvoiceFormatted = '$' + averageInvoice.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const highestFormatted = '$' + highest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            const lowestFormatted = '$' + lowest.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            
            // RENDER SPENDING SUMMARY CARDS
            const summaryContainer = document.getElementById('spendingSummary');
            summaryContainer.innerHTML = `
                <!-- Total Spent -->
                <div style="background: linear-gradient(135deg, var(--primary-500) 0%, var(--primary-600) 100%); padding: 1.5rem; border-radius: 12px; box-shadow: 0 4px 12px rgba(139, 32, 32, 0.3); color: white;">
                    <div style="font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; opacity: 0.9; margin-bottom: 0.5rem;">Total Spending</div>
                    <div style="font-size: 2rem; font-weight: 700; font-variant-numeric: tabular-nums; margin-bottom: 0.25rem;">${totalSpentFormatted}</div>
                    <div style="font-size: 0.75rem; opacity: 0.8;">Across ${count} invoice${count !== 1 ? 's' : ''}</div>
                </div>
                
                <!-- Average Invoice -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #10b981;">
                    <div style="font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem;">Average Invoice</div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: #0f172a; font-variant-numeric: tabular-nums; margin-bottom: 0.25rem;">${averageInvoiceFormatted}</div>
                    <div style="font-size: 0.75rem; color: #64748b;">Per invoice</div>
                </div>
                
                <!-- Unique Vendors -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #f59e0b;">
                    <div style="font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem;">Unique Vendors</div>
                    <div style="font-size: 1.75rem; font-weight: 700; color: #0f172a; margin-bottom: 0.25rem;">${uniqueVendors}</div>
                    <div style="font-size: 0.75rem; color: #64748b;">Active suppliers</div>
                </div>
                
                <!-- Highest/Lowest -->
                <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-left: 4px solid #8b5cf6;">
                    <div style="font-size: 0.6875rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.05em; color: #64748b; margin-bottom: 0.5rem;">Range</div>
                    <div style="display: flex; justify-content: space-between; align-items: baseline;">
                        <div>
                            <div style="font-size: 0.6875rem; color: #64748b; margin-bottom: 0.25rem;">High</div>
                            <div style="font-size: 1.125rem; font-weight: 700; color: #059669;">${highestFormatted}</div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-size: 0.6875rem; color: #64748b; margin-bottom: 0.25rem;">Low</div>
                            <div style="font-size: 1.125rem; font-weight: 700; color: #dc2626;">${lowestFormatted}</div>
                        </div>
                    </div>
                </div>
            `;
            
            // RENDER TABLE
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="7" style="padding: 4rem; text-align: center;">
                            <div style="font-size: 3rem; opacity: 0.2; margin-bottom: 1rem;">📄</div>
                            <div style="font-size: 1.125rem; font-weight: 600; color: #64748b; margin-bottom: 0.5rem;">No Invoices Found</div>
                            <div style="font-size: 0.875rem; color: #94a3b8;">Click "Add Invoice" to create your first invoice</div>
                        </td>
                    </tr>
                `;
                return;
            }
            
            // RENDER PROFESSIONAL TABLE ROWS
            tbody.innerHTML = filteredInvoices.map((inv, index) => {
                const total = parseFloat(inv.total || inv.amount || 0);
                const vendorLogo = getVendorLogo(inv.vendor);
                const rowBg = index % 2 === 0 ? '#ffffff' : '#f8fafc';
                
                return `
                <tr style="background: ${rowBg}; border-bottom: 1px solid #e2e8f0; transition: all 0.15s;" 
                    onmouseover="this.style.background='#eff6ff'" 
                    onmouseout="this.style.background='${rowBg}'">
                    
                    <!-- Vendor with Logo -->
                    <td style="padding: 1rem; white-space: nowrap;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            ${vendorLogo ? `
                                <img src="${vendorLogo}" 
                                     onerror="this.style.display='none'" 
                                     style="width: 36px; height: 36px; object-fit: contain; border-radius: 6px; background: white; padding: 0.25rem; border: 1px solid #e2e8f0; flex-shrink: 0;" 
                                     alt="${inv.vendor}">
                            ` : `
                                <div style="width: 36px; height: 36px; background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: #4f46e5; font-size: 0.875rem; flex-shrink: 0;">
                                    ${inv.vendor.charAt(0)}
                                </div>
                            `}
                            <div style="font-weight: 600; color: #0f172a; font-size: 0.875rem; line-height: 1.3;">${inv.vendor}</div>
                        </div>
                    </td>
                    
                    <!-- Date -->
                    <td style="padding: 1rem; color: #475569; font-size: 0.875rem; white-space: nowrap;">${formatDate(inv.invoice_date)}</td>
                    
                    <!-- Invoice # -->
                    <td style="padding: 1rem; font-family: 'Monaco', 'Courier New', monospace; font-weight: 600; color: #1e293b; font-size: 0.8125rem;">${inv.invoice_number}</td>
                    
                    <!-- Check # -->
                    <td style="padding: 1rem; font-family: 'Monaco', 'Courier New', monospace; color: #64748b; font-size: 0.8125rem;">${inv.check_number || '—'}</td>
                    
                    <!-- Amount -->
                    <td style="padding: 1rem; text-align: right; font-family: 'Monaco', 'Courier New', monospace; font-weight: 700; color: #0f172a; font-size: 0.9375rem; font-variant-numeric: tabular-nums;">$${total.toFixed(2)}</td>
                    
                    <!-- Notes -->
                    <td style="padding: 1rem; color: #64748b; font-size: 0.8125rem; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;" title="${inv.notes || ''}">${inv.notes || '—'}</td>
                    
                    <!-- Actions -->
                    <td style="padding: 1rem;">
                        <div style="display: flex; gap: 0.375rem; justify-content: center;">
                            <button onclick="recalculateInvoiceTotals('${inv.id}')" title="Recalculate" 
                                    style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: var(--primary-400); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s;" 
                                    onmouseover="this.style.background='#eff6ff'; this.style.borderColor='var(--primary-400)'" 
                                    onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e1'">
                                <i class="fas fa-sync" style="font-size: 0.75rem;"></i>
                            </button>
                            <button onclick="editInvoice('${inv.id}')" title="Edit" 
                                    style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: #64748b; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s;" 
                                    onmouseover="this.style.background='#f1f5f9'; this.style.borderColor='#64748b'" 
                                    onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e1'">
                                <i class="fas fa-edit" style="font-size: 0.75rem;"></i>
                            </button>
                            <button onclick="deleteInvoice('${inv.id}')" title="Delete" 
                                    style="width: 32px; height: 32px; border-radius: 6px; border: 1px solid #cbd5e1; background: white; color: #ef4444; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.15s;" 
                                    onmouseover="this.style.background='#fef2f2'; this.style.borderColor='#ef4444'" 
                                    onmouseout="this.style.background='white'; this.style.borderColor='#cbd5e1'">
                                <i class="fas fa-trash" style="font-size: 0.75rem;"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }
             


        function renderVendorDistributionChart() {
            const vendorCounts = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            const ctx = document.getElementById('vendorDistributionChart');
            if (vendorDistributionChart) vendorDistributionChart.destroy();
            vendorDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(vendorCounts),
                    datasets: [{
                        data: Object.values(vendorCounts),
                        backgroundColor: ['#6B4444','#C48A00','#10b981','#dc2626','#8b5cf6','#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderVendorsOverviewTable() {
            const tbody = document.getElementById('vendorsTableBody');
            const vendorStats = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { count: 0, lastPurchase: null, totalValue: 0 };
                }
                vendorStats[vendor].count++;
                vendorStats[vendor].totalValue += parseFloat(item.unit_price || 0);
                const purchaseDate = new Date(item.purchase_date);
                if (!vendorStats[vendor].lastPurchase || purchaseDate > vendorStats[vendor].lastPurchase) {
                    vendorStats[vendor].lastPurchase = purchaseDate;
                }
            });

            const vendors = Object.keys(vendorStats).sort();
            document.getElementById('vendorCount').textContent = `${vendors.length} vendors`;

            tbody.innerHTML = vendors.map(vendor => {
                const stats = vendorStats[vendor];
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : '<div style="width: 120px; height: 120px; background: var(--neutral-200); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--neutral-500); font-size: 2rem;">' + vendor.substring(0, 2).toUpperCase() + '</div>';
                
                return `
                    <tr>
                        <td>${logoHtml}</td>
                        <td><span class="vendor-badge">${vendor}</span></td>
                        <td>${stats.count}</td>
                        <td>${stats.lastPurchase ? formatDate(stats.lastPurchase.toISOString()) : 'N/A'}</td>
                        <td><span class="price-cell">$${stats.totalValue.toFixed(2)}</span></td>
                    </tr>
                `;
            }).join('');
        }

function performSearch() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    filteredData = inventoryData.filter(item => {
        const name = (item.product_name || '').toLowerCase();
        const code = (item.item_code || '').toLowerCase();
        const vendor = (item.vendor || '').toLowerCase();
        return name.includes(term) || code.includes(term) || vendor.includes(term);
    });
    applyFilters();
}

   function applyFilters() {
    const vendorFilter = document.getElementById('vendorFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const assignedFilter = document.getElementById('assignedToFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;  // ADD THIS LINE

    let data = filteredData.length > 0 ? filteredData : inventoryData;

    if (vendorFilter) {
        data = data.filter(i => i.vendor === vendorFilter);
    }

    if (yearFilter) {
        data = data.filter(i => new Date(i.purchase_date).getFullYear().toString() === yearFilter);
    }

    if (assignedFilter) {
        if (assignedFilter === 'unassigned') {
            data = data.filter(i => !i.assigned_to || i.assigned_to.length === 0);
        } else {
            data = data.filter(i => {
                if (!i.assigned_to) return false;
                return Array.isArray(i.assigned_to) && i.assigned_to.includes(assignedFilter);
            });
        }
    }

    // ADD THIS BLOCK
    if (categoryFilter) {
        data = data.filter(i => i.category === categoryFilter);
    }

    filteredData = data;
    renderInventoryTable();
    updateRecordCount();
}

        function populateVendorFilter() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('vendorFilter');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function populateProductSelects() {
            const uniqueProducts = [...new Set(inventoryData.map(i => i.product_name).filter(p => p))].sort();
            const select = document.getElementById('analyticsProductSelect');
            select.innerHTML = '<option value="">Choose a product to compare prices...</option>';
            uniqueProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = `${filteredData.length} of ${inventoryData.length} items`;
        }

      
      function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    // Parse date string manually to avoid timezone conversion
    const parts = dateString.split('T')[0].split('-'); // Get YYYY-MM-DD part
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Create date object using local timezone components
    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}
      
      
      
      
      
      
      
              function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

    
// Tab label map for the corporate nav indicator
const CORP_TAB_LABELS = {
    inventory: 'Inventory View', quickEdit: 'Quick Edit', analytics: 'Analytics & Insights',
    vendorSpending: 'Vendor Spending Analysis', invoices: 'Invoice Tracking',
    vendors: 'Vendor Management', julioOrders: "Julio's Orders", ronyOrders: "Rony's Orders",
    officeOrders: 'Office Orders', placeOrder: 'Place Order', inventorySettings: 'Inventory Settings',
    submissionHistory: 'Submission History', stockAlerts: 'Stock Alerts',
    consumptionTracking: 'Consumption & Orders', inventoryValuation: 'Valuation Reports',
    budgetTracking: 'Budget Tracking', vendorPerformance: 'Vendor Performance', imageGallery: 'Image Gallery',
    // Reports v4
    rpt_vendor_analysis: 'Vendor & Purchase Analysis', rpt_cogs: 'COGS Report',
    rpt_price_variance: 'Price Variance & Tracking', rpt_inventory_intel: 'Inventory Intelligence',
    rpt_top10: 'Top 10 Purchased Items', rpt_fast_slow: 'Fast vs Slow Moving',
    rpt_dead_stock: 'Dead Stock Report', rpt_high_value: 'High Value Exposure',
    rpt_monthly_trend: 'Monthly Spend Trend', rpt_turnover: 'Inventory Turnover',
    rpt_price_volatility: 'Vendor Price Volatility', rpt_shrinkage: 'Shrinkage & Adjustments',
    rpt_order_history: 'Order History Report', rpt_order_frequency: 'Order Frequency Report',
    rpt_delivery_accuracy: 'Delivery Accuracy Report', rpt_executive_summary: 'Executive Summary Report',
    rpt_purchase_summary: 'Purchase Summary (Legacy)', rpt_vendor_spend: 'Vendor Spend (Legacy)',
    rpt_stock_valuation: 'Stock Valuation (Legacy)', rpt_low_stock: 'Low Stock (Legacy)',
    rpt_par_compliance: 'PAR Compliance (Legacy)', rpt_consumption: 'Consumption (Legacy)'
};
const CORP_TAB_GROUPS = {
    inventory: 'inventory', quickEdit: 'inventory', imageGallery: 'inventory', inventorySettings: 'inventory',
    analytics: 'analytics', vendorSpending: 'analytics', inventoryValuation: 'analytics',
    budgetTracking: 'analytics', vendorPerformance: 'analytics', consumptionTracking: 'analytics',
    invoices: 'procurement', vendors: 'procurement', placeOrder: 'procurement',
    julioOrders: 'orders', ronyOrders: 'orders', officeOrders: 'orders',
    stockAlerts: 'operations', submissionHistory: 'operations',
    rpt_vendor_analysis: 'reports', rpt_cogs: 'reports', rpt_price_variance: 'reports',
    rpt_inventory_intel: 'reports', rpt_top10: 'reports', rpt_fast_slow: 'reports',
    rpt_dead_stock: 'reports', rpt_high_value: 'reports', rpt_monthly_trend: 'reports',
    rpt_turnover: 'reports', rpt_price_volatility: 'reports', rpt_shrinkage: 'reports',
    rpt_order_history: 'reports', rpt_order_frequency: 'reports',
    rpt_delivery_accuracy: 'reports', rpt_executive_summary: 'reports',
    rpt_purchase_summary: 'reports', rpt_vendor_spend: 'reports',
    rpt_stock_valuation: 'reports', rpt_low_stock: 'reports',
    rpt_par_compliance: 'reports', rpt_consumption: 'reports'
};

function corpNav(tabName) {
    switchTab(tabName, null);
    // Update corporate nav active states
    document.querySelectorAll('.corp-nav-btn').forEach(btn => btn.classList.remove('group-active'));
    const groupId = CORP_TAB_GROUPS[tabName];
    if (groupId) {
        const groupBtn = document.getElementById('corpGroup_' + groupId);
        if (groupBtn) groupBtn.classList.add('group-active');
    }
    // Update all dropdown nav-tabs active state
    document.querySelectorAll('.corp-nav-dropdown .nav-tab').forEach(btn => btn.classList.remove('active'));
    // Mark correct dropdown item
    document.querySelectorAll('.corp-nav-dropdown .nav-tab').forEach(btn => {
        if (btn.getAttribute('onclick') === `corpNav('${tabName}')`) btn.classList.add('active');
    });
    // Update active label
    const label = document.getElementById('corpNavActiveLabel');
    if (label) label.textContent = CORP_TAB_LABELS[tabName] || tabName;
    // ✅ Persist current tab so page refresh returns here
    try { localStorage.setItem('jengchi_active_tab', tabName); } catch(e) {}
}

// ✅ Restore last tab on page load
function restoreLastTab() {
    try {
        const saved = localStorage.getItem('jengchi_active_tab');
        if (saved && document.getElementById(saved)) {
            corpNav(saved);
            return true;
        }
    } catch(e) {}
    return false;
}

function switchTab(tabName, evt) {
    // Stop Place Order auto-refresh when navigating away
    if (tabName !== 'placeOrder' && typeof stopPlaceOrderAutoRefresh === 'function') {
        stopPlaceOrderAutoRefresh();
    }

    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
    
    if (evt && evt.target) {
        evt.target.classList.add('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    
    if (tabName === 'quickEdit') {
        renderQuickEditTable();
    } else if (tabName === 'vendors') {
        loadVendorManagement();
    } else if (tabName === 'vendorSpending') {
        // Set default week date if empty
        const weekInput = document.getElementById('vsaWeekDate');
        if (weekInput && !weekInput.value) {
            const today = new Date();
            weekInput.value = today.toISOString().slice(0, 10);
        }
        // Set default month
        const monthSel = document.getElementById('vsaMonth');
        if (monthSel && !monthSel.value) monthSel.value = new Date().getMonth() + 1;
        setVSAPeriod('week');
        loadVendorSpendingAnalysis();
    } else if (tabName === 'julioOrders') {
        loadJulioOrders();
    } else if (tabName === 'ronyOrders') {
        loadRonyOrders();
    } else if (tabName === 'officeOrders') {
        loadOfficeOrders();
    } else if (tabName === 'placeOrder') {
        initializeEnhancedPlaceOrder();
    } else if (tabName === 'inventorySettings') {
        loadInventorySettings();
    } else if (tabName === 'submissionHistory') {
        loadSubmissionHistory();
    } else if (tabName === 'stockAlerts') {
        loadStockAlerts();
    } else if (tabName === 'consumptionTracking') {
        loadConsumptionData();
    } else if (tabName === 'inventoryValuation') {
        loadValuationReport();
    } else if (tabName === 'budgetTracking') {
        loadBudgetTracking();
    } else if (tabName === 'vendorPerformance') {
        loadVendorPerformance();
    } else if (tabName === 'imageGallery') {
        console.log('🖼️ Image Gallery tab clicked!');
        setTimeout(() => {
            console.log('⏰ Calling loadImageGallery after timeout...');
            if (typeof loadImageGallery === 'function') {
                loadImageGallery();
            } else {
                console.error('❌ loadImageGallery is not defined!');
            }
        }, 100);
    } else if (tabName && tabName.startsWith('rpt_')) {
        if (typeof loadReport === 'function') loadReport(tabName);
    }
}



// ╔══════════════════════════════════════════════════════════════════════╗
// ║  JENG CHI — REPORTS ENGINE v4                                       ║
// ║  Consolidated | Enhanced Filters | Per-Vendor Charts | Price Track  ║
// ╚══════════════════════════════════════════════════════════════════════╝

const JENGCHI = {
    name:    'Jeng Chi Restaurant',
    address: '1400 N Greenville Ave, Richardson, TX 75081',
    phone:   '(972) 479-0600',
    email:   'admin@jengchirestaurant.com',
    logo:    'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg',
    tagline: 'Food · Drink · Dessert',
    disclaimer: 'This report is generated by the Jeng Chi Inventory Intelligence Platform for internal use only. Data reflects the most recently synced records. For questions contact admin@jengchirestaurant.com.'
};

const RPT_CONFIG = {
    // ── Financial ─────────────────────────────────────────────────────
    rpt_vendor_analysis:  { title:'Vendor & Purchase Analysis',   icon:'🏭', color:[44,88,136],   category:'Financial'  },
    rpt_cogs:             { title:'Cost of Goods Sold (COGS)',     icon:'📊', color:[5,150,105],   category:'Financial'  },
    rpt_price_variance:   { title:'Price Variance & Tracking',     icon:'📈', color:[220,38,38],   category:'Financial'  },
    // ── Inventory ─────────────────────────────────────────────────────
    rpt_inventory_intel:  { title:'Inventory Intelligence',        icon:'📦', color:[79,70,229],   category:'Inventory'  },
    rpt_top10:            { title:'Top 10 Purchased Items',        icon:'🏆', color:[217,119,6],   category:'Inventory'  },
    rpt_fast_slow:        { title:'Fast vs Slow Moving Items',     icon:'⚡', color:[5,150,105],   category:'Inventory'  },
    rpt_dead_stock:       { title:'Dead Stock Report',             icon:'💀', color:[107,114,128], category:'Inventory'  },
    rpt_high_value:       { title:'High Value Inventory Exposure', icon:'💎', color:[124,58,237],  category:'Inventory'  },
    // ── Analytics ─────────────────────────────────────────────────────
    rpt_monthly_trend:    { title:'Monthly Spend Trend',           icon:'📅', color:[14,165,233],  category:'Analytics'  },
    rpt_turnover:         { title:'Inventory Turnover Report',     icon:'🔄', color:[5,150,105],   category:'Analytics'  },
    rpt_price_volatility: { title:'Vendor Price Volatility',       icon:'📉', color:[220,38,38],   category:'Analytics'  },
    rpt_shrinkage:        { title:'Shrinkage & Adjustments',       icon:'⚖️', color:[217,119,6],   category:'Analytics'  },
    // ── Orders ────────────────────────────────────────────────────────
    rpt_order_history:    { title:'Order History Report',          icon:'📋', color:[44,88,136],   category:'Orders'     },
    rpt_order_frequency:  { title:'Order Frequency Report',        icon:'🔁', color:[5,150,105],   category:'Orders'     },
    rpt_delivery_accuracy:{ title:'Delivery Accuracy Report',      icon:'🚚', color:[217,119,6],   category:'Orders'     },
    rpt_executive_summary:{ title:'Executive Summary Report',      icon:'⭐', color:[44,44,44],    category:'Executive'  },
    // ── Legacy stubs (kept for backward compat) ───────────────────────
    rpt_purchase_summary: { title:'Purchase Summary (Legacy)',     icon:'🧾', color:[44,88,136],   category:'Financial'  },
    rpt_vendor_spend:     { title:'Vendor Spend (Legacy)',         icon:'💳', color:[217,119,6],   category:'Financial'  },
    rpt_stock_valuation:  { title:'Stock Valuation (Legacy)',      icon:'📦', color:[44,88,136],   category:'Inventory'  },
    rpt_low_stock:        { title:'Low Stock (Legacy)',            icon:'⚠️', color:[220,38,38],   category:'Inventory'  },
    rpt_par_compliance:   { title:'PAR Compliance (Legacy)',       icon:'🎯', color:[5,150,105],   category:'Inventory'  },
    rpt_consumption:      { title:'Consumption (Legacy)',          icon:'🔥', color:[217,119,6],   category:'Inventory'  },
};

let _rptCurrentTab = null;
let _rptData       = {};
let _rptCharts     = {};
let _rptCurrentSec = null;  // active section element — used for scoped querySelector

// Always query inside the active report section to avoid duplicate-ID collision
function rptEl(id) {
    if (_rptCurrentSec) {
        const el = _rptCurrentSec.querySelector('[id="' + id + '"]');
        if (el) return el;
    }
    return document.getElementById(id);
}

// ── ENTRY POINT ───────────────────────────────────────────────────────
async function loadReport(reportType) {
    console.log('📊 [loadReport] START:', reportType);
    _rptCurrentTab = reportType;
    const cfg = RPT_CONFIG[reportType];
    if (!cfg) { console.error('❌ No config for:', reportType); return; }

    const sec = document.getElementById(reportType);
    if (!sec) { console.error('❌ DOM section not found:', reportType); return; }

    _rptCurrentSec = sec;
    sec.innerHTML = rptBuildShell(reportType, cfg);

    const bar = () => sec.querySelector('[id="rptLoadingBar"]');
    try {
        if (bar()) { bar().style.width = '20%'; bar().style.opacity = '1'; }
        const data = await rptFetchData(reportType);
        _rptData[reportType] = data;
        if (bar()) bar().style.width = '80%';
        rptRenderBody(reportType, cfg, data);
        if (bar()) { bar().style.width = '100%'; setTimeout(() => { if (bar()) bar().style.opacity = '0'; }, 500); }
        console.log('✅ [loadReport] Done:', reportType);
    } catch(e) {
        console.error('❌ [loadReport] Error:', e);
        const errDiv = document.createElement('div');
        errDiv.style.cssText = 'margin:1.5rem;padding:1.5rem 2rem;background:#fef2f2;border:1px solid #fecaca;border-radius:12px;color:#dc2626;font-family:monospace;';
        errDiv.innerHTML = `<div style="font-size:1.1rem;font-weight:700;margin-bottom:.75rem;">⚠️ Report Error</div>
            <div style="font-size:.875rem;padding:.75rem;background:#fff5f5;border-radius:6px;">${e.message}</div>
            <button onclick="loadReport('${reportType}')" style="margin-top:1rem;padding:.6rem 1.25rem;background:#dc2626;color:white;border:none;border-radius:6px;cursor:pointer;font-weight:700;">🔄 Retry</button>`;
        sec.appendChild(errDiv);
    }
}

// ── SHELL BUILDER ─────────────────────────────────────────────────────
function rptBuildShell(tabName, cfg) {
    const [r,g,b] = cfg.color;
    const now = new Date();
    const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const monthOpts = months.map((m,i)=>`<option value="${i+1}" ${i===now.getMonth()?'selected':''}>${m} ${now.getFullYear()}</option>`).join('');
    const yearOpts = [2022,2023,2024,2025,2026,2027].map(y=>`<option value="${y}" ${y===now.getFullYear()?'selected':''}>${y}</option>`).join('');
    const dayOpts = Array.from({length:31},(_,i)=>`<option value="${i+1}">${String(i+1).padStart(2,'0')}</option>`).join('');

    return `<div style="max-width:1500px;margin:0 auto;">
      <!-- Progress bar -->
      <div style="height:3px;background:var(--neutral-200);border-radius:2px;margin-bottom:1.5rem;overflow:hidden;">
        <div id="rptLoadingBar" style="height:100%;width:0%;background:rgb(${r},${g},${b});border-radius:2px;transition:width .4s ease,opacity .5s ease;opacity:0;"></div>
      </div>

      <!-- Header -->
      <div style="background:linear-gradient(135deg,rgb(${r},${g},${b}),rgba(${r},${g},${b},.7));border-radius:16px;padding:1.75rem 2rem;color:white;margin-bottom:1.5rem;box-shadow:0 8px 24px rgba(${r},${g},${b},.25);">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;gap:1rem;flex-wrap:wrap;">
          <div>
            <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.1em;opacity:.75;margin-bottom:.4rem;">${cfg.category} · Jeng Chi Restaurant</div>
            <h2 style="font-size:1.6rem;font-weight:800;margin:0 0 .3rem;">${cfg.icon} ${cfg.title}</h2>
            <div style="font-size:.8rem;opacity:.8;">Generated: ${now.toLocaleDateString('en-US',{weekday:'long',year:'numeric',month:'long',day:'numeric'})} · ${now.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'})}</div>
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap;align-items:flex-start;">
            <button onclick="rptExportPDF('${tabName}')" style="background:white;color:rgb(${r},${g},${b});border:none;border-radius:8px;padding:.6rem 1.1rem;font-weight:700;font-size:.8rem;cursor:pointer;display:flex;align-items:center;gap:.4rem;box-shadow:0 2px 8px rgba(0,0,0,.15);">
              <i class="fas fa-file-pdf"></i> Export PDF
            </button>
            <button onclick="loadReport('${tabName}')" style="background:rgba(255,255,255,.2);color:white;border:2px solid rgba(255,255,255,.4);border-radius:8px;padding:.6rem 1.1rem;font-weight:700;font-size:.8rem;cursor:pointer;">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
        </div>
      </div>

      <!-- ── ENHANCED FILTERS ── -->
      <div style="background:white;border-radius:12px;padding:1rem 1.5rem 1.2rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);margin-bottom:1.25rem;">
        <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.07em;color:var(--neutral-500);margin-bottom:.75rem;">🔎 Filter &amp; Search</div>
        <div style="display:flex;flex-wrap:wrap;gap:.85rem;align-items:flex-end;">

          <!-- Year -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">📅 Year</label>
            <select id="rptYear" class="search-input" onchange="loadReport('${tabName}')">${yearOpts}</select>
          </div>

          <!-- Month -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">📆 Month</label>
            <select id="rptMonth" class="search-input" onchange="rptHandleMonthChange('${tabName}')">
              <option value="0">— All —</option>
              ${monthOpts}
            </select>
          </div>

          <!-- Day -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">📌 Day</label>
            <select id="rptDay" class="search-input" onchange="loadReport('${tabName}')">
              <option value="0">— All —</option>
              ${dayOpts}
            </select>
          </div>

          <!-- Time Range -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">⏱ Range</label>
            <select id="rptRange" class="search-input" onchange="loadReport('${tabName}')">
              <option value="custom">Custom</option>
              <option value="7">Last 7 Days</option>
              <option value="30">Last 30 Days</option>
              <option value="90">Last 90 Days</option>
              <option value="180">Last 6 Months</option>
              <option value="365">Last 12 Months</option>
              <option value="ytd">Year to Date</option>
            </select>
          </div>

          <!-- Vendor -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">🏭 Vendor</label>
            <select id="rptVendor" class="search-input" onchange="loadReport('${tabName}')">
              <option value="">All Vendors</option>
            </select>
          </div>

          <!-- Category -->
          <div>
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">🗂 Category</label>
            <select id="rptCategory" class="search-input" onchange="loadReport('${tabName}')">
              <option value="">All Categories</option>
            </select>
          </div>

          <!-- Search -->
          <div style="flex:1;min-width:180px;">
            <label style="display:block;font-size:.68rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-600);margin-bottom:.25rem;">🔍 Search</label>
            <input type="text" id="rptSearch" class="search-input" placeholder="Filter results…" oninput="rptFilterTable()" style="width:100%">
          </div>

          <!-- Clear Filters -->
          <div>
            <label style="display:block;font-size:.68rem;color:transparent;margin-bottom:.25rem;">.</label>
            <button onclick="rptClearFilters('${tabName}')" style="padding:.45rem .9rem;background:var(--neutral-100);border:1px solid var(--neutral-300);border-radius:6px;font-size:.8rem;cursor:pointer;color:var(--neutral-600);">✕ Clear</button>
          </div>

        </div>
      </div>

      <!-- Date notice banner -->
      <div id="rptDateNotice" style="display:none;padding:.65rem 1rem;background:#fef9c3;border:1px solid #fde047;border-radius:8px;font-size:.82rem;color:#713f12;margin-bottom:1rem;">
        📅 <span id="rptDateNoticeText"></span>
      </div>

      <!-- KPI Row -->
      <div id="rptKPIs" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(175px,1fr));gap:.85rem;margin-bottom:1.5rem;">
        <div style="background:white;border-radius:10px;padding:2rem;border:1px solid var(--neutral-200);text-align:center;color:var(--neutral-400);grid-column:1/-1;">
          <i class="fas fa-spinner fa-spin" style="font-size:1.5rem;margin-bottom:.5rem;display:block;"></i> Loading data…
        </div>
      </div>

      <!-- Chart area (flexible, filled by each report) -->
      <div id="rptChartRow" style="display:grid;grid-template-columns:1fr 1fr;gap:1.25rem;margin-bottom:1.5rem;"></div>

      <!-- Extra content area (per-vendor charts, product timelines, etc.) -->
      <div id="rptExtras" style="margin-bottom:1.5rem;"></div>

      <!-- Main table -->
      <div style="background:white;border-radius:12px;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);overflow:hidden;">
        <div style="display:flex;justify-content:space-between;align-items:center;padding:.9rem 1.25rem;border-bottom:1px solid var(--neutral-200);background:var(--neutral-50);">
          <h3 id="rptTableTitle" style="font-size:.95rem;font-weight:700;margin:0;color:var(--neutral-900);">Loading…</h3>
          <span id="rptTableCount" style="font-size:.78rem;color:var(--neutral-500);"></span>
        </div>
        <div style="overflow-x:auto;">
          <table class="data-table" style="margin:0;">
            <thead><tr id="rptTableHead"></tr></thead>
            <tbody id="rptTableBody">
              <tr><td colspan="12" style="text-align:center;padding:2rem;color:var(--neutral-400);">
                <i class="fas fa-spinner fa-spin"></i> Fetching data…
              </td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>`;
}

// ── FILTER HELPERS ────────────────────────────────────────────────────
function rptHandleMonthChange(tabName) {
    // When month changes, reset Day to All
    const day = rptEl('rptDay');
    if (day) day.value = '0';
    loadReport(tabName);
}
function rptClearFilters(tabName) {
    const yr = rptEl('rptYear'); if (yr) yr.value = new Date().getFullYear();
    const mo = rptEl('rptMonth'); if (mo) mo.value = '0';
    const dy = rptEl('rptDay'); if (dy) dy.value = '0';
    const rg = rptEl('rptRange'); if (rg) rg.value = 'custom';
    const vn = rptEl('rptVendor'); if (vn) vn.value = '';
    const ct = rptEl('rptCategory'); if (ct) ct.value = '';
    const sr = rptEl('rptSearch'); if (sr) sr.value = '';
    loadReport(tabName);
}

// ── DATA FETCHER v4 ───────────────────────────────────────────────────
async function rptFetchData(tabName) {
    if (!supabaseClient) {
        if (typeof getSupabaseClient === 'function') supabaseClient = getSupabaseClient();
        else throw new Error('supabaseClient not initialized — please reload.');
    }

    // ── Read filter values ─────────────────────────────────────────────
    const yearEl  = rptEl('rptYear');
    const monthEl = rptEl('rptMonth');
    const dayEl   = rptEl('rptDay');
    const rangeEl = rptEl('rptRange');
    const vendorEl= rptEl('rptVendor');

    const year  = parseInt(yearEl?.value  || new Date().getFullYear());
    const month = parseInt(monthEl?.value || 0);
    const day   = parseInt(dayEl?.value   || 0);
    const range = rangeEl?.value || 'custom';
    const vendorFilter = vendorEl?.value || '';

    // Compute date range
    let startStr, endStr;
    const now = new Date();

    if (range !== 'custom') {
        if (range === 'ytd') {
            startStr = `${now.getFullYear()}-01-01`;
            endStr   = now.toISOString().slice(0,10);
        } else {
            const days = parseInt(range);
            const start = new Date(now); start.setDate(start.getDate() - days);
            startStr = start.toISOString().slice(0,10);
            endStr   = now.toISOString().slice(0,10);
        }
        // Sync year/month selects to match range (best-effort)
        if (yearEl) yearEl.value = endStr.slice(0,4);
    } else {
        if (month === 0) {
            startStr = `${year}-01-01`;
            endStr   = `${year}-12-31`;
        } else if (day === 0) {
            const lastDay = new Date(year, month, 0).getDate();
            startStr = `${year}-${String(month).padStart(2,'0')}-01`;
            endStr   = `${year}-${String(month).padStart(2,'0')}-${String(lastDay).padStart(2,'0')}`;
        } else {
            const ds = `${year}-${String(month).padStart(2,'0')}-${String(day).padStart(2,'0')}`;
            startStr = ds; endStr = ds;
        }
    }

    console.log(`[rptFetchData v4] Period: ${startStr}→${endStr} | vendor:"${vendorFilter}"`);

    // ── Timeout wrapper ────────────────────────────────────────────────
    function withTimeout(promise, label, ms=15000) {
        return Promise.race([promise, new Promise((_,rej)=>setTimeout(()=>rej(new Error(`"${label}" timed out after ${ms/1000}s`)),ms))]);
    }

    // ── Live status in KPI area ────────────────────────────────────────
    const kpiEl = rptEl('rptKPIs');
    const log = [];
    function status(icon, msg) {
        log.push(`${icon} ${msg}`);
        if (kpiEl) kpiEl.innerHTML = `<div style="grid-column:1/-1;background:white;border-radius:10px;padding:1.25rem 1.5rem;border:1px solid var(--neutral-200);">
          <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;color:var(--neutral-500);margin-bottom:.75rem;">⏳ Loading…</div>
          ${log.map(s=>`<div style="font-size:.82rem;color:var(--neutral-700);padding:.15rem 0;font-family:var(--font-mono);">${s}</div>`).join('')}
        </div>`;
    }

    let mgmt=[], allItems=[], allInv=[], allStock=[], allIc=[];
    let stockError=false, icError=false;

    // ── Sequential targeted fetches ────────────────────────────────────
    status('⏳','Fetching inventory catalog…');
    try {
        const t=Date.now();
        const res = await withTimeout(supabaseClient.from('inventory_management').select('product_name,category,par,on_hand,assigned_to').limit(5000),'inventory_management');
        if (res.error) throw new Error(res.error.message);
        mgmt = res.data || [];
        status('✅',`Catalog: ${mgmt.length} products (${Date.now()-t}ms)`);
    } catch(e) { status('❌',`Catalog failed: ${e.message}`); throw e; }

    status('⏳','Fetching invoices…');
    try {
        const t=Date.now();
        const res = await withTimeout(supabaseClient.from('invoices').select('id,invoice_number,invoice_date,vendor,total,amount,notes').order('invoice_date',{ascending:false}).limit(10000),'invoices');
        if (res.error) throw new Error(res.error.message);
        allInv = res.data || [];
        status('✅',`Invoices: ${allInv.length} rows (${Date.now()-t}ms)`);
    } catch(e) { status('❌',`Invoices failed: ${e.message}`); throw e; }

    status('⏳','Fetching invoice items…');
    try {
        const t=Date.now();
        const res = await withTimeout(supabaseClient.from('invoice_items').select('id,invoice_id,product_name,unit_price,price_per_unit,quantity,weight,has_weight,category').limit(10000),'invoice_items');
        if (res.error) throw new Error(res.error.message);
        allItems = res.data || [];
        status('✅',`Invoice items: ${allItems.length} rows (${Date.now()-t}ms)`);
    } catch(e) { status('❌',`Invoice items failed: ${e.message}`); throw e; }

    status('⏳','Fetching stock snapshots…');
    try {
        const t=Date.now();
        const res = await withTimeout(supabaseClient.from('current_stock').select('product_name,stock_date,quantity_in_stock').limit(5000),'current_stock',8000);
        if (res.error) throw new Error(res.error.message);
        allStock = res.data || [];
        status('✅',`Stock: ${allStock.length} rows (${Date.now()-t}ms)`);
    } catch(e) { stockError=true; status('⚠️',`Stock unavailable: ${e.message}`); }

    status('⏳','Fetching order checks…');
    try {
        const t=Date.now();
        const res = await withTimeout(supabaseClient.from('inventory_check').select('product_name,order_date,tentative,on_hand,user').limit(10000),'inventory_check',8000);
        if (res.error) throw new Error(res.error.message);
        allIc = res.data || [];
        status('✅',`Order checks: ${allIc.length} rows (${Date.now()-t}ms)`);
    } catch(e) { icError=true; status('⚠️',`Order checks unavailable: ${e.message}`); }

    // ── Build lookups ──────────────────────────────────────────────────
    const mgmtMap    = new Map(mgmt.map(p=>[p.product_name, p]));
    const invDateMap = new Map(allInv.map(i=>[i.id, i]));

    // Populate vendor dropdown from invoice data
    const vendors = [...new Set(allInv.map(i=>i.vendor).filter(Boolean))].sort();
    const vendorSel = rptEl('rptVendor');
    if (vendorSel) {
        const cur = vendorSel.value;
        vendorSel.innerHTML = '<option value="">All Vendors</option>' +
            vendors.map(v=>`<option value="${v}" ${v===cur?'selected':''}>${v}</option>`).join('');
    }

    // Populate category dropdown
    const cats = [...new Set(mgmt.map(p=>p.category||'Other').filter(Boolean))].sort();
    const catSel = rptEl('rptCategory');
    if (catSel) {
        const cur = catSel.value;
        catSel.innerHTML = '<option value="">All Categories</option>' +
            cats.map(c=>`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`).join('');
    }

    // ── Enrich invoice items ───────────────────────────────────────────
    const allEnriched = allItems.map(it => {
        const inv  = invDateMap.get(it.invoice_id) || {};
        const ppUnit = parseFloat(it.price_per_unit||0);
        const uPrice = parseFloat(it.unit_price||0);
        let price=0;
        const _wv2 = parseFloat(it.weight||0);
        const _isW2 = !!(it.has_weight || _wv2 > 0);
        if (_isW2 && ppUnit>0)        price=ppUnit;
        else if (uPrice>0)            price=uPrice;
        else if (ppUnit>0)            price=ppUnit;
        // Detect weight items by has_weight flag OR weight column > 0
        const qty = _isW2 ? _wv2 : parseFloat(it.quantity||0);
        const invoice_date = (inv.invoice_date||'').slice(0,10);
        return { ...it, invoice_date,
            vendor:   inv.vendor||'—',
            inv_number: inv.invoice_number||'',
            inv_total:  parseFloat(inv.total||inv.amount||0),
            price, qty, total: price*qty,
            category: mgmtMap.get(it.product_name)?.category || it.category || 'Other',
            par:     parseFloat(mgmtMap.get(it.product_name)?.par||0),
            on_hand: parseFloat(mgmtMap.get(it.product_name)?.on_hand||0)
        };
    });

    // ── Apply date + vendor filters ────────────────────────────────────
    let items    = allEnriched.filter(it=>{
        const d=it.invoice_date;
        return d>=startStr && d<=endStr && (!vendorFilter || it.vendor===vendorFilter);
    });
    let invoices = allInv.filter(i=>{
        const d=(i.invoice_date||'').slice(0,10);
        return d>=startStr && d<=endStr && (!vendorFilter || i.vendor===vendorFilter);
    });
    let stock    = allStock.filter(s=>{const d=(s.stock_date||'').slice(0,10);return d>=startStr&&d<=endStr;});
    let ic       = allIc.filter(r=>{const d=(r.order_date||'').slice(0,10);return d>=startStr&&d<=endStr;});

    // ── Auto-fallback (no vendor filter — only when month is empty) ────
    let usedFallback=false, fallbackMsg='';
    if (items.length===0 && !vendorFilter && month!==0 && range==='custom' && allEnriched.length>0) {
        items    = allEnriched.filter(it=>it.invoice_date.startsWith(String(year)));
        invoices = allInv.filter(i=>(i.invoice_date||'').startsWith(String(year)));
        stock    = allStock.filter(s=>(s.stock_date||'').startsWith(String(year)));
        ic       = allIc.filter(r=>(r.order_date||'').startsWith(String(year)));
        usedFallback=true;
        const mN=['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
        fallbackMsg=`No invoices for ${mN[month-1]} ${year} — showing all of ${year} (${items.length} lines).`;
    }
    if (items.length===0 && !vendorFilter && range==='custom' && allEnriched.length>0) {
        items=allEnriched; invoices=allInv; stock=allStock; ic=allIc;
        usedFallback=true;
        fallbackMsg=`No data for ${year} — showing all-time data (${items.length} lines).`;
    }

    const notice = rptEl('rptDateNotice'), noticeText = rptEl('rptDateNoticeText');
    if (notice&&noticeText) {
        if (usedFallback&&fallbackMsg) { notice.style.display='block'; noticeText.textContent=fallbackMsg; }
        else notice.style.display='none';
    }

    status('✅',`Done — ${items.length} invoice lines ready`);
    console.log(`[rptFetchData v4] FINAL items:${items.length} inv:${invoices.length} stock:${stock.length} ic:${ic.length}`);

    return { mgmt, mgmtMap, items, invoices, stock, ic, allEnriched, allInv, allItems, allStock, allIc,
             startStr, endStr, year, month, day, vendorFilter, usedFallback, stockError, icError, invDateMap };
}

// ── RENDER BODY ───────────────────────────────────────────────────────
function rptRenderBody(tabName, cfg, d) {
    _rptDestroyAllCharts();
    const [r,g,b] = cfg.color;
    const catFilter = rptEl('rptCategory')?.value || '';
    const filtered  = catFilter ? d.items.filter(it=>it.category===catFilter) : d.items;
    const colHex    = `rgb(${r},${g},${b})`;

    const kpiEl   = rptEl('rptKPIs');
    const chartEl = rptEl('rptChartRow');
    const extEl   = rptEl('rptExtras');

    if (!kpiEl||!chartEl) { console.error('❌ KPI/Chart element missing'); return; }

    // ── Helper builders ────────────────────────────────────────────────
    const safeMin = arr=>arr.length?Math.min(...arr):0;
    const safeMax = arr=>arr.length?Math.max(...arr):0;
    const safeAvg = arr=>arr.length?arr.reduce((a,b)=>a+b,0)/arr.length:0;
    const safeStd = arr=>{if(arr.length<2)return 0;const m=safeAvg(arr);return Math.sqrt(arr.map(x=>(x-m)**2).reduce((a,b)=>a+b,0)/arr.length);};
    const fmt$    = n=>n>=1000?`$${(n/1000).toFixed(1)}k`:`$${n.toFixed(2)}`;
    const pct     = (n,t)=>t>0?`${(n/t*100).toFixed(1)}%`:'0%';

    const kpi=(icon,label,val,sub,color='#374151')=>`
        <div style="background:white;border-radius:10px;padding:1rem 1.1rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);border-left:4px solid ${color};">
          <div style="font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:var(--neutral-500);margin-bottom:.25rem;">${icon} ${label}</div>
          <div style="font-size:1.55rem;font-weight:800;font-family:var(--font-mono);color:${color};">${val}</div>
          ${sub?`<div style="font-size:.68rem;color:var(--neutral-400);margin-top:.15rem;">${sub}</div>`:''}
        </div>`;

    const noData=(msg='No data for selected period/filters')=>
        `<tr><td colspan="12" style="text-align:center;padding:3rem;color:var(--neutral-400);font-style:italic;">📭 ${msg}</td></tr>`;

    // ── Card for per-vendor charts ─────────────────────────────────────
    const chartCard=(id,title)=>{
        const d2=document.createElement('div');
        d2.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);margin-bottom:1rem;';
        d2.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">${title}</h4><canvas id="${id}" height="110"></canvas>`;
        return d2;
    };

    console.log(`[rptRenderBody v4] ${tabName} | filtered:${filtered.length}`);

    // ── Invoice modal open helper ──────────────────────────────────────
    window.rptOpenInvoice = async function(invoiceId) {
        const modal = document.getElementById('rptInvoiceModal');
        const content = document.getElementById('rptInvoiceModalContent');
        if (!modal||!content) return;
        modal.style.display='flex';
        content.innerHTML='<div style="text-align:center;padding:3rem;"><i class="fas fa-spinner fa-spin fa-2x" style="color:#6b7280;"></i><div style="margin-top:.75rem;color:#6b7280;">Loading invoice…</div></div>';

        try {
            const inv = d.invDateMap.get(invoiceId) || d.allInv.find(i=>i.id===invoiceId) || {};
            const res = await supabaseClient.from('invoice_items').select('*').eq('invoice_id',invoiceId);
            const items = res.data || [];
            const vc = [44,88,136];

            // ── live-recalc helper: updates row total + invoice grand total ──
            window._rptRecalcRow = function(itemId) {
                const priceIn = document.getElementById('priceInput_'+itemId);
                const qtyIn   = document.getElementById('qtyInput_'+itemId);
                const rowTotal= document.getElementById('rowTotal_'+itemId);
                if (!priceIn||!qtyIn||!rowTotal) return;
                const p = parseFloat(priceIn.value)||0;
                const q = parseFloat(qtyIn.value)||0;
                rowTotal.textContent = '$'+(p*q).toFixed(2);
                // recalc grand total
                let grand = 0;
                document.querySelectorAll('[id^="rowTotal_"]').forEach(el=>{
                    grand += parseFloat(el.textContent.replace('$',''))||0;
                });
                const grandEl = document.getElementById('rptInvGrandTotal');
                if (grandEl) grandEl.textContent = '$'+grand.toFixed(2);
            };

            const rows = items.map(it=>{
                const p   = parseFloat(it.unit_price||it.price_per_unit||0);
                // Detect weight-based: has_weight flag OR weight column has a value > 0
                // (some items were entered without has_weight flag but still store lbs in weight)
                const weightVal = parseFloat(it.weight||0);
                const isW = !!(it.has_weight || weightVal > 0);
                const q   = isW ? weightVal : parseFloat(it.quantity||0);
                const weightBadge = isW
                    ? `<span style="display:inline-block;margin-left:.4rem;padding:.1rem .35rem;background:#fef3c7;color:#92400e;border:1px solid #fde68a;border-radius:4px;font-size:.62rem;font-weight:700;letter-spacing:.03em;">⚖ LB</span>`
                    : '';
                return `<tr id="row_${it.id}">
                  <td><strong>${it.product_name||'—'}</strong>${weightBadge}</td>
                  <td style="color:#6b7280;font-size:.85rem;">${it.category||'—'}</td>
                  <td>
                    <input id="qtyInput_${it.id}" type="number" step="${isW?'0.001':'0.01'}" min="0" value="${q.toFixed(isW?3:2)}"
                      data-is-weight="${isW?'true':'false'}"
                      oninput="_rptRecalcRow('${it.id}')"
                      style="width:${isW?'78px':'65px'};padding:.3rem .4rem;border:1px solid #d1d5db;border-radius:5px;font-size:.82rem;text-align:right;">
                    ${isW?'<span style="font-size:.7rem;color:#92400e;margin-left:.2rem;">lb</span>':''}
                  </td>
                  <td>$${p.toFixed(2)}</td>
                  <td id="rowTotal_${it.id}" style="font-weight:600;">$${(p*q).toFixed(2)}</td>
                  <td>
                    <div style="display:flex;gap:.35rem;align-items:center;">
                      <input id="priceInput_${it.id}" type="number" step="0.01" min="0" value="${p.toFixed(2)}"
                        oninput="_rptRecalcRow('${it.id}')"
                        style="width:80px;padding:.3rem .4rem;border:1px solid #d1d5db;border-radius:5px;font-size:.82rem;">
                      <button id="saveBtn_${it.id}" onclick="rptUpdateItem('${it.id}','${escQ(it.product_name)}','${invoiceId}')"
                        style="padding:.3rem .65rem;background:rgb(${vc});color:white;border:none;border-radius:5px;font-size:.75rem;cursor:pointer;font-weight:600;white-space:nowrap;">💾 Save</button>
                    </div>
                  </td>
                </tr>`;
            }).join('');

            // Fetch the real invoice total from DB (includes tax if applicable)
            let initTotal = 0;
            try {
                const { data: invRow } = await supabaseClient
                    .from('invoices').select('total,amount').eq('id', invoiceId).single();
                initTotal = parseFloat(invRow?.total || invRow?.amount || 0);
            } catch(_) {
                // Fallback: calculate from items if invoices fetch fails
                initTotal = items.reduce((s,it)=>{
                    const p  = parseFloat(it.unit_price||it.price_per_unit||0);
                    const wv = parseFloat(it.weight||0);
                    const isW = !!(it.has_weight || wv > 0);
                    const q  = isW ? wv : parseFloat(it.quantity||0);
                    return s + p * q;
                },0);
            }

            content.innerHTML=`
                <div style="display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:1.5rem;">
                  <div>
                    <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.08em;color:#6b7280;">Invoice Detail</div>
                    <h3 style="font-size:1.4rem;font-weight:800;margin:.25rem 0;">${inv.vendor||'Unknown Vendor'}</h3>
                    <div style="font-size:.85rem;color:#6b7280;">${inv.invoice_date||''} &nbsp;·&nbsp; #${inv.invoice_number||invoiceId.slice(0,8)}</div>
                  </div>
                  <button onclick="document.getElementById('rptInvoiceModal').style.display='none'" style="background:#f3f4f6;border:none;border-radius:8px;padding:.6rem 1rem;cursor:pointer;font-size:.85rem;color:#374151;">✕ Close</button>
                </div>
                <table class="data-table" style="margin:0 0 1rem;">
                  <thead><tr>
                    <th>Product</th>
                    <th>Category</th>
                    <th style="width:100px;">Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th style="width:190px;">Update Price</th>
                  </tr></thead>
                  <tbody>${rows}</tbody>
                  <tfoot><tr>
                    <td colspan="4" style="text-align:right;font-weight:700;padding:.75rem 1rem;">Grand Total:</td>
                    <td id="rptInvGrandTotal" style="font-weight:800;color:rgb(${vc});">$${initTotal.toFixed(2)}</td>
                    <td></td>
                  </tr></tfoot>
                </table>
                ${inv.notes?`<div style="padding:.75rem 1rem;background:#fef9c3;border-radius:8px;font-size:.82rem;color:#713f12;"><strong>Notes:</strong> ${inv.notes}</div>`:''}
            `;
        } catch(e) {
            content.innerHTML=`<div style="color:#dc2626;padding:2rem;">Error loading invoice: ${e.message}</div>`;
        }
    };

    // ── Quote-escape helper (avoids regex inside template literal onclick attrs) ──
    window.escQ = function(s) { return (s || '').replace(/'/g, "\\'"); };

    // ── Save price + qty from the invoice detail modal ──────────────
    window.rptUpdateItem = async function(itemId, productName, invoiceId) {
        const priceIn = document.getElementById('priceInput_'+itemId);
        const qtyIn   = document.getElementById('qtyInput_'+itemId);
        const rowTotal= document.getElementById('rowTotal_'+itemId);
        const btn     = document.getElementById('saveBtn_'+itemId);
        const isWt    = qtyIn && qtyIn.dataset.isWeight === 'true';

        if (!priceIn) { console.error('[rptUpdateItem] priceInput not found:', itemId); return; }

        const newPrice = parseFloat(priceIn.value);
        const newQty   = qtyIn ? parseFloat(qtyIn.value) : null;

        if (isNaN(newPrice) || newPrice < 0) { alert('Invalid price'); return; }
        if (newQty !== null && (isNaN(newQty) || newQty < 0)) { alert('Invalid quantity'); return; }

        if (btn) { btn.disabled=true; btn.textContent='⏳ Saving…'; }

        try {
            // ── Build update payload with correct columns per item type ──
            let updateData = {};
            if (isWt) {
                // Weight-based: price stored in price_per_unit, amount in weight
                const wt = newQty !== null ? newQty : parseFloat(qtyIn?.value||0);
                updateData = {
                    price_per_unit: newPrice,
                    unit_price:     0,
                    weight:         wt,
                    quantity:       0,
                    line_total:     wt * newPrice,
                    has_weight:     true
                };
            } else {
                // Quantity-based: price stored in unit_price, amount in quantity
                const qt = newQty !== null ? Math.round(newQty) : Math.round(parseFloat(qtyIn?.value||0));
                updateData = {
                    unit_price:     newPrice,
                    price_per_unit: 0,
                    quantity:       qt,
                    weight:         0,
                    line_total:     qt * newPrice,
                    has_weight:     false
                };
            }

            console.log('[rptUpdateItem] updating id='+itemId, updateData);
            const { data: saved, error } = await supabaseClient
                .from('invoice_items')
                .update(updateData)
                .eq('id', itemId)
                .select();

            if (error) throw new Error(error.message);

            // ✅ Verify that rows were actually updated (Supabase can silently return [] if RLS blocks)
            if (!saved || saved.length === 0) {
                throw new Error('Save failed: no rows were updated. The record may be locked or not found.');
            }
            console.log('[rptUpdateItem] saved:', saved);

            // ── Update invoice totals in DB (so it matches next time you open) ──
            if (invoiceId) {
                await updateInvoiceTotals(invoiceId);
                // Refresh the grand total shown in modal from DB
                try {
                    const { data: inv } = await supabaseClient
                        .from('invoices').select('total,amount').eq('id', invoiceId).single();
                    const grandEl = document.getElementById('rptInvGrandTotal');
                    if (grandEl && inv) grandEl.textContent = '$'+parseFloat(inv.total||inv.amount||0).toFixed(2);
                } catch(e2) { /* non-critical */ }
            }

            // ── Update the row total display ──────────────────────────
            const dispQty  = newQty !== null ? newQty : 0;
            const lineTotal = dispQty * newPrice;
            if (rowTotal) rowTotal.textContent = '$'+lineTotal.toFixed(2);

            // ── Flash inputs green ────────────────────────────────────
            [priceIn, qtyIn].forEach(el=>{
                if (el) { el.style.background='#d1fae5'; el.style.borderColor='#16a34a'; }
            });
            if (btn) { btn.disabled=false; btn.textContent='✅ Saved!'; btn.style.background='#16a34a'; }
            setTimeout(()=>{
                [priceIn, qtyIn].forEach(el=>{ if(el){ el.style.background=''; el.style.borderColor=''; }});
                if (btn) { btn.textContent='💾 Save'; btn.style.background='rgb(44,88,136)'; }
            }, 2500);

            const qtyLabel = newQty !== null ? newQty.toFixed(isWt?3:2)+(isWt?' lb':'') : '—';
            showAlert('✅ Saved — '+productName+': Qty '+qtyLabel+' · Price $'+newPrice.toFixed(2), 'success');

            // ── Sync in-memory cache ──────────────────────────────────
            const _rptCache = _rptData[_rptCurrentTab] || _rptData['rpt_price_variance'];
            const existing = _rptCache?.allItems?.find(it => it.id === itemId);
            if (existing) Object.assign(existing, updateData, {qty: newQty ?? existing.qty});

        } catch(e) {
            console.error('[rptUpdateItem] FAILED:', e);
            [priceIn, qtyIn].forEach(el=>{ if(el){ el.style.background='#fee2e2'; el.style.borderColor='#dc2626'; }});
            if (btn) { btn.disabled=false; btn.textContent='💾 Save'; }
            showAlert('❌ Save failed: '+e.message, 'error');
        }
    };

    // ── Price-only update (kept for backward compat) ────────────────
    // Routes to the right handler based on which inputs exist in DOM
    window.rptUpdateItemPrice = async function(itemId, productName, invoiceId) {
        if (document.getElementById('pvPrice_'+itemId)) {
            return window.pvSaveRow(itemId, productName, invoiceId);
        }
        return window.rptUpdateItem(itemId, productName, invoiceId);
    };

    // ── Price History table: live recalc row total ────────────────────
    window._pvRecalcRow = function(itemId) {
        const priceIn = document.getElementById('pvPrice_'+itemId);
        const qtyIn   = document.getElementById('pvQty_'+itemId);
        const totalEl = document.getElementById('pvTotal_'+itemId);
        if (!priceIn||!qtyIn||!totalEl) return;
        const p = parseFloat(priceIn.value)||0;
        const q = parseFloat(qtyIn.value)||0;
        totalEl.textContent = '$'+(p*q).toFixed(2);
        totalEl.style.color = '#d97706'; // gold = unsaved change
    };

    // ── Price History table: save both price + qty inline ─────────────
    window.pvSaveRow = async function(itemId, productName, invoiceId) {
        const priceIn = document.getElementById('pvPrice_'+itemId);
        const qtyIn   = document.getElementById('pvQty_'+itemId);
        const totalEl = document.getElementById('pvTotal_'+itemId);
        const btn     = document.getElementById('pvSaveBtn_'+itemId);
        if (!priceIn) { console.error('[pvSaveRow] pvPrice not found:', itemId); return; }

        const newPrice = parseFloat(priceIn.value);
        const newQty   = qtyIn ? parseFloat(qtyIn.value) : null;
        const isWt     = qtyIn && qtyIn.dataset.isWeight === 'true';

        if (isNaN(newPrice)||newPrice<0) { alert('Invalid price'); return; }
        if (newQty !== null && (isNaN(newQty)||newQty<0)) { alert('Invalid quantity'); return; }

        if (btn) { btn.disabled=true; btn.textContent='⏳'; }

        try {
            // ── Correct columns per item type (mirrors how items are inserted) ──
            let updateData = {};
            if (isWt) {
                const wt = newQty !== null ? newQty : 0;
                updateData = {
                    price_per_unit: newPrice,
                    unit_price:     0,
                    weight:         wt,
                    quantity:       0,
                    line_total:     wt * newPrice,
                    has_weight:     true
                };
            } else {
                const qt = newQty !== null ? Math.round(newQty) : 0;
                updateData = {
                    unit_price:     newPrice,
                    price_per_unit: 0,
                    quantity:       qt,
                    weight:         0,
                    line_total:     qt * newPrice,
                    has_weight:     false
                };
            }

            console.log('[pvSaveRow] updating id='+itemId, updateData);
            const { data: pvSaved, error } = await supabaseClient
                .from('invoice_items')
                .update(updateData)
                .eq('id', itemId)
                .select();
            if (error) throw new Error(error.message);
            // ✅ Verify rows were actually updated (RLS can silently block without error)
            if (!pvSaved || pvSaved.length === 0) {
                throw new Error('Save failed: no rows were updated. The record may be locked or not found.');
            }

            // ── Update invoice totals in DB ───────────────────────────
            if (invoiceId) await updateInvoiceTotals(invoiceId);

            // ── Update row total display ──────────────────────────────
            if (totalEl && newQty !== null) {
                totalEl.textContent = '$'+(newQty * newPrice).toFixed(2);
                totalEl.style.color = '#16a34a';
            }

            // ── Flash inputs ──────────────────────────────────────────
            [priceIn, qtyIn].forEach(el=>{ if(el) el.style.background='#d1fae5'; });
            if (btn) { btn.disabled=false; btn.textContent='✅ Saved'; btn.style.background='#16a34a'; }
            setTimeout(()=>{
                [priceIn, qtyIn].forEach(el=>{ if(el) el.style.background=''; });
                if (totalEl) totalEl.style.color='#374151';
                if (btn) { btn.textContent='💾 Save'; btn.style.background='rgb(44,88,136)'; }
            }, 2500);

            // ── Sync in-memory cache ──────────────────────────────────
            const _rptCache = _rptData[_rptCurrentTab] || _rptData['rpt_price_variance'];
            const existing = _rptCache?.allItems?.find(it => it.id === itemId);
            if (existing) Object.assign(existing, updateData, {qty: newQty ?? existing.qty});

            const pvQtyLabel = newQty !== null ? newQty.toFixed(isWt?3:2)+(isWt?' lb':'') : '—';
            showAlert('✅ Saved — '+productName+': Qty '+pvQtyLabel+' · Price $'+newPrice.toFixed(2), 'success');

        } catch(e) {
            console.error('[pvSaveRow] FAILED:', e);
            [priceIn, qtyIn].forEach(el=>{ if(el) el.style.background='#fee2e2'; });
            if (btn) { btn.disabled=false; btn.textContent='💾 Save'; }
            showAlert('❌ Save failed: '+e.message, 'error');
        }
    };

    switch(tabName) {

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_vendor_analysis':
    case 'rpt_purchase_summary':
    case 'rpt_vendor_spend': {
        // Consolidated vendor + purchase analysis
        const totalSpend = filtered.reduce((s,it)=>s+it.total,0);
        const invCount   = [...new Set(filtered.map(i=>i.invoice_id).filter(Boolean))].length;
        const prodCount  = [...new Set(filtered.map(i=>i.product_name).filter(Boolean))].length;

        // Per-vendor aggregation
        const byVendor = {};
        filtered.forEach(it=>{
            if (!byVendor[it.vendor]) byVendor[it.vendor]={vendor:it.vendor,total:0,lines:0,products:new Set(),invoices:new Map()};
            byVendor[it.vendor].total+=it.total;
            byVendor[it.vendor].lines++;
            byVendor[it.vendor].products.add(it.product_name);
            const inv=byVendor[it.vendor].invoices;
            const key=it.invoice_id;
            if(!inv.has(key)) inv.set(key,{id:key,date:it.invoice_date,total:0,number:it.inv_number});
            inv.get(key).total+=it.total;
        });
        const vendorRows = Object.values(byVendor).sort((a,b)=>b.total-a.total);
        const topVendor  = vendorRows[0];

        // Highest single invoice across all vendors
        let highInv={total:0,vendor:'',date:'',id:''};
        vendorRows.forEach(v=>v.invoices.forEach(inv=>{if(inv.total>highInv.total)highInv={...inv,vendor:v.vendor};}));

        kpiEl.innerHTML =
            kpi('💳','Total Spend',fmt$(totalSpend),`${d.startStr} → ${d.endStr}`,colHex)+
            kpi('🏭','Vendors',vendorRows.length,'Active this period',colHex)+
            kpi('📋','Invoices',invCount,'Processed','#16a34a')+
            kpi('📦','Products',prodCount,'Unique items','#8b5cf6')+
            kpi('🥇','Highest Spend',topVendor?topVendor.vendor.substring(0,20):'—',topVendor?fmt$(topVendor.total):'','#d97706')+
            kpi('🧾','Largest Invoice',`$${highInv.total.toFixed(2)}`,highInv.vendor?`${highInv.vendor} · ${highInv.date}`:'—','#dc2626');

        // ── Summary doughnut chart ─────────────────────────────────────
        rptSetChart(chartEl, 'Spend by Vendor',
            vendorRows.slice(0,8).map(v=>v.vendor),
            vendorRows.slice(0,8).map(v=>v.total),
            'doughnut', cfg.color);

        // ── Monthly trend chart ────────────────────────────────────────
        const byMonth={};
        filtered.forEach(it=>{
            const mo=it.invoice_date.slice(0,7);
            byMonth[mo]=(byMonth[mo]||0)+it.total;
        });
        const moKeys=Object.keys(byMonth).sort();
        if (moKeys.length>1) {
            const trendId='rptVATrend_'+Date.now();
            const trendDiv=document.createElement('div');
            trendDiv.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
            trendDiv.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">📈 Monthly Spend Trend</h4><canvas id="${trendId}" height="100"></canvas>`;
            chartEl.appendChild(trendDiv);
            requestAnimationFrame(()=>{
                const c=document.getElementById(trendId);
                if(!c)return;
                new Chart(c,{type:'line',data:{labels:moKeys,datasets:[{label:'Spend',data:moKeys.map(k=>byMonth[k]),borderColor:`rgb(${r},${g},${b})`,backgroundColor:`rgba(${r},${g},${b},.1)`,fill:true,tension:.3,borderWidth:2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0)}}}}});
            });
        }

        // ── Per-vendor individual charts ───────────────────────────────
        if (extEl && vendorRows.length>0) {
            extEl.innerHTML='<h3 style="font-size:1rem;font-weight:700;color:var(--neutral-800);margin:0 0 1rem;">📊 Per-Vendor Breakdown &amp; Invoice History</h3>';
            vendorRows.forEach(v=>{
                const vDiv=document.createElement('div');
                vDiv.style.cssText='background:white;border-radius:12px;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);margin-bottom:1.25rem;overflow:hidden;';

                // Sort invoices by date desc
                const invList=[...v.invoices.values()].sort((a,b)=>b.date.localeCompare(a.date));
                const maxInvTotal=Math.max(...invList.map(i=>i.total));

                // Bar chart data — by invoice date
                const chartId='rptVChart_'+v.vendor.replace(/\W/g,'')+'_'+Date.now();
                vDiv.innerHTML=`
                    <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--neutral-100);display:flex;justify-content:space-between;align-items:center;">
                      <div>
                        <div style="font-size:.72rem;font-weight:700;text-transform:uppercase;letter-spacing:.06em;color:#6b7280;">Vendor</div>
                        <div style="font-size:1.05rem;font-weight:800;color:var(--neutral-900);">${v.vendor}</div>
                      </div>
                      <div style="display:flex;gap:1.5rem;text-align:right;">
                        <div><div style="font-size:.65rem;color:#6b7280;text-transform:uppercase;">Total Spend</div><div style="font-size:1.1rem;font-weight:800;color:rgb(${r},${g},${b});">$${v.total.toFixed(2)}</div></div>
                        <div><div style="font-size:.65rem;color:#6b7280;text-transform:uppercase;">Invoices</div><div style="font-size:1.1rem;font-weight:800;color:#374151;">${v.invoices.size}</div></div>
                        <div><div style="font-size:.65rem;color:#6b7280;text-transform:uppercase;">Products</div><div style="font-size:1.1rem;font-weight:800;color:#374151;">${v.products.size}</div></div>
                        <div><div style="font-size:.65rem;color:#6b7280;text-transform:uppercase;">Avg Invoice</div><div style="font-size:1.1rem;font-weight:800;color:#374151;">$${(v.total/v.invoices.size).toFixed(0)}</div></div>
                      </div>
                    </div>
                    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
                      <div style="padding:1rem 1.25rem;border-right:1px solid var(--neutral-100);">
                        <div style="font-size:.75rem;font-weight:700;color:#6b7280;margin-bottom:.75rem;">Invoice Amounts</div>
                        <canvas id="${chartId}" height="130"></canvas>
                      </div>
                      <div style="padding:1rem 1.25rem;">
                        <div style="font-size:.75rem;font-weight:700;color:#6b7280;margin-bottom:.6rem;">Invoice History</div>
                        <table style="width:100%;font-size:.78rem;border-collapse:collapse;">
                          <thead><tr style="border-bottom:1px solid var(--neutral-100);">
                            <th style="text-align:left;padding:.3rem .4rem;color:#6b7280;font-weight:600;">Date</th>
                            <th style="text-align:left;padding:.3rem .4rem;color:#6b7280;font-weight:600;">#</th>
                            <th style="text-align:right;padding:.3rem .4rem;color:#6b7280;font-weight:600;">Amount</th>
                            <th style="padding:.3rem .4rem;"></th>
                          </tr></thead>
                          <tbody>
                            ${invList.map(inv=>`
                              <tr style="border-bottom:1px solid var(--neutral-50);">
                                <td style="padding:.3rem .4rem;">${inv.date}</td>
                                <td style="padding:.3rem .4rem;color:#6b7280;">${inv.number||inv.id.slice(0,8)}</td>
                                <td style="text-align:right;padding:.3rem .4rem;font-weight:700;${inv.total===maxInvTotal?'color:#dc2626;':''}">$${inv.total.toFixed(2)}</td>
                                <td style="padding:.3rem .4rem;">
                                  <button onclick="rptOpenInvoice('${inv.id}')" style="padding:.2rem .5rem;background:rgba(${r},${g},${b},.1);color:rgb(${r},${g},${b});border:1px solid rgba(${r},${g},${b},.3);border-radius:4px;font-size:.7rem;cursor:pointer;font-weight:600;">View</button>
                                </td>
                              </tr>`).join('')}
                          </tbody>
                        </table>
                      </div>
                    </div>`;
                extEl.appendChild(vDiv);

                // Draw per-vendor bar chart
                requestAnimationFrame(()=>{
                    const c=document.getElementById(chartId);
                    if(!c)return;
                    const labels=invList.slice(0,12).map(i=>i.date.slice(5));
                    const values=invList.slice(0,12).map(i=>i.total);
                    new Chart(c,{type:'bar',data:{labels,datasets:[{label:'Invoice $',data:values,
                        backgroundColor:values.map(v=>v===maxInvTotal?'rgba(220,38,38,.85)':`rgba(${r},${g},${b},.7)`),
                        borderColor:values.map(v=>v===maxInvTotal?'#dc2626':`rgb(${r},${g},${b})`),
                        borderWidth:1,borderRadius:3}]},
                        options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`$${ctx.parsed.y.toFixed(2)}`}}},
                        scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0),font:{size:10}}}}}});
                });
            });
        }

        // ── Main table ─────────────────────────────────────────────────
        rptSetTable('Vendor Summary',['Vendor','Invoices','Products','Line Items','Total Spend','Share','Avg/Invoice'],
            vendorRows.map(v=>[v.vendor,v.invoices.size,v.products.size,v.lines,
                `$${v.total.toFixed(2)}`,pct(v.total,totalSpend),`$${(v.total/v.invoices.size).toFixed(2)}`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_cogs': {
        const byCat={};
        filtered.forEach(it=>{
            if(!byCat[it.category]) byCat[it.category]={cat:it.category,total:0,products:new Set(),lines:0};
            byCat[it.category].total+=it.total;
            byCat[it.category].products.add(it.product_name);
            byCat[it.category].lines++;
        });
        const rows=Object.values(byCat).sort((a,b)=>b.total-a.total);
        const grand=rows.reduce((s,r)=>s+r.total,0);

        kpiEl.innerHTML=
            kpi('📊','Total COGS',fmt$(grand),'Invoiced cost',colHex)+
            kpi('🥬','Top Category',rows[0]?.cat||'—',fmt$(rows[0]?.total||0),colHex)+
            kpi('📦','Categories',rows.length,'','#16a34a')+
            kpi('📋','Line Items',filtered.length,'','#d97706');

        rptSetChart(chartEl,'COGS by Category',rows.map(r=>r.cat),rows.map(r=>r.total),'doughnut',cfg.color);

        // Monthly COGS trend
        const byMo={};
        filtered.forEach(it=>{const m=it.invoice_date.slice(0,7);byMo[m]=(byMo[m]||0)+it.total;});
        const moK=Object.keys(byMo).sort();
        if(moK.length>1){
            const tid='rptCOGST_'+Date.now();
            const td=document.createElement('div');
            td.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
            td.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">📅 Monthly COGS Trend</h4><canvas id="${tid}" height="100"></canvas>`;
            chartEl.appendChild(td);
            requestAnimationFrame(()=>{
                const c=document.getElementById(tid);
                if(!c)return;
                new Chart(c,{type:'bar',data:{labels:moK,datasets:[{label:'COGS',data:moK.map(k=>byMo[k]),backgroundColor:`rgba(${r},${g},${b},.7)`,borderRadius:3}]},
                    options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0)}}}}});
            });
        }

        rptSetTable('COGS by Category',['Category','Products','Line Items','Total Cost','% of COGS'],
            rows.map(row=>[row.cat,row.products.size,row.lines,`$${row.total.toFixed(2)}`,pct(row.total,grand)]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_price_variance': {
        // Build per-product price history with full invoice detail
        const byProduct={};
        filtered.forEach(it=>{
            if(!it.product_name||it.price<=0)return;
            if(!byProduct[it.product_name]) byProduct[it.product_name]={name:it.product_name,cat:it.category,history:[]};
            byProduct[it.product_name].history.push({
                date:it.invoice_date, price:it.price, qty:it.qty, total:it.total,
                vendor:it.vendor, invoiceId:it.invoice_id, invNum:it.inv_number, itemId:it.id
            });
        });

        const rows=Object.values(byProduct).map(p=>{
            p.history.sort((a,b)=>a.date.localeCompare(b.date));
            const prices=p.history.map(h=>h.price);
            const mn=safeMin(prices),mx=safeMax(prices),avg=safeAvg(prices),std=safeStd(prices);
            // Most expensive vendor
            const byVendor={};
            p.history.forEach(h=>{if(!byVendor[h.vendor])byVendor[h.vendor]={vendor:h.vendor,prices:[],maxP:0};byVendor[h.vendor].prices.push(h.price);byVendor[h.vendor].maxP=Math.max(byVendor[h.vendor].maxP,h.price);});
            const expVendor=Object.values(byVendor).sort((a,b)=>b.maxP-a.maxP)[0];
            return {...p,min:mn,max:mx,avg,std,varPct:mn>0?(mx-mn)/mn*100:0,variance:mx-mn,expVendor:expVendor?.vendor||'—',expVendorMax:expVendor?.maxP||0};
        }).sort((a,b)=>b.varPct-a.varPct);

        const avgVar=rows.length?safeAvg(rows.map(r=>r.varPct)):0;
        const totalSavings=rows.reduce((s,r)=>s+r.variance*(r.history.length),0);

        kpiEl.innerHTML=
            kpi('📈','Highest Variance',rows[0]?.name?.substring(0,20)||'—',`${rows[0]?.varPct.toFixed(1)||0}% spread`,colHex)+
            kpi('💡','Avg Variance',`${avgVar.toFixed(1)}%`,'Across products',colHex)+
            kpi('💰','Potential Savings',fmt$(totalSavings),'Best vs worst price','#dc2626')+
            kpi('📦','Products Analyzed',rows.length,'With price data','#16a34a');

        // Top variance bar chart
        rptSetChart(chartEl,'Price Variance % by Product',
            rows.slice(0,10).map(r=>r.name.substring(0,18)),
            rows.slice(0,10).map(r=>r.varPct),'bar',cfg.color);

        // ── Per-product price history timeline (top 8 by variance) ────
        if (extEl) {
            extEl.innerHTML=`<h3 style="font-size:1rem;font-weight:700;color:var(--neutral-800);margin:0 0 1rem;">🔍 Product Price History — Click to expand</h3>
            <div style="font-size:.82rem;color:#6b7280;margin-bottom:1rem;">Showing top ${Math.min(8,rows.length)} products by price variance. Expand any product to see full history, edit prices inline.</div>`;

            rows.slice(0,8).forEach((prod,idx)=>{
                const pid='pvProd_'+idx+'_'+Date.now();
                const cid='pvChart_'+idx+'_'+Date.now();
                const wrapId='pvWrap_'+idx;
                const wrap=document.createElement('div');
                wrap.id=wrapId;
                wrap.style.cssText='background:white;border-radius:12px;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);margin-bottom:.85rem;overflow:hidden;';
                wrap.innerHTML=`
                    <div onclick="rptTogglePVDetail('${wrapId}')" style="padding:.9rem 1.25rem;cursor:pointer;display:flex;justify-content:space-between;align-items:center;hover:background:#f9fafb;">
                      <div style="display:flex;align-items:center;gap:1rem;">
                        <div style="width:8px;height:40px;border-radius:4px;background:${prod.varPct>30?'#dc2626':prod.varPct>15?'#d97706':'#16a34a'};"></div>
                        <div>
                          <div style="font-size:.95rem;font-weight:700;color:var(--neutral-900);">${prod.name}</div>
                          <div style="font-size:.75rem;color:#6b7280;">${prod.cat} &nbsp;·&nbsp; Most expensive from: <strong>${prod.expVendor}</strong></div>
                        </div>
                      </div>
                      <div style="display:flex;gap:2rem;text-align:right;align-items:center;">
                        <div><div style="font-size:.65rem;text-transform:uppercase;color:#6b7280;">Min</div><div style="font-weight:700;color:#16a34a;">$${prod.min.toFixed(2)}</div></div>
                        <div><div style="font-size:.65rem;text-transform:uppercase;color:#6b7280;">Max</div><div style="font-weight:700;color:#dc2626;">$${prod.max.toFixed(2)}</div></div>
                        <div><div style="font-size:.65rem;text-transform:uppercase;color:#6b7280;">Avg</div><div style="font-weight:700;">$${prod.avg.toFixed(2)}</div></div>
                        <div><div style="font-size:.65rem;text-transform:uppercase;color:#6b7280;">Variance</div><div style="font-weight:800;color:${prod.varPct>30?'#dc2626':prod.varPct>15?'#d97706':'#374151'};">${prod.varPct.toFixed(1)}%</div></div>
                        <div style="color:#9ca3af;font-size:1.1rem;">▼</div>
                      </div>
                    </div>
                    <div id="${pid}" style="display:none;border-top:1px solid var(--neutral-100);">
                      <div style="display:grid;grid-template-columns:1fr 1fr;gap:0;">
                        <div style="padding:1rem 1.25rem;border-right:1px solid var(--neutral-100);">
                          <div style="font-size:.75rem;font-weight:700;color:#6b7280;margin-bottom:.75rem;">Price Timeline</div>
                          <canvas id="${cid}" height="120"></canvas>
                        </div>
                        <div style="padding:1rem 1.25rem;overflow-x:auto;">
                          <div style="font-size:.75rem;font-weight:700;color:#6b7280;margin-bottom:.6rem;">Invoice History — Edit &amp; Save Price</div>
                          <table style="width:100%;font-size:.78rem;border-collapse:collapse;">
                            <thead><tr style="border-bottom:1px solid var(--neutral-100);">
                              <th style="text-align:left;padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Date</th>
                              <th style="text-align:left;padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Vendor</th>
                              <th style="text-align:left;padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">#</th>
                              <th style="padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Qty</th>
                              <th style="padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Unit Price</th>
                              <th style="text-align:right;padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Line Total</th>
                              <th style="padding:.3rem .4rem;color:#6b7280;font-size:.72rem;">Save</th>
                              <th style="padding:.3rem .4rem;"></th>
                            </tr></thead>
                            <tbody>
                              ${prod.history.map(h=>{
                                const _raw = d.allItems.find(it=>it.id===h.itemId);
                                const isW = !!(_raw?.has_weight || parseFloat(_raw?.weight||0) > 0);
                                return `
                                <tr id="pvRow_${h.itemId}" style="border-bottom:1px solid var(--neutral-50);">
                                  <td style="padding:.3rem .4rem;font-size:.78rem;">${h.date}</td>
                                  <td style="padding:.3rem .4rem;font-size:.78rem;">${h.vendor}</td>
                                  <td style="padding:.3rem .4rem;color:#6b7280;font-size:.78rem;">${h.invNum||h.invoiceId?.slice(0,8)||'—'}</td>
                                  <td style="padding:.3rem .4rem;">
                                    <div style="display:flex;align-items:center;gap:.2rem;">
                                      <input id="pvQty_${h.itemId}" type="number" step="${isW?'0.001':'0.01'}" min="0" value="${h.qty.toFixed(isW?3:2)}"
                                        data-is-weight="${isW}"
                                        oninput="_pvRecalcRow('${h.itemId}')"
                                        style="width:65px;padding:.2rem .3rem;border:1px solid #d1d5db;border-radius:4px;font-size:.78rem;text-align:right;">
                                      ${isW?'<span style="font-size:.68rem;color:#92400e;">lb</span>':''}
                                    </div>
                                  </td>
                                  <td style="padding:.3rem .4rem;">
                                    <input id="pvPrice_${h.itemId}" type="number" step="0.01" min="0" value="${h.price.toFixed(2)}"
                                      oninput="_pvRecalcRow('${h.itemId}')"
                                      style="width:72px;padding:.2rem .3rem;border:1px solid #d1d5db;border-radius:4px;font-size:.78rem;text-align:right;font-weight:700;color:${h.price===prod.max?'#dc2626':h.price===prod.min?'#16a34a':'#374151'};">
                                  </td>
                                  <td id="pvTotal_${h.itemId}" style="text-align:right;padding:.3rem .4rem;font-size:.78rem;font-weight:600;color:#374151;">$${(h.price*h.qty).toFixed(2)}</td>
                                  <td style="padding:.3rem .4rem;">
                                    <button id="pvSaveBtn_${h.itemId}" onclick="pvSaveRow('${h.itemId}','${escQ(prod.name)}','${h.invoiceId}')"
                                      style="padding:.25rem .55rem;background:rgb(${r},${g},${b});color:white;border:none;border-radius:4px;font-size:.72rem;cursor:pointer;font-weight:700;white-space:nowrap;">💾 Save</button>
                                  </td>
                                  <td style="padding:.3rem .4rem;">
                                    <button onclick="rptOpenInvoice('${h.invoiceId}')"
                                      style="padding:.2rem .45rem;background:#f3f4f6;border:1px solid #d1d5db;border-radius:4px;font-size:.68rem;cursor:pointer;">📄 Invoice</button>
                                  </td>
                                </tr>`;}).join('')}
                            </tbody>
                          </table>
                        </div>
                      </div>
                    </div>`;
                extEl.appendChild(wrap);

                // Chart drawn lazily when expanded
                window['_pvChartData_'+pid] = {cid, prod, r, g, b};
            });
        }

        rptSetTable('Price Variance Detail',['Product','Category','Min Price','Max Price','Avg Price','Std Dev','Variance %','Most Expensive Vendor','# Purchases'],
            rows.map(row=>[row.name,row.cat,`$${row.min.toFixed(2)}`,`$${row.max.toFixed(2)}`,
                `$${row.avg.toFixed(2)}`,`$${row.std.toFixed(2)}`,`${row.varPct.toFixed(1)}%`,
                row.expVendor,row.history.length]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_inventory_intel':
    case 'rpt_stock_valuation':
    case 'rpt_low_stock':
    case 'rpt_consumption': {
        // Consolidated inventory intelligence
        // Build latest price map from all invoice items
        const priceMap=new Map();
        d.allEnriched.sort((a,b)=>a.invoice_date.localeCompare(b.invoice_date)).forEach(it=>{
            if(it.price>0) priceMap.set(it.product_name,{price:it.price,vendor:it.vendor});
        });

        // Build delivery totals (for the filtered period)
        const deliveryMap=new Map();
        filtered.forEach(it=>{ deliveryMap.set(it.product_name,(deliveryMap.get(it.product_name)||0)+it.qty); });

        // Build stock snapshots — find LATEST snapshot before period start and EARLIEST after/during period end
        const stockByProduct={};
        d.allStock.forEach(s=>{
            const p=s.product_name; if(!p) return;
            if(!stockByProduct[p]) stockByProduct[p]=[];
            stockByProduct[p].push({date:s.stock_date,qty:parseFloat(s.quantity_in_stock||0)});
        });

        // Build consumption timeline per product
        const consumptionTimeline={};
        d.allStock.forEach(s=>{
            const p=s.product_name; if(!p) return;
            if(!consumptionTimeline[p]) consumptionTimeline[p]=[];
            consumptionTimeline[p].push({date:s.stock_date,qty:parseFloat(s.quantity_in_stock||0)});
        });

        const prodRows = d.mgmt.map(p=>{
            const name=p.product_name;
            const prInfo = priceMap.get(name)||{price:0,vendor:'—'};
            const onHand = parseFloat(p.on_hand||0); // current on_hand from inventory_management
            const par    = parseFloat(p.par||0);
            const delivered = deliveryMap.get(name)||0;

            // Stock formula: last stock (pre-period) + deliveries (during period) = new expected total
            const snaps = stockByProduct[name]||[];
            snaps.sort((a,b)=>a.date.localeCompare(b.date));

            // Find last snapshot before/at period start
            const preSnaps = snaps.filter(s=>s.date<=d.startStr);
            const postSnaps = snaps.filter(s=>s.date>=d.startStr&&s.date<=d.endStr);
            const lastStock  = preSnaps.length>0 ? preSnaps[preSnaps.length-1].qty : onHand;
            const closingStock = postSnaps.length>0 ? postSnaps[postSnaps.length-1].qty : onHand;
            const expectedTotal = lastStock + delivered;
            const consumed = Math.max(0, expectedTotal - closingStock);
            const consumed_pct = expectedTotal>0 ? consumed/expectedTotal*100 : 0;

            return {
                name, cat:p.category||'Other', par, on_hand:onHand,
                price:prInfo.price, vendor:prInfo.vendor,
                stockValue:onHand*prInfo.price,
                stockPct:par>0?Math.min(999,Math.round(onHand/par*100)):null,
                lastStock, delivered, expectedTotal, closingStock, consumed, consumed_pct,
                restockCost:Math.max(0,par-onHand)*prInfo.price,
                timeline: consumptionTimeline[name]||[]
            };
        }).filter(r=>catFilter?r.cat===catFilter:true).sort((a,b)=>b.stockValue-a.stockValue);

        const totalVal    = prodRows.reduce((s,r)=>s+r.stockValue,0);
        const criticalCnt = prodRows.filter(r=>r.stockPct!==null&&r.stockPct<25).length;
        const totalConsumed = prodRows.reduce((s,r)=>s+r.consumed,0);
        const restockTotal= prodRows.reduce((s,r)=>s+r.restockCost,0);

        kpiEl.innerHTML=
            kpi('💰','Total Stock Value',fmt$(totalVal),'On-hand × latest price',colHex)+
            kpi('📦','Products',prodRows.length,'In catalog',colHex)+
            kpi('🔴','Critical (<25% PAR)',criticalCnt,'Immediate reorder','#dc2626')+
            kpi('🔥','Consumed This Period',totalConsumed.toFixed(0)+' units','Deliveries - closing','#d97706')+
            kpi('🛒','Restock Cost',fmt$(restockTotal),'To reach PAR','#16a34a')+
            kpi('📊','Avg Stock Fill',`${prodRows.filter(r=>r.stockPct!==null).length>0?Math.round(prodRows.filter(r=>r.stockPct!==null).reduce((s,r)=>s+r.stockPct,0)/prodRows.filter(r=>r.stockPct!==null).length):0}%`,'Avg PAR %','#8b5cf6');

        // Stock status donut
        const critical2=prodRows.filter(r=>r.stockPct!==null&&r.stockPct<25).length;
        const low2=prodRows.filter(r=>r.stockPct!==null&&r.stockPct>=25&&r.stockPct<50).length;
        const mod2=prodRows.filter(r=>r.stockPct!==null&&r.stockPct>=50&&r.stockPct<100).length;
        const full2=prodRows.filter(r=>r.stockPct!==null&&r.stockPct>=100).length;
        rptSetChart(chartEl,'Stock Level Distribution',
            ['🔴 Critical <25%','🟠 Low 25-50%','🟡 Moderate 50-99%','🟢 Full ≥100%'],
            [critical2,low2,mod2,full2],'doughnut',cfg.color);

        // Top consumed bar
        const topConsumed=prodRows.filter(r=>r.consumed>0).sort((a,b)=>b.consumed-a.consumed).slice(0,10);
        if(topConsumed.length>0){
            const tcId='rptTC_'+Date.now();
            const tcDiv=document.createElement('div');
            tcDiv.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
            tcDiv.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">🔥 Top Consumed Products</h4><canvas id="${tcId}" height="110"></canvas>`;
            chartEl.appendChild(tcDiv);
            requestAnimationFrame(()=>{
                const c=document.getElementById(tcId);
                if(!c)return;
                new Chart(c,{type:'bar',data:{labels:topConsumed.map(r=>r.name.substring(0,16)),datasets:[{label:'Consumed',data:topConsumed.map(r=>r.consumed),backgroundColor:`rgba(${r},${g},${b},.75)`,borderRadius:3}]},
                    options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
            });
        }

        // ── Per-product consumption timeline charts ────────────────────
        if(extEl){
            extEl.innerHTML='<h3 style="font-size:1rem;font-weight:700;color:var(--neutral-800);margin:0 0 1rem;">📊 Product Stock Timeline — Consumption Charts</h3>';
            const timelineProds=prodRows.filter(r=>r.timeline.length>=2).slice(0,6);
            if(timelineProds.length>0){
                const grid=document.createElement('div');
                grid.style.cssText='display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:1rem;';
                timelineProds.forEach(prod=>{
                    const cid='rptStockTL_'+prod.name.replace(/\W/g,'')+'_'+Date.now();
                    const sorted=[...prod.timeline].sort((a,b)=>a.date.localeCompare(b.date));
                    const div=document.createElement('div');
                    div.style.cssText='background:white;border-radius:12px;padding:1.1rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
                    div.innerHTML=`<div style="font-size:.8rem;font-weight:700;color:var(--neutral-700);margin-bottom:.6rem;">${prod.name}
                        <span style="font-size:.7rem;font-weight:400;color:#6b7280;"> · Last stock: ${prod.lastStock.toFixed(1)} + ${prod.delivered.toFixed(1)} delivered = <strong>${prod.expectedTotal.toFixed(1)}</strong></span></div>
                        <canvas id="${cid}" height="100"></canvas>`;
                    grid.appendChild(div);
                    requestAnimationFrame(()=>{
                        const c=document.getElementById(cid);
                        if(!c)return;
                        new Chart(c,{type:'line',data:{labels:sorted.map(s=>s.date.slice(5)),datasets:[{label:'Stock Level',data:sorted.map(s=>s.qty),borderColor:`rgb(${r},${g},${b})`,backgroundColor:`rgba(${r},${g},${b},.1)`,fill:true,tension:.3,borderWidth:2,pointRadius:3}]},
                            options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>v.toFixed(1)}}}}});
                    });
                });
                extEl.appendChild(grid);
            } else {
                extEl.innerHTML+='<div style="padding:2rem;text-align:center;color:#9ca3af;font-size:.85rem;background:white;border-radius:12px;border:1px solid var(--neutral-200);">📭 No stock snapshot history available for timeline charts. Stock levels are read from inventory_management.on_hand.</div>';
            }
        }

        rptSetTable('Inventory Intelligence',
            ['Product','Category','Last Stock','+ Delivered','= Expected','Closing','Consumed','PAR%','Unit Price','Stock Value','Status'],
            prodRows.map(r=>[
                r.name, r.cat,
                r.lastStock.toFixed(1), `+${r.delivered.toFixed(1)}`, r.expectedTotal.toFixed(1),
                r.closingStock.toFixed(1), r.consumed.toFixed(1),
                r.stockPct!==null?`${r.stockPct}%`:'—',
                `$${r.price.toFixed(2)}`, `$${r.stockValue.toFixed(2)}`,
                r.stockPct===null?'—':r.stockPct<25?'🔴 Critical':r.stockPct<50?'🟠 Low':r.stockPct<100?'🟡 Ok':'🟢 Full'
            ]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_top10': {
        const byProd={};
        filtered.forEach(it=>{
            if(!byProd[it.product_name]) byProd[it.product_name]={name:it.product_name,cat:it.category,qty:0,total:0,times:0};
            byProd[it.product_name].qty+=it.qty;
            byProd[it.product_name].total+=it.total;
            byProd[it.product_name].times++;
        });
        const byQty=Object.values(byProd).sort((a,b)=>b.qty-a.qty).slice(0,10);
        const bySpend=Object.values(byProd).sort((a,b)=>b.total-a.total).slice(0,10);
        const grandTotal=Object.values(byProd).reduce((s,r)=>s+r.total,0);

        kpiEl.innerHTML=
            kpi('🏆','Top by Qty',byQty[0]?.name?.substring(0,20)||'—',`${byQty[0]?.qty.toFixed(0)||0} units`,colHex)+
            kpi('💰','Top by Spend',bySpend[0]?.name?.substring(0,20)||'—',fmt$(bySpend[0]?.total||0),colHex)+
            kpi('📦','Products',Object.keys(byProd).length,'In period','#16a34a')+
            kpi('💳','Total Spend',fmt$(grandTotal),'','#d97706');

        rptSetChart(chartEl,'Top 10 by Quantity',byQty.map(r=>r.name.substring(0,18)),byQty.map(r=>r.qty),'bar',cfg.color);
        const sid='rptT10S_'+Date.now();
        const sd=document.createElement('div');
        sd.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
        sd.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">💰 Top 10 by Spend</h4><canvas id="${sid}" height="130"></canvas>`;
        chartEl.appendChild(sd);
        requestAnimationFrame(()=>{
            const c=document.getElementById(sid);
            if(!c)return;
            new Chart(c,{type:'bar',data:{labels:bySpend.map(r=>r.name.substring(0,16)),datasets:[{label:'Spend',data:bySpend.map(r=>r.total),backgroundColor:'rgba(217,119,6,.75)',borderRadius:3}]},
                options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0)}}}}});
        });

        rptSetTable('Top 10 Products',['Rank','Product','Category','Total Qty','Total Spend','Times Ordered','Avg Price'],
            bySpend.slice(0,10).map((r,i)=>[i+1,r.name,r.cat,r.qty.toFixed(0),`$${r.total.toFixed(2)}`,r.times,`$${(r.total/r.qty||0).toFixed(2)}`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_monthly_trend': {
        const byMonth={};
        d.allEnriched.forEach(it=>{
            if(!it.vendor&&d.vendorFilter)return;
            if(d.vendorFilter&&it.vendor!==d.vendorFilter)return;
            const mo=it.invoice_date.slice(0,7); if(!mo.match(/^\d{4}-\d{2}$/))return;
            if(!byMonth[mo]) byMonth[mo]={mo,total:0,lines:0,invoices:new Set(),products:new Set()};
            byMonth[mo].total+=it.total;
            byMonth[mo].lines++;
            byMonth[mo].invoices.add(it.invoice_id);
            byMonth[mo].products.add(it.product_name);
        });
        const moRows=Object.values(byMonth).sort((a,b)=>a.mo.localeCompare(b.mo));
        const peak=moRows.reduce((a,b)=>b.total>a.total?b:a,{total:0,mo:'—'});
        const avgMo=moRows.length?safeAvg(moRows.map(r=>r.total)):0;

        kpiEl.innerHTML=
            kpi('📅','Months Tracked',moRows.length,'','',colHex)+
            kpi('📈','Peak Month',peak.mo,fmt$(peak.total),colHex)+
            kpi('💡','Monthly Avg',fmt$(avgMo),'','#16a34a')+
            kpi('💳','Total',fmt$(moRows.reduce((s,r)=>s+r.total,0)),'All time','#d97706');

        rptSetChart(chartEl,'Monthly Spend Trend',moRows.map(r=>r.mo),moRows.map(r=>r.total),'bar',cfg.color);

        // 3-month rolling average line overlay
        const rolId='rptMTRoll_'+Date.now();
        const rolDiv=document.createElement('div');
        rolDiv.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
        rolDiv.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">📉 3-Month Rolling Average</h4><canvas id="${rolId}" height="100"></canvas>`;
        chartEl.appendChild(rolDiv);
        requestAnimationFrame(()=>{
            const c=document.getElementById(rolId); if(!c)return;
            const rolling=moRows.map((m,i)=>{const slice=moRows.slice(Math.max(0,i-2),i+1);return safeAvg(slice.map(s=>s.total));});
            new Chart(c,{type:'line',data:{labels:moRows.map(r=>r.mo),datasets:[{label:'Actual',data:moRows.map(r=>r.total),borderColor:`rgba(${r},${g},${b},.5)`,backgroundColor:`rgba(${r},${g},${b},.08)`,fill:true,tension:.3,borderWidth:1.5},{label:'3-Mo Avg',data:rolling,borderColor:`rgb(${r},${g},${b})`,backgroundColor:'transparent',borderWidth:2.5,tension:.3,borderDash:[]}]},
                options:{responsive:true,plugins:{legend:{position:'top'}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0)}}}}});
        });

        rptSetTable('Monthly Spend Detail',['Month','Total Spend','Invoices','Products','Line Items','vs Avg'],
            moRows.map(r=>[r.mo,`$${r.total.toFixed(2)}`,r.invoices.size,r.products.size,r.lines,
                r.total>avgMo?`▲ +${((r.total-avgMo)/avgMo*100).toFixed(1)}%`:`▼ ${((r.total-avgMo)/avgMo*100).toFixed(1)}%`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_turnover': {
        // Turnover = Total consumed / Average stock level
        const byProd={};
        d.allEnriched.forEach(it=>{if(!byProd[it.product_name])byProd[it.product_name]={name:it.product_name,cat:it.category,delivered:0};byProd[it.product_name].delivered+=it.qty;});

        const prodT=d.mgmt.map(p=>{
            const info=byProd[p.product_name]||{delivered:0};
            const on_hand=parseFloat(p.on_hand||0);
            const delivered=info.delivered;
            const avgStock=(on_hand+delivered)/2||1;
            const turnover=delivered/avgStock;
            const daysToDeplete=on_hand>0&&delivered>0?Math.round(on_hand/(delivered/365)):null;
            return {name:p.product_name,cat:p.category||'Other',on_hand,delivered,avgStock,turnover,daysToDeplete};
        }).filter(r=>catFilter?r.cat===catFilter:true).sort((a,b)=>b.turnover-a.turnover);

        const avgTurn=prodT.length?safeAvg(prodT.map(r=>r.turnover)):0;
        kpiEl.innerHTML=
            kpi('🔄','Avg Turnover',`${avgTurn.toFixed(2)}x`,'All products',colHex)+
            kpi('⚡','High Turnover',prodT.filter(r=>r.turnover>2).length,'Turnover > 2x','#16a34a')+
            kpi('🐢','Low Turnover',prodT.filter(r=>r.turnover<0.5&&r.delivered>0).length,'Turnover < 0.5x','#d97706')+
            kpi('💀','No Movement',prodT.filter(r=>r.delivered===0).length,'Zero deliveries','#dc2626');

        rptSetChart(chartEl,'Inventory Turnover (Top 10)',prodT.slice(0,10).map(r=>r.name.substring(0,18)),prodT.slice(0,10).map(r=>r.turnover),'bar',cfg.color);

        rptSetTable('Inventory Turnover',['Product','Category','On Hand','Total Delivered','Avg Stock','Turnover Rate','Days to Deplete','Speed'],
            prodT.map(r=>[r.name,r.cat,r.on_hand.toFixed(1),r.delivered.toFixed(0),(r.avgStock).toFixed(1),`${r.turnover.toFixed(2)}x`,r.daysToDeplete!==null?`${r.daysToDeplete}d`:'—',r.turnover>2?'⚡ Fast':r.turnover>1?'🟢 Good':r.turnover>0.3?'🟡 Slow':'🔴 Very Slow']));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_price_volatility': {
        const byProd={};
        filtered.forEach(it=>{
            if(!it.price||it.price<=0)return;
            if(!byProd[it.product_name]) byProd[it.product_name]={name:it.product_name,cat:it.category,prices:[],byVendor:{}};
            byProd[it.product_name].prices.push(it.price);
            if(!byProd[it.product_name].byVendor[it.vendor]) byProd[it.product_name].byVendor[it.vendor]=[];
            byProd[it.product_name].byVendor[it.vendor].push(it.price);
        });
        const rows=Object.values(byProd).filter(r=>r.prices.length>1).map(r=>{
            const std=safeStd(r.prices); const avg=safeAvg(r.prices); const cv=avg>0?std/avg*100:0;
            const mostVol=Object.entries(r.byVendor).map(([v,ps])=>({v,std:safeStd(ps),avg:safeAvg(ps)})).sort((a,b)=>b.std-a.std)[0];
            return {...r,std,avg,cv,min:safeMin(r.prices),max:safeMax(r.prices),mostVolatileVendor:mostVol?.v||'—'};
        }).sort((a,b)=>b.cv-a.cv);

        kpiEl.innerHTML=
            kpi('📊','Most Volatile',rows[0]?.name?.substring(0,20)||'—',`${rows[0]?.cv.toFixed(1)||0}% CV`,colHex)+
            kpi('⚠️','High Volatility',rows.filter(r=>r.cv>20).length,'CV > 20%','#dc2626')+
            kpi('✅','Stable',rows.filter(r=>r.cv<5).length,'CV < 5%','#16a34a')+
            kpi('📦','Analyzed',rows.length,'Products with 2+ prices','#8b5cf6');

        rptSetChart(chartEl,'Price Volatility (CV%)',rows.slice(0,10).map(r=>r.name.substring(0,18)),rows.slice(0,10).map(r=>r.cv),'bar',cfg.color);

        rptSetTable('Price Volatility Detail',['Product','Category','Min','Max','Avg','Std Dev','CV%','# Prices','Most Volatile Vendor'],
            rows.map(r=>[r.name,r.cat,`$${r.min.toFixed(2)}`,`$${r.max.toFixed(2)}`,`$${r.avg.toFixed(2)}`,`$${r.std.toFixed(2)}`,`${r.cv.toFixed(1)}%`,r.prices.length,r.mostVolatileVendor]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_shrinkage': {
        // Shrinkage = expected stock (opening + deliveries) minus closing stock, excluding known consumption
        const rows=d.mgmt.map(p=>{
            const name=p.product_name;
            const cat=p.category||'Other';
            if(catFilter&&cat!==catFilter) return null;
            const delivered=d.allEnriched.filter(it=>it.product_name===name).reduce((s,it)=>s+it.qty,0);
            const on_hand=parseFloat(p.on_hand||0);
            const par=parseFloat(p.par||0);
            const expected=par+delivered;
            const shrink=Math.max(0,expected-on_hand);
            const shrinkPct=expected>0?shrink/expected*100:0;
            const priceInfo=[...d.allEnriched].filter(it=>it.product_name===name&&it.price>0).sort((a,b)=>b.invoice_date.localeCompare(a.invoice_date))[0];
            const price=priceInfo?.price||0;
            return {name,cat,par,on_hand,delivered,expected,shrink,shrinkPct,price,shrinkValue:shrink*price};
        }).filter(r=>r&&r.shrink>0).sort((a,b)=>b.shrinkValue-a.shrinkValue);

        const totalShrinkVal=rows.reduce((s,r)=>s+r.shrinkValue,0);
        kpiEl.innerHTML=
            kpi('⚖️','Total Shrinkage Value',fmt$(totalShrinkVal),'PAR+Deliveries minus On-hand',colHex)+
            kpi('📦','Items with Shrinkage',rows.length,'','#dc2626')+
            kpi('🔴','High Shrinkage',rows.filter(r=>r.shrinkPct>20).length,'Shrink > 20%','#d97706')+
            kpi('💡','Avg Shrinkage',`${rows.length?safeAvg(rows.map(r=>r.shrinkPct)).toFixed(1):0}%`,'','#16a34a');

        rptSetChart(chartEl,'Top Shrinkage by Value',rows.slice(0,10).map(r=>r.name.substring(0,18)),rows.slice(0,10).map(r=>r.shrinkValue),'bar',cfg.color);

        rptSetTable('Shrinkage & Adjustments',['Product','Category','PAR','Delivered','Expected','On Hand','Shrinkage','Shrink%','Shrink Value'],
            rows.map(r=>[r.name,r.cat,r.par.toFixed(1),r.delivered.toFixed(1),r.expected.toFixed(1),r.on_hand.toFixed(1),
                r.shrink.toFixed(1),`${r.shrinkPct.toFixed(1)}%`,`$${r.shrinkValue.toFixed(2)}`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_fast_slow': {
        // Fast = high deliveries in period, Slow = low deliveries
        const cutoffFast = new Date(); cutoffFast.setDate(cutoffFast.getDate()-30);
        const cutStr=cutoffFast.toISOString().slice(0,10);

        const byProd={};
        d.allEnriched.filter(it=>it.invoice_date>=cutStr).forEach(it=>{
            if(!byProd[it.product_name]) byProd[it.product_name]={name:it.product_name,cat:it.category,qty30:0,spend30:0,times30:0};
            byProd[it.product_name].qty30+=it.qty;
            byProd[it.product_name].spend30+=it.total;
            byProd[it.product_name].times30++;
        });

        const rows=d.mgmt.map(p=>{
            const info=byProd[p.product_name]||{qty30:0,spend30:0,times30:0};
            return {name:p.product_name,cat:p.category||'Other',on_hand:parseFloat(p.on_hand||0),...info};
        }).filter(r=>catFilter?r.cat===catFilter:true).sort((a,b)=>b.qty30-a.qty30);

        const medQty=rows.length?rows[Math.floor(rows.length/2)].qty30:0;
        const fast=rows.filter(r=>r.qty30>medQty*1.5&&r.qty30>0);
        const slow=rows.filter(r=>r.qty30<=medQty&&r.qty30>0);
        const none=rows.filter(r=>r.qty30===0);

        kpiEl.innerHTML=
            kpi('⚡','Fast Moving',fast.length,'Last 30 days active','#16a34a')+
            kpi('🐢','Slow Moving',slow.length,'Below median','#d97706')+
            kpi('💀','No Movement',none.length,'Zero in 30 days','#dc2626')+
            kpi('📦','Total Products',rows.length,'In catalog',colHex);

        rptSetChart(chartEl,'Fast Moving — Top 10 (30-day qty)',fast.slice(0,10).map(r=>r.name.substring(0,18)),fast.slice(0,10).map(r=>r.qty30),'bar',cfg.color);
        const sId='rptFS_'+Date.now();
        const sDiv=document.createElement('div');
        sDiv.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
        sDiv.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">🐢 Slow Moving — Bottom 10</h4><canvas id="${sId}" height="130"></canvas>`;
        chartEl.appendChild(sDiv);
        requestAnimationFrame(()=>{
            const c=document.getElementById(sId); if(!c||slow.length===0)return;
            const sRows=[...slow].sort((a,b)=>a.qty30-b.qty30).slice(0,10);
            new Chart(c,{type:'bar',data:{labels:sRows.map(r=>r.name.substring(0,16)),datasets:[{label:'Qty (30d)',data:sRows.map(r=>r.qty30),backgroundColor:'rgba(217,119,6,.75)',borderRadius:3}]},
                options:{indexAxis:'y',responsive:true,plugins:{legend:{display:false}},scales:{x:{beginAtZero:true}}}});
        });

        rptSetTable('Fast vs Slow Moving (30-day)',['Product','Category','30d Qty','30d Spend','30d Orders','On Hand','Speed'],
            rows.map(r=>[r.name,r.cat,r.qty30.toFixed(0),`$${r.spend30.toFixed(2)}`,r.times30,r.on_hand.toFixed(1),
                r.qty30===0?'💀 No Movement':r.qty30>medQty*1.5?'⚡ Fast':'🐢 Slow']));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_dead_stock': {
        const cutoff=new Date(); cutoff.setDate(cutoff.getDate()-60);
        const cutStr=cutoff.toISOString().slice(0,10);
        const active=new Set(d.allEnriched.filter(it=>it.invoice_date>=cutStr).map(it=>it.product_name));
        const lastPurchase={};
        d.allEnriched.forEach(it=>{if(!lastPurchase[it.product_name]||it.invoice_date>lastPurchase[it.product_name])lastPurchase[it.product_name]=it.invoice_date;});
        const priceMap2=new Map();
        d.allEnriched.forEach(it=>{if(it.price>0)priceMap2.set(it.product_name,it.price);});

        const deadRows=d.mgmt.filter(p=>!active.has(p.product_name)&&parseFloat(p.on_hand||0)>0)
            .map(p=>({name:p.product_name,cat:p.category||'Other',on_hand:parseFloat(p.on_hand||0),
                price:priceMap2.get(p.product_name)||0,lastPurchase:lastPurchase[p.product_name]||'Never',
                daysIdle:lastPurchase[p.product_name]?Math.round((Date.now()-new Date(lastPurchase[p.product_name]).getTime())/86400000):999}))
            .filter(r=>catFilter?r.cat===catFilter:true)
            .sort((a,b)=>b.daysIdle-a.daysIdle);

        const totalDeadVal=deadRows.reduce((s,r)=>s+r.on_hand*r.price,0);
        kpiEl.innerHTML=
            kpi('💀','Dead Stock Items',deadRows.length,'No purchase in 60+ days',colHex)+
            kpi('💰','Dead Stock Value',fmt$(totalDeadVal),'Tied up capital','#dc2626')+
            kpi('⚠️','Oldest Item',deadRows[0]?.name?.substring(0,20)||'—',`${deadRows[0]?.daysIdle||0} days idle`,'#d97706')+
            kpi('📦','Active Products',active.size,'Purchased in 60 days','#16a34a');

        rptSetChart(chartEl,'Dead Stock by Value',deadRows.slice(0,10).map(r=>r.name.substring(0,18)),deadRows.slice(0,10).map(r=>r.on_hand*r.price),'bar',cfg.color);

        rptSetTable('Dead Stock Report (60+ Day No Purchase)',['Product','Category','On Hand','Unit Price','Stock Value','Last Purchase','Days Idle'],
            deadRows.map(r=>[r.name,r.cat,r.on_hand.toFixed(1),`$${r.price.toFixed(2)}`,`$${(r.on_hand*r.price).toFixed(2)}`,r.lastPurchase,`${r.daysIdle}d`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_high_value': {
        const threshold=parseFloat(rptEl('rptHighValueThresh')?.value||100);
        const priceMap3=new Map();
        d.allEnriched.sort((a,b)=>b.invoice_date.localeCompare(a.invoice_date)).forEach(it=>{if(it.price>0)priceMap3.set(it.product_name,{price:it.price,vendor:it.vendor});});

        const hvRows=d.mgmt.map(p=>{
            const info=priceMap3.get(p.product_name)||{price:0,vendor:'—'};
            const on_hand=parseFloat(p.on_hand||0);
            const value=on_hand*info.price;
            return {name:p.product_name,cat:p.category||'Other',on_hand,price:info.price,vendor:info.vendor,value};
        }).filter(r=>r.value>=threshold&&(catFilter?r.cat===catFilter:true)).sort((a,b)=>b.value-a.value);

        const total=hvRows.reduce((s,r)=>s+r.value,0);
        kpiEl.innerHTML=
            kpi('💎','High Value Items',hvRows.length,`Above $${threshold.toFixed(0)} value`,colHex)+
            kpi('💰','Total Exposed Value',fmt$(total),'Combined',colHex)+
            kpi('🔝','Highest Exposure',hvRows[0]?.name?.substring(0,20)||'—',fmt$(hvRows[0]?.value||0),'#dc2626')+
            kpi('💡','Avg Exposure',fmt$(hvRows.length?total/hvRows.length:0),'Per item','#8b5cf6');

        rptSetChart(chartEl,'High Value Items',hvRows.slice(0,10).map(r=>r.name.substring(0,18)),hvRows.slice(0,10).map(r=>r.value),'bar',cfg.color);

        if(extEl){
            extEl.innerHTML=`<div style="display:flex;align-items:center;gap:.75rem;padding:0 0 .75rem;"><label style="font-size:.78rem;font-weight:600;color:#374151;">💎 Value Threshold: $</label>
                <input id="rptHighValueThresh" type="number" value="${threshold}" min="0" step="10"
                    style="width:90px;padding:.4rem .6rem;border:1px solid #d1d5db;border-radius:6px;font-size:.85rem;"
                    onchange="loadReport('rpt_high_value')">
                <span style="font-size:.78rem;color:#6b7280;">(items with on-hand value above this amount)</span></div>`;
        }

        rptSetTable('High Value Exposure',['Product','Category','On Hand','Unit Price','Total Value','Vendor','% of Total'],
            hvRows.map(r=>[r.name,r.cat,r.on_hand.toFixed(1),`$${r.price.toFixed(2)}`,`$${r.value.toFixed(2)}`,r.vendor,pct(r.value,total)]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_order_history': {
        if(d.icError){kpiEl.innerHTML=kpi('⚠️','Data Unavailable','—','inventory_check not accessible','#dc2626');rptSetTable('Order History',['Note'],[['inventory_check table unavailable. Check RLS policies.']]);break;}
        const byDate={};
        d.ic.forEach(row=>{const qty=parseFloat(row.tentative||row.on_hand||0);if(!qty)return;const dt=row.order_date;if(!byDate[dt])byDate[dt]={date:dt,orders:0,totalQty:0,products:new Set(),users:new Set()};byDate[dt].orders++;byDate[dt].totalQty+=qty;byDate[dt].products.add(row.product_name);byDate[dt].users.add(row.user);});
        const rows=Object.values(byDate).sort((a,b)=>b.date.localeCompare(a.date));
        kpiEl.innerHTML=kpi('📋','Order Days',rows.length,'Days with orders',colHex)+kpi('📦','Total Qty',rows.reduce((s,r)=>s+r.totalQty,0).toFixed(0),'',colHex)+kpi('🛒','Avg Items/Day',rows.length?(rows.reduce((s,r)=>s+r.orders,0)/rows.length).toFixed(1):'0','','#16a34a')+kpi('👤','Users',[...new Set(d.ic.map(r=>r.user).filter(Boolean))].length,'Active','#d97706');
        rptSetChart(chartEl,'Order Volume by Date',rows.slice(0,12).map(r=>r.date.slice(5)),rows.slice(0,12).map(r=>r.orders),'bar',cfg.color);
        rptSetTable('Order History',['Date','Order Lines','Total Qty','Unique Products','Users'],rows.map(r=>[r.date,r.orders,r.totalQty.toFixed(0),r.products.size,[...r.users].join(', ')]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_order_frequency': {
        if(d.icError){kpiEl.innerHTML=kpi('⚠️','Data Unavailable','—','inventory_check not accessible','#dc2626');rptSetTable('Order Frequency',['Note'],[['inventory_check table unavailable.']]);break;}
        const byProd2={};
        d.ic.forEach(row=>{const qty=parseFloat(row.tentative||row.on_hand||0);if(!qty||!row.product_name)return;const n=row.product_name;if(!byProd2[n])byProd2[n]={name:n,cat:d.mgmtMap.get(n)?.category||'Other',count:0,totalQty:0,lastDate:''};byProd2[n].count++;byProd2[n].totalQty+=qty;if(row.order_date>byProd2[n].lastDate)byProd2[n].lastDate=row.order_date;});
        const rows2=Object.values(byProd2).filter(r=>catFilter?r.cat===catFilter:true).sort((a,b)=>b.count-a.count);
        kpiEl.innerHTML=kpi('🔁','Most Ordered',rows2[0]?.name?.substring(0,18)||'—',`${rows2[0]?.count||0}x`,colHex)+kpi('📦','Products',rows2.length,'',colHex)+kpi('📊','Avg Freq',rows2.length?(rows2.reduce((s,r)=>s+r.count,0)/rows2.length).toFixed(1):'0','','#16a34a')+kpi('📋','Total Lines',rows2.reduce((s,r)=>s+r.count,0),'','#d97706');
        rptSetChart(chartEl,'Top 10 Order Frequency',rows2.slice(0,10).map(r=>r.name.substring(0,16)),rows2.slice(0,10).map(r=>r.count),'bar',cfg.color);
        rptSetTable('Order Frequency',['Product','Category','Times Ordered','Total Qty','Avg Qty/Order','Last Ordered'],rows2.map(r=>[r.name,r.cat,r.count,r.totalQty.toFixed(0),(r.totalQty/r.count).toFixed(1),r.lastDate]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_delivery_accuracy': {
        const ordered2={},delivered2={};
        d.ic.forEach(r=>{const q=parseFloat(r.tentative||r.on_hand||0);if(q)ordered2[r.product_name]=(ordered2[r.product_name]||0)+q;});
        filtered.forEach(it=>{delivered2[it.product_name]=(delivered2[it.product_name]||0)+it.qty;});
        const rows3=Object.keys({...ordered2,...delivered2}).map(name=>{const ord=ordered2[name]||0,del=delivered2[name]||0,acc=ord>0?Math.min(100,Math.round(del/ord*100)):null,cat=d.mgmtMap.get(name)?.category||'Other';return {name,cat,ordered:ord,delivered:del,accuracy:acc,diff:del-ord};}).filter(r=>catFilter?r.cat===catFilter:true).sort((a,b)=>(a.accuracy??99)-(b.accuracy??99));
        const hasAcc=rows3.filter(r=>r.accuracy!==null);
        const avgAcc=hasAcc.length?Math.round(hasAcc.reduce((s,r)=>s+r.accuracy,0)/hasAcc.length):0;
        kpiEl.innerHTML=kpi('🚚','Avg Accuracy',`${avgAcc}%`,'',colHex)+kpi('✅','On Target',rows3.filter(r=>r.accuracy!==null&&r.accuracy>=90).length,'≥90%','#16a34a')+kpi('⚠️','Under',rows3.filter(r=>r.accuracy!==null&&r.accuracy<90).length,'<90%','#d97706')+kpi('📦','Products',rows3.length,'','#8b5cf6');
        rptSetChart(chartEl,'Delivery Accuracy',rows3.slice(0,10).map(r=>r.name.substring(0,16)),rows3.slice(0,10).map(r=>r.accuracy||0),'bar',cfg.color);
        rptSetTable('Delivery Accuracy',['Product','Category','Ordered','Delivered','Accuracy','Over/Under'],rows3.map(r=>[r.name,r.cat,r.ordered.toFixed(0),r.delivered.toFixed(0),r.accuracy!==null?`${r.accuracy}%`:'—',r.diff>0?`+${r.diff.toFixed(0)}`:`${r.diff.toFixed(0)}`]));
        break;
    }

    // ══════════════════════════════════════════════════════════════════
    case 'rpt_executive_summary': {
        const totalSpend=filtered.reduce((s,it)=>s+it.total,0);
        const vendorCount=[...new Set(filtered.map(i=>i.vendor).filter(v=>v&&v!=='—'))].length;
        const productCount=[...new Set(filtered.map(i=>i.product_name).filter(Boolean))].length;
        const invCount=d.invoices.length;
        const priceMap4=new Map(); filtered.forEach(it=>{if(!priceMap4.has(it.product_name)&&it.price>0)priceMap4.set(it.product_name,it.price);});
        const stockValue=d.mgmt.reduce((s,p)=>s+(parseFloat(p.on_hand||0)*(priceMap4.get(p.product_name)||0)),0);
        const lowStock=d.mgmt.filter(p=>parseFloat(p.par||0)>0&&parseFloat(p.on_hand||0)<parseFloat(p.par||0)*.25).length;
        kpiEl.innerHTML=kpi('💳','Period Spend',fmt$(totalSpend),`${d.startStr}→${d.endStr}`,colHex)+kpi('💰','Stock Value',fmt$(stockValue),'On-hand',colHex)+kpi('📋','Invoices',invCount,'',colHex)+kpi('🏭','Vendors',vendorCount,'','#d97706')+kpi('📦','Products',productCount,'','#8b5cf6')+kpi('⚠️','Critical',lowStock,'<25% PAR','#dc2626')+kpi('💡','Avg Invoice',invCount>0?`$${(totalSpend/invCount).toFixed(2)}`:'—','','#ca8a04');
        const byCat2={};filtered.forEach(it=>{byCat2[it.category]=(byCat2[it.category]||0)+it.total;});
        const catR2=Object.entries(byCat2).sort((a,b)=>b[1]-a[1]);
        rptSetChart(chartEl,'Spend by Category',catR2.map(c=>c[0]),catR2.map(c=>c[1]),'doughnut',cfg.color);
        const wSpend={};filtered.forEach(it=>{const wk=`Wk${Math.ceil(new Date(it.invoice_date+'T12:00:00').getDate()/7)}`;wSpend[wk]=(wSpend[wk]||0)+it.total;});
        const wK=Object.keys(wSpend).sort();
        const c2id='rptExecT_'+Date.now();
        const c2d=document.createElement('div');
        c2d.style.cssText='background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);';
        c2d.innerHTML=`<h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">📈 Weekly Spend Trend</h4><canvas id="${c2id}" height="100"></canvas>`;
        chartEl.appendChild(c2d);
        requestAnimationFrame(()=>{const c=document.getElementById(c2id);if(c&&wK.length>0)new Chart(c,{type:'line',data:{labels:wK,datasets:[{label:'Spend',data:wK.map(k=>wSpend[k]),borderColor:`rgb(${r},${g},${b})`,backgroundColor:`rgba(${r},${g},${b},.1)`,fill:true,tension:.3,borderWidth:2}]},options:{responsive:true,plugins:{legend:{display:false}},scales:{y:{beginAtZero:true,ticks:{callback:v=>'$'+v.toFixed(0)}}}}});});
        rptSetTable('Executive Summary — Top 20 by Spend',['Product','Category','Qty','Total Spend','% of Total'],
            filtered.reduce((acc,it)=>{const e=acc.find(x=>x.name===it.product_name);if(e){e.qty+=it.qty;e.total+=it.total;}else acc.push({name:it.product_name,cat:it.category,qty:it.qty,total:it.total});return acc;},[]).sort((a,b)=>b.total-a.total).slice(0,20).map(r=>[r.name,r.cat,r.qty.toFixed(0),`$${r.total.toFixed(2)}`,pct(r.total,totalSpend)]));
        break;
    }

    default: {
        // Legacy stubs redirect
        const redirect={rpt_par_compliance:'rpt_inventory_intel',rpt_stock_valuation:'rpt_inventory_intel',rpt_low_stock:'rpt_inventory_intel',rpt_consumption:'rpt_inventory_intel',rpt_purchase_summary:'rpt_vendor_analysis',rpt_vendor_spend:'rpt_vendor_analysis'};
        if(redirect[tabName]){kpiEl.innerHTML=`<div style="grid-column:1/-1;text-align:center;padding:2rem;"><div style="font-size:.95rem;color:#374151;">Redirecting to consolidated report…</div></div>`;setTimeout(()=>{corpNav(redirect[tabName]);},300);}
        break;
    }

    } // end switch
}

// ── Price Variance Expand/Collapse ────────────────────────────────────
window.rptTogglePVDetail = function(wrapId) {
    const wrap = document.getElementById(wrapId);
    if (!wrap) return;
    const panels = wrap.querySelectorAll('[id^="pvProd_"]');
    panels.forEach(panel => {
        const wasHidden = panel.style.display==='none';
        panel.style.display = wasHidden ? 'block' : 'none';
        // Draw chart on first open
        if (wasHidden) {
            const cdata = window['_pvChartData_'+panel.id];
            if (cdata && !cdata._drawn) {
                cdata._drawn=true;
                const {cid, prod, r, g, b} = cdata;
                requestAnimationFrame(()=>{
                    const c=document.getElementById(cid); if(!c)return;
                    const labels=prod.history.map(h=>h.date.slice(5)+'('+h.vendor.slice(0,8)+')');
                    const values=prod.history.map(h=>h.price);
                    new Chart(c,{type:'line',data:{labels,datasets:[{label:'Price',data:values,borderColor:`rgb(${r},${g},${b})`,backgroundColor:`rgba(${r},${g},${b},.1)`,fill:true,tension:.3,borderWidth:2,pointRadius:4,pointHoverRadius:6}]},options:{responsive:true,plugins:{legend:{display:false},tooltip:{callbacks:{label:ctx=>`$${ctx.parsed.y.toFixed(2)} - ${prod.history[ctx.dataIndex]?.vendor||''}`}}},scales:{y:{beginAtZero:false,ticks:{callback:v=>'$'+v.toFixed(2)}}}}});
                });
            }
        }
    });
    // Arrow toggle
    const arrow = wrap.querySelector('[style*="1.1rem"]');
    if (arrow) arrow.textContent = panels[0]?.style.display==='none' ? '▼' : '▲';
};

// ── CHART HELPER ──────────────────────────────────────────────────────
function _rptDestroyAllCharts() {
    Object.values(_rptCharts).forEach(c=>{try{c.destroy();}catch(e){}});
    _rptCharts={};
    if(typeof _valChart!=='undefined'&&_valChart){try{_valChart.destroy();}catch(e){}}
    if(typeof _valTrendChart!=='undefined'&&_valTrendChart){try{_valTrendChart.destroy();}catch(e){}}
}

function rptSetChart(el, title, labels, values, type, colorArr) {
    if (!el) { console.warn('[rptSetChart] No element'); return; }
    const [r,g,b] = colorArr||[44,88,136];
    const isDoughnut = type==='doughnut';
    const PALETTE=['#3b82f6','#dc2626','#16a34a','#f59e0b','#0ea5e9','#ec4899','#a855f7','#ea580c','#ca8a04','#64748b'];
    const cid='rptChartMain_'+Date.now();
    el.innerHTML=`<div style="background:white;border-radius:12px;padding:1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);">
      <h4 style="font-size:.85rem;font-weight:700;color:var(--neutral-700);margin:0 0 1rem;">📊 ${title}</h4>
      ${labels.length===0?`<div style="padding:2rem;text-align:center;color:#9ca3af;font-style:italic;">No data</div>`:`<canvas id="${cid}" height="${isDoughnut?160:110}"></canvas>`}
    </div>`;
    if(labels.length===0)return;
    requestAnimationFrame(()=>{
        const canvas=document.getElementById(cid); if(!canvas)return;
        if(_rptCharts['chart1']){try{_rptCharts['chart1'].destroy();}catch(e){}}
        _rptCharts['chart1']=new Chart(canvas,{type,data:{labels,datasets:[{label:title,data:values,
            backgroundColor:isDoughnut?PALETTE.slice(0,labels.length):`rgba(${r},${g},${b},0.75)`,
            borderColor:isDoughnut?PALETTE.slice(0,labels.length):`rgb(${r},${g},${b})`,
            borderWidth:1,borderRadius:isDoughnut?0:4}]},
            options:{responsive:true,plugins:{legend:{position:isDoughnut?'right':'top',labels:{font:{size:11},boxWidth:14}},
            tooltip:{callbacks:{label:ctx=>{const v=ctx.parsed.y??ctx.parsed;return typeof v==='number'?v>100?` $${v.toFixed(2)}`:`${v.toFixed(v<10?1:0)}`:`${v}`;}}}},
            scales:isDoughnut?{}:{y:{beginAtZero:true,grid:{color:'rgba(0,0,0,.05)'},ticks:{callback:v=>v>=100?'$'+v.toFixed(0):v}}}}});
    });
}

// ── TABLE HELPERS ─────────────────────────────────────────────────────
let _rptAllRows=[];
function rptSetTable(title,headers,rows){
    _rptAllRows=rows||[];
    const tEl=rptEl('rptTableTitle'),cEl=rptEl('rptTableCount'),hEl=rptEl('rptTableHead');
    if(tEl)tEl.textContent=title;
    if(cEl)cEl.textContent=`${_rptAllRows.length} records`;
    if(hEl)hEl.innerHTML=headers.map(h=>`<th>${h}</th>`).join('');
    rptRenderRows(_rptAllRows);
}
function rptRenderRows(rows){
    const bEl=rptEl('rptTableBody'); if(!bEl)return;
    if(!rows||!rows.length){bEl.innerHTML=`<tr><td colspan="14" style="text-align:center;padding:3rem;color:#9ca3af;font-style:italic;">📭 No data for selected period / filters. Try "All Months" or a different year.</td></tr>`;return;}
    bEl.innerHTML=rows.map(row=>`<tr>${row.map(cell=>`<td>${String(cell??'—')}</td>`).join('')}</tr>`).join('');
}
function rptFilterTable(){
    const q=(rptEl('rptSearch')?.value||'').toLowerCase();
    if(!q){rptRenderRows(_rptAllRows);return;}
    rptRenderRows(_rptAllRows.filter(row=>row.some(cell=>String(cell).toLowerCase().includes(q))));
}

// ── PDF EXPORT ────────────────────────────────────────────────────────
async function rptExportPDF(tabName) {
    const cfg=RPT_CONFIG[tabName]; const data=_rptData[tabName];
    if(!cfg||!data){showAlert('Load the report first, then export.','warning');return;}
    const {jsPDF}=window.jspdf;
    const doc=new jsPDF({orientation:'landscape',unit:'pt',format:'letter'});
    const PW=doc.internal.pageSize.getWidth(),PH=doc.internal.pageSize.getHeight();
    const [r,g,b]=cfg.color;
    const now=new Date(); const dateStr=now.toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
    const monthNames=['January','February','March','April','May','June','July','August','September','October','November','December'];

    let logoData=null;
    try{const res=await fetch(JENGCHI.logo);const blob=await res.blob();logoData=await new Promise(res2=>{const fr=new FileReader();fr.onload=e=>res2(e.target.result);fr.readAsDataURL(blob);});}catch(e){}

    function addPageHeader(isCover){
        doc.setFillColor(r,g,b); doc.rect(0,0,PW,52,'F');
        if(logoData){try{doc.addImage(logoData,'JPEG',16,8,36,36);}catch(e){}}
        doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(isCover?14:11);
        doc.text(JENGCHI.name,60,24);
        doc.setFont('helvetica','normal'); doc.setFontSize(isCover?9:8);
        doc.text(JENGCHI.tagline,60,38);
        doc.setFontSize(8);
        doc.text(`Generated: ${dateStr}`,PW-160,24);
        doc.text(`${cfg.title}`,PW-160,38);
        doc.setFillColor(217,119,6); doc.rect(0,52,PW,4,'F');
    }

    // Cover
    addPageHeader(true);
    doc.setFillColor(248,249,252); doc.rect(0,56,PW,PH-56,'F');
    doc.setTextColor(r,g,b); doc.setFont('helvetica','bold'); doc.setFontSize(28);
    doc.text(cfg.title,PW/2,PH/2-40,{align:'center'});
    doc.setFontSize(14); doc.setTextColor(80,80,80); doc.setFont('helvetica','normal');
    doc.text(`${cfg.category} Report`,PW/2,PH/2-10,{align:'center'});
    doc.setFontSize(10);
    doc.text(`Period: ${data.startStr} to ${data.endStr}`,PW/2,PH/2+20,{align:'center'});
    doc.text(JENGCHI.address,PW/2,PH-55,{align:'center'});
    doc.setFillColor(r,g,b); doc.rect(0,PH-20,PW,20,'F');
    doc.setTextColor(255,255,255); doc.setFont('helvetica','bold'); doc.setFontSize(7);
    doc.text('CONFIDENTIAL — FOR INTERNAL USE ONLY',PW/2,PH-8,{align:'center'});

    // Data
    doc.addPage(); addPageHeader(true);
    const head=[...(_rptCurrentSec||document).querySelectorAll('#rptTableHead th')].map(th=>th.textContent);
    const bodyRows=[...(_rptCurrentSec||document).querySelectorAll('#rptTableBody tr')].map(tr=>[...tr.querySelectorAll('td')].map(td=>td.textContent));
    doc.autoTable({startY:72,head:[head],body:bodyRows,margin:{left:20,right:20,bottom:36},
        styles:{fontSize:7,cellPadding:4,overflow:'linebreak',lineColor:[220,220,220],lineWidth:0.3},
        headStyles:{fillColor:[r,g,b],textColor:255,fontStyle:'bold',fontSize:8.5},
        alternateRowStyles:{fillColor:[248,248,252]},
        didDrawPage:(h)=>{if(h.pageNumber>1)addPageHeader(false);}});

    const fileName=`JengChi_${cfg.title.replace(/[^a-zA-Z0-9]/g,'_')}_${data.year}.pdf`;
    doc.save(fileName);
    showAlert(`📄 ${cfg.title} exported!`,'success');
}


function exportToCSV() {
const headers = ['Vendor','Item No.','Description','Price','Date','Assigned To'];
const rows = filteredData.map(item => [
item.vendor || '',
item.item_code || '',
item.product_name || '',
item.unit_price || '',
item.purchase_date || '',
(item.assigned_to && item.assigned_to[0]) || ''
]);
let csv = headers.join(',') + '\n';  // ✅ Fixed: Use \n instead of literal newline
rows.forEach(row => {
csv += row.map(cell => `"${cell}"`).join(',') + '\n';  // ✅ Fixed
});
const blob = new Blob([csv], { type: 'text/csv' });
const url = window.URL.createObjectURL(blob);
const a = document.createElement('a');
a.href = url;
a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
a.click();
window.URL.revokeObjectURL(url);
showAlert('Exported successfully', 'success');
}



function toggleWeightFields() {
    const hasWeight = document.getElementById('itemHasWeight').checked;
    const quantityFields = document.getElementById('quantityFields');
    const weightFields = document.getElementById('weightFields');
    
    if (hasWeight) {
        // Show weight fields, hide quantity fields
        quantityFields.style.display = 'none';
        weightFields.style.display = 'block';
        
        // Update required attributes
        document.getElementById('itemQuantity').required = false;
        document.getElementById('itemPrice').required = false;
        document.getElementById('itemWeight').required = true;
        document.getElementById('itemPricePerUnit').required = true;
    } else {
        // Show quantity fields, hide weight fields
        quantityFields.style.display = 'block';
        weightFields.style.display = 'none';
        
        // Update required attributes
        document.getElementById('itemQuantity').required = true;
        document.getElementById('itemPrice').required = true;
        document.getElementById('itemWeight').required = false;
        document.getElementById('itemPricePerUnit').required = false;
    }
}

// Sync missing images from inventory_management to invoice_items
async function syncMissingImages() {
    if (!confirm('Sync images for all items missing images? This will copy image paths from Inventory Management.')) {
        return;
    }
    
    showLoading(true);
    try {
        // Step 1: Get all items missing images from invoice_items
        const { data: itemsMissingImages, error: fetchError } = await supabaseClient
            .from('invoice_items')
            .select('id, product_name, item_code')
            .or('image_path.is.null,image_path.eq.');
        
        if (fetchError) throw fetchError;
        
        console.log(`📸 Found ${itemsMissingImages.length} items missing images`);
        
        if (itemsMissingImages.length === 0) {
            showAlert('✅ All items already have images!', 'success');
            return;
        }
        
        // Step 2: Get all products with images from inventory_management
        const { data: inventoryWithImages, error: inventoryError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url')
            .not('image_url', 'is', null)
            .neq('image_url', '');
        
        if (inventoryError) throw inventoryError;
        
        console.log(`📦 Found ${inventoryWithImages.length} products with images in inventory_management`);
        
        // Step 3: Match and update
        let updatedCount = 0;
        
        for (const item of itemsMissingImages) {
            // Find matching product in inventory_management
            const inventoryItem = inventoryWithImages.find(inv => 
                inv.product_name === item.product_name
            );
            
            if (inventoryItem) {
                // Build the full GitHub URL
                let imagePath = inventoryItem.image_url;
                if (!imagePath.startsWith('http')) {
                    imagePath = `https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/${imagePath}`;
                }
                
                // Update the invoice_item
                const { error: updateError } = await supabaseClient
                    .from('invoice_items')
                    .update({ image_path: imagePath })
                    .eq('id', item.id);
                
                if (!updateError) {
                    updatedCount++;
                    console.log(`✅ Updated image for: ${item.product_name}`);
                }
            }
        }
        
        showAlert(`✅ Synced images for ${updatedCount} items!`, 'success');
        
        // Reload data
        await loadInventoryData();
        renderQuickEditTable();
        applyFilters();
        
    } catch (error) {
        console.error('Error syncing images:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

     async function openAddItemModal() {
    document.getElementById('itemModalTitle').textContent = 'Add Item';
    document.getElementById('itemForm').reset();
    document.getElementById('itemForm').removeAttribute('data-edit-id');
    
    // Reset weight checkbox and show quantity fields by default
    document.getElementById('itemHasWeight').checked = false;
    document.getElementById('quantityFields').style.display = 'block';
    document.getElementById('weightFields').style.display = 'none';
    document.getElementById('itemQuantity').value = 1;
    document.getElementById('itemQuantity').required = true;
    document.getElementById('itemPrice').required = true;
    document.getElementById('itemWeight').required = false;
    document.getElementById('itemPricePerUnit').required = false;
    
    // Show invoice selector for new items and make it required
    const invoiceSelectGroup = document.getElementById('invoiceSelectGroup');
    const invoiceSelect = document.getElementById('itemInvoiceId');
    invoiceSelectGroup.style.display = 'block';
    invoiceSelect.required = true;
    
    // Hide purchase date field (date comes from invoice) and remove required
    const dateField = document.getElementById('itemEffectiveDate');
    const dateGroup = dateField.closest('.form-group');
    if (dateGroup) dateGroup.style.display = 'none';
    dateField.required = false; // Remove required attribute for hidden field
    
    // Load available invoices
    await loadInvoicesForSelection();
    
    populateVendorDropdownInModal();
    openModal('itemModal');
}

async function loadInvoicesForSelection() {
    try {
        const { data: invoices, error } = await supabaseClient
            .from('invoices')
            .select('id, invoice_date, vendor, invoice_number')
            .order('invoice_date', { ascending: false })
            .limit(50);
        
        if (error) throw error;
        
        const select = document.getElementById('itemInvoiceId');
        select.innerHTML = '<option value="">-- Select Invoice --</option>';
        
        invoices.forEach(inv => {
            // Parse date without timezone conversion
            const [year, month, day] = inv.invoice_date.split('-');
            const date = `${month}/${day}/${year}`;
            
            const option = document.createElement('option');
            option.value = inv.id;
            option.textContent = `${date} - ${inv.vendor}${inv.invoice_number ? ' - #' + inv.invoice_number : ''}`;
            select.appendChild(option);
        });
        
    } catch (error) {
        console.error('Error loading invoices:', error);
        showAlert('Error loading invoices', 'error');
    }
}


async function editItem(id) {
    console.log('🔍 editItem called with ID:', id, 'Type:', typeof id);
    console.log('📦 inventoryData length:', inventoryData.length);
    console.log('📦 First item ID:', inventoryData[0]?.id, 'Type:', typeof inventoryData[0]?.id);
    
    showLoading(true);
    try {
        // Try to find item with flexible ID comparison (handles string vs UUID vs number)
        const item = inventoryData.find(i => {
            // Convert both to strings for comparison to handle type mismatches
            return String(i.id) === String(id);
        });
        
        if (!item) {
            console.error('❌ Item not found! ID:', id);
            console.error('Available IDs:', inventoryData.map(i => i.id));
            showAlert('Item not found. Please refresh the page and try again.', 'error');
            return;
        }

        console.log('✅ Item found:', item);

        // Set form title and edit ID FIRST
        document.getElementById('itemModalTitle').textContent = 'Edit Item';
        document.getElementById('itemForm').dataset.editId = id;
        
        // Hide invoice selector for editing and remove required
        const invoiceSelectGroup = document.getElementById('invoiceSelectGroup');
        const invoiceSelect = document.getElementById('itemInvoiceId');
        invoiceSelectGroup.style.display = 'none';
        invoiceSelect.required = false;
        
        // Show purchase date field (readonly)
        const dateGroup = document.getElementById('itemEffectiveDate').closest('.form-group');
        if (dateGroup) dateGroup.style.display = 'block';
        
        // Populate vendor dropdown BEFORE setting values
        populateVendorDropdownInModal();
        
        // Now set all the field values
        document.getElementById('itemProductName').value = item.product_name || '';
        document.getElementById('itemNumber').value = item.item_code || '';
        document.getElementById('itemProductImage').value = normalizeImageInput(item.image_path || '');
        document.getElementById('itemVendor').value = item.vendor || '';
        document.getElementById('itemCategory').value = item.category || '';

        // Handle weight vs quantity
        const hasWeight = item.has_weight || false;
        document.getElementById('itemHasWeight').checked = hasWeight;
        
        if (hasWeight) {
            // Item sold by weight
            document.getElementById('quantityFields').style.display = 'none';
            document.getElementById('weightFields').style.display = 'block';
            document.getElementById('itemWeight').value = item.weight || '';
            document.getElementById('itemPricePerUnit').value = item.price_per_unit || '';
            document.getElementById('itemWeight').required = true;
            document.getElementById('itemPricePerUnit').required = true;
            document.getElementById('itemQuantity').required = false;
            document.getElementById('itemPrice').required = false;
        } else {
            // Item sold by quantity
            document.getElementById('quantityFields').style.display = 'block';
            document.getElementById('weightFields').style.display = 'none';
            document.getElementById('itemQuantity').value = item.quantity || 1;
            document.getElementById('itemPrice').value = item.unit_price || '';
            document.getElementById('itemQuantity').required = true;
            document.getElementById('itemPrice').required = true;
            document.getElementById('itemWeight').required = false;
            document.getElementById('itemPricePerUnit').required = false;
        }
        
        // Set purchase date and make it readonly (it's in the invoices table, not invoice_items)
        const dateField = document.getElementById('itemEffectiveDate');
        dateField.value = item.purchase_date || '';
        dateField.readOnly = true;
        dateField.required = true; // Keep required even though readonly
        dateField.style.backgroundColor = '#f5f5f5';
        dateField.style.cursor = 'not-allowed';
        dateField.title = 'Date cannot be changed for individual items. Edit through Invoice Tracking tab.';
        
        // Set assigned_to
        const assignedToSelect = document.getElementById('itemAssignedTo');
        const assignedArray = Array.isArray(item.assigned_to) ? item.assigned_to : [];
        Array.from(assignedToSelect.options).forEach(option => {
            option.selected = assignedArray.includes(option.value);
        });
        
        // Open modal
        openModal('itemModal');
        
    } catch (error) {
        console.error('💥 Edit item error:', error);
        showAlert('Error loading item: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}




function populateVendorDropdownInModal() {
    const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
    const select = document.getElementById('itemVendor');
    const currentValue = select.value; // Save current selection
    
    select.innerHTML = '<option value="">-- Select Vendor --</option>';
    vendors.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
    
    // Restore selection if it exists
    if (currentValue) {
        select.value = currentValue;
    }
}



function openAddInvoiceModal() {
    document.getElementById('invoiceModalTitle').textContent = 'Add Invoice';
    document.getElementById('invoiceForm').reset();
    document.getElementById('invoiceForm').removeAttribute('data-edit-id');
    document.getElementById('invoiceDate').valueAsDate = new Date();
    document.getElementById('invoiceItemsCount').value = '0 items';
    document.getElementById('invoiceTaxEnabled').checked = true;
    
    document.getElementById('invoiceNumberValidation').innerHTML = '';
    document.getElementById('invoiceNumber').style.borderColor = '';
    document.getElementById('invoiceNumber').style.background = '';
    isInvoiceNumberValid = false;
    
    selectedInvoiceProducts = [];
    renderSelectedInvoiceProducts();
    populateInvoiceVendorDropdown();
    document.getElementById('productSearchSection').style.display = 'none';
    document.getElementById('invoiceProductResults').style.display = 'none';
    
    preloadLastPrices();
    
    openModal('invoiceModal');
}


        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

// Recalculate and update invoice totals after adding/editing items
async function updateInvoiceTotals(invoiceId) {
    try {
        // Get all items for this invoice with item_code
        const { data: items, error: itemsError } = await supabaseClient
            .from('invoice_items')
            .select('line_total, item_code')
            .eq('invoice_id', invoiceId);
        
        if (itemsError) throw itemsError;
        
        // Get the invoice to check tax settings
        const { data: invoice, error: invoiceError } = await supabaseClient
            .from('invoices')
            .select('vendor, tax_enabled')
            .eq('id', invoiceId)
            .single();
        
        if (invoiceError) throw invoiceError;
        
        // Calculate subtotal and tax PER ITEM
        // Tax rules: Delta = ALL items, Pacific Plus = only 752GO
        const TAX_RATE = 0.0825;
        const itemCount = items.length;
        const vendorLower = (invoice.vendor || '').toLowerCase();
        const isDelta = vendorLower.includes('delta');
        const isPacificPlus = vendorLower.includes('pacific');
        let subtotal = 0;
        let totalTax = 0;
        
        items.forEach(item => {
            const itemSubtotal = parseFloat(item.line_total) || 0;
            subtotal += itemSubtotal;
            
            // Apply tax based on vendor and item
            if (invoice.tax_enabled) {
                const is752GO = item.item_code === '752GO';
                if (isDelta) {
                    // Delta: tax ALL items
                    totalTax += itemSubtotal * TAX_RATE;
                } else if (isPacificPlus && is752GO) {
                    // Pacific Plus: tax ONLY 752GO
                    totalTax += itemSubtotal * TAX_RATE;
                }
            }
        });
        
        const total = subtotal + totalTax;
        
        let taxStatus = '❌ NO TAX';
        if (isDelta) taxStatus = '✅ DELTA - ALL ITEMS TAXED';
        else if (isPacificPlus) taxStatus = '✅ PACIFIC PLUS - 752GO TAXED';
        
        console.log(`📊 TAX CALC: ${itemCount} items, Vendor: ${invoice.vendor} ${taxStatus}, Subtotal=$${subtotal.toFixed(2)}, Tax=$${totalTax.toFixed(2)}, Total=$${total.toFixed(2)}`);
        
        // Update the invoice with correct column names
        const { error: updateError } = await supabaseClient
            .from('invoices')
            .update({
                subtotal: subtotal,
                tax_amount: totalTax,
                total: total,
                amount: total
            })
            .eq('id', invoiceId);
        
        if (updateError) throw updateError;
        
        console.log(`✅ Invoice updated in database: Subtotal=$${subtotal.toFixed(2)}, Tax=$${totalTax.toFixed(2)}, Total=$${total.toFixed(2)}`);
        
    } catch (error) {
        console.error('Error updating invoice totals:', error);
        // Don't throw - item was added successfully, just log the error
    }
}

// Manual recalculate function for the sync button
async function recalculateInvoiceTotals(invoiceId) {
    if (!confirm('Recalculate this invoice total from all items? This will overwrite the current total.')) {
        return;
    }
    
    showLoading(true);
    try {
        await updateInvoiceTotals(invoiceId);
        showAlert('✅ Invoice totals recalculated successfully!', 'success');
        await loadInvoices();
    } catch (error) {
        showAlert('Error recalculating totals: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

let isSubmittingItem = false; // Flag to prevent multiple submissions

      async function saveVendorItem(event) {
    event.preventDefault();
    
    // Prevent multiple submissions
    if (isSubmittingItem) {
        console.log('⚠️ Already submitting, ignoring duplicate submission');
        return;
    }
    
    isSubmittingItem = true;
    
    // Disable the submit button immediately
    const submitButton = event.target.querySelector('button[type="submit"]');
    if (submitButton) {
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';
    }
    
    showLoading(true);
    try {
        const assignedToSelect = document.getElementById('itemAssignedTo');
        const assignedTo = Array.from(assignedToSelect.selectedOptions).map(o => o.value);
        const editId = document.getElementById('itemForm').dataset.editId;

        // Check if item is sold by weight or quantity
        const hasWeight = document.getElementById('itemHasWeight').checked;
        
        let itemData = {
            product_name: document.getElementById('itemProductName').value,
            item_code: document.getElementById('itemNumber').value,
            vendor: document.getElementById('itemVendor').value,
            category: document.getElementById('itemCategory').value || null,
            image_path: normalizeImageInput(document.getElementById('itemProductImage').value) || null,
            assigned_to: assignedTo,
            has_weight: hasWeight
        };
        
        if (hasWeight) {
            // Item sold by weight
            itemData.weight = parseFloat(document.getElementById('itemWeight').value) || 0;
            itemData.price_per_unit = parseFloat(document.getElementById('itemPricePerUnit').value) || 0;
            itemData.unit_price = 0; // Not used for weight-based items
            itemData.quantity = 0;   // Not used for weight-based items
        } else {
            // Item sold by quantity
            itemData.quantity = parseInt(document.getElementById('itemQuantity').value) || 1;
            itemData.unit_price = parseFloat(document.getElementById('itemPrice').value) || 0;
            itemData.weight = 0;         // Not used for quantity-based items
            itemData.price_per_unit = 0; // Not used for quantity-based items
        }

        if (editId) {
            // Get the original item to know the old product_name
            const originalItem = inventoryData.find(i => String(i.id) === String(editId));
            if (!originalItem) {
                throw new Error('Original item not found');
            }

            const oldProductName = originalItem.product_name;

            // Calculate line_total for the updated item
            if (itemData.has_weight) {
                itemData.line_total = itemData.weight * itemData.price_per_unit;
            } else {
                itemData.line_total = itemData.quantity * itemData.unit_price;
            }

            // STEP 1: Update THIS specific item with ALL fields
            const { error: itemError } = await supabaseClient
                .from('invoice_items')
                .update(itemData)
                .eq('id', editId);
            
            if (itemError) throw itemError;
            
            // Recalculate and update invoice totals
            await updateInvoiceTotals(originalItem.invoice_id);

            let updateMessages = [];

            // STEP 2: Update PRODUCT-LEVEL attributes across ALL vendors (same product name)
            // These are: product_name, category, image_path, assigned_to
            const { data: productUpdates, error: productError } = await supabaseClient
                .from('invoice_items')
                .update({
                    product_name: itemData.product_name,
                    category: itemData.category,
                    image_path: itemData.image_path,
                    assigned_to: itemData.assigned_to
                })
                .eq('product_name', oldProductName)
                .neq('id', editId) // Don't update the item we already updated
                .select();
            
            if (productError) {
                console.warn('Product-level update warning:', productError);
            } else if (productUpdates && productUpdates.length > 0) {
                updateMessages.push(`Updated ${productUpdates.length} items across all vendors`);
            }

            // STEP 3: Update VENDOR-SPECIFIC attributes (item_code) for same product + same vendor
            const { data: vendorUpdates, error: vendorError } = await supabaseClient
                .from('invoice_items')
                .update({
                    item_code: itemData.item_code
                })
                .eq('product_name', itemData.product_name)
                .eq('vendor', itemData.vendor)
                .neq('id', editId) // Don't update the item we already updated
                .select();
            
            if (vendorError) {
                console.warn('Vendor-specific update warning:', vendorError);
            } else if (vendorUpdates && vendorUpdates.length > 0) {
                updateMessages.push(`Updated item code for ${vendorUpdates.length} ${itemData.vendor} items`);
            }

            // Show success message with details
            const mainMessage = '✅ Item updated successfully!';
            const detailMessage = updateMessages.length > 0 ? '\n' + updateMessages.join('\n') : '';
            showAlert(mainMessage + detailMessage, 'success');

        } else {
            // ADD NEW ITEM
            const invoiceId = document.getElementById('itemInvoiceId').value;
            
            if (!invoiceId) {
                showAlert('❌ Please select an invoice', 'error');
                return;
            }
            
            // Add invoice_id to itemData for new items
            itemData.invoice_id = invoiceId;
            
            // Calculate line total based on whether it's sold by weight or quantity
            if (itemData.has_weight) {
                itemData.line_total = itemData.weight * itemData.price_per_unit;
            } else {
                itemData.line_total = itemData.quantity * itemData.unit_price;
            }
            
            console.log('💾 Saving new item to invoice:', invoiceId);
            console.log('💾 Item data:', itemData);
            
            const { error: insertError } = await supabaseClient
                .from('invoice_items')
                .insert([itemData]);
            
            if (insertError) throw insertError;
            
            // Verify the item was saved
            const { data: savedItem, error: verifyError } = await supabaseClient
                .from('invoice_items')
                .select('*')
                .eq('invoice_id', invoiceId)
                .eq('product_name', itemData.product_name)
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            if (!verifyError && savedItem) {
                console.log('✅ Item verified in database:', savedItem.product_name, '- ID:', savedItem.id);
            }
            
            // Recalculate and update invoice totals
            await updateInvoiceTotals(invoiceId);
            
            showAlert('✅ Item added successfully! Invoice totals updated.', 'success');
        }

        closeModal('itemModal');
        await loadInventoryData();
        
        // Also reload invoice data so Invoice Tracking tab shows updated totals
        if (typeof loadInvoices === 'function') {
            await loadInvoices();
        }
        
        renderQuickEditTable();
        applyFilters();
    } catch (error) {
        console.error('Save error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
        isSubmittingItem = false; // Reset flag
        
        // Re-enable submit button
        const form = document.getElementById('itemForm');
        const submitButton = form.querySelector('button[type="submit"]');
        if (submitButton) {
            submitButton.disabled = false;
            submitButton.textContent = 'Save';
        }
    }
}

        // ========== ENHANCED INVOICE FUNCTIONS WITH WEIGHT & PRICE PER UNIT ==========

        function calculateInvoiceTotals() {
            const TAX_RATE = 0.0825;
            let subtotal = 0;
            let totalTax = 0;
            
            // Get current vendor
            const currentVendor = document.getElementById('invoiceVendorDropdown')?.value || '';
            const vendorLower = currentVendor.toLowerCase();
            const isDelta = vendorLower.includes('delta');
            const isPacificPlus = vendorLower.includes('pacific');
            
            // Calculate per-item totals with tax
            selectedInvoiceProducts.forEach(p => {
                const hasWeight = p.has_weight && p.weight && p.weight > 0;
                let itemSubtotal = 0;
                
                if (hasWeight) {
                    itemSubtotal = parseFloat(p.weight || 0) * parseFloat(p.price_per_unit || 0);
                } else {
                    itemSubtotal = parseFloat(p.quantity || 0) * parseFloat(p.invoice_price || 0);
                }
                
                // Tax logic:
                // 1. Delta vendor → tax ALL items
                // 2. Pacific Plus vendor → tax ONLY item 752GO
                // 3. All others → no tax
                const taxEnabled = document.getElementById('invoiceTaxEnabled')?.checked ?? true;
                const is752GO = p.item_code === '752GO';
                let itemTax = 0;
                
                if (taxEnabled) {
                    if (isDelta) {
                        // Delta: tax ALL items
                        itemTax = itemSubtotal * TAX_RATE;
                    } else if (isPacificPlus && is752GO) {
                        // Pacific Plus: tax ONLY 752GO
                        itemTax = itemSubtotal * TAX_RATE;
                    }
                    // All other vendors: no tax
                }
                
                subtotal += itemSubtotal;
                totalTax += itemTax;
            });
            
            const total = subtotal + totalTax;
            
            document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('invoiceTax').textContent = '$' + totalTax.toFixed(2);
            document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);
            
            // Update tax label
            const taxLabel = document.getElementById('taxLabel');
            const taxEnabled = document.getElementById('invoiceTaxEnabled')?.checked ?? true;
            const has752GO = selectedInvoiceProducts.some(p => p.item_code === '752GO');
            
            if (taxEnabled && isDelta) {
                taxLabel.textContent = '💰 Tax (8.25% - DELTA - ALL ITEMS):';
                taxLabel.style.color = 'var(--success-700)';
                taxLabel.style.fontWeight = '700';
            } else if (taxEnabled && isPacificPlus && has752GO) {
                taxLabel.textContent = '💰 Tax (8.25% - PACIFIC PLUS - ITEM 752GO):';
                taxLabel.style.color = 'var(--primary-700)';
                taxLabel.style.fontWeight = '700';
            } else if (taxEnabled) {
                taxLabel.textContent = 'Tax (Not applicable):';
                taxLabel.style.color = 'var(--neutral-500)';
                taxLabel.style.fontWeight = '400';
            } else {
                taxLabel.textContent = 'Tax (Disabled):';
                taxLabel.style.color = 'var(--neutral-400)';
                taxLabel.style.fontWeight = '400';
            }
            
            return { subtotal, taxAmount: totalTax, total, taxEnabled };
        }

        function updateInvoiceVendorField() {
            const vendor = document.getElementById('invoiceVendorDropdown').value;
            if (vendor) {
                searchInvoiceProducts();
            }
        }

       function searchInvoiceProducts() {
    const searchTerm = document.getElementById('invoiceProductSearch').value.toLowerCase();
    const selectedVendor = document.getElementById('invoiceVendorDropdown').value;
    const resultsDiv = document.getElementById('invoiceProductResults');
    
    if (!searchTerm && !selectedVendor) {
        resultsDiv.style.display = 'none';
        return;
    }

    let filteredProducts = inventoryData.filter(item => {
        const matchesSearch = !searchTerm || 
            (item.product_name || '').toLowerCase().includes(searchTerm) ||
            (item.item_code || '').toLowerCase().includes(searchTerm);
        
        const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
        
        return matchesSearch && matchesVendor;
    });

    const productMap = new Map();
    filteredProducts.forEach(item => {
        if (!productMap.has(item.item_code)) {
            productMap.set(item.item_code, item);
        }
    });

    const uniqueProducts = Array.from(productMap.values());

    if (uniqueProducts.length === 0) {
        resultsDiv.innerHTML = '<p style="color: var(--neutral-500); text-align: center; padding: 1rem;">No products found</p>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = uniqueProducts.map(item => {
        const imageUrl = resolveImage(item.image_path);
        const isSelected = selectedInvoiceProducts.some(p => p.item_code === item.item_code);
        
        return `
            <div class="invoice-product-item ${isSelected ? 'selected' : ''}" 
                 onclick="toggleInvoiceProduct('${item.item_code}')">
                <img src="${imageUrl}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;" onerror="this.src='${PLACEHOLDER_IMAGE}'">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--neutral-900);">${item.product_name || 'Unnamed'}</div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600);">
                        <span class="item-number">${item.item_code}</span> • 
                        <span class="vendor-badge" style="padding: 0.125rem 0.5rem; font-size: 0.75rem;">${item.vendor}</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="price-cell" style="font-size: 1.125rem;">$${parseFloat(item.unit_price || 0).toFixed(2)}</div>
                    ${isSelected ? '<i class="fas fa-check-circle" style="color: var(--success-600); font-size: 1.25rem;"></i>' : ''}
                </div>
            </div>
        `;
    }).join('');
}

async function toggleInvoiceProduct(itemCode) {
    const existingIndex = selectedInvoiceProducts.findIndex(p => p.item_code === itemCode);
    
    if (existingIndex > -1) {
        selectedInvoiceProducts.splice(existingIndex, 1);
    } else {
        const product = inventoryData.find(i => i.item_code === itemCode);
        if (!product) return;

        // ✅ Fetch last unit price from purchase_history
        let lastPrice = null;
        try {
            const { data, error } = await supabaseClient
                .from('purchase_history')
                .select('unit_price')
                .eq('item_code', itemCode)
                .eq('vendor', product.vendor)
                .order('purchase_date', { ascending: false })
                .limit(1);
            
            if (!error && data && data.length > 0) {
                lastPrice = parseFloat(data[0].unit_price);
            }
        } catch (e) {
            console.warn('Failed to fetch last price:', e);
        }

        // ✅ FEATURE #3: BY WEIGHT MEMORY - Check if product was previously by-weight
        let wasWeightBefore = false;
        try {
            const { data: weightHistory, error: weightError } = await supabaseClient
                .from('invoice_items')
                .select('has_weight')
                .eq('product_name', product.product_name)
                .eq('has_weight', true)
                .limit(1);
            
            if (!weightError && weightHistory && weightHistory.length > 0) {
                wasWeightBefore = true;
                console.log(`✅ BY WEIGHT MEMORY: "${product.product_name}" was previously by-weight, auto-checking!`);
            }
        } catch (e) {
            console.warn('Failed to check weight history:', e);
        }

        // ✅ Use lastPrice if available, otherwise inventory price
        const unitPrice = lastPrice !== null ? lastPrice : (parseFloat(product.unit_price) || 0);

        selectedInvoiceProducts.push({
            item_code: product.item_code,
            product_name: product.product_name,
            vendor: product.vendor,
            unit_price: unitPrice,
            invoice_price: unitPrice,        // ← THIS IS THE KEY: set unit price
            quantity: 1,
            weight: wasWeightBefore ? 1 : null,  // Auto-set weight to 1 if previously by-weight
            price_per_unit: unitPrice,
            has_weight: wasWeightBefore,  // ← AUTO-SET if previously by-weight!
            image_path: product.image_path,
            originalItemCode: product.item_code,
            originalProductName: product.product_name
        });
    }

    searchInvoiceProducts();
    // Scroll to the newly added item only
    renderSelectedInvoiceProducts(true);
}

function renderSelectedInvoiceProducts(_scrollToLast = false) {
    const container = document.getElementById('selectedInvoiceProducts');
    const countLabel = document.getElementById('invoiceProductCount');
    const itemsCountField = document.getElementById('invoiceItemsCount');

    const itemCount = selectedInvoiceProducts.length;
    countLabel.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''} selected`;
    itemsCountField.value  = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;

    if (itemCount === 0) {
        container.innerHTML = `
            <div style="text-align:center;padding:3rem;background:white;border-radius:12px;border:2px dashed var(--neutral-300);">
                <div style="font-size:3rem;margin-bottom:1rem;opacity:0.3;">📦</div>
                <h3 style="color:var(--neutral-600);margin-bottom:0.5rem;">No Products Added Yet</h3>
                <p style="color:var(--neutral-500);">Click "+ Add Item" to search and add products to this invoice</p>
            </div>`;
        calculateInvoiceTotals();
        return;
    }

    // ── Compact table layout — no full re-render on keystrokes ──────────────
    container.innerHTML = `
    <table style="width:100%;border-collapse:collapse;background:white;border-radius:12px;overflow:hidden;box-shadow:0 1px 4px rgba(0,0,0,0.08);">
      <thead>
        <tr style="background:linear-gradient(135deg,var(--primary-700),var(--primary-600));color:white;font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.06em;">
          <th style="padding:0.65rem 0.5rem;text-align:left;width:44px;"></th>
          <th style="padding:0.65rem 0.75rem;text-align:left;">Product</th>
          <th style="padding:0.65rem 0.5rem;text-align:center;width:70px;">⚖ Wt?</th>
          <th style="padding:0.65rem 0.5rem;text-align:center;width:90px;">Qty / Lbs</th>
          <th style="padding:0.65rem 0.5rem;text-align:center;width:115px;">Price Each / /lb</th>
          <th style="padding:0.65rem 0.5rem;text-align:right;width:90px;">Line Total</th>
          <th style="padding:0.65rem 0.5rem;text-align:center;width:40px;"></th>
        </tr>
      </thead>
      <tbody id="invoiceItemsTbody">
      </tbody>
    </table>`;

    const tbody = document.getElementById('invoiceItemsTbody');

    selectedInvoiceProducts.forEach((product, idx) => {
        const imageUrl    = resolveImage(product.image_path);
        const weightNum   = parseFloat(product.weight) || 0;
        const hasWeight   = !!(product.has_weight || weightNum > 0);
        const ppuNum      = parseFloat(product.price_per_unit) || 0;
        const qtyNum      = parseInt(product.quantity) || 0;
        const priceNum    = parseFloat(product.invoice_price) || 0;
        const lineTotal   = hasWeight ? (weightNum * ppuNum) : (qtyNum * priceNum);
        const rowBg       = idx % 2 === 0 ? '#ffffff' : '#fafafa';
        const lastPrice   = product.unit_price ? parseFloat(product.unit_price).toFixed(2) : null;

        const tr = document.createElement('tr');
        tr.id = 'inv-row-' + idx;
        tr.style.cssText = `background:${rowBg};border-bottom:1px solid #f0f0f0;transition:background 0.15s;`;
        tr.onmouseenter = () => tr.style.background = '#f0f4ff';
        tr.onmouseleave = () => tr.style.background = rowBg;

        tr.innerHTML = `
          <!-- Image -->
          <td style="padding:0.5rem 0.4rem 0.5rem 0.65rem;">
            <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
                 style="width:36px;height:36px;border-radius:6px;object-fit:cover;box-shadow:0 1px 3px rgba(0,0,0,0.12);">
          </td>

          <!-- Product name + item code -->
          <td style="padding:0.4rem 0.75rem;">
            <input type="text"
                   id="invName_${idx}"
                   value="${(product.product_name||'').replace(/"/g,'&quot;')}"
                   onchange="updateInvoiceProductFieldInPlace(${idx},'product_name',this.value)"
                   style="width:100%;font-size:0.875rem;font-weight:600;border:1px solid transparent;border-radius:5px;padding:0.3rem 0.45rem;background:transparent;color:var(--neutral-800);transition:all 0.15s;"
                   onfocus="this.style.background='white';this.style.borderColor='var(--primary-400)';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.15)';"
                   onblur="this.style.background='transparent';this.style.borderColor='transparent';this.style.boxShadow='none';">
            <div style="display:flex;align-items:center;gap:0.35rem;margin-top:0.25rem;">
              <input type="text"
                     id="invCode_${idx}"
                     value="${(product.item_code||'').replace(/"/g,'&quot;')}"
                     onchange="updateInvoiceProductFieldInPlace(${idx},'item_code',this.value)"
                     placeholder="Item code"
                     style="font-size:0.72rem;font-family:var(--font-mono);border:1px solid transparent;border-radius:4px;padding:0.2rem 0.35rem;background:transparent;color:var(--neutral-500);width:120px;transition:all 0.15s;"
                     onfocus="this.style.background='white';this.style.borderColor='#cbd5e1';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.1)';"
                     onblur="this.style.background='transparent';this.style.borderColor='transparent';this.style.boxShadow='none';">
              <span style="font-size:0.68rem;color:#94a3b8;">${product.vendor||''}</span>
            </div>
          </td>

          <!-- Weight toggle -->
          <td style="padding:0.4rem 0.5rem;text-align:center;">
            <label style="display:inline-flex;align-items:center;justify-content:center;cursor:pointer;gap:0.2rem;" title="${hasWeight?'Weight mode — click to switch to Qty':'Qty mode — click to switch to Weight'}">
              <input type="checkbox" ${hasWeight?'checked':''}
                     onchange="toggleWeightMode(${idx},this.checked)"
                     style="width:15px;height:15px;cursor:pointer;accent-color:var(--primary-600);">
              <span style="font-size:0.7rem;color:${hasWeight?'var(--primary-600)':'#94a3b8'};font-weight:600;">${hasWeight?'⚖':'#'}</span>
            </label>
          </td>

          <!-- Qty or Weight input -->
          <td style="padding:0.4rem 0.35rem;text-align:center;">
            ${hasWeight ? `
              <input type="number" id="invoiceWeight_${idx}"
                     value="${weightNum||''}"
                     min="0" step="0.01" placeholder="lbs"
                     oninput="updateInvoiceProductFieldInPlace(${idx},'weight',this.value)"
                     style="width:80px;text-align:center;font-size:0.9rem;font-weight:700;border:1px solid #e2e8f0;border-radius:6px;padding:0.35rem 0.4rem;font-family:var(--font-mono);transition:all 0.15s;"
                     onfocus="this.style.borderColor='var(--primary-400)';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.15)';"
                     onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none';">
              <div style="font-size:0.65rem;color:#92400e;margin-top:0.15rem;">lbs</div>
            ` : `
              <input type="number" id="invoiceQty_${idx}"
                     value="${qtyNum||1}"
                     min="1" step="1"
                     oninput="updateInvoiceProductFieldInPlace(${idx},'quantity',this.value)"
                     style="width:70px;text-align:center;font-size:0.9rem;font-weight:700;border:1px solid #e2e8f0;border-radius:6px;padding:0.35rem 0.4rem;transition:all 0.15s;"
                     onfocus="this.style.borderColor='var(--primary-400)';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.15)';"
                     onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none';">
            `}
          </td>

          <!-- Price input -->
          <td style="padding:0.4rem 0.35rem;text-align:center;">
            ${hasWeight ? `
              <input type="number" id="invoicePPU_${idx}"
                     value="${ppuNum||''}"
                     min="0" step="0.01" placeholder="$/lb"
                     oninput="updateInvoiceProductFieldInPlace(${idx},'price_per_unit',this.value)"
                     style="width:100px;text-align:right;font-size:0.9rem;font-weight:700;border:1px solid #e2e8f0;border-radius:6px;padding:0.35rem 0.45rem;font-family:var(--font-mono);transition:all 0.15s;"
                     onfocus="this.style.borderColor='var(--primary-400)';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.15)';"
                     onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none';">
              ${lastPrice ? `<div style="font-size:0.65rem;color:#64748b;margin-top:0.15rem;">Last: $${lastPrice}</div>` : ''}
            ` : `
              <input type="number" id="invoicePrice_${idx}"
                     value="${priceNum||''}"
                     min="0" step="0.01" placeholder="0.00"
                     oninput="updateInvoiceProductFieldInPlace(${idx},'invoice_price',this.value)"
                     style="width:100px;text-align:right;font-size:0.9rem;font-weight:700;border:1px solid #e2e8f0;border-radius:6px;padding:0.35rem 0.45rem;font-family:var(--font-mono);transition:all 0.15s;"
                     onfocus="this.style.borderColor='var(--primary-400)';this.style.boxShadow='0 0 0 2px rgba(107,68,68,0.15)';"
                     onblur="this.style.borderColor='#e2e8f0';this.style.boxShadow='none';">
              ${lastPrice ? `<div style="font-size:0.65rem;color:#64748b;margin-top:0.15rem;">Last: $${lastPrice}</div>` : ''}
            `}
          </td>

          <!-- Line total -->
          <td style="padding:0.4rem 0.5rem;text-align:right;">
            <span id="invLineTotal_${idx}"
                  style="font-size:0.9rem;font-weight:700;font-family:var(--font-mono);color:var(--primary-700);">
              $${lineTotal.toFixed(2)}
            </span>
          </td>

          <!-- Delete -->
          <td style="padding:0.4rem 0.5rem;text-align:center;">
            <button type="button" onclick="removeInvoiceProduct(${idx})"
                    title="Remove item"
                    style="width:28px;height:28px;border-radius:5px;border:1px solid #fca5a5;background:#fef2f2;color:#ef4444;cursor:pointer;display:inline-flex;align-items:center;justify-content:center;font-size:0.75rem;transition:all 0.15s;"
                    onmouseover="this.style.background='#ef4444';this.style.color='white';"
                    onmouseout="this.style.background='#fef2f2';this.style.color='#ef4444';">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;

        tbody.appendChild(tr);
    });

    calculateInvoiceTotals();
    // ✅ FIX: Only suppress search section; do NOT auto-scroll on every render
    document.getElementById('productSearchSection').style.display = 'none';
    document.getElementById('invoiceProductSearch').value = '';
    document.getElementById('invoiceProductResults').style.display = 'none';

    // Only scroll if explicitly adding a new item (not on every keystroke)
    if (_scrollToLast) {
        setTimeout(() => {
            const tbody2 = document.getElementById('invoiceItemsTbody');
            if (tbody2 && tbody2.lastElementChild) {
                tbody2.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }, 80);
    }
}

// ── In-place field update — NO full re-render, NO scroll ─────────────────────
function updateInvoiceProductFieldInPlace(index, field, value) {
    if (index < 0 || index >= selectedInvoiceProducts.length) return;
    const product = selectedInvoiceProducts[index];

    if (field === 'quantity')      { product.quantity      = Math.max(1, parseInt(value) || 1); }
    else if (field === 'weight')   { product.weight        = Math.max(0, parseFloat(value) || 0); }
    else if (field === 'invoice_price')   { const p = parseFloat(value); product.invoice_price   = isNaN(p) ? 0 : p; }
    else if (field === 'price_per_unit')  { const p = parseFloat(value); product.price_per_unit  = isNaN(p) ? 0 : p; }
    else if (field === 'product_name')    { product.product_name = value; }
    else if (field === 'item_code')       { product.item_code    = value; }

    const hasWeight = !!(product.has_weight || parseFloat(product.weight||0) > 0);
    const lineTotal = hasWeight
        ? (parseFloat(product.weight||0) * parseFloat(product.price_per_unit||0))
        : (parseInt(product.quantity||0) * parseFloat(product.invoice_price||0));

    const totalEl = document.getElementById('invLineTotal_' + index);
    if (totalEl) totalEl.textContent = '$' + lineTotal.toFixed(2);
    calculateInvoiceTotals();

    // ✅ Auto-save: debounce 900ms
    clearTimeout(updateInvoiceProductFieldInPlace._t);
    updateInvoiceProductFieldInPlace._t = setTimeout(() => autoSaveInvoiceItem(index), 900);
}

// ── Auto-save single item to Supabase ────────────────────────────────────────
async function autoSaveInvoiceItem(index) {
    const product  = selectedInvoiceProducts[index];
    if (!product || !product._dbId) return;
    const invoiceId = document.getElementById('invoiceForm')?.dataset?.editId;
    if (!invoiceId) return;

    const hw  = !!(product.has_weight || parseFloat(product.weight||0) > 0);
    const wt  = hw ? (parseFloat(product.weight)         || 0) : 0;
    const ppu = hw ? (parseFloat(product.price_per_unit)  || 0) : 0;
    const qt  = hw ? 0 : (parseInt(product.quantity)     || 0);
    const up  = hw ? 0 : (parseFloat(product.invoice_price) || 0);

    try {
        const { error } = await supabaseClient.from('invoice_items')
            .update({ item_code: product.item_code, product_name: product.product_name,
                      quantity: qt, unit_price: up, weight: wt, price_per_unit: ppu,
                      has_weight: hw, line_total: hw ? (wt*ppu) : (qt*up) })
            .eq('id', product._dbId);
        if (!error) {
            const ind = document.getElementById('autoSaveIndicator');
            if (ind) { ind.style.opacity='1'; clearTimeout(autoSaveInvoiceItem._h); autoSaveInvoiceItem._h = setTimeout(()=>ind.style.opacity='0', 2000); }
        }
    } catch(e) { console.warn('Auto-save failed:', e); }
}

// ── Toggle New Item panel ──────────────────────────────────────────────────────
function toggleNewItemPanel() {
    const panel = document.getElementById('newItemPanel');
    if (!panel) return;
    const open = panel.style.display !== 'none';
    panel.style.display = open ? 'none' : 'block';
    if (!open) {
        resetNewItemPanelFields();
        setTimeout(() => document.getElementById('newItemCode')?.focus(), 60);
    }
}

// Reset fields but keep panel open — so user can add another item immediately
function resetNewItemPanelFields() {
    ['newItemCode','newItemName','newItemImage','newItemPrice'].forEach(id => { const el=document.getElementById(id); if(el) el.value=''; });
    const qEl = document.getElementById('newItemQty'); if(qEl) qEl.value='1';
    const wEl = document.getElementById('newItemIsWeight'); if(wEl) wEl.checked=false;
    const catEl = document.getElementById('newItemCategory'); if(catEl) catEl.value='';
    const assignEl = document.getElementById('newItemAssignTo'); if(assignEl) assignEl.value='';
    const st = document.getElementById('newItemStatus'); if(st) st.innerHTML='';
}

// populateNewItemCategories: removed — categories now hardcoded in HTML panel with optgroups

// ── Save new item to catalog and add it to the invoice ───────────────────────
async function saveNewItemAndAddToInvoice() {
    const statusEl  = document.getElementById('newItemStatus');
    const name      = (document.getElementById('newItemName')?.value  || '').trim();
    const code      = (document.getElementById('newItemCode')?.value  || '').trim();
    const category  = (document.getElementById('newItemCategory')?.value || '').trim();
    const imageUrl  = (document.getElementById('newItemImage')?.value || '').trim() || null;
    const qty       = parseInt(document.getElementById('newItemQty')?.value)   || 1;
    const price     = parseFloat(document.getElementById('newItemPrice')?.value) || 0;
    const isWeight  = document.getElementById('newItemIsWeight')?.checked || false;
    const assignTo  = document.getElementById('newItemAssignTo')?.value || '';
    const vendor    = document.getElementById('invoiceVendorDropdown')?.value || '';

    if (!name)     { statusEl.innerHTML = '<span style="color:#dc2626;"><i class="fas fa-exclamation-triangle"></i> Product Name required</span>';  return; }
    if (!category) { statusEl.innerHTML = '<span style="color:#dc2626;"><i class="fas fa-exclamation-triangle"></i> Category required</span>'; return; }

    statusEl.innerHTML = '<span style="color:#059669;"><i class="fas fa-spinner fa-spin"></i> Saving to catalog…</span>';

    try {
        // Save to inventory_management (include assigned_to if set)
        const mgmtRecord = {
            product_name: name, image_url: imageUrl, vendors: vendor,
            category: category, on_hand: 0, par: 0
        };
        if (assignTo) mgmtRecord.assigned_to = [assignTo];

        const { error: mgmtErr } = await supabaseClient.from('inventory_management').insert([mgmtRecord]);
        // ✅ Safe includes check — guard against undefined
        if (mgmtErr && !(mgmtErr.message||'').includes('duplicate')) throw mgmtErr;

        // Save to inventory_data
        if (code || price > 0) {
            const { error: invErr } = await supabaseClient.from('inventory_data').insert([{
                item_code: code || null, product_name: name,
                vendor: vendor, unit_price: price, image_path: imageUrl
            }]);
            if (invErr && !(invErr.message||'').includes('duplicate')) console.warn('inventory_data warn:', invErr);
        }

        // Add to current invoice
        selectedInvoiceProducts.push({
            product_name: name, item_code: code||'', vendor: vendor,
            image_path: imageUrl||'', unit_price: price,
            invoice_price: isWeight ? 0 : price, price_per_unit: isWeight ? price : 0,
            quantity: isWeight ? 0 : qty, weight: isWeight ? qty : 0,
            has_weight: isWeight, category: category,
            assigned_to: assignTo ? [assignTo] : []
        });
        renderSelectedInvoiceProducts(true);
        await loadInventoryData();

        // ✅ STAY OPEN — show success, clear fields, focus Item Code for next item
        const assignLabel = assignTo ? ` → assigned to ${assignTo.charAt(0).toUpperCase()+assignTo.slice(1)}` : '';
        statusEl.innerHTML = `<span style="color:#059669;font-weight:600;"><i class="fas fa-check-circle"></i> ✅ "${name}" added!${assignLabel} — Ready for next item</span>`;
        setTimeout(() => {
            resetNewItemPanelFields();
            document.getElementById('newItemCode')?.focus();
        }, 1400);

    } catch(e) {
        console.error('saveNewItemAndAddToInvoice error:', e);
        statusEl.innerHTML = `<span style="color:#dc2626;"><i class="fas fa-exclamation-triangle"></i> Error: ${e.message||'Unknown error'}</span>`;
    }
}

// ── Draggable invoice modal ───────────────────────────────────────────────────
(function initInvoiceDrag() {
    function attachDrag() {
        const handle = document.getElementById('invoiceModalDragHandle');
        const box    = document.getElementById('invoiceModalBox');
        if (!handle || !box) return;
        let isDragging = false, startX = 0, startY = 0, origLeft = 0, origTop = 0;
        handle.addEventListener('mousedown', function(e) {
            if (e.target.closest('.modal-close')) return;
            isDragging = true;
            handle.style.cursor = 'grabbing';
            const rect = box.getBoundingClientRect();
            // Switch from transform-based centering to absolute position
            box.style.transform = 'none';
            box.style.left  = rect.left + 'px';
            box.style.top   = rect.top  + 'px';
            startX   = e.clientX;
            startY   = e.clientY;
            origLeft = rect.left;
            origTop  = rect.top;
            e.preventDefault();
        });
        document.addEventListener('mousemove', function(e) {
            if (!isDragging) return;
            const dx = e.clientX - startX;
            const dy = e.clientY - startY;
            box.style.left = Math.max(0, Math.min(window.innerWidth  - box.offsetWidth,  origLeft + dx)) + 'px';
            box.style.top  = Math.max(0, Math.min(window.innerHeight - box.offsetHeight, origTop  + dy)) + 'px';
        });
        document.addEventListener('mouseup', function() {
            if (isDragging) { isDragging = false; handle.style.cursor = 'grab'; }
        });
    }
    // Try immediately, fallback to DOMContentLoaded
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', attachDrag);
    } else {
        attachDrag();
    }
})();

// Get last price for a product from purchase history
async function getLastPriceForProduct(itemCode, vendor) {
    try {
        const { data, error } = await supabaseClient
            .from('purchase_history')
            .select('unit_price, purchase_date')
            .eq('item_code', itemCode)
            .eq('vendor', vendor)
            .order('purchase_date', { ascending: false })
            .limit(1);
        
        if (error || !data || data.length === 0) return null;
        return parseFloat(data[0].unit_price);
    } catch (error) {
        console.error('Error getting last price:', error);
        return null;
    }
}


// Preload last prices when modal opens
async function preloadLastPrices() {
    try {
        console.log('🔄 Preloading last prices...');
        
        // Get all unique product-vendor combinations
        const uniqueCombinations = new Set();
        inventoryData.forEach(item => {
            if (item.item_code && item.vendor) {
                uniqueCombinations.add(`${item.item_code}_${item.vendor}`);
            }
        });
        
        // Fetch last prices in batches
        let count = 0;
        for (const combo of uniqueCombinations) {
            const [itemCode, vendor] = combo.split('_');
            await getLastPriceForProduct(itemCode, vendor);
            count++;
        }
        
        console.log('✅ Preloaded last prices for', count, 'products');
    } catch (error) {
        console.error('Error preloading prices:', error);
    }
}

function toggleWeightMode(index, isEnabled) {
    if (index >= 0 && index < selectedInvoiceProducts.length) {
        const product = selectedInvoiceProducts[index];
        
        product.has_weight = isEnabled;
        
        if (isEnabled) {
            // Switching TO weight mode
            // Keep weight if already set (e.g. from a previous toggle), else default to empty
            if (!product.weight) {
                product.weight = '';   // leave blank so user enters real lbs
            }
            if (!product.price_per_unit || product.price_per_unit === 0) {
                // Pre-fill with the existing unit price as a starting point
                product.price_per_unit = parseFloat(product.invoice_price) || parseFloat(product.unit_price) || 0;
            }
            // Zero out qty since this is now weight-based
            product.quantity = 0;
        } else {
            // Switching FROM weight mode back to qty mode
            if (product.weight && product.price_per_unit) {
                // ✅ Preserve the calculated total as the new invoice price
                product.invoice_price = parseFloat(product.weight) * parseFloat(product.price_per_unit);
            }
            product.weight = null;
            product.price_per_unit = null;
            product.has_weight = false;
            // ✅ FIXED: Reset quantity to 1 (was 0 from weight mode, which caused $0 totals)
            if (!product.quantity || product.quantity <= 0) {
                product.quantity = 1;
            }
        }
        
        renderSelectedInvoiceProducts();
    }
}



function updateInvoiceProductField(index, field, value) {
    // ✅ Route all calls through the in-place updater (no full re-render on keystrokes)
    updateInvoiceProductFieldInPlace(index, field, value);
}


        function removeInvoiceProduct(index) {
            selectedInvoiceProducts.splice(index, 1);
            renderSelectedInvoiceProducts();
            searchInvoiceProducts();
        }

        function populateInvoiceVendorDropdown() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorDropdown');
            select.innerHTML = '<option value="">-- Select Vendor --</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        async function saveInvoice(event) {
            event.preventDefault();
              // ✅ CHECK INVOICE NUMBER VALIDATION BEFORE SAVING
    const editId = document.getElementById('invoiceForm').dataset.editId;
    if (!editId && !isInvoiceNumberValid) {
        showAlert('⚠️ Please fix the invoice number before saving', 'error');
        return;
    }
    
    if (selectedInvoiceProducts.length === 0) {
        showAlert('Please add at least one product to the invoice', 'error');
        return;
    }
            // ✅ DOM SYNC: read current field values into selectedInvoiceProducts
            // Guarantees Save captures typed values even if user clicked Save 
            // immediately after typing (before any blur/change event could fire)
            selectedInvoiceProducts.forEach((product, _domIdx) => {
                const wEl   = document.getElementById('invoiceWeight_'  + _domIdx);
                const ppuEl = document.getElementById('invoicePPU_'     + _domIdx);
                const qEl   = document.getElementById('invoiceQty_'     + _domIdx);
                const ipEl  = document.getElementById('invoicePrice_'   + _domIdx);
                if (wEl   && wEl.value   !== '') product.weight        = Math.max(0, parseFloat(wEl.value)   || 0);
                if (ppuEl && ppuEl.value !== '') product.price_per_unit = Math.max(0, parseFloat(ppuEl.value) || 0);
                if (qEl   && qEl.value   !== '') product.quantity       = Math.max(0, parseInt(qEl.value)    || 0);
                if (ipEl  && ipEl.value  !== '') product.invoice_price  = Math.max(0, parseFloat(ipEl.value) || 0);
            });

            console.log('🔵 saveInvoice started');
            console.log('🔵 selectedInvoiceProducts:', selectedInvoiceProducts);
            
            if (selectedInvoiceProducts.length === 0) {
                showAlert('Please add at least one product to the invoice', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const editId = document.getElementById('invoiceForm').dataset.editId;
                const vendor = document.getElementById('invoiceVendorDropdown').value;
                const totals = calculateInvoiceTotals();

                console.log('🔵 Invoice totals:', totals);

                const invoiceData = {
                    vendor: vendor,
                    invoice_number: document.getElementById('invoiceNumber').value,
                    invoice_date: document.getElementById('invoiceDate').value,
                    check_number: document.getElementById('invoiceCheckNumber').value || null,
                    notes: document.getElementById('invoiceNotes').value || null,
                    subtotal: totals.subtotal,
                    tax_rate: totals.taxEnabled ? TAX_RATE : 0,
                    tax_amount: totals.taxAmount,
                    tax_enabled: totals.taxEnabled,
                    total: totals.total,
                    amount: totals.total
                };

                console.log('🔵 Invoice data to save:', invoiceData);

                let invoiceId = editId;

                if (editId) {
                    console.log('🟡 Updating existing invoice:', editId);
                    const { error } = await supabaseClient.from('invoices').update(invoiceData).eq('id', editId);
                    if (error) throw error;
                    showAlert('✅ Invoice updated successfully!', 'success');
                } else {
                    console.log('🟢 Creating new invoice');
                    const { data, error } = await supabaseClient.from('invoices').insert([invoiceData]).select();
                    if (error) {
                        console.error('❌ Error creating invoice:', error);
                        throw error;
                    }
                    invoiceId = data[0].id;
                    console.log('✅ New invoice created with ID:', invoiceId);
                    showAlert('✅ Invoice saved successfully!', 'success');
                }

                console.log('🔴 Preparing to save invoice items...');
                console.log('🔴 Invoice ID:', invoiceId);
                console.log('🔴 Number of products:', selectedInvoiceProducts.length);

                // ── Build item payloads ────────────────────────────────────────
                // RULE: always use 0 (never null) for numeric fields
                // Supabase RLS rejects null numerics → causes 42501 error
                const buildItemPayload = (product, forInsert = false) => {
                    // Detect weight mode: has_weight flag OR weight > 0
                    const hasWeight = !!(product.has_weight || parseFloat(product.weight||0) > 0);
                    const wt  = hasWeight ? (parseFloat(product.weight)        || 0) : 0;
                    const ppu = hasWeight ? (parseFloat(product.price_per_unit) || 0) : 0;
                    const qt  = hasWeight ? 0 : (parseInt(product.quantity)    || 0);
                    const up  = hasWeight ? 0 : (parseFloat(product.invoice_price) || 0);
                    const lineTotal = hasWeight ? (wt * ppu) : (qt * up);

                    const payload = {
                        item_code:      product.item_code,
                        product_name:   product.product_name,
                        vendor:         product.vendor,
                        quantity:       qt,   // 0 for weight items — NEVER null (RLS rejects null)
                        unit_price:     up,   // 0 for weight items — NEVER null
                        weight:         wt,   // 0 for qty items   — NEVER null
                        price_per_unit: ppu,  // 0 for qty items   — NEVER null
                        has_weight:     hasWeight,
                        line_total:     lineTotal
                    };
                    if (forInsert) payload.invoice_id = invoiceId;
                    return payload;
                };

                // ── Split: existing rows (UPDATE) vs new rows (INSERT) ─────────
                const existingProducts = selectedInvoiceProducts.filter(p => p._dbId);
                const newProducts      = selectedInvoiceProducts.filter(p => !p._dbId);

                // ── If editing: delete rows that were REMOVED from the list ─────
                let insertedItems = [];
                if (editId) {
                    const keptIds = new Set(existingProducts.map(p => p._dbId));
                    // Fetch current item IDs in DB for this invoice
                    const { data: currentDbItems } = await supabaseClient
                        .from('invoice_items').select('id').eq('invoice_id', editId);
                    const toDelete = (currentDbItems || []).filter(r => !keptIds.has(r.id)).map(r => r.id);
                    if (toDelete.length > 0) {
                        console.log('🗑️ Deleting removed items:', toDelete);
                        await supabaseClient.from('invoice_items').delete().in('id', toDelete);
                    }
                }

                // ── UPDATE existing items (avoids RLS INSERT restriction) ───────
                for (const product of existingProducts) {
                    const payload = buildItemPayload(product, false);
                    console.log('🟡 Updating item:', product._dbId, payload);

                    // ✅ FIXED: .select() forces Supabase to return affected rows.
                    // Without it, RLS silently blocks the write — no error, just data:[] —
                    // and the UI showed "✅ SUCCESS" even though nothing was saved.
                    const { data: updData, error: updErr } = await supabaseClient
                        .from('invoice_items').update(payload).eq('id', product._dbId).select();

                    if (updErr) {
                        console.error('❌ Update failed for item', product._dbId, updErr);
                        throw updErr;
                    }

                    // ✅ FIXED: Catch silent RLS block (Supabase returns data:[] with no error)
                    if (!updData || updData.length === 0) {
                        console.error('❌ Silent RLS block for:', product.product_name, product._dbId, payload);
                        throw new Error(`Could not save "${product.product_name}" (id: ${product._dbId.slice(0,8)}). Supabase blocked the update silently — check RLS policies on invoice_items. Payload: has_weight=${payload.has_weight}, qty=${payload.quantity}, weight=${payload.weight}`);
                    }

                    console.log('✅ Updated item:', product._dbId, updData[0]);
                }

                // ── INSERT only truly NEW items ───────────────────────────────
                if (newProducts.length > 0) {
                    const newPayloads = newProducts.map(p => buildItemPayload(p, true));
                    console.log('🟢 Inserting new items:', newPayloads);
                    const { data: inserted, error: insErr } = await supabaseClient
                        .from('invoice_items').insert(newPayloads).select();
                    if (insErr) {
                        console.error('❌ Insert failed for new items:', insErr);
                        throw insErr;
                    }
                    insertedItems = inserted || [];
                }

                // Combine for downstream use (on_hand update etc.)
                const invoiceItems = selectedInvoiceProducts.map(p => buildItemPayload(p, false));

                console.log('✅✅✅ SUCCESS! Items saved. Updated:', existingProducts.length, 'Inserted:', insertedItems.length);

// ✅ NEW: SYNC PRICES TO PURCHASE_HISTORY TABLE
console.log('💾 Syncing prices to purchase_history table...');
const invoiceDate = document.getElementById('invoiceDate').value;

for (const product of selectedInvoiceProducts) {
    const hasWeight = product.has_weight && product.weight && product.weight > 0;
    
    // Determine the unit price based on pricing mode
    const unitPrice = hasWeight 
        ? parseFloat(product.price_per_unit)  // Weight-based: use price per lb
        : parseFloat(product.invoice_price);   // Regular: use invoice price
    
    // Create purchase_history record
    const purchaseRecord = {
        product_name: product.product_name,
        item_code: product.item_code,
        vendor: vendor,
        unit_price: unitPrice,
        purchase_date: invoiceDate,
        image_path: product.image_path || null,
        assigned_to: null  // Can be set if needed
    };
    
    // Insert into purchase_history
    const { error: historyError } = await supabaseClient
        .from('purchase_history')
        .insert([purchaseRecord]);
    
    if (historyError) {
        console.error('⚠️ Error saving to purchase_history:', historyError);
        // Don't throw - main invoice save succeeded
    } else {
        console.log(`✅ Price history saved: ${product.product_name} @ $${unitPrice.toFixed(2)}`);
    }
}

// Update product names/codes in inventory if changed
for (const product of selectedInvoiceProducts) {
                    const updates = {};
                    let needsUpdate = false;

                    if (product.productNameChanged && product.product_name !== product.originalProductName) {
                        updates.product_name = product.product_name;
                        needsUpdate = true;
                    }

                    if (product.itemCodeChanged && product.item_code !== product.originalItemCode) {
                        updates.item_code = product.item_code;
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        console.log(`🔄 Updating inventory for item code: ${product.originalItemCode}`, updates);
                        const { error } = await supabaseClient
                            .from('purchase_history')
                            .update(updates)
                            .eq('item_code', product.originalItemCode);

                        if (error) {
                            console.error('Error updating products:', error);
                        } else {
                            console.log('✅ Inventory updated successfully');
                        }
                    }
                }

                selectedInvoiceProducts = [];
                closeModal('invoiceModal');
                await loadInvoices();
                await loadInventoryData();
                populateInvoiceVendorSelect();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
                renderInventoryTable();
                renderQuickEditTable();

                // ✅ AUTO-UPDATE on_hand: current stock + (invoice qty × units_per_case)
                // Example: #1 Folded Takeout Box White — 1 case = 9 units
                console.log('📦 Updating on_hand quantities from invoice (with case conversion)...');

                // Load all product_conversions once
                let convMapForUpdate = new Map();
                try {
                    const { data: convRows } = await supabaseClient
                        .from('product_conversions')
                        .select('product_name, units_per_case, unit_type');
                    (convRows || []).forEach(c => {
                        convMapForUpdate.set(c.product_name.toLowerCase(), parseFloat(c.units_per_case || 1));
                    });
                } catch(e) {
                    console.warn('⚠️ Could not load product_conversions, defaulting to 1:1', e);
                }

                for (const product of invoiceItems) {
                    const invoiceQty = parseFloat(product.quantity || 0);
                    if (invoiceQty <= 0) continue;

                    // Look up units per case — e.g. 1 case Folded Box = 9 units
                    const unitsPerCase = convMapForUpdate.get((product.product_name || '').toLowerCase()) || 1;
                    const unitsToAdd = invoiceQty * unitsPerCase;

                    console.log(`📦 ${product.product_name}: ${invoiceQty} case(s) × ${unitsPerCase} units/case = +${unitsToAdd} units`);

                    try {
                        // Get current on_hand from inventory_management
                        const { data: existing, error: fetchErr } = await supabaseClient
                            .from('inventory_management')
                            .select('id, on_hand, product_name')
                            .ilike('product_name', product.product_name)
                            .limit(1);
                        if (fetchErr || !existing?.length) {
                            console.warn(`⚠️ Product not found in inventory_management: ${product.product_name}`);
                            continue;
                        }

                        const prevOnHand = parseFloat(existing[0].on_hand || 0);
                        const newOnHand  = prevOnHand + unitsToAdd;

                        const { error: updErr } = await supabaseClient
                            .from('inventory_management')
                            .update({ on_hand: newOnHand })
                            .eq('id', existing[0].id);

                        if (!updErr) {
                            console.log(`✅ ${product.product_name}: on_hand ${prevOnHand} → ${newOnHand} (+${unitsToAdd} units)`);
                        } else {
                            console.error(`❌ Failed to update on_hand for ${product.product_name}:`, updErr);
                        }
                    } catch(e) {
                        console.warn('⚠️ Could not update on_hand for', product.product_name, e);
                    }
                }

                // Refresh stock alert bell after invoice save
                if (typeof loadDropdownAlerts === 'function') loadDropdownAlerts();

            } catch (error) {
                console.error('💥 CRITICAL ERROR in saveInvoice:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editInvoice(id) {
            showLoading(true);
            try {
                const { data: invoice, error: invoiceError } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (invoiceError) throw invoiceError;

                const { data: items, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .select('*')
                    .eq('invoice_id', id);
                
                if (itemsError) throw itemsError;

                console.log('📦 Loaded invoice:', invoice);
                console.log('📦 Loaded', items.length, 'items for invoice', invoice.invoice_number);
                console.log('📦 Items:', items.map(i => i.product_name));

                openModal('invoiceModal');
                populateInvoiceVendorDropdown();
                
                setTimeout(() => {
                    document.getElementById('invoiceModalTitle').textContent = 'Edit Invoice';
                    
                    const vendorDropdown = document.getElementById('invoiceVendorDropdown');
                    const invoiceNumberField = document.getElementById('invoiceNumber');
                    const invoiceDateField = document.getElementById('invoiceDate');
                    const checkNumberField = document.getElementById('invoiceCheckNumber');
                    const notesField = document.getElementById('invoiceNotes');
                    const itemsCountField = document.getElementById('invoiceItemsCount');
                    const taxEnabledField = document.getElementById('invoiceTaxEnabled');
                    
                    if (vendorDropdown) vendorDropdown.value = invoice.vendor || '';
                    if (invoiceNumberField) invoiceNumberField.value = invoice.invoice_number || '';
                    if (invoiceDateField) invoiceDateField.value = invoice.invoice_date || '';
                    if (checkNumberField) checkNumberField.value = invoice.check_number || '';
                    if (notesField) notesField.value = invoice.notes || '';
                    if (taxEnabledField) taxEnabledField.checked = invoice.tax_enabled !== false;
                    
                    document.getElementById('invoiceForm').dataset.editId = id;
                    
                  selectedInvoiceProducts = (items || []).map(item => {
    // Detect weight mode: has_weight flag OR weight column > 0
    // (some items stored without has_weight flag but still have weight value)
    const weightVal   = parseFloat(item.weight || 0);
    const hasWeight   = !!(item.has_weight || weightVal > 0);

    let invoice_price = 0;
    let price_per_unit = 0;

    if (hasWeight) {
        price_per_unit = parseFloat(item.price_per_unit) || 0;
        invoice_price  = price_per_unit;
    } else {
        invoice_price  = parseFloat(item.unit_price) || 0;
        price_per_unit = 0;
    }

    return {
        _dbId:               item.id,           // ✅ Preserve DB ID → UPDATE not INSERT
        item_code:           item.item_code,
        product_name:        item.product_name,
        vendor:              item.vendor,
        category:            item.category || null,
        assigned_to:         item.assigned_to || null,
        unit_price:          parseFloat(item.unit_price || item.price_per_unit || 0),
        invoice_price:       invoice_price,
        // ✅ Weight items: load actual weight (e.g. 320), NOT quantity (which is 0/null)
        quantity:            hasWeight ? 0 : (parseInt(item.quantity) || 0),
        weight:              weightVal,          // ✅ Always the real lb amount
        price_per_unit:      price_per_unit,
        has_weight:          hasWeight,          // ✅ Correct flag including weight>0 items
        image_path:          item.image_path || null,
        originalItemCode:    item.item_code,
        originalProductName: item.product_name
    };
});

                    console.log('selectedInvoiceProducts:', selectedInvoiceProducts);

                    selectedInvoiceProducts.forEach(product => {
                        const inventoryItem = inventoryData.find(i => i.item_code === product.item_code);
                        if (inventoryItem) {
                            product.image_path = inventoryItem.image_path;
                        }
                    });

                    renderSelectedInvoiceProducts();
                    
                    if (itemsCountField) {
                        itemsCountField.value = `${selectedInvoiceProducts.length} item${selectedInvoiceProducts.length !== 1 ? 's' : ''}`;
                    }
                    
                    document.getElementById('productSearchSection').style.display = 'none';
                    document.getElementById('invoiceProductResults').style.display = 'none';
                }, 100);
                
            } catch (error) {
                console.error('Edit invoice error:', error);
                showAlert('Error loading invoice: ' + error.message, 'error');
                closeModal('invoiceModal');
            } finally {
                showLoading(false);
            }
        }

        async function deleteSingleItem(id) {
            if (!confirm('Delete this item?')) return;
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('invoice_items').delete().eq('id', id);
                if (error) throw error;
                showAlert('Item deleted', 'success');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting item', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Delete this invoice?')) return;
            showLoading(true);
            try {
                await supabaseClient.from('invoice_items').delete().eq('invoice_id', id);
                const { error } = await supabaseClient.from('invoices').delete().eq('id', id);
                if (error) throw error;
                showAlert('Invoice deleted', 'success');
                await loadInvoices();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting invoice', 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedItems.clear();
            
            const deleteToggleBtn = document.getElementById('deleteToggleBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const checkboxHeader = document.getElementById('checkboxHeader');
            
            if (deleteMode) {
                deleteToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteSelectedBtn.style.display = 'inline-flex';
                checkboxHeader.style.display = 'table-cell';
            } else {
                deleteToggleBtn.innerHTML = '🗑️';
                deleteSelectedBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
            }
            
            renderInventoryTable();
        }

        function toggleItemSelection(itemId) {
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
            } else {
                selectedItems.add(itemId);
            }
            renderInventoryTable();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            if (selectAll) {
                filteredData.forEach(item => selectedItems.add(item.id));
            } else {
                selectedItems.clear();
            }
            renderInventoryTable();
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showAlert('Select items to delete', 'error');
                return;
            }
            
            if (!confirm(`Delete ${selectedItems.size} items?`)) return;
            
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('invoice_items').delete().in('id', Array.from(selectedItems));
                if (error) throw error;
                showAlert('Items deleted', 'success');
                selectedItems.clear();
                deleteMode = false;
                await loadInventoryData();
                applyFilters();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Delete failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== BULK ASSIGN MODE ==========
        let bulkAssignMode = false;

        function toggleBulkAssignMode() {
            bulkAssignMode = !bulkAssignMode;
            
            // If turning on bulk assign mode, turn off delete mode
            if (bulkAssignMode && deleteMode) {
                deleteMode = false;
                document.getElementById('deleteToggleBtn').innerHTML = '🗑️';
                document.getElementById('deleteSelectedBtn').style.display = 'none';
            }
            
            selectedItems.clear();
            
            const bulkAssignToggleBtn = document.getElementById('bulkAssignToggleBtn');
            const applyBulkAssignBtn = document.getElementById('applyBulkAssignBtn');
            const checkboxHeader = document.getElementById('checkboxHeader');
            
            if (bulkAssignMode) {
                bulkAssignToggleBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                bulkAssignToggleBtn.style.background = 'var(--error-600)';
                applyBulkAssignBtn.style.display = 'inline-flex';
                checkboxHeader.style.display = 'table-cell';
            } else {
                bulkAssignToggleBtn.innerHTML = '<i class="fas fa-user-check"></i> Bulk Assign';
                bulkAssignToggleBtn.style.background = 'var(--primary-600)';
                applyBulkAssignBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
            }
            
            renderInventoryTable();
        }

        async function applyBulkAssignment() {
            if (selectedItems.size === 0) {
                showAlert('⚠️ Please select items to assign', 'warning');
                return;
            }

            // Update count and show modal
            document.getElementById('selectedItemsCount').textContent = selectedItems.size;
            
            // Clear previous selection
            document.querySelectorAll('input[name="assignmentChoice"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Show modal
            openModal('quickAssignModal');
        }

        async function confirmQuickAssignment() {
            const selectedRadio = document.querySelector('input[name="assignmentChoice"]:checked');
            
            if (!selectedRadio) {
                showAlert('⚠️ Please select who to assign to', 'warning');
                return;
            }

            const assignTo = selectedRadio.value; // 'rony', 'julio', or 'office'
            const itemCount = selectedItems.size;

            closeModal('quickAssignModal');

            showLoading(true);
            try {
                // Update purchase_history table (this is the main inventory table)
                const { data, error } = await supabaseClient
                    .from('purchase_history')
                    .update({ assigned_to: assignTo })
                    .in('id', Array.from(selectedItems))
                    .select();

                if (error) throw error;

                const updatedCount = data ? data.length : itemCount;

                showAlert(`✅ Successfully assigned ${updatedCount} items to ${assignTo.toUpperCase()}`, 'success');
                selectedItems.clear();
                bulkAssignMode = false;
                toggleBulkAssignMode(); // Reset UI
                await loadInventoryData();
                renderInventoryTable();
            } catch (error) {
                console.error('Bulk assign error:', error);
                showAlert('❌ Assignment failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function openBulkAssignModal() {
            const productMap = new Map();
            
            inventoryData.forEach(item => {
                if (!item.item_code) return;
                
                if (!productMap.has(item.item_code)) {
                    productMap.set(item.item_code, {
                        code: item.item_code,
                        name: item.product_name || 'Unnamed',
                        count: 0,
                        assignedTo: []
                    });
                }
                
                const entry = productMap.get(item.item_code);
                entry.count++;
                
                let assignedArray = [];
                
                if (item.assigned_to) {
                    if (Array.isArray(item.assigned_to)) {
                        assignedArray = item.assigned_to;
                    } else if (typeof item.assigned_to === 'string') {
                        const trimmed = item.assigned_to.trim();
                        if (trimmed && trimmed !== '[]' && trimmed !== '{}' && trimmed !== 'null') {
                            try {
                                assignedArray = JSON.parse(trimmed);
                            } catch (e) {
                                assignedArray = [];
                            }
                        }
                    }
                }
                
                const validAssignments = assignedArray.filter(person => 
                    person && 
                    typeof person === 'string' && 
                    person.trim() !== '' &&
                    person.trim() !== '[]' &&
                    person.trim() !== '{}'
                );
                
                validAssignments.forEach(person => {
                    if (!entry.assignedTo.includes(person)) {
                        entry.assignedTo.push(person);
                    }
                });
            });

            const allProducts = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            const unassignedProducts = allProducts.filter(p => p.assignedTo.length === 0);
            const assignedProducts = allProducts.filter(p => p.assignedTo.length > 0);

            let html = '';
            
            if (unassignedProducts.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-700); margin-bottom: 0.5rem;">
                            📋 Unassigned Products (${unassignedProducts.length})
                        </h4>
                `;
                unassignedProducts.forEach(p => {
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; background: white; border: 2px solid var(--accent-400); border-radius: 4px; margin-bottom: 0.25rem;">
                            <input type="checkbox" class="product-checkbox" value="${p.code}" style="width: 18px; height: 18px;">
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">${p.count} items</span>
                        </label>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: var(--success-600); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 1rem;">✅ All products are assigned!</p>`;
            }

            if (assignedProducts.length > 0) {
                html += `
                    <details style="margin-top: 1rem; padding: 0.5rem; background: var(--neutral-100); border-radius: 8px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--neutral-700);">
                            ✅ Already Assigned Products (${assignedProducts.length})
                        </summary>
                        <div style="margin-top: 0.5rem;">
                `;
                
                assignedProducts.forEach(p => {
                    const assignedList = p.assignedTo
                        .map(person => person.charAt(0).toUpperCase() + person.slice(1))
                        .join(', ');
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem; color: var(--neutral-600);">
                            <i class="fa-solid fa-check" style="color: var(--success-600);"></i>
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">→ ${assignedList}</span>
                        </div>
                    `;
                });
                
                html += `</div></details>`;
            }

            document.getElementById('productCheckboxList').innerHTML = html;
            openModal('bulkAssignModal');
        }

        function toggleAllProducts() {
            const selectAll = document.getElementById('selectAllProducts').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function saveBulkAssignment() {
            const selectedCodes = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            const person = document.getElementById('bulkAssignTo').value;
            const mode = document.getElementById('assignmentMode').value;

            if (selectedCodes.length === 0) {
                showAlert('Please select at least one product', 'error');
                return;
            }
            if (!person) {
                showAlert('Please select an employee to assign', 'error');
                return;
            }

            if (!confirm(`Assign ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}?`)) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => selectedCodes.includes(item.item_code));
                
                for (const item of itemsToUpdate) {
                    let currentAssigned = [];
                    
                    try {
                        if (Array.isArray(item.assigned_to)) {
                            currentAssigned = item.assigned_to;
                        } else if (typeof item.assigned_to === 'string') {
                            const s = item.assigned_to.trim();
                            if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                                currentAssigned = JSON.parse(s);
                            }
                        }
                    } catch (e) {
                        currentAssigned = [];
                    }
                    
                    let newAssigned;
                    if (mode === 'replace') {
                        newAssigned = [person];
                    } else {
                        if (!currentAssigned.includes(person)) {
                            newAssigned = [...currentAssigned, person];
                        } else {
                            newAssigned = currentAssigned;
                        }
                    }
                    
                    const { error } = await supabaseClient
                        .from('purchase_history')
                        .update({ assigned_to: newAssigned })
                        .eq('id', item.id);
                        
                    if (error) throw error;
                }

                showAlert(`✅ Successfully assigned ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}!`, 'success');
                closeModal('bulkAssignModal');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();

            } catch (error) {
                console.error('Bulk assign error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

// ========== JULIO'S ORDERS FUNCTIONS ==========

// ========== JULIO'S ORDERS FUNCTIONS (FIXED - EMPTY BY DEFAULT) ==========

let julioTargetsMap = new Map();

// ========== FIXED: Julio's Orders with invoice_items data ==========

// ========== FIX 1: STOP TRIMMING PRODUCT NAMES ==========
async function loadJulioOrders() {
    try {
        const dateInput   = document.getElementById('julioOrderDate');
        const selectedDate = dateInput ? dateInput.value : todayYMD();

        if (dateInput && !dateInput.value) {
            dateInput.value = todayYMD();
        }

        // ── Products assigned to Julio ────────────────────────────────────
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, item_code, assigned_to, category')
            .order('product_name');

        if (prodError) throw prodError;

        const uniqueProducts = new Map();
        (products || []).forEach(p => {
            const name     = p.product_name || '';
            const assigned = String(p.assigned_to || '').toLowerCase();
            if (!name || !assigned.includes('julio')) return;

            if (!uniqueProducts.has(name)) {
                uniqueProducts.set(name, {
                    product_name:    name,
                    image_url:       p.image_url,
                    item_code:       p.item_code,
                    category:        p.category || 'Uncategorized',
                    target_quantity: null,   // what Julio submitted as target
                    order_needed:    null    // calculated: target − on_hand
                });
            }
        });

        // ── Load Julio's submitted targets ────────────────────────────────
        const { data: targets } = await supabaseClient
            .from('target_inventory')
            .select('product_name, target_quantity')
            .eq('order_date', selectedDate);

        (targets || []).forEach(t => {
            const name = t.product_name || '';
            if (uniqueProducts.has(name)) {
                uniqueProducts.get(name).target_quantity = t.target_quantity;
            }
        });

        // ── Load inventory_check for this date (has on_hand & target) ─────
        // This gives us the ALREADY CALCULATED needed quantity
        const { data: checkRows } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, target, tentative, user')
            .eq('order_date', selectedDate);

        (checkRows || []).forEach(row => {
            if ((row.user || '').toLowerCase() !== 'julio') return;
            const name = row.product_name || '';
            if (!uniqueProducts.has(name)) return;

            const product   = uniqueProducts.get(name);
            const onHand    = parseFloat(row.on_hand  || 0);
            const target    = parseFloat(row.target   || 0);
            const tentative = parseFloat(row.tentative|| 0);

            // ORDER NEEDED = target − on_hand  (never negative)
            const needed = Math.max(0, target - onHand);

            // Auto-fill: use saved tentative if already set, else needed qty
            product.order_needed = needed;
            if (tentative > 0) {
                product.target_quantity = tentative;  // already saved order qty
            } else if (needed > 0) {
                product.target_quantity = needed;     // pre-fill with needed
            }
        });

        // ── Vendor / price data (unchanged from original) ────────────────
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id))];
        let invoiceDates = new Map();

        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => {
                invoiceDates.set(inv.id, { date: inv.invoice_date, vendor: inv.vendor });
            });
        }

        uniqueProducts.forEach((product, productName) => {
            const productInvoices = (invoiceItems || []).filter(i => i.product_name === productName);
            const vendors   = new Set();
            const priceData = [];

            productInvoices.forEach(item => {
                const invInfo = invoiceDates.get(item.invoice_id);
                if (!invInfo) return;
                vendors.add(invInfo.vendor);
                const unitPrice = item.has_weight
                    ? parseFloat(item.price_per_unit || 0)
                    : parseFloat(item.unit_price     || 0);
                priceData.push({ vendor: invInfo.vendor, price: unitPrice, date: invInfo.date });
            });

            // Legacy purchase_history
            const legacy = window.inventoryData
                ? window.inventoryData.filter(i => i.product_name === productName)
                : [];
            legacy.forEach(item => {
                if (item.vendor) vendors.add(item.vendor);
                priceData.push({ vendor: item.vendor, price: parseFloat(item.unit_price || 0), date: item.purchase_date });
            });

            product.vendors   = Array.from(vendors);
            product.priceData = priceData;
        });

        julioTargetsMap = uniqueProducts;
        renderJulioProducts();

    } catch (error) {
        console.error('Load Julio orders error:', error);
        showAlert('Error loading Julio orders', 'error');
    }
}


// ========== ULTRA-SIMPLIFIED JULIO CARD ==========

function renderJulioProducts() {
  const container = document.getElementById('julioProductGrid');
  const searchTerm = document.getElementById('julioSearchInput')?.value.toLowerCase() || '';

  let products = Array.from(julioTargetsMap.values()).filter(p => {
    if (!searchTerm) return true;
    return (p.product_name || '').toLowerCase().includes(searchTerm);
  });

  // Group by category
  const categorized = new Map();
  products.forEach(p => {
    const category = p.category || 'Uncategorized';
    if (!categorized.has(category)) categorized.set(category, []);
    categorized.get(category).push(p);
  });

  // Sort categories alphabetically, 'Other' always last
  const sortedCategories = Array.from(categorized.keys()).sort((a, b) => {
    if (a === 'Other') return 1;
    if (b === 'Other') return -1;
    return a.localeCompare(b);
  });
  // Sort products alphabetically within each category
  sortedCategories.forEach(cat => {
    categorized.get(cat).sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));
  });

  document.getElementById('julioProductCount').textContent = `${products.length} products`;

  // ✅ UPDATE PROGRESS BAR
  const totalProducts = products.length;
  const productsSet = products.filter(p => p.target_quantity != null && p.target_quantity > 0).length;
  const progressPct = totalProducts > 0 ? Math.round((productsSet / totalProducts) * 100) : 0;

  const progressBar = document.getElementById('julioProgress');
  const progressPercent = document.getElementById('julioProgressPercent');
  const productsSetEl = document.getElementById('julioProductsSet');
  const totalProductsEl = document.getElementById('julioTotalProducts');

  if (progressBar) progressBar.style.width = progressPct + '%';
  if (progressPercent) progressPercent.textContent = progressPct + '%';
  if (productsSetEl) productsSetEl.textContent = productsSet;
  if (totalProductsEl) totalProductsEl.textContent = totalProducts;

  if (products.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">📦</div>
        <h3>No Products Found</h3>
      </div>
    `;
    return;
  }

  container.innerHTML = sortedCategories.map(category => {
    const categoryProducts = categorized.get(category);
    categoryProducts.sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));

    const categoryColors = {
      'Produce':            { bg: '#dcfce7', border: '#16a34a', text: '#15803d' },
      'Meat & Seafood':     { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
      'Dairy':              { bg: 'var(--primary-100)', border: 'var(--primary-500)', text: 'var(--primary-600)' },
      'Dry Goods':          { bg: '#fef3c7', border: '#f59e0b', text: '#b45309' },
      'Frozen':             { bg: '#e0f2fe', border: '#0ea5e9', text: '#075985' },
      'Beverages':          { bg: '#fce7f3', border: '#ec4899', text: '#be185d' },
      'Cleaning Supplies':  { bg: '#f3e8ff', border: '#a855f7', text: '#7e22ce' },
      'Office Supplies':    { bg: '#ede9fe', border: '#8b5cf6', text: '#6d28d9' },
      'Kitchen Equipment':  { bg: '#fed7aa', border: '#ea580c', text: '#c2410c' },
      'Supermarket':        { bg: '#fefce8', border: '#ca8a04', text: '#854d0e' },
      'Other':              { bg: '#f1f5f9', border: '#64748b', text: '#475569' }
    };

    const colors = categoryColors[category] || categoryColors['Other'];

    return `
      <div style="margin-bottom: 2rem; grid-column: 1 / -1;">
        <div style="
          background: linear-gradient(135deg, ${colors.bg}, white);
          padding: 1rem 1.5rem;
          border-radius: 12px;
          border-left: 6px solid ${colors.border};
          margin-bottom: 1rem;
          box-shadow: var(--shadow-sm);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 700; color: ${colors.text}; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
              ${getCategoryIcon(category)} ${category}
            </h3>
            <span style="background: ${colors.border}; color: white; padding: 0.375rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 700; font-family: var(--font-mono);">
              ${categoryProducts.length}
            </span>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.75rem;">
          ${categoryProducts.map(product => renderJulioProductCard(product, colors)).join('')}
        </div>
      </div>
    `;
  }).join('');
}


// ✅ NEW: Get icon for category
function getCategoryIcon(category) {
  const icons = {
    'Produce': '🥬',
    'Meat & Seafood': '🥩',
    'Dairy': '🥛',
    'Dry Goods': '🌾',
    'Frozen': '❄️',
    'Beverages': '🥤',
    'Cleaning Supplies': '🧹',
    'Office Supplies': '📎',
    'Kitchen Equipment': '🍳',
    'Supermarket': '🛒',
    'Other': '📦'
  };
  return icons[category] || '📦';
}

// ✅ NEW: Separate product card function
function renderJulioProductCard(product, categoryColors) {
    const imageUrl  = resolveImage(product.image_url);
    const orderQty  = product.target_quantity || 0;
    const hasQty    = orderQty > 0;
    const needLabel = (product.order_needed > 0)
        ? `<div style="font-size:0.7rem;color:var(--warning-600);font-weight:700;margin-top:0.35rem;">
               📦 Calculated need: ${parseFloat(product.order_needed).toFixed(1)}
           </div>`
        : '';

    const submittedStyle = hasQty
        ? `border: 3px solid var(--success-600); box-shadow: 0 0 0 2px rgba(16,185,129,0.2);`
        : `border: 2px solid ${categoryColors.border};`;

    const submittedBadge = hasQty
        ? `<div style="position:absolute;top:8px;right:8px;background:var(--success-600);color:white;
                       border-radius:50%;width:28px;height:28px;display:flex;align-items:center;
                       justify-content:center;font-size:1rem;box-shadow:var(--shadow-md);">✓</div>`
        : '';

    return `
    <div class="julio-corporate-card" style="
        background:white;border-radius:12px;overflow:hidden;
        box-shadow:0 2px 8px rgba(0,0,0,0.08);
        ${submittedStyle}
        transition:all 0.3s;display:flex;flex-direction:column;position:relative;">

        ${submittedBadge}

        <!-- PRODUCT INFO -->
        <div style="
            background:${hasQty ? 'linear-gradient(135deg,rgba(16,185,129,0.08),white)' : 'linear-gradient(135deg,var(--neutral-50),white)'};
            padding:1.5rem;
            border-bottom:2px solid ${hasQty ? 'var(--success-300)' : categoryColors.border};
            text-align:center;">
            <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
                 style="width:120px;height:120px;object-fit:contain;border-radius:8px;
                        margin:0 auto 1rem auto;display:block;background:white;
                        padding:0.5rem;border:1px solid var(--neutral-300);">
            <h3 style="font-size:1.125rem;font-weight:700;color:var(--neutral-900);margin:0;
                       line-height:1.3;min-height:2.6rem;display:flex;align-items:center;justify-content:center;">
                ${product.product_name}
            </h3>
        </div>

        <!-- ORDER QUANTITY -->
        <div style="
            padding:1.5rem;
            background:${hasQty ? 'rgba(16,185,129,0.08)' : categoryColors.bg};
            flex-grow:1;display:flex;flex-direction:column;justify-content:center;
            border-bottom:3px solid ${hasQty ? 'var(--success-600)' : categoryColors.border};">

            <label style="
                display:block;font-size:0.8125rem;font-weight:700;
                color:${hasQty ? 'var(--success-700)' : categoryColors.text};
                text-transform:uppercase;letter-spacing:0.05em;
                margin-bottom:0.75rem;text-align:center;">
                ${hasQty ? '✅ Order Quantity (Saved)' : '🛒 Order Quantity'}
            </label>

            <input type="number"
                   id="qty-${product.product_name.replace(/[^a-zA-Z0-9]/g, '_')}"
                   value="${orderQty > 0 ? orderQty : ''}"
                   min="0" step="0.1" placeholder="0.00"
                   inputmode="decimal"
                   data-product-name="${escAttr(product.product_name)}"
                   onchange="setJulioQuantity(this.dataset.productName, this.value)"
                   class="search-input"
                   style="width:100%;font-size:1.5rem;font-weight:700;text-align:center;
                          padding:0.875rem;font-family:var(--font-mono);background:white;
                          border:3px solid ${hasQty ? 'var(--success-600)' : categoryColors.border};
                          box-shadow:0 2px 4px rgba(0,0,0,0.1);">

            ${needLabel}
        </div>

        <!-- FOOTER -->
        <div style="padding:1rem;background:white;border-top:2px solid var(--neutral-200);">
            <button data-product="${escAttr(product.product_name)}"
                    onclick="deleteProductFromJulio(this.dataset.product)"
                    class="btn btn-danger"
                    style="width:100%;padding:0.875rem;font-size:0.9375rem;">
                <i class="fas fa-trash"></i> Remove Product
            </button>
        </div>
    </div>`;
}




function updateJulioQuantity(productName, delta) {
    if (!julioTargetsMap.has(productName)) return;
    
    const product = julioTargetsMap.get(productName);
    const currentQty = product.target_quantity || 0;
    const newQty = Math.max(0, currentQty + delta);
    
    product.target_quantity = newQty === 0 ? null : newQty; // ✅ Set to null if 0
    
    const input = document.getElementById(`julio-qty-${productName.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (input) input.value = newQty === 0 ? '' : newQty; // ✅ Show empty if 0
    
    renderJulioProducts();
}

function setJulioQuantity(productName, value) {
    if (!julioTargetsMap.has(productName)) return;
    
    const qty = value === '' ? null : (parseInt(value) || 0);
    const product = julioTargetsMap.get(productName);
    product.target_quantity = (qty === 0) ? null : qty; // ✅ Set to null if 0
    
    renderJulioProducts();
}

function filterJulioProducts() {
    renderJulioProducts();
}

async function saveJulioOrders() {
    showLoading(true);
    try {
        const submissionDate = new Date().toISOString();
        const orderDate = document.getElementById('julioOrderDate')?.value || todayYMD();
        
        const targets = Array.from(julioTargetsMap.values())
            .filter(p => p.target_quantity != null && p.target_quantity > 0)
            .map(p => ({
                product_name: p.product_name,
                target_quantity: p.target_quantity,
                order_date: orderDate,
                last_updated: submissionDate
            }));
        
        if (targets.length === 0) {
            showAlert('No target quantities set', 'error');
            return;
        }
        
     // UPSERT - insert or update if already exists
const { error: targetError } = await supabaseClient
    .from('target_inventory')
    .upsert(targets, { 
        onConflict: 'product_name,order_date',
        ignoreDuplicates: false 
    });

if (targetError) throw targetError;
        
        // Save to historical submissions table
        const submissions = targets.map(t => ({
            submission_date: submissionDate,
            submitted_by: 'julio',
            product_name: t.product_name,
            quantity: t.target_quantity,
            submission_type: 'target_inventory',
            notes: `Target inventory for ${orderDate}`
        }));
        
        const { error: historyError } = await supabaseClient
            .from('inventory_submissions')
            .insert(submissions);
        
        if (historyError) {
            console.error('Error saving submission history:', historyError);
        }
        
        // ✅ NEW: Send email notification to admin
        const emailItems = targets.map(t => ({
            product_name: t.product_name,
            quantity: t.target_quantity,
            notes: `Target: ${t.target_quantity}`
        }));

        const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-order-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
                submittedBy: 'julio',
                orderDate: orderDate,
                items: emailItems
            })
        });

        const emailResult = await emailResponse.json();
        
        if (emailResult.success) {
            showAlert(`✅ Saved ${targets.length} target inventory levels for ${orderDate}! 📧 Admin notified via email.`, 'success');
        } else {
            showAlert(`✅ Saved ${targets.length} targets, but email notification failed: ${emailResult.error}`, 'warning');
        }
        
    } catch (error) {
        console.error('Save Julio targets error:', error);
        showAlert('Error saving targets: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


async function clearJulioOrders() {
    if (!confirm('Clear all target quantities?')) return;
    
    julioTargetsMap.forEach(product => {
        product.target_quantity = null;
    });
    
    renderJulioProducts();
    showAlert('All targets cleared', 'success');
}

// ========== RONY TAB — EDITABLE STOCK INPUT ==========
let ronyProductsByPosition = new Map();

async function loadRonyOrders() {
    try {
        // Get selected date or use today
        const dateInput = document.getElementById('ronyOrderDate');
        const selectedDate = dateInput ? dateInput.value : todayYMD();
        
        // Set default date if not set
        if (dateInput && !dateInput.value) {
            dateInput.value = todayYMD();
        }
        
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, position, assigned_to')
            .order('position', { ascending: true });
        
        if (prodError) throw prodError;
        
        const uniqueProducts = new Map();
        (products || []).forEach(p => {
            const name = (p.product_name || '').trim();
            const assigned = String(p.assigned_to || '').toLowerCase();
            if (!name || !assigned.includes('rony')) return;
            
            if (!uniqueProducts.has(name)) {
                uniqueProducts.set(name, {
                    product_name: name,
                    image_url: p.image_url,
                    position: p.position,
                    current_stock: null
                });
            }
        });
        
        // ✅ Load stock levels for the selected date
        const { data: stock, error: stockError } = await supabaseClient
            .from('current_stock')
            .select('*')
            .eq('stock_date', selectedDate);
        
        if (!stockError && stock) {
            stock.forEach(s => {
                const name = (s.product_name || '').trim();
                if (uniqueProducts.has(name)) {
                    uniqueProducts.get(name).current_stock = s.quantity_in_stock;
                }
            });
        }
        
        // Group by position
        ronyProductsByPosition.clear();
        uniqueProducts.forEach(product => {
            const pos = product.position || 'Uncategorized';
            if (!ronyProductsByPosition.has(pos)) {
                ronyProductsByPosition.set(pos, []);
            }
            ronyProductsByPosition.get(pos).push(product);
        });
        
        renderRonyProducts();
        
    } catch (error) {
        console.error('Load Rony stock error:', error);
        showAlert('Error loading Rony stock', 'error');
    }
}



function renderRonyProducts() {
    const container = document.getElementById('ronyProductContainer');
    const searchTerm = document.getElementById('ronySearchInput')?.value.toLowerCase() || '';

    const positions = Array.from(ronyProductsByPosition.keys()).sort((a, b) => {
        const numA = parseInt(a);
        const numB = parseInt(b);
        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
        return String(a).localeCompare(String(b));
    });

    // ✅ UPDATE GLOBAL PROGRESS BAR
    let totalAll = 0, hasStockAll = 0;
    ronyProductsByPosition.forEach(products => {
        totalAll += products.length;
        hasStockAll += products.filter(p => p.current_stock !== null && p.current_stock !== undefined).length;
    });
    const globalPct = totalAll > 0 ? Math.round((hasStockAll / totalAll) * 100) : 0;
    const globalBar = document.getElementById('ronyGlobalProgress');
    const globalLabel = document.getElementById('ronyGlobalLabel');
    if (globalBar) globalBar.style.width = globalPct + '%';
    if (globalLabel) globalLabel.textContent = `${globalPct}% (${hasStockAll}/${totalAll})`;

    container.innerHTML = positions.map(position => {
        let products = ronyProductsByPosition.get(position);

        if (searchTerm) {
            products = products.filter(p =>
                (p.product_name || '').toLowerCase().includes(searchTerm)
            );
        }

        if (products.length === 0) return '';

        const total = products.length;
        // ✅ 0 is a valid stock count (out of stock) — count it as entered
        const hasStock = products.filter(p => p.current_stock !== null && p.current_stock !== undefined).length;
        const progressPct = total > 0 ? Math.round((hasStock / total) * 100) : 0;

        return `
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-md); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--neutral-900);">
                        📍 Position ${position}
                        <span style="font-size: 0.875rem; font-weight: 500; color: ${hasStock === total ? 'var(--success-600)' : 'var(--neutral-500)'}; margin-left: 0.75rem;">
                            ${hasStock === total ? '✅ All entered' : `${hasStock}/${total} entered`}
                        </span>
                    </h2>
                    <div style="flex: 0 0 200px; min-width: 150px;">
                        <div style="height: 8px; background: var(--neutral-200); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem;">
                            <div style="height: 100%; width: ${progressPct}%; background: ${progressPct === 100 ? 'var(--success-600)' : 'var(--primary-600)'}; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--neutral-600); text-align: right;">
                            ${hasStock}/${total} have stock entered
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    ${products.map(product => renderRonyProductCard(product)).join('')}
                </div>
            </div>
        `;
    }).join('');
}



// ✅ FIXED: renderRonyProductCard function
// ✅ UPDATED: renderRonyProductCard with DELETE button
function renderRonyProductCard(product) {
    const imageUrl = resolveImage(product.image_url);
    // ✅ 0 is a valid stock count (means "out of stock") — only null means "not entered yet"
    const hasStock = product.current_stock !== null && product.current_stock !== undefined;
    const displayQty = hasStock ? product.current_stock : '';

    return `
        <div style="
            background: ${hasStock ? 'rgba(16,185,129,0.05)' : 'var(--neutral-50)'};
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 2px solid ${hasStock ? 'var(--success-600)' : 'var(--neutral-300)'};
            transition: all 0.3s;
            position: relative;
        ">
            <!-- DELETE BUTTON -->
            <button data-product="${escAttr(product.product_name)}"
                    onclick="deleteProductFromRony(this.dataset.product)"
                    class="btn btn-danger btn-icon"
                    style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; padding: 0; font-size: 0.75rem;"
                    title="Delete Product">
                <i class="fas fa-trash"></i>
            </button>

            <!-- ✅ SAVED BADGE -->
            ${hasStock ? `<div style="position:absolute;top:8px;left:8px;background:var(--success-600);color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:0.75rem;">✓</div>` : ''}

            <img src="${imageUrl}"
                 onerror="this.src='${PLACEHOLDER_IMAGE}'"
                 style="width: 100%; max-width: 100px; height: 100px; object-fit: contain; border-radius: 8px; margin-bottom: 0.75rem;">

            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--neutral-900); min-height: 2.5rem; display: flex; align-items: center; justify-content: center; word-wrap: break-word;">
                ${product.product_name}
            </div>

            <div style="margin-bottom: 0.5rem;">
                <label style="display: block; font-size: 0.7rem; font-weight: 600; color: ${hasStock ? 'var(--success-700)' : 'var(--neutral-600)'}; margin-bottom: 0.25rem;">
                    ${hasStock ? '✅ STOCK (SAVED)' : 'CURRENT STOCK'}
                </label>
            </div>

            <!-- ✅ REMOVED +/- BUTTONS - Just the input field -->
            <div style="display: flex; justify-content: center;">
                <input type="number"
                       id="rony-stock-${product.product_name.replace(/[^a-zA-Z0-9]/g, '_')}"
                       value="${displayQty}"
                       min="0"
                       step="0.1"
                       inputmode="decimal"
                       placeholder="0"
                       onchange="setRonyStock('${escAttr(product.product_name)}', this.value)"
                       style="width: 100px; text-align: center; padding: 0.6rem; border: 2px solid ${hasStock ? 'var(--success-600)' : 'var(--primary-400)'}; border-radius: 6px; font-size: 1.25rem; font-weight: 700; font-family: var(--font-mono); background: ${hasStock ? 'rgba(16,185,129,0.05)' : 'white'};">
            </div>
        </div>
    `;
}

function updateRonyStock(productName, delta) {
    let allProducts = [];
    ronyProductsByPosition.forEach(products => {
        allProducts = allProducts.concat(products);
    });
    
    const product = allProducts.find(p => p.product_name === productName);
    if (!product) return;
    
    const currentStock = product.current_stock || 0;
    const newStock = Math.max(0, currentStock + delta);
    
    product.current_stock = parseFloat(newStock.toFixed(2));  // ✅ 0 is valid out-of-stock
    
    const input = document.getElementById(`rony-stock-${productName.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (input) input.value = newStock === 0 ? '' : newStock.toFixed(2);
    
    renderRonyProducts();
}

function setRonyStock(productName, value) {
    let allProducts = [];
    ronyProductsByPosition.forEach(products => {
        allProducts = allProducts.concat(products);
    });

    const product = allProducts.find(p => p.product_name === productName);
    if (!product) return;

    // ✅ Allow 0: empty string = not entered (null), any number including 0 = entered
    if (value === '' || value === null || value === undefined) {
        product.current_stock = null;       // blank = not yet entered
    } else {
        const qty = parseFloat(value);
        product.current_stock = isNaN(qty) ? null : qty;  // 0 is valid!
    }

    renderRonyProducts();
}

function filterRonyProducts() {
    renderRonyProducts();
}


// ✅ SAVE RONY STOCK (NOW EDITABLE)
async function saveRonyOrders() {
    showLoading(true);
    try {
        const submissionDate = new Date().toISOString();
        const stockDate = document.getElementById('ronyOrderDate')?.value || todayYMD();
        
        let allProducts = [];
        ronyProductsByPosition.forEach(products => {
            allProducts = allProducts.concat(products);
        });
        
        const stockUpdates = allProducts
            .filter(p => p.current_stock !== null && p.current_stock !== undefined)  // ✅ 0 is valid
            .map(p => ({
                product_name: p.product_name,
                quantity_in_stock: p.current_stock,
                stock_date: stockDate,
                last_updated: submissionDate
            }));
        
        if (stockUpdates.length === 0) {
            showAlert('❌ No stock quantities entered', 'error');
            return;
        }
        
      // UPSERT - insert or update if already exists
const { error: stockError } = await supabaseClient
    .from('current_stock')
    .upsert(stockUpdates, { 
        onConflict: 'product_name,stock_date',
        ignoreDuplicates: false 
    });

if (stockError) throw stockError;
        
        // Save to historical submissions table
        const submissions = stockUpdates.map(s => ({
            submission_date: submissionDate,
            submitted_by: 'rony',
            product_name: s.product_name,
            quantity: s.quantity_in_stock,
            submission_type: 'current_stock',
            notes: `Stock count for ${stockDate}`
        }));
        
        const { error: historyError } = await supabaseClient
            .from('inventory_submissions')
            .insert(submissions);
        
        if (historyError) {
            console.error('Error saving submission history:', historyError);
        }
        
        // ✅ NEW: Send email notification to admin
        const emailItems = stockUpdates.map(s => ({
            product_name: s.product_name,
            quantity: s.quantity_in_stock,
            notes: `Current stock`
        }));

        const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-order-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
                submittedBy: 'rony',
                orderDate: stockDate,
                items: emailItems
            })
        });

        const emailResult = await emailResponse.json();
        
        if (emailResult.success) {
            showAlert(`✅ Saved ${stockUpdates.length} stock levels for ${stockDate}! 📧 Admin notified via email.`, 'success');
        } else {
            showAlert(`✅ Saved ${stockUpdates.length} stock levels, but email notification failed: ${emailResult.error}`, 'warning');
        }
        
    } catch (error) {
        console.error('Save Rony stock error:', error);
        showAlert('Error saving stock: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

async function clearRonyOrders() {
    if (!confirm('Clear all stock levels?')) return;
    
    ronyProductsByPosition.forEach(products => {
        products.forEach(p => {
            p.current_stock = null;
        });
    });
    
    renderRonyProducts();
    showAlert('All stock levels cleared', 'success');
}


// ========== ENHANCED PLACE ORDER FUNCTIONS ==========

let enhancedOrderData = new Map();

// Load enhanced create order with full vendor comparison
// ========== FIXED LOAD ENHANCED CREATE ORDER FUNCTION ==========


// ADD THIS NEW FUNCTION (copy from COMPLETE_FIXED_PLACE_ORDER.js)
// ========== COMPLETE FIXED PLACE ORDER CODE ==========
// Replace the entire Place Order section with this code

// ========== RENDER EMPTY STATE ==========
function renderEmptyOrderState(dateISO) {
    const container = document.getElementById('enhancedOrderContainer');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 16px; box-shadow: var(--shadow-lg); margin: 2rem auto; max-width: 900px;">
            <div style="display: inline-block; padding: 0.5rem 1.5rem; background: linear-gradient(135deg, var(--success-100), var(--success-50)); border-radius: 999px; border: 2px solid var(--success-400); margin-bottom: 1.5rem;">
                <span style="font-size: 0.875rem; font-weight: 700; color: var(--success-700);">✓ SYSTEM WORKING NORMALLY</span>
            </div>
            
            <div style="font-size: 4rem; margin-bottom: 1rem; opacity: 0.4;">⏳</div>
            <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--neutral-900); margin-bottom: 0.75rem;">
                Waiting for Orders - ${formatDate(dateISO)}
            </h2>
            <p style="font-size: 1rem; color: var(--neutral-700); margin-bottom: 2.5rem; line-height: 1.6;">
                No orders have been submitted yet for this date.<br>
                Orders will <strong>automatically appear here</strong> once users submit their inventory counts.
            </p>
            
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem; max-width: 750px; margin: 0 auto 2rem;">
                <div style="background: linear-gradient(135deg, rgba(44, 86, 136, 0.08), rgba(44, 86, 136, 0.02)); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--primary-200);">
                    <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">🍳</div>
                    <div style="font-weight: 700; font-size: 1rem; color: var(--neutral-900); margin-bottom: 0.5rem;">
                        Rony's Orders
                    </div>
                    <div style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--neutral-100); border-radius: 999px; font-size: 0.75rem; color: var(--neutral-600);">
                        Pending submission
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(234, 88, 12, 0.08), rgba(234, 88, 12, 0.02)); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--accent-200);">
                    <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">🛒</div>
                    <div style="font-weight: 700; font-size: 1rem; color: var(--neutral-900); margin-bottom: 0.5rem;">
                        Julio's Orders
                    </div>
                    <div style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--neutral-100); border-radius: 999px; font-size: 0.75rem; color: var(--neutral-600);">
                        Pending submission
                    </div>
                </div>
                
                <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.08), rgba(16, 185, 129, 0.02)); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--success-200);">
                    <div style="font-size: 2.5rem; margin-bottom: 0.75rem;">🏢</div>
                    <div style="font-weight: 700; font-size: 1rem; color: var(--neutral-900); margin-bottom: 0.5rem;">
                        Office Orders
                    </div>
                    <div style="display: inline-block; padding: 0.25rem 0.75rem; background: var(--neutral-100); border-radius: 999px; font-size: 0.75rem; color: var(--neutral-600);">
                        Pending submission
                    </div>
                </div>
            </div>
            
            <div style="background: linear-gradient(135deg, var(--primary-50), var(--primary-25)); padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; border: 2px solid var(--primary-200); text-align: left;">
                <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                    <div style="font-size: 1.5rem;">💡</div>
                    <div style="font-weight: 700; font-size: 1rem; color: var(--neutral-900);">
                        How the workflow works:
                    </div>
                </div>
                <ol style="color: var(--neutral-700); line-height: 1.8; padding-left: 1.5rem; margin: 0; font-size: 0.9375rem;">
                    <li><strong>Users submit orders</strong> in their respective tabs (Rony's Orders, Julio's Orders, Office Orders)</li>
                    <li><strong>Orders appear here automatically</strong> after submission with full details</li>
                    <li><strong>Review and finalize</strong> the consolidated orders for each vendor</li>
                    <li><strong>Generate purchase orders</strong> and send to vendors</li>
                </ol>
            </div>
        </div>
    `;
}

// ========== LOAD ENHANCED CREATE ORDER (COMPLETE VERSION) ==========
// ========== FIXED: Load Enhanced Create Order WITH IMAGES ==========
// ========== COMPLETE ENHANCED loadEnhancedCreateOrder ==========
async function loadEnhancedCreateOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    const userFilter = document.getElementById('createUserFilter')?.value || 'all';
    
    showLoading(true);
    try {
        // ✅ STEP 1: Check if ANY users have submitted orders for this date
        const { data: ronySubmitted } = await supabaseClient
            .from('current_stock')
            .select('product_name')
            .eq('stock_date', dateISO)
            .limit(1);
        
        const { data: julioSubmitted } = await supabaseClient
            .from('target_inventory')
            .select('product_name')
            .eq('order_date', dateISO)
            .limit(1);
        
        const { data: officeSubmitted } = await supabaseClient
            .from('inventory_check')
            .select('product_name')
            .eq('order_date', dateISO)
            .limit(1);
        
        // Check if inventory_check was populated by sync for this date
        const { data: syncCheck } = await supabaseClient
            .from('inventory_check')
            .select('product_name')
            .eq('order_date', dateISO)
            .limit(1);

        // Show empty state ONLY when there's truly nothing synced yet
        if ((!syncCheck || syncCheck.length === 0) &&
            (!ronySubmitted || ronySubmitted.length === 0) &&
            (!julioSubmitted || julioSubmitted.length === 0) &&
            (!officeSubmitted || officeSubmitted.length === 0)) {
            renderEmptyOrderState(dateISO);
            showLoading(false);
            return;
        }
        
        // ✅ STEP 2: Load supporting data
        await loadSupportingData();
        
        // ✅ STEP 3: Load inventory_management data for images and PAR
        const { data: mgmtData, error: mgmtError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, par, position, category')
            .order('product_name');
        
        if (mgmtError) throw mgmtError;
        
        // ✅ STEP 4: Create lookup map
        const imageMap = new Map();
        (mgmtData || []).forEach(item => {
            imageMap.set(item.product_name, {
                image_url: item.image_url,
                par: item.par,
                position: item.position,
                category: item.category
            });
        });
        
        // ✅ STEP 5: Load RONY's data from inventory_check (syncInventoryCheck already populated it)
        // This gives every assigned product a real DB id so updateTentative/vendor/itemCode work
        const { data: ronyCheck, error: ronyError } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO)
            .eq('user', 'Rony');

        let ronyData = (ronyCheck || []).map(row => {
            const mgmt = imageMap.get(row.product_name);
            return {
                ...row,
                user: 'rony',
                // on_hand = quantity Rony counted in current_stock for this date
                on_hand: parseFloat(row.on_hand ?? 0),
                // tentative = saved order qty (vendor selected, qty entered)
                tentative: row.tentative ?? null,
                image_url: mgmt?.image_url || row.image_url || null,
                par: mgmt?.par || parseFloat(row.target || 0),
                position: mgmt?.position || null,
                category: mgmt?.category || 'Uncategorized'
            };
        });
        
        // ✅ STEP 6: Load JULIO's data from inventory_check (same approach as Rony)
        // This gives Julio rows a real DB id so vendor/qty auto-save & preload on refresh
        const { data: julioCheck, error: julioError } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO)
            .eq('user', 'Julio');

        // Build Julio data: only show products he actually needs to order (qty > 0)
        // Use tentative if set in Place Order, else fall back to on_hand (= submitted target_qty)
        let julioData = (julioCheck || [])
            .map(row => {
                const mgmt = imageMap.get(row.product_name);
                const savedTentative = row.tentative ?? null;
                const submittedQty   = parseFloat(row.on_hand ?? 0);
                const tentativeQty   = (savedTentative !== null && savedTentative !== 0)
                    ? savedTentative
                    : (submittedQty > 0 ? submittedQty : null);
                return {
                    ...row,
                    user: 'julio',
                    on_hand:   submittedQty,
                    tentative: tentativeQty,
                    image_url: mgmt?.image_url || row.image_url || null,
                    par:       mgmt?.par || parseFloat(row.target || 0),
                    position:  mgmt?.position || null,
                    category:  mgmt?.category || 'Uncategorized'
                };
            })
            // ✅ Only show products Julio needs to order (qty > 0)
            .filter(row => (row.tentative !== null && row.tentative > 0));
        
        // ✅ STEP 7: Load OFFICE data from inventory_check
        const { data: officeCheck, error: officeError } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO);
        
        let officeData = (officeCheck || [])
            .filter(row => {
                const isOffice = (row.user || '').toLowerCase().trim() === 'office';
                const hasSubmitted = parseFloat(row.tentative || 0) > 0;
                return isOffice && hasSubmitted;
            })
            .map(row => {
                const mgmt = imageMap.get(row.product_name);
                return {
                    ...row,
                    image_url: mgmt?.image_url || null,
                    par: mgmt?.par || 0,
                    position: mgmt?.position || null,
                    category: mgmt?.category || 'Uncategorized'
                };
            });
        
        // ✅ STEP 8: Apply user filter
        if (userFilter !== 'all') {
            if (userFilter === 'rony') {
                julioData = [];
                officeData = [];
            } else if (userFilter === 'julio') {
                ronyData = [];
                officeData = [];
            } else if (userFilter === 'office') {
                ronyData = [];
                julioData = [];
            }
        }
        
        console.log('✅ Place Order Data Loaded:');
        console.log('📊 Rony products:', ronyData.length);
        console.log('📦 Julio products:', julioData.length,
            '| tentative values:', julioData.slice(0,5).map(p => `${p.product_name}=${p.tentative}`));
        console.log('🏢 Office products:', officeData.length);
        
        // ✅ STEP 9: Render cards
        renderEnhancedOrderCards(ronyData, julioData, officeData);
        
        // ✅ STEP 10: Load vendor prices
        setTimeout(() => {
            [...ronyData, ...julioData, ...officeData].forEach(row => {
                const productId = (row.product_name || '').replace(/[^a-zA-Z0-9]/g, '_');
                loadVendorPricesForProduct(row.product_name, productId);
            });
        }, 500);
        
    } catch (error) {
        console.error('❌ Load Place Order error:', error);
        showAlert('Error loading orders: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}



// ========== PLACE ORDER: SECTION FILTER STATE ==========
// Per-section filter state (persists across re-renders without page jump)
window._placeOrderFilters = window._placeOrderFilters || {
    rony:  { vendor: '', category: '' },
    julio: { vendor: '', category: '' },
};

function applyPlaceOrderFilter(section, type, value) {
    // ✅ STAY IN PLACE: remember scroll position
    const scrollY = window.scrollY;
    window._placeOrderFilters[section][type] = value;
    // Re-render only the cards, NOT reload from DB
    _rerenderPlaceOrderSections();
    requestAnimationFrame(() => window.scrollTo({ top: scrollY, behavior: 'instant' }));
}

function _buildSectionFilters(section, allRows, accentColor) {
    const vendors    = [...new Set(allRows.map(r => r.vendor).filter(Boolean))].sort();
    const categories = [...new Set(allRows.map(r => r.category).filter(Boolean))].sort();
    const f = window._placeOrderFilters[section];
    const selStyle = `padding:0.4rem 0.75rem;border-radius:6px;border:1px solid ${accentColor};font-size:0.8125rem;font-weight:600;background:white;cursor:pointer;min-width:140px;`;
    return `
      <div style="display:flex;flex-wrap:wrap;gap:0.75rem;align-items:center;margin-top:0.75rem;">
        <span style="font-size:0.75rem;font-weight:700;color:rgba(255,255,255,0.8);text-transform:uppercase;letter-spacing:.05em;">Filter:</span>
        <select style="${selStyle}" onchange="applyPlaceOrderFilter('${section}','vendor',this.value)">
          <option value="">All Vendors</option>
          ${vendors.map(v=>`<option value="${v}" ${f.vendor===v?'selected':''}>${v}</option>`).join('')}
        </select>
        <select style="${selStyle}" onchange="applyPlaceOrderFilter('${section}','category',this.value)">
          <option value="">All Categories</option>
          ${categories.map(c=>`<option value="${c}" ${f.category===c?'selected':''}>${c}</option>`).join('')}
        </select>
        ${(f.vendor||f.category)?`<button onclick="applyPlaceOrderFilter('${section}','vendor','');applyPlaceOrderFilter('${section}','category','')" style="padding:0.4rem 0.75rem;border-radius:6px;border:none;background:rgba(255,255,255,0.25);color:white;font-size:0.8125rem;font-weight:600;cursor:pointer;">✕ Clear</button>`:''}
      </div>`;
}

function _filterRows(rows, section) {
    const f = window._placeOrderFilters[section];
    return rows.filter(r => {
        if (f.vendor   && r.vendor   !== f.vendor)   return false;
        if (f.category && (r.category||'Other') !== f.category) return false;
        return true;
    });
}

function _groupByCategory(rows) {
    const map = {};
    rows.forEach(r => {
        const cat = r.category || 'Other';
        if (!map[cat]) map[cat] = [];
        map[cat].push(r);
    });
    // Sort products alphabetically within each category
    Object.keys(map).forEach(cat => {
        map[cat].sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));
    });
    // Sort categories alphabetically, but always put 'Other' last
    const sorted = Object.keys(map).sort((a, b) => {
        if (a === 'Other') return 1;
        if (b === 'Other') return -1;
        return a.localeCompare(b);
    });
    return sorted.map(cat => ({ cat, rows: map[cat] }));
}

function _renderCategoryGroups(groups, userType, accentColor) {
    if (groups.length === 0) return `
      <div style="text-align:center;padding:3rem;background:white;border-radius:12px;border:2px dashed var(--neutral-300);">
        <div style="font-size:2rem;opacity:0.4;">🔍</div>
        <p style="color:var(--neutral-500);margin-top:0.5rem;">No products match the selected filters</p>
      </div>`;

        // Per-category accent colors for Place Order section headers
    const catAccents = {
        'Supermarket':       '#ca8a04',
        'Produce':           '#16a34a',
        'Meat & Seafood':    '#dc2626',
        'Dairy':             '#3b82f6',
        'Dry Goods':         '#f59e0b',
        'Frozen':            '#0ea5e9',
        'Beverages':         '#ec4899',
        'Cleaning Supplies': '#a855f7',
        'Office Supplies':   '#8b5cf6',
        'Kitchen Equipment': '#ea580c',
        'Other':             '#64748b'
    };

    return groups.map(({ cat, rows }) => {
        const catColor = catAccents[cat] || accentColor;
        const icon = getCategoryIcon(cat);
        return `
      <div style="margin-bottom:1.5rem;">
        <div style="display:flex;align-items:center;gap:0.75rem;margin-bottom:1rem;padding:0.6rem 1rem;background:${catColor}18;border-left:4px solid ${catColor};border-radius:0 8px 8px 0;">
          <span style="font-size:1rem;">${icon}</span>
          <span style="font-size:0.875rem;font-weight:800;text-transform:uppercase;letter-spacing:.06em;color:var(--neutral-800);">${cat}</span>
          <span style="font-size:0.75rem;font-weight:600;color:var(--neutral-500);margin-left:auto;">${rows.length} item${rows.length!==1?'s':''}</span>
        </div>
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:1.5rem;">
          ${rows.map(row => renderEnhancedCard(row, userType)).join('')}
        </div>
      </div>
    `;
    }).join('');
}

// Cached data for re-renders without DB hit
window._placeOrderCache = window._placeOrderCache || { rony: [], julio: [], office: [] };

function _rerenderPlaceOrderSections() {
    const container = document.getElementById('enhancedOrderContainer');
    if (!container) return;
    const userFilter = document.getElementById('createUserFilter')?.value || 'all';
    container.innerHTML = _buildPlaceOrderHTML(
        window._placeOrderCache.rony,
        window._placeOrderCache.julio,
        window._placeOrderCache.office,
        userFilter
    );
}

function _buildPlaceOrderHTML(ronyData, julioData, officeData, userFilter) {
    let html = '';

    // ─── RONY SECTION ────────────────────────────────────────────
    if (userFilter === 'all' || userFilter === 'rony') {
        const filtered = _filterRows(ronyData, 'rony');
        const groups   = _groupByCategory(filtered);
        const accent   = '#6B4444';
        html += `
        <div style="margin-bottom:3rem;padding:2rem;background:linear-gradient(135deg,rgba(44,86,136,0.08),rgba(44,86,136,0.03));border-radius:20px;border:3px solid var(--primary-400);box-shadow:0 8px 16px rgba(44,86,136,0.15);">
          <div style="background:linear-gradient(135deg,var(--primary-700),var(--primary-600));padding:1.5rem 2rem;border-radius:15px;margin-bottom:1.5rem;box-shadow:var(--shadow-lg);">
            <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
              <h2 style="font-size:2rem;font-weight:800;color:white;margin:0;">🍳 RONY'S PRODUCTS</h2>
              <span style="background:white;color:var(--primary-700);padding:0.4rem 1.2rem;border-radius:50px;font-size:1.4rem;font-family:var(--font-mono);font-weight:700;">${filtered.length}${filtered.length!==ronyData.length?` / ${ronyData.length}`:''}</span>
            </div>
            ${_buildSectionFilters('rony', ronyData, 'rgba(255,255,255,0.6)')}
          </div>
          ${ronyData.length > 0 ? _renderCategoryGroups(groups, 'rony', accent) : `
            <div style="text-align:center;padding:3rem;background:white;border-radius:12px;border:2px dashed var(--neutral-300);">
              <div style="font-size:3rem;opacity:0.3;">🍳</div>
              <h3 style="color:var(--neutral-600);">No submitted orders from Rony for this date</h3>
            </div>`}
        </div>`;
    }

    // ─── SEPARATOR ────────────────────────────────────────────────
    if (userFilter === 'all') {
        html += `<div style="height:3px;background:linear-gradient(90deg,var(--primary-400),var(--accent-400));border-radius:2px;margin:2rem 0;"></div>`;
    }

    // ─── JULIO SECTION ────────────────────────────────────────────
    if (userFilter === 'all' || userFilter === 'julio') {
        const filtered = _filterRows(julioData, 'julio');
        const groups   = _groupByCategory(filtered);
        const accent   = '#d97706';
        html += `
        <div style="margin-bottom:3rem;padding:2rem;background:linear-gradient(135deg,rgba(217,119,6,0.08),rgba(217,119,6,0.03));border-radius:20px;border:3px solid var(--accent-400);box-shadow:0 8px 16px rgba(217,119,6,0.15);">
          <div style="background:linear-gradient(135deg,var(--accent-600),var(--accent-500));padding:1.5rem 2rem;border-radius:15px;margin-bottom:1.5rem;box-shadow:var(--shadow-lg);">
            <div style="display:flex;align-items:center;gap:15px;flex-wrap:wrap;">
              <h2 style="font-size:2rem;font-weight:800;color:white;margin:0;">📦 JULIO'S PRODUCTS</h2>
              <span style="background:white;color:var(--accent-700);padding:0.4rem 1.2rem;border-radius:50px;font-size:1.4rem;font-family:var(--font-mono);font-weight:700;">${filtered.length}${filtered.length!==julioData.length?` / ${julioData.length}`:''}</span>
            </div>
            ${_buildSectionFilters('julio', julioData, 'rgba(255,255,255,0.6)')}
          </div>
          ${julioData.length > 0 ? _renderCategoryGroups(groups, 'julio', accent) : `
            <div style="text-align:center;padding:3rem;background:white;border-radius:12px;border:2px dashed var(--neutral-300);">
              <div style="font-size:3rem;opacity:0.3;">📦</div>
              <h3 style="color:var(--neutral-600);">No submitted orders from Julio for this date</h3>
            </div>`}
        </div>`;
    }

    // ─── SEPARATOR ────────────────────────────────────────────────
    if (userFilter === 'all' && officeData.length > 0) {
        html += `<div style="height:3px;background:linear-gradient(90deg,var(--accent-400),var(--success-400));border-radius:2px;margin:2rem 0;"></div>`;
    }

    // ─── OFFICE SECTION ────────────────────────────────────────────
    if (userFilter === 'all' || userFilter === 'office') {
        html += `
        <div style="margin-bottom:3rem;padding:2rem;background:linear-gradient(135deg,rgba(5,150,105,0.08),rgba(5,150,105,0.03));border-radius:20px;border:3px solid var(--success-400);box-shadow:0 8px 16px rgba(5,150,105,0.15);">
          <div style="background:linear-gradient(135deg,var(--success-600),var(--success-500));padding:1.5rem 2rem;border-radius:15px;margin-bottom:1.5rem;box-shadow:var(--shadow-lg);">
            <h2 style="font-size:2rem;font-weight:800;color:white;margin:0;">🏢 OFFICE PRODUCTS
              <span style="background:white;color:var(--success-700);padding:0.4rem 1.2rem;border-radius:50px;font-size:1.4rem;font-family:var(--font-mono);font-weight:700;margin-left:15px;">${officeData.length}</span>
            </h2>
          </div>
          ${officeData.length > 0 ? `
            <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:1.5rem;">
              ${officeData.map(row => renderEnhancedCard(row, 'office')).join('')}
            </div>` : `
            <div style="text-align:center;padding:3rem;background:white;border-radius:12px;border:2px dashed var(--neutral-300);">
              <div style="font-size:3rem;opacity:0.3;">🏢</div>
              <h3 style="color:var(--neutral-600);">No submitted orders from Office for this date</h3>
            </div>`}
        </div>`;
    }

    return html;
}

function renderEnhancedOrderCards(ronyData, julioData, officeData = []) {
    const userFilter = document.getElementById('createUserFilter')?.value || 'all';
    ronyData = ronyData.filter(r => (r.user||'').toLowerCase().trim() === 'rony');

    // ✅ Cache so filters can re-render without a DB round-trip
    window._placeOrderCache = { rony: ronyData, julio: julioData, office: officeData };
    // ✅ Reset per-section filters when new data loads
    window._placeOrderFilters = { rony: { vendor:'', category:'' }, julio: { vendor:'', category:'' } };

    const container = document.getElementById('enhancedOrderContainer');
    container.innerHTML = _buildPlaceOrderHTML(ronyData, julioData, officeData, userFilter);
}

// ========== NEW MANAGEMENT FUNCTIONS ==========
// ========== CORPORATE REDESIGNED PLACE ORDER CARD ==========
function renderEnhancedCard(row, userType) {
    const imageUrl = resolveImage(row.image_url);
    const productName = row.product_name || 'Unknown Product';
    const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');

    const escapedProductName = escAttr(productName);
    const escapedItemId = String(row.id).replace(/'/g, "\\'").replace(/"/g, '\\"');

    // Raw values
    const onHandRaw = parseFloat(row.on_hand || 0);
    const parRaw    = parseFloat(row.par || 0);
    const targetRaw = (userType === 'rony') ? parRaw : parseFloat(row.target || 0);
    const neededRaw = Math.max(0, targetRaw - onHandRaw);

    const tentative = parseFloat(row.tentative || 0);
    const isRony    = userType === 'rony';
    const isJulio   = userType === 'julio';
    const isOffice  = userType === 'office';
    
    // Show REAL NUMBERS (no more 50% discount!)
    const displayStock = isJulio ? tentative : onHandRaw;
    const displayPar = parRaw;
    const displayNeeded = neededRaw;
    
    // ✅ ALL users: pre-fill with saved tentative qty (persists across refreshes)
    // Rony: pre-fill if tentative was saved (vendor/qty entered previously)
    const defaultQty = (tentative !== null && tentative !== undefined && tentative !== 0)
        ? tentative
        : (isRony ? '' : '');

    const conversion = window.conversionMap?.get(productName) || { units_per_case: 1, unit_type: 'unit' };
    const hasCase = conversion.units_per_case > 1;
    const caseSizeText = hasCase
        ? `${conversion.units_per_case} ${conversion.unit_type} per case`
        : 'N/A';

    // Current assignment
    const currentUser      = (row.user || '').toLowerCase();
    const isAssignedToRony   = currentUser === 'rony';
    const isAssignedToJulio  = currentUser === 'julio';
    const isAssignedToOffice = currentUser === 'office';

    // Price data - Show REAL PRICES (no discount!)
    const productPrices = inventoryData.filter(i => i.product_name === productName);
    const prices = productPrices.map(i => parseFloat(i.unit_price || 0));
    let bestPrice    = { price: 0, vendor: 'N/A', date: 'N/A' };
    let highestPrice = { price: 0, vendor: 'N/A', date: 'N/A' };

    if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const minItem  = productPrices.find(i => parseFloat(i.unit_price) === minPrice);
        const maxItem  = productPrices.find(i => parseFloat(i.unit_price) === maxPrice);
        bestPrice    = { price: minPrice, vendor: minItem?.vendor || 'N/A', date: minItem?.purchase_date || 'N/A' };
        highestPrice = { price: maxPrice, vendor: maxItem?.vendor || 'N/A', date: maxItem?.purchase_date || 'N/A' };
    }

    return `
<div class="enhanced-order-card" data-product="${escapedProductName}" data-user="${userType}" data-id="${escapedItemId}"
     style="background:white;border:1px solid var(--neutral-300);border-radius:8px;overflow:hidden;box-shadow:var(--shadow-sm);">

  <!-- HEADER: Assignment & Actions -->
  <div style="background:linear-gradient(135deg,var(--neutral-100),var(--neutral-50));padding:0.75rem 1rem;border-bottom:2px solid var(--neutral-200);display:flex;justify-content:space-between;align-items:center;">
    <div style="display:flex;gap:0.5rem;align-items:center;">
      <span style="font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;">Assign:</span>
      <button onclick="toggleAssignment('${escapedItemId}','Rony')" class="btn ${isAssignedToRony?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;">Rony</button>
      <button onclick="toggleAssignment('${escapedItemId}','Julio')" class="btn ${isAssignedToJulio?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;">Julio</button>
      <button onclick="toggleAssignment('${escapedItemId}','Office')" class="btn ${isAssignedToOffice?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;${isAssignedToOffice?'background:var(--success-600);':''}">Office</button>
    </div>
    <button onclick="deleteProductFromPlaceOrder('${escapedItemId}')" class="btn btn-danger btn-icon" style="width:32px;height:32px;padding:0;font-size:0.875rem;"><i class="fas fa-trash"></i></button>
  </div>

  <!-- PRODUCT INFO -->
  <div style="padding:1rem;border-bottom:1px solid var(--neutral-200);">
    <div style="display:grid;grid-template-columns:100px 1fr;gap:1rem;align-items:start;">
      <div style="text-align:center;">
        <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
             style="width:100px;height:100px;object-fit:contain;border-radius:8px;border:1px solid var(--neutral-200);background:white;padding:0.5rem;">
      </div>
      <div>
        ${(isRony || isJulio) ? `
        <!-- ✅ EDITABLE PRODUCT NAME (Rony & Julio) -->
        <input type="text"
          data-original="${escapedProductName}"
          value="${escapedProductName}"
          onkeydown="if(event.key==='Enter')this.blur()"
          onblur="autoSaveProductName(this)"
          onfocus="this.style.borderColor='var(--primary-400)';this.style.background='var(--primary-50)'"
          style="width:100%;font-size:1rem;font-weight:700;color:var(--neutral-900);
                 border:2px dashed transparent;border-radius:6px;padding:0.2rem 0.4rem;
                 margin:0 0 0.5rem 0;background:transparent;outline:none;
                 line-height:1.3;transition:all .2s;cursor:text;"
          title="Click to edit — saves automatically">
        ` : `<h3 style="font-size:1rem;font-weight:700;color:var(--neutral-900);margin:0 0 0.5rem 0;line-height:1.3;">${escapedProductName}</h3>`}
        <div style="display:grid;grid-template-columns:auto 1fr;gap:0.5rem 1rem;font-size:0.8125rem;">
          <span style="color:var(--neutral-600);font-weight:600;">Item Code:</span>
          <span style="font-family:var(--font-mono);font-weight:600;color:${row.item_code ? 'var(--success-700)' : 'var(--warning-600)'};" id="itemcode-display-${productId}">
            ${row.item_code || 'Not Set - Select Vendor'}
          </span>
          <span style="color:var(--neutral-600);font-weight:600;">Case Size:</span>
          <span style="font-weight:600;color:${hasCase ? 'var(--primary-700)' : 'var(--neutral-500)'};">
            ${caseSizeText}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTORY METRICS -->
  <div style="padding:1rem;background:var(--neutral-50);border-bottom:1px solid var(--neutral-200);">
    ${isRony ? `
    <!-- RONY: 3 boxes - Current Stock, PAR Level, Fully Stocked/Order Needed -->
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">
      <!-- Current Stock -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--neutral-300);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Current Stock</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--primary-700);">${displayStock.toFixed(1)}</div>
      </div>
      
      <!-- PAR Level -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--accent-400);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">PAR Level</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--accent-700);">${displayPar.toFixed(1)}</div>
      </div>
      
      <!-- Status: Fully Stocked or Order Needed -->
      <div style="background:${displayStock >= displayPar ? 'var(--success-50)' : 'var(--warning-50)'};padding:0.75rem;border-radius:8px;border:1px solid ${displayStock >= displayPar ? 'var(--success-400)' : 'var(--warning-400)'};text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">
          ${displayStock >= displayPar ? 'Status' : 'Order Needed'}
        </div>
        ${displayStock >= displayPar ? `
          <!-- Fully Stocked - Green with checkmark -->
          <div style="font-size:1.75rem;font-weight:700;color:var(--success-600);">
            <i class="fas fa-check-circle"></i>
          </div>
          <div style="font-size:0.6rem;color:var(--success-700);margin-top:0.25rem;font-weight:600;">Fully Stocked</div>
        ` : `
          <!-- Order Needed - Orange with quantity -->
          <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--warning-700);">${displayNeeded.toFixed(1)}</div>
          <div style="font-size:0.6rem;color:var(--warning-700);margin-top:0.25rem;font-weight:600;">Recommendation</div>
        `}
      </div>
    </div>
    ` : isJulio ? `
    <!-- JULIO: Only 1 box - Order Qty (centered) -->
    <div style="display:grid;grid-template-columns:1fr;max-width:300px;margin:0 auto;">
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--neutral-300);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Order Qty</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--primary-700);">${displayStock.toFixed(1)}</div>
      </div>
    </div>
    ` : `
    <!-- OFFICE: 2 boxes - Current Stock and PAR Level -->
    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:1rem;">
      <!-- Current Stock -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--neutral-300);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Current Stock</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--primary-700);">${displayStock.toFixed(1)}</div>
      </div>
      
      <!-- PAR Level -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--accent-400);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">PAR Level</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--accent-700);">${displayPar.toFixed(1)}</div>
      </div>
    </div>
    `}
  </div>

  <!-- VENDOR PRICES TABLE (loads async, shows all vendors + dates) -->
  <div id="vendor-prices-${productId}" style="padding:1rem;border-bottom:1px solid var(--neutral-200);">
    <div style="font-size:0.8125rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">
      🔥 Vendor Prices
    </div>
    <div style="font-size:0.75rem;color:var(--neutral-500);text-align:center;padding:1rem;background:var(--neutral-50);border-radius:6px;">
      Loading vendor prices...
    </div>
  </div>

  <!-- ORDER FORM -->
  <div style="padding:1rem;background:var(--neutral-50);">
    <div style="display:grid;gap:1rem;">
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Select Vendor</label>
        <select id="vendor-${productId}"
                onchange="selectVendorAndUpdateItemCode('${escapedItemId}','${escapedProductName}',this.value)"
                class="search-input" style="width:100%;font-size:0.9375rem;">
          <option value="">-- Choose Vendor --</option>
          <option value="Pacific Plus"           ${row.vendor==='Pacific Plus'           ?'selected':''}>Pacific Plus</option>
          <option value="Formosa Foods"           ${row.vendor==='Formosa Foods'           ?'selected':''}>Formosa Foods</option>
          <option value="North Food Group"        ${row.vendor==='North Food Group'        ?'selected':''}>North Food Group</option>
          <option value="BakeMark"                ${row.vendor==='BakeMark'                ?'selected':''}>BakeMark</option>
          <option value="Autochlor"               ${row.vendor==='Autochlor'               ?'selected':''}>Autochlor</option>
          <option value="Delta Office Products"   ${row.vendor==='Delta Office Products'   ?'selected':''}>Delta Office Products</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Item Code</label>
          <input type="text" id="itemcode-input-${productId}" value="${row.item_code || ''}"
                 onblur="updateItemCode('${escapedItemId}',this.value)"
                 placeholder="Auto-fills" class="search-input"
                 style="font-family:var(--font-mono);font-weight:600;">
        </div>
        <div>
          <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">
            Order Quantity
            ${!isRony && displayNeeded > 0 ? `<span style="color:var(--warning-600);font-weight:700;text-transform:none;">(Need: ${displayNeeded.toFixed(1)})</span>` : ''}
          </label>
          <input type="number" id="qty-${productId}" value="${defaultQty}"
                 step="0.01" min="0"
                 onblur="updateTentative('${escapedItemId}',this.value)"
                 placeholder="0.00" class="search-input"
                 style="font-size:1.125rem;font-weight:700;text-align:center;font-family:var(--font-mono);">
        </div>
      </div>
    </div>
    <div id="save-status-${productId}" style="text-align:center;font-size:0.8125rem;color:var(--neutral-500);margin-top:0.75rem;min-height:1.25rem;"></div>
  </div>

</div>`;
}
// ========== LOAD CONVERSION MAP & LAST ORDER DATA ==========
async function loadSupportingData() {
    try {
        // Load product conversions from product_conversions table
        const { data: conversions, error: convError } = await supabaseClient
            .from('product_conversions')
            .select('*');
        
        if (!convError && conversions) {
            window.conversionMap = new Map();
            conversions.forEach(c => {
                window.conversionMap.set(c.product_name, {
                    units_per_case: c.units_per_case || 1,
                    unit_type: c.unit_type || 'unit'
                });
            });
            console.log('✅ Loaded', conversions.length, 'product conversions');
        }
        
        // Load last order information from inventory_submissions
        const { data: lastOrders, error: orderError } = await supabaseClient
            .from('inventory_submissions')
            .select('*')
            .order('submission_date', { ascending: false });
        
        if (!orderError && lastOrders) {
            window.lastOrderMap = new Map();
            lastOrders.forEach(order => {
                if (!window.lastOrderMap.has(order.product_name)) {
                    window.lastOrderMap.set(order.product_name, {
                        vendor: order.submitted_by === 'julio' ? 'Julio (Target)' : 'Rony (Stock)',
                        quantity: order.quantity,
                        date: order.submission_date
                    });
                }
            });
            console.log('✅ Loaded last orders for', window.lastOrderMap.size, 'products');
        }
    } catch (error) {
        console.error('⚠️ Error loading supporting data:', error);
    }
}


// ========== SELECT VENDOR AND AUTO-FILL ITEM CODE ==========
async function selectVendorAndUpdateItemCode(rowId, productName, vendor) {
    if (!vendor) return;
    
    const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');
    const itemCodeInput = document.getElementById(`itemcode-input-${productId}`);
    const itemCodeDisplay = document.getElementById(`itemcode-display-${productId}`);
    const statusEl = document.getElementById(`save-status-${productId}`);
    
    try {
        // ✅ Look up item code from invoice_items table (2026 data)
        const { data: invoiceItems, error: itemsError } = await supabaseClient
            .from('invoice_items')
            .select('item_code, unit_price, price_per_unit, has_weight, invoice_id')
            .eq('product_name', productName);  // Get all items for this product
        
        if (itemsError) throw itemsError;
        
        // Get invoice dates to filter for 2026 and get most recent
        let itemCode = '';
        let latestPrice = 0;
        
        if (invoiceItems && invoiceItems.length > 0) {
            const invoiceIds = [...new Set(invoiceItems.map(i => i.invoice_id))];
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')  // Include vendor
                .in('id', invoiceIds);
            
            // Filter for 2026, matching vendor, and find most recent
            const validItems = invoiceItems
                .map(item => {
                    const invoice = invoices?.find(inv => inv.id === item.invoice_id);
                    return { 
                        ...item, 
                        invoice_date: invoice?.invoice_date,
                        invoice_vendor: invoice?.vendor  // Add vendor from invoice
                    };
                })
                .filter(item => {
                    // Must have date, be in 2026, and match vendor
                    if (!item.invoice_date) return false;
                    if (new Date(item.invoice_date).getFullYear() !== 2026) return false;
                    // Case-insensitive vendor match
                    if (!item.invoice_vendor) return false;
                    return item.invoice_vendor.toLowerCase() === vendor.toLowerCase();
                })
                .sort((a, b) => new Date(b.invoice_date) - new Date(a.invoice_date));
            
            if (validItems.length > 0) {
                const mostRecent = validItems[0];
                itemCode = mostRecent.item_code || '';
                latestPrice = mostRecent.has_weight 
                    ? parseFloat(mostRecent.price_per_unit || 0)
                    : parseFloat(mostRecent.unit_price || 0);
            }
        }
        
        // Update UI
        if (itemCodeInput) itemCodeInput.value = itemCode || '';
        if (itemCodeDisplay) itemCodeDisplay.textContent = itemCode || 'Not Set - Select Vendor';
        
        // Show status
        if (statusEl) {
            statusEl.innerHTML = itemCode 
                ? `<span style="color: var(--success-600);"><i class="fas fa-check-circle"></i> Item code loaded: ${itemCode}</span>`
                : `<span style="color: var(--warning-600);"><i class="fas fa-exclamation-triangle"></i> No item code found for ${vendor}</span>`;
        }
        
        // Read current qty from the input field (if any)
        const currentQtyInput = document.getElementById(`qty-${productName.replace(/[^a-zA-Z0-9]/g, '_')}`);
        const currentQty = currentQtyInput ? (parseFloat(currentQtyInput.value) ?? null) : null;

        // ✅ Auto-save vendor + item_code + tentative qty immediately
        if (rowId && rowId !== 'undefined' && rowId !== 'null') {
            // Has real DB id — update by id
            const updatePayload = { vendor: vendor, item_code: itemCode || null };
            if (currentQty !== null && !isNaN(currentQty)) updatePayload.tentative = currentQty;
            const { error: updateError } = await supabaseClient
                .from('inventory_check')
                .update(updatePayload)
                .eq('id', rowId);
            if (updateError) console.warn('⚠️ Could not update inventory_check:', updateError);
        } else {
            // Rony rows: look up by product_name + date
            const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();
            const updatePayload = { vendor: vendor, item_code: itemCode || null };
            if (currentQty !== null && !isNaN(currentQty)) updatePayload.tentative = currentQty;
            const { error: updateError } = await supabaseClient
                .from('inventory_check')
                .update(updatePayload)
                .eq('order_date', dateISO)
                .eq('product_name', productName)
                .eq('user', 'Rony');
            if (updateError) console.warn('⚠️ Could not update inventory_check (Rony):', updateError);
        }
        
        if (statusEl) {
            statusEl.innerHTML = `<span style="color: var(--success-600);">✅ ${vendor} selected${itemCode ? ` (${itemCode})` : ''}${latestPrice ? ` - $${parseFloat(latestPrice).toFixed(2)}` : ''}</span>`;
            setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
        }
        
    } catch (error) {
        console.error('Select vendor error:', error);
        if (statusEl) {
            statusEl.innerHTML = '<span style="color: var(--warning-600);">❌ Error</span>';
        }
    }
}



// ========== LOAD VENDOR PRICES FOR A SPECIFIC PRODUCT ==========




// ========== ENHANCED: LOAD ALL VENDOR PRICES WITH ALL ITEM CODES ==========
// ========== FIXED: Load prices from BOTH invoice_items AND purchase_history ==========
async function loadVendorPricesForProduct(productName, productId) {
    try {
        console.log('🔍 Loading prices for:', productName);
        console.log('🆔 Product ID:', productId);
        
        // 1. Get all invoice_items for this product (case-insensitive)
        const { data: invoiceItems, error: itemsError } = await supabaseClient
            .from('invoice_items')
            .select('item_code, unit_price, price_per_unit, has_weight, invoice_id')
            .ilike('product_name', productName);  // ✅ Case-insensitive match

        if (itemsError) {
            console.error('❌ Error loading invoice_items:', itemsError);
            throw itemsError;
        }
        
        console.log('📦 Found invoice_items:', invoiceItems?.length || 0);
        if (invoiceItems && invoiceItems.length > 0) {
            console.log('📊 Sample item:', invoiceItems[0]);
        }

        // 2. Fetch invoice dates for those invoice_ids
        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id))];
        const invoiceDatesMap = new Map();

        console.log('📅 Fetching invoices for IDs:', invoiceIds);

        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            
            console.log('📋 Found invoices:', invoices?.length || 0);
            
            (invoices || []).forEach(inv => {
                invoiceDatesMap.set(inv.id, { date: inv.invoice_date, vendor: inv.vendor });
            });
        }

        // 3. Build flat list — 2026 ONLY
        const allEntries = [];
        (invoiceItems || []).forEach(item => {
            const invInfo = invoiceDatesMap.get(item.invoice_id);
            if (!invInfo || !invInfo.date) {
                console.log('⚠️ Missing invoice info for item:', item);
                return;
            }
            const year = new Date(invInfo.date).getFullYear();
            if (year !== 2026) {
                console.log(`⏭️ Skipping ${year} invoice (not 2026)`);
                return; // ✅ 2026 filter
            }

            const price = item.has_weight
                ? parseFloat(item.price_per_unit || 0)
                : parseFloat(item.unit_price || 0);

            console.log(`➕ Adding entry:`, {
                vendor: invInfo.vendor,
                price,
                date: invInfo.date,
                has_weight: item.has_weight,
                unit_price: item.unit_price,
                price_per_unit: item.price_per_unit
            });

            allEntries.push({
                vendor:    invInfo.vendor,
                item_code: item.item_code || 'N/A',
                price,
                date:      invInfo.date
            });
        });
        
        console.log('📦 Total entries collected:', allEntries.length);
        console.log('📊 All entries:', allEntries);

        // 4. Per vendor: keep only MOST RECENT entry
        const vendorLatestMap = new Map();
        allEntries.forEach(entry => {
            const existing = vendorLatestMap.get(entry.vendor);
            if (!existing || new Date(entry.date) > new Date(existing.date)) {
                vendorLatestMap.set(entry.vendor, {
                    item_code: entry.item_code,
                    price:     entry.price,
                    date:      entry.date
                });
            }
        });
        
        console.log('✅ Final vendor map size:', vendorLatestMap.size);
        console.log('📊 Vendors:', Array.from(vendorLatestMap.keys()));

        const container = document.getElementById(`vendor-prices-${productId}`);

        // 5. No 2026 invoice_items data - FALLBACK to price_history
        if (vendorLatestMap.size === 0) {
            // ✅ FALLBACK: Try price_history table
            const { data: priceHistory, error: historyError } = await supabaseClient
                .from('price_history')
                .select('vendor, item_code, unit_price, purchase_date')
                .eq('product_name', productName)
                .order('purchase_date', { ascending: false });
            
            if (!historyError && priceHistory && priceHistory.length > 0) {
                // Build vendorLatestMap from price_history
                priceHistory.forEach(entry => {
                    const existing = vendorLatestMap.get(entry.vendor);
                    if (!existing || new Date(entry.purchase_date) > new Date(existing.date)) {
                        vendorLatestMap.set(entry.vendor, {
                            item_code: entry.item_code || 'N/A',
                            price: parseFloat(entry.unit_price || 0),
                            date: entry.purchase_date,
                            source: 'price_history'
                        });
                    }
                });
            }
            
            // If still no data after fallback, show no data message
            if (vendorLatestMap.size === 0) {
                if (container) container.innerHTML = `
                    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.35rem;">
                        <span style="font-size:0.7rem;font-weight:700;color:var(--neutral-600);">🔥 VENDOR PRICES</span>
                        <span style="font-size:0.6rem;color:var(--neutral-400);">No data</span>
                    </div>
                    <div style="font-size:0.65rem;color:var(--neutral-500);text-align:center;padding:0.5rem;
                                background:var(--neutral-50);border-radius:5px;border:1px dashed var(--neutral-300);">
                        No price history for this product
                    </div>`;
                return;
            }
        }

        // 6. Compute best / highest - Show REAL PRICES
        const sortedVendors = Array.from(vendorLatestMap.keys()).sort();
        const prices      = sortedVendors.map(v => vendorLatestMap.get(v).price);
        const bestPrice   = Math.min(...prices);
        const highPrice   = Math.max(...prices);
        const bestVendor    = sortedVendors[prices.indexOf(bestPrice)];
        const highVendor    = sortedVendors[prices.indexOf(highPrice)];
        const bestEntry     = vendorLatestMap.get(bestVendor);
        const highEntry     = vendorLatestMap.get(highVendor);

        // Render vendor table
        if (!container) return;

        const priceRange  = (highPrice - bestPrice).toFixed(2);
        const optLabel = sortedVendors.length === 1 ? '1 vendor' : `${sortedVendors.length} vendors`;
        
        // Check if any data came from price_history
        const hasHistoryData = Array.from(vendorLatestMap.values()).some(e => e.source === 'price_history');
        const dataSource = hasHistoryData ? 'Price History' : '2026 Invoices';

        const rowsHTML = sortedVendors.map(vendor => {
            const entry   = vendorLatestMap.get(vendor);
            const price = entry.price.toFixed(2);
            const isBest  = vendor === bestVendor;
            const isHistory = entry.source === 'price_history';
            return `
            <tr style="background:${isBest?'rgba(16,185,129,0.07)':'white'};
                       border-bottom:1px solid var(--neutral-200);">
                <td style="padding:0.3rem 0.45rem;font-weight:700;color:var(--primary-700);font-size:0.7rem;">
                    ${vendor}${isHistory ? ' <span style="font-size:0.55rem;color:var(--warning-600);">📜</span>' : ''}</td>
                <td style="padding:0.3rem 0.45rem;font-family:var(--font-mono);font-size:0.65rem;
                           color:${isBest?'var(--success-700)':'var(--neutral-600)'};
                           text-align:center;font-weight:600;">
                    ${entry.item_code}</td>
                <td style="padding:0.3rem 0.45rem;font-size:0.6rem;color:var(--neutral-500);text-align:center;">
                    ${entry.date ? formatDate(entry.date) : 'N/A'}</td>
                <td style="padding:0.3rem 0.45rem;font-family:var(--font-mono);font-weight:700;
                           font-size:0.75rem;text-align:right;
                           color:${isBest?'var(--success-700)':'var(--neutral-800)'};">
                    $${price}${isBest?' 🏆':''}</td>
            </tr>`;
        }).join('');

        container.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.35rem;">
                <span style="font-size:0.7rem;font-weight:700;color:var(--neutral-600);">🔥 VENDOR PRICES</span>
                <span style="font-size:0.6rem;color:var(--neutral-400);font-weight:600;">
                    ${optLabel} • ${dataSource}
                </span>
            </div>
            <table style="width:100%;border-collapse:collapse;
                          border:1px solid var(--neutral-300);border-radius:5px;overflow:hidden;">
                <thead>
                    <tr style="background:var(--neutral-800);">
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:left;">Vendor</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:center;">Code</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:center;">Date</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:right;">Price</th>
                    </tr>
                </thead>
                <tbody>${rowsHTML}</tbody>
            </table>
            ${sortedVendors.length > 1 ? `
            <div style="margin-top:0.35rem;padding:0.35rem 0.5rem;background:var(--success-50);
                        border-radius:5px;border:1px solid var(--success-200);">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.2rem;font-size:0.6rem;">
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">BEST</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--success-700);font-family:var(--font-mono);">$${bestPrice.toFixed(2)} 🏆</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">HIGH</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--warning-600);font-family:var(--font-mono);">$${highPrice.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">RANGE</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--primary-700);font-family:var(--font-mono);">$${priceRange}</div>
                    </div>
                </div>
            </div>` : ''}`;

    } catch (error) {
        console.error('⚠️ loadVendorPrices error:', error);
        const container = document.getElementById(`vendor-prices-${productId}`);
        if (container) container.innerHTML = `
            <div style="font-size:0.65rem;color:var(--warning-600);text-align:center;padding:0.4rem;
                        background:var(--warning-50);border-radius:5px;border:1px solid var(--warning-300);">
                ⚠️ Error loading prices
            </div>`;
    }
}














// Update PAR value with auto-save
async function updateParValue(productName, newPar) {
    const parValue = parseFloat(newPar) || 0;
    
    showLoading(true);
    try {
        // Update in inventory_management table
        const { error } = await supabaseClient
            .from('inventory_management')
            .update({ par: parValue })
            .eq('product_name', productName);
        
        if (error) throw error;
        
        showAlert(`✅ PAR updated to ${parValue.toFixed(1)} for ${productName}`, 'success');
        
        // Reload the order to reflect changes
        await loadEnhancedCreateOrder();
        
    } catch (error) {
        console.error('Update PAR error:', error);
        showAlert('❌ Error updating PAR: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Update tentative (order quantity) — safe null check + product_name fallback
async function updateTentative(rowId, value) {
    const qty = parseFloat(value) ?? 0;

    // Safe statusEl lookup — data-id may be "undefined" for Rony rows
    const cardEl = document.querySelector(`[data-id="${rowId}"]`);
    const statusEl = cardEl ? cardEl.querySelector('[id^="save-status-"]') : null;

    const showStatus = (html) => { if (statusEl) { statusEl.innerHTML = html; } };

    try {
        if (!rowId || rowId === 'undefined' || rowId === 'null') {
            // Rony rows: no inventory_check id — find by product_name from card
            const productName = cardEl?.dataset?.product;
            if (!productName) { console.warn('updateTentative: no rowId or productName'); return; }
            const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();
            const { error } = await supabaseClient
                .from('inventory_check')
                .update({ tentative: qty })
                .eq('order_date', dateISO)
                .eq('product_name', productName)
                .eq('user', 'Rony');
            if (error) throw error;
        } else {
            const { error } = await supabaseClient
                .from('inventory_check')
                .update({ tentative: qty })
                .eq('id', rowId);
            if (error) throw error;
        }
        showStatus('<span style="color:var(--success-600);">✅ Saved</span>');
        setTimeout(() => { if (statusEl) statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update tentative error:', error);
        showStatus('<span style="color:var(--warning-600);">❌ Error</span>');
    }
}

// Update vendor
async function updateVendorItemCode(rowId, vendor) {
    const cardEl = document.querySelector(`[data-id="${rowId}"]`);
    const statusEl = cardEl ? cardEl.querySelector('[id^="save-status-"]') : null;
    const showStatus = (html) => { if (statusEl) statusEl.innerHTML = html; };
    try {
        if (!rowId || rowId === 'undefined' || rowId === 'null') {
            const productName = cardEl?.dataset?.product;
            if (!productName) return;
            const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();
            const { error } = await supabaseClient.from('inventory_check')
                .update({ vendor: vendor || null })
                .eq('order_date', dateISO).eq('product_name', productName).eq('user', 'Rony');
            if (error) throw error;
        } else {
            const { error } = await supabaseClient.from('inventory_check')
                .update({ vendor: vendor || null }).eq('id', rowId);
            if (error) throw error;
        }
        showStatus('<span style="color:var(--success-600);">✅ Vendor saved</span>');
        setTimeout(() => { if (statusEl) statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update vendor error:', error);
        showStatus('<span style="color:var(--warning-600);">❌ Error</span>');
    }
}

// Update item code
async function updateItemCode(rowId, itemCode) {
    const cardEl = document.querySelector(`[data-id="${rowId}"]`);
    const statusEl = cardEl ? cardEl.querySelector('[id^="save-status-"]') : null;
    const showStatus = (html) => { if (statusEl) statusEl.innerHTML = html; };
    try {
        if (!rowId || rowId === 'undefined' || rowId === 'null') {
            const productName = cardEl?.dataset?.product;
            if (!productName) return;
            const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();
            const { error } = await supabaseClient.from('inventory_check')
                .update({ item_code: itemCode || null })
                .eq('order_date', dateISO).eq('product_name', productName).eq('user', 'Rony');
            if (error) throw error;
        } else {
            const { error } = await supabaseClient.from('inventory_check')
                .update({ item_code: itemCode || null }).eq('id', rowId);
            if (error) throw error;
        }
        showStatus('<span style="color:var(--success-600);">✅ Item code saved</span>');
        setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update item code error:', error);
        statusEl.innerHTML = '<span style="color: var(--warning-600);">❌ Error</span>';
    }
}

// Toggle assignment (rony ↔ julio) — stays in place
async function toggleAssignment(rowId, newUser) {
    const scrollY = window.scrollY;
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .update({ user: newUser })
            .eq('id', rowId);
        
        if (error) throw error;
        
        // Update cache row and re-render in-place
        ['rony','julio','office'].forEach(section => {
            window._placeOrderCache[section] = window._placeOrderCache[section].map(r =>
                String(r.id) === String(rowId) ? { ...r, user: newUser.toLowerCase() } : r
            );
        });
        _rerenderPlaceOrderSections();
        requestAnimationFrame(() => window.scrollTo({ top: scrollY, behavior: 'instant' }));
        showAlert(`✅ Assigned to ${newUser}`, 'success');
    } catch (error) {
        console.error('Toggle assignment error:', error);
        showAlert('❌ Error updating assignment', 'error');
    }
}

// Delete product — stays in place
async function deleteProductFromPlaceOrder(rowId) {
    if (!confirm('⚠️ Delete this product from inventory_check?')) return;
    const scrollY = window.scrollY;
    showLoading(true);
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .delete()
            .eq('id', rowId);
        
        if (error) throw error;

        // Remove from cache and re-render in-place
        ['rony','julio','office'].forEach(section => {
            window._placeOrderCache[section] = window._placeOrderCache[section].filter(r =>
                String(r.id) !== String(rowId)
            );
        });
        _rerenderPlaceOrderSections();
        requestAnimationFrame(() => window.scrollTo({ top: scrollY, behavior: 'instant' }));
        showAlert('✅ Product deleted', 'success');
    } catch (error) {
        console.error('Delete error:', error);
        showAlert('❌ Error deleting product', 'error');
    } finally {
        showLoading(false);
    }
}

// ✅ AUTO-SAVE PRODUCT NAME — updates ALL tables, stays in place
const _pnSaveTimers = {};
async function autoSaveProductName(input) {
    const oldName = (input.dataset.original || "").trim();
    const newName = (input.value || "").trim();
    if (!oldName || !newName || oldName === newName) return;

    input.style.borderColor = "var(--accent-500)";
    input.style.background  = "rgba(245,158,11,0.08)";

    clearTimeout(_pnSaveTimers[oldName]);
    _pnSaveTimers[oldName] = setTimeout(async () => {
        const scrollY = window.scrollY;
        try {
            await Promise.all([
                supabaseClient.from("inventory_management").update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("current_stock")        .update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("target_inventory")     .update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("inventory_check")      .update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("purchase_history")     .update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("invoice_items")        .update({ product_name: newName }).eq("product_name", oldName),
                supabaseClient.from("vendor_prices")        .update({ product_name: newName }).eq("product_name", oldName),
            ]);
            ["rony","julio","office"].forEach(s => {
                window._placeOrderCache[s] = window._placeOrderCache[s].map(r =>
                    r.product_name === oldName ? { ...r, product_name: newName } : r
                );
            });
            input.dataset.original = newName;
            input.style.borderColor = "var(--success-500)";
            input.style.background  = "rgba(16,185,129,0.08)";
            showAlert(`Renamed "${oldName}" to "${newName}"`, "success");
            requestAnimationFrame(() => window.scrollTo({ top: scrollY, behavior: "instant" }));
            setTimeout(() => { input.style.borderColor="transparent"; input.style.background="transparent"; }, 2000);
        } catch(err) {
            input.style.borderColor = "var(--warning-600)";
            input.style.background  = "rgba(220,38,38,0.08)";
            input.value = oldName;
            showAlert("Failed to save name — reverted", "error");
        }
    }, 400);
}

// Select vendor for product
function selectVendorForProduct(productId, vendor, itemCode) {
    document.getElementById(`vendor-${productId}`).value = vendor;
    document.getElementById(`itemcode-${productId}`).textContent = itemCode || '-------';
    
    // Highlight selected row
    const card = document.querySelector(`[data-product]`);
    if (card) {
        card.querySelectorAll('.vendor-option-row').forEach(row => {
            row.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    }
    
    showAlert(`✅ Selected ${vendor} for ordering`, 'success');
}

// Submit enhanced order
async function submitEnhancedOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    const cards = document.querySelectorAll('.enhanced-order-card');
    
    if (cards.length === 0) {
        showAlert('No products to order', 'error');
        return;
    }
    
    showLoading(true);
    try {
        const updates = [];
        
        for (const card of cards) {
            const productName = card.dataset.product;
            const user = card.dataset.user;
            const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const qtyInput = document.getElementById(`qty-${productId}`);
            const vendorInput = document.getElementById(`vendor-${productId}`);
            
            if (!qtyInput || !vendorInput) continue;
            
            const quantity = parseFloat(qtyInput.value || 0);
            const vendor = vendorInput.value || null;
            
            if (quantity > 0 || vendor) {
                updates.push(
                    supabaseClient
                        .from('inventory_check')
                        .update({
                            tentative: quantity,
                            vendor: vendor
                        })
                        .eq('order_date', dateISO)
                        .eq('product_name', productName)
                        .eq('user', user)
                );
            }
        }
        
        if (updates.length === 0) {
            showAlert('No changes to save', 'error');
            return;
        }
        
        await Promise.all(updates);
        
        showAlert(`✅ Order saved successfully! ${updates.length} products updated`, 'success');
        
        // Reload
        await loadEnhancedCreateOrder();
        
    } catch (error) {
        console.error('Submit order error:', error);
        showAlert('Error saving order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ========== UTILITY FUNCTIONS FOR PLACE ORDER ==========

// Get today's date in YYYY-MM-DD format
function todayYMD() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Canonicalize vendor names (handle variations)
function canonicalizeVendor(vendor) {
    if (!vendor) return '';
    const v = vendor.toLowerCase().trim();
    
    // Handle common variations
    if (v.includes('pacific')) return 'Pacific Plus';
    if (v.includes('formosa')) return 'Formosa Foods';
    if (v.includes('north') && v.includes('food')) return 'North Food Group';
    if (v.includes('bakemark')) return 'BakeMark';
    if (v.includes('autochlor')) return 'Autochlor';
    
    // Default: capitalize first letter of each word
    return vendor.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

// Allowed vendors list
const ALLOWED_VENDORS = [
    'Pacific Plus',
    'Formosa Foods',
    'North Food Group',
    'BakeMark',
    'Delta Office Products',
    'Autochlor'
];

// Vendor code map (for item codes)
let vendorCodeMap = new Map();

async function buildVendorCodeMap() {
    try {
        const { data, error } = await supabaseClient
            .from('vendor_prices')
            .select('product_name, vendor, item_code, unit_price')
            .order('last_updated', { ascending: false });
        
        if (error) throw error;
        
        vendorCodeMap.clear();
        (data || []).forEach(row => {
            if (!row.product_name || !row.vendor) return;
            const key = `${row.product_name}_${canonicalizeVendor(row.vendor)}`;
            if (!vendorCodeMap.has(key)) {
                vendorCodeMap.set(key, {
                    item_code: row.item_code || '',
                    unit_price: parseFloat(row.unit_price || 0)
                });
            }
        });
        
        console.log('✅ vendorCodeMap built:', vendorCodeMap.size, 'entries');
    } catch (error) {
        console.error('Build vendor code map error:', error);
    }
}

// Get item code for product and vendor
function getItemCodeFor(productName, vendor) {
    const key = `${productName}_${canonicalizeVendor(vendor)}`;
    return vendorCodeMap.get(key) || '-------';
}

// Load jsPDF library (stub for now - can be enhanced later)
function loadJsPDF() {
    // PDF generation can be added later if needed
    console.log('PDF generation ready (placeholder)');
}

function switchOrderTab(tabName, evt) {
    // Remove active class from all sub-tabs
    document.querySelectorAll('.order-sub-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'transparent';
        tab.style.color = 'var(--neutral-600)';
    });
    
    // Remove active class from all order content sections
    document.querySelectorAll('.order-content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Add active class to clicked tab
    if (evt && evt.target) {
        evt.target.classList.add('active');
        evt.target.style.background = 'linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%)';
        evt.target.style.color = 'white';
    }
    
    // Show corresponding content section
    document.getElementById(tabName).classList.add('active');
}

// Update date change listener
document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'createOrderDate') {
        loadEnhancedCreateOrder();
    }
});




// ========== INVENTORY SETTINGS FUNCTIONS ==========

let settingsData = [];

async function loadInventorySettings() {
    showLoading(true);
    try {
        // Get all unique products from inventory_management (Rony's items priority)
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, user')
            .order('product_name');
        
        if (prodError) throw prodError;
        
        const uniqueProducts = new Set();
        (products || []).forEach(p => {
            const name = (p.product_name || '').trim();
            if (name) uniqueProducts.add(name);
        });
        
        // Load existing conversions
        const { data: conversions, error: convError } = await supabaseClient
            .from('product_conversions')
            .select('*');
        
        if (convError) throw convError;
        
        const conversionMap = new Map();
        (conversions || []).forEach(c => {
            conversionMap.set(c.product_name, c);
        });
        
        // Build settings data
        settingsData = Array.from(uniqueProducts).map(name => {
            const existing = conversionMap.get(name);
            return {
                product_name: name,
                units_per_case: existing ? existing.units_per_case : 1,
                unit_type: existing ? existing.unit_type : 'unit',
                notes: existing ? existing.notes : ''
            };
        });
        
        renderInventorySettings();
        
    } catch (error) {
        console.error('Load inventory settings error:', error);
        showAlert('Error loading settings', 'error');
    } finally {
        showLoading(false);
    }
}

function renderInventorySettings() {
    const tbody = document.getElementById('settingsTableBody');
    const searchTerm = document.getElementById('settingsSearchInput')?.value.toLowerCase() || '';
    
    let filtered = settingsData.filter(item => {
        if (!searchTerm) return true;
        return (item.product_name || '').toLowerCase().includes(searchTerm);
    });
    
    document.getElementById('settingsCount').textContent = `${filtered.length} products`;
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No products found</td></tr>';
        return;
    }
    
    tbody.innerHTML = filtered.map((item, idx) => `
        <tr>
            <td style="font-weight: 600;">${item.product_name}</td>
            <td>
                <input type="number" 
                       value="${item.units_per_case}" 
                       min="0.01" 
                       step="0.01"
                       onchange="updateConversion('${item.product_name}', 'units_per_case', this.value)"
                       class="search-input" 
                       style="width: 100px; text-align: center; font-family: var(--font-mono); font-weight: 700;">
            </td>
            <td>
                <select onchange="updateConversion('${item.product_name}', 'unit_type', this.value)" class="search-input" style="width: 120px;">
                    <option value="case" ${item.unit_type === 'case' ? 'selected' : ''}>Case</option>
                    <option value="unit" ${item.unit_type === 'unit' ? 'selected' : ''}>Unit</option>
                    <option value="box" ${item.unit_type === 'box' ? 'selected' : ''}>Box</option>
                    <option value="bag" ${item.unit_type === 'bag' ? 'selected' : ''}>Bag</option>
                    <option value="bucket" ${item.unit_type === 'bucket' ? 'selected' : ''}>Bucket</option>
                </select>
            </td>
            <td>
                <input type="text" 
                       value="${item.notes || ''}" 
                       onchange="updateConversion('${item.product_name}', 'notes', this.value)"
                       placeholder="e.g., 6 bottles per case"
                       class="search-input" 
                       style="width: 100%;">
            </td>
        </tr>
    `).join('');
}

function updateConversion(productName, field, value) {
    const item = settingsData.find(i => i.product_name === productName);
    if (!item) return;
    
    if (field === 'units_per_case') {
        item[field] = parseFloat(value) || 1;
    } else {
        item[field] = value;
    }
}

function filterInventorySettings() {
    renderInventorySettings();
}

async function saveAllConversions() {
    showLoading(true);
    try {
        const { error } = await supabaseClient
            .from('product_conversions')
            .upsert(settingsData, { onConflict: 'product_name' });
        
        if (error) throw error;
        
        showAlert('✅ Conversion factors saved!', 'success');
        
    } catch (error) {
        console.error('Save conversions error:', error);
        showAlert('Error saving: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}
let submissionHistoryData = [];
let filteredHistory = [];

async function loadSubmissionHistory() {
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_submissions')
            .select('*')
            .order('submission_date', { ascending: false });
        
        if (error) throw error;
        
        submissionHistoryData = data || [];
        filteredHistory = [...submissionHistoryData];
        renderSubmissionHistory();
        
    } catch (error) {
        console.error('Load submission history error:', error);
        showAlert('Error loading history', 'error');
    } finally {
        showLoading(false);
    }
}

function filterSubmissionHistory() {
    const userFilter = document.getElementById('historyUserFilter')?.value || '';
    const dateFrom = document.getElementById('historyDateFrom')?.value || '';
    const dateTo = document.getElementById('historyDateTo')?.value || '';
    const searchTerm = document.getElementById('historySearchInput')?.value.toLowerCase() || '';
    
    filteredHistory = submissionHistoryData.filter(item => {
        const matchesUser = !userFilter || item.submitted_by === userFilter;
        const matchesDateFrom = !dateFrom || new Date(item.submission_date) >= new Date(dateFrom);
        const matchesDateTo = !dateTo || new Date(item.submission_date) <= new Date(dateTo + 'T23:59:59');
        const matchesSearch = !searchTerm || (item.product_name || '').toLowerCase().includes(searchTerm);
        
        return matchesUser && matchesDateFrom && matchesDateTo && matchesSearch;
    });
    
    renderSubmissionHistory();
}

function renderSubmissionHistory() {
    const tbody = document.getElementById('historyTableBody');
    document.getElementById('historyCount').textContent = `${filteredHistory.length} submissions`;
    
    if (filteredHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">📅</div><h3>No Submissions Found</h3></div></td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredHistory.map(item => {
        const userBadge = item.submitted_by === 'julio' 
            ? '<span class="vendor-badge" style="background: var(--accent-200); color: var(--accent-800);">Julio</span>'
            : '<span class="vendor-badge" style="background: var(--primary-200); color: var(--primary-800);">Rony</span>';
        
        const typeBadge = item.submission_type === 'target_inventory'
            ? '<span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">Target</span>'
            : '<span class="vendor-badge" style="background: var(--success-100); color: var(--success-700);">Stock</span>';
        
        return `
            <tr>
                <td>${formatDate(item.submission_date)}</td>
                <td>${userBadge}</td>
                <td style="font-weight: 600;">${item.product_name}</td>
                <td><span class="price-cell" style="font-family: var(--font-mono); font-weight: 700; color: var(--neutral-900);">${parseFloat(item.quantity).toFixed(2)}</span></td>
                <td>${typeBadge}</td>
                <td style="font-size: 0.875rem; color: var(--neutral-600);">${item.notes || '-'}</td>
            </tr>
        `;
    }).join('');
}

// ========== STOCK ALERTS SYSTEM ==========
let currentAlertFilter = 'all';
let stockAlertsData = [];     // flat list of all alert objects
let stockAlertsRaw  = [];     // same, used by filter without re-fetch

function todayYMD_alerts() {
    return new Date().toISOString().slice(0, 10);
}

async function loadStockAlerts() {
    // Always use today as the alert date (no UI date picker needed)
    const alertDate = todayYMD_alerts();

    showLoading(true);
    try {
        // ── 1. Load ALL inventory_management products ──────────────────
        const { data: mgmtData, error: mgmtErr } = await supabaseClient
            .from('inventory_management')
            .select('product_name, par, category, image_url, assigned_to')
            .order('product_name');
        if (mgmtErr) throw mgmtErr;

        // ── 2. Load RONY's stock — most recent per product ─────────────
        //    current_stock ordered DESC so first hit per product = latest
        const { data: ronyRaw } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock, stock_date')
            .lte('stock_date', alertDate)
            .order('stock_date', { ascending: false });

        const ronyStockMap = new Map();
        (ronyRaw || []).forEach(s => {
            if (!ronyStockMap.has(s.product_name)) {
                ronyStockMap.set(s.product_name, {
                    qty: parseFloat(s.quantity_in_stock ?? 0),
                    date: s.stock_date
                });
            }
        });

        // ── 3. Load JULIO's on-hand from inventory_check ───────────────
        const { data: julioRaw } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, order_date, user')
            .lte('order_date', alertDate)
            .order('order_date', { ascending: false });

        const julioStockMap = new Map();
        (julioRaw || []).forEach(s => {
            const u = (s.user || '').toLowerCase();
            if (u !== 'julio') return;
            if (!julioStockMap.has(s.product_name)) {
                julioStockMap.set(s.product_name, {
                    qty: parseFloat(s.on_hand ?? 0),
                    date: s.order_date
                });
            }
        });

        // ── 4. Load product_conversions (cases ↔ units) ────────────────
        const { data: convData } = await supabaseClient
            .from('product_conversions')
            .select('product_name, units_per_case, unit_type');

        const conversionMap = new Map();
        (convData || []).forEach(c => {
            conversionMap.set(c.product_name, {
                units_per_case: parseFloat(c.units_per_case || 1),
                unit_type: c.unit_type || 'unit'
            });
        });

        // ── 5. Load recent submissions for trend analysis ──────────────
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const { data: submissions } = await supabaseClient
            .from('inventory_submissions')
            .select('product_name, quantity, submission_date, submitted_by')
            .gte('submission_date', thirtyDaysAgo.toISOString())
            .order('submission_date', { ascending: false });

        const consumptionMap = new Map();
        (submissions || []).forEach(item => {
            if (!consumptionMap.has(item.product_name)) consumptionMap.set(item.product_name, []);
            consumptionMap.get(item.product_name).push({
                qty: parseFloat(item.quantity || 0),
                date: new Date(item.submission_date)
            });
        });

        // ── 6. Build alerts ────────────────────────────────────────────
        const alerts = [];

        (mgmtData || []).forEach(item => {
            const productName = item.product_name;
            const par = parseFloat(item.par || 0);
            const category = item.category || 'Uncategorized';
            const image_url = item.image_url;

            // Determine sections (rony / julio — can be both)
            const rawAssigned = item.assigned_to;
            let assignedStr = '';
            if (Array.isArray(rawAssigned)) assignedStr = rawAssigned.join(' ').toLowerCase();
            else assignedStr = String(rawAssigned || '').toLowerCase();

            const isRony  = assignedStr.includes('rony');
            const isJulio = assignedStr.includes('julio');
            if (!isRony && !isJulio) return; // unassigned — skip

            // Get current stock per section
            const sections = [];
            if (isRony) {
                const stockInfo = ronyStockMap.get(productName);
                sections.push({ section: 'rony', qty: stockInfo?.qty ?? null, stockDate: stockInfo?.date ?? null });
            }
            if (isJulio) {
                const stockInfo = julioStockMap.get(productName);
                sections.push({ section: 'julio', qty: stockInfo?.qty ?? null, stockDate: stockInfo?.date ?? null });
            }

            // Conversion info
            const conv = conversionMap.get(productName) || { units_per_case: 1, unit_type: 'unit' };

            // Declining trend
            const consumption = consumptionMap.get(productName) || [];
            let isDeclining = false;
            if (consumption.length >= 4) {
                const recent = consumption.slice(0, Math.min(7, consumption.length));
                const older  = consumption.slice(7, Math.min(14, consumption.length));
                if (older.length > 0) {
                    const recentAvg = recent.reduce((s,r)=>s+r.qty,0)/recent.length;
                    const olderAvg  = older.reduce((s,r)=>s+r.qty,0)/older.length;
                    isDeclining = olderAvg > 0 && ((olderAvg - recentAvg)/olderAvg) > 0.4;
                }
            }

            sections.forEach(({ section, qty, stockDate }) => {
                // qty=null means never counted yet, treat as unknown
                const currentStock = qty ?? 0;
                const hasBeenCounted = qty !== null;

                let alertType = null;
                if (!hasBeenCounted) {
                    alertType = 'watch'; // never counted
                } else if (currentStock === 0) {
                    alertType = 'critical';
                } else if (par > 0) {
                    const ratio = currentStock / par;
                    if (ratio < 0.25) alertType = 'warning';
                    else if (ratio < 0.5)  alertType = 'watch';
                }

                // ✅ ALWAYS include ALL assigned products — not just alerting ones
                // Products with healthy stock get alert_type = 'ok'
                const finalAlertType = alertType
                    ? alertType
                    : isDeclining
                        ? 'declining'
                        : 'ok';

                const lastCountDate = consumption.length > 0 ? consumption[0].date : null;
                alerts.push({
                    product_name: productName,
                    section,
                    category,
                    image_url,
                    par,
                    current_stock: currentStock,
                    has_been_counted: hasBeenCounted,
                    stock_date: stockDate,
                    alert_type: finalAlertType,
                    is_declining: isDeclining,
                    last_count_date: lastCountDate,
                    conv
                });
            });
        });

        // ── Deduplicate: one entry per product+section (highest alert priority wins) ──
        const priority = { critical: 5, warning: 4, watch: 3, declining: 2, ok: 1 };
        const dedupeMap = new Map();
        alerts.forEach(a => {
            const key = (a.product_name + '||' + a.section).toLowerCase();
            const existing = dedupeMap.get(key);
            if (!existing || (priority[a.alert_type]||0) > (priority[existing.alert_type]||0)) {
                dedupeMap.set(key, a);
            }
        });
        // Sort: critical first → ok last, then alphabetical within same type
        stockAlertsRaw = Array.from(dedupeMap.values()).sort((a, b) => {
            const pa = priority[b.alert_type] || 0;
            const pb = priority[a.alert_type] || 0;
            if (pa !== pb) return pa - pb;
            return a.product_name.localeCompare(b.product_name);
        });
        stockAlertsData = [...stockAlertsRaw];

        renderStockAlerts();
        updateAlertBadge();

    } catch (error) {
        console.error('Load stock alerts error:', error);
        const container = document.getElementById('alertsContainer');
        if (container) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">⚠️</div>
                    <h3>Error Loading Stock Alerts</h3>
                    <p style="color:#dc2626;">${error.message}</p>
                    <button class="btn btn-primary" style="margin-top:1rem;" onclick="loadStockAlerts()">
                        <i class="fas fa-refresh"></i> Retry
                    </button>
                </div>`;
        }
        showAlert('Error loading stock alerts: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function filterAlerts(filter) {
    currentAlertFilter = filter;
    // Sync the select dropdown
    const sel = document.getElementById('alertTypeFilter');
    if (sel) sel.value = filter;
    renderStockAlerts();
}

function renderStockAlerts() {
    const container = document.getElementById('alertsContainer');
    const summaryContainer = document.getElementById('alertSummaryCards');

    const typeFilter     = document.getElementById('alertTypeFilter')?.value     || currentAlertFilter || 'all';
    const sectionFilter  = document.getElementById('alertSectionFilter')?.value  || 'all';
    const categoryFilter = document.getElementById('alertCategoryFilter')?.value || '';
    const searchTerm     = (document.getElementById('alertSearchInput')?.value || '').toLowerCase().trim();

    let filtered = stockAlertsRaw.filter(a => {
        if (typeFilter !== 'all'    && a.alert_type !== typeFilter)          return false;
        if (sectionFilter !== 'all' && a.section !== sectionFilter)          return false;
        if (categoryFilter          && a.category !== categoryFilter)         return false;
        if (searchTerm && !a.product_name.toLowerCase().includes(searchTerm)) return false;
        return true;
    });

    // ── Summary stat cards ──────────────────────────────────────────
    if (summaryContainer) {
        const total    = stockAlertsRaw.length;
        const critical = stockAlertsRaw.filter(a=>a.alert_type==='critical').length;
        const warning  = stockAlertsRaw.filter(a=>a.alert_type==='warning').length;
        const watch    = stockAlertsRaw.filter(a=>a.alert_type==='watch').length;
        const declining= stockAlertsRaw.filter(a=>a.alert_type==='declining').length;
        const ok       = stockAlertsRaw.filter(a=>a.alert_type==='ok').length;
        summaryContainer.innerHTML = `
            <div class="stock-stat-card" style="border-top:3px solid var(--neutral-400); cursor:pointer;" onclick="filterAlerts('all')">
                <div class="stock-stat-label">📦 Total Products</div>
                <div class="stock-stat-value" style="color:var(--neutral-700);">${total}</div>
            </div>
            <div class="stock-stat-card" style="border-top:3px solid #dc2626; cursor:pointer;" onclick="filterAlerts('critical')">
                <div class="stock-stat-label">🔴 Out of Stock</div>
                <div class="stock-stat-value" style="color:#dc2626;">${critical}</div>
            </div>
            <div class="stock-stat-card" style="border-top:3px solid #f59e0b; cursor:pointer;" onclick="filterAlerts('warning')">
                <div class="stock-stat-label">🟠 Low Stock</div>
                <div class="stock-stat-value" style="color:#d97706;">${warning}</div>
            </div>
            <div class="stock-stat-card" style="border-top:3px solid #eab308; cursor:pointer;" onclick="filterAlerts('watch')">
                <div class="stock-stat-label">🟡 Below 50%</div>
                <div class="stock-stat-value" style="color:#ca8a04;">${watch}</div>
            </div>
            <div class="stock-stat-card" style="border-top:3px solid #8b5cf6; cursor:pointer;" onclick="filterAlerts('declining')">
                <div class="stock-stat-label">📉 Declining</div>
                <div class="stock-stat-value" style="color:#7c3aed;">${declining}</div>
            </div>
            <div class="stock-stat-card" style="border-top:3px solid #16a34a; cursor:pointer;" onclick="filterAlerts('ok')">
                <div class="stock-stat-label">✅ In Stock OK</div>
                <div class="stock-stat-value" style="color:#16a34a;">${ok}</div>
            </div>`;
    }

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">${stockAlertsRaw.length === 0 ? '📦' : '🔍'}</div>
                <h3>${stockAlertsRaw.length === 0 ? 'No Products Loaded' : 'No Products Match Filter'}</h3>
                <p>${stockAlertsRaw.length === 0
                    ? 'No products are assigned to Rony or Julio yet. Assign products in Inventory Settings.'
                    : 'Try changing or clearing the filters above.'}</p>
            </div>`;
        return;
    }

    // ── Group by section → category ────────────────────────────────
    const sections = ['rony','julio'];
    const sectionLabels = {
        rony:  { label: "🍳 Rony's Section", cls: 'rony', icon: 'fa-user-chef' },
        julio: { label: "🛒 Julio's Section", cls: 'julio', icon: 'fa-cart-shopping' }
    };
    const statusIcons  = { critical:'🔴', warning:'🟠', watch:'🟡', declining:'📉', ok:'✅' };
    const statusLabels = { critical:'CRITICAL – Out of Stock', warning:'WARNING – Low Stock', watch:'WATCH – Below 50%', declining:'DECLINING – Dropping Fast', ok:'IN STOCK' };

    let html = '';

    sections.forEach(sec => {
        if (sectionFilter !== 'all' && sectionFilter !== sec) return;
        const sectionItems = filtered.filter(a => a.section === sec);
        if (sectionItems.length === 0) return;

        const secInfo = sectionLabels[sec];

        // Group by category
        const byCategory = {};
        sectionItems.forEach(a => {
            const cat = a.category || 'Uncategorized';
            if (!byCategory[cat]) byCategory[cat] = [];
            byCategory[cat].push(a);
        });

        html += `<div class="alert-section">
            <div class="alert-section-header ${secInfo.cls}">
                <i class="fas ${secInfo.icon}"></i>
                ${secInfo.label}
                <span style="margin-left:auto; background:rgba(255,255,255,0.2); border-radius:20px; padding:0.2rem 0.75rem; font-size:0.8125rem; font-weight:700;">${sectionItems.length} alert${sectionItems.length!==1?'s':''}</span>
            </div>`;

        Object.keys(byCategory).sort().forEach(cat => {
            const catItems = byCategory[cat];
            html += `<div class="alert-category-block">
                <div class="alert-category-label">
                    <i class="fas fa-tag" style="opacity:0.5;"></i> ${cat}
                    <span style="margin-left:auto; font-size:0.75rem; font-weight:600;">${catItems.length} item${catItems.length!==1?'s':''}</span>
                </div>
                <div class="alert-category-grid">`;

            catItems.forEach(alert => {
                const imgSrc = alert.image_url || PLACEHOLDER_IMAGE;
                const daysSince = alert.last_count_date
                    ? Math.floor((new Date() - alert.last_count_date) / 86400000)
                    : null;

                // Case/unit display
                const conv = alert.conv || { units_per_case: 1, unit_type: 'unit' };
                const hasCase = conv.units_per_case > 1;
                let stockDisplay = '';
                let caseDisplay = '';
                if (hasCase && alert.current_stock > 0) {
                    const cases = Math.floor(alert.current_stock / conv.units_per_case);
                    const units = alert.current_stock % conv.units_per_case;
                    caseDisplay = `<div class="case-unit-badge">
                        <i class="fas fa-boxes-stacked"></i>
                        ${cases > 0 ? cases + ' case' + (cases>1?'s':'') : ''}
                        ${cases > 0 && units > 0 ? ' + ' : ''}
                        ${units > 0 ? units + ' ' + conv.unit_type : ''}
                        <span style="opacity:0.6;">(${conv.units_per_case} ${conv.unit_type}/cs)</span>
                    </div>`;
                }

                const stockColor = alert.current_stock === 0 ? '#dc2626' : 'var(--neutral-900)';
                const stockValue = alert.has_been_counted ? alert.current_stock.toFixed(1) : '?';
                const stockNote  = !alert.has_been_counted ? '<div style="font-size:0.75rem;color:#d97706;margin-top:0.25rem;">Never counted</div>' : '';

                const pctVal = alert.par > 0 ? ((alert.current_stock / alert.par) * 100).toFixed(0) : '0';
                const barColor = alert.alert_type === 'critical' ? '#dc2626'
                    : alert.alert_type === 'warning'  ? '#f59e0b'
                    : alert.alert_type === 'watch'    ? '#eab308'
                    : alert.alert_type === 'ok'       ? '#16a34a'
                    : '#8b5cf6';
                const pctBar = `<div style="margin-top:0.5rem;height:4px;background:#e5e7eb;border-radius:2px;overflow:hidden;">
                    <div style="height:100%;width:${Math.min(100,pctVal)}%;background:${barColor};border-radius:2px;"></div>
                </div>`;

                html += `
                <div class="alert-card ${alert.alert_type}">
                    <div>
                        <img src="${imgSrc}" style="width:72px;height:72px;object-fit:cover;border-radius:8px;box-shadow:var(--shadow-sm);" onerror="this.src=PLACEHOLDER_IMAGE">
                    </div>
                    <div>
                        <div style="display:flex;align-items:center;gap:0.75rem;flex-wrap:wrap;margin-bottom:0.5rem;">
                            <h3 style="margin:0;font-size:1rem;font-weight:700;color:var(--neutral-900);">${alert.product_name}</h3>
                            <span class="alert-status ${alert.alert_type}">${statusIcons[alert.alert_type]} ${statusLabels[alert.alert_type]}</span>
                        </div>
                        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(120px,1fr));gap:0.75rem;margin-top:0.5rem;">
                            <div>
                                <div style="font-size:0.6875rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;letter-spacing:0.06em;">Current Stock</div>
                                <div style="font-size:1.5rem;font-weight:700;color:${stockColor};font-family:var(--font-mono);">${stockValue}</div>
                                ${stockNote}
                                ${caseDisplay}
                            </div>
                            <div>
                                <div style="font-size:0.6875rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;letter-spacing:0.06em;">PAR Level</div>
                                <div style="font-size:1.5rem;font-weight:700;font-family:var(--font-mono);">${alert.par > 0 ? alert.par.toFixed(1) : '—'}</div>
                                ${hasCase && alert.par > 0 ? `<div style="font-size:0.75rem;color:var(--neutral-500);">${(alert.par / conv.units_per_case).toFixed(1)} cases</div>` : ''}
                            </div>
                            <div>
                                <div style="font-size:0.6875rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;letter-spacing:0.06em;">Stock %</div>
                                <div style="font-size:1.5rem;font-weight:700;font-family:var(--font-mono);">${pctVal}%</div>
                                ${pctBar}
                            </div>
                            ${alert.stock_date ? `<div>
                                <div style="font-size:0.6875rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;letter-spacing:0.06em;">Last Counted</div>
                                <div style="font-size:0.875rem;font-weight:600;">${alert.stock_date}</div>
                            </div>` : ''}
                        </div>
                    </div>
                    <div style="display:flex;flex-direction:column;gap:0.5rem;min-width:110px;">
                        <button class="btn btn-primary" onclick="quickOrderFromAlert('${alert.product_name.replace(/'/g,"&#39;")}')">
                            <i class="fas fa-clipboard-list"></i> Order Now
                        </button>
                        <button class="btn btn-secondary" onclick="acknowledgeAlert('${alert.product_name.replace(/'/g,"&#39;")}')">
                            <i class="fas fa-check"></i> Acknowledge
                        </button>
                    </div>
                </div>`;
            });

            html += `</div></div>`;
        });

        html += `</div>`;
    });

    container.innerHTML = html || '<div class="empty-state"><div class="empty-state-icon">✅</div><h3>No Alerts</h3></div>';
}

function updateAlertBadge() {
    // Count only real alerts (not ok products)
    const alertsOnly = stockAlertsRaw.filter(a => a.alert_type !== 'ok');
    const criticalCount = alertsOnly.filter(a => a.alert_type === 'critical').length;
    const totalAlertCount = alertsOnly.length;

    // Nav badge — shows critical count, or total non-ok alerts
    const badge = document.getElementById('alertBadge');
    if (badge) {
        badge.textContent = criticalCount > 0 ? criticalCount : totalAlertCount;
        badge.style.display = totalAlertCount > 0 ? 'inline' : 'none';
    }
    // 🔔 Bell badge — only shows real alerts (not ok)
    const bellBadge = document.getElementById('bellBadge');
    if (bellBadge) {
        if (totalAlertCount > 0) {
            bellBadge.textContent = totalAlertCount > 99 ? '99+' : totalAlertCount;
            bellBadge.style.display = 'flex';
        } else {
            bellBadge.style.display = 'none';
        }
    }
    // Refresh the dropdown list if it's open (dropdown shows only alerts, not ok)
    renderDropdownAlerts();
}

// ── STOCK ALERT DROPDOWN PANEL ────────────────────────────────────
let _dpFilter = 'all';

function toggleAlertDropdown() {
    const panel = document.getElementById('alertDropdownPanel');
    if (!panel) return;
    const isOpen = panel.classList.contains('open');
    if (isOpen) {
        panel.classList.remove('open');
    } else {
        panel.classList.add('open');
        // If no data yet, load it
        if (stockAlertsRaw.length === 0) {
            loadDropdownAlerts();
        } else {
            renderDropdownAlerts();
        }
    }
}

// Close dropdown when clicking outside
document.addEventListener('click', function(e) {
    const panel = document.getElementById('alertDropdownPanel');
    const btn   = document.getElementById('alertBellBtn');
    if (panel && panel.classList.contains('open') && !panel.contains(e.target) && e.target !== btn && !btn?.contains(e.target)) {
        panel.classList.remove('open');
    }
});

async function loadDropdownAlerts() {
    const list = document.getElementById('alertDpList');
    if (list) list.innerHTML = '<div class="alert-dp-empty"><div class="big-icon">⏳</div><div>Loading…</div></div>';
    await loadStockAlerts(); // reuses main load which calls renderDropdownAlerts via updateAlertBadge
}

function filterDropdownAlerts(filter, btn) {
    _dpFilter = filter;
    // Update button states
    document.querySelectorAll('.alert-dp-filter-btn').forEach(b => b.classList.remove('active'));
    if (btn) btn.classList.add('active');
    renderDropdownAlerts();
}

function renderDropdownAlerts() {
    const list   = document.getElementById('alertDpList');
    const footer = document.getElementById('alertDpFooter');
    if (!list) return;

    let data = stockAlertsRaw;
    if (_dpFilter !== 'all') data = data.filter(a => a.alert_type === _dpFilter);

    if (data.length === 0) {
        list.innerHTML = `<div class="alert-dp-empty"><div class="big-icon">✅</div><div>${stockAlertsRaw.length===0 ? 'All stock levels healthy!' : 'No alerts match filter.'}</div></div>`;
        if (footer) footer.textContent = 'All products are well-stocked';
        return;
    }

    const labelMap = { critical: 'OUT', warning: 'LOW', watch: 'WATCH', declining: 'DROP' };
    list.innerHTML = data.map(a => {
        const imgHTML = a.image_url
            ? `<img class="alert-dp-img" src="${a.image_url}" alt="" onerror="this.style.display='none'">`
            : `<div class="alert-dp-img" style="display:flex;align-items:center;justify-content:center;font-size:1.25rem;">📦</div>`;
        return `
        <div class="alert-dp-item ${a.alert_type}">
            ${imgHTML}
            <span class="alert-dp-name" title="${a.product_name}">${a.product_name}</span>
            <span class="alert-dp-badge ${a.alert_type}">${labelMap[a.alert_type] || a.alert_type.toUpperCase()}</span>
        </div>`;
    }).join('');

    const critical = data.filter(a=>a.alert_type==='critical').length;
    const warning  = data.filter(a=>a.alert_type==='warning').length;
    if (footer) footer.textContent = `${data.length} alert${data.length!==1?'s':''} · ${critical} critical · ${warning} low stock`;
}

async function acknowledgeAlert(productName) {
    try {
        const { error } = await supabaseClient
            .from('alert_acknowledgements')
            .insert([{ product_name: productName, acknowledged_at: new Date().toISOString(), acknowledged_by: 'system' }]);
        if (error) throw error;
        showAlert(`Alert for "${productName}" acknowledged`, 'success');
        loadStockAlerts();
    } catch (error) {
        console.error('Acknowledge error:', error);
        showAlert('Error: ' + error.message, 'error');
    }
}

function quickOrderFromAlert(productName) {
    switchTab('placeOrder');
    showAlert(`Navigate to "${productName}" in the order form`, 'info');
}

// Auto-refresh every 60s when tab is active
setInterval(() => {
    if (document.getElementById('stockAlerts')?.classList.contains('active')) {
        loadStockAlerts();
    }
}, 60000);

// ========== CONSUMPTION TRACKING SYSTEM ==========
let consumptionData = [];
let consumptionTrendChart = null;
let consumptionCostChart = null;

// ═══════════════════════════════════════════════════════════════
// CONSUMPTION & ORDERS — Complete engine (per-product bar charts)
// Data sources:
//   Rony: inventory_submissions (stock counts by date)
//   Julio: inventory_check (tentative order qty by date)
//   Prices: invoice_items + invoices
// ═══════════════════════════════════════════════════════════════

let ctAllProducts = [];    // [{product_name, category, weeklyData:{weekLabel:[qty,...]}, vendor, latestPrice}]
let ctChartInstances = {}; // chartId → Chart.js instance

// ── INIT: set current month on load ───────────────────────────
(function ctInit() {
    const now = new Date();
    const monthSel = document.getElementById('consumptionMonth');
    if (monthSel) monthSel.value = String(now.getMonth() + 1);
    ctUpdateWeeks();
})();

function ctUpdateWeeks() {
    const year  = parseInt(document.getElementById('consumptionYear')?.value || new Date().getFullYear());
    const month = parseInt(document.getElementById('consumptionMonth')?.value || new Date().getMonth() + 1);
    const weekSel = document.getElementById('ctWeekFilter');
    if (!weekSel) return;

    // Build week boundaries for this month
    const weeks = [];
    const firstDay = new Date(year, month - 1, 1);
    const lastDay  = new Date(year, month, 0);

    let cursor = new Date(firstDay);
    let wNum = 1;
    while (cursor <= lastDay) {
        const wStart = new Date(cursor);
        const wEnd   = new Date(Math.min(cursor.getTime() + 6*86400000, lastDay.getTime()));
        const label  = `Week ${wNum} (${(wStart.getMonth()+1)}/${wStart.getDate()} - ${(wEnd.getMonth()+1)}/${wEnd.getDate()})`;
        weeks.push({ label, start: wStart.toISOString().split('T')[0], end: wEnd.toISOString().split('T')[0] });
        cursor = new Date(wEnd.getTime() + 86400000);
        wNum++;
    }

    weekSel.innerHTML = '<option value="all">All Weeks</option>' +
        weeks.map((w, i) => `<option value="${JSON.stringify({s:w.start,e:w.end})}">${w.label}</option>`).join('');
}

// ── MAIN LOAD ─────────────────────────────────────────────────
async function ctLoadData() {
    showLoading(true);
    try {
        const year  = parseInt(document.getElementById('consumptionYear')?.value || 2026);
        const month = parseInt(document.getElementById('consumptionMonth')?.value || 2);
        const weekVal = document.getElementById('ctWeekFilter')?.value || 'all';

        let startDate, endDate;
        if (weekVal !== 'all') {
            try {
                const w = JSON.parse(weekVal);
                startDate = w.s; endDate = w.e;
            } catch(jsonErr) {
                console.warn('Week filter parse error, defaulting to full month:', jsonErr);
                // Fall back to full month
                const last = new Date(year, month, 0);
                startDate = `${year}-${String(month).padStart(2,'0')}-01`;
                endDate   = `${year}-${String(month).padStart(2,'0')}-${String(last.getDate()).padStart(2,'0')}`;
            }
        } else {
            const last = new Date(year, month, 0);
            startDate = `${year}-${String(month).padStart(2,'0')}-01`;
            endDate   = `${year}-${String(month).padStart(2,'0')}-${String(last.getDate()).padStart(2,'0')}`;
        }

        // Update banner
        const banner = document.getElementById('ctDateRangeBanner');
        if (banner) { banner.style.display='block'; document.getElementById('ctDateRangeText').textContent = `${startDate} → ${endDate}`; }

        // ── Load management products (categories) ─────────────
        const { data: mgmt } = await supabaseClient
            .from('inventory_management')
            .select('product_name, category, image_url, assigned_to')
            .order('product_name');

        const mgmtMap = new Map();
        (mgmt || []).forEach(p => mgmtMap.set(p.product_name, p));

        // Populate category filter
        const cats = [...new Set((mgmt||[]).map(p => p.category||'Other').filter(Boolean))].sort();
        const catSel = document.getElementById('ctCategoryFilter');
        if (catSel) {
            catSel.innerHTML = '<option value="">All Categories</option>' +
                cats.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        // ── Load invoice data for prices and delivery ─────────
        const { data: invItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, quantity, unit_price, price_per_unit, has_weight, invoice_id');

        const invIds = [...new Set((invItems||[]).map(i=>i.invoice_id).filter(Boolean))];
        const invDateVendorMap = new Map();
        if (invIds.length > 0) {
            const { data: invs } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invIds)
                .gte('invoice_date', startDate)
                .lte('invoice_date', endDate);
            (invs||[]).forEach(i => invDateVendorMap.set(i.id, {date: i.invoice_date, vendor: i.vendor}));
        }

        // Build price + vendor map (latest per product)
        const priceMap  = new Map();
        const vendorMap = new Map();
        const deliveryByProductWeek = new Map(); // key: productName → Map(weekLabel → qty)
        (invItems||[]).forEach(item => {
            const inv = invDateVendorMap.get(item.invoice_id);
            if (!inv) return;
            const price = item.has_weight ? parseFloat(item.price_per_unit||0) : parseFloat(item.unit_price||0);
            if (!priceMap.has(item.product_name)) { priceMap.set(item.product_name, price); vendorMap.set(item.product_name, inv.vendor); }
            // Track delivery by week
            const wLabel = ctGetWeekLabel(inv.date, year, month);
            if (!deliveryByProductWeek.has(item.product_name)) deliveryByProductWeek.set(item.product_name, new Map());
            const wMap = deliveryByProductWeek.get(item.product_name);
            wMap.set(wLabel, (wMap.get(wLabel)||0) + parseFloat(item.quantity||0));
        });

        // ── Load Rony stock counts ─────────────────────────────
        const { data: ronySubmissions } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock, stock_date')
            .gte('stock_date', startDate)
            .lte('stock_date', endDate)
            .order('stock_date', { ascending: true });

        // Group rony by product → week → [qty readings]
        const ronyByProduct = new Map();
        (ronySubmissions||[]).forEach(s => {
            const wLabel = ctGetWeekLabel(s.stock_date, year, month);
            if (!ronyByProduct.has(s.product_name)) ronyByProduct.set(s.product_name, new Map());
            const wMap = ronyByProduct.get(s.product_name);
            if (!wMap.has(wLabel)) wMap.set(wLabel, []);
            wMap.get(wLabel).push(parseFloat(s.quantity_in_stock||0));
        });

        // ── Load Julio order entries ───────────────────────────
        const { data: julioOrders } = await supabaseClient
            .from('inventory_check')
            .select('product_name, tentative, order_date')
            .eq('user', 'Julio')
            .gte('order_date', startDate)
            .lte('order_date', endDate)
            .order('order_date', { ascending: true });

        const julioByProduct = new Map();
        (julioOrders||[]).forEach(o => {
            const qty = parseFloat(o.tentative||0);
            if (!qty) return;
            const wLabel = ctGetWeekLabel(o.order_date, year, month);
            if (!julioByProduct.has(o.product_name)) julioByProduct.set(o.product_name, new Map());
            const wMap = julioByProduct.get(o.product_name);
            wMap.set(wLabel, (wMap.get(wLabel)||0) + qty);
        });

        // ── Build product list with week-by-week data ─────────
        const userFilter = document.getElementById('consumptionUserFilter')?.value || 'all';
        const weekLabels = ctGetWeekLabels(year, month);

        ctAllProducts = [];
        mgmtMap.forEach((p, productName) => {
            const hasRony  = ronyByProduct.has(productName);
            const hasJulio = julioByProduct.has(productName);
            if (!hasRony && !hasJulio) return; // no data for this period

            if (userFilter === 'rony'  && !hasRony)  return;
            if (userFilter === 'julio' && !hasJulio) return;

            // Rony weekly consumption = avg_stock[week] - avg_stock[next_week]
            const ronyWeekly = {};
            if (hasRony) {
                const ronyMap = ronyByProduct.get(productName);
                weekLabels.forEach((wl, idx) => {
                    const thisWeekVals = ronyMap.get(wl) || [];
                    const avgThis = thisWeekVals.length ? thisWeekVals.reduce((a,b)=>a+b,0)/thisWeekVals.length : null;
                    ronyWeekly[wl] = avgThis;
                });
            }

            // Julio weekly ordered qty
            const julioWeekly = {};
            if (hasJulio) {
                const julioMap = julioByProduct.get(productName);
                weekLabels.forEach(wl => { julioWeekly[wl] = julioMap.get(wl) || 0; });
            }

            // Delivery by week
            const deliveryWeekly = {};
            const dMap = deliveryByProductWeek.get(productName);
            weekLabels.forEach(wl => { deliveryWeekly[wl] = dMap ? (dMap.get(wl)||0) : 0; });

            ctAllProducts.push({
                product_name: productName,
                category: p.category || 'Other',
                image_url: p.image_url,
                latestPrice: priceMap.get(productName) || 0,
                vendor: vendorMap.get(productName) || '—',
                weekLabels,
                ronyWeekly,
                julioWeekly,
                deliveryWeekly,
                totalRonyConsumed: hasRony ? Object.values(ronyWeekly).reduce((s,v)=>s+(v||0),0) : 0,
                totalJulioOrdered: hasJulio ? Object.values(julioWeekly).reduce((s,v)=>s+(v||0),0) : 0,
            });
        });

        ctAllProducts.sort((a,b) => a.product_name.localeCompare(b.product_name));
        ctRenderAll();

    } catch(e) {
        console.error('ctLoadData error:', e);
        showAlert('Error loading data: ' + e.message, 'error');
    } finally {
        showLoading(false);
    }
}

function ctGetWeekLabels(year, month) {
    const labels = [];
    const firstDay = new Date(year, month-1, 1);
    const lastDay  = new Date(year, month, 0);
    let cursor = new Date(firstDay);
    let wNum = 1;
    while (cursor <= lastDay) {
        const wEnd = new Date(Math.min(cursor.getTime() + 6*86400000, lastDay.getTime()));
        labels.push(`W${wNum} ${(cursor.getMonth()+1)}/${cursor.getDate()}`);
        cursor = new Date(wEnd.getTime() + 86400000);
        wNum++;
    }
    return labels;
}

function ctGetWeekLabel(dateStr, year, month) {
    const d = new Date(dateStr + (dateStr.length === 10 ? 'T12:00:00' : ''));
    const firstDay = new Date(year, month-1, 1);
    const dayDiff = Math.floor((d - firstDay) / 86400000);
    const weekNum = Math.floor(dayDiff / 7) + 1;
    const wStart  = new Date(year, month-1, 1 + (weekNum-1)*7);
    return `W${weekNum} ${(wStart.getMonth()+1)}/${wStart.getDate()}`;
}

// ── FILTERS ──────────────────────────────────────────────────
function ctApplyFilters() { ctRenderAll(); }
function ctClearSearch() {
    const inp = document.getElementById('ctProductSearch');
    if (inp) { inp.value = ''; }
    document.getElementById('ctSuggestBox').style.display = 'none';
    ctRenderAll();
}

function ctShowSuggestions(query) {
    const box = document.getElementById('ctSuggestBox');
    if (!query.trim() || ctAllProducts.length === 0) { box.style.display='none'; ctRenderAll(); return; }
    const q = query.toLowerCase();
    const matches = ctAllProducts.filter(p => p.product_name.toLowerCase().includes(q)).slice(0, 8);
    if (!matches.length) { box.style.display='none'; ctRenderAll(); return; }
    box.style.display = 'block';
    box.innerHTML = matches.map(p => `
        <div onclick="ctSelectProduct('${p.product_name.replace(/'/g,"\'")}');"
             style="padding:.6rem 1rem;cursor:pointer;border-bottom:1px solid var(--neutral-100);font-size:.875rem;display:flex;align-items:center;gap:.75rem;"
             onmouseover="this.style.background='var(--primary-50)'" onmouseout="this.style.background='white'">
          <span style="font-size:.7rem;background:var(--primary-100);color:var(--primary-700);padding:.2rem .5rem;border-radius:4px;">${p.category}</span>
          <span style="font-weight:600;">${p.product_name}</span>
        </div>`).join('');
    ctRenderAll();
}

function ctSelectProduct(name) {
    const inp = document.getElementById('ctProductSearch');
    if (inp) inp.value = name;
    document.getElementById('ctSuggestBox').style.display = 'none';
    ctRenderAll();
}

// ── RENDER ALL PRODUCT CARDS ──────────────────────────────────
function ctRenderAll() {
    const searchQ    = (document.getElementById('ctProductSearch')?.value || '').toLowerCase().trim();
    const catFilter  = document.getElementById('ctCategoryFilter')?.value || '';
    const userFilter = document.getElementById('consumptionUserFilter')?.value || 'all';

    let filtered = ctAllProducts.filter(p => {
        if (searchQ && !p.product_name.toLowerCase().includes(searchQ)) return false;
        if (catFilter && p.category !== catFilter) return false;
        if (userFilter === 'rony'  && !Object.values(p.ronyWeekly).some(v=>v!==null)) return false;
        if (userFilter === 'julio' && !Object.values(p.julioWeekly).some(v=>v>0))     return false;
        return true;
    });

    const container = document.getElementById('ctProductCards');
    const empty     = document.getElementById('ctEmptyState');

    if (!filtered.length) {
        if (container) container.innerHTML = '';
        if (empty) empty.style.display = 'block';
        ctRenderSummary([]);
        return;
    }
    if (empty) empty.style.display = 'none';

    // Destroy old charts
    Object.values(ctChartInstances).forEach(c => { try { c.destroy(); } catch(e){} });
    ctChartInstances = {};

    container.innerHTML = filtered.map(p => ctBuildProductCard(p)).join('');

    // Build charts after DOM update
    requestAnimationFrame(() => {
        filtered.forEach(p => ctBuildChart(p));
    });

    ctRenderSummary(filtered);
}

// ── PRODUCT CARD HTML ─────────────────────────────────────────
function ctBuildProductCard(p) {
    const imgUrl  = resolveImage(p.image_url);
    const catColors = {
        'Produce':'#16a34a','Meat & Seafood':'#dc2626','Dairy':'#3b82f6',
        'Dry Goods':'#f59e0b','Frozen':'#0ea5e9','Beverages':'#ec4899',
        'Cleaning Supplies':'#a855f7','Office Supplies':'#8b5cf6',
        'Kitchen Equipment':'#ea580c','Supermarket':'#ca8a04','Other':'#64748b'
    };
    const catColor = catColors[p.category] || '#64748b';
    const chartId = 'ctChart_' + p.product_name.replace(/[^a-zA-Z0-9]/g,'_');

    const totalQty  = Math.max(p.totalRonyConsumed, p.totalJulioOrdered);
    const totalCost = totalQty * p.latestPrice;

    return `
    <div style="background:white;border-radius:12px;border:1px solid var(--neutral-200);overflow:hidden;box-shadow:var(--shadow-sm);">
      <!-- Header -->
      <div style="display:flex;align-items:center;gap:1rem;padding:.875rem 1.25rem;border-bottom:2px solid ${catColor}22;background:${catColor}08;">
        <img src="${imgUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
             style="width:52px;height:52px;object-fit:contain;border-radius:8px;border:1px solid ${catColor}33;background:white;padding:3px;flex-shrink:0;">
        <div style="flex:1;min-width:0;">
          <div style="font-weight:700;font-size:1rem;color:var(--neutral-900);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;">${p.product_name}</div>
          <div style="display:flex;gap:.5rem;flex-wrap:wrap;margin-top:.25rem;">
            <span style="font-size:.7rem;font-weight:700;background:${catColor};color:white;padding:.15rem .5rem;border-radius:4px;">${p.category}</span>
            <span style="font-size:.7rem;color:var(--neutral-500);">🏭 ${p.vendor}</span>
            <span style="font-size:.7rem;color:var(--success-700);font-weight:600;">$${p.latestPrice.toFixed(2)}/unit</span>
          </div>
        </div>
        <!-- KPIs -->
        <div style="display:flex;gap:1.5rem;flex-shrink:0;">
          ${p.totalRonyConsumed > 0 ? `<div style="text-align:right;">
            <div style="font-size:1.5rem;font-weight:800;color:var(--primary-700);font-family:var(--font-mono);">${p.totalRonyConsumed.toFixed(0)}</div>
            <div style="font-size:.65rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;">Consumed</div>
          </div>` : ''}
          ${p.totalJulioOrdered > 0 ? `<div style="text-align:right;">
            <div style="font-size:1.5rem;font-weight:800;color:var(--accent-600);font-family:var(--font-mono);">${p.totalJulioOrdered.toFixed(0)}</div>
            <div style="font-size:.65rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;">Ordered</div>
          </div>` : ''}
          ${p.latestPrice > 0 && (p.totalRonyConsumed + p.totalJulioOrdered) > 0 ? `<div style="text-align:right;">
            <div style="font-size:1.5rem;font-weight:800;color:var(--success-700);font-family:var(--font-mono);">$${totalCost.toFixed(0)}</div>
            <div style="font-size:.65rem;color:var(--neutral-500);text-transform:uppercase;font-weight:700;">Period Cost</div>
          </div>` : ''}
        </div>
      </div>
      <!-- Chart -->
      <div style="padding:1rem 1.25rem;">
        <canvas id="${chartId}" height="100"></canvas>
      </div>
    </div>`;
}

// ── BUILD CHART ───────────────────────────────────────────────
function ctBuildChart(p) {
    const chartId = 'ctChart_' + p.product_name.replace(/[^a-zA-Z0-9]/g,'_');
    const canvas  = document.getElementById(chartId);
    if (!canvas) return;

    const labels   = p.weekLabels;
    const datasets = [];

    // Rony stock level (line, secondary axis)
    const ronyVals = labels.map(wl => p.ronyWeekly[wl] ?? null);
    if (ronyVals.some(v => v !== null)) {
        datasets.push({
            label: 'Rony Stock Level',
            data: ronyVals,
            type: 'line',
            borderColor: '#2c5888',
            backgroundColor: 'rgba(44,88,136,0.08)',
            pointBackgroundColor: '#2c5888',
            borderWidth: 2,
            pointRadius: 4,
            fill: true,
            tension: 0.3,
            spanGaps: true,
            yAxisID: 'yStock'
        });
    }

    // Julio ordered (bar)
    const julioVals = labels.map(wl => p.julioWeekly[wl] || 0);
    if (julioVals.some(v => v > 0)) {
        datasets.push({
            label: 'Julio Ordered',
            data: julioVals,
            type: 'bar',
            backgroundColor: 'rgba(217,119,6,0.7)',
            borderColor: '#d97706',
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'yQty'
        });
    }

    // Delivery (bar stacked or separate)
    const deliveryVals = labels.map(wl => p.deliveryWeekly[wl] || 0);
    if (deliveryVals.some(v => v > 0)) {
        datasets.push({
            label: '📦 Delivered',
            data: deliveryVals,
            type: 'bar',
            backgroundColor: 'rgba(22,163,74,0.65)',
            borderColor: '#16a34a',
            borderWidth: 1,
            borderRadius: 4,
            yAxisID: 'yQty'
        });
    }

    if (!datasets.length) return;

    const scales = {
        x: { grid: { color: 'rgba(0,0,0,0.04)' }, ticks: { font: { size: 11 } } },
        yQty: {
            type: 'linear', position: 'left',
            title: { display: true, text: 'Qty', font: { size: 10 } },
            grid: { color: 'rgba(0,0,0,0.05)' }, beginAtZero: true,
            ticks: { font: { size: 10 } }
        }
    };
    if (ronyVals.some(v => v !== null)) {
        scales.yStock = {
            type: 'linear', position: 'right',
            title: { display: true, text: 'Stock', font: { size: 10 } },
            grid: { drawOnChartArea: false }, beginAtZero: true,
            ticks: { font: { size: 10 } }
        };
    }

    if (ctChartInstances[chartId]) { try { ctChartInstances[chartId].destroy(); } catch(e){} }
    ctChartInstances[chartId] = new Chart(canvas, {
        type: 'bar',
        data: { labels, datasets },
        options: {
            responsive: true, maintainAspectRatio: true,
            plugins: {
                legend: { position: 'top', labels: { boxWidth: 12, font: { size: 11 } } },
                tooltip: {
                    callbacks: {
                        label: ctx => {
                            const v = ctx.parsed.y;
                            const price = p.latestPrice;
                            const cost  = price > 0 ? ` ($${(v*price).toFixed(2)})` : '';
                            return ` ${ctx.dataset.label}: ${v !== null ? v.toFixed(1) : 'N/A'}${cost}`;
                        }
                    }
                }
            },
            scales
        }
    });
}

// ── SUMMARY CARDS ─────────────────────────────────────────────
function ctRenderSummary(filtered) {
    const cont = document.getElementById('ctSummaryCards');
    if (!cont) return;
    const totalProducts = filtered.length;
    const totalConsumed = filtered.reduce((s,p)=>s+p.totalRonyConsumed,0);
    const totalOrdered  = filtered.reduce((s,p)=>s+p.totalJulioOrdered,0);
    const totalCost     = filtered.reduce((s,p)=>s+(p.totalRonyConsumed+p.totalJulioOrdered)*p.latestPrice,0);
    const topProduct    = [...filtered].sort((a,b)=>(b.totalRonyConsumed+b.totalJulioOrdered)-(a.totalRonyConsumed+a.totalJulioOrdered))[0];

    const card = (icon, label, value, sub, color) => `
        <div style="background:white;border-radius:10px;padding:1.1rem 1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);border-left:4px solid ${color};">
          <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-500);margin-bottom:.25rem;">${icon} ${label}</div>
          <div style="font-size:1.6rem;font-weight:800;font-family:var(--font-mono);color:${color};">${value}</div>
          ${sub ? `<div style="font-size:.72rem;color:var(--neutral-400);margin-top:.15rem;">${sub}</div>` : ''}
        </div>`;

    cont.innerHTML =
        card('📦','Products Tracked', totalProducts, '', '#3b82f6') +
        (totalConsumed > 0 ? card('🔴','Rony Consumed', totalConsumed.toFixed(0)+' units', 'Total period', '#dc2626') : '') +
        (totalOrdered  > 0 ? card('🟠','Julio Ordered',  totalOrdered.toFixed(0)+' units',  'Total period', '#d97706') : '') +
        card('💰','Period Cost', '$'+totalCost.toFixed(2), 'All products', '#16a34a') +
        (topProduct ? card('🏆','Top Product', topProduct.product_name.substring(0,18)+(topProduct.product_name.length>18?'…':''), topProduct.category, '#ca8a04') : '');
}

// ── LEGACY COMPAT STUBS ────────────────────────────────────────
async function loadConsumptionData() { await ctLoadData(); }
function filterConsumptionData() { ctApplyFilters(); }

function updateConsumptionSummary(totalQty, totalCost, avgCost) {
    const container = document.getElementById('consumptionSummary');
    const user = document.getElementById('consumptionUserFilter').value;
    const qtyLabel = user === 'rony' ? 'Total Consumed' : 'Total Ordered';

    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-label">${qtyLabel}</div>
            <div class="metric-value">${totalQty.toFixed(0)}</div>
            <div class="metric-subtitle">Units</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Cost</div>
            <div class="metric-value">$${totalCost.toFixed(2)}</div>
            <div class="metric-subtitle">All items</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Average Cost</div>
            <div class="metric-value">$${avgCost.toFixed(2)}</div>
            <div class="metric-subtitle">Per product</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Products</div>
            <div class="metric-value">${consumptionData.length}</div>
            <div class="metric-subtitle">Tracked items</div>
        </div>
    `;
}

function renderConsumptionCharts() {
    const top10 = consumptionData.slice(0, 10);
    const user = document.getElementById('consumptionUserFilter').value;
    const qtyField = user === 'rony' ? 'consumed' : 'total_ordered';

    // Trend Chart
    const trendCtx = document.getElementById('consumptionTrendChart');
    if (consumptionTrendChart) consumptionTrendChart.destroy();
    consumptionTrendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: top10.map(i => i.product_name.substring(0, 20)),
            datasets: [{
                label: user === 'rony' ? 'Consumed' : 'Ordered',
                data: top10.map(i => i[qtyField]),
                backgroundColor: 'rgba(139, 32, 32, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Cost Chart
    const costCtx = document.getElementById('consumptionCostChart');
    if (consumptionCostChart) consumptionCostChart.destroy();
    consumptionCostChart = new Chart(costCtx, {
        type: 'bar',
        data: {
            labels: top10.map(i => i.product_name.substring(0, 20)),
            datasets: [{
                label: 'Total Cost',
                data: top10.map(i => i.total_cost),
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => `$${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        }
    });
}

function filterConsumptionData() {
    // Re-render with search filter
    loadConsumptionData();
}

// ========== INVENTORY VALUATION REPORTS ==========
let valuationChart = null;
let valuationTrendChart = null;

async function loadValuationReport() {
    showLoading(true);
    let valAllData = [];
    try {
        const reportType = document.getElementById('valuationReportType')?.value || 'current';
        const period     = document.getElementById('valuationPeriod')?.value || 'month';
        const catFilter  = document.getElementById('valCategoryFilter')?.value || '';

        // Date range
        const now = new Date();
        let startDate;
        if      (period === 'month')   startDate = new Date(now.getFullYear(), now.getMonth(), 1);
        else if (period === 'quarter') startDate = new Date(now.getFullYear(), Math.floor(now.getMonth()/3)*3, 1);
        else if (period === 'year')    startDate = new Date(now.getFullYear(), 0, 1);
        else                           startDate = new Date(2020, 0, 1); // all time

        const startStr = startDate.toISOString().split('T')[0];
        const endStr   = now.toISOString().split('T')[0];

        // 1. Load inventory_management (categories, par, on_hand)
        const { data: mgmt } = await supabaseClient
            .from('inventory_management')
            .select('product_name, category, par, on_hand, image_url');

        const mgmtMap = new Map();
        (mgmt||[]).forEach(p => mgmtMap.set(p.product_name, p));

        // Populate category filter
        const cats = [...new Set((mgmt||[]).map(p=>p.category||'Other').filter(Boolean))].sort();
        const catSel = document.getElementById('valCategoryFilter');
        if (catSel) {
            const cur = catSel.value;
            catSel.innerHTML = '<option value="">All Categories</option>' + cats.map(c=>`<option value="${c}" ${c===cur?'selected':''}>${c}</option>`).join('');
        }

        // 2. Load invoice_items with invoices for prices + vendor + dates
        const { data: invItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, quantity, unit_price, price_per_unit, has_weight, invoice_id');

        const invIds = [...new Set((invItems||[]).map(i=>i.invoice_id).filter(Boolean))];
        const invMap = new Map(); // id → {date, vendor}
        if (invIds.length > 0) {
            const { data: invs } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invIds);
            (invs||[]).forEach(i => invMap.set(i.id, {date: i.invoice_date, vendor: i.vendor}));
        }

        // 3. Build per-product data
        const productData = new Map(); // productName → {purchases:[{date,vendor,price,qty}], on_hand, category, par}

        mgmtMap.forEach((p, name) => {
            productData.set(name, {
                product_name: name,
                category: p.category || 'Other',
                on_hand: parseFloat(p.on_hand||0),
                par: parseFloat(p.par||0),
                image_url: p.image_url,
                purchases: [],
                vendors: new Set()
            });
        });

        (invItems||[]).forEach(item => {
            const inv = invMap.get(item.invoice_id);
            if (!inv || inv.date < startStr) return;

            const price = item.has_weight ? parseFloat(item.price_per_unit||0) : parseFloat(item.unit_price||0);
            const qty   = parseFloat(item.quantity||0);
            const name  = item.product_name;

            if (!productData.has(name)) {
                productData.set(name, {
                    product_name: name,
                    category: 'Other',
                    on_hand: 0, par: 0, image_url: null,
                    purchases: [], vendors: new Set()
                });
            }
            const p = productData.get(name);
            p.purchases.push({ date: inv.date, vendor: inv.vendor, price, qty });
            p.vendors.add(inv.vendor);
        });

        // 4. Compute metrics per product
        valAllData = [];
        productData.forEach((p, name) => {
            if (catFilter && p.category !== catFilter) return;

            const purchases = p.purchases.filter(pu => pu.date >= startStr && pu.date <= endStr);
            const latestPurchase  = purchases.sort((a,b)=>b.date.localeCompare(a.date))[0];
            const latestPrice     = latestPurchase?.price || 0;
            const latestVendor    = latestPurchase?.vendor || '—';
            const totalSpend      = purchases.reduce((s,pu)=>s+pu.price*pu.qty,0);
            const totalQtyBought  = purchases.reduce((s,pu)=>s+pu.qty,0);
            const avgPrice        = totalQtyBought > 0 ? totalSpend / totalQtyBought : latestPrice;
            const stockValue      = p.on_hand * latestPrice;
            const parValue        = p.par * latestPrice;
            const stockPct        = p.par > 0 ? Math.min(100, Math.round(p.on_hand/p.par*100)) : null;

            // Min / Max price across vendors
            const allPrices = purchases.map(pu=>pu.price).filter(x=>x>0);
            const minPrice  = allPrices.length ? Math.min(...allPrices) : latestPrice;
            const maxPrice  = allPrices.length ? Math.max(...allPrices) : latestPrice;
            const priceSavings = (maxPrice - minPrice) * totalQtyBought;

            valAllData.push({
                product_name: name,
                category: p.category,
                on_hand: p.on_hand,
                par: p.par,
                stockPct,
                latestPrice,
                avgPrice,
                minPrice,
                maxPrice,
                priceSavings,
                latestVendor,
                vendors: [...p.vendors].filter(Boolean).join(', ') || '—',
                totalSpend,
                totalQtyBought,
                stockValue,
                parValue,
                purchaseCount: purchases.length
            });
        });

        valAllData.sort((a,b) => b.stockValue - a.stockValue);
        valApplyFilters(valAllData);
        valRenderCharts(valAllData, startStr, endStr, invItems, invMap);

    } catch(e) {
        console.error('loadValuationReport error:', e);
        showAlert('Error: ' + e.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Store for filter re-apply
let _valAllData = [];
function valApplyFilters(data) {
    if (data) _valAllData = data;
    const q = (document.getElementById('valSearch')?.value||'').toLowerCase().trim();
    const filtered = q ? _valAllData.filter(p=>p.product_name.toLowerCase().includes(q)) : _valAllData;
    valRenderTable(filtered);
    valRenderSummary(filtered);
}

function valRenderSummary(data) {
    const cont = document.getElementById('valuationSummary');
    if (!cont) return;

    const totalStockValue = data.reduce((s,p)=>s+p.stockValue,0);
    const totalSpend      = data.reduce((s,p)=>s+p.totalSpend,0);
    const totalSavings    = data.reduce((s,p)=>s+p.priceSavings,0);
    const lowStock        = data.filter(p=>p.stockPct !== null && p.stockPct < 25).length;
    const products        = data.length;

    const card = (icon,label,val,sub,color) => `
        <div style="background:white;border-radius:10px;padding:1.1rem 1.25rem;border:1px solid var(--neutral-200);box-shadow:var(--shadow-sm);border-left:4px solid ${color};">
          <div style="font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.05em;color:var(--neutral-500);margin-bottom:.25rem;">${icon} ${label}</div>
          <div style="font-size:1.55rem;font-weight:800;font-family:var(--font-mono);color:${color};">${val}</div>
          ${sub?`<div style="font-size:.72rem;color:var(--neutral-400);margin-top:.15rem;">${sub}</div>`:''}
        </div>`;

    cont.innerHTML =
        card('📦','Products',    products, 'in database', '#3b82f6') +
        card('💰','Stock Value', '$'+totalStockValue.toFixed(2), 'on-hand × latest price', '#16a34a') +
        card('🧾','Period Spend','$'+totalSpend.toFixed(2), 'invoices this period', '#d97706') +
        card('💡','Price Savings','$'+totalSavings.toFixed(2), 'best vs worst vendor', '#8b5cf6') +
        card('⚠️','Low Stock',   lowStock, 'below 25% PAR', '#dc2626');
}

function valRenderTable(data) {
    const tbody  = document.getElementById('valuationTableBody');
    const header = document.getElementById('valuationTableHeader');
    const title  = document.getElementById('valuationTableTitle');
    const count  = document.getElementById('valuationCount');

    if (!tbody) return;
    const reportType = document.getElementById('valuationReportType')?.value || 'current';

    if (title) title.textContent = {
        current: 'Current Stock Valuation',
        cogs: 'Purchase History (COGS)',
        vendor_price: 'Vendor Price Comparison',
        category: 'By Category Summary'
    }[reportType] || 'Valuation Details';

    if (count) count.textContent = `${data.length} items`;

    if (!data.length) {
        tbody.innerHTML = `<tr><td colspan="8" style="text-align:center;padding:2rem;color:var(--neutral-400);">No data. Select period and click Refresh.</td></tr>`;
        return;
    }

    // Build by-category view
    if (reportType === 'category') {
        const catMap = {};
        data.forEach(p => {
            if (!catMap[p.category]) catMap[p.category] = {count:0,stockValue:0,totalSpend:0,onHand:0};
            const c = catMap[p.category];
            c.count++;c.stockValue+=p.stockValue;c.totalSpend+=p.totalSpend;c.onHand+=p.on_hand;
        });
        header.innerHTML = `<th>Category</th><th>Products</th><th>Total On Hand</th><th>Stock Value</th><th>Period Spend</th><th>% of Portfolio</th>`;
        const totalVal = Object.values(catMap).reduce((s,c)=>s+c.stockValue,0);
        tbody.innerHTML = Object.entries(catMap).sort((a,b)=>b[1].stockValue-a[1].stockValue).map(([cat,c])=>`
            <tr>
              <td style="font-weight:700;">${cat}</td>
              <td>${c.count}</td>
              <td style="font-family:var(--font-mono);">${c.onHand.toFixed(1)}</td>
              <td><strong style="color:var(--success-700);">$${c.stockValue.toFixed(2)}</strong></td>
              <td><span style="color:var(--accent-700);">$${c.totalSpend.toFixed(2)}</span></td>
              <td>
                <div style="display:flex;align-items:center;gap:.5rem;">
                  <div style="flex:1;height:6px;background:var(--neutral-200);border-radius:3px;overflow:hidden;">
                    <div style="height:100%;width:${totalVal>0?((c.stockValue/totalVal)*100).toFixed(0):0}%;background:var(--primary-500);"></div>
                  </div>
                  <span style="font-size:.8rem;font-family:var(--font-mono);">${totalVal>0?((c.stockValue/totalVal)*100).toFixed(1):0}%</span>
                </div>
              </td>
            </tr>`).join('');
        return;
    }

    // Vendor price comparison
    if (reportType === 'vendor_price') {
        header.innerHTML = `<th>Product</th><th>Category</th><th>Min Price</th><th>Max Price</th><th>Savings Opp.</th><th>Vendors Used</th><th>Best Vendor</th><th>Purchases</th>`;
        tbody.innerHTML = data.filter(p=>p.purchaseCount>0).sort((a,b)=>b.priceSavings-a.priceSavings).map(p=>`
            <tr>
              <td style="font-weight:600;">${p.product_name}</td>
              <td><span style="font-size:.7rem;background:var(--primary-100);color:var(--primary-700);padding:.15rem .5rem;border-radius:4px;">${p.category}</span></td>
              <td style="color:var(--success-700);font-weight:700;font-family:var(--font-mono);">$${p.minPrice.toFixed(2)}</td>
              <td style="color:var(--warning-700);font-family:var(--font-mono);">$${p.maxPrice.toFixed(2)}</td>
              <td style="color:var(--success-600);font-weight:700;">$${p.priceSavings.toFixed(2)}</td>
              <td style="font-size:.8rem;">${p.vendors}</td>
              <td style="font-size:.8rem;font-weight:600;">${p.latestVendor}</td>
              <td style="font-family:var(--font-mono);">${p.purchaseCount}x</td>
            </tr>`).join('');
        return;
    }

    // COGS / Current stock (default)
    header.innerHTML = `<th>Product</th><th>Category</th><th>On Hand</th><th>PAR</th><th>Stock %</th><th>Latest Price</th><th>Stock Value</th><th>Period Spend</th>`;
    const rows = reportType === 'cogs'
        ? [...data].sort((a,b)=>b.totalSpend-a.totalSpend)
        : data;

    tbody.innerHTML = rows.map(p => {
        const pct     = p.stockPct !== null ? p.stockPct : '—';
        const pctColor= p.stockPct === null ? 'var(--neutral-400)' : p.stockPct < 25 ? '#dc2626' : p.stockPct < 50 ? '#d97706' : '#16a34a';
        return `<tr>
          <td style="font-weight:600;">${p.product_name}</td>
          <td><span style="font-size:.7rem;background:var(--primary-100);color:var(--primary-700);padding:.15rem .5rem;border-radius:4px;">${p.category}</span></td>
          <td style="font-family:var(--font-mono);">${p.on_hand.toFixed(1)}</td>
          <td style="font-family:var(--font-mono);color:var(--neutral-500);">${p.par.toFixed(0)}</td>
          <td>
            ${p.stockPct !== null ? `<div style="display:flex;align-items:center;gap:.4rem;">
              <div style="width:60px;height:6px;background:var(--neutral-200);border-radius:3px;overflow:hidden;">
                <div style="height:100%;width:${pct}%;background:${pctColor};"></div>
              </div>
              <span style="font-size:.8rem;font-weight:700;color:${pctColor};">${pct}%</span>
            </div>` : '<span style="color:var(--neutral-400);">—</span>'}
          </td>
          <td style="font-family:var(--font-mono);">$${p.latestPrice.toFixed(2)}</td>
          <td style="font-weight:700;color:var(--success-700);">$${p.stockValue.toFixed(2)}</td>
          <td style="color:var(--accent-700);">$${p.totalSpend.toFixed(2)}</td>
        </tr>`;
    }).join('');
}

let _valChart, _valTrendChart;
function valRenderCharts(data, startStr, endStr, invItems, invMap) {
    // Category donut
    const catTotals = {};
    data.forEach(p => {
        catTotals[p.category] = (catTotals[p.category]||0) + p.stockValue;
    });
    const catLabels = Object.keys(catTotals).sort((a,b)=>catTotals[b]-catTotals[a]).slice(0,8);
    const catValues = catLabels.map(c => catTotals[c]);

    const vc = document.getElementById('valuationChart');
    if (vc) {
        if (_valChart) try { _valChart.destroy(); } catch(e) {}
        _valChart = new Chart(vc, {
            type: 'doughnut',
            data: {
                labels: catLabels,
                datasets: [{ data: catValues, backgroundColor: ['#3b82f6','#dc2626','#16a34a','#f59e0b','#0ea5e9','#ec4899','#a855f7','#64748b'], borderWidth: 2 }]
            },
            options: { responsive: true, plugins: { legend: { position: 'right', labels: { font: {size:11} } } } }
        });
    }

    // Weekly spend trend
    const weekSpend = {};
    (invItems||[]).forEach(item => {
        const inv = invMap.get(item.invoice_id);
        if (!inv || inv.date < startStr || inv.date > endStr) return;
        const d = new Date(inv.date + 'T12:00:00');
        const weekStart = new Date(d);
        weekStart.setDate(d.getDate() - d.getDay());
        const wKey = weekStart.toISOString().split('T')[0];
        const price = item.has_weight ? parseFloat(item.price_per_unit||0) : parseFloat(item.unit_price||0);
        weekSpend[wKey] = (weekSpend[wKey]||0) + price * parseFloat(item.quantity||0);
    });
    const wKeys   = Object.keys(weekSpend).sort();
    const wValues = wKeys.map(k => weekSpend[k]);

    const vtc = document.getElementById('valuationTrendChart');
    if (vtc && wKeys.length) {
        if (_valTrendChart) try { _valTrendChart.destroy(); } catch(e) {}
        _valTrendChart = new Chart(vtc, {
            type: 'bar',
            data: {
                labels: wKeys.map(k => k.substring(5)),
                datasets: [{ label: 'Weekly Spend', data: wValues, backgroundColor: 'rgba(44,88,136,0.7)', borderColor: '#2c5888', borderWidth: 1, borderRadius: 4 }]
            },
            options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { callback: v => '$'+v.toFixed(0) } } } }
        });
    }
}

// Legacy compat
function renderValuationReport(data) { loadValuationReport(); }
function calculateValuationClientSide() { return loadValuationReport(); }
function exportValuationReport() { showAlert('PDF export coming soon', 'info'); }


async function loadBudgetTracking() {
    showLoading(true);
    try {
        const period = document.getElementById('budgetPeriod').value;
        const category = document.getElementById('budgetCategory').value;

        // Call Edge Function
        const { data, error } = await supabaseClient.functions.invoke('track-budget', {
            body: { period, category }
        });

        if (error) throw error;

        renderBudgetTracking(data);

    } catch (error) {
        console.error('Budget tracking error:', error);
        
        // Fallback: Load from budget_settings table
        await loadBudgetClientSide();
    } finally {
        showLoading(false);
    }
}

async function loadBudgetClientSide() {
    const period = document.getElementById('budgetPeriod').value;
    
    // Load budget settings
    const { data: budgets } = await supabaseClient
        .from('budget_settings')
        .select('*')
        .eq('period_type', period);

    // Load actual spending from invoices
    const startDate = new Date();
    if (period === 'weekly') startDate.setDate(startDate.getDate() - 7);
    else if (period === 'monthly') startDate.setMonth(startDate.getMonth() - 1);
    else if (period === 'quarterly') startDate.setMonth(startDate.getMonth() - 3);

    const { data: invoices } = await supabaseClient
        .from('invoices')
        .select('total, category, invoice_date')
        .gte('invoice_date', startDate.toISOString());

    const actualByCategory = {};
    (invoices || []).forEach(inv => {
        const cat = inv.category || 'Uncategorized';
        if (!actualByCategory[cat]) actualByCategory[cat] = 0;
        actualByCategory[cat] += parseFloat(inv.total || 0);
    });

    const results = (budgets || []).map(budget => ({
        category: budget.category,
        budget_amount: parseFloat(budget.amount || 0),
        actual_spend: actualByCategory[budget.category] || 0,
        remaining: parseFloat(budget.amount || 0) - (actualByCategory[budget.category] || 0),
        percent_used: ((actualByCategory[budget.category] || 0) / parseFloat(budget.amount || 1)) * 100
    }));

    const totalBudget = results.reduce((sum, r) => sum + r.budget_amount, 0);
    const totalActual = results.reduce((sum, r) => sum + r.actual_spend, 0);

    renderBudgetTracking({
        summary: {
            total_budget: totalBudget,
            actual_spend: totalActual,
            remaining: totalBudget - totalActual,
            variance: ((totalActual - totalBudget) / totalBudget) * 100
        },
        details: results
    });
}

function renderBudgetTracking(data) {
      // FIX: Add null checks
    const summary = data?.summary || { total_budget: 0, actual_spend: 0, remaining: 0, variance: 0 };
    const details = data?.details || [];
    document.getElementById('budgetTotal').textContent = `$${(summary.total_budget || 0).toFixed(2)}`;
    document.getElementById('budgetActual').textContent = `$${(summary.actual_spend || 0).toFixed(2)}`;
    document.getElementById('budgetRemaining').textContent = `$${(summary.remaining || 0).toFixed(2)}`;
    
    const varianceColor = summary.variance > 0 ? 'var(--error-600)' : 'var(--success-600)';
    const varianceEl = document.getElementById('budgetVariance');
    varianceEl.textContent = `${summary.variance > 0 ? '+' : ''}${(summary.variance || 0).toFixed(1)}%`;
    varianceEl.style.color = varianceColor;

    // Render details table
    const tbody = document.getElementById('budgetDetailsBody');
    tbody.innerHTML = data.details.map(item => {
        const statusColor = item.percent_used > 100 ? 'var(--error-600)' : 
                           item.percent_used > 80 ? '#f59e0b' : 'var(--success-600)';
        const statusIcon = item.percent_used > 100 ? '🔴' : 
                          item.percent_used > 80 ? '🟠' : '🟢';
        
        return `
            <tr>
                <td style="font-weight: 600;">${item.category}</td>
                <td><span class="price-cell">$${item.budget_amount.toFixed(2)}</span></td>
                <td><span class="price-cell">$${item.actual_spend.toFixed(2)}</span></td>
                <td><span class="price-cell" style="color: ${item.remaining < 0 ? 'var(--error-600)' : 'var(--success-600)'};">$${item.remaining.toFixed(2)}</span></td>
                <td><span class="vendor-badge">${item.percent_used.toFixed(1)}%</span></td>
                <td><span class="price-cell">$${(item.actual_spend * 1.1).toFixed(2)}</span></td>
                <td style="color: ${statusColor};">${statusIcon}</td>
            </tr>
        `;
    }).join('');

    // Render chart
    const ctx = document.getElementById('budgetChart');
    if (budgetChart) budgetChart.destroy();
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.details.map(d => d.category),
            datasets: [
                {
                    label: 'Budget',
                    data: data.details.map(d => d.budget_amount),
                    backgroundColor: 'rgba(139, 32, 32, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2
                },
                {
                    label: 'Actual',
                    data: data.details.map(d => d.actual_spend),
                    backgroundColor: 'rgba(34, 197, 94, 0.5)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
}

function openSetBudgetModal() {
    showAlert('Budget configuration modal coming soon', 'info');
}

// ========== VENDOR PERFORMANCE SCORECARD ==========
let vendorScoreChart = null;
let vendorPriceCompChart = null;

async function loadVendorPerformance() {
    showLoading(true);
    try {
        const period = document.getElementById('performancePeriod').value;

        // Call Edge Function
        const { data, error } = await supabaseClient.functions.invoke('vendor-performance', {
            body: { period }
        });

        if (error) throw error;

        renderVendorPerformance(data);

    } catch (error) {
        console.error('Vendor performance error:', error);
        
        // Fallback: Calculate client-side
        await calculateVendorPerformanceClientSide();
    } finally {
        showLoading(false);
    }
}

async function calculateVendorPerformanceClientSide() {
    const period = document.getElementById('performancePeriod')?.value || 'month';
    let startDate = new Date();
    if (period === 'month') startDate.setDate(startDate.getDate() - 30);
    else if (period === 'quarter') startDate.setMonth(startDate.getMonth() - 3);
    else if (period === 'year') startDate.setFullYear(startDate.getFullYear() - 1);

    // Load invoices in period
    const { data: invoices } = await supabaseClient
        .from('invoices')
        .select('vendor, invoice_date, total, quality_rating, delivery_rating')
        .gte('invoice_date', startDate.toISOString());

    // Load vendor budgets from budget_settings table
    const { data: budgets } = await supabaseClient
        .from('budget_settings')
        .select('category, amount')
        .eq('period_type', 'monthly');

    // Create budget map by vendor (using category as vendor name for now)
    const budgetMap = {};
    (budgets || []).forEach(b => {
        budgetMap[b.category] = parseFloat(b.amount || 0);
    });

    // Group by vendor
    const vendorStats = {};
    (invoices || []).forEach(inv => {
        if (!vendorStats[inv.vendor]) {
            vendorStats[inv.vendor] = {
                total_orders: 0,
                total_spend: 0,
                quality_ratings: [],
                delivery_ratings: []
            };
        }
        const stats = vendorStats[inv.vendor];
        stats.total_orders += 1;
        stats.total_spend += parseFloat(inv.total || 0);
        if (inv.quality_rating) stats.quality_ratings.push(inv.quality_rating);
        if (inv.delivery_rating) stats.delivery_ratings.push(inv.delivery_rating);
    });

    const results = Object.entries(vendorStats).map(([vendor, stats]) => {
        return {
            vendor,
            total_orders: stats.total_orders,
            total_spend: stats.total_spend,
            budget: budgetMap[vendor] || 0,
            avg_quality: 0,
            avg_delivery: 0,
            overall_score: 0
        };
    }).sort((a, b) => b.total_spend - a.total_spend);

    renderVendorPerformance({ vendors: results });
}

function renderVendorPerformance(data) {
    const container = document.getElementById('vendorPerformanceCards');
    
    container.innerHTML = data.vendors.map(vendor => {
        // Calculate budget data (you'll need to load this from budget_settings table)
        const vendorBudget = vendor.budget || 0;
        const budgetUsedPercent = vendorBudget > 0 ? (vendor.total_spend / vendorBudget) * 100 : 0;
        const remaining = vendorBudget - vendor.total_spend;
        const budgetStatus = budgetUsedPercent > 100 ? 'Over' : budgetUsedPercent > 80 ? 'Warning' : 'Good';
        const statusColor = budgetUsedPercent > 100 ? 'var(--error-600)' : budgetUsedPercent > 80 ? '#f59e0b' : 'var(--success-600)';

        return `
            <div class="alert-card" style="margin-bottom: 1rem;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 1rem 0;">${vendor.vendor}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Total Spend</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">$${vendor.total_spend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Budget</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${vendorBudget > 0 ? '$' + vendorBudget.toFixed(2) : 'Not Set'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Budget Used</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${statusColor};">${vendorBudget > 0 ? budgetUsedPercent.toFixed(0) + '%' : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Remaining</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${remaining < 0 ? 'var(--error-600)' : 'var(--success-600)'};">${vendorBudget > 0 ? '$' + remaining.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Total Orders</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${vendor.total_orders}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Render chart - Budget vs Actual Spending
    const scoreCtx = document.getElementById('vendorScoreChart');
    if (vendorScoreChart) vendorScoreChart.destroy();
    vendorScoreChart = new Chart(scoreCtx, {
        type: 'bar',
        data: {
            labels: data.vendors.map(v => v.vendor),
            datasets: [
                {
                    label: 'Budget',
                    data: data.vendors.map(v => v.budget || 0),
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderColor: 'rgb(156, 163, 175)',
                    borderWidth: 2
                },
                {
                    label: 'Actual Spend',
                    data: data.vendors.map(v => v.total_spend),
                    backgroundColor: 'rgba(139, 32, 32, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        }
    });
}

function filterVendorPerformance() {
    loadVendorPerformance();
}

// ========== IMAGE GALLERY FUNCTIONS ==========

let PRODUCT_IMAGES = []; // Will be loaded from GitHub automatically
let filteredImages = [];
let imagesLoaded = false;

// Fetch images from GitHub repository automatically
async function fetchImagesFromGitHub() {
    console.log('🔄 Fetching images from GitHub...');
    
    try {
        const response = await fetch('https://api.github.com/repos/pgonzalez2910/jengchi-product-images/contents');
        
        if (!response.ok) {
            throw new Error(`GitHub API error: ${response.status}`);
        }
        
        const files = await response.json();
        console.log('📦 GitHub API response:', files.length, 'items');
        
        // Filter for image files only (.jpg, .png, .jpeg, .gif, .webp)
        PRODUCT_IMAGES = files
            .filter(file => {
                const name = file.name.toLowerCase();
                return name.endsWith('.jpg') || 
                       name.endsWith('.jpeg') || 
                       name.endsWith('.png') || 
                       name.endsWith('.gif') || 
                       name.endsWith('.webp');
            })
            .map(file => file.name)
            .sort(); // Sort alphabetically
        
        console.log('✅ Loaded', PRODUCT_IMAGES.length, 'images from GitHub');
        console.log('📸 Sample images:', PRODUCT_IMAGES.slice(0, 5));
        
        imagesLoaded = true;
        return PRODUCT_IMAGES;
        
    } catch (error) {
        console.error('❌ Error fetching images from GitHub:', error);
        showAlert('⚠️ Could not load images from GitHub. Using cached list.', 'warning');
        
        // Fallback to empty array
        PRODUCT_IMAGES = [];
        imagesLoaded = false;
        return PRODUCT_IMAGES;
    }
}

async function loadImageGallery() {
    console.log('🖼️ loadImageGallery called!');
    
    const container = document.getElementById('imageGalleryGrid');
    const imageCount = document.getElementById('imageCount');
    
    // Show loading message
    if (container) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--primary-600);">
                <div style="font-size: 3rem; margin-bottom: 1rem;">🔄</div>
                <h3>Loading images from GitHub...</h3>
                <p style="color: var(--neutral-600);">Fetching the latest product images</p>
            </div>`;
    }
    
    // Fetch images from GitHub
    await fetchImagesFromGitHub();
    
    console.log('PRODUCT_IMAGES length:', PRODUCT_IMAGES.length);
    filteredImages = [...PRODUCT_IMAGES];
    console.log('filteredImages length:', filteredImages.length);
    
    console.log('About to call renderImageGallery...');
    renderImageGallery();
    console.log('✅ loadImageGallery complete!');
}

function renderImageGallery() {
    console.log('📸 renderImageGallery called!');
    
    const container = document.getElementById('imageGalleryGrid');
    const imageCount = document.getElementById('imageCount');
    
    if (!container) {
        console.error('❌ imageGalleryGrid container not found!');
        return;
    }
    
    console.log('✅ Container found!');
    console.log('Images to render:', filteredImages.length);
    
    if (imageCount) {
        imageCount.textContent = `${filteredImages.length} images`;
    }
    
    if (filteredImages.length === 0) {
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: var(--neutral-500);">
                <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;"></i>
                <h3>No images found</h3>
                <p>Try adjusting your search</p>
            </div>`;
        return;
    }
    
    try {
        const cardsHTML = filteredImages.map(filename => {
            const imageUrl = GITHUB_IMAGE_BASE + filename;
            return `
                <div style="background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1); transition: all 0.2s; cursor: pointer;"
                     onmouseenter="this.style.transform='translateY(-4px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.15)';"
                     onmouseleave="this.style.transform=''; this.style.boxShadow='0 2px 4px rgba(0,0,0,0.1)';"
                     onclick="copyImageFilename('${filename}')">
                    <div style="aspect-ratio: 1; background: #f5f5f5; display: flex; align-items: center; justify-content: center; overflow: hidden;">
                        <img src="${imageUrl}" 
                             alt="${filename}" 
                             onerror="this.src='${PLACEHOLDER_IMAGE}'"
                             loading="lazy"
                             style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="padding: 1rem; text-align: center;">
                        <div style="font-family: monospace; font-size: 0.875rem; font-weight: 600; color: var(--primary-600); word-break: break-all;">
                            ${filename}
                        </div>
                        <div style="margin-top: 0.5rem; font-size: 0.75rem; color: #6b7280;">
                            📋 Click to copy
                        </div>
                    </div>
                </div>`;
        }).join('');
        
        container.innerHTML = cardsHTML;
        console.log('✅ Images rendered successfully!');
        
    } catch (error) {
        console.error('❌ Error rendering images:', error);
        container.innerHTML = `
            <div style="grid-column: 1 / -1; text-align: center; padding: 3rem; color: red;">
                <h3>Error loading images</h3>
                <p>${error.message}</p>
            </div>`;
    }
}

function filterImageGallery() {
    const searchTerm = document.getElementById('imageGallerySearch').value.toLowerCase();
    
    if (searchTerm === '') {
        filteredImages = [...PRODUCT_IMAGES];
    } else {
        filteredImages = PRODUCT_IMAGES.filter(filename => 
            filename.toLowerCase().includes(searchTerm)
        );
    }
    
    renderImageGallery();
}

function copyImageFilename(filename) {
    // Copy to clipboard
    navigator.clipboard.writeText(filename).then(() => {
        showAlert(`✅ Copied: ${filename}`, 'success');
    }).catch(err => {
        console.error('Copy failed:', err);
        showAlert('❌ Failed to copy filename', 'error');
    });
}

// ✅ GLOBAL FUNCTION: Transfer ALL assignments from one user to another
async function transferAllAssignments() {
  const fromUser = document.getElementById('transferFromUser')?.value;
  const toUser = document.getElementById('transferToUser')?.value;

  if (!fromUser || !toUser) {
    showAlert('⚠️ Please select both "From" and "To" users.', 'error');
    return;
  }
  if (fromUser === toUser) {
    showAlert('⚠️ Source and destination must be different.', 'error');
    return;
  }

  if (!confirm(`Transfer ALL products from ${fromUser.toUpperCase()} to ${toUser.toUpperCase()}?`)) return;

  showLoading(true);
  try {
    const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();

    // Update all records where user = fromUser
    const { data, error } = await supabaseClient
      .from('inventory_check')
      .select('product_name')
      .eq('user', fromUser)
      .eq('order_date', dateISO);

    if (error) throw error;

    const count = data.length;
    if (count === 0) {
      showAlert(`ℹ️ No products found for ${fromUser.toUpperCase()}.`, 'info');
      await loadEnhancedCreateOrder();
      return;
    }

    // Perform the update
    const { error: updateError } = await supabaseClient
      .from('inventory_check')
      .update({ user: toUser })
      .eq('user', fromUser)
      .eq('order_date', dateISO);

    if (updateError) throw updateError;

    showAlert(`✅ Successfully transferred ${count} products from ${fromUser.toUpperCase()} to ${toUser.toUpperCase()}.`, 'success');
    await loadEnhancedCreateOrder();
  } catch (error) {
    console.error('Transfer failed:', error);
    showAlert('❌ Transfer failed: ' + (error.message || 'Unknown error'), 'error');
  } finally {
    showLoading(false);
  }
}
// ========== ADD/DELETE PRODUCT FUNCTIONS ==========

// Open Add Product Modal
function openAddProductModal(userType) {
    document.getElementById('addProductModalTitle').textContent = 
        userType === 'julio' ? 'Add Product for Julio' : 'Add Product for Rony';
    document.getElementById('addProductUser').value = userType;
    document.getElementById('addProductForm').reset();
    
    // Show/hide position field based on user type
    const positionGroup = document.getElementById('addProductPositionGroup');
    if (userType === 'rony') {
        positionGroup.style.display = 'block';
        document.getElementById('addProductPosition').required = true;
    } else {
        positionGroup.style.display = 'none';
        document.getElementById('addProductPosition').required = false;
    }
    
    openModal('addProductModal');
}

// Save New Product
// ========== FIXED DELETE FUNCTIONS ==========

// Delete Product from Julio (FIXED VERSION)
// ========== FIXED: Remove Assignment (Don't Delete Product) ==========
// ========== ENHANCED DELETE WITH DEBUGGING ==========
async function deleteProductFromJulio(productName) {
    if (!confirm(`Remove "${productName}" from Julio's list?`)) return;
    
    showLoading(true);
    try {
        console.log('🔍 Original product name:', productName);
        console.log('🔍 Product name length:', productName.length);
        console.log('🔍 Product name (trimmed):', productName.trim());
        
        // STEP 1: Try exact match first
        let { data: rows, error: fetchError } = await supabaseClient
            .from('inventory_management')
            .select('id, product_name, assigned_to')
            .eq('product_name', productName);
        
        if (fetchError) throw fetchError;
        
        console.log('📦 Exact match found:', rows?.length || 0, 'rows');
        
        // STEP 2: If no exact match, try trimmed version
        if (!rows || rows.length === 0) {
            console.log('⚠️ No exact match, trying trimmed version...');
            const trimmedName = productName.trim();
            
            const result = await supabaseClient
                .from('inventory_management')
                .select('id, product_name, assigned_to')
                .eq('product_name', trimmedName);
            
            rows = result.data;
            console.log('📦 Trimmed match found:', rows?.length || 0, 'rows');
        }
        
        // STEP 3: If still no match, do case-insensitive search
        if (!rows || rows.length === 0) {
            console.log('⚠️ No trimmed match, trying case-insensitive search...');
            
            const result = await supabaseClient
                .from('inventory_management')
                .select('id, product_name, assigned_to')
                .ilike('product_name', productName);
            
            rows = result.data;
            console.log('📦 Case-insensitive match found:', rows?.length || 0, 'rows');
            
            if (rows && rows.length > 0) {
                console.log('📋 Actual product names in DB:', rows.map(r => `"${r.product_name}"`));
            }
        }
        
        // STEP 4: If STILL no match, list all products assigned to Julio
        if (!rows || rows.length === 0) {
            console.log('❌ Product not found anywhere! Searching all Julio products...');
            
            const { data: allJulio } = await supabaseClient
                .from('inventory_management')
                .select('product_name, assigned_to');
            
            const julioProducts = allJulio?.filter(p => {
                const assigned = String(p.assigned_to || '').toLowerCase();
                return assigned.includes('julio');
            });
            
            console.log('📋 All Julio products in database:');
            julioProducts?.forEach((p, idx) => {
                console.log(`  ${idx + 1}. "${p.product_name}" (length: ${p.product_name.length})`);
            });
            
            showAlert(`⚠️ Product "${productName}" not found in database. Check console for details.`, 'error');
            return;
        }
        
        console.log('✅ Product found! Processing deletion...');
        
        // Process each matching row
        for (const row of rows) {
            console.log('🔄 Processing row ID:', row.id, 'Product:', row.product_name);
            
            let assignedArray = [];
            if (Array.isArray(row.assigned_to)) {
                assignedArray = row.assigned_to;
            } else if (typeof row.assigned_to === 'string') {
                try {
                    assignedArray = JSON.parse(row.assigned_to);
                } catch (e) {
                    assignedArray = [];
                }
            }
            
            console.log('📋 Current assignments:', assignedArray);
            
            const newAssigned = assignedArray.filter(user => 
                String(user).toLowerCase() !== 'julio'
            );
            
            console.log('📝 New assignments:', newAssigned);
            
            if (newAssigned.length === 0) {
                console.log('🗑️ Deleting row (no assignments left)');
                const { error: deleteError } = await supabaseClient
                    .from('inventory_management')
                    .delete()
                    .eq('id', row.id);
                
                if (deleteError) throw deleteError;
            } else {
                console.log('✏️ Updating assignments');
                const { error: updateError } = await supabaseClient
                    .from('inventory_management')
                    .update({ assigned_to: newAssigned })
                    .eq('id', row.id);
                
                if (updateError) throw updateError;
            }
        }
        
        // Remove from target_inventory
        await supabaseClient
            .from('target_inventory')
            .delete()
            .eq('product_name', productName);
        
        showAlert(`✅ Product removed successfully`, 'success');
        await loadJulioOrders();
        
    } catch (error) {
        console.error('❌ Delete error:', error);
        showAlert('❌ Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// Delete Product from Rony (FIXED VERSION)
// ========== FIXED: Remove Assignment for Rony ==========
async function deleteProductFromRony(productName) {
    if (!confirm(`Remove "${productName}" from Rony's list?\n\nThis will unassign it from Rony but keep the product in the system.`)) return;
    
    showLoading(true);
    try {
        const { data: rows, error: fetchError } = await supabaseClient
            .from('inventory_management')
            .select('id, assigned_to')
            .eq('product_name', productName);
        
        if (fetchError) throw fetchError;
        
        if (!rows || rows.length === 0) {
            showAlert('⚠️ Product not found', 'error');
            return;
        }
        
        for (const row of rows) {
            let assignedArray = [];
            
            try {
                if (Array.isArray(row.assigned_to)) {
                    assignedArray = row.assigned_to;
                } else if (typeof row.assigned_to === 'string') {
                    assignedArray = JSON.parse(row.assigned_to);
                }
            } catch (e) {
                assignedArray = [];
            }
            
            const newAssigned = assignedArray.filter(user => user.toLowerCase() !== 'rony');
            
            if (newAssigned.length === 0) {
                await supabaseClient
                    .from('inventory_management')
                    .delete()
                    .eq('id', row.id);
            } else {
                await supabaseClient
                    .from('inventory_management')
                    .update({ assigned_to: newAssigned })
                    .eq('id', row.id);
            }
        }
        
        showAlert(`✅ ${productName} removed from Rony's list`, 'success');
        
        await supabaseClient
            .from('current_stock')
            .delete()
            .eq('product_name', productName);
        
        await loadRonyOrders();
        
    } catch (error) {
        console.error('❌ Remove assignment error:', error);
        showAlert('❌ Error removing product: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// ========== INVOICE NUMBER VALIDATION ==========
let invoiceNumberTimeout;
let isInvoiceNumberValid = false;

async function validateInvoiceNumber(invoiceNumber) {
    const validationDiv = document.getElementById('invoiceNumberValidation');
    const inputField = document.getElementById('invoiceNumber');
    const submitButton = document.querySelector('#invoiceForm button[type="submit"]');
    
    // Clear previous timeout
    clearTimeout(invoiceNumberTimeout);
    
    // Reset if empty
    if (!invoiceNumber || invoiceNumber.trim() === '') {
        validationDiv.innerHTML = '';
        inputField.style.borderColor = '';
        isInvoiceNumberValid = false;
        if (submitButton) submitButton.disabled = false;
        return;
    }
    
    // Show "checking..." message
    validationDiv.innerHTML = '<span style="color: var(--neutral-500);"><i class="fas fa-spinner fa-spin"></i> Checking...</span>';
    inputField.style.borderColor = 'var(--neutral-400)';
    
    // Debounce: wait 500ms after user stops typing
    invoiceNumberTimeout = setTimeout(async () => {
        try {
            // Check if we're editing an existing invoice
            const editId = document.getElementById('invoiceForm').dataset.editId;
            
            // Query database for existing invoice number
            let query = supabaseClient
                .from('invoices')
                .select('id, vendor, invoice_date')
                .eq('invoice_number', invoiceNumber.trim());
            
            // If editing, exclude the current invoice from the check
            if (editId) {
                query = query.neq('id', editId);
            }
            
            const { data, error } = await query;
            
            if (error) throw error;
            
            if (data && data.length > 0) {
                // ❌ DUPLICATE FOUND
                const existing = data[0];
                isInvoiceNumberValid = false;
                inputField.style.borderColor = 'var(--warning-600)';
                inputField.style.background = 'rgba(220, 38, 38, 0.05)';
                validationDiv.innerHTML = `
                    <div style="color: var(--warning-600); font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Invoice #${invoiceNumber} already exists!
                    </div>
                    <div style="color: var(--neutral-600); font-size: 0.8125rem; margin-top: 0.25rem;">
                        Vendor: ${existing.vendor} • Date: ${formatDate(existing.invoice_date)}
                    </div>
                `;
                
                // Disable submit button
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                    submitButton.style.cursor = 'not-allowed';
                }
                
            } else {
                // ✅ UNIQUE - OK TO PROCEED
                isInvoiceNumberValid = true;
                inputField.style.borderColor = 'var(--success-600)';
                inputField.style.background = 'rgba(16, 185, 129, 0.05)';
                validationDiv.innerHTML = `
                    <span style="color: var(--success-600); font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Invoice number available
                    </span>
                `;
                
                // Enable submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.style.cursor = 'pointer';
                }
            }
            
        } catch (error) {
            console.error('Validation error:', error);
            validationDiv.innerHTML = `
                <span style="color: var(--warning-600);">
                    <i class="fas fa-exclamation-circle"></i> Error checking invoice number
                </span>
            `;
            isInvoiceNumberValid = false;
        }
    }, 500); // Wait 500ms after user stops typing
}




// ========== PDF INVOICE GENERATION (CORPORATE STYLE) ==========
async function generateOrderPDFs() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    const { jsPDF } = window.jspdf;
    
    showLoading(true);
    
    try {
        // Load all orders for this date
        const { data: rows, error } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, tentative, user, vendor, item_code')
            .eq('order_date', dateISO);
        
        if (error) throw error;
        
        if (!rows || rows.length === 0) {
            showAlert('❌ No orders found for this date', 'error');
            return;
        }
        
        // Get product images and prices
        const { data: mgmtData } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url');
        
        const imageMap = new Map();
        (mgmtData || []).forEach(item => {
            imageMap.set(item.product_name, item.image_url);
        });
        
        // Get prices from invoice_items
        const { data: priceData } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, unit_price, price_per_unit, has_weight');
        
        const priceMap = new Map();
        (priceData || []).forEach(item => {
            const key = `${item.product_name}_${item.vendor}`;
            const price = item.has_weight ? item.price_per_unit : item.unit_price;
            priceMap.set(key, parseFloat(price || 0));
        });
        
        // Group by vendor
        const byVendor = {};
        rows.forEach(r => {
            const qty = r.user.toLowerCase() === 'julio' 
                ? Number(r.on_hand || 0) 
                : Number(r.tentative || 0);
            
            if (qty <= 0) return;
            
            const vendor = r.vendor || 'Unknown Vendor';
            if (!byVendor[vendor]) byVendor[vendor] = [];
            
            const priceKey = `${r.product_name}_${vendor}`;
            const unitPrice = priceMap.get(priceKey) || 0;
            
            byVendor[vendor].push({
                product_name: r.product_name,
                item_code: r.item_code || '-------',
                qty: qty,
                unit_price: unitPrice,
                line_total: qty * unitPrice,
                image_url: imageMap.get(r.product_name) || null
            });
        });
        
        const vendors = Object.keys(byVendor);
        if (vendors.length === 0) {
            showAlert('❌ No items with quantity > 0', 'error');
            return;
        }
        
        // Generate PDF for each vendor
        for (const vendor of vendors) {
            await generateVendorPDF(vendor, byVendor[vendor], dateISO);
            await sleep(200); // Delay between PDFs
        }
        
        showAlert(`✅ Generated ${vendors.length} PDF invoice(s)`, 'success');
        
    } catch (error) {
        console.error('PDF generation error:', error);
        showAlert('❌ Error generating PDFs: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Generate individual vendor PDF
async function generateVendorPDF(vendor, items, dateISO) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const M = 42; // margins
    
    // ===== HEADER =====
    let y = M;
    
    // Company logo (left)
    const companyLogo = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg';
    try {
        const logoImg = await toDataUrl(companyLogo);
        if (logoImg.data) {
            doc.addImage(logoImg.data, logoImg.fmt, M, y, 72, 54);
        }
    } catch (e) {
        console.error('Logo load error:', e);
    }
    
    // Vendor logo (right)
    const vendorLogos = {
        'Formosa Foods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
        'North Food Group': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
        'Pacific Plus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
        'Delta Office Products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
        'Supermarket': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg'
    };
    
    if (vendorLogos[vendor]) {
        try {
            const vLogo = await toDataUrl(vendorLogos[vendor]);
            if (vLogo.data) {
                doc.addImage(vLogo.data, vLogo.fmt, pageW - M - 72, y + 6, 72, 42);
            }
        } catch (e) {
            console.error('Vendor logo error:', e);
        }
    }
    
    // Title
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.text('PURCHASE ORDER', pageW / 2, y + 18, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Order Date: ${formatDate(dateISO)}`, pageW / 2, y + 36, { align: 'center' });
    
    y += 70;
    
    // ===== VENDOR INFO BOX =====
    doc.setFillColor(247, 249, 252);
    doc.rect(M, y, pageW - 2*M, 50, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(M, y, pageW - 2*M, 50, 'S');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Vendor:', M + 15, y + 20);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(14);
    doc.text(vendor, M + 15, y + 38);
    
    y += 65;
    
    // ✅ NEW: GROUP ITEMS BY CATEGORY
    const itemsByCategory = {};
    items.forEach(item => {
        const category = item.category || 'Other';
        if (!itemsByCategory[category]) {
            itemsByCategory[category] = [];
        }
        itemsByCategory[category].push(item);
    });
    
    // Sort categories alphabetically
    const categories = Object.keys(itemsByCategory).sort();
    
    // ===== PRODUCT TABLE WITH CATEGORY GROUPING =====
    // Cache product images
    const imgCache = {};
    const uniqueUrls = [...new Set(items.map(r => r.image_url).filter(Boolean))];
    for (const url of uniqueUrls) {
        imgCache[url] = await toDataUrl(url);
    }
    
    const columns = [
        { header: 'Image', dataKey: 'img' },
        { header: 'Item Code', dataKey: 'code' },
        { header: 'Product', dataKey: 'product' },
        { header: 'Qty', dataKey: 'qty' },
        { header: 'Unit Price', dataKey: 'price' },
        { header: 'Total', dataKey: 'total' }
    ];
    
    // Build table body with category headers
    const body = [];
    let grandTotal = 0;
    
    categories.forEach(category => {
        // Add category header row
        body.push({
            img: null,
            code: '',
            product: `━━━ ${category.toUpperCase()} ━━━`,
            qty: '',
            price: '',
            total: '',
            _isCategory: true
        });
        
        // Add items in this category
        const categoryItems = itemsByCategory[category];
        let categoryTotal = 0;
        
        categoryItems.forEach(item => {
            const lineTotal = item.line_total || (item.qty * item.unit_price);
            categoryTotal += lineTotal;
            
            body.push({
                img: item.image_url ? { url: item.image_url } : null,
                code: item.item_code,
                product: item.product_name,
                qty: item.qty.toFixed(2),
                price: '$' + item.unit_price.toFixed(2),
                total: '$' + lineTotal.toFixed(2),
                _isCategory: false
            });
        });
        
        // Add category subtotal
        body.push({
            img: null,
            code: '',
            product: `${category} Subtotal`,
            qty: '',
            price: '',
            total: '$' + categoryTotal.toFixed(2),
            _isSubtotal: true
        });
        
        grandTotal += categoryTotal;
    });
    
    const ink = [17, 24, 39];
    const line = [226, 232, 240];
    const zebra = [247, 249, 252];
    const categoryBg = [59, 130, 246]; // Blue for category headers
    const subtotalBg = [245, 245, 245]; // Light gray for subtotals
    
    doc.autoTable({
        startY: y,
        margin: { left: M, right: M },
        theme: 'grid',
        rowPageBreak: 'auto',
        styles: {
            font: 'helvetica',
            fontSize: 10,
            cellPadding: { top: 6, right: 6, bottom: 6, left: 6 },
            lineColor: line,
            lineWidth: 0.25,
            minCellHeight: 60,
            overflow: 'linebreak'
        },
        headStyles: {
            fillColor: ink,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 11
        },
        alternateRowStyles: { fillColor: zebra },
        columnStyles: {
            img: { cellWidth: 60, halign: 'center' },
            code: { cellWidth: 100, font: 'courier', fontStyle: 'bold' },
            product: { cellWidth: 'auto' },
            qty: { cellWidth: 60, halign: 'right', fontStyle: 'bold' },
            price: { cellWidth: 80, halign: 'right', font: 'courier' },
            total: { cellWidth: 80, halign: 'right', font: 'courier', fontStyle: 'bold' }
        },
        columns,
        body,
        didParseCell: (data) => {
            const row = data.row.raw;
            
            // Category header styling
            if (row._isCategory) {
                data.cell.styles.fillColor = categoryBg;
                data.cell.styles.textColor = [255, 255, 255];
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.fontSize = 11;
                data.cell.styles.minCellHeight = 30;
            }
            
            // Subtotal styling
            if (row._isSubtotal) {
                data.cell.styles.fillColor = subtotalBg;
                data.cell.styles.fontStyle = 'bold';
                data.cell.styles.minCellHeight = 25;
            }
            
            // Clear image text for non-image cells
            if (data.section === 'body' && data.column.dataKey === 'img') {
                data.cell.text = '';
            }
        },
        didDrawCell: (data) => {
            if (data.section === 'body' && data.column.dataKey === 'img') {
                const payload = data.row.raw.img;
                const url = payload?.url;
                const cached = url ? imgCache[url] : null;
                
                if (cached?.data) {
                    const maxW = Math.max(20, data.cell.width - 10);
                    const maxH = Math.max(20, data.cell.height - 10);
                    const size = Math.min(52, maxW, maxH);
                    const x = data.cell.x + (data.cell.width - size) / 2;
                    const yy = data.cell.y + (data.cell.height - size) / 2;
                    
                    try {
                        doc.addImage(cached.data, cached.fmt, x, yy, size, size);
                    } catch (e) {
                        console.error('Image draw error:', e);
                    }
                }
            }
        },
        didDrawPage: () => {
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(99);
            doc.text(`Vendor: ${vendor}`, M, pageH - 14);
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW - M, pageH - 14, { align: 'right' });
        }
    });
    
    // ===== TOTALS SECTION =====
    const finalY = doc.lastAutoTable.finalY + 20;
    
    doc.setFillColor(247, 249, 252);
    doc.rect(pageW - M - 200, finalY, 200, 80, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(pageW - M - 200, finalY, 200, 80, 'S');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('Subtotal:', pageW - M - 185, finalY + 20);
    doc.text('Tax (8.25%):', pageW - M - 185, finalY + 40);
    doc.setFontSize(14);
    doc.text('TOTAL:', pageW - M - 185, finalY + 65);
    
    doc.setFont('courier', 'bold');
    const tax = grandTotal * 0.0825;
    const totalWithTax = grandTotal + tax;
    
    doc.setFontSize(11);
    doc.text('$' + grandTotal.toFixed(2), pageW - M - 15, finalY + 20, { align: 'right' });
    doc.text('$' + tax.toFixed(2), pageW - M - 15, finalY + 40, { align: 'right' });
    doc.setFontSize(14);
    doc.text('$' + totalWithTax.toFixed(2), pageW - M - 15, finalY + 65, { align: 'right' });
    
    // Save PDF
    const safeVendor = vendor.replace(/[^a-zA-Z0-9]/g, '_');
    const safeDate = dateISO.replace(/-/g, '');
    doc.save(`PO_${safeVendor}_${safeDate}.pdf`);
}

// Helper function to convert image URL to base64
async function toDataUrl(url) {
    try {
        const res = await fetch(url);
        const blob = await res.blob();
        return await new Promise(resolve => {
            const fr = new FileReader();
            fr.onloadend = () => resolve({
                data: fr.result,
                fmt: blob.type.includes('png') ? 'PNG' : 'JPEG'
            });
            fr.readAsDataURL(blob);
        });
    } catch (e) {
        console.error('Image load error:', e);
        return { data: null, fmt: 'JPEG' };
    }
}

// Sleep helper
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}


// ── MAIN: GENERATE ALL PDFS ───────────────────────────────────
async function generateAllVendorPDFs() {
    const orderDate = document.getElementById('pdfOrderDate')?.value || todayYMD();
    const resultsDiv = document.getElementById('pdfGenerationResults');

    showLoading(true);
    resultsDiv.innerHTML = `
        <div style="padding:2rem;text-align:center;color:var(--neutral-600);">
            <div class="spinner" style="margin:0 auto 1rem;"></div>
            <p style="font-size:1.1rem;">Building PDFs — please wait…</p>
        </div>`;

    try {
        // ── 1. Load all inventory_check rows for this date ────────────
        const { data: orderData, error: orderErr } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, target, tentative, user, vendor, item_code, image_url, category')
            .eq('order_date', orderDate);

        if (orderErr) throw orderErr;

        if (!orderData || orderData.length === 0) {
            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📦</div>
                    <h3>No orders found for ${formatDate(orderDate)}</h3>
                    <p>Make sure inventory counts have been submitted first.</p>
                </div>`;
            return;
        }

        // ── 2. Load ALL invoice_items + their invoice dates ───────────
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
        const invDateMap = new Map();
        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
        }

        // ── 2b. Also load vendor_prices (for item_code lookups) ───────
        const { data: vendorPricesData } = await supabaseClient
            .from('vendor_prices')
            .select('product_name, vendor, item_code, unit_price')
            .order('last_updated', { ascending: false });

        // vendor_prices maps for item_code resolution only
        const vendorPricesMap    = new Map(); // key: `product_name|vendor`
        const vendorPricesAnyVendor = new Map(); // key: product_name → item_code
        (vendorPricesData || []).forEach(row => {
            if (!row.product_name) return;
            const key = `${row.product_name}|${row.vendor}`;
            if (!vendorPricesMap.has(key)) {
                vendorPricesMap.set(key, { item_code: row.item_code || '', unit_price: parseFloat(row.unit_price || 0) });
            }
            if (!vendorPricesAnyVendor.has(row.product_name) && row.item_code) {
                vendorPricesAnyVendor.set(row.product_name, row.item_code);
            }
        });

        // ── 2c. Build price maps keyed by item_code ───────────────────
        // Primary key: `item_code|vendor`  Secondary key: `item_code` (any vendor)
        // For each key we keep the LATEST 2026 date, falling back to latest 2025 date.
        const priceByCode = new Map();       // `item_code|vendor` → { price, date, year }
        const priceByCodeAny = new Map();    // `item_code`        → { price, date, year }

        // Also name-based maps for items without item_codes
        const latestPriceMap = new Map();    // `product_name|vendor` → { price, date, item_code }
        const itemCodeByName = new Map();    // product_name → item_code (any year)

        (invoiceItems || []).forEach(item => {
            // Always capture item_code by product_name (name-based fallback)
            if (item.item_code && item.product_name && !itemCodeByName.has(item.product_name)) {
                itemCodeByName.set(item.product_name, item.item_code);
            }

            const invDate = invDateMap.get(item.invoice_id);
            if (!invDate) return;

            const invYear = new Date(invDate).getFullYear();
            if (invYear !== 2026 && invYear !== 2025) return; // only use 2025+2026 data

            const price = item.has_weight
                ? parseFloat(item.price_per_unit || 0)
                : parseFloat(item.unit_price || 0);
            if (!price) return;

            // ── name-based map (2026 only, for name-matched products) ──
            if (invYear === 2026) {
                const nameKey = `${item.product_name}|${item.vendor}`;
                const ex = latestPriceMap.get(nameKey);
                if (!ex || new Date(invDate) > new Date(ex.date)) {
                    latestPriceMap.set(nameKey, { price, date: invDate, item_code: item.item_code });
                }
            }

            // ── item_code-based maps (2026 beats 2025, latest date wins within year) ──
            if (item.item_code) {
                // by item_code + vendor
                const codeVendorKey = `${item.item_code}|${item.vendor}`;
                const exCV = priceByCode.get(codeVendorKey);
                const betterCV = !exCV
                    || (invYear === 2026 && exCV.year === 2025)
                    || (invYear === exCV.year && new Date(invDate) > new Date(exCV.date));
                if (betterCV) priceByCode.set(codeVendorKey, { price, date: invDate, year: invYear });

                // by item_code only (any vendor)
                const exC = priceByCodeAny.get(item.item_code);
                const betterC = !exC
                    || (invYear === 2026 && exC.year === 2025)
                    || (invYear === exC.year && new Date(invDate) > new Date(exC.date));
                if (betterC) priceByCodeAny.set(item.item_code, { price, date: invDate, year: invYear });
            }
        });

        // ── 3. Filter rows that have a qty > 0 and a vendor ──────────
        const rowsWithQty = orderData.filter(row => {
            const qty = (row.user || '').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || row.target || 0)
                : parseFloat(row.tentative || 0);
            return qty > 0 && row.vendor;
        });

        if (rowsWithQty.length === 0) {
            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">📋</div>
                    <h3>No items with quantities and vendors assigned</h3>
                    <p>Set quantities and select vendors in the Create Order tab first.</p>
                </div>`;
            return;
        }

        // ── 4. Group by vendor ────────────────────────────────────────
        const byVendor = {};
        rowsWithQty.forEach(row => {
            const qty = (row.user || '').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || row.target || 0)
                : parseFloat(row.tentative || 0);

            // ── Resolve item_code first (5-level chain) ───────────────
            const priceKey = `${row.product_name}|${row.vendor}`;
            const vpEntry   = vendorPricesMap.get(priceKey);
            const nameEntry = latestPriceMap.get(priceKey);   // 2026 name-match

            const resolvedCode = row.item_code
                || vpEntry?.item_code
                || (nameEntry ? nameEntry.item_code : '')
                || itemCodeByName.get(row.product_name)
                || vendorPricesAnyVendor.get(row.product_name)
                || '';

            // ── Resolve price via item_code (2026 → 2025) ────────────
            // Priority:
            //   1. item_code + vendor  (invoice, 2026 beats 2025)
            //   2. item_code any vendor (invoice, 2026 beats 2025)
            //   3. product_name + vendor (2026 invoice, name-match)
            //   4. vendor_prices table
            let unitPrice = 0;
            if (resolvedCode) {
                const cv = priceByCode.get(`${resolvedCode}|${row.vendor}`);
                const ca = priceByCodeAny.get(resolvedCode);
                unitPrice = cv?.price || ca?.price || 0;
            }
            if (!unitPrice) {
                unitPrice = nameEntry?.price || vpEntry?.unit_price || 0;
            }

            if (!byVendor[row.vendor]) byVendor[row.vendor] = [];
            byVendor[row.vendor].push({
                product_name: row.product_name,
                item_code:    resolvedCode,
                qty:          qty,
                unit_price:   unitPrice,
                line_total:   qty * unitPrice,
                image_url:    row.image_url || null,
                category:     row.category || 'Other',  // ✅ Add category field
            });
        });

        // ── 5. Pre-fetch all images concurrently ──────────────────────
        const companyLogoB64 = await fetchImageBase64(COMPANY_LOGO_URL);

        // ── 6. Generate one PDF per vendor ────────────────────────────
        const pdfResults = [];
        const vendors = Object.keys(byVendor).sort();

        for (const vendor of vendors) {
            const items = byVendor[vendor];
            const vendorLogoB64 = await fetchImageBase64(VENDOR_LOGO_URLS[vendor] || null);

            // Pre-fetch product images
            for (const item of items) {
                item._imageB64 = await fetchImageBase64(
                    item.image_url
                        ? (item.image_url.startsWith('http') ? item.image_url : GITHUB_IMAGE_BASE + item.image_url)
                        : null
                );
            }

            const result = await buildVendorPDF(
                vendor, items, orderDate,
                companyLogoB64, vendorLogoB64
            );
            pdfResults.push(result);
        }

        // ── 7. Render download links ──────────────────────────────────
        renderPDFResults(resultsDiv, pdfResults, orderDate);
        showAlert(`✅ ${pdfResults.length} PDF(s) generated!`, 'success');

    } catch (err) {
        console.error('PDF generation error:', err);
        showAlert('❌ PDF generation failed: ' + err.message, 'error');
        resultsDiv.innerHTML = `<div class="alert alert-error">❌ Error: ${err.message}</div>`;
    } finally {
        showLoading(false);
    }
}


// ── GENERATE UNIQUE-LOOKING INVOICE NUMBER (e.g. KZQ47821) ───
function generateInvoiceNumber() {
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // no I/O to avoid confusion
    let prefix = '';
    for (let i = 0; i < 3; i++) {
        prefix += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    const digits = String(Math.floor(10000 + Math.random() * 90000)); // 5 digits
    return prefix + digits;
}

// ── BUILD A SINGLE VENDOR PDF ─────────────────────────────────
async function buildVendorPDF(vendor, items, orderDate, companyLogoB64, vendorLogoB64) {
    // jsPDF must be loaded via CDN in the HTML head:
  

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter', orientation: 'portrait' });

    const PW = doc.internal.pageSize.getWidth();   // 612
    const PH = doc.internal.pageSize.getHeight();  // 792
    const ML = 36, MR = 36, MT = 36;

    const NAVY   = [10, 22, 40];
    const GOLD   = [245, 158, 11];
    const WHITE  = [255, 255, 255];
    const LGRAY  = [245, 245, 245];
    const MGRAY  = [200, 200, 200];
    const GREEN  = [5, 150, 105];
    const RED    = [220, 38, 38];

    // ── HEADER BAND — WHITE BACKGROUND ───────────────────────
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, PW, 100, 'F');

    // Thin bottom border line under header
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(0, 100, PW, 100);

    // Gold accent bar at bottom of header
    doc.setFillColor(245, 158, 11);
    doc.rect(0, 97, PW, 4, 'F');

    // Company logo (left inside header) — contained, no overlap
    if (companyLogoB64) {
        try { doc.addImage(companyLogoB64, 'JPEG', ML, 8, 88, 62); } catch (e) {}
    } else {
        doc.setFontSize(18).setTextColor(10, 22, 40).setFont('helvetica', 'bold');
        doc.text('JENG CHI', ML + 5, 48);
    }

    // Vendor logo (right inside header) — contained, no overlap
    if (vendorLogoB64) {
        try { doc.addImage(vendorLogoB64, 'JPEG', PW - MR - 95, 12, 95, 58, undefined, 'FAST'); } catch (e) {}
    }

    // Centre: title + date + email
    doc.setTextColor(10, 22, 40);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('ORDER REQUEST', PW / 2, 34, { align: 'center' });
    doc.setFontSize(10).setFont('helvetica', 'normal');
    doc.text(`Order Date: ${formatDate(orderDate)}`, PW / 2, 52, { align: 'center' });
    doc.setFontSize(8.5).setTextColor(80, 80, 80);
    doc.text('admin@jengchirestaurant.com', PW / 2, 67, { align: 'center' });

    // Invoice number — random 3-letter + 5-digit (e.g. KZQ47821)
    const invNum = generateInvoiceNumber();
    doc.setFontSize(8.5).setTextColor(10, 22, 40).setFont('helvetica', 'bold');
    doc.text(`Ref #: ${invNum}`, PW / 2, 82, { align: 'center' });

    // ── VENDOR INFO STRIPE ────────────────────────────────────
    let y = 114;
    doc.setFillColor(245, 245, 245);
    doc.rect(ML, y, PW - ML - MR, 30, 'F');
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.rect(ML, y, PW - ML - MR, 30, 'S');

    doc.setFillColor(10, 22, 40);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('VENDOR:', ML + 12, y + 19);
    doc.setFont('helvetica', 'normal').setFontSize(13);
    doc.text(vendor, ML + 62, y + 19);

    y += 44;

    // ── PRODUCT TABLE ─────────────────────────────────────────
    // Columns: Image | Item Code | Product Name | Qty | Unit Price | Line Total
    const IMG_W   = 50;
    const CODE_W  = 72;
    const QTY_W   = 42;
    const PRICE_W = 62;
    const TOT_W   = 78;
    const NAME_W  = PW - ML - MR - IMG_W - CODE_W - QTY_W - PRICE_W - TOT_W;
    const ROW_H   = 58;
    const HEADER_H = 24;

    // Table header
    const drawTableHeader = (startY) => {
        doc.setFillColor(10, 22, 40);
        doc.rect(ML, startY, PW - ML - MR, HEADER_H, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8.5);
        const cols = [
            { label: 'Image',      x: ML + IMG_W / 2,                                 align: 'center' },
            { label: 'Item Code',  x: ML + IMG_W + CODE_W / 2,                        align: 'center' },
            { label: 'Product',    x: ML + IMG_W + CODE_W + NAME_W / 2,               align: 'center' },
            { label: 'Qty',        x: ML + IMG_W + CODE_W + NAME_W + QTY_W / 2,       align: 'center' },
            { label: 'Unit Price', x: ML + IMG_W + CODE_W + NAME_W + QTY_W + PRICE_W / 2, align: 'center' },
            { label: 'Total',      x: ML + IMG_W + CODE_W + NAME_W + QTY_W + PRICE_W + TOT_W / 2, align: 'center' },
        ];
        cols.forEach(col => doc.text(col.label, col.x, startY + 16, { align: col.align }));
        return startY + HEADER_H;
    };

    let tableY = drawTableHeader(y);

    // Draw rows
    let subtotal = 0;
    const usedPageH = PH - 36; // bottom margin

    for (let i = 0; i < items.length; i++) {
        const item = items[i];

        // Page break check
        if (tableY + ROW_H > usedPageH) {
            // Footer on current page
            drawPageFooter(doc, vendor, orderDate, PW, PH, MR);
            doc.addPage();
            y = MT;
            tableY = drawTableHeader(y);
        }

    const rowColor = i % 2 === 0 ? WHITE : LGRAY;
        doc.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
        doc.rect(ML, tableY, PW - ML - MR, ROW_H, 'F');
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.rect(ML, tableY, PW - ML - MR, ROW_H, 'S');

        // Vertical dividers
        let divX = ML + IMG_W;
        [CODE_W, NAME_W, QTY_W, PRICE_W, TOT_W].forEach(w => {
            doc.line(divX, tableY, divX, tableY + ROW_H);
            divX += w;
        });

        // Product image
        if (item._imageB64) {
            try {
                const imgSize = 44;
                doc.addImage(
                    item._imageB64, 'JPEG',
                    ML + (IMG_W - imgSize) / 2,
                    tableY + (ROW_H - imgSize) / 2,
                    imgSize, imgSize
                );
            } catch (e) {}
        } else {
            // Placeholder box
            doc.setFillColor(220, 220, 220);
            doc.rect(ML + 3, tableY + 7, 44, 44, 'F');
            doc.setFontSize(7).setTextColor(150, 150, 150).setFont('helvetica', 'italic');
            doc.text('No img', ML + 25, tableY + 32, { align: 'center' });
        }

        // Column x positions
        let cx = ML + IMG_W;

        const cellText = (text, width, align = 'left', bold = false) => {
            doc.setTextColor(10, 22, 40);
            doc.setFont('helvetica', bold ? 'bold' : 'normal');
            const pad = 5;
            const tx = align === 'center' ? cx + width / 2
                      : align === 'right'  ? cx + width - pad
                      : cx + pad;
            // Word-wrap for name column
            const maxW = width - 2 * pad;
            const lines = doc.splitTextToSize(String(text), maxW);
            const lineH = 11;
            const totalH = lines.length * lineH;
            const startTy = tableY + (ROW_H - totalH) / 2 + 9;
            lines.forEach((line, li) => {
                doc.text(line, tx, startTy + li * lineH, { align });
            });
            cx += width;
        };

        // Item code
        doc.setFontSize(8);
        doc.setFont('courier', 'bold');
        doc.setTextColor(10, 22, 40);
        const code = item.item_code || '—';
        doc.text(code, ML + IMG_W + CODE_W / 2, tableY + ROW_H / 2 + 4, { align: 'center' });
        cx = ML + IMG_W + CODE_W;

        // Product name
        doc.setFontSize(8.5).setFont('helvetica', 'normal');
        cellText(item.product_name, NAME_W, 'left');

        // Qty
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(10, 22, 40);
        doc.text(item.qty.toFixed(2), cx + QTY_W / 2, tableY + ROW_H / 2 + 4, { align: 'center' });
        cx += QTY_W;

        // Unit Price
        doc.setFontSize(9).setFont('courier', 'normal');
        const priceStr = item.unit_price > 0 ? `$${item.unit_price.toFixed(2)}` : '—';
        doc.text(priceStr, cx + PRICE_W - 6, tableY + ROW_H / 2 + 4, { align: 'right' });
        cx += PRICE_W;

        // Line total — no tax added
        doc.setTextColor(5, 150, 105);
        doc.setFont('courier', 'bold');
        doc.setFontSize(10);
        doc.text(`$${item.line_total.toFixed(2)}`, cx + TOT_W - 6, tableY + ROW_H / 2 + 4, { align: 'right' });

        subtotal   += item.line_total;
        tableY += ROW_H;
    }

    // ── TOTALS BOX ────────────────────────────────────────────
    const taxRule2 = VENDOR_TAX_RULES[vendor] || { taxAll: false };
    const hasTax = taxRule2.taxAll || (taxRule2.taxableItemCodes && taxRule2.taxableItemCodes.length > 0);

    // Calculate tax amount
    let totalTaxAmount = 0;
    if (hasTax) {
        items.forEach(item => {
            totalTaxAmount += calcLineTax(vendor, item.item_code, item.line_total);
        });
    }
    const grandTotal = subtotal + totalTaxAmount;

    const TOTBOX_W = 220;
    const showTaxRow = totalTaxAmount > 0;  // only show tax row if there's actual tax
    const TOTBOX_H = showTaxRow ? 72 : 52;

    // Page break check for totals
    if (tableY + TOTBOX_H + 20 > usedPageH) {
        drawPageFooter(doc, vendor, orderDate, PW, PH, MR);
        doc.addPage();
        tableY = MT;
    }

    tableY += 16;
    const totX = PW - MR - TOTBOX_W;

 doc.setFillColor(245, 245, 245);
 doc.rect(totX, tableY, TOTBOX_W, TOTBOX_H, 'F');
   doc.setDrawColor(200, 200, 200);
    doc.rect(totX, tableY, TOTBOX_W, TOTBOX_H, 'S');

    const totRow = (label, value, color, fontSize = 10, bold = false, ty) => {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.setTextColor(10, 22, 40);
        doc.text(label, totX + 12, ty);
        doc.setFont('courier', bold ? 'bold' : 'normal');
        doc.setTextColor(color[0], color[1], color[2]);
        doc.text(value, totX + TOTBOX_W - 12, ty, { align: 'right' });
    };

    let tr = tableY + 18;
    totRow('Subtotal:', `$${subtotal.toFixed(2)}`, NAVY, 10, false, tr);
    tr += 20;
    if (showTaxRow) {
        totRow('Tax (8.25%):', `$${totalTaxAmount.toFixed(2)}`, RED, 10, false, tr);
        tr += 20;
    }
    // Separator line
    doc.setFillColor(10, 22, 40);
    doc.setLineWidth(1);
    doc.line(totX + 8, tr - 6, totX + TOTBOX_W - 8, tr - 6);
    totRow('GRAND TOTAL:', `$${grandTotal.toFixed(2)}`, GREEN, 13, true, tr);

    // Item count summary
    tableY += TOTBOX_H + 12;
    doc.setFontSize(9).setFont('helvetica', 'italic').setTextColor(100, 100, 100);
    doc.text(`${items.length} line item${items.length !== 1 ? 's' : ''} on this order`, ML, tableY);

    // ── FOOTER ────────────────────────────────────────────────
    drawPageFooter(doc, vendor, orderDate, PW, PH, MR);

    // ── SAVE ──────────────────────────────────────────────────
    const safeVendor = vendor.replace(/[^a-zA-Z0-9]/g, '_');
    const safeDate   = orderDate.replace(/-/g, '');
    const fileName   = `PO_${safeVendor}_${safeDate}.pdf`;

    const blobUrl = doc.output('bloburl');
    return { vendor, fileName, blobUrl, itemCount: items.length, grandTotal, subtotal, totalTax: totalTaxAmount };
}

// ── PAGE FOOTER ───────────────────────────────────────────────
function drawPageFooter(doc, vendor, orderDate, PW, PH, MR) {
    const NAVY = [10, 22, 40];
    const GOLD = [245, 158, 11];
doc.setFillColor(245, 158, 11);
    doc.rect(0, PH - 42, PW, 3, 'F');
    doc.setFillColor(10, 22, 40);
    doc.rect(0, PH - 39, PW, 39, 'F');

    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    doc.text('JENG CHI RESTAURANT  •  Order Request', 40, PH - 24);
    doc.text(`${vendor}  •  ${formatDate(orderDate)}`, PW - MR, PH - 24, { align: 'right' });
    doc.text(
        `Page ${doc.internal.getNumberOfPages()}`,
        PW / 2, PH - 24, { align: 'center' }
    );

    // Disclaimer line
    doc.setFontSize(6.5).setTextColor(180, 180, 180);
    doc.text(
        'ORDER REQUEST: This document is issued by Jeng Chi Restaurant to the vendor listed above and represents a request to place an order. ' +
        'It is not an invoice. Prices shown are based on current vendor pricing and may be subject to change. ' +
        'Please confirm availability and final pricing. Questions? Contact admin@jengchirestaurant.com.',
        PW / 2, PH - 9, { align: 'center', maxWidth: PW - 80 }
    );
}

// ── RENDER DOWNLOAD UI ────────────────────────────────────────
function renderPDFResults(container, results, orderDate) {
    const NAVY = 'var(--primary-900)';
    const html = `
        <div style="background:white;border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;margin-top:1rem;">
            <!-- Header -->
            <div style="background:${NAVY};padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:white;font-size:1.375rem;margin:0;display:flex;align-items:center;gap:0.75rem;">
                    <i class="fas fa-file-pdf"></i>
                    ${results.length} Order Request PDF${results.length !== 1 ? 's' : ''} Ready
                </h3>
                <button onclick="downloadAllPDFsNew()" class="btn" style="background:var(--accent-500);color:white;padding:0.75rem 1.5rem;font-size:0.9375rem;">
                    <i class="fas fa-download"></i> Download All
                </button>
            </div>

            <!-- Cards -->
            <div style="padding:1.5rem;display:grid;gap:1rem;">
                ${results.map((r, idx) => `
                    <div style="display:flex;justify-content:space-between;align-items:center;
                                padding:1.25rem 1.5rem;background:var(--neutral-50);
                                border-radius:10px;border:2px solid var(--neutral-200);">
                        <div>
                            <div style="font-weight:700;font-size:1.125rem;color:var(--neutral-900);margin-bottom:0.3rem;">
                                ${r.vendor}
                            </div>
                            <div style="font-size:0.875rem;color:var(--neutral-600);">
                                ${r.itemCount} items &nbsp;•&nbsp;
                                Subtotal: <strong>$${r.subtotal.toFixed(2)}</strong>
                                ${r.totalTax > 0 ? `&nbsp;•&nbsp; Tax: <strong style="color:#dc2626;">$${r.totalTax.toFixed(2)}</strong>` : ''}
                                &nbsp;•&nbsp;
                                <strong style="color:var(--success-600);font-family:var(--font-mono);">
                                    Total: $${r.grandTotal.toFixed(2)}
                                </strong>
                            </div>
                        </div>
                        <a href="${r.blobUrl}" download="${r.fileName}"
                           class="btn btn-success" style="text-decoration:none;white-space:nowrap;">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>`).join('')}
            </div>

            <!-- Grand summary -->
            <div style="padding:1.5rem 2rem;border-top:2px solid var(--neutral-200);
                        background:var(--neutral-50);display:flex;justify-content:flex-end;">
                <div style="text-align:right;">
                    <div style="font-size:0.875rem;color:var(--neutral-600);margin-bottom:0.25rem;">Combined Grand Total</div>
                    <div style="font-size:2rem;font-weight:700;font-family:var(--font-mono);color:var(--success-600);">
                        $${results.reduce((s, r) => s + r.grandTotal, 0).toFixed(2)}
                    </div>
                </div>
            </div>
        </div>`;

    container.innerHTML = html;
    // Store for "Download All" button
    window._generatedPDFsNew = results;
}


function downloadAllPDFsNew() {
    const pdfs = window._generatedPDFsNew || [];
    if (!pdfs.length) { showAlert('No PDFs to download', 'error'); return; }
    pdfs.forEach((pdf, i) => {
        setTimeout(() => {
            const a = document.createElement('a');
            a.href = pdf.blobUrl;
            a.download = pdf.fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }, i * 600);
    });
    showAlert(`📥 Downloading ${pdfs.length} PDFs…`, 'success');
}



// Download all PDFs at once
function downloadAllPDFs() {
    if (!window.generatedPDFs || window.generatedPDFs.length === 0) {
        showAlert('No PDFs to download', 'error');
        return;
    }
    
    window.generatedPDFs.forEach((pdf, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = pdf.url;
            link.download = pdf.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, index * 500); // Stagger downloads by 500ms
    });
    
    showAlert(`📥 Downloading ${window.generatedPDFs.length} PDF(s)...`, 'success');
}

// Initialize PDF date to today
document.addEventListener('DOMContentLoaded', () => {
    const pdfDateInput = document.getElementById('pdfOrderDate');
    if (pdfDateInput) {
        pdfDateInput.value = todayYMD();
    }
});



// Client-side HTML to PDF conversion (fallback)
async function generatePDFFromHTML(html, vendor, orderDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        unit: 'pt',
        format: 'letter'
    });
    
    // Create temporary div
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    tempDiv.style.width = '8.5in';
    tempDiv.style.padding = '0.5in';
    document.body.appendChild(tempDiv);
    
    try {
        await doc.html(tempDiv, {
            callback: function (doc) {
                // Clean up
                document.body.removeChild(tempDiv);
            },
            x: 0,
            y: 0,
            width: 612, // Letter width in pts
            windowWidth: 816 // 8.5in * 96dpi
        });
        
        // Convert to blob URL
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        return pdfUrl;
    } catch (error) {
        document.body.removeChild(tempDiv);
        throw error;
    }
}

// Initialize PDF date to today
document.addEventListener('DOMContentLoaded', () => {
    const pdfDateInput = document.getElementById('pdfOrderDate');
    if (pdfDateInput) {
        pdfDateInput.value = todayYMD();
    }
});

// ========== EDIT ORDER TAB FUNCTIONS ==========
async function loadEditOrder() {
    const dateISO = document.getElementById('editOrderDate').value || todayYMD();
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO);
        if (error) throw error;

        const submitted = (data || []).filter(r => r.tentative > 0 || r.vendor);
        const unsubmitted = (data || []).filter(r => !r.tentative && !r.vendor);

        document.getElementById('submittedCount').textContent = submitted.length;
        document.getElementById('unsubmittedCount').textContent = unsubmitted.length;

        renderEditOrderTable('submittedOrdersBody', submitted);
        renderEditOrderTable('unsubmittedProductsBody', unsubmitted);
    } catch (error) {
        showAlert('Error loading order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function renderEditOrderTable(tbodyId, rows) {
    const tbody = document.getElementById(tbodyId);
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--neutral-500);">No items</td></tr>';
        return;
    }
    tbody.innerHTML = rows.map(row => {
        const imageUrl = resolveImage(row.image_url);
        const productId = (row.product_name || '').replace(/[^a-zA-Z0-9]/g, '_');
        return `
            <tr>
                <td><img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
                    style="width:60px;height:60px;object-fit:cover;border-radius:6px;"></td>
                <td><span class="item-number">${row.item_code || '—'}</span></td>
                <td style="font-weight:600;">${row.product_name}</td>
                <td>
                    <input type="number" value="${row.tentative || ''}" min="0" step="0.01"
                           placeholder="0"
                           onblur="updateTentative('${row.id}', this.value)"
                           class="search-input" style="width:90px;text-align:center;font-family:var(--font-mono);font-weight:700;">
                </td>
                <td>
                    <select onchange="selectVendorAndUpdateItemCode('${row.id}','${(row.product_name||'').replace(/'/g,"&#39;")}',this.value)"
                            class="search-input" style="min-width:160px;">
                        <option value="">— Select —</option>
                        ${['Pacific Plus','Formosa Foods','North Food Group','BakeMark','Autochlor','Delta Office Products']
                            .map(v => `<option value="${v}" ${row.vendor===v?'selected':''}>${v}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <button class="btn btn-danger btn-icon" onclick="deleteProductFromPlaceOrder('${row.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    }).join('');
}

async function updateEditedOrder() {
    showAlert('✅ All edits are auto-saved as you type. No additional action needed.', 'success');
}

// ========== FINAL ORDER TAB FUNCTIONS ==========
async function loadFinalOrderPreview() {
    const dateISO = document.getElementById('finalOrderDate').value || todayYMD();
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO);
        if (error) throw error;

        const byVendor = {};
        (data || []).forEach(row => {
            const qty = (row.user||'').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || 0)
                : parseFloat(row.tentative || 0);
            if (qty <= 0 || !row.vendor) return;
            if (!byVendor[row.vendor]) byVendor[row.vendor] = [];
            byVendor[row.vendor].push({ ...row, displayQty: qty });
        });

        const container = document.getElementById('vendorSummaryContainer');
        if (Object.keys(byVendor).length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">📋</div><h3>No items with quantities assigned to vendors</h3></div>`;
            return;
        }

        container.innerHTML = Object.entries(byVendor).map(([vendor, items]) => `
            <div class="vendor-card" style="margin-bottom:2rem;">
                <div class="vendor-card-header">
                    <div>
                        <div class="vendor-card-title">${vendor}</div>
                        <div style="color:var(--neutral-600);margin-top:0.5rem;">${items.length} items</div>
                    </div>
                    <div class="vendor-total-card">
                        <div class="vendor-total-label">Items to Order</div>
                        <div class="vendor-total-value">${items.length}</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead><tr><th>Item Code</th><th>Product</th><th>Qty</th><th>User</th></tr></thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><span class="item-number">${item.item_code||'—'}</span></td>
                                <td>${item.product_name}</td>
                                <td><span class="price-cell">${item.displayQty.toFixed(2)}</span></td>
                                <td>${item.user}</td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`).join('');
    } catch (error) {
        showAlert('Error loading preview: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

async function generateFinalPDFs() {
    const dateISO = document.getElementById('finalOrderDate').value || todayYMD();
    const pdfInput = document.getElementById('pdfOrderDate');
    if (pdfInput) pdfInput.value = dateISO;
    await generateAllVendorPDFs();
}






// ========== SAFE STRING ESCAPE FOR HTML ATTRIBUTES ==========
function escAttr(str) {
    return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}



// ========== ADD THIS NEW FUNCTION (place it before initializeEnhancedPlaceOrder) ==========
async function syncInventoryCheck(dateISO) {
    try {
        console.log('🔄 Syncing inventory_check for date:', dateISO);

        // 1. Load all products from inventory_management
        const { data: mgmtProducts, error: mgmtError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, par, position, assigned_to');

        if (mgmtError) throw mgmtError;

        // 2. Load Rony's stock counts for this date
        const { data: stockData, error: stockError } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock')
            .eq('stock_date', dateISO);

        if (stockError) throw stockError;

        // 3. Load Julio's targets for this date
        const { data: targetData, error: targetError } = await supabaseClient
            .from('target_inventory')
            .select('product_name, target_quantity')
            .eq('order_date', dateISO);

        if (targetError) throw targetError;

        // 4. Build lookup maps
        const stockMap = new Map();
        (stockData || []).forEach(s => stockMap.set(s.product_name, s.quantity_in_stock));

        const targetMap = new Map();
        (targetData || []).forEach(t => targetMap.set(t.product_name, t.target_quantity));

        console.log('📦 Stock entries:', stockMap.size, '| Target entries:', targetMap.size);

        // 5. Build upsert rows
        const rows = [];

        // ✅ Track seen product+user combos to avoid duplicates
        const seen = new Set();

        (mgmtProducts || []).forEach(product => {
            const name = product.product_name || '';
            if (!name) return;

            // ✅ FIXED: Handle assigned_to as plain STRING (e.g. 'Rony') 
            // OR array OR JSON string
            let assignedArray = [];
            const raw = product.assigned_to;

            if (Array.isArray(raw)) {
                assignedArray = raw;
            } else if (typeof raw === 'string') {
                const trimmed = raw.trim();
                // Try JSON parse first
                if (trimmed.startsWith('[')) {
                    try {
                        const parsed = JSON.parse(trimmed);
                        assignedArray = Array.isArray(parsed) ? parsed : [trimmed];
                    } catch (e) {
                        assignedArray = [trimmed];
                    }
                } else {
                    // Plain string like 'Rony' or 'Julio'
                    assignedArray = [trimmed];
                }
            }

         assignedArray.forEach(user => {
    const userNormalized = normalizeUser(user);
    
    // ✅ Skip null/unrecognized users — won't violate constraint
    if (!userNormalized) return;

    // ✅ Skip duplicates
    const key = `${name}__${userNormalized}`;
    if (seen.has(key)) return;
    seen.add(key);

    let on_hand = 0;
    let target = 0;

    const userLower = userNormalized.toLowerCase();

    if (userLower === 'rony') {
        on_hand = parseFloat(stockMap.get(name) || 0);
        target = parseFloat(product.par || 0);
    } else if (userLower === 'julio') {
        on_hand = parseFloat(targetMap.get(name) || 0);
        target = parseFloat(targetMap.get(name) || 0);
    } else if (userLower === 'office') {
        on_hand = parseFloat(stockMap.get(name) || targetMap.get(name) || 0);
        target = parseFloat(product.par || 0);
    }

    rows.push({
        order_date: dateISO,
        product_name: name,
        user: userNormalized,  // ✅ Always 'Rony', 'Julio', or 'Office'
        on_hand: on_hand,
        target: target,
        image_url: product.image_url || null
    });
});
        });

        console.log('📝 Rows to upsert into inventory_check:', rows.length);

        if (rows.length === 0) {
            console.log('⚠️ No products found to sync');
            return 0;
        }

        // 6. Upsert in batches — INSERT new rows, skip existing ones to preserve
        //    any saved tentative/vendor/item_code the user already entered
        const batchSize = 50;
        for (let i = 0; i < rows.length; i += batchSize) {
            const batch = rows.slice(i, i + batchSize);
            const { error: upsertError } = await supabaseClient
                .from('inventory_check')
                .upsert(batch, {
                    onConflict: 'order_date,product_name,user',
                    ignoreDuplicates: true   // ✅ NEVER overwrite saved vendor/qty/item_code
                });

            if (upsertError) {
                console.error('❌ Upsert error on batch', i, upsertError);
                throw upsertError;
            }
        }

        // 7. Batch-update on_hand + target for rows that have REAL stock data
        //    (i.e., came from current_stock or target_inventory — not zero placeholders)
        //    Do this in one upsert per batch, only touching on_hand + target columns.
        //    We split: "has real data" (upsert with update) vs "scaffold only" (already inserted above).
        const realDataRows = rows.filter(r =>
            (r.user === 'Rony'   && stockMap.has(r.product_name)) ||
            (r.user === 'Julio'  && targetMap.has(r.product_name))
        );

        if (realDataRows.length > 0) {
            // These rows definitely exist now — upsert again to refresh on_hand + target.
            // For Julio: also write tentative = target_quantity so Place Order preloads it.
            // Safe: tentative/vendor/item_code preserved unless they were null.
            const refreshRows = realDataRows.map(r => {
                const row = {
                    order_date:   r.order_date,
                    product_name: r.product_name,
                    user:         r.user,
                    on_hand:      r.on_hand,
                    target:       r.target
                };
                // ✅ FIX: populate tentative for Julio from submitted target_quantity
                // This ensures Place Order always preloads the submitted qty
                if (r.user === 'Julio' && r.on_hand > 0) {
                    row.tentative = r.on_hand;
                }
                return row;
            });
            for (let i = 0; i < refreshRows.length; i += batchSize) {
                const batch = refreshRows.slice(i, i + batchSize);
                const { error: refreshErr } = await supabaseClient
                    .from('inventory_check')
                    .upsert(batch, {
                        onConflict: 'order_date,product_name,user',
                        ignoreDuplicates: false   // update on_hand + target, nothing else in payload
                    });
                if (refreshErr) console.warn('⚠️ on_hand refresh batch error:', refreshErr);
            }
            console.log(`✅ Refreshed on_hand for ${realDataRows.length} real-data rows`);
        }

        console.log('✅ Synced', rows.length, 'rows into inventory_check');
        return rows.length;

    } catch (error) {
        console.error('❌ syncInventoryCheck error:', error);
        throw error;
    }
}

// ========== REPLACE your existing initializeEnhancedPlaceOrder with this ==========
// ── Place Order auto-refresh timer ──────────────────────────────
let _placeOrderRefreshTimer = null;

let _placeOrderCountdownTimer = null;

function startPlaceOrderAutoRefresh() {
    stopPlaceOrderAutoRefresh();

    // Countdown display
    let secondsLeft = 60;
    function updateCountdown() {
        const el = document.getElementById('placeOrderCountdown');
        if (el) el.textContent = `⏱ ${secondsLeft}s`;
        secondsLeft--;
        if (secondsLeft < 0) secondsLeft = 60;
    }
    updateCountdown();
    _placeOrderCountdownTimer = setInterval(updateCountdown, 1000);

    // Data refresh every 60s
    _placeOrderRefreshTimer = setInterval(async () => {
        console.log('🔄 Place Order auto-refresh…');
        secondsLeft = 60;
        const el = document.getElementById('placeOrderCountdown');
        if (el) { el.textContent = '🔄 Refreshing…'; }
        try {
            await loadEnhancedCreateOrder();
        } catch(e) {
            console.warn('Auto-refresh error:', e);
        }
    }, 60000);

    console.log('✅ Place Order auto-refresh started (60s)');
}

function stopPlaceOrderAutoRefresh() {
    if (_placeOrderRefreshTimer)  { clearInterval(_placeOrderRefreshTimer);  _placeOrderRefreshTimer  = null; }
    if (_placeOrderCountdownTimer){ clearInterval(_placeOrderCountdownTimer); _placeOrderCountdownTimer= null; }
}

function stopPlaceOrderAutoRefresh() {
    if (_placeOrderRefreshTimer) { clearInterval(_placeOrderRefreshTimer); _placeOrderRefreshTimer = null; }
}

async function initializeEnhancedPlaceOrder() {
    loadJsPDF();

    const today = todayYMD();
    document.getElementById('createOrderDate').value = today;
    document.getElementById('editOrderDate').value = today;
    document.getElementById('finalOrderDate').value = today;

    const vendorOptions = ALLOWED_VENDORS.map(v => `<option value="${v}">${v}</option>`).join('');
    document.getElementById('createVendorFilter').innerHTML = '<option value="">— All Vendors —</option>' + vendorOptions;

    await buildVendorCodeMap();

    // ✅ SYNC FIRST, then load
    const dateISO = document.getElementById('createOrderDate').value || today;
    await syncAndLoad(dateISO);

    // ✅ Start 60-second auto-refresh
    startPlaceOrderAutoRefresh();
}


// ========== ADD THIS HELPER (sync + load in one call) ==========

// ═══ SUPERMARKET CATEGORY MIGRATION ═══════════════════════════════
// Sets category = 'Supermarket' for these specific products in DB
// Safe to run multiple times (only updates if category differs)
const SUPERMARKET_PRODUCTS = [
    'Madras Curry Powder',
    'Sushi Vinegar',
    'Soy Paste Kimlan',
    'Original Sesame Jam',
    'Red Curry Paste',
    'Pixiandouban',
    'Orient Worcestershire Sauce Kimlan',
    'Maltose',
    'Sichuan Yibin Suimiyacai',
    'Coconut Milk',
    'Sweetened Condensed Milk'
];

async function migrateSupermarketCategory() {
    try {
        // Check which products exist in inventory_management
        const { data: existing, error } = await supabaseClient
            .from('inventory_management')
            .select('id, product_name, category')
            .in('product_name', SUPERMARKET_PRODUCTS);

        if (error) { console.warn('Supermarket migration check error:', error); return; }

        const toUpdate = (existing || []).filter(p => p.category !== 'Supermarket');
        if (toUpdate.length === 0) { console.log('✅ Supermarket categories already set'); return; }

        // Update in one batch
        const updatePromises = toUpdate.map(p =>
            supabaseClient
                .from('inventory_management')
                .update({ category: 'Supermarket' })
                .eq('id', p.id)
        );
        await Promise.all(updatePromises);
        console.log(`✅ Set Supermarket category for ${toUpdate.length} products:`, toUpdate.map(p => p.product_name));

        // Also update inventory_check rows (category is denormalized there)
        await supabaseClient
            .from('inventory_check')
            .update({ category: 'Supermarket' })
            .in('product_name', SUPERMARKET_PRODUCTS);

    } catch(e) {
        console.warn('Supermarket migration error:', e);
    }
}
// ═══════════════════════════════════════════════════════════════════

async function syncAndLoad(dateISO) {
    showLoading(true);
    try {
        // Run Supermarket category migration (safe, idempotent)
        await migrateSupermarketCategory();
        const synced = await syncInventoryCheck(dateISO);
        console.log('✅ Sync complete:', synced, 'rows');
        await loadEnhancedCreateOrder();
    } catch (error) {
        console.error('Sync error:', error);
        showAlert('Error syncing data: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// ========== REPLACE your existing date change listener with this ==========
// Find: document.addEventListener('change', (e) => {
//     if (e.target && e.target.id === 'createOrderDate') {
//         loadEnhancedCreateOrder();
//     }
// });
// REPLACE WITH:
document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'createOrderDate') {
        const dateISO = e.target.value;
        syncAndLoad(dateISO);
    }
});



// ✅ ADD THIS HELPER before syncInventoryCheck
function normalizeUser(user) {
    const u = (user || '').trim().toLowerCase();
    if (u === 'rony')   return 'Rony';
    if (u === 'julio')  return 'Julio';
    if (u === 'office') return 'Office';
    return null; // ✅ Return null for anything unrecognized
}




async function submitAndMarkOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();

    // Collect all current card states from the DOM
    const cards = document.querySelectorAll('.enhanced-order-card');

    if (cards.length === 0) {
        showAlert('❌ No products loaded. Please load an order first.', 'error');
        return;
    }

    // Build list of items that have a qty > 0 OR a vendor selected
    const orderItems = [];
    cards.forEach(card => {
        const productName = card.dataset.product;
        const userType    = card.dataset.user;
        const productId   = (productName || '').replace(/[^a-zA-Z0-9]/g, '_');

        const qtyInput    = document.getElementById(`qty-${productId}`);
        const vendorInput = document.getElementById(`vendor-${productId}`);
        const codeInput   = document.getElementById(`itemcode-input-${productId}`);

        const qty    = parseFloat(qtyInput?.value  || 0);
        const vendor = vendorInput?.value || '';
        const code   = codeInput?.value   || '';

        if (qty > 0 || vendor) {
            orderItems.push({
                product_name: productName,
                user:         userType,
                quantity:     qty,
                vendor:       vendor || null,
                item_code:    code   || null
            });
        }
    });

    if (orderItems.length === 0) {
        showAlert('❌ No items have quantities or vendors set. Fill in the order first.', 'error');
        return;
    }

    if (!confirm(`Submit order with ${orderItems.length} item(s) for ${formatDate(dateISO)}?`)) return;

    showLoading(true);
    try {
        // ── STEP 1: Save / update every item in inventory_check ──────────
        for (const item of orderItems) {
            await supabaseClient
                .from('inventory_check')
                .update({
                    tentative:  item.quantity,
                    vendor:     item.vendor,
                    item_code:  item.item_code
                })
                .eq('order_date',    dateISO)
                .eq('product_name',  item.product_name)
                .eq('user',          item.user   === 'rony' ? 'Rony'
                                   : item.user   === 'julio' ? 'Julio'
                                   : item.user   === 'office' ? 'Office'
                                   : item.user);
        }

        // ── STEP 2: Write to submitted_orders table ───────────────────────
        const submittedAt = new Date().toISOString();

        const submissionRows = orderItems.map(item => ({
            order_date:      dateISO,
            submitted_at:    submittedAt,
            submitted_by:    'office',          // person placing the final order
            product_name:    item.product_name,
            quantity:        item.quantity,
            vendor:          item.vendor,
            item_code:       item.item_code,
            user_section:    item.user          // 'rony' | 'julio' | 'office'
        }));

        const { error: insertError } = await supabaseClient
            .from('submitted_orders')
            .insert(submissionRows);

        if (insertError) {
            // Table may not exist yet — log but don't block
            console.warn('submitted_orders insert warning:', insertError.message);
        }

        // ── STEP 3: Also write to inventory_submissions (history) ─────────
        const historyRows = orderItems.map(item => ({
            submission_date: submittedAt,
            submitted_by:    'office',
            product_name:    item.product_name,
            quantity:        item.quantity,
            submission_type: 'place_order',
            notes:           `Order for ${dateISO} | Vendor: ${item.vendor || 'TBD'}`
        }));

        await supabaseClient
            .from('inventory_submissions')
            .insert(historyRows);

        // ── STEP 4: Send email notification ──────────────────────────────
        let emailMsg = '';
        try {
            const emailPayload = {
                submittedBy: 'office',
                orderDate:   dateISO,
                items: orderItems.map(i => ({
                    product_name: i.product_name,
                    quantity:     i.quantity,
                    vendor:       i.vendor || 'TBD',
                    item_code:    i.item_code || '',
                    notes:        `Section: ${i.user}`
                }))
            };

            const resp = await fetch(
                `${SUPABASE_URL}/functions/v1/send-order-notification`,
                {
                    method:  'POST',
                    headers: {
                        'Content-Type':  'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(emailPayload)
                }
            );

            const result = await resp.json();
            emailMsg = result.success
                ? ' 📧 Email notification sent!'
                : ` (Email failed: ${result.error})`;

        } catch (emailErr) {
            console.error('Email send error:', emailErr);
            emailMsg = ' (Email could not be sent)';
        }

        // ── STEP 5: Success message ───────────────────────────────────────
        showAlert(
            `✅ Order submitted successfully! ${orderItems.length} items saved for ${formatDate(dateISO)}.${emailMsg}`,
            'success'
        );

        // Reload the cards to reflect saved state
        await loadEnhancedCreateOrder();

    } catch (error) {
        console.error('submitAndMarkOrder error:', error);
        showAlert('❌ Error submitting order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ========== OFFICE ORDERS FUNCTIONS ==========
let officeOrdersData = [];

async function loadOfficeOrders() {
    console.log('🏢 [Office Orders] Starting to load...');
    showLoading(true);
    try {
        // Initialize date if not set
        const dateInput = document.getElementById('officeOrderDate');
        if (!dateInput.value) {
            dateInput.value = todayYMD();
            console.log('📅 [Office Orders] Date initialized to:', dateInput.value);
        }
        
        const orderDate = dateInput.value || todayYMD();
        console.log('📅 [Office Orders] Using date:', orderDate);
        
        // Load ALL products from purchase_history, then filter in JavaScript
        console.log('📊 [Office Orders] Fetching all products from purchase_history...');
        const { data: allData, error } = await supabaseClient
            .from('purchase_history')
            .select('product_name, vendor, category, image_path, assigned_to, item_code, unit_price');

        if (error) {
            console.error('❌ [Office Orders] Database error:', error);
            throw error;
        }
        
        console.log('✅ [Office Orders] Loaded', allData?.length || 0, 'total products');

        // Filter for office-assigned items (handles both string and array formats)
        const officeItems = (allData || []).filter(item => {
            if (!item.assigned_to) return false;
            
            // Handle string format
            if (typeof item.assigned_to === 'string') {
                const lower = item.assigned_to.toLowerCase().trim();
                return lower === 'office' || lower.includes('office');
            }
            
            // Handle array format
            if (Array.isArray(item.assigned_to)) {
                return item.assigned_to.some(user => 
                    user && typeof user === 'string' && user.toLowerCase().trim() === 'office'
                );
            }
            
            return false;
        });
        
        console.log('🏢 [Office Orders] Found', officeItems.length, 'office-assigned items');

        if (officeItems.length === 0) {
            console.log('⚠️ [Office Orders] No office items found - showing empty state');
            document.getElementById('officeProductCount').textContent = '0 products';
            document.getElementById('officeOrdersTableBody').innerHTML = 
                '<tr><td colspan="7" style="text-align: center; padding: 2rem;"><div class="empty-state"><h3>No products assigned to Office</h3><p>Use Bulk Assign to assign products to Office</p></div></td></tr>';
            showLoading(false);
            return;
        }

        // Group by product name (combine duplicates)
        const productMap = new Map();
        officeItems.forEach(item => {
            const key = item.product_name;
            if (!productMap.has(key)) {
                productMap.set(key, {
                    product_name: item.product_name,
                    vendor: item.vendor,
                    category: item.category,
                    unit_price: parseFloat(item.unit_price || 0),
                    image_path: item.image_path || null,
                    count: 0
                });
            }
            productMap.get(key).count++;
        });
        
        console.log('📦 [Office Orders]', productMap.size, 'unique products after grouping');

        // Load existing orders for this date
        const { data: existingOrders } = await supabaseClient
            .from('inventory_check')
            .select('product_name, tentative')
            .eq('user', 'office')
            .eq('order_date', orderDate);

        const orderMap = new Map();
        (existingOrders || []).forEach(order => {
            orderMap.set(order.product_name, parseFloat(order.tentative || 0));
        });
        
        console.log('📝 [Office Orders] Loaded', existingOrders?.length || 0, 'existing orders');

        // Load current stock
        const { data: stockData } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock');

        const stockMap = new Map();
        (stockData || []).forEach(item => {
            stockMap.set(item.product_name, parseFloat(item.quantity_in_stock || 0));
        });
        
        console.log('📊 [Office Orders] Loaded stock data for', stockData?.length || 0, 'products');

        officeOrdersData = Array.from(productMap.values()).map(item => ({
            product_name: item.product_name,
            vendor: item.vendor,
            par: 0,
            current_stock: stockMap.get(item.product_name) || 0,
            order_qty: orderMap.get(item.product_name) || 0,
            unit_price: item.unit_price,
            category: item.category,
            image_path: item.image_path
        }));
        
        console.log('✅ [Office Orders] Data prepared, calling renderOfficeOrders()');
        renderOfficeOrders();
        console.log('✅ [Office Orders] Load complete!');
        
        // Final visibility check
        const officeDiv = document.getElementById('officeOrders');
        if (officeDiv) {
            console.log('👁️ [Office Orders] Final check - div classes:', officeDiv.className);
            console.log('👁️ [Office Orders] Final check - display:', window.getComputedStyle(officeDiv).display);
            console.log('👁️ [Office Orders] Final check - visibility:', window.getComputedStyle(officeDiv).visibility);
            console.log('👁️ [Office Orders] Final check - opacity:', window.getComputedStyle(officeDiv).opacity);
            
            // DOM INSPECTION
            const tbody = document.getElementById('officeOrdersTableBody');
            console.log('📋 [Office Orders] tbody exists:', tbody ? 'YES' : 'NO');
            console.log('📋 [Office Orders] tbody innerHTML length:', tbody?.innerHTML.length || 0);
            console.log('📋 [Office Orders] tbody children count:', tbody?.children.length || 0);
            console.log('📋 [Office Orders] First 200 chars of tbody:', tbody?.innerHTML.substring(0, 200));
            
            const table = tbody?.closest('table');
            if (table) {
                console.log('📐 [Office Orders] Table height:', window.getComputedStyle(table).height);
                console.log('📐 [Office Orders] Table display:', window.getComputedStyle(table).display);
                console.log('📐 [Office Orders] Table visibility:', window.getComputedStyle(table).visibility);
            }
            
            const container = document.querySelector('#officeOrders .data-table-container');
            if (container) {
                console.log('📦 [Office Orders] Container height:', window.getComputedStyle(container).height);
                console.log('📦 [Office Orders] Container overflow:', window.getComputedStyle(container).overflow);
                console.log('📦 [Office Orders] Container display:', window.getComputedStyle(container).display);
            }
            
            console.log('🌳 [Office Orders] officeDiv childElementCount:', officeDiv.childElementCount);
            console.log('🌳 [Office Orders] officeDiv innerHTML length:', officeDiv.innerHTML.length);
            
            // POSITION & COORDINATES
            const rect = officeDiv.getBoundingClientRect();
            console.log('📍 [Office Orders] Position - top:', rect.top, 'left:', rect.left, 'bottom:', rect.bottom, 'right:', rect.right);
            console.log('📍 [Office Orders] Size - width:', rect.width, 'height:', rect.height);
            console.log('📍 [Office Orders] Position style:', window.getComputedStyle(officeDiv).position);
            console.log('📍 [Office Orders] Top/Left/Right/Bottom:', 
                window.getComputedStyle(officeDiv).top,
                window.getComputedStyle(officeDiv).left,
                window.getComputedStyle(officeDiv).right,
                window.getComputedStyle(officeDiv).bottom
            );
            console.log('📍 [Office Orders] Z-index:', window.getComputedStyle(officeDiv).zIndex);
            console.log('📍 [Office Orders] Transform:', window.getComputedStyle(officeDiv).transform);
            
            // Check if anything is covering it
            const elementAtCenter = document.elementFromPoint(rect.left + rect.width/2, rect.top + rect.height/2);
            console.log('🎯 [Office Orders] Element at center of div:', elementAtCenter?.tagName, elementAtCenter?.id, elementAtCenter?.className);
            
            // Viewport check
            console.log('🖥️ [Office Orders] Viewport - width:', window.innerWidth, 'height:', window.innerHeight);
            console.log('🖥️ [Office Orders] Is in viewport?', 
                rect.top >= 0 && 
                rect.left >= 0 && 
                rect.bottom <= window.innerHeight && 
                rect.right <= window.innerWidth
            );
            
            // FORCE FIX: Hide loading overlay and ensure size
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (loadingOverlay && loadingOverlay.classList.contains('active')) {
                console.log('🚨 [Office Orders] FORCING loading overlay to hide!');
                loadingOverlay.classList.remove('active');
            }
            
            // NUCLEAR FIX: Force the div to have size with inline styles
            console.log('💥 [Office Orders] FORCING div to have dimensions with inline styles!');
            officeDiv.style.minHeight = '500px';
            officeDiv.style.height = 'auto';
            officeDiv.style.display = 'block';
            officeDiv.style.width = '100%';
            officeDiv.style.padding = '20px';
            officeDiv.style.background = 'white';
            officeDiv.style.boxSizing = 'border-box';
            
            // Force table container (reuse variable from above)
            if (container) {
                console.log('💥 [Office Orders] FORCING container dimensions!');
                container.style.minHeight = '300px';
                container.style.display = 'block';
                container.style.padding = '15px';
                container.style.width = '100%';
            }
            
            // Force table (reuse variable from above)
            if (table) {
                console.log('💥 [Office Orders] FORCING table dimensions!');
                table.style.width = '100%';
                table.style.display = 'table';
            }
            
            // Force re-check after style application
            setTimeout(() => {
                const finalRect = officeDiv.getBoundingClientRect();
                console.log('✅ [Office Orders] AFTER FORCE - Size:', finalRect.width, 'x', finalRect.height);
                if (finalRect.height === 0) {
                    console.error('❌❌❌ [Office Orders] STILL 0 HEIGHT AFTER FORCE FIX!');
                    // Try one more time with even more aggressive styling
                    officeDiv.style.setProperty('height', '600px', 'important');
                    officeDiv.style.setProperty('min-height', '600px', 'important');
                }
            }, 100);
        } else {
            console.error('❌ [Office Orders] officeOrders div not found in DOM!');
        }

    } catch (error) {
        console.error('❌ [Office Orders] Load error:', error);
        showAlert('Error loading office orders: ' + error.message, 'error');
        document.getElementById('officeProductCount').textContent = 'Error loading';
        document.getElementById('officeOrdersTableBody').innerHTML = 
            '<tr><td colspan="7" style="text-align: center; padding: 2rem; color: var(--error-600);"><h3>Error Loading Office Orders</h3><p>' + error.message + '</p></td></tr>';
    } finally {
        showLoading(false);
    }
}

function renderOfficeOrders() {
    console.log('🎨 [Office Orders] Rendering', officeOrdersData.length, 'products');
    const tbody = document.getElementById('officeOrdersTableBody');
    
    if (!tbody) {
        console.error('❌ [Office Orders] tbody element not found!');
        return;
    }
    
    document.getElementById('officeProductCount').textContent = `${officeOrdersData.length} products`;

    tbody.innerHTML = officeOrdersData.map((item, idx) => {
        const total = item.order_qty * item.unit_price;
        const imageUrl = resolveImage(item.image_path);
        return `
            <tr>
                <td>
                    <img src="${imageUrl}" 
                         alt="${item.product_name}" 
                         style="width: 50px; height: 50px; object-fit: cover; border-radius: 8px;"
                         onerror="this.src='${PLACEHOLDER_IMAGE}'">
                </td>
                <td style="font-weight: 600;">${item.product_name}</td>
                <td><span class="vendor-badge">${item.vendor || 'N/A'}</span></td>
                <td><span class="price-cell">${item.current_stock.toFixed(1)}</span></td>
                <td>
                    <input type="number" 
                        value="${item.order_qty}" 
                        onchange="updateOfficeOrderQty(${idx}, this.value)"
                        style="width: 100px; padding: 0.5rem; border: 2px solid var(--neutral-300); border-radius: 8px;"
                        min="0" step="0.1">
                </td>
                <td><span class="price-cell">$${item.unit_price.toFixed(2)}</span></td>
                <td><span class="price-cell" style="font-weight: 700;">$${total.toFixed(2)}</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="updateOfficeOrderQty(${idx}, 0)">Clear</button>
                </td>
            </tr>
        `;
    }).join('');
    console.log('✅ [Office Orders] Render complete');
}

function updateOfficeOrderQty(idx, qty) {
    officeOrdersData[idx].order_qty = parseFloat(qty || 0);
    renderOfficeOrders();
}

async function saveOfficeOrders() {
    showLoading(true);
    try {
        const orderDate = document.getElementById('officeOrderDate')?.value || todayYMD();
        
        const ordersToSave = officeOrdersData
            .filter(item => item.order_qty > 0)
            .map(item => ({
                product_name: item.product_name,
                vendor: item.vendor,
                user: 'office',
                tentative: item.order_qty,
                order_date: orderDate
            }));

        if (ordersToSave.length === 0) {
            showAlert('No items to save', 'warning');
            return;
        }

        // Delete existing orders for this date
        await supabaseClient
            .from('inventory_check')
            .delete()
            .eq('user', 'office')
            .eq('order_date', orderDate);

        // Insert new orders
        const { error } = await supabaseClient
            .from('inventory_check')
            .insert(ordersToSave);

        if (error) throw error;

        showAlert(`✅ Saved ${ordersToSave.length} office orders`, 'success');

    } catch (error) {
        console.error('Save office orders error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function clearOfficeOrders() {
    if (!confirm('Clear all office orders?')) return;
    officeOrdersData.forEach(item => item.order_qty = 0);
    renderOfficeOrders();
}

function filterOfficeProducts() {
    // Implement if needed
    renderOfficeOrders();
}



function updateConsumptionPeriods() {
    updateWeekOptions();
}

function updateWeekOptions() {
    const year = parseInt(document.getElementById('consumptionYear').value);
    const monthSelect = document.getElementById('consumptionMonth');
    const weekSelect = document.getElementById('consumptionWeeks');
    
    const selectedMonths = Array.from(monthSelect.selectedOptions).map(o => parseInt(o.value));
    
    weekSelect.innerHTML = '';
    
    selectedMonths.forEach(month => {
        const monthName = monthSelect.querySelector(`option[value="${month}"]`).text;
        const weeksInMonth = getWeeksInMonth(year, month);
        
        weeksInMonth.forEach((week, idx) => {
            const opt = document.createElement('option');
            opt.value = `${year}-${month}-${idx+1}`;
            opt.textContent = `${monthName} Week ${idx+1} (${week.start} - ${week.end})`;
            weekSelect.appendChild(opt);
        });
    });
}

function getWeeksInMonth(year, month) {
    const weeks = [];
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    
    let currentStart = 1;
    while (currentStart <= lastDay.getDate()) {
        const weekEnd = Math.min(currentStart + 6, lastDay.getDate());
        weeks.push({
            start: `${month}/${currentStart}`,
            end: `${month}/${weekEnd}`
        });
        currentStart = weekEnd + 1;
    }
    
    return weeks;
}






    </script>



<!-- Quick Assignment Modal -->
<div class="modal-overlay" id="quickAssignModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2>👥 Assign Selected Items</h2>
            <button class="modal-close" onclick="closeModal('quickAssignModal')">×</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label style="font-size: 1rem; margin-bottom: 1rem; display: block;">
                    Assign <strong id="selectedItemsCount">0</strong> items to:
                </label>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="rony" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">👨‍🍳</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Rony</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Kitchen Manager</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="julio" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">👨‍🍳</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Julio</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Kitchen Staff</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="office" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">🏢</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Office</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Administrative Use</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('quickAssignModal')">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmQuickAssignment()">
                    <i class="fas fa-check"></i> Assign Now
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.assignment-option:has(input:checked) {
    border-color: var(--primary-600) !important;
    background: var(--primary-100) !important;
}

.assignment-option:hover {
    border-color: var(--primary-500);
    background: var(--neutral-50);
}
</style>

<!-- ========== ADD PRODUCT MODAL ========== -->
<div class="modal-overlay" id="addProductModalOverlay" style="display:none;">
    <div class="modal" style="max-width: 600px;">
        <div class="modal-header">
            <h2><i class="fas fa-plus-circle"></i> Add New Product</h2>
            <button class="modal-close" onclick="closeAddProductModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" onsubmit="saveNewProduct(event)">
                <input type="hidden" id="addProductUser" value="">
                
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Product Name <span style="color: var(--danger-600);">*</span></label>
                    <input type="text" id="addProductName" class="search-input" placeholder="e.g., Tomato - Roma" required autocomplete="off">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-image"></i> Image URL</label>
                    <input type="text" id="addProductImage" class="search-input" placeholder="cumin.jpg or https://example.com/image.jpg" autocomplete="off">
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">Optional: Enter image filename (e.g., cumin.jpg) or full URL</small>
                </div>

                <div class="form-group" id="positionFieldGroup" style="display:none;">
                    <label><i class="fas fa-map-marker-alt"></i> Position <span style="color: var(--danger-600);">*</span></label>
                    <input type="number" id="addProductPosition" class="search-input" placeholder="e.g., 1, 2, 3..." min="1" autocomplete="off">
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">For Rony: Physical location/position number in warehouse</small>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-folder"></i> Category <span style="color: var(--danger-600);">*</span></label>
                    <input type="text" id="addProductCategory" class="search-input" list="categoryList" placeholder="e.g., Vegetables, Meat, Dairy..." required autocomplete="off">
                    <datalist id="categoryList">
                        <option value="Vegetables">
                        <option value="Fruits">
                        <option value="Meat & Seafood">
                        <option value="Dairy">
                        <option value="Dry Goods">
                        <option value="Beverages">
                        <option value="Condiments">
                        <option value="Frozen">
                        <option value="Office Supplies">
                    </datalist>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-layer-group"></i> PAR Level</label>
                    <input type="number" id="addProductPAR" class="search-input" placeholder="0" min="0" step="0.01" autocomplete="off">
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">Optional: Target inventory level (recommended stock amount)</small>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Save & Add to List
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddProductModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
            
            <div id="addProductStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>
</div>

<script>
// ========== ADD PRODUCT MODAL FUNCTIONS ==========

function openAddProductModal(userType) {
    console.log('Opening Add Product modal for:', userType);
    
    document.getElementById('addProductUser').value = userType;
    document.getElementById('addProductModalOverlay').style.display = 'flex';
    
    // Show/hide position field based on user
    const positionField = document.getElementById('positionFieldGroup');
    const positionInput = document.getElementById('addProductPosition');
    
    if (userType === 'rony') {
        positionField.style.display = 'block';
        positionInput.required = true;
    } else {
        positionField.style.display = 'none';
        positionInput.required = false;
    }
    
    // Update modal title
    const userName = userType.charAt(0).toUpperCase() + userType.slice(1);
    const modalTitle = document.querySelector('#addProductModalOverlay .modal-header h2');
    modalTitle.innerHTML = `<i class="fas fa-plus-circle"></i> Add Product for ${userName}`;
    
    // Reset form
    document.getElementById('addProductForm').reset();
    document.getElementById('addProductStatus').innerHTML = '';
    
    // Focus on product name
    setTimeout(() => document.getElementById('addProductName').focus(), 100);
}

function closeAddProductModal() {
    document.getElementById('addProductModalOverlay').style.display = 'none';
    document.getElementById('addProductForm').reset();
    document.getElementById('addProductStatus').innerHTML = '';
}

async function saveNewProduct(event) {
    event.preventDefault();
    
    const statusEl = document.getElementById('addProductStatus');
    const userType = document.getElementById('addProductUser').value;
    const productName = document.getElementById('addProductName').value.trim();
    const imageUrl = document.getElementById('addProductImage').value.trim() || null;
    const positionValue = document.getElementById('addProductPosition').value;
    const position = positionValue ? parseInt(positionValue) : null;
    const category = document.getElementById('addProductCategory').value.trim();
    const parValue = document.getElementById('addProductPAR').value;
    const par = parValue ? parseFloat(parValue) : 0;
    
    console.log('Form values:', { 
        productName, 
        userType, 
        position, 
        positionValue,
        category, 
        par,
        imageUrl 
    });
    
    // Detailed validation with specific messages
    if (!productName) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Product Name is required</div>';
        return;
    }
    
    if (!category) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Category is required</div>';
        return;
    }
    
    if (userType === 'rony' && !position) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Position is required for Rony\'s products</div>';
        return;
    }
    
    statusEl.innerHTML = '<div style="color: var(--primary-600); padding: 0.75rem; background: var(--primary-50); border-radius: 8px;"><i class="fas fa-spinner fa-spin"></i> Saving product to database...</div>';
    
    try {
        // Step 1: Check if product already exists in inventory_management
        const { data: existing, error: checkError } = await supabaseClient
            .from('inventory_management')
            .select('id, assigned_to, product_name')
            .ilike('product_name', productName)
            .limit(1);
        
        if (checkError) {
            console.error('Check error:', checkError);
            throw checkError;
        }
        
        console.log('Existing products found:', existing);
        
        let productId;
        
        if (existing && existing.length > 0) {
            // Product exists - update assigned_to
            const existingProduct = existing[0];
            productId = existingProduct.id;
            let assignedTo = existingProduct.assigned_to || [];
            
            // Parse if string (Postgres sometimes returns JSON as string)
            if (typeof assignedTo === 'string') {
                try {
                    assignedTo = JSON.parse(assignedTo);
                } catch {
                    assignedTo = [assignedTo];
                }
            }
            
            // Ensure it's an array
            if (!Array.isArray(assignedTo)) {
                assignedTo = [assignedTo];
            }
            
            // Add user if not already assigned
            const userLower = userType.toLowerCase();
            if (!assignedTo.some(u => String(u).toLowerCase() === userLower)) {
                assignedTo.push(userType);
                
                console.log('Updating assigned_to:', assignedTo);
                
                const { error: updateError } = await supabaseClient
                    .from('inventory_management')
                    .update({ assigned_to: assignedTo })
                    .eq('id', existingProduct.id);
                
                if (updateError) {
                    console.error('Update error:', updateError);
                    throw updateError;
                }
                
                statusEl.innerHTML = `<div style="color: var(--success-600); padding: 0.75rem; background: var(--success-50); border-radius: 8px; border: 1px solid var(--success-300);"><i class="fas fa-check-circle"></i> Product "${productName}" already exists! Added to ${userType}'s list.</div>`;
            } else {
                statusEl.innerHTML = `<div style="color: var(--success-600); padding: 0.75rem; background: var(--success-50); border-radius: 8px; border: 1px solid var(--success-300);"><i class="fas fa-info-circle"></i> Product "${productName}" is already assigned to ${userType}.</div>`;
            }
        } else {
            // Create new product
            const newProduct = {
                product_name: productName,
                image_url: imageUrl,
                category: category,
                par: par,
                assigned_to: [userType]
            };
            
            // Add position for Rony
            if (userType === 'rony' && position) {
                newProduct.position = position;
            }
            
            console.log('Creating new product:', newProduct);
            
            const { data: inserted, error: insertError } = await supabaseClient
                .from('inventory_management')
                .insert([newProduct])
                .select();
            
            if (insertError) {
                console.error('Insert error:', insertError);
                throw insertError;
            }
            
            console.log('Product created:', inserted);
            productId = inserted[0]?.id;
            
            statusEl.innerHTML = `<div style="color: var(--success-600); padding: 0.75rem; background: var(--success-50); border-radius: 8px; border: 1px solid var(--success-300);"><i class="fas fa-check-circle"></i> Product "${productName}" created successfully and added to ${userType}'s list!</div>`;
        }
        
        // Step 2: Reload the appropriate tab after 1.5 seconds
        setTimeout(() => {
            closeAddProductModal();
            
            console.log('Reloading tab for:', userType);
            
            if (userType === 'rony') {
                if (typeof loadRonyOrders === 'function') {
                    loadRonyOrders();
                }
            } else if (userType === 'julio') {
                if (typeof loadJulioOrders === 'function') {
                    loadJulioOrders();
                }
            } else if (userType === 'office') {
                if (typeof loadOfficeOrders === 'function') {
                    loadOfficeOrders();
                }
            }
        }, 1500);
        
    } catch (error) {
        console.error('Error saving product:', error);
        statusEl.innerHTML = `<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message || 'Failed to save product'}</div>`;
    }
}

// Close modal when clicking outside
document.getElementById('addProductModalOverlay')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddProductModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('addProductModalOverlay').style.display === 'flex') {
        closeAddProductModal();
    }
});
</script>

<!-- ========== FEATURE #8: ADD ITEM FROM INVOICE TRACKING MODAL ========== -->
<div class="modal-overlay" id="addItemTrackingModal" style="display:none;">
    <div class="modal" style="max-width: 650px;">
        <div class="modal-header">
            <h2><i class="fas fa-box"></i> Add New Item to Inventory</h2>
            <button class="modal-close" onclick="closeAddItemTrackingModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="addItemTrackingForm" onsubmit="saveItemFromTracking(event)">
                
                <div class="form-group">
                    <label><i class="fas fa-tag"></i> Product Name <span style="color: var(--danger-600);">*</span></label>
                    <input type="text" id="trackingProductName" class="search-input" placeholder="e.g., Tomato - Roma" required autocomplete="off">
                </div>

                <div class="form-group">
                    <label><i class="fas fa-image"></i> Image Filename</label>
                    <input type="text" id="trackingProductImage" class="search-input" placeholder="e.g., tomato.jpg" autocomplete="off">
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">Optional: Enter image filename or full URL</small>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-building"></i> Vendor <span style="color: var(--danger-600);">*</span></label>
                    <select id="trackingProductVendor" class="search-input" required>
                        <option value="">Select Vendor</option>
                    </select>
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">Current vendor will be pre-selected if viewing an invoice</small>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-folder"></i> Category <span style="color: var(--danger-600);">*</span></label>
                    <input type="text" id="trackingProductCategory" class="search-input" list="trackingCategoryList" placeholder="e.g., Vegetables, Meat..." required autocomplete="off">
                    <datalist id="trackingCategoryList">
                        <option value="Vegetables">
                        <option value="Fruits">
                        <option value="Meat & Seafood">
                        <option value="Dairy">
                        <option value="Dry Goods">
                        <option value="Beverages">
                        <option value="Condiments">
                        <option value="Frozen">
                    </datalist>
                </div>

                <div class="form-group">
                    <label><i class="fas fa-barcode"></i> Item Code</label>
                    <input type="text" id="trackingProductItemCode" class="search-input" placeholder="e.g., VEG001" autocomplete="off">
                    <small style="color: var(--neutral-500); font-size: 0.75rem;">Optional: Vendor's item code</small>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label><i class="fas fa-dollar-sign"></i> Price</label>
                        <input type="number" id="trackingProductPrice" class="search-input" placeholder="0.00" min="0" step="0.01" autocomplete="off">
                    </div>
                    
                    <div class="form-group">
                        <label><i class="fas fa-layer-group"></i> PAR Level</label>
                        <input type="number" id="trackingProductPAR" class="search-input" placeholder="0" min="0" step="0.01" autocomplete="off">
                    </div>
                </div>

                <div style="display: flex; gap: 0.75rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary" style="flex: 1;">
                        <i class="fas fa-save"></i> Save & Add to Inventory
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="closeAddItemTrackingModal()">
                        <i class="fas fa-times"></i> Cancel
                    </button>
                </div>
            </form>
            
            <div id="addItemTrackingStatus" style="margin-top: 1rem;"></div>
        </div>
    </div>
</div>

<script>
// ========== FEATURE #8: ADD ITEM FROM INVOICE TRACKING FUNCTIONS ==========

function openAddItemFromTracking() {
    console.log('Opening Add Item from Invoice Tracking modal');
    
    document.getElementById('addItemTrackingModal').style.display = 'flex';
    
    // Populate vendor dropdown
    populateVendorDropdown();
    
    // Pre-select vendor if we're viewing/editing an invoice
    const currentVendor = document.getElementById('invoiceVendorSelect')?.value;
    if (currentVendor && currentVendor !== '') {
        setTimeout(() => {
            document.getElementById('trackingProductVendor').value = currentVendor;
        }, 100);
    }
    
    // Reset form
    document.getElementById('addItemTrackingForm').reset();
    document.getElementById('addItemTrackingStatus').innerHTML = '';
    
    // Focus on product name
    setTimeout(() => document.getElementById('trackingProductName').focus(), 100);
}

function closeAddItemTrackingModal() {
    document.getElementById('addItemTrackingModal').style.display = 'none';
    document.getElementById('addItemTrackingForm').reset();
    document.getElementById('addItemTrackingStatus').innerHTML = '';
}

async function populateVendorDropdown() {
    try {
        // Get unique vendors from invoices table
        const { data: vendors, error } = await supabaseClient
            .from('invoices')
            .select('vendor')
            .order('vendor');
        
        if (error) throw error;
        
        // Get unique vendor names
        const uniqueVendors = [...new Set(vendors.map(v => v.vendor).filter(Boolean))].sort();
        
        const select = document.getElementById('trackingProductVendor');
        select.innerHTML = '<option value="">Select Vendor</option>';
        
        uniqueVendors.forEach(vendor => {
            const option = document.createElement('option');
            option.value = vendor;
            option.textContent = vendor;
            select.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading vendors:', error);
    }
}

async function saveItemFromTracking(event) {
    event.preventDefault();
    
    const statusEl = document.getElementById('addItemTrackingStatus');
    const productName = document.getElementById('trackingProductName').value.trim();
    const imageUrl = document.getElementById('trackingProductImage').value.trim() || null;
    const vendor = document.getElementById('trackingProductVendor').value;
    const category = document.getElementById('trackingProductCategory').value.trim();
    const itemCode = document.getElementById('trackingProductItemCode').value.trim() || null;
    const price = document.getElementById('trackingProductPrice').value ? parseFloat(document.getElementById('trackingProductPrice').value) : 0;
    const par = document.getElementById('trackingProductPAR').value ? parseFloat(document.getElementById('trackingProductPAR').value) : 0;
    
    console.log('Saving item from tracking:', { productName, vendor, category, price });
    
    // Validation
    if (!productName) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Product Name is required</div>';
        return;
    }
    
    if (!vendor) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Vendor is required</div>';
        return;
    }
    
    if (!category) {
        statusEl.innerHTML = '<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Category is required</div>';
        return;
    }
    
    statusEl.innerHTML = '<div style="color: var(--primary-600); padding: 0.75rem; background: var(--primary-50); border-radius: 8px;"><i class="fas fa-spinner fa-spin"></i> Saving item to inventory...</div>';
    
    try {
        // Check if product already exists
        const { data: existing, error: checkError } = await supabaseClient
            .from('inventory_management')
            .select('id, product_name')
            .ilike('product_name', productName)
            .limit(1);
        
        if (checkError) throw checkError;
        
        if (existing && existing.length > 0) {
            statusEl.innerHTML = `<div style="color: var(--warning-600); padding: 0.75rem; background: var(--warning-50); border-radius: 8px; border: 1px solid var(--warning-300);"><i class="fas fa-exclamation-triangle"></i> Product "${productName}" already exists in inventory!</div>`;
            return;
        }
        
        // Create new product
        const newProduct = {
            product_name: productName,
            image_url: imageUrl,
            vendors: vendor,
            category: category,
            on_hand: 0,
            par: par
        };
        
        const { data: inserted, error: insertError } = await supabaseClient
            .from('inventory_management')
            .insert([newProduct])
            .select();
        
        if (insertError) throw insertError;
        
        console.log('✅ Item created in inventory:', inserted);
        
        // Also add to inventory_data table if needed
        if (itemCode && price > 0) {
            const inventoryItem = {
                item_code: itemCode,
                product_name: productName,
                vendor: vendor,
                unit_price: price,
                image_path: imageUrl
            };
            
            const { error: invError } = await supabaseClient
                .from('inventory_data')
                .insert([inventoryItem]);
            
            if (invError) {
                console.warn('Could not add to inventory_data:', invError);
            } else {
                console.log('✅ Also added to inventory_data');
            }
        }
        
        statusEl.innerHTML = `<div style="color: var(--success-600); padding: 0.75rem; background: var(--success-50); border-radius: 8px; border: 1px solid var(--success-300);"><i class="fas fa-check-circle"></i> Item "${productName}" added successfully!</div>`;
        
        // Close modal after 2 seconds
        setTimeout(() => {
            closeAddItemTrackingModal();
            // Reload inventory data if we're on inventory view
            if (typeof loadInventory === 'function') {
                loadInventory();
            }
        }, 2000);
        
    } catch (error) {
        console.error('Error saving item:', error);
        statusEl.innerHTML = `<div style="color: var(--danger-600); padding: 0.75rem; background: var(--danger-50); border-radius: 8px; border: 1px solid var(--danger-300);"><i class="fas fa-exclamation-triangle"></i> Error: ${error.message || 'Failed to save item'}</div>`;
    }
}

// Close modal when clicking outside
document.getElementById('addItemTrackingModal')?.addEventListener('click', function(e) {
    if (e.target === this) {
        closeAddItemTrackingModal();
    }
});

// Close modal on Escape key
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape' && document.getElementById('addItemTrackingModal').style.display === 'flex') {
        closeAddItemTrackingModal();
    }
});





</script>

</body>

</html>
