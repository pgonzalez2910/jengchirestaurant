<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Inventory Intelligence Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-900: #0a1628;
            --primary-800: #132540;
            --primary-700: #1a3558;
            --primary-600: #234670;
            --primary-500: #2c5688;
            --primary-400: #4a7aae;
            --primary-300: #6b9dd4;
            --primary-200: #a5c7f0;
            --primary-100: #d4e7ff;
            
            --accent-600: #d97706;
            --accent-500: #f59e0b;
            --accent-400: #fbbf24;
            
            --success-600: #059669;
            --success-500: #10b981;
            --warning-600: #dc2626;
            
            --neutral-950: #0a0a0a;
            --neutral-900: #171717;
            --neutral-800: #262626;
            --neutral-700: #404040;
            --neutral-600: #525252;
            --neutral-500: #737373;
            --neutral-400: #a3a3a3;
            --neutral-300: #d4d4d4;
            --neutral-200: #e5e5e5;
            --neutral-100: #f5f5f5;
            --neutral-50: #fafafa;
            
            --font-display: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-display);
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--neutral-100) 100%);
            color: var(--neutral-900);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-xl);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-500);
        }
        
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .app-title .subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
            font-weight: 400;
            margin-top: 0.25rem;
            font-family: var(--font-mono);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--neutral-600);
            transition: all var(--transition-base);
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: var(--neutral-100);
            color: var(--primary-700);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .content-section {
            display: none;
            animation: fadeIn var(--transition-slow);
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-filter-bar {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-group {
            flex: 1;
            min-width: 300px;
        }
        
        .search-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            transition: all var(--transition-base);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }
        
        .filter-group {
            min-width: 200px;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-700);
            border: 2px solid var(--primary-700);
        }
        
        .btn-secondary:hover {
            background: var(--primary-700);
            color: white;
        }
        
        .btn-success {
            background: var(--success-600);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-500);
        }
        
        .btn-danger {
            background: var(--warning-600);
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
        }
        
        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .table-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-50) 100%);
            border-bottom: 2px solid var(--neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table thead {
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--neutral-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--neutral-300);
            cursor: pointer;
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table tbody tr {
            transition: all var(--transition-fast);
        }
        
        .data-table tbody tr:hover {
            background: var(--primary-100);
        }
        
        .data-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            font-size: 0.9375rem;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .vendor-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--neutral-200);
            color: var(--neutral-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        
        .price-cell {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--primary-700);
            font-size: 1rem;
        }
        
        .item-number {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
        
        .assignment-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-200);
            color: var(--primary-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-right: 0.25rem;
            position: relative;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .assignment-badge:hover {
            background: var(--primary-300);
            padding-right: 1.75rem;
        }
        
        .assignment-badge:hover::after {
            content: '√ó';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-800);
        }
        
        .assignment-select {
            padding: 0.5rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .assignment-select:hover {
            border-color: var(--primary-500);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-600);
            transition: all var(--transition-base);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .metric-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-900);
            font-family: var(--font-mono);
        }
        
        .metric-subtitle {
            font-size: 0.8125rem;
            color: var(--neutral-500);
            margin-top: 0.5rem;
        }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }
        
        .chart-container h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 450px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--neutral-50);
            border-radius: 12px;
        }
        
        .comparison-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--success-600);
        }
        
        .comparison-card.highest {
            border-left-color: var(--warning-600);
        }
        
        .comparison-card.lowest {
            border-left-color: var(--success-600);
        }
        
        .comparison-card.average {
            border-left-color: var(--primary-600);
        }
        
        .comparison-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .comparison-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            margin-bottom: 0.5rem;
        }
        
        .comparison-vendor {
            font-size: 0.9375rem;
            color: var(--neutral-700);
            font-weight: 600;
        }
        
        .comparison-date {
            font-size: 0.8125rem;
            color: var(--neutral-500);
        }
        
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            box-shadow: var(--shadow-xl);
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--neutral-200);
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-600);
            border-left: 4px solid var(--success-600);
        }
        
        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--warning-600);
            border-left: 4px solid var(--warning-600);
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--neutral-200);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--neutral-500);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .vendor-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--neutral-200);
        }

        .month-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .month-chip {
            padding: 0.5rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .month-chip:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .month-chip.selected {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .vendor-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border-left: 6px solid var(--primary-600);
        }

        .vendor-card-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--neutral-200);
        }

        .vendor-card-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .vendor-monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .vendor-month-card {
            background: var(--neutral-50);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--neutral-200);
            text-align: center;
            transition: all var(--transition-base);
        }

        .vendor-month-card:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: translateY(-2px);
        }

        .vendor-month-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .vendor-month-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-700);
            font-family: var(--font-mono);
        }

        .vendor-total-card {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .vendor-total-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vendor-total-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .invoice-product-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .invoice-product-item:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .invoice-product-item.selected {
            border-color: var(--success-600);
            background: rgba(16, 185, 129, 0.1);
        }

        .selected-product-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--success-600);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .selected-product-card img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .editable-field {
            padding: 0.5rem;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            background: white;
            font-family: var(--font-display);
            transition: all var(--transition-base);
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }

        input[type="number"].editable-field {
            -moz-appearance: textfield;
        }

        input[type="number"].editable-field::-webkit-outer-spin-button,
        input[type="number"].editable-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="app-header">
        <div class="header-content">
            <div class="app-title">
                <div>
                    <h1>Enterprise Inventory Intelligence Platform</h1>
                    <div class="subtitle">Multi-Vendor Product Management & Analytics</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Online</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('inventory')">üì¶ Inventory View</button>
            <button class="nav-tab" onclick="switchTab('quickEdit')">‚úèÔ∏è Quick Edit</button>
            <button class="nav-tab" onclick="switchTab('analytics')">üìä Analytics & Insights</button>
            <button class="nav-tab" onclick="switchTab('vendorSpending')">üí∞ Vendor Spending Analysis</button>
            <button class="nav-tab" onclick="switchTab('invoices')">üìÑ Invoice Tracking</button>
            <button class="nav-tab" onclick="switchTab('vendors')">üè¢ Vendor Management</button>
        </div>

        <!-- Inventory View -->
        <div id="inventory" class="content-section active">
            <div class="search-filter-bar">
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." oninput="performSearch()">
                </div>
                <div class="filter-group">
                    <label>Vendor Filter</label>
                    <select id="vendorFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year Filter</label>
                    <select id="yearFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Assigned To</label>
                    <select id="assignedToFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="exportToCSV()">üì• Export</button>
                    <button class="btn btn-secondary" onclick="openBulkAssignModal()">üë• Bulk Assign</button>
                    <button class="btn btn-success" onclick="openAddItemModal()">+ Add Item</button>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Product Inventory</h2>
                    <div class="table-actions">
                        <button class="btn btn-icon" onclick="toggleDeleteMode()" id="deleteToggleBtn" title="Delete Mode" style="background: var(--warning-600); color: white;">üóëÔ∏è</button>
                        <button class="btn btn-primary" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">Delete Selected</button>
                        <span id="recordCount">Loading...</span>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th id="checkboxHeader" style="display: none; width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer; width: 18px; height: 18px;">
                            </th>
                            <th>Image</th>
                            <th>Vendor</th>
                            <th>Item No.</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Purchase Date</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Quick Edit View -->
        <div id="quickEdit" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>Filter by Assignment</label>
                    <select id="quickEditAssignFilter" class="search-input" onchange="filterQuickEdit()">
                        <option value="">All Products</option>
                        <option value="rony">Rony's Products</option>
                        <option value="julio">Julio's Products</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="quickEditSearch" class="search-input" placeholder="Search by name or code..." oninput="filterQuickEdit()">
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Quick Edit - All Matching Items Update Together</h2>
                    <span id="quickEditCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Item Code</th>
                            <th>Product Name</th>
                            <th>Vendor</th>
                            <th>Price</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quickEditTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Products</div>
                    <div class="metric-value" id="metricTotalProducts">-</div>
                    <div class="metric-subtitle">Unique products</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Vendors</div>
                    <div class="metric-value" id="metricActiveVendors">-</div>
                    <div class="metric-subtitle">Suppliers with inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Price</div>
                    <div class="metric-value" id="metricAvgPrice">-</div>
                    <div class="metric-subtitle">Across all inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Value</div>
                    <div class="metric-value" id="metricTotalValue">-</div>
                    <div class="metric-subtitle">Estimated total</div>
                </div>
            </div>

            <div class="search-filter-bar">
                <div class="search-group">
                    <label>üìä Select Product for Price Analysis</label>
                    <select id="analyticsProductSelect" class="search-input" onchange="loadProductAnalytics()">
                        <option value="">Choose a product to compare prices...</option>
                    </select>
                </div>
            </div>

            <div id="productAnalysisSection" style="display: none;">
                <div class="comparison-grid" id="priceComparison"></div>

                <div class="chart-container">
                    <h3>üìà Vendor Price Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="vendorPriceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>üìâ Price History Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="priceHistoryChart"></canvas>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h2>üí° Price Variance Analysis</h2>
                    </div>
                    <div style="padding: 2rem;" id="varianceAnalysis"></div>
                </div>
            </div>

            <div class="chart-container">
                <h3>üè¢ Vendor Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="vendorDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Vendor Spending Analysis -->
        <div id="vendorSpending" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>üìÖ Select Year</label>
                    <select id="vendorSpendingYear" class="search-input" onchange="loadVendorSpendingAnalysis()">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="search-group">
                    <label style="display: block; margin-bottom: 0.5rem;">üóìÔ∏è Select Months to Analyze</label>
                    <div class="month-selector" id="vendorMonthSelector"></div>
                </div>
            </div>

            <div id="vendorSpendingContent"></div>
        </div>

        <!-- Invoice Tracking Section -->
        <div id="invoices" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>Select Vendor</label>
                    <select id="invoiceVendorSelect" class="search-input" onchange="filterInvoicesByVendor()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year</label>
                    <select id="invoiceYearSelect" class="search-input" onchange="filterInvoicesByVendor()">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-success" onclick="openAddInvoiceModal()">+ Add Invoice</button>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Invoice List</h2>
                    <span id="invoiceCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Invoice #</th>
                            <th>Check #</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Vendor Management Section -->
        <div id="vendors" class="content-section">
            <div class="data-table-container">
                <div class="table-header">
                    <h2>Vendor Statistics</h2>
                    <span id="vendorCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vendor Logo</th>
                            <th>Vendor Name</th>
                            <th>Product Count</th>
                            <th>Last Purchase</th>
                            <th>Total Purchases</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- MODALS START HERE -->
    
    <!-- Item Modal -->
    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="itemModalTitle">Add Item</h2>
                <button class="modal-close" onclick="closeModal('itemModal')">√ó</button>
            </div>
            <div class="modal-body">
                <form id="itemForm" onsubmit="saveVendorItem(event)">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="itemProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Number *</label>
                        <input type="text" id="itemNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="itemProductImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-group">
    <label>Vendor *</label>
    <select id="itemVendor" class="search-input" required>
        <option value="">-- Select Vendor --</option>
    </select>
</div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" id="itemPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Purchase Date *</label>
                        <input type="date" id="itemEffectiveDate" required>
                    </div>
                    <div class="form-group">
                        <label>Assign To</label>
                        <select id="itemAssignedTo" class="search-input" multiple style="height: 120px;">
                            <option value="rony">Rony</option>
                            <option value="julio">Julio</option>
                        </select>
                        <small style="color: var(--neutral-500); font-size: 0.8125rem;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Edit Modal -->
    <div class="modal-overlay" id="quickEditModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="quickEditModalTitle">Quick Edit Product</h2>
                <button class="modal-close" onclick="closeModal('quickEditModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i>
                    <span>Editing this product will update <strong id="affectedCount">0</strong> matching items in the database.</span>
                </div>
                <form id="quickEditForm" onsubmit="saveQuickEdit(event)">
                    <input type="hidden" id="quickEditItemCode">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="quickEditProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Code *</label>
                        <input type="text" id="quickEditItemCodeDisplay" disabled>
                    </div>
                    <div class="form-group">
                        <label>Vendor *</label>
                        <input type="text" id="quickEditVendor" required>
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" id="quickEditPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="quickEditImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('quickEditModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update All Matching Items
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ENHANCED INVOICE MODAL WITH WEIGHT & PRICE PER UNIT -->
    <div class="modal-overlay" id="invoiceModal">
        <div class="modal" style="max-width: 1400px; max-height: 95vh;">
            <div class="modal-header">
                <h2 id="invoiceModalTitle">Add Invoice</h2>
                <button class="modal-close" onclick="closeModal('invoiceModal')">√ó</button>
            </div>
            <div class="modal-body" style="max-height: calc(95vh - 140px); overflow-y: auto;">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <!-- Invoice Header Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Vendor *</label>
                            <select id="invoiceVendorDropdown" class="search-input" required onchange="updateInvoiceVendorField()">
                                <option value="">-- Select Vendor --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                            <input type="text" id="invoiceNumber" required>
                        </div>
                        <div class="form-group">
                            <label>Check Number</label>
                            <input type="text" id="invoiceCheckNumber" placeholder="e.g., CHK-12345">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label>Products Count</label>
                            <input type="text" id="invoiceItemsCount" readonly style="background: var(--primary-50); font-weight: 700; font-size: 1.125rem; color: var(--primary-700); text-align: center;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="invoiceNotes" rows="2" placeholder="Add any additional notes about this invoice..."></textarea>
                    </div>

                    <!-- Tax Toggle -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="invoiceTaxEnabled" checked onchange="calculateInvoiceTotals()">
                            <span style="font-weight: 600; color: var(--neutral-700);">
                                <i class="fas fa-receipt"></i> Apply Tax (8.25%)
                            </span>
                        </label>
                        <small style="color: var(--neutral-500); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                            Uncheck this for vendors that don't charge tax (e.g., some seafood suppliers)
                        </small>
                    </div>

                    <!-- Product Selection Section -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 3px solid var(--primary-600);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary-700); font-size: 1.25rem;">üì¶ Invoice Products</h3>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span id="invoiceProductCount" style="color: var(--neutral-600); font-weight: 600; font-size: 1rem;">0 items selected</span>
                                <button type="button" class="btn btn-primary" onclick="toggleProductSearch()" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>

                        <!-- Search Section (Initially Hidden) -->
                        <div id="productSearchSection" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: var(--primary-50); border-radius: 12px; border: 2px solid var(--primary-200);">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>üîç Search Products (by name or item code)</label>
                                <input type="text" 
                                       id="invoiceProductSearch" 
                                       class="search-input" 
                                       placeholder="Type to search products..." 
                                       oninput="searchInvoiceProducts()">
                            </div>
                            <div id="invoiceProductResults" style="max-height: 250px; overflow-y: auto; border: 2px solid var(--neutral-300); border-radius: 8px; padding: 1rem; background: white; display: none;"></div>
                        </div>

                        <!-- Selected Products Display -->
                        <div id="selectedInvoiceProducts" style="display: grid; gap: 1rem; margin-bottom: 2rem;"></div>
                        
                        <!-- Invoice Totals -->
                        <div id="invoiceTotalsSection" style="background: var(--neutral-50); padding: 2rem; border-radius: 12px; border: 2px solid var(--neutral-300);">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; max-width: 400px; margin-left: auto;">
                                <div style="text-align: right; font-weight: 600; color: var(--neutral-700);">Subtotal:</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.125rem; color: var(--neutral-900);" id="invoiceSubtotal">$0.00</div>
                                
                                <div style="text-align: right; font-weight: 600; color: var(--neutral-700);" id="taxLabel">Tax (8.25%):</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.125rem; color: var(--neutral-900);" id="invoiceTax">$0.00</div>
                                
                                <div style="text-align: right; font-weight: 700; font-size: 1.25rem; color: var(--primary-900); padding-top: 1rem; border-top: 2px solid var(--neutral-400);">TOTAL:</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.5rem; color: var(--primary-700); padding-top: 1rem; border-top: 2px solid var(--neutral-400);" id="invoiceTotal">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="position: sticky; bottom: 0; background: white; padding-top: 1.5rem; margin-top: 2rem; border-top: 2px solid var(--neutral-200); z-index: 100;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success" style="font-size: 1.125rem; padding: 0.875rem 2rem;">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Assignment Modal -->
    <div class="modal-overlay" id="bulkAssignModal">
        <div class="modal">
            <div class="modal-header">
                <h2>üë• Bulk Assignment</h2>
                <button class="modal-close" onclick="closeModal('bulkAssignModal')">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Products</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 2px solid var(--neutral-300); border-radius: 8px; padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="selectAllProducts" onchange="toggleAllProducts()" style="width: 18px; height: 18px;">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="productCheckboxList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="bulkAssignTo" class="search-input">
                        <option value="">-- Select Person --</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mode</label>
                    <select id="assignmentMode" class="search-input">
                        <option value="replace">Replace existing</option>
                        <option value="add">Add to existing</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulkAssignModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkAssignment()">
                        <i class="fa-solid fa-floppy-disk"></i> Save Assignments
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
    const VENDOR_LOGOS = {
    'autochlor': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/autochlor.jpg',
    'bakemark': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/bakemark.jpg',
    'formosa': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/formosa.jpg',
    'formosafoods': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/formosa.jpg',
    'formosa foods': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/formosa.jpg',
    'northfoodgroup': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/northfoodgroup.jpg',
    'north food group': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/northfoodgroup.jpg',
    'pacific': 'https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/jengchi/pacific.jpg'
};

        let inventoryData = [];
        let filteredData = [];
        let invoicesData = [];
        let filteredInvoices = [];
        let deleteMode = false;
        let selectedItems = new Set();
        let selectedVendorMonths = [];
        let vendorDistributionChart, vendorPriceChart, priceHistoryChart;
        let vendorSpendingCharts = {};
        let selectedInvoiceProducts = [];
        const TAX_RATE = 0.0825; // 8.25%

        async function initializeApp() {
            showLoading(true);
            try {
                await loadAllData();
                renderInventoryTable();
                renderQuickEditTable();
                updateRecordCount();
                initializeVendorMonthSelector();
                showAlert('System initialized successfully', 'success');
            } catch (error) {
                console.error('Init error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function loadAllData() {
            await Promise.all([
                loadInventoryData(),
                loadInvoices(),
                loadAnalytics()
            ]);
        }

        async function loadInventoryData() {
            try {
                const { data, error } = await supabaseClient
                    .from('purchase_history')
                    .select('*')
                    .order('purchase_date', { ascending: false });
                if (error) throw error;
                inventoryData = data || [];
                filteredData = [...inventoryData];
                populateVendorFilter();
                populateProductSelects();
                populateInvoiceVendorSelect();
                populateInvoiceVendorDropdown();
            } catch (error) {
                console.error('Load inventory error:', error);
            }
        }

        function toggleProductSearch() {
            const searchSection = document.getElementById('productSearchSection');
            const isHidden = searchSection.style.display === 'none';
            searchSection.style.display = isHidden ? 'block' : 'none';
            
            if (isHidden) {
                document.getElementById('invoiceProductSearch').focus();
            }
        }

        async function loadInvoices() {
            try {
                const { data, error } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .order('invoice_date', { ascending: false });
                if (error) throw error;
                invoicesData = data || [];
                filteredInvoices = [...invoicesData];
                renderInvoicesTable();
            } catch (error) {
                console.error('Load invoices error:', error);
            }
        }

        async function loadAnalytics() {
            const uniqueProducts = new Set(inventoryData.map(i => i.product_name)).size;
            const activeVendors = new Set(inventoryData.map(i => i.vendor).filter(v => v)).size;
            const prices = inventoryData.map(i => parseFloat(i.unit_price || 0));
            const avgPrice = prices.length > 0 ? prices.reduce((a,b) => a+b, 0) / prices.length : 0;
            const totalValue = prices.reduce((a,b) => a+b, 0);

            document.getElementById('metricTotalProducts').textContent = uniqueProducts;
            document.getElementById('metricActiveVendors').textContent = activeVendors;
            document.getElementById('metricAvgPrice').textContent = '$' + avgPrice.toFixed(2);
            document.getElementById('metricTotalValue').textContent = '$' + totalValue.toFixed(2);

            renderVendorDistributionChart();
            renderVendorsTable();
        }

        function getVendorLogo(vendorName) {
            if (!vendorName) return null;
            const vendorKey = vendorName.toLowerCase().replace(/\s+/g, '');
            return VENDOR_LOGOS[vendorKey] || VENDOR_LOGOS[vendorName.toLowerCase()] || null;
        }

        function initializeVendorMonthSelector() {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const container = document.getElementById('vendorMonthSelector');
            container.innerHTML = months.map((month, idx) => {
                return `<div class="month-chip" data-month="${idx + 1}" onclick="toggleVendorMonth(${idx + 1})">${month}</div>`;
            }).join('');
        }

        function toggleVendorMonth(monthNum) {
            const chip = document.querySelector(`#vendorMonthSelector [data-month="${monthNum}"]`);
            chip.classList.toggle('selected');
            
            const index = selectedVendorMonths.indexOf(monthNum);
            if (index > -1) {
                selectedVendorMonths.splice(index, 1);
            } else {
                selectedVendorMonths.push(monthNum);
            }
            
            loadVendorSpendingAnalysis();
        }

        async function loadVendorSpendingAnalysis() {
            const year = document.getElementById('vendorSpendingYear').value;
            const selectedMonths = selectedVendorMonths.length > 0 ? selectedVendorMonths : [1,2,3,4,5,6,7,8,9,10,11,12];
            
            showLoading(true);
            try {
                const filteredInvoices = invoicesData.filter(inv => {
                    const invDate = new Date(inv.invoice_date);
                    const invYear = invDate.getFullYear().toString();
                    const invMonth = invDate.getMonth() + 1;
                    return invYear === year && selectedMonths.includes(invMonth);
                });

                const vendorData = {};
                filteredInvoices.forEach(inv => {
                    if (!vendorData[inv.vendor]) {
                        vendorData[inv.vendor] = {
                            total: 0,
                            months: {},
                            invoiceCount: 0
                        };
                    }
                    
                    const month = new Date(inv.invoice_date).getMonth() + 1;
                    if (!vendorData[inv.vendor].months[month]) {
                        vendorData[inv.vendor].months[month] = 0;
                    }
                    
                    const amount = parseFloat(inv.total || inv.amount || 0);
                    vendorData[inv.vendor].months[month] += amount;
                    vendorData[inv.vendor].total += amount;
                    vendorData[inv.vendor].invoiceCount++;
                });

                renderVendorSpendingCards(vendorData, year, selectedMonths);
                
            } catch (error) {
                console.error('Vendor spending analysis error:', error);
                showAlert('Error loading vendor spending analysis', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderVendorSpendingCards(vendorData, year, selectedMonths) {
            const container = document.getElementById('vendorSpendingContent');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            if (Object.keys(vendorData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <h3>No Invoice Data Available</h3>
                        <p>No invoices found for the selected year and months.</p>
                    </div>
                `;
                return;
            }

            const sortedVendors = Object.entries(vendorData).sort((a, b) => b[1].total - a[1].total);
            
            let html = '';
            
            sortedVendors.forEach(([vendor, data]) => {
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : `<div class="vendor-image" style="display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 2rem; color: var(--neutral-500); background: var(--neutral-100);">${vendor.substring(0, 2).toUpperCase()}</div>`;
                
                html += `
                    <div class="vendor-card">
                        <div class="vendor-card-header">
                            ${logoHtml}
                            <div style="flex: 1;">
                                <div class="vendor-card-title">${vendor}</div>
                                <div style="color: var(--neutral-600); font-size: 0.9375rem; margin-top: 0.5rem;">
                                    ${data.invoiceCount} invoices ‚Ä¢ Year ${year}
                                </div>
                            </div>
                            <div class="vendor-total-card">
                                <div class="vendor-total-label">Total Spent</div>
                                <div class="vendor-total-value">$${data.total.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="vendor-monthly-grid">
                `;
                
                selectedMonths.sort((a, b) => a - b).forEach(month => {
                    const amount = data.months[month] || 0;
                    html += `
                        <div class="vendor-month-card">
                            <div class="vendor-month-label">${monthNames[month - 1]}</div>
                            <div class="vendor-month-value">$${amount.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div class="chart-container" style="margin-top: 2rem;">
                            <h3>üìä Monthly Spending Trend - ${vendor}</h3>
                            <div class="chart-wrapper">
                                <canvas id="vendorChart_${vendor.replace(/\s+/g, '_')}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            setTimeout(() => {
                sortedVendors.forEach(([vendor, data]) => {
                    renderVendorChart(vendor, data, selectedMonths, monthNames);
                });
            }, 100);
        }

        function renderVendorChart(vendor, data, selectedMonths, monthNames) {
            const canvasId = `vendorChart_${vendor.replace(/\s+/g, '_')}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (vendorSpendingCharts[vendor]) {
                vendorSpendingCharts[vendor].destroy();
            }
            
            const labels = selectedMonths.sort((a, b) => a - b).map(m => monthNames[m - 1]);
            const amounts = selectedMonths.sort((a, b) => a - b).map(m => data.months[m] || 0);
            
            vendorSpendingCharts[vendor] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: amounts,
                        backgroundColor: 'rgba(44, 86, 136, 0.8)',
                        borderColor: '#2c5688',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '$' + v.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            if (filteredData.length === 0) {
                tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No Items Found</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = filteredData.map((item, idx) => {
                const timestamp = new Date().getTime() + idx;
                const imageUrl = item.image_path 
                    ? `${SUPABASE_URL}/storage/v1/object/public/jengchi/${item.image_path}?t=${timestamp}`
                    : 'https://via.placeholder.com/60';

                let assignedArray = [];
                try {
                    if (Array.isArray(item.assigned_to)) {
                        assignedArray = item.assigned_to;
                    } else if (typeof item.assigned_to === 'string') {
                        const s = item.assigned_to.trim();
                        if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                            assignedArray = JSON.parse(s);
                        }
                    }
                } catch (e) {
                    assignedArray = [];
                }
                assignedArray = assignedArray.filter(x => typeof x === 'string' && x.trim() !== '');

                const checkboxCell = deleteMode ? `
                    <td>
                        <input type="checkbox" 
                               class="item-checkbox" 
                               ${selectedItems.has(item.id) ? 'checked' : ''}
                               onchange="toggleItemSelection('${item.id}')" 
                               style="cursor: pointer; width: 18px; height: 18px;">
                    </td>
                ` : '';

                const assignmentBadges = assignedArray.length > 0 
                    ? assignedArray.map(person => `
                        <span class="assignment-badge" 
                              onclick="removeSingleAssignment('${item.id}', '${person}')"
                              title="Click to remove ${person}">
                            ${person.charAt(0).toUpperCase() + person.slice(1)}
                        </span>`
                      ).join(' ')
                    : '';

                const assignmentSelect = assignedArray.length === 0 ? `
                    <select class="assignment-select" 
                            onchange="quickAssign('${item.item_code}', this.value); this.value='';"
                            style="margin-left: 0.5rem; width: auto; min-width: 100px;">
                        <option value="">+ Assign</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                    </select>`
                : '';

                return `
                    <tr>
                        ${checkboxCell}
                        <td><img src="${imageUrl}" class="product-image" onerror="this.src='https://via.placeholder.com/60'"></td>
                        <td><span class="vendor-badge">${item.vendor || 'Unknown'}</span></td>
                        <td><span class="item-number">${item.item_code || 'N/A'}</span></td>
                        <td>${item.product_name || 'N/A'}</td>
                        <td><span class="price-cell">$${parseFloat(item.unit_price || 0).toFixed(2)}</span></td>
                        <td>${formatDate(item.purchase_date)}</td>
                        <td>
                            ${assignmentBadges}
                            ${assignmentSelect}
                        </td>
                        <td>
                            <button class="btn btn-icon btn-secondary" onclick="editItem('${item.id}')" title="Edit">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-icon btn-danger" onclick="deleteSingleItem('${item.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function renderQuickEditTable() {
            const productMap = new Map();
            
            let dataToShow = inventoryData;
            const assignFilter = document.getElementById('quickEditAssignFilter')?.value;
            const searchTerm = document.getElementById('quickEditSearch')?.value.toLowerCase() || '';

            if (assignFilter) {
                if (assignFilter === 'unassigned') {
                    dataToShow = dataToShow.filter(item => !item.assigned_to || item.assigned_to.length === 0);
                } else {
                    dataToShow = dataToShow.filter(item => {
                        if (!item.assigned_to) return false;
                        const assigned = Array.isArray(item.assigned_to) ? item.assigned_to : [];
                        return assigned.includes(assignFilter);
                    });
                }
            }

            if (searchTerm) {
                dataToShow = dataToShow.filter(item => {
                    const name = (item.product_name || '').toLowerCase();
                    const code = (item.item_code || '').toLowerCase();
                    return name.includes(searchTerm) || code.includes(searchTerm);
                });
            }

            dataToShow.forEach(item => {
                if (!item.item_code) return;
                
                if (!productMap.has(item.item_code)) {
                    productMap.set(item.item_code, {
                        code: item.item_code,
                        name: item.product_name || 'Unnamed',
                        vendor: item.vendor || 'Unknown',
                        price: item.unit_price || 0,
                        image: item.image_path || null,
                        count: 0
                    });
                }
                
                const entry = productMap.get(item.item_code);
                entry.count++;
            });

            const products = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            
            const tbody = document.getElementById('quickEditTableBody');
            document.getElementById('quickEditCount').textContent = `${products.length} unique products`;

            if (products.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üì¶</div><h3>No Products Found</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = products.map(p => {
                const imageUrl = p.image 
                    ? `${SUPABASE_URL}/storage/v1/object/public/jengchi/${p.image}?t=${Date.now()}`
                    : 'https://via.placeholder.com/60';

                return `
                    <tr>
                        <td><img src="${imageUrl}" class="product-image" onerror="this.src='https://via.placeholder.com/60'"></td>
                        <td><span class="item-number">${p.code}</span></td>
                        <td>${p.name}</td>
                        <td><span class="vendor-badge">${p.vendor}</span></td>
                        <td><span class="price-cell">$${parseFloat(p.price).toFixed(2)}</span></td>
                        <td><span style="font-weight: 600; color: var(--primary-700);">${p.count} items</span></td>
                        <td>
                            <button class="btn btn-primary" onclick="openQuickEditModal('${p.code}', ${p.count})">
                                <i class="fas fa-edit"></i> Edit All
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterQuickEdit() {
            renderQuickEditTable();
        }

        async function openQuickEditModal(itemCode, count) {
            const items = inventoryData.filter(i => i.item_code === itemCode);
            if (items.length === 0) return;

            const firstItem = items[0];
            
            document.getElementById('quickEditItemCode').value = itemCode;
            document.getElementById('quickEditItemCodeDisplay').value = itemCode;
            document.getElementById('quickEditProductName').value = firstItem.product_name || '';
            document.getElementById('quickEditVendor').value = firstItem.vendor || '';
            document.getElementById('quickEditPrice').value = firstItem.unit_price || '';
            document.getElementById('quickEditImage').value = firstItem.image_path || '';
            document.getElementById('affectedCount').textContent = count;
            
            openModal('quickEditModal');
        }

        async function saveQuickEdit(event) {
            event.preventDefault();
            showLoading(true);
            
            try {
                const itemCode = document.getElementById('quickEditItemCode').value;
                const productName = document.getElementById('quickEditProductName').value;
                const vendor = document.getElementById('quickEditVendor').value;
                const price = parseFloat(document.getElementById('quickEditPrice').value);
                const imagePath = document.getElementById('quickEditImage').value.trim() || null;

                const { error } = await supabaseClient
                    .from('purchase_history')
                    .update({
                        product_name: productName,
                        vendor: vendor,
                        unit_price: price,
                        image_path: imagePath
                    })
                    .eq('item_code', itemCode);

                if (error) throw error;

                showAlert('All matching items updated successfully!', 'success');
                closeModal('quickEditModal');
                await loadInventoryData();
                renderInventoryTable();
                renderQuickEditTable();
                applyFilters();

            } catch (error) {
                console.error('Quick edit error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function quickAssign(itemCode, person) {
            if (!person || !itemCode) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => item.item_code === itemCode);
                if (itemsToUpdate.length === 0) {
                    showAlert('No items found with this item code', 'error');
                    return;
                }

                for (const item of itemsToUpdate) {
                    const currentAssigned = Array.isArray(item.assigned_to) ? item.assigned_to : [];
                    if (!currentAssigned.includes(person)) {
                        const newAssigned = [...currentAssigned, person];
                        const { error } = await supabaseClient
                            .from('purchase_history')
                            .update({ assigned_to: newAssigned })
                            .eq('id', item.id);

                        if (error) throw error;
                    }
                }

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} assigned to all items with code: ${itemCode}`, 'success');
                
                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Quick assign error:', error);
                showAlert('Error updating assignment', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function removeSingleAssignment(itemId, person) {
            showLoading(true);
            try {
                const currentItem = inventoryData.find(item => item.id === itemId);
                if (!currentItem) {
                    showAlert('Item not found. Please refresh the page.', 'error');
                    return;
                }

                const existing = currentItem.assigned_to || [];
                const existingArray = Array.isArray(existing) ? existing : [];
                const newAssignment = existingArray.filter(p => p !== person);

                const { error } = await supabaseClient
                    .from('purchase_history')
                    .update({ assigned_to: newAssignment })
                    .eq('id', itemId);

                if (error) throw error;

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} removed from assignment`, 'success');

                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Remove assignment error:', error);
                showAlert('Error removing assignment: ' + (error.message || 'Unknown'), 'error');
            } finally {
                showLoading(false);
            }
        }

        function populateInvoiceVendorSelect() {
            const vendors = [...new Set(invoicesData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorSelect');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function filterInvoicesByVendor() {
            const vendorFilter = document.getElementById('invoiceVendorSelect').value;
            const yearFilter = document.getElementById('invoiceYearSelect').value;
            
            let data = [...invoicesData];
            
            if (vendorFilter) {
                data = data.filter(i => i.vendor === vendorFilter);
            }
            
            if (yearFilter) {
                data = data.filter(i => new Date(i.invoice_date).getFullYear().toString() === yearFilter);
            }
            
            filteredInvoices = data;
            renderInvoicesTable();
        }

        async function loadProductAnalytics() {
            const productName = document.getElementById('analyticsProductSelect').value;
            if (!productName) {
                document.getElementById('productAnalysisSection').style.display = 'none';
                return;
            }

            showLoading(true);
            try {
                const productItems = inventoryData.filter(i => i.product_name === productName);
                
                if (productItems.length === 0) {
                    showAlert('No data found for this product', 'error');
                    return;
                }

                document.getElementById('productAnalysisSection').style.display = 'block';
                
                renderPriceComparison(productItems);
                renderVendorPriceChart(productItems);
                renderPriceHistoryChart(productItems);
                renderVarianceAnalysis(productItems);

            } catch (error) {
                console.error('Analytics error:', error);
                showAlert('Error loading analytics', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderPriceComparison(data) {
            const prices = data.map(i => parseFloat(i.unit_price));
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const avgPrice = prices.reduce((a,b) => a+b, 0) / prices.length;
            
            const minItem = data.find(i => parseFloat(i.unit_price) === minPrice);
            const maxItem = data.find(i => parseFloat(i.unit_price) === maxPrice);

            const container = document.getElementById('priceComparison');
            container.innerHTML = `
                <div class="comparison-card lowest">
                    <div class="comparison-label">üí∞ Lowest Price</div>
                    <div class="comparison-value" style="color: var(--success-600);">$${minPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${minItem.vendor}</div>
                    <div class="comparison-date">${formatDate(minItem.purchase_date)}</div>
                </div>
                <div class="comparison-card average">
                    <div class="comparison-label">üìä Average Price</div>
                    <div class="comparison-value" style="color: var(--primary-600);">$${avgPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">Across ${data.length} purchases</div>
                    <div class="comparison-date">All vendors</div>
                </div>
                <div class="comparison-card highest">
                    <div class="comparison-label">üìà Highest Price</div>
                    <div class="comparison-value" style="color: var(--warning-600);">$${maxPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${maxItem.vendor}</div>
                    <div class="comparison-date">${formatDate(maxItem.purchase_date)}</div>
                </div>
                <div class="comparison-card">
                    <div class="comparison-label">üìâ Price Variance</div>
                    <div class="comparison-value" style="color: var(--accent-500);">${((maxPrice - minPrice) / minPrice * 100).toFixed(1)}%</div>
                    <div class="comparison-vendor">Spread: $${(maxPrice - minPrice).toFixed(2)}</div>
                    <div class="comparison-date">Max vs Min</div>
                </div>
            `;
        }

        function renderVendorPriceChart(data) {
            const vendorPrices = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorPrices[vendor]) vendorPrices[vendor] = [];
                vendorPrices[vendor].push(parseFloat(item.unit_price));
            });

            const vendors = Object.keys(vendorPrices);
            const avgPrices = vendors.map(v => {
                const sum = vendorPrices[v].reduce((a,b) => a+b, 0);
                return sum / vendorPrices[v].length;
            });
            const minPrices = vendors.map(v => Math.min(...vendorPrices[v]));
            const maxPrices = vendors.map(v => Math.max(...vendorPrices[v]));

            const ctx = document.getElementById('vendorPriceChart');
            if (vendorPriceChart) vendorPriceChart.destroy();
            vendorPriceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vendors,
                    datasets: [
                        {
                            label: 'Minimum Price',
                            data: minPrices,
                            backgroundColor: 'rgba(5, 150, 105, 0.8)',
                            borderColor: '#059669',
                            borderWidth: 2
                        },
                        {
                            label: 'Average Price',
                            data: avgPrices,
                            backgroundColor: 'rgba(44, 86, 136, 0.8)',
                            borderColor: '#2c5688',
                            borderWidth: 2
                        },
                        {
                            label: 'Maximum Price',
                            data: maxPrices,
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: '#dc2626',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderPriceHistoryChart(data) {
            const sortedData = [...data].sort((a,b) => new Date(a.purchase_date) - new Date(b.purchase_date));
            
            const vendorData = {};
            sortedData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorData[vendor]) vendorData[vendor] = [];
                vendorData[vendor].push({
                    x: item.purchase_date,
                    y: parseFloat(item.unit_price)
                });
            });

            const colors = ['#2c5688', '#f59e0b', '#10b981', '#dc2626', '#8b5cf6', '#ec4899'];
            const datasets = Object.keys(vendorData).map((vendor, idx) => ({
                label: vendor,
                data: vendorData[vendor],
                borderColor: colors[idx % colors.length],
                backgroundColor: colors[idx % colors.length] + '40',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8
            }));

            const ctx = document.getElementById('priceHistoryChart');
            if (priceHistoryChart) priceHistoryChart.destroy();
            priceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            title: { display: true, text: 'Purchase Date' }
                        },
                        y: {
                            title: { display: true, text: 'Price ($)' },
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderVarianceAnalysis(data) {
            const vendorStats = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { prices: [], count: 0 };
                }
                vendorStats[vendor].prices.push(parseFloat(item.unit_price));
                vendorStats[vendor].count++;
            });

            const analysis = Object.keys(vendorStats).map(vendor => {
                const prices = vendorStats[vendor].prices;
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const avg = prices.reduce((a,b) => a+b, 0) / prices.length;
                const variance = max - min;
                const variancePct = (variance / min * 100).toFixed(1);

                return { vendor, min, max, avg, variance, variancePct, count: prices.length };
            }).sort((a,b) => a.avg - b.avg);

            const container = document.getElementById('varianceAnalysis');
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--neutral-100); font-weight: 700;">
                            <th style="padding: 1rem; text-align: left;">Vendor</th>
                            <th style="padding: 1rem; text-align: right;">Purchases</th>
                            <th style="padding: 1rem; text-align: right;">Min Price</th>
                            <th style="padding: 1rem; text-align: right;">Avg Price</th>
                            <th style="padding: 1rem; text-align: right;">Max Price</th>
                            <th style="padding: 1rem; text-align: right;">Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.map(stat => `
                            <tr style="border-bottom: 1px solid var(--neutral-200);">
                                <td style="padding: 1rem;"><span class="vendor-badge">${stat.vendor}</span></td>
                                <td style="padding: 1rem; text-align: right;">${stat.count}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--success-600); font-weight: 600;">$${stat.min.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600;">$${stat.avg.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--warning-600); font-weight: 600;">$${stat.max.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-family: var(--font-mono); font-weight: 700; color: var(--accent-500);">
                                    ${stat.variancePct}%
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTableBody');
            document.getElementById('invoiceCount').textContent = `${filteredInvoices.length} invoices`;
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">üí∞</div><h3>No Invoices</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = filteredInvoices.map(inv => `
                <tr>
                    <td><span class="vendor-badge">${inv.vendor}</span></td>
                    <td><span class="item-number">${inv.invoice_number}</span></td>
                    <td><span class="item-number">${inv.check_number || '-'}</span></td>
                    <td>${formatDate(inv.invoice_date)}</td>
                    <td><span class="price-cell">$${parseFloat(inv.total || inv.amount || 0).toFixed(2)}</span></td>
                    <td>${inv.notes || '-'}</td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="editInvoice('${inv.id}')" title="Edit Invoice">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteInvoice('${inv.id}')" title="Delete Invoice">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderVendorDistributionChart() {
            const vendorCounts = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            const ctx = document.getElementById('vendorDistributionChart');
            if (vendorDistributionChart) vendorDistributionChart.destroy();
            vendorDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(vendorCounts),
                    datasets: [{
                        data: Object.values(vendorCounts),
                        backgroundColor: ['#2c5688','#f59e0b','#10b981','#dc2626','#8b5cf6','#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderVendorsTable() {
            const tbody = document.getElementById('vendorsTableBody');
            const vendorStats = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { count: 0, lastPurchase: null, totalValue: 0 };
                }
                vendorStats[vendor].count++;
                vendorStats[vendor].totalValue += parseFloat(item.unit_price || 0);
                const purchaseDate = new Date(item.purchase_date);
                if (!vendorStats[vendor].lastPurchase || purchaseDate > vendorStats[vendor].lastPurchase) {
                    vendorStats[vendor].lastPurchase = purchaseDate;
                }
            });

            const vendors = Object.keys(vendorStats).sort();
            document.getElementById('vendorCount').textContent = `${vendors.length} vendors`;

            tbody.innerHTML = vendors.map(vendor => {
                const stats = vendorStats[vendor];
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : '<div style="width: 120px; height: 120px; background: var(--neutral-200); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--neutral-500); font-size: 2rem;">' + vendor.substring(0, 2).toUpperCase() + '</div>';
                
                return `
                    <tr>
                        <td>${logoHtml}</td>
                        <td><span class="vendor-badge">${vendor}</span></td>
                        <td>${stats.count}</td>
                        <td>${stats.lastPurchase ? formatDate(stats.lastPurchase.toISOString()) : 'N/A'}</td>
                        <td><span class="price-cell">$${stats.totalValue.toFixed(2)}</span></td>
                    </tr>
                `;
            }).join('');
        }

        function performSearch() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            filteredData = inventoryData.filter(item => {
                const name = (item.product_name || '').toLowerCase();
                const code = (item.item_code || '').toLowerCase();
                const vendor = (item.vendor || '').toLowerCase();
                return name.includes(term) || code.includes(term) || vendor.includes(term);
            });
            applyFilters();
        }

        function applyFilters() {
            const vendorFilter = document.getElementById('vendorFilter').value;
            const yearFilter = document.getElementById('yearFilter').value;
            const assignedFilter = document.getElementById('assignedToFilter').value;

            let data = filteredData.length > 0 ? filteredData : inventoryData;

            if (vendorFilter) {
                data = data.filter(i => i.vendor === vendorFilter);
            }

            if (yearFilter) {
                data = data.filter(i => new Date(i.purchase_date).getFullYear().toString() === yearFilter);
            }

            if (assignedFilter) {
                if (assignedFilter === 'unassigned') {
                    data = data.filter(i => !i.assigned_to || i.assigned_to.length === 0);
                } else {
                    data = data.filter(i => {
                        if (!i.assigned_to) return false;
                        return Array.isArray(i.assigned_to) && i.assigned_to.includes(assignedFilter);
                    });
                }
            }

            filteredData = data;
            renderInventoryTable();
            updateRecordCount();
        }

        function populateVendorFilter() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('vendorFilter');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function populateProductSelects() {
            const uniqueProducts = [...new Set(inventoryData.map(i => i.product_name).filter(p => p))].sort();
            const select = document.getElementById('analyticsProductSelect');
            select.innerHTML = '<option value="">Choose a product to compare prices...</option>';
            uniqueProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = `${filteredData.length} of ${inventoryData.length} items`;
        }

      
      function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    // Parse date string manually to avoid timezone conversion
    const parts = dateString.split('T')[0].split('-'); // Get YYYY-MM-DD part
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Create date object using local timezone components
    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}
      
      
      
      
      
      
      
              function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'quickEdit') {
                renderQuickEditTable();
            } else if (tabName === 'vendorSpending') {
                loadVendorSpendingAnalysis();
            }
        }

        function exportToCSV() {
            const headers = ['Vendor','Item No.','Description','Price','Date','Assigned To'];
            const rows = filteredData.map(item => [
                item.vendor || '',
                item.item_code || '',
                item.product_name || '',
                item.unit_price || '',
                item.purchase_date || '',
                (item.assigned_to && item.assigned_to[0]) || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showAlert('Exported successfully', 'success');
        }

     function openAddItemModal() {
    document.getElementById('itemModalTitle').textContent = 'Add Item';
    document.getElementById('itemForm').reset();
    document.getElementById('itemForm').removeAttribute('data-edit-id');
    document.getElementById('itemEffectiveDate').valueAsDate = new Date();
    populateVendorDropdownInModal(); // ‚Üê ADD THIS LINE
    openModal('itemModal');
}


async function editItem(id) {
    console.log('üîç editItem called with ID:', id, 'Type:', typeof id);
    console.log('üì¶ inventoryData length:', inventoryData.length);
    console.log('üì¶ First item ID:', inventoryData[0]?.id, 'Type:', typeof inventoryData[0]?.id);
    
    showLoading(true);
    try {
        // Try to find item with flexible ID comparison (handles string vs UUID vs number)
        const item = inventoryData.find(i => {
            // Convert both to strings for comparison to handle type mismatches
            return String(i.id) === String(id);
        });
        
        if (!item) {
            console.error('‚ùå Item not found! ID:', id);
            console.error('Available IDs:', inventoryData.map(i => i.id));
            showAlert('Item not found. Please refresh the page and try again.', 'error');
            return;
        }

        console.log('‚úÖ Item found:', item);

        // Set form title and edit ID FIRST
        document.getElementById('itemModalTitle').textContent = 'Edit Item';
        document.getElementById('itemForm').dataset.editId = id;
        
        // Populate vendor dropdown BEFORE setting values
        populateVendorDropdownInModal();
        
        // Now set all the field values
        document.getElementById('itemProductName').value = item.product_name || '';
        document.getElementById('itemNumber').value = item.item_code || '';
        document.getElementById('itemProductImage').value = item.image_path || '';
        document.getElementById('itemVendor').value = item.vendor || '';
        document.getElementById('itemPrice').value = item.unit_price || '';
        document.getElementById('itemEffectiveDate').value = item.purchase_date || '';
        
        // Set assigned_to
        const assignedToSelect = document.getElementById('itemAssignedTo');
        const assignedArray = Array.isArray(item.assigned_to) ? item.assigned_to : [];
        Array.from(assignedToSelect.options).forEach(option => {
            option.selected = assignedArray.includes(option.value);
        });
        
        // Open modal
        openModal('itemModal');
        
    } catch (error) {
        console.error('üí• Edit item error:', error);
        showAlert('Error loading item: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}




function populateVendorDropdownInModal() {
    const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
    const select = document.getElementById('itemVendor');
    const currentValue = select.value; // Save current selection
    
    select.innerHTML = '<option value="">-- Select Vendor --</option>';
    vendors.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
    
    // Restore selection if it exists
    if (currentValue) {
        select.value = currentValue;
    }
}



        function openAddInvoiceModal() {
            document.getElementById('invoiceModalTitle').textContent = 'Add Invoice';
            document.getElementById('invoiceForm').reset();
            document.getElementById('invoiceForm').removeAttribute('data-edit-id');
            document.getElementById('invoiceDate').valueAsDate = new Date();
            document.getElementById('invoiceItemsCount').value = '0 items';
            document.getElementById('invoiceTaxEnabled').checked = true;
            selectedInvoiceProducts = [];
            renderSelectedInvoiceProducts();
            populateInvoiceVendorDropdown();
            document.getElementById('productSearchSection').style.display = 'none';
            document.getElementById('invoiceProductResults').style.display = 'none';
            openModal('invoiceModal');
        }

        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        async function saveVendorItem(event) {
            event.preventDefault();
            showLoading(true);
            try {
                const assignedToSelect = document.getElementById('itemAssignedTo');
                const assignedTo = Array.from(assignedToSelect.selectedOptions).map(o => o.value);
                const editId = document.getElementById('itemForm').dataset.editId;

                const itemData = {
                    product_name: document.getElementById('itemProductName').value,
                    item_code: document.getElementById('itemNumber').value,
                    vendor: document.getElementById('itemVendor').value,
                    unit_price: parseFloat(document.getElementById('itemPrice').value),
                    purchase_date: document.getElementById('itemEffectiveDate').value,
                    image_path: document.getElementById('itemProductImage').value.trim() || null,
                    assigned_to: assignedTo
                };

                if (editId) {
                    const { error } = await supabaseClient.from('purchase_history').update(itemData).eq('id', editId);
                    if (error) throw error;
                    showAlert('Item updated!', 'success');
                } else {
                    const { error } = await supabaseClient.from('purchase_history').insert([itemData]);
                    if (error) throw error;
                    showAlert('Item added!', 'success');
                }

                closeModal('itemModal');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();
            } catch (error) {
                console.error('Save error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== ENHANCED INVOICE FUNCTIONS WITH WEIGHT & PRICE PER UNIT ==========

        function calculateInvoiceTotals() {
            const subtotal = selectedInvoiceProducts.reduce((sum, p) => {
                const hasWeight = p.has_weight && p.weight && p.weight > 0;
                if (hasWeight) {
                    return sum + (parseFloat(p.weight || 0) * parseFloat(p.price_per_unit || 0));
                } else {
                    return sum + (parseFloat(p.quantity || 0) * parseFloat(p.invoice_price || 0));
                }
            }, 0);
            
            const taxEnabled = document.getElementById('invoiceTaxEnabled').checked;
            const taxAmount = taxEnabled ? subtotal * TAX_RATE : 0;
            const total = subtotal + taxAmount;
            
            document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('invoiceTax').textContent = '$' + taxAmount.toFixed(2);
            document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);
            
            // Update tax label
            const taxLabel = document.getElementById('taxLabel');
            if (taxEnabled) {
                taxLabel.textContent = 'Tax (8.25%):';
                taxLabel.style.color = 'var(--neutral-700)';
            } else {
                taxLabel.textContent = 'Tax (Disabled):';
                taxLabel.style.color = 'var(--neutral-400)';
            }
            
            return { subtotal, taxAmount, total, taxEnabled };
        }

        function updateInvoiceVendorField() {
            const vendor = document.getElementById('invoiceVendorDropdown').value;
            if (vendor) {
                searchInvoiceProducts();
            }
        }

        function searchInvoiceProducts() {
            const searchTerm = document.getElementById('invoiceProductSearch').value.toLowerCase();
            const selectedVendor = document.getElementById('invoiceVendorDropdown').value;
            const resultsDiv = document.getElementById('invoiceProductResults');
            
            if (!searchTerm && !selectedVendor) {
                resultsDiv.style.display = 'none';
                return;
            }

            let filteredProducts = inventoryData.filter(item => {
                const matchesSearch = !searchTerm || 
                    (item.product_name || '').toLowerCase().includes(searchTerm) ||
                    (item.item_code || '').toLowerCase().includes(searchTerm);
                
                const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
                
                return matchesSearch && matchesVendor;
            });

            const productMap = new Map();
            filteredProducts.forEach(item => {
                if (!productMap.has(item.item_code)) {
                    productMap.set(item.item_code, item);
                }
            });

            const uniqueProducts = Array.from(productMap.values());

            if (uniqueProducts.length === 0) {
                resultsDiv.innerHTML = '<p style="color: var(--neutral-500); text-align: center; padding: 1rem;">No products found</p>';
                resultsDiv.style.display = 'block';
                return;
            }

            resultsDiv.style.display = 'block';
            resultsDiv.innerHTML = uniqueProducts.map(item => {
                const imageUrl = item.image_path 
                    ? `${SUPABASE_URL}/storage/v1/object/public/jengchi/${item.image_path}?t=${Date.now()}`
                    : 'https://via.placeholder.com/50';
                
                const isSelected = selectedInvoiceProducts.some(p => p.item_code === item.item_code);
                
                return `
                    <div class="invoice-product-item ${isSelected ? 'selected' : ''}" 
                         onclick="toggleInvoiceProduct('${item.item_code}')">
                        <img src="${imageUrl}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;" onerror="this.src='https://via.placeholder.com/50'">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; color: var(--neutral-900);">${item.product_name || 'Unnamed'}</div>
                            <div style="font-size: 0.875rem; color: var(--neutral-600);">
                                <span class="item-number">${item.item_code}</span> ‚Ä¢ 
                                <span class="vendor-badge" style="padding: 0.125rem 0.5rem; font-size: 0.75rem;">${item.vendor}</span>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div class="price-cell" style="font-size: 1.125rem;">$${parseFloat(item.unit_price || 0).toFixed(2)}</div>
                            ${isSelected ? '<i class="fas fa-check-circle" style="color: var(--success-600); font-size: 1.25rem;"></i>' : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function toggleInvoiceProduct(itemCode) {
            const existingIndex = selectedInvoiceProducts.findIndex(p => p.item_code === itemCode);
            
            if (existingIndex > -1) {
                selectedInvoiceProducts.splice(existingIndex, 1);
            } else {
                const product = inventoryData.find(item => item.item_code === itemCode);
                if (product) {
                    selectedInvoiceProducts.push({
                        item_code: product.item_code,
                        product_name: product.product_name,
                        vendor: product.vendor,
                        unit_price: product.unit_price,
                        invoice_price: product.unit_price,
                        quantity: 1,
                        weight: null,
                        price_per_unit: null,
                        has_weight: false,
                        image_path: product.image_path,
                        originalItemCode: product.item_code,
                        originalProductName: product.product_name
                    });
                }
            }
            
            renderSelectedInvoiceProducts();
            searchInvoiceProducts();
        }

        function renderSelectedInvoiceProducts() {
            const container = document.getElementById('selectedInvoiceProducts');
            const countLabel = document.getElementById('invoiceProductCount');
            const itemsCountField = document.getElementById('invoiceItemsCount');
            
            const itemCount = selectedInvoiceProducts.length;
            countLabel.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''} selected`;
            itemsCountField.value = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
            
            if (itemCount === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; border: 2px dashed var(--neutral-300);">
                        <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">üì¶</div>
                        <h3 style="color: var(--neutral-600); margin-bottom: 0.5rem;">No Products Added Yet</h3>
                        <p style="color: var(--neutral-500);">Click "Add Item" to search and add products to this invoice</p>
                    </div>
                `;
                calculateInvoiceTotals();
                return;
            }

            container.innerHTML = selectedInvoiceProducts.map((product, idx) => {
                const imageUrl = product.image_path 
                    ? `${SUPABASE_URL}/storage/v1/object/public/jengchi/${product.image_path}?t=${Date.now()}`
                    : 'https://via.placeholder.com/50';
                
                const hasWeight = product.has_weight && product.weight && product.weight > 0;
                const lineTotal = hasWeight 
                    ? (parseFloat(product.weight || 0) * parseFloat(product.price_per_unit || 0)).toFixed(2)
                    : (parseFloat(product.quantity || 0) * parseFloat(product.invoice_price || 0)).toFixed(2);

                return `
                    <div class="selected-product-card" style="display: grid; grid-template-columns: 60px 1fr auto; gap: 1rem; align-items: start; background: white; border: 2px solid var(--success-600); border-radius: 12px; padding: 1.25rem;">
                        <img src="${imageUrl}" onerror="this.src='https://via.placeholder.com/50'" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; box-shadow: var(--shadow-sm);">
                        
                        <div style="display: grid; gap: 0.75rem;">
                            <div>
                                <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Product Name</label>
                                <input type="text" 
                                       class="editable-field" 
                                       value="${product.product_name || ''}"
                                       onchange="updateInvoiceProductField(${idx}, 'product_name', this.value)"
                                       style="width: 100%; font-size: 0.9375rem; font-weight: 600;">
                            </div>
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Item Code</label>
                                    <input type="text" 
                                           class="editable-field" 
                                           value="${product.item_code || ''}"
                                           onchange="updateInvoiceProductField(${idx}, 'item_code', this.value)"
                                           style="width: 100%; font-size: 0.875rem; font-family: var(--font-mono);">
                                    <small style="color: var(--accent-500); font-size: 0.7rem; display: block; margin-top: 0.25rem;">
                                        <i class="fas fa-info-circle"></i> Updates all matching items
                                    </small>
                                </div>
                                
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Vendor</label>
                                    <div style="padding: 0.75rem; background: var(--neutral-100); border-radius: 6px; font-size: 0.875rem; color: var(--neutral-700); font-weight: 600;">
                                        ${product.vendor || ''}
                                    </div>
                                </div>
                            </div>
                            
                            <!-- WEIGHT-BASED PRICING SECTION -->
                            <div style="background: var(--primary-50); padding: 1rem; border-radius: 8px; border: 2px solid var(--primary-200);">
                                <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                                    <input type="checkbox" 
                                           ${hasWeight ? 'checked' : ''}
                                           onchange="toggleWeightMode(${idx}, this.checked)">
                                    <span style="font-weight: 600; color: var(--primary-700);">
                                        <i class="fas fa-weight"></i> Weight-Based Pricing (for meat, seafood, produce)
                                    </span>
                                </label>
                                
                                ${hasWeight ? `
                                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                                        <div>
                                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Weight (lbs) ‚öñÔ∏è</label>
                                            <input type="number" 
                                                   class="editable-field" 
                                                   value="${product.weight || ''}"
                                                   min="0"
                                                   step="0.01"
                                                   placeholder="25.5"
                                                   onchange="updateInvoiceProductField(${idx}, 'weight', this.value)"
                                                   style="width: 100%; font-size: 1.125rem; font-weight: 700; text-align: center;">
                                        </div>
                                        
                                        <div>
                                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Price per lb üíµ</label>
                                            <input type="number" 
                                                   class="editable-field" 
                                                   value="${product.price_per_unit || ''}"
                                                   min="0"
                                                   step="0.01"
                                                   placeholder="3.20"
                                                   onchange="updateInvoiceProductField(${idx}, 'price_per_unit', this.value)"
                                                   style="width: 100%; font-size: 1.125rem; font-weight: 700; font-family: var(--font-mono);">
                                        </div>
                                        
                                        <div>
                                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Calculation</label>
                                            <div style="padding: 0.75rem; background: white; border-radius: 6px; font-size: 0.875rem; color: var(--neutral-700); border: 2px solid var(--neutral-300); font-family: var(--font-mono);">
                                                ${product.weight || 0} √ó $${(product.price_per_unit || 0).toFixed(2)}
                                            </div>
                                        </div>
                                    </div>
                                ` : `
                                    <div style="display: grid; grid-template-columns: 100px 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                                        <div>
                                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Quantity</label>
                                            <input type="number" 
                                                   class="editable-field" 
                                                   value="${product.quantity || 1}"
                                                   min="1"
                                                   step="1"
                                                   onchange="updateInvoiceProductField(${idx}, 'quantity', this.value)"
                                                   style="width: 100%; font-size: 1.125rem; font-weight: 700; text-align: center;">
                                        </div>
                                        
                                        <div>
                                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Price Each üí∞</label>
                                            <input type="number" 
                                                   class="editable-field" 
                                                   value="${product.invoice_price || 0}"
                                                   min="0"
                                                   step="0.01"
                                                   onchange="updateInvoiceProductField(${idx}, 'invoice_price', this.value)"
                                                   style="width: 100%; font-size: 1.125rem; font-weight: 700; font-family: var(--font-mono);">
                                        </div>
                                    </div>
                                `}
                            </div>
                            
                            <!-- LINE TOTAL -->
                            <div>
                                <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Line Total</label>
                                <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary-700); font-family: var(--font-mono); padding: 1rem; background: var(--primary-50); border-radius: 8px; text-align: center; border: 2px solid var(--primary-300);">
                                    $${lineTotal}
                                </div>
                            </div>
                        </div>
                        
                        <div style="text-align: right;">
                            <button type="button" 
                                    class="btn btn-danger btn-icon" 
                                    onclick="removeInvoiceProduct(${idx})"
                                    title="Remove Item"
                                    style="width: 50px; height: 50px; font-size: 1.25rem;">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
            
            calculateInvoiceTotals();
            document.getElementById('productSearchSection').style.display = 'none';
            document.getElementById('invoiceProductSearch').value = '';
            document.getElementById('invoiceProductResults').style.display = 'none';
        }

        function toggleWeightMode(index, enabled) {
            selectedInvoiceProducts[index].has_weight = enabled;
            
            if (enabled) {
                selectedInvoiceProducts[index].weight = selectedInvoiceProducts[index].weight || 1;
                selectedInvoiceProducts[index].price_per_unit = selectedInvoiceProducts[index].invoice_price || 0;
            } else {
                selectedInvoiceProducts[index].quantity = 1;
            }
            
            renderSelectedInvoiceProducts();
        }

        function updateInvoiceProductField(index, field, value) {
            if (field === 'quantity') {
                selectedInvoiceProducts[index][field] = parseInt(value) || 1;
            } else if (field === 'invoice_price' || field === 'weight' || field === 'price_per_unit') {
                selectedInvoiceProducts[index][field] = parseFloat(value) || 0;
            } else {
                selectedInvoiceProducts[index][field] = value;
            }
            
            if (field === 'item_code') {
                selectedInvoiceProducts[index].itemCodeChanged = true;
            } else if (field === 'product_name') {
                selectedInvoiceProducts[index].productNameChanged = true;
            }
            
            renderSelectedInvoiceProducts();
        }

        function removeInvoiceProduct(index) {
            selectedInvoiceProducts.splice(index, 1);
            renderSelectedInvoiceProducts();
            searchInvoiceProducts();
        }

        function populateInvoiceVendorDropdown() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorDropdown');
            select.innerHTML = '<option value="">-- Select Vendor --</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        async function saveInvoice(event) {
            event.preventDefault();
            
            console.log('üîµ saveInvoice started');
            console.log('üîµ selectedInvoiceProducts:', selectedInvoiceProducts);
            
            if (selectedInvoiceProducts.length === 0) {
                showAlert('Please add at least one product to the invoice', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const editId = document.getElementById('invoiceForm').dataset.editId;
                const vendor = document.getElementById('invoiceVendorDropdown').value;
                const totals = calculateInvoiceTotals();

                console.log('üîµ Invoice totals:', totals);

                const invoiceData = {
                    vendor: vendor,
                    invoice_number: document.getElementById('invoiceNumber').value,
                    invoice_date: document.getElementById('invoiceDate').value,
                    check_number: document.getElementById('invoiceCheckNumber').value || null,
                    notes: document.getElementById('invoiceNotes').value || null,
                    subtotal: totals.subtotal,
                    tax_rate: totals.taxEnabled ? TAX_RATE : 0,
                    tax_amount: totals.taxAmount,
                    tax_enabled: totals.taxEnabled,
                    total: totals.total,
                    amount: totals.total
                };

                console.log('üîµ Invoice data to save:', invoiceData);

                let invoiceId = editId;

                if (editId) {
                    console.log('üü° Updating existing invoice:', editId);
                    const { error } = await supabaseClient.from('invoices').update(invoiceData).eq('id', editId);
                    if (error) throw error;
                    
                    console.log('üü° Deleting old invoice items for invoice:', editId);
                    await supabaseClient.from('invoice_items').delete().eq('invoice_id', editId);
                    
                    showAlert('‚úÖ Invoice updated successfully!', 'success');
                } else {
                    console.log('üü¢ Creating new invoice');
                    const { data, error } = await supabaseClient.from('invoices').insert([invoiceData]).select();
                    if (error) {
                        console.error('‚ùå Error creating invoice:', error);
                        throw error;
                    }
                    invoiceId = data[0].id;
                    console.log('‚úÖ New invoice created with ID:', invoiceId);
                    showAlert('‚úÖ Invoice saved successfully!', 'success');
                }

                console.log('üî¥ Preparing to save invoice items...');
                console.log('üî¥ Invoice ID:', invoiceId);
                console.log('üî¥ Number of products to save:', selectedInvoiceProducts.length);
                
                const invoiceItems = selectedInvoiceProducts.map(product => {
                    const hasWeight = product.has_weight && product.weight && product.weight > 0;
                    const lineTotal = hasWeight 
                        ? parseFloat(product.weight) * parseFloat(product.price_per_unit)
                        : parseFloat(product.quantity) * parseFloat(product.invoice_price);
                    
                    return {
                        invoice_id: invoiceId,
                        item_code: product.item_code,
                        product_name: product.product_name,
                        vendor: product.vendor,
                        quantity: hasWeight ? null : parseInt(product.quantity),
                        unit_price: hasWeight ? null : parseFloat(product.invoice_price),
                        weight: hasWeight ? parseFloat(product.weight) : null,
                        price_per_unit: hasWeight ? parseFloat(product.price_per_unit) : null,
                        has_weight: hasWeight,
                        line_total: lineTotal
                    };
                });

                console.log('üî¥ Invoice items array:', invoiceItems);

                const { data: insertedItems, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .insert(invoiceItems)
                    .select();

                if (itemsError) {
                    console.error('‚ùå ERROR saving invoice items:', itemsError);
                    throw itemsError;
                }

                console.log('‚úÖ‚úÖ‚úÖ SUCCESS! Invoice items saved:', insertedItems);
                console.log('‚úÖ Number of items saved:', insertedItems?.length || 0);

                // Update product names/codes in inventory if changed
                for (const product of selectedInvoiceProducts) {
                    const updates = {};
                    let needsUpdate = false;

                    if (product.productNameChanged && product.product_name !== product.originalProductName) {
                        updates.product_name = product.product_name;
                        needsUpdate = true;
                    }

                    if (product.itemCodeChanged && product.item_code !== product.originalItemCode) {
                        updates.item_code = product.item_code;
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        console.log(`üîÑ Updating inventory for item code: ${product.originalItemCode}`, updates);
                        const { error } = await supabaseClient
                            .from('purchase_history')
                            .update(updates)
                            .eq('item_code', product.originalItemCode);

                        if (error) {
                            console.error('Error updating products:', error);
                        } else {
                            console.log('‚úÖ Inventory updated successfully');
                        }
                    }
                }

                selectedInvoiceProducts = [];
                closeModal('invoiceModal');
                await loadInvoices();
                await loadInventoryData();
                populateInvoiceVendorSelect();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
                renderInventoryTable();
                renderQuickEditTable();

            } catch (error) {
                console.error('üí• CRITICAL ERROR in saveInvoice:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editInvoice(id) {
            showLoading(true);
            try {
                const { data: invoice, error: invoiceError } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (invoiceError) throw invoiceError;

                const { data: items, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .select('*')
                    .eq('invoice_id', id);
                
                if (itemsError) throw itemsError;

                console.log('Loaded invoice items:', items);

                openModal('invoiceModal');
                populateInvoiceVendorDropdown();
                
                setTimeout(() => {
                    document.getElementById('invoiceModalTitle').textContent = 'Edit Invoice';
                    
                    const vendorDropdown = document.getElementById('invoiceVendorDropdown');
                    const invoiceNumberField = document.getElementById('invoiceNumber');
                    const invoiceDateField = document.getElementById('invoiceDate');
                    const checkNumberField = document.getElementById('invoiceCheckNumber');
                    const notesField = document.getElementById('invoiceNotes');
                    const itemsCountField = document.getElementById('invoiceItemsCount');
                    const taxEnabledField = document.getElementById('invoiceTaxEnabled');
                    
                    if (vendorDropdown) vendorDropdown.value = invoice.vendor || '';
                    if (invoiceNumberField) invoiceNumberField.value = invoice.invoice_number || '';
                    if (invoiceDateField) invoiceDateField.value = invoice.invoice_date || '';
                    if (checkNumberField) checkNumberField.value = invoice.check_number || '';
                    if (notesField) notesField.value = invoice.notes || '';
                    if (taxEnabledField) taxEnabledField.checked = invoice.tax_enabled !== false;
                    
                    document.getElementById('invoiceForm').dataset.editId = id;
                    
                    selectedInvoiceProducts = (items || []).map(item => ({
                        item_code: item.item_code,
                        product_name: item.product_name,
                        vendor: item.vendor,
                        unit_price: item.unit_price || item.price_per_unit || 0,
                        invoice_price: item.unit_price || 0,
                        quantity: item.quantity || 1,
                        weight: item.weight || null,
                        price_per_unit: item.price_per_unit || null,
                        has_weight: item.has_weight || false,
                        image_path: null,
                        originalItemCode: item.item_code,
                        originalProductName: item.product_name
                    }));

                    console.log('selectedInvoiceProducts:', selectedInvoiceProducts);

                    selectedInvoiceProducts.forEach(product => {
                        const inventoryItem = inventoryData.find(i => i.item_code === product.item_code);
                        if (inventoryItem) {
                            product.image_path = inventoryItem.image_path;
                        }
                    });

                    renderSelectedInvoiceProducts();
                    
                    if (itemsCountField) {
                        itemsCountField.value = `${selectedInvoiceProducts.length} item${selectedInvoiceProducts.length !== 1 ? 's' : ''}`;
                    }
                    
                    document.getElementById('productSearchSection').style.display = 'none';
                    document.getElementById('invoiceProductResults').style.display = 'none';
                }, 100);
                
            } catch (error) {
                console.error('Edit invoice error:', error);
                showAlert('Error loading invoice: ' + error.message, 'error');
                closeModal('invoiceModal');
            } finally {
                showLoading(false);
            }
        }

        async function deleteSingleItem(id) {
            if (!confirm('Delete this item?')) return;
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('purchase_history').delete().eq('id', id);
                if (error) throw error;
                showAlert('Item deleted', 'success');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting item', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Delete this invoice?')) return;
            showLoading(true);
            try {
                await supabaseClient.from('invoice_items').delete().eq('invoice_id', id);
                const { error } = await supabaseClient.from('invoices').delete().eq('id', id);
                if (error) throw error;
                showAlert('Invoice deleted', 'success');
                await loadInvoices();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting invoice', 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedItems.clear();
            
            const deleteToggleBtn = document.getElementById('deleteToggleBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const checkboxHeader = document.getElementById('checkboxHeader');
            
            if (deleteMode) {
                deleteToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteSelectedBtn.style.display = 'inline-flex';
                checkboxHeader.style.display = 'table-cell';
            } else {
                deleteToggleBtn.innerHTML = 'üóëÔ∏è';
                deleteSelectedBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
            }
            
            renderInventoryTable();
        }

        function toggleItemSelection(itemId) {
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
            } else {
                selectedItems.add(itemId);
            }
            renderInventoryTable();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            if (selectAll) {
                filteredData.forEach(item => selectedItems.add(item.id));
            } else {
                selectedItems.clear();
            }
            renderInventoryTable();
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showAlert('Select items to delete', 'error');
                return;
            }
            
            if (!confirm(`Delete ${selectedItems.size} items?`)) return;
            
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('purchase_history').delete().in('id', Array.from(selectedItems));
                if (error) throw error;
                showAlert('Items deleted', 'success');
                selectedItems.clear();
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();
                toggleDeleteMode();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting items', 'error');
            } finally {
                showLoading(false);
            }
        }

        function openBulkAssignModal() {
            const productMap = new Map();
            
            inventoryData.forEach(item => {
                if (!item.item_code) return;
                
                if (!productMap.has(item.item_code)) {
                    productMap.set(item.item_code, {
                        code: item.item_code,
                        name: item.product_name || 'Unnamed',
                        count: 0,
                        assignedTo: []
                    });
                }
                
                const entry = productMap.get(item.item_code);
                entry.count++;
                
                let assignedArray = [];
                
                if (item.assigned_to) {
                    if (Array.isArray(item.assigned_to)) {
                        assignedArray = item.assigned_to;
                    } else if (typeof item.assigned_to === 'string') {
                        const trimmed = item.assigned_to.trim();
                        if (trimmed && trimmed !== '[]' && trimmed !== '{}' && trimmed !== 'null') {
                            try {
                                assignedArray = JSON.parse(trimmed);
                            } catch (e) {
                                assignedArray = [];
                            }
                        }
                    }
                }
                
                const validAssignments = assignedArray.filter(person => 
                    person && 
                    typeof person === 'string' && 
                    person.trim() !== '' &&
                    person.trim() !== '[]' &&
                    person.trim() !== '{}'
                );
                
                validAssignments.forEach(person => {
                    if (!entry.assignedTo.includes(person)) {
                        entry.assignedTo.push(person);
                    }
                });
            });

            const allProducts = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            const unassignedProducts = allProducts.filter(p => p.assignedTo.length === 0);
            const assignedProducts = allProducts.filter(p => p.assignedTo.length > 0);

            let html = '';
            
            if (unassignedProducts.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-700); margin-bottom: 0.5rem;">
                            üìã Unassigned Products (${unassignedProducts.length})
                        </h4>
                `;
                unassignedProducts.forEach(p => {
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; background: white; border: 2px solid var(--accent-400); border-radius: 4px; margin-bottom: 0.25rem;">
                            <input type="checkbox" class="product-checkbox" value="${p.code}" style="width: 18px; height: 18px;">
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">${p.count} items</span>
                        </label>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: var(--success-600); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 1rem;">‚úÖ All products are assigned!</p>`;
            }

            if (assignedProducts.length > 0) {
                html += `
                    <details style="margin-top: 1rem; padding: 0.5rem; background: var(--neutral-100); border-radius: 8px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--neutral-700);">
                            ‚úÖ Already Assigned Products (${assignedProducts.length})
                        </summary>
                        <div style="margin-top: 0.5rem;">
                `;
                
                assignedProducts.forEach(p => {
                    const assignedList = p.assignedTo
                        .map(person => person.charAt(0).toUpperCase() + person.slice(1))
                        .join(', ');
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem; color: var(--neutral-600);">
                            <i class="fa-solid fa-check" style="color: var(--success-600);"></i>
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">‚Üí ${assignedList}</span>
                        </div>
                    `;
                });
                
                html += `</div></details>`;
            }

            document.getElementById('productCheckboxList').innerHTML = html;
            openModal('bulkAssignModal');
        }

        function toggleAllProducts() {
            const selectAll = document.getElementById('selectAllProducts').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function saveBulkAssignment() {
            const selectedCodes = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            const person = document.getElementById('bulkAssignTo').value;
            const mode = document.getElementById('assignmentMode').value;

            if (selectedCodes.length === 0) {
                showAlert('Please select at least one product', 'error');
                return;
            }
            if (!person) {
                showAlert('Please select an employee to assign', 'error');
                return;
            }

            if (!confirm(`Assign ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}?`)) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => selectedCodes.includes(item.item_code));
                
                for (const item of itemsToUpdate) {
                    let currentAssigned = [];
                    
                    try {
                        if (Array.isArray(item.assigned_to)) {
                            currentAssigned = item.assigned_to;
                        } else if (typeof item.assigned_to === 'string') {
                            const s = item.assigned_to.trim();
                            if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                                currentAssigned = JSON.parse(s);
                            }
                        }
                    } catch (e) {
                        currentAssigned = [];
                    }
                    
                    let newAssigned;
                    if (mode === 'replace') {
                        newAssigned = [person];
                    } else {
                        if (!currentAssigned.includes(person)) {
                            newAssigned = [...currentAssigned, person];
                        } else {
                            newAssigned = currentAssigned;
                        }
                    }
                    
                    const { error } = await supabaseClient
                        .from('purchase_history')
                        .update({ assigned_to: newAssigned })
                        .eq('id', item.id);
                        
                    if (error) throw error;
                }

                showAlert(`‚úÖ Successfully assigned ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}!`, 'success');
                closeModal('bulkAssignModal');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();

            } catch (error) {
                console.error('Bulk assign error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
