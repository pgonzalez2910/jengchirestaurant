<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enterprise Inventory Intelligence Platform</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        :root {
            --primary-900: #0a1628;
            --primary-800: #132540;
            --primary-700: #1a3558;
            --primary-600: #234670;
            --primary-500: #2c5688;
            --primary-400: #4a7aae;
            --primary-300: #6b9dd4;
            --primary-200: #a5c7f0;
            --primary-100: #d4e7ff;
            
            --accent-600: #d97706;
            --accent-500: #f59e0b;
            --accent-400: #fbbf24;
            
            --success-600: #059669;
            --success-500: #10b981;
            --warning-600: #dc2626;
            
            --neutral-950: #0a0a0a;
            --neutral-900: #171717;
            --neutral-800: #262626;
            --neutral-700: #404040;
            --neutral-600: #525252;
            --neutral-500: #737373;
            --neutral-400: #a3a3a3;
            --neutral-300: #d4d4d4;
            --neutral-200: #e5e5e5;
            --neutral-100: #f5f5f5;
            --neutral-50: #fafafa;
            
            --font-display: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-mono: 'JetBrains Mono', 'Courier New', monospace;
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 200ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 300ms cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: var(--font-display);
            background: linear-gradient(135deg, var(--neutral-50) 0%, var(--neutral-100) 100%);
            color: var(--neutral-900);
            line-height: 1.6;
            min-height: 100vh;
            overflow-x: hidden;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%);
            color: white;
            padding: 1.5rem 2rem;
            box-shadow: var(--shadow-xl);
            position: sticky;
            top: 0;
            z-index: 1000;
            border-bottom: 3px solid var(--accent-500);
        }
        
        .header-content {
            max-width: 1800px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .app-title h1 {
            font-size: 1.75rem;
            font-weight: 700;
            letter-spacing: -0.025em;
        }
        
        .app-title .subtitle {
            font-size: 0.875rem;
            opacity: 0.8;
            font-weight: 400;
            margin-top: 0.25rem;
            font-family: var(--font-mono);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            backdrop-filter: blur(10px);
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success-500);
            animation: pulse 2s ease-in-out infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .container {
            max-width: 1800px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .nav-tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 2rem;
            background: white;
            padding: 0.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow-x: auto;
        }
        
        .nav-tab {
            flex: 1;
            padding: 1rem 1.5rem;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            font-weight: 600;
            color: var(--neutral-600);
            transition: all var(--transition-base);
            white-space: nowrap;
        }
        
        .nav-tab:hover {
            background: var(--neutral-100);
            color: var(--primary-700);
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .content-section {
            display: none;
            animation: fadeIn var(--transition-slow);
        }
        
        .content-section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .search-filter-bar {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }
        
        .search-group {
            flex: 1;
            min-width: 300px;
        }
        
        .search-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            transition: all var(--transition-base);
        }
        
        .search-input:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }
        
        .filter-group {
            min-width: 200px;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-base);
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            box-shadow: var(--shadow-md);
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-700);
            border: 2px solid var(--primary-700);
        }
        
        .btn-secondary:hover {
            background: var(--primary-700);
            color: white;
        }
        
        .btn-success {
            background: var(--success-600);
            color: white;
        }
        
        .btn-success:hover {
            background: var(--success-500);
        }
        
        .btn-danger {
            background: var(--warning-600);
            color: white;
        }
        
        .btn-danger:hover {
            background: #b91c1c;
        }
        
        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
        }
        
        .data-table-container {
            background: white;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            overflow: hidden;
        }
        
        .table-header {
            padding: 1.5rem;
            background: linear-gradient(135deg, var(--neutral-100) 0%, var(--neutral-50) 100%);
            border-bottom: 2px solid var(--neutral-200);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h2 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
        }
        
        .table-actions {
            display: flex;
            gap: 0.75rem;
        }
        
        .data-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        
        .data-table thead {
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table th {
            padding: 1rem 1.5rem;
            text-align: left;
            font-size: 0.875rem;
            font-weight: 700;
            color: var(--neutral-700);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 2px solid var(--neutral-300);
            cursor: pointer;
            background: var(--neutral-100);
            position: sticky;
            top: 0;
            z-index: 500;
        }
        
        .data-table tbody tr {
            transition: all var(--transition-fast);
        }
        
        .data-table tbody tr:hover {
            background: var(--primary-100);
        }
        
        .data-table td {
            padding: 1rem 1.5rem;
            border-bottom: 1px solid var(--neutral-200);
            font-size: 0.9375rem;
        }
        
        .product-image {
            width: 60px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
        }
        
        .vendor-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--neutral-200);
            color: var(--neutral-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            font-family: var(--font-mono);
        }
        
        .price-cell {
            font-family: var(--font-mono);
            font-weight: 600;
            color: var(--primary-700);
            font-size: 1rem;
        }
        
        .item-number {
            font-family: var(--font-mono);
            font-size: 0.875rem;
            color: var(--neutral-600);
        }
        
        .assignment-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--primary-200);
            color: var(--primary-800);
            border-radius: 6px;
            font-size: 0.8125rem;
            font-weight: 600;
            margin-right: 0.25rem;
            position: relative;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .assignment-badge:hover {
            background: var(--primary-300);
            padding-right: 1.75rem;
        }
        
        .assignment-badge:hover::after {
            content: 'Ã—';
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary-800);
        }
        
        .assignment-select {
            padding: 0.5rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            font-size: 0.875rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }
        
        .assignment-select:hover {
            border-color: var(--primary-500);
        }
        
        .analytics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .metric-card {
            background: white;
            padding: 1.5rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border-left: 4px solid var(--primary-600);
            transition: all var(--transition-base);
        }
        
        .metric-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }
        
        .metric-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }
        
        .metric-value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-900);
            font-family: var(--font-mono);
        }
        
        .metric-subtitle {
            font-size: 0.8125rem;
            color: var(--neutral-500);
            margin-top: 0.5rem;
        }
        
        .chart-container {
            background: white;
            padding: 2rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
        }
        
        .chart-container h3 {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--neutral-900);
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }
        
        .chart-wrapper {
            position: relative;
            height: 450px;
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--neutral-50);
            border-radius: 12px;
        }
        
        .comparison-card {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            border-left: 4px solid var(--success-600);
        }
        
        .comparison-card.highest {
            border-left-color: var(--warning-600);
        }
        
        .comparison-card.lowest {
            border-left-color: var(--success-600);
        }
        
        .comparison-card.average {
            border-left-color: var(--primary-600);
        }
        
        .comparison-label {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .comparison-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
            margin-bottom: 0.5rem;
        }
        
        .comparison-vendor {
            font-size: 0.9375rem;
            color: var(--neutral-700);
            font-weight: 600;
        }
        
        .comparison-date {
            font-size: 0.8125rem;
            color: var(--neutral-500);
        }
        
       .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(4px);
    z-index: 2000;
}
       .modal-overlay.active {
    display: block;
}
        .modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: white;
    border-radius: 0;
    box-shadow: none;
    overflow-y: auto;
    margin: 0;
    padding: 0;
}
        
        .modal-header {
            padding: 2rem;
            background: linear-gradient(135deg, var(--primary-900) 0%, var(--primary-800) 100%);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            font-size: 1.5rem;
            font-weight: 700;
        }
        
        .modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            font-size: 1.5rem;
            width: 40px;
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        .form-group label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--neutral-700);
            margin-bottom: 0.5rem;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            font-family: var(--font-display);
            font-size: 0.9375rem;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 2rem;
            padding-top: 2rem;
            border-top: 2px solid var(--neutral-200);
        }
        
        .alert {
            padding: 1rem 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            color: var(--success-600);
            border-left: 4px solid var(--success-600);
        }
        
        .alert-error {
            background: rgba(220, 38, 38, 0.1);
            color: var(--warning-600);
            border-left: 4px solid var(--warning-600);
        }
        
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(8px);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 60px;
            height: 60px;
            border: 4px solid var(--neutral-200);
            border-top-color: var(--primary-600);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .empty-state {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--neutral-500);
        }
        
        .empty-state-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
            opacity: 0.3;
        }

        .vendor-image {
            width: 120px;
            height: 120px;
            object-fit: contain;
            background: white;
            padding: 1rem;
            border-radius: 12px;
            box-shadow: var(--shadow-md);
            border: 2px solid var(--neutral-200);
        }

        .month-selector {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-top: 1rem;
        }

        .month-chip {
            padding: 0.5rem 1rem;
            border: 2px solid var(--neutral-300);
            border-radius: 6px;
            cursor: pointer;
            transition: all var(--transition-base);
            font-size: 0.875rem;
            font-weight: 600;
        }

        .month-chip:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .month-chip.selected {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }

        .vendor-card {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow-md);
            margin-bottom: 2rem;
            border-left: 6px solid var(--primary-600);
        }

        .vendor-card-header {
            display: flex;
            align-items: center;
            gap: 2rem;
            margin-bottom: 2rem;
            padding-bottom: 1.5rem;
            border-bottom: 2px solid var(--neutral-200);
        }

        .vendor-card-title {
            font-size: 1.75rem;
            font-weight: 700;
            color: var(--neutral-900);
        }

        .vendor-monthly-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .vendor-month-card {
            background: var(--neutral-50);
            padding: 1rem;
            border-radius: 8px;
            border: 2px solid var(--neutral-200);
            text-align: center;
            transition: all var(--transition-base);
        }

        .vendor-month-card:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
            transform: translateY(-2px);
        }

        .vendor-month-label {
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--neutral-600);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
        }

        .vendor-month-value {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--primary-700);
            font-family: var(--font-mono);
        }

        .vendor-total-card {
            background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%);
            color: white;
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .vendor-total-label {
            font-size: 0.875rem;
            opacity: 0.9;
            margin-bottom: 0.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .vendor-total-value {
            font-size: 2.5rem;
            font-weight: 700;
            font-family: var(--font-mono);
        }

        .invoice-product-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: white;
            border: 2px solid var(--neutral-300);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all var(--transition-base);
        }

        .invoice-product-item:hover {
            border-color: var(--primary-500);
            background: var(--primary-50);
        }

        .invoice-product-item.selected {
            border-color: var(--success-600);
            background: rgba(16, 185, 129, 0.1);
        }

        .selected-product-card {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border: 2px solid var(--success-600);
            border-radius: 8px;
            margin-bottom: 0.75rem;
        }

        .selected-product-card img {
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 6px;
        }

        .editable-field {
            padding: 0.5rem;
            border: 1px solid var(--neutral-300);
            border-radius: 4px;
            background: white;
            font-family: var(--font-display);
            transition: all var(--transition-base);
        }

        .editable-field:focus {
            outline: none;
            border-color: var(--primary-500);
            box-shadow: 0 0 0 3px rgba(44, 86, 136, 0.1);
        }

        input[type="number"].editable-field {
            -moz-appearance: textfield;
        }

        input[type="number"].editable-field::-webkit-outer-spin-button,
        input[type="number"].editable-field::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }

        .checkbox-label input[type="checkbox"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }


        /* Place Order Tab Styles */
.order-content-section {
    display: none;
}

.order-content-section.active {
    display: block;
}

.order-sub-tab:hover {
    background: var(--neutral-100) !important;
    color: var(--primary-700) !important;
}

.order-sub-tab.active {
    background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%) !important;
    color: white !important;
}
/* Executive Card Styles (from placeorder.html) */
.order-card {
    background: white;
    border: 1px solid var(--neutral-200);
    border-radius: 12px;
    padding: 1.5rem;
    box-shadow: var(--shadow-sm);
    transition: all var(--transition-base);
}

.order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-md);
}

.order-card-poster {
    height: 120px;
    border: 1px solid var(--neutral-200);
    border-radius: 10px;
    background: linear-gradient(180deg, #f9fafb, #f1f5f9);
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
    margin-bottom: 1rem;
}

.order-card-poster img {
    height: 100%;
    width: auto;
    object-fit: contain;
}

.order-kpi {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 0.75rem;
    margin: 1rem 0;
}

.order-kbox {
    border: 1px solid var(--neutral-200);
    border-radius: 8px;
    padding: 0.75rem;
    background: var(--neutral-50);
}

.order-kbox-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--neutral-600);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: 0.25rem;
}

.order-kbox-value {
    font-size: 1.125rem;
    font-weight: 700;
    color: var(--neutral-900);
    font-family: var(--font-mono);
}

.order-recommendation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 0.5rem;
    padding: 0.5rem;
    border-radius: 999px;
    color: white;
    font-weight: 700;
    font-size: 0.875rem;
    margin-top: 1rem;
}

.order-recommendation.green {
    background: linear-gradient(135deg, #059669 0%, #10b981 100%);
}

.order-recommendation.black {
    background: linear-gradient(135deg, #171717 0%, #262626 100%);
}

.order-recommendation-dot {
    width: 8px;
    height: 8px;
    background: white;
    border-radius: 50%;
    box-shadow: 0 0 0 2px rgba(255, 255, 255, 0.3) inset;
}

/* Enhanced Place Order Styles */
.enhanced-order-card {
    background: white;
    border-radius: 16px;
    padding: 1.5rem;
    box-shadow: var(--shadow-lg);
    border: 3px solid var(--neutral-300);
    transition: all 0.3s;
}

.enhanced-order-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-500);
}

.price-comparison-table {
    width: 100%;
    font-size: 0.875rem;
    border-collapse: collapse;
}

.price-comparison-table th {
    background: var(--neutral-100);
    padding: 0.5rem;
    font-weight: 700;
    text-align: left;
    border-bottom: 2px solid var(--neutral-300);
}

.price-comparison-table td {
    padding: 0.5rem;
    border-bottom: 1px solid var(--neutral-200);
}

.best-price {
    background: rgba(16, 185, 129, 0.1);
    color: var(--success-600);
    font-weight: 700;
}

.stock-delta-positive {
    color: var(--success-600);
    font-weight: 700;
}

.stock-delta-negative {
    color: var(--warning-600);
    font-weight: 700;
}

.vendor-option-card {
    padding: 0.75rem;
    border: 2px solid var(--neutral-300);
    border-radius: 8px;
    margin-bottom: 0.5rem;
    cursor: pointer;
    transition: all 0.2s;
}

.vendor-option-card:hover {
    border-color: var(--primary-500);
    background: var(--primary-50);
}

.vendor-option-card.selected {
    border-color: var(--success-600);
    background: rgba(16, 185, 129, 0.1);
}


/* ========== ENHANCED PLACE ORDER CARD STYLES ========== */

/* Editable PAR input styling */
input[id^="par-input-"]:hover {
    background: rgba(255, 255, 255, 0.2) !important;
}

input[id^="par-input-"]:focus {
    background: rgba(255, 255, 255, 0.3) !important;
    outline: 2px solid white !important;
}

/* Assignment button styling */
.btn.assignment-btn {
    transition: all 0.2s ease;
}

.btn.assignment-btn:hover {
    transform: translateY(-2px);
}

/* Delete button enhanced hover */
.btn-danger:hover {
    transform: scale(1.1);
    box-shadow: 0 4px 12px rgba(220, 38, 38, 0.4);
}

/* Vendor option row hover effect */
.vendor-option-row {
    transition: all 0.2s ease;
}

.vendor-option-row:hover {
    background: var(--primary-50) !important;
    transform: translateX(4px);
}

.vendor-option-row.selected {
    background: rgba(16, 185, 129, 0.1) !important;
    border-left: 4px solid var(--success-600);
}

/* Enhanced order card hover */
.enhanced-order-card {
    transition: all 0.3s ease;
}

.enhanced-order-card:hover {
    transform: translateY(-4px);
    box-shadow: var(--shadow-xl);
    border-color: var(--primary-500);
}

/* ========== COMPACT PLACE ORDER CARDS ========== */
.enhanced-order-card {
    background: white;
    border-radius: 8px;
    padding: 0.75rem;
    box-shadow: var(--shadow-md);
    border: 2px solid var(--neutral-300);
    transition: all 0.3s;
    font-size: 0.75rem; /* Reduce base font size */
}

.enhanced-order-card:hover {
    transform: translateY(-2px);
    box-shadow: var(--shadow-lg);
    border-color: var(--primary-500);
}

/* Compact product images */
.enhanced-order-card img {
    max-width: 60px !important;
    height: 60px !important;
}

/* Compact metrics */
.compact-metric {
    padding: 0.5rem;
    border-radius: 6px;
    text-align: center;
}

.compact-metric-label {
    font-size: 0.6rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.compact-metric-value {
    font-size: 1.25rem;
    font-weight: 700;
    font-family: var(--font-mono);
}

/* Compact price comparison */
.compact-price-box {
    padding: 0.5rem;
    border-radius: 6px;
}

.compact-price-label {
    font-size: 0.55rem;
    font-weight: 700;
    margin-bottom: 0.25rem;
}

.compact-price-value {
    font-size: 0.95rem;
    font-weight: 700;
    font-family: var(--font-mono);
}

.compact-price-vendor {
    font-size: 0.65rem;
    margin-top: 0.25rem;
}

/* Compact vendor price table */
.compact-price-table {
    font-size: 0.7rem;
}

.compact-price-table th {
    padding: 0.35rem;
    font-size: 0.65rem;
}

.compact-price-table td {
    padding: 0.35rem;
    font-size: 0.7rem;
}

/* Compact form elements */
.enhanced-order-card .search-input,
.enhanced-order-card select,
.enhanced-order-card input {
    padding: 0.4rem 0.6rem;
    font-size: 0.8rem;
}

/* Compact buttons */
.enhanced-order-card .btn {
    padding: 0.4rem 0.8rem;
    font-size: 0.75rem;
}

/* ========== MOBILE RESPONSIVE STYLES FOR JULIO'S ORDERS ========== */

/* Tablet (landscape) */
@media (max-width: 1024px) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)) !important;
        gap: 1.25rem !important;
        padding: 1.5rem !important;
    }
    
    .julio-corporate-card img {
        width: 100px !important;
        height: 100px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 1rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.25rem !important;
        padding: 0.75rem !important;
    }
}

/* Tablet (portrait) and large phones */
@media (max-width: 768px) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
        gap: 1rem !important;
        padding: 1rem !important;
    }
    
    .julio-corporate-card {
        border-radius: 10px !important;
    }
    
    .julio-corporate-card img {
        width: 90px !important;
        height: 90px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.9375rem !important;
        min-height: 2.2rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.125rem !important;
        padding: 0.625rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.75rem !important;
        font-size: 0.875rem !important;
    }
    
    /* Stack search bar and buttons vertically */
    .search-filter-bar {
        flex-direction: column !important;
        gap: 1rem !important;
    }
    
    .search-group, .filter-group {
        min-width: 100% !important;
    }
}

/* Mobile phones */
@media (max-width: 480px) {
    #julioProductGrid {
        grid-template-columns: 1fr !important; /* Single column on mobile */
        gap: 1rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card {
        max-width: 100% !important;
    }
    
    .julio-corporate-card img {
        width: 80px !important;
        height: 80px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.875rem !important;
        min-height: auto !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1rem !important;
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card label {
        font-size: 0.75rem !important;
    }
    
    /* Mobile header adjustments */
    .table-header h2 {
        font-size: 1.125rem !important;
    }
    
    /* Mobile buttons */
    .btn {
        padding: 0.75rem 1rem !important;
        font-size: 0.8125rem !important;
    }
    
    /* Progress bar on mobile */
    #julioProgress {
        height: 6px !important;
    }
}

/* iPhone SE / Very small phones */
@media (max-width: 375px) {
    #julioProductGrid {
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card {
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card img {
        width: 70px !important;
        height: 70px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.8125rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 0.9375rem !important;
    }
}

/* Landscape mode for phones */
@media (max-width: 812px) and (orientation: landscape) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)) !important;
    }
}


/* ========== ENHANCED RESPONSIVE DESIGN FOR ALL DEVICES ========== */

/* Large Desktop (1920px+) - Default styles work fine */

/* Standard Desktop & Laptop (1024px - 1919px) */
@media (max-width: 1919px) {
    .container {
        max-width: 1400px;
    }
    
    .analytics-grid {
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    }
}

/* Tablet Landscape (768px - 1023px) */
@media (max-width: 1023px) {
    .container {
        padding: 1.5rem;
    }
    
    .app-header {
        padding: 1.25rem 1.5rem;
    }
    
    .app-title h1 {
        font-size: 1.5rem;
    }
    
    .nav-tabs {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .nav-tab {
        min-width: 120px;
        font-size: 0.875rem;
        padding: 0.875rem 1.25rem;
    }
    
    .search-filter-bar {
        flex-direction: column;
        gap: 1rem;
    }
    
    .search-group,
    .filter-group {
        min-width: 100%;
    }
    
    .data-table {
        font-size: 0.875rem;
    }
    
    .data-table th,
    .data-table td {
        padding: 0.75rem 1rem;
    }
    
    /* Julio's Orders - Tablet */
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)) !important;
        gap: 1.5rem !important;
        padding: 1.5rem !important;
    }
    
    .julio-corporate-card img {
        width: 110px !important;
        height: 110px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 1.0625rem !important;
    }
    
    /* Rony's Orders - Tablet */
    #ronyProductContainer .vendor-card {
        padding: 1.25rem;
    }
    
    /* Place Order - Tablet */
    .enhanced-order-card {
        font-size: 0.8125rem;
    }
}

/* Tablet Portrait & Large Phones (481px - 767px) */
@media (max-width: 767px) {
    .container {
        padding: 1rem;
    }
    
    .app-header {
        padding: 1rem;
    }
    
    .app-title h1 {
        font-size: 1.25rem;
    }
    
    .app-title .subtitle {
        font-size: 0.75rem;
    }
    
    .status-indicator {
        padding: 0.375rem 0.75rem;
        font-size: 0.75rem;
    }
    
    .nav-tabs {
        padding: 0.375rem;
        gap: 0.375rem;
    }
    
    .nav-tab {
        min-width: 100px;
        font-size: 0.8125rem;
        padding: 0.75rem 1rem;
    }
    
    .table-header h2 {
        font-size: 1.125rem;
    }
    
    .btn {
        padding: 0.625rem 1rem;
        font-size: 0.875rem;
    }
    
    /* Julio's Orders - Tablet Portrait */
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(240px, 1fr)) !important;
        gap: 1.25rem !important;
        padding: 1.25rem !important;
    }
    
    .julio-corporate-card {
        border-radius: 10px !important;
    }
    
    .julio-corporate-card img {
        width: 100px !important;
        height: 100px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.9375rem !important;
        min-height: 2.5rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.25rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.75rem !important;
        font-size: 0.875rem !important;
    }
    
    /* Rony's Orders - Tablet Portrait */
    #ronyProductContainer > div {
        padding: 1rem;
    }
    
    #ronyProductContainer h2 {
        font-size: 1.125rem;
    }
    
    /* Metric Cards */
    .metric-card {
        padding: 1.25rem;
    }
    
    .metric-value {
        font-size: 1.75rem;
    }
    
    /* Modal adjustments */
    .modal-body {
        padding: 1.5rem;
    }
}

/* Mobile Phones (320px - 480px) */
@media (max-width: 480px) {
    body {
        font-size: 14px;
    }
    
    .container {
        padding: 0.75rem;
    }
    
    .app-header {
        padding: 0.75rem;
    }
    
    .header-content {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
    }
    
    .app-title h1 {
        font-size: 1.125rem;
    }
    
    .app-title .subtitle {
        font-size: 0.6875rem;
    }
    
    .status-indicator {
        padding: 0.375rem 0.625rem;
        font-size: 0.6875rem;
    }
    
    .nav-tabs {
        flex-direction: column;
        padding: 0.5rem;
    }
    
    .nav-tab {
        width: 100%;
        min-width: auto;
        text-align: center;
        font-size: 0.875rem;
        padding: 0.75rem;
    }
    
    .search-filter-bar {
        padding: 1rem;
    }
    
    .table-header {
        flex-direction: column;
        gap: 0.75rem;
        align-items: flex-start;
    }
    
    .table-header h2 {
        font-size: 1rem;
    }
    
    .table-actions {
        width: 100%;
        justify-content: space-between;
    }
    
    .btn {
        padding: 0.625rem 0.875rem;
        font-size: 0.8125rem;
    }
    
    .btn-icon {
        width: 36px;
        height: 36px;
    }
    
    /* Julio's Orders - Mobile */
    #julioProductGrid {
        grid-template-columns: 1fr !important;
        gap: 1rem !important;
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card {
        max-width: 100% !important;
        border-radius: 8px !important;
    }
    
    .julio-corporate-card > div:first-child {
        padding: 1.25rem !important;
    }
    
    .julio-corporate-card img {
        width: 90px !important;
        height: 90px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.875rem !important;
        min-height: auto !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1.125rem !important;
        padding: 0.625rem !important;
    }
    
    .julio-corporate-card label {
        font-size: 0.75rem !important;
    }
    
    .julio-corporate-card .btn {
        padding: 0.625rem !important;
        font-size: 0.8125rem !important;
    }
    
    /* Julio Progress Bar */
    #julioProgress {
        height: 6px !important;
    }
    
    /* Rony's Orders - Mobile */
    #ronyProductContainer > div {
        padding: 0.75rem;
        margin-bottom: 1rem;
    }
    
    #ronyProductContainer h2 {
        font-size: 1rem;
    }
    
    #ronyProductContainer > div > div:last-child {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)) !important;
    }
    
    /* Place Order - Mobile */
    .enhanced-order-card {
        margin-bottom: 1rem;
    }
    
    .enhanced-order-card img {
        max-width: 80px !important;
        height: 80px !important;
    }
    
    /* Metric Cards - Mobile */
    .analytics-grid {
        grid-template-columns: 1fr;
        gap: 1rem;
    }
    
    .metric-card {
        padding: 1rem;
    }
    
    .metric-value {
        font-size: 1.5rem;
    }
    
    /* Chart Containers */
    .chart-wrapper {
        height: 300px;
    }
    
    /* Modal - Mobile */
    .modal {
        border-radius: 0;
    }
    
    .modal-header {
        padding: 1.25rem;
    }
    
    .modal-header h2 {
        font-size: 1.125rem;
    }
    
    .modal-body {
        padding: 1.25rem;
    }
    
    .form-group input,
    .form-group select,
    .form-group textarea {
        font-size: 16px; /* Prevents zoom on iOS */
    }
    
    /* Data Tables - Mobile */
    .data-table-container {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }
    
    .data-table {
        min-width: 600px;
    }
}

/* Small Mobile (iPhone SE, older devices) */
@media (max-width: 375px) {
    .app-title h1 {
        font-size: 1rem;
    }
    
    #julioProductGrid {
        padding: 0.5rem !important;
    }
    
    .julio-corporate-card {
        padding: 0.75rem !important;
    }
    
    .julio-corporate-card img {
        width: 80px !important;
        height: 80px !important;
    }
    
    .julio-corporate-card h3 {
        font-size: 0.8125rem !important;
    }
    
    .julio-corporate-card input[type="number"] {
        font-size: 1rem !important;
        padding: 0.5rem !important;
    }
}

/* Landscape Mode for Phones */
@media (max-width: 896px) and (orientation: landscape) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)) !important;
    }
    
    #ronyProductContainer > div > div:last-child {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)) !important;
    }
    
    .modal {
        max-height: 100vh;
        overflow-y: auto;
    }
}

/* iPad specific adjustments */
@media only screen 
  and (min-device-width: 768px) 
  and (max-device-width: 1024px) 
  and (-webkit-min-device-pixel-ratio: 2) {
    #julioProductGrid {
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)) !important;
    }
}

/* Improve touch targets for mobile */
@media (hover: none) and (pointer: coarse) {
    .btn,
    .nav-tab,
    .search-input,
    button {
        min-height: 44px; /* Apple's recommended touch target size */
    }
    
    .checkbox-label input[type="checkbox"] {
        width: 24px;
        height: 24px;
    }
}




        /* Stock Alerts Styles */
        .badge-count {
            background: var(--error-600);
            color: white;
            border-radius: 12px;
            padding: 0.125rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 700;
            margin-left: 0.5rem;
        }
        .filter-chips {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }
        .filter-chip {
            padding: 0.5rem 1rem;
            border: 2px solid var(--neutral-300);
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }
        .filter-chip.active {
            background: var(--primary-600);
            color: white;
            border-color: var(--primary-600);
        }
        .filter-chip:hover:not(.active) {
            border-color: var(--primary-400);
            background: var(--primary-50);
        }
        .alert-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow-md);
            display: grid;
            grid-template-columns: 80px 1fr auto;
            gap: 1.5rem;
            align-items: center;
            transition: all 0.2s;
        }
        .alert-card:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }
        .alert-card.critical {
            border-left: 6px solid var(--error-600);
            animation: pulse-border 2s infinite;
        }
        .alert-card.warning {
            border-left: 6px solid #f59e0b;
        }
        .alert-card.watch {
            border-left: 6px solid #eab308;
        }
        .alert-card.declining {
            border-left: 6px solid #8b5cf6;
        }
        @keyframes pulse-border {
            0%, 100% { border-left-color: var(--error-600); }
            50% { border-left-color: #ef4444; }
        }
        .alert-status {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            border-radius: 6px;
            font-size: 0.875rem;
            font-weight: 600;
        }
        .alert-status.critical {
            background: #fee2e2;
            color: #991b1b;
        }
        .alert-status.warning {
            background: #fef3c7;
            color: #92400e;
        }
        .alert-status.watch {
            background: #fef9c3;
            color: #854d0e;
        }
        .alert-status.declining {
            background: #ede9fe;
            color: #6b21a8;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <header class="app-header">
        <div class="header-content">
            <div class="app-title">
                <div>
                    <h1>Enterprise Inventory Intelligence Platform</h1>
                    <div class="subtitle">Multi-Vendor Product Management & Analytics</div>
                </div>
            </div>
            <div class="status-indicator">
                <div class="status-dot"></div>
                <span>System Online</span>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="alertContainer"></div>
<div class="nav-tabs">
    <button class="nav-tab active" onclick="switchTab('inventory', event)">ðŸ“¦ Inventory View</button>
    <button class="nav-tab" onclick="switchTab('quickEdit', event)">âœï¸ Quick Edit</button>
    <button class="nav-tab" onclick="switchTab('analytics', event)">ðŸ“Š Analytics & Insights</button>
    <button class="nav-tab" onclick="switchTab('vendorSpending', event)">ðŸ’° Vendor Spending Analysis</button>
    <button class="nav-tab" onclick="switchTab('invoices', event)">ðŸ“„ Invoice Tracking</button>
    <button class="nav-tab" onclick="switchTab('vendors', event)">ðŸ¢ Vendor Management</button>
    <button class="nav-tab" onclick="switchTab('julioOrders', event)">ðŸ›’ Julio's Orders</button>
    <button class="nav-tab" onclick="switchTab('ronyOrders', event)">ðŸ³ Rony's Orders</button>
    <button class="nav-tab" onclick="switchTab('officeOrders', event)">ðŸ¢ Office Orders</button>
    <button class="nav-tab" onclick="switchTab('placeOrder', event)">ðŸ“‹ Place Order</button>
    <button class="nav-tab" onclick="switchTab('inventorySettings', event)">âš™ï¸ Inventory Settings</button>
    <button class="nav-tab" onclick="switchTab('submissionHistory', event)">ðŸ“… Submission History</button>
    <button class="nav-tab" onclick="switchTab('stockAlerts', event)">ðŸš¨ Stock Alerts <span id="alertBadge" class="badge-count" style="display:none;">0</span></button>
    <button class="nav-tab" onclick="switchTab('consumptionTracking', event)">ðŸ“Š Consumption & Orders</button>
    <button class="nav-tab" onclick="switchTab('inventoryValuation', event)">ðŸ’° Valuation Reports</button>
    <button class="nav-tab" onclick="switchTab('budgetTracking', event)">ðŸŽ¯ Budget Tracking</button>
    <button class="nav-tab" onclick="switchTab('vendorPerformance', event)">ðŸ† Vendor Performance</button>
</div>

        <!-- Inventory View -->
        <div id="inventory" class="content-section active">
            <div class="search-filter-bar">
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="searchInput" class="search-input" placeholder="Search..." oninput="performSearch()">
                </div>
                <div class="filter-group">
                    <label>Vendor Filter</label>
                    <select id="vendorFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year Filter</label>
                    <select id="yearFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Assigned To</label>
                    <select id="assignedToFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Category Filter</label>
                    <select id="categoryFilter" class="search-input" onchange="applyFilters()">
                        <option value="">All Categories</option>
                        <option value="Produce">Produce</option>
                        <option value="Meat & Seafood">Meat & Seafood</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Dry Goods">Dry Goods</option>
                        <option value="Frozen">Frozen</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Cleaning Supplies">Cleaning Supplies</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Kitchen Equipment">Kitchen Equipment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-primary" onclick="exportToCSV()">ðŸ“¥ Export</button>
                    <button class="btn btn-secondary" onclick="openBulkAssignModal()">ðŸ‘¥ Bulk Assign</button>
                    <button class="btn btn-success" onclick="openAddItemModal()">+ Add Item</button>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Product Inventory</h2>
                    <div class="table-actions" style="display: flex; align-items: center; gap: 1rem;">
                        <button class="btn btn-icon" onclick="toggleBulkAssignMode()" id="bulkAssignToggleBtn" title="Bulk Assign Mode" style="background: var(--primary-600); color: white;">
                            <i class="fas fa-user-check"></i> Bulk Assign
                        </button>
                        <button class="btn btn-success" onclick="applyBulkAssignment()" id="applyBulkAssignBtn" style="display: none;">
                            <i class="fas fa-check"></i> Assign Selected
                        </button>
                        <button class="btn btn-icon" onclick="toggleDeleteMode()" id="deleteToggleBtn" title="Delete Mode" style="background: var(--warning-600); color: white;">ðŸ—‘ï¸</button>
                        <button class="btn btn-primary" onclick="deleteSelected()" id="deleteSelectedBtn" style="display: none;">Delete Selected</button>
                        <span id="recordCount" style="margin-left: auto; font-weight: 600; white-space: nowrap;">Loading...</span>
                    </div>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th id="checkboxHeader" style="display: none; width: 50px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll()" style="cursor: pointer; width: 18px; height: 18px;">
                            </th>
                            <th>Image</th>
                            <th>Vendor</th>
                             <th>Category</th>
                            <th>Item No.</th>
                            <th>Description</th>
                            <th>Price</th>
                            <th>Purchase Date</th>
                            <th>Assigned To</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Quick Edit View -->
        <div id="quickEdit" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>Filter by Assignment</label>
                    <select id="quickEditAssignFilter" class="search-input" onchange="filterQuickEdit()">
                        <option value="">All Products</option>
                        <option value="rony">Rony's Products</option>
                        <option value="julio">Julio's Products</option>
                        <option value="unassigned">Unassigned</option>
                    </select>
                </div>
                <div class="search-group">
                    <label>Search Products</label>
                    <input type="text" id="quickEditSearch" class="search-input" placeholder="Search by name or code..." oninput="filterQuickEdit()">
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Quick Edit - All Matching Items Update Together</h2>
                    <span id="quickEditCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Image</th>
                            <th>Item Code</th>
                            <th>Product Name</th>
                            <th>Vendor</th>
                            <th>Category</th>
                            <th>Price</th>
                            <th>Count</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="quickEditTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Analytics Section -->
        <div id="analytics" class="content-section">
            <div class="analytics-grid">
                <div class="metric-card">
                    <div class="metric-label">Total Products</div>
                    <div class="metric-value" id="metricTotalProducts">-</div>
                    <div class="metric-subtitle">Unique products</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Active Vendors</div>
                    <div class="metric-value" id="metricActiveVendors">-</div>
                    <div class="metric-subtitle">Suppliers with inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Average Price</div>
                    <div class="metric-value" id="metricAvgPrice">-</div>
                    <div class="metric-subtitle">Across all inventory</div>
                </div>
                <div class="metric-card">
                    <div class="metric-label">Total Value</div>
                    <div class="metric-value" id="metricTotalValue">-</div>
                    <div class="metric-subtitle">Estimated total</div>
                </div>
            </div>

            <div class="search-filter-bar">
                <div class="search-group">
                    <label>ðŸ“Š Select Product for Price Analysis</label>
                    <select id="analyticsProductSelect" class="search-input" onchange="loadProductAnalytics()">
                        <option value="">Choose a product to compare prices...</option>
                    </select>
                </div>
            </div>

            <div id="productAnalysisSection" style="display: none;">
                <div class="comparison-grid" id="priceComparison"></div>

                <div class="chart-container">
                    <h3>ðŸ“ˆ Vendor Price Comparison</h3>
                    <div class="chart-wrapper">
                        <canvas id="vendorPriceChart"></canvas>
                    </div>
                </div>

                <div class="chart-container">
                    <h3>ðŸ“‰ Price History Over Time</h3>
                    <div class="chart-wrapper">
                        <canvas id="priceHistoryChart"></canvas>
                    </div>
                </div>

                <div class="data-table-container">
                    <div class="table-header">
                        <h2>ðŸ’¡ Price Variance Analysis</h2>
                    </div>
                    <div style="padding: 2rem;" id="varianceAnalysis"></div>
                </div>
            </div>

            <div class="chart-container">
                <h3>ðŸ¢ Vendor Distribution</h3>
                <div class="chart-wrapper">
                    <canvas id="vendorDistributionChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Vendor Spending Analysis -->
        <div id="vendorSpending" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>ðŸ“… Select Year</label>
                    <select id="vendorSpendingYear" class="search-input" onchange="loadVendorSpendingAnalysis()">
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026" selected>2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div class="search-group">
                    <label style="display: block; margin-bottom: 0.5rem;">ðŸ—“ï¸ Select Months to Analyze</label>
                    <div class="month-selector" id="vendorMonthSelector"></div>
                </div>
            </div>

            <div id="vendorSpendingContent"></div>
        </div>

        <!-- Invoice Tracking Section -->
        <div id="invoices" class="content-section">
            <div class="search-filter-bar">
                <div class="filter-group">
                    <label>Select Vendor</label>
                    <select id="invoiceVendorSelect" class="search-input" onchange="filterInvoicesByVendor()">
                        <option value="">All Vendors</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label>Year</label>
                    <select id="invoiceYearSelect" class="search-input" onchange="filterInvoicesByVendor()">
                        <option value="">All Years</option>
                        <option value="2024">2024</option>
                        <option value="2025">2025</option>
                        <option value="2026">2026</option>
                        <option value="2027">2027</option>
                    </select>
                </div>
                <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                    <button class="btn btn-success" onclick="openAddInvoiceModal()">+ Add Invoice</button>
                </div>
            </div>

            <div class="data-table-container">
                <div class="table-header">
                    <h2>Invoice List</h2>
                    <span id="invoiceCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vendor</th>
                            <th>Invoice #</th>
                            <th>Check #</th>
                            <th>Date</th>
                            <th>Amount</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="invoicesTableBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Vendor Management Section -->
        <div id="vendors" class="content-section">
            <div class="data-table-container">
                <div class="table-header">
                    <h2>Vendor Statistics</h2>
                    <span id="vendorCount">Loading...</span>
                </div>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Vendor Logo</th>
                            <th>Vendor Name</th>
                            <th>Product Count</th>
                            <th>Last Purchase</th>
                            <th>Total Purchases</th>
                        </tr>
                    </thead>
                    <tbody id="vendorsTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Julio's Orders Section -->
<!-- Julio's Orders Section -->
<div id="julioOrders" class="content-section">
  <div class="search-filter-bar">
    <!-- ADD DATE PICKER -->
    <div class="filter-group">
      <label>ðŸ“… Order Date</label>
      <input type="date" id="julioOrderDate" class="search-input" onchange="loadJulioOrders()">
    </div>
    
    <div class="search-group">
      <label>ðŸ” Search Products</label>
      <input type="text" id="julioSearchInput" class="search-input" placeholder="Search by product name..." oninput="filterJulioProducts()">
    </div>
    <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
      <button class="btn btn-success" onclick="openAddProductModal('julio')">
        <i class="fas fa-plus"></i> Add Product
      </button>
      <button class="btn btn-primary" onclick="saveJulioOrders()">
        <i class="fas fa-save"></i> Save Order Request
      </button>
      <button class="btn btn-secondary" onclick="clearJulioOrders()">
        <i class="fas fa-eraser"></i> Clear All
      </button>
    </div>
  </div>
  
  <div class="data-table-container">
    <div class="table-header" style="display: flex; justify-content: space-between; align-items: center;">
      <h2 style="display: flex; align-items: center; gap: 0.75rem; font-size: 1.5rem;">
        <i class="fas fa-boxes" style="color: var(--accent-500);"></i>
        Julio's Target Inventory
      </h2>
      <span id="julioProductCount" style="font-size: 1.1rem; color: var(--neutral-600);">Loading...</span>
    </div>
    
    <!-- Redesigned Product Grid -->
    <div id="julioProductGrid" style="padding: 2rem; display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.75rem;">
      <!-- Product cards will be rendered here by JavaScript -->
    </div>
  </div>
  
  <!-- Enhanced SUBMIT BUTTON with progress visualization -->
  <div style="background: white; padding: 1.75rem; border-radius: 16px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center; position: relative;">
    <div style="display: flex; justify-content: center; align-items: center; gap: 1rem; margin-bottom: 1.25rem;">
      <div style="background: var(--accent-100); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; color: var(--accent-700);">
        <i class="fas fa-boxes"></i>
      </div>
      <div style="text-align: left;">
        <h3 style="font-size: 1.3rem; color: var(--neutral-900); margin: 0;">Complete Your Order</h3>
        <p style="font-size: 0.95rem; color: var(--neutral-600); margin: 0.5rem 0 0 0;">Set target quantities for all products before submitting</p>
      </div>
    </div>
    
    <div style="display: flex; flex-direction: column; gap: 1rem;">
      <div style="display: flex; justify-content: center; gap: 0.75rem; align-items: center;">
        <div style="width: 100%; height: 8px; background: var(--neutral-200); border-radius: 4px; overflow: hidden;">
          <div id="julioProgress" style="height: 100%; width: 0%; background: var(--accent-600); border-radius: 4px; transition: width 0.5s;"></div>
        </div>
        <div style="font-size: 1.1rem; font-weight: 600; color: var(--neutral-700); min-width: 80px; text-align: center;">
          <span id="julioProgressPercent">0%</span>
        </div>
      </div>
      <div style="display: flex; justify-content: space-between; font-size: 0.9rem; color: var(--neutral-600);">
        <span>Products with targets set: <span id="julioProductsSet">0</span> of <span id="julioTotalProducts">0</span></span>
        <span>Completion status</span>
      </div>
    </div>
    
    <button class="btn btn-success" onclick="saveJulioOrders()" style="padding: 1.25rem 3.5rem; font-size: 1.35rem; margin-top: 1.5rem; width: 100%;">
      <i class="fas fa-paper-plane"></i> Submit Julio's Order
    </button>
  </div>
</div>

<!-- Rony's Orders Section -->
<!-- Rony's Orders Section -->
<div id="ronyOrders" class="content-section">
    <div class="search-filter-bar">
        <!-- ADD DATE PICKER -->
        <div class="filter-group">
            <label>ðŸ“… Stock Count Date</label>
            <input type="date" id="ronyOrderDate" class="search-input" onchange="loadRonyOrders()">
        </div>
        
        <div class="search-group">
            <label>ðŸ” Search Products</label>
            <input type="text" id="ronySearchInput" class="search-input" placeholder="Search by product name..." oninput="filterRonyProducts()">
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="openAddProductModal('rony')">
                <i class="fas fa-plus"></i> Add Product
            </button>
            <button class="btn btn-primary" onclick="saveRonyOrders()">
                <i class="fas fa-save"></i> Submit Order
            </button>
            <button class="btn btn-secondary" onclick="clearRonyOrders()">
                <i class="fas fa-eraser"></i> Clear All
            </button>
        </div>
    </div>


<!-- ðŸ¢ OFFICE ORDERS TAB -->
<div id="officeOrders" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>ðŸ“… Order Date</label>
            <input type="date" id="officeOrderDate" class="search-input" onchange="loadOfficeOrders()">
        </div>
        <div class="search-group">
            <label>ðŸ” Search Products</label>
            <input type="text" id="officeSearchInput" class="search-input" placeholder="Search..." oninput="filterOfficeProducts()">
        </div>
        <div style="display: flex; gap: 0.75rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="openAddProductModal('office')">
                <i class="fas fa-plus"></i> Add Product
            </button>
            <button class="btn btn-primary" onclick="saveOfficeOrders()">
                <i class="fas fa-save"></i> Save Order
            </button>
            <button class="btn btn-secondary" onclick="clearOfficeOrders()">
                <i class="fas fa-eraser"></i> Clear All
            </button>
        </div>
    </div>
    
    <div class="data-table-container">
        <div class="table-header">
            <h2><i class="fas fa-building"></i> Office Supplies Order</h2>
            <span id="officeProductCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product</th>
                    <th>Vendor</th>
                    <th>Current Stock</th>
                    <th>Order Qty</th>
                    <th>Unit Price</th>
                    <th>Total</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="officeOrdersTableBody"></tbody>
        </table>
    </div>
</div>



    
    <!-- Global Progress Bar -->
    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
        <div style="height: 10px; background: var(--neutral-200); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem;">
            <div id="ronyGlobalProgress" style="height: 100%; width: 0%; background: var(--primary-600); transition: width 0.3s;"></div>
        </div>
        <div style="display: flex; justify-content: space-between; font-size: 0.875rem; color: var(--neutral-600);">
            <span>Overall Progress</span>
            <span id="ronyGlobalLabel">0%</span>
        </div>
    </div>

    <!-- Products Grouped by Position -->
    <div id="ronyProductContainer"></div>
    
    <!-- SUBMIT BUTTON AT BOTTOM -->
    <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
        <button class="btn btn-success" onclick="saveRonyOrders()" style="padding: 1rem 3rem; font-size: 1.25rem;">
            <i class="fas fa-paper-plane"></i> Submit Rony's Stock Count
        </button>
    </div>
</div>

<!-- Submission History Section -->
<div id="submissionHistory" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Submitted By</label>
            <select id="historyUserFilter" class="search-input" onchange="filterSubmissionHistory()">
                <option value="">All Users</option>
                <option value="julio">Julio</option>
                <option value="rony">Rony</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Date From</label>
            <input type="date" id="historyDateFrom" class="search-input" onchange="filterSubmissionHistory()">
        </div>
        <div class="filter-group">
            <label>Date To</label>
            <input type="date" id="historyDateTo" class="search-input" onchange="filterSubmissionHistory()">
        </div>
        <div class="search-group">
            <label>Search Product</label>
            <input type="text" id="historySearchInput" class="search-input" placeholder="Search by product name..." oninput="filterSubmissionHistory()">
        </div>
    </div>

    <div class="data-table-container">
        <div class="table-header">
            <h2>ðŸ“… Order Submission History</h2>
            <span id="historyCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Submission Date</th>
                    <th>Submitted By</th>
                    <th>Product Name</th>
                    <th>Quantity</th>
                    <th>Type</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="historyTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ðŸš¨ STOCK ALERTS TAB -->
<div id="stockAlerts" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-chips" style="display: flex; gap: 0.5rem; flex-wrap: wrap;">
            <button class="filter-chip active" data-filter="all" onclick="filterAlerts('all')">All</button>
            <button class="filter-chip" data-filter="critical" onclick="filterAlerts('critical')">ðŸ”´ Critical</button>
            <button class="filter-chip" data-filter="warning" onclick="filterAlerts('warning')">ðŸŸ  Warning</button>
            <button class="filter-chip" data-filter="watch" onclick="filterAlerts('watch')">ðŸŸ¡ Watch</button>
            <button class="filter-chip" data-filter="declining" onclick="filterAlerts('declining')">ðŸ“‰ Declining</button>
        </div>
        <div class="filter-group">
            <label>Category</label>
            <select id="alertCategoryFilter" class="search-input" onchange="loadStockAlerts()">
                <option value="">All Categories</option>
                <option value="Produce">Produce</option>
                <option value="Meat & Seafood">Meat & Seafood</option>
                <option value="Dairy">Dairy</option>
                <option value="Dry Goods">Dry Goods</option>
                <option value="Frozen">Frozen</option>
                <option value="Beverages">Beverages</option>
            </select>
        </div>
        <button class="btn btn-secondary" onclick="loadStockAlerts()">
            <i class="fas fa-sync"></i> Refresh
        </button>
    </div>

    <div id="alertsContainer" style="display: grid; gap: 1rem;"></div>
</div>

<!-- ðŸ“Š CONSUMPTION TRACKING TAB -->
<div id="consumptionTracking" class="content-section">
    <div class="search-filter-bar">
        <!-- Year Selector -->
        <div class="filter-group">
            <label>ðŸ“… Year</label>
            <select id="consumptionYear" class="search-input" onchange="updateConsumptionPeriods()">
                <option value="2024">2024</option>
                <option value="2025">2025</option>
                <option value="2026" selected>2026</option>
                <option value="2027">2027</option>
            </select>
        </div>

        <!-- Month Multi-Select -->
        <div class="filter-group">
            <label>ðŸ“† Months (Multi-Select)</label>
            <select id="consumptionMonth" class="search-input" multiple size="4" onchange="updateWeekOptions()" style="min-width: 150px;">
                <option value="1">January</option>
                <option value="2" selected>February</option>
                <option value="3">March</option>
                <option value="4">April</option>
                <option value="5">May</option>
                <option value="6">June</option>
                <option value="7">July</option>
                <option value="8">August</option>
                <option value="9">September</option>
                <option value="10">October</option>
                <option value="11">November</option>
                <option value="12">December</option>
            </select>
        </div>

        <!-- Week Multi-Select (Populated dynamically) -->
        <div class="filter-group">
            <label>ðŸ“… Weeks (Multi-Select)</label>
            <select id="consumptionWeeks" class="search-input" multiple size="4" style="min-width: 200px;">
                <!-- Populated by JavaScript based on selected months -->
            </select>
        </div>

        <!-- User Filter -->
        <div class="filter-group">
            <label>ðŸ‘¤ User</label>
            <select id="consumptionUserFilter" class="search-input" onchange="loadConsumptionData()">
                <option value="rony">Rony (Stock Consumption)</option>
                <option value="julio">Julio (Order Frequency)</option>
            </select>
        </div>

        <!-- Search -->
        <div class="search-group">
            <label>ðŸ” Search Product</label>
            <input type="text" id="consumptionSearch" class="search-input" placeholder="Search..." oninput="filterConsumptionData()">
        </div>

        <!-- Load Data Button -->
        <div class="filter-group" style="display: flex; align-items: flex-end;">
            <button class="btn btn-primary" onclick="loadConsumptionData()">
                <i class="fas fa-sync"></i> Load Data
            </button>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="analytics-grid" id="consumptionSummary"></div>

    <!-- Date Range Display -->
    <div style="background: var(--primary-50); border-left: 4px solid var(--primary-600); padding: 1rem; margin: 1rem 0; border-radius: 8px;">
        <strong>ðŸ“Š Analysis Period:</strong> <span id="consumptionDateRange">Loading...</span>
    </div>

    <!-- Charts -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
        <div class="chart-container">
            <h3>ðŸ“ˆ Consumption Trend</h3>
            <div class="chart-wrapper">
                <canvas id="consumptionTrendChart"></canvas>
            </div>
        </div>
        <div class="chart-container">
            <h3>ðŸ’° Cost Analysis</h3>
            <div class="chart-wrapper">
                <canvas id="consumptionCostChart"></canvas>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="data-table-container" style="margin-top: 2rem;">
        <div class="table-header">
            <h2 id="consumptionTableTitle">Consumption Details</h2>
            <span id="consumptionCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr id="consumptionTableHeader"></tr>
            </thead>
            <tbody id="consumptionTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ðŸ’° INVENTORY VALUATION REPORTS -->
<div id="inventoryValuation" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Report Type</label>
            <select id="valuationReportType" class="search-input" onchange="loadValuationReport()">
                <option value="current">Current Inventory Value</option>
                <option value="cogs">COGS Analysis</option>
                <option value="turnover">Inventory Turnover</option>
                <option value="days">Days on Hand</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Group By</label>
            <select id="valuationGroupBy" class="search-input" onchange="loadValuationReport()">
                <option value="category">Category</option>
                <option value="vendor">Vendor</option>
                <option value="product">Product</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Time Period</label>
            <select id="valuationPeriod" class="search-input" onchange="loadValuationReport()">
                <option value="week">This Week</option>
                <option value="month" selected>This Month</option>
                <option value="quarter">This Quarter</option>
                <option value="year">This Year</option>
            </select>
        </div>
        <button class="btn btn-primary" onclick="exportValuationReport()">ðŸ“¥ Export PDF</button>
    </div>
    
    <div class="analytics-grid" id="valuationSummary"></div>
    
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; margin-top: 2rem;">
        <div class="chart-container">
            <h3>ðŸ“Š Valuation Breakdown</h3>
            <div class="chart-wrapper"><canvas id="valuationChart"></canvas></div>
        </div>
        <div class="chart-container">
            <h3>ðŸ“ˆ Trend Analysis</h3>
            <div class="chart-wrapper"><canvas id="valuationTrendChart"></canvas></div>
        </div>
    </div>
    
    <div class="data-table-container" style="margin-top: 2rem;">
        <div class="table-header">
            <h2 id="valuationTableTitle">Valuation Details</h2>
            <span id="valuationCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead><tr id="valuationTableHeader"></tr></thead>
            <tbody id="valuationTableBody"></tbody>
        </table>
    </div>
</div>

<!-- ðŸŽ¯ BUDGET TRACKING -->
<div id="budgetTracking" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Budget Period</label>
            <select id="budgetPeriod" class="search-input" onchange="loadBudgetTracking()">
                <option value="weekly">Weekly</option>
                <option value="monthly" selected>Monthly</option>
                <option value="quarterly">Quarterly</option>
            </select>
        </div>
        <div class="filter-group">
            <label>Category</label>
            <select id="budgetCategory" class="search-input" onchange="loadBudgetTracking()">
                <option value="">All Categories</option>
                <option value="Produce">Produce</option>
                <option value="Meat & Seafood">Meat & Seafood</option>
                <option value="Dairy">Dairy</option>
                <option value="Dry Goods">Dry Goods</option>
            </select>
        </div>
        <button class="btn btn-success" onclick="openSetBudgetModal()">âš™ï¸ Set Budget</button>
    </div>
    
    <div class="analytics-grid">
        <div class="metric-card">
            <div class="metric-label">Total Budget</div>
            <div class="metric-value" id="budgetTotal">$0.00</div>
            <div class="metric-subtitle">Current period</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Actual Spend</div>
            <div class="metric-value" id="budgetActual">$0.00</div>
            <div class="metric-subtitle">To date</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Remaining</div>
            <div class="metric-value" id="budgetRemaining">$0.00</div>
            <div class="metric-subtitle">Available</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Variance</div>
            <div class="metric-value" id="budgetVariance">0%</div>
            <div class="metric-subtitle">Over/Under</div>
        </div>
    </div>
    
    <div class="chart-container" style="margin-top: 2rem;">
        <h3>ðŸ“Š Budget vs Actual Spending</h3>
        <div class="chart-wrapper"><canvas id="budgetChart"></canvas></div>
    </div>
    
    <div id="budgetAlerts" style="margin-top: 2rem;"></div>
    
    <div class="data-table-container" style="margin-top: 2rem;">
        <div class="table-header">
            <h2>Budget Details by Category</h2>
            <span id="budgetDetailsCount">0 categories</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Category</th>
                    <th>Budget</th>
                    <th>Actual</th>
                    <th>Remaining</th>
                    <th>% Used</th>
                    <th>Forecast EOD</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody id="budgetDetailsBody"></tbody>
        </table>
    </div>
</div>

<!-- ðŸ† VENDOR PERFORMANCE SCORECARD -->
<div id="vendorPerformance" class="content-section">
    <div class="search-filter-bar">
        <div class="filter-group">
            <label>Time Period</label>
            <select id="performancePeriod" class="search-input" onchange="loadVendorPerformance()">
                <option value="month" selected>Last 30 Days</option>
                <option value="quarter">Last Quarter</option>
                <option value="year">Last Year</option>
            </select>
        </div>
        <div class="search-group">
            <label>Search Vendor</label>
            <input type="text" id="performanceSearch" class="search-input" placeholder="Search..." oninput="filterVendorPerformance()">
        </div>
    </div>
    
    <div id="vendorPerformanceCards"></div>
    
    <div style="display: grid; grid-template-columns: 1fr; gap: 2rem; margin-top: 2rem;">
        <div class="chart-container">
            <h3>ðŸ’° Budget vs Actual Spending</h3>
            <div class="chart-wrapper"><canvas id="vendorScoreChart"></canvas></div>
        </div>
    </div>
</div>

<!-- PLACE ORDER SECTION - ENHANCED -->
<!-- PLACE ORDER SECTION - ENHANCED -->
<div id="placeOrder" class="content-section">
    <!-- Sub-tabs -->
    <div style="background: white; padding: 0.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 2rem; display: flex; gap: 0.5rem;">
        <button class="order-sub-tab active" onclick="switchOrderTab('createOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%); color: white;">
            ðŸ“ 1. Create Order
        </button>
        <button class="order-sub-tab" onclick="switchOrderTab('editOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: transparent; color: var(--neutral-600);">
            âœï¸ 2. Edit Order
        </button>
        <button class="order-sub-tab" onclick="switchOrderTab('finalOrder')" style="flex: 1; padding: 1rem; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; background: transparent; color: var(--neutral-600);">
            ðŸ“Š 3. Final Order & PDFs
        </button>
    </div>

    <!-- CREATE ORDER TAB -->
    <div id="createOrder" class="order-content-section active">
        <!-- Keep existing create order content -->
        <!-- Date Selection -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">ðŸ“… Order Date</label>
                    <input type="date" id="createOrderDate" class="search-input">
                </div>
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">ðŸ¢ Filter by Vendor (optional)</label>
                    <select id="createVendorFilter" class="search-input" onchange="loadEnhancedCreateOrder()">
                        <option value="">â€” All Vendors â€”</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Enhanced Product Cards Container -->
        <div id="enhancedOrderContainer"></div>

        <!-- Submit Button -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-success" onclick="submitAndMarkOrder()" style="padding: 1rem 3rem; font-size: 1.25rem; background: var(--success-600);">
                <i class="fas fa-check-circle"></i> Submit Order
            </button>
            <p style="margin-top: 1rem; font-size: 0.875rem; color: var(--neutral-600);">
                This will save and mark your order as submitted
            </p>
        </div>
    </div>

    <!-- EDIT ORDER TAB (NEW) -->
    <div id="editOrder" class="order-content-section">
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">ðŸ“… Order Date</label>
                    <input type="date" id="editOrderDate" class="search-input">
                </div>
                <button class="btn btn-primary" onclick="loadEditOrder()">
                    <i class="fas fa-sync"></i> Load Order
                </button>
            </div>
        </div>

        <!-- SUBMITTED ORDERS SECTION -->
        <div style="background: white; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 2rem; overflow: hidden;">
            <div style="background: linear-gradient(135deg, var(--success-600), var(--success-500)); padding: 1.5rem; color: white;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-check-circle"></i> Submitted Orders
                    <span id="submittedCount" style="background: white; color: var(--success-700); padding: 0.375rem 1rem; border-radius: 50px; font-size: 1rem;">0</span>
                </h2>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">Items that have been submitted - edit qty/vendor or delete</p>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Image</th>
                            <th style="width: 120px;">Item Code</th>
                            <th>Product</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 200px;">Vendor</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="submittedOrdersBody"></tbody>
                </table>
            </div>
        </div>

        <!-- UNSUBMITTED PRODUCTS SECTION -->
        <div style="background: white; border-radius: 12px; box-shadow: var(--shadow-md); overflow: hidden;">
            <div style="background: linear-gradient(135deg, var(--warning-600), var(--warning-500)); padding: 1.5rem; color: white;">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0; display: flex; align-items: center; gap: 1rem;">
                    <i class="fas fa-exclamation-triangle"></i> Unsubmitted Products
                    <span id="unsubmittedCount" style="background: white; color: var(--warning-700); padding: 0.375rem 1rem; border-radius: 50px; font-size: 1rem;">0</span>
                </h2>
                <p style="margin: 0.5rem 0 0 0; opacity: 0.9;">In case you forgot to add something - set qty & vendor to include</p>
            </div>
            <div style="overflow-x: auto;">
                <table class="data-table" style="margin: 0;">
                    <thead>
                        <tr>
                            <th style="width: 80px;">Image</th>
                            <th style="width: 120px;">Item Code</th>
                            <th>Product</th>
                            <th style="width: 100px;">Quantity</th>
                            <th style="width: 200px;">Vendor</th>
                            <th style="width: 100px;">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="unsubmittedProductsBody"></tbody>
                </table>
            </div>
        </div>

        <!-- Update Order Button -->
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 1.5rem; text-align: center;">
            <button class="btn btn-primary" onclick="updateEditedOrder()" style="padding: 1rem 3rem; font-size: 1.25rem;">
                <i class="fas fa-save"></i> Update Order
            </button>
        </div>
    </div>

    <!-- FINAL ORDER TAB (NEW) -->
    <div id="finalOrder" class="order-content-section">
        <div style="background: white; padding: 1.5rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-bottom: 1.5rem;">
            <div style="display: grid; grid-template-columns: 1fr auto auto; gap: 1rem; align-items: end;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">ðŸ“… Order Date</label>
                    <input type="date" id="finalOrderDate" class="search-input">
                </div>
                <button class="btn btn-secondary" onclick="loadFinalOrderPreview()">
                    <i class="fas fa-eye"></i> Preview Order
                </button>
                <button class="btn btn-success" onclick="generateFinalPDFs()" style="background: var(--success-600);">
                    <i class="fas fa-file-pdf"></i> Generate PDFs
                </button>
            </div>
        </div>

        <!-- Vendor Summary Cards -->
        <div id="vendorSummaryContainer"></div>

        <!-- PDF Generation Section -->
        <div style="background: white; padding: 2rem; border-radius: 12px; box-shadow: var(--shadow-md); margin-top: 2rem;">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--neutral-900); margin-bottom: 0.5rem;">
                    ðŸ“„ Generate Purchase Order PDFs
                </h2>
                <p style="color: var(--neutral-600); font-size: 1rem;">
                    Create professional PDF purchase orders for each vendor to download and send
                </p>
            </div>
            
            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; align-items: end; margin-bottom: 2rem;">
                <div>
                    <label style="display: block; font-size: 0.875rem; font-weight: 600; color: var(--neutral-700); margin-bottom: 0.5rem;">ðŸ“… Order Date</label>
                    <input type="date" id="pdfOrderDate" class="search-input">
                </div>
                <button class="btn btn-success" onclick="generateAllVendorPDFs()" style="padding: 1rem 2rem; font-size: 1.125rem;">
                    <i class="fas fa-file-pdf"></i> Generate All PDFs
                </button>
            </div>
            
            <div id="pdfGenerationResults" style="margin-top: 2rem;"></div>
        </div>
    </div>
</div>

<!-- Inventory Settings Section -->
<div id="inventorySettings" class="content-section">
    <div class="search-filter-bar">
        <div class="search-group">
            <label>ðŸ” Search Products</label>
            <input type="text" id="settingsSearchInput" class="search-input" placeholder="Search products..." oninput="filterInventorySettings()">
        </div>
        <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
            <button class="btn btn-success" onclick="saveAllConversions()">
                <i class="fas fa-save"></i> Save All Settings
            </button>
        </div>
    </div>

    <div class="data-table-container">
        <div class="table-header">
            <h2>âš™ï¸ Product Conversion Factors</h2>
            <span id="settingsCount">Loading...</span>
        </div>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Units per Case</th>
                    <th>Unit Type</th>
                    <th>Notes</th>
                </tr>
            </thead>
            <tbody id="settingsTableBody"></tbody>
        </table>
    </div>
</div>

    <!-- MODALS START HERE -->
    
    <!-- Item Modal -->
    <div class="modal-overlay" id="itemModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="itemModalTitle">Add Item</h2>
                <button class="modal-close" onclick="closeModal('itemModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <form id="itemForm" onsubmit="saveVendorItem(event)">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="itemProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Number *</label>
                        <input type="text" id="itemNumber" required>
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="itemProductImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-group">
                        <label>Vendor *</label>
                        <select id="itemVendor" class="search-input" required>
                            <option value="">-- Select Vendor --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="itemCategory" class="search-input">
                            <option value="">-- Select Category --</option>
                            <option value="Produce">Produce</option>
                            <option value="Meat & Seafood">Meat & Seafood</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Dry Goods">Dry Goods</option>
                            <option value="Frozen">Frozen</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Cleaning Supplies">Cleaning Supplies</option>
                            <option value="Office Supplies">Office Supplies</option>
                            <option value="Kitchen Equipment">Kitchen Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" id="itemPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Purchase Date *</label>
                        <input type="date" id="itemEffectiveDate" required>
                    </div>
                    <div class="form-group">
                        <label>Assign To</label>
                        <select id="itemAssignedTo" class="search-input" multiple style="height: 120px;">
                            <option value="rony">Rony</option>
                            <option value="julio">Julio</option>
                            <option value="office">Office</option>
                        </select>
                        <small style="color: var(--neutral-500); font-size: 0.8125rem;">Hold Ctrl/Cmd to select multiple</small>
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('itemModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">Save</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Quick Edit Modal -->
    <div class="modal-overlay" id="quickEditModal">
        <div class="modal">
            <div class="modal-header">
                <h2 id="quickEditModalTitle">Quick Edit Product</h2>
                <button class="modal-close" onclick="closeModal('quickEditModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="alert alert-success">
                    <i class="fas fa-info-circle"></i>
                    <span>Editing this product will update <strong id="affectedCount">0</strong> matching items in the database.</span>
                </div>
                <form id="quickEditForm" onsubmit="saveQuickEditInvoice(event)">
                    <input type="hidden" id="quickEditItemCode">
                    <div class="form-group">
                        <label>Product Name *</label>
                        <input type="text" id="quickEditProductName" required>
                    </div>
                    <div class="form-group">
                        <label>Item Code *</label>
                        <input type="text" id="quickEditItemCodeDisplay" disabled>
                    </div>
                    <div class="form-group">
                        <label>Vendor *</label>
                        <input type="text" id="quickEditVendor" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="quickEditCategory" class="search-input">
                            <option value="">-- Select Category --</option>
                            <option value="Produce">Produce</option>
                            <option value="Meat & Seafood">Meat & Seafood</option>
                            <option value="Dairy">Dairy</option>
                            <option value="Dry Goods">Dry Goods</option>
                            <option value="Frozen">Frozen</option>
                            <option value="Beverages">Beverages</option>
                            <option value="Cleaning Supplies">Cleaning Supplies</option>
                            <option value="Office Supplies">Office Supplies</option>
                            <option value="Kitchen Equipment">Kitchen Equipment</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price *</label>
                        <input type="number" id="quickEditPrice" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label>Product Image Path</label>
                        <input type="text" id="quickEditImage" placeholder="e.g., product.jpg">
                    </div>
                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('quickEditModal')">Cancel</button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i> Update All Matching Items
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- ENHANCED INVOICE MODAL WITH WEIGHT & PRICE PER UNIT -->
    <div class="modal-overlay" id="invoiceModal">
      <div class="modal">
            <div class="modal-header">
                <h2 id="invoiceModalTitle">Add Invoice</h2>
                <button class="modal-close" onclick="closeModal('invoiceModal')">Ã—</button>
            </div>
            <div class="modal-body" style="max-height: calc(95vh - 140px); overflow-y: auto;">
                <form id="invoiceForm" onsubmit="saveInvoice(event)">
                    <!-- Invoice Header Info -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem; margin-bottom: 1.5rem;">
                        <div class="form-group">
                            <label>Vendor *</label>
                            <select id="invoiceVendorDropdown" class="search-input" required onchange="updateInvoiceVendorField()">
                                <option value="">-- Select Vendor --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Invoice Number *</label>
                           <input type="text" 
       id="invoiceNumber" 
       required 
       oninput="validateInvoiceNumber(this.value)"
       autocomplete="off">
<div id="invoiceNumberValidation" style="margin-top: 0.5rem; font-size: 0.875rem;"></div>
                        </div>
                        <div class="form-group">
                            <label>Check Number</label>
                            <input type="text" id="invoiceCheckNumber" placeholder="e.g., CHK-12345">
                        </div>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                        <div class="form-group">
                            <label>Invoice Date *</label>
                            <input type="date" id="invoiceDate" required>
                        </div>
                        <div class="form-group">
                            <label>Products Count</label>
                            <input type="text" id="invoiceItemsCount" readonly style="background: var(--primary-50); font-weight: 700; font-size: 1.125rem; color: var(--primary-700); text-align: center;">
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Notes</label>
                        <textarea id="invoiceNotes" rows="2" placeholder="Add any additional notes about this invoice..."></textarea>
                    </div>

                    <!-- Tax Toggle -->
                    <div class="form-group" style="margin-bottom: 2rem;">
                        <label class="checkbox-label">
                            <input type="checkbox" id="invoiceTaxEnabled" checked onchange="calculateInvoiceTotals()">
                            <span style="font-weight: 600; color: var(--neutral-700);">
                                <i class="fas fa-receipt"></i> Apply Tax (8.25%)
                            </span>
                        </label>
                        <small style="color: var(--neutral-500); display: block; margin-top: 0.5rem; margin-left: 1.75rem;">
                            Uncheck this for vendors that don't charge tax (e.g., some seafood suppliers)
                        </small>
                    </div>

                    <!-- Product Selection Section -->
                    <div style="margin-top: 2rem; padding-top: 2rem; border-top: 3px solid var(--primary-600);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                            <h3 style="color: var(--primary-700); font-size: 1.25rem;">ðŸ“¦ Invoice Products</h3>
                            <div style="display: flex; align-items: center; gap: 1rem;">
                                <span id="invoiceProductCount" style="color: var(--neutral-600); font-weight: 600; font-size: 1rem;">0 items selected</span>
                                <button type="button" class="btn btn-primary" onclick="toggleProductSearch()" style="padding: 0.5rem 1rem;">
                                    <i class="fas fa-plus"></i> Add Item
                                </button>
                            </div>
                        </div>

                        <!-- Search Section (Initially Hidden) -->
                        <div id="productSearchSection" style="display: none; margin-bottom: 1.5rem; padding: 1.5rem; background: var(--primary-50); border-radius: 12px; border: 2px solid var(--primary-200);">
                            <div class="form-group" style="margin-bottom: 1rem;">
                                <label>ðŸ” Search Products (by name or item code)</label>
                                <input type="text" 
                                       id="invoiceProductSearch" 
                                       class="search-input" 
                                       placeholder="Type to search products..." 
                                       oninput="searchInvoiceProducts()">
                            </div>
                            <div id="invoiceProductResults" style="max-height: 250px; overflow-y: auto; border: 2px solid var(--neutral-300); border-radius: 8px; padding: 1rem; background: white; display: none;"></div>
                        </div>

                        <!-- Selected Products Display -->
                        <div id="selectedInvoiceProducts" style="display: grid; gap: 1rem; margin-bottom: 2rem;"></div>
                        
                        <!-- Invoice Totals -->
                        <div id="invoiceTotalsSection" style="background: var(--neutral-50); padding: 2rem; border-radius: 12px; border: 2px solid var(--neutral-300);">
                            <div style="display: grid; grid-template-columns: 1fr auto; gap: 1rem; max-width: 400px; margin-left: auto;">
                                <div style="text-align: right; font-weight: 600; color: var(--neutral-700);">Subtotal:</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.125rem; color: var(--neutral-900);" id="invoiceSubtotal">$0.00</div>
                                
                                <div style="text-align: right; font-weight: 600; color: var(--neutral-700);" id="taxLabel">Tax (8.25%):</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.125rem; color: var(--neutral-900);" id="invoiceTax">$0.00</div>
                                
                                <div style="text-align: right; font-weight: 700; font-size: 1.25rem; color: var(--primary-900); padding-top: 1rem; border-top: 2px solid var(--neutral-400);">TOTAL:</div>
                                <div style="font-family: var(--font-mono); font-weight: 700; font-size: 1.5rem; color: var(--primary-700); padding-top: 1rem; border-top: 2px solid var(--neutral-400);" id="invoiceTotal">$0.00</div>
                            </div>
                        </div>
                    </div>

                    <div class="form-actions" style="position: sticky; bottom: 0; background: white; padding-top: 1.5rem; margin-top: 2rem; border-top: 2px solid var(--neutral-200); z-index: 100;">
                        <button type="button" class="btn btn-secondary" onclick="closeModal('invoiceModal')">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" class="btn btn-success" style="font-size: 1.125rem; padding: 0.875rem 2rem;">
                            <i class="fas fa-save"></i> Save Invoice
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Bulk Assignment Modal -->
    <div class="modal-overlay" id="bulkAssignModal">
        <div class="modal">
            <div class="modal-header">
                <h2>ðŸ‘¥ Bulk Assignment</h2>
                <button class="modal-close" onclick="closeModal('bulkAssignModal')">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Select Products</label>
                    <div style="max-height: 300px; overflow-y: auto; border: 2px solid var(--neutral-300); border-radius: 8px; padding: 1rem;">
                        <div style="margin-bottom: 1rem;">
                            <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                                <input type="checkbox" id="selectAllProducts" onchange="toggleAllProducts()" style="width: 18px; height: 18px;">
                                <strong>Select All</strong>
                            </label>
                        </div>
                        <div id="productCheckboxList"></div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Assign To</label>
                    <select id="bulkAssignTo" class="search-input">
                        <option value="">-- Select Person --</option>
                        <option value="rony">Rony</option>
                        <option value="julio">Julio</option>
                        <option value="office">Office</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mode</label>
                    <select id="assignmentMode" class="search-input">
                        <option value="replace">Replace existing</option>
                        <option value="add">Add to existing</option>
                    </select>
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('bulkAssignModal')">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveBulkAssignment()">
                        <i class="fa-solid fa-floppy-disk"></i> Save Assignments
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Add Product Modal -->
<div class="modal-overlay" id="addProductModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="addProductModalTitle">Add Product</h2>
            <button class="modal-close" onclick="closeModal('addProductModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" onsubmit="saveNewProduct(event)">
                <input type="hidden" id="addProductUser" value="">
                
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="addProductName" required class="search-input">
                </div>
                
                <div class="form-group">
                    <label>Image Filename</label>
                    <input type="text" id="addProductImage" placeholder="e.g., product.jpg" class="search-input">
                    <small style="color: var(--neutral-500); font-size: 0.875rem;">Images should be in GitHub repository</small>
                </div>
                
                <div class="form-group">
                    <label>Vendor</label>
                    <select id="addProductVendor" class="search-input">
                        <option value="Supermarket">Supermarket</option>
                        <option value="General List">General List</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="addProductCategory" class="search-input">
                        <option value="">-- Select Category --</option>
                        <option value="Produce">Produce</option>
                        <option value="Meat & Seafood">Meat & Seafood</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Dry Goods">Dry Goods</option>
                        <option value="Frozen">Frozen</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Cleaning Supplies">Cleaning Supplies</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Kitchen Equipment">Kitchen Equipment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- Position field (only for Rony) -->
                <div class="form-group" id="addProductPositionGroup" style="display: none;">
                    <label>Position *</label>
                    <input type="number" id="addProductPosition" min="1" class="search-input">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

    <script >

        // ========== CRITICAL: GLOBAL FUNCTIONS FIRST ==========
        window.switchTab = function(tabName, evt) {
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
            
            if (evt && evt.target) {
                evt.target.classList.add('active');
            }
            
            const targetSection = document.getElementById(tabName);
            if (targetSection) targetSection.classList.add('active');
            
            // Load tab content
            setTimeout(() => {
                if (tabName === 'quickEdit' && typeof renderQuickEditTable === 'function') {
                    renderQuickEditTable();
                } else if (tabName === 'vendors' && typeof loadVendorManagement === 'function') {
                    loadVendorManagement();
                } else if (tabName === 'vendorSpending' && typeof loadVendorSpendingAnalysis === 'function') {
                    loadVendorSpendingAnalysis();
                } else if (tabName === 'julioOrders' && typeof loadJulioOrders === 'function') {
                    loadJulioOrders();
                } else if (tabName === 'ronyOrders' && typeof loadRonyOrders === 'function') {
                    loadRonyOrders();
                } else if (tabName === 'officeOrders' && typeof loadOfficeOrders === 'function') {
                    loadOfficeOrders();
                } else if (tabName === 'placeOrder' && typeof initializeEnhancedPlaceOrder === 'function') {
                    initializeEnhancedPlaceOrder();
                } else if (tabName === 'inventorySettings' && typeof loadInventorySettings === 'function') {
                    loadInventorySettings();
                } else if (tabName === 'submissionHistory' && typeof loadSubmissionHistory === 'function') {
                    loadSubmissionHistory();
                } else if (tabName === 'stockAlerts' && typeof loadStockAlerts === 'function') {
                    loadStockAlerts();
                } else if (tabName === 'consumptionTracking' && typeof loadConsumptionData === 'function') {
                    loadConsumptionData();
                } else if (tabName === 'inventoryValuation' && typeof loadValuationReport === 'function') {
                    loadValuationReport();
                } else if (tabName === 'budgetTracking' && typeof loadBudgetTracking === 'function') {
                    loadBudgetTracking();
                } else if (tabName === 'vendorPerformance' && typeof loadVendorPerformance === 'function') {
                    loadVendorPerformance();
                }
            }, 0);
        };

        window.showAlert = function(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            if (!container) return;
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        };

        window.showLoading = function(show) {
            const loadingEl = document.getElementById('loadingOverlay');
            if (loadingEl) loadingEl.classList.toggle('active', show);
        };

        window._priceCache2026 = window._priceCache2026 || new Map();


// ========== CRITICAL: DEFINE IMAGE ERROR HANDLER FIRST ==========
const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI2MCIgeT0iNjAiIGZvbnQtZmFtaWx5PSJBcmlhbCwgc2Fucy1zZXJpZiIgZm9udC1zaXplPSIxNCIgZmlsbD0iIzljYTNhZiIgdGV4dC1hbmNob3I9Im1pZGRsZSIgZHk9IjAuM2VtIj5ObyBJbWFnZTwvdGV4dD48L3N2Zz4=';
const GITHUB_IMAGE_BASE = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/';

window.PLACEHOLDER_IMAGE = PLACEHOLDER_IMAGE;
window.handleImageError = function(img) {
    if (!img) return;
    img.onerror = null; // Prevent infinite loop
    img.src = PLACEHOLDER_IMAGE;
};
// ========== END CRITICAL SECTION ==========

// ========== IMAGE RESOLUTION FUNCTION ==========
function resolveImage(imageName) {
    if (!imageName || imageName.trim() === '') {
        return PLACEHOLDER_IMAGE;
    }
    
    const trimmed = imageName.trim();
    
    // If it's a full Supabase URL, extract just the filename
    if (trimmed.includes('supabase.co/storage') || trimmed.startsWith('http')) {
        const parts = trimmed.split('/');
        const filename = parts[parts.length - 1];
        
        // Remove any query parameters (like timestamps)
        const cleanFilename = filename.split('?')[0];
        
        return GITHUB_IMAGE_BASE + cleanFilename;
    }
    
    // Otherwise, it's just a filename - use it directly
    return GITHUB_IMAGE_BASE + trimmed;
}
// ========== END IMAGE RESOLUTION FUNCTION ==========

const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// â”€â”€ VENDOR LOGO URLS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const VENDOR_LOGO_URLS = {
    'Formosa Foods':         'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
    'North Food Group':      'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
    'Pacific Plus':          'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
    'BakeMark':              'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg',
    'Delta Office Products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
    'Autochlor':             'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/autochlor.jpg',
};

const COMPANY_LOGO_URL =
    'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg';

const VENDOR_TAX_RULES = {
    'Formosa Foods':         { taxAll: false },
    'North Food Group':      { taxAll: false },
    'Pacific Plus':          { taxAll: false, taxableItemCodes: ['752GO'] },
    'Delta Office Products': { taxAll: true },
    'BakeMark':              { taxAll: false },
    'Autochlor':             { taxAll: false },
};

const TAX_RATE_PDF = 0.0825;



        let inventoryData = [];
        let filteredData = [];
        let invoicesData = [];
        let filteredInvoices = [];
        let deleteMode = false;
        let selectedItems = new Set();
        let selectedVendorMonths = [];
        let vendorDistributionChart, vendorPriceChart, priceHistoryChart;
        let vendorSpendingCharts = {};
        let selectedInvoiceProducts = [];
        const TAX_RATE = 0.0825; // 8.25%

        // Vendor logos map
        const VENDOR_LOGOS = {
            'formosafoods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
            'formosa foods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
            'northfoodgroup': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
            'north food group': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
            'pacificplus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
            'pacific plus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
            'deltaofficeproducts': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
            'delta office products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
            'bakemark': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg',
            'autochlor': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/autochlor.jpg',
            'supermarket': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg'
        };

async function initializeApp() {
    showLoading(true);
    try {
        await loadAllData();
        await loadJulioOrders();
        await loadRonyOrders();
        renderInventoryTable();
        renderQuickEditTable();
        updateRecordCount();
        initializeVendorMonthSelector();
        showAlert('System initialized successfully', 'success');
    } catch (error) {
        console.error('Init error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

        async function loadAllData() {
            await Promise.all([
                loadInventoryData(),
                loadInvoices(),
                loadAnalytics()
            ]);
        }

        async function loadInventoryData() {
            try {
                const { data, error } = await supabaseClient
                    .from('purchase_history')
                    .select('*')
                    .order('purchase_date', { ascending: false });
                if (error) throw error;
                inventoryData = data || [];
                filteredData = [...inventoryData];
                populateVendorFilter();
                populateProductSelects();
                populateInvoiceVendorSelect();
                populateInvoiceVendorDropdown();
            } catch (error) {
                console.error('Load inventory error:', error);
            }
        }

        function toggleProductSearch() {
            const searchSection = document.getElementById('productSearchSection');
            const isHidden = searchSection.style.display === 'none';
            searchSection.style.display = isHidden ? 'block' : 'none';
            
            if (isHidden) {
                document.getElementById('invoiceProductSearch').focus();
            }
        }

        async function loadInvoices() {
            try {
                const { data, error } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .order('invoice_date', { ascending: false });
                if (error) throw error;
                invoicesData = data || [];
                filteredInvoices = [...invoicesData];
                renderInvoicesTable();
            } catch (error) {
                console.error('Load invoices error:', error);
            }
        }

        async function loadAnalytics() {
            // Load invoice_items data from 2026 onward for accurate metrics
            const { data: invoiceItems } = await supabaseClient
                .from('invoice_items')
                .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

            const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
            let invDateMap = new Map();
            if (invoiceIds.length > 0) {
                const { data: invoices } = await supabaseClient
                    .from('invoices')
                    .select('id, invoice_date')
                    .in('id', invoiceIds);
                (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
            }

            // Filter to 2026+ items only
            const items2026Plus = (invoiceItems || []).filter(item => {
                const invDate = invDateMap.get(item.invoice_id);
                if (!invDate) return false;
                return new Date(invDate).getFullYear() >= 2026;
            });

            const uniqueProducts = new Set(items2026Plus.map(i => i.product_name)).size;
            const activeVendors = new Set(items2026Plus.map(i => i.vendor).filter(v => v)).size;
            
            // CRITICAL: Use unit_price, NOT line totals
            const prices = items2026Plus.map(i => {
                const price = i.has_weight 
                    ? parseFloat(i.price_per_unit || 0)
                    : parseFloat(i.unit_price || 0);
                return price;
            }).filter(p => p > 0);
            
            const avgPrice = prices.length > 0 ? prices.reduce((a,b) => a+b, 0) / prices.length : 0;
            const totalValue = prices.reduce((a,b) => a+b, 0);

            document.getElementById('metricTotalProducts').textContent = uniqueProducts;
            document.getElementById('metricActiveVendors').textContent = activeVendors;
            document.getElementById('metricAvgPrice').textContent = '$' + avgPrice.toFixed(2);
            document.getElementById('metricTotalValue').textContent = '$' + totalValue.toFixed(2);

            renderVendorDistributionChart();
            renderVendorsOverviewTable();
        }


// ========== VENDOR MANAGEMENT FUNCTIONS ==========
async function loadVendorManagement() {
    showLoading(true);
    try {
        const { data: invoices, error } = await supabaseClient
            .from('invoices')
            .select('vendor, total, invoice_date')
            .order('invoice_date', { ascending: false });

        if (error) throw error;

        // Group by vendor
        const vendorStats = {};
        (invoices || []).forEach(inv => {
            if (!vendorStats[inv.vendor]) {
                vendorStats[inv.vendor] = {
                    productCount: 0,
                    totalPurchases: 0,
                    lastPurchase: null
                };
            }
            vendorStats[inv.vendor].productCount += 1;
            vendorStats[inv.vendor].totalPurchases += parseFloat(inv.total || 0);
            if (!vendorStats[inv.vendor].lastPurchase || new Date(inv.invoice_date) > new Date(vendorStats[inv.vendor].lastPurchase)) {
                vendorStats[inv.vendor].lastPurchase = inv.invoice_date;
            }
        });

        renderVendorsTable(vendorStats);

    } catch (error) {
        console.error('Load vendor management error:', error);
        showAlert('Error loading vendor data', 'error');
    } finally {
        showLoading(false);
    }
}

function renderVendorsTable(vendorStats) {
    const tbody = document.getElementById('vendorsTableBody');
    document.getElementById('vendorCount').textContent = `${Object.keys(vendorStats).length} vendors`;

    const vendors = Object.entries(vendorStats).sort((a, b) => b[1].totalPurchases - a[1].totalPurchases);

    tbody.innerHTML = vendors.map(([vendor, stats]) => {
        const logoUrl = getVendorLogo(vendor);
        const logoHtml = logoUrl 
            ? `<img src="${logoUrl}" style="width:50px;height:50px;object-fit:contain;border-radius:8px;" onerror="this.style.display='none'">`
            : `<div style="width:50px;height:50px;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:1.5rem;color:var(--neutral-500);background:var(--neutral-100);border-radius:8px;">${vendor.substring(0,2).toUpperCase()}</div>`;

        return `
            <tr>
                <td>${logoHtml}</td>
                <td style="font-weight: 600;">${vendor}</td>
                <td><span class="vendor-badge">${stats.productCount}</span></td>
                <td>${formatDate(stats.lastPurchase)}</td>
                <td><span class="price-cell" style="font-weight: 700;">$${stats.totalPurchases.toFixed(2)}</span></td>
            </tr>
        `;
    }).join('');
}


        function getVendorLogo(vendorName) {
            if (!vendorName) return null;
            const vendorKey = vendorName.toLowerCase().replace(/\s+/g, '');
            return VENDOR_LOGOS[vendorKey] || VENDOR_LOGOS[vendorName.toLowerCase()] || null;
        }

        function initializeVendorMonthSelector() {
            const months = [
                'January', 'February', 'March', 'April', 'May', 'June',
                'July', 'August', 'September', 'October', 'November', 'December'
            ];
            
            const container = document.getElementById('vendorMonthSelector');
            container.innerHTML = months.map((month, idx) => {
                return `<div class="month-chip" data-month="${idx + 1}" onclick="toggleVendorMonth(${idx + 1})">${month}</div>`;
            }).join('');
        }

        function toggleVendorMonth(monthNum) {
            const chip = document.querySelector(`#vendorMonthSelector [data-month="${monthNum}"]`);
            chip.classList.toggle('selected');
            
            const index = selectedVendorMonths.indexOf(monthNum);
            if (index > -1) {
                selectedVendorMonths.splice(index, 1);
            } else {
                selectedVendorMonths.push(monthNum);
            }
            
            loadVendorSpendingAnalysis();
        }

        async function loadVendorSpendingAnalysis() {
            const year = document.getElementById('vendorSpendingYear')?.value;
            if (!year) return;

            const selectedMonths = selectedVendorMonths.length > 0 ? selectedVendorMonths : [1,2,3,4,5,6,7,8,9,10,11,12];
            
            showLoading(true);
            const container = document.getElementById('vendorSpendingContent');
            
            try {
                // Ensure invoices are loaded
                if (!invoicesData || invoicesData.length === 0) {
                    await loadInvoices();
                }

                const filteredInvoices = (invoicesData || []).filter(inv => {
                    if (!inv || !inv.invoice_date) return false;
                    const invDate = new Date(inv.invoice_date);
                    const invYear = invDate.getFullYear().toString();
                    const invMonth = invDate.getMonth() + 1;
                    return invYear === year && selectedMonths.includes(invMonth);
                });

                const vendorData = {};
                filteredInvoices.forEach(inv => {
                    if (!inv.vendor) return;
                    
                    if (!vendorData[inv.vendor]) {
                        vendorData[inv.vendor] = {
                            total: 0,
                            months: {},
                            invoiceCount: 0
                        };
                    }
                    
                    const month = new Date(inv.invoice_date).getMonth() + 1;
                    if (!vendorData[inv.vendor].months[month]) {
                        vendorData[inv.vendor].months[month] = 0;
                    }
                    
                    const amount = parseFloat(inv.total || inv.amount || 0);
                    vendorData[inv.vendor].months[month] += amount;
                    vendorData[inv.vendor].total += amount;
                    vendorData[inv.vendor].invoiceCount++;
                });

                renderVendorSpendingCards(vendorData, year, selectedMonths);
                
            } catch (error) {
                console.error('Vendor spending analysis error:', error);
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">âš ï¸</div>
                        <h3>Error loading vendor spending analysis</h3>
                        <p style="color: var(--error-600);">${error.message}</p>
                    </div>
                `;
            } finally {
                showLoading(false);
            }
        }

        function renderVendorSpendingCards(vendorData, year, selectedMonths) {
            const container = document.getElementById('vendorSpendingContent');
            const monthNames = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            
            if (Object.keys(vendorData).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">ðŸ’°</div>
                        <h3>No Invoice Data Available</h3>
                        <p>No invoices found for the selected year and months.</p>
                    </div>
                `;
                return;
            }

            const sortedVendors = Object.entries(vendorData).sort((a, b) => b[1].total - a[1].total);
            
            let html = '';
            
            sortedVendors.forEach(([vendor, data]) => {
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : `<div class="vendor-image" style="display: flex; align-items: center; justify-content: center; font-weight: 700; font-size: 2rem; color: var(--neutral-500); background: var(--neutral-100);">${vendor.substring(0, 2).toUpperCase()}</div>`;
                
                html += `
                    <div class="vendor-card">
                        <div class="vendor-card-header">
                            ${logoHtml}
                            <div style="flex: 1;">
                                <div class="vendor-card-title">${vendor}</div>
                                <div style="color: var(--neutral-600); font-size: 0.9375rem; margin-top: 0.5rem;">
                                    ${data.invoiceCount} invoices â€¢ Year ${year}
                                </div>
                            </div>
                            <div class="vendor-total-card">
                                <div class="vendor-total-label">Total Spent</div>
                                <div class="vendor-total-value">$${data.total.toFixed(2)}</div>
                            </div>
                        </div>
                        
                        <div class="vendor-monthly-grid">
                `;
                
                selectedMonths.sort((a, b) => a - b).forEach(month => {
                    const amount = data.months[month] || 0;
                    html += `
                        <div class="vendor-month-card">
                            <div class="vendor-month-label">${monthNames[month - 1]}</div>
                            <div class="vendor-month-value">$${amount.toFixed(2)}</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                        
                        <div class="chart-container" style="margin-top: 2rem;">
                            <h3>ðŸ“Š Monthly Spending Trend - ${vendor}</h3>
                            <div class="chart-wrapper">
                                <canvas id="vendorChart_${vendor.replace(/\s+/g, '_')}"></canvas>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
            
            setTimeout(() => {
                sortedVendors.forEach(([vendor, data]) => {
                    renderVendorChart(vendor, data, selectedMonths, monthNames);
                });
            }, 100);
        }

function calcLineTax(vendor, itemCode, lineTotal) {
    const rule = VENDOR_TAX_RULES[vendor];
    if (!rule) return 0;
    if (rule.taxAll) return lineTotal * TAX_RATE_PDF;
    if (rule.taxableItemCodes && rule.taxableItemCodes.includes((itemCode || '').trim().toUpperCase())) {
        return lineTotal * TAX_RATE_PDF;
    }
    return 0;
}
// â”€â”€ IMAGE HELPER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchImageBase64(url) {
    if (!url) return null;
    try {
        // Convert GitHub blob URLs to raw URLs
        let fetchUrl = url;
        if (fetchUrl.includes('github.com') && !fetchUrl.includes('raw.githubusercontent.com')) {
            fetchUrl = fetchUrl
                .replace('github.com', 'raw.githubusercontent.com')
                .replace('/blob/', '/');
        }
        const res = await fetch(fetchUrl);
        if (!res.ok) return null;
        const blob = await res.blob();
        return await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result);
            reader.onerror = () => resolve(null);
            reader.readAsDataURL(blob);
        });
    } catch (e) {
        console.warn('Image fetch failed:', url, e.message);
        return null;
    }
}



        function renderVendorChart(vendor, data, selectedMonths, monthNames) {
            const canvasId = `vendorChart_${vendor.replace(/\s+/g, '_')}`;
            const ctx = document.getElementById(canvasId);
            if (!ctx) return;
            
            if (vendorSpendingCharts[vendor]) {
                vendorSpendingCharts[vendor].destroy();
            }
            
            const labels = selectedMonths.sort((a, b) => a - b).map(m => monthNames[m - 1]);
            const amounts = selectedMonths.sort((a, b) => a - b).map(m => data.months[m] || 0);
            
            vendorSpendingCharts[vendor] = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Monthly Spending',
                        data: amounts,
                        backgroundColor: 'rgba(44, 86, 136, 0.8)',
                        borderColor: '#2c5688',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '$' + v.toFixed(0)
                            }
                        }
                    }
                }
            });
        }

        // âœ… FIXED: renderInventoryTable function
function renderInventoryTable() {
    const tbody = document.getElementById('inventoryTableBody');
    if (filteredData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="9"><div class="empty-state"><div class="empty-state-icon">ðŸ“¦</div><h3>No Items Found</h3></div></td></tr>';
        return;
    }
tbody.innerHTML = filteredData.map((item, idx) => {
    const imageUrl = resolveImage(item.image_path);

    let assignedArray = [];
    try {
        if (Array.isArray(item.assigned_to)) {
            assignedArray = item.assigned_to;
        } else if (typeof item.assigned_to === 'string') {
            const s = item.assigned_to.trim();
            if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                assignedArray = JSON.parse(s);
            }
        }
    } catch (e) {
        assignedArray = [];
    }
    assignedArray = assignedArray.filter(x => typeof x === 'string' && x.trim() !== '');

    const checkboxCell = (deleteMode || bulkAssignMode) ? `
        <td>
            <input type="checkbox" 
                   class="item-checkbox" 
                   ${selectedItems.has(item.id) ? 'checked' : ''}
                   onchange="toggleItemSelection('${item.id}')" 
                   style="cursor: pointer; width: 18px; height: 18px;">
        </td>
    ` : '';

    const assignmentBadges = assignedArray.length > 0 
        ? assignedArray.map(person => `
            <span class="assignment-badge" 
                  onclick="removeSingleAssignment('${item.id}', '${person}')"
                  title="Click to remove ${person}">
                ${person.charAt(0).toUpperCase() + person.slice(1)}
            </span>`
          ).join(' ')
        : '';

    const assignmentSelect = assignedArray.length === 0 ? `
        <select class="assignment-select" 
                onchange="quickAssign('${item.item_code}', this.value); this.value='';"
                style="margin-left: 0.5rem; width: auto; min-width: 100px;">
            <option value="">+ Assign</option>
            <option value="rony">Rony</option>
            <option value="julio">Julio</option>
            <option value="office">Office</option>
        </select>`
    : '';

    return `
        <tr>
            ${checkboxCell}
            <td><img src="${imageUrl}" class="product-image" onerror="this.src='${PLACEHOLDER_IMAGE}'"></td>
            <td><span class="vendor-badge">${item.vendor || 'Unknown'}</span></td>
            <td><span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">${item.category || 'Uncategorized'}</span></td>
            <td><span class="item-number">${item.item_code || 'N/A'}</span></td>
            <td>${item.product_name || 'Unnamed'}</td>
            <td><span class="price-cell">$${parseFloat(item.unit_price || 0).toFixed(2)}</span></td>
            <td>${formatDate(item.purchase_date)}</td>
            <td>${assignmentBadges}${assignmentSelect}</td>
            <td>
                <button class="btn btn-icon btn-secondary" onclick="editItem('${item.id}')" title="Edit">
                    <i class="fas fa-edit"></i>
                </button>
                <button class="btn btn-icon btn-danger" onclick="deleteSingleItem('${item.id}')" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>
            </td>
        </tr>
    `;
}).join('');
}

// âœ… FIXED: renderQuickEditTable - show only 2026+ invoice_items, group by item_code
async function renderQuickEditTable() {
    showLoading(true);
    const tbody = document.getElementById('quickEditTableBody');
    
    try {
        // Load all invoice_items
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
        let invDateMap = new Map();
        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
        }

        // Load product images from inventory_management
        const { data: mgmtData } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url');
        const imageMap = new Map();
        (mgmtData || []).forEach(item => {
            if (item.image_url) imageMap.set(item.product_name, item.image_url);
        });

        // Filter to 2026+ items only
        let items2026Plus = (invoiceItems || []).filter(item => {
            const invDate = invDateMap.get(item.invoice_id);
            if (!invDate) return false;
            return new Date(invDate).getFullYear() >= 2026;
        });

        // Apply filters
        const assignFilter = document.getElementById('quickEditAssignFilter')?.value;
        const searchTerm = document.getElementById('quickEditSearch')?.value.toLowerCase() || '';

        if (searchTerm) {
            items2026Plus = items2026Plus.filter(item => {
                const name = (item.product_name || '').toLowerCase();
                const code = (item.item_code || '').toLowerCase();
                return name.includes(searchTerm) || code.includes(searchTerm);
            });
        }

        // Group by item_code
        const productMap = new Map();
        items2026Plus.forEach(item => {
            if (!item.item_code) return;
            
            if (!productMap.has(item.item_code)) {
                // Get latest price/vendor for this item_code
                const price = item.has_weight 
                    ? parseFloat(item.price_per_unit || 0)
                    : parseFloat(item.unit_price || 0);
                
                productMap.set(item.item_code, {
                    code: item.item_code,
                    name: item.product_name || 'Unnamed',
                    vendor: item.vendor || 'Unknown',
                    price: price,
                    image_url: imageMap.get(item.product_name) || null,
                    count: 0
                });
            }
            productMap.get(item.item_code).count++;
        });

        const products = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
        
        document.getElementById('quickEditCount').textContent = `${products.length} unique products (2026+)`;

        if (products.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ðŸ“¦</div><h3>No Products Found</h3><p>No invoice items from 2026 onward match your search</p></div></td></tr>';
            return;
        }

        tbody.innerHTML = products.map(p => {
            const imgSrc = p.image_url || 'https://via.placeholder.com/50x50?text=No+Image';
            return `
            <tr>
                <td><img src="${imgSrc}" class="product-image" style="width:50px;height:50px;object-fit:cover;border-radius:8px;" onerror="this.src='https://via.placeholder.com/50x50?text=No+Image'"></td>
                <td><span class="item-number">${p.code}</span></td>
                <td>${p.name}</td>
                <td><span class="vendor-badge">${p.vendor}</span></td>
                <td><span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">-</span></td>
                <td><span class="price-cell">$${parseFloat(p.price).toFixed(2)}</span></td>
                <td><span style="font-weight: 600; color: var(--primary-700);">${p.count} items</span></td>
                <td>
                    <button class="btn btn-primary" onclick="openQuickEditModalInvoice('${p.code}', ${p.count})">
                        <i class="fas fa-edit"></i> Edit All
                    </button>
                </td>
            </tr>
        `}).join('');
        
    } catch (error) {
        console.error('Quick edit load error:', error);
        tbody.innerHTML = `<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">âš ï¸</div><h3>Error loading data</h3><p>${error.message}</p></div></td></tr>`;
    } finally {
        showLoading(false);
    }
}



        function filterQuickEdit() {
            renderQuickEditTable();
        }

       // NEW: Quick edit modal for invoice_items
       async function openQuickEditModalInvoice(itemCode, count) {
    try {
        const { data: items } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight')
            .eq('item_code', itemCode)
            .limit(1);
        
        if (!items || items.length === 0) return;
        
        const firstItem = items[0];
        const price = firstItem.has_weight 
            ? parseFloat(firstItem.price_per_unit || 0)
            : parseFloat(firstItem.unit_price || 0);
        
        document.getElementById('quickEditItemCode').value = itemCode;
        document.getElementById('quickEditItemCodeDisplay').value = itemCode;
        document.getElementById('quickEditProductName').value = firstItem.product_name || '';
        document.getElementById('quickEditVendor').value = firstItem.vendor || '';
        document.getElementById('quickEditPrice').value = price;
        document.getElementById('affectedCount').textContent = count;
        
        openModal('quickEditModal');
    } catch (error) {
        console.error('Open quick edit error:', error);
        showAlert('Error: ' + error.message, 'error');
    }
}

async function saveQuickEditInvoice(event) {
    event.preventDefault();
    showLoading(true);
    
    try {
        const itemCode = document.getElementById('quickEditItemCode').value;
        const productName = document.getElementById('quickEditProductName').value;
        const vendor = document.getElementById('quickEditVendor').value;
        const price = parseFloat(document.getElementById('quickEditPrice').value);

        // Update all invoice_items with this item_code
        const { data: updated, error } = await supabaseClient
            .from('invoice_items')
            .update({
                product_name: productName,
                vendor: vendor,
                unit_price: price,
                price_per_unit: price
            })
            .eq('item_code', itemCode)
            .select();

        if (error) throw error;

        const updateCount = updated ? updated.length : 0;
        showAlert(`âœ… Updated ${updateCount} matching items with code ${itemCode}`, 'success');
        closeModal('quickEditModal');
        await renderQuickEditTable();

    } catch (error) {
        console.error('Quick edit save error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

       async function openQuickEditModal(itemCode, count) {
    const items = inventoryData.filter(i => i.item_code === itemCode);
    if (items.length === 0) return;

    const firstItem = items[0];
    
    document.getElementById('quickEditItemCode').value = itemCode;
    document.getElementById('quickEditItemCodeDisplay').value = itemCode;
    document.getElementById('quickEditProductName').value = firstItem.product_name || '';
    document.getElementById('quickEditVendor').value = firstItem.vendor || '';
    document.getElementById('quickEditCategory').value = firstItem.category || '';
    document.getElementById('quickEditPrice').value = firstItem.unit_price || '';
    document.getElementById('quickEditImage').value = firstItem.image_path || '';
    document.getElementById('affectedCount').textContent = count;
    
    openModal('quickEditModal');
}
        async function saveQuickEdit(event) {
    event.preventDefault();
    showLoading(true);
    
    try {
        const itemCode = document.getElementById('quickEditItemCode').value;
        const productName = document.getElementById('quickEditProductName').value;
        const vendor = document.getElementById('quickEditVendor').value;
        const price = parseFloat(document.getElementById('quickEditPrice').value);
        const imagePath = document.getElementById('quickEditImage').value.trim() || null;
        const category = document.getElementById('quickEditCategory').value || null;

        const { error } = await supabaseClient
            .from('purchase_history')
            .update({
                product_name: productName,
                vendor: vendor,
                category: category,
                unit_price: price,
                image_path: imagePath
            })
            .eq('item_code', itemCode);

        if (error) throw error;

        showAlert('All matching items updated successfully!', 'success');
        closeModal('quickEditModal');
        await loadInventoryData();
        renderInventoryTable();
        renderQuickEditTable();
        applyFilters();

    } catch (error) {
        console.error('Quick edit error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

        async function quickAssign(itemCode, person) {
            if (!person || !itemCode) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => item.item_code === itemCode);
                if (itemsToUpdate.length === 0) {
                    showAlert('No items found with this item code', 'error');
                    return;
                }

                for (const item of itemsToUpdate) {
                    const currentAssigned = Array.isArray(item.assigned_to) ? item.assigned_to : [];
                    if (!currentAssigned.includes(person)) {
                      const newAssigned = [person]; // exclusive!
                        const { error } = await supabaseClient
                            .from('purchase_history')
                            .update({ assigned_to: newAssigned })
                            .eq('id', item.id);

                        if (error) throw error;
                    }
                }

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} assigned to all items with code: ${itemCode}`, 'success');
                
                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Quick assign error:', error);
                showAlert('Error updating assignment', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function removeSingleAssignment(itemId, person) {
            showLoading(true);
            try {
                const currentItem = inventoryData.find(item => item.id === itemId);
                if (!currentItem) {
                    showAlert('Item not found. Please refresh the page.', 'error');
                    return;
                }

                const existing = currentItem.assigned_to || [];
                const existingArray = Array.isArray(existing) ? existing : [];
                const newAssignment = existingArray.filter(p => p !== person);

                const { error } = await supabaseClient
                    .from('purchase_history')
                   .update({ assigned_to: [person] })
                    .eq('id', itemId);

                if (error) throw error;

                showAlert(`${person.charAt(0).toUpperCase() + person.slice(1)} removed from assignment`, 'success');

                await loadInventoryData();
                applyFilters();

            } catch (error) {
                console.error('Remove assignment error:', error);
                showAlert('Error removing assignment: ' + (error.message || 'Unknown'), 'error');
            } finally {
                showLoading(false);
            }
        }

        function populateInvoiceVendorSelect() {
            const vendors = [...new Set(invoicesData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorSelect');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function filterInvoicesByVendor() {
            const vendorFilter = document.getElementById('invoiceVendorSelect').value;
            const yearFilter = document.getElementById('invoiceYearSelect').value;
            
            let data = [...invoicesData];
            
            if (vendorFilter) {
                data = data.filter(i => i.vendor === vendorFilter);
            }
            
            if (yearFilter) {
                data = data.filter(i => new Date(i.invoice_date).getFullYear().toString() === yearFilter);
            }
            
            filteredInvoices = data;
            renderInvoicesTable();
        }

        async function loadProductAnalytics() {
            const productName = document.getElementById('analyticsProductSelect').value;
            if (!productName) {
                document.getElementById('productAnalysisSection').style.display = 'none';
                return;
            }

            showLoading(true);
            try {
                const productItems = inventoryData.filter(i => i.product_name === productName);
                
                if (productItems.length === 0) {
                    showAlert('No data found for this product', 'error');
                    return;
                }

                document.getElementById('productAnalysisSection').style.display = 'block';
                
                renderPriceComparison(productItems);
                renderVendorPriceChart(productItems);
                renderPriceHistoryChart(productItems);
                renderVarianceAnalysis(productItems);

            } catch (error) {
                console.error('Analytics error:', error);
                showAlert('Error loading analytics', 'error');
            } finally {
                showLoading(false);
            }
        }

        function renderPriceComparison(data) {
            const prices = data.map(i => parseFloat(i.unit_price));
            const minPrice = Math.min(...prices);
            const maxPrice = Math.max(...prices);
            const avgPrice = prices.reduce((a,b) => a+b, 0) / prices.length;
            
            const minItem = data.find(i => parseFloat(i.unit_price) === minPrice);
            const maxItem = data.find(i => parseFloat(i.unit_price) === maxPrice);

            const container = document.getElementById('priceComparison');
            container.innerHTML = `
                <div class="comparison-card lowest">
                    <div class="comparison-label">ðŸ’° Lowest Price</div>
                    <div class="comparison-value" style="color: var(--success-600);">$${minPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${minItem.vendor}</div>
                    <div class="comparison-date">${formatDate(minItem.purchase_date)}</div>
                </div>
                <div class="comparison-card average">
                    <div class="comparison-label">ðŸ“Š Average Price</div>
                    <div class="comparison-value" style="color: var(--primary-600);">$${avgPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">Across ${data.length} purchases</div>
                    <div class="comparison-date">All vendors</div>
                </div>
                <div class="comparison-card highest">
                    <div class="comparison-label">ðŸ“ˆ Highest Price</div>
                    <div class="comparison-value" style="color: var(--warning-600);">$${maxPrice.toFixed(2)}</div>
                    <div class="comparison-vendor">${maxItem.vendor}</div>
                    <div class="comparison-date">${formatDate(maxItem.purchase_date)}</div>
                </div>
                <div class="comparison-card">
                    <div class="comparison-label">ðŸ“‰ Price Variance</div>
                    <div class="comparison-value" style="color: var(--accent-500);">${((maxPrice - minPrice) / minPrice * 100).toFixed(1)}%</div>
                    <div class="comparison-vendor">Spread: $${(maxPrice - minPrice).toFixed(2)}</div>
                    <div class="comparison-date">Max vs Min</div>
                </div>
            `;
        }

        function renderVendorPriceChart(data) {
            const vendorPrices = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorPrices[vendor]) vendorPrices[vendor] = [];
                vendorPrices[vendor].push(parseFloat(item.unit_price));
            });

            const vendors = Object.keys(vendorPrices);
            const avgPrices = vendors.map(v => {
                const sum = vendorPrices[v].reduce((a,b) => a+b, 0);
                return sum / vendorPrices[v].length;
            });
            const minPrices = vendors.map(v => Math.min(...vendorPrices[v]));
            const maxPrices = vendors.map(v => Math.max(...vendorPrices[v]));

            const ctx = document.getElementById('vendorPriceChart');
            if (vendorPriceChart) vendorPriceChart.destroy();
            vendorPriceChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: vendors,
                    datasets: [
                        {
                            label: 'Minimum Price',
                            data: minPrices,
                            backgroundColor: 'rgba(5, 150, 105, 0.8)',
                            borderColor: '#059669',
                            borderWidth: 2
                        },
                        {
                            label: 'Average Price',
                            data: avgPrices,
                            backgroundColor: 'rgba(44, 86, 136, 0.8)',
                            borderColor: '#2c5688',
                            borderWidth: 2
                        },
                        {
                            label: 'Maximum Price',
                            data: maxPrices,
                            backgroundColor: 'rgba(220, 38, 38, 0.8)',
                            borderColor: '#dc2626',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderPriceHistoryChart(data) {
            const sortedData = [...data].sort((a,b) => new Date(a.purchase_date) - new Date(b.purchase_date));
            
            const vendorData = {};
            sortedData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorData[vendor]) vendorData[vendor] = [];
                vendorData[vendor].push({
                    x: item.purchase_date,
                    y: parseFloat(item.unit_price)
                });
            });

            const colors = ['#2c5688', '#f59e0b', '#10b981', '#dc2626', '#8b5cf6', '#ec4899'];
            const datasets = Object.keys(vendorData).map((vendor, idx) => ({
                label: vendor,
                data: vendorData[vendor],
                borderColor: colors[idx % colors.length],
                backgroundColor: colors[idx % colors.length] + '40',
                borderWidth: 3,
                fill: false,
                tension: 0.4,
                pointRadius: 6,
                pointHoverRadius: 8
            }));

            const ctx = document.getElementById('priceHistoryChart');
            if (priceHistoryChart) priceHistoryChart.destroy();
            priceHistoryChart = new Chart(ctx, {
                type: 'line',
                data: { datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                font: { size: 14, weight: 'bold' }
                            }
                        }
                    },
                    scales: {
                        x: {
                            type: 'time',
                            time: { unit: 'month' },
                            title: { display: true, text: 'Purchase Date' }
                        },
                        y: {
                            title: { display: true, text: 'Price ($)' },
                            ticks: {
                                callback: (v) => '$' + v.toFixed(2)
                            }
                        }
                    }
                }
            });
        }

        function renderVarianceAnalysis(data) {
            const vendorStats = {};
            data.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { prices: [], count: 0 };
                }
                vendorStats[vendor].prices.push(parseFloat(item.unit_price));
                vendorStats[vendor].count++;
            });

            const analysis = Object.keys(vendorStats).map(vendor => {
                const prices = vendorStats[vendor].prices;
                const min = Math.min(...prices);
                const max = Math.max(...prices);
                const avg = prices.reduce((a,b) => a+b, 0) / prices.length;
                const variance = max - min;
                const variancePct = (variance / min * 100).toFixed(1);

                return { vendor, min, max, avg, variance, variancePct, count: prices.length };
            }).sort((a,b) => a.avg - b.avg);

            const container = document.getElementById('varianceAnalysis');
            container.innerHTML = `
                <table style="width: 100%; border-collapse: collapse;">
                    <thead>
                        <tr style="background: var(--neutral-100); font-weight: 700;">
                            <th style="padding: 1rem; text-align: left;">Vendor</th>
                            <th style="padding: 1rem; text-align: right;">Purchases</th>
                            <th style="padding: 1rem; text-align: right;">Min Price</th>
                            <th style="padding: 1rem; text-align: right;">Avg Price</th>
                            <th style="padding: 1rem; text-align: right;">Max Price</th>
                            <th style="padding: 1rem; text-align: right;">Variance</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.map(stat => `
                            <tr style="border-bottom: 1px solid var(--neutral-200);">
                                <td style="padding: 1rem;"><span class="vendor-badge">${stat.vendor}</span></td>
                                <td style="padding: 1rem; text-align: right;">${stat.count}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--success-600); font-weight: 600;">$${stat.min.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-weight: 600;">$${stat.avg.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; color: var(--warning-600); font-weight: 600;">$${stat.max.toFixed(2)}</td>
                                <td style="padding: 1rem; text-align: right; font-family: var(--font-mono); font-weight: 700; color: var(--accent-500);">
                                    ${stat.variancePct}%
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function renderInvoicesTable() {
            const tbody = document.getElementById('invoicesTableBody');
            document.getElementById('invoiceCount').textContent = `${filteredInvoices.length} invoices`;
            
            if (filteredInvoices.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ðŸ’°</div><h3>No Invoices</h3></div></td></tr>';
                return;
            }

            tbody.innerHTML = filteredInvoices.map(inv => `
                <tr>
                    <td><span class="vendor-badge">${inv.vendor}</span></td>
                    <td><span class="item-number">${inv.invoice_number}</span></td>
                    <td><span class="item-number">${inv.check_number || '-'}</span></td>
                    <td>${formatDate(inv.invoice_date)}</td>
                    <td><span class="price-cell">$${parseFloat(inv.total || inv.amount || 0).toFixed(2)}</span></td>
                    <td>${inv.notes || '-'}</td>
                    <td>
                        <button class="btn btn-icon btn-secondary" onclick="editInvoice('${inv.id}')" title="Edit Invoice">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-icon btn-danger" onclick="deleteInvoice('${inv.id}')" title="Delete Invoice">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        function renderVendorDistributionChart() {
            const vendorCounts = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                vendorCounts[vendor] = (vendorCounts[vendor] || 0) + 1;
            });

            const ctx = document.getElementById('vendorDistributionChart');
            if (vendorDistributionChart) vendorDistributionChart.destroy();
            vendorDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(vendorCounts),
                    datasets: [{
                        data: Object.values(vendorCounts),
                        backgroundColor: ['#2c5688','#f59e0b','#10b981','#dc2626','#8b5cf6','#ec4899']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }

        function renderVendorsOverviewTable() {
            const tbody = document.getElementById('vendorsTableBody');
            const vendorStats = {};
            inventoryData.forEach(item => {
                const vendor = item.vendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { count: 0, lastPurchase: null, totalValue: 0 };
                }
                vendorStats[vendor].count++;
                vendorStats[vendor].totalValue += parseFloat(item.unit_price || 0);
                const purchaseDate = new Date(item.purchase_date);
                if (!vendorStats[vendor].lastPurchase || purchaseDate > vendorStats[vendor].lastPurchase) {
                    vendorStats[vendor].lastPurchase = purchaseDate;
                }
            });

            const vendors = Object.keys(vendorStats).sort();
            document.getElementById('vendorCount').textContent = `${vendors.length} vendors`;

            tbody.innerHTML = vendors.map(vendor => {
                const stats = vendorStats[vendor];
                const logoUrl = getVendorLogo(vendor);
                const logoHtml = logoUrl 
                    ? `<img src="${logoUrl}" class="vendor-image" alt="${vendor}" onerror="this.style.display='none'">`
                    : '<div style="width: 120px; height: 120px; background: var(--neutral-200); border-radius: 12px; display: flex; align-items: center; justify-content: center; font-weight: 700; color: var(--neutral-500); font-size: 2rem;">' + vendor.substring(0, 2).toUpperCase() + '</div>';
                
                return `
                    <tr>
                        <td>${logoHtml}</td>
                        <td><span class="vendor-badge">${vendor}</span></td>
                        <td>${stats.count}</td>
                        <td>${stats.lastPurchase ? formatDate(stats.lastPurchase.toISOString()) : 'N/A'}</td>
                        <td><span class="price-cell">$${stats.totalValue.toFixed(2)}</span></td>
                    </tr>
                `;
            }).join('');
        }

function performSearch() {
    const term = document.getElementById('searchInput').value.toLowerCase();
    filteredData = inventoryData.filter(item => {
        const name = (item.product_name || '').toLowerCase();
        const code = (item.item_code || '').toLowerCase();
        const vendor = (item.vendor || '').toLowerCase();
        return name.includes(term) || code.includes(term) || vendor.includes(term);
    });
    applyFilters();
}

   function applyFilters() {
    const vendorFilter = document.getElementById('vendorFilter').value;
    const yearFilter = document.getElementById('yearFilter').value;
    const assignedFilter = document.getElementById('assignedToFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;  // ADD THIS LINE

    let data = filteredData.length > 0 ? filteredData : inventoryData;

    if (vendorFilter) {
        data = data.filter(i => i.vendor === vendorFilter);
    }

    if (yearFilter) {
        data = data.filter(i => new Date(i.purchase_date).getFullYear().toString() === yearFilter);
    }

    if (assignedFilter) {
        if (assignedFilter === 'unassigned') {
            data = data.filter(i => !i.assigned_to || i.assigned_to.length === 0);
        } else {
            data = data.filter(i => {
                if (!i.assigned_to) return false;
                return Array.isArray(i.assigned_to) && i.assigned_to.includes(assignedFilter);
            });
        }
    }

    // ADD THIS BLOCK
    if (categoryFilter) {
        data = data.filter(i => i.category === categoryFilter);
    }

    filteredData = data;
    renderInventoryTable();
    updateRecordCount();
}

        function populateVendorFilter() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('vendorFilter');
            select.innerHTML = '<option value="">All Vendors</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        function populateProductSelects() {
            const uniqueProducts = [...new Set(inventoryData.map(i => i.product_name).filter(p => p))].sort();
            const select = document.getElementById('analyticsProductSelect');
            select.innerHTML = '<option value="">Choose a product to compare prices...</option>';
            uniqueProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p;
                opt.textContent = p;
                select.appendChild(opt);
            });
        }

        function updateRecordCount() {
            document.getElementById('recordCount').textContent = `${filteredData.length} of ${inventoryData.length} items`;
        }

      
      function formatDate(dateString) {
    if (!dateString) return 'N/A';
    
    // Parse date string manually to avoid timezone conversion
    const parts = dateString.split('T')[0].split('-'); // Get YYYY-MM-DD part
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    
    // Create date object using local timezone components
    const date = new Date(parseInt(year), parseInt(month) - 1, parseInt(day));
    
    return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
}
      
      
      
      
      
      
      
              function showAlert(message, type = 'info') {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.appendChild(alert);
            setTimeout(() => alert.remove(), 5000);
        }

        function showLoading(show) {
            document.getElementById('loadingOverlay').classList.toggle('active', show);
        }

    
function switchTab(tabName, evt) {
    document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.content-section').forEach(sec => sec.classList.remove('active'));
    
    if (evt && evt.target) {
        evt.target.classList.add('active');
    }
    
    document.getElementById(tabName).classList.add('active');
    
    if (tabName === 'quickEdit') {
        renderQuickEditTable();
    } else if (tabName === 'vendors') {
        loadVendorManagement();
    } else if (tabName === 'vendorSpending') {
        loadVendorSpendingAnalysis();
    } else if (tabName === 'julioOrders') {
        loadJulioOrders();
    } else if (tabName === 'ronyOrders') {
        loadRonyOrders();
    } else if (tabName === 'officeOrders') {
        loadOfficeOrders();
    } else if (tabName === 'placeOrder') {
        initializeEnhancedPlaceOrder();
    } else if (tabName === 'inventorySettings') {
        loadInventorySettings();
    } else if (tabName === 'submissionHistory') {
        loadSubmissionHistory();
    } else if (tabName === 'stockAlerts') {
        loadStockAlerts();
    } else if (tabName === 'consumptionTracking') {
        loadConsumptionData();
    } else if (tabName === 'inventoryValuation') {
        loadValuationReport();
    } else if (tabName === 'budgetTracking') {
        loadBudgetTracking();
    } else if (tabName === 'vendorPerformance') {
        loadVendorPerformance();
    }
}


           function exportToCSV() {
            const headers = ['Vendor','Item No.','Description','Price','Date','Assigned To'];
            const rows = filteredData.map(item => [
                item.vendor || '',
                item.item_code || '',
                item.product_name || '',
                item.unit_price || '',
                item.purchase_date || '',
                (item.assigned_to && item.assigned_to[0]) || ''
            ]);

            let csv = headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });

            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `inventory-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
            showAlert('Exported successfully', 'success');
        }

     function openAddItemModal() {
    document.getElementById('itemModalTitle').textContent = 'Add Item';
    document.getElementById('itemForm').reset();
    document.getElementById('itemForm').removeAttribute('data-edit-id');
    document.getElementById('itemEffectiveDate').valueAsDate = new Date();
    populateVendorDropdownInModal(); // â† ADD THIS LINE
    openModal('itemModal');
}


async function editItem(id) {
    console.log('ðŸ” editItem called with ID:', id, 'Type:', typeof id);
    console.log('ðŸ“¦ inventoryData length:', inventoryData.length);
    console.log('ðŸ“¦ First item ID:', inventoryData[0]?.id, 'Type:', typeof inventoryData[0]?.id);
    
    showLoading(true);
    try {
        // Try to find item with flexible ID comparison (handles string vs UUID vs number)
        const item = inventoryData.find(i => {
            // Convert both to strings for comparison to handle type mismatches
            return String(i.id) === String(id);
        });
        
        if (!item) {
            console.error('âŒ Item not found! ID:', id);
            console.error('Available IDs:', inventoryData.map(i => i.id));
            showAlert('Item not found. Please refresh the page and try again.', 'error');
            return;
        }

        console.log('âœ… Item found:', item);

        // Set form title and edit ID FIRST
        document.getElementById('itemModalTitle').textContent = 'Edit Item';
        document.getElementById('itemForm').dataset.editId = id;
        
        // Populate vendor dropdown BEFORE setting values
        populateVendorDropdownInModal();
        
        // Now set all the field values
        document.getElementById('itemProductName').value = item.product_name || '';
        document.getElementById('itemNumber').value = item.item_code || '';
        document.getElementById('itemProductImage').value = item.image_path || '';
        document.getElementById('itemVendor').value = item.vendor || '';
        document.getElementById('itemCategory').value = item.category || '';  // ADD THIS LINE

        document.getElementById('itemPrice').value = item.unit_price || '';
        document.getElementById('itemEffectiveDate').value = item.purchase_date || '';
        
        // Set assigned_to
        const assignedToSelect = document.getElementById('itemAssignedTo');
        const assignedArray = Array.isArray(item.assigned_to) ? item.assigned_to : [];
        Array.from(assignedToSelect.options).forEach(option => {
            option.selected = assignedArray.includes(option.value);
        });
        
        // Open modal
        openModal('itemModal');
        
    } catch (error) {
        console.error('ðŸ’¥ Edit item error:', error);
        showAlert('Error loading item: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}




function populateVendorDropdownInModal() {
    const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
    const select = document.getElementById('itemVendor');
    const currentValue = select.value; // Save current selection
    
    select.innerHTML = '<option value="">-- Select Vendor --</option>';
    vendors.forEach(v => {
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = v;
        select.appendChild(opt);
    });
    
    // Restore selection if it exists
    if (currentValue) {
        select.value = currentValue;
    }
}



function openAddInvoiceModal() {
    document.getElementById('invoiceModalTitle').textContent = 'Add Invoice';
    document.getElementById('invoiceForm').reset();
    document.getElementById('invoiceForm').removeAttribute('data-edit-id');
    document.getElementById('invoiceDate').valueAsDate = new Date();
    document.getElementById('invoiceItemsCount').value = '0 items';
    document.getElementById('invoiceTaxEnabled').checked = true;
    
    document.getElementById('invoiceNumberValidation').innerHTML = '';
    document.getElementById('invoiceNumber').style.borderColor = '';
    document.getElementById('invoiceNumber').style.background = '';
    isInvoiceNumberValid = false;
    
    selectedInvoiceProducts = [];
    renderSelectedInvoiceProducts();
    populateInvoiceVendorDropdown();
    document.getElementById('productSearchSection').style.display = 'none';
    document.getElementById('invoiceProductResults').style.display = 'none';
    
    preloadLastPrices();
    
    openModal('invoiceModal');
}


        function openModal(modalId) {
            document.getElementById(modalId).classList.add('active');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

      async function saveVendorItem(event) {
    event.preventDefault();
    showLoading(true);
    try {
        const assignedToSelect = document.getElementById('itemAssignedTo');
        const assignedTo = Array.from(assignedToSelect.selectedOptions).map(o => o.value);
        const editId = document.getElementById('itemForm').dataset.editId;

        const itemData = {
            product_name: document.getElementById('itemProductName').value,
            item_code: document.getElementById('itemNumber').value,
            vendor: document.getElementById('itemVendor').value,
            category: document.getElementById('itemCategory').value || null,
            unit_price: parseFloat(document.getElementById('itemPrice').value),
            purchase_date: document.getElementById('itemEffectiveDate').value,
            image_path: document.getElementById('itemProductImage').value.trim() || null,
            assigned_to: assignedTo
        };

        if (editId) {
            // Single item edit
            const { error } = await supabaseClient.from('purchase_history').update(itemData).eq('id', editId);
            if (error) throw error;

            // Auto-update ALL matching item_codes
            if (itemData.item_code) {
                const { data: matchingItems, error: updateError } = await supabaseClient
                    .from('purchase_history')
                    .update({
                        product_name: itemData.product_name,
                        vendor: itemData.vendor,
                        category: itemData.category,
                        unit_price: itemData.unit_price,
                        image_path: itemData.image_path
                    })
                    .eq('item_code', itemData.item_code)
                    .select();

                if (updateError) throw updateError;

                const updateCount = matchingItems ? matchingItems.length : 0;
                showAlert(`âœ… Updated ${updateCount} item(s) with code ${itemData.item_code}`, 'success');
            } else {
                showAlert('Item updated!', 'success');
            }
        } else {
            const { error } = await supabaseClient.from('purchase_history').insert([itemData]);
            if (error) throw error;
            showAlert('Item added!', 'success');
        }

        closeModal('itemModal');
        await loadInventoryData();
        renderQuickEditTable();
        applyFilters();
    } catch (error) {
        console.error('Save error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

        // ========== ENHANCED INVOICE FUNCTIONS WITH WEIGHT & PRICE PER UNIT ==========

        function calculateInvoiceTotals() {
            const subtotal = selectedInvoiceProducts.reduce((sum, p) => {
                const hasWeight = p.has_weight && p.weight && p.weight > 0;
                if (hasWeight) {
                    return sum + (parseFloat(p.weight || 0) * parseFloat(p.price_per_unit || 0));
                } else {
                    return sum + (parseFloat(p.quantity || 0) * parseFloat(p.invoice_price || 0));
                }
            }, 0);
            
            const taxEnabled = document.getElementById('invoiceTaxEnabled').checked;
            const taxAmount = taxEnabled ? subtotal * TAX_RATE : 0;
            const total = subtotal + taxAmount;
            
            document.getElementById('invoiceSubtotal').textContent = '$' + subtotal.toFixed(2);
            document.getElementById('invoiceTax').textContent = '$' + taxAmount.toFixed(2);
            document.getElementById('invoiceTotal').textContent = '$' + total.toFixed(2);
            
            // Update tax label
            const taxLabel = document.getElementById('taxLabel');
            if (taxEnabled) {
                taxLabel.textContent = 'Tax (8.25%):';
                taxLabel.style.color = 'var(--neutral-700)';
            } else {
                taxLabel.textContent = 'Tax (Disabled):';
                taxLabel.style.color = 'var(--neutral-400)';
            }
            
            return { subtotal, taxAmount, total, taxEnabled };
        }

        function updateInvoiceVendorField() {
            const vendor = document.getElementById('invoiceVendorDropdown').value;
            if (vendor) {
                searchInvoiceProducts();
            }
        }

       function searchInvoiceProducts() {
    const searchTerm = document.getElementById('invoiceProductSearch').value.toLowerCase();
    const selectedVendor = document.getElementById('invoiceVendorDropdown').value;
    const resultsDiv = document.getElementById('invoiceProductResults');
    
    if (!searchTerm && !selectedVendor) {
        resultsDiv.style.display = 'none';
        return;
    }

    let filteredProducts = inventoryData.filter(item => {
        const matchesSearch = !searchTerm || 
            (item.product_name || '').toLowerCase().includes(searchTerm) ||
            (item.item_code || '').toLowerCase().includes(searchTerm);
        
        const matchesVendor = !selectedVendor || item.vendor === selectedVendor;
        
        return matchesSearch && matchesVendor;
    });

    const productMap = new Map();
    filteredProducts.forEach(item => {
        if (!productMap.has(item.item_code)) {
            productMap.set(item.item_code, item);
        }
    });

    const uniqueProducts = Array.from(productMap.values());

    if (uniqueProducts.length === 0) {
        resultsDiv.innerHTML = '<p style="color: var(--neutral-500); text-align: center; padding: 1rem;">No products found</p>';
        resultsDiv.style.display = 'block';
        return;
    }

    resultsDiv.style.display = 'block';
    resultsDiv.innerHTML = uniqueProducts.map(item => {
        const imageUrl = resolveImage(item.image_path);
        const isSelected = selectedInvoiceProducts.some(p => p.item_code === item.item_code);
        
        return `
            <div class="invoice-product-item ${isSelected ? 'selected' : ''}" 
                 onclick="toggleInvoiceProduct('${item.item_code}')">
                <img src="${imageUrl}" style="width: 50px; height: 50px; border-radius: 6px; object-fit: cover;" onerror="this.src='${PLACEHOLDER_IMAGE}'">
                <div style="flex: 1;">
                    <div style="font-weight: 600; color: var(--neutral-900);">${item.product_name || 'Unnamed'}</div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600);">
                        <span class="item-number">${item.item_code}</span> â€¢ 
                        <span class="vendor-badge" style="padding: 0.125rem 0.5rem; font-size: 0.75rem;">${item.vendor}</span>
                    </div>
                </div>
                <div style="text-align: right;">
                    <div class="price-cell" style="font-size: 1.125rem;">$${parseFloat(item.unit_price || 0).toFixed(2)}</div>
                    ${isSelected ? '<i class="fas fa-check-circle" style="color: var(--success-600); font-size: 1.25rem;"></i>' : ''}
                </div>
            </div>
        `;
    }).join('');
}

async function toggleInvoiceProduct(itemCode) {
    const existingIndex = selectedInvoiceProducts.findIndex(p => p.item_code === itemCode);
    
    if (existingIndex > -1) {
        selectedInvoiceProducts.splice(existingIndex, 1);
    } else {
        const product = inventoryData.find(i => i.item_code === itemCode);
        if (!product) return;

        // âœ… Fetch last unit price from purchase_history
        let lastPrice = null;
        try {
            const { data, error } = await supabaseClient
                .from('purchase_history')
                .select('unit_price')
                .eq('item_code', itemCode)
                .eq('vendor', product.vendor)
                .order('purchase_date', { ascending: false })
                .limit(1);
            
            if (!error && data && data.length > 0) {
                lastPrice = parseFloat(data[0].unit_price);
            }
        } catch (e) {
            console.warn('Failed to fetch last price:', e);
        }

        // âœ… Use lastPrice if available, otherwise inventory price
        const unitPrice = lastPrice !== null ? lastPrice : (parseFloat(product.unit_price) || 0);

        selectedInvoiceProducts.push({
            item_code: product.item_code,
            product_name: product.product_name,
            vendor: product.vendor,
            unit_price: unitPrice,
            invoice_price: unitPrice,        // â† THIS IS THE KEY: set unit price
            quantity: 1,
            weight: null,
            price_per_unit: unitPrice,
            has_weight: false,
            image_path: product.image_path,
            originalItemCode: product.item_code,
            originalProductName: product.product_name
        });
    }

    renderSelectedInvoiceProducts();
    searchInvoiceProducts();

    // âœ… Auto-scroll to new item
    setTimeout(() => {
        const container = document.getElementById('selectedInvoiceProducts');
        if (container && container.lastElementChild) {
            container.lastElementChild.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 100);
}

function renderSelectedInvoiceProducts() {
    const container = document.getElementById('selectedInvoiceProducts');
    const countLabel = document.getElementById('invoiceProductCount');
    const itemsCountField = document.getElementById('invoiceItemsCount');
    
    container.style.maxHeight = '600px';
    container.style.overflowY = 'auto';
    container.style.paddingRight = '10px';
    
    const itemCount = selectedInvoiceProducts.length;
    countLabel.textContent = `${itemCount} item${itemCount !== 1 ? 's' : ''} selected`;
    itemsCountField.value = `${itemCount} item${itemCount !== 1 ? 's' : ''}`;
    
    if (itemCount === 0) {
        container.innerHTML = `
            <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; border: 2px dashed var(--neutral-300);">
                <div style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.3;">ðŸ“¦</div>
                <h3 style="color: var(--neutral-600); margin-bottom: 0.5rem;">No Products Added Yet</h3>
                <p style="color: var(--neutral-500);">Click "Add Item" to search and add products to this invoice</p>
            </div>
        `;
        calculateInvoiceTotals();
        return;
    }

    container.innerHTML = selectedInvoiceProducts.map((product, idx) => {
        const imageUrl = resolveImage(product.image_path);
        const hasWeight = product.has_weight && product.weight && product.weight > 0;
        
        const weightNum = parseFloat(product.weight) || 0;
        const pricePerUnitNum = parseFloat(product.price_per_unit) || 0;
        const quantityNum = parseInt(product.quantity) || 1;
        const invoicePriceNum = parseFloat(product.invoice_price) || 0;
        
        const lineTotal = hasWeight 
            ? (weightNum * pricePerUnitNum).toFixed(2)
            : (quantityNum * invoicePriceNum).toFixed(2);

        return `
            <div class="selected-product-card" style="display: grid; grid-template-columns: 60px 1fr auto; gap: 1rem; align-items: start; background: white; border: 2px solid var(--success-600); border-radius: 12px; padding: 1.25rem; margin-bottom: 1rem;">
                <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'" style="width: 60px; height: 60px; border-radius: 8px; object-fit: cover; box-shadow: var(--shadow-sm);">
                
                <div style="display: grid; gap: 0.75rem;">
                    <div>
                        <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Product Name</label>
                        <input type="text" 
                               class="editable-field" 
                               value="${product.product_name || ''}"
                               onchange="updateInvoiceProductField(${idx}, 'product_name', this.value)"
                               style="width: 100%; font-size: 0.9375rem; font-weight: 600;">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.75rem;">
                        <div>
                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Item Code</label>
                            <input type="text" 
                                   class="editable-field" 
                                   value="${product.item_code || ''}"
                                   onchange="updateInvoiceProductField(${idx}, 'item_code', this.value)"
                                   style="width: 100%; font-size: 0.875rem; font-family: var(--font-mono);">
                            <small style="color: var(--accent-500); font-size: 0.7rem; display: block; margin-top: 0.25rem;">
                                <i class="fas fa-info-circle"></i> Updates all matching items
                            </small>
                        </div>
                        
                        <div>
                            <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Vendor</label>
                            <div style="padding: 0.75rem; background: var(--neutral-100); border-radius: 6px; font-size: 0.875rem; color: var(--neutral-700); font-weight: 600;">
                                ${product.vendor || ''}
                            </div>
                        </div>
                    </div>
                    
                    <!-- WEIGHT-BASED PRICING SECTION -->
                    <div style="background: var(--primary-50); padding: 1rem; border-radius: 8px; border: 2px solid var(--primary-200);">
                        <label class="checkbox-label" style="margin-bottom: 0.75rem;">
                            <input type="checkbox" 
                                   ${hasWeight ? 'checked' : ''}
                                   onchange="toggleWeightMode(${idx}, this.checked)">
                            <span style="font-weight: 600; color: var(--primary-700);">
                                <i class="fas fa-weight"></i> Weight-Based Pricing (for meat, seafood, produce)
                            </span>
                        </label>
                        
                        ${hasWeight ? `
                            <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Weight (lbs) âš–ï¸</label>
                                    <input type="number" 
                                           class="editable-field" 
                                           value="${product.weight || ''}"
                                           min="0"
                                           step="0.01"
                                           placeholder="25.5"
                                           onchange="updateInvoiceProductField(${idx}, 'weight', this.value)"
                                           style="width: 100%; font-size: 1.125rem; font-weight: 700; text-align: center;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Price per lb ðŸ’µ</label>
                                    <input type="number" 
                                           class="editable-field" 
                                           value="${product.price_per_unit || ''}"
                                           min="0"
                                           step="0.01"
                                           placeholder="3.20"
                                           onchange="updateInvoiceProductField(${idx}, 'price_per_unit', this.value)"
                                           style="width: 100%; font-size: 1.125rem; font-weight: 700; font-family: var(--font-mono);">
                                    <small style="color: var(--primary-600); font-size: 0.7rem; display: block; margin-top: 0.25rem;">
                                        Last: $${product.unit_price ? parseFloat(product.unit_price).toFixed(2) : 'N/A'}
                                    </small>
                                </div>
                                
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Calculation</label>
                                    <div style="padding: 0.75rem; background: white; border-radius: 6px; font-size: 0.875rem; color: var(--neutral-700); border: 2px solid var(--neutral-300); font-family: var(--font-mono);">
                                        ${weightNum.toFixed(2)} Ã— $${pricePerUnitNum.toFixed(2)}
                                    </div>
                                </div>
                            </div>
                        ` : `
                            <div style="display: grid; grid-template-columns: 100px 1fr; gap: 0.75rem; margin-top: 0.75rem;">
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Quantity</label>
                                    <input type="number" 
                                           class="editable-field" 
                                           value="${product.quantity || 1}"
                                           min="1"
                                           step="1"
                                           onchange="updateInvoiceProductField(${idx}, 'quantity', this.value)"
                                           style="width: 100%; font-size: 1.125rem; font-weight: 700; text-align: center;">
                                </div>
                                
                                <div>
                                    <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Price Each ðŸ’°</label>
                                    <input type="number" 
                                           class="editable-field" 
                                           value="${product.invoice_price || 0}"
                                           min="0"
                                           step="0.01"
                                           onchange="updateInvoiceProductField(${idx}, 'invoice_price', this.value)"
                                           style="width: 100%; font-size: 1.125rem; font-weight: 700; font-family: var(--font-mono);">
                                    <small style="color: var(--primary-600); font-size: 0.7rem; display: block; margin-top: 0.25rem;">
                                        Last: $${product.unit_price ? parseFloat(product.unit_price).toFixed(2) : 'N/A'}
                                    </small>
                                </div>
                            </div>
                        `}
                    </div>
                    
                    <!-- LINE TOTAL -->
                    <div>
                        <label style="font-size: 0.75rem; color: var(--neutral-600); font-weight: 600; display: block; margin-bottom: 0.25rem;">Line Total</label>
                        <div style="font-size: 1.75rem; font-weight: 700; color: var(--primary-700); font-family: var(--font-mono); padding: 1rem; background: var(--primary-50); border-radius: 8px; text-align: center; border: 2px solid var(--primary-300);">
                            $${lineTotal}
                        </div>
                    </div>
                </div>
                
                <div style="text-align: right;">
                    <button type="button" 
                            class="btn btn-danger btn-icon" 
                            onclick="removeInvoiceProduct(${idx})"
                            title="Remove Item"
                            style="width: 50px; height: 50px; font-size: 1.25rem;">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    calculateInvoiceTotals();
    document.getElementById('productSearchSection').style.display = 'none';
    document.getElementById('invoiceProductSearch').value = '';
    document.getElementById('invoiceProductResults').style.display = 'none';
    
    // âœ… AUTO-SCROLL TO NEW ITEM
    setTimeout(() => {
        const lastItem = container.lastElementChild;
        if (lastItem) {
            lastItem.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }
    }, 100);
    
    // âœ… ADD "BACK TO SEARCH" BUTTON
    const scrollButton = document.createElement('div');
    scrollButton.innerHTML = `
        <div style="text-align: center; padding: 1rem; margin-top: 1rem;">
            <button type="button" 
                    class="btn btn-primary" 
                    onclick="document.getElementById('productSearchSection').scrollIntoView({behavior: 'smooth'})"
                    style="padding: 0.75rem 2rem; font-size: 1rem; box-shadow: var(--shadow-md);">
                <i class="fas fa-arrow-up"></i> Back to Search
            </button>
        </div>
    `;
    container.appendChild(scrollButton);
}





// Get last price for a product from purchase history
async function getLastPriceForProduct(itemCode, vendor) {
    try {
        const { data, error } = await supabaseClient
            .from('purchase_history')
            .select('unit_price, purchase_date')
            .eq('item_code', itemCode)
            .eq('vendor', vendor)
            .order('purchase_date', { ascending: false })
            .limit(1);
        
        if (error || !data || data.length === 0) return null;
        return parseFloat(data[0].unit_price);
    } catch (error) {
        console.error('Error getting last price:', error);
        return null;
    }
}


// Preload last prices when modal opens
async function preloadLastPrices() {
    try {
        console.log('ðŸ”„ Preloading last prices...');
        
        // Get all unique product-vendor combinations
        const uniqueCombinations = new Set();
        inventoryData.forEach(item => {
            if (item.item_code && item.vendor) {
                uniqueCombinations.add(`${item.item_code}_${item.vendor}`);
            }
        });
        
        // Fetch last prices in batches
        let count = 0;
        for (const combo of uniqueCombinations) {
            const [itemCode, vendor] = combo.split('_');
            await getLastPriceForProduct(itemCode, vendor);
            count++;
        }
        
        console.log('âœ… Preloaded last prices for', count, 'products');
    } catch (error) {
        console.error('Error preloading prices:', error);
    }
}

function toggleWeightMode(index, isEnabled) {
    if (index >= 0 && index < selectedInvoiceProducts.length) {
        const product = selectedInvoiceProducts[index];
        
        product.has_weight = isEnabled;
        
        if (isEnabled) {
            // Switching TO weight mode
            if (!product.weight) {
                product.weight = 1.0;
            }
            if (!product.price_per_unit) {
                // âœ… Convert to NUMBER, not string
                product.price_per_unit = parseFloat(product.invoice_price) || 0;
            }
        } else {
            // Switching FROM weight mode
            if (product.weight && product.price_per_unit) {
                // âœ… Convert to NUMBER, not string
                product.invoice_price = parseFloat(product.weight) * parseFloat(product.price_per_unit);
            }
            product.weight = null;
            product.price_per_unit = null;
        }
        
        renderSelectedInvoiceProducts();
    }
}



function updateInvoiceProductField(index, field, value) {
    if (index >= 0 && index < selectedInvoiceProducts.length) {
        const product = selectedInvoiceProducts[index];
        
        if (field === 'quantity') {
            product.quantity = Math.max(1, parseInt(value) || 1);
        } else if (field === 'weight') {
            product.weight = Math.max(0, parseFloat(value) || 0);
        } else if (field === 'invoice_price') {
            const price = parseFloat(value);
            product.invoice_price = isNaN(price) ? 0 : price;
        } else if (field === 'price_per_unit') {
            const price = parseFloat(value);
            product.price_per_unit = isNaN(price) ? 0 : price;
        } else if (field === 'product_name') {
            product.product_name = value;
        } else if (field === 'item_code') {
            product.item_code = value;
        }
        
        renderSelectedInvoiceProducts();
    }
}


        function removeInvoiceProduct(index) {
            selectedInvoiceProducts.splice(index, 1);
            renderSelectedInvoiceProducts();
            searchInvoiceProducts();
        }

        function populateInvoiceVendorDropdown() {
            const vendors = [...new Set(inventoryData.map(i => i.vendor).filter(v => v))].sort();
            const select = document.getElementById('invoiceVendorDropdown');
            select.innerHTML = '<option value="">-- Select Vendor --</option>';
            vendors.forEach(v => {
                const opt = document.createElement('option');
                opt.value = v;
                opt.textContent = v;
                select.appendChild(opt);
            });
        }

        async function saveInvoice(event) {
            event.preventDefault();
              // âœ… CHECK INVOICE NUMBER VALIDATION BEFORE SAVING
    const editId = document.getElementById('invoiceForm').dataset.editId;
    if (!editId && !isInvoiceNumberValid) {
        showAlert('âš ï¸ Please fix the invoice number before saving', 'error');
        return;
    }
    
    if (selectedInvoiceProducts.length === 0) {
        showAlert('Please add at least one product to the invoice', 'error');
        return;
    }
            console.log('ðŸ”µ saveInvoice started');
            console.log('ðŸ”µ selectedInvoiceProducts:', selectedInvoiceProducts);
            
            if (selectedInvoiceProducts.length === 0) {
                showAlert('Please add at least one product to the invoice', 'error');
                return;
            }
            
            showLoading(true);
            
            try {
                const editId = document.getElementById('invoiceForm').dataset.editId;
                const vendor = document.getElementById('invoiceVendorDropdown').value;
                const totals = calculateInvoiceTotals();

                console.log('ðŸ”µ Invoice totals:', totals);

                const invoiceData = {
                    vendor: vendor,
                    invoice_number: document.getElementById('invoiceNumber').value,
                    invoice_date: document.getElementById('invoiceDate').value,
                    check_number: document.getElementById('invoiceCheckNumber').value || null,
                    notes: document.getElementById('invoiceNotes').value || null,
                    subtotal: totals.subtotal,
                    tax_rate: totals.taxEnabled ? TAX_RATE : 0,
                    tax_amount: totals.taxAmount,
                    tax_enabled: totals.taxEnabled,
                    total: totals.total,
                    amount: totals.total
                };

                console.log('ðŸ”µ Invoice data to save:', invoiceData);

                let invoiceId = editId;

                if (editId) {
                    console.log('ðŸŸ¡ Updating existing invoice:', editId);
                    const { error } = await supabaseClient.from('invoices').update(invoiceData).eq('id', editId);
                    if (error) throw error;
                    
                    console.log('ðŸŸ¡ Deleting old invoice items for invoice:', editId);
                    await supabaseClient.from('invoice_items').delete().eq('invoice_id', editId);
                    
                    showAlert('âœ… Invoice updated successfully!', 'success');
                } else {
                    console.log('ðŸŸ¢ Creating new invoice');
                    const { data, error } = await supabaseClient.from('invoices').insert([invoiceData]).select();
                    if (error) {
                        console.error('âŒ Error creating invoice:', error);
                        throw error;
                    }
                    invoiceId = data[0].id;
                    console.log('âœ… New invoice created with ID:', invoiceId);
                    showAlert('âœ… Invoice saved successfully!', 'success');
                }

                console.log('ðŸ”´ Preparing to save invoice items...');
                console.log('ðŸ”´ Invoice ID:', invoiceId);
                console.log('ðŸ”´ Number of products to save:', selectedInvoiceProducts.length);
                
                const invoiceItems = selectedInvoiceProducts.map(product => {
                    const hasWeight = product.has_weight && product.weight && product.weight > 0;
                    const lineTotal = hasWeight 
                        ? parseFloat(product.weight) * parseFloat(product.price_per_unit)
                        : parseFloat(product.quantity) * parseFloat(product.invoice_price);
                    
                    return {
                        invoice_id: invoiceId,
                        item_code: product.item_code,
                        product_name: product.product_name,
                        vendor: product.vendor,
                        quantity: hasWeight ? null : parseInt(product.quantity),
                        unit_price: hasWeight ? null : parseFloat(product.invoice_price),
                        weight: hasWeight ? parseFloat(product.weight) : null,
                        price_per_unit: hasWeight ? parseFloat(product.price_per_unit) : null,
                        has_weight: hasWeight,
                        line_total: lineTotal
                    };
                });

                console.log('ðŸ”´ Invoice items array:', invoiceItems);

                const { data: insertedItems, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .insert(invoiceItems)
                    .select();

                if (itemsError) {
                    console.error('âŒ ERROR saving invoice items:', itemsError);
                    throw itemsError;
                }

                console.log('âœ…âœ…âœ… SUCCESS! Invoice items saved:', insertedItems);
console.log('âœ… Number of items saved:', insertedItems?.length || 0);

// âœ… NEW: SYNC PRICES TO PURCHASE_HISTORY TABLE
console.log('ðŸ’¾ Syncing prices to purchase_history table...');
const invoiceDate = document.getElementById('invoiceDate').value;

for (const product of selectedInvoiceProducts) {
    const hasWeight = product.has_weight && product.weight && product.weight > 0;
    
    // Determine the unit price based on pricing mode
    const unitPrice = hasWeight 
        ? parseFloat(product.price_per_unit)  // Weight-based: use price per lb
        : parseFloat(product.invoice_price);   // Regular: use invoice price
    
    // Create purchase_history record
    const purchaseRecord = {
        product_name: product.product_name,
        item_code: product.item_code,
        vendor: vendor,
        unit_price: unitPrice,
        purchase_date: invoiceDate,
        image_path: product.image_path || null,
        assigned_to: null  // Can be set if needed
    };
    
    // Insert into purchase_history
    const { error: historyError } = await supabaseClient
        .from('purchase_history')
        .insert([purchaseRecord]);
    
    if (historyError) {
        console.error('âš ï¸ Error saving to purchase_history:', historyError);
        // Don't throw - main invoice save succeeded
    } else {
        console.log(`âœ… Price history saved: ${product.product_name} @ $${unitPrice.toFixed(2)}`);
    }
}

// Update product names/codes in inventory if changed
for (const product of selectedInvoiceProducts) {
                    const updates = {};
                    let needsUpdate = false;

                    if (product.productNameChanged && product.product_name !== product.originalProductName) {
                        updates.product_name = product.product_name;
                        needsUpdate = true;
                    }

                    if (product.itemCodeChanged && product.item_code !== product.originalItemCode) {
                        updates.item_code = product.item_code;
                        needsUpdate = true;
                    }

                    if (needsUpdate) {
                        console.log(`ðŸ”„ Updating inventory for item code: ${product.originalItemCode}`, updates);
                        const { error } = await supabaseClient
                            .from('purchase_history')
                            .update(updates)
                            .eq('item_code', product.originalItemCode);

                        if (error) {
                            console.error('Error updating products:', error);
                        } else {
                            console.log('âœ… Inventory updated successfully');
                        }
                    }
                }

                selectedInvoiceProducts = [];
                closeModal('invoiceModal');
                await loadInvoices();
                await loadInventoryData();
                populateInvoiceVendorSelect();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
                renderInventoryTable();
                renderQuickEditTable();

            } catch (error) {
                console.error('ðŸ’¥ CRITICAL ERROR in saveInvoice:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function editInvoice(id) {
            showLoading(true);
            try {
                const { data: invoice, error: invoiceError } = await supabaseClient
                    .from('invoices')
                    .select('*')
                    .eq('id', id)
                    .single();
                
                if (invoiceError) throw invoiceError;

                const { data: items, error: itemsError } = await supabaseClient
                    .from('invoice_items')
                    .select('*')
                    .eq('invoice_id', id);
                
                if (itemsError) throw itemsError;

                console.log('Loaded invoice items:', items);

                openModal('invoiceModal');
                populateInvoiceVendorDropdown();
                
                setTimeout(() => {
                    document.getElementById('invoiceModalTitle').textContent = 'Edit Invoice';
                    
                    const vendorDropdown = document.getElementById('invoiceVendorDropdown');
                    const invoiceNumberField = document.getElementById('invoiceNumber');
                    const invoiceDateField = document.getElementById('invoiceDate');
                    const checkNumberField = document.getElementById('invoiceCheckNumber');
                    const notesField = document.getElementById('invoiceNotes');
                    const itemsCountField = document.getElementById('invoiceItemsCount');
                    const taxEnabledField = document.getElementById('invoiceTaxEnabled');
                    
                    if (vendorDropdown) vendorDropdown.value = invoice.vendor || '';
                    if (invoiceNumberField) invoiceNumberField.value = invoice.invoice_number || '';
                    if (invoiceDateField) invoiceDateField.value = invoice.invoice_date || '';
                    if (checkNumberField) checkNumberField.value = invoice.check_number || '';
                    if (notesField) notesField.value = invoice.notes || '';
                    if (taxEnabledField) taxEnabledField.checked = invoice.tax_enabled !== false;
                    
                    document.getElementById('invoiceForm').dataset.editId = id;
                    
                  selectedInvoiceProducts = (items || []).map(item => {
    const hasWeight = item.has_weight || false;
    
    // âœ… CORRECTLY DETERMINE UNIT PRICE BASED ON MODE
    let invoice_price = 0;
    let price_per_unit = null;

    if (hasWeight) {
        // Weight-based: unit price = price_per_unit
        price_per_unit = parseFloat(item.price_per_unit) || 0;
        invoice_price = price_per_unit; // for UI consistency in non-weight fields
    } else {
        // Regular: unit price = unit_price
        invoice_price = parseFloat(item.unit_price) || 0;
        price_per_unit = null;
    }

    return {
        item_code: item.item_code,
        product_name: item.product_name,
        vendor: item.vendor,
        unit_price: item.unit_price || item.price_per_unit || 0, // reference only
        invoice_price: invoice_price,        // âœ… CORRECT UNIT PRICE
        quantity: item.quantity || 1,
        weight: item.weight || null,
        price_per_unit: price_per_unit,     // âœ… CORRECT PER-LB PRICE
        has_weight: hasWeight,              // âœ… MUST BE SET BEFORE RENDER
        image_path: null,
        originalItemCode: item.item_code,
        originalProductName: item.product_name
    };
});

                    console.log('selectedInvoiceProducts:', selectedInvoiceProducts);

                    selectedInvoiceProducts.forEach(product => {
                        const inventoryItem = inventoryData.find(i => i.item_code === product.item_code);
                        if (inventoryItem) {
                            product.image_path = inventoryItem.image_path;
                        }
                    });

                    renderSelectedInvoiceProducts();
                    
                    if (itemsCountField) {
                        itemsCountField.value = `${selectedInvoiceProducts.length} item${selectedInvoiceProducts.length !== 1 ? 's' : ''}`;
                    }
                    
                    document.getElementById('productSearchSection').style.display = 'none';
                    document.getElementById('invoiceProductResults').style.display = 'none';
                }, 100);
                
            } catch (error) {
                console.error('Edit invoice error:', error);
                showAlert('Error loading invoice: ' + error.message, 'error');
                closeModal('invoiceModal');
            } finally {
                showLoading(false);
            }
        }

        async function deleteSingleItem(id) {
            if (!confirm('Delete this item?')) return;
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('purchase_history').delete().eq('id', id);
                if (error) throw error;
                showAlert('Item deleted', 'success');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting item', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteInvoice(id) {
            if (!confirm('Delete this invoice?')) return;
            showLoading(true);
            try {
                await supabaseClient.from('invoice_items').delete().eq('invoice_id', id);
                const { error } = await supabaseClient.from('invoices').delete().eq('id', id);
                if (error) throw error;
                showAlert('Invoice deleted', 'success');
                await loadInvoices();
                filterInvoicesByVendor();
                loadVendorSpendingAnalysis();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Error deleting invoice', 'error');
            } finally {
                showLoading(false);
            }
        }

        function toggleDeleteMode() {
            deleteMode = !deleteMode;
            selectedItems.clear();
            
            const deleteToggleBtn = document.getElementById('deleteToggleBtn');
            const deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
            const checkboxHeader = document.getElementById('checkboxHeader');
            
            if (deleteMode) {
                deleteToggleBtn.innerHTML = '<i class="fas fa-times"></i>';
                deleteSelectedBtn.style.display = 'inline-flex';
                checkboxHeader.style.display = 'table-cell';
            } else {
                deleteToggleBtn.innerHTML = 'ðŸ—‘ï¸';
                deleteSelectedBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
            }
            
            renderInventoryTable();
        }

        function toggleItemSelection(itemId) {
            if (selectedItems.has(itemId)) {
                selectedItems.delete(itemId);
            } else {
                selectedItems.add(itemId);
            }
            renderInventoryTable();
        }

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllCheckbox').checked;
            if (selectAll) {
                filteredData.forEach(item => selectedItems.add(item.id));
            } else {
                selectedItems.clear();
            }
            renderInventoryTable();
        }

        async function deleteSelected() {
            if (selectedItems.size === 0) {
                showAlert('Select items to delete', 'error');
                return;
            }
            
            if (!confirm(`Delete ${selectedItems.size} items?`)) return;
            
            showLoading(true);
            try {
                const { error } = await supabaseClient.from('purchase_history').delete().in('id', Array.from(selectedItems));
                if (error) throw error;
                showAlert('Items deleted', 'success');
                selectedItems.clear();
                deleteMode = false;
                await loadInventory();
            } catch (error) {
                console.error('Delete error:', error);
                showAlert('Delete failed', 'error');
            } finally {
                showLoading(false);
            }
        }

        // ========== BULK ASSIGN MODE ==========
        let bulkAssignMode = false;

        function toggleBulkAssignMode() {
            bulkAssignMode = !bulkAssignMode;
            
            // If turning on bulk assign mode, turn off delete mode
            if (bulkAssignMode && deleteMode) {
                deleteMode = false;
                document.getElementById('deleteToggleBtn').innerHTML = 'ðŸ—‘ï¸';
                document.getElementById('deleteSelectedBtn').style.display = 'none';
            }
            
            selectedItems.clear();
            
            const bulkAssignToggleBtn = document.getElementById('bulkAssignToggleBtn');
            const applyBulkAssignBtn = document.getElementById('applyBulkAssignBtn');
            const checkboxHeader = document.getElementById('checkboxHeader');
            
            if (bulkAssignMode) {
                bulkAssignToggleBtn.innerHTML = '<i class="fas fa-times"></i> Cancel';
                bulkAssignToggleBtn.style.background = 'var(--error-600)';
                applyBulkAssignBtn.style.display = 'inline-flex';
                checkboxHeader.style.display = 'table-cell';
            } else {
                bulkAssignToggleBtn.innerHTML = '<i class="fas fa-user-check"></i> Bulk Assign';
                bulkAssignToggleBtn.style.background = 'var(--primary-600)';
                applyBulkAssignBtn.style.display = 'none';
                checkboxHeader.style.display = 'none';
            }
            
            renderInventoryTable();
        }

        async function applyBulkAssignment() {
            if (selectedItems.size === 0) {
                showAlert('âš ï¸ Please select items to assign', 'warning');
                return;
            }

            // Update count and show modal
            document.getElementById('selectedItemsCount').textContent = selectedItems.size;
            
            // Clear previous selection
            document.querySelectorAll('input[name="assignmentChoice"]').forEach(radio => {
                radio.checked = false;
            });
            
            // Show modal
            openModal('quickAssignModal');
        }

        async function confirmQuickAssignment() {
            const selectedRadio = document.querySelector('input[name="assignmentChoice"]:checked');
            
            if (!selectedRadio) {
                showAlert('âš ï¸ Please select who to assign to', 'warning');
                return;
            }

            const assignTo = selectedRadio.value; // 'rony', 'julio', or 'office'
            const itemCount = selectedItems.size;

            closeModal('quickAssignModal');

            showLoading(true);
            try {
                // Update purchase_history table (this is the main inventory table)
                const { data, error } = await supabaseClient
                    .from('purchase_history')
                    .update({ assigned_to: assignTo })
                    .in('id', Array.from(selectedItems))
                    .select();

                if (error) throw error;

                const updatedCount = data ? data.length : itemCount;

                showAlert(`âœ… Successfully assigned ${updatedCount} items to ${assignTo.toUpperCase()}`, 'success');
                selectedItems.clear();
                bulkAssignMode = false;
                toggleBulkAssignMode(); // Reset UI
                await loadInventoryData();
                renderInventoryTable();
            } catch (error) {
                console.error('Bulk assign error:', error);
                showAlert('âŒ Assignment failed: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function openBulkAssignModal() {
            const productMap = new Map();
            
            inventoryData.forEach(item => {
                if (!item.item_code) return;
                
                if (!productMap.has(item.item_code)) {
                    productMap.set(item.item_code, {
                        code: item.item_code,
                        name: item.product_name || 'Unnamed',
                        count: 0,
                        assignedTo: []
                    });
                }
                
                const entry = productMap.get(item.item_code);
                entry.count++;
                
                let assignedArray = [];
                
                if (item.assigned_to) {
                    if (Array.isArray(item.assigned_to)) {
                        assignedArray = item.assigned_to;
                    } else if (typeof item.assigned_to === 'string') {
                        const trimmed = item.assigned_to.trim();
                        if (trimmed && trimmed !== '[]' && trimmed !== '{}' && trimmed !== 'null') {
                            try {
                                assignedArray = JSON.parse(trimmed);
                            } catch (e) {
                                assignedArray = [];
                            }
                        }
                    }
                }
                
                const validAssignments = assignedArray.filter(person => 
                    person && 
                    typeof person === 'string' && 
                    person.trim() !== '' &&
                    person.trim() !== '[]' &&
                    person.trim() !== '{}'
                );
                
                validAssignments.forEach(person => {
                    if (!entry.assignedTo.includes(person)) {
                        entry.assignedTo.push(person);
                    }
                });
            });

            const allProducts = Array.from(productMap.values()).sort((a, b) => a.name.localeCompare(b.name));
            const unassignedProducts = allProducts.filter(p => p.assignedTo.length === 0);
            const assignedProducts = allProducts.filter(p => p.assignedTo.length > 0);

            let html = '';
            
            if (unassignedProducts.length > 0) {
                html += `
                    <div style="margin-bottom: 1rem;">
                        <h4 style="color: var(--primary-700); margin-bottom: 0.5rem;">
                            ðŸ“‹ Unassigned Products (${unassignedProducts.length})
                        </h4>
                `;
                unassignedProducts.forEach(p => {
                    html += `
                        <label style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; cursor: pointer; background: white; border: 2px solid var(--accent-400); border-radius: 4px; margin-bottom: 0.25rem;">
                            <input type="checkbox" class="product-checkbox" value="${p.code}" style="width: 18px; height: 18px;">
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">${p.count} items</span>
                        </label>
                    `;
                });
                html += `</div>`;
            } else {
                html += `<p style="color: var(--success-600); padding: 1rem; background: rgba(16, 185, 129, 0.1); border-radius: 8px; margin-bottom: 1rem;">âœ… All products are assigned!</p>`;
            }

            if (assignedProducts.length > 0) {
                html += `
                    <details style="margin-top: 1rem; padding: 0.5rem; background: var(--neutral-100); border-radius: 8px;">
                        <summary style="cursor: pointer; font-weight: 600; color: var(--neutral-700);">
                            âœ… Already Assigned Products (${assignedProducts.length})
                        </summary>
                        <div style="margin-top: 0.5rem;">
                `;
                
                assignedProducts.forEach(p => {
                    const assignedList = p.assignedTo
                        .map(person => person.charAt(0).toUpperCase() + person.slice(1))
                        .join(', ');
                    
                    html += `
                        <div style="display: flex; align-items: center; gap: 0.5rem; padding: 0.5rem; background: white; border-radius: 4px; margin-bottom: 0.25rem; color: var(--neutral-600);">
                            <i class="fa-solid fa-check" style="color: var(--success-600);"></i>
                            <span><strong>${p.name}</strong> (${p.code})</span>
                            <span style="margin-left: auto; color: var(--neutral-500); font-size: 0.875rem;">â†’ ${assignedList}</span>
                        </div>
                    `;
                });
                
                html += `</div></details>`;
            }

            document.getElementById('productCheckboxList').innerHTML = html;
            openModal('bulkAssignModal');
        }

        function toggleAllProducts() {
            const selectAll = document.getElementById('selectAllProducts').checked;
            document.querySelectorAll('.product-checkbox').forEach(cb => {
                cb.checked = selectAll;
            });
        }

        async function saveBulkAssignment() {
            const selectedCodes = Array.from(document.querySelectorAll('.product-checkbox:checked')).map(cb => cb.value);
            const person = document.getElementById('bulkAssignTo').value;
            const mode = document.getElementById('assignmentMode').value;

            if (selectedCodes.length === 0) {
                showAlert('Please select at least one product', 'error');
                return;
            }
            if (!person) {
                showAlert('Please select an employee to assign', 'error');
                return;
            }

            if (!confirm(`Assign ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}?`)) return;

            showLoading(true);
            try {
                const itemsToUpdate = inventoryData.filter(item => selectedCodes.includes(item.item_code));
                
                for (const item of itemsToUpdate) {
                    let currentAssigned = [];
                    
                    try {
                        if (Array.isArray(item.assigned_to)) {
                            currentAssigned = item.assigned_to;
                        } else if (typeof item.assigned_to === 'string') {
                            const s = item.assigned_to.trim();
                            if (s && s !== '[]' && s !== '{}' && s !== 'null') {
                                currentAssigned = JSON.parse(s);
                            }
                        }
                    } catch (e) {
                        currentAssigned = [];
                    }
                    
                    let newAssigned;
                    if (mode === 'replace') {
                        newAssigned = [person];
                    } else {
                        if (!currentAssigned.includes(person)) {
                            newAssigned = [...currentAssigned, person];
                        } else {
                            newAssigned = currentAssigned;
                        }
                    }
                    
                    const { error } = await supabaseClient
                        .from('purchase_history')
                        .update({ assigned_to: newAssigned })
                        .eq('id', item.id);
                        
                    if (error) throw error;
                }

                showAlert(`âœ… Successfully assigned ${selectedCodes.length} product(s) to ${person.charAt(0).toUpperCase() + person.slice(1)}!`, 'success');
                closeModal('bulkAssignModal');
                await loadInventoryData();
                renderQuickEditTable();
                applyFilters();

            } catch (error) {
                console.error('Bulk assign error:', error);
                showAlert('Error: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        document.addEventListener('DOMContentLoaded', initializeApp);

// ========== JULIO'S ORDERS FUNCTIONS ==========

// ========== JULIO'S ORDERS FUNCTIONS (FIXED - EMPTY BY DEFAULT) ==========

let julioTargetsMap = new Map();

// ========== FIXED: Julio's Orders with invoice_items data ==========

// ========== FIX 1: STOP TRIMMING PRODUCT NAMES ==========
async function loadJulioOrders() {
    try {
        const dateInput   = document.getElementById('julioOrderDate');
        const selectedDate = dateInput ? dateInput.value : todayYMD();

        if (dateInput && !dateInput.value) {
            dateInput.value = todayYMD();
        }

        // â”€â”€ Products assigned to Julio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, item_code, assigned_to, category')
            .order('product_name');

        if (prodError) throw prodError;

        const uniqueProducts = new Map();
        (products || []).forEach(p => {
            const name     = p.product_name || '';
            const assigned = String(p.assigned_to || '').toLowerCase();
            if (!name || !assigned.includes('julio')) return;

            if (!uniqueProducts.has(name)) {
                uniqueProducts.set(name, {
                    product_name:    name,
                    image_url:       p.image_url,
                    item_code:       p.item_code,
                    category:        p.category || 'Uncategorized',
                    target_quantity: null,   // what Julio submitted as target
                    order_needed:    null    // calculated: target âˆ’ on_hand
                });
            }
        });

        // â”€â”€ Load Julio's submitted targets â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: targets } = await supabaseClient
            .from('target_inventory')
            .select('product_name, target_quantity')
            .eq('order_date', selectedDate);

        (targets || []).forEach(t => {
            const name = t.product_name || '';
            if (uniqueProducts.has(name)) {
                uniqueProducts.get(name).target_quantity = t.target_quantity;
            }
        });

        // â”€â”€ Load inventory_check for this date (has on_hand & target) â”€â”€â”€â”€â”€
        // This gives us the ALREADY CALCULATED needed quantity
        const { data: checkRows } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, target, tentative, user')
            .eq('order_date', selectedDate);

        (checkRows || []).forEach(row => {
            if ((row.user || '').toLowerCase() !== 'julio') return;
            const name = row.product_name || '';
            if (!uniqueProducts.has(name)) return;

            const product   = uniqueProducts.get(name);
            const onHand    = parseFloat(row.on_hand  || 0);
            const target    = parseFloat(row.target   || 0);
            const tentative = parseFloat(row.tentative|| 0);

            // ORDER NEEDED = target âˆ’ on_hand  (never negative)
            const needed = Math.max(0, target - onHand);

            // Auto-fill: use saved tentative if already set, else needed qty
            product.order_needed = needed;
            if (tentative > 0) {
                product.target_quantity = tentative;  // already saved order qty
            } else if (needed > 0) {
                product.target_quantity = needed;     // pre-fill with needed
            }
        });

        // â”€â”€ Vendor / price data (unchanged from original) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id))];
        let invoiceDates = new Map();

        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => {
                invoiceDates.set(inv.id, { date: inv.invoice_date, vendor: inv.vendor });
            });
        }

        uniqueProducts.forEach((product, productName) => {
            const productInvoices = (invoiceItems || []).filter(i => i.product_name === productName);
            const vendors   = new Set();
            const priceData = [];

            productInvoices.forEach(item => {
                const invInfo = invoiceDates.get(item.invoice_id);
                if (!invInfo) return;
                vendors.add(invInfo.vendor);
                const unitPrice = item.has_weight
                    ? parseFloat(item.price_per_unit || 0)
                    : parseFloat(item.unit_price     || 0);
                priceData.push({ vendor: invInfo.vendor, price: unitPrice, date: invInfo.date });
            });

            // Legacy purchase_history
            const legacy = window.inventoryData
                ? window.inventoryData.filter(i => i.product_name === productName)
                : [];
            legacy.forEach(item => {
                if (item.vendor) vendors.add(item.vendor);
                priceData.push({ vendor: item.vendor, price: parseFloat(item.unit_price || 0), date: item.purchase_date });
            });

            product.vendors   = Array.from(vendors);
            product.priceData = priceData;
        });

        julioTargetsMap = uniqueProducts;
        renderJulioProducts();

    } catch (error) {
        console.error('Load Julio orders error:', error);
        showAlert('Error loading Julio orders', 'error');
    }
}


// ========== UPDATED: renderJulioProducts with vendor data ==========

// ========== SIMPLIFIED JULIO CARD - ORDER FOCUSED ==========

// ========== ULTRA-SIMPLIFIED JULIO CARD ==========

function renderJulioProducts() {
  const container = document.getElementById('julioProductGrid');
  const searchTerm = document.getElementById('julioSearchInput')?.value.toLowerCase() || '';

  let products = Array.from(julioTargetsMap.values()).filter(p => {
    if (!searchTerm) return true;
    return (p.product_name || '').toLowerCase().includes(searchTerm);
  });

  // Group by category
  const categorized = new Map();
  products.forEach(p => {
    const category = p.category || 'Uncategorized';
    if (!categorized.has(category)) categorized.set(category, []);
    categorized.get(category).push(p);
  });

  const sortedCategories = Array.from(categorized.keys()).sort();

  document.getElementById('julioProductCount').textContent = `${products.length} products`;

  // âœ… UPDATE PROGRESS BAR
  const totalProducts = products.length;
  const productsSet = products.filter(p => p.target_quantity != null && p.target_quantity > 0).length;
  const progressPct = totalProducts > 0 ? Math.round((productsSet / totalProducts) * 100) : 0;

  const progressBar = document.getElementById('julioProgress');
  const progressPercent = document.getElementById('julioProgressPercent');
  const productsSetEl = document.getElementById('julioProductsSet');
  const totalProductsEl = document.getElementById('julioTotalProducts');

  if (progressBar) progressBar.style.width = progressPct + '%';
  if (progressPercent) progressPercent.textContent = progressPct + '%';
  if (productsSetEl) productsSetEl.textContent = productsSet;
  if (totalProductsEl) totalProductsEl.textContent = totalProducts;

  if (products.length === 0) {
    container.innerHTML = `
      <div class="empty-state">
        <div class="empty-state-icon">ðŸ“¦</div>
        <h3>No Products Found</h3>
      </div>
    `;
    return;
  }

  container.innerHTML = sortedCategories.map(category => {
    const categoryProducts = categorized.get(category);
    categoryProducts.sort((a, b) => (a.product_name || '').localeCompare(b.product_name || ''));

    const categoryColors = {
      'Produce':            { bg: '#dcfce7', border: '#16a34a', text: '#15803d' },
      'Meat & Seafood':     { bg: '#fee2e2', border: '#dc2626', text: '#991b1b' },
      'Dairy':              { bg: '#dbeafe', border: '#2563eb', text: '#1e40af' },
      'Dry Goods':          { bg: '#fef3c7', border: '#f59e0b', text: '#b45309' },
      'Frozen':             { bg: '#e0f2fe', border: '#0ea5e9', text: '#075985' },
      'Beverages':          { bg: '#fce7f3', border: '#ec4899', text: '#be185d' },
      'Cleaning Supplies':  { bg: '#f3e8ff', border: '#a855f7', text: '#7e22ce' },
      'Office Supplies':    { bg: '#ede9fe', border: '#8b5cf6', text: '#6d28d9' },
      'Kitchen Equipment':  { bg: '#fed7aa', border: '#ea580c', text: '#c2410c' },
      'Other':              { bg: '#f1f5f9', border: '#64748b', text: '#475569' }
    };

    const colors = categoryColors[category] || categoryColors['Other'];

    return `
      <div style="margin-bottom: 2rem; grid-column: 1 / -1;">
        <div style="
          background: linear-gradient(135deg, ${colors.bg}, white);
          padding: 1rem 1.5rem;
          border-radius: 12px;
          border-left: 6px solid ${colors.border};
          margin-bottom: 1rem;
          box-shadow: var(--shadow-sm);
        ">
          <div style="display: flex; justify-content: space-between; align-items: center;">
            <h3 style="font-size: 1.25rem; font-weight: 700; color: ${colors.text}; margin: 0; display: flex; align-items: center; gap: 0.75rem;">
              ${getCategoryIcon(category)} ${category}
            </h3>
            <span style="background: ${colors.border}; color: white; padding: 0.375rem 1rem; border-radius: 50px; font-size: 0.875rem; font-weight: 700; font-family: var(--font-mono);">
              ${categoryProducts.length}
            </span>
          </div>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.75rem;">
          ${categoryProducts.map(product => renderJulioProductCard(product, colors)).join('')}
        </div>
      </div>
    `;
  }).join('');
}


// âœ… NEW: Get icon for category
function getCategoryIcon(category) {
  const icons = {
    'Produce': 'ðŸ¥¬',
    'Meat & Seafood': 'ðŸ¥©',
    'Dairy': 'ðŸ¥›',
    'Dry Goods': 'ðŸŒ¾',
    'Frozen': 'â„ï¸',
    'Beverages': 'ðŸ¥¤',
    'Cleaning Supplies': 'ðŸ§¹',
    'Office Supplies': 'ðŸ“Ž',
    'Kitchen Equipment': 'ðŸ³',
    'Other': 'ðŸ“¦'
  };
  return icons[category] || 'ðŸ“¦';
}

// âœ… NEW: Separate product card function
function renderJulioProductCard(product, categoryColors) {
    const imageUrl  = resolveImage(product.image_url);
    const orderQty  = product.target_quantity || 0;
    const hasQty    = orderQty > 0;
    const needLabel = (product.order_needed > 0)
        ? `<div style="font-size:0.7rem;color:var(--warning-600);font-weight:700;margin-top:0.35rem;">
               ðŸ“¦ Calculated need: ${parseFloat(product.order_needed).toFixed(1)}
           </div>`
        : '';

    const submittedStyle = hasQty
        ? `border: 3px solid var(--success-600); box-shadow: 0 0 0 2px rgba(16,185,129,0.2);`
        : `border: 2px solid ${categoryColors.border};`;

    const submittedBadge = hasQty
        ? `<div style="position:absolute;top:8px;right:8px;background:var(--success-600);color:white;
                       border-radius:50%;width:28px;height:28px;display:flex;align-items:center;
                       justify-content:center;font-size:1rem;box-shadow:var(--shadow-md);">âœ“</div>`
        : '';

    return `
    <div class="julio-corporate-card" style="
        background:white;border-radius:12px;overflow:hidden;
        box-shadow:0 2px 8px rgba(0,0,0,0.08);
        ${submittedStyle}
        transition:all 0.3s;display:flex;flex-direction:column;position:relative;">

        ${submittedBadge}

        <!-- PRODUCT INFO -->
        <div style="
            background:${hasQty ? 'linear-gradient(135deg,rgba(16,185,129,0.08),white)' : 'linear-gradient(135deg,var(--neutral-50),white)'};
            padding:1.5rem;
            border-bottom:2px solid ${hasQty ? 'var(--success-300)' : categoryColors.border};
            text-align:center;">
            <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
                 style="width:120px;height:120px;object-fit:contain;border-radius:8px;
                        margin:0 auto 1rem auto;display:block;background:white;
                        padding:0.5rem;border:1px solid var(--neutral-300);">
            <h3 style="font-size:1.125rem;font-weight:700;color:var(--neutral-900);margin:0;
                       line-height:1.3;min-height:2.6rem;display:flex;align-items:center;justify-content:center;">
                ${product.product_name}
            </h3>
        </div>

        <!-- ORDER QUANTITY -->
        <div style="
            padding:1.5rem;
            background:${hasQty ? 'rgba(16,185,129,0.08)' : categoryColors.bg};
            flex-grow:1;display:flex;flex-direction:column;justify-content:center;
            border-bottom:3px solid ${hasQty ? 'var(--success-600)' : categoryColors.border};">

            <label style="
                display:block;font-size:0.8125rem;font-weight:700;
                color:${hasQty ? 'var(--success-700)' : categoryColors.text};
                text-transform:uppercase;letter-spacing:0.05em;
                margin-bottom:0.75rem;text-align:center;">
                ${hasQty ? 'âœ… Order Quantity (Saved)' : 'ðŸ›’ Order Quantity'}
            </label>

            <input type="number"
                   id="qty-${product.product_name.replace(/[^a-zA-Z0-9]/g, '_')}"
                   value="${orderQty > 0 ? orderQty : ''}"
                   min="0" step="0.1" placeholder="0.00"
                   data-product-name="${escAttr(product.product_name)}"
                   onchange="setJulioQuantity(this.dataset.productName, this.value)"
                   class="search-input"
                   style="width:100%;font-size:1.5rem;font-weight:700;text-align:center;
                          padding:0.875rem;font-family:var(--font-mono);background:white;
                          border:3px solid ${hasQty ? 'var(--success-600)' : categoryColors.border};
                          box-shadow:0 2px 4px rgba(0,0,0,0.1);">

            ${needLabel}
        </div>

        <!-- FOOTER -->
        <div style="padding:1rem;background:white;border-top:2px solid var(--neutral-200);">
            <button data-product="${escAttr(product.product_name)}"
                    onclick="deleteProductFromJulio(this.dataset.product)"
                    class="btn btn-danger"
                    style="width:100%;padding:0.875rem;font-size:0.9375rem;">
                <i class="fas fa-trash"></i> Remove Product
            </button>
        </div>
    </div>`;
}




function updateJulioQuantity(productName, delta) {
    if (!julioTargetsMap.has(productName)) return;
    
    const product = julioTargetsMap.get(productName);
    const currentQty = product.target_quantity || 0;
    const newQty = Math.max(0, currentQty + delta);
    
    product.target_quantity = newQty === 0 ? null : newQty; // âœ… Set to null if 0
    
    const input = document.getElementById(`julio-qty-${productName.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (input) input.value = newQty === 0 ? '' : newQty; // âœ… Show empty if 0
    
    renderJulioProducts();
}

function setJulioQuantity(productName, value) {
    if (!julioTargetsMap.has(productName)) return;
    
    const qty = value === '' ? null : (parseInt(value) || 0);
    const product = julioTargetsMap.get(productName);
    product.target_quantity = (qty === 0) ? null : qty; // âœ… Set to null if 0
    
    renderJulioProducts();
}

function filterJulioProducts() {
    renderJulioProducts();
}

async function saveJulioOrders() {
    showLoading(true);
    try {
        const submissionDate = new Date().toISOString();
        const orderDate = document.getElementById('julioOrderDate')?.value || todayYMD();
        
        const targets = Array.from(julioTargetsMap.values())
            .filter(p => p.target_quantity != null && p.target_quantity > 0)
            .map(p => ({
                product_name: p.product_name,
                target_quantity: p.target_quantity,
                order_date: orderDate,
                last_updated: submissionDate
            }));
        
        if (targets.length === 0) {
            showAlert('No target quantities set', 'error');
            return;
        }
        
     // UPSERT - insert or update if already exists
const { error: targetError } = await supabaseClient
    .from('target_inventory')
    .upsert(targets, { 
        onConflict: 'product_name,order_date',
        ignoreDuplicates: false 
    });

if (targetError) throw targetError;
        
        // Save to historical submissions table
        const submissions = targets.map(t => ({
            submission_date: submissionDate,
            submitted_by: 'julio',
            product_name: t.product_name,
            quantity: t.target_quantity,
            submission_type: 'target_inventory',
            notes: `Target inventory for ${orderDate}`
        }));
        
        const { error: historyError } = await supabaseClient
            .from('inventory_submissions')
            .insert(submissions);
        
        if (historyError) {
            console.error('Error saving submission history:', historyError);
        }
        
        // âœ… NEW: Send email notification to admin
        const emailItems = targets.map(t => ({
            product_name: t.product_name,
            quantity: t.target_quantity,
            notes: `Target: ${t.target_quantity}`
        }));

        const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-order-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
                submittedBy: 'julio',
                orderDate: orderDate,
                items: emailItems
            })
        });

        const emailResult = await emailResponse.json();
        
        if (emailResult.success) {
            showAlert(`âœ… Saved ${targets.length} target inventory levels for ${orderDate}! ðŸ“§ Admin notified via email.`, 'success');
        } else {
            showAlert(`âœ… Saved ${targets.length} targets, but email notification failed: ${emailResult.error}`, 'warning');
        }
        
    } catch (error) {
        console.error('Save Julio targets error:', error);
        showAlert('Error saving targets: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


async function clearJulioOrders() {
    if (!confirm('Clear all target quantities?')) return;
    
    julioTargetsMap.forEach(product => {
        product.target_quantity = null;
    });
    
    renderJulioProducts();
    showAlert('All targets cleared', 'success');
}

// ========== RONY TAB â€” EDITABLE STOCK INPUT ==========
let ronyProductsByPosition = new Map();

async function loadRonyOrders() {
    try {
        // Get selected date or use today
        const dateInput = document.getElementById('ronyOrderDate');
        const selectedDate = dateInput ? dateInput.value : todayYMD();
        
        // Set default date if not set
        if (dateInput && !dateInput.value) {
            dateInput.value = todayYMD();
        }
        
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, position, assigned_to')
            .order('position', { ascending: true });
        
        if (prodError) throw prodError;
        
        const uniqueProducts = new Map();
        (products || []).forEach(p => {
            const name = (p.product_name || '').trim();
            const assigned = String(p.assigned_to || '').toLowerCase();
            if (!name || !assigned.includes('rony')) return;
            
            if (!uniqueProducts.has(name)) {
                uniqueProducts.set(name, {
                    product_name: name,
                    image_url: p.image_url,
                    position: p.position,
                    current_stock: null
                });
            }
        });
        
        // âœ… Load stock levels for the selected date
        const { data: stock, error: stockError } = await supabaseClient
            .from('current_stock')
            .select('*')
            .eq('stock_date', selectedDate);
        
        if (!stockError && stock) {
            stock.forEach(s => {
                const name = (s.product_name || '').trim();
                if (uniqueProducts.has(name)) {
                    uniqueProducts.get(name).current_stock = s.quantity_in_stock;
                }
            });
        }
        
        // Group by position
        ronyProductsByPosition.clear();
        uniqueProducts.forEach(product => {
            const pos = product.position || 'Uncategorized';
            if (!ronyProductsByPosition.has(pos)) {
                ronyProductsByPosition.set(pos, []);
            }
            ronyProductsByPosition.get(pos).push(product);
        });
        
        renderRonyProducts();
        
    } catch (error) {
        console.error('Load Rony stock error:', error);
        showAlert('Error loading Rony stock', 'error');
    }
}



function renderRonyProducts() {
    const container = document.getElementById('ronyProductContainer');
    const searchTerm = document.getElementById('ronySearchInput')?.value.toLowerCase() || '';

    const positions = Array.from(ronyProductsByPosition.keys()).sort((a, b) => {
        const numA = parseInt(a);
        const numB = parseInt(b);
        if (!isNaN(numA) && !isNaN(numB)) return numA - numB;
        return String(a).localeCompare(String(b));
    });

    // âœ… UPDATE GLOBAL PROGRESS BAR
    let totalAll = 0, hasStockAll = 0;
    ronyProductsByPosition.forEach(products => {
        totalAll += products.length;
        hasStockAll += products.filter(p => p.current_stock != null && p.current_stock > 0).length;
    });
    const globalPct = totalAll > 0 ? Math.round((hasStockAll / totalAll) * 100) : 0;
    const globalBar = document.getElementById('ronyGlobalProgress');
    const globalLabel = document.getElementById('ronyGlobalLabel');
    if (globalBar) globalBar.style.width = globalPct + '%';
    if (globalLabel) globalLabel.textContent = `${globalPct}% (${hasStockAll}/${totalAll})`;

    container.innerHTML = positions.map(position => {
        let products = ronyProductsByPosition.get(position);

        if (searchTerm) {
            products = products.filter(p =>
                (p.product_name || '').toLowerCase().includes(searchTerm)
            );
        }

        if (products.length === 0) return '';

        const total = products.length;
        const hasStock = products.filter(p => p.current_stock != null && p.current_stock > 0).length;
        const progressPct = total > 0 ? Math.round((hasStock / total) * 100) : 0;

        return `
            <div style="background: white; border-radius: 12px; padding: 1.5rem; box-shadow: var(--shadow-md); margin-bottom: 2rem;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; padding-bottom: 1rem; border-bottom: 2px solid var(--neutral-200); flex-wrap: wrap; gap: 1rem;">
                    <h2 style="font-size: 1.25rem; font-weight: 700; color: var(--neutral-900);">
                        ðŸ“ Position ${position}
                        <span style="font-size: 0.875rem; font-weight: 500; color: ${hasStock === total ? 'var(--success-600)' : 'var(--neutral-500)'}; margin-left: 0.75rem;">
                            ${hasStock === total ? 'âœ… All entered' : `${hasStock}/${total} entered`}
                        </span>
                    </h2>
                    <div style="flex: 0 0 200px; min-width: 150px;">
                        <div style="height: 8px; background: var(--neutral-200); border-radius: 999px; overflow: hidden; margin-bottom: 0.5rem;">
                            <div style="height: 100%; width: ${progressPct}%; background: ${progressPct === 100 ? 'var(--success-600)' : 'var(--primary-600)'}; transition: width 0.3s;"></div>
                        </div>
                        <div style="font-size: 0.75rem; color: var(--neutral-600); text-align: right;">
                            ${hasStock}/${total} have stock entered
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 1rem;">
                    ${products.map(product => renderRonyProductCard(product)).join('')}
                </div>
            </div>
        `;
    }).join('');
}



// âœ… FIXED: renderRonyProductCard function
// âœ… UPDATED: renderRonyProductCard with DELETE button
function renderRonyProductCard(product) {
    const imageUrl = resolveImage(product.image_url);
    const hasStock = product.current_stock != null && product.current_stock > 0;
    const displayQty = hasStock ? product.current_stock : '';

    return `
        <div style="
            background: ${hasStock ? 'rgba(16,185,129,0.05)' : 'var(--neutral-50)'};
            border-radius: 12px;
            padding: 1rem;
            text-align: center;
            border: 2px solid ${hasStock ? 'var(--success-600)' : 'var(--neutral-300)'};
            transition: all 0.3s;
            position: relative;
        ">
            <!-- DELETE BUTTON -->
            <button data-product="${escAttr(product.product_name)}"
                    onclick="deleteProductFromRony(this.dataset.product)"
                    class="btn btn-danger btn-icon"
                    style="position: absolute; top: 8px; right: 8px; width: 30px; height: 30px; padding: 0; font-size: 0.75rem;"
                    title="Delete Product">
                <i class="fas fa-trash"></i>
            </button>

            <!-- âœ… SAVED BADGE -->
            ${hasStock ? `<div style="position:absolute;top:8px;left:8px;background:var(--success-600);color:white;border-radius:50%;width:22px;height:22px;display:flex;align-items:center;justify-content:center;font-size:0.75rem;">âœ“</div>` : ''}

            <img src="${imageUrl}"
                 onerror="this.src='${PLACEHOLDER_IMAGE}'"
                 style="width: 100%; max-width: 100px; height: 100px; object-fit: contain; border-radius: 8px; margin-bottom: 0.75rem;">

            <div style="font-weight: 700; font-size: 0.9rem; margin-bottom: 0.75rem; color: var(--neutral-900); min-height: 2.5rem; display: flex; align-items: center; justify-content: center; word-wrap: break-word;">
                ${product.product_name}
            </div>

            <div style="margin-bottom: 0.5rem;">
                <label style="display: block; font-size: 0.7rem; font-weight: 600; color: ${hasStock ? 'var(--success-700)' : 'var(--neutral-600)'}; margin-bottom: 0.25rem;">
                    ${hasStock ? 'âœ… STOCK (SAVED)' : 'CURRENT STOCK'}
                </label>
            </div>

            <div style="display: flex; justify-content: center; gap: 0.5rem; align-items: center;">
                <button onclick="updateRonyStock('${escAttr(product.product_name)}', -0.1)"
                        class="btn btn-secondary"
                        style="width: 36px; height: 36px; padding: 0; font-size: 1rem; font-weight: 700;">
                    âˆ’
                </button>

                <input type="number"
                       id="rony-stock-${product.product_name.replace(/[^a-zA-Z0-9]/g, '_')}"
                       value="${displayQty}"
                       min="0"
                       step="0.1"
                       placeholder=""
                       onchange="setRonyStock('${escAttr(product.product_name)}', this.value)"
                       style="width: 65px; text-align: center; padding: 0.4rem; border: 2px solid ${hasStock ? 'var(--success-600)' : 'var(--primary-400)'}; border-radius: 6px; font-size: 1rem; font-weight: 700; font-family: var(--font-mono); background: ${hasStock ? 'rgba(16,185,129,0.05)' : 'white'};">

                <button onclick="updateRonyStock('${escAttr(product.product_name)}', 0.1)"
                        class="btn btn-primary"
                        style="width: 36px; height: 36px; padding: 0; font-size: 1rem; font-weight: 700;">
                    +
                </button>
            </div>
        </div>
    `;
}

function updateRonyStock(productName, delta) {
    let allProducts = [];
    ronyProductsByPosition.forEach(products => {
        allProducts = allProducts.concat(products);
    });
    
    const product = allProducts.find(p => p.product_name === productName);
    if (!product) return;
    
    const currentStock = product.current_stock || 0;
    const newStock = Math.max(0, currentStock + delta);
    
    product.current_stock = newStock === 0 ? null : parseFloat(newStock.toFixed(2));
    
    const input = document.getElementById(`rony-stock-${productName.replace(/[^a-zA-Z0-9]/g, '_')}`);
    if (input) input.value = newStock === 0 ? '' : newStock.toFixed(2);
    
    renderRonyProducts();
}

function setRonyStock(productName, value) {
    let allProducts = [];
    ronyProductsByPosition.forEach(products => {
        allProducts = allProducts.concat(products);
    });
    
    const product = allProducts.find(p => p.product_name === productName);
    if (!product) return;
    
    const qty = value === '' ? null : (parseFloat(value) || 0);
    product.current_stock = (qty === 0) ? null : qty;
    
    renderRonyProducts();
}

function filterRonyProducts() {
    renderRonyProducts();
}


// âœ… SAVE RONY STOCK (NOW EDITABLE)
async function saveRonyOrders() {
    showLoading(true);
    try {
        const submissionDate = new Date().toISOString();
        const stockDate = document.getElementById('ronyOrderDate')?.value || todayYMD();
        
        let allProducts = [];
        ronyProductsByPosition.forEach(products => {
            allProducts = allProducts.concat(products);
        });
        
        const stockUpdates = allProducts
            .filter(p => p.current_stock != null && p.current_stock >= 0)
            .map(p => ({
                product_name: p.product_name,
                quantity_in_stock: p.current_stock,
                stock_date: stockDate,
                last_updated: submissionDate
            }));
        
        if (stockUpdates.length === 0) {
            showAlert('âŒ No stock quantities entered', 'error');
            return;
        }
        
      // UPSERT - insert or update if already exists
const { error: stockError } = await supabaseClient
    .from('current_stock')
    .upsert(stockUpdates, { 
        onConflict: 'product_name,stock_date',
        ignoreDuplicates: false 
    });

if (stockError) throw stockError;
        
        // Save to historical submissions table
        const submissions = stockUpdates.map(s => ({
            submission_date: submissionDate,
            submitted_by: 'rony',
            product_name: s.product_name,
            quantity: s.quantity_in_stock,
            submission_type: 'current_stock',
            notes: `Stock count for ${stockDate}`
        }));
        
        const { error: historyError } = await supabaseClient
            .from('inventory_submissions')
            .insert(submissions);
        
        if (historyError) {
            console.error('Error saving submission history:', historyError);
        }
        
        // âœ… NEW: Send email notification to admin
        const emailItems = stockUpdates.map(s => ({
            product_name: s.product_name,
            quantity: s.quantity_in_stock,
            notes: `Current stock`
        }));

        const emailResponse = await fetch(`${SUPABASE_URL}/functions/v1/send-order-notification`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
            },
            body: JSON.stringify({
                submittedBy: 'rony',
                orderDate: stockDate,
                items: emailItems
            })
        });

        const emailResult = await emailResponse.json();
        
        if (emailResult.success) {
            showAlert(`âœ… Saved ${stockUpdates.length} stock levels for ${stockDate}! ðŸ“§ Admin notified via email.`, 'success');
        } else {
            showAlert(`âœ… Saved ${stockUpdates.length} stock levels, but email notification failed: ${emailResult.error}`, 'warning');
        }
        
    } catch (error) {
        console.error('Save Rony stock error:', error);
        showAlert('Error saving stock: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

async function clearRonyOrders() {
    if (!confirm('Clear all stock levels?')) return;
    
    ronyProductsByPosition.forEach(products => {
        products.forEach(p => {
            p.current_stock = null;
        });
    });
    
    renderRonyProducts();
    showAlert('All stock levels cleared', 'success');
}


// ========== ENHANCED PLACE ORDER FUNCTIONS ==========

let enhancedOrderData = new Map();

// Load enhanced create order with full vendor comparison
// ========== FIXED LOAD ENHANCED CREATE ORDER FUNCTION ==========


// ADD THIS NEW FUNCTION (copy from COMPLETE_FIXED_PLACE_ORDER.js)
// ========== COMPLETE FIXED PLACE ORDER CODE ==========
// Replace the entire Place Order section with this code

// ========== RENDER EMPTY STATE ==========
function renderEmptyOrderState(dateISO) {
    const container = document.getElementById('enhancedOrderContainer');
    
    container.innerHTML = `
        <div style="text-align: center; padding: 4rem 2rem; background: white; border-radius: 16px; box-shadow: var(--shadow-lg); margin: 2rem auto; max-width: 800px;">
            <div style="font-size: 5rem; margin-bottom: 1.5rem; opacity: 0.3;">ðŸ“¦</div>
            <h2 style="font-size: 1.75rem; font-weight: 700; color: var(--neutral-900); margin-bottom: 1rem;">
                No Inventory Data for ${formatDate(dateISO)}
            </h2>
            <p style="font-size: 1.125rem; color: var(--neutral-600); margin-bottom: 2rem; line-height: 1.6;">
                Julio and Rony need to submit their inventory counts first before you can create orders.
            </p>
            
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem; max-width: 600px; margin: 0 auto;">
                <div style="background: var(--accent-50); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--accent-300);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ“¦</div>
                    <div style="font-weight: 700; font-size: 1.125rem; color: var(--neutral-900); margin-bottom: 0.5rem;">
                        Julio's Target Inventory
                    </div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600);">
                        Go to "ðŸ›’ Julio's Orders" tab to submit target quantities
                    </div>
                </div>
                
                <div style="background: var(--primary-50); padding: 1.5rem; border-radius: 12px; border: 2px solid var(--primary-300);">
                    <div style="font-size: 2rem; margin-bottom: 0.5rem;">ðŸ³</div>
                    <div style="font-weight: 700; font-size: 1.125rem; color: var(--neutral-900); margin-bottom: 0.5rem;">
                        Rony's Stock Count
                    </div>
                    <div style="font-size: 0.875rem; color: var(--neutral-600);">
                        Go to "ðŸ³ Rony's Orders" tab to submit current stock
                    </div>
                </div>
            </div>
            
            <div style="margin-top: 2rem; padding: 1.5rem; background: var(--neutral-50); border-radius: 12px; border: 2px solid var(--neutral-300);">
                <div style="font-weight: 700; color: var(--neutral-700); margin-bottom: 0.5rem;">
                    ðŸ’¡ How it works:
                </div>
                <ol style="text-align: left; color: var(--neutral-600); line-height: 1.8; padding-left: 1.5rem; max-width: 500px; margin: 0 auto;">
                    <li>Julio submits target quantities</li>
                    <li>Rony submits current stock counts</li>
                    <li>System calculates what needs to be ordered</li>
                    <li>Place Order tab shows recommendations with vendor prices</li>
                </ol>
            </div>
        </div>
    `;
}

// ========== LOAD ENHANCED CREATE ORDER (COMPLETE VERSION) ==========
// ========== FIXED: Load Enhanced Create Order WITH IMAGES ==========
// ========== COMPLETE ENHANCED loadEnhancedCreateOrder ==========
async function loadEnhancedCreateOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    
    showLoading(true);
    try {
        // âœ… STEP 1: Load supporting data FIRST (conversions, last orders)
        await loadSupportingData();
        
        // âœ… STEP 2: Load inventory_check data
        const { data: inventoryData, error: checkError } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO)
            .order('product_name');
        
        if (checkError) throw checkError;
        
        if (!inventoryData || inventoryData.length === 0) {
            renderEmptyOrderState(dateISO);
            return;
        }
        
        // âœ… STEP 3: Load inventory_management data for images and PAR
        const { data: mgmtData, error: mgmtError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, par, position');
        
        if (mgmtError) throw mgmtError;
        
        // âœ… STEP 4: Create lookup map
        const imageMap = new Map();
        (mgmtData || []).forEach(item => {
            imageMap.set(item.product_name, {
                image_url: item.image_url,
                par: item.par,
                position: item.position
            });
        });
        
        // âœ… STEP 5: Merge data
        const enrichedData = inventoryData.map(row => {
            const mgmt = imageMap.get(row.product_name);
            return {
                ...row,
                image_url: mgmt?.image_url || null,
                par: mgmt?.par || 0,
                position: mgmt?.position || null
            };
        });
        
        // âœ… STEP 6: Separate by user
        const ronyData = enrichedData.filter(row => 
            (row.user || '').toLowerCase().trim() === 'rony'
        );
        
        const julioData = enrichedData.filter(row => 
            (row.user || '').toLowerCase().trim() === 'julio'
        );
        
const officeData = enrichedData.filter(row => 
    (row.user || '').toLowerCase().trim() === 'office'
);


        console.log('âœ… Loaded with images:', enrichedData.length);
        console.log('ðŸ–¼ï¸ Sample image_url:', enrichedData[0]?.image_url);
        console.log('ðŸ“Š Sample PAR:', enrichedData[0]?.par);
        
        // âœ… STEP 7: Render cards
        renderEnhancedOrderCards(ronyData, julioData, officeData);
        
        // âœ… STEP 8: Load vendor prices for each product (after DOM renders)
        setTimeout(() => {
            enrichedData.forEach(row => {
                const productId = (row.product_name || '').replace(/[^a-zA-Z0-9]/g, '_');
                loadVendorPricesForProduct(row.product_name, productId);
            });
        }, 500);
        
    } catch (error) {
        console.error('âŒ Load order error:', error);
        showAlert('Error loading order data: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}



// ========== FIXED VERSION: ALWAYS SHOWS BOTH RONY AND JULIO SECTIONS ==========
// Find this function in your code and REPLACE it with this version

// ========== COMPLETE FIXED renderEnhancedOrderCards FUNCTION ==========
// ========== FIXED: renderEnhancedOrderCards FUNCTION ==========
function renderEnhancedOrderCards(ronyData, julioData, officeData = []) {
    const container = document.getElementById('enhancedOrderContainer');
    let html = '';
    
    // âœ… FIXED: Don't redeclare officeData - it's already a parameter
    // Just ensure ronyData doesn't have any office items that slipped through
    ronyData = ronyData.filter(row => 
        (row.user || '').toLowerCase().trim() === 'rony'
    );
    
    // ðŸ³ RONY'S SECTION - BLUE BACKGROUND (ALWAYS SHOWS)
    html += `
        <div style="margin-bottom: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(44, 86, 136, 0.08), rgba(44, 86, 136, 0.03)); border-radius: 20px; border: 3px solid var(--primary-400); box-shadow: 0 8px 16px rgba(44, 86, 136, 0.15);">
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, var(--primary-700), var(--primary-600)); padding: 1.5rem 2rem; border-radius: 15px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
                <h2 style="font-size: 2rem; font-weight: 800; color: white; margin: 0; display: flex; align-items: center; gap: 15px;">
                    ðŸ³ RONY'S PRODUCTS
                    <span style="background: white; color: var(--primary-700); padding: 0.5rem 1.5rem; border-radius: 50px; font-size: 1.5rem; font-family: var(--font-mono);">
                        ${ronyData.length}
                    </span>
                </h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin: 0.5rem 0 0 0; font-size: 1rem;">
                    Current stock counts and ordering recommendations
                </p>
            </div>
            
            <!-- PRODUCTS GRID OR EMPTY STATE -->
            ${ronyData.length > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 2rem;">
                    ${ronyData.map(row => renderEnhancedCard(row, 'rony')).join('')}
                </div>
            ` : `
                <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; border: 2px dashed var(--neutral-300);">
                    <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">ðŸ³</div>
                    <h3 style="color: var(--neutral-600);">No products from Rony for this date</h3>
                    <p style="color: var(--neutral-500);">Rony needs to submit stock counts first</p>
                </div>
            `}
        </div>
    `;
    
    // â­â­â­ BIG VISUAL SEPARATOR â­â­â­
    html += `
        <div style="height: 4rem; display: flex; align-items: center; justify-content: center; position: relative; margin: 3rem 0;">
            <div style="position: absolute; width: 100%; height: 3px; background: linear-gradient(90deg, var(--primary-400), var(--accent-400));"></div>
            <div style="background: white; padding: 1rem 2rem; border-radius: 50px; border: 3px solid var(--neutral-300); box-shadow: var(--shadow-xl); position: relative; z-index: 10;">
                <span style="font-size: 1.5rem; font-weight: 800; color: var(--neutral-700);">â¬‡ï¸ SEPARATOR â¬‡ï¸</span>
            </div>
        </div>
    `;
    
    // ðŸ“¦ JULIO'S SECTION - ORANGE BACKGROUND (ALWAYS SHOWS)
    html += `
        <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(217, 119, 6, 0.08), rgba(217, 119, 6, 0.03)); border-radius: 20px; border: 3px solid var(--accent-400); box-shadow: 0 8px 16px rgba(217, 119, 6, 0.15);">
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, var(--accent-600), var(--accent-500)); padding: 1.5rem 2rem; border-radius: 15px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
                <h2 style="font-size: 2rem; font-weight: 800; color: white; margin: 0; display: flex; align-items: center; gap: 15px;">
                    ðŸ“¦ JULIO'S PRODUCTS
                    <span style="background: white; color: var(--accent-700); padding: 0.5rem 1.5rem; border-radius: 50px; font-size: 1.5rem; font-family: var(--font-mono);">
                        ${julioData.length}
                    </span>
                </h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin: 0.5rem 0 0 0; font-size: 1rem;">
                    Target inventory levels and ordering recommendations
                </p>
            </div>
            
            <!-- PRODUCTS GRID OR EMPTY STATE -->
            ${julioData.length > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 2rem;">
                    ${julioData.map(row => renderEnhancedCard(row, 'julio')).join('')}
                </div>
            ` : `
                <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; border: 2px dashed var(--neutral-300);">
                    <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">ðŸ“¦</div>
                    <h3 style="color: var(--neutral-600);">No products from Julio for this date</h3>
                    <p style="color: var(--neutral-500);">Julio needs to submit target inventory first</p>
                </div>
            `}
        </div>
    `;
    
    // â­ SEPARATOR BEFORE OFFICE â­
    html += `
        <div style="height: 4rem; display: flex; align-items: center; justify-content: center; position: relative; margin: 3rem 0;">
            <div style="position: absolute; width: 100%; height: 3px; background: linear-gradient(90deg, var(--accent-400), var(--success-400));"></div>
            <div style="background: white; padding: 1rem 2rem; border-radius: 50px; border: 3px solid var(--neutral-300); box-shadow: var(--shadow-xl); position: relative; z-index: 10;">
                <span style="font-size: 1.5rem; font-weight: 800; color: var(--neutral-700);">â¬‡ï¸ SEPARATOR â¬‡ï¸</span>
            </div>
        </div>
    `;
    
    // ðŸ¢ OFFICE SECTION - GREEN BACKGROUND
    html += `
        <div style="margin-top: 3rem; padding: 2rem; background: linear-gradient(135deg, rgba(5, 150, 105, 0.08), rgba(5, 150, 105, 0.03)); border-radius: 20px; border: 3px solid var(--success-400); box-shadow: 0 8px 16px rgba(5, 150, 105, 0.15);">
            <!-- HEADER -->
            <div style="background: linear-gradient(135deg, var(--success-600), var(--success-500)); padding: 1.5rem 2rem; border-radius: 15px; margin-bottom: 2rem; box-shadow: var(--shadow-lg);">
                <h2 style="font-size: 2rem; font-weight: 800; color: white; margin: 0; display: flex; align-items: center; gap: 15px;">
                    ðŸ¢ OFFICE PRODUCTS
                    <span style="background: white; color: var(--success-700); padding: 0.5rem 1.5rem; border-radius: 50px; font-size: 1.5rem; font-family: var(--font-mono);">
                        ${officeData.length}
                    </span>
                </h2>
                <p style="color: rgba(255, 255, 255, 0.9); margin: 0.5rem 0 0 0; font-size: 1rem;">
                    Office supplies and general inventory
                </p>
            </div>
            
            <!-- PRODUCTS GRID OR EMPTY STATE -->
            ${officeData.length > 0 ? `
                <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(400px, 1fr)); gap: 2rem;">
                    ${officeData.map(row => renderEnhancedCard(row, 'office')).join('')}
                </div>
            ` : `
                <div style="text-align: center; padding: 3rem; background: white; border-radius: 12px; border: 2px dashed var(--neutral-300);">
                    <div style="font-size: 3rem; opacity: 0.3; margin-bottom: 1rem;">ðŸ¢</div>
                    <h3 style="color: var(--neutral-600);">No office products for this date</h3>
                    <p style="color: var(--neutral-500);">Office supplies will appear here when submitted</p>
                </div>
            `}
        </div>
    `;
    
    // âœ… SET THE HTML
    container.innerHTML = html;
}

// ========== NEW MANAGEMENT FUNCTIONS ==========
// ========== CORPORATE REDESIGNED PLACE ORDER CARD ==========
function renderEnhancedCard(row, userType) {
    const imageUrl = resolveImage(row.image_url);
    const productName = row.product_name || 'Unknown Product';
    const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');

    const escapedProductName = escAttr(productName);
    const escapedItemId = String(row.id).replace(/'/g, "\\'").replace(/"/g, '\\"');

    // Raw values
    const onHandRaw = parseFloat(row.on_hand || 0);
    const parRaw    = parseFloat(row.par || 0);
    const targetRaw = (userType === 'rony') ? parRaw : parseFloat(row.target || 0);
    const neededRaw = Math.max(0, targetRaw - onHandRaw);

    // âœ… 50% REDUCED display values
    const onHand50  = onHandRaw  * 0.5;
    const par50     = parRaw     * 0.5;
    const needed50  = neededRaw  * 0.5;

    const tentative = parseFloat(row.tentative || 0);
    const isRony    = userType === 'rony';
    const defaultQty = isRony ? '' : (tentative > 0 ? tentative : (needed50 > 0 ? needed50 : ''));

    const conversion = window.conversionMap?.get(productName) || { units_per_case: 1, unit_type: 'unit' };
    const hasCase = conversion.units_per_case > 1;
    const caseSizeText = hasCase
        ? `${conversion.units_per_case} ${conversion.unit_type} per case`
        : 'N/A';

    // Current assignment
    const currentUser      = (row.user || '').toLowerCase();
    const isAssignedToRony   = currentUser === 'rony';
    const isAssignedToJulio  = currentUser === 'julio';
    const isAssignedToOffice = currentUser === 'office';

    // Price data (50% of actual)
    const productPrices = inventoryData.filter(i => i.product_name === productName);
    const prices = productPrices.map(i => parseFloat(i.unit_price || 0));
    let bestPrice    = { price: 0, vendor: 'N/A', date: 'N/A' };
    let highestPrice = { price: 0, vendor: 'N/A', date: 'N/A' };

    if (prices.length > 0) {
        const minPrice = Math.min(...prices);
        const maxPrice = Math.max(...prices);
        const minItem  = productPrices.find(i => parseFloat(i.unit_price) === minPrice);
        const maxItem  = productPrices.find(i => parseFloat(i.unit_price) === maxPrice);
        bestPrice    = { price: minPrice * 0.5, vendor: minItem?.vendor || 'N/A', date: minItem?.purchase_date || 'N/A' };
        highestPrice = { price: maxPrice * 0.5, vendor: maxItem?.vendor || 'N/A', date: maxItem?.purchase_date || 'N/A' };
    }

    return `
<div class="enhanced-order-card" data-product="${escapedProductName}" data-user="${userType}" data-id="${escapedItemId}"
     style="background:white;border:1px solid var(--neutral-300);border-radius:8px;overflow:hidden;box-shadow:var(--shadow-sm);">

  <!-- HEADER: Assignment & Actions -->
  <div style="background:linear-gradient(135deg,var(--neutral-100),var(--neutral-50));padding:0.75rem 1rem;border-bottom:2px solid var(--neutral-200);display:flex;justify-content:space-between;align-items:center;">
    <div style="display:flex;gap:0.5rem;align-items:center;">
      <span style="font-size:0.75rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;">Assign:</span>
      <button onclick="toggleAssignment('${escapedItemId}','Rony')" class="btn ${isAssignedToRony?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;">Rony</button>
      <button onclick="toggleAssignment('${escapedItemId}','Julio')" class="btn ${isAssignedToJulio?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;">Julio</button>
      <button onclick="toggleAssignment('${escapedItemId}','Office')" class="btn ${isAssignedToOffice?'btn-primary':'btn-secondary'}" style="padding:0.375rem 0.75rem;font-size:0.8125rem;min-width:70px;${isAssignedToOffice?'background:var(--success-600);':''}">Office</button>
    </div>
    <button onclick="deleteProductFromPlaceOrder('${escapedItemId}')" class="btn btn-danger btn-icon" style="width:32px;height:32px;padding:0;font-size:0.875rem;"><i class="fas fa-trash"></i></button>
  </div>

  <!-- PRODUCT INFO -->
  <div style="padding:1rem;border-bottom:1px solid var(--neutral-200);">
    <div style="display:grid;grid-template-columns:100px 1fr;gap:1rem;align-items:start;">
      <div style="text-align:center;">
        <img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
             style="width:100px;height:100px;object-fit:contain;border-radius:8px;border:1px solid var(--neutral-200);background:white;padding:0.5rem;">
      </div>
      <div>
        <h3 style="font-size:1rem;font-weight:700;color:var(--neutral-900);margin:0 0 0.5rem 0;line-height:1.3;">${escapedProductName}</h3>
        <div style="display:grid;grid-template-columns:auto 1fr;gap:0.5rem 1rem;font-size:0.8125rem;">
          <span style="color:var(--neutral-600);font-weight:600;">Item Code:</span>
          <span style="font-family:var(--font-mono);font-weight:600;color:var(--neutral-900);" id="itemcode-display-${productId}">
            ${row.item_code || '-------'}
          </span>
          <span style="color:var(--neutral-600);font-weight:600;">Case Size:</span>
          <span style="font-weight:600;color:${hasCase ? 'var(--primary-700)' : 'var(--neutral-500)'};">
            ${caseSizeText}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- INVENTORY METRICS â€” ALL AT 50% -->
  <div style="padding:1rem;background:var(--neutral-50);border-bottom:1px solid var(--neutral-200);">
    <!-- Halved notice badge -->
    <div style="text-align:center;margin-bottom:0.75rem;">
      <span style="display:inline-block;background:var(--primary-100);color:var(--primary-800);padding:0.25rem 0.75rem;border-radius:50px;font-size:0.7rem;font-weight:700;letter-spacing:0.05em;">
        Ã·2 â€” ALL VALUES SHOWN AT 50%
      </span>
    </div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:1rem;">

      <!-- CURRENT STOCK (50%) -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--neutral-300);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Current Stock</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--primary-700);">${onHand50.toFixed(1)}</div>
        <div style="font-size:0.6rem;color:var(--neutral-400);margin-top:0.2rem;">actual: ${onHandRaw.toFixed(1)}</div>
      </div>

      <!-- PAR (50%) â€” editable but shows 50% -->
      <div style="background:white;padding:0.75rem;border-radius:8px;border:1px solid var(--accent-400);text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">PAR Level</div>
        <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--accent-700);">${par50.toFixed(1)}</div>
        <div style="font-size:0.6rem;color:var(--neutral-400);margin-top:0.2rem;">actual: ${parRaw.toFixed(1)}</div>
      </div>

      <!-- ORDER NEEDED (50%) -->
      <div style="background:${needed50 > 0 ? 'var(--warning-50)' : 'var(--success-50)'};padding:0.75rem;border-radius:8px;border:1px solid ${needed50 > 0 ? 'var(--warning-400)' : 'var(--success-400)'};text-align:center;">
        <div style="font-size:0.6875rem;font-weight:700;color:var(--neutral-600);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">
          ${needed50 > 0 ? 'Order Needed' : 'Fully Stocked'}
        </div>
        ${needed50 > 0 ? `
          <div style="font-size:1.75rem;font-weight:700;font-family:var(--font-mono);color:var(--warning-700);">${needed50.toFixed(1)}</div>
          <div style="font-size:0.6rem;color:var(--neutral-400);margin-top:0.2rem;">actual: ${neededRaw.toFixed(1)}</div>
        ` : `
          <div style="font-size:1.75rem;font-weight:700;color:var(--success-600);"><i class="fas fa-check-circle"></i></div>
        `}
      </div>
    </div>
  </div>

  <!-- PRICE BOXES â€” filled async by loadVendorPricesForProduct -->
  <div style="padding:0.75rem;border-bottom:1px solid var(--neutral-200);">
    <div style="text-align:center;margin-bottom:0.5rem;">
      <span style="display:inline-block;background:var(--success-50);color:var(--success-800);
                   padding:0.2rem 0.6rem;border-radius:50px;font-size:0.6rem;font-weight:700;
                   letter-spacing:0.04em;">
        2026 PRICES AT 50%
      </span>
    </div>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:0.6rem;">

      <!-- BEST PRICE BOX -->
      <div style="background:var(--success-50);padding:0.6rem;border-radius:6px;border:2px solid var(--success-500);">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.3rem;">
          <span style="font-size:0.6rem;font-weight:700;color:var(--success-700);text-transform:uppercase;">Best Price</span>
          <i class="fas fa-award" style="color:var(--success-600);font-size:0.75rem;"></i>
        </div>
        <div id="best-price-box-${productId}">
          <div style="font-size:0.65rem;color:var(--neutral-400);padding:0.25rem 0;">Loading 2026â€¦</div>
        </div>
      </div>

      <!-- HIGHEST PRICE BOX -->
      <div style="background:var(--neutral-100);padding:0.6rem;border-radius:6px;border:1px solid var(--neutral-300);">
        <div style="font-size:0.6rem;font-weight:700;color:var(--neutral-500);text-transform:uppercase;margin-bottom:0.3rem;">
          Highest Price
        </div>
        <div id="high-price-box-${productId}">
          <div style="font-size:0.65rem;color:var(--neutral-400);padding:0.25rem 0;">Loading 2026â€¦</div>
        </div>
      </div>
    </div>
  </div>

  <!-- VENDOR PRICES TABLE (loads async, shows all vendors + dates) -->
  <div id="vendor-prices-${productId}" style="padding:1rem;border-bottom:1px solid var(--neutral-200);">
    <div style="font-size:0.8125rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.75rem;">
      ðŸ”¥ Vendor Prices
    </div>
    <div style="font-size:0.75rem;color:var(--neutral-500);text-align:center;padding:1rem;background:var(--neutral-50);border-radius:6px;">
      Loading vendor prices...
    </div>
  </div>

  <!-- ORDER FORM -->
  <div style="padding:1rem;background:var(--neutral-50);">
    <div style="display:grid;gap:1rem;">
      <div>
        <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Select Vendor</label>
        <select id="vendor-${productId}"
                onchange="selectVendorAndUpdateItemCode('${escapedItemId}','${escapedProductName}',this.value)"
                class="search-input" style="width:100%;font-size:0.9375rem;">
          <option value="">-- Choose Vendor --</option>
          <option value="Pacific Plus"           ${row.vendor==='Pacific Plus'           ?'selected':''}>Pacific Plus</option>
          <option value="Formosa Foods"           ${row.vendor==='Formosa Foods'           ?'selected':''}>Formosa Foods</option>
          <option value="North Food Group"        ${row.vendor==='North Food Group'        ?'selected':''}>North Food Group</option>
          <option value="BakeMark"                ${row.vendor==='BakeMark'                ?'selected':''}>BakeMark</option>
          <option value="Autochlor"               ${row.vendor==='Autochlor'               ?'selected':''}>Autochlor</option>
          <option value="Delta Office Products"   ${row.vendor==='Delta Office Products'   ?'selected':''}>Delta Office Products</option>
        </select>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:1rem;">
        <div>
          <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">Item Code</label>
          <input type="text" id="itemcode-input-${productId}" value="${row.item_code || ''}"
                 onblur="updateItemCode('${escapedItemId}',this.value)"
                 placeholder="Auto-fills" class="search-input"
                 style="font-family:var(--font-mono);font-weight:600;">
        </div>
        <div>
          <label style="display:block;font-size:0.75rem;font-weight:700;color:var(--neutral-700);text-transform:uppercase;letter-spacing:0.05em;margin-bottom:0.5rem;">
            Order Quantity
            ${!isRony && needed50 > 0 ? `<span style="color:var(--warning-600);font-weight:700;text-transform:none;">(Need: ${needed50.toFixed(1)})</span>` : ''}
          </label>
          <input type="number" id="qty-${productId}" value="${defaultQty}"
                 step="0.01" min="0"
                 onblur="updateTentative('${escapedItemId}',this.value)"
                 placeholder="0.00" class="search-input"
                 style="font-size:1.125rem;font-weight:700;text-align:center;font-family:var(--font-mono);">
        </div>
      </div>
    </div>
    <div id="save-status-${productId}" style="text-align:center;font-size:0.8125rem;color:var(--neutral-500);margin-top:0.75rem;min-height:1.25rem;"></div>
  </div>

</div>`;
}
// ========== LOAD CONVERSION MAP & LAST ORDER DATA ==========
async function loadSupportingData() {
    try {
        // Load product conversions from product_conversions table
        const { data: conversions, error: convError } = await supabaseClient
            .from('product_conversions')
            .select('*');
        
        if (!convError && conversions) {
            window.conversionMap = new Map();
            conversions.forEach(c => {
                window.conversionMap.set(c.product_name, {
                    units_per_case: c.units_per_case || 1,
                    unit_type: c.unit_type || 'unit'
                });
            });
            console.log('âœ… Loaded', conversions.length, 'product conversions');
        }
        
        // Load last order information from inventory_submissions
        const { data: lastOrders, error: orderError } = await supabaseClient
            .from('inventory_submissions')
            .select('*')
            .order('submission_date', { ascending: false });
        
        if (!orderError && lastOrders) {
            window.lastOrderMap = new Map();
            lastOrders.forEach(order => {
                if (!window.lastOrderMap.has(order.product_name)) {
                    window.lastOrderMap.set(order.product_name, {
                        vendor: order.submitted_by === 'julio' ? 'Julio (Target)' : 'Rony (Stock)',
                        quantity: order.quantity,
                        date: order.submission_date
                    });
                }
            });
            console.log('âœ… Loaded last orders for', window.lastOrderMap.size, 'products');
        }
    } catch (error) {
        console.error('âš ï¸ Error loading supporting data:', error);
    }
}


// ========== SELECT VENDOR AND AUTO-FILL ITEM CODE ==========
async function selectVendorAndUpdateItemCode(rowId, productName, vendor) {
    if (!vendor) return;
    
    const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');
    const itemCodeInput = document.getElementById(`itemcode-input-${productId}`);
    const itemCodeDisplay = document.getElementById(`itemcode-display-${productId}`);
    const statusEl = document.getElementById(`save-status-${productId}`);
    
    try {
        // Look up item code from purchase_history
        const { data, error } = await supabaseClient
            .from('purchase_history')
            .select('item_code, unit_price')
            .eq('product_name', productName)
            .eq('vendor', vendor)
            .order('purchase_date', { ascending: false })
            .limit(1);
        
        if (error) throw error;
        
        const itemCode = data && data.length > 0 ? data[0].item_code : '';
        const price = data && data.length > 0 ? data[0].unit_price : null;
        
        // Update UI
        if (itemCodeInput) itemCodeInput.value = itemCode || '';
        if (itemCodeDisplay) itemCodeDisplay.textContent = itemCode || '-------';
        
        // Save to database
        const { error: updateError } = await supabaseClient
            .from('inventory_check')
            .update({ 
                vendor: vendor,
                item_code: itemCode || null
            })
            .eq('id', rowId);
        
        if (updateError) throw updateError;
        
        if (statusEl) {
            statusEl.innerHTML = `<span style="color: var(--success-600);">âœ… ${vendor} selected${itemCode ? ` (${itemCode})` : ''}${price ? ` - $${parseFloat(price).toFixed(2)}` : ''}</span>`;
            setTimeout(() => { statusEl.innerHTML = ''; }, 3000);
        }
        
    } catch (error) {
        console.error('Select vendor error:', error);
        if (statusEl) {
            statusEl.innerHTML = '<span style="color: var(--warning-600);">âŒ Error</span>';
        }
    }
}



// ========== LOAD VENDOR PRICES FOR A SPECIFIC PRODUCT ==========




// ========== ENHANCED: LOAD ALL VENDOR PRICES WITH ALL ITEM CODES ==========
// ========== FIXED: Load prices from BOTH invoice_items AND purchase_history ==========
async function loadVendorPricesForProduct(productName, productId) {
    try {
        // 1. Get all invoice_items for this product
        const { data: invoiceItems, error: itemsError } = await supabaseClient
            .from('invoice_items')
            .select('vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id')
            .eq('product_name', productName);

        if (itemsError) throw itemsError;

        // 2. Fetch invoice dates for those invoice_ids
        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id))];
        const invoiceDatesMap = new Map();

        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => {
                invoiceDatesMap.set(inv.id, { date: inv.invoice_date, vendor: inv.vendor });
            });
        }

        // 3. Build flat list â€” 2026 ONLY
        const allEntries = [];
        (invoiceItems || []).forEach(item => {
            const invInfo = invoiceDatesMap.get(item.invoice_id);
            if (!invInfo || !invInfo.date) return;
            if (new Date(invInfo.date).getFullYear() !== 2026) return; // âœ… 2026 filter

            const price = item.has_weight
                ? parseFloat(item.price_per_unit || 0)
                : parseFloat(item.unit_price || 0);

            allEntries.push({
                vendor:    invInfo.vendor,
                item_code: item.item_code || 'N/A',
                price,
                date:      invInfo.date
            });
        });

        // 4. Per vendor: keep only MOST RECENT entry
        const vendorLatestMap = new Map();
        allEntries.forEach(entry => {
            const existing = vendorLatestMap.get(entry.vendor);
            if (!existing || new Date(entry.date) > new Date(existing.date)) {
                vendorLatestMap.set(entry.vendor, {
                    item_code: entry.item_code,
                    price:     entry.price,
                    date:      entry.date
                });
            }
        });

        const container = document.getElementById(`vendor-prices-${productId}`);

        // 5. No 2026 data case
        if (vendorLatestMap.size === 0) {
            const noDataMsg = `<div style="font-size:0.65rem;color:var(--neutral-400);padding:0.25rem 0;">No 2026 data yet</div>`;
            const bestEl = document.getElementById(`best-price-box-${productId}`);
            const highEl = document.getElementById(`high-price-box-${productId}`);
            if (bestEl) bestEl.innerHTML = noDataMsg;
            if (highEl) highEl.innerHTML = noDataMsg;
            if (container) container.innerHTML = `
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.35rem;">
                    <span style="font-size:0.7rem;font-weight:700;color:var(--neutral-600);">ðŸ”¥ VENDOR PRICES</span>
                    <span style="font-size:0.6rem;color:var(--neutral-400);">2026 only</span>
                </div>
                <div style="font-size:0.65rem;color:var(--neutral-500);text-align:center;padding:0.5rem;
                            background:var(--neutral-50);border-radius:5px;border:1px dashed var(--neutral-300);">
                    No 2026 invoices for this product yet
                </div>`;
            return;
        }

        // 6. Compute best / highest
        const sortedVendors = Array.from(vendorLatestMap.keys()).sort();
        const prices50      = sortedVendors.map(v => vendorLatestMap.get(v).price * 0.5);
        const bestPrice50   = Math.min(...prices50);
        const highPrice50   = Math.max(...prices50);
        const bestVendor    = sortedVendors[prices50.indexOf(bestPrice50)];
        const highVendor    = sortedVendors[prices50.indexOf(highPrice50)];
        const bestEntry     = vendorLatestMap.get(bestVendor);
        const highEntry     = vendorLatestMap.get(highVendor);

        // 7. âœ… UPDATE the Best Price box (2026 data)
        const bestBoxEl = document.getElementById(`best-price-box-${productId}`);
        if (bestBoxEl) bestBoxEl.innerHTML = `
            <div style="font-size:1.25rem;font-weight:700;font-family:var(--font-mono);
                        color:var(--success-700);margin-bottom:0.2rem;">
                $${bestPrice50.toFixed(2)}
            </div>
            <div style="font-size:0.7rem;color:var(--neutral-700);font-weight:600;">${bestVendor}</div>
            <div style="font-size:0.6rem;color:var(--neutral-500);margin-top:0.1rem;">
                ${bestEntry.date ? formatDate(bestEntry.date) : 'N/A'}
            </div>`;

        // 8. âœ… UPDATE the Highest Price box (2026 data)
        const highBoxEl = document.getElementById(`high-price-box-${productId}`);
        if (highBoxEl) highBoxEl.innerHTML = `
            <div style="font-size:1.25rem;font-weight:700;font-family:var(--font-mono);
                        color:var(--neutral-700);margin-bottom:0.2rem;">
                $${highPrice50.toFixed(2)}
            </div>
            <div style="font-size:0.7rem;color:var(--neutral-600);font-weight:600;">${highVendor}</div>
            <div style="font-size:0.6rem;color:var(--neutral-500);margin-top:0.1rem;">
                ${highEntry.date ? formatDate(highEntry.date) : 'N/A'}
            </div>`;

        // 9. Render vendor table
        if (!container) return;

        const range50  = (highPrice50 - bestPrice50).toFixed(2);
        const optLabel = sortedVendors.length === 1 ? '1 vendor' : `${sortedVendors.length} vendors`;

        const rowsHTML = sortedVendors.map(vendor => {
            const entry   = vendorLatestMap.get(vendor);
            const price50 = (entry.price * 0.5).toFixed(2);
            const isBest  = vendor === bestVendor;
            return `
            <tr style="background:${isBest?'rgba(16,185,129,0.07)':'white'};
                       border-bottom:1px solid var(--neutral-200);">
                <td style="padding:0.3rem 0.45rem;font-weight:700;color:var(--primary-700);font-size:0.7rem;">
                    ${vendor}</td>
                <td style="padding:0.3rem 0.45rem;font-family:var(--font-mono);font-size:0.65rem;
                           color:${isBest?'var(--success-700)':'var(--neutral-600)'};
                           text-align:center;font-weight:600;">
                    ${entry.item_code}</td>
                <td style="padding:0.3rem 0.45rem;font-size:0.6rem;color:var(--neutral-500);text-align:center;">
                    ${entry.date ? formatDate(entry.date) : 'N/A'}</td>
                <td style="padding:0.3rem 0.45rem;font-family:var(--font-mono);font-weight:700;
                           font-size:0.75rem;text-align:right;
                           color:${isBest?'var(--success-700)':'var(--neutral-800)'};">
                    $${price50}${isBest?' ðŸ†':''}</td>
            </tr>`;
        }).join('');

        container.innerHTML = `
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:0.35rem;">
                <span style="font-size:0.7rem;font-weight:700;color:var(--neutral-600);">ðŸ”¥ VENDOR PRICES</span>
                <span style="font-size:0.6rem;color:var(--neutral-400);font-weight:600;">
                    ${optLabel} â€¢ 2026 â€¢ 50%
                </span>
            </div>
            <table style="width:100%;border-collapse:collapse;
                          border:1px solid var(--neutral-300);border-radius:5px;overflow:hidden;">
                <thead>
                    <tr style="background:var(--neutral-800);">
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:left;">Vendor</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:center;">Code</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:center;">Date</th>
                        <th style="padding:0.28rem 0.45rem;font-size:0.6rem;font-weight:700;color:white;text-align:right;">Price (50%)</th>
                    </tr>
                </thead>
                <tbody>${rowsHTML}</tbody>
            </table>
            ${sortedVendors.length > 1 ? `
            <div style="margin-top:0.35rem;padding:0.35rem 0.5rem;background:var(--success-50);
                        border-radius:5px;border:1px solid var(--success-200);">
                <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:0.2rem;font-size:0.6rem;">
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">BEST</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--success-700);font-family:var(--font-mono);">$${bestPrice50.toFixed(2)} ðŸ†</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">HIGH</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--warning-600);font-family:var(--font-mono);">$${highPrice50.toFixed(2)}</div>
                    </div>
                    <div style="text-align:center;">
                        <div style="color:var(--neutral-500);font-weight:600;margin-bottom:0.1rem;">RANGE</div>
                        <div style="font-size:0.75rem;font-weight:700;color:var(--primary-700);font-family:var(--font-mono);">$${range50}</div>
                    </div>
                </div>
            </div>` : ''}`;

    } catch (error) {
        console.error('âš ï¸ loadVendorPrices error:', error);
        const container = document.getElementById(`vendor-prices-${productId}`);
        if (container) container.innerHTML = `
            <div style="font-size:0.65rem;color:var(--warning-600);text-align:center;padding:0.4rem;
                        background:var(--warning-50);border-radius:5px;border:1px solid var(--warning-300);">
                âš ï¸ Error loading prices
            </div>`;
    }
}














// Update PAR value with auto-save
async function updateParValue(productName, newPar) {
    const parValue = parseFloat(newPar) || 0;
    
    showLoading(true);
    try {
        // Update in inventory_management table
        const { error } = await supabaseClient
            .from('inventory_management')
            .update({ par: parValue })
            .eq('product_name', productName);
        
        if (error) throw error;
        
        showAlert(`âœ… PAR updated to ${parValue.toFixed(1)} for ${productName}`, 'success');
        
        // Reload the order to reflect changes
        await loadEnhancedCreateOrder();
        
    } catch (error) {
        console.error('Update PAR error:', error);
        showAlert('âŒ Error updating PAR: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Update tentative (order quantity)
async function updateTentative(rowId, value) {
    const qty = parseFloat(value) || 0;
    const statusEl = document.querySelector(`[data-id="${rowId}"]`).querySelector('[id^="save-status-"]');
    
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .update({ tentative: qty })
            .eq('id', rowId);
        
        if (error) throw error;
        
        statusEl.innerHTML = '<span style="color: var(--success-600);">âœ… Saved</span>';
        setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update tentative error:', error);
        statusEl.innerHTML = '<span style="color: var(--warning-600);">âŒ Error</span>';
    }
}

// Update vendor
async function updateVendorItemCode(rowId, vendor) {
    const statusEl = document.querySelector(`[data-id="${rowId}"]`).querySelector('[id^="save-status-"]');
    
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .update({ vendor: vendor || null })
            .eq('id', rowId);
        
        if (error) throw error;
        
        statusEl.innerHTML = '<span style="color: var(--success-600);">âœ… Vendor saved</span>';
        setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update vendor error:', error);
        statusEl.innerHTML = '<span style="color: var(--warning-600);">âŒ Error</span>';
    }
}

// Update item code
async function updateItemCode(rowId, itemCode) {
    const statusEl = document.querySelector(`[data-id="${rowId}"]`).querySelector('[id^="save-status-"]');
    
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .update({ item_code: itemCode || null })
            .eq('id', rowId);
        
        if (error) throw error;
        
        statusEl.innerHTML = '<span style="color: var(--success-600);">âœ… Item code saved</span>';
        setTimeout(() => { statusEl.innerHTML = ''; }, 2000);
    } catch (error) {
        console.error('Update item code error:', error);
        statusEl.innerHTML = '<span style="color: var(--warning-600);">âŒ Error</span>';
    }
}

// Toggle assignment (rony â†” julio)
async function toggleAssignment(rowId, newUser) {
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .update({ user: newUser })
            .eq('id', rowId);
        
        if (error) throw error;
        
        showAlert(`âœ… Assignment updated to ${newUser.toUpperCase()}`, 'success');
        await loadEnhancedCreateOrder();
    } catch (error) {
        console.error('Toggle assignment error:', error);
        showAlert('âŒ Error updating assignment', 'error');
    }
}

// Delete product
// âœ… KEEP THIS VERSION - It works with row.id
async function deleteProductFromPlaceOrder(rowId) {
    if (!confirm('âš ï¸ Delete this product from inventory_check?')) return;
    
    showLoading(true);
    try {
        const { error } = await supabaseClient
            .from('inventory_check')
            .delete()
            .eq('id', rowId);
        
        if (error) throw error;
        
        showAlert('âœ… Product deleted', 'success');
        await loadEnhancedCreateOrder();
    } catch (error) {
        console.error('Delete error:', error);
        showAlert('âŒ Error deleting product', 'error');
    } finally {
        showLoading(false);
    }
}

// Select vendor for product
function selectVendorForProduct(productId, vendor, itemCode) {
    document.getElementById(`vendor-${productId}`).value = vendor;
    document.getElementById(`itemcode-${productId}`).textContent = itemCode || '-------';
    
    // Highlight selected row
    const card = document.querySelector(`[data-product]`);
    if (card) {
        card.querySelectorAll('.vendor-option-row').forEach(row => {
            row.classList.remove('selected');
        });
        event.currentTarget.classList.add('selected');
    }
    
    showAlert(`âœ… Selected ${vendor} for ordering`, 'success');
}

// Submit enhanced order
async function submitEnhancedOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    const cards = document.querySelectorAll('.enhanced-order-card');
    
    if (cards.length === 0) {
        showAlert('No products to order', 'error');
        return;
    }
    
    showLoading(true);
    try {
        const updates = [];
        
        for (const card of cards) {
            const productName = card.dataset.product;
            const user = card.dataset.user;
            const productId = productName.replace(/[^a-zA-Z0-9]/g, '_');
            
            const qtyInput = document.getElementById(`qty-${productId}`);
            const vendorInput = document.getElementById(`vendor-${productId}`);
            
            if (!qtyInput || !vendorInput) continue;
            
            const quantity = parseFloat(qtyInput.value || 0);
            const vendor = vendorInput.value || null;
            
            if (quantity > 0 || vendor) {
                updates.push(
                    supabaseClient
                        .from('inventory_check')
                        .update({
                            tentative: quantity,
                            vendor: vendor
                        })
                        .eq('order_date', dateISO)
                        .eq('product_name', productName)
                        .eq('user', user)
                );
            }
        }
        
        if (updates.length === 0) {
            showAlert('No changes to save', 'error');
            return;
        }
        
        await Promise.all(updates);
        
        showAlert(`âœ… Order saved successfully! ${updates.length} products updated`, 'success');
        
        // Reload
        await loadEnhancedCreateOrder();
        
    } catch (error) {
        console.error('Submit order error:', error);
        showAlert('Error saving order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ========== UTILITY FUNCTIONS FOR PLACE ORDER ==========

// Get today's date in YYYY-MM-DD format
function todayYMD() {
    const today = new Date();
    const year = today.getFullYear();
    const month = String(today.getMonth() + 1).padStart(2, '0');
    const day = String(today.getDate()).padStart(2, '0');
    return `${year}-${month}-${day}`;
}

// Canonicalize vendor names (handle variations)
function canonicalizeVendor(vendor) {
    if (!vendor) return '';
    const v = vendor.toLowerCase().trim();
    
    // Handle common variations
    if (v.includes('pacific')) return 'Pacific Plus';
    if (v.includes('formosa')) return 'Formosa Foods';
    if (v.includes('north') && v.includes('food')) return 'North Food Group';
    if (v.includes('bakemark')) return 'BakeMark';
    if (v.includes('autochlor')) return 'Autochlor';
    
    // Default: capitalize first letter of each word
    return vendor.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
}

// Allowed vendors list
const ALLOWED_VENDORS = [
    'Pacific Plus',
    'Formosa Foods',
    'North Food Group',
    'BakeMark',
    'Delta Office Products',
    'Autochlor'
];

// Vendor code map (for item codes)
let vendorCodeMap = new Map();

async function buildVendorCodeMap() {
    try {
        const { data, error } = await supabaseClient
            .from('vendor_prices')
            .select('product_name, vendor, item_code, unit_price')
            .order('last_updated', { ascending: false });
        
        if (error) throw error;
        
        vendorCodeMap.clear();
        (data || []).forEach(row => {
            if (!row.product_name || !row.vendor) return;
            const key = `${row.product_name}_${canonicalizeVendor(row.vendor)}`;
            if (!vendorCodeMap.has(key)) {
                vendorCodeMap.set(key, {
                    item_code: row.item_code || '',
                    unit_price: parseFloat(row.unit_price || 0)
                });
            }
        });
        
        console.log('âœ… vendorCodeMap built:', vendorCodeMap.size, 'entries');
    } catch (error) {
        console.error('Build vendor code map error:', error);
    }
}

// Get item code for product and vendor
function getItemCodeFor(productName, vendor) {
    const key = `${productName}_${canonicalizeVendor(vendor)}`;
    return vendorCodeMap.get(key) || '-------';
}

// Load jsPDF library (stub for now - can be enhanced later)
function loadJsPDF() {
    // PDF generation can be added later if needed
    console.log('PDF generation ready (placeholder)');
}

function switchOrderTab(tabName, evt) {
    // Remove active class from all sub-tabs
    document.querySelectorAll('.order-sub-tab').forEach(tab => {
        tab.classList.remove('active');
        tab.style.background = 'transparent';
        tab.style.color = 'var(--neutral-600)';
    });
    
    // Remove active class from all order content sections
    document.querySelectorAll('.order-content-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Add active class to clicked tab
    if (evt && evt.target) {
        evt.target.classList.add('active');
        evt.target.style.background = 'linear-gradient(135deg, var(--primary-700) 0%, var(--primary-600) 100%)';
        evt.target.style.color = 'white';
    }
    
    // Show corresponding content section
    document.getElementById(tabName).classList.add('active');
}

// Update date change listener
document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'createOrderDate') {
        loadEnhancedCreateOrder();
    }
});




// ========== INVENTORY SETTINGS FUNCTIONS ==========

let settingsData = [];

async function loadInventorySettings() {
    showLoading(true);
    try {
        // Get all unique products from inventory_management (Rony's items priority)
        const { data: products, error: prodError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, user')
            .order('product_name');
        
        if (prodError) throw prodError;
        
        const uniqueProducts = new Set();
        (products || []).forEach(p => {
            const name = (p.product_name || '').trim();
            if (name) uniqueProducts.add(name);
        });
        
        // Load existing conversions
        const { data: conversions, error: convError } = await supabaseClient
            .from('product_conversions')
            .select('*');
        
        if (convError) throw convError;
        
        const conversionMap = new Map();
        (conversions || []).forEach(c => {
            conversionMap.set(c.product_name, c);
        });
        
        // Build settings data
        settingsData = Array.from(uniqueProducts).map(name => {
            const existing = conversionMap.get(name);
            return {
                product_name: name,
                units_per_case: existing ? existing.units_per_case : 1,
                unit_type: existing ? existing.unit_type : 'unit',
                notes: existing ? existing.notes : ''
            };
        });
        
        renderInventorySettings();
        
    } catch (error) {
        console.error('Load inventory settings error:', error);
        showAlert('Error loading settings', 'error');
    } finally {
        showLoading(false);
    }
}

function renderInventorySettings() {
    const tbody = document.getElementById('settingsTableBody');
    const searchTerm = document.getElementById('settingsSearchInput')?.value.toLowerCase() || '';
    
    let filtered = settingsData.filter(item => {
        if (!searchTerm) return true;
        return (item.product_name || '').toLowerCase().includes(searchTerm);
    });
    
    document.getElementById('settingsCount').textContent = `${filtered.length} products`;
    
    if (filtered.length === 0) {
        tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 2rem;">No products found</td></tr>';
        return;
    }
    
    tbody.innerHTML = filtered.map((item, idx) => `
        <tr>
            <td style="font-weight: 600;">${item.product_name}</td>
            <td>
                <input type="number" 
                       value="${item.units_per_case}" 
                       min="0.01" 
                       step="0.01"
                       onchange="updateConversion('${item.product_name}', 'units_per_case', this.value)"
                       class="search-input" 
                       style="width: 100px; text-align: center; font-family: var(--font-mono); font-weight: 700;">
            </td>
            <td>
                <select onchange="updateConversion('${item.product_name}', 'unit_type', this.value)" class="search-input" style="width: 120px;">
                    <option value="case" ${item.unit_type === 'case' ? 'selected' : ''}>Case</option>
                    <option value="unit" ${item.unit_type === 'unit' ? 'selected' : ''}>Unit</option>
                    <option value="box" ${item.unit_type === 'box' ? 'selected' : ''}>Box</option>
                    <option value="bag" ${item.unit_type === 'bag' ? 'selected' : ''}>Bag</option>
                    <option value="bucket" ${item.unit_type === 'bucket' ? 'selected' : ''}>Bucket</option>
                </select>
            </td>
            <td>
                <input type="text" 
                       value="${item.notes || ''}" 
                       onchange="updateConversion('${item.product_name}', 'notes', this.value)"
                       placeholder="e.g., 6 bottles per case"
                       class="search-input" 
                       style="width: 100%;">
            </td>
        </tr>
    `).join('');
}

function updateConversion(productName, field, value) {
    const item = settingsData.find(i => i.product_name === productName);
    if (!item) return;
    
    if (field === 'units_per_case') {
        item[field] = parseFloat(value) || 1;
    } else {
        item[field] = value;
    }
}

function filterInventorySettings() {
    renderInventorySettings();
}

async function saveAllConversions() {
    showLoading(true);
    try {
        const { error } = await supabaseClient
            .from('product_conversions')
            .upsert(settingsData, { onConflict: 'product_name' });
        
        if (error) throw error;
        
        showAlert('âœ… Conversion factors saved!', 'success');
        
    } catch (error) {
        console.error('Save conversions error:', error);
        showAlert('Error saving: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}
let submissionHistoryData = [];
let filteredHistory = [];

async function loadSubmissionHistory() {
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_submissions')
            .select('*')
            .order('submission_date', { ascending: false });
        
        if (error) throw error;
        
        submissionHistoryData = data || [];
        filteredHistory = [...submissionHistoryData];
        renderSubmissionHistory();
        
    } catch (error) {
        console.error('Load submission history error:', error);
        showAlert('Error loading history', 'error');
    } finally {
        showLoading(false);
    }
}

function filterSubmissionHistory() {
    const userFilter = document.getElementById('historyUserFilter')?.value || '';
    const dateFrom = document.getElementById('historyDateFrom')?.value || '';
    const dateTo = document.getElementById('historyDateTo')?.value || '';
    const searchTerm = document.getElementById('historySearchInput')?.value.toLowerCase() || '';
    
    filteredHistory = submissionHistoryData.filter(item => {
        const matchesUser = !userFilter || item.submitted_by === userFilter;
        const matchesDateFrom = !dateFrom || new Date(item.submission_date) >= new Date(dateFrom);
        const matchesDateTo = !dateTo || new Date(item.submission_date) <= new Date(dateTo + 'T23:59:59');
        const matchesSearch = !searchTerm || (item.product_name || '').toLowerCase().includes(searchTerm);
        
        return matchesUser && matchesDateFrom && matchesDateTo && matchesSearch;
    });
    
    renderSubmissionHistory();
}

function renderSubmissionHistory() {
    const tbody = document.getElementById('historyTableBody');
    document.getElementById('historyCount').textContent = `${filteredHistory.length} submissions`;
    
    if (filteredHistory.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6"><div class="empty-state"><div class="empty-state-icon">ðŸ“…</div><h3>No Submissions Found</h3></div></td></tr>';
        return;
    }
    
    tbody.innerHTML = filteredHistory.map(item => {
        const userBadge = item.submitted_by === 'julio' 
            ? '<span class="vendor-badge" style="background: var(--accent-200); color: var(--accent-800);">Julio</span>'
            : '<span class="vendor-badge" style="background: var(--primary-200); color: var(--primary-800);">Rony</span>';
        
        const typeBadge = item.submission_type === 'target_inventory'
            ? '<span class="vendor-badge" style="background: var(--accent-100); color: var(--accent-700);">Target</span>'
            : '<span class="vendor-badge" style="background: var(--success-100); color: var(--success-700);">Stock</span>';
        
        return `
            <tr>
                <td>${formatDate(item.submission_date)}</td>
                <td>${userBadge}</td>
                <td style="font-weight: 600;">${item.product_name}</td>
                <td><span class="price-cell" style="font-family: var(--font-mono); font-weight: 700; color: var(--neutral-900);">${parseFloat(item.quantity).toFixed(2)}</span></td>
                <td>${typeBadge}</td>
                <td style="font-size: 0.875rem; color: var(--neutral-600);">${item.notes || '-'}</td>
            </tr>
        `;
    }).join('');
}

// ========== STOCK ALERTS SYSTEM ==========
let currentAlertFilter = 'all';
let stockAlertsData = [];

async function loadStockAlerts() {
    showLoading(true);
    try {
        // Load current stock levels from current_stock table
        const { data: stockData, error: stockError } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock');
        
        // Load PAR levels and assignments from inventory_management
        // CRITICAL: Only show products assigned to Rony
        const { data: parData, error: parError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, par, category, image_url, assigned_to');
        
        // Load recent submissions to calculate consumption rate
        const thirtyDaysAgo = new Date();
        thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
        const { data: submissions, error: subError } = await supabaseClient
            .from('inventory_submissions')
            .select('product_name, quantity, submission_date, submitted_by')
            .gte('submission_date', thirtyDaysAgo.toISOString())
            .order('submission_date', { ascending: false });

        if (stockError || parError || subError) {
            throw stockError || parError || subError;
        }

        // Build stock map
        const stockMap = new Map();
        (stockData || []).forEach(item => {
            stockMap.set(item.product_name, parseFloat(item.quantity_in_stock || 0));
        });

        // Build PAR map - FILTER TO RONY'S PRODUCTS ONLY
        const parMap = new Map();
        (parData || []).forEach(item => {
            const assigned = Array.isArray(item.assigned_to) ? item.assigned_to : [];
            // ONLY include if assigned to Rony
            if (assigned.includes('rony')) {
                parMap.set(item.product_name, {
                    par: parseFloat(item.par || 0),
                    category: item.category,
                    image_url: item.image_url
                });
            }
        });

        // Calculate consumption trends - only for Rony's submissions
        const consumptionMap = new Map();
        (submissions || []).filter(s => s.submitted_by === 'rony').forEach(item => {
            if (!consumptionMap.has(item.product_name)) {
                consumptionMap.set(item.product_name, []);
            }
            consumptionMap.get(item.product_name).push({
                qty: parseFloat(item.quantity || 0),
                date: new Date(item.submission_date)
            });
        });

        // Generate alerts
        const alerts = [];
        const categoryFilter = document.getElementById('alertCategoryFilter')?.value || '';

        parMap.forEach((parInfo, productName) => {
            if (categoryFilter && parInfo.category !== categoryFilter) return;

            const currentStock = stockMap.get(productName) || 0;
            const par = parInfo.par;
            const consumption = consumptionMap.get(productName) || [];

            // Calculate if declining (>40% drop in last 2 weeks)
            let isDeclining = false;
            if (consumption.length >= 2) {
                const recent = consumption.slice(0, Math.min(7, consumption.length));
                const older = consumption.slice(7, Math.min(14, consumption.length));
                if (recent.length > 0 && older.length > 0) {
                    const recentAvg = recent.reduce((sum, r) => sum + r.qty, 0) / recent.length;
                    const olderAvg = older.reduce((sum, r) => sum + r.qty, 0) / older.length;
                    if (olderAvg > 0 && ((olderAvg - recentAvg) / olderAvg) > 0.4) {
                        isDeclining = true;
                    }
                }
            }

            let alertType = null;
            if (currentStock === 0) {
                alertType = 'critical';
            } else if (par > 0) {
                const ratio = currentStock / par;
                if (ratio < 0.25) alertType = 'warning';
                else if (ratio < 0.5) alertType = 'watch';
            }

            if (alertType || isDeclining) {
                alerts.push({
                    product_name: productName,
                    current_stock: currentStock,
                    par: par,
                    category: parInfo.category,
                    image_url: parInfo.image_url,
                    alert_type: alertType || 'declining',
                    is_declining: isDeclining,
                    last_count_date: consumption.length > 0 ? consumption[0].date : null
                });
            }
        });

        stockAlertsData = alerts.sort((a, b) => {
            const priority = { critical: 4, warning: 3, watch: 2, declining: 1 };
            return (priority[b.alert_type] || 0) - (priority[a.alert_type] || 0);
        });

        renderStockAlerts();
        updateAlertBadge();

    } catch (error) {
        console.error('Load stock alerts error:', error);
        showAlert('Error loading stock alerts: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function filterAlerts(filter) {
    currentAlertFilter = filter;
    document.querySelectorAll('.filter-chip').forEach(chip => {
        chip.classList.toggle('active', chip.dataset.filter === filter);
    });
    renderStockAlerts();
}

function renderStockAlerts() {
    const container = document.getElementById('alertsContainer');
    let filtered = stockAlertsData;

    if (currentAlertFilter !== 'all') {
        filtered = stockAlertsData.filter(a => a.alert_type === currentAlertFilter);
    }

    if (filtered.length === 0) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">âœ…</div>
                <h3>No Alerts</h3>
                <p>All stock levels look good!</p>
            </div>
        `;
        return;
    }

    container.innerHTML = filtered.map(alert => {
        const imgSrc = alert.image_url || 'https://via.placeholder.com/80x80?text=No+Image';
        const statusIcons = {
            critical: 'ðŸ”´',
            warning: 'ðŸŸ ',
            watch: 'ðŸŸ¡',
            declining: 'ðŸ“‰'
        };
        const statusLabels = {
            critical: 'CRITICAL - Out of Stock',
            warning: 'WARNING - Low Stock',
            watch: 'WATCH - Below 50%',
            declining: 'DECLINING - Dropping Fast'
        };

        const daysSinceCount = alert.last_count_date 
            ? Math.floor((new Date() - alert.last_count_date) / (1000 * 60 * 60 * 24))
            : null;

        return `
            <div class="alert-card ${alert.alert_type}">
                <div>
                    <img src="${imgSrc}" style="width:80px;height:80px;object-fit:cover;border-radius:8px;" onerror="this.src='https://via.placeholder.com/80x80?text=No+Image'">
                </div>
                <div>
                    <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                        <h3 style="margin: 0; font-size: 1.125rem;">${alert.product_name}</h3>
                        <span class="alert-status ${alert.alert_type}">
                            ${statusIcons[alert.alert_type]} ${statusLabels[alert.alert_type]}
                        </span>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem; margin-top: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase; font-weight: 600;">Current Stock</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${alert.current_stock === 0 ? 'var(--error-600)' : 'var(--neutral-900)'};">${alert.current_stock.toFixed(1)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase; font-weight: 600;">PAR Level</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${alert.par.toFixed(1)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase; font-weight: 600;">Stock %</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: var(--primary-600);">${alert.par > 0 ? ((alert.current_stock / alert.par) * 100).toFixed(0) : '0'}%</div>
                        </div>
                        ${daysSinceCount !== null ? `
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase; font-weight: 600;">Last Count</div>
                            <div style="font-size: 1rem; font-weight: 600;">${daysSinceCount} days ago</div>
                        </div>
                        ` : ''}
                    </div>
                </div>
                <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <button class="btn btn-primary" onclick="quickOrderFromAlert('${alert.product_name}')" style="white-space: nowrap;">
                        ðŸ“‹ Order Now
                    </button>
                    <button class="btn btn-secondary" onclick="acknowledgeAlert('${alert.product_name}')">
                        âœ“ Acknowledge
                    </button>
                </div>
            </div>
        `;
    }).join('');
}

function updateAlertBadge() {
    const badge = document.getElementById('alertBadge');
    const criticalCount = stockAlertsData.filter(a => a.alert_type === 'critical').length;
    if (criticalCount > 0) {
        badge.textContent = criticalCount;
        badge.style.display = 'inline';
    } else {
        badge.style.display = 'none';
    }
}

async function acknowledgeAlert(productName) {
    try {
        const { error } = await supabaseClient
            .from('alert_acknowledgements')
            .insert([{
                product_name: productName,
                acknowledged_at: new Date().toISOString(),
                acknowledged_by: 'system'
            }]);

        if (error) throw error;

        showAlert(`Alert for "${productName}" acknowledged`, 'success');
        loadStockAlerts();
    } catch (error) {
        console.error('Acknowledge error:', error);
        showAlert('Error: ' + error.message, 'error');
    }
}

function quickOrderFromAlert(productName) {
    // Switch to Place Order tab and pre-fill the product
    switchTab('placeOrder');
    showAlert(`Navigate to "${productName}" in the order form`, 'info');
}

// Auto-refresh alerts every 60 seconds
setInterval(() => {
    if (document.getElementById('stockAlerts').classList.contains('active')) {
        loadStockAlerts();
    }
}, 60000);

// ========== CONSUMPTION TRACKING SYSTEM ==========
let consumptionData = [];
let consumptionTrendChart = null;
let consumptionCostChart = null;

async function loadConsumptionData() {
    showLoading(true);
    const user = document.getElementById('consumptionUserFilter')?.value || 'rony';
    
    try {
        // Check if we have new week selectors or old period selector
        const hasWeekSelector = document.getElementById('consumptionWeeks');
        let startDate, endDate;
        
        if (hasWeekSelector && hasWeekSelector.options.length > 0) {
            // NEW: Use week selector
            try {
                const selectedWeeks = Array.from(hasWeekSelector.selectedOptions)
                    .map(o => {
                        try {
                            return JSON.parse(o.value);
                        } catch {
                            return null;
                        }
                    })
                    .filter(w => w !== null);
                
                if (selectedWeeks.length === 0) {
                    // Default to current month
                    const now = new Date();
                    startDate = new Date(now.getFullYear(), now.getMonth(), 1);
                    endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0);
                } else {
                    const allDates = selectedWeeks.map(w => ({
                        start: new Date(w.startDate),
                        end: new Date(w.endDate)
                    }));
                    startDate = new Date(Math.min(...allDates.map(d => d.start)));
                    endDate = new Date(Math.max(...allDates.map(d => d.end)));
                }
                
                // Update date range display if element exists
                const rangeDisplay = document.getElementById('consumptionDateRange');
                if (rangeDisplay) {
                    rangeDisplay.textContent = `${formatDate(startDate.toISOString())} to ${formatDate(endDate.toISOString())}`;
                }
            } catch (error) {
                // If week selector fails, fall through to period selector
                console.warn('Week selector error, using period selector:', error);
                const period = document.getElementById('consumptionPeriod')?.value || 'month';
                endDate = new Date();
                
                if (period === 'week') {
                    startDate = new Date();
                    startDate.setDate(startDate.getDate() - 7);
                } else if (period === 'month') {
                    startDate = new Date();
                    startDate.setMonth(startDate.getMonth() - 1);
                } else if (period === 'year') {
                    startDate = new Date();
                    startDate.setFullYear(startDate.getFullYear() - 1);
                }
            }
        } else {
            // OLD: Use period selector (fallback)
            const period = document.getElementById('consumptionPeriod')?.value || 'month';
            endDate = new Date();
            
            if (period === 'week') {
                startDate = new Date();
                startDate.setDate(startDate.getDate() - 7);
            } else if (period === 'month') {
                startDate = new Date();
                startDate.setMonth(startDate.getMonth() - 1);
            } else if (period === 'year') {
                startDate = new Date();
                startDate.setFullYear(startDate.getFullYear() - 1);
            } else if (period === 'custom') {
                const customDateFilters = document.getElementById('customDateRangeFilters');
                if (customDateFilters) {
                    customDateFilters.style.display = 'block';
                    const customDateFilters2 = document.getElementById('customDateRangeFilters2');
                    if (customDateFilters2) customDateFilters2.style.display = 'block';
                }
                startDate = new Date(document.getElementById('consumptionDateFrom')?.value || new Date());
                endDate = new Date(document.getElementById('consumptionDateTo')?.value || new Date());
            }
        }

        if (user === 'rony') {
            await loadRonyConsumption(startDate, endDate);
        } else {
            await loadJulioOrderFrequency(startDate, endDate);
        }

    } catch (error) {
        console.error('Load consumption error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}



// RONY: Actual consumption tracking (stock-based)
async function loadRonyConsumption(startDate, endDate) {
    // Load inventory submissions for Rony in date range
    const { data: submissions, error: subError } = await supabaseClient
        .from('inventory_submissions')
        .select('product_name, quantity, submission_date, submission_type')
        .eq('submitted_by', 'rony')
        .gte('submission_date', startDate.toISOString())
        .lte('submission_date', endDate.toISOString())
        .order('submission_date', { ascending: true });

    // Load invoice items to get deliveries and prices
    const { data: invoiceItems } = await supabaseClient
        .from('invoice_items')
        .select('product_name, quantity, unit_price, price_per_unit, has_weight, invoice_id');

    const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
    const invDateMap = new Map();
    if (invoiceIds.length > 0) {
        const { data: invoices } = await supabaseClient
            .from('invoices')
            .select('id, invoice_date')
            .in('id', invoiceIds)
            .gte('invoice_date', startDate.toISOString())
            .lte('invoice_date', endDate.toISOString());
        (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
    }

    // Build delivery map (product â†’ total delivered in period)
    const deliveryMap = new Map();
    const priceMap = new Map();
    (invoiceItems || []).forEach(item => {
        const invDate = invDateMap.get(item.invoice_id);
        if (!invDate) return;

        const qty = parseFloat(item.quantity || 0);
        const price = item.has_weight 
            ? parseFloat(item.price_per_unit || 0)
            : parseFloat(item.unit_price || 0);

        if (!deliveryMap.has(item.product_name)) {
            deliveryMap.set(item.product_name, 0);
            priceMap.set(item.product_name, price);
        }
        deliveryMap.set(item.product_name, deliveryMap.get(item.product_name) + qty);
    });

    // Group submissions by product
    const productMap = new Map();
    (submissions || []).forEach(sub => {
        if (!productMap.has(sub.product_name)) {
            productMap.set(sub.product_name, []);
        }
        productMap.get(sub.product_name).push({
            qty: parseFloat(sub.quantity || 0),
            date: new Date(sub.submission_date),
            type: sub.submission_type
        });
    });

    // Calculate consumption for each product
    const results = [];
    productMap.forEach((entries, productName) => {
        if (entries.length < 2) return; // Need at least 2 data points

        // Sort by date
        entries.sort((a, b) => a.date - b.date);

        const firstStock = entries[0].qty;
        const lastStock = entries[entries.length - 1].qty;
        const delivered = deliveryMap.get(productName) || 0;
        
        // CONSUMPTION FORMULA: Previous Stock + Delivered - Current Stock
        const consumed = firstStock + delivered - lastStock;
        
        if (consumed <= 0) return; // Skip if no consumption

        const unitPrice = priceMap.get(productName) || 0;
        const totalCost = consumed * unitPrice;

        results.push({
            product_name: productName,
            previous_stock: firstStock,
            delivered: delivered,
            current_stock: lastStock,
            consumed: consumed,
            unit_price: unitPrice,
            total_cost: totalCost,
            frequency: entries.length
        });
    });

    consumptionData = results.sort((a, b) => b.consumed - a.consumed);
    renderRonyConsumption();
}

// JULIO: Order frequency tracking (order-based, no stock)
async function loadJulioOrderFrequency(startDate, endDate) {
    // Load inventory_check entries for Julio
    const { data: orders } = await supabaseClient
        .from('inventory_check')
        .select('product_name, tentative, order_date')
        .eq('user', 'julio')
        .gte('order_date', startDate.toISOString().split('T')[0])
        .lte('order_date', endDate.toISOString().split('T')[0])
        .order('order_date', { ascending: true });

    // Get prices from invoice_items
    const { data: priceData } = await supabaseClient
        .from('invoice_items')
        .select('product_name, unit_price, price_per_unit, has_weight');

    const priceMap = new Map();
    (priceData || []).forEach(item => {
        const price = item.has_weight 
            ? parseFloat(item.price_per_unit || 0)
            : parseFloat(item.unit_price || 0);
        if (!priceMap.has(item.product_name)) {
            priceMap.set(item.product_name, price);
        }
    });

    // Group by product
    const productMap = new Map();
    (orders || []).forEach(order => {
        const qty = parseFloat(order.tentative || 0);
        if (qty <= 0) return;

        if (!productMap.has(order.product_name)) {
            productMap.set(order.product_name, {
                total_ordered: 0,
                order_count: 0,
                dates: []
            });
        }
        const entry = productMap.get(order.product_name);
        entry.total_ordered += qty;
        entry.order_count += 1;
        entry.dates.push(new Date(order.order_date));
    });

    // Build results
    const results = [];
    productMap.forEach((data, productName) => {
        const unitPrice = priceMap.get(productName) || 0;
        const totalCost = data.total_ordered * unitPrice;

        results.push({
            product_name: productName,
            total_ordered: data.total_ordered,
            order_count: data.order_count,
            avg_per_order: data.total_ordered / data.order_count,
            unit_price: unitPrice,
            total_cost: totalCost,
            last_order_date: data.dates.sort((a, b) => b - a)[0]
        });
    });

    consumptionData = results.sort((a, b) => b.total_ordered - a.total_ordered);
    renderJulioOrderFrequency();
}

function renderRonyConsumption() {
    const tbody = document.getElementById('consumptionTableBody');
    const header = document.getElementById('consumptionTableHeader');
    
    document.getElementById('consumptionTableTitle').textContent = 'Rony - Stock Consumption Analysis';
    document.getElementById('consumptionCount').textContent = `${consumptionData.length} products`;

    header.innerHTML = `
        <th>Product</th>
        <th>Previous Stock</th>
        <th>+ Delivered</th>
        <th>- Current Stock</th>
        <th>= Consumed</th>
        <th>Unit Price</th>
        <th>Total Cost</th>
    `;

    if (consumptionData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><h3>No Consumption Data</h3></div></td></tr>';
        updateConsumptionSummary(0, 0, 0);
        return;
    }

    tbody.innerHTML = consumptionData.map(item => `
        <tr>
            <td style="font-weight: 600;">${item.product_name}</td>
            <td><span class="price-cell">${item.previous_stock.toFixed(1)}</span></td>
            <td><span class="price-cell" style="color: var(--success-600);">+${item.delivered.toFixed(1)}</span></td>
            <td><span class="price-cell">${item.current_stock.toFixed(1)}</span></td>
            <td><span class="price-cell" style="font-weight: 700; color: var(--primary-700);">${item.consumed.toFixed(1)}</span></td>
            <td><span class="price-cell">$${item.unit_price.toFixed(2)}</span></td>
            <td><span class="price-cell" style="font-weight: 700;">$${item.total_cost.toFixed(2)}</span></td>
        </tr>
    `).join('');

    const totalConsumed = consumptionData.reduce((sum, i) => sum + i.consumed, 0);
    const totalCost = consumptionData.reduce((sum, i) => sum + i.total_cost, 0);
    const avgCost = totalCost / consumptionData.length;

    updateConsumptionSummary(totalConsumed, totalCost, avgCost);
    renderConsumptionCharts();
}

function renderJulioOrderFrequency() {
    const tbody = document.getElementById('consumptionTableBody');
    const header = document.getElementById('consumptionTableHeader');
    
    document.getElementById('consumptionTableTitle').textContent = 'Julio - Order Frequency Analysis';
    document.getElementById('consumptionCount').textContent = `${consumptionData.length} products`;

    header.innerHTML = `
        <th>Product</th>
        <th>Total Ordered</th>
        <th>Order Count</th>
        <th>Avg Per Order</th>
        <th>Unit Price</th>
        <th>Total Cost</th>
        <th>Last Ordered</th>
    `;

    if (consumptionData.length === 0) {
        tbody.innerHTML = '<tr><td colspan="7"><div class="empty-state"><div class="empty-state-icon">ðŸ“Š</div><h3>No Order Data</h3></div></td></tr>';
        updateConsumptionSummary(0, 0, 0);
        return;
    }

    tbody.innerHTML = consumptionData.map(item => `
        <tr>
            <td style="font-weight: 600;">${item.product_name}</td>
            <td><span class="price-cell" style="font-weight: 700;">${item.total_ordered.toFixed(1)}</span></td>
            <td><span class="vendor-badge" style="background: var(--primary-100); color: var(--primary-700);">${item.order_count}x</span></td>
            <td><span class="price-cell">${item.avg_per_order.toFixed(1)}</span></td>
            <td><span class="price-cell">$${item.unit_price.toFixed(2)}</span></td>
            <td><span class="price-cell" style="font-weight: 700;">$${item.total_cost.toFixed(2)}</span></td>
            <td>${formatDate(item.last_order_date.toISOString())}</td>
        </tr>
    `).join('');

    const totalOrdered = consumptionData.reduce((sum, i) => sum + i.total_ordered, 0);
    const totalCost = consumptionData.reduce((sum, i) => sum + i.total_cost, 0);
    const avgCost = totalCost / consumptionData.length;

    updateConsumptionSummary(totalOrdered, totalCost, avgCost);
    renderConsumptionCharts();
}

function updateConsumptionSummary(totalQty, totalCost, avgCost) {
    const container = document.getElementById('consumptionSummary');
    const user = document.getElementById('consumptionUserFilter').value;
    const qtyLabel = user === 'rony' ? 'Total Consumed' : 'Total Ordered';

    container.innerHTML = `
        <div class="metric-card">
            <div class="metric-label">${qtyLabel}</div>
            <div class="metric-value">${totalQty.toFixed(0)}</div>
            <div class="metric-subtitle">Units</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Total Cost</div>
            <div class="metric-value">$${totalCost.toFixed(2)}</div>
            <div class="metric-subtitle">All items</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Average Cost</div>
            <div class="metric-value">$${avgCost.toFixed(2)}</div>
            <div class="metric-subtitle">Per product</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Products</div>
            <div class="metric-value">${consumptionData.length}</div>
            <div class="metric-subtitle">Tracked items</div>
        </div>
    `;
}

function renderConsumptionCharts() {
    const top10 = consumptionData.slice(0, 10);
    const user = document.getElementById('consumptionUserFilter').value;
    const qtyField = user === 'rony' ? 'consumed' : 'total_ordered';

    // Trend Chart
    const trendCtx = document.getElementById('consumptionTrendChart');
    if (consumptionTrendChart) consumptionTrendChart.destroy();
    consumptionTrendChart = new Chart(trendCtx, {
        type: 'bar',
        data: {
            labels: top10.map(i => i.product_name.substring(0, 20)),
            datasets: [{
                label: user === 'rony' ? 'Consumed' : 'Ordered',
                data: top10.map(i => i[qtyField]),
                backgroundColor: 'rgba(59, 130, 246, 0.8)',
                borderColor: 'rgb(59, 130, 246)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });

    // Cost Chart
    const costCtx = document.getElementById('consumptionCostChart');
    if (consumptionCostChart) consumptionCostChart.destroy();
    consumptionCostChart = new Chart(costCtx, {
        type: 'bar',
        data: {
            labels: top10.map(i => i.product_name.substring(0, 20)),
            datasets: [{
                label: 'Total Cost',
                data: top10.map(i => i.total_cost),
                backgroundColor: 'rgba(34, 197, 94, 0.8)',
                borderColor: 'rgb(34, 197, 94)',
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => `$${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        }
    });
}

function filterConsumptionData() {
    // Re-render with search filter
    loadConsumptionData();
}

// ========== INVENTORY VALUATION REPORTS ==========
let valuationChart = null;
let valuationTrendChart = null;

async function loadValuationReport() {
    showLoading(true);
    try {
        const reportType = document.getElementById('valuationReportType').value;
        const groupBy = document.getElementById('valuationGroupBy').value;
        const period = document.getElementById('valuationPeriod').value;

        // Call Edge Function for complex calculations
        const { data, error } = await supabaseClient.functions.invoke('calculate-valuation', {
            body: { reportType, groupBy, period }
        });

        if (error) throw error;

        renderValuationReport(data);

    } catch (error) {
        console.error('Valuation report error:', error);
        
        // Fallback: Calculate client-side if Edge Function fails
        await calculateValuationClientSide();
    } finally {
        showLoading(false);
    }
}

async function calculateValuationClientSide() {
    const reportType = document.getElementById('valuationReportType').value;
    const groupBy = document.getElementById('valuationGroupBy').value;
    
    // Load current stock
    const { data: stockData } = await supabaseClient
        .from('current_stock')
        .select('product_name, quantity_in_stock');
    
    // Load prices from invoice_items
    const { data: priceData } = await supabaseClient
        .from('invoice_items')
        .select('product_name, vendor, category, unit_price, price_per_unit, has_weight');
    
    // Load inventory management for categories
    const { data: mgmtData } = await supabaseClient
        .from('inventory_management')
        .select('product_name, category, par');

    const stockMap = new Map();
    (stockData || []).forEach(item => {
        stockMap.set(item.product_name, parseFloat(item.quantity_in_stock || 0));
    });

    const categoryMap = new Map();
    (mgmtData || []).forEach(item => {
        categoryMap.set(item.product_name, item.category || 'Uncategorized');
    });

    // Calculate valuation
    const valuationMap = new Map();
    (priceData || []).forEach(item => {
        const stock = stockMap.get(item.product_name) || 0;
        if (stock <= 0) return;

        const price = item.has_weight 
            ? parseFloat(item.price_per_unit || 0)
            : parseFloat(item.unit_price || 0);
        
        const value = stock * price;
        const category = categoryMap.get(item.product_name) || 'Uncategorized';
        const key = groupBy === 'category' ? category : (groupBy === 'vendor' ? item.vendor : item.product_name);

        if (!valuationMap.has(key)) {
            valuationMap.set(key, { value: 0, items: 0 });
        }
        const entry = valuationMap.get(key);
        entry.value += value;
        entry.items += 1;
    });

    const results = Array.from(valuationMap.entries()).map(([name, data]) => ({
        name,
        value: data.value,
        items: data.items
    })).sort((a, b) => b.value - a.value);

    renderValuationReport({ results, totalValue: results.reduce((sum, r) => sum + r.value, 0) });
}

function renderValuationReport(data) {
    const tbody = document.getElementById('valuationTableBody');
    const header = document.getElementById('valuationTableHeader');
    const summary = document.getElementById('valuationSummary');

    header.innerHTML = `
        <th>Name</th>
        <th>Items</th>
        <th>Value</th>
        <th>% of Total</th>
    `;

    const totalValue = data.totalValue || 0;
    summary.innerHTML = `
        <div class="metric-card">
            <div class="metric-label">Total Inventory Value</div>
            <div class="metric-value">$${totalValue.toFixed(2)}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Items</div>
            <div class="metric-value">${data.results.length}</div>
        </div>
    `;

    tbody.innerHTML = data.results.map(item => `
        <tr>
            <td style="font-weight: 600;">${item.name}</td>
            <td>${item.items}</td>
            <td><span class="price-cell" style="font-weight: 700;">$${item.value.toFixed(2)}</span></td>
            <td><span class="vendor-badge">${totalValue > 0 ? ((item.value / totalValue) * 100).toFixed(1) : 0}%</span></td>
        </tr>
    `).join('');

    // Render chart
    const ctx = document.getElementById('valuationChart');
    if (valuationChart) valuationChart.destroy();
    valuationChart = new Chart(ctx, {
        type: 'pie',
        data: {
            labels: data.results.map(r => r.name),
            datasets: [{
                data: data.results.map(r => r.value),
                backgroundColor: [
                    '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6',
                    '#ec4899', '#14b8a6', '#f97316', '#06b6d4', '#84cc16'
                ]
            }]
        },
        options: { responsive: true, maintainAspectRatio: false }
    });
}

function exportValuationReport() {
    showAlert('PDF export feature coming soon', 'info');
}

// ========== BUDGET TRACKING ==========
let budgetChart = null;
let budgetData = {};

async function loadBudgetTracking() {
    showLoading(true);
    try {
        const period = document.getElementById('budgetPeriod').value;
        const category = document.getElementById('budgetCategory').value;

        // Call Edge Function
        const { data, error } = await supabaseClient.functions.invoke('track-budget', {
            body: { period, category }
        });

        if (error) throw error;

        renderBudgetTracking(data);

    } catch (error) {
        console.error('Budget tracking error:', error);
        
        // Fallback: Load from budget_settings table
        await loadBudgetClientSide();
    } finally {
        showLoading(false);
    }
}

async function loadBudgetClientSide() {
    const period = document.getElementById('budgetPeriod').value;
    
    // Load budget settings
    const { data: budgets } = await supabaseClient
        .from('budget_settings')
        .select('*')
        .eq('period_type', period);

    // Load actual spending from invoices
    const startDate = new Date();
    if (period === 'weekly') startDate.setDate(startDate.getDate() - 7);
    else if (period === 'monthly') startDate.setMonth(startDate.getMonth() - 1);
    else if (period === 'quarterly') startDate.setMonth(startDate.getMonth() - 3);

    const { data: invoices } = await supabaseClient
        .from('invoices')
        .select('total, category, invoice_date')
        .gte('invoice_date', startDate.toISOString());

    const actualByCategory = {};
    (invoices || []).forEach(inv => {
        const cat = inv.category || 'Uncategorized';
        if (!actualByCategory[cat]) actualByCategory[cat] = 0;
        actualByCategory[cat] += parseFloat(inv.total || 0);
    });

    const results = (budgets || []).map(budget => ({
        category: budget.category,
        budget_amount: parseFloat(budget.amount || 0),
        actual_spend: actualByCategory[budget.category] || 0,
        remaining: parseFloat(budget.amount || 0) - (actualByCategory[budget.category] || 0),
        percent_used: ((actualByCategory[budget.category] || 0) / parseFloat(budget.amount || 1)) * 100
    }));

    const totalBudget = results.reduce((sum, r) => sum + r.budget_amount, 0);
    const totalActual = results.reduce((sum, r) => sum + r.actual_spend, 0);

    renderBudgetTracking({
        summary: {
            total_budget: totalBudget,
            actual_spend: totalActual,
            remaining: totalBudget - totalActual,
            variance: ((totalActual - totalBudget) / totalBudget) * 100
        },
        details: results
    });
}

function renderBudgetTracking(data) {
      // FIX: Add null checks
    const summary = data?.summary || { total_budget: 0, actual_spend: 0, remaining: 0, variance: 0 };
    const details = data?.details || [];
    document.getElementById('budgetTotal').textContent = `$${(summary.total_budget || 0).toFixed(2)}`;
    document.getElementById('budgetActual').textContent = `$${(summary.actual_spend || 0).toFixed(2)}`;
    document.getElementById('budgetRemaining').textContent = `$${(summary.remaining || 0).toFixed(2)}`;
    
    const varianceColor = summary.variance > 0 ? 'var(--error-600)' : 'var(--success-600)';
    const varianceEl = document.getElementById('budgetVariance');
    varianceEl.textContent = `${summary.variance > 0 ? '+' : ''}${(summary.variance || 0).toFixed(1)}%`;
    varianceEl.style.color = varianceColor;

    // Render details table
    const tbody = document.getElementById('budgetDetailsBody');
    tbody.innerHTML = data.details.map(item => {
        const statusColor = item.percent_used > 100 ? 'var(--error-600)' : 
                           item.percent_used > 80 ? '#f59e0b' : 'var(--success-600)';
        const statusIcon = item.percent_used > 100 ? 'ðŸ”´' : 
                          item.percent_used > 80 ? 'ðŸŸ ' : 'ðŸŸ¢';
        
        return `
            <tr>
                <td style="font-weight: 600;">${item.category}</td>
                <td><span class="price-cell">$${item.budget_amount.toFixed(2)}</span></td>
                <td><span class="price-cell">$${item.actual_spend.toFixed(2)}</span></td>
                <td><span class="price-cell" style="color: ${item.remaining < 0 ? 'var(--error-600)' : 'var(--success-600)'};">$${item.remaining.toFixed(2)}</span></td>
                <td><span class="vendor-badge">${item.percent_used.toFixed(1)}%</span></td>
                <td><span class="price-cell">$${(item.actual_spend * 1.1).toFixed(2)}</span></td>
                <td style="color: ${statusColor};">${statusIcon}</td>
            </tr>
        `;
    }).join('');

    // Render chart
    const ctx = document.getElementById('budgetChart');
    if (budgetChart) budgetChart.destroy();
    budgetChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.details.map(d => d.category),
            datasets: [
                {
                    label: 'Budget',
                    data: data.details.map(d => d.budget_amount),
                    backgroundColor: 'rgba(59, 130, 246, 0.5)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2
                },
                {
                    label: 'Actual',
                    data: data.details.map(d => d.actual_spend),
                    backgroundColor: 'rgba(34, 197, 94, 0.5)',
                    borderColor: 'rgb(34, 197, 94)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } }
        }
    });
}

function openSetBudgetModal() {
    showAlert('Budget configuration modal coming soon', 'info');
}

// ========== VENDOR PERFORMANCE SCORECARD ==========
let vendorScoreChart = null;
let vendorPriceCompChart = null;

async function loadVendorPerformance() {
    showLoading(true);
    try {
        const period = document.getElementById('performancePeriod').value;

        // Call Edge Function
        const { data, error } = await supabaseClient.functions.invoke('vendor-performance', {
            body: { period }
        });

        if (error) throw error;

        renderVendorPerformance(data);

    } catch (error) {
        console.error('Vendor performance error:', error);
        
        // Fallback: Calculate client-side
        await calculateVendorPerformanceClientSide();
    } finally {
        showLoading(false);
    }
}

async function calculateVendorPerformanceClientSide() {
    const period = document.getElementById('performancePeriod')?.value || 'month';
    let startDate = new Date();
    if (period === 'month') startDate.setDate(startDate.getDate() - 30);
    else if (period === 'quarter') startDate.setMonth(startDate.getMonth() - 3);
    else if (period === 'year') startDate.setFullYear(startDate.getFullYear() - 1);

    // Load invoices in period
    const { data: invoices } = await supabaseClient
        .from('invoices')
        .select('vendor, invoice_date, total, quality_rating, delivery_rating')
        .gte('invoice_date', startDate.toISOString());

    // Load vendor budgets from budget_settings table
    const { data: budgets } = await supabaseClient
        .from('budget_settings')
        .select('category, amount')
        .eq('period_type', 'monthly');

    // Create budget map by vendor (using category as vendor name for now)
    const budgetMap = {};
    (budgets || []).forEach(b => {
        budgetMap[b.category] = parseFloat(b.amount || 0);
    });

    // Group by vendor
    const vendorStats = {};
    (invoices || []).forEach(inv => {
        if (!vendorStats[inv.vendor]) {
            vendorStats[inv.vendor] = {
                total_orders: 0,
                total_spend: 0,
                quality_ratings: [],
                delivery_ratings: []
            };
        }
        const stats = vendorStats[inv.vendor];
        stats.total_orders += 1;
        stats.total_spend += parseFloat(inv.total || 0);
        if (inv.quality_rating) stats.quality_ratings.push(inv.quality_rating);
        if (inv.delivery_rating) stats.delivery_ratings.push(inv.delivery_rating);
    });

    const results = Object.entries(vendorStats).map(([vendor, stats]) => {
        return {
            vendor,
            total_orders: stats.total_orders,
            total_spend: stats.total_spend,
            budget: budgetMap[vendor] || 0,
            avg_quality: 0,
            avg_delivery: 0,
            overall_score: 0
        };
    }).sort((a, b) => b.total_spend - a.total_spend);

    renderVendorPerformance({ vendors: results });
}

function renderVendorPerformance(data) {
    const container = document.getElementById('vendorPerformanceCards');
    
    container.innerHTML = data.vendors.map(vendor => {
        // Calculate budget data (you'll need to load this from budget_settings table)
        const vendorBudget = vendor.budget || 0;
        const budgetUsedPercent = vendorBudget > 0 ? (vendor.total_spend / vendorBudget) * 100 : 0;
        const remaining = vendorBudget - vendor.total_spend;
        const budgetStatus = budgetUsedPercent > 100 ? 'Over' : budgetUsedPercent > 80 ? 'Warning' : 'Good';
        const statusColor = budgetUsedPercent > 100 ? 'var(--error-600)' : budgetUsedPercent > 80 ? '#f59e0b' : 'var(--success-600)';

        return `
            <div class="alert-card" style="margin-bottom: 1rem;">
                <div style="flex: 1;">
                    <h3 style="margin: 0 0 1rem 0;">${vendor.vendor}</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 1rem;">
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Total Spend</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">$${vendor.total_spend.toFixed(2)}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Budget</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${vendorBudget > 0 ? '$' + vendorBudget.toFixed(2) : 'Not Set'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Budget Used</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${statusColor};">${vendorBudget > 0 ? budgetUsedPercent.toFixed(0) + '%' : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Remaining</div>
                            <div style="font-size: 1.5rem; font-weight: 700; color: ${remaining < 0 ? 'var(--error-600)' : 'var(--success-600)'};">${vendorBudget > 0 ? '$' + remaining.toFixed(2) : 'N/A'}</div>
                        </div>
                        <div>
                            <div style="font-size: 0.75rem; color: var(--neutral-600); text-transform: uppercase;">Total Orders</div>
                            <div style="font-size: 1.5rem; font-weight: 700;">${vendor.total_orders}</div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // Render chart - Budget vs Actual Spending
    const scoreCtx = document.getElementById('vendorScoreChart');
    if (vendorScoreChart) vendorScoreChart.destroy();
    vendorScoreChart = new Chart(scoreCtx, {
        type: 'bar',
        data: {
            labels: data.vendors.map(v => v.vendor),
            datasets: [
                {
                    label: 'Budget',
                    data: data.vendors.map(v => v.budget || 0),
                    backgroundColor: 'rgba(156, 163, 175, 0.5)',
                    borderColor: 'rgb(156, 163, 175)',
                    borderWidth: 2
                },
                {
                    label: 'Actual Spend',
                    data: data.vendors.map(v => v.total_spend),
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderColor: 'rgb(59, 130, 246)',
                    borderWidth: 2
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: { y: { beginAtZero: true } },
            plugins: {
                tooltip: {
                    callbacks: {
                        label: (context) => `${context.dataset.label}: $${context.parsed.y.toFixed(2)}`
                    }
                }
            }
        }
    });
}

function filterVendorPerformance() {
    loadVendorPerformance();
}

// âœ… GLOBAL FUNCTION: Transfer ALL assignments from one user to another
async function transferAllAssignments() {
  const fromUser = document.getElementById('transferFromUser')?.value;
  const toUser = document.getElementById('transferToUser')?.value;

  if (!fromUser || !toUser) {
    showAlert('âš ï¸ Please select both "From" and "To" users.', 'error');
    return;
  }
  if (fromUser === toUser) {
    showAlert('âš ï¸ Source and destination must be different.', 'error');
    return;
  }

  if (!confirm(`Transfer ALL products from ${fromUser.toUpperCase()} to ${toUser.toUpperCase()}?`)) return;

  showLoading(true);
  try {
    const dateISO = document.getElementById('createOrderDate')?.value || todayYMD();

    // Update all records where user = fromUser
    const { data, error } = await supabaseClient
      .from('inventory_check')
      .select('product_name')
      .eq('user', fromUser)
      .eq('order_date', dateISO);

    if (error) throw error;

    const count = data.length;
    if (count === 0) {
      showAlert(`â„¹ï¸ No products found for ${fromUser.toUpperCase()}.`, 'info');
      await loadEnhancedCreateOrder();
      return;
    }

    // Perform the update
    const { error: updateError } = await supabaseClient
      .from('inventory_check')
      .update({ user: toUser })
      .eq('user', fromUser)
      .eq('order_date', dateISO);

    if (updateError) throw updateError;

    showAlert(`âœ… Successfully transferred ${count} products from ${fromUser.toUpperCase()} to ${toUser.toUpperCase()}.`, 'success');
    await loadEnhancedCreateOrder();
  } catch (error) {
    console.error('Transfer failed:', error);
    showAlert('âŒ Transfer failed: ' + (error.message || 'Unknown error'), 'error');
  } finally {
    showLoading(false);
  }
}
// ========== ADD/DELETE PRODUCT FUNCTIONS ==========

// Open Add Product Modal
function openAddProductModal(userType) {
    document.getElementById('addProductModalTitle').textContent = 
        userType === 'julio' ? 'Add Product for Julio' : 'Add Product for Rony';
    document.getElementById('addProductUser').value = userType;
    document.getElementById('addProductForm').reset();
    
    // Show/hide position field based on user type
    const positionGroup = document.getElementById('addProductPositionGroup');
    if (userType === 'rony') {
        positionGroup.style.display = 'block';
        document.getElementById('addProductPosition').required = true;
    } else {
        positionGroup.style.display = 'none';
        document.getElementById('addProductPosition').required = false;
    }
    
    openModal('addProductModal');
}

// Save New Product
async function saveNewProduct(event) {
    event.preventDefault();
    showLoading(true);
    
    try {
        const userType = document.getElementById('addProductUser').value;
        const productName = document.getElementById('addProductName').value.trim();
        const imageUrl = document.getElementById('addProductImage').value.trim() || null;
        const vendor = document.getElementById('addProductVendor').value;
        const category = document.getElementById('addProductCategory').value || null;
        const position = userType === 'rony' ? parseInt(document.getElementById('addProductPosition').value) : null;
        
        // Check if product already exists for this user
        const { data: existing, error: checkError } = await supabaseClient
            .from('inventory_management')
            .select('id, assigned_to')
            .eq('product_name', productName);
        
        if (checkError) throw checkError;
        
        if (existing && existing.length > 0) {
            // Product exists - check if already assigned to this user
            const alreadyAssigned = existing.some(item => {
                const assigned = String(item.assigned_to || '').toLowerCase();
                return assigned.includes(userType);
            });
            
            if (alreadyAssigned) {
                showAlert(`âš ï¸ ${productName} is already assigned to ${userType.toUpperCase()}`, 'error');
                return;
            }
            
            // Product exists but not assigned to this user - add assignment
            const item = existing[0];
            let currentAssigned = [];
            try {
                if (Array.isArray(item.assigned_to)) {
                    currentAssigned = item.assigned_to;
                } else if (typeof item.assigned_to === 'string') {
                    const parsed = JSON.parse(item.assigned_to);
                    currentAssigned = Array.isArray(parsed) ? parsed : [];
                }
            } catch (e) {
                currentAssigned = [];
            }
            
            if (!currentAssigned.includes(userType)) {
                currentAssigned.push(userType);
            }
            
            const { error: updateError } = await supabaseClient
                .from('inventory_management')
                .update({ assigned_to: currentAssigned })
                .eq('id', item.id);
            
            if (updateError) throw updateError;
            
        } else {
            // Product doesn't exist - create new
            const newProduct = {
                product_name: productName,
                image_url: imageUrl,
                vendors: vendor,
                category: category,
                assigned_to: [userType],
                on_hand: 0,
                par: 0
            };
            
            if (userType === 'rony') {
                newProduct.position = position;
            }
            
            const { error: insertError } = await supabaseClient
                .from('inventory_management')
                .insert([newProduct]);
            
            if (insertError) throw insertError;
        }
        
        showAlert(`âœ… ${productName} added to ${userType.toUpperCase()}'s products!`, 'success');
        closeModal('addProductModal');
        
        // Reload the appropriate tab
        if (userType === 'julio') {
            await loadJulioOrders();
        } else {
            await loadRonyOrders();
        }
        
    } catch (error) {
        console.error('Add product error:', error);
        showAlert('âŒ Error adding product: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ========== FIXED DELETE FUNCTIONS ==========

// Delete Product from Julio (FIXED VERSION)
// ========== FIXED: Remove Assignment (Don't Delete Product) ==========
// ========== ENHANCED DELETE WITH DEBUGGING ==========
async function deleteProductFromJulio(productName) {
    if (!confirm(`Remove "${productName}" from Julio's list?`)) return;
    
    showLoading(true);
    try {
        console.log('ðŸ” Original product name:', productName);
        console.log('ðŸ” Product name length:', productName.length);
        console.log('ðŸ” Product name (trimmed):', productName.trim());
        
        // STEP 1: Try exact match first
        let { data: rows, error: fetchError } = await supabaseClient
            .from('inventory_management')
            .select('id, product_name, assigned_to')
            .eq('product_name', productName);
        
        if (fetchError) throw fetchError;
        
        console.log('ðŸ“¦ Exact match found:', rows?.length || 0, 'rows');
        
        // STEP 2: If no exact match, try trimmed version
        if (!rows || rows.length === 0) {
            console.log('âš ï¸ No exact match, trying trimmed version...');
            const trimmedName = productName.trim();
            
            const result = await supabaseClient
                .from('inventory_management')
                .select('id, product_name, assigned_to')
                .eq('product_name', trimmedName);
            
            rows = result.data;
            console.log('ðŸ“¦ Trimmed match found:', rows?.length || 0, 'rows');
        }
        
        // STEP 3: If still no match, do case-insensitive search
        if (!rows || rows.length === 0) {
            console.log('âš ï¸ No trimmed match, trying case-insensitive search...');
            
            const result = await supabaseClient
                .from('inventory_management')
                .select('id, product_name, assigned_to')
                .ilike('product_name', productName);
            
            rows = result.data;
            console.log('ðŸ“¦ Case-insensitive match found:', rows?.length || 0, 'rows');
            
            if (rows && rows.length > 0) {
                console.log('ðŸ“‹ Actual product names in DB:', rows.map(r => `"${r.product_name}"`));
            }
        }
        
        // STEP 4: If STILL no match, list all products assigned to Julio
        if (!rows || rows.length === 0) {
            console.log('âŒ Product not found anywhere! Searching all Julio products...');
            
            const { data: allJulio } = await supabaseClient
                .from('inventory_management')
                .select('product_name, assigned_to');
            
            const julioProducts = allJulio?.filter(p => {
                const assigned = String(p.assigned_to || '').toLowerCase();
                return assigned.includes('julio');
            });
            
            console.log('ðŸ“‹ All Julio products in database:');
            julioProducts?.forEach((p, idx) => {
                console.log(`  ${idx + 1}. "${p.product_name}" (length: ${p.product_name.length})`);
            });
            
            showAlert(`âš ï¸ Product "${productName}" not found in database. Check console for details.`, 'error');
            return;
        }
        
        console.log('âœ… Product found! Processing deletion...');
        
        // Process each matching row
        for (const row of rows) {
            console.log('ðŸ”„ Processing row ID:', row.id, 'Product:', row.product_name);
            
            let assignedArray = [];
            if (Array.isArray(row.assigned_to)) {
                assignedArray = row.assigned_to;
            } else if (typeof row.assigned_to === 'string') {
                try {
                    assignedArray = JSON.parse(row.assigned_to);
                } catch (e) {
                    assignedArray = [];
                }
            }
            
            console.log('ðŸ“‹ Current assignments:', assignedArray);
            
            const newAssigned = assignedArray.filter(user => 
                String(user).toLowerCase() !== 'julio'
            );
            
            console.log('ðŸ“ New assignments:', newAssigned);
            
            if (newAssigned.length === 0) {
                console.log('ðŸ—‘ï¸ Deleting row (no assignments left)');
                const { error: deleteError } = await supabaseClient
                    .from('inventory_management')
                    .delete()
                    .eq('id', row.id);
                
                if (deleteError) throw deleteError;
            } else {
                console.log('âœï¸ Updating assignments');
                const { error: updateError } = await supabaseClient
                    .from('inventory_management')
                    .update({ assigned_to: newAssigned })
                    .eq('id', row.id);
                
                if (updateError) throw updateError;
            }
        }
        
        // Remove from target_inventory
        await supabaseClient
            .from('target_inventory')
            .delete()
            .eq('product_name', productName);
        
        showAlert(`âœ… Product removed successfully`, 'success');
        await loadJulioOrders();
        
    } catch (error) {
        console.error('âŒ Delete error:', error);
        showAlert('âŒ Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// Delete Product from Rony (FIXED VERSION)
// ========== FIXED: Remove Assignment for Rony ==========
async function deleteProductFromRony(productName) {
    if (!confirm(`Remove "${productName}" from Rony's list?\n\nThis will unassign it from Rony but keep the product in the system.`)) return;
    
    showLoading(true);
    try {
        const { data: rows, error: fetchError } = await supabaseClient
            .from('inventory_management')
            .select('id, assigned_to')
            .eq('product_name', productName);
        
        if (fetchError) throw fetchError;
        
        if (!rows || rows.length === 0) {
            showAlert('âš ï¸ Product not found', 'error');
            return;
        }
        
        for (const row of rows) {
            let assignedArray = [];
            
            try {
                if (Array.isArray(row.assigned_to)) {
                    assignedArray = row.assigned_to;
                } else if (typeof row.assigned_to === 'string') {
                    assignedArray = JSON.parse(row.assigned_to);
                }
            } catch (e) {
                assignedArray = [];
            }
            
            const newAssigned = assignedArray.filter(user => user.toLowerCase() !== 'rony');
            
            if (newAssigned.length === 0) {
                await supabaseClient
                    .from('inventory_management')
                    .delete()
                    .eq('id', row.id);
            } else {
                await supabaseClient
                    .from('inventory_management')
                    .update({ assigned_to: newAssigned })
                    .eq('id', row.id);
            }
        }
        
        showAlert(`âœ… ${productName} removed from Rony's list`, 'success');
        
        await supabaseClient
            .from('current_stock')
            .delete()
            .eq('product_name', productName);
        
        await loadRonyOrders();
        
    } catch (error) {
        console.error('âŒ Remove assignment error:', error);
        showAlert('âŒ Error removing product: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// ========== INVOICE NUMBER VALIDATION ==========
let invoiceNumberTimeout;
let isInvoiceNumberValid = false;

async function validateInvoiceNumber(invoiceNumber) {
    const validationDiv = document.getElementById('invoiceNumberValidation');
    const inputField = document.getElementById('invoiceNumber');
    const submitButton = document.querySelector('#invoiceForm button[type="submit"]');
    
    // Clear previous timeout
    clearTimeout(invoiceNumberTimeout);
    
    // Reset if empty
    if (!invoiceNumber || invoiceNumber.trim() === '') {
        validationDiv.innerHTML = '';
        inputField.style.borderColor = '';
        isInvoiceNumberValid = false;
        if (submitButton) submitButton.disabled = false;
        return;
    }
    
    // Show "checking..." message
    validationDiv.innerHTML = '<span style="color: var(--neutral-500);"><i class="fas fa-spinner fa-spin"></i> Checking...</span>';
    inputField.style.borderColor = 'var(--neutral-400)';
    
    // Debounce: wait 500ms after user stops typing
    invoiceNumberTimeout = setTimeout(async () => {
        try {
            // Check if we're editing an existing invoice
            const editId = document.getElementById('invoiceForm').dataset.editId;
            
            // Query database for existing invoice number
            let query = supabaseClient
                .from('invoices')
                .select('id, vendor, invoice_date')
                .eq('invoice_number', invoiceNumber.trim());
            
            // If editing, exclude the current invoice from the check
            if (editId) {
                query = query.neq('id', editId);
            }
            
            const { data, error } = await query;
            
            if (error) throw error;
            
            if (data && data.length > 0) {
                // âŒ DUPLICATE FOUND
                const existing = data[0];
                isInvoiceNumberValid = false;
                inputField.style.borderColor = 'var(--warning-600)';
                inputField.style.background = 'rgba(220, 38, 38, 0.05)';
                validationDiv.innerHTML = `
                    <div style="color: var(--warning-600); font-weight: 600;">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Invoice #${invoiceNumber} already exists!
                    </div>
                    <div style="color: var(--neutral-600); font-size: 0.8125rem; margin-top: 0.25rem;">
                        Vendor: ${existing.vendor} â€¢ Date: ${formatDate(existing.invoice_date)}
                    </div>
                `;
                
                // Disable submit button
                if (submitButton) {
                    submitButton.disabled = true;
                    submitButton.style.opacity = '0.5';
                    submitButton.style.cursor = 'not-allowed';
                }
                
            } else {
                // âœ… UNIQUE - OK TO PROCEED
                isInvoiceNumberValid = true;
                inputField.style.borderColor = 'var(--success-600)';
                inputField.style.background = 'rgba(16, 185, 129, 0.05)';
                validationDiv.innerHTML = `
                    <span style="color: var(--success-600); font-weight: 600;">
                        <i class="fas fa-check-circle"></i> Invoice number available
                    </span>
                `;
                
                // Enable submit button
                if (submitButton) {
                    submitButton.disabled = false;
                    submitButton.style.opacity = '1';
                    submitButton.style.cursor = 'pointer';
                }
            }
            
        } catch (error) {
            console.error('Validation error:', error);
            validationDiv.innerHTML = `
                <span style="color: var(--warning-600);">
                    <i class="fas fa-exclamation-circle"></i> Error checking invoice number
                </span>
            `;
            isInvoiceNumberValid = false;
        }
    }, 500); // Wait 500ms after user stops typing
}




// ========== PDF INVOICE GENERATION (CORPORATE STYLE) ==========
async function generateOrderPDFs() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();
    const { jsPDF } = window.jspdf;
    
    showLoading(true);
    
    try {
        // Load all orders for this date
        const { data: rows, error } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, tentative, user, vendor, item_code')
            .eq('order_date', dateISO);
        
        if (error) throw error;
        
        if (!rows || rows.length === 0) {
            showAlert('âŒ No orders found for this date', 'error');
            return;
        }
        
        // Get product images and prices
        const { data: mgmtData } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url');
        
        const imageMap = new Map();
        (mgmtData || []).forEach(item => {
            imageMap.set(item.product_name, item.image_url);
        });
        
        // Get prices from invoice_items
        const { data: priceData } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, unit_price, price_per_unit, has_weight');
        
        const priceMap = new Map();
        (priceData || []).forEach(item => {
            const key = `${item.product_name}_${item.vendor}`;
            const price = item.has_weight ? item.price_per_unit : item.unit_price;
            priceMap.set(key, parseFloat(price || 0));
        });
        
        // Group by vendor
        const byVendor = {};
        rows.forEach(r => {
            const qty = r.user.toLowerCase() === 'julio' 
                ? Number(r.on_hand || 0) 
                : Number(r.tentative || 0);
            
            if (qty <= 0) return;
            
            const vendor = r.vendor || 'Unknown Vendor';
            if (!byVendor[vendor]) byVendor[vendor] = [];
            
            const priceKey = `${r.product_name}_${vendor}`;
            const unitPrice = priceMap.get(priceKey) || 0;
            
            byVendor[vendor].push({
                product_name: r.product_name,
                item_code: r.item_code || '-------',
                qty: qty,
                unit_price: unitPrice,
                line_total: qty * unitPrice,
                image_url: imageMap.get(r.product_name) || null
            });
        });
        
        const vendors = Object.keys(byVendor);
        if (vendors.length === 0) {
            showAlert('âŒ No items with quantity > 0', 'error');
            return;
        }
        
        // Generate PDF for each vendor
        for (const vendor of vendors) {
            await generateVendorPDF(vendor, byVendor[vendor], dateISO);
            await sleep(200); // Delay between PDFs
        }
        
        showAlert(`âœ… Generated ${vendors.length} PDF invoice(s)`, 'success');
        
    } catch (error) {
        console.error('PDF generation error:', error);
        showAlert('âŒ Error generating PDFs: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// Generate individual vendor PDF
async function generateVendorPDF(vendor, items, dateISO) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter' });
    
    const pageW = doc.internal.pageSize.getWidth();
    const pageH = doc.internal.pageSize.getHeight();
    const M = 42; // margins
    
    // ===== HEADER =====
    let y = M;
    
    // Company logo (left)
    const companyLogo = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg';
    try {
        const logoImg = await toDataUrl(companyLogo);
        if (logoImg.data) {
            doc.addImage(logoImg.data, logoImg.fmt, M, y, 72, 54);
        }
    } catch (e) {
        console.error('Logo load error:', e);
    }
    
    // Vendor logo (right)
    const vendorLogos = {
        'Formosa Foods': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg',
        'North Food Group': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg',
        'Pacific Plus': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg',
        'Delta Office Products': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg',
        'Supermarket': 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg'
    };
    
    if (vendorLogos[vendor]) {
        try {
            const vLogo = await toDataUrl(vendorLogos[vendor]);
            if (vLogo.data) {
                doc.addImage(vLogo.data, vLogo.fmt, pageW - M - 72, y + 6, 72, 42);
            }
        } catch (e) {
            console.error('Vendor logo error:', e);
        }
    }
    
    // Title
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(20);
    doc.text('PURCHASE ORDER', pageW / 2, y + 18, { align: 'center' });
    
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(11);
    doc.text(`Order Date: ${formatDate(dateISO)}`, pageW / 2, y + 36, { align: 'center' });
    
    y += 70;
    
    // ===== VENDOR INFO BOX =====
    doc.setFillColor(247, 249, 252);
    doc.rect(M, y, pageW - 2*M, 50, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(M, y, pageW - 2*M, 50, 'S');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(12);
    doc.text('Vendor:', M + 15, y + 20);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(14);
    doc.text(vendor, M + 15, y + 38);
    
    y += 65;
    
    // ===== PRODUCT TABLE =====
    // Cache product images
    const imgCache = {};
    const uniqueUrls = [...new Set(items.map(r => r.image_url).filter(Boolean))];
    for (const url of uniqueUrls) {
        imgCache[url] = await toDataUrl(url);
    }
    
    const columns = [
        { header: 'Image', dataKey: 'img' },
        { header: 'Item Code', dataKey: 'code' },
        { header: 'Product', dataKey: 'product' },
        { header: 'Qty', dataKey: 'qty' },
        { header: 'Unit Price', dataKey: 'price' },
        { header: 'Total', dataKey: 'total' }
    ];
    
    const body = items.map(item => ({
        img: item.image_url ? { url: item.image_url } : null,
        code: item.item_code,
        product: item.product_name,
        qty: item.qty.toFixed(2),
        price: '$' + item.unit_price.toFixed(2),
        total: '$' + item.line_total.toFixed(2)
    }));
    
    const ink = [17, 24, 39];
    const line = [226, 232, 240];
    const zebra = [247, 249, 252];
    
    doc.autoTable({
        startY: y,
        margin: { left: M, right: M },
        theme: 'grid',
        rowPageBreak: 'auto',
        styles: {
            font: 'helvetica',
            fontSize: 10,
            cellPadding: { top: 6, right: 6, bottom: 6, left: 6 },
            lineColor: line,
            lineWidth: 0.25,
            minCellHeight: 60,
            overflow: 'linebreak'
        },
        headStyles: {
            fillColor: ink,
            textColor: [255, 255, 255],
            fontStyle: 'bold',
            fontSize: 11
        },
        alternateRowStyles: { fillColor: zebra },
        columnStyles: {
            img: { cellWidth: 60, halign: 'center' },
            code: { cellWidth: 100, font: 'courier', fontStyle: 'bold' },
            product: { cellWidth: 'auto' },
            qty: { cellWidth: 60, halign: 'right', fontStyle: 'bold' },
            price: { cellWidth: 80, halign: 'right', font: 'courier' },
            total: { cellWidth: 80, halign: 'right', font: 'courier', fontStyle: 'bold' }
        },
        columns,
        body,
        didParseCell: (data) => {
            if (data.section === 'body' && data.column.dataKey === 'img') {
                data.cell.text = '';
            }
        },
        didDrawCell: (data) => {
            if (data.section === 'body' && data.column.dataKey === 'img') {
                const payload = data.row.raw.img;
                const url = payload?.url;
                const cached = url ? imgCache[url] : null;
                
                if (cached?.data) {
                    const maxW = Math.max(20, data.cell.width - 10);
                    const maxH = Math.max(20, data.cell.height - 10);
                    const size = Math.min(52, maxW, maxH);
                    const x = data.cell.x + (data.cell.width - size) / 2;
                    const yy = data.cell.y + (data.cell.height - size) / 2;
                    
                    try {
                        doc.addImage(cached.data, cached.fmt, x, yy, size, size);
                    } catch (e) {
                        console.error('Image draw error:', e);
                    }
                }
            }
        },
        didDrawPage: () => {
            // Footer
            doc.setFontSize(9);
            doc.setTextColor(99);
            doc.text(`Vendor: ${vendor}`, M, pageH - 14);
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW - M, pageH - 14, { align: 'right' });
        }
    });
    
    // ===== TOTALS SECTION =====
    const finalY = doc.lastAutoTable.finalY + 20;
    const grandTotal = items.reduce((sum, item) => sum + item.line_total, 0);
    
    doc.setFillColor(247, 249, 252);
    doc.rect(pageW - M - 200, finalY, 200, 80, 'F');
    doc.setDrawColor(226, 232, 240);
    doc.rect(pageW - M - 200, finalY, 200, 80, 'S');
    
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(11);
    doc.text('Subtotal:', pageW - M - 185, finalY + 20);
    doc.text('Tax (8.25%):', pageW - M - 185, finalY + 40);
    doc.setFontSize(14);
    doc.text('TOTAL:', pageW - M - 185, finalY + 65);
    
    doc.setFont('courier', 'bold');
    const tax = grandTotal * 0.0825;
    const totalWithTax = grandTotal + tax;
    
    doc.setFontSize(11);
    doc.text('$' + grandTotal.toFixed(2), pageW - M - 15, finalY + 20, { align: 'right' });
    doc.text('$' + tax.toFixed(2), pageW - M - 15, finalY + 40, { align: 'right' });
    doc.setFontSize(14);
    doc.text('$' + totalWithTax.toFixed(2), pageW - M - 15, finalY + 65, { align: 'right' });
    
    // Save PDF
    const safeVendor = vendor.replace(/[^a-zA-Z0-9]/g, '_');
    const safeDate = dateISO.replace(/-/g, '');
    doc.save(`PO_${safeVendor}_${safeDate}.pdf`);
}

// Helper function to convert image URL to base64
async function toDataUrl(url) {
    try {
        const res = await fetch(url);
        const blob = await res.blob();
        return await new Promise(resolve => {
            const fr = new FileReader();
            fr.onloadend = () => resolve({
                data: fr.result,
                fmt: blob.type.includes('png') ? 'PNG' : 'JPEG'
            });
            fr.readAsDataURL(blob);
        });
    } catch (e) {
        console.error('Image load error:', e);
        return { data: null, fmt: 'JPEG' };
    }
}

// Sleep helper
function sleep(ms) {
    return new Promise(resolve => setTimeout(resolve, ms));
}


// â”€â”€ MAIN: GENERATE ALL PDFS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function generateAllVendorPDFs() {
    const orderDate = document.getElementById('pdfOrderDate')?.value || todayYMD();
    const resultsDiv = document.getElementById('pdfGenerationResults');

    showLoading(true);
    resultsDiv.innerHTML = `
        <div style="padding:2rem;text-align:center;color:var(--neutral-600);">
            <div class="spinner" style="margin:0 auto 1rem;"></div>
            <p style="font-size:1.1rem;">Building PDFs â€” please waitâ€¦</p>
        </div>`;

    try {
        // â”€â”€ 1. Load all inventory_check rows for this date â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: orderData, error: orderErr } = await supabaseClient
            .from('inventory_check')
            .select('product_name, on_hand, target, tentative, user, vendor, item_code, image_url')
            .eq('order_date', orderDate);

        if (orderErr) throw orderErr;

        if (!orderData || orderData.length === 0) {
            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“¦</div>
                    <h3>No orders found for ${formatDate(orderDate)}</h3>
                    <p>Make sure inventory counts have been submitted first.</p>
                </div>`;
            return;
        }

        // â”€â”€ 2. Load ALL invoice_items + their invoice dates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const { data: invoiceItems } = await supabaseClient
            .from('invoice_items')
            .select('product_name, vendor, item_code, unit_price, price_per_unit, has_weight, invoice_id');

        const invoiceIds = [...new Set((invoiceItems || []).map(i => i.invoice_id).filter(Boolean))];
        const invDateMap = new Map();
        if (invoiceIds.length > 0) {
            const { data: invoices } = await supabaseClient
                .from('invoices')
                .select('id, invoice_date, vendor')
                .in('id', invoiceIds);
            (invoices || []).forEach(inv => invDateMap.set(inv.id, inv.invoice_date));
        }

        // â”€â”€ 2b. Also load vendor_prices (for item_code lookups) â”€â”€â”€â”€â”€â”€â”€
        const { data: vendorPricesData } = await supabaseClient
            .from('vendor_prices')
            .select('product_name, vendor, item_code, unit_price')
            .order('last_updated', { ascending: false });

        // vendor_prices maps for item_code resolution only
        const vendorPricesMap    = new Map(); // key: `product_name|vendor`
        const vendorPricesAnyVendor = new Map(); // key: product_name â†’ item_code
        (vendorPricesData || []).forEach(row => {
            if (!row.product_name) return;
            const key = `${row.product_name}|${row.vendor}`;
            if (!vendorPricesMap.has(key)) {
                vendorPricesMap.set(key, { item_code: row.item_code || '', unit_price: parseFloat(row.unit_price || 0) });
            }
            if (!vendorPricesAnyVendor.has(row.product_name) && row.item_code) {
                vendorPricesAnyVendor.set(row.product_name, row.item_code);
            }
        });

        // â”€â”€ 2c. Build price maps keyed by item_code â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        // Primary key: `item_code|vendor`  Secondary key: `item_code` (any vendor)
        // For each key we keep the LATEST 2026 date, falling back to latest 2025 date.
        const priceByCode = new Map();       // `item_code|vendor` â†’ { price, date, year }
        const priceByCodeAny = new Map();    // `item_code`        â†’ { price, date, year }

        // Also name-based maps for items without item_codes
        const latestPriceMap = new Map();    // `product_name|vendor` â†’ { price, date, item_code }
        const itemCodeByName = new Map();    // product_name â†’ item_code (any year)

        (invoiceItems || []).forEach(item => {
            // Always capture item_code by product_name (name-based fallback)
            if (item.item_code && item.product_name && !itemCodeByName.has(item.product_name)) {
                itemCodeByName.set(item.product_name, item.item_code);
            }

            const invDate = invDateMap.get(item.invoice_id);
            if (!invDate) return;

            const invYear = new Date(invDate).getFullYear();
            if (invYear !== 2026 && invYear !== 2025) return; // only use 2025+2026 data

            const price = item.has_weight
                ? parseFloat(item.price_per_unit || 0)
                : parseFloat(item.unit_price || 0);
            if (!price) return;

            // â”€â”€ name-based map (2026 only, for name-matched products) â”€â”€
            if (invYear === 2026) {
                const nameKey = `${item.product_name}|${item.vendor}`;
                const ex = latestPriceMap.get(nameKey);
                if (!ex || new Date(invDate) > new Date(ex.date)) {
                    latestPriceMap.set(nameKey, { price, date: invDate, item_code: item.item_code });
                }
            }

            // â”€â”€ item_code-based maps (2026 beats 2025, latest date wins within year) â”€â”€
            if (item.item_code) {
                // by item_code + vendor
                const codeVendorKey = `${item.item_code}|${item.vendor}`;
                const exCV = priceByCode.get(codeVendorKey);
                const betterCV = !exCV
                    || (invYear === 2026 && exCV.year === 2025)
                    || (invYear === exCV.year && new Date(invDate) > new Date(exCV.date));
                if (betterCV) priceByCode.set(codeVendorKey, { price, date: invDate, year: invYear });

                // by item_code only (any vendor)
                const exC = priceByCodeAny.get(item.item_code);
                const betterC = !exC
                    || (invYear === 2026 && exC.year === 2025)
                    || (invYear === exC.year && new Date(invDate) > new Date(exC.date));
                if (betterC) priceByCodeAny.set(item.item_code, { price, date: invDate, year: invYear });
            }
        });

        // â”€â”€ 3. Filter rows that have a qty > 0 and a vendor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const rowsWithQty = orderData.filter(row => {
            const qty = (row.user || '').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || row.target || 0)
                : parseFloat(row.tentative || 0);
            return qty > 0 && row.vendor;
        });

        if (rowsWithQty.length === 0) {
            resultsDiv.innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">ðŸ“‹</div>
                    <h3>No items with quantities and vendors assigned</h3>
                    <p>Set quantities and select vendors in the Create Order tab first.</p>
                </div>`;
            return;
        }

        // â”€â”€ 4. Group by vendor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const byVendor = {};
        rowsWithQty.forEach(row => {
            const qty = (row.user || '').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || row.target || 0)
                : parseFloat(row.tentative || 0);

            // â”€â”€ Resolve item_code first (5-level chain) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            const priceKey = `${row.product_name}|${row.vendor}`;
            const vpEntry   = vendorPricesMap.get(priceKey);
            const nameEntry = latestPriceMap.get(priceKey);   // 2026 name-match

            const resolvedCode = row.item_code
                || vpEntry?.item_code
                || (nameEntry ? nameEntry.item_code : '')
                || itemCodeByName.get(row.product_name)
                || vendorPricesAnyVendor.get(row.product_name)
                || '';

            // â”€â”€ Resolve price via item_code (2026 â†’ 2025) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
            // Priority:
            //   1. item_code + vendor  (invoice, 2026 beats 2025)
            //   2. item_code any vendor (invoice, 2026 beats 2025)
            //   3. product_name + vendor (2026 invoice, name-match)
            //   4. vendor_prices table
            let unitPrice = 0;
            if (resolvedCode) {
                const cv = priceByCode.get(`${resolvedCode}|${row.vendor}`);
                const ca = priceByCodeAny.get(resolvedCode);
                unitPrice = cv?.price || ca?.price || 0;
            }
            if (!unitPrice) {
                unitPrice = nameEntry?.price || vpEntry?.unit_price || 0;
            }

            if (!byVendor[row.vendor]) byVendor[row.vendor] = [];
            byVendor[row.vendor].push({
                product_name: row.product_name,
                item_code:    resolvedCode,
                qty:          qty,
                unit_price:   unitPrice,
                line_total:   qty * unitPrice,
                image_url:    row.image_url || null,
            });
        });

        // â”€â”€ 5. Pre-fetch all images concurrently â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const companyLogoB64 = await fetchImageBase64(COMPANY_LOGO_URL);

        // â”€â”€ 6. Generate one PDF per vendor â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const pdfResults = [];
        const vendors = Object.keys(byVendor).sort();

        for (const vendor of vendors) {
            const items = byVendor[vendor];
            const vendorLogoB64 = await fetchImageBase64(VENDOR_LOGO_URLS[vendor] || null);

            // Pre-fetch product images
            for (const item of items) {
                item._imageB64 = await fetchImageBase64(
                    item.image_url
                        ? (item.image_url.startsWith('http') ? item.image_url : GITHUB_IMAGE_BASE + item.image_url)
                        : null
                );
            }

            const result = await buildVendorPDF(
                vendor, items, orderDate,
                companyLogoB64, vendorLogoB64
            );
            pdfResults.push(result);
        }

        // â”€â”€ 7. Render download links â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        renderPDFResults(resultsDiv, pdfResults, orderDate);
        showAlert(`âœ… ${pdfResults.length} PDF(s) generated!`, 'success');

    } catch (err) {
        console.error('PDF generation error:', err);
        showAlert('âŒ PDF generation failed: ' + err.message, 'error');
        resultsDiv.innerHTML = `<div class="alert alert-error">âŒ Error: ${err.message}</div>`;
    } finally {
        showLoading(false);
    }
}


// â”€â”€ GENERATE UNIQUE-LOOKING INVOICE NUMBER (e.g. KZQ47821) â”€â”€â”€
function generateInvoiceNumber() {
    const letters = 'ABCDEFGHJKLMNPQRSTUVWXYZ'; // no I/O to avoid confusion
    let prefix = '';
    for (let i = 0; i < 3; i++) {
        prefix += letters.charAt(Math.floor(Math.random() * letters.length));
    }
    const digits = String(Math.floor(10000 + Math.random() * 90000)); // 5 digits
    return prefix + digits;
}

// â”€â”€ BUILD A SINGLE VENDOR PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function buildVendorPDF(vendor, items, orderDate, companyLogoB64, vendorLogoB64) {
    // jsPDF must be loaded via CDN in the HTML head:
  

    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({ unit: 'pt', format: 'letter', orientation: 'portrait' });

    const PW = doc.internal.pageSize.getWidth();   // 612
    const PH = doc.internal.pageSize.getHeight();  // 792
    const ML = 36, MR = 36, MT = 36;

    const NAVY   = [10, 22, 40];
    const GOLD   = [245, 158, 11];
    const WHITE  = [255, 255, 255];
    const LGRAY  = [245, 245, 245];
    const MGRAY  = [200, 200, 200];
    const GREEN  = [5, 150, 105];
    const RED    = [220, 38, 38];

    // â”€â”€ HEADER BAND â€” WHITE BACKGROUND â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    doc.setFillColor(255, 255, 255);
    doc.rect(0, 0, PW, 100, 'F');

    // Thin bottom border line under header
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.line(0, 100, PW, 100);

    // Gold accent bar at bottom of header
    doc.setFillColor(245, 158, 11);
    doc.rect(0, 97, PW, 4, 'F');

    // Company logo (left inside header) â€” contained, no overlap
    if (companyLogoB64) {
        try { doc.addImage(companyLogoB64, 'JPEG', ML, 8, 88, 62); } catch (e) {}
    } else {
        doc.setFontSize(18).setTextColor(10, 22, 40).setFont('helvetica', 'bold');
        doc.text('JENG CHI', ML + 5, 48);
    }

    // Vendor logo (right inside header) â€” contained, no overlap
    if (vendorLogoB64) {
        try { doc.addImage(vendorLogoB64, 'JPEG', PW - MR - 95, 12, 95, 58, undefined, 'FAST'); } catch (e) {}
    }

    // Centre: title + date + email
    doc.setTextColor(10, 22, 40);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(18);
    doc.text('ORDER REQUEST', PW / 2, 34, { align: 'center' });
    doc.setFontSize(10).setFont('helvetica', 'normal');
    doc.text(`Order Date: ${formatDate(orderDate)}`, PW / 2, 52, { align: 'center' });
    doc.setFontSize(8.5).setTextColor(80, 80, 80);
    doc.text('admin@jengchirestaurant.com', PW / 2, 67, { align: 'center' });

    // Invoice number â€” random 3-letter + 5-digit (e.g. KZQ47821)
    const invNum = generateInvoiceNumber();
    doc.setFontSize(8.5).setTextColor(10, 22, 40).setFont('helvetica', 'bold');
    doc.text(`Ref #: ${invNum}`, PW / 2, 82, { align: 'center' });

    // â”€â”€ VENDOR INFO STRIPE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let y = 114;
    doc.setFillColor(245, 245, 245);
    doc.rect(ML, y, PW - ML - MR, 30, 'F');
    doc.setDrawColor(200, 200, 200);
    doc.setLineWidth(0.5);
    doc.rect(ML, y, PW - ML - MR, 30, 'S');

    doc.setFillColor(10, 22, 40);
    doc.setFont('helvetica', 'bold');
    doc.setFontSize(10);
    doc.text('VENDOR:', ML + 12, y + 19);
    doc.setFont('helvetica', 'normal').setFontSize(13);
    doc.text(vendor, ML + 62, y + 19);

    y += 44;

    // â”€â”€ PRODUCT TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    // Columns: Image | Item Code | Product Name | Qty | Unit Price | Line Total
    const IMG_W   = 50;
    const CODE_W  = 72;
    const QTY_W   = 42;
    const PRICE_W = 62;
    const TOT_W   = 78;
    const NAME_W  = PW - ML - MR - IMG_W - CODE_W - QTY_W - PRICE_W - TOT_W;
    const ROW_H   = 58;
    const HEADER_H = 24;

    // Table header
    const drawTableHeader = (startY) => {
        doc.setFillColor(10, 22, 40);
        doc.rect(ML, startY, PW - ML - MR, HEADER_H, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(8.5);
        const cols = [
            { label: 'Image',      x: ML + IMG_W / 2,                                 align: 'center' },
            { label: 'Item Code',  x: ML + IMG_W + CODE_W / 2,                        align: 'center' },
            { label: 'Product',    x: ML + IMG_W + CODE_W + NAME_W / 2,               align: 'center' },
            { label: 'Qty',        x: ML + IMG_W + CODE_W + NAME_W + QTY_W / 2,       align: 'center' },
            { label: 'Unit Price', x: ML + IMG_W + CODE_W + NAME_W + QTY_W + PRICE_W / 2, align: 'center' },
            { label: 'Total',      x: ML + IMG_W + CODE_W + NAME_W + QTY_W + PRICE_W + TOT_W / 2, align: 'center' },
        ];
        cols.forEach(col => doc.text(col.label, col.x, startY + 16, { align: col.align }));
        return startY + HEADER_H;
    };

    let tableY = drawTableHeader(y);

    // Draw rows
    let subtotal = 0;
    const usedPageH = PH - 36; // bottom margin

    for (let i = 0; i < items.length; i++) {
        const item = items[i];

        // Page break check
        if (tableY + ROW_H > usedPageH) {
            // Footer on current page
            drawPageFooter(doc, vendor, orderDate, PW, PH, MR);
            doc.addPage();
            y = MT;
            tableY = drawTableHeader(y);
        }

    const rowColor = i % 2 === 0 ? WHITE : LGRAY;
        doc.setFillColor(rowColor[0], rowColor[1], rowColor[2]);
        doc.rect(ML, tableY, PW - ML - MR, ROW_H, 'F');
        doc.setDrawColor(200, 200, 200);
        doc.setLineWidth(0.3);
        doc.rect(ML, tableY, PW - ML - MR, ROW_H, 'S');

        // Vertical dividers
        let divX = ML + IMG_W;
        [CODE_W, NAME_W, QTY_W, PRICE_W, TOT_W].forEach(w => {
            doc.line(divX, tableY, divX, tableY + ROW_H);
            divX += w;
        });

        // Product image
        if (item._imageB64) {
            try {
                const imgSize = 44;
                doc.addImage(
                    item._imageB64, 'JPEG',
                    ML + (IMG_W - imgSize) / 2,
                    tableY + (ROW_H - imgSize) / 2,
                    imgSize, imgSize
                );
            } catch (e) {}
        } else {
            // Placeholder box
            doc.setFillColor(220, 220, 220);
            doc.rect(ML + 3, tableY + 7, 44, 44, 'F');
            doc.setFontSize(7).setTextColor(150, 150, 150).setFont('helvetica', 'italic');
            doc.text('No img', ML + 25, tableY + 32, { align: 'center' });
        }

        // Column x positions
        let cx = ML + IMG_W;

        const cellText = (text, width, align = 'left', bold = false) => {
            doc.setTextColor(10, 22, 40);
            doc.setFont('helvetica', bold ? 'bold' : 'normal');
            const pad = 5;
            const tx = align === 'center' ? cx + width / 2
                      : align === 'right'  ? cx + width - pad
                      : cx + pad;
            // Word-wrap for name column
            const maxW = width - 2 * pad;
            const lines = doc.splitTextToSize(String(text), maxW);
            const lineH = 11;
            const totalH = lines.length * lineH;
            const startTy = tableY + (ROW_H - totalH) / 2 + 9;
            lines.forEach((line, li) => {
                doc.text(line, tx, startTy + li * lineH, { align });
            });
            cx += width;
        };

        // Item code
        doc.setFontSize(8);
        doc.setFont('courier', 'bold');
        doc.setTextColor(10, 22, 40);
        const code = item.item_code || 'â€”';
        doc.text(code, ML + IMG_W + CODE_W / 2, tableY + ROW_H / 2 + 4, { align: 'center' });
        cx = ML + IMG_W + CODE_W;

        // Product name
        doc.setFontSize(8.5).setFont('helvetica', 'normal');
        cellText(item.product_name, NAME_W, 'left');

        // Qty
        doc.setFontSize(10);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(10, 22, 40);
        doc.text(item.qty.toFixed(2), cx + QTY_W / 2, tableY + ROW_H / 2 + 4, { align: 'center' });
        cx += QTY_W;

        // Unit Price
        doc.setFontSize(9).setFont('courier', 'normal');
        const priceStr = item.unit_price > 0 ? `$${item.unit_price.toFixed(2)}` : 'â€”';
        doc.text(priceStr, cx + PRICE_W - 6, tableY + ROW_H / 2 + 4, { align: 'right' });
        cx += PRICE_W;

        // Line total â€” no tax added
        doc.setTextColor(5, 150, 105);
        doc.setFont('courier', 'bold');
        doc.setFontSize(10);
        doc.text(`$${item.line_total.toFixed(2)}`, cx + TOT_W - 6, tableY + ROW_H / 2 + 4, { align: 'right' });

        subtotal   += item.line_total;
        tableY += ROW_H;
    }

    // â”€â”€ TOTALS BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const taxRule2 = VENDOR_TAX_RULES[vendor] || { taxAll: false };
    const hasTax = taxRule2.taxAll || (taxRule2.taxableItemCodes && taxRule2.taxableItemCodes.length > 0);

    // Calculate tax amount
    let totalTaxAmount = 0;
    if (hasTax) {
        items.forEach(item => {
            totalTaxAmount += calcLineTax(vendor, item.item_code, item.line_total);
        });
    }
    const grandTotal = subtotal + totalTaxAmount;

    const TOTBOX_W = 220;
    const showTaxRow = totalTaxAmount > 0;  // only show tax row if there's actual tax
    const TOTBOX_H = showTaxRow ? 72 : 52;

    // Page break check for totals
    if (tableY + TOTBOX_H + 20 > usedPageH) {
        drawPageFooter(doc, vendor, orderDate, PW, PH, MR);
        doc.addPage();
        tableY = MT;
    }

    tableY += 16;
    const totX = PW - MR - TOTBOX_W;

 doc.setFillColor(245, 245, 245);
 doc.rect(totX, tableY, TOTBOX_W, TOTBOX_H, 'F');
   doc.setDrawColor(200, 200, 200);
    doc.rect(totX, tableY, TOTBOX_W, TOTBOX_H, 'S');

    const totRow = (label, value, color, fontSize = 10, bold = false, ty) => {
        doc.setFontSize(fontSize);
        doc.setFont('helvetica', bold ? 'bold' : 'normal');
        doc.setTextColor(10, 22, 40);
        doc.text(label, totX + 12, ty);
        doc.setFont('courier', bold ? 'bold' : 'normal');
        doc.setTextColor(color[0], color[1], color[2]);
        doc.text(value, totX + TOTBOX_W - 12, ty, { align: 'right' });
    };

    let tr = tableY + 18;
    totRow('Subtotal:', `$${subtotal.toFixed(2)}`, NAVY, 10, false, tr);
    tr += 20;
    if (showTaxRow) {
        totRow('Tax (8.25%):', `$${totalTaxAmount.toFixed(2)}`, RED, 10, false, tr);
        tr += 20;
    }
    // Separator line
    doc.setFillColor(10, 22, 40);
    doc.setLineWidth(1);
    doc.line(totX + 8, tr - 6, totX + TOTBOX_W - 8, tr - 6);
    totRow('GRAND TOTAL:', `$${grandTotal.toFixed(2)}`, GREEN, 13, true, tr);

    // Item count summary
    tableY += TOTBOX_H + 12;
    doc.setFontSize(9).setFont('helvetica', 'italic').setTextColor(100, 100, 100);
    doc.text(`${items.length} line item${items.length !== 1 ? 's' : ''} on this order`, ML, tableY);

    // â”€â”€ FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    drawPageFooter(doc, vendor, orderDate, PW, PH, MR);

    // â”€â”€ SAVE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const safeVendor = vendor.replace(/[^a-zA-Z0-9]/g, '_');
    const safeDate   = orderDate.replace(/-/g, '');
    const fileName   = `PO_${safeVendor}_${safeDate}.pdf`;

    const blobUrl = doc.output('bloburl');
    return { vendor, fileName, blobUrl, itemCount: items.length, grandTotal, subtotal, totalTax: totalTaxAmount };
}

// â”€â”€ PAGE FOOTER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawPageFooter(doc, vendor, orderDate, PW, PH, MR) {
    const NAVY = [10, 22, 40];
    const GOLD = [245, 158, 11];
doc.setFillColor(245, 158, 11);
    doc.rect(0, PH - 42, PW, 3, 'F');
    doc.setFillColor(10, 22, 40);
    doc.rect(0, PH - 39, PW, 39, 'F');

    doc.setTextColor(255, 255, 255);
    doc.setFont('helvetica', 'normal');
    doc.setFontSize(8);

    doc.text('JENG CHI RESTAURANT  â€¢  Order Request', 40, PH - 24);
    doc.text(`${vendor}  â€¢  ${formatDate(orderDate)}`, PW - MR, PH - 24, { align: 'right' });
    doc.text(
        `Page ${doc.internal.getNumberOfPages()}`,
        PW / 2, PH - 24, { align: 'center' }
    );

    // Disclaimer line
    doc.setFontSize(6.5).setTextColor(180, 180, 180);
    doc.text(
        'ORDER REQUEST: This document is issued by Jeng Chi Restaurant to the vendor listed above and represents a request to place an order. ' +
        'It is not an invoice. Prices shown are based on current vendor pricing and may be subject to change. ' +
        'Please confirm availability and final pricing. Questions? Contact admin@jengchirestaurant.com.',
        PW / 2, PH - 9, { align: 'center', maxWidth: PW - 80 }
    );
}

// â”€â”€ RENDER DOWNLOAD UI â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPDFResults(container, results, orderDate) {
    const NAVY = '#0a1628';
    const html = `
        <div style="background:white;border-radius:16px;box-shadow:var(--shadow-lg);overflow:hidden;margin-top:1rem;">
            <!-- Header -->
            <div style="background:${NAVY};padding:1.5rem 2rem;display:flex;justify-content:space-between;align-items:center;">
                <h3 style="color:white;font-size:1.375rem;margin:0;display:flex;align-items:center;gap:0.75rem;">
                    <i class="fas fa-file-pdf"></i>
                    ${results.length} Order Request PDF${results.length !== 1 ? 's' : ''} Ready
                </h3>
                <button onclick="downloadAllPDFsNew()" class="btn" style="background:var(--accent-500);color:white;padding:0.75rem 1.5rem;font-size:0.9375rem;">
                    <i class="fas fa-download"></i> Download All
                </button>
            </div>

            <!-- Cards -->
            <div style="padding:1.5rem;display:grid;gap:1rem;">
                ${results.map((r, idx) => `
                    <div style="display:flex;justify-content:space-between;align-items:center;
                                padding:1.25rem 1.5rem;background:var(--neutral-50);
                                border-radius:10px;border:2px solid var(--neutral-200);">
                        <div>
                            <div style="font-weight:700;font-size:1.125rem;color:var(--neutral-900);margin-bottom:0.3rem;">
                                ${r.vendor}
                            </div>
                            <div style="font-size:0.875rem;color:var(--neutral-600);">
                                ${r.itemCount} items &nbsp;â€¢&nbsp;
                                Subtotal: <strong>$${r.subtotal.toFixed(2)}</strong>
                                ${r.totalTax > 0 ? `&nbsp;â€¢&nbsp; Tax: <strong style="color:#dc2626;">$${r.totalTax.toFixed(2)}</strong>` : ''}
                                &nbsp;â€¢&nbsp;
                                <strong style="color:var(--success-600);font-family:var(--font-mono);">
                                    Total: $${r.grandTotal.toFixed(2)}
                                </strong>
                            </div>
                        </div>
                        <a href="${r.blobUrl}" download="${r.fileName}"
                           class="btn btn-success" style="text-decoration:none;white-space:nowrap;">
                            <i class="fas fa-download"></i> Download
                        </a>
                    </div>`).join('')}
            </div>

            <!-- Grand summary -->
            <div style="padding:1.5rem 2rem;border-top:2px solid var(--neutral-200);
                        background:var(--neutral-50);display:flex;justify-content:flex-end;">
                <div style="text-align:right;">
                    <div style="font-size:0.875rem;color:var(--neutral-600);margin-bottom:0.25rem;">Combined Grand Total</div>
                    <div style="font-size:2rem;font-weight:700;font-family:var(--font-mono);color:var(--success-600);">
                        $${results.reduce((s, r) => s + r.grandTotal, 0).toFixed(2)}
                    </div>
                </div>
            </div>
        </div>`;

    container.innerHTML = html;
    // Store for "Download All" button
    window._generatedPDFsNew = results;
}


function downloadAllPDFsNew() {
    const pdfs = window._generatedPDFsNew || [];
    if (!pdfs.length) { showAlert('No PDFs to download', 'error'); return; }
    pdfs.forEach((pdf, i) => {
        setTimeout(() => {
            const a = document.createElement('a');
            a.href = pdf.blobUrl;
            a.download = pdf.fileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }, i * 600);
    });
    showAlert(`ðŸ“¥ Downloading ${pdfs.length} PDFsâ€¦`, 'success');
}



// Download all PDFs at once
function downloadAllPDFs() {
    if (!window.generatedPDFs || window.generatedPDFs.length === 0) {
        showAlert('No PDFs to download', 'error');
        return;
    }
    
    window.generatedPDFs.forEach((pdf, index) => {
        setTimeout(() => {
            const link = document.createElement('a');
            link.href = pdf.url;
            link.download = pdf.fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }, index * 500); // Stagger downloads by 500ms
    });
    
    showAlert(`ðŸ“¥ Downloading ${window.generatedPDFs.length} PDF(s)...`, 'success');
}

// Initialize PDF date to today
document.addEventListener('DOMContentLoaded', () => {
    const pdfDateInput = document.getElementById('pdfOrderDate');
    if (pdfDateInput) {
        pdfDateInput.value = todayYMD();
    }
});



// Client-side HTML to PDF conversion (fallback)
async function generatePDFFromHTML(html, vendor, orderDate) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF({
        unit: 'pt',
        format: 'letter'
    });
    
    // Create temporary div
    const tempDiv = document.createElement('div');
    tempDiv.innerHTML = html;
    tempDiv.style.width = '8.5in';
    tempDiv.style.padding = '0.5in';
    document.body.appendChild(tempDiv);
    
    try {
        await doc.html(tempDiv, {
            callback: function (doc) {
                // Clean up
                document.body.removeChild(tempDiv);
            },
            x: 0,
            y: 0,
            width: 612, // Letter width in pts
            windowWidth: 816 // 8.5in * 96dpi
        });
        
        // Convert to blob URL
        const pdfBlob = doc.output('blob');
        const pdfUrl = URL.createObjectURL(pdfBlob);
        
        return pdfUrl;
    } catch (error) {
        document.body.removeChild(tempDiv);
        throw error;
    }
}

// Initialize PDF date to today
document.addEventListener('DOMContentLoaded', () => {
    const pdfDateInput = document.getElementById('pdfOrderDate');
    if (pdfDateInput) {
        pdfDateInput.value = todayYMD();
    }
});

// ========== EDIT ORDER TAB FUNCTIONS ==========
async function loadEditOrder() {
    const dateISO = document.getElementById('editOrderDate').value || todayYMD();
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO);
        if (error) throw error;

        const submitted = (data || []).filter(r => r.tentative > 0 || r.vendor);
        const unsubmitted = (data || []).filter(r => !r.tentative && !r.vendor);

        document.getElementById('submittedCount').textContent = submitted.length;
        document.getElementById('unsubmittedCount').textContent = unsubmitted.length;

        renderEditOrderTable('submittedOrdersBody', submitted);
        renderEditOrderTable('unsubmittedProductsBody', unsubmitted);
    } catch (error) {
        showAlert('Error loading order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function renderEditOrderTable(tbodyId, rows) {
    const tbody = document.getElementById(tbodyId);
    if (!rows.length) {
        tbody.innerHTML = '<tr><td colspan="6" style="text-align:center;padding:2rem;color:var(--neutral-500);">No items</td></tr>';
        return;
    }
    tbody.innerHTML = rows.map(row => {
        const imageUrl = resolveImage(row.image_url);
        const productId = (row.product_name || '').replace(/[^a-zA-Z0-9]/g, '_');
        return `
            <tr>
                <td><img src="${imageUrl}" onerror="this.src='${PLACEHOLDER_IMAGE}'"
                    style="width:60px;height:60px;object-fit:cover;border-radius:6px;"></td>
                <td><span class="item-number">${row.item_code || 'â€”'}</span></td>
                <td style="font-weight:600;">${row.product_name}</td>
                <td>
                    <input type="number" value="${row.tentative || ''}" min="0" step="0.01"
                           placeholder="0"
                           onblur="updateTentative('${row.id}', this.value)"
                           class="search-input" style="width:90px;text-align:center;font-family:var(--font-mono);font-weight:700;">
                </td>
                <td>
                    <select onchange="selectVendorAndUpdateItemCode('${row.id}','${(row.product_name||'').replace(/'/g,"\\'")}',this.value)"
                            class="search-input" style="min-width:160px;">
                        <option value="">â€” Select â€”</option>
                        ${['Pacific Plus','Formosa Foods','North Food Group','BakeMark','Autochlor','Delta Office Products']
                            .map(v => `<option value="${v}" ${row.vendor===v?'selected':''}>${v}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <button class="btn btn-danger btn-icon" onclick="deleteProductFromPlaceOrder('${row.id}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>`;
    }).join('');
}

async function updateEditedOrder() {
    showAlert('âœ… All edits are auto-saved as you type. No additional action needed.', 'success');
}

// ========== FINAL ORDER TAB FUNCTIONS ==========
async function loadFinalOrderPreview() {
    const dateISO = document.getElementById('finalOrderDate').value || todayYMD();
    showLoading(true);
    try {
        const { data, error } = await supabaseClient
            .from('inventory_check')
            .select('*')
            .eq('order_date', dateISO);
        if (error) throw error;

        const byVendor = {};
        (data || []).forEach(row => {
            const qty = (row.user||'').toLowerCase() === 'julio'
                ? parseFloat(row.on_hand || 0)
                : parseFloat(row.tentative || 0);
            if (qty <= 0 || !row.vendor) return;
            if (!byVendor[row.vendor]) byVendor[row.vendor] = [];
            byVendor[row.vendor].push({ ...row, displayQty: qty });
        });

        const container = document.getElementById('vendorSummaryContainer');
        if (Object.keys(byVendor).length === 0) {
            container.innerHTML = `<div class="empty-state"><div class="empty-state-icon">ðŸ“‹</div><h3>No items with quantities assigned to vendors</h3></div>`;
            return;
        }

        container.innerHTML = Object.entries(byVendor).map(([vendor, items]) => `
            <div class="vendor-card" style="margin-bottom:2rem;">
                <div class="vendor-card-header">
                    <div>
                        <div class="vendor-card-title">${vendor}</div>
                        <div style="color:var(--neutral-600);margin-top:0.5rem;">${items.length} items</div>
                    </div>
                    <div class="vendor-total-card">
                        <div class="vendor-total-label">Items to Order</div>
                        <div class="vendor-total-value">${items.length}</div>
                    </div>
                </div>
                <table class="data-table">
                    <thead><tr><th>Item Code</th><th>Product</th><th>Qty</th><th>User</th></tr></thead>
                    <tbody>
                        ${items.map(item => `
                            <tr>
                                <td><span class="item-number">${item.item_code||'â€”'}</span></td>
                                <td>${item.product_name}</td>
                                <td><span class="price-cell">${item.displayQty.toFixed(2)}</span></td>
                                <td>${item.user}</td>
                            </tr>`).join('')}
                    </tbody>
                </table>
            </div>`).join('');
    } catch (error) {
        showAlert('Error loading preview: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

async function generateFinalPDFs() {
    const dateISO = document.getElementById('finalOrderDate').value || todayYMD();
    const pdfInput = document.getElementById('pdfOrderDate');
    if (pdfInput) pdfInput.value = dateISO;
    await generateAllVendorPDFs();
}






// ========== SAFE STRING ESCAPE FOR HTML ATTRIBUTES ==========
function escAttr(str) {
    return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
}



// ========== ADD THIS NEW FUNCTION (place it before initializeEnhancedPlaceOrder) ==========
async function syncInventoryCheck(dateISO) {
    try {
        console.log('ðŸ”„ Syncing inventory_check for date:', dateISO);

        // 1. Load all products from inventory_management
        const { data: mgmtProducts, error: mgmtError } = await supabaseClient
            .from('inventory_management')
            .select('product_name, image_url, par, position, assigned_to');

        if (mgmtError) throw mgmtError;

        // 2. Load Rony's stock counts for this date
        const { data: stockData, error: stockError } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock')
            .eq('stock_date', dateISO);

        if (stockError) throw stockError;

        // 3. Load Julio's targets for this date
        const { data: targetData, error: targetError } = await supabaseClient
            .from('target_inventory')
            .select('product_name, target_quantity')
            .eq('order_date', dateISO);

        if (targetError) throw targetError;

        // 4. Build lookup maps
        const stockMap = new Map();
        (stockData || []).forEach(s => stockMap.set(s.product_name, s.quantity_in_stock));

        const targetMap = new Map();
        (targetData || []).forEach(t => targetMap.set(t.product_name, t.target_quantity));

        console.log('ðŸ“¦ Stock entries:', stockMap.size, '| Target entries:', targetMap.size);

        // 5. Build upsert rows
        const rows = [];

        // âœ… Track seen product+user combos to avoid duplicates
        const seen = new Set();

        (mgmtProducts || []).forEach(product => {
            const name = product.product_name || '';
            if (!name) return;

            // âœ… FIXED: Handle assigned_to as plain STRING (e.g. 'Rony') 
            // OR array OR JSON string
            let assignedArray = [];
            const raw = product.assigned_to;

            if (Array.isArray(raw)) {
                assignedArray = raw;
            } else if (typeof raw === 'string') {
                const trimmed = raw.trim();
                // Try JSON parse first
                if (trimmed.startsWith('[')) {
                    try {
                        const parsed = JSON.parse(trimmed);
                        assignedArray = Array.isArray(parsed) ? parsed : [trimmed];
                    } catch (e) {
                        assignedArray = [trimmed];
                    }
                } else {
                    // Plain string like 'Rony' or 'Julio'
                    assignedArray = [trimmed];
                }
            }

         assignedArray.forEach(user => {
    const userNormalized = normalizeUser(user);
    
    // âœ… Skip null/unrecognized users â€” won't violate constraint
    if (!userNormalized) return;

    // âœ… Skip duplicates
    const key = `${name}__${userNormalized}`;
    if (seen.has(key)) return;
    seen.add(key);

    let on_hand = 0;
    let target = 0;

    const userLower = userNormalized.toLowerCase();

    if (userLower === 'rony') {
        on_hand = parseFloat(stockMap.get(name) || 0);
        target = parseFloat(product.par || 0);
    } else if (userLower === 'julio') {
        on_hand = parseFloat(targetMap.get(name) || 0);
        target = parseFloat(targetMap.get(name) || 0);
    } else if (userLower === 'office') {
        on_hand = parseFloat(stockMap.get(name) || targetMap.get(name) || 0);
        target = parseFloat(product.par || 0);
    }

    rows.push({
        order_date: dateISO,
        product_name: name,
        user: userNormalized,  // âœ… Always 'Rony', 'Julio', or 'Office'
        on_hand: on_hand,
        target: target,
        image_url: product.image_url || null
    });
});
        });

        console.log('ðŸ“ Rows to upsert into inventory_check:', rows.length);

        if (rows.length === 0) {
            console.log('âš ï¸ No products found to sync');
            return 0;
        }

        // 6. Upsert in batches of 50 to avoid payload limits
        const batchSize = 50;
        for (let i = 0; i < rows.length; i += batchSize) {
            const batch = rows.slice(i, i + batchSize);
            const { error: upsertError } = await supabaseClient
                .from('inventory_check')
                .upsert(batch, {
                    onConflict: 'order_date,product_name,user',
                    ignoreDuplicates: false
                });

            if (upsertError) {
                console.error('âŒ Upsert error on batch', i, upsertError);
                throw upsertError;
            }
        }

        console.log('âœ… Synced', rows.length, 'rows into inventory_check');
        return rows.length;

    } catch (error) {
        console.error('âŒ syncInventoryCheck error:', error);
        throw error;
    }
}

// ========== REPLACE your existing initializeEnhancedPlaceOrder with this ==========
async function initializeEnhancedPlaceOrder() {
    loadJsPDF();

    const today = todayYMD();
    document.getElementById('createOrderDate').value = today;
    document.getElementById('editOrderDate').value = today;
    document.getElementById('finalOrderDate').value = today;

    const vendorOptions = ALLOWED_VENDORS.map(v => `<option value="${v}">${v}</option>`).join('');
    document.getElementById('createVendorFilter').innerHTML = '<option value="">â€” All Vendors â€”</option>' + vendorOptions;

    await buildVendorCodeMap();

    // âœ… SYNC FIRST, then load
    const dateISO = document.getElementById('createOrderDate').value || today;
    await syncAndLoad(dateISO);
}


// ========== ADD THIS HELPER (sync + load in one call) ==========
async function syncAndLoad(dateISO) {
    showLoading(true);
    try {
        const synced = await syncInventoryCheck(dateISO);
        console.log('âœ… Sync complete:', synced, 'rows');
        await loadEnhancedCreateOrder();
    } catch (error) {
        console.error('Sync error:', error);
        showAlert('Error syncing data: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}


// ========== REPLACE your existing date change listener with this ==========
// Find: document.addEventListener('change', (e) => {
//     if (e.target && e.target.id === 'createOrderDate') {
//         loadEnhancedCreateOrder();
//     }
// });
// REPLACE WITH:
document.addEventListener('change', (e) => {
    if (e.target && e.target.id === 'createOrderDate') {
        const dateISO = e.target.value;
        syncAndLoad(dateISO);
    }
});



// âœ… ADD THIS HELPER before syncInventoryCheck
function normalizeUser(user) {
    const u = (user || '').trim().toLowerCase();
    if (u === 'rony')   return 'Rony';
    if (u === 'julio')  return 'Julio';
    if (u === 'office') return 'Office';
    return null; // âœ… Return null for anything unrecognized
}




async function submitAndMarkOrder() {
    const dateISO = document.getElementById('createOrderDate').value || todayYMD();

    // Collect all current card states from the DOM
    const cards = document.querySelectorAll('.enhanced-order-card');

    if (cards.length === 0) {
        showAlert('âŒ No products loaded. Please load an order first.', 'error');
        return;
    }

    // Build list of items that have a qty > 0 OR a vendor selected
    const orderItems = [];
    cards.forEach(card => {
        const productName = card.dataset.product;
        const userType    = card.dataset.user;
        const productId   = (productName || '').replace(/[^a-zA-Z0-9]/g, '_');

        const qtyInput    = document.getElementById(`qty-${productId}`);
        const vendorInput = document.getElementById(`vendor-${productId}`);
        const codeInput   = document.getElementById(`itemcode-input-${productId}`);

        const qty    = parseFloat(qtyInput?.value  || 0);
        const vendor = vendorInput?.value || '';
        const code   = codeInput?.value   || '';

        if (qty > 0 || vendor) {
            orderItems.push({
                product_name: productName,
                user:         userType,
                quantity:     qty,
                vendor:       vendor || null,
                item_code:    code   || null
            });
        }
    });

    if (orderItems.length === 0) {
        showAlert('âŒ No items have quantities or vendors set. Fill in the order first.', 'error');
        return;
    }

    if (!confirm(`Submit order with ${orderItems.length} item(s) for ${formatDate(dateISO)}?`)) return;

    showLoading(true);
    try {
        // â”€â”€ STEP 1: Save / update every item in inventory_check â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        for (const item of orderItems) {
            await supabaseClient
                .from('inventory_check')
                .update({
                    tentative:  item.quantity,
                    vendor:     item.vendor,
                    item_code:  item.item_code
                })
                .eq('order_date',    dateISO)
                .eq('product_name',  item.product_name)
                .eq('user',          item.user   === 'rony' ? 'Rony'
                                   : item.user   === 'julio' ? 'Julio'
                                   : item.user   === 'office' ? 'Office'
                                   : item.user);
        }

        // â”€â”€ STEP 2: Write to submitted_orders table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const submittedAt = new Date().toISOString();

        const submissionRows = orderItems.map(item => ({
            order_date:      dateISO,
            submitted_at:    submittedAt,
            submitted_by:    'office',          // person placing the final order
            product_name:    item.product_name,
            quantity:        item.quantity,
            vendor:          item.vendor,
            item_code:       item.item_code,
            user_section:    item.user          // 'rony' | 'julio' | 'office'
        }));

        const { error: insertError } = await supabaseClient
            .from('submitted_orders')
            .insert(submissionRows);

        if (insertError) {
            // Table may not exist yet â€” log but don't block
            console.warn('submitted_orders insert warning:', insertError.message);
        }

        // â”€â”€ STEP 3: Also write to inventory_submissions (history) â”€â”€â”€â”€â”€â”€â”€â”€â”€
        const historyRows = orderItems.map(item => ({
            submission_date: submittedAt,
            submitted_by:    'office',
            product_name:    item.product_name,
            quantity:        item.quantity,
            submission_type: 'place_order',
            notes:           `Order for ${dateISO} | Vendor: ${item.vendor || 'TBD'}`
        }));

        await supabaseClient
            .from('inventory_submissions')
            .insert(historyRows);

        // â”€â”€ STEP 4: Send email notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        let emailMsg = '';
        try {
            const emailPayload = {
                submittedBy: 'office',
                orderDate:   dateISO,
                items: orderItems.map(i => ({
                    product_name: i.product_name,
                    quantity:     i.quantity,
                    vendor:       i.vendor || 'TBD',
                    item_code:    i.item_code || '',
                    notes:        `Section: ${i.user}`
                }))
            };

            const resp = await fetch(
                `${SUPABASE_URL}/functions/v1/send-order-notification`,
                {
                    method:  'POST',
                    headers: {
                        'Content-Type':  'application/json',
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    },
                    body: JSON.stringify(emailPayload)
                }
            );

            const result = await resp.json();
            emailMsg = result.success
                ? ' ðŸ“§ Email notification sent!'
                : ` (Email failed: ${result.error})`;

        } catch (emailErr) {
            console.error('Email send error:', emailErr);
            emailMsg = ' (Email could not be sent)';
        }

        // â”€â”€ STEP 5: Success message â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        showAlert(
            `âœ… Order submitted successfully! ${orderItems.length} items saved for ${formatDate(dateISO)}.${emailMsg}`,
            'success'
        );

        // Reload the cards to reflect saved state
        await loadEnhancedCreateOrder();

    } catch (error) {
        console.error('submitAndMarkOrder error:', error);
        showAlert('âŒ Error submitting order: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

// ========== OFFICE ORDERS FUNCTIONS ==========
let officeOrdersData = [];

async function loadOfficeOrders() {
    showLoading(true);
    try {
        const orderDate = document.getElementById('officeOrderDate')?.value || todayYMD();
        
        // Load products assigned to 'office'
        const { data, error } = await supabaseClient
            .from('inventory_management')
            .select('product_name, par, vendors, category, image_url, assigned_to')
            .ilike('assigned_to', '%office%');

        if (error) throw error;

        // Load current stock
        const { data: stockData } = await supabaseClient
            .from('current_stock')
            .select('product_name, quantity_in_stock');

        const stockMap = new Map();
        (stockData || []).forEach(item => {
            stockMap.set(item.product_name, parseFloat(item.quantity_in_stock || 0));
        });

        // Load existing orders for this date
        const { data: existingOrders } = await supabaseClient
            .from('inventory_check')
            .select('product_name, tentative')
            .eq('user', 'office')
            .eq('order_date', orderDate);

        const orderMap = new Map();
        (existingOrders || []).forEach(order => {
            orderMap.set(order.product_name, parseFloat(order.tentative || 0));
        });

        // Get latest prices
        const { data: priceData } = await supabaseClient
            .from('invoice_items')
            .select('product_name, unit_price, price_per_unit, has_weight');

        const priceMap = new Map();
        (priceData || []).forEach(item => {
            const price = item.has_weight 
                ? parseFloat(item.price_per_unit || 0)
                : parseFloat(item.unit_price || 0);
            if (!priceMap.has(item.product_name)) {
                priceMap.set(item.product_name, price);
            }
        });

        officeOrdersData = (data || []).map(item => ({
            product_name: item.product_name,
           vendor: item.vendors,
            par: parseFloat(item.par || 0),
            current_stock: stockMap.get(item.product_name) || 0,
            order_qty: orderMap.get(item.product_name) || 0,
            unit_price: priceMap.get(item.product_name) || 0,
            category: item.category
        }));

        renderOfficeOrders();

    } catch (error) {
        console.error('Load office orders error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function renderOfficeOrders() {
    const tbody = document.getElementById('officeOrdersTableBody');
    document.getElementById('officeProductCount').textContent = `${officeOrdersData.length} products`;

    tbody.innerHTML = officeOrdersData.map((item, idx) => {
        const total = item.order_qty * item.unit_price;
        return `
            <tr>
                <td style="font-weight: 600;">${item.product_name}</td>
                <td><span class="vendor-badge">${item.vendor || 'N/A'}</span></td>
                <td><span class="price-cell">${item.current_stock.toFixed(1)}</span></td>
                <td>
                    <input type="number" 
                        value="${item.order_qty}" 
                        onchange="updateOfficeOrderQty(${idx}, this.value)"
                        style="width: 100px; padding: 0.5rem; border: 2px solid var(--neutral-300); border-radius: 8px;"
                        min="0" step="0.1">
                </td>
                <td><span class="price-cell">$${item.unit_price.toFixed(2)}</span></td>
                <td><span class="price-cell" style="font-weight: 700;">$${total.toFixed(2)}</span></td>
                <td>
                    <button class="btn btn-sm btn-secondary" onclick="updateOfficeOrderQty(${idx}, 0)">Clear</button>
                </td>
            </tr>
        `;
    }).join('');
}

function updateOfficeOrderQty(idx, qty) {
    officeOrdersData[idx].order_qty = parseFloat(qty || 0);
    renderOfficeOrders();
}

async function saveOfficeOrders() {
    showLoading(true);
    try {
        const orderDate = document.getElementById('officeOrderDate')?.value || todayYMD();
        
        const ordersToSave = officeOrdersData
            .filter(item => item.order_qty > 0)
            .map(item => ({
                product_name: item.product_name,
                vendor: item.vendor,
                user: 'office',
                tentative: item.order_qty,
                order_date: orderDate
            }));

        if (ordersToSave.length === 0) {
            showAlert('No items to save', 'warning');
            return;
        }

        // Delete existing orders for this date
        await supabaseClient
            .from('inventory_check')
            .delete()
            .eq('user', 'office')
            .eq('order_date', orderDate);

        // Insert new orders
        const { error } = await supabaseClient
            .from('inventory_check')
            .insert(ordersToSave);

        if (error) throw error;

        showAlert(`âœ… Saved ${ordersToSave.length} office orders`, 'success');

    } catch (error) {
        console.error('Save office orders error:', error);
        showAlert('Error: ' + error.message, 'error');
    } finally {
        showLoading(false);
    }
}

function clearOfficeOrders() {
    if (!confirm('Clear all office orders?')) return;
    officeOrdersData.forEach(item => item.order_qty = 0);
    renderOfficeOrders();
}

function filterOfficeProducts() {
    // Implement if needed
    renderOfficeOrders();
}



function updateConsumptionPeriods() {
    updateWeekOptions();
}

function updateWeekOptions() {
    const year = parseInt(document.getElementById('consumptionYear').value);
    const monthSelect = document.getElementById('consumptionMonth');
    const weekSelect = document.getElementById('consumptionWeeks');
    
    const selectedMonths = Array.from(monthSelect.selectedOptions).map(o => parseInt(o.value));
    
    weekSelect.innerHTML = '';
    
    selectedMonths.forEach(month => {
        const monthName = monthSelect.querySelector(`option[value="${month}"]`).text;
        const weeksInMonth = getWeeksInMonth(year, month);
        
        weeksInMonth.forEach((week, idx) => {
            const opt = document.createElement('option');
            opt.value = `${year}-${month}-${idx+1}`;
            opt.textContent = `${monthName} Week ${idx+1} (${week.start} - ${week.end})`;
            weekSelect.appendChild(opt);
        });
    });
}

function getWeeksInMonth(year, month) {
    const weeks = [];
    const firstDay = new Date(year, month - 1, 1);
    const lastDay = new Date(year, month, 0);
    
    let currentStart = 1;
    while (currentStart <= lastDay.getDate()) {
        const weekEnd = Math.min(currentStart + 6, lastDay.getDate());
        weeks.push({
            start: `${month}/${currentStart}`,
            end: `${month}/${weekEnd}`
        });
        currentStart = weekEnd + 1;
    }
    
    return weeks;
}






    </script>


    <!-- Add Product Modal -->
<div class="modal-overlay" id="addProductModal">
    <div class="modal">
        <div class="modal-header">
            <h2 id="addProductModalTitle">Add Product</h2>
            <button class="modal-close" onclick="closeModal('addProductModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <form id="addProductForm" onsubmit="saveNewProduct(event)">
                <input type="hidden" id="addProductUser" value="">
                
                <div class="form-group">
                    <label>Product Name *</label>
                    <input type="text" id="addProductName" required class="search-input">
                </div>
                
                <div class="form-group">
                    <label>Image Filename</label>
                    <input type="text" id="addProductImage" placeholder="e.g., product.jpg" class="search-input">
                    <small style="color: var(--neutral-500); font-size: 0.875rem;">Images should be in GitHub repository</small>
                </div>
                
                <div class="form-group">
                    <label>Vendor</label>
                    <select id="addProductVendor" class="search-input">
                        <option value="Supermarket">Supermarket</option>
                        <option value="General List">General List</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Category</label>
                    <select id="addProductCategory" class="search-input">
                        <option value="">-- Select Category --</option>
                        <option value="Produce">Produce</option>
                        <option value="Meat & Seafood">Meat & Seafood</option>
                        <option value="Dairy">Dairy</option>
                        <option value="Dry Goods">Dry Goods</option>
                        <option value="Frozen">Frozen</option>
                        <option value="Beverages">Beverages</option>
                        <option value="Cleaning Supplies">Cleaning Supplies</option>
                        <option value="Office Supplies">Office Supplies</option>
                        <option value="Kitchen Equipment">Kitchen Equipment</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                
                <!-- Position field (only for Rony) -->
                <div class="form-group" id="addProductPositionGroup" style="display: none;">
                    <label>Position *</label>
                    <input type="number" id="addProductPosition" min="1" class="search-input">
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancel</button>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Product
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Quick Assignment Modal -->
<div class="modal-overlay" id="quickAssignModal">
    <div class="modal" style="max-width: 450px;">
        <div class="modal-header">
            <h2>ðŸ‘¥ Assign Selected Items</h2>
            <button class="modal-close" onclick="closeModal('quickAssignModal')">Ã—</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label style="font-size: 1rem; margin-bottom: 1rem; display: block;">
                    Assign <strong id="selectedItemsCount">0</strong> items to:
                </label>
                
                <div style="display: flex; flex-direction: column; gap: 1rem;">
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="rony" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">ðŸ‘¨â€ðŸ³</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Rony</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Kitchen Staff</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="julio" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">ðŸ‘¨â€ðŸ³</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Julio</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Kitchen Staff</div>
                            </div>
                        </div>
                    </label>
                    
                    <label class="assignment-option" style="display: flex; align-items: center; gap: 1rem; padding: 1rem; border: 2px solid var(--neutral-300); border-radius: 8px; cursor: pointer; transition: all 0.2s;">
                        <input type="radio" name="assignmentChoice" value="office" style="width: 20px; height: 20px; cursor: pointer;">
                        <div style="display: flex; align-items: center; gap: 0.75rem;">
                            <span style="font-size: 2rem;">ðŸ¢</span>
                            <div>
                                <div style="font-weight: 600; font-size: 1.1rem;">Office</div>
                                <div style="font-size: 0.875rem; color: var(--neutral-600);">Administrative Use</div>
                            </div>
                        </div>
                    </label>
                </div>
            </div>
            
            <div class="form-actions" style="margin-top: 1.5rem;">
                <button type="button" class="btn btn-secondary" onclick="closeModal('quickAssignModal')">Cancel</button>
                <button type="button" class="btn btn-success" onclick="confirmQuickAssignment()">
                    <i class="fas fa-check"></i> Assign Now
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.assignment-option:has(input:checked) {
    border-color: var(--primary-600) !important;
    background: var(--primary-100) !important;
}

.assignment-option:hover {
    border-color: var(--primary-500);
    background: var(--neutral-50);
}
</style>

</body>

</html>
