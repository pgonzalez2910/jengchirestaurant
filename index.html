<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Inventory Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root{
      --jc-accent:#7A3D36;
      --jc-accent-dark:#5c2e29;
      --ink:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
      --surface:#ffffff;
      --bg:#f5f6f8;
    }
    html,body{height:100%}
    body{margin:0;background:var(--bg);font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;color:var(--ink);}

    /* ===== Login ===== */
    .login-wrap{min-height:100vh;display:grid;place-items:center;padding:28px}
    .login-card{
      width:min(980px,96vw);background:#fff;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.1);
      display:grid;grid-template-columns:1fr 1fr;gap:28px;padding:28px
    }
    .brand{display:flex;flex-direction:column;align-items:center;justify-content:center;border-right:1px solid var(--border)}
    .brand img{width:min(320px,90%);height:auto;mix-blend:multiply}
    .brand .title{margin-top:10px;font-weight:800;letter-spacing:.3px;font-size:.95rem;color:var(--jc-accent);text-align:center}
    .form-side{display:flex;align-items:center}
    .form{width:100%;max-width:420px;margin-inline:auto}
    .form h2{margin:0 0 12px;font-size:1.25rem;font-weight:800}
    .fg{margin:12px 0}
    .fg label{display:block;font-weight:700;font-size:.95rem;margin-bottom:6px;color:#374151}
    .fg input{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:12px;outline:none;background:#fff}
    .fg input:focus{border-color:var(--jc-accent);box-shadow:0 0 0 3px rgba(122,61,54,.12)}
    .btn{width:100%;padding:12px 16px;border:0;border-radius:12px;background:linear-gradient(90deg,#34D399,#10B981);color:#fff;font-weight:800}
    .err{display:none;color:#DC2626;font-weight:800;margin-top:8px}
    @media (max-width:900px){
      .login-card{grid-template-columns:1fr;padding:22px}
      .brand{border-right:0;border-bottom:1px solid var(--border);padding-bottom:14px}
    }

    /* ===== App Shell ===== */
    .app{min-height:100vh;display:flex;flex-direction:column}
    .nav{
      position:sticky;top:0;z-index:20;background:#fff;border-bottom:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,.05)
    }
    .nav-inner{
      max-width:1200px;margin:0 auto;padding:10px 14px;display:flex;align-items:center;gap:14px
    }
    .logo-mini{height:28px;width:auto;border-radius:6px;mix-blend:multiply}
    .app-title{font-weight:900;letter-spacing:.2px;white-space:nowrap}
    .tabs{display:flex;gap:8px;margin-left:auto}
    .tab{
      padding:8px 12px;border-radius:10px;border:1px solid transparent;font-weight:800;color:#374151;background:transparent;cursor:pointer
    }
    .tab:hover{background:#f3f4f6}
    .tab.active{color:#fff;background:linear-gradient(90deg,var(--jc-accent),var(--jc-accent-dark));box-shadow:0 3px 10px rgba(0,0,0,.12)}
    .logout{margin-left:8px;padding:8px 14px;border-radius:10px;border:0;background:#DC2626;color:#fff;font-weight:800;cursor:pointer}

    .main{flex:1;min-height:0;display:flex;flex-direction:column}
    .frame-wrap{position:relative;flex:1;min-height:0}
    iframe#frame{position:absolute;inset:0;border:0;width:100%;height:100%;background:#fff}
    .loader{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(255,255,255,.6)}
    .spin{width:42px;height:42px;border-radius:999px;border:4px solid #e5e7eb;border-top-color:var(--jc-accent);animation:spin .9s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}

    .footer{background:linear-gradient(135deg,#1f2937,#000);color:#fff;text-align:center;padding:8px 10px;font-size:.7rem;font-weight:800;border-top:1px solid #4b5563}
  </style>
</head>
<body>

  <!-- ===== LOGIN ===== -->
  <section id="login" class="login-wrap">
    <div class="login-card">
      <div class="brand">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
        <div class="title">JENG CHI INVENTORY MANAGEMENT SYSTEM</div>
      </div>
      <div class="form-side">
        <form id="loginForm" class="form">
          <h2>Sign in</h2>
          <input type="text" style="display:none" autocomplete="off">
          <input type="password" style="display:none" autocomplete="off">
          <div class="fg">
            <label for="u">Username</label>
            <input id="u" autocomplete="off" required>
          </div>
          <div class="fg">
            <label for="p">Password</label>
            <input id="p" type="password" autocomplete="new-password" inputmode="numeric" pattern="[0-9]*" required>
          </div>
          <div id="err" class="err"></div>
          <button class="btn" type="submit">Login</button>
        </form>
      </div>
    </div>
  </section>

  <!-- ===== APP SHELL ===== -->
  <section id="app" class="app" style="display:none;">
    <header class="nav">
      <div class="nav-inner">
        <img class="logo-mini" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi">
        <div class="app-title">Jeng Chi Inventory Management System</div>

        <nav id="tabs" class="tabs">
          <button class="tab" data-page="check">Check Management</button>
          <button class="tab" data-page="order">Order Management</button>
          <button class="tab" data-page="rony">General Order List</button>
          <button class="tab" data-page="julio">Kitchen Prep List</button>
        </nav>

        <button id="logoutBtn" class="logout">Logout</button>
      </div>
    </header>

    <main class="main">
      <div class="frame-wrap">
        <div id="loader" class="loader" style="display:flex"><div class="spin"></div></div>
        <iframe id="frame" title="Module"></iframe>
      </div>
    </main>

    <footer class="footer">
      Jeng Chi Inventory Management System • Designed by Pablo Gonzalez • v1
    </footer>
  </section>

  <script>
    /* ========= CONFIG ========= */
    const MODULE_BASE = 'https://portal.jengchirestaurant.com/'; // same-origin module pages
    const TAB_MAP = {
      check: 'check.html',
      order: 'placeorder.html',
      rony:  'rony.html',
      julio: 'julio.html'
    };

    /* ========= SUPABASE ========= */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    /* ========= ACL ========= */
    const ACL = {
      PG:{tabs:['check','order','rony','julio'], default:'check'},
      JT:{tabs:['check','order','rony','julio'], default:'check'},
      FT:{tabs:['check','order','rony','julio'], default:'check'},
      RC:{tabs:['rony'], default:'rony'},
      JM:{tabs:['julio'], default:'julio'}
    };

    /* ========= DOM ========= */
    const $  = (s,r=document)=>r.querySelector(s);
    const $$ = (s,r=document)=>Array.from(r.querySelectorAll(s));
    const loginSec = $('#login');
    const appSec   = $('#app');
    const uInput   = $('#u');
    const pInput   = $('#p');
    const errBox   = $('#err');
    const logoutBtn= $('#logoutBtn');
    const tabsWrap = $('#tabs');
    const frame    = $('#frame');
    const loader   = $('#loader');

    function showError(m){ errBox.textContent=m; errBox.style.display='block'; }
    function hideError(){ errBox.style.display='none'; }
    function setActiveTab(key){ $$('.tab',tabsWrap).forEach(b=>b.classList.toggle('active', b.dataset.page===key)); }

    /* ========= Load Module ========= */
    function mountModule(key){
      const file = TAB_MAP[key] || TAB_MAP.check;
      const url  = new URL(file, MODULE_BASE).toString();

      setActiveTab(key);
      loader.style.display='flex';
      frame.src = url;

      frame.onload = () => {
        loader.style.display='none';

        // Since modules are same-origin, we can inject CSS to remove their internal banners/headers
        try{
          const doc = frame.contentDocument || frame.contentWindow?.document;
          if (!doc) return;

          const style = doc.createElement('style');
          style.textContent = `
            /* Hide common hero/header/logo areas inside module pages */
            header, .header, .app-header, .topbar, .hero, .logo, .nav, .navbar { display: none !important; }
            /* Trim giant top margins/paddings that many pages add for their own header */
            body { margin-top: 0 !important; padding-top: 0 !important; }
            /* Keep module content edge-to-edge */
            .container, .main, .page, .content { max-width: 100% !important; }
          `;
          doc.head.appendChild(style);
        }catch(e){
          // If anything fails, we still show the page; CSS injection is a progressive enhancement
          console.warn('Module CSS injection skipped:', e);
        }
      };

      frame.onerror = () => {
        loader.style.display='none';
        frame.srcdoc = `
          <div style="padding:24px;font-family:Inter,system-ui">
            <h2>Could not load <code>${file}</code></h2>
            <p>Tried URL:</p>
            <pre style="white-space:pre-wrap;background:#f8fafc;border:1px solid #e5e7eb;padding:12px;border-radius:8px">${url}</pre>
            <p>Ensure the file exists on the server.</p>
          </div>`;
      };
    }

    function showApp(defaultKey){
      loginSec.style.display='none';
      appSec.style.display='flex';
      mountModule(defaultKey);
    }
    function logout(){
      localStorage.clear();
      appSec.style.display='none';
      loginSec.style.display='grid';
      uInput.value=''; pInput.value='';
      uInput.focus();
    }

    tabsWrap.addEventListener('click',(e)=>{
      const btn = e.target.closest('.tab'); if(!btn) return;
      e.preventDefault();
      const key = btn.dataset.page;
      localStorage.setItem('lastPage', key);
      mountModule(key);
    });
    logoutBtn.addEventListener('click', logout);

    // Restore session
    (function init(){
      const session = JSON.parse(localStorage.getItem('userPermissions')||'null');
      if(session?.username){
        const acl = ACL[session.username] || {tabs:['check'], default:'check'};
        $$('.tab',tabsWrap).forEach(b => { b.style.display = acl.tabs.includes(b.dataset.page) ? '' : 'none'; });
        const last = localStorage.getItem('lastPage') || acl.default;
        showApp(last);
      }else{
        loginSec.style.display='grid';
      }
    })();

    // Login
    $('#loginForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault(); hideError();
      const username = (uInput.value||'').trim();
      const password = pInput.value;
      if(!username || !password) return showError('Please enter both username and password.');
      try{
        const { data, error } = await supabaseClient
          .from('users')
          .select('username, password, role, departments')
          .ilike('username', username) // case-insensitive
          .maybeSingle();

        if(error) throw error;
        if(!data || String(data.password) !== String(password)){
          throw new Error('Invalid username or password.');
        }

        const canonical = data.username;
        const acl = ACL[canonical] || {tabs:['check'], default:'check'};

        localStorage.setItem('userPermissions', JSON.stringify({
          role: data.role, departments: data.departments, username: canonical, tabs: acl.tabs
        }));
        $$('.tab',tabsWrap).forEach(b => { b.style.display = acl.tabs.includes(b.dataset.page) ? '' : 'none'; });

        const start = localStorage.getItem('lastPage') || acl.default;
        showApp(start);
      }catch(err){
        console.error(err);
        showError(err.message || 'Unexpected error. Please try again.');
      }
    });
  </script>
</body>
</html>
