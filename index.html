<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi - Inventory System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --jc-brown:#7A3D36; --jc-deep:#5f302b; }

    /* ===== Base layout: make page fill full height ===== */
    html, body{ height:100%; margin:0; padding:0; display:flex; flex-direction:column; }
    body{ font-family:'Montserrat',sans-serif; background:#F3F4F6; }

    /* Shell wrapper */
    #app-container{ flex:1 1 auto; display:flex; flex-direction:column; min-height:0; }

    /* Login */
    .main-content{ flex:1; display:flex; }
    .main-border{ border:8px solid var(--jc-brown); box-sizing:border-box; display:flex; flex-direction:column; width:100%; }
    .left-section,.right-section{ flex:1; display:flex; justify-content:center; align-items:center; background:#fff; padding:2rem; flex-direction:column; text-align:center; }
    .logo-container{ display:flex; flex-direction:column; align-items:center; justify-content:center; height:100%; }
    .system-title{ color:var(--jc-brown); font-weight:700; font-size:clamp(1rem,2.5vw,1.5rem); line-height:1.2; margin-top:1rem; text-align:center; }
    .login-container{ width:90%; max-width:420px; }
    .form-group{ margin-bottom:1rem; text-align:left; }
    .form-group label{ display:block; margin-bottom:.5rem; font-weight:600; color:#1f2937; }
    .form-group input{ width:100%; padding:.75rem; border:1px solid #e5e7eb; border-radius:10px; font-size:1rem; transition:border-color .2s; background:#fff; }
    .form-group input:focus{ outline:none; border-color:var(--jc-brown); box-shadow:0 0 0 3px rgba(122,61,54,.1); }
    .login-btn{ width:100%; background:linear-gradient(to right,#6EE7B7,#34D399); color:#fff; padding:.8rem; border:none; border-radius:12px; font-size:1.1rem; font-weight:700; cursor:pointer; transition:all .2s ease; box-shadow:0 4px 6px rgba(0,0,0,.1); }
    .login-btn:hover{ background:linear-gradient(to right,#34D399,#10B981); transform:translateY(-2px); box-shadow:0 6px 10px rgba(0,0,0,.15); }
    .error-message{ color:#DC2626; margin-top:.75rem; font-weight:600; }

    /* Navbar */
    .navbar{ background:#fff; padding:.8rem 1.25rem; box-shadow:0 2px 4px rgba(0,0,0,.08); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; width:100%; }
    .nav-links a{ font-weight:700; color:#4B5563; padding:.45rem .9rem; border-radius:10px; transition:background-color .2s,color .2s; }
    .nav-links a:hover{ background:#F3F4F6; color:#111827; }
    .nav-links a.active{ background:linear-gradient(90deg,var(--jc-brown),var(--jc-deep)); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    .logout-btn{ background:#DC2626; color:#fff; padding:.5rem 1.2rem; border-radius:10px; font-weight:700; cursor:pointer; transition:background-color .2s,transform .1s; }
    .logout-btn:hover{ background:#B91C1C; transform:translateY(-1px); }

    /* Page area & frame: fill remaining height (no max-width cap) */
    #dashboard-section{ flex:1 1 auto; display:flex; flex-direction:column; min-height:0; }
    .page-content{ flex:1 1 auto; min-height:0; margin:0; width:100%; text-align:left; padding:0; }
    .frame-wrap{ flex:1 1 auto; min-height:0; display:flex; position:relative; }
    #moduleFrame{ flex:1 1 auto; min-height:0; width:100%; height:100%; border:none; }

    /* Loader */
    .loader{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; }
    .spinner{ width:42px; height:42px; border:4px solid #e5e7eb; border-top-color:var(--jc-brown); border-radius:50%; animation:spin 1s linear infinite; }
    @keyframes spin{ to{ transform:rotate(360deg); } }

    /* Footer smaller (reduced ~60%) */
    .footer{ text-align:center; padding:0.5rem 0.5rem; font-size:0.65rem; background:linear-gradient(135deg,#1f2937 0%,#000 100%); color:#fff; border-top:1px solid #4b5563; box-shadow:0 -4px 10px rgba(0,0,0,.2); position:relative; }
    .footer p{ margin:0; line-height:1.2; font-weight:600; text-shadow:0 1px 1px rgba(0,0,0,.5); }
  </style>
</head>
<body class="main-border">
  <div id="app-container">
    <!-- LOGIN -->
    <div id="login-section">
      <div class="main-content">
        <div class="left-section">
          <div class="logo-container">
            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="w-full max-w-[450px] rounded-xl shadow">
            <h1 class="system-title">INVENTORY MANAGEMENT SYSTEM</h1>
          </div>
        </div>
        <div class="right-section">
          <div class="login-container">
            <form id="login-form">
              <input type="text" style="display:none" name="username_dummy" autocomplete="off">
              <input type="password" style="display:none" name="password_dummy" autocomplete="off">
              <div class="form-group">
                <label for="username">Username</label>
                <input id="username" name="username" type="text" required autocomplete="off" placeholder="">
              </div>
              <div class="form-group">
                <label for="password">Password</label>
                <input id="password" name="password" type="password" required inputmode="numeric" pattern="[0-9]*" autocomplete="new-password" placeholder="4-6 digits">
              </div>
              <p id="error-message" class="error-message hidden"></p>
              <button type="submit" class="login-btn" id="login-btn">Login</button>
              <p class="mt-2 text-xs text-gray-500 text-center">Authorized use only.</p>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- DASHBOARD -->
    <div id="dashboard-section" class="hidden"></div>
  </div>

  <footer class="footer">
    <p>Jeng Chi Inventory Management System</p>
    <p>Designed by Pablo Gonzalez</p>
    <p><span id="year"></span> | v1</p>
  </footer>

  <script>
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== CONFIG =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Where your modules live remotely (GitHub RAW)
    const RAW_BASE = 'https://raw.githubusercontent.com/pgonzalez2910/jengchirestaurant/main/';

    // ACL
    const ACL = {
      PG:{tabs:['check','order','rony','julio'],defaultPage:'check'},
      JT:{tabs:['check','order','rony','julio'],defaultPage:'check'},
      FT:{tabs:['check','order','rony','julio'],defaultPage:'check'},
      RC:{tabs:['rony'],defaultPage:'rony'},
      JM:{tabs:['julio'],defaultPage:'julio'},
    };

    // Map + Labels
    const TAB_MAP   = { check:'check.html', order:'placeorder.html', rony:'rony.html', julio:'julio.html' };
    const TAB_LABELS= { check:'Check Management', order:'Order Management', rony:'General Order List', julio:'Kitchen Prep List' };

    // Expand injected modules full width
    const EXPAND_CSS = `
      <style id="shell-expand-overrides">
        html, body { margin:0 !important; padding:0 !important; height:100%; }
        body { background: transparent !important; }
        *, *::before, *::after { box-sizing: border-box; }
        #root, #app, .app, .page, .content, .wrapper, .container, .container-fluid,
        .mx-auto, .max-w-screen, .max-w-screen-xl, .max-w-7xl, .max-w-6xl, .max-w-5xl,
        [class*="container"], [class*="max-w"], [class*="mx-auto"] {
          max-width: none !important; width: 100% !important; margin-left: 0 !important; margin-right: 0 !important;
        }
      </style>`;

    // DOM refs
    const loginForm = document.getElementById('login-form');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const errorMessage = document.getElementById('error-message');
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');

    function showLogin(){ loginSection.classList.remove('hidden'); dashboardSection.classList.add('hidden'); }
    function showDashboard(defaultPage){ loginSection.classList.add('hidden'); dashboardSection.classList.remove('hidden'); renderPage(defaultPage); }
    function logout(){ localStorage.clear(); showLogin(); }

    // Load a module's HTML from GitHub RAW into the iframe via Blob and inject <base> + EXPAND css
    async function mountModuleIntoFrame(pageKey){
      const path = TAB_MAP[pageKey];
      const url  = RAW_BASE + path;
      const frame = document.getElementById('moduleFrame');
      const loader = document.getElementById('frameLoader');
      loader.classList.remove('hidden');
      try{
        const res = await fetch(url, {mode:'cors'});
        const html = await res.text();
        const withBase = html.replace('<head>', `<head><base href="${RAW_BASE}">\n${EXPAND_CSS}`);
        const blob = new Blob([withBase], {type:'text/html'});
        const blobUrl = URL.createObjectURL(blob);
        frame.src = blobUrl;
        frame.onload = () => { loader.classList.add('hidden'); };
      }catch(err){
        console.error('[MODULE_LOAD_ERROR]', err);
        loader.classList.add('hidden');
        frame.srcdoc = `<div style="font-family:Montserrat,Arial,sans-serif;padding:24px"><h2>Failed to load module</h2><p>Could not fetch <code>${url}</code>. Make sure the file exists and is public.</p></div>`;
      }
    }

    function renderPage(pageKey){
      const userPermissions = JSON.parse(localStorage.getItem('userPermissions'));
      const allowed = userPermissions?.tabs || [];
      if(!allowed.includes(pageKey)) pageKey = allowed[0] || 'check';

      dashboardSection.innerHTML = `
        <div class="navbar">
          <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="h-10 rounded">
            <h1 class="text-xl font-extrabold text-gray-800">Jeng Chi Inventory Management System</h1>
          </div>
          <nav class="nav-links space-x-2">
            ${allowed.map(tab=>`<a href="#" data-page="${tab}" class="${pageKey===tab?'active':''}">${TAB_LABELS[tab]}</a>`).join('')}
          </nav>
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
        <div class="page-content">
          <div class="frame-wrap">
            <div id="frameLoader" class="loader"><div class="spinner" aria-label="Loading"></div></div>
            <iframe id="moduleFrame" title="${TAB_LABELS[pageKey]}"></iframe>
          </div>
        </div>`;

      dashboardSection.querySelectorAll('a[data-page]').forEach(link=>{
        link.addEventListener('click',e=>{e.preventDefault();const newKey=e.currentTarget.getAttribute('data-page');localStorage.setItem('lastPage',newKey);renderPage(newKey);});
      });
      dashboardSection.querySelector('#logoutBtn')?.addEventListener('click',logout);

      mountModuleIntoFrame(pageKey);
    }

    // Restore session
    document.addEventListener('DOMContentLoaded',()=>{
      const userPermissions = JSON.parse(localStorage.getItem('userPermissions'));
      if(userPermissions){ const acl=ACL[userPermissions.username]||{tabs:userPermissions.tabs||[],defaultPage:'check'}; const def=localStorage.getItem('lastPage')||acl.defaultPage||'check'; showDashboard(def); }
      else{ showLogin(); usernameInput.focus(); }
    });

    // Login (case-insensitive username)
    let isSubmitting=false; 
    loginForm?.addEventListener('submit', async (e)=>{
      e.preventDefault(); if(isSubmitting) return; isSubmitting=true; 
      const raw = (usernameInput.value||'').trim();
      const password = passwordInput.value; 
      errorMessage.classList.add('hidden');
      try{
        if(!raw||!password){ throw new Error('Please enter both username and password.'); }
        const candidates = Array.from(new Set([raw, raw.toUpperCase(), raw.toLowerCase()]));
        const { data, error } = await supabaseClient
          .from('users')
          .select('username, password, role, departments')
          .in('username', candidates)
          .maybeSingle();
        if(error) throw error;
        if(!data || data.password !== password){ throw new Error('Invalid username or password.'); }
        const username = (data.username||raw).toUpperCase();
        const acl = ACL[username] || { tabs:['check'], defaultPage:'check' };
        localStorage.setItem('userPermissions', JSON.stringify({ role:data.role, departments:data.departments, username, tabs:acl.tabs }));
        localStorage.setItem('currentUser', username);
        const last = localStorage.getItem('lastPage') || acl.defaultPage; 
        showDashboard(last);
      }catch(err){ errorMessage.textContent = err.message || 'Unexpected error. Please try again.'; errorMessage.classList.remove('hidden'); }
      finally{ isSubmitting=false; }
    });

    // Enter key convenience
    [usernameInput, passwordInput].forEach(el=>{ el.addEventListener('keydown',e=>{ if(e.key==='Enter'){ loginForm.requestSubmit(); } }); });
  </script>
</body>
</html>
