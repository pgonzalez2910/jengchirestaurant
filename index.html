<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Executive Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <style>
    :root {
      --jc-brand: #7A3D36;
      --jc-brand-deep: #5A2B26;
      --jc-accent: #10B981;
      --jc-accent-deep: #059669;
    }
    body {
      font-family: 'Inter', system-ui, Arial, sans-serif;
      background: #fff;
      color: #111;
    }
    .card-light {
      background: #fff;
      border: 1px solid #d1d5db;
      box-shadow: 0 12px 28px rgba(0, 0, 0, .1);
      border-radius: 18px;
    }
    .glass {
      background: rgba(0, 0, 0, 0.04);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(0, 0, 0, 0.12);
    }
    .glass-soft {
      background: rgba(0, 0, 0, 0.02);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }
    .ring-focus {
      outline: none;
      box-shadow: 0 0 0 4px rgba(16, 185, 129, .25);
    }
    .btn-brand {
      background: linear-gradient(135deg, var(--jc-brand), var(--jc-brand-deep));
      color: #fff;
    }
    .btn-brand:hover {
      filter: brightness(1.05);
    }
    .btn-accent {
      background: linear-gradient(135deg, var(--jc-accent), var(--jc-accent-deep));
      color: #fff;
    }
    .btn-accent:hover {
      filter: brightness(1.06);
    }
    .sh {
      box-shadow: 0 8px 24px rgba(0, 0, 0, .1);
    }
    .sep {
      border-top: 1px solid rgba(0, 0, 0, 0.08);
    }
    .muted {
      color: #6b7280;
    }
    .muted-2 {
      color: #9aa3b2;
    }
    .caps {
      letter-spacing: .12em;
      text-transform: uppercase;
    }
    .tab-active {
      background: rgba(0, 0, 0, .05);
      border-color: rgba(0, 0, 0, .15);
    }
    .badge-light {
      border: 1px solid #d1d5db;
      background: #f9fafb;
      color: #374151;
    }
    .pill {
      border-radius: 999px;
    }
    .shadow-inner-1 {
      box-shadow: inset 0 1px 0 rgba(0, 0, 0, .08);
    }
    .text-glossy {
      background: linear-gradient(180deg, #111 0%, #a0a0a0 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      filter: drop-shadow(0 1px 1px rgba(0,0,0,.15));
    }
    /* Custom styles for the order list section */
    .product-grid {
      display: grid;
      gap: 1rem;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
    }
    .product-card {
      background: #f9fafb;
      border-radius: 14px;
      padding: 18px;
      box-shadow: 0 3px 10px rgba(0, 0, 0, .08);
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      color: #111;
      transition: all 0.2s ease-in-out;
    }
    .product-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 18px rgba(0, 0, 0, .12);
    }
    .product-details img {
      width: 120px;
      height: 120px;
      object-fit: contain;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      background: linear-gradient(145deg, rgba(255, 255, 255, .45), rgba(255, 255, 255, .1));
    }
    .product-name {
      font-weight: 700;
      font-size: 14px;
      margin-top: 10px;
      line-height: 1.25;
      color: #111;
    }
    .counter {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 12px;
    }
    .counter button {
      background: #3b82f6;
      border: none;
      color: #fff;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    .counter button:hover {
      background: #2563eb;
    }
    .counter input {
      width: 64px;
      text-align: center;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
      color: #111;
    }
    .footer-history {
      max-width: 1100px;
      margin: 22px auto;
      padding: 18px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, .08);
      color: #111;
    }
    .order-summary-list {
      list-style: none;
      margin: 0;
      padding: 0;
    }
    .order-summary-item {
      display: flex;
      justify-content: space-between;
      padding: 6px 0;
      border-bottom: 1px solid #e5e7eb;
    }
    .fab {
      position: fixed;
      right: 18px;
      bottom: 18px;
      z-index: 50;
    }
    .fab img {
      width: 92px;
      height: 92px;
      border-radius: 50%;
      box-shadow: 0 6px 16px rgba(0, 0, 0, .25);
      cursor: pointer;
    }
    .fab img:hover {
      transform: scale(1.06);
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, .4);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: #fff;
      padding: 22px;
      border-radius: 12px;
      max-width: 420px;
      width: 92%;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0, 0, 0, .3);
      border: 1px solid #e5e7eb;
    }
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    input[type="number"] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="min-h-full">
  <!-- ===== EXECUTIVE LOGIN ===== -->
  <main id="loginView" class="min-h-screen flex items-center justify-center p-4">
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 w-full max-w-6xl items-center">
      <!-- Left: Brand panel -->
      <div class="flex flex-col items-center text-center space-y-2 mb-8 lg:mb-0">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="h-64 rounded-xl" alt="Jeng Chi" />
        <h1 class="text-2xl font-extrabold tracking-tight text-glossy text-center text-black">Jeng Chi Enterprise Portal</h1>
        <p class="muted text-glossy text-center text-black">Executive Access</p>
      </div>
      <!-- Right: Form card -->
      <div class="card-light p-8 w-full">
        <div class="flex flex-col gap-3 text-center">
          <div>
            <p class="caps text-xs muted-2 font-bold text-glossy text-black">Secure Access</p>
          </div>
        </div>
        <form id="loginForm" class="mt-6 space-y-5">
          <div>
            <label class="block text-sm mb-1 text-black">Username</label>
            <input id="username" type="text" autocomplete="off" class="w-full pill px-4 py-3 text-black shadow-inner-1 border border-gray-300 focus:ring-focus" placeholder="e.g., PG, RC, JM" required>
          </div>
          <div>
            <label class="block text-sm mb-1 text-black">PIN (4–6 digits)</label>
            <input id="password" type="password" inputmode="numeric" pattern="[0-9]*" autocomplete="new-password" class="w-full pill px-4 py-3 text-black shadow-inner-1 border border-gray-300 focus:ring-focus" placeholder="••••" required>
          </div>
          <p id="loginError" class="hidden text-rose-400 text-sm"></p>
          <button type="submit" class="btn-brand pill px-5 py-3 font-bold w-full">Enter</button>
          <div class="flex items-center justify-between mt-4">
            <span class="text-xs muted-2 text-black">Authorized use only</span>
            <span id="yr" class="text-xs muted-2 text-black"></span>
            <span class="text-xs badge-light pill px-2 py-1">v1.2 Executive</span>
          </div>
        </form>
      </div>
    </div>
  </main>
  <!-- ===== EXECUTIVE DASHBOARD (SINGLE‑PAGE) ===== -->
  <section id="appView" class="hidden min-h-screen">
    <!-- Topbar -->
    <header class="card-light px-5 py-3 sticky top-0 z-20">
      <div class="flex items-center justify-between">
        <div class="flex items-center gap-3">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="h-10 rounded-xl sh" alt="logo" />
          <div>
            <p class="caps text-[11px] muted-2 text-black">Jeng Chi Enterprise Portal</p>
            <h1 class="font-extrabold tracking-tight text-black">Executive Dashboard</h1>
          </div>
        </div>
        <div class="flex items-center gap-2">
          <span id="userBadge" class="badge-light pill px-3 py-1 text-sm text-black"></span>
          <button id="logoutBtn" class="pill px-3 py-2 btn-accent font-bold">Logout</button>
        </div>
      </div>
      <div class="mt-3 flex flex-wrap gap-2">
        <!-- Tab buttons -->
        <button data-tab="order-management" class="tabBtn pill px-3 py-2 border glass-soft">Order Management</button>
        <button data-tab="invoice-management" class="tabBtn pill px-3 py-2 border glass-soft">Invoice Management</button>
        <button data-tab="general-order-list" class="tabBtn pill px-3 py-2 border glass-soft">General Order List</button>
        <button data-tab="kitchen-prep-list" class="tabBtn pill px-3 py-2 border glass-soft">Kitchen Prep List</button>
        <button data-tab="check-management" class="tabBtn pill px-3 py-2 border glass-soft">Check Management</button>
        <button data-tab="mooncake-management" class="tabBtn pill px-3 py-2 border glass-soft">Mooncake Management</button>
      </div>
    </header>
    <!-- Content -->
    <div id="tab-content" class="p-4 grid gap-4">
      <!-- Tabs content will be dynamically loaded here -->
    </div>
  </section>
  <!-- Toast / Modal -->
  <div id="toast" class="fixed bottom-4 right-4 hidden">
    <div class="card-light rounded-xl px-4 py-3 flex items-center gap-3">
      <div class="h-2 w-2 rounded-full bg-emerald-400"></div>
      <div id="toastMsg" class="text-sm text-black">Signed in</div>
    </div>
  </div>
  <!-- Modal for the order list -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" class="text-xl font-extrabold mb-2 text-black"></h3>
      <div id="modal-icon" class="my-4"></div>
      <p id="modal-message" class="text-gray-400 mb-4 text-black"></p>
      <button onclick="closeModal()" class="bg-blue-500 text-white py-2 px-6 rounded-xl font-bold transition-colors duration-200 hover:bg-blue-600">OK</button>
    </div>
  </div>
  <!-- Submit FAB -->
  <div id="fab" class="fixed bottom-4 right-4 z-50 hidden">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffysubmit.jpg" alt="Submit Order" class="w-24 h-24 rounded-full shadow-lg transition-transform hover:scale-110" onclick="submitInventory()" />
  </div>
<script>
  // ===== Supabase setup =====
  const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const ACL = {
    PG: {
      tabs: ['order-management', 'invoice-management', 'general-order-list', 'kitchen-prep-list', 'check-management', 'mooncake-management'],
      defaultPage: 'order-management'
    },
    JT: {
      tabs: ['order-management', 'invoice-management', 'general-order-list', 'kitchen-prep-list', 'check-management', 'mooncake-management'],
      defaultPage: 'order-management'
    },
    FT: {
      tabs: ['order-management', 'invoice-management', 'general-order-list', 'kitchen-prep-list', 'check-management', 'mooncake-management'],
      defaultPage: 'order-management'
    },
    RC: {
      tabs: ['general-order-list'],
      defaultPage: 'general-order-list'
    },
    JM: {
      tabs: ['kitchen-prep-list'],
      defaultPage: 'kitchen-prep-list'
    },
  };
  const loginView = document.getElementById('loginView');
  const appView = document.getElementById('appView');
  const loginForm = document.getElementById('loginForm');
  const loginError = document.getElementById('loginError');
  const userBadge = document.getElementById('userBadge');
  const yr = document.getElementById('yr');
  yr.textContent = new Date().getFullYear();
  // Rony Tab Initialization state
  let isRonyTabInitialized = false;
  // Tab switching
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.tabBtn');
    if (!btn) return;
    const tab = btn.getAttribute('data-tab');
    document.querySelectorAll('.tabBtn').forEach(b => b.classList.remove('tab-active'));
    btn.classList.add('tab-active');
    
    // Show loading message inside the main content container
    const tabContentContainer = document.getElementById('tab-content');
    tabContentContainer.innerHTML = `<div class="flex items-center justify-center h-40">
                             <p class="text-xl text-gray-400">Loading...</p>
                           </div>`;
    localStorage.setItem('lastTab', tab);
    
    // Simulate network delay for a better user experience
    await new Promise(resolve => setTimeout(resolve, 500));
    
    // Hide FAB by default, then show if necessary
    const fab = document.getElementById('fab');
    fab.classList.add('hidden');
    
    // Load content based on the active tab
    if (tab === 'general-order-list') {
      tabContentContainer.innerHTML = `
        <h2 class="font-bold tracking-tight text-black">General Order List</h2>
        <div class="flex flex-col gap-4">
          <div class="flex flex-col lg:flex-row items-center justify-between">
            <input type="date" id="order-date" class="bg-gray-100 text-black border border-gray-300 rounded-lg p-2 text-sm" />
          </div>
          <section id="inventory-list" class="flex flex-col gap-8">
            <p class="text-center text-gray-400">Loading inventory...</p>
          </section>
          <footer id="order-history-footer" class="max-w-3xl mx-auto p-5 bg-gray-50 rounded-xl shadow-md mt-6 hidden">
            <h3 class="text-lg font-extrabold border-b-2 border-gray-200 pb-2 mb-2 text-black">Last Submitted Order</h3>
            <div id="last-order-details">
              <p class="text-center text-gray-400 text-black">No order submitted yet.</p>
            </div>
            <div class="text-center mt-4">
              <p class="font-bold text-gray-700 text-black">Click logout when finished</p>
              <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffylogout.jpg" alt="Logout" class="h-28 cursor-pointer mt-2" onclick="logoutUser()" />
            </div>
          </footer>
        </div>
      `;
      document.getElementById('fab').classList.remove('hidden');
      // Use a short timeout to ensure the DOM elements are parsed before calling init
      setTimeout(() => initRonyTab(), 0);
    } else if (tab === 'order-management') {
      tabContentContainer.innerHTML = `<h2 class="font-bold tracking-tight text-black">Order Management</h2><div class="mt-3 text-sm muted text-black">Your <strong>Place Order</strong> experience will live here. We can integrate the order form, progress bars, and the “Gracias Rony” UX from the previous version.</div>`;
    } else if (tab === 'invoice-management') {
      tabContentContainer.innerHTML = `<h2 class="font-bold tracking-tight text-black">Invoice Management</h2><div class="mt-3 text-sm muted text-black">This section will contain the UI for managing invoices.</div>`;
    } else if (tab === 'kitchen-prep-list') {
      tabContentContainer.innerHTML = `<h2 class="font-bold tracking-tight text-black">Kitchen Prep List</h2><div class="mt-3 text-sm muted text-black">This section will contain the UI for the kitchen prep workflow.</div>`;
    } else if (tab === 'check-management') {
      tabContentContainer.innerHTML = `<h2 class="font-bold tracking-tight text-black">Check Management</h2><div class="mt-3 text-sm muted text-black">This section will contain the UI for managing checks.</div>`;
    } else if (tab === 'mooncake-management') {
      tabContentContainer.innerHTML = `<h2 class="font-bold tracking-tight text-black">Mooncake Management</h2><div class="mt-3 text-sm muted text-black">This section will contain the UI for managing mooncake orders and shipping.</div>`;
    }
  });
  // Rony Tab Initialization
  function initRonyTab() {
    if (isRonyTabInitialized) return;
    isRonyTabInitialized = true;
    const orderDate = document.getElementById('order-date');
    if (orderDate) orderDate.value = todayYmd();
    loadInventory();
    displayLastOrder();
  }
  // Toast helper
  function toast(msg) {
    const t = document.getElementById('toast');
    const m = document.getElementById('toastMsg');
    if (m) m.textContent = msg;
    if (t) {
        t.classList.remove('hidden');
        setTimeout(() => t.classList.add('hidden'), 1800);
    }
  }
  // Modal helpers for the order list
  function openModal(title, msg, img) {
    const m = document.getElementById('custom-modal');
    if (m) {
        document.getElementById('modal-title').textContent = title;
        document.getElementById('modal-message').textContent = msg;
        document.getElementById('modal-icon').innerHTML = img ? `<img src="${img}" class="h-24 mx-auto rounded-full shadow-lg">` : '';
        m.style.display = 'flex';
    }
  }
  function closeModal() {
    const m = document.getElementById('custom-modal');
    if (m) m.style.display = 'none';
  }
  // Render dashboard shell
  function showApp(username) {
    loginView.classList.add('hidden');
    appView.classList.remove('hidden');
    const U = (username || '').toUpperCase();
    const acl = ACL[U] || {
      tabs: ['order-management'],
      defaultPage: 'order-management'
    };
    if (userBadge) userBadge.textContent = `User: ${U}`;
    // enable/disable tab buttons by ACL
    document.querySelectorAll('.tabBtn').forEach(b => {
      const key = b.getAttribute('data-tab');
      b.classList.toggle('hidden', !acl.tabs.includes(key));
    });
    // set default/open tab
    const open = localStorage.getItem('lastTab') || acl.defaultPage;
    const firstVisible = acl.tabs.includes(open) ? open : acl.tabs[0];
    const btn = document.querySelector(`.tabBtn[data-tab="${firstVisible}"]`);
    btn?.click();
    toast('Signed in');
  }
  function showLogin() {
    appView.classList.add('hidden');
    loginView.classList.remove('hidden');
  }
  // Restore session
  (function init() {
    const saved = JSON.parse(localStorage.getItem('userPermissions') || 'null');
    if (saved?.username) {
      showApp(saved.username);
    }
  })();
  // Login flow (users table: username + password)
  let busy = false;
  loginForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (busy) return;
    busy = true;
    if (loginError) loginError.classList.add('hidden');
    const u = document.getElementById('username').value.trim();
    const p = document.getElementById('password').value;
    try {
      if (!u || !p) throw new Error('Please enter both fields.');
      const variants = Array.from(new Set([u, u.toUpperCase(), u.toLowerCase()]));
      const {
        data,
        error
      } = await sb.from('users').select('username,password,role,departments').in('username', variants).maybeSingle();
      if (error) throw error;
      if (!data || data.password !== p) throw new Error('Invalid credentials.');
      const username = (data.username || u).toUpperCase();
      const acl = ACL[username] || {
        tabs: ['order-management'],
        defaultPage: 'order-management'
      };
      localStorage.setItem('userPermissions', JSON.stringify({
        username,
        role: data.role,
        departments: data.departments,
        tabs: acl.tabs
      }));
      showApp(username);
    } catch (err) {
      if (loginError) {
          loginError.textContent = err.message || 'Unexpected error.';
          loginError.classList.remove('hidden');
      }
    } finally {
      busy = false;
    }
  });
  // Logout
  document.getElementById('logoutBtn').addEventListener('click', () => {
    localStorage.clear();
    showLogin();
    toast('Signed out');
  });
  // Order list logic
  /***** Constants & helpers *****/
  const TZ = "America/Chicago";
  const ORDER_CONFIRMATION_TO = "admin@jengchirestaurant.com";
  function formatCT(dateLike) {
    return new Intl.DateTimeFormat("en-US", {
      dateStyle: "medium",
      timeStyle: "short",
      timeZone: TZ
    }).format(new Date(dateLike));
  }
  function todayYmd() {
    const d = new Date();
    return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`
  }
  function dateInputToLocalMidnightISO(ymd) {
    if (!ymd) return new Date().toISOString();
    const [y, m, d] = ymd.split('-').map(Number);
    return new Date(y, m - 1, d, 0, 0, 0).toISOString()
  }
  /***** Inventory UI (inputs blank when 0) *****/
  async function loadInventory() {
    const container = document.getElementById('inventory-list');
    if (!container) return; // Add a check to prevent errors if the element doesn't exist
    container.innerHTML = "<p class='text-center text-gray-400'>Loading…</p>";
    const {
      data,
      error
    } = await sb
      .from('inventory_management')
      .select('product_name,image_url,on_hand,position')
      .eq('user', 'Rony')
      .order('position', {
        ascending: true
      });
    if (error || !data) {
      console.error(error);
      container.innerHTML = '<p class="text-center text-red-400">Error loading.</p>';
      return;
    }
    // Group by position and roll-up duplicates per product
    const grouped = {};
    for (const row of data) {
      const pos = row.position || 'Uncategorized';
      grouped[pos] ||= {};
      const prod = grouped[pos][row.product_name] ||= {
        total: 0,
        image: row.image_url
      };
      prod.total += Number(row.on_hand) || 0;
    }
    // Render
    container.innerHTML = '';
    for (const pos of Object.keys(grouped)) {
      const sec = document.createElement('div');
      sec.className = 'category-section';
      sec.innerHTML = `<h2 class="text-lg font-extrabold my-4 border-b-2 border-gray-200 pb-2 text-black">Position ${pos}</h2>`;
      const grid = document.createElement('div');
      grid.className = 'grid gap-4 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4';
      for (const [name, obj] of Object.entries(grouped[pos])) {
        const card = document.createElement('div');
        card.className = 'bg-gray-50 p-5 rounded-2xl shadow-lg flex flex-col items-center text-center transition-all duration-200 ease-in-out hover:scale-105';
        const valueAttr = Number(obj.total) > 0 ? `value="${obj.total}"` : '';
        card.innerHTML = `
          <div class="product-details">
            <img src="${obj.image || 'https://placehold.co/120x120/E5E7EB/6B7280?text=No+Image'}" alt="${name}" class="w-24 h-24 object-contain rounded-xl border border-gray-200" onerror="this.onerror=null;this.src='https://placehold.co/120x120/E5E7EB/6B7280?text=No+Image';">
          </div>
          <div class="font-bold mt-3 text-sm leading-tight text-black">${name}</div>
          <div class="flex items-center gap-2 mt-4">
            <button onclick="updateQty('${encodeURIComponent(name)}',-1)" class="bg-blue-500 text-white p-3 rounded-xl font-bold transition-colors duration-200 ease-in-out hover:bg-blue-600">-</button>
            <input type="number" data-name="${name.replace(/"/g,'&quot;')}" ${valueAttr} min="0" placeholder="0" class="w-20 text-center border-gray-300 rounded-xl p-2 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 text-black" />
            <button onclick="updateQty('${encodeURIComponent(name)}',1)" class="bg-blue-500 text-white p-3 rounded-xl font-bold transition-colors duration-200 ease-in-out hover:bg-blue-600">+</button>
          </div>`;
        grid.appendChild(card);
      }
      sec.appendChild(grid);
      container.appendChild(sec);
    }
  }
  async function updateQty(encodedName, change) {
    const name = decodeURIComponent(encodedName);
    const input = document.querySelector(`input[data-name="${CSS.escape(name)}"]`);
    let current = parseInt(input?.value ?? '', 10);
    if (!Number.isFinite(current) || current < 0) current = 0;
    let next = current + change;
    if (next < 0) next = 0;
    if (input) input.value = next === 0 ? '' : String(next);
    await sb
      .from('inventory_management')
      .update({
        on_hand: next
      })
      .eq('product_name', name)
      .eq('user', 'Rony');
  }
  /***** Submit order (SAVE explicit 0s) *****/
  async function submitInventory() {
    const dateInput = document.getElementById('order-date').value;
    const orderDateISO = dateInputToLocalMidnightISO(dateInput);
    const products = [...document.querySelectorAll('.product-card')].map(card => {
      const name = card.querySelector('.product-name').textContent.trim();
      const raw = card.querySelector('input').value;
      const n = parseInt(raw, 10);
      const quantity = Number.isFinite(n) && n >= 0 ? n : 0;
      return {
        name,
        quantity,
        out_of_stock: quantity === 0
      };
    });
    const vendorList = 'General List';
    const {
      error: orderErr
    } = await sb.from('submitted_orders').insert([{
      order_date: new Date().toISOString(),
      vendor_list: vendorList,
      summary_details: products
    }]);
    if (orderErr) {
      console.error(orderErr);
      openModal('Error', 'Submit failed');
      return;
    }
    try {
      await sb.functions.invoke('send-email', {
        body: {
          to: ORDER_CONFIRMATION_TO,
          vendor: vendorList,
          orderDate: orderDateISO,
          items: products
        }
      });
    } catch (e) {
      console.warn('Email function error:', e);
    }
    for (const p of products) {
      await sb.from('inventory_check').insert([{
        order_date: new Date().toISOString(),
        product_name: p.name,
        on_hand: p.quantity,
        tentative: p.quantity,
        user: 'Rony'
      }]);
    }
    await sb.from('inventory_management')
      .update({
        on_hand: 0
      })
      .in('product_name', products.map(p => p.name))
      .eq('user', 'Rony');
    await displayLastOrder();
    await loadInventory();
    const footer = document.getElementById('order-history-footer');
    if (footer) footer.scrollIntoView({ behavior: 'smooth' });
    openModal('¡Éxito!', 'Gracias Rony por ayudarme a poner la orden', 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/daffy.jpg');
  }
  /***** Last order footer *****/
  async function displayLastOrder() {
    const cont = document.getElementById('last-order-details');
    if (!cont) return; // Add a check to prevent errors if the element doesn't exist
    cont.innerHTML = '<p class="text-center text-gray-400">Loading…</p>';
    const {
      data,
      error
    } = await sb
      .from('submitted_orders')
      .select('order_date,summary_details,vendor_list')
      .order('order_date', {
        ascending: false
      })
      .limit(1);
    if (error || !data || !data.length) {
      cont.innerHTML = '<p class="text-center text-gray-400">No orders.</p>';
      return;
    }
    const last = data[0];
    let details = [];
    if (Array.isArray(last.summary_details)) details = last.summary_details;
    else if (typeof last.summary_details === 'string') {
      try {
        details = JSON.parse(last.summary_details)
      } catch {
        details = []
      }
    }
    const items = details.map(i => `<li class="flex justify-between py-1 border-b border-gray-200 last:border-none text-black"><span>${i.name}</span><span>${i.quantity}</span></li>`).join('');
    cont.innerHTML = `<p class="text-sm text-black"><b>Vendor:</b> ${last.vendor_list}</p>
                     <p class="text-sm text-black"><b>Date:</b> ${formatCT(last.order_date)}</p>
                     <ul class="list-none m-0 p-0 mt-2">${items}</ul>`;

 (function attachExternalTabLoader(){
    const TAB_URLS = {
      'order-management': 'https://portal.jengchirestaurant.com/placeorder.html',
      'invoice-management': 'https://portal.jengchirestaurant.com/invoices.html',
      'general-order-list': 'https://portal.jengchirestaurant.com/rony.html',
      'kitchen-prep-list': 'https://portal.jengchirestaurant.com/julio.html',
      'check-management': 'https://portal.jengchirestaurant.com/check.html',
      'mooncake-management': 'https://portal.jengchirestaurant.com/shipping.html'
    };

    // A lightweight loader (spinning dots)
    const LOADING_HTML = `
      <div style="display:flex;align-items:center;justify-content:center;height:40vh;color:#6b7280;gap:.6rem;font:600 14px/1.4 Inter,system-ui,sans-serif;">
        <span>Loading…</span>
      </div>`;

    // Add a second click listener that runs alongside your existing one
    document.addEventListener('click', (e) => {
      const btn = e.target.closest('.tabBtn');
      if (!btn) return;
      const tab = btn.getAttribute('data-tab');
      const url = TAB_URLS[tab];
      if (!url) return; // not one of the mapped tabs

      const cont = document.getElementById('tab-content');
      if (!cont) return;

      // Show a quick loading state, then mount the iframe
      cont.innerHTML = LOADING_HTML;

      // Hide FAB by default; show only if you want it on a specific page
      const fab = document.getElementById('fab');
      if (fab) fab.classList.add('hidden');

      // Build iframe safely
      const frame = document.createElement('iframe');
      frame.src = url;
      frame.title = tab + ' — Jeng Chi';
      frame.style.width = '100%';
      frame.style.height = 'calc(100vh - 190px)'; // responsive viewport height
      frame.style.border = '0';
      frame.style.borderRadius = '12px';
      frame.loading = 'eager';
      frame.referrerPolicy = 'no-referrer-when-downgrade';

      // Swap in the iframe (tiny delay so the loading UI paints)
      requestAnimationFrame(() => {
        cont.innerHTML = '';
        cont.appendChild(frame);
      });
    });
  })();

    
  }
</script>
<!-- Paste this snippet **AFTER** your existing <script> block in the same file.
     It does not change or remove your current code. It only adds a second
     click handler that swaps the #tab-content with an iframe pointing to
     each external page you specified. -->


  
</body>
</html>

