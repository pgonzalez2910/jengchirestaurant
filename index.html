<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Inventory Management System</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      --jc-accent:#7A3D36;
      --jc-accent-dark:#5c2e29;
      --surface:#ffffff;
      --bg:#f5f6f8;
      --ink:#0f172a;
      --muted:#6b7280;
      --border:#e5e7eb;
    }
    html, body { height:100%; }
    body{
      margin:0;
      background:var(--bg);
      font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink);
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* ---------- LOGIN ---------- */
    .login-wrap{ min-height:100vh; display:grid; place-items:center; padding:28px; }
    .login-card{
      width:min(980px, 96vw);
      background:var(--surface);
      border-radius:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.10);
      display:grid;
      grid-template-columns:1.1fr 1fr;
      gap:28px;
      padding:28px;
    }
    .brand-side{ display:flex; flex-direction:column; align-items:center; justify-content:center; border-right:1px solid var(--border); padding:12px 8px; }
    .brand-side img{ width:min(360px, 90%); height:auto; object-fit:contain; mix-blend:multiply; }
    .brand-title{ margin-top:10px; font-weight:800; letter-spacing:.4px; font-size:.9rem; color:var(--jc-accent); text-align:center; }
    .form-side{ display:flex; align-items:center; }
    .form{ width:100%; max-width:420px; margin-inline:auto; }
    .form h2{ font-size:1.15rem; font-weight:800; margin:0 0 12px; color:var(--ink); }
    .fg{ margin:12px 0; }
    .fg label{ display:block; font-size:.95rem; font-weight:600; margin:0 0 6px; color:#374151; }
    .fg input{
      width:100%; padding:11px 14px; border:1px solid var(--border); border-radius:12px; background:#fff; font-size:1rem;
      outline:none; transition:border-color .15s, box-shadow .15s;
    }
    .fg input:focus{ border-color:var(--jc-accent); box-shadow:0 0 0 3px rgba(122,61,54,.10); }
    .btn{
      width:100%; padding:11px 16px; border:0; border-radius:12px; font-weight:800; font-size:1.02rem; color:#fff;
      background:linear-gradient(90deg,#34D399,#10B981); box-shadow:0 6px 16px rgba(16,185,129,.25); cursor:pointer; transition:transform .06s ease;
    }
    .btn:active{ transform:translateY(1px); }
    .err{ color:#DC2626; font-weight:700; margin:8px 0 0; display:none; }

    @media (max-width: 900px){
      .login-card{ grid-template-columns:1fr; padding:22px; }
      .brand-side{ border-right:0; border-bottom:1px solid var(--border); padding-bottom:16px; }
    }

    /* ---------- EXECUTIVE HEADER (NEW LAYOUT) ---------- */
    .header{
      position:sticky; top:0; z-index:30;
      background:#fff; border-bottom:1px solid var(--border);
      box-shadow:0 2px 8px rgba(0,0,0,.06);
    }
    .header-inner{
      max-width:1200px;
      margin:0 auto;
      padding:10px 16px 8px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    /* Row 1: left small title, center logo, right logout */
    .top-row{
      display:grid;
      grid-template-columns:1fr auto auto;
      align-items:center;
      column-gap:12px;
    }
    .app-title{
      font-weight:800;
      color:var(--ink);
      /* ~50% reduction */
      font-size:.72rem;
      letter-spacing:.15px;
      white-space:nowrap;
    }
    .logo-wrap{
      justify-self:center;
      display:flex; align-items:center;
    }
    .logo{ height:72px; width:auto; border-radius:10px; mix-blend:multiply; }
    .logout{ justify-self:end; padding:9px 14px; border-radius:10px; border:0; background:#DC2626; color:#fff; font-weight:800; cursor:pointer; transition:filter .15s, transform .06s; }
    .logout:hover{ filter:brightness(.95); transform:translateY(-1px); }

    /* Row 2: full-width menu, evenly distributed across the page */
    .menu-row{ display:flex; justify-content:center; }
    .tabs{
      display:flex; justify-content:space-between; align-items:center;
      gap:8px; width:100%; max-width:1200px;
      padding:2px 6px 8px;
      flex-wrap:wrap;
    }
    .tab{
      padding:8px 10px;
      border-radius:10px;
      border:1px solid transparent;
      font-weight:800;
      font-size:0.72rem;           /* compact menu text */
      letter-spacing:.2px;
      color:#374151;
      background:transparent;
      cursor:pointer;
      transition:background .15s,color .15s,transform .06s;
    }
    .tab:hover{ background:#f3f4f6; transform:translateY(-1px); }
    .tab.active{
      color:#fff;
      background:linear-gradient(90deg,var(--jc-accent),var(--jc-accent-dark));
      box-shadow:0 4px 12px rgba(0,0,0,.12);
    }

    @media (max-width:900px){
      .logo{ height:56px; }
      .app-title{ font-size:.66rem; }
    }

    /* ---------- MAIN LAYOUT (FULL SIZE) ---------- */
    .main { flex:1; display:flex; min-height:0; }
    .frame-wrap{ position:relative; flex:1; min-height:0; }
    .module-frame{
      position:relative; z-index:1;
      width:100%;
      height:100%;
      border:0;
      background:#fff;
    }
    .loader{
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      z-index:2; background:rgba(255,255,255,.6);
    }
    .spin{ width:44px; height:44px; border-radius:999px; border:4px solid #e5e7eb; border-top-color:var(--jc-accent); animation:spin .9s linear infinite; }
    @keyframes spin{ to { transform:rotate(360deg); } }

    .footer{
      background:linear-gradient(135deg,#1f2937,#000); color:#fff; text-align:center; padding:8px 10px;
      border-top:1px solid #4b5563; font-size:.70rem; font-weight:700;
    }
  </style>
</head>
<body>

  <!-- ============ LOGIN ============ -->
  <section id="login" class="login-wrap">
    <div class="login-card">
      <div class="brand-side">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
        <div class="brand-title">JENG CHI INVENTORY MANAGEMENT SYSTEM</div>
      </div>
      <div class="form-side">
        <form id="loginForm" class="form">
          <h2>Sign in</h2>
          <input type="text" style="display:none" autocomplete="off">
          <input type="password" style="display:none" autocomplete="off">
          <div class="fg">
            <label for="u">Username</label>
            <input id="u" autocomplete="off" required>
          </div>
          <div class="fg">
            <label for="p">Password</label>
            <input id="p" type="password" autocomplete="new-password" inputmode="numeric" pattern="[0-9]*" required>
          </div>
          <div id="err" class="err"></div>
          <button type="submit" class="btn">Login</button>
        </form>
      </div>
    </div>
  </section>

  <!-- ============ APP SHELL ============ -->
  <section id="app" style="display:none; min-height:100vh; display:flex; flex-direction:column;">
    <header class="header">
      <div class="header-inner">

        <!-- Row 1 -->
        <div class="top-row">
          <div class="app-title">Jeng Chi Inventory Management System</div>
          <div class="logo-wrap">
            <img class="logo" src="https://raw.githubusercontent.com/pgonzalez2910/jengchilogo.jpg" alt="Jeng Chi">
          </div>
          <button id="logoutBtn" class="logout">Logout</button>
        </div>

        <!-- Row 2 -->
        <div class="menu-row">
          <nav id="tabs" class="tabs">
            <button class="tab" data-page="check">Check Management</button>
            <button class="tab" data-page="order">Order Management</button>
            <button class="tab" data-page="rony">General Order List</button>
            <button class="tab" data-page="julio">Kitchen Prep List</button>
          </nav>
        </div>

      </div>
    </header>

    <main class="main">
      <div class="frame-wrap">
        <div id="loader" class="loader" style="display:flex;"><div class="spin"></div></div>
        <iframe id="frame" class="module-frame" title="Module"></iframe>
      </div>
    </main>

    <footer class="footer">
      Jeng Chi Inventory Management System • Designed by Pablo Gonzalez • v1
    </footer>
  </section>

  <script>
    /* ========= CONFIG ========= */
    const MODULE_BASE = 'https://portal.jengchirestaurant.com/';

    // Supabase
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ACL
    const ACL = {
      PG:{tabs:['check','order','rony','julio'], default:'check'},
      JT:{tabs:['check','order','rony','julio'], default:'check'},
      FT:{tabs:['check','order','rony','julio'], default:'check'},
      RC:{tabs:['rony'],  default:'rony'},
      JM:{tabs:['julio'], default:'julio'}
    };
    const TAB_MAP = {
      check: 'check.html',
      order: 'placeorder.html',
      rony:  'rony.html',
      julio: 'julio.html'
    };

    /* ========= DOM ========= */
    const $  = (s, r=document)=>r.querySelector(s);
    const $$ = (s, r=document)=>Array.from(r.querySelectorAll(s));
    const loginSec = $('#login');
    const appSec   = $('#app');
    const uInput   = $('#u');
    const pInput   = $('#p');
    const errBox   = $('#err');
    const tabsWrap = $('#tabs');
    const frame    = $('#frame');
    const loader   = $('#loader');
    $('#logoutBtn')?.addEventListener('click', logout);

    function showError(m){ errBox.textContent=m; errBox.style.display='block'; }
    function hideError(){ errBox.style.display='none'; }
    function setActiveTab(key){ $$('.tab',tabsWrap).forEach(b=>b.classList.toggle('active', b.dataset.page===key)); }

    function mountModule(key){
      const filename = TAB_MAP[key] || TAB_MAP.check;
      const absolute = new URL(filename, MODULE_BASE).toString();

      setActiveTab(key);
      loader.style.display = 'flex';

      frame.src = absolute;
      frame.onload  = () => { loader.style.display = 'none'; };
      frame.onerror = () => {
        loader.style.display = 'none';
        frame.srcdoc = `<div style="padding:24px;font-family:Inter,system-ui">
            <h2>Could not load <code>${filename}</code></h2>
            <p>Tried URL: <code>${absolute}</code></p>
          </div>`;
      };
    }

    function showApp(defaultKey){
      loginSec.style.display='none';
      appSec.style.display='flex';
      mountModule(defaultKey);
    }
    function logout(){
      localStorage.clear();
      appSec.style.display='none';
      loginSec.style.display='grid';
      uInput.value=''; pInput.value='';
      uInput.focus();
    }

    // Tabs
    tabsWrap.addEventListener('click', (e)=>{
      const btn=e.target.closest('.tab'); if(!btn) return;
      e.preventDefault();
      const key = btn.dataset.page;
      localStorage.setItem('lastPage', key);
      mountModule(key);
    });

    // Restore session
    (function init(){
      const session = JSON.parse(localStorage.getItem('userPermissions')||'null');
      if(session?.username){
        const acl = ACL[session.username] || {tabs:['check'], default:'check'};
        $$('.tab', tabsWrap).forEach(b => { b.style.display = acl.tabs.includes(b.dataset.page) ? '' : 'none'; });
        const last = localStorage.getItem('lastPage') || acl.default;
        showApp(last);
      }else{
        loginSec.style.display='grid';
      }
    })();

    // Login
    $('#loginForm').addEventListener('submit', async (ev)=>{
      ev.preventDefault(); hideError();
      const username = (uInput.value||'').trim();
      const password = pInput.value;
      if(!username || !password){ return showError('Please enter both username and password.'); }
      try{
        const {data, error} = await supabaseClient
          .from('users')
          .select('username, password, role, departments')
          .ilike('username', username)
          .maybeSingle();

        if(error) throw error;
        if(!data || String(data.password) !== String(password)){
          throw new Error('Invalid username or password.');
        }

        const canonicalUser = data.username;
        const acl = ACL[canonicalUser] || {tabs:['check'], default:'check'};

        localStorage.setItem('userPermissions', JSON.stringify({
          role: data.role,
          departments: data.departments,
          username: canonicalUser,
          tabs: acl.tabs
        }));
        $$('.tab', tabsWrap).forEach(b => { b.style.display = acl.tabs.includes(b.dataset.page) ? '' : 'none'; });

        const start = localStorage.getItem('lastPage') || acl.default;
        showApp(start);
      }catch(err){
        console.error(err);
        showError(err.message || 'Unexpected error. Please try again.');
      }
    });
  </script>
</body>
</html>
