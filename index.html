<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Jeng Chi Inventory Management System</title>
  <!-- Tailwind first -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  <!-- Supabase v2 UMD -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{ --jc-brown:#7A3D36; --jc-deep:#5f302b; }
    html, body{ height:100%; }
    body{ font-family:'Montserrat',sans-serif; margin:0; display:flex; flex-direction:column; min-height:100vh; background:#f8fafc; color:#111827; }
    /* Layout regions */
    #app-root{ flex:1 1 auto; display:flex; flex-direction:column; min-height:0; }
    /* ---- Executive Login Card ---- */
    .login-wrap{ flex:1 1 auto; display:flex; align-items:center; justify-content:center; padding:2rem 1rem; }
    .card-shell{ position:relative; width:100%; max-width:1000px; }
    .card-glow{ position:absolute; inset:-10px; border-radius:20px; background:linear-gradient(90deg, rgba(255,200,150,.25), rgba(255,170,170,.25), rgba(150,250,200,.25)); filter:blur(18px); }
    .login-card{ position:relative; display:grid; grid-template-columns:1fr; background:rgba(255,255,255,.96); border:1px solid rgba(0,0,0,.05); border-radius:16px; box-shadow:0 25px 60px rgba(0,0,0,.12); overflow:hidden; }
    @media(min-width: 900px){ .login-card{ grid-template-columns:1fr 1fr; } }
    .brand-pane{ display:none; padding:2.2rem; background:radial-gradient(120% 120% at 0% 0%, rgba(122,61,54,.07), #fff 60%); align-items:center; justify-content:center; text-align:center; }
    @media(min-width: 900px){ .brand-pane{ display:flex; flex-direction:column; gap:14px; } }
    .logo-clean{ width:100%; max-width:240px; height:auto; margin:0 auto; display:block; mix-blend-mode:multiply; filter:brightness(0.98) contrast(1.12); background:transparent; }
    .app-title{ color:var(--jc-brown); font-weight:800; font-size:0.9rem; letter-spacing:.03em; text-transform:uppercase; }
    .form-pane{ padding:2rem; display:flex; align-items:center; justify-content:center; background:#fff; }
    .form-card{ width:100%; max-width:380px; }
    .form-group{ margin-bottom:1rem; }
    .form-group label{ display:block; margin-bottom:.45rem; font-weight:700; color:#374151; font-size:.95rem; }
    .form-input{ width:100%; padding:.8rem 1rem; border:1px solid #d1d5db; border-radius:12px; font-size:1rem; transition:border-color .2s, box-shadow .2s; background:#fff; }
    .form-input:focus{ outline:none; border-color:var(--jc-brown); box-shadow:0 0 0 4px rgba(122,61,54,.12); }
    .login-btn{ width:100%; background:linear-gradient(90deg,#7A3D36,#5f302b); color:#fff; padding:.9rem 1rem; border:none; border-radius:12px; font-weight:800; letter-spacing:.02em; box-shadow:0 8px 20px rgba(122,61,54,.25); cursor:pointer; }
    .login-btn:hover{ filter:brightness(1.02); transform:translateY(-1px); }
    .error-message{ color:#DC2626; font-weight:700; text-align:center; }
    /* ---- Dashboard Shell ---- */
    .navbar{ flex:0 0 auto; background:#fff; padding:.8rem 1.25rem; box-shadow:0 2px 4px rgba(0,0,0,.08); display:flex; justify-content:space-between; align-items:center; position:sticky; top:0; z-index:100; width:100%; }
    .nav-links a{ font-weight:700; color:#4B5563; padding:.45rem .9rem; border-radius:10px; transition:background-color .2s,color .2s; }
    .nav-links a:hover{ background:#F3F4F6; color:#111827; }
    .nav-links a.active{ background:linear-gradient(90deg,var(--jc-brown),var(--jc-deep)); color:#fff; box-shadow:0 2px 6px rgba(0,0,0,.15); }
    .logout-btn{ background:#DC2626; color:#fff; padding:.5rem 1.2rem; border-radius:10px; font-weight:700; cursor:pointer; transition:background-color .2s,transform .1s; }
    .logout-btn:hover{ background:#B91C1C; transform:translateY(-1px); }
    #dashboard{ flex:1 1 auto; min-height:0; display:flex; flex-direction:column; }
    .page-content{ margin:0; width:100%; flex:1 1 auto; min-height:0; display:flex; flex-direction:column; }
    .frame-wrap{ flex:1 1 auto; min-height:0; display:flex; position:relative; }
    .module-frame{ flex:1 1 auto; min-height:0; width:100%; height:100%; border:none; }
    /* ---- Footer (tiny) ---- */
    footer{ flex:0 0 auto; text-align:center; padding:.25rem .5rem; background:#111827; color:#fff; font-size:.55rem; }
    footer p{ margin:2px 0; }
  </style>
</head>
<body>
  <div id="app-root">
    <!-- ===================== LOGIN ===================== -->
    <section id="login-section" class="login-wrap">
      <div class="card-shell">
        <div class="card-glow"></div>
        <div class="login-card">
          <!-- Brand / Left Panel -->
          <div class="brand-pane">
            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="logo-clean" />
            <div class="app-title">JENG CHI INVENTORY MANAGEMENT SYSTEM</div>
          </div>
          <!-- Form / Right Panel -->
          <div class="form-pane">
            <div class="form-card">
              <form id="login-form" class="space-y-4">
                <!-- Safari/Chrome autocomplete decoys -->
                <input type="text" style="display:none" name="username_dummy" autocomplete="off">
                <input type="password" style="display:none" name="password_dummy" autocomplete="off">

                <div class="form-group">
                  <label for="username">Username</label>
                  <input id="username" name="username" type="text" required autocomplete="off" class="form-input" placeholder="" />
                </div>

                <div class="form-group">
                  <label for="password">Password</label>
                  <input id="password" name="password" type="password" inputmode="numeric" pattern="[0-9]*" required autocomplete="new-password" class="form-input" placeholder="4-6 digits" />
                </div>

                <p id="error-message" class="error-message hidden text-sm"></p>
                <button type="submit" id="login-btn" class="login-btn">Login</button>
                <p class="mt-2 text-[11px] text-center text-gray-500">Authorized use only.</p>
              </form>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- ===================== DASHBOARD ===================== -->
    <section id="dashboard" class="hidden"></section>
  </div>

  <!-- ===================== FOOTER ===================== -->
  <footer>
    <p>Jeng Chi Inventory Management System</p>
    <p>Designed by Pablo Gonzalez</p>
    <p><span id="year"></span> | v1</p>
  </footer>

  <script>
    // Year in footer
    document.getElementById('year').textContent = new Date().getFullYear();

    // ===== Supabase Config =====
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ===== ACL =====
    const ACL = {
      PG: { tabs: ["check", "order", "rony", "julio"], defaultPage: "check" },
      JT: { tabs: ["check", "order", "rony", "julio"], defaultPage: "check" },
      FT: { tabs: ["check", "order", "rony", "julio"], defaultPage: "check" },
      RC: { tabs: ["rony"], defaultPage: "rony" },
      JM: { tabs: ["julio"], defaultPage: "julio" }
    };

    // ===== Tab Mapping =====
    const RAW_BASE = 'https://raw.githubusercontent.com/pgonzalez2910/jengchirestaurant/main/';
    const TAB_MAP = { check: 'check.html', order: 'placeorder.html', rony: 'rony.html', julio: 'julio.html' };
    const TAB_LABELS = { check: 'Check Management', order: 'Order Management', rony: 'General Order List', julio: 'Kitchen Prep List' };

    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard');
    const loginForm = document.getElementById('login-form');
    const errorMessage = document.getElementById('error-message');
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');

    function showLogin(){ loginSection.classList.remove('hidden'); dashboardSection.classList.add('hidden'); }
    function showDashboard(defaultPage){ loginSection.classList.add('hidden'); dashboardSection.classList.remove('hidden'); renderPage(defaultPage); }
    function logout(){ localStorage.removeItem('userPermissions'); localStorage.removeItem('currentUser'); showLogin(); }

    async function mountModuleIntoFrame(pageKey){
      const path = TAB_MAP[pageKey];
      const url = RAW_BASE + path;
      const frame = document.getElementById('moduleFrame');
      try {
        const res = await fetch(url);
        const html = await res.text();
        const withBase = html.replace('<head>', `<head><base href="${RAW_BASE}">`);
        const blob = new Blob([withBase], { type: 'text/html' });
        const blobUrl = URL.createObjectURL(blob);
        frame.src = blobUrl;
      } catch (err) {
        console.error('[MODULE_LOAD_ERROR]', err);
        frame.srcdoc = `<div style="font-family:Montserrat,Arial;padding:20px"><h2>Failed to load ${url}</h2></div>`;
      }
    }

    function renderPage(pageKey){
      const userPermissions = JSON.parse(localStorage.getItem('userPermissions'));
      const allowed = userPermissions?.tabs || [];
      if (!allowed.includes(pageKey)) pageKey = allowed[0] || 'check';

      dashboardSection.innerHTML = `
        <div class="navbar">
          <div class="flex items-center gap-3">
            <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="h-10 rounded" />
            <h1 class="text-xl font-extrabold text-gray-800">Jeng Chi Inventory Management System</h1>
          </div>
          <nav class="nav-links space-x-2">
            ${allowed.map(tab => `<a href="#" data-page="${tab}" class="${pageKey === tab ? 'active' : ''}">${TAB_LABELS[tab]}</a>`).join('')}
          </nav>
          <button id="logoutBtn" class="logout-btn">Logout</button>
        </div>
        <div class="page-content">
          <div class="frame-wrap">
            <iframe id="moduleFrame" class="module-frame" title="${TAB_LABELS[pageKey]}"></iframe>
          </div>
        </div>`;

      dashboardSection.querySelectorAll('a[data-page]').forEach(link => {
        link.addEventListener('click', (e) => { e.preventDefault(); const newKey = e.currentTarget.getAttribute('data-page'); localStorage.setItem('lastPage', newKey); renderPage(newKey); });
      });
      dashboardSection.querySelector('#logoutBtn')?.addEventListener('click', logout);
      mountModuleIntoFrame(pageKey);
    }

    // Restore session if present
    document.addEventListener('DOMContentLoaded', () => {
      const saved = JSON.parse(localStorage.getItem('userPermissions'));
      if (saved) {
        const acl = ACL[saved.username] || { tabs: saved.tabs || [], defaultPage: 'check' };
        const start = localStorage.getItem('lastPage') || acl.defaultPage || 'check';
        showDashboard(start);
      }
    });

    // Login handler
    let isSubmitting = false;
    loginForm?.addEventListener('submit', async (e) => {
      e.preventDefault(); if (isSubmitting) return; isSubmitting = true; errorMessage.classList.add('hidden');
      try {
        let username = (usernameInput.value || '').trim();
        const password = passwordInput.value;
        if (!username || !password) throw new Error('Please enter both username and password.');
        username = username.toUpperCase(); // normalize to match ACL keys
        const { data, error } = await supabaseClient
          .from('users')
          .select('username, password, role, departments')
          .eq('username', username)
          .maybeSingle();
        if (error) throw error;
        if (!data || data.password !== password) throw new Error('Invalid username or password.');
        const acl = ACL[username] || { tabs: ['check'], defaultPage: 'check' };
        localStorage.setItem('userPermissions', JSON.stringify({ role: data.role, departments: data.departments, username, tabs: acl.tabs }));
        localStorage.setItem('currentUser', username);
        const start = localStorage.getItem('lastPage') || acl.defaultPage; showDashboard(start);
      } catch (err) {
        console.error('[LOGIN_ERROR]', err); errorMessage.textContent = err.message || 'Unexpected error. Please try again.'; errorMessage.classList.remove('hidden');
      } finally { isSubmitting = false; }
    });
  </script>
</body>
</html>
