<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Jeng Chi ‚Äî Admin Portal</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .fade-in { animation: fadeIn 0.35s ease forwards; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(6px); } to { opacity:1; transform:translateY(0); } }
    .slide-in { animation: slideIn 0.3s ease forwards; }
    @keyframes slideIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }
    .emp-row { transition: background 0.12s; cursor:pointer; }
    .emp-row:hover { background:#fdf8f0; }
    .emp-row.selected { background:#fef3e2; }
    .field-input {
      width:100%; border:1px solid #E2E8F0; border-radius:10px;
      padding:8px 12px; font-size:13px; outline:none; background:#fff;
      transition: border-color 0.15s, box-shadow 0.15s;
    }
    .field-input:focus { border-color:#C0A06D; box-shadow:0 0 0 3px rgba(192,160,109,.15); }
    .field-input.changed { border-color:#F59E0B; background:#fffbf0; }
    .field-input.saving  { border-color:#C0A06D; background:#fffbf5; }
    .field-input.saved   { border-color:#10B981; background:#f0fdf4; }
    .badge { display:inline-block; padding:2px 10px; border-radius:999px; font-size:11px; font-weight:600; }
    .badge-active     { background:#d1fae5; color:#065f46; }
    .badge-terminated { background:#fee2e2; color:#991b1b; }
    .badge-other      { background:#f1f5f9; color:#475569; }
    .tab-btn { padding:7px 18px; border-radius:9px; font-size:12px; font-weight:600; transition:all 0.15s; }
    .tab-btn.active { background:#C0A06D; color:#fff; }
    .tab-btn:not(.active) { color:#64748b; }
    .tab-btn:not(.active):hover { background:#f8f4ef; }
    ::-webkit-scrollbar { width:4px; }
    ::-webkit-scrollbar-track { background:#f1f5f9; }
    ::-webkit-scrollbar-thumb { background:#C0A06D55; border-radius:4px; }
    select.field-input { cursor:pointer; }
    input[type=number]::-webkit-inner-spin-button { -webkit-appearance:none; }
  </style>
</head>
<body class="min-h-screen bg-slate-50 text-slate-800">

<div class="fixed inset-0 -z-10 bg-gradient-to-b from-white via-[#faf7f3] to-[#f3f0ea]"></div>
<div class="fixed inset-0 -z-10 pointer-events-none opacity-20"
     style="background:radial-gradient(800px 400px at 50% -50%,rgba(192,160,109,.3),transparent 60%)"></div>

<!-- =================== LOGIN =================== -->
<main id="loginView" class="min-h-screen flex items-center justify-center p-6">
  <section class="w-full max-w-[440px] rounded-2xl bg-white/85 backdrop-blur-md shadow-xl border border-slate-200">
    <div class="p-8">
      <div class="flex justify-center">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi" class="h-16 w-auto rounded-xl shadow-md object-contain"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI2MCIgeT0iNjAiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SkM8L3RleHQ+PC9zdmc+'"/>
      </div>
      <h1 style="font-family:'Playfair Display',serif" class="text-2xl text-center mt-5 text-slate-800">Admin Portal</h1>
      <p class="text-center text-sm text-slate-500 mt-1">Employee Management System</p>
      <div class="mt-7 space-y-4">
        <div>
          <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-1.5">Username</label>
          <input id="loginUser" type="text" class="field-input" placeholder="Your username"/>
        </div>
        <div>
          <label class="block text-xs font-semibold text-slate-600 uppercase tracking-wider mb-1.5">PIN</label>
          <input id="loginPin" type="password" inputmode="numeric" maxlength="8" class="field-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢"/>
        </div>
        <button id="btnLogin" class="w-full rounded-xl py-3 text-sm font-semibold text-white hover:opacity-90 transition-opacity"
                style="background:#C0A06D">Access Admin Panel</button>
        <p id="loginMsg" class="text-sm text-center text-red-500 min-h-[20px]"></p>
      </div>
      <p class="mt-6 text-center text-[11px] text-slate-400">Jeng Chi Restaurant ¬∑ HR Administration</p>
    </div>
  </section>
</main>

<!-- =================== APP =================== -->
<div id="appView" class="hidden fade-in">

  <!-- Navbar -->
  <header class="sticky top-0 z-30 bg-white/85 backdrop-blur-md border-b border-slate-200 shadow-sm">
    <div class="max-w-screen-2xl mx-auto px-5 flex items-center justify-between py-3">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="" class="h-9 w-auto rounded-lg object-contain"
             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI4MCIgaGVpZ2h0PSI4MCIgdmlld0JveD0iMCAwIDgwIDgwIj48cmVjdCB3aWR0aD0iODAiIGhlaWdodD0iODAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI0MCIgeT0iNDAiIGZvbnQtc2l6ZT0iMTAiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+SkM8L3RleHQ+PC9zdmc+'"/>
        <div>
          <div style="font-family:'Playfair Display',serif" class="text-base text-slate-800 leading-tight">Jeng Chi</div>
          <div class="text-[10px] text-slate-500 leading-tight">Admin ¬∑ Employee Manager</div>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <div id="saveIndicator" class="hidden text-xs text-emerald-600 font-semibold bg-emerald-50 border border-emerald-200 rounded-full px-3 py-1">‚úì Saved</div>
        <span id="adminBadge" class="text-xs font-semibold text-amber-700 bg-amber-50 border border-amber-200 rounded-full px-3 py-1.5"></span>
        <button id="btnLogout" class="text-xs text-slate-400 hover:text-red-500 font-medium transition-colors">Sign Out</button>
      </div>
    </div>
  </header>

  <div class="max-w-screen-2xl mx-auto px-5 py-5 flex gap-5" style="min-height:calc(100vh - 56px)">

    <!-- LEFT SIDEBAR -->
    <div class="w-72 flex-shrink-0 flex flex-col gap-3">

      <!-- Stats -->
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-white rounded-xl border border-slate-200 p-3 shadow-sm text-center">
          <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wider">Total</p>
          <p id="statTotal" class="text-2xl font-bold text-slate-800">‚Äî</p>
        </div>
        <div class="bg-white rounded-xl border border-slate-200 p-3 shadow-sm text-center">
          <p class="text-[10px] text-slate-500 font-semibold uppercase tracking-wider">Active</p>
          <p id="statActive" class="text-2xl font-bold text-emerald-600">‚Äî</p>
        </div>
      </div>

      <!-- Search + List -->
      <div class="bg-white rounded-xl border border-slate-200 shadow-sm overflow-hidden flex flex-col" style="max-height:calc(100vh - 190px)">
        <div class="p-2.5 border-b border-slate-100 flex gap-2">
          <input id="searchInput" type="text" placeholder="Search‚Ä¶"
            class="field-input flex-1" style="padding:6px 10px; font-size:12px"/>
          <button id="btnAddMember" title="Add New Employee"
            class="w-9 h-9 flex-shrink-0 rounded-xl flex items-center justify-center text-white text-xl font-light hover:opacity-85 transition-opacity"
            style="background:#C0A06D; line-height:1">+</button>
        </div>
        <div class="px-2.5 pt-1.5 pb-1">
          <select id="filterStatus" class="field-input" style="padding:5px 9px; font-size:12px">
            <option value="">All Status</option>
            <option value="Active">Active</option>
            <option value="Inactive">Inactive</option>
            <option value="Terminated">Terminated</option>
          </select>
        </div>
        <div id="empList" class="overflow-y-auto flex-1 py-1"></div>
        <div class="px-3 py-2 border-t border-slate-100 text-[11px] text-slate-400 flex justify-between items-center">
          <span id="listCount">‚Äî</span>
          <div class="flex gap-1">
            <button id="btnPrev" class="px-2 py-0.5 rounded border border-slate-200 hover:bg-slate-50 disabled:opacity-30 text-xs" disabled>‚Äπ</button>
            <button id="btnNext" class="px-2 py-0.5 rounded border border-slate-200 hover:bg-slate-50 disabled:opacity-30 text-xs" disabled>‚Ä∫</button>
          </div>
        </div>
      </div>
    </div>

    <!-- RIGHT: EDITOR -->
    <div class="flex-1 min-w-0 overflow-y-auto" style="max-height:calc(100vh - 70px)">

      <!-- Empty state -->
      <div id="emptyState" class="h-full flex flex-col items-center justify-center text-slate-400 min-h-96">
        <div class="text-5xl mb-4">üë§</div>
        <p class="text-base font-medium text-slate-500">Select an employee to edit</p>
        <p class="text-sm mt-1">or click <span class="font-bold text-amber-500 text-base">+</span> to add a new member</p>
      </div>

      <!-- Editor -->
      <div id="editorPanel" class="hidden space-y-4 pb-8">

        <!-- Header card -->
        <div class="bg-white rounded-2xl border border-slate-200 shadow-sm p-5 flex items-center justify-between gap-4">
          <div class="flex items-center gap-4">
            <div id="edAvatar" class="w-14 h-14 rounded-full flex items-center justify-center text-white text-xl font-bold flex-shrink-0"
                 style="background:#C0A06D">?</div>
            <div>
              <h2 id="edTitle" style="font-family:'Playfair Display',serif" class="text-xl text-slate-800 leading-tight">New Employee</h2>
              <p id="edSubtitle" class="text-sm text-slate-500 mt-0.5">Fill in the fields below</p>
            </div>
          </div>
          <div class="flex items-center gap-2 flex-shrink-0">
            <span id="edStatusBadge" class="badge badge-other">‚Äî</span>
            <button id="btnDeleteEmployee" class="hidden text-xs text-red-400 hover:text-red-600 border border-red-200 hover:border-red-400 rounded-lg px-3 py-1.5 font-medium transition-colors">
              üóë Delete
            </button>
          </div>
        </div>

        <!-- Tabs -->
        <div class="flex gap-1.5 bg-white rounded-xl border border-slate-200 p-1.5 shadow-sm w-fit">
          <button class="tab-btn active" data-tab="access">üîê Access</button>
          <button class="tab-btn" data-tab="personal">üë§ Personal</button>
          <button class="tab-btn" data-tab="job">üíº Job</button>
          <button class="tab-btn" data-tab="contact">üìû Contact</button>
        </div>

        <!-- TAB: ACCESS -->
        <div id="tab-access" class="tab-content bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pb-3 mb-4 border-b border-slate-100">Login Credentials</h3>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Username <span class="text-red-400">*</span></label>
              <input id="f_username" class="field-input" placeholder="e.g. PG" data-field="username"/>
              <p class="text-[11px] text-slate-400 mt-1">Used to sign in to all Jeng Chi portals</p>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">PIN <span class="text-red-400">*</span></label>
              <div class="relative">
                <input id="f_pin" class="field-input pr-20" type="password" inputmode="numeric" maxlength="8" placeholder="4‚Äì8 digits" data-field="pin"/>
                <div class="absolute right-2 top-1/2 -translate-y-1/2 flex gap-1">
                  <button type="button" id="btnTogglePin" class="text-[10px] text-slate-400 hover:text-slate-700 px-1.5 py-0.5 rounded border border-slate-200 bg-white">Show</button>
                  <button type="button" id="btnGenNewPin" class="text-[10px] text-amber-700 hover:text-amber-900 px-1.5 py-0.5 rounded border border-amber-200 bg-amber-50">Gen</button>
                </div>
              </div>
              <p id="pinStrength" class="text-[11px] mt-1 text-slate-400"></p>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Status</label>
              <select id="f_status" class="field-input" data-field="status">
                <option value="Active">Active</option>
                <option value="Inactive">Inactive</option>
                <option value="Terminated">Terminated</option>
                <option value="Leave">On Leave</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Employment Type</label>
              <select id="f_employment_type" class="field-input" data-field="employment_type">
                <option value="">Select‚Ä¶</option>
                <option value="FT">Full Time (FT)</option>
                <option value="PT">Part Time (PT)</option>
              </select>
            </div>
          </div>
          <div class="mt-5 bg-amber-50 border border-amber-200 rounded-xl p-4 text-sm text-amber-800">
            ‚ö° <strong>Auto-save:</strong> Changes to any field save automatically 0.9s after you stop typing. Or click <strong>Save All</strong> to force save everything.
          </div>
        </div>

        <!-- TAB: PERSONAL -->
        <div id="tab-personal" class="tab-content hidden bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pb-3 mb-4 border-b border-slate-100">Personal Information</h3>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">First Name <span class="text-red-400">*</span></label>
              <input id="f_first_name" class="field-input" placeholder="First name" data-field="first_name"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Last Name <span class="text-red-400">*</span></label>
              <input id="f_last_name" class="field-input" placeholder="Last name" data-field="last_name"/>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Date of Birth</label>
              <input id="f_date_of_birth" class="field-input" type="date" data-field="date_of_birth"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">SSN</label>
              <input id="f_ssn" class="field-input" maxlength="11" placeholder="XXX-XX-XXXX" data-field="ssn"/>
            </div>
          </div>
          <div class="mb-5">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Address Line 1</label>
            <input id="f_address_line_1" class="field-input" placeholder="Street address" data-field="address_line_1"/>
          </div>
          <div class="grid grid-cols-3 gap-4 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">City</label>
              <input id="f_city" class="field-input" placeholder="City" data-field="city"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">State</label>
              <input id="f_state" class="field-input" placeholder="TX" maxlength="2" data-field="state"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">ZIP</label>
              <input id="f_zip_code" class="field-input" placeholder="75081" maxlength="10" data-field="zip_code"/>
            </div>
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Original Hire Date</label>
            <input id="f_original_hire_date" class="field-input" type="date" data-field="original_hire_date"/>
          </div>
        </div>

        <!-- TAB: JOB -->
        <div id="tab-job" class="tab-content hidden bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pb-3 mb-4 border-b border-slate-100">Job Information</h3>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Job Title</label>
              <input id="f_job_title" class="field-input" placeholder="e.g. Server, Cook" data-field="job_title"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Position Title</label>
              <input id="f_position_title" class="field-input" placeholder="e.g. Lead Server" data-field="position_title"/>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Department</label>
              <select id="f_department" class="field-input" data-field="department">
                <option value="">Select‚Ä¶</option>
                <option value="FOH">Front of House (FOH)</option>
                <option value="BOH">Back of House (BOH)</option>
                <option value="Management">Management</option>
                <option value="Admin">Admin</option>
              </select>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Compensation Type</label>
              <select id="f_compensation_type" class="field-input" data-field="compensation_type">
                <option value="hourly">Hourly</option>
                <option value="salary">Salary</option>
              </select>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Hourly Rate ($)</label>
              <input id="f_hourly_rate" class="field-input" type="number" step="0.01" min="0" placeholder="0.00" data-field="hourly_rate"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Annual Salary ($)</label>
              <input id="f_annual_salary" class="field-input" type="number" step="0.01" min="0" placeholder="0.00" data-field="annual_salary"/>
            </div>
          </div>
          <div class="grid grid-cols-2 gap-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Reports To</label>
              <input id="f_report_to" class="field-input" placeholder="Manager name" data-field="report_to"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Hire Date</label>
              <input id="f_hire_date" class="field-input" type="date" data-field="hire_date"/>
            </div>
          </div>
        </div>

        <!-- TAB: CONTACT -->
        <div id="tab-contact" class="tab-content hidden bg-white rounded-2xl border border-slate-200 shadow-sm p-6">
          <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest pb-3 mb-4 border-b border-slate-100">Contact Information</h3>
          <div class="grid grid-cols-2 gap-5 mb-5">
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Phone</label>
              <input id="f_phone" class="field-input" placeholder="(214) 555-0000" data-field="phone"/>
            </div>
            <div>
              <label class="block text-xs font-semibold text-slate-600 mb-1.5">Primary Phone</label>
              <input id="f_primary_phone" class="field-input" placeholder="(214) 555-0000" data-field="primary_phone"/>
            </div>
          </div>
          <div class="mb-5">
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Email</label>
            <input id="f_email" class="field-input" type="email" placeholder="employee@email.com" data-field="email"/>
          </div>
          <div>
            <label class="block text-xs font-semibold text-slate-600 mb-1.5">Additional Info / Notes</label>
            <input id="f_additional_info" class="field-input" placeholder="Any notes‚Ä¶" data-field="additional_info"/>
          </div>
        </div>

        <!-- Action Row -->
        <div class="flex items-center gap-3">
          <button id="btnSaveAll" class="px-7 py-3 rounded-xl text-white text-sm font-semibold hover:opacity-90 transition-opacity shadow-md"
                  style="background:#C0A06D">üíæ Save All Changes</button>
          <button id="btnDiscard" class="px-5 py-3 rounded-xl border border-slate-200 text-sm text-slate-600 hover:bg-slate-50 font-medium">
            Discard
          </button>
          <span id="saveMsg" class="text-sm font-medium ml-2"></span>
        </div>

      </div><!-- /editorPanel -->
    </div><!-- /right -->
  </div>
</div><!-- /appView -->

<!-- TOAST -->
<div id="toast" class="hidden fixed bottom-6 right-6 z-50 text-white px-5 py-3 rounded-xl shadow-xl text-sm font-medium max-w-xs fade-in"
     style="background:#1F2937"></div>

<!-- CONFIRM MODAL -->
<div id="confirmModal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4">
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" id="confirmBackdrop"></div>
  <div class="relative bg-white rounded-2xl shadow-xl border border-slate-200 w-full max-w-sm p-7 fade-in text-center">
    <div class="text-4xl mb-3">‚ö†Ô∏è</div>
    <h3 class="text-lg font-bold text-slate-800 mb-2">Confirm Delete</h3>
    <p id="confirmMsg" class="text-sm text-slate-500 mb-6">Are you sure?</p>
    <div class="flex gap-3">
      <button id="confirmYes" class="flex-1 py-2.5 rounded-xl bg-red-500 text-white text-sm font-semibold hover:bg-red-600 transition-colors">Yes, Delete</button>
      <button id="confirmNo"  class="flex-1 py-2.5 rounded-xl border border-slate-200 text-sm font-medium hover:bg-slate-50">Cancel</button>
    </div>
  </div>
</div>

<script>
// ‚îÄ‚îÄ PLACEHOLDER ‚îÄ‚îÄ
const PLACEHOLDER_IMAGE = 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjAiIGhlaWdodD0iMTIwIiB2aWV3Qm94PSIwIDAgMTIwIDEyMCI+PHJlY3Qgd2lkdGg9IjEyMCIgaGVpZ2h0PSIxMjAiIGZpbGw9IiNlNWU3ZWIiLz48dGV4dCB4PSI2MCIgeT0iNjAiIGZvbnQtc2l6ZT0iMTIiIGZpbGw9IiM5Y2EzYWYiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIwLjNlbSI+Tm8gSW1hZ2U8L3RleHQ+PC9zdmc+';
document.querySelectorAll('img').forEach(i=>{ i.onerror=function(){this.src=PLACEHOLDER_IMAGE;}; });

// ‚îÄ‚îÄ SUPABASE ‚îÄ‚îÄ
const SUPABASE_URL      = 'https://kpldzwlftkvjjntgsqxx.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs';
const client = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ
const $ = id => document.getElementById(id);
let currentAdmin = null, allEmployees = [], filtered = [], page = 0;
const PAGE = 20;
let selectedEmp = null, pendingChanges = {}, autoTimers = {}, isNew = false;

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ
function initials(f,l){ return ((f||'?')[0]+(l||'?')[0]).toUpperCase(); }
function avatarBg(name){
  const c=['#C0A06D','#6B7280','#10B981','#3B82F6','#8B5CF6','#EF4444','#F59E0B'];
  let h=0; for(const ch of(name||'')) h=ch.charCodeAt(0)+((h<<5)-h);
  return c[Math.abs(h)%c.length];
}
function badgeClass(s){
  const v=(s||'').toLowerCase();
  if(v==='active') return 'badge-active';
  if(v==='terminated'||v==='inactive') return 'badge-terminated';
  return 'badge-other';
}
function toast(msg, ok=true){
  const t=$('toast'); t.textContent=msg;
  t.style.background = ok?'#1F2937':'#DC2626';
  t.classList.remove('hidden'); clearTimeout(t._t);
  t._t=setTimeout(()=>t.classList.add('hidden'),3000);
}
function flashSaved(){
  const el=$('saveIndicator'); el.classList.remove('hidden');
  clearTimeout(el._t); el._t=setTimeout(()=>el.classList.add('hidden'),2200);
}
function generatePin(){ return Array.from({length:4},()=>Math.floor(Math.random()*10)).join(''); }

// ‚îÄ‚îÄ TABS ‚îÄ‚îÄ
document.querySelectorAll('.tab-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.add('hidden'));
    btn.classList.add('active');
    $('tab-'+btn.dataset.tab).classList.remove('hidden');
  });
});

// ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ
async function doLogin(){
  const username=$('loginUser').value.trim();
  const pin=$('loginPin').value.trim();
  $('loginMsg').textContent='';
  if(!username||!pin){$('loginMsg').textContent='Enter username and PIN.';return;}
  $('btnLogin').textContent='Verifying‚Ä¶'; $('btnLogin').disabled=true;

  const {data,error}=await client
    .from('employees2025')
    .select('id,first_name,last_name,username,pin,status,employment_status')
    .ilike('username',username).limit(10);

  $('btnLogin').textContent='Access Admin Panel'; $('btnLogin').disabled=false;
  if(error){$('loginMsg').textContent='Connection error.';return;}

  const emp=(data||[]).find(e=>String(e.pin).trim()===String(pin).trim());
  if(!emp){$('loginMsg').textContent='Invalid credentials. Access denied.';return;}

  currentAdmin=emp;
  $('adminBadge').textContent=`${emp.first_name} ${emp.last_name}`;
  $('loginView').classList.add('hidden');
  $('appView').classList.remove('hidden');
  loadEmployees();
}
$('btnLogin').addEventListener('click',doLogin);
['loginUser','loginPin'].forEach(id=>$(id).addEventListener('keydown',e=>{if(e.key==='Enter')doLogin();}));

// ‚îÄ‚îÄ LOAD ALL ‚îÄ‚îÄ
async function loadEmployees(){
  $('empList').innerHTML='<div class="p-4 text-center text-sm text-slate-400">Loading‚Ä¶</div>';
  const {data,error}=await client
    .from('employees2025')
    .select('id,first_name,last_name,job_title,position_title,username,pin,phone,primary_phone,employment_status,status,employee_id,department,email,compensation_type,employment_type,hourly_rate,annual_salary,hire_date,original_hire_date,date_of_birth,ssn,address_line_1,city,state,zip_code,report_to,additional_info')
    .order('first_name',{ascending:true});

  if(error){toast('Failed to load employees',false);return;}
  allEmployees=data||[];
  const active=allEmployees.filter(e=>(e.status||e.employment_status||'').toLowerCase()==='active').length;
  $('statTotal').textContent=allEmployees.length;
  $('statActive').textContent=active;
  applyFilter();
}

// ‚îÄ‚îÄ FILTER ‚îÄ‚îÄ
function applyFilter(){
  const q=($('searchInput').value||'').toLowerCase();
  const s=($('filterStatus').value||'').toLowerCase();
  filtered=allEmployees.filter(e=>{
    const name=`${e.first_name||''} ${e.last_name||''}`.toLowerCase();
    const role=(e.job_title||e.position_title||'').toLowerCase();
    const uname=(e.username||'').toLowerCase();
    const mq=!q||name.includes(q)||role.includes(q)||uname.includes(q);
    const empS=(e.status||e.employment_status||'').toLowerCase();
    const ms=!s||empS===s;
    return mq&&ms;
  });
  page=0; renderList();
}
$('searchInput').addEventListener('input',applyFilter);
$('filterStatus').addEventListener('change',applyFilter);

// ‚îÄ‚îÄ RENDER LIST ‚îÄ‚îÄ
function renderList(){
  const start=page*PAGE;
  const slice=filtered.slice(start,start+PAGE);
  const ul=$('empList');
  if(!slice.length){
    ul.innerHTML='<div class="p-4 text-center text-sm text-slate-400">No employees found.</div>';
  } else {
    ul.innerHTML=slice.map(e=>{
      const name=`${e.first_name||''} ${e.last_name||''}`.trim()||'Unnamed';
      const role=e.job_title||e.position_title||'‚Äî';
      const uname=e.username||'‚Äî';
      const isSel=selectedEmp&&selectedEmp.id===e.id;
      const col=avatarBg(name);
      const noPIN=!e.pin?'<div class="w-2 h-2 rounded-full bg-red-400 flex-shrink-0" title="No PIN set"></div>':'';
      return `
        <div class="emp-row px-2.5 py-2 flex items-center gap-2.5 rounded-lg mx-1.5 mb-0.5 ${isSel?'selected':''}" data-id="${e.id}">
          <div class="w-8 h-8 rounded-full flex items-center justify-center text-white text-xs font-bold flex-shrink-0"
               style="background:${col}">${initials(e.first_name,e.last_name)}</div>
          <div class="min-w-0 flex-1">
            <div class="text-sm font-semibold text-slate-800 truncate">${name}</div>
            <div class="text-[11px] text-slate-400 truncate">${role} ¬∑ <span class="font-mono">${uname}</span></div>
          </div>
          ${noPIN}
        </div>`;
    }).join('');
    ul.querySelectorAll('.emp-row').forEach(row=>{
      row.addEventListener('click',()=>openEmployee(row.dataset.id));
    });
  }
  const total=filtered.length, tp=Math.ceil(total/PAGE)||1;
  $('listCount').textContent=`${Math.min(start+1,total)}‚Äì${Math.min(start+PAGE,total)} of ${total}`;
  $('btnPrev').disabled=page===0;
  $('btnNext').disabled=page>=tp-1;
}
$('btnPrev').addEventListener('click',()=>{page--;renderList();});
$('btnNext').addEventListener('click',()=>{page++;renderList();});

// ‚îÄ‚îÄ OPEN EMPLOYEE ‚îÄ‚îÄ
function openEmployee(empId){
  selectedEmp=allEmployees.find(e=>String(e.id)===String(empId))||null;
  isNew=false; pendingChanges={};
  renderList(); fillEditor(selectedEmp);
}

// ‚îÄ‚îÄ ADD NEW ‚îÄ‚îÄ
$('btnAddMember').addEventListener('click',()=>{
  selectedEmp=null; isNew=true; pendingChanges={};
  renderList(); fillEditor(null);
});

// ‚îÄ‚îÄ FILL EDITOR ‚îÄ‚îÄ
function fillEditor(emp){
  $('emptyState').classList.add('hidden');
  $('editorPanel').classList.remove('hidden');

  const name=emp?`${emp.first_name||''} ${emp.last_name||''}`.trim()||'Unnamed':'New Employee';
  const col=avatarBg(name);
  $('edAvatar').textContent=emp?initials(emp.first_name,emp.last_name):'+';
  $('edAvatar').style.background=col;
  $('edTitle').textContent=name;
  $('edSubtitle').textContent=emp?(emp.job_title||emp.position_title||'No title'):'Fill in all fields below';
  const st=emp?(emp.status||emp.employment_status||'Active'):'Active';
  $('edStatusBadge').textContent=st;
  $('edStatusBadge').className=`badge ${badgeClass(st)}`;
  emp?$('btnDeleteEmployee').classList.remove('hidden'):$('btnDeleteEmployee').classList.add('hidden');

  // Field mapping: [fieldId, empKey, default]
  const fields=[
    ['f_username','username',''],
    ['f_pin','pin',''],
    ['f_status','status','Active'],
    ['f_employment_type','employment_type',''],
    ['f_first_name','first_name',''],
    ['f_last_name','last_name',''],
    ['f_date_of_birth','date_of_birth',''],
    ['f_ssn','ssn',''],
    ['f_address_line_1','address_line_1',''],
    ['f_city','city',''],
    ['f_state','state',''],
    ['f_zip_code','zip_code',''],
    ['f_original_hire_date','original_hire_date',''],
    ['f_job_title','job_title',''],
    ['f_position_title','position_title',''],
    ['f_department','department',''],
    ['f_compensation_type','compensation_type','hourly'],
    ['f_hourly_rate','hourly_rate',''],
    ['f_annual_salary','annual_salary',''],
    ['f_report_to','report_to',''],
    ['f_hire_date','hire_date',''],
    ['f_phone','phone',''],
    ['f_primary_phone','primary_phone',''],
    ['f_email','email',''],
    ['f_additional_info','additional_info',''],
  ];
  fields.forEach(([fid,key,def])=>{
    const el=$(fid); if(!el)return;
    el.value=emp?(emp[key]??def):def;
    el.classList.remove('changed','saving','saved');
  });

  $('saveMsg').textContent='';
  $('pinStrength').textContent='';
  $('f_pin').type='password';
  $('btnTogglePin').textContent='Show';
  attachAutoSave();
}

// ‚îÄ‚îÄ AUTO-SAVE WIRING ‚îÄ‚îÄ
function attachAutoSave(){
  // Remove old listeners via clone
  document.querySelectorAll('[data-field]').forEach(el=>{
    const clone=el.cloneNode(true);
    el.parentNode.replaceChild(clone,el);
  });
  // Re-attach PIN toggle and gen after clone wipes them
  $('btnTogglePin').addEventListener('click',togglePin);
  $('btnGenNewPin').addEventListener('click',genPin);

  document.querySelectorAll('[data-field]').forEach(el=>{
    el.addEventListener('input',()=>{
      const field=el.dataset.field;
      let val=el.value;
      if(field==='pin'){ val=val.replace(/\D/g,''); el.value=val; updatePinStrength(val); }
      el.classList.add('changed'); el.classList.remove('saved');
      pendingChanges[field]=val;
      // Live header updates
      if(field==='first_name'||field==='last_name'){
        const fn=$('f_first_name').value||'', ln=$('f_last_name').value||'';
        const n=`${fn} ${ln}`.trim()||'New Employee';
        $('edTitle').textContent=n;
        $('edAvatar').textContent=initials(fn||'?',ln||'?');
        $('edAvatar').style.background=avatarBg(n);
      }
      if(field==='status'){
        $('edStatusBadge').textContent=val;
        $('edStatusBadge').className=`badge ${badgeClass(val)}`;
      }
      if(!isNew){
        clearTimeout(autoTimers[field]);
        autoTimers[field]=setTimeout(()=>autoSaveField(el,field,val),900);
      }
    });
  });
}

function togglePin(){
  const f=$('f_pin');
  const hide=f.type==='password';
  f.type=hide?'text':'password';
  $('btnTogglePin').textContent=hide?'Hide':'Show';
}
function genPin(){
  const pin=generatePin();
  const f=$('f_pin'); f.value=pin; f.type='text';
  $('btnTogglePin').textContent='Hide';
  updatePinStrength(pin);
  f.classList.add('changed');
  pendingChanges['pin']=pin;
  if(!isNew){ clearTimeout(autoTimers['pin']); autoTimers['pin']=setTimeout(()=>autoSaveField(f,'pin',pin),900); }
  toast(`Generated PIN: ${pin}`);
}
$('btnTogglePin').addEventListener('click',togglePin);
$('btnGenNewPin').addEventListener('click',genPin);

async function autoSaveField(el,field,val){
  if(!selectedEmp||isNew)return;
  el.classList.add('saving'); el.classList.remove('changed');
  const {error}=await client.from('employees2025')
    .update({[field]:val||null, last_modified:new Date().toISOString()})
    .eq('id',selectedEmp.id);
  if(error){ el.classList.remove('saving'); el.classList.add('changed'); toast('Save failed: '+error.message,false); return; }
  el.classList.remove('saving'); el.classList.add('saved');
  const idx=allEmployees.findIndex(e=>e.id===selectedEmp.id);
  if(idx!==-1) allEmployees[idx][field]=val;
  selectedEmp[field]=val;
  delete pendingChanges[field];
  flashSaved(); renderList();
}

function updatePinStrength(pin){
  const el=$('pinStrength');
  if(!pin){el.textContent='';return;}
  if(pin.length<4){el.textContent='‚ö† Too short (min 4)';el.style.color='#EF4444';return;}
  if(pin.length>=6){el.textContent='‚óè‚óè Strong';el.style.color='#10B981';return;}
  el.textContent='‚óè OK';el.style.color='#F59E0B';
}

// ‚îÄ‚îÄ SAVE ALL ‚îÄ‚îÄ
$('btnSaveAll').addEventListener('click',async()=>{
  if(isNew) await saveNewEmployee();
  else await saveAllChanges();
});

async function saveAllChanges(){
  if(!selectedEmp)return;
  const payload={};
  document.querySelectorAll('[data-field]').forEach(el=>{ payload[el.dataset.field]=el.value||null; });
  payload.last_modified=new Date().toISOString();
  $('btnSaveAll').textContent='Saving‚Ä¶'; $('btnSaveAll').disabled=true;

  const {error}=await client.from('employees2025').update(payload).eq('id',selectedEmp.id);
  $('btnSaveAll').textContent='üíæ Save All Changes'; $('btnSaveAll').disabled=false;

  if(error){
    $('saveMsg').textContent='‚úï '+error.message; $('saveMsg').style.color='#EF4444';
    toast('Save failed: '+error.message,false); return;
  }
  Object.assign(selectedEmp,payload);
  const idx=allEmployees.findIndex(e=>e.id===selectedEmp.id);
  if(idx!==-1)Object.assign(allEmployees[idx],payload);
  document.querySelectorAll('[data-field]').forEach(el=>el.classList.remove('changed','saving','saved'));
  $('saveMsg').textContent='‚úì All saved'; $('saveMsg').style.color='#10B981';
  pendingChanges={}; flashSaved(); renderList();
  toast('‚úì Employee updated');
}

async function saveNewEmployee(){
  const fn=$('f_first_name').value.trim();
  const ln=$('f_last_name').value.trim();
  const un=$('f_username').value.trim();
  const pn=$('f_pin').value.trim();
  if(!fn||!ln){toast('First and last name required',false);return;}
  if(!un){toast('Username is required',false);return;}
  if(!pn||pn.length<4){toast('PIN must be at least 4 digits',false);return;}

  const payload={};
  document.querySelectorAll('[data-field]').forEach(el=>{ if(el.value) payload[el.dataset.field]=el.value; });
  payload.last_modified=new Date().toISOString();
  payload.status=payload.status||'Active';
  payload.employment_status=payload.status;

  $('btnSaveAll').textContent='Creating‚Ä¶'; $('btnSaveAll').disabled=true;
  const {data,error}=await client.from('employees2025').insert([payload]).select();
  $('btnSaveAll').textContent='üíæ Save All Changes'; $('btnSaveAll').disabled=false;

  if(error){
    $('saveMsg').textContent='‚úï '+error.message; $('saveMsg').style.color='#EF4444';
    toast('Create failed: '+error.message,false); return;
  }
  const newEmp=data[0];
  allEmployees.unshift(newEmp);
  selectedEmp=newEmp; isNew=false; pendingChanges={};
  $('statTotal').textContent=allEmployees.length;
  applyFilter(); fillEditor(newEmp);
  $('saveMsg').textContent='‚úì Employee created!'; $('saveMsg').style.color='#10B981';
  flashSaved(); toast(`‚úì ${fn} ${ln} added successfully`);
}

// ‚îÄ‚îÄ DISCARD ‚îÄ‚îÄ
$('btnDiscard').addEventListener('click',()=>{
  if(isNew){
    selectedEmp=null; isNew=false; pendingChanges={};
    $('editorPanel').classList.add('hidden');
    $('emptyState').classList.remove('hidden');
    renderList();
  } else if(selectedEmp){
    fillEditor(selectedEmp); toast('Changes discarded');
  }
});

// ‚îÄ‚îÄ DELETE ‚îÄ‚îÄ
$('btnDeleteEmployee').addEventListener('click',()=>{
  if(!selectedEmp)return;
  const name=`${selectedEmp.first_name||''} ${selectedEmp.last_name||''}`.trim();
  $('confirmMsg').textContent=`Delete ${name}? This cannot be undone.`;
  $('confirmModal').classList.remove('hidden');
});
$('confirmBackdrop').addEventListener('click',()=>$('confirmModal').classList.add('hidden'));
$('confirmNo').addEventListener('click',()=>$('confirmModal').classList.add('hidden'));
$('confirmYes').addEventListener('click',async()=>{
  if(!selectedEmp)return;
  $('confirmModal').classList.add('hidden');
  const {error}=await client.from('employees2025').delete().eq('id',selectedEmp.id);
  if(error){toast('Delete failed: '+error.message,false);return;}
  allEmployees=allEmployees.filter(e=>e.id!==selectedEmp.id);
  selectedEmp=null; isNew=false; pendingChanges={};
  applyFilter();
  $('editorPanel').classList.add('hidden');
  $('emptyState').classList.remove('hidden');
  $('statTotal').textContent=allEmployees.length;
  toast('Employee deleted');
});

// ‚îÄ‚îÄ LOGOUT ‚îÄ‚îÄ
$('btnLogout').addEventListener('click',()=>{
  currentAdmin=null; allEmployees=[]; selectedEmp=null; isNew=false;
  $('appView').classList.add('hidden');
  $('loginView').classList.remove('hidden');
  $('loginUser').value=''; $('loginPin').value=''; $('loginMsg').textContent='';
});
</script>
</body>
</html>
