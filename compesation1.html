<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Payroll Advance Request - Jeng Chi Restaurant</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #f5f7fa 0%, #e8eef5 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .login-container {
      max-width: 500px;
      margin: 100px auto;
      background: white;
      border-radius: 12px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
      padding: 50px 40px;
    }

    .login-container.hidden {
      display: none;
    }

    .logo-container {
      text-align: center;
      margin-bottom: 30px;
    }

    .logo-container img {
      max-width: 180px;
      height: auto;
    }

    .login-header {
      text-align: center;
      margin-bottom: 35px;
    }

    .login-header h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .login-header p {
      font-size: 15px;
      color: #7f8c8d;
    }

    .form-group {
      margin-bottom: 25px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #34495e;
      margin-bottom: 8px;
    }

    .input-wrapper {
      position: relative;
    }

    .input-wrapper i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: #95a5a6;
      font-size: 16px;
    }

    .input-wrapper input[type="email"] {
      width: 100%;
      padding: 14px 15px 14px 45px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .input-wrapper input[type="email"]:focus {
      outline: none;
      border-color: #3498db;
      background: white;
    }

    .form-control {
      width: 100%;
      padding: 14px 15px 14px 45px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s ease;
      background: #f8f9fa;
    }

    .form-control:focus {
      outline: none;
      border-color: #3498db;
      background: white;
    }

    .error-message {
      display: none;
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .error-message.show {
      display: block;
    }

    .btn-login {
      width: 100%;
      padding: 15px;
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .btn-login:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .app-container {
      display: none;
      max-width: 1200px;
      margin: 0 auto;
    }

    .app-container.show {
      display: block;
    }

    .top-bar {
      background: white;
      padding: 15px 30px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      margin-bottom: 30px;
      border-radius: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .logo-section img {
      max-height: 50px;
    }

    .user-section {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .user-info {
      text-align: right;
    }

    .user-info .name {
      font-weight: 600;
      color: #2c3e50;
      font-size: 15px;
    }

    .user-info .role {
      font-size: 13px;
      color: #7f8c8d;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      margin-left: 8px;
    }

    .role-badge.hr {
      background: #3498db;
      color: white;
    }

    .role-badge.employee {
      background: #95a5a6;
      color: white;
    }

    .btn-logout {
      padding: 8px 20px;
      background: #ecf0f1;
      border: none;
      border-radius: 6px;
      color: #34495e;
      font-size: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-logout:hover {
      background: #bdc3c7;
    }

    .page-header {
      background: white;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
      text-align: center;
      position: relative;
    }

    .page-header h1 {
      font-size: 28px;
      color: #2c3e50;
      margin-bottom: 8px;
    }

    .page-header p {
      color: #7f8c8d;
      font-size: 15px;
    }

    .advance-counter {
      position: absolute;
      top: 20px;
      right: 30px;
      background: #e8f4f8;
      padding: 15px 25px;
      border-radius: 10px;
      border-left: 4px solid #3498db;
    }

    .advance-counter label {
      display: block;
      font-size: 11px;
      color: #7f8c8d;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .advance-counter .value {
      font-size: 24px;
      color: #3498db;
      font-weight: 700;
    }

    .today-date {
      margin-top: 10px;
      font-weight: 600;
      color: #3498db;
    }

    .card {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
      margin-bottom: 25px;
    }

    .card-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #ecf0f1;
    }

    .card-header i {
      font-size: 24px;
      color: #3498db;
    }

    .card-header h2 {
      font-size: 20px;
      color: #2c3e50;
      font-weight: 600;
    }

    .info-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }

    .info-item {
      padding: 15px;
      background: #f8f9fa;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    .info-item label {
      display: block;
      font-size: 12px;
      color: #7f8c8d;
      text-transform: uppercase;
      font-weight: 600;
      margin-bottom: 5px;
      letter-spacing: 0.5px;
    }

    .info-item .value {
      font-size: 18px;
      color: #2c3e50;
      font-weight: 600;
    }

    .info-item.editable {
      background: white;
      border: 2px solid #3498db;
    }

    .info-item input,
    .info-item select {
      width: 100%;
      padding: 10px;
      border: 1px solid #e0e6ed;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 500;
      color: #2c3e50;
    }

    .alert {
      padding: 15px 20px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
    }

    .alert-danger {
      background: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }

    .alert-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }

    .input-prefix {
      position: relative;
    }

    .input-prefix input {
      padding-left: 35px;
      width: 100%;
      padding: 14px 15px 14px 35px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 18px;
      transition: all 0.3s ease;
      background: #f8f9fa;
      font-weight: 600;
    }

    .input-prefix input:focus {
      outline: none;
      border-color: #3498db;
      background: white;
    }

    .input-prefix::before {
      content: '$';
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 18px;
      color: #2c3e50;
      font-weight: 700;
    }

    .signature-container {
      margin-top: 30px;
    }

    .signature-canvas {
      border: 2px dashed #bdc3c7;
      border-radius: 8px;
      cursor: crosshair;
      background: white;
      display: block;
      width: 100%;
      max-width: 600px;
      height: 180px;
    }

    .signature-controls {
      margin-top: 15px;
      display: flex;
      gap: 10px;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-size: 15px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-secondary {
      background: #ecf0f1;
      color: #34495e;
    }

    .btn-secondary:hover {
      background: #bdc3c7;
    }

    .btn-primary {
      background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }

    .btn-primary:disabled {
      background: #bdc3c7;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .btn-success {
      background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(39, 174, 96, 0.3);
    }

    .btn-success:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(39, 174, 96, 0.4);
    }

    .btn-danger {
      background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
      color: white;
      box-shadow: 0 4px 15px rgba(231, 76, 60, 0.3);
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(231, 76, 60, 0.4);
    }

    .btn-sm {
      padding: 8px 16px;
      font-size: 13px;
    }

    .submit-section {
      margin-top: 40px;
      padding-top: 30px;
      border-top: 2px solid #ecf0f1;
    }

    .legal-text {
      font-size: 12px;
      color: #7f8c8d;
      line-height: 1.6;
      margin-top: 20px;
      padding: 15px;
      background: #f8f9fa;
      border-radius: 6px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      z-index: 1000;
      align-items: center;
      justify-content: center;
      overflow-y: auto;
    }

    .modal.show {
      display: flex;
    }

    .modal-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      max-width: 1200px;
      width: 95%;
      max-height: 90vh;
      overflow-y: auto;
      text-align: center;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    .modal-content i {
      font-size: 60px;
      margin-bottom: 20px;
    }

    .modal-content.success i {
      color: #27ae60;
    }

    .modal-content h3 {
      font-size: 24px;
      color: #2c3e50;
      margin-bottom: 15px;
    }

    .modal-content p {
      color: #7f8c8d;
      margin-bottom: 25px;
      line-height: 1.6;
    }

    .review-modal-content {
      text-align: left;
    }

    .review-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 3px solid #3498db;
    }

    .review-modal-header h2 {
      color: #2c3e50;
      font-size: 28px;
    }

    .close-modal {
      background: #ecf0f1;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      color: #34495e;
    }

    .close-modal:hover {
      background: #bdc3c7;
    }

    .review-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      margin-bottom: 30px;
    }

    .review-section {
      background: #f8f9fa;
      padding: 20px;
      border-radius: 8px;
      border-left: 4px solid #3498db;
    }

    .review-section h3 {
      font-size: 16px;
      color: #2c3e50;
      margin-bottom: 15px;
      text-align: left;
    }

    .review-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      border-bottom: 1px solid #e0e6ed;
    }

    .review-row:last-child {
      border-bottom: none;
    }

    .review-label {
      font-size: 13px;
      color: #7f8c8d;
      font-weight: 600;
    }

    .review-value {
      font-size: 14px;
      color: #2c3e50;
      font-weight: 600;
    }

    .review-value.highlight {
      color: #3498db;
      font-size: 16px;
    }

    .review-value.danger {
      color: #e74c3c;
    }

    .review-value.success {
      color: #27ae60;
    }

    .calculation-section {
      background: #e8f4f8;
      padding: 25px;
      border-radius: 8px;
      margin: 20px 0;
      border: 2px solid #3498db;
    }

    .calculation-row {
      display: flex;
      justify-content: space-between;
      padding: 10px 0;
      font-size: 15px;
    }

    .calculation-row.total {
      border-top: 2px solid #3498db;
      margin-top: 10px;
      padding-top: 15px;
      font-size: 18px;
      font-weight: 700;
      color: #2c3e50;
    }

    .eligibility-box {
      padding: 20px;
      border-radius: 8px;
      margin: 20px 0;
      font-size: 15px;
      font-weight: 600;
      text-align: center;
    }

    .eligibility-box.eligible {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }

    .eligibility-box.ineligible {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }

    .modal-actions {
      display: flex;
      gap: 15px;
      justify-content: center;
      margin-top: 30px;
      padding-top: 20px;
      border-top: 2px solid #ecf0f1;
    }

    .hr-section {
      background: #e8f4f8;
      padding: 30px;
      border-radius: 12px;
      margin-top: 30px;
    }

    .hr-section h3 {
      color: #2c3e50;
      margin-bottom: 20px;
      font-size: 18px;
    }

    textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e0e6ed;
      border-radius: 8px;
      font-size: 14px;
      resize: vertical;
      min-height: 100px;
      font-family: inherit;
    }

    table {
      border-collapse: collapse;
    }

    table th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #2c3e50;
      border-bottom: 2px solid #ecf0f1;
    }

    table td {
      padding: 12px;
      border-bottom: 1px solid #ecf0f1;
    }

    @media (max-width: 768px) {
      .info-grid {
        grid-template-columns: 1fr;
      }

      .top-bar {
        flex-direction: column;
        gap: 15px;
      }

      .advance-counter {
        position: static;
        margin-top: 15px;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SECTION -->
  <div class="login-container" id="loginSection">
    <div class="logo-container">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jeng-chi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Restaurant">
    </div>

    <div class="login-header">
      <h1>Payroll Advance System</h1>
      <p>Employee & HR Access Portal</p>
    </div>

    <div class="error-message" id="loginError"></div>

    <form id="loginForm">
      <div class="form-group">
        <label for="username">Username</label>
        <div class="input-wrapper">
          <i class="fas fa-user"></i>
          <input type="text" id="username" class="form-control" placeholder="Enter your username" required autocomplete="username">
        </div>
      </div>

      <div class="form-group">
        <label for="pin">PIN</label>
        <div class="input-wrapper">
          <i class="fas fa-lock"></i>
          <input type="password" id="pin" class="form-control" placeholder="Enter your PIN" required autocomplete="current-password">
        </div>
      </div>

      <button type="submit" class="btn-login" id="loginBtn">
        <i class="fas fa-sign-in-alt"></i> Login
      </button>
    </form>
  </div>

  <!-- MAIN APPLICATION -->
  <div class="app-container" id="appContainer">
    <div class="top-bar">
      <div class="logo-section">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jeng-chi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Restaurant">
      </div>
      <div class="user-section">
        <div class="user-info">
          <div class="name" id="userName">
            <span id="displayName"></span>
            <span class="role-badge" id="roleBadge"></span>
          </div>
          <div class="role" id="userPosition"></div>
        </div>
        <button class="btn-logout" onclick="logout()">
          <i class="fas fa-sign-out-alt"></i> Logout
        </button>
      </div>
    </div>

    <div class="page-header">
      <div class="advance-counter">
        <label>Payroll Advance Requests</label>
        <div class="value" id="advanceCounterDisplay">0 / 6</div>
      </div>

      <h1><i class="fas fa-file-invoice-dollar"></i> PAYROLL ADVANCE REQUEST FORM</h1>
      <p>Jeng Chi Restaurant (JCR) â€¢ 400 N. Greenville Av. Ste 11, Richardson, Texas 75081 â€¢ admin@jengchirestaurant.com â€¢ 972-669-9094</p>
      <p class="today-date">Today's Date: <span id="todayDate"></span></p>
    </div>

    <!-- TOP TABS -->
    <div class="card" style="padding:15px;">
      <div style="display:flex; gap:20px; flex-wrap: wrap;">
        <button
          id="tabEmployee"
          class="btn btn-primary"
          onclick="switchTab('employee')"
        >
          <i class="fas fa-user"></i> My Advance Request
        </button>

        <button
          id="tabPending"
          class="btn btn-secondary"
          onclick="switchTab('pending')"
          style="display:none;"
        >
          <i class="fas fa-inbox"></i> Pending Approvals
        </button>

        <button
          id="tabApproved"
          class="btn btn-secondary"
          onclick="switchTab('approved')"
          style="display:none;"
        >
          <i class="fas fa-check-circle"></i> Approved
        </button>

        <button
          id="tabDenied"
          class="btn btn-secondary"
          onclick="switchTab('denied')"
          style="display:none;"
        >
          <i class="fas fa-times-circle"></i> Denied
        </button>
      </div>
    </div>

    <div id="blockingAlert"></div>

    <!-- EMPLOYEE TAB CONTENT -->
    <div id="employeeTabContent">

      <!-- EMPLOYEE INFORMATION -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-user-circle"></i>
          <h2>Employee Information</h2>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <label>Employee Name</label>
            <div class="value" id="employeeName"></div>
          </div>
          <div class="info-item">
            <label>Position</label>
            <div class="value" id="position"></div>
          </div>
          <div class="info-item">
            <label>Department</label>
            <div class="value" id="department"></div>
          </div>
          <div class="info-item">
            <label>Email Address</label>
            <div class="value" id="employeeEmailDisplay"></div>
          </div>
        </div>
      </div>

      <!-- PAYROLL PERIOD (EMPLOYEE VIEW) -->
      <div class="card" id="employeePayrollCard">
        <div class="card-header">
          <i class="fas fa-calendar-alt"></i>
          <h2>Payroll Period & Earnings Calculation</h2>
        </div>
        <div class="info-grid">
          <div class="info-item">
            <label>Pay Period Start</label>
            <div class="value" id="periodStartEmployee"></div>
          </div>
          <div class="info-item">
            <label>Pay Period End</label>
            <div class="value" id="periodEndEmployee"></div>
          </div>
          <div class="info-item">
            <label>Hours Worked</label>
            <div class="value" id="hoursWorkedEmployee">0.00</div>
          </div>
          <div class="info-item">
            <label>Tips Earned</label>
            <div class="value" id="tipsEarnedEmployee">$0.00</div>
          </div>
          <div class="info-item">
            <label>Hourly Rate</label>
            <div class="value" id="hourlyRateEmployee">$2.50</div>
          </div>
          <div class="info-item">
            <label>Gross Earned</label>
            <div class="value" id="grossEarnedEmployee">$0.00</div>
          </div>
        </div>
      </div>

      <!-- REQUEST AMOUNT -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-hand-holding-usd"></i>
          <h2>Requested Advance Amount</h2>
        </div>

        <div class="form-group">
          <label>Requested Advance Amount ($)</label>
          <div class="input-prefix">
            <input type="number" id="requestedAmount" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <div class="alert alert-info">
          <i class="fas fa-info-circle"></i>
          <div>
            <strong>Policy Summary:</strong>
            Advance is limited to 50% of earned wages in the current payroll period.
          </div>
        </div>
      </div>

      <!-- EMPLOYEE SIGNATURE -->
      <div class="card">
        <div class="card-header">
          <i class="fas fa-signature"></i>
          <h2>Authorization & Acknowledgment</h2>
        </div>

        <div class="legal-text">
          I authorize Jeng Chi Restaurant to deduct this advance from my next paycheck.
        </div>

        <div class="signature-container">
          <label>Employee Signature:</label>
          <canvas id="employeeSignatureCanvas" class="signature-canvas"></canvas>
          <div class="signature-controls">
            <button class="btn btn-secondary" onclick="clearEmployeeSignature()">
              <i class="fas fa-eraser"></i> Clear Signature
            </button>
          </div>
        </div>

        <div class="submit-section">
          <button class="btn btn-primary" id="submitBtn" onclick="submitRequest()" disabled>
            <i class="fas fa-paper-plane"></i> Submit Request
          </button>
        </div>
      </div>

    </div>
    <!-- END EMPLOYEE TAB CONTENT -->

    <!-- HR PENDING TAB CONTENT -->
    <div id="pendingTabContent" style="display:none;">

      <!-- HR PENDING ADVANCES LIST -->
      <div class="card" id="hrPendingList">
        <div class="card-header">
          <i class="fas fa-inbox"></i>
          <h2>Pending Payroll Advances</h2>
        </div>

        <table style="width:100%;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th>Employee</th>
              <th>Amount</th>
              <th>Period</th>
              <th>Submitted</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody id="pendingAdvanceTable"></tbody>
        </table>
      </div>

    </div>
    <!-- END HR PENDING TAB CONTENT -->

    <!-- APPROVED TAB CONTENT -->
    <div id="approvedTabContent" style="display:none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-check-circle"></i>
          <h2>Approved Payroll Advances</h2>
        </div>

        <table style="width:100%;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th>Employee</th>
              <th>Amount</th>
              <th>Decision Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="approvedAdvanceTable"></tbody>
        </table>
      </div>
    </div>

    <!-- DENIED TAB CONTENT -->
    <div id="deniedTabContent" style="display:none;">
      <div class="card">
        <div class="card-header">
          <i class="fas fa-times-circle"></i>
          <h2>Denied Payroll Advances</h2>
        </div>

        <table style="width:100%;">
          <thead>
            <tr style="background:#f8f9fa;">
              <th>Employee</th>
              <th>Requested</th>
              <th>Reason</th>
              <th>Decision Date</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="deniedAdvanceTable"></tbody>
        </table>
      </div>
    </div>

  </div>

  <!-- SUCCESS MODAL -->
  <div class="modal" id="successModal">
    <div class="modal-content success">
      <i class="fas fa-check-circle"></i>
      <h3>Request Submitted Successfully!</h3>
      <p>Your payroll advance request has been submitted to HR for review. You will be notified once a decision is made.</p>
      <button class="btn btn-primary" onclick="location.reload()">
        <i class="fas fa-home"></i> Return to Home
      </button>
    </div>
  </div>

  <!-- REVIEW MODAL -->
  <div class="modal" id="reviewModal">
    <div class="modal-content review-modal-content">
      <div class="review-modal-header">
        <h2><i class="fas fa-clipboard-check"></i> Payroll Advance Review</h2>
        <button class="close-modal" onclick="closeReviewModal()">
          <i class="fas fa-times"></i> Close
        </button>
      </div>

      <!-- Employee Information -->
      <div class="review-grid">
        <div class="review-section">
          <h3><i class="fas fa-user"></i> Employee Information</h3>
          <div class="review-row">
            <span class="review-label">Employee Name</span>
            <span class="review-value" id="reviewEmployeeName"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Employee ID</span>
            <span class="review-value" id="reviewEmployeeID"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Position</span>
            <span class="review-value" id="reviewPosition"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Department</span>
            <span class="review-value" id="reviewDepartment"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Is Server? (tips included)</span>
            <span class="review-value" id="reviewIsServer"></span>
          </div>
        </div>

        <div class="review-section">
          <h3><i class="fas fa-calendar-alt"></i> Pay Period & Status</h3>
          <div class="review-row">
            <span class="review-label">Pay Period Start (date)</span>
            <span class="review-value" id="reviewPeriodStart"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Pay Period End (date)</span>
            <span class="review-value" id="reviewPeriodEnd"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Today's Advance Count</span>
            <span class="review-value" id="reviewAdvanceCount"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Salary Advance Outstanding? (Y/N)</span>
            <span class="review-value" id="reviewOutstanding"></span>
          </div>
          <div class="review-row">
            <span class="review-label">Does Employee have Disciplinary Action? (Y/N)</span>
            <span class="review-value" id="reviewDisciplinary"></span>
          </div>
        </div>
      </div>

      <!-- Earnings Calculation -->
      <div class="calculation-section">
        <h3 style="margin-bottom: 15px; color: #2c3e50;">
          <i class="fas fa-calculator"></i> Earnings Calculation
        </h3>
        <div class="review-grid">
          <div>
            <div class="form-group">
              <label for="reviewHoursWorkedInput">Hours Worked to Date (this payroll)</label>
              <input 
                type="number" 
                id="reviewHoursWorkedInput" 
                class="form-control" 
                placeholder="0.00" 
                step="0.01" 
                min="0"
                oninput="calculateEarningsInModal()"
                style="padding: 12px; font-size: 16px; font-weight: 600;">
            </div>
            <div class="form-group">
              <label for="reviewTipsEarnedInput">Tips Earned to Date (server only)</label>
              <div class="input-prefix">
                <input 
                  type="number" 
                  id="reviewTipsEarnedInput" 
                  placeholder="0.00" 
                  step="0.01" 
                  min="0"
                  oninput="calculateEarningsInModal()">
              </div>
            </div>
            <div class="form-group">
              <label for="reviewHourlyRateInput">Hourly Rate ($/hr)</label>
              <div class="input-prefix">
                <input 
                  type="number" 
                  id="reviewHourlyRateInput" 
                  placeholder="0.00" 
                  step="0.01" 
                  min="0"
                  oninput="calculateEarningsInModal()">
              </div>
            </div>
            <div class="calculation-row total">
              <span>Gross Earned to Date ($)</span>
              <span id="reviewGrossEarnedCalc" class="highlight">$0.00</span>
            </div>
          </div>
          <div>
            <div class="calculation-row" style="padding: 12px 0; background: #f8f9fa; border-radius: 6px; margin-bottom: 10px;">
              <span style="padding-left: 10px;">Eligible Advance (50% of earned) ($)</span>
              <span id="reviewEligibleAmountCalc" style="padding-right: 10px; font-weight: 700; color: #27ae60;">$0.00</span>
            </div>
            <div class="calculation-row" style="padding: 12px 0; background: #e8f4f8; border-radius: 6px; margin-bottom: 10px;">
              <span style="padding-left: 10px;">Requested Advance Amount ($)</span>
              <span id="reviewRequestedAmountCalc" class="highlight" style="padding-right: 10px;">$0.00</span>
            </div>
            <div class="calculation-row" style="padding: 12px 0; background: #f8f9fa; border-radius: 6px;">
              <span style="padding-left: 10px;">Amount Limit Check</span>
              <span id="reviewLimitCheckCalc" style="padding-right: 10px;"></span>
            </div>
          </div>
        </div>
      </div>

      <!-- Eligibility Status -->
      <div class="eligibility-box" id="reviewEligibilityBox">
        <i class="fas fa-check-circle"></i> 
        <span id="reviewEligibilityText">ELIGIBLE â€” Meets policy conditions.</span>
      </div>

      <!-- Policy Summary -->
      <div class="review-section" style="margin-bottom: 20px;">
        <h3><i class="fas fa-file-alt"></i> Policy Summary</h3>
        <p style="margin: 0; color: #2c3e50; line-height: 1.8;">
          In accordance with the advance policy, the amount to be advanced will be 50% of your earned hours worked in the current payroll. 
          As per company guidelines, any tips earned are included in the calculation for the advance (server only). 
          The full amount of the advance will be deducted from the next payroll.
        </p>
      </div>

      <!-- HR Decision Section -->
      <div class="hr-section">
        <h3><i class="fas fa-clipboard-check"></i> Salary Advance Decision</h3>
        
        <div class="form-group">
          <label for="reviewApproverName">Approver Name / Title</label>
          <input type="text" id="reviewApproverName" class="form-control" placeholder="Enter your name and title" style="padding: 12px;">
        </div>

        <div class="form-group">
          <label for="reviewApprovedAmount">Approved Amount (if different from requested)</label>
          <div class="input-prefix">
            <input type="number" id="reviewApprovedAmount" placeholder="0.00" step="0.01" min="0">
          </div>
        </div>

        <div class="form-group">
          <label for="reviewHRNotes">HR Notes / Denial Reason</label>
          <textarea id="reviewHRNotes" placeholder="Enter notes or reason for denial..."></textarea>
        </div>

        <div class="signature-container">
          <label>HR Signature (Required for Approval/Denial):</label>
          <canvas id="reviewHRSignatureCanvas" class="signature-canvas"></canvas>
          <div class="signature-controls">
            <button class="btn btn-secondary" type="button" onclick="clearReviewHRSignature()">
              <i class="fas fa-eraser"></i> Clear Signature
            </button>
          </div>
        </div>

        <div class="modal-actions">
          <button class="btn btn-success" onclick="approveFromModal()">
            <i class="fas fa-check-circle"></i> Approve
          </button>
          <button class="btn btn-danger" onclick="denyFromModal()">
            <i class="fas fa-times-circle"></i> Deny
          </button>
          <button class="btn btn-secondary" onclick="closeReviewModal()">
            <i class="fas fa-arrow-left"></i> Cancel
          </button>
        </div>

        <!-- APPROVAL SUCCESS ACTIONS (Hidden by default, shown after approval) -->
        <div id="approvalSuccessActions" style="display: block; margin-top: 30px; padding: 30px; background: #d4edda; border-radius: 12px; border: 2px solid #28a745;">
          <div style="text-align: center; margin-bottom: 20px;">
            <i class="fas fa-check-circle" style="font-size: 48px; color: #28a745;"></i>
            <h3 style="color: #155724; margin: 15px 0;">Advance Approved Successfully!</h3>
            <p style="color: #155724;">Choose an action below:</p>
          </div>
          <div style="display: flex; gap: 15px; justify-content: center;">
            <button class="btn btn-primary" onclick="saveApprovalData()">
              <i class="fas fa-save"></i> Save Data
            </button>
            <button class="btn" style="background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%); color: white; box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);" onclick="generateCorporatePDF()">
              <i class="fas fa-file-pdf"></i> Generate Corporate PDF
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    window.supabaseClient = supabaseClient;

    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ðŸš€ Jeng Chi Payroll Advance System Starting...');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    console.log('ðŸ“ Supabase URL:', SUPABASE_URL);
    console.log('âœ… Database client initialized');
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

    let currentUser = null;
    let userRole = null;
    let employeeCanvas = null;
    let employeeCtx = null;
    let hrCanvas = null;
    let hrCtx = null;
    let reviewHRCanvas = null;
    let reviewHRCtx = null;
    let isDrawingEmployee = false;
    let isDrawingHR = false;
    let isDrawingReviewHR = false;
    let hasEmployeeSigned = false;
    let hasHRSigned = false;
    let hasReviewHRSigned = false;
    let currentPeriod = {};
    let payrollPeriods = [];
    let employeeHourlyRate = 2.50;
    let currentAdvanceId = null;
    let selectedEmployeeId = null;

    document.addEventListener('DOMContentLoaded', () => {
      const today = new Date();
      document.getElementById('todayDate').textContent = formatDate(today);
    });

function switchTab(tab) {
  const employeeTab = document.getElementById('employeeTabContent');
  const pendingTab = document.getElementById('pendingTabContent');
  const approvedTab = document.getElementById('approvedTabContent');
  const deniedTab = document.getElementById('deniedTabContent');

  const btnEmployee = document.getElementById('tabEmployee');
  const btnPending = document.getElementById('tabPending');
  const btnApproved = document.getElementById('tabApproved');
  const btnDenied = document.getElementById('tabDenied');

  // Hide all tabs
  if (employeeTab) employeeTab.style.display = 'none';
  if (pendingTab) pendingTab.style.display = 'none';
  if (approvedTab) approvedTab.style.display = 'none';
  if (deniedTab) deniedTab.style.display = 'none';

  // Reset all buttons
  if (btnEmployee) btnEmployee.className = 'btn btn-secondary';
  if (btnPending) btnPending.className = 'btn btn-secondary';
  if (btnApproved) btnApproved.className = 'btn btn-secondary';
  if (btnDenied) btnDenied.className = 'btn btn-secondary';

  // Show selected tab
  if (tab === 'employee' && employeeTab) {
    employeeTab.style.display = 'block';
    if (btnEmployee) btnEmployee.className = 'btn btn-primary';
  } else if (tab === 'pending' && pendingTab) {
    pendingTab.style.display = 'block';
    if (btnPending) btnPending.className = 'btn btn-primary';
    loadPendingPayrollAdvances();
  } else if (tab === 'approved' && approvedTab) {
    approvedTab.style.display = 'block';
    if (btnApproved) btnApproved.className = 'btn btn-primary';
    loadApprovedAdvances();
  } else if (tab === 'denied' && deniedTab) {
    deniedTab.style.display = 'block';
    if (btnDenied) btnDenied.className = 'btn btn-primary';
    loadDeniedAdvances();
  }
}

    function generatePayrollPeriods() {
      const periods = [];
      const years = [2026, 2027, 2028];
      const firstStart = new Date('2025-12-14');
      
      for (let week = 0; week < 156; week++) {
        const periodStart = new Date(firstStart);
        periodStart.setDate(periodStart.getDate() + (week * 14));
        
        const periodEnd = new Date(periodStart);
        periodEnd.setDate(periodEnd.getDate() + 13);
        
        const payDate = new Date(periodEnd);
        payDate.setDate(payDate.getDate() + 6);
        
        const year = periodStart.getFullYear();
        if (years.includes(year) || years.includes(periodEnd.getFullYear())) {
          periods.push({
            start: periodStart,
            end: periodEnd,
            payDate: payDate,
            label: `${formatDate(periodStart)} - ${formatDate(periodEnd)} (Pay: ${formatDate(payDate)})`,
            value: `${periodStart.toISOString().split('T')[0]}|${periodEnd.toISOString().split('T')[0]}`
          });
        }
      }
      
      return periods;
    }

    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const username = document.getElementById('username').value.trim();
      const pin = document.getElementById('pin').value.trim();

      if (!username || !pin) {
        showLoginError('Please enter both username and PIN');
        return;
      }

      setLoginLoading(true);

      try {
        console.log('ðŸ” Attempting login for:', username);

        const isHR = (username.toUpperCase() === 'JT' || username.toUpperCase() === 'PG');

        const { data, error } = await supabaseClient
          .from('employees2025')
          .select('id, employee_id, username, pin, first_name, last_name, job_title, department, employment_status, position_title, hourly_rate, email')
          .eq('username', username)
          .single();

        if (error || !data) {
          console.error('âŒ Login failed - user not found');
          await logLoginAttempt(username, false);
          showLoginError('Invalid username or PIN');
          setLoginLoading(false);
          return;
        }

        if (data.employment_status !== 'Active') {
          console.warn('âš ï¸ Login denied - inactive employee');
          await logLoginAttempt(username, false);
          showLoginError('Access denied. Only active employees can log in.');
          setLoginLoading(false);
          return;
        }

        if (data.pin !== pin) {
          console.error('âŒ Login failed - incorrect PIN');
          await logLoginAttempt(username, false);
          showLoginError('Invalid username or PIN');
          setLoginLoading(false);
          return;
        }

        console.log('âœ… Login successful');
        await logLoginAttempt(username, true, isHR ? 'HR' : 'EMPLOYEE');

        currentUser = {
          id: data.id,
          employee_id: data.employee_id || `EMP-${String(data.id).padStart(4, '0')}`,
          username: data.username,
          first_name: data.first_name,
          last_name: data.last_name,
          job_title: data.job_title || data.position_title,
          department: data.department,
          hourly_rate: data.hourly_rate || 2.50,
          email: data.email || '',
          isApprover: isHR,
          loginTime: new Date().toISOString()
        };

        employeeHourlyRate = currentUser.hourly_rate;
        userRole = isHR ? 'HR' : 'EMPLOYEE';

        console.log('ðŸ‘¤ User role assigned:', userRole);
        console.log('ðŸ’° Hourly rate:', employeeHourlyRate);
        console.log('ðŸ”‘ Is Approver:', currentUser.isApprover);

        document.getElementById('loginSection').classList.add('hidden');
        document.getElementById('appContainer').classList.add('show');

        await initializeApplication();

      } catch (error) {
        console.error('âŒ Login error:', error);
        showLoginError('An error occurred during login. Please try again.');
        setLoginLoading(false);
      }
    });

    function showLoginError(message) {
      const errorDiv = document.getElementById('loginError');
      errorDiv.textContent = message;
      errorDiv.classList.add('show');
      setTimeout(() => {
        errorDiv.classList.remove('show');
      }, 5000);
    }

    function setLoginLoading(isLoading) {
      const loginBtn = document.getElementById('loginBtn');
      if (isLoading) {
        loginBtn.disabled = true;
        loginBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Authenticating...';
      } else {
        loginBtn.disabled = false;
        loginBtn.innerHTML = '<i class="fas fa-sign-in-alt"></i> Login';
      }
    }

    async function logLoginAttempt(username, success, role = null) {
      try {
        await supabaseClient.from('payroll_login_attempts').insert({
          username: username,
          success: success,
          role_assigned: role,
          attempted_at: new Date().toISOString()
        });
      } catch (error) {
        console.error('Failed to log login attempt:', error);
      }
    }

    function logout() {
      currentUser = null;
      userRole = null;
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('appContainer').classList.remove('show');
      document.getElementById('username').value = '';
      document.getElementById('pin').value = '';
    }

    async function initializeApplication() {
      console.log('ðŸš€ Initializing application for', userRole);

      document.getElementById('displayName').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
      document.getElementById('userPosition').textContent = currentUser.job_title;
      
      const roleBadge = document.getElementById('roleBadge');
      roleBadge.textContent = userRole;
      roleBadge.className = `role-badge ${userRole.toLowerCase()}`;

      payrollPeriods = generatePayrollPeriods();

      await loadEmployeeData();
      initializeSignatureCanvases();

      // Show/hide tabs based on role - FIXED WITH NULL CHECKS
      if (currentUser.isApprover) {
        const tabPending = document.getElementById('tabPending');
        const tabApproved = document.getElementById('tabApproved');
        const tabDenied = document.getElementById('tabDenied');
        
        if (tabPending) tabPending.style.display = 'inline-flex';
        if (tabApproved) tabApproved.style.display = 'inline-flex';
        if (tabDenied) tabDenied.style.display = 'inline-flex';
      } else {
        const tabPending = document.getElementById('tabPending');
        const tabApproved = document.getElementById('tabApproved');
        const tabDenied = document.getElementById('tabDenied');
        
        if (tabPending) tabPending.style.display = 'none';
        if (tabApproved) tabApproved.style.display = 'none';
        if (tabDenied) tabDenied.style.display = 'none';
      }

      // Show/hide appropriate sections
      const employeePayrollCard = document.getElementById('employeePayrollCard');
      if (employeePayrollCard) {
        employeePayrollCard.style.display = 'block';
      }

      setupEventListeners();
    }

    async function loadEmployeeData() {
      console.log('ðŸ“Š Loading employee data...');

      document.getElementById('employeeName').textContent = `${currentUser.first_name} ${currentUser.last_name}`;
      document.getElementById('position').textContent = currentUser.job_title;
      document.getElementById('department').textContent = currentUser.department || 'N/A';
      document.getElementById('employeeEmailDisplay').textContent = currentUser.email || 'No email on file';

      const isServer = currentUser.job_title && (
        currentUser.job_title.toLowerCase().includes('server') ||
        currentUser.job_title.toLowerCase().includes('waiter') ||
        currentUser.job_title.toLowerCase().includes('waitress')
      );

      currentPeriod = calculateCurrentPayrollPeriod();
      
      if (userRole === 'EMPLOYEE' || userRole === 'HR') {
        document.getElementById('periodStartEmployee').textContent = formatDate(currentPeriod.start);
        document.getElementById('periodEndEmployee').textContent = formatDate(currentPeriod.end);
        document.getElementById('hourlyRateEmployee').textContent = formatCurrency(employeeHourlyRate);
      }

      await checkEligibility();
    }

    function calculateCurrentPayrollPeriod() {
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      // First period starts on December 14, 2025 (Sunday)
      const firstStart = new Date('2025-12-14T00:00:00');
      firstStart.setHours(0, 0, 0, 0);
      
      // If today is before the first period start, return the first period
      if (today < firstStart) {
        const firstEnd = new Date(firstStart);
        firstEnd.setDate(firstEnd.getDate() + 13); // December 27, 2025 (Saturday)
        
        const payDate = new Date(firstEnd);
        payDate.setDate(payDate.getDate() + 6);
        
        return {
          start: firstStart,
          end: firstEnd,
          payDate: payDate
        };
      }
      
      // Calculate how many days since first period started
      const daysSinceFirst = Math.floor((today - firstStart) / (1000 * 60 * 60 * 24));
      
      // Calculate which period we're in (each period is 14 days)
      const periodNumber = Math.floor(daysSinceFirst / 14);
      
      // Calculate the start of the current period
      const currentStart = new Date(firstStart);
      currentStart.setDate(currentStart.getDate() + (periodNumber * 14));
      
      // End is 13 days after start (14-day period, Sunday to Saturday)
      const currentEnd = new Date(currentStart);
      currentEnd.setDate(currentEnd.getDate() + 13);
      
      // Pay date is 6 days after period end (Friday)
      const payDate = new Date(currentEnd);
      payDate.setDate(payDate.getDate() + 6);
      
      console.log('ðŸ“… Current Payroll Period:');
      console.log('   Today:', formatDate(today));
      console.log('   Days since first:', daysSinceFirst);
      console.log('   Period number:', periodNumber);
      console.log('   Start:', formatDate(currentStart), '(Sunday)');
      console.log('   End:', formatDate(currentEnd), '(Saturday)');
      console.log('   Pay Date:', formatDate(payDate), '(Friday)');
      
      return {
        start: currentStart,
        end: currentEnd,
        payDate: payDate
      };
    }

    function formatDate(date) {
      return date.toLocaleDateString('en-US', { year: 'numeric', month: '2-digit', day: '2-digit' });
    }

    function formatCurrency(amount) {
      return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
    }

    async function checkEligibility() {
      console.log('ðŸ” Checking eligibility...');

      try {
        const currentYear = new Date().getFullYear();
        
        const { data: advances, error } = await supabaseClient
          .from('payroll_advances')
          .select('id, status, outstanding_balance, created_at')
          .eq('employee_id', currentUser.employee_id);

        if (error && error.code !== 'PGRST116') {
          console.error('Error checking eligibility:', error);
          return;
        }

        const yearAdvances = advances ? advances.filter(a => {
          const year = new Date(a.created_at).getFullYear();
          return year === currentYear;
        }) : [];

        const advanceCount = yearAdvances.length;
        document.getElementById('advanceCounterDisplay').textContent = `${advanceCount} / 6`;

        const hasOutstanding = advances ? advances.some(a => 
          a.outstanding_balance > 0 || 
          ['submitted', 'approved'].includes(a.status)
        ) : false;

        const { data: empData } = await supabaseClient
          .from('employees2025')
          .select('disciplinary_warning_count, final_warning_count')
          .eq('employee_id', currentUser.employee_id)
          .single();

        const hasDisciplinary = empData && (
          (empData.disciplinary_warning_count && empData.disciplinary_warning_count > 0) ||
          (empData.final_warning_count && empData.final_warning_count > 0)
        );

        if (userRole === 'EMPLOYEE') {
          if (advanceCount >= 6) {
            showBlockingAlert('danger', 'You have reached the maximum of 6 advances for this year.');
            return false;
          }

          if (hasOutstanding) {
            showBlockingAlert('danger', 'You have an outstanding advance balance or pending request. Please clear it before requesting a new advance.');
            return false;
          }
        }

        return true;

      } catch (error) {
        console.error('Eligibility check error:', error);
        return false;
      }
    }

    function showBlockingAlert(type, message) {
      const alertDiv = document.getElementById('blockingAlert');
      alertDiv.className = `alert alert-${type}`;
      alertDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i><div><strong>Access Restricted:</strong> ${message}</div>`;
      alertDiv.style.display = 'flex';
    }

    function setupEventListeners() {
      document.getElementById('requestedAmount').addEventListener('input', updateSubmitButton);
      document.getElementById('pin').addEventListener('input', (e) => {
        e.target.value = e.target.value.replace(/[^0-9]/g, '');
      });
    }

    function initializeSignatureCanvases() {
      employeeCanvas = document.getElementById('employeeSignatureCanvas');
      if (!employeeCanvas) return;
      
      employeeCtx = employeeCanvas.getContext('2d');
      employeeCanvas.width = employeeCanvas.offsetWidth;
      employeeCanvas.height = employeeCanvas.offsetHeight;
      employeeCtx.strokeStyle = '#2c3e50';
      employeeCtx.lineWidth = 2;
      employeeCtx.lineCap = 'round';
      employeeCtx.lineJoin = 'round';

      employeeCanvas.addEventListener('mousedown', startDrawingEmployee);
      employeeCanvas.addEventListener('mousemove', drawEmployee);
      employeeCanvas.addEventListener('mouseup', stopDrawingEmployee);
      employeeCanvas.addEventListener('mouseout', stopDrawingEmployee);
      employeeCanvas.addEventListener('touchstart', handleTouchEmployee);
      employeeCanvas.addEventListener('touchmove', handleTouchEmployee);
      employeeCanvas.addEventListener('touchend', stopDrawingEmployee);

      if (currentUser.isApprover) {
        hrCanvas = document.getElementById('hrSignatureCanvas');
        if (hrCanvas) {
          hrCtx = hrCanvas.getContext('2d');
          hrCanvas.width = hrCanvas.offsetWidth;
          hrCanvas.height = hrCanvas.offsetHeight;
          hrCtx.strokeStyle = '#2c3e50';
          hrCtx.lineWidth = 2;
          hrCtx.lineCap = 'round';
          hrCtx.lineJoin = 'round';

          hrCanvas.addEventListener('mousedown', startDrawingHR);
          hrCanvas.addEventListener('mousemove', drawHR);
          hrCanvas.addEventListener('mouseup', stopDrawingHR);
          hrCanvas.addEventListener('mouseout', stopDrawingHR);
          hrCanvas.addEventListener('touchstart', handleTouchHR);
          hrCanvas.addEventListener('touchmove', handleTouchHR);
          hrCanvas.addEventListener('touchend', stopDrawingHR);
        }
      }
    }

    function startDrawingEmployee(e) {
      isDrawingEmployee = true;
      const rect = employeeCanvas.getBoundingClientRect();
      employeeCtx.beginPath();
      employeeCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function drawEmployee(e) {
      if (!isDrawingEmployee) return;
      const rect = employeeCanvas.getBoundingClientRect();
      employeeCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      employeeCtx.stroke();
      hasEmployeeSigned = true;
      updateSubmitButton();
    }

    function stopDrawingEmployee() {
      isDrawingEmployee = false;
    }

    function handleTouchEmployee(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(
        e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup',
        { clientX: touch.clientX, clientY: touch.clientY }
      );
      employeeCanvas.dispatchEvent(mouseEvent);
    }

    function clearEmployeeSignature() {
      if (employeeCtx && employeeCanvas) {
        employeeCtx.clearRect(0, 0, employeeCanvas.width, employeeCanvas.height);
        hasEmployeeSigned = false;
        updateSubmitButton();
      }
    }

    function startDrawingHR(e) {
      isDrawingHR = true;
      const rect = hrCanvas.getBoundingClientRect();
      hrCtx.beginPath();
      hrCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function drawHR(e) {
      if (!isDrawingHR) return;
      const rect = hrCanvas.getBoundingClientRect();
      hrCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      hrCtx.stroke();
      hasHRSigned = true;
    }

    function stopDrawingHR() {
      isDrawingHR = false;
    }

    function handleTouchHR(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(
        e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup',
        { clientX: touch.clientX, clientY: touch.clientY }
      );
      hrCanvas.dispatchEvent(mouseEvent);
    }

    function clearHRSignature() {
      if (hrCtx && hrCanvas) {
        hrCtx.clearRect(0, 0, hrCanvas.width, hrCanvas.height);
        hasHRSigned = false;
      }
    }

    function updateSubmitButton() {
      const amount = parseFloat(document.getElementById('requestedAmount').value) || 0;
      const submitBtn = document.getElementById('submitBtn');
      
      if (currentUser.isApprover) {
        submitBtn.disabled = false;
      } else {
        submitBtn.disabled = !(hasEmployeeSigned && amount > 0);
      }
    }

    async function submitRequest() {
      try {
        const requestedAmount = parseFloat(document.getElementById('requestedAmount').value);

        if (!requestedAmount || requestedAmount <= 0) {
          alert('Please enter a valid amount.');
          return;
        }

        if (!currentUser.email) {
          alert('No email address on file. Please contact HR to update your email before submitting a request.');
          return;
        }

        // Insert into payroll_advances
        const { data, error } = await supabaseClient
          .from('payroll_advances')
          .insert({
            employee_id: currentUser.employee_id,
            employee_name: `${currentUser.first_name} ${currentUser.last_name}`,
            employee_email: currentUser.email,
            department: currentUser.department,
            position: currentUser.job_title,
            requested_amount: requestedAmount,
            payroll_period_start: currentPeriod.start.toISOString().split('T')[0],
            payroll_period_end: currentPeriod.end.toISOString().split('T')[0],
            status: 'submitted',
            employee_signature: employeeCanvas.toDataURL('image/png'),
            hourly_rate: employeeHourlyRate
          })
          .select()
          .single();

        if (error) throw error;

        // Log the action
        await supabaseClient.rpc('log_payroll_advance_action', {
          p_advance_id: data.id,
          p_employee_id: currentUser.employee_id,
          p_action: 'submitted',
          p_performed_by: 'employee',
          p_notes: null
        });

        // Show success modal
        document.getElementById('successModal').classList.add('show');

      } catch (err) {
        console.error('âŒ Submit error:', err);
        alert('An error occurred submitting the request: ' + err.message);
      }
    }

    async function loadPendingPayrollAdvances() {
      const { data, error } = await supabaseClient
        .from('payroll_advances')
        .select(`
          id,
          employee_name,
          department,
          position,
          requested_amount,
          payroll_period_start,
          payroll_period_end,
          created_at
        `)
        .eq('status', 'submitted')
        .order('created_at', { ascending: true });

      if (error) {
        console.error('Error loading pending payroll advances:', error);
        return;
      }

      renderPendingPayrollAdvances(data);
    }

    function renderPendingPayrollAdvances(rows) {
      const tbody = document.getElementById('pendingAdvanceTable');
      if (!tbody) return;
      
      tbody.innerHTML = '';

      if (!rows || rows.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="padding:15px; text-align:center; color:#7f8c8d;">
              No pending payroll advances
            </td>
          </tr>`;
        return;
      }

      rows.forEach(r => {
        const tr = document.createElement('tr');
        
        // Parse dates correctly to avoid timezone issues
        const startDate = new Date(r.payroll_period_start + 'T00:00:00');
        const endDate = new Date(r.payroll_period_end + 'T00:00:00');
        const submittedDate = new Date(r.created_at);
        
        tr.innerHTML = `
          <td style="padding:10px;">${r.employee_name}</td>
          <td style="padding:10px;">${formatCurrency(r.requested_amount)}</td>
          <td style="padding:10px;">
            ${formatDate(startDate)} â€“ ${formatDate(endDate)}
          </td>
          <td style="padding:10px;">${formatDate(submittedDate)}</td>
          <td style="padding:10px;">
            <button class="btn btn-primary btn-sm"
              onclick="openAdvanceForReview(${r.id})">
              Review
            </button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    }

   async function openAdvanceForReview(advanceId) {
      if (!currentUser.isApprover) {
        alert('Unauthorized action.');
        return;
      }

      try {
        // Get the advance request details
        const { data: advance, error: advanceError } = await supabaseClient
          .from('payroll_advances')
          .select('*')
          .eq('id', advanceId)
          .single();

        if (advanceError) throw advanceError;

        currentAdvanceId = advance.id;
        selectedEmployeeId = advance.employee_id;

        // Get employee details from employees2025
        const { data: employee, error: empError } = await supabaseClient
          .from('employees2025')
          .select('*')
          .eq('employee_id', advance.employee_id)
          .single();

        if (empError) throw empError;

        // Check for disciplinary actions
        const hasDisciplinary = (employee.disciplinary_warning_count > 0) || (employee.final_warning_count > 0);

        // Check for outstanding advances
        const { data: outstandingAdvances } = await supabaseClient
          .from('payroll_advances')
          .select('outstanding_balance')
          .eq('employee_id', advance.employee_id)
          .neq('status', 'denied')
          .neq('id', advanceId);

        const hasOutstanding = outstandingAdvances && outstandingAdvances.some(a => a.outstanding_balance > 0);

        // Count advances this year
        const currentYear = new Date().getFullYear();
        const { data: yearAdvances } = await supabaseClient
          .from('payroll_advances')
          .select('id')
          .eq('employee_id', advance.employee_id)
          .gte('created_at', `${currentYear}-01-01`)
          .lte('created_at', `${currentYear}-12-31`);

        const advanceCount = yearAdvances ? yearAdvances.length : 0;

        // Determine if server
        const isServer = employee.job_title && (
          employee.job_title.toLowerCase().includes('server') ||
          employee.job_title.toLowerCase().includes('waiter') ||
          employee.job_title.toLowerCase().includes('waitress')
        );

        // Get hours worked and tips for this pay period
        const periodStart = new Date(advance.payroll_period_start);
        const periodEnd = new Date(advance.payroll_period_end);

        // TODO: Replace with actual timesheet query
        // For now, using placeholder values
        const hoursWorked = 50; // This should come from your timesheet system
        const tipsEarned = isServer ? 500 : 0; // This should come from your tip tracking system

        const hourlyRate = employee.hourly_rate || 2.50;
        const baseWages = hoursWorked * hourlyRate;
        const grossEarned = baseWages + tipsEarned;
        const eligibleAmount = grossEarned * 0.50;
        const requestedAmount = advance.requested_amount;

        const withinLimit = requestedAmount <= eligibleAmount;
        const isEligible = withinLimit && !hasOutstanding && advanceCount < 6;

        // Populate the review modal
        document.getElementById('reviewEmployeeName').textContent = advance.employee_name;
        document.getElementById('reviewEmployeeID').textContent = advance.employee_id;
        document.getElementById('reviewPosition').textContent = advance.position || employee.job_title;
        document.getElementById('reviewDepartment').textContent = advance.department || employee.department;
        document.getElementById('reviewIsServer').textContent = isServer ? 'Yes' : 'No';

        document.getElementById('reviewPeriodStart').textContent = formatDate(periodStart);
        document.getElementById('reviewPeriodEnd').textContent = formatDate(periodEnd);
        document.getElementById('reviewAdvanceCount').textContent = `${advanceCount} / 6`;
        
        const outstandingEl = document.getElementById('reviewOutstanding');
        outstandingEl.textContent = hasOutstanding ? 'Y' : 'N';
        outstandingEl.className = hasOutstanding ? 'review-value danger' : 'review-value success';

        const disciplinaryEl = document.getElementById('reviewDisciplinary');
        disciplinaryEl.textContent = hasDisciplinary ? 'Y' : 'N';
        disciplinaryEl.className = hasDisciplinary ? 'review-value danger' : 'review-value success';

        // Populate editable calculation fields
        document.getElementById('reviewHoursWorkedInput').value = advance.hours_worked || hoursWorked || '';
        document.getElementById('reviewTipsEarnedInput').value = advance.tips_earned || tipsEarned || '';
        document.getElementById('reviewHourlyRateInput').value = advance.hourly_rate || hourlyRate || '';
        document.getElementById('reviewRequestedAmountCalc').textContent = formatCurrency(requestedAmount);

        // Initial calculation
        calculateEarningsInModal();

        // Pre-fill approver name
        document.getElementById('reviewApproverName').value = `${currentUser.first_name} ${currentUser.last_name}`;
        document.getElementById('reviewApprovedAmount').value = '';
        document.getElementById('reviewHRNotes').value = '';

        // Initialize review HR signature canvas
        initializeReviewHRSignatureCanvas();

        // Show the modal
        document.getElementById('reviewModal').classList.add('show');

      } catch (error) {
        console.error('Error loading review:', error);
        alert('Failed to load advance request details.');
      }
    }

    function closeReviewModal() {
      document.getElementById('reviewModal').classList.remove('show');
      hasReviewHRSigned = false;
    }

    function initializeReviewHRSignatureCanvas() {
      reviewHRCanvas = document.getElementById('reviewHRSignatureCanvas');
      if (!reviewHRCanvas) return;

      reviewHRCtx = reviewHRCanvas.getContext('2d');
      reviewHRCanvas.width = reviewHRCanvas.offsetWidth;
      reviewHRCanvas.height = reviewHRCanvas.offsetHeight;
      reviewHRCtx.strokeStyle = '#2c3e50';
      reviewHRCtx.lineWidth = 2;
      reviewHRCtx.lineCap = 'round';
      reviewHRCtx.lineJoin = 'round';

      // Clear any previous signature
      reviewHRCtx.clearRect(0, 0, reviewHRCanvas.width, reviewHRCanvas.height);
      hasReviewHRSigned = false;

      // Remove old listeners
      reviewHRCanvas.removeEventListener('mousedown', startDrawingReviewHR);
      reviewHRCanvas.removeEventListener('mousemove', drawReviewHR);
      reviewHRCanvas.removeEventListener('mouseup', stopDrawingReviewHR);
      reviewHRCanvas.removeEventListener('mouseout', stopDrawingReviewHR);

      // Add event listeners
      reviewHRCanvas.addEventListener('mousedown', startDrawingReviewHR);
      reviewHRCanvas.addEventListener('mousemove', drawReviewHR);
      reviewHRCanvas.addEventListener('mouseup', stopDrawingReviewHR);
      reviewHRCanvas.addEventListener('mouseout', stopDrawingReviewHR);
      reviewHRCanvas.addEventListener('touchstart', handleTouchReviewHR);
      reviewHRCanvas.addEventListener('touchmove', handleTouchReviewHR);
      reviewHRCanvas.addEventListener('touchend', stopDrawingReviewHR);
    }

    function startDrawingReviewHR(e) {
      isDrawingReviewHR = true;
      const rect = reviewHRCanvas.getBoundingClientRect();
      reviewHRCtx.beginPath();
      reviewHRCtx.moveTo(e.clientX - rect.left, e.clientY - rect.top);
    }

    function drawReviewHR(e) {
      if (!isDrawingReviewHR) return;
      const rect = reviewHRCanvas.getBoundingClientRect();
      reviewHRCtx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
      reviewHRCtx.stroke();
      hasReviewHRSigned = true;
    }

    function stopDrawingReviewHR() {
      isDrawingReviewHR = false;
    }

    function handleTouchReviewHR(e) {
      e.preventDefault();
      const touch = e.touches[0];
      const mouseEvent = new MouseEvent(
        e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup',
        { clientX: touch.clientX, clientY: touch.clientY }
      );
      reviewHRCanvas.dispatchEvent(mouseEvent);
    }

    function clearReviewHRSignature() {
      if (reviewHRCtx && reviewHRCanvas) {
        reviewHRCtx.clearRect(0, 0, reviewHRCanvas.width, reviewHRCanvas.height);
        hasReviewHRSigned = false;
      }
    }

    function calculateEarningsInModal() {
      const hoursWorked = parseFloat(document.getElementById('reviewHoursWorkedInput').value) || 0;
      const tipsEarned = parseFloat(document.getElementById('reviewTipsEarnedInput').value) || 0;
      const hourlyRate = parseFloat(document.getElementById('reviewHourlyRateInput').value) || 0;
      const requestedAmount = parseFloat(document.getElementById('reviewRequestedAmountCalc').textContent.replace(/[$,]/g, '')) || 0;

      const baseWages = hoursWorked * hourlyRate;
      const grossEarned = baseWages + tipsEarned;
      const eligibleAmount = grossEarned * 0.50;
      const withinLimit = requestedAmount <= eligibleAmount;

      // Update display
      document.getElementById('reviewGrossEarnedCalc').textContent = formatCurrency(grossEarned);
      document.getElementById('reviewEligibleAmountCalc').textContent = formatCurrency(eligibleAmount);

      const limitCheckEl = document.getElementById('reviewLimitCheckCalc');
      if (withinLimit) {
        limitCheckEl.textContent = 'OK â€” within 50% limit.';
        limitCheckEl.style.color = '#27ae60';
        limitCheckEl.style.fontWeight = '600';
      } else {
        limitCheckEl.textContent = `EXCEEDS LIMIT â€” Max: ${formatCurrency(eligibleAmount)}`;
        limitCheckEl.style.color = '#e74c3c';
        limitCheckEl.style.fontWeight = '700';
      }

      // Update eligibility status
      updateEligibilityStatus();
    }

    function updateEligibilityStatus() {
      const hoursWorked = parseFloat(document.getElementById('reviewHoursWorkedInput').value) || 0;
      const tipsEarned = parseFloat(document.getElementById('reviewTipsEarnedInput').value) || 0;
      const hourlyRate = parseFloat(document.getElementById('reviewHourlyRateInput').value) || 0;
      const requestedAmount = parseFloat(document.getElementById('reviewRequestedAmountCalc').textContent.replace(/[$,]/g, '')) || 0;

      const grossEarned = (hoursWorked * hourlyRate) + tipsEarned;
      const eligibleAmount = grossEarned * 0.50;
      const withinLimit = requestedAmount <= eligibleAmount;

      const hasOutstanding = document.getElementById('reviewOutstanding').textContent === 'Y';
      const hasDisciplinary = document.getElementById('reviewDisciplinary').textContent === 'Y';
      const advanceCount = parseInt(document.getElementById('reviewAdvanceCount').textContent.split('/')[0].trim());

      const isEligible = withinLimit && !hasOutstanding && advanceCount < 6;

      const eligibilityBox = document.getElementById('reviewEligibilityBox');
      const eligibilityText = document.getElementById('reviewEligibilityText');
      
      if (isEligible) {
        eligibilityBox.className = 'eligibility-box eligible';
        eligibilityText.innerHTML = '<i class="fas fa-check-circle"></i> ELIGIBLE â€” Meets policy conditions.';
      } else {
        eligibilityBox.className = 'eligibility-box ineligible';
        let reasons = [];
        if (!withinLimit) reasons.push('exceeds 50% limit');
        if (hasOutstanding) reasons.push('has outstanding balance');
        if (advanceCount >= 6) reasons.push('reached 6 advance maximum');
        eligibilityText.innerHTML = `<i class="fas fa-exclamation-triangle"></i> INELIGIBLE â€” ${reasons.join(', ')}`;
      }
    }

    async function approveFromModal() {

      document.getElementById('approvalSuccessActions').style.display = 'block';

      if (!currentUser.isApprover) {
        alert('Unauthorized action.');
        return;
      }

      try {
        const approvedAmount =
          parseFloat(document.getElementById('reviewApprovedAmount').value) ||
          parseFloat(document.getElementById('reviewRequestedAmountCalc').textContent.replace(/[$,]/g, ''));

        const hrNotes = document.getElementById('reviewHRNotes').value;
        const approverName = document.getElementById('reviewApproverName').value;

        // Get the entered calculation values
        const hoursWorked = parseFloat(document.getElementById('reviewHoursWorkedInput').value) || 0;
        const tipsEarned = parseFloat(document.getElementById('reviewTipsEarnedInput').value) || 0;
        const hourlyRate = parseFloat(document.getElementById('reviewHourlyRateInput').value) || 0;
        const grossEarned = (hoursWorked * hourlyRate) + tipsEarned;

        // Validation
        if (!approverName) {
          alert('Please enter approver name/title');
          return;
        }

        if (hoursWorked === 0 || hourlyRate === 0) {
          alert('Please enter hours worked and hourly rate');
          return;
        }

        if (!hasReviewHRSigned) {
          alert('Please sign the approval before submitting');
          return;
        }

        // Get HR signature as base64
        const hrSignature = reviewHRCanvas.toDataURL('image/png');

        // Update DB with all calculation data and signature
        const { error } = await supabaseClient
          .from('payroll_advances')
          .update({
            status: 'approved',
            approved_amount: approvedAmount,
            hours_worked: hoursWorked,
            tips_earned: tipsEarned,
            hourly_rate: hourlyRate,
            gross_earned: grossEarned,
            hr_notes: hrNotes,
            hr_signature: hrSignature,
            hr_approved_by: approverName,
            approved_at: new Date().toISOString()
          })
          .eq('id', currentAdvanceId);

        if (error) throw error;

        // Log the action
        await supabaseClient.rpc('log_payroll_advance_action', {
          p_advance_id: currentAdvanceId,
          p_employee_id: selectedEmployeeId,
          p_action: 'approved',
          p_performed_by: 'HR',
          p_notes: hrNotes
        });

        // Hide approve/deny buttons, show success actions
        const modalActions = document.querySelector('.modal-actions');
        if (modalActions) modalActions.style.display = 'none';
        
        const successActions = document.getElementById('approvalSuccessActions');
        if (successActions) {
          successActions.style.display = 'block';
          // Scroll to success section
          successActions.scrollIntoView({ behavior: 'smooth' });
        }

      } catch (err) {
        console.error(err);
        alert('Approval failed: ' + err.message);
      }
    }

    function saveApprovalData() {
      alert('Data has been saved successfully!');
      // Don't reload - just close modal and refresh pending list
      closeReviewModal();
      switchTab('pending'); // Refresh the pending tab
    }



function generateCorporatePDF() {
  const element = document.querySelector('.review-modal-content');

  if (!element) {
    alert('PDF content not found.');
    return;
  }

  // FORCE FULL HEIGHT RENDER
  const originalOverflow = element.style.overflow;
  element.style.overflow = 'visible';

  const options = {
    margin: 0.5,
    filename: `Payroll_Advance_${currentAdvanceId || 'preview'}.pdf`,
    image: { type: 'jpeg', quality: 0.98 },
    html2canvas: { scale: 2, scrollY: 0, useCORS: true },
    jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
  };

  html2pdf()
    .set(options)
    .from(element)
    .save()
    .then(() => {
      element.style.overflow = originalOverflow;
    });
}












    async function denyFromModal() {
      if (!currentUser.isApprover) {
        alert('Unauthorized action.');
        return;
      }

      try {
        const hrNotes = document.getElementById('reviewHRNotes').value;
        const approverName = document.getElementById('reviewApproverName').value;

        if (!hrNotes) {
          alert('Please provide a denial reason.');
          return;
        }

        if (!approverName) {
          alert('Please enter approver name/title');
          return;
        }

        if (!hasReviewHRSigned) {
          alert('Please sign the denial before submitting');
          return;
        }

        // Get HR signature as base64
        const hrSignature = reviewHRCanvas.toDataURL('image/png');

        const { error } = await supabaseClient
          .from('payroll_advances')
          .update({
            status: 'denied',
            hr_notes: hrNotes,
            hr_signature: hrSignature,
            hr_approved_by: approverName,
            denied_at: new Date().toISOString()
          })
          .eq('id', currentAdvanceId);

        if (error) throw error;

        // Log the action
        await supabaseClient.rpc('log_payroll_advance_action', {
          p_advance_id: currentAdvanceId,
          p_employee_id: selectedEmployeeId,
          p_action: 'denied',
          p_performed_by: 'HR',
          p_notes: hrNotes
        });

        // Call PDF generation function for denial letter too
        console.log('ðŸ“„ Generating denial PDF and sending emails...');
        try {
          const pdfResponse = await fetch(
            'https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/generate-advance-pdf',
            {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ 
                advanceId: currentAdvanceId
              })
            }
          );

          if (pdfResponse.ok) {
            console.log('âœ… Denial PDF generated and emails sent');
          }
        } catch (pdfError) {
          console.error('PDF generation error:', pdfError);
        }

        alert('Advance denied successfully. Notification sent to employee.');
        location.reload();

      } catch (err) {
        console.error(err);
        alert('Denial failed: ' + err.message);
      }
    }

    async function approveRequest() {
      if (!currentUser.isApprover) {
        alert('Unauthorized action.');
        return;
      }

      try {
        const approvedAmount =
          parseFloat(document.getElementById('approvedAmount').value) ||
          parseFloat(document.getElementById('requestedAmount').value);

        const hrNotes = document.getElementById('hrNotes').value;

        // Update DB
        const { error } = await supabaseClient
          .from('payroll_advances')
          .update({
            status: 'approved',
            approved_amount: approvedAmount,
            hr_notes: hrNotes,
            hr_signature: hrCanvas ? hrCanvas.toDataURL('image/png') : null,
            hr_approved_by: currentUser.username,
            approved_at: new Date().toISOString()
          })
          .eq('id', currentAdvanceId);

        if (error) throw error;

        // Log the action
        await supabaseClient.rpc('log_payroll_advance_action', {
          p_advance_id: currentAdvanceId,
          p_employee_id: selectedEmployeeId,
          p_action: 'approved',
          p_performed_by: 'HR',
          p_notes: hrNotes
        });

        alert('Advance approved successfully.');
        location.reload();

      } catch (err) {
        console.error(err);
        alert('Approval failed.');
      }
    }

    async function denyRequest() {
      if (!currentUser.isApprover) {
        alert('Unauthorized action.');
        return;
      }

      try {
        const hrNotes = document.getElementById('hrNotes').value;

        if (!hrNotes) {
          alert('Please provide a denial reason.');
          return;
        }

        const { error } = await supabaseClient
          .from('payroll_advances')
          .update({
            status: 'denied',
            hr_notes: hrNotes,
            hr_approved_by: currentUser.username,
            denied_at: new Date().toISOString()
          })
          .eq('id', currentAdvanceId);

        if (error) throw error;

        // Log the action
        await supabaseClient.rpc('log_payroll_advance_action', {
          p_advance_id: currentAdvanceId,
          p_employee_id: selectedEmployeeId,
          p_action: 'denied',
          p_performed_by: 'HR',
            p_notes: hrNotes
        });

        alert('Advance denied successfully.');
        location.reload();

      } catch (err) {
        console.error(err);
        alert('Denial failed.');
      }
    }


// ===== APPROVED ADVANCES =====
async function loadApprovedAdvances() {
  const { data, error } = await supabaseClient
    .from('payroll_advances')
    .select('*')
    .eq('status', 'approved')
    .order('approved_at', { ascending: false });

  if (error) {
    console.error('Error loading approved advances:', error);
    return;
  }

  renderApprovedAdvances(data);
}






function renderApprovedAdvances(rows) {
  const tbody = document.getElementById('approvedAdvanceTable');
  tbody.innerHTML = '';

  if (!rows || rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="padding:15px; text-align:center; color:#7f8c8d;">
          No approved advances
        </td>
      </tr>`;
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const approvedDate = new Date(r.approved_at);
    
    tr.innerHTML = `
      <td style="padding:10px;">${r.employee_name}</td>
      <td style="padding:10px;">${formatCurrency(r.approved_amount || r.requested_amount)}</td>
      <td style="padding:10px;">${formatDate(approvedDate)}</td>
      <td style="padding:10px;">
        <div style="display:flex; gap:5px;">
          <button class="btn btn-sm" style="background: #17a2b8; color: white; padding: 6px 12px;" onclick="viewAdvanceDetails(${r.id})">
            <i class="fas fa-eye"></i> View
          </button>
          <button class="btn btn-sm" style="background: #6f42c1; color: white; padding: 6px 12px;" onclick="regeneratePDF(${r.id})">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
          <button class="btn btn-sm" style="background: #28a745; color: white; padding: 6px 12px;" onclick="resendEmail(${r.id})">
            <i class="fas fa-envelope"></i> Resend
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}








// ===== DENIED ADVANCES =====
async function loadDeniedAdvances() {
  const { data, error } = await supabaseClient
    .from('payroll_advances')
    .select('*')
    .eq('status', 'denied')
    .order('denied_at', { ascending: false });

  if (error) {
    console.error('Error loading denied advances:', error);
    return;
  }

  renderDeniedAdvances(data);
}




function renderDeniedAdvances(rows) {
  const tbody = document.getElementById('deniedAdvanceTable');
  tbody.innerHTML = '';

  if (!rows || rows.length === 0) {
    tbody.innerHTML = `
      <tr>
        <td colspan="5" style="padding:15px; text-align:center; color:#7f8c8d;">
          No denied advances
        </td>
      </tr>`;
    return;
  }

  rows.forEach(r => {
    const tr = document.createElement('tr');
    const deniedDate = new Date(r.denied_at);
    
    tr.innerHTML = `
      <td style="padding:10px;">${r.employee_name}</td>
      <td style="padding:10px;">${formatCurrency(r.requested_amount)}</td>
      <td style="padding:10px; max-width: 200px; overflow: hidden; text-overflow: ellipsis;">${r.hr_notes || 'N/A'}</td>
      <td style="padding:10px;">${formatDate(deniedDate)}</td>
      <td style="padding:10px;">
        <div style="display:flex; gap:5px;">
          <button class="btn btn-sm" style="background: #17a2b8; color: white; padding: 6px 12px;" onclick="viewAdvanceDetails(${r.id})">
            <i class="fas fa-eye"></i> View
          </button>
          <button class="btn btn-sm" style="background: #6f42c1; color: white; padding: 6px 12px;" onclick="regeneratePDF(${r.id})">
            <i class="fas fa-file-pdf"></i> PDF
          </button>
          <button class="btn btn-sm" style="background: #28a745; color: white; padding: 6px 12px;" onclick="resendEmail(${r.id})">
            <i class="fas fa-envelope"></i> Resend
          </button>
        </div>
      </td>
    `;
    tbody.appendChild(tr);
  });
}










// ===== VIEW/PDF/RESEND ACTIONS =====
async function viewAdvanceDetails(advanceId) {
  // Reopen the review modal with the advance details (read-only mode)
  await openAdvanceForReview(advanceId);
  
  // Hide action buttons since decision is already made
  const modalActions = document.querySelector('.modal-actions');
  const successActions = document.getElementById('approvalSuccessActions');
  
  if (modalActions) modalActions.style.display = 'none';
  if (successActions) successActions.style.display = 'none';
  
  // Make all inputs read-only (with null checks)
  const reviewHours = document.getElementById('reviewHoursWorkedInput');
  const reviewTips = document.getElementById('reviewTipsEarnedInput');
  const reviewRate = document.getElementById('reviewHourlyRateInput');
  const reviewAmount = document.getElementById('reviewApprovedAmount');
  const reviewNotes = document.getElementById('reviewHRNotes');
  const reviewApprover = document.getElementById('reviewApproverName');
  const outstandingCheck = document.getElementById('hasOutstandingBalance');
  const disciplinaryCheck = document.getElementById('hasDisciplinaryAction');
  const outstandingNotes = document.getElementById('outstandingBalanceNotes');
  const disciplinaryNotes = document.getElementById('disciplinaryActionNotes');
  
  if (reviewHours) reviewHours.disabled = true;
  if (reviewTips) reviewTips.disabled = true;
  if (reviewRate) reviewRate.disabled = true;
  if (reviewAmount) reviewAmount.disabled = true;
  if (reviewNotes) reviewNotes.disabled = true;
  if (reviewApprover) reviewApprover.disabled = true;
  if (outstandingCheck) outstandingCheck.disabled = true;
  if (disciplinaryCheck) disciplinaryCheck.disabled = true;
  if (outstandingNotes) outstandingNotes.disabled = true;
  if (disciplinaryNotes) disciplinaryNotes.disabled = true;
}








async function regeneratePDF(advanceId) {
  if (!confirm('Generate a new PDF for this advance?')) return;
  
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ“„ PDF GENERATION STARTED');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ”‘ Advance ID:', advanceId);
  console.log('ðŸ”‘ Supabase URL:', SUPABASE_URL);
  console.log('ðŸ”‘ API Key (first 20 chars):', SUPABASE_ANON_KEY.substring(0, 20) + '...');
  
  // Show loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'pdfLoadingIndicator';
  loadingDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px 50px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 10000;
    text-align: center;
  `;
  loadingDiv.innerHTML = `
    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
    <h3 style="margin: 10px 0; color: #2c3e50;">Generating PDF...</h3>
    <p style="color: #7f8c8d; margin: 5px 0;">Please wait</p>
  `;
  document.body.appendChild(loadingDiv);
  
  try {
    const url = 'https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/generate-advance-pdf';
    const payload = { advanceId: advanceId };
    
    console.log('ðŸ“¤ Request URL:', url);
    console.log('ðŸ“¤ Request Payload:', JSON.stringify(payload, null, 2));
    console.log('ðŸ“¤ Request Headers:', {
      'Content-Type': 'application/json',
      'Authorization': 'Bearer ' + SUPABASE_ANON_KEY.substring(0, 20) + '...'
    });
    
    const startTime = Date.now();
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'apikey': SUPABASE_ANON_KEY
      },
      body: JSON.stringify(payload)
    });

    const endTime = Date.now();
    const duration = endTime - startTime;

    console.log('ðŸ“¥ Response received in:', duration + 'ms');
    console.log('ðŸ“¥ Response status:', response.status);
    console.log('ðŸ“¥ Response statusText:', response.statusText);
    console.log('ðŸ“¥ Response headers:', Object.fromEntries([...response.headers.entries()]));

    // Remove loading indicator
    document.body.removeChild(loadingDiv);

    if (response.ok) {
      const result = await response.json();
      console.log('âœ… SUCCESS - PDF Generated');
      console.log('âœ… Result:', JSON.stringify(result, null, 2));
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      // Show success modal
      const successDiv = document.createElement('div');
      successDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        max-width: 500px;
      `;
      successDiv.innerHTML = `
        <i class="fas fa-check-circle" style="font-size: 60px; color: #28a745; margin-bottom: 20px;"></i>
        <h2 style="color: #2c3e50; margin-bottom: 15px;">PDF Generated Successfully!</h2>
        <p style="color: #7f8c8d; margin-bottom: 20px;">The PDF has been generated and emails have been sent.</p>
        ${result.pdfUrl ? `<p style="margin: 15px 0;"><a href="${result.pdfUrl}" target="_blank" style="color: #3498db; text-decoration: underline;">View PDF</a></p>` : ''}
        <button onclick="this.parentElement.remove()" style="
          padding: 12px 30px;
          background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-top: 15px;
        ">Close</button>
      `;
      document.body.appendChild(successDiv);
      
    } else {
      const errorText = await response.text();
      console.error('âŒ FAILED - PDF Generation Error');
      console.error('âŒ Status:', response.status);
      console.error('âŒ Status Text:', response.statusText);
      console.error('âŒ Error Response:', errorText);
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      alert(`âŒ Failed to generate PDF\n\nStatus: ${response.status}\nError: ${errorText}\n\nCheck console for full details.`);
    }
  } catch (error) {
    // Remove loading indicator if it exists
    const indicator = document.getElementById('pdfLoadingIndicator');
    if (indicator) document.body.removeChild(indicator);
    
    console.error('âŒ EXCEPTION - PDF Generation Error');
    console.error('âŒ Error Type:', error.name);
    console.error('âŒ Error Message:', error.message);
    console.error('âŒ Error Stack:', error.stack);
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    alert(`âŒ Error generating PDF:\n\n${error.message}\n\nCheck console for full details.`);
  }
}











// REPLACE WITH (better error handling and logging):
async function resendEmail(advanceId) {
  if (!confirm('Resend decision email to employee?')) return;
  
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ“§ EMAIL RESEND STARTED');
  console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
  console.log('ðŸ”‘ Advance ID:', advanceId);
  
  // Show loading indicator
  const loadingDiv = document.createElement('div');
  loadingDiv.id = 'emailLoadingIndicator';
  loadingDiv.style.cssText = `
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    padding: 30px 50px;
    border-radius: 12px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
    z-index: 10000;
    text-align: center;
  `;
  loadingDiv.innerHTML = `
    <i class="fas fa-spinner fa-spin" style="font-size: 48px; color: #3498db; margin-bottom: 15px;"></i>
    <h3 style="margin: 10px 0; color: #2c3e50;">Sending Email...</h3>
    <p style="color: #7f8c8d; margin: 5px 0;">Please wait</p>
  `;
  document.body.appendChild(loadingDiv);
  
  try {
    const url = 'https://kpldzwlftkvjjntgsqxx.supabase.co/functions/v1/generate-advance-pdf';
    const payload = { 
      advanceId: advanceId,
      resendOnly: true 
    };
    
    console.log('ðŸ“¤ Request URL:', url);
    console.log('ðŸ“¤ Request Payload:', JSON.stringify(payload, null, 2));
    
    const startTime = Date.now();
    
    const response = await fetch(url, {
      method: 'POST',
      headers: { 
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
        'apikey': SUPABASE_ANON_KEY
      },
      body: JSON.stringify(payload)
    });

    const endTime = Date.now();
    const duration = endTime - startTime;

    console.log('ðŸ“¥ Response received in:', duration + 'ms');
    console.log('ðŸ“¥ Response status:', response.status);

    // Remove loading indicator
    document.body.removeChild(loadingDiv);

    if (response.ok) {
      const result = await response.json();
      console.log('âœ… SUCCESS - Email Sent');
      console.log('âœ… Result:', JSON.stringify(result, null, 2));
      console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      // Show success message
      const successDiv = document.createElement('div');
      successDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: white;
        padding: 40px;
        border-radius: 12px;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        z-index: 10000;
        text-align: center;
        max-width: 500px;
      `;
      successDiv.innerHTML = `
        <i class="fas fa-check-circle" style="font-size: 60px; color: #28a745; margin-bottom: 20px;"></i>
        <h2 style="color: #2c3e50; margin-bottom: 15px;">Email Sent Successfully!</h2>
        <p style="color: #7f8c8d; margin-bottom: 20px;">The decision email has been sent to the employee and admin@jengchirestaurant.com.</p>
        <button onclick="this.parentElement.remove()" style="
          padding: 12px 30px;
          background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
          color: white;
          border: none;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          cursor: pointer;
          margin-top: 15px;
        ">Close</button>
      `;
      document.body.appendChild(successDiv);
      
    } else {
      const errorText = await response.text();
      console.error('âŒ FAILED - Email Send Error');
      console.error('âŒ Status:', response.status);
      console.error('âŒ Error Response:', errorText);
      console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
      
      alert(`âŒ Failed to send email\n\nStatus: ${response.status}\nError: ${errorText}\n\nCheck console for full details.`);
    }
  } catch (error) {
    // Remove loading indicator if it exists
    const indicator = document.getElementById('emailLoadingIndicator');
    if (indicator) document.body.removeChild(indicator);
    
    console.error('âŒ EXCEPTION - Email Send Error');
    console.error('âŒ Error Type:', error.name);
    console.error('âŒ Error Message:', error.message);
    console.error('âŒ Error Stack:', error.stack);
    console.error('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    alert(`âŒ Error sending email:\n\n${error.message}\n\nCheck console for full details.`);
  }
}










  </script>
</body>
</html>