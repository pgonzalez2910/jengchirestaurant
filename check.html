<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi – Check & Invoice Tracker</title>

  <!-- UI libs -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- PDF libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.8.3/dist/jspdf.plugin.autotable.min.js"></script>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
  <style>
    :root{ --primary:#2563eb; --ink:#0f172a; --muted:#6b7280; --danger:#ef4444; }
    body{ font-family:'Inter',system-ui,Segoe UI,Roboto,Helvetica,Arial; background:#f3f4f6; }
    .tab-btn{ padding:.75rem 1.25rem; border-bottom:3px solid transparent; font-weight:700; }
    .tab-btn.active{ color:var(--primary); border-bottom-color:var(--primary); }
    .row-card{ background:#fff; border:1px solid #e5e7eb; border-radius:.75rem; padding:1rem; }
    .btn{ font-weight:700; border-radius:.5rem; padding:.5rem .9rem; }
    .btn-primary{ background:var(--primary); color:#fff; }
    .btn-outline{ background:#fff; border:1px solid #cbd5e1; }
    .btn-danger{ background:var(--danger); color:#fff; }
    .muted{ color:var(--muted); }
    .badge{ font-size:.7rem; border:1px solid #e5e7eb; padding:.1rem .4rem; border-radius:.375rem; }
  </style>
</head>
<body class="p-8">

  <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-xl p-6">
    <header class="text-center mb-8">
      <img id="company-logo" alt="Jeng Chi Logo" class="mx-auto h-20 mb-3">
      <h1 class="text-3xl font-extrabold text-blue-600">Inventory Management System</h1>
      <h2 class="text-lg font-semibold text-slate-800">Check & Invoice Tracker</h2>
    </header>

    <div class="flex justify-center gap-6 border-b mb-6 overflow-x-auto">
      <button id="tab-manage" class="tab-btn active">Invoice Management</button>
      <button id="tab-view" class="tab-btn">View Invoices</button>
      <button id="tab-edit" class="tab-btn">Edit Check</button>
      <button id="tab-report" class="tab-btn">Generate Report</button>
    </div>

    <!-- ========== INVOICE MANAGEMENT ========== -->
    <section id="panel-manage">
      <div class="row-card mb-4">
        <h3 class="text-lg font-bold mb-2">Add New Vendor</h3>
        <div class="flex flex-col sm:flex-row gap-3">
          <input id="newVendorName" class="flex-1 border rounded-md p-2" placeholder="Enter New Vendor Name"/>
          <button id="btnAddVendor" class="btn btn-primary">Add Vendor</button>
        </div>
      </div>

      <div class="row-card">
        <h3 class="text-lg font-bold mb-3">Enter New Invoice Details</h3>

        <div class="row-card mb-4">
          <h4 class="font-semibold mb-2">Create Check</h4>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="text-sm font-medium">Check Number</label>
              <input id="newCheckNumber" class="w-full border rounded-md p-2" placeholder="e.g. 10123"/>
            </div>
            <div>
              <label class="text-sm font-medium">Check Date</label>
              <input type="date" id="newCheckDate" class="w-full border rounded-md p-2"/>
            </div>
            <div>
              <label class="text-sm font-medium">Check Amount ($)</label>
              <input type="number" step="0.01" id="newCheckAmount" class="w-full border rounded-md p-2"/>
            </div>
            <div>
              <label class="text-sm font-medium">Notes</label>
              <input id="newCheckNotes" class="w-full border rounded-md p-2" placeholder="Memo / notes (e.g. VOID)"/>
            </div>
          </div>
          <div class="flex items-center gap-2 mt-2">
            <input type="checkbox" id="chkVoid" class="h-4 w-4">
            <label for="chkVoid" class="text-sm">This is a <b>void / empty</b> check (no invoices)</label>
          </div>
          <p class="muted text-sm mt-1">Enter number and optional date/amount/notes. If “void/empty” is checked you can save the check without invoices.</p>
        </div>

        <div class="row-card mb-3">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">Invoices to Add</h4>
            <div class="flex gap-2">
              <button id="btnAddRow" class="btn btn-outline">+ Add another invoice</button>
              <button id="btnClearRows" class="btn">Clear</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-sm font-medium">Default Vendor for new rows</label>
              <select id="defaultVendor" class="w-full border rounded-md p-2"></select>
            </div>
            <p class="muted self-end">Each row can still choose a different vendor.</p>
          </div>

          <div id="invoiceRows" class="space-y-3"></div>
          <p class="muted text-sm mt-2">Add as many rows as needed; all will attach to the check you create above.</p>
        </div>

        <div class="flex flex-col md:flex-row gap-3 justify-center">
          <button id="btnSaveInvoices" class="btn btn-primary px-8">Save Invoices</button>
          <button id="btnSaveVoid" class="btn btn-outline px-8">Save Void / Empty Check</button>
        </div>
      </div>
    </section>

    <!-- ========== VIEW INVOICES ========== -->
    <section id="panel-view" class="hidden">
      <h3 class="text-lg font-bold mb-3">Invoice History</h3>
      <div class="flex flex-wrap gap-4 mb-4 items-end">
        <div>
          <label class="text-sm font-medium">Filter by Vendor</label>
          <select id="invoiceVendorFilter" class="p-2 border rounded-md min-w-[200px]">
            <option value="">— All Vendors —</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Filter by Status</label>
          <select id="invoiceStatusFilter" class="p-2 border rounded-md min-w-[140px]">
            <option>All</option><option>Paid</option><option>Unpaid</option><option>Voided</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Filter by Month</label>
          <select id="invoiceMonthFilter" class="p-2 border rounded-md min-w-[180px]">
            <option value="">— All Months —</option>
          </select>
        </div>
        <div>
          <label class="text-sm font-medium">Filter by Year</label>
          <select id="invoiceYearFilter" class="p-2 border rounded-md min-w-[120px] text-center"></select>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100 text-xs">
            <tr>
              <th class="py-2 px-3 text-left font-semibold">Invoice #</th>
              <th class="py-2 px-3 text-left font-semibold">Vendor</th>
              <th class="py-2 px-3 text-left font-semibold">Date</th>
              <th class="py-2 px-3 text-left font-semibold">Amount</th>
              <th class="py-2 px-3 text-left font-semibold">Check #</th>
              <th class="py-2 px-3 text-left font-semibold">Status</th>
            </tr>
          </thead>
          <tbody id="dgvInvoices" class="bg-white divide-y divide-gray-100">
            <tr><td colspan="6" class="text-center py-4 text-gray-500">No invoices to display.</td></tr>
          </tbody>
        </table>
      </div>
    </section>

    <!-- ========== EDIT CHECK ========== -->
    <section id="panel-edit" class="hidden">
      <h3 class="text-lg font-bold mb-3">Edit Check</h3>
      <div class="row-card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="text-sm font-medium">Search by Check Number</label>
            <input id="searchCheckNumber" class="w-full border rounded-md p-2" placeholder="e.g. 10123"/>
          </div>
          <button id="btnFindCheck" class="btn btn-primary w-full md:mt-6">Find Check</button>
          <p class="muted md:mt-6">Tip: From “View Invoices”, click “Edit” next to a check.</p>
        </div>
      </div>

      <div id="checkEditor" class="hidden">
        <div class="row-card mb-3">
          <div class="flex items-center justify-between mb-2">
            <h4 class="font-semibold">Check Details</h4>
            <span id="voidBadge" class="badge hidden text-red-700 bg-red-50 border-red-200">VOIDED</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-5 gap-4">
            <div>
              <label class="text-sm font-medium">Check Number</label>
              <input id="editCheckNumber" class="w-full border rounded-md p-2"/>
            </div>
            <div>
              <label class="text-sm font-medium">Check Date</label>
              <input type="date" id="editCheckDate" class="w-full border rounded-md p-2"/>
            </div>
            <div>
              <label class="text-sm font-medium">Check Amount ($)</label>
              <input type="number" step="0.01" id="editCheckAmount" class="w-full border rounded-md p-2"/>
            </div>
            <div>
              <label class="text-sm font-medium">Notes</label>
              <input id="editCheckNotes" class="w-full border rounded-md p-2"/>
            </div>
            <div class="flex items-end gap-2">
              <button id="btnSaveCheckEdits" class="btn btn-primary w-full">Save Check</button>
              <button id="btnNewProcedure" class="btn btn-outline w-full">Start New</button>
            </div>
          </div>
        </div>

        <!-- Void / Unvoid controls -->
        <div class="row-card mb-3 border-red-200">
          <div class="flex items-center justify-between">
            <h4 class="font-semibold text-red-700">Void this Check</h4>
          </div>
          <p class="text-sm text-red-700 mt-1">Voiding sets this check as <b>VOID</b> and marks all linked invoices as <b>Voided</b>, so they are excluded from totals and reports.</p>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mt-3">
            <div class="md:col-span-2">
              <label class="text-sm font-medium">Reason (optional)</label>
              <input id="editVoidReason" class="w-full border rounded-md p-2" placeholder="e.g. Misprint, reissued as #12345"/>
            </div>
            <div class="flex gap-2 items-end">
              <button id="btnVoidCheck" class="btn btn-danger w-full">Mark as VOID</button>
              <button id="btnUnvoidCheck" class="btn btn-outline w-full">Unvoid</button>
            </div>
          </div>
        </div>

        <div class="row-card">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold">Invoices linked to this check</h4>
            <div class="flex gap-2">
              <button id="btnAddInvoiceRowEdit" class="btn btn-outline">+ Add invoice</button>
              <button id="btnSaveInvoicesEdit" class="btn btn-primary">Save new invoices</button>
            </div>
          </div>
          <div id="linkedInvoices" class="space-y-2"></div>
          <div id="newInvoicesForThisCheck" class="space-y-3 mt-3"></div>
        </div>
      </div>
    </section>

    <!-- ========== REPORT ========== -->
    <section id="panel-report" class="hidden">
      <h3 class="text-lg font-bold mb-4">Generate Monthly Checks Report</h3>

      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-5">
        <div>
          <label class="text-sm font-medium">Whole Month</label>
          <select id="quickMonth" class="w-full p-2 border rounded-md">
            <option value="custom">— Custom Range —</option>
          </select>
          <p class="muted text-sm mt-1">Pick a whole month (Aug 2025 → Dec 2030). Choose Custom for exact dates.</p>
        </div>
        <div>
          <label class="text-sm font-medium">Start Date</label>
          <input type="date" id="reportStartDate" class="w-full p-2 border rounded-md"/>
        </div>
        <div>
          <label class="text-sm font-medium">End Date</label>
          <input type="date" id="reportEndDate" class="w-full p-2 border rounded-md"/>
        </div>
      </div>

      <div class="text-center mb-4">
        <button id="btnGenerateReport" class="btn btn-primary px-8">Download & Preview Report</button>
      </div>

      <!-- Live preview (shows right after generation) -->
      <div class="row-card">
        <h4 class="font-semibold mb-2">Report Preview</h4>
        <iframe id="reportPreview" class="w-full h-[800px] border rounded-lg" title="Report Preview"></iframe>
      </div>
    </section>
  </div>

  <!-- Simple modal -->
  <div id="modal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
    <div class="bg-white rounded-lg p-5 w-[92%] max-w-md">
      <h3 id="mTitle" class="text-lg font-bold mb-1"></h3>
      <p id="mMsg" class="text-sm mb-3"></p>
      <div class="text-right">
        <button id="mOk" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
    /* ========================== UTILITIES ========================== */
    window.jsPDF = window.jspdf.jsPDF;

    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const fmtMoney = n => {
      const v = Number(n || 0);
      return `$ ${v.toLocaleString('en-US',{minimumFractionDigits:2, maximumFractionDigits:2})}`;
    };

    const ymd = (y,m0,d)=>`${y}-${String(m0+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    const firstOfMonth=(y,m0)=>ymd(y,m0,1);
    const lastOfMonth=(y,m0)=>ymd(y,m0,new Date(y,m0+1,0).getDate());
    const monthName = (y,m0)=> new Date(y,m0,1).toLocaleString('en-US',{month:'long'});
    const mmddyyyyFromYMD = s => {
      if (!s) return "";
      const [y,m,d]=s.split('-'); return `${m}/${d}/${y}`;
    };

    function showModal(title, msg){
      document.getElementById('mTitle').textContent = title;
      document.getElementById('mMsg').textContent = msg;
      const md = document.getElementById('modal');
      md.classList.remove('hidden'); md.classList.add('flex');
    }
    function hideModal(){
      const md = document.getElementById('modal');
      md.classList.add('hidden'); md.classList.remove('flex');
    }

    // vendor logos
    const companyLogoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
    const vendorLogos = {
      "City of Richardson":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/richardson.jpg",
      "Eiland - Coffe":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/eliand.jpg",
      "Taiwanese Student Association":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/taiwanese.jpg",
      "Bakemark":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg",
      "Delta Office Products":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg",
      "Formosa Foods":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg",
      "North Food Group":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg",
      "Pacific Plus":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg",
      "Supermarket":"https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg",
    };
    const logoData = {};

    const imgFormatFromMime = (mime) =>
      mime?.includes('png')?'PNG':(mime?.includes('jpeg')||mime?.includes('jpg'))?'JPEG':'JPEG';

    async function toDataUrl(url){
      try{
        const res = await fetch(url); const blob = await res.blob();
        const fmt = imgFormatFromMime(blob.type);
        const p = new Promise(r=>{
          const fr = new FileReader();
          fr.onloadend=()=>r({data:fr.result, fmt});
          fr.readAsDataURL(blob);
        });
        return await p;
      }catch(e){ console.warn('img preload fail', url, e); return {data:null, fmt:'JPEG'}; }
    }

    /* ========================== UI SETUP ========================== */
    function switchTab(id){
      const tabs = [
        ['tab-manage','panel-manage'],
        ['tab-view','panel-view'],
        ['tab-edit','panel-edit'],
        ['tab-report','panel-report'],
      ];
      for(const [btn,panel] of tabs){
        document.getElementById(btn).classList.toggle('active', btn===id);
        document.getElementById(panel).classList.toggle('hidden', btn!==id);
      }
    }

    function optionHtmlFromSelect(sel){
      return Array.from(sel.options).map(o=>`<option value="${o.value}">${o.textContent}</option>`).join('');
    }

    function makeRow(optionsHtml, preset={}){
      const wrap = document.createElement('div');
      wrap.className = 'row-card';
      wrap.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-4 gap-3">
          <div>
            <label class="text-sm font-medium">Vendor</label>
            <select class="vendor w-full border rounded-md p-2">${optionsHtml}</select>
          </div>
          <div>
            <label class="text-sm font-medium">Invoice Date</label>
            <input type="date" class="invdate w-full border rounded-md p-2"/>
          </div>
          <div>
            <label class="text-sm font-medium">Invoice Number</label>
            <input class="invnum w-full border rounded-md p-2" placeholder="INV-"/>
          </div>
          <div>
            <label class="text-sm font-medium">Invoice Total ($)</label>
            <input type="number" step="0.01" class="invtotal w-full border rounded-md p-2"/>
          </div>
        </div>
        <div class="text-right mt-2">
          <button class="btn" data-remove>Remove</button>
        </div>`;
      if(preset.vendor) wrap.querySelector('.vendor').value = preset.vendor;
      if(preset.date) wrap.querySelector('.invdate').value = preset.date;
      if(preset.number) wrap.querySelector('.invnum').value = preset.number;
      if(preset.total!=null) wrap.querySelector('.invtotal').value = preset.total;
      wrap.querySelector('[data-remove]').onclick = ()=>wrap.remove();
      return wrap;
    }

    function syncFirstRowVendor(){
      const first = document.querySelector('#invoiceRows .vendor');
      if(first) first.value = defaultVendor.value || '';
    }

    /* ========================== SUPABASE LOADERS ========================== */
    async function loadVendors(){
      const { data } = await supabase.from("public_vendors").select("vendor_name").order("vendor_name");
      defaultVendor.innerHTML = "";
      invoiceVendorFilter.innerHTML = '<option value="">— All Vendors —</option>';
      if(data){
        data.forEach(v=>{
          if(v.vendor_name!=="AutoChlor"){
            defaultVendor.add(new Option(v.vendor_name,v.vendor_name));
            invoiceVendorFilter.add(new Option(v.vendor_name,v.vendor_name));
          }
        });
      }
    }

    async function addVendor(){
      const name = newVendorName.value.trim();
      if(!name) return showModal('Missing name','Please enter a vendor name.');
      const { error } = await supabase.from("public_vendors").insert([{vendor_name:name}]);
      if(error) return showModal('Error','Failed to add vendor.');
      showModal('Added',`${name} created.`);
      newVendorName.value = '';
      await loadVendors();
      document.querySelectorAll('.vendor').forEach(sel=>{
        const cur = sel.value; sel.innerHTML = optionHtmlFromSelect(defaultVendor); if(cur) sel.value=cur;
      });
      syncFirstRowVendor();
    }

    async function upsertCheckFromForm(){
      const num = (newCheckNumber.value||'').trim();
      if(!num){ showModal('Validation','Enter a check number.'); throw new Error('no num'); }
      const dateStr = newCheckDate.value || null;
      const amount = newCheckAmount.value? Number(newCheckAmount.value): 0;
      const isVoid = chkVoid.checked;
      const memoRaw = (newCheckNotes.value||'').trim();
      const notes = isVoid ? (memoRaw? `VOID - ${memoRaw}` : 'VOID') : (memoRaw || null);

      const { data: existing } = await supabase.from('public_checks').select('id').eq('check_number',num).maybeSingle();
      if(existing?.id){
        await supabase.from('public_checks').update({check_date:dateStr,check_amount:amount,notes}).eq('id',existing.id);
        return {id:existing.id, amount};
      }
      const { data: inserted, error } = await supabase
        .from('public_checks')
        .insert([{check_number:num, check_date:dateStr, check_amount:amount, notes}])
        .select('id, check_amount').single();
      if(error) throw error;
      return {id:inserted.id, amount: inserted.check_amount ?? amount};
    }

    function addInvoiceRowInManagement() {
      const html = optionHtmlFromSelect(defaultVendor);
      const vendorDefault = defaultVendor.value || '';
      const row = makeRow(html, { vendor: vendorDefault });
      invoiceRows.appendChild(row);
    }

    // Save multiple invoices
    async function saveInvoices() {
      let checkRef;
      try { checkRef = await upsertCheckFromForm(); } catch { return; }

      const rows = [...invoiceRows.querySelectorAll('.row-card')];
      if (rows.length === 0 && !chkVoid.checked) {
        return showModal('Nothing to save','Add at least one invoice row or mark as Void/Empty.');
      }
      if (rows.length === 0 && chkVoid.checked) {
        showModal('Success','Void/empty check saved.');
        resetForm();
        await loadInvoices();
        return;
      }

      const payload = [];
      let invoiceSum = 0;
      for (const r of rows) {
        const vendor = r.querySelector('.vendor').value;
        const invdate = r.querySelector('.invdate').value;
        const invnum = r.querySelector('.invnum').value.trim();
        const invtotal = parseFloat(r.querySelector('.invtotal').value);
        if (!vendor || !invdate || !invnum || isNaN(invtotal)) {
          return showModal('Validation Error','Each row needs Vendor, Date, Number, and Total.');
        }
        invoiceSum += invtotal;
        payload.push({ VendorName: vendor, InvoiceDate: invdate, InvoiceNumber: invnum, InvoiceTotal: invtotal, Status: "Paid", check_id: checkRef.id });
      }

      const diff = Math.abs((checkRef.amount || 0) - invoiceSum);
      if (diff > 0.01) {
        return showModal('Amount mismatch',
          `The sum of invoices ($${invoiceSum.toFixed(2)}) does not match the check amount ($${(checkRef.amount||0).toFixed(2)}).`);
      }

      const { error } = await supabase.from("public_invoices").insert(payload);
      if (error) { console.error(error); return showModal('Error','Failed to save invoices.'); }

      showModal('Success', `${payload.length} invoice(s) saved. Total matches the check amount.`);
      resetForm();
      await loadInvoices();
    }

    async function saveVoidOnly() {
      try { await upsertCheckFromForm(); } catch { return; }
      showModal('Success','Void/empty check saved.');
      resetForm();
    }

    function resetForm(){
      newCheckNumber.value=''; newCheckDate.value=''; newCheckAmount.value=''; newCheckNotes.value=''; chkVoid.checked=false;
      invoiceRows.innerHTML='';
      addInvoiceRowInManagement();
      syncFirstRowVendor();
    }

    // View Invoices
    async function loadInvoices(){
      const v = invoiceVendorFilter.value;
      const st = invoiceStatusFilter.value;
      const m = invoiceMonthFilter.value;
      const y = invoiceYearFilter.value;

      dgvInvoices.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading…</td></tr>`;

      let q = supabase.from("public_invoices").select(`*, check:public_checks!public_invoices_check_fk ( id, check_number, check_date, check_amount, notes )`);
      if(v) q = q.eq('VendorName',v);
      if(st && st!=='All') q = q.eq('Status',st);
      if(m && y){
        q = q.gte('InvoiceDate', firstOfMonth(+y, +m-1)).lte('InvoiceDate', lastOfMonth(+y, +m-1));
      }else if(y){
        q = q.gte('InvoiceDate', `${y}-01-01`).lte('InvoiceDate', `${y}-12-31`);
      }

      const { data, error } = await q.order('InvoiceDate',{ascending:false});
      if(error){ dgvInvoices.innerHTML=`<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading.</td></tr>`; return; }
      if(!data?.length){ dgvInvoices.innerHTML=`<tr><td colspan="6" class="text-center py-4 text-gray-500">No invoices found.</td></tr>`; return; }

      dgvInvoices.innerHTML='';
      for(const inv of data){
        const chk = inv.check||{};
        const isVoidedCheck = /^VOID/i.test(chk?.notes||'');
        const tr = document.createElement('tr');
        tr.className = (inv.Status==='Voided' || isVoidedCheck) ? 'bg-red-50' : '';
        tr.innerHTML = `
          <td class="py-2 px-3">${inv.InvoiceNumber}</td>
          <td class="py-2 px-3">${inv.VendorName}</td>
          <td class="py-2 px-3">${mmddyyyyFromYMD(inv.InvoiceDate)}</td>
          <td class="py-2 px-3">${fmtMoney(inv.InvoiceTotal)}</td>
          <td class="py-2 px-3">
            <div class="flex items-center gap-2">
              <span>${chk.check_number||'N/A'}</span>
              ${chk.id?`<button class="text-blue-600 underline text-xs" data-edit="${chk.id}">Edit</button>`:''}
              ${isVoidedCheck?'<span class="badge text-red-700 bg-red-50 border-red-200">VOID</span>':''}
            </div>
          </td>
          <td class="py-2 px-3">${inv.Status||'Paid'}</td>`;
        dgvInvoices.appendChild(tr);
      }
      dgvInvoices.querySelectorAll('[data-edit]').forEach(btn=>{
        btn.onclick=()=>{ switchTab('tab-edit'); loadCheckById(btn.getAttribute('data-edit')); };
      });
    }

    /* ========================== EDIT CHECK ========================== */
    let currentEditCheckId = null;
    function notesIndicateVoid(notes){ return /^VOID/i.test(notes||''); }

    async function loadCheckByNumber(num){
      const { data, error } = await supabase.from('public_checks').select('*').eq('check_number',num).maybeSingle();
      if(error || !data) return showModal('Not found','No check with that number.');
      return loadCheck(data);
    }
    async function loadCheckById(id){
      const { data, error } = await supabase.from('public_checks').select('*').eq('id',id).single();
      if(error || !data) return showModal('Error','Could not load check.');
      return loadCheck(data);
    }

    function clearEditCheckForm(){
      currentEditCheckId = null;
      editCheckNumber.value = '';
      editCheckDate.value = '';
      editCheckAmount.value = '';
      editCheckNotes.value = '';
      document.getElementById('editVoidReason').value = '';
      document.getElementById('voidBadge').classList.add('hidden');
      linkedInvoices.innerHTML = '';
      newInvoicesForThisCheck.innerHTML = '';
      checkEditor.classList.add('hidden');
      searchCheckNumber.value = '';
    }

    async function loadCheck(row){
      currentEditCheckId = row.id;
      checkEditor.classList.remove('hidden');
      editCheckNumber.value = row.check_number||'';
      editCheckDate.value = row.check_date||'';
      editCheckAmount.value = typeof row.check_amount==='number'? row.check_amount : '';
      editCheckNotes.value = row.notes || '';
      document.getElementById('voidBadge').classList.toggle('hidden', !notesIndicateVoid(row.notes));
      renderLinkedInvoices();
    }

    async function renderLinkedInvoices(){
      linkedInvoices.innerHTML = '<div class="muted">Loading…</div>';
      const { data, error } = await supabase.from('public_invoices')
        .select('VendorName, InvoiceDate, InvoiceNumber, InvoiceTotal, Status')
        .eq('check_id', currentEditCheckId).order('InvoiceDate',{ascending:true});
      if(error){ linkedInvoices.innerHTML='<div class="text-red-500">Error loading.</div>'; return; }
      if(!data?.length){ linkedInvoices.innerHTML='<div class="muted">No invoices linked.</div>'; return; }
      linkedInvoices.innerHTML='';
      data.forEach(inv=>{
        const row = document.createElement('div'); row.className='row-card';
        const muted = inv.Status==='Voided';
        row.innerHTML = `
          <div class="grid grid-cols-5 gap-3 text-sm ${muted?'text-red-700':''}">
            <div><b>${inv.VendorName}</b></div>
            <div>${mmddyyyyFromYMD(inv.InvoiceDate)}</div>
            <div>${inv.InvoiceNumber}</div>
            <div>${fmtMoney(inv.InvoiceTotal)}</div>
            <div>${inv.Status||'Paid'}</div>
          </div>`;
        linkedInvoices.appendChild(row);
      });
    }

    async function saveCheckEdits(){
      if(!currentEditCheckId) return;
      const payload = {
        check_number:(editCheckNumber.value||'').trim(),
        check_date: editCheckDate.value||null,
        check_amount: editCheckAmount.value? Number(editCheckAmount.value):null,
        notes: editCheckNotes.value||null
      };
      if(!payload.check_number) return showModal('Validation','Check number is required.');
      const { error } = await supabase.from('public_checks').update(payload).eq('id',currentEditCheckId);
      if(error) return showModal('Error','Failed to save check.');
      showModal('Saved','Check updated. Starting a new procedure.');
      await loadInvoices();
      clearEditCheckForm();
    }

    function addInvoiceRowEdit(){
      const row = makeRow(optionHtmlFromSelect(defaultVendor),{});
      newInvoicesForThisCheck.appendChild(row);
    }

    async function saveInvoicesEdit(){
      if(!currentEditCheckId) return showModal('No check','Load a check first.');
      const rows = [...document.querySelectorAll('#newInvoicesForThisCheck .row-card')];
      if(!rows.length) return showModal('Nothing to save','Add at least one invoice row.');
      const batch=[];
      for(const r of rows){
        const vendor=r.querySelector('.vendor').value;
        const dt=r.querySelector('.invdate').value;
        const no=r.querySelector('.invnum').value.trim();
        const tot=parseFloat(r.querySelector('.invtotal').value);
        if(!vendor || !dt || !no || isNaN(tot)) return showModal('Validation','Every row needs vendor, date, number and total.');
        batch.push({VendorName:vendor, InvoiceDate:dt, InvoiceNumber:no, InvoiceTotal:tot, Status:'Paid', check_id:currentEditCheckId});
      }
      const { error } = await supabase.from('public_invoices').insert(batch);
      if(error) return showModal('Error','Failed to save invoices.');
      showModal('Saved', `${batch.length} invoice(s) added. Starting a new procedure.`);
      await loadInvoices();
      clearEditCheckForm();
    }

    // Void / Unvoid operations
    async function setCheckVoidState(shouldVoid){
      if(!currentEditCheckId) return showModal('No check','Load a check first.');

      if(shouldVoid){
        const reason = (document.getElementById('editVoidReason').value||'').trim();
        const existingNotes = (editCheckNotes.value||'').trim();
        const newNotes = existingNotes && !/^VOID/i.test(existingNotes)
          ? `VOID${reason?` - ${reason}`:''} — ${existingNotes}`
          : (existingNotes || `VOID${reason?` - ${reason}`:''}`);

        const { error: e1 } = await supabase.from('public_checks')
          .update({ notes: newNotes }).eq('id', currentEditCheckId);
        if(e1) return showModal('Error','Could not mark check as VOID.');

        const { error: e2 } = await supabase
          .from('public_invoices')
          .update({ Status:'Voided' })
          .eq('check_id', currentEditCheckId);
        if(e2) return showModal('Partial','Check voided, but failed to update invoices.');

        showModal('Voided','Check marked as VOID and invoices marked as Voided. Starting a new procedure.');
      } else {
        const original = (editCheckNotes.value||'');
        const cleaned = original.replace(/^\s*VOID\b\s*(?:[-–—]\s*)?/i,'').trim();
        const { error: e1 } = await supabase.from('public_checks').update({ notes: cleaned || null }).eq('id', currentEditCheckId);
        if(e1) return showModal('Error','Could not unvoid the check.');

        const { error: e2 } = await supabase
          .from('public_invoices')
          .update({ Status:'Paid' })
          .eq('check_id', currentEditCheckId)
          .eq('Status','Voided');
        if(e2) return showModal('Partial','Check unvoided, but failed to restore invoice statuses.');

        showModal('Unvoided','Check unvoided and invoices set back to Paid. Starting a new procedure.');
      }

      await loadInvoices();
      clearEditCheckForm();
    }

    /* ========================== REPORT (LETTER, EXECUTIVE) ========================== */
    function drawBigNumberFit(doc, x, yBase, width, text) {
      const sizes = [22, 20, 18, 16];
      for (const s of sizes) {
        doc.setFont('helvetica','bold');
        doc.setFontSize(s);
        const w = doc.getTextWidth(text);
        if (w <= width - 28) {
          doc.text(text, x + 14, yBase);
          return;
        }
      }
      doc.setFontSize(16);
      doc.text(text, x + 14, yBase);
    }

    async function generateReport(){
      const startDate = reportStartDate.value;
      const endDate = reportEndDate.value;
      if(!startDate || !endDate) return showModal('Select dates','Please choose a date range.');

      const { data: checks } = await supabase.from('public_checks')
        .select('id,check_number,check_date,check_amount,notes')
        .gte('check_date',startDate).lte('check_date',endDate).order('check_date',{ascending:true});
      if(!checks?.length) return showModal('No Data','No checks in this range.');

      const { data: invoices } = await supabase.from('public_invoices')
        .select('VendorName,InvoiceDate,InvoiceNumber,InvoiceTotal,Status,check_id')
        .in('check_id', checks.map(c=>c.id));

      const checksById = new Map(checks.map(c=>[c.id,c]));
      const voidedSet = new Set(checks.filter(c=>/^VOID/i.test(c.notes||'')).map(c=>c.id));

      const vendorTotals = new Map();
      const invoicedCheckIds = new Set();
      (invoices||[]).forEach(inv=>{
        if(voidedSet.has(inv.check_id)) return; // exclude invoices on voided checks
        if((inv.Status||'')==='Voided') return; // exclude explicitly voided invoices
        invoicedCheckIds.add(inv.check_id);
        const v = inv.VendorName || 'Unknown Vendor';
        vendorTotals.set(v,(vendorTotals.get(v)||0)+ (Number(inv.InvoiceTotal)||0));
      });

      const voidChecks = checks.filter(c=>voidedSet.has(c.id));
      const grandTotal = [...vendorTotals.values()].reduce((a,b)=>a+b,0);

      // PDF
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({unit:'pt', format:'letter'}); // 612 x 792 pt
      const pageW = doc.internal.pageSize.getWidth();
      const pageH = doc.internal.pageSize.getHeight();
      const M = 42; let y = M;

      /* ---------- COVER ---------- */
      if(logoData.company?.data){
        doc.addImage(logoData.company.data, logoData.company.fmt, pageW/2-60, y, 120, 90);
        y += 110;
      }
      doc.setFont('helvetica','bold'); doc.setFontSize(22); doc.setTextColor(15,23,42);
      doc.text('Check & Invoices Report', pageW/2, y, {align:'center'}); y += 18;
      doc.setFont('helvetica','normal'); doc.setFontSize(12);
      doc.text(`Period: ${mmddyyyyFromYMD(startDate)} to ${mmddyyyyFromYMD(endDate)}`, pageW/2, y, {align:'center'}); y += 22;

      doc.setDrawColor(37,99,235); doc.setLineWidth(1.4);
      doc.line(M, y, pageW-M, y); y += 10;

      /* ---------- SUMMARY CARDS ---------- */
      const cardW = (pageW - M*2 - 24) / 2;
      const cardH = 110; const cardY = y;
      function card(x, title, big, sub){
        doc.setDrawColor(74,110,245); doc.setLineWidth(1.2);
        doc.roundedRect(x, cardY, cardW, cardH, 8,8);
        doc.setTextColor(62,91,197); doc.setFont('helvetica','bold'); doc.setFontSize(12);
        doc.text(title, x+14, cardY+22);
        doc.setTextColor(17,24,39);
        drawBigNumberFit(doc, x, cardY + 56, cardW, String(big));
        if(sub){ doc.setFont('helvetica','normal'); doc.setTextColor(100,116,139); doc.setFontSize(11); doc.text(String(sub), x+14, cardY+80); }
      }
      card(M, 'Grand Total Paid', fmtMoney(grandTotal), '');
      card(M + cardW + 24, 'Total Vendors', String(vendorTotals.size), `Total Checks: ${checks.length} (${voidChecks.length} void)`);
      y = cardY + cardH + 28;

      /* ---------- FREQUENTLY USED VENDORS (selected) ---------- */
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(15,23,42);
      doc.text('Frequently Used Vendors (selected)', M, y); y += 24;

      const WANTED = ['Formosa Foods','North Food Group','Pacific Plus','Delta Office Products','Supermarket'];
      let chartRows = WANTED.map(v => [v, vendorTotals.get(v)||0]).filter(([,t])=>t>0);
      chartRows.sort((a,b)=>a[1]-b[1]);

      if (!chartRows.length) {
        doc.setFont('helvetica','normal'); doc.setTextColor(100,116,139); doc.setFontSize(12);
        doc.text('No matching vendor spend found for the selected period.', M, y);
        y += 16;
      } else {
        const maxVal = Math.max(1, ...chartRows.map(([,t])=>t));
        const barMaxW = pageW - M*2 - 160;
        const rowH = 52; // a bit taller for a glossy name label feel

        for (const [name, total] of chartRows) {
          if (y + rowH + 10 > pageH - M) { doc.addPage(); y = M; }

          // logo with rounded border (simulate glossy tile)
          const L = vendorLogos[name] && logoData[name]?.data ? logoData[name] : null;
          if (L) {
            doc.setDrawColor(220,230,255); doc.setLineWidth(1);
            doc.roundedRect(M, y - 18, 60, 38, 6, 6); // border tile
            doc.addImage(L.data, L.fmt, M+2, y - 16, 56, 34);
          }

          const bw = Math.max(6, (total / maxVal) * barMaxW);
          const barY = y - 6; const barH = 18;

          // very light blue lane
          doc.setFillColor(232, 240, 255); // lane
          doc.roundedRect(M + 70, barY, barMaxW, barH, 9, 9, 'F');
          // value bar (slightly darker but still light)
          doc.setFillColor(60, 115, 255);
          doc.roundedRect(M + 70, barY, bw, barH, 9, 9, 'F');

          // glossy-ish vendor label (bold)
          doc.setTextColor(15,23,42);
          doc.setFont('helvetica','bold'); doc.setFontSize(12);
          doc.text(name, M + 76, barY + barH + 12);

          // amount at the end
          doc.setFont('helvetica','bold'); doc.setFontSize(12);
          doc.text(fmtMoney(total), M + 70 + barMaxW + 10, barY + barH + 12);

          y += rowH - 6;
        }
      }

      if(y+28>pageH-M){ doc.addPage(); y=M; }
      doc.setDrawColor(230, 232, 240); doc.line(M, y, pageW-M, y); y+=18;

      /* ---------- VOID / EMPTY CHECKS ---------- */
      const voidChecks = checks.filter(c=>voidedSet.has(c.id));
      if(voidChecks.length){
        if(y+60>pageH-M){ doc.addPage(); y=M; }
        doc.setFont('helvetica','bold'); doc.setFontSize(15); doc.setTextColor(15,23,42);
        doc.text('Void / Empty Checks', M, y); y+=10;

        const tableBody = voidChecks.map(c=>[
          String(c.check_number||''),
          mmddyyyyFromYMD(c.check_date),
          fmtMoney(c.check_amount||0),
          c.notes || ''
        ]);

        doc.autoTable({
          startY: y+6,
          margin: {left:M, right:M},
          tableWidth: pageW - M*2,
          head: [['Check #','Date','Amount','Notes']],
          body: tableBody,
          styles:{font:'helvetica',fontSize:10,cellPadding:4, overflow:'linebreak'},
          headStyles:{fillColor:[224,232,248], textColor:[30,58,138], fontStyle:'bold'},
          columnStyles:{ 0:{cellWidth:70}, 1:{cellWidth:80}, 2:{cellWidth:80}, 3:{cellWidth:'auto'} },
          didDrawPage: ()=> {
            doc.setFontSize(9); doc.setTextColor(148,163,184);
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW-M, pageH-16, {align:'right'});
          }
        });
        y = doc.autoTable.previous.finalY + 10;
      }

      /* ---------- VENDOR SUMMARY TABLE ---------- */
      doc.addPage(); y = M;
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(15,23,42);
      doc.text("Vendor Summary", M, y); y += 10;

      doc.autoTable({
        startY: y,
        margin: {left: M, right: M},
        tableWidth: pageW - M*2,
        head: [['Vendor Name', 'Total Paid']],
        body: [...vendorTotals.entries()]
              .sort((a,b)=>b[1]-a[1])
              .map(([vendor, total]) => [vendor, fmtMoney(total)]),
        styles: {font:'helvetica', fontSize: 10, cellPadding: 4, overflow: 'linebreak'},
        headStyles: {fillColor: [20, 20, 20], textColor: [255,255,255], fontStyle: 'bold'},
        didDrawPage: () => {
          doc.setFontSize(9);
          doc.setTextColor(148, 163, 184);
          doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW - M, pageH - 16, {align: 'right'});
        }
      });
      y = doc.autoTable.previous.finalY + 24;

      /* ---------- VENDOR DETAIL TABLES ---------- */
      doc.addPage(); y = M;
      doc.setFont('helvetica','bold'); doc.setFontSize(16); doc.setTextColor(15,23,42);
      doc.text('Vendor Details', M, y); y+=10;

      function estimateTableHeight(rows){ return 26 + rows*20 + 12; }

      const vendorsAlpha = [...vendorTotals.keys()].sort((a,b)=>a.localeCompare(b));
      for(const v of vendorsAlpha){
        const byCheck = new Map();
        (invoices||[]).filter(inv => inv.VendorName === v && !voidedSet.has(inv.check_id) && (inv.Status||'')!=='Voided').forEach(inv => {
          if (!byCheck.has(inv.check_id)) { byCheck.set(inv.check_id, {invoices: []}); }
          byCheck.get(inv.check_id).invoices.push(inv);
        });

        const rows = [];
        const items = [...byCheck.keys()]
          .map(id => [id, checksById.get(id), byCheck.get(id)])
          .sort((a,b)=>(a[1]?.check_date||'').localeCompare(b[1]?.check_date||''));
        for(const [cid, cRow, bucket] of items){
          bucket.invoices
            .sort((a,b)=>(a.InvoiceDate||'').localeCompare(b.InvoiceDate||''))
            .forEach((inv,idx)=>{
              rows.push([
                idx===0? (cRow?.check_number||'') : '', // JUST THE NUMBER (no 'Check #')
                idx===0?(cRow?.check_date?mmddyyyyFromYMD(cRow.check_date):''):'',
                idx===0?fmtMoney(cRow?.check_amount||0):'',
                inv.InvoiceNumber||'',
                inv.InvoiceDate? mmddyyyyFromYMD(inv.InvoiceDate):'',
                fmtMoney(inv.InvoiceTotal||0)
              ]);
            });
        }

        const needed = 28 + estimateTableHeight(rows.length);
        if(y + needed > pageH - M){ doc.addPage(); y=M; }

        doc.setFont('helvetica','bold'); doc.setFontSize(10); doc.setTextColor(0,0,0);
        doc.text(v, M, y+16);
        y += 20;

        doc.autoTable({
          startY: y,
          margin: {left:M, right:M},
          tableWidth: pageW - M*2,
          head: [['Check #','Check Date','Check Amount','Invoice #','Invoice Date','Invoice Amount']],
          body: rows,
          styles:{font:'helvetica', fontSize:10, cellPadding:4, overflow:'linebreak'},
          headStyles:{fillColor:[0,0,0], textColor:[255,255,255], fontStyle:'bold'},
          columnStyles:{
            0:{cellWidth:72},
            1:{cellWidth:72},
            2:{cellWidth:82},
            3:{cellWidth:88},
            4:{cellWidth:80},
            5:{cellWidth:90, halign:'right'}
          },
          alternateRowStyles:{ fillColor:[245,247,255] },
          didDrawPage: ()=> {
            doc.setFontSize(9); doc.setTextColor(148,163,184);
            doc.text(`Page ${doc.internal.getNumberOfPages()}`, pageW-M, pageH-16, {align:'right'});
          }
        });
        y = doc.autoTable.previous.finalY + 12;
      }

      // ===== File name format =====
      let fileMonthLabel = '';
      if(quickMonth.value && quickMonth.value !== 'custom'){
        const [yy, mm] = quickMonth.value.split('-').map(Number);
        fileMonthLabel = `${monthName(yy, mm-1)} ${yy}`;
      }else{
        const d = new Date(startDate);
        fileMonthLabel = `${d.toLocaleString('en-US',{month:'long'})} ${d.getFullYear()}`;
      }
      const fileName = `Check Summary Report - ${fileMonthLabel}.pdf`;

      // Save + preview
      const blob = doc.output('blob');
      const url = URL.createObjectURL(blob);
      document.getElementById('reportPreview').src = url; // live preview
      doc.save(fileName); // download
      showModal("Report Generated", `Downloaded: ${fileName}`);
    }

    // ====== QUICK MONTH (Aug 2025 → Dec 2030) ======
    function populateQuickMonth(){
      const s = quickMonth;
      const startY=2025, startM=7;
      const endY=2030, endM=11;
      for(let y=startY; y<=endY; y++){
        const mStart = (y===startY)? startM : 0;
        const mEnd   = (y===endY)? endM   : 11;
        for(let m=mStart; m<=mEnd; m++){
          const name = new Date(y,m,1).toLocaleString('en-US',{month:'long'});
          const opt = document.createElement('option');
          opt.value=`${y}-${String(m+1).padStart(2,'0')}`;
          opt.textContent = `${name} ${y}`;
          s.appendChild(opt);
        }
      }
    }
    function applyQuickMonth(){
      if(quickMonth.value==='custom'){ reportStartDate.disabled=false; reportEndDate.disabled=false; return; }
      const [yy, mm] = quickMonth.value.split('-').map(Number);
      reportStartDate.value = firstOfMonth(yy, mm-1);
      reportEndDate.value   = lastOfMonth(yy, mm-1);
      reportStartDate.disabled = true; reportEndDate.disabled = true;
    }

    /* ========================== BOOT ========================== */
    document.addEventListener('DOMContentLoaded', async ()=>{
      // tabs
      document.getElementById('tab-manage').onclick = ()=>switchTab('tab-manage');
      document.getElementById('tab-view').onclick   = ()=>switchTab('tab-view');
      document.getElementById('tab-edit').onclick   = ()=>switchTab('tab-edit');
      document.getElementById('tab-report').onclick = ()=>switchTab('tab-report');

      // modal
      document.getElementById('mOk').onclick = hideModal;

      // preload images
      logoData.company = await toDataUrl(companyLogoUrl);
      const companyLogo = document.getElementById('company-logo');
      companyLogo.src = logoData.company?.data || companyLogoUrl;
      await Promise.all(Object.entries(vendorLogos).map(async([k,u])=>{ logoData[k] = await toDataUrl(u); }));

      // filters
      const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      months.forEach((m,i)=> invoiceMonthFilter.add(new Option(m, String(i+1))));
      for(let y=(new Date()).getFullYear(); y>=2020; y--) {
        const o = document.createElement('option');
        o.value = String(y);
        o.textContent = String(y);
        invoiceYearFilter.appendChild(o);
      }

      await loadVendors(); await loadInvoices();

      // rows
      btnAddRow.onclick = ()=>addInvoiceRowInManagement();
      btnClearRows.onclick = ()=> invoiceRows.innerHTML='';
      defaultVendor.onchange = syncFirstRowVendor;

      // actions
      btnAddVendor.onclick = addVendor;
      btnSaveInvoices.onclick = saveInvoices;
      btnSaveVoid.onclick = saveVoidOnly;
      btnFindCheck.onclick = ()=> {
        const n=(searchCheckNumber.value||'').trim();
        if(!n) return showModal('Enter number','Type a check number.');
        loadCheckByNumber(n);
      };
      document.getElementById('btnSaveCheckEdits').onclick = saveCheckEdits;
      document.getElementById('btnNewProcedure').onclick = clearEditCheckForm;
      btnAddInvoiceRowEdit.onclick = addInvoiceRowEdit;
      btnSaveInvoicesEdit.onclick = saveInvoicesEdit;

      // void / unvoid
      document.getElementById('btnVoidCheck').onclick   = ()=> setCheckVoidState(true);
      document.getElementById('btnUnvoidCheck').onclick = ()=> setCheckVoidState(false);

      // report controls
      populateQuickMonth();
      const now = new Date();
      reportStartDate.value = firstOfMonth(now.getFullYear(), now.getMonth());
      reportEndDate.value   = lastOfMonth(now.getFullYear(), now.getMonth());
      quickMonth.onchange = applyQuickMonth;
      btnGenerateReport.onclick = generateReport;

      // first editable row
      addInvoiceRowInManagement();
      syncFirstRowVendor();
    });
  </script>
</body>
</html>
