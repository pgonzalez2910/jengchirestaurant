<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Jeng Chi Check Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet"/>
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .tab-btn { padding: .75rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: border-color .2s, color .2s; }
    .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; }
    .modal { display:none; position:fixed; z-index:1000; inset:0; background:rgba(0,0,0,.4); justify-content:center; align-items:center; }
    .modal-content { background:#fff; padding:2rem; border-radius:12px; width:90%; max-width:520px; box-shadow:0 5px 15px rgba(0,0,0,.3); text-align:left; }
    .modal-actions { display:flex; justify-content:center; gap:.75rem; margin-top:1rem; }
    .grid-sm { display:grid; grid-template-columns: 1.2fr .9fr .9fr 1fr; gap:.5rem; }
    @media (max-width: 1024px){ .grid-sm{ grid-template-columns: 1fr 1fr; } }
    .btn { display:inline-flex; align-items:center; justify-content:center; font-weight:600; border-radius:.5rem; padding:.5rem .9rem; }
    .btn-primary { background:#2563eb; color:#fff; }
    .btn-ghost { background:#eef2ff; color:#374151; }
    .btn-danger { background:#ef4444; color:#fff; }
    .btn-outline { border:1px solid #cbd5e1; color:#111827; background:#fff; }
    .row-card { background:#fff; border:1px solid #e5e7eb; border-radius:.5rem; padding:.75rem; }
    .muted { color:#6b7280; font-size:.82rem; }
  </style>
</head>
<body class="bg-gray-100 p-8">

  <div class="max-w-6xl mx-auto bg-white shadow-xl rounded-lg p-6">
    <header class="text-center mb-8">
      <img id="company-logo" alt="Jeng Chi Logo" class="mx-auto h-20 mb-4">
      <h1 class="text-3xl font-bold text-blue-600">Inventory Management System</h1>
      <h2 class="text-xl font-semibold text-gray-800">Check & Invoice Tracker</h2>
    </header>

    <div class="flex justify-center border-b border-gray-200 mb-6 gap-6 overflow-x-auto">
      <button id="invoice-management-tab" class="tab-btn active">Invoice Management</button>
      <button id="view-invoices-tab" class="tab-btn">View Invoices</button>
      <button id="edit-check-tab" class="tab-btn">Edit Check</button>
      <button id="generate-report-tab" class="tab-btn">Generate Report</button>
    </div>

    <!-- Invoice Management -->
    <div id="invoice-management-section" class="tab-content">
      <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Add New Vendor</h3>
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="newVendorName" placeholder="Enter New Vendor Name" class="flex-grow p-2 border border-gray-300 rounded-md">
          <button id="btnAddVendor" class="btn btn-primary">Add Vendor</button>
        </div>
      </div>

      <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-3">Enter New Invoice Details</h3>

        <!-- Select or Create Check -->
        <div class="bg-white border rounded-md p-4 mb-4">
          <h4 class="font-semibold text-gray-800 mb-2">Select or Create Check</h4>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
            <div>
              <label class="block mb-1 text-sm font-medium">Existing Check</label>
              <select id="selectCheck" class="w-full p-2 border border-gray-300 rounded-md">
                <option value="">-- New Check --</option>
              </select>
            </div>
            <div>
              <label class="block mb-1 text-sm font-medium">Check Number</label>
              <input type="text" id="newCheckNumber" class="w-full p-2 border border-gray-300 rounded-md" placeholder="e.g. 10321">
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="block mb-1 text-sm font-medium">Check Date</label>
                <input type="date" id="newCheckDate" class="w-full p-2 border border-gray-300 rounded-md">
              </div>
              <div>
                <label class="block mb-1 text-sm font-medium">Check Amount ($)</label>
                <input type="number" step="0.01" id="newCheckAmount" class="w-full p-2 border border-gray-300 rounded-md">
              </div>
            </div>
          </div>
          <p class="muted mt-1">Tip: Choose an existing check to add multiple invoices to it, or leave as “New Check” and enter number/date/amount to create one.</p>
        </div>

        <!-- MULTI-INVOICE EDITOR -->
        <div class="row-card mb-4">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-gray-800">Invoices to Add</h4>
            <div class="flex gap-2">
              <button id="btnAddInvoiceRow" class="btn btn-outline">+ Add another invoice</button>
              <button id="btnClearInvoiceRows" class="btn btn-ghost">Clear</button>
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-3">
            <div>
              <label class="block mb-1 text-sm font-medium">Default Vendor for new rows</label>
              <select id="defaultVendor" class="w-full p-2 border border-gray-300 rounded-md"></select>
            </div>
            <div class="muted flex items-end">Each row can still choose a different vendor.</div>
          </div>

          <div id="invoiceRows" class="space-y-3"></div>
          <p class="muted mt-2">You can add as many rows as needed; all will attach to the selected/created check.</p>
        </div>

        <div class="text-center mt-6">
          <button id="btnSaveMultipleInvoices" class="btn btn-primary px-8">Save Invoices</button>
        </div>
      </div>
    </div>

    <!-- View Invoices -->
    <div id="view-invoices-section" class="tab-content hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Invoice History</h3>
      <div class="flex flex-wrap gap-4 mb-4 items-end">
        <div>
          <label class="font-medium block mb-1">Filter by Vendor</label>
          <select id="invoiceVendorFilter" class="p-2 border border-gray-300 rounded-md min-w-[200px]">
            <option value="">-- All Vendors --</option>
          </select>
        </div>
        <div>
          <label class="font-medium block mb-1">Filter by Status</label>
          <select id="invoiceStatusFilter" class="p-2 border border-gray-300 rounded-md min-w-[140px]">
            <option value="All">All</option>
            <option value="Paid">Paid</option>
            <option value="Unpaid">Unpaid</option>
          </select>
        </div>
        <div>
          <label class="font-medium block mb-1">Filter by Month</label>
          <select id="invoiceMonthFilter" class="p-2 border border-gray-300 rounded-md min-w-[180px]">
            <option value="">-- All Months --</option>
          </select>
        </div>
        <div>
          <label class="font-medium block mb-1">Filter by Year</label>
          <select id="invoiceYearFilter" class="p-2 border border-gray-300 rounded-md min-w-[140px]">
            <option value="">-- All Years --</option>
          </select>
        </div>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-3 text-xs font-semibold text-left">Invoice #</th>
              <th class="py-2 px-3 text-xs font-semibold text-left">Vendor</th>
              <th class="py-2 px-3 text-xs font-semibold text-left">Date</th>
              <th class="py-2 px-3 text-xs font-semibold text-left">Amount</th>
              <th class="py-2 px-3 text-xs font-semibold text-left">Check #</th>
              <th class="py-2 px-3 text-xs font-semibold text-left">Status</th>
            </tr>
          </thead>
          <tbody id="dgvInvoices" class="bg-white divide-y divide-gray-200">
            <tr><td colspan="6" class="text-center py-4 text-gray-500">No invoices to display.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Edit Check -->
    <div id="edit-check-section" class="tab-content hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-3">Edit Check</h3>

      <div class="row-card mb-4">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
          <div>
            <label class="block text-sm font-medium mb-1">Search by Check Number</label>
            <input type="text" id="searchCheckNumber" class="w-full p-2 border rounded-md" placeholder="e.g. 10321">
          </div>
          <div>
            <button id="btnFindCheck" class="btn btn-primary mt-6 w-full">Find Check</button>
          </div>
          <div class="muted md:mt-6">You can also open this tab from “View Invoices” by clicking “Edit”.</div>
        </div>
      </div>

      <div id="checkEditor" class="hidden">
        <div class="row-card mb-4">
          <h4 class="font-semibold text-gray-800 mb-2">Check Details</h4>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium mb-1">Check Number</label>
              <input type="text" id="editCheckNumber" class="w-full p-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Check Date</label>
              <input type="date" id="editCheckDate" class="w-full p-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Check Amount ($)</label>
              <input type="number" step="0.01" id="editCheckAmount" class="w-full p-2 border rounded-md">
            </div>
            <div>
              <label class="block text-sm font-medium mb-1">Notes</label>
              <input type="text" id="editCheckNotes" class="w-full p-2 border rounded-md" placeholder="Memo / notes">
            </div>
          </div>
          <div class="flex gap-2 mt-3">
            <button id="btnSaveCheckEdits" class="btn btn-primary">Save Check</button>
            <button id="btnReloadCheck" class="btn btn-outline">Reload</button>
          </div>
        </div>

        <div class="row-card">
          <div class="flex items-center justify-between mb-3">
            <h4 class="font-semibold text-gray-800">Invoices Linked to this Check</h4>
            <div class="flex gap-2">
              <button id="btnAddInvoiceRowEdit" class="btn btn-outline">+ Add invoice</button>
              <button id="btnSaveInvoicesEdit" class="btn btn-primary">Save new invoices</button>
            </div>
          </div>
          <div id="linkedInvoices" class="space-y-2"></div>
          <div id="newInvoicesForThisCheck" class="space-y-3 mt-4"></div>
        </div>
      </div>
    </div>

    <!-- Generate Report -->
    <div id="generate-report-section" class="tab-content hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Generate Monthly Checks Report</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div>
          <label class="block">Start Date</label>
          <input type="date" id="reportStartDate" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
        <div>
          <label class="block">End Date</label>
          <input type="date" id="reportEndDate" class="w-full p-2 border border-gray-300 rounded-md">
        </div>
      </div>
      <div class="text-center">
        <button id="btnGenerateReport" class="btn btn-primary px-8">Download PDF Report</button>
      </div>
    </div>
  </div>

  <!-- Generic Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" class="text-lg font-semibold mb-2"></h3>
      <p id="modal-message" class="text-sm"></p>
      <div class="modal-actions">
        <button id="modal-close-btn" class="btn btn-primary">OK</button>
      </div>
    </div>
  </div>

  <script>
    // libs
    window.jsPDF = window.jspdf.jsPDF;

    // Supabase
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Logos
    const companyLogoUrl = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";
    const vendorLogos = {
      "City of Richardson": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/richardson.jpg",
      "Eiland - Coffe": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/eliand.jpg",
      "Taiwanese Student Association": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/taiwanese.jpg",
      "Bakemark": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/bakemark.jpg",
      "Delta Office Products": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/delta.jpg",
      "Formosa Foods": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/formosa.jpg",
      "North Food Group": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/northfoodgroup.jpg",
      "Pacific Plus": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/pacific.jpg",
      "Fortune": "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/fortune.jpg"
    };
    const logoDataUrls = {};

    // UI helpers
    function showMessageModal(title, msg) {
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-message").textContent = msg;
      document.getElementById("custom-modal").style.display = "flex";
    }
    function hideMessageModal() { document.getElementById("custom-modal").style.display = "none"; }

    // Tabs
    function setupTabs() {
      const tabs = {
        'invoice-management-tab': 'invoice-management-section',
        'view-invoices-tab': 'view-invoices-section',
        'edit-check-tab': 'edit-check-section',
        'generate-report-tab': 'generate-report-section'
      };
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(button => {
        button.addEventListener('click', () => {
          tabButtons.forEach(btn => btn.classList.remove('active'));
          button.classList.add('active');
          for (const tid in tabs) document.getElementById(tabs[tid]).classList.add('hidden');
          document.getElementById(tabs[button.id]).classList.remove('hidden');
        });
      });
    }

    // Images preload
    async function preloadImages() {
      try {
        const response = await fetch(companyLogoUrl);
        const blob = await response.blob();
        const reader = new FileReader();
        await new Promise(resolve => { reader.onloadend = () => { logoDataUrls['company'] = reader.result; resolve(); }; reader.readAsDataURL(blob); });
      } catch (e) { console.error("Failed to preload company logo:", e); logoDataUrls['company'] = null; }

      const vendorPromises = Object.keys(vendorLogos).map(async (vendorName) => {
        try {
          const response = await fetch(vendorLogos[vendorName]);
          const blob = await response.blob();
          const reader = new FileReader();
          await new Promise(resolve => { reader.onloadend = () => { logoDataUrls[vendorName] = reader.result; resolve(); }; reader.readAsDataURL(blob); });
        } catch (e) { console.error(`Failed to preload logo for ${vendorName}:`, e); logoDataUrls[vendorName] = null; }
      });
      await Promise.allSettled(vendorPromises);
    }

    // Vendors
    async function loadVendors() {
      const { data: vendors } = await supabase.from("public_vendors").select("vendor_name").order("vendor_name");
      const addVendor = document.getElementById("defaultVendor");
      const invoiceVendorFilter = document.getElementById("invoiceVendorFilter");
      addVendor.innerHTML = "";
      invoiceVendorFilter.innerHTML = '<option value="">-- All Vendors --</option>';
      if (vendors) {
        vendors.forEach(v => {
          if (v.vendor_name !== "AutoChlor") {
            addVendor.add(new Option(v.vendor_name, v.vendor_name));
            invoiceVendorFilter.add(new Option(v.vendor_name, v.vendor_name));
          }
        });
      }
    }
    async function addVendorAction() {
      const name = document.getElementById("newVendorName").value.trim();
      if (!name) return showMessageModal('Error','Please enter a vendor name.');
      const { error } = await supabase.from("public_vendors").insert([{ vendor_name: name }]);
      if (error) { console.error(error); return showMessageModal('Error','Failed to add vendor.'); }
      showMessageModal('Success', `${name} added.`);
      document.getElementById("newVendorName").value = "";
      await loadVendors();
      refreshVendorSelectorsInRows();
    }

    // Checks
    async function loadChecksDropdown() {
      const { data: checks, error } = await supabase
        .from('public_checks')
        .select('id, check_number, check_date, check_amount')
        .order('check_date', { ascending: false });
      const select = document.getElementById('selectCheck');
      if (!select) return;
      select.innerHTML = '<option value="">-- New Check --</option>';
      if (checks && !error) {
        checks.forEach(c => {
          const label = [c.check_number || '(no #)', c.check_date ? new Date(c.check_date).toLocaleDateString('en-US') : 'no date', (typeof c.check_amount === 'number' ? `$${c.check_amount.toFixed(2)}` : '')].filter(Boolean).join(' • ');
          select.add(new Option(label, c.id));
        });
      }
    }
    async function upsertCheckFromForm() {
      const selectedCheckId = document.getElementById('selectCheck').value;
      if (selectedCheckId) return { id: selectedCheckId };

      const number = (document.getElementById('newCheckNumber').value || '').trim();
      const date = document.getElementById('newCheckDate').value || null;
      const amtStr = document.getElementById('newCheckAmount').value;
      const amount = amtStr ? Number(amtStr) : 0;

      if (!number) { showMessageModal('Validation Error','Enter a Check Number or choose an existing check.'); throw new Error('missing check number'); }

      const { data: existing } = await supabase.from('public_checks').select('id').eq('check_number', number).maybeSingle();
      if (existing?.id) {
        await supabase.from('public_checks').update({ check_date: date, check_amount: amount }).eq('id', existing.id);
        return { id: existing.id };
      }
      const { data: inserted, error } = await supabase.from('public_checks').insert([{ check_number: number, check_date: date, check_amount: amount }]).select('id').single();
      if (error) { console.error(error); showMessageModal('Error','Failed to create check.'); throw error; }
      await loadChecksDropdown();
      return { id: inserted.id };
    }

    // MULTI-INVOICE rows (Invoice Management)
    function makeInvoiceRow(idSuffix, vendorOptionsHtml, preset={}) {
      const wrap = document.createElement('div');
      wrap.className = 'row-card';
      wrap.innerHTML = `
        <div class="grid-sm">
          <div>
            <label class="block text-sm font-medium mb-1">Vendor</label>
            <select class="vendor w-full p-2 border rounded-md">${vendorOptionsHtml}</select>
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Invoice Date</label>
            <input type="date" class="invdate w-full p-2 border rounded-md" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Invoice Number</label>
            <input type="text" class="invnum w-full p-2 border rounded-md" placeholder="INV-" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">Invoice Total ($)</label>
            <input type="number" step="0.01" class="invtotal w-full p-2 border rounded-md" />
          </div>
        </div>
        <div class="flex justify-end mt-2">
          <button class="btn btn-danger btnRemoveRow">Remove</button>
        </div>
      `;
      if (preset.vendor) wrap.querySelector('.vendor').value = preset.vendor;
      if (preset.date) wrap.querySelector('.invdate').value = preset.date;
      if (preset.number) wrap.querySelector('.invnum').value = preset.number;
      if (preset.total != null) wrap.querySelector('.invtotal').value = preset.total;

      wrap.querySelector('.btnRemoveRow').addEventListener('click', () => wrap.remove());
      return wrap;
    }
    function currentVendorOptionsHtml() {
      const def = document.getElementById('defaultVendor');
      const opts = Array.from(def.options).map(o => `<option value="${o.value}">${o.textContent}</option>`).join('');
      return opts;
    }
    function refreshVendorSelectorsInRows() {
      const html = currentVendorOptionsHtml();
      document.querySelectorAll('#invoiceRows .vendor, #newInvoicesForThisCheck .vendor').forEach(sel => {
        const cur = sel.value;
        sel.innerHTML = html;
        if (cur) sel.value = cur;
      });
    }
    function addInvoiceRowInManagement() {
      const html = currentVendorOptionsHtml();
      const vendorDefault = document.getElementById('defaultVendor').value || '';
      const row = makeInvoiceRow('m', html, { vendor: vendorDefault });
      document.getElementById('invoiceRows').appendChild(row);
    }

    async function saveMultipleInvoices() {
      // ensure a check
      let checkRef;
      try { checkRef = await upsertCheckFromForm(); } catch { return; }

      const rows = Array.from(document.querySelectorAll('#invoiceRows .row-card'));
      if (rows.length === 0) return showMessageModal('Nothing to save','Add at least one invoice row.');

      const payload = [];
      for (const r of rows) {
        const vendor = r.querySelector('.vendor').value;
        const invdate = r.querySelector('.invdate').value;
        const invnum = r.querySelector('.invnum').value.trim();
        const invtotal = parseFloat(r.querySelector('.invtotal').value);
        if (!vendor || !invdate || !invnum || isNaN(invtotal)) {
          return showMessageModal('Validation Error','Each row needs Vendor, Date, Number, and Total.');
        }
        payload.push({
          VendorName: vendor,
          InvoiceDate: invdate,
          InvoiceNumber: invnum,
          InvoiceTotal: invtotal,
          Status: "Paid",
          check_id: checkRef.id
        });
      }

      const { error } = await supabase.from("public_invoices").insert(payload);
      if (error) { console.error(error); return showMessageModal('Error','Failed to save invoices.'); }
      showMessageModal('Success', `${payload.length} invoice(s) saved to the check.`);
      document.getElementById('invoiceRows').innerHTML = '';
      await loadInvoices();
      await loadChecksDropdown();
    }

    // View Invoices
    async function loadInvoices() {
      const selectedVendor = document.getElementById("invoiceVendorFilter").value;
      const selectedStatus = document.getElementById("invoiceStatusFilter").value;
      const selectedMonth = document.getElementById("invoiceMonthFilter").value;
      const selectedYear = document.getElementById("invoiceYearFilter").value;
      const tableBody = document.getElementById("dgvInvoices");
      tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">Loading...</td></tr>`;

      let query = supabase.from("public_invoices").select(`
        *,
        check:public_checks!public_invoices_check_fk ( id, check_number, check_date, check_amount )
      `);

      if (selectedVendor) query = query.eq("VendorName", selectedVendor);
      if (selectedStatus !== "All") query = query.eq("Status", selectedStatus);

      if (selectedMonth && selectedYear) {
        const startOfMonth = new Date(selectedYear, selectedMonth - 1, 1).toISOString();
        const endOfMonth = new Date(selectedYear, selectedMonth, 0, 23, 59, 59).toISOString();
        query = query.gte("InvoiceDate", startOfMonth).lte("InvoiceDate", endOfMonth);
      } else if (selectedYear) {
        const startOfYear = new Date(selectedYear, 0, 1).toISOString();
        const endOfYear = new Date(selectedYear, 11, 31, 23, 59, 59).toISOString();
        query = query.gte("InvoiceDate", startOfYear).lte("InvoiceDate", endOfYear);
      }

      const { data: invoices, error } = await query.order("InvoiceDate", { ascending: false });
      if (error || !invoices) { console.error(error); tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-500">Error loading invoices.</td></tr>`; return; }
      if (invoices.length === 0) { tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No invoices found.</td></tr>`; return; }

      tableBody.innerHTML = "";
      invoices.forEach(inv => {
        const row = document.createElement("tr");
        const formattedDate = inv.InvoiceDate ? new Date(inv.InvoiceDate).toLocaleDateString("en-US") : "N/A";
        const chk = inv.check || {};
        row.innerHTML = `
          <td class="py-2 px-3 text-sm text-gray-700">${inv.InvoiceNumber}</td>
          <td class="py-2 px-3 text-sm text-gray-700">${inv.VendorName}</td>
          <td class="py-2 px-3 text-sm text-gray-700">${formattedDate}</td>
          <td class="py-2 px-3 text-sm text-gray-700">$${Number(inv.InvoiceTotal).toFixed(2)}</td>
          <td class="py-2 px-3 text-sm text-gray-700">
            <div class="flex items-center gap-2">
              <span>${chk.check_number || 'N/A'}</span>
              ${chk.id ? `<button class="text-blue-600 underline text-xs" data-edit-check="${chk.id}">Edit</button>` : ''}
            </div>
          </td>
          <td class="py-2 px-3 text-sm text-gray-700">${inv.Status || 'Paid'}</td>
        `;
        tableBody.appendChild(row);
      });

      tableBody.querySelectorAll('[data-edit-check]').forEach(btn => {
        btn.addEventListener('click', () => {
          // jump to Edit tab and load this check
          document.getElementById('edit-check-tab').click();
          loadCheckById(btn.getAttribute('data-edit-check'));
        });
      });
    }

    // ===== EDIT CHECK TAB =====
    let currentEditCheckId = null;

    async function loadCheckByNumber(number) {
      const { data, error } = await supabase.from('public_checks').select('*').eq('check_number', number).maybeSingle();
      if (error || !data) { showMessageModal('Not found', 'No check with that number.'); return; }
      return loadCheckIntoEditor(data);
    }
    async function loadCheckById(id) {
      const { data, error } = await supabase.from('public_checks').select('*').eq('id', id).single();
      if (error || !data) { showMessageModal('Error','Could not load check.'); return; }
      return loadCheckIntoEditor(data);
    }
    async function loadCheckIntoEditor(checkRow) {
      currentEditCheckId = checkRow.id;
      document.getElementById('checkEditor').classList.remove('hidden');
      document.getElementById('editCheckNumber').value = checkRow.check_number || '';
      document.getElementById('editCheckDate').value = checkRow.check_date || '';
      document.getElementById('editCheckAmount').value = (typeof checkRow.check_amount === 'number' ? checkRow.check_amount : '');
      document.getElementById('editCheckNotes').value = checkRow.notes || '';

      await renderLinkedInvoices();
    }
    async function renderLinkedInvoices() {
      const box = document.getElementById('linkedInvoices');
      box.innerHTML = '<div class="muted">Loading invoices…</div>';
      const { data: invoices, error } = await supabase.from('public_invoices')
        .select('Id, VendorName, InvoiceDate, InvoiceNumber, InvoiceTotal')
        .eq('check_id', currentEditCheckId)
        .order('InvoiceDate', { ascending: true });
      if (error) { console.error(error); box.innerHTML = '<div class="text-red-500">Error loading invoices.</div>'; return; }
      if (!invoices || invoices.length === 0) { box.innerHTML = '<div class="muted">No invoices are linked to this check yet.</div>'; return; }

      box.innerHTML = '';
      invoices.forEach(inv => {
        const row = document.createElement('div');
        row.className = 'row-card';
        row.innerHTML = `
          <div class="grid-sm items-center">
            <div><div class="text-sm"><span class="font-semibold">${inv.VendorName}</span></div></div>
            <div><div class="text-sm">${inv.InvoiceDate ? new Date(inv.InvoiceDate).toLocaleDateString('en-US') : ''}</div></div>
            <div><div class="text-sm">${inv.InvoiceNumber}</div></div>
            <div><div class="text-sm">$${Number(inv.InvoiceTotal).toFixed(2)}</div></div>
          </div>
        `;
        box.appendChild(row);
      });
    }
    async function saveCheckEdits() {
      if (!currentEditCheckId) return;
      const payload = {
        check_number: (document.getElementById('editCheckNumber').value || '').trim(),
        check_date: document.getElementById('editCheckDate').value || null,
        check_amount: (document.getElementById('editCheckAmount').value ? Number(document.getElementById('editCheckAmount').value) : null),
        notes: document.getElementById('editCheckNotes').value || null
      };
      if (!payload.check_number) return showMessageModal('Validation','Check number is required.');
      const { error } = await supabase.from('public_checks').update(payload).eq('id', currentEditCheckId);
      if (error) { console.error(error); return showMessageModal('Error','Failed to save check.'); }
      showMessageModal('Success','Check updated.');
      await loadChecksDropdown();
      await renderLinkedInvoices();
      await loadInvoices();
    }

    // add rows on the Edit tab specifically for this check
    function addInvoiceRowInEdit() {
      const html = currentVendorOptionsHtml();
      const row = makeInvoiceRow('e', html, {});
      document.getElementById('newInvoicesForThisCheck').appendChild(row);
    }
    async function saveNewInvoicesForThisCheck() {
      if (!currentEditCheckId) return showMessageModal('No check','Load a check first.');
      const rows = Array.from(document.querySelectorAll('#newInvoicesForThisCheck .row-card'));
      if (rows.length === 0) return showMessageModal('Nothing to save','Add at least one invoice row.');

      const payload = [];
      for (const r of rows) {
        const vendor = r.querySelector('.vendor').value;
        const invdate = r.querySelector('.invdate').value;
        const invnum = r.querySelector('.invnum').value.trim();
        const invtotal = parseFloat(r.querySelector('.invtotal').value);
        if (!vendor || !invdate || !invnum || isNaN(invtotal)) {
          return showMessageModal('Validation Error','Each row needs Vendor, Date, Number, and Total.');
        }
        payload.push({ VendorName: vendor, InvoiceDate: invdate, InvoiceNumber: invnum, InvoiceTotal: invtotal, Status: 'Paid', check_id: currentEditCheckId });
      }

      const { error } = await supabase.from('public_invoices').insert(payload);
      if (error) { console.error(error); return showMessageModal('Error','Failed to save invoices.'); }
      showMessageModal('Success', `${payload.length} invoice(s) added to this check.`);
      document.getElementById('newInvoicesForThisCheck').innerHTML = '';
      await renderLinkedInvoices();
      await loadInvoices();
    }

    // ===== REPORT (unchanged layout; uses joins) =====
    async function generateMonthlyChecksReport() {
      const startDate = document.getElementById('reportStartDate').value;
      const endDate = document.getElementById('reportEndDate').value;

      const { data: paidInvoices, error } = await supabase
        .from("public_invoices")
        .select(`*, check:public_checks!public_invoices_check_fk (check_number, check_date, check_amount)`)
        .gte("InvoiceDate", startDate)
        .lte("InvoiceDate", endDate)
        .order("VendorName", { ascending: true })
        .order("InvoiceDate", { ascending: true });

      if (error || !paidInvoices || paidInvoices.length === 0) {
        showMessageModal("No Data", "No paid invoices for this range.");
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF("p", "pt", "a4");
      const pageWidth = doc.internal.pageSize.getWidth();
      let y = 60, margin = 40;
      const tableColumnWidth = (pageWidth - margin * 2) / 4;
      const headerColors = ['#F8E0E0','#E0E8F8','#E0F8E8','#F8E8E0','#E8F8E0'];

      if (logoDataUrls['company']) doc.addImage(logoDataUrls['company'], "JPEG", pageWidth/2-40, 10, 80, 60);
      y = 90;
      doc.setFont("helvetica","bold").setFontSize(18).text("Jeng Chi - Inventory Management System", pageWidth/2, y, {align:"center"});
      y+=20; doc.setFontSize(14).text("Monthly Checks Report", pageWidth/2, y, {align:"center"});
      y+=20; doc.setFontSize(12).text(`Period: ${new Date(startDate).toLocaleDateString("en-US",{month:"long",day:"2-digit",year:"numeric",timeZone:'UTC'})} to ${new Date(endDate).toLocaleDateString("en-US",{month:"long",day:"2-digit",year:"numeric",timeZone:'UTC'})}`, pageWidth/2, y, {align:"center"});
      y+=30;

      const grouped = paidInvoices.reduce((a,inv)=>((a[inv.VendorName]=a[inv.VendorName]||[]).push(inv),a),{});
      let grandTotal=0, vendorTotals={}, colorIndex=0;

      for (const vendor of Object.keys(grouped)) {
        if (y+50>doc.internal.pageSize.getHeight()-margin){ doc.addPage(); y=margin; }
        let subtotal=0;
        doc.setFillColor(headerColors[colorIndex%headerColors.length]);
        doc.rect(margin,y,pageWidth-margin*2,20,"F");
        doc.setFont("helvetica","bold").setFontSize(12).text(vendor, margin+10, y+14); y+=30;

        doc.setFont("helvetica","bold").setFontSize(10);
        doc.text("Invoice #", margin+5, y);
        doc.text("Date",    margin+tableColumnWidth+5, y);
        doc.text("Amount",  margin+tableColumnWidth*2+5, y);
        doc.text("Check #", margin+tableColumnWidth*3+5, y);
        y+=15;

        grouped[vendor].forEach(inv=>{
          if (y+15>doc.internal.pageSize.getHeight()-margin){
            doc.addPage(); y=margin;
            doc.setFont("helvetica","bold").setFontSize(10);
            doc.text("Invoice #", margin+5, y);
            doc.text("Date",    margin+tableColumnWidth+5, y);
            doc.text("Amount",  margin+tableColumnWidth*2+5, y);
            doc.text("Check #", margin+tableColumnWidth*3+5, y);
            y+=15;
          }
          const amount = Number(inv.InvoiceTotal)||0;
          subtotal += amount;
          doc.setFont("helvetica","normal");
          doc.text(inv.InvoiceNumber, margin+5, y);
          doc.text(new Date(inv.InvoiceDate).toLocaleDateString("en-US",{month:"2-digit",day:"2-digit",year:"numeric"}), margin+tableColumnWidth+5, y);
          doc.text(`$${amount.toLocaleString("en-US",{minimumFractionDigits:2, maximumFractionDigits:2})}`, margin+tableColumnWidth*2+5, y);
          doc.text(inv.check?.check_number || '', margin+tableColumnWidth*3+5, y);
          y+=15;
        });

        grandTotal+=subtotal; vendorTotals[vendor]=subtotal;
        doc.setFont("helvetica","bold").text(`Subtotal: $${subtotal.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`, pageWidth-margin, y, {align:"right"}); y+=25;
        colorIndex++;
      }

      if (y+100>doc.internal.pageSize.getHeight()){ doc.addPage(); y=margin; }
      y+=20; doc.setFillColor(200,230,200); doc.roundedRect(margin,y,pageWidth-margin*2,80,8,8,"F");
      if (logoDataUrls['company']) doc.addImage(logoDataUrls['company'],"JPEG", margin+10, y+10,60,60);
      doc.setFont("helvetica","bold").setFontSize(14).text("Grand Total", margin+80, y+30);
      doc.setFont("helvetica","normal").setFontSize(14).text(`$${grandTotal.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`, pageWidth-margin-10, y+30,{align:"right"});

      y+=100; if (y>doc.internal.pageSize.getHeight()-80){ doc.addPage(); y=60; }
      doc.setFont("helvetica","bold").setFontSize(12).text("Summary by Vendor", pageWidth/2, y, {align:"center"}); y+=20;
      const cw = (pageWidth - margin*3)/2; let x=margin, cy=y, count=0;
      for (const [vendor,total] of Object.entries(vendorTotals)){
        doc.setFillColor(245,245,245); doc.roundedRect(x,cy,cw,100,8,8,"F");
        doc.setFont("helvetica","bold").setFontSize(11).text(vendor, x+cw/2, cy+65, {align:"center"});
        doc.setFont("helvetica","normal").setFontSize(11).text(`$${total.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`, x+cw/2, cy+85, {align:"center"});
        x+=cw+margin; count++; if (count%2===0){ x=margin; cy+=120; }
      }

      doc.save(`JengChi_Checks_Report_${startDate}_to_${endDate}.pdf`);
      showMessageModal("Report Generated", "PDF downloaded.");
    }

    // DOM Ready
    document.addEventListener("DOMContentLoaded", async () => {
      document.getElementById("modal-close-btn").onclick = hideMessageModal;

      setupTabs();
      await preloadImages();
      document.getElementById('company-logo').src = logoDataUrls['company'];

      // month/year filters
      const invoiceMonthFilter = document.getElementById('invoiceMonthFilter');
      const invoiceYearFilter = document.getElementById('invoiceYearFilter');
      const months = ["January","February","March","April","May","June","July","August","September","October","November","December"];
      const currentYear = new Date().getFullYear();
      months.forEach((m,i)=>{ const o=document.createElement('option'); o.value=i+1; o.textContent=m; invoiceMonthFilter.appendChild(o); });
      for (let i=currentYear;i>=2020;i--){ const o=document.createElement('option'); o.value=i; o.textContent=i; invoiceYearFilter.appendChild(o); }
      invoiceMonthFilter.value=""; invoiceYearFilter.value="";

      await loadVendors();
      await loadChecksDropdown();
      await loadInvoices();

      // Wire filters
      document.getElementById("invoiceVendorFilter").addEventListener("change", loadInvoices);
      document.getElementById("invoiceMonthFilter").addEventListener("change", loadInvoices);
      document.getElementById("invoiceYearFilter").addEventListener("change", loadInvoices);
      document.getElementById("invoiceStatusFilter").addEventListener("change", loadInvoices);

      // Invoice Management actions
      document.getElementById("btnAddVendor").addEventListener("click", addVendorAction);
      document.getElementById("btnAddInvoiceRow").addEventListener("click", addInvoiceRowInManagement);
      document.getElementById("btnClearInvoiceRows").addEventListener("click", ()=> document.getElementById('invoiceRows').innerHTML='');
      document.getElementById("btnSaveMultipleInvoices").addEventListener("click", saveMultipleInvoices);

      // Edit Check actions
      document.getElementById("btnFindCheck").addEventListener("click", async ()=>{
        const num = (document.getElementById('searchCheckNumber').value||'').trim();
        if (!num) return showMessageModal('Enter number','Type a check number.');
        await loadCheckByNumber(num);
      });
      document.getElementById("btnSaveCheckEdits").addEventListener("click", saveCheckEdits);
      document.getElementById("btnReloadCheck").addEventListener("click", ()=> currentEditCheckId && loadCheckById(currentEditCheckId));
      document.getElementById("btnAddInvoiceRowEdit").addEventListener("click", addInvoiceRowInEdit);
      document.getElementById("btnSaveInvoicesEdit").addEventListener("click", saveNewInvoicesForThisCheck);

      // Report
      document.getElementById("btnGenerateReport").addEventListener("click", generateMonthlyChecksReport);
      const rs = document.getElementById('reportStartDate'), re = document.getElementById('reportEndDate');
      const now = new Date();
      rs.value = new Date(now.getFullYear(), now.getMonth(), 1).toISOString().substring(0,10);
      re.value = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString().substring(0,10);

      // Start with one invoice row for convenience
      addInvoiceRowInManagement();
    });
  </script>
</body>
</html>
