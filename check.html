<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Jeng Chi Check Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
    .tab-btn { padding: 0.75rem 1.5rem; cursor: pointer; font-weight: 600; border-bottom: 3px solid transparent; transition: border-color 0.2s, color 0.2s; }
    .tab-btn.active { border-bottom-color: #3b82f6; color: #3b82f6; }
    .modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); justify-content: center; align-items: center; }
    .modal-content { background-color: #fefefe; padding: 2rem; border-radius: 12px; width: 80%; max-width: 500px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); text-align: center; }
  </style>
</head>
<body class="bg-gray-100 p-8">

  <div class="max-w-5xl mx-auto bg-white shadow-xl rounded-lg p-6">
    <header class="text-center mb-8">
      <img src="https://github.com/pgonzalez2910/jengchi-product-images/blob/main/jengchilogo.jpg?raw=true" alt="Logo" class="mx-auto h-20 mb-4">
      <h1 class="text-3xl font-bold text-blue-600">Inventory Management System</h1>
      <h2 class="text-xl font-semibold text-gray-800">Check & Invoice Tracker</h2>
    </header>

    <div class="flex justify-center border-b border-gray-200 mb-6">
      <button id="invoice-management-tab" class="tab-btn active">Invoice Management</button>
      <button id="paid-invoices-tab" class="tab-btn">Paid Invoices</button>
      <button id="generate-report-tab" class="tab-btn">Generate Report</button>
    </div>

    <!-- Invoice Management -->
    <div id="invoice-management-section" class="tab-content">
      <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Add New Vendor</h3>
        <div class="flex flex-col sm:flex-row gap-4">
          <input type="text" id="newVendorName" placeholder="Enter New Vendor Name" class="flex-grow p-2 border border-gray-300 rounded-md">
          <button id="btnAddVendor" class="bg-purple-600 text-white font-bold py-2 px-6 rounded-md">Add Vendor</button>
        </div>
      </div>
      <div class="bg-gray-50 rounded-lg p-4 mb-4">
        <h3 class="text-lg font-semibold text-gray-800 mb-2">Enter New Invoice Details</h3>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div><label>Vendor</label><select id="addInvoiceVendor" class="w-full p-2 border border-gray-300 rounded-md"></select></div>
          <div><label>Invoice Date</label><input type="date" id="addInvoiceDate" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label>Invoice Number</label><input type="text" id="addInvoiceNumber" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label>Invoice Total ($)</label><input type="number" step="0.01" id="addInvoiceTotal" class="w-full p-2 border border-gray-300 rounded-md"></div>
          <div><label>Check Number</label><input type="text" id="addCheckNumber" class="w-full p-2 border border-gray-300 rounded-md"></div>
        </div>
        <div class="text-center mt-6">
          <button id="btnSaveNewInvoice" class="bg-blue-600 text-white font-bold py-2 px-8 rounded-md">Save New Invoice</button>
        </div>
      </div>
    </div>

    <!-- Paid Invoices -->
    <div id="paid-invoices-section" class="tab-content hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-2">Paid Invoices</h3>
      <div class="flex gap-4 mb-4">
        <label class="font-medium">Filter by Vendor:</label>
        <select id="paidVendorFilter" class="p-2 border border-gray-300 rounded-md">
          <option value="">-- All Vendors --</option>
        </select>
      </div>
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-100">
            <tr>
              <th class="py-2 px-3 text-xs font-semibold">Invoice #</th>
              <th class="py-2 px-3 text-xs font-semibold">Vendor</th>
              <th class="py-2 px-3 text-xs font-semibold">Date</th>
              <th class="py-2 px-3 text-xs font-semibold">Amount</th>
              <th class="py-2 px-3 text-xs font-semibold">Check #</th>
            </tr>
          </thead>
          <tbody id="dgvPaidInvoices" class="bg-white divide-y divide-gray-200">
            <tr><td colspan="5" class="text-center py-4 text-gray-500">No paid invoices.</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Generate Report -->
    <div id="generate-report-section" class="tab-content hidden">
      <h3 class="text-lg font-semibold text-gray-800 mb-4">Generate Monthly Checks Report</h3>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
        <div><label>Start Date</label><input type="date" id="reportStartDate" class="w-full p-2 border border-gray-300 rounded-md"></div>
        <div><label>End Date</label><input type="date" id="reportEndDate" class="w-full p-2 border border-gray-300 rounded-md"></div>
      </div>
      <div class="text-center">
        <button id="btnGenerateReport" class="bg-green-600 text-white font-bold py-2 px-8 rounded-md">Download PDF Report</button>
      </div>
    </div>
  </div>

  <!-- Modal -->
  <div id="custom-modal" class="modal">
    <div class="modal-content">
      <h3 id="modal-title" class="text-lg font-semibold"></h3>
      <p id="modal-message"></p>
      <button id="modal-close-btn" class="bg-blue-600 text-white py-2 px-6 rounded-md">OK</button>
    </div>
  </div>

  <script>
    window.jsPDF = window.jspdf.jsPDF;
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    function showMessageModal(title, msg) {
      document.getElementById("modal-title").textContent = title;
      document.getElementById("modal-message").textContent = msg;
      document.getElementById("custom-modal").style.display = "flex";
    }
    document.getElementById("modal-close-btn").onclick = () => document.getElementById("custom-modal").style.display = "none";

    document.addEventListener("DOMContentLoaded", () => {
      setupTabs();
      loadVendors();
      loadPaidInvoices(); 
      autoSetReportDates();
      document.getElementById("paidVendorFilter").addEventListener("change", loadPaidInvoices);
      document.getElementById("btnSaveNewInvoice").addEventListener("click", saveNewInvoice);
      document.getElementById("btnAddVendor").addEventListener("click", addVendor);
      document.getElementById("btnGenerateReport").addEventListener("click", generateMonthlyChecksReport);
    });

    function setupTabs() {
      const tabs = { "invoice-management-tab":"invoice-management-section", "paid-invoices-tab":"paid-invoices-section", "generate-report-tab":"generate-report-section" };
      const tabButtons = document.querySelectorAll(".tab-btn");
      tabButtons.forEach(button => {
        button.addEventListener("click", () => {
          tabButtons.forEach(btn => btn.classList.remove("active"));
          button.classList.add("active");
          for (const tabId in tabs) document.getElementById(tabs[tabId]).classList.add("hidden");
          document.getElementById(tabs[button.id]).classList.remove("hidden");
        });
      });
    }

    async function loadVendors() {
      const { data: vendors } = await supabase.from("public_vendors").select("vendor_name").order("vendor_name");
      const addVendor = document.getElementById("addInvoiceVendor");
      const paidFilter = document.getElementById("paidVendorFilter");
      addVendor.innerHTML = "";
      paidFilter.innerHTML = '<option value="">-- All Vendors --</option>';
      vendors.forEach(v => {
        if (v.vendor_name !== "AutoChlor") {
          addVendor.add(new Option(v.vendor_name, v.vendor_name));
          paidFilter.add(new Option(v.vendor_name, v.vendor_name));
        }
      });
    }

   async function saveNewInvoice() {
  const vendorName = document.getElementById("addInvoiceVendor").value;
  const invoiceDate = document.getElementById("addInvoiceDate").value;
  const invoiceNumber = document.getElementById("addInvoiceNumber").value;
  const invoiceTotal = parseFloat(document.getElementById("addInvoiceTotal").value);
  const checkNumber = document.getElementById("addCheckNumber").value;

  if (!vendorName || !invoiceDate || !invoiceNumber || isNaN(invoiceTotal) || !checkNumber) {
    showMessageModal("Validation Error", "Fill out all fields including check number.");
    return;
  }

  // ðŸ” Validate check number
  const { data: existing, error: checkError } = await supabase
    .from("public_invoices")
    .select("Id")
    .eq("CheckNumber", checkNumber);

  if (checkError) {
    console.error(checkError);
    showMessageModal("Error", "Failed to validate check number.");
    return;
  }

  if (existing.length > 0) {
    showMessageModal("Duplicate Check", `Check #${checkNumber} already exists.`);
    return;
  }

  // âœ… Insert new invoice as Paid
  const { error } = await supabase.from("public_invoices").insert([{
    VendorName: vendorName,
    InvoiceDate: invoiceDate,
    InvoiceNumber: invoiceNumber,
    InvoiceTotal: invoiceTotal,
    CheckNumber: checkNumber,
    CheckDate: invoiceDate,   // auto-fill
    Status: "Paid"
  }]);

  if (error) {
    console.error(error);
    showMessageModal("Error", "Failed to save invoice.");
  } else {
    showMessageModal("Success", "Invoice saved and marked Paid.");
    loadPaidInvoices(); // refresh paid invoices tab
  }
}


    async function addVendor() {
      const newVendorName = document.getElementById("newVendorName").value.trim();
      if (!newVendorName) {
        showMessageModal('Error', 'Please enter a vendor name.');
        return;
      }
      const { error } = await supabase.from("public_vendors").insert([{ vendor_name: newVendorName }]);
      if (error) {
        console.error(error);
        showMessageModal('Error', 'Failed to add vendor.');
      } else {
        showMessageModal('Success', `${newVendorName} added.`);
        document.getElementById("newVendorName").value = "";
        await loadVendors();
      }
    }

async function loadPaidInvoices() {
  const vendor = document.getElementById("paidVendorFilter").value;
  let query = supabase.from("public_invoices")
    .select("*")
    .eq("Status", "Paid")
    .order("InvoiceDate", { ascending: false });

  if (vendor) query = query.eq("VendorName", vendor);

  const { data: invoices } = await query;
  const tableBody = document.getElementById("dgvPaidInvoices");
  tableBody.innerHTML = "";

  if (!invoices || invoices.length === 0) {
    tableBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No paid invoices.</td></tr>`;
    return;
  }

  let subtotal = 0;

  invoices.forEach(inv => {
    subtotal += Number(inv.InvoiceTotal);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td class="p-3">${inv.InvoiceNumber}</td>
      <td class="p-3">${inv.VendorName}</td>
      <td class="p-3">${new Date(inv.InvoiceDate).toLocaleDateString()}</td>
      <td class="p-3">$${Number(inv.InvoiceTotal).toFixed(2)}</td>
      <td class="p-3">${inv.CheckNumber || ""}</td>
    `;
    tableBody.appendChild(row);
  });

  // ðŸ”¹ Subtotal row
  const subtotalRow = document.createElement("tr");
  subtotalRow.classList.add("bg-gray-100", "font-bold");
  subtotalRow.innerHTML = `
    <td colspan="3" class="p-3 text-right">Subtotal:</td>
    <td class="p-3">$${subtotal.toFixed(2)}</td>
    <td></td>
  `;
  tableBody.appendChild(subtotalRow);
}
    




    function autoSetReportDates() {
      const now = new Date();
      const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
      const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
      document.getElementById("reportStartDate").valueAsDate = firstDay;
      document.getElementById("reportEndDate").valueAsDate = lastDay;
    }

    async function generateMonthlyChecksReport() {
  const startDate = document.getElementById('reportStartDate').value;
  const endDate = document.getElementById('reportEndDate').value;

  if (!startDate || !endDate) {
    showMessageModal("Validation Error", "Select start and end dates.");
    return;
  }

 const { data: paidInvoices, error } = await supabase
  .from("public_invoices")
  .select("*")
  .eq("Status", "Paid")   // only paid invoices
  .gte("InvoiceDate", startDate)
  .lte("InvoiceDate", endDate)
  .order("VendorName", { ascending: true })
  .order("InvoiceDate", { ascending: true });

  if (error || !paidInvoices || paidInvoices.length === 0) {
    showMessageModal("No Data", "No paid invoices for this range.");
    return;
  }

  const { jsPDF } = window.jspdf;
  const doc = new jsPDF("p", "pt", "a4");
  const pageWidth = doc.internal.pageSize.getWidth();
  let y = 60;

  // ðŸ”¹ Add logo
  const logo = new Image();
  logo.src = "https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg";

  await new Promise(resolve => { logo.onload = resolve; });
  doc.addImage(logo, "JPEG", pageWidth / 2 - 40, 10, 80, 60);

  y = 90;
  doc.setFont("helvetica", "bold");
  doc.setFontSize(18);
  doc.text("Inventory Management System", pageWidth / 2, y, { align: "center" });
  y += 20;
  doc.setFontSize(14);
  doc.text("Monthly Checks Report", pageWidth / 2, y, { align: "center" });
  y += 20;
  doc.setFontSize(12);
  doc.text(`Period: ${startDate} to ${endDate}`, pageWidth / 2, y, { align: "center" });
  y += 30;

  // ðŸ”¹ Group invoices by Vendor
  const grouped = paidInvoices.reduce((acc, inv) => {
    (acc[inv.VendorName] = acc[inv.VendorName] || []).push(inv);
    return acc;
  }, {});

  let grandTotal = 0;

  for (const vendor of Object.keys(grouped)) {
    doc.setFillColor(230, 240, 255);
    doc.rect(40, y, pageWidth - 80, 20, "F");
    doc.setFont("helvetica", "bold");
    doc.setFontSize(12);
    doc.text(vendor, 50, y + 14);
    y += 30;

    let subtotal = 0;

    grouped[vendor].forEach((inv, idx) => {
      if (idx % 2 === 0) {
        doc.setFillColor(245, 245, 245);
        doc.rect(40, y - 10, pageWidth - 80, 20, "F");
      }

      subtotal += inv.InvoiceTotal;
      doc.setFont("helvetica", "normal");
      doc.setFontSize(10);
      doc.text(`Invoice#: ${inv.InvoiceNumber}`, 50, y);
      doc.text(`Date: ${new Date(inv.InvoiceDate).toLocaleDateString()}`, 180, y);
      doc.text(`Amount: $${Number(inv.InvoiceTotal).toFixed(2)}`, 330, y);
      doc.text(`Check#: ${inv.CheckNumber}`, 480, y);

      y += 18;
      if (y > doc.internal.pageSize.getHeight() - 60) {
        doc.addPage();
        y = 60;
      }
    });

    grandTotal += subtotal;

    // Vendor subtotal box
    doc.setFont("helvetica", "bold");
    doc.text(`Subtotal: $${subtotal.toFixed(2)}`, pageWidth - 60, y, { align: "right" });
    y += 25;
  }

  // ðŸ”¹ Grand Total
  doc.setFont("helvetica", "bold");
  doc.setFontSize(14);
  doc.setFillColor(200, 230, 200);
  doc.rect(40, y, pageWidth - 80, 30, "F");
  doc.text(`Grand Total: $${grandTotal.toFixed(2)}`, pageWidth - 60, y + 20, { align: "right" });

  doc.save(`JengChi_Checks_Report_${startDate}_to_${endDate}.pdf`);
  showMessageModal("Report Generated", "PDF downloaded.");
}

  </script>
</body>
</html>
