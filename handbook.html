<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif']
          },
          colors: {
            'jc-gold': '#744B3A',
            'jc-border': '#E2E8F0',
            'jc-danger': '#EF4444'
          },
          boxShadow: { soft: '0 10px 30px rgba(0,0,0,.08)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { height: 100%; }
    .btn { @apply rounded-xl border border-jc-border px-3 py-2 text-sm hover:bg-slate-50; }
  </style>
</head>
<body class="h-full font-sans text-slate-800">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-jc-border">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center justify-between gap-3">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi" class="h-8 w-auto rounded bg-white shadow-soft object-contain"/>
        <div>
          <div class="font-serif-head text-xl">Jeng Chi</div>
          <div class="text-xs text-slate-500 -mt-0.5">Enterprise Portal • Executive Access</div>
        </div>
      </div>

      <!-- Controls -->
      <div class="flex items-center gap-2">
        <select id="jumpSelect" class="hidden md:block rounded-xl border border-jc-border px-3 py-2 text-sm min-w-[340px]">
          <option value="">Jump to…</option>
        </select>

        <button id="btnPdf"  class="btn">Download PDF</button>
        <button id="btnDocx" class="btn">Download DOCX</button>
        <button id="btnPrint" class="btn">Print</button>

        <span id="who" class="hidden text-sm bg-slate-100 rounded-xl px-3 py-1"></span>
        <button id="logout" class="hidden btn">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Viewer area -->
  <main class="mx-auto max-w-7xl px-3 sm:px-4 pb-16">
    <div class="relative mt-4 rounded-2xl border border-jc-border bg-white shadow-soft overflow-hidden">
      <!-- iframe with native PDF viewer -->
      <iframe id="pdfFrame" class="w-full" style="height: calc(100vh - 160px);" title="Employee Handbook PDF"></iframe>

      <!-- Lock overlay (shown until login) -->
      <div id="lock"
           class="absolute inset-0 bg-white/70 backdrop-blur grid place-items-center">
        <div class="text-center max-w-sm px-6">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 116 0v3z"/>
          </svg>
          <div class="mt-3 font-serif-head text-2xl">Handbook Locked</div>
          <p class="mt-2 text-slate-600 text-sm">Use the initials and PIN panel to unlock the handbook.</p>
        </div>
      </div>

      <!-- Floating login panel -->
      <div id="loginCard"
           class="absolute top-4 left-4 w-[320px] bg-white border border-jc-border rounded-2xl p-4 shadow-soft">
        <div class="font-serif-head text-lg">Editor Sign In</div>
        <p class="text-xs text-slate-600 mt-0.5">Use your initials and PIN.</p>

        <div class="mt-3 space-y-3">
          <div>
            <label class="block text-xs font-semibold mb-1">Initials</label>
            <input id="initials" class="w-full rounded-xl border border-jc-border px-3 py-2" placeholder="JT or PG" />
          </div>
          <div>
            <label class="block text-xs font-semibold mb-1">PIN</label>
            <input id="pin" type="password" inputmode="numeric" maxlength="8"
                   class="w-full rounded-xl border border-jc-border px-3 py-2" placeholder="e.g., 2316" />
          </div>
          <div class="flex items-center gap-2">
            <button id="login" class="rounded-xl px-4 py-2 text-sm bg-jc-gold text-white hover:opacity-90">Enter</button>
            <span id="loginMsg" class="text-sm"></span>
          </div>
        </div>

        <p class="mt-3 text-[11px] text-slate-500 leading-4">
          Credentials are initials + PIN only. No emails are collected.
        </p>
      </div>
    </div>

    <!-- Footer disclaimer -->
    <p class="text-[11px] text-slate-500 mt-3 text-center">
      © 2025 Jeng Chi Restaurant — All rights reserved. Internal reference only. Unauthorized copying or distribution is prohibited.
    </p>
  </main>

  <!-- Notes FAB -->
  <button id="notesFab"
          class="fixed bottom-5 right-5 rounded-full bg-jc-gold text-white px-4 py-3 shadow-soft hover:opacity-90">
    Notes
  </button>

  <!-- Notes panel -->
  <div id="notesPanel"
       class="hidden fixed bottom-20 right-5 w-[380px] max-h-[65vh] overflow-hidden bg-white border border-jc-border rounded-2xl shadow-soft">
    <div class="px-4 py-3 border-b border-jc-border flex items-center justify-between">
      <div class="font-semibold text-sm">Notes for page <span id="notesForPage">—</span></div>
      <button id="notesClose" class="btn">Close</button>
    </div>

    <div class="px-4 py-3 space-y-3 overflow-y-auto" style="max-height: 55vh;">
      <div id="notesList" class="space-y-2 text-sm"></div>

      <div class="border-t border-jc-border pt-3">
        <div class="text-xs text-slate-500 mb-1">Add a note (confirm your PIN to save):</div>
        <textarea id="noteText" class="w-full h-28 rounded-xl border border-jc-border px-3 py-2 text-sm"></textarea>

        <div class="mt-2 flex items-center gap-2">
          <input id="notePin" type="password" inputmode="numeric" maxlength="8"
                 class="rounded-xl border border-jc-border px-3 py-2 text-sm w-32" placeholder="PIN" />
          <button id="saveNote" class="rounded-xl px-4 py-2 text-sm bg-jc-gold text-white hover:opacity-90">Save note</button>
        </div>

        <div id="notesMsg" class="mt-2 text-sm"></div>
      </div>
    </div>
  </div>

  <script>
    // -------------------- CONFIG --------------------
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PDF_URL  = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";
    const DOCX_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.docx";

    // Section → page map
    const SECTION_INDEX = [
      { title: 'SECTION I – INTRODUCTION', page: 6 },
      { title: '1.1 WELCOME TO JENG CHI RESTAURANT', page: 6 },
      { title: '1.2 EMPLOYEE HANDBOOK', page: 6 },
      { title: '1.3 DISCLAIMER, EMPLOYMENT-AT-WILL & MANAGEMENT APPROVAL AUTHORITY', page: 6 },
      { title: '1.4 APPROVAL AUTHORITY FOR POSITION & PAY CHANGES', page: 7 },
      { title: '1.5 ADMINISTRATION AND CHANGES', page: 8 },
      { title: '1.6 INTERPRETATION; DEVIATION; NO PAST-PRACTICE RIGHTS', page: 8 },
      { title: '1.7 CONFLICTS WITH LAW OR OTHER DOCUMENTS', page: 8 },

      { title: 'SECTION II - EMPLOYMENT POLICIES', page: 9 },
      { title: '2.1 EMPLOYEE CLASSIFICATIONS', page: 9 },
      { title: '2.2 EQUAL EMPLOYMENT OPPORTUNITY (EEO) & AMERICANS WITH DISABILITIES ACT (ADA)', page: 9 },
      { title: '2.3 INTRODUCTORY PERIOD', page: 10 },
      { title: '2.4 REPORTING DISCRIMINATION/HARASSMENT', page: 10 },
      { title: '2.5 REQUIRED CERTIFICATIONS & PAID TRAINING', page: 10 },
      { title: '2.5.1 FOOD SAFETY (FOOD HANDLER – TXDSHS)', page: 10 },
      { title: '2.5.2 ALCOHOL SERVICE (TABC SELLER-SERVER)', page: 11 },
      { title: '2.6 PAID TRAINING – FLSA/TWC COMPLIANCE RULES', page: 11 },
      { title: '2.7 PARKING', page: 11 },
      { title: '2.8 REQUIRED NOTICES AND POSTINGS', page: 12 },

      { title: 'SECTION III - HOURS OF WORK & PAYROLL PRACTICES', page: 13 },
      { title: '3.1 PAY PERIODS & PAYDAYS (TEXAS PAYDAY LAW)', page: 13 },
      { title: '3.2 WORKWEEK & HOURS OF WORK', page: 13 },
      { title: '3.3 TIMEKEEPING (ALL EMPLOYEES)', page: 14 },
      { title: '3.4 TIMEKEEPING: RECORD ALL TRAINING TIME ON YOUR TIMECARD.', page: 14 },
      { title: '3.5 TIMEKEEPING & WAGE COMPLIANCE.', page: 14 },
      { title: '3.6 OVERTIME (NONEXEMPT)', page: 15 },
      { title: '3.7 OVERTIME FOR TIPPED EMPLOYEES (SERVERS)', page: 15 },
      { title: '3.8 MEAL & REST BREAKS', page: 16 },
      { title: '3.9 PAYROLL DEDUCTIONS (TEXAS PAYDAY LAW)', page: 16 },
      { title: '3.10 UNIFORMS & WORK EQUIPMENT (DEDUCTIONS)', page: 16 },
      { title: '3.11 WAGE GARNISHMENTS', page: 17 },
      { title: '3.12 DIRECT DEPOSIT & LOST/RETURNED PAYMENTS', page: 17 },
      { title: '3.13 PAY STATEMENTS & ACCESS (MYTOAST)', page: 17 },
      { title: '3.14 PAYROLL QUESTIONS & DISPUTES', page: 18 },
      { title: '3.15 TIPS & GRATUITIES POLICY (TEXAS) — TIP CREDIT, POOLING, CREDIT-CARD TIPS & PROCESSING FEES', page: 18 },

      { title: 'SECTION IV — STANDARDS OF CONDUCT', page: 20 },
      { title: '4.1 ZERO-TOLERANCE POLICY (SAFETY, INTEGRITY & RESPECT)', page: 20 },
      { title: '4.2 ANTI-HARASSMENT / ANTI-DISCRIMINATION & DIVERSITY', page: 21 },
      { title: '4.3 DIVERSITY & INCLUSION COMMITMENT', page: 21 },
      { title: '4.4 EXAMPLES OF PROHIBITED CONDUCT (NOT EXHAUSTIVE)', page: 21 },
      { title: '4.5 SPEAK-UP & INVESTIGATION POLICY', page: 22 },
      { title: '4.6 OUR INVESTIGATION (WHAT HAPPENS BEHIND THE SCENES)', page: 22 },
      { title: '4.7 ANTI-RETALIATION (ZERO TOLERANCE)', page: 22 },
      { title: '4.8 PROFESSIONAL BOUNDARIES & NO HORSEPLAY', page: 23 },
      { title: '4.9 WORKPLACE SEARCHES & MONITORING', page: 24 },
      { title: '4.10 PERSONAL CELL PHONE & EARBUD POLICY', page: 25 },
      { title: '4.11 NO SMOKING, VAPING, CHEWING GUM, DIPPING', page: 25 },
      { title: '4.12 PERSONAL ERRANDS WHILE ON THE CLOCK', page: 26 },
      { title: '4.13 EMPLOYEE BAR POLICY', page: 26 },
      { title: '4.14 FOH ORDER INTEGRITY & GUEST SERVICE', page: 26 },

      { title: 'SECTION V - DISCIPLINE & CORRECTIVE ACTION', page: 29 },
      { title: '5.1 STANDARD PROGRESSIVE PATH', page: 29 },
      { title: '5.2 CROSS-POLICY PROGRESSION (NO RESET)', page: 29 },
      { title: '5.3 DOCUMENTATION & TIMELINES', page: 30 },
      { title: '5.4 ZERO-TOLERANCE / IMMEDIATE-TERMINATION OFFENSES (EXAMPLES)', page: 30 },
      { title: '5.5 ATTENDANCE & PUNCTUALITY – SPECIFIC LADDER', page: 30 },
      { title: '5.6 FIGHTS, THREATS & WORKPLACE VIOLENCE', page: 31 },
      { title: '5.7 DISHONESTY, THEFT & FRAUD (YOUR REQUESTED RULES)', page: 31 },
      { title: '5.8 UNPROFESSIONAL / DISRESPECTFUL CONDUCT (EMPLOYEES ↔ MANAGERS/OWNERS)', page: 31 },
      { title: '5.9 SOCIAL MEDIA & COMMUNICATIONS', page: 32 },
      { title: '5.10 DRUGS, ALCOHOL & IMPAIRMENT', page: 32 },
      { title: '5.11 HARASSMENT, DISCRIMINATION & RETALIATION', page: 32 },
      { title: '5.12 CORRECTIVE ACTION PLANS (CAPS)', page: 32 },
      { title: '5.13 BENEFITS & PTO ON SEPARATION', page: 33 },
      { title: '5.14 RESIGNATION (TWO-WEEKS’ NOTICE) & HOW TO SUBMIT', page: 33 },
      { title: '5.15 COMPANY ACCEPTANCE / SCHEDULING DURING NOTICE', page: 33 },
      { title: '5.16 CONDUCT DURING NOTICE (DISCIPLINE STILL APPLIES)', page: 33 },
      { title: '5.17 JOB ABANDONMENT (NO-CALL/NO-SHOW)', page: 34 },
      { title: '5.18 DISCIPLINE & CORRECTIVE ACTION (FOH: ORDER INTEGRITY & GUEST SERVICE)', page: 34 },

      { title: 'FAMILY AND MEDICAL LEAVE (FMLA)', page: 37 },
      { title: '6.1 ELIGIBILITY (FMLA)', page: 37 },
      { title: '6.2 QUALIFYING REASONS (FMLA)', page: 37 },
      { title: '6.3 PREGNANCY & CHILDBIRTH — HOW FMLA AND PWFA/ADA INTERACT', page: 37 },
      { title: '6.4 AMOUNT, SCHEDULING & INTERMITTENT LEAVE', page: 38 },
      { title: '6.6 EMPLOYEE NOTICE RESPONSIBILITIES', page: 38 },
      { title: '6.7 MEDICAL CERTIFICATION & FITNESS-FOR-DUTY', page: 39 },
      { title: '6.8 EMPLOYER NOTICES (WHAT YOU’LL RECEIVE)', page: 39 },
      { title: '6.9 PERFORMANCE, CONDUCT & ANTI-RETALIATION', page: 39 },
      { title: '6.10 FRAUD/ABUSE', page: 39 },
      { title: '6.11 CONCURRENT LEAVES & WORKERS’ COMPENSATION', page: 39 },
      { title: '6.12 HOW TO REQUEST FMLA OR PREGNANCY-RELATED ACCOMMODATION', page: 40 },
      { title: '6.13 ADMINISTRATION & QUESTIONS', page: 40 },

      { title: 'DOCTOR’S NOTICE & MEDICAL LEAVE DOCUMENTATION', page: 41 },
      { title: '7.1 WHEN A DOCTOR’S NOTE IS REQUIRED', page: 41 },
      { title: '7.2 HOW TO SUBMIT YOUR DOCTOR’S NOTE', page: 41 },
      { title: '7.3 FMLA SCREENING & PAPERWORK (IF/WHEN WE ARE FMLA-COVERED)', page: 42 },
      { title: '7.4 PREGNANCY, CHILDBIRTH & RELATED CONDITIONS (PWFA/ADA)', page: 42 },
      { title: '7.5 WORKERS’ COMPENSATION & WORK-INJURY NOTES', page: 42 },
      { title: '7.6 PAY, PTO & SCHEDULING DURING MEDICAL LEAVE', page: 43 },
      { title: '7.7 IF DOCUMENTATION IS NOT PROVIDED (DOCTOR’S NOTES, FMLA CERTIFICATION, FITNESS-FOR-DUTY)', page: 43 },
      { title: '7.8 FITNESS-FOR-DUTY (FFD) TO RETURN', page: 44 },
      { title: '7.9 NO RETALIATION / CONSISTENT APPLICATION', page: 44 },

      { title: 'SECTION VIII – EMPLOYEE BENEFITS & SERVICES (OVERVIEW)', page: 45 },
      { title: '8.1 ELIGIBILITY & WAITING PERIOD', page: 45 },
      { title: '8.2 PTO (PAID TIME OFF) — ACCRUAL START', page: 46 },
      { title: '8.3 COORDINATION WITH LEAVE & PAYROLL', page: 46 },
      { title: '8.4 PAYROLL ADVANCE POLICY', page: 46 },
      { title: '8.5 CONDITIONS FOR REQUESTING A PAYROLL ADVANCE', page: 46 },
      { title: '8.6 EMPLOYEE MEAL', page: 47 },
      { title: '8.7 WORKER COMPENSATION INSURANCE.', page: 48 },
      { title: '8.8 EMPLOYEE TIME OFF', page: 48 },
      { title: '8.9 VACATION POLICY', page: 48 },
      { title: '8.10 USE AND MANAGEMENT OF PTO', page: 49 },
      { title: '8.11 REQUEST TO USE PTO', page: 50 },
      { title: '8.12 PAID TIME OFF (PTO) – FULL-TIME EMPLOYEES (≥30 HRS./WK.)', page: 50 },
      { title: '8.13 REQUESTING & SCHEDULING PTO', page: 52 },
      { title: '8.14 PAY & FLSA GUARDRAILS', page: 52 }
    ];

    // -------------------- DOM --------------------
    const pdfFrame  = document.getElementById('pdfFrame');
    const lock      = document.getElementById('lock');
    const loginCard = document.getElementById('loginCard');
    const initials  = document.getElementById('initials');
    const pin       = document.getElementById('pin');
    const loginBtn  = document.getElementById('login');
    const loginMsg  = document.getElementById('loginMsg');
    const who       = document.getElementById('who');
    const logoutBtn = document.getElementById('logout');

    const jumpSelect = document.getElementById('jumpSelect');
    const btnPdf  = document.getElementById('btnPdf');
    const btnDocx = document.getElementById('btnDocx');
    const btnPrint = document.getElementById('btnPrint');

    const notesFab    = document.getElementById('notesFab');
    const notesPanel  = document.getElementById('notesPanel');
    const notesClose  = document.getElementById('notesClose');
    const notesForPage= document.getElementById('notesForPage');
    const notesList   = document.getElementById('notesList');
    const noteText    = document.getElementById('noteText');
    const notePin     = document.getElementById('notePin');
    const saveNoteBtn = document.getElementById('saveNote');
    const notesMsg    = document.getElementById('notesMsg');

    let session = null;       // { initials, is_owner }
    let currentPage = 1;
    let currentSectionTitle = '';

    const toast = (el, msg, ok=false) => {
      el.textContent = msg;
      el.className = `text-sm ${ok ? 'text-green-700' : 'text-jc-danger'}`;
      setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 3500);
    };

    // -------------------- UI helpers --------------------
    function setSession(s){
      session = s;
      if(s){
        localStorage.setItem('hb_session', JSON.stringify(s));
        who.textContent = `Logged in: ${s.initials}`;
        who.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');
        lock.classList.add('hidden');
        loginCard.classList.add('hidden');
        jumpSelect.disabled = false;
        btnPdf.disabled = btnDocx.disabled = btnPrint.disabled = false;
        // show first page (intro) on unlock if not already set
        if(!currentPage) jumpTo(6, 'SECTION I – INTRODUCTION');
      }else{
        localStorage.removeItem('hb_session');
        who.classList.add('hidden');
        logoutBtn.classList.add('hidden');
        lock.classList.remove('hidden');
        loginCard.classList.remove('hidden');
        jumpSelect.disabled = true;
        btnPdf.disabled = btnDocx.disabled = btnPrint.disabled = true;
      }
    }

    function restore(){
      const raw = localStorage.getItem('hb_session');
      if(!raw) return setSession(null);
      try { setSession(JSON.parse(raw)); } catch { setSession(null); }
    }

    function jumpTo(page, title=''){
      currentPage = page;
      currentSectionTitle = title || currentSectionTitle || '';
      pdfFrame.src = PDF_URL + '#page=' + encodeURIComponent(page);
      notesForPage.textContent = 'p.' + page;
      // fetch notes for that page (if logged in)
      if(session) loadNotes(page);
    }

    function fillDropdown(){
      jumpSelect.innerHTML = '<option value="">Jump to…</option>';
      SECTION_INDEX.forEach((s,i)=>{
        const opt = document.createElement('option');
        opt.value = s.page;
        opt.textContent = s.title + ` (p.${s.page})`;
        jumpSelect.appendChild(opt);
      });
    }

    // -------------------- Auth --------------------
    loginBtn.addEventListener('click', async () => {
      const u = (initials.value || '').trim().toUpperCase();
      const p = (pin.value || '').trim();
      if(!u || !p){ toast(loginMsg, 'Enter initials & PIN.'); return; }

      const { data: rows, error } = await client.rpc('hb_login', { p_initials: u, p_pin: p });
      if(error){ toast(loginMsg, error.message); return; }
      if(!rows || rows.length === 0){ toast(loginMsg, 'Invalid initials or PIN.'); return; }

      const row = rows[0] || {};
      const is_owner = typeof row.is_owner === 'boolean' ? row.is_owner : (u === 'JT' || u === 'PG');
      setSession({ initials: u, is_owner });
      toast(loginMsg, 'Unlocked.', true);

      // default jump to first TOC item if the dropdown has one
      if(SECTION_INDEX.length) jumpTo(SECTION_INDEX[0].page, SECTION_INDEX[0].title);
    });

    logoutBtn.addEventListener('click', () => setSession(null));

    // -------------------- Jump / download / print --------------------
    jumpSelect.addEventListener('change', () => {
      const page = Number(jumpSelect.value || '0');
      if(!page) return;
      const item = SECTION_INDEX.find(s => s.page === page) || { title: '' };
      jumpTo(page, item.title);
    });

    btnPdf.addEventListener('click', ()=> window.open(PDF_URL, '_blank'));
    btnDocx.addEventListener('click',()=> window.open(DOCX_URL,'_blank'));
    btnPrint.addEventListener('click',()=> {
      // opens native viewer in new tab, user prints from there
      window.open(PDF_URL + '#page=' + currentPage, '_blank');
    });

    // -------------------- Notes --------------------
    notesFab.addEventListener('click', () => {
      if(!session){ alert('Unlock with initials & PIN first.'); return; }
      notesPanel.classList.remove('hidden');
      loadNotes(currentPage);
    });
    notesClose.addEventListener('click', () => notesPanel.classList.add('hidden'));

    async function loadNotes(page){
      const { data, error } = await client
        .from('hb_notes')
        .select('*')
        .eq('page', page)
        .order('created_at', { ascending: true });
      if(error){ notesList.innerHTML = `<div class="text-jc-danger text-sm">${error.message}</div>`; return; }
      renderNotes(data || []);
    }

    function renderNotes(list){
      notesList.innerHTML = '';
      if(list.length === 0){
        notesList.innerHTML = `<div class="text-slate-500 text-sm">No notes on this page yet.</div>`;
        return;
      }
      list.forEach(n=>{
        const row = document.createElement('div');
        row.className = 'rounded-xl border border-jc-border px-3 py-2 flex items-start justify-between gap-3';
        const left = document.createElement('div');
        left.innerHTML = `
          <div class="text-xs text-slate-500 mb-1">
            <span class="font-semibold">${n.author_initials}</span>
            • ${new Date(n.created_at).toLocaleString()}
            ${n.section ? ` • <span class="italic">${n.section}</span>` : ''}
          </div>
          <div class="${n.resolved ? 'line-through text-slate-500' : ''} whitespace-pre-wrap">${n.body}</div>
        `;
        const right = document.createElement('div');
        right.className = 'shrink-0 flex flex-col items-end gap-2';
        const status = document.createElement('div');
        status.className = 'text-xs ' + (n.resolved ? 'text-green-700' : 'text-amber-700');
        status.textContent = n.resolved ? `Resolved by ${n.resolved_by || ''}` : 'Open';
        const btn = document.createElement('button');
        btn.className = 'btn';
        btn.textContent = n.resolved ? 'Mark open' : 'Mark resolved';
        btn.onclick = async ()=>{
          if(!notePin.value){ toast(notesMsg, 'Enter PIN to update.', false); return; }
          const { error } = await client.rpc('hb_resolve_note', {
            p_initials: session.initials,
            p_pin: notePin.value,
            p_id: n.id,
            p_resolved: !n.resolved
          });
          if(error){ toast(notesMsg, error.message, false); return; }
          notePin.value = '';
          loadNotes(currentPage);
        };
        right.appendChild(status);
        right.appendChild(btn);
        row.appendChild(left);
        row.appendChild(right);
        notesList.appendChild(row);
      });
    }

    saveNoteBtn.addEventListener('click', async () => {
      if(!session){ toast(notesMsg, 'Unlock first.'); return; }
      const txt = (noteText.value || '').trim();
      const pinC = (notePin.value || '').trim();
      if(!txt){ toast(notesMsg, 'Enter a note.'); return; }
      if(!pinC){ toast(notesMsg, 'Enter your PIN to save.'); return; }

      const { error } = await client.rpc('hb_add_note', {
        p_initials: session.initials,
        p_pin: pinC,
        p_page: currentPage,
        p_section: currentSectionTitle || '',
        p_body: txt
      });
      if(error){ toast(notesMsg, error.message); return; }
      noteText.value = ''; notePin.value = '';
      toast(notesMsg, 'Saved.', true);
      loadNotes(currentPage);
    });

    // -------------------- init --------------------
    (function init(){
      fillDropdown();
      // before login, show a blank frame (or a title page if you want)
      pdfFrame.src = 'about:blank';
      setSession(null);
      restore();
      if(session){
        // default to first section
        jumpTo(SECTION_INDEX[0].page, SECTION_INDEX[0].title);
      }
    })();
  </script>
</body>
</html>
