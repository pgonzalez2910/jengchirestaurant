<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Jeng Chi â€” Employee Handbook</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-primary': '#2D3748',
            'jc-brown':   '#744B3A',
            'jc-border':  '#E2E8F0',
          },
          boxShadow: {
            soft: '0 10px 30px rgba(0,0,0,.08)'
          }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    /* keep the login card above the viewer toolbar */
    .stack { isolation: isolate; }
  </style>
</head>
<body class="h-full font-sans text-slate-800 stack">
  <!-- Header -->
  <header class="sticky top-0 z-20 bg-white/80 backdrop-blur border-b border-jc-border">
    <div class="max-w-[1400px] mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi" class="h-8 w-auto rounded bg-white shadow" />
        <div class="leading-tight">
          <div class="text-lg font-semibold text-jc-primary">Jeng Chi</div>
          <div class="text-xs text-slate-500">Enterprise Portal â€¢ Executive Access</div>
        </div>
      </div>

      <!-- Top controls (enabled after login) -->
      <div class="flex items-center gap-2">
        <button id="btnPdf"  class="px-3 py-2 text-sm rounded-lg border border-jc-border bg-white hover:bg-slate-50 disabled:opacity-40" disabled>Download PDF</button>
        <button id="btnDocx" class="px-3 py-2 text-sm rounded-lg border border-jc-border bg-white hover:bg-slate-50 disabled:opacity-40" disabled>Download DOCX</button>
        <button id="btnPrint" class="px-3 py-2 text-sm rounded-lg border border-jc-border bg-white hover:bg-slate-50 disabled:opacity-40" disabled>Print</button>
        <span id="whoBadge" class="hidden text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700"></span>
        <button id="btnLogout" class="hidden px-3 py-2 text-sm rounded-lg border border-jc-border bg-white hover:bg-slate-50">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-[1400px] mx-auto px-4 py-4">
    <!-- Jump to (appears after login) -->
    <div id="jumpRow" class="hidden mb-3 flex items-center gap-2">
      <label for="jumpSelect" class="text-sm text-slate-600">Jump to</label>
      <select id="jumpSelect" class="w-[520px] max-w-full rounded-lg border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-brown/30"></select>
      <span id="viewerMeta" class="text-xs text-slate-500"></span>
    </div>

    <!-- Viewer -->
    <div class="relative">
      <!-- The PDF iframe -->
      <iframe id="pdfFrame" title="Employee Handbook"
              class="w-full h-[78vh] rounded-2xl border border-jc-border bg-white shadow-soft"
              src=""
              loading="lazy"></iframe>

      <!-- Locked overlay (shown before login) -->
      <div id="lockedOverlay" class="absolute inset-0 grid place-items-center rounded-2xl bg-white/80 backdrop-blur border border-jc-border">
        <div class="text-center max-w-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-14 w-14 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 116 0v3z"/>
          </svg>
          <h3 class="mt-3 text-xl font-semibold text-jc-primary">Handbook Locked</h3>
          <p class="mt-1 text-slate-600 text-sm">Sign in with your initials and PIN to view and download the Employee Handbook.</p>
        </div>
      </div>

      <!-- Floating login panel -->
      <div class="absolute left-3 top-3 w-[280px]">
        <div id="loginCard" class="rounded-2xl border border-jc-border bg-white/95 backdrop-blur p-4 shadow-soft">
          <div class="font-semibold text-sm mb-1">Editor Sign In</div>
          <p class="text-xs text-slate-600 mb-3">Use your initials and PIN.</p>
          <div class="space-y-2">
            <input id="inpInitials" class="w-full rounded-lg border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-brown/30" placeholder="Initials" />
            <input id="inpPin" type="password" inputmode="numeric" maxlength="8"
                   class="w-full rounded-lg border border-jc-border px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-jc-brown/30" placeholder="PIN" />
            <div class="flex items-center gap-2">
              <button id="btnLogin" class="px-3 py-2 text-sm rounded-lg bg-jc-brown text-white hover:opacity-90">Enter</button>
              <span id="loginMsg" class="text-xs"></span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="mt-4 text-xs text-slate-500">
      Â© 2025 Jeng Chi Restaurant â€” All rights reserved. Internal reference only. Unauthorized copying or distribution is prohibited.
    </div>
  </main>

  <script>
    // ===================== CONFIG =====================
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Storage bucket + filenames
    const BUCKET    = "HANDBOOK";
    const PDF_PATH  = "Handbook 2026.pdf";   // ðŸ” change if your filename is different
    const DOCX_PATH = "Handbook 2026.docx";

    // If bucket is PRIVATE, keep this true to generate signed URLs after login.
    // If bucket is PUBLIC, set to false and use the public URLs below.
    const USE_SIGNED_URLS = true;

    // (Only when public bucket)
    const PUBLIC_PDF_URL  = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";
    const PUBLIC_DOCX_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.docx";

    // Section index (title â†’ starting page in PDF)
    const SECTION_INDEX = [
      { title: 'SECTION I â€“ INTRODUCTION', page: 6 },
      { title: '1.1 WELCOME TO JENG CHI RESTAURANT', page: 6 },
      { title: '1.2 EMPLOYEE HANDBOOK', page: 6 },
      { title: '1.3 DISCLAIMER, EMPLOYMENT-AT-WILL & MANAGEMENT APPROVAL AUTHORITY', page: 6 },
      { title: '1.4 APPROVAL AUTHORITY FOR POSITION & PAY CHANGES', page: 7 },
      { title: '1.5 ADMINISTRATION AND CHANGES', page: 8 },
      { title: '1.6 INTERPRETATION; DEVIATION; NO PAST-PRACTICE RIGHTS', page: 8 },
      { title: '1.7 CONFLICTS WITH LAW OR OTHER DOCUMENTS', page: 8 },

      { title: 'SECTION II - EMPLOYMENT POLICIES', page: 9 },
      { title: '2.1 EMPLOYEE CLASSIFICATIONS', page: 9 },
      { title: '2.2 EEO & AMERICANS WITH DISABILITIES ACT (ADA)', page: 9 },
      { title: '2.3 INTRODUCTORY PERIOD', page: 10 },
      { title: '2.4 REPORTING DISCRIMINATION/HARASSMENT', page: 10 },
      { title: '2.5 REQUIRED CERTIFICATIONS & PAID TRAINING', page: 10 },
      { title: '2.5.1 FOOD SAFETY (FOOD HANDLER â€“ TXDSHS)', page: 10 },
      { title: '2.5.2 ALCOHOL SERVICE (TABC SELLER-SERVER)', page: 11 },
      { title: '2.6 PAID TRAINING â€“ FLSA/TWC COMPLIANCE RULES', page: 11 },
      { title: '2.7 PARKING', page: 11 },
      { title: '2.8 REQUIRED NOTICES AND POSTINGS', page: 12 },

      { title: 'SECTION III - HOURS OF WORK & PAYROLL PRACTICES', page: 13 },
      { title: '3.1 PAY PERIODS & PAYDAYS (TEXAS PAYDAY LAW)', page: 13 },
      { title: '3.2 WORKWEEK & HOURS OF WORK', page: 13 },
      { title: '3.3 TIMEKEEPING (ALL EMPLOYEES)', page: 14 },
      { title: '3.4 TIMEKEEPING: RECORD ALL TRAINING TIME', page: 14 },
      { title: '3.5 TIMEKEEPING & WAGE COMPLIANCE', page: 14 },
      { title: '3.6 OVERTIME (NONEXEMPT)', page: 15 },
      { title: '3.7 OVERTIME FOR TIPPED EMPLOYEES (SERVERS)', page: 15 },
      { title: '3.8 MEAL & REST BREAKS', page: 16 },
      { title: '3.9 PAYROLL DEDUCTIONS (TEXAS PAYDAY LAW)', page: 16 },
      { title: '3.10 UNIFORMS & WORK EQUIPMENT (DEDUCTIONS)', page: 16 },
      { title: '3.11 WAGE GARNISHMENTS', page: 17 },
      { title: '3.12 DIRECT DEPOSIT & LOST/RETURNED PAYMENTS', page: 17 },
      { title: '3.13 PAY STATEMENTS & ACCESS (MYTOAST)', page: 17 },
      { title: '3.14 PAYROLL QUESTIONS & DISPUTES', page: 18 },
      { title: '3.15 TIPS & GRATUITIES POLICY (TEXAS)', page: 18 },

      { title: 'SECTION IV â€” STANDARDS OF CONDUCT', page: 20 },
      { title: '4.1 ZERO-TOLERANCE POLICY (SAFETY, INTEGRITY & RESPECT)', page: 20 },
      { title: '4.2 ANTI-HARASSMENT / ANTI-DISCRIMINATION & DIVERSITY', page: 21 },
      { title: '4.3 DIVERSITY & INCLUSION COMMITMENT', page: 21 },
      { title: '4.4 EXAMPLES OF PROHIBITED CONDUCT', page: 21 },
      { title: '4.5 SPEAK-UP & INVESTIGATION POLICY', page: 22 },
      { title: '4.6 OUR INVESTIGATION', page: 22 },
      { title: '4.7 ANTI-RETALIATION', page: 22 },
      { title: '4.8 PROFESSIONAL BOUNDARIES & NO HORSEPLAY', page: 23 },
      { title: '4.9 WORKPLACE SEARCHES & MONITORING', page: 24 },
      { title: '4.10 PERSONAL CELL PHONE & EARBUD POLICY', page: 25 },
      { title: '4.11 NO SMOKING / VAPING / GUM / DIP', page: 25 },
      { title: '4.12 PERSONAL ERRANDS ON THE CLOCK', page: 26 },
      { title: '4.13 EMPLOYEE BAR POLICY', page: 26 },
      { title: '4.14 FOH ORDER INTEGRITY & GUEST SERVICE', page: 26 },

      { title: 'SECTION V - DISCIPLINE & CORRECTIVE ACTION', page: 29 },
      { title: '5.1 STANDARD PROGRESSIVE PATH', page: 29 },
      { title: '5.2 CROSS-POLICY PROGRESSION (NO RESET)', page: 29 },
      { title: '5.3 DOCUMENTATION & TIMELINES', page: 30 },
      { title: '5.4 ZERO-TOLERANCE / IMMEDIATE TERMINATION', page: 30 },
      { title: '5.5 ATTENDANCE & PUNCTUALITY LADDER', page: 30 },
      { title: '5.6 FIGHTS, THREATS & WORKPLACE VIOLENCE', page: 31 },
      { title: '5.7 DISHONESTY, THEFT & FRAUD', page: 31 },
      { title: '5.8 UNPROFESSIONAL / DISRESPECTFUL CONDUCT', page: 31 },
      { title: '5.9 SOCIAL MEDIA & COMMUNICATIONS', page: 32 },
      { title: '5.10 DRUGS, ALCOHOL & IMPAIRMENT', page: 32 },
      { title: '5.11 HARASSMENT / DISCRIMINATION / RETALIATION', page: 32 },
      { title: '5.12 CORRECTIVE ACTION PLANS (CAPS)', page: 32 },
      { title: '5.13 BENEFITS & PTO ON SEPARATION', page: 33 },
      { title: '5.14 RESIGNATION & HOW TO SUBMIT', page: 33 },
      { title: '5.15 COMPANY ACCEPTANCE / SCHEDULING', page: 33 },
      { title: '5.16 CONDUCT DURING NOTICE', page: 33 },
      { title: '5.17 JOB ABANDONMENT (NO-CALL/NO-SHOW)', page: 34 },
      { title: '5.18 FOH: ORDER INTEGRITY & GUEST SERVICE', page: 34 },

      { title: 'FAMILY AND MEDICAL LEAVE (FMLA)', page: 37 },
      { title: '6.1 ELIGIBILITY (FMLA)', page: 37 },
      { title: '6.2 QUALIFYING REASONS (FMLA)', page: 37 },
      { title: '6.3 PREGNANCY & CHILDBIRTH â€” FMLA / PWFA / ADA', page: 37 },
      { title: '6.4 AMOUNT, SCHEDULING & INTERMITTENT LEAVE', page: 38 },
      { title: '6.6 EMPLOYEE NOTICE RESPONSIBILITIES', page: 38 },
      { title: '6.7 MEDICAL CERTIFICATION & FITNESS-FOR-DUTY', page: 39 },
      { title: '6.8 EMPLOYER NOTICES', page: 39 },
      { title: '6.9 PERFORMANCE, CONDUCT & ANTI-RETALIATION', page: 39 },
      { title: '6.10 FRAUD/ABUSE', page: 39 },
      { title: '6.11 CONCURRENT LEAVES & WORKERSâ€™ COMP', page: 39 },
      { title: '6.12 HOW TO REQUEST FMLA OR PREGNANCY ACCOMMODATION', page: 40 },
      { title: '6.13 ADMINISTRATION & QUESTIONS', page: 40 },

      { title: 'DOCTORâ€™S NOTICE & MEDICAL LEAVE DOCUMENTATION', page: 41 },
      { title: '7.1 WHEN A DOCTORâ€™S NOTE IS REQUIRED', page: 41 },
      { title: '7.2 HOW TO SUBMIT YOUR DOCTORâ€™S NOTE', page: 41 },
      { title: '7.3 FMLA SCREENING & PAPERWORK', page: 42 },
      { title: '7.4 PREGNANCY, CHILDBIRTH & RELATED CONDITIONS', page: 42 },
      { title: '7.5 WORKERSâ€™ COMPENSATION & WORK-INJURY NOTES', page: 42 },
      { title: '7.6 PAY, PTO & SCHEDULING DURING MEDICAL LEAVE', page: 43 },
      { title: '7.7 IF DOCUMENTATION IS NOT PROVIDED', page: 43 },
      { title: '7.8 FITNESS-FOR-DUTY (FFD) TO RETURN', page: 44 },
      { title: '7.9 NO RETALIATION / CONSISTENT APPLICATION', page: 44 },

      { title: 'SECTION VIII â€“ EMPLOYEE BENEFITS & SERVICES (OVERVIEW)', page: 45 },
      { title: '8.1 ELIGIBILITY & WAITING PERIOD', page: 45 },
      { title: '8.2 PTO â€” ACCRUAL START', page: 46 },
      { title: '8.3 COORDINATION WITH LEAVE & PAYROLL', page: 46 },
      { title: '8.4 PAYROLL ADVANCE POLICY', page: 46 },
      { title: '8.5 CONDITIONS FOR REQUESTING A PAYROLL ADVANCE', page: 46 },
      { title: '8.6 EMPLOYEE MEAL', page: 47 },
      { title: '8.7 WORKER COMPENSATION INSURANCE', page: 48 },
      { title: '8.8 EMPLOYEE TIME OFF', page: 48 },
      { title: '8.9 VACATION POLICY', page: 48 },
      { title: '8.10 USE AND MANAGEMENT OF PTO', page: 49 },
      { title: '8.11 REQUEST TO USE PTO', page: 50 },
      { title: '8.12 PTO â€“ FULL-TIME EMPLOYEES (â‰¥30 HRS/WK)', page: 50 },
      { title: '8.13 REQUESTING & SCHEDULING PTO', page: 52 },
      { title: '8.14 PAY & FLSA GUARDRAILS', page: 52 }
    ];

    // ===================== DOM refs =====================
    const pdfFrame   = document.getElementById('pdfFrame');
    const locked     = document.getElementById('lockedOverlay');
    const loginCard  = document.getElementById('loginCard');
    const inpInitials= document.getElementById('inpInitials');
    const inpPin     = document.getElementById('inpPin');
    const btnLogin   = document.getElementById('btnLogin');
    const loginMsg   = document.getElementById('loginMsg');
    const whoBadge   = document.getElementById('whoBadge');
    const btnLogout  = document.getElementById('btnLogout');

    const jumpRow    = document.getElementById('jumpRow');
    const jumpSelect = document.getElementById('jumpSelect');
    const viewerMeta = document.getElementById('viewerMeta');

    const btnPdf     = document.getElementById('btnPdf');
    const btnDocx    = document.getElementById('btnDocx');
    const btnPrint   = document.getElementById('btnPrint');

    // ===================== State =====================
    let session = null;                 // { initials, is_owner? } â€” RPC decides access
    let currentPdfUrl = '';
    let currentDocxUrl = '';
    let urlRefreshTimer = null;

    // ===================== Helpers =====================
    function toast(msg, ok=false){
      loginMsg.textContent = msg;
      loginMsg.className = 'text-xs ' + (ok ? 'text-green-700' : 'text-red-600');
      setTimeout(()=>{ loginMsg.textContent=''; loginMsg.className='text-xs'; }, 3500);
    }

    function uiLock(){
      pdfFrame.src = '';
      locked.classList.remove('hidden');
      loginCard.classList.remove('hidden');
      jumpRow.classList.add('hidden');
      btnPdf.disabled = btnDocx.disabled = btnPrint.disabled = true;
      whoBadge.classList.add('hidden');
      btnLogout.classList.add('hidden');
      if(urlRefreshTimer){ clearInterval(urlRefreshTimer); urlRefreshTimer = null; }
    }

    function uiUnlock(){
      locked.classList.add('hidden');
      loginCard.classList.add('hidden');
      jumpRow.classList.remove('hidden');
      btnPdf.disabled = btnDocx.disabled = btnPrint.disabled = false;
      whoBadge.classList.remove('hidden');
      btnLogout.classList.remove('hidden');
    }

    function fillJumpMenu(){
      jumpSelect.innerHTML = '';
      SECTION_INDEX.forEach((s,i)=>{
        const opt = document.createElement('option');
        opt.value = s.page;
        opt.textContent = s.title + ` (p.${s.page})`;
        if(i===0) opt.selected = true;
        jumpSelect.appendChild(opt);
      });
    }

    function openToPage(page){
      const hash = `#page=${page}&view=FitH`;
      pdfFrame.src = currentPdfUrl + hash;
      viewerMeta.textContent = `PDF viewer â€” page ${page}`;
    }

    async function resolveHandbookUrls(){
      if(!USE_SIGNED_URLS){
        currentPdfUrl  = PUBLIC_PDF_URL;
        currentDocxUrl = PUBLIC_DOCX_URL;
        return;
      }
      const pdf  = await client.storage.from(BUCKET).createSignedUrl(PDF_PATH, 60 * 15);
      const docx = await client.storage.from(BUCKET).createSignedUrl(DOCX_PATH, 60 * 15);
      if(pdf.error)  throw pdf.error;
      if(docx.error) throw docx.error;
      currentPdfUrl  = pdf.data.signedUrl;
      currentDocxUrl = docx.data.signedUrl;

      // Refresh signed URLs a bit before they expire
      if(urlRefreshTimer){ clearInterval(urlRefreshTimer); }
      urlRefreshTimer = setInterval(async ()=>{
        try{ await resolveHandbookUrls(); }catch(_e){}
      }, 60 * 13 * 1000); // refresh every 13 min
    }

    async function mountViewer(){
      await resolveHandbookUrls();
      fillJumpMenu();
      openToPage(SECTION_INDEX[0]?.page ?? 1);
      btnPdf.onclick  = ()=> window.open(currentPdfUrl, '_blank');
      btnDocx.onclick = ()=> window.open(currentDocxUrl, '_blank');
      btnPrint.onclick= ()=> window.open(currentPdfUrl + '#toolbar=0', '_blank');
    }

    function setSession(s){
      session = s;
      if(s){
        localStorage.setItem('hb_session', JSON.stringify(s));
        whoBadge.textContent = `Logged in: ${s.initials}`;
        uiUnlock();
        mountViewer().catch(e=>toast(e.message));
      }else{
        localStorage.removeItem('hb_session');
        uiLock();
      }
    }

    function restoreSession(){
      try{
        const raw = localStorage.getItem('hb_session');
        if(!raw) return uiLock();
        setSession(JSON.parse(raw));
      }catch{ uiLock(); }
    }

    // ===================== Events =====================
    btnLogin.addEventListener('click', async ()=>{
      const initials = (inpInitials.value||'').trim().toUpperCase();
      const pin      = (inpPin.value||'').trim();
      if(!initials || !pin){ toast('Enter initials and PIN'); return; }

      // Your RPC validates (no emails stored anywhere)
      const { data: rows, error } = await client.rpc('hb_login', { p_initials: initials, p_pin: pin });
      if(error){ toast(error.message); return; }
      if(!rows || rows.length===0){ toast('Invalid initials or PIN'); return; }

      const row = rows[0] || {};
      const is_owner = typeof row.is_owner === 'boolean' ? row.is_owner : (initials==='JT' || initials==='PG');
      setSession({ initials, is_owner });
      toast('Unlocked', true);
    });

    btnLogout.addEventListener('click', ()=> setSession(null));

    jumpSelect.addEventListener('change', ()=>{
      const page = parseInt(jumpSelect.value,10) || 1;
      openToPage(page);
    });

    // ===================== Init =====================
    restoreSession();
  </script>
</body>
</html>
