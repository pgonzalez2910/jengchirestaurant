<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#2D3748',
            'jc-secondary': '#4A5568',
            'jc-gold': '#744B3A',
            'jc-border': '#E2E8F0',
            'jc-danger': '#EF4444'
          },
          boxShadow: { soft: '0 8px 30px rgba(0,0,0,.06)' }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    [x-cloak]{ display:none!important; }
    .btn { @apply rounded-xl border px-3 py-2 text-sm hover:bg-slate-50 transition; }
    .btn-primary { @apply bg-jc-gold text-white border-jc-gold hover:opacity-90; }
    .card { @apply bg-white border border-jc-border rounded-2xl shadow-soft; }
    .label { @apply text-xs uppercase tracking-wide text-slate-500 font-semibold; }
  </style>
</head>

<body class="h-full text-slate-800 font-sans">
  <!-- Header -->
  <header class="border-b border-jc-border bg-white/80 backdrop-blur sticky top-0 z-10">
    <div class="mx-auto max-w-7xl px-4 py-4 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo" class="h-10 w-auto rounded-md shadow-soft object-contain bg-white"/>
        <div>
          <h1 class="font-serif-head text-2xl text-jc-primary leading-tight">Jeng Chi</h1>
          <p class="text-sm text-slate-500 leading-none">Enterprise Portal • Executive Access</p>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <span id="whoLabel" class="hidden text-sm text-slate-600 bg-slate-100 rounded-xl px-3 py-1"></span>
        <button id="logoutBtn" class="hidden btn">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Layout -->
  <main class="mx-auto max-w-7xl px-4 py-6 grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Left Column -->
    <aside class="lg:col-span-4 space-y-4">
      <!-- Sign in -->
      <div class="card p-5">
        <h2 class="font-serif-head text-xl text-jc-primary mb-1">Editor Sign In</h2>
        <p class="text-sm text-slate-600 mb-4">Use your initials and PIN.</p>
        <div class="space-y-3">
          <div>
            <label class="label mb-1" for="loginInitials">Initials</label>
            <input id="loginInitials" class="w-full rounded-xl border border-jc-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-jc-gold/30" />
          </div>
          <div>
            <label class="label mb-1" for="loginPin">PIN</label>
            <input id="loginPin" type="password" inputmode="numeric" maxlength="8" class="w-full rounded-xl border border-jc-border px-3 py-2 focus:outline-none focus:ring-2 focus:ring-jc-gold/30" />
          </div>
          <div class="flex items-center gap-3">
            <button id="loginBtn" class="btn-primary">Enter</button>
            <div id="loginMsg" class="text-sm"></div>
          </div>
        </div>
      </div>

      <!-- Sections list (read-only quick nav) -->
      <div class="card p-5">
        <h3 class="font-semibold mb-2">Sections</h3>
        <ul id="sectionsList" class="space-y-1 text-sm"></ul>
      </div>

      <!-- Tools (open / download / print) -->
      <div id="viewerTools" class="hidden card p-5">
        <h3 class="font-semibold mb-2">Viewer</h3>
        <div class="flex flex-wrap gap-2">
          <a id="openOriginal" class="btn" target="_blank" rel="noopener">Open original</a>
          <a id="downloadPdf" class="btn" download>Download PDF</a>
          <button id="printBtn" class="btn">Print</button>
        </div>
      </div>

      <!-- Disclaimer / Copyright -->
      <div class="text-xs text-slate-500 px-1">
        <p class="mb-1"><strong>Disclaimer.</strong> This portal and handbook contain proprietary, confidential information of Jeng Chi Restaurant and are intended for authorized managers only. Do not copy, distribute, or disclose without written permission.</p>
        <p>© 2025 Jeng Chi Restaurant • All rights reserved.</p>
      </div>
    </aside>

    <!-- Right Column -->
    <section class="lg:col-span-8 space-y-4">
      <!-- LOCKED state -->
      <div id="lockedCard" class="card p-10 grid place-items-center">
        <div class="text-center max-w-md">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 116 0v3z"/>
          </svg>
          <h3 class="mt-4 font-serif-head text-2xl text-jc-primary">Handbook Locked</h3>
          <p class="mt-2 text-slate-600">Enter your initials and PIN on the left to unlock and view the Employee Handbook.</p>
        </div>
      </div>

      <!-- CONTENT state -->
      <div id="contentCard" class="hidden card overflow-hidden">
        <!-- Top bar -->
        <div class="flex items-center justify-between gap-3 px-4 py-3 border-b bg-white">
          <div>
            <h2 class="font-serif-head text-xl text-jc-primary">Employee Handbook</h2>
            <p id="hbMeta" class="text-xs text-slate-500"></p>
          </div>
        </div>
        <!-- PDF / DOCX viewer -->
        <div class="h-[70vh]">
          <iframe id="docFrame" class="w-full h-full" frameborder="0" referrerpolicy="no-referrer"></iframe>
        </div>
      </div>

      <!-- Comments -->
      <div id="commentsCard" class="hidden card p-5">
        <h3 class="font-semibold mb-2">Comments</h3>
        <div id="commentForm" class="flex flex-col gap-2 mb-4">
          <select id="commentSection" class="rounded-xl border border-jc-border px-3 py-2 text-sm"></select>
          <textarea id="commentText" class="rounded-xl border border-jc-border px-3 py-2 text-sm" rows="3" placeholder="Add a comment for managers…"></textarea>
          <button id="commentSend" class="self-start btn-primary">Post comment</button>
          <div id="commentMsg" class="text-sm"></div>
        </div>
        <ul id="commentsList" class="divide-y divide-jc-border"></ul>
      </div>
    </section>
  </main>

  <script>
    // ====== CONFIG ======
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // 1) Put your **PDF** public URL here (preferred)
    const PDF_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";
    // 2) (Optional fallback) DOCX public URL — will render with Office viewer if no PDF provided
    const DOCX_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.docx";

    // Read-only sections list (edit this array to reflect your handbook)
    const SECTIONS = [
      "Section I — Introduction",
      "Section II — Employment Policies",
      "3.1 Pay Periods",
      "3.2 Workweek & Hours",
      "3.3 Timekeeping",
      "3.4 Overtime (Nonexempt)",
      "3.7 Overtime for Tipped Employees",
      "3.8 Meal & Rest Breaks",
      "3.9 Payroll Deductions",
      "3.11 Wage Garnishments",
      "3.12 Direct Deposit / Lost Payments"
    ];

    // ====== DOM ======
    const whoLabel = document.getElementById('whoLabel');
    const logoutBtn = document.getElementById('logoutBtn');
    const loginInitials = document.getElementById('loginInitials');
    const loginPin = document.getElementById('loginPin');
    const loginBtn = document.getElementById('loginBtn');
    const loginMsg = document.getElementById('loginMsg');

    const sectionsList = document.getElementById('sectionsList');
    const viewerTools = document.getElementById('viewerTools');
    const openOriginal = document.getElementById('openOriginal');
    const downloadPdf = document.getElementById('downloadPdf');
    const printBtn = document.getElementById('printBtn');

    const lockedCard = document.getElementById('lockedCard');
    const contentCard = document.getElementById('contentCard');
    const commentsCard = document.getElementById('commentsCard');
    const hbMeta = document.getElementById('hbMeta');
    const docFrame = document.getElementById('docFrame');

    const commentSection = document.getElementById('commentSection');
    const commentText = document.getElementById('commentText');
    const commentSend = document.getElementById('commentSend');
    const commentMsg = document.getElementById('commentMsg');
    const commentsList = document.getElementById('commentsList');

    // ====== State ======
    let session = null; // {initials,is_owner}

    // ====== Helpers ======
    function show(el){ el.classList.remove('hidden'); }
    function hide(el){ el.classList.add('hidden'); }
    function toast(el, msg, ok=false){
      el.textContent = msg;
      el.className = `text-sm ${ok ? 'text-green-700' : 'text-jc-danger'}`;
      setTimeout(()=>{ el.textContent=''; el.className='text-sm'; }, 3000);
    }
    const prettyDate = iso => new Date(iso).toLocaleString(undefined,{ dateStyle:'medium', timeStyle:'short' });

    function setSession(s){
      session = s;
      if(s){
        localStorage.setItem('hb_session', JSON.stringify(s));
        whoLabel.textContent = `Logged in: ${s.initials}`;
        show(whoLabel); show(logoutBtn);
        hide(lockedCard); show(contentCard); show(viewerTools); show(commentsCard);
        loadViewer();
        loadComments();
      }else{
        localStorage.removeItem('hb_session');
        hide(whoLabel); hide(logoutBtn);
        show(lockedCard); hide(contentCard); hide(viewerTools); hide(commentsCard);
      }
    }
    function restoreSession(){
      try { const raw = localStorage.getItem('hb_session'); setSession(raw? JSON.parse(raw):null); }
      catch { setSession(null); }
    }

    function renderSections(){
      sectionsList.innerHTML = '';
      commentSection.innerHTML = '';
      SECTIONS.forEach(s=>{
        const li = document.createElement('li'); li.textContent = s; sectionsList.appendChild(li);
        const opt = document.createElement('option'); opt.value = s; opt.textContent = s; commentSection.appendChild(opt);
      });
    }

    // ====== Viewer ======
    function loadViewer(){
      let src = '';
      if (PDF_URL && PDF_URL.toLowerCase().endsWith('.pdf')) {
        // Native PDF viewer
        src = `${PDF_URL}#toolbar=1&navpanes=0&view=FitH`;
        hbMeta.textContent = 'PDF viewer';
        openOriginal.href = PDF_URL;
        downloadPdf.href = PDF_URL;
      } else if (DOCX_URL) {
        // Office online viewer for DOCX
        const encoded = encodeURIComponent(DOCX_URL);
        src = `https://view.officeapps.live.com/op/embed.aspx?src=${encoded}`;
        hbMeta.textContent = 'DOCX viewer (Office)';
        openOriginal.href = DOCX_URL;
        downloadPdf.removeAttribute('href'); // not a PDF
      } else {
        hbMeta.textContent = 'No document configured.';
      }
      docFrame.src = src;
    }

    printBtn.addEventListener('click', () => {
      // Ask the iframe to print (works in most browsers with PDF/DOCX viewer)
      const f = docFrame.contentWindow;
      try { f.focus(); f.print(); } catch(e) { alert('Use the viewer toolbar to print.'); }
    });

    // ====== Comments ======
    async function loadComments(){
      const { data, error } = await client.from('handbook_comments').select('*').order('created_at', { ascending:false }).limit(100);
      if(error){ commentsList.innerHTML = `<li class="py-2 text-sm text-jc-danger">${error.message}</li>`; return; }
      commentsList.innerHTML = '';
      (data||[]).forEach(row=>{
        const li = document.createElement('li');
        li.className = 'py-3';
        li.innerHTML = `
          <div class="text-sm"><span class="font-semibold">${row.author}</span> • <span class="text-slate-500">${prettyDate(row.created_at)}</span></div>
          <div class="text-xs text-slate-500 mb-1">${row.section}</div>
          <div class="text-sm">${escapeHtml(row.comment)}</div>`;
        commentsList.appendChild(li);
      });
    }
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

    commentSend.addEventListener('click', async ()=>{
      const section = commentSection.value;
      const text = (commentText.value||'').trim();
      if(!text){ toast(commentMsg,'Type a comment.'); return; }
      const { error } = await client.from('handbook_comments').insert({ section, comment:text, author: session.initials });
      if(error){ toast(commentMsg, error.message); return; }
      commentText.value = '';
      toast(commentMsg, 'Posted.', true);
      await loadComments();
    });

    // ====== Auth (initials + pin; no emails) ======
    loginBtn.addEventListener('click', async () => {
      const initials = (loginInitials.value || '').trim().toUpperCase();
      const pin = (loginPin.value || '').trim();
      if(!initials || !pin){ toast(loginMsg, 'Enter initials and PIN.'); return; }
      const { data: rows, error } = await client.rpc('hb_login', { p_initials: initials, p_pin: pin });
      if(error){ toast(loginMsg, error.message); return; }
      if(!rows || rows.length === 0){ toast(loginMsg, 'Invalid initials or PIN.'); return; }
      const row = rows[0] || {};
      const is_owner = typeof row.is_owner === 'boolean' ? row.is_owner : (initials === 'JT' || initials === 'PG');
      setSession({ initials, is_owner });
      toast(loginMsg, 'Unlocked.', true);
    });
    logoutBtn.addEventListener('click', () => setSession(null));

    // ====== Init ======
    (function(){
      renderSections();
      restoreSession();
    })();
  </script>
</body>
</html>
