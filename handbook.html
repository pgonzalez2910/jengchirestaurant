<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Handbook</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-ink':   '#2D3748',
            'jc-sub':   '#4A5568',
            'jc-brown': '#744B3A',
            'jc-border':'#E2E8F0'
          },
          boxShadow: {
            soft: '0 8px 30px rgba(0,0,0,.06)'
          }
        }
      }
    }
  </script>

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    html, body { height: 100%; }
    .viewer-h { height: calc(100vh - 78px); } /* header ~78px */
    /* Hide default iframe border */
    iframe { border: 0; }
  </style>
</head>

<body class="h-full text-slate-800 font-sans">
  <!-- Header -->
  <header class="border-b border-jc-border bg-white/90 backdrop-blur sticky top-0 z-10">
    <div class="mx-auto max-w-7xl px-4 py-3 flex items-center gap-4">
      <div class="flex items-center gap-3 min-w-0">
        <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg"
             alt="Jeng Chi logo" class="h-8 w-auto rounded bg-white shadow-soft object-contain" />
        <div class="min-w-0">
          <h1 class="font-serif-head text-xl leading-none text-jc-ink truncate">Jeng Chi</h1>
          <div class="text-xs text-slate-500 leading-tight">Enterprise Portal • Executive Access</div>
        </div>
      </div>

      <!-- Jump select (hidden until login) -->
      <label class="ml-2 text-sm text-slate-600 hidden" id="jumpWrap">
        <span class="mr-2">Jump to</span>
        <select id="jumpSelect" class="rounded-lg border border-jc-border px-3 py-2 text-sm w-[360px] max-w-[48vw]"></select>
      </label>

      <div class="ml-auto flex items-center gap-2">
        <button id="downloadPdf" class="rounded-lg border px-3 py-2 text-sm hover:bg-slate-50">Download PDF</button>
        <button id="downloadDocx" class="rounded-lg border px-3 py-2 text-sm hover:bg-slate-50">Download DOCX</button>
        <button id="printBtn" class="rounded-lg border px-3 py-2 text-sm hover:bg-slate-50">Print</button>

        <span id="whoChip" class="hidden text-xs text-slate-700 bg-slate-100 rounded-xl px-2 py-1 ml-2"></span>
        <button id="logoutBtn" class="hidden rounded-lg border border-jc-border px-3 py-2 text-sm hover:bg-slate-50">Sign out</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="mx-auto max-w-7xl px-3 sm:px-4">
    <div class="relative viewer-h rounded-2xl border border-jc-border bg-white overflow-hidden shadow-soft mt-4">

      <!-- LOCK overlay -->
      <div id="lockedOverlay" class="absolute inset-0 grid place-items-center bg-white">
        <div class="text-center max-w-md px-4">
          <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-14 w-14 text-slate-400" viewBox="0 0 24 24" fill="currentColor">
            <path d="M12 2a5 5 0 00-5 5v3H6a2 2 0 00-2 2v8a2 2 0 002 2h12a2 2 0 002-2v-8a2 2 0 00-2-2h-1V7a5 5 0 00-5-5zm3 8H9V7a3 3 0 116 0v3z"/>
          </svg>
          <h2 class="mt-3 font-serif-head text-2xl text-jc-ink">Handbook Locked</h2>
          <p class="mt-2 text-slate-600 text-sm">Use your initials and PIN to unlock the Employee Handbook.</p>
        </div>
      </div>

      <!-- PDF viewer -->
      <iframe id="pdfFrame" class="w-full h-full hidden" referrerpolicy="no-referrer"></iframe>

      <!-- Floating login card -->
      <div id="loginCard" class="absolute left-4 top-4 w-[300px] rounded-2xl border border-jc-border bg-white/95 backdrop-blur p-4 shadow-soft">
        <h3 class="font-semibold mb-2">Editor Sign In</h3>
        <div class="space-y-2">
          <label class="block text-xs text-slate-600">Initials</label>
          <input id="loginInitials" class="w-full rounded-lg border border-jc-border px-3 py-2 text-sm" placeholder="Initials" />
          <label class="block text-xs text-slate-600 mt-2">PIN</label>
          <input id="loginPin" type="password" inputmode="numeric" maxlength="8" class="w-full rounded-lg border border-jc-border px-3 py-2 text-sm" placeholder="PIN" />
          <button id="loginBtn" class="w-full rounded-lg bg-jc-brown text-white py-2 text-sm mt-2 hover:opacity-90">Enter</button>
          <div id="loginMsg" class="text-xs min-h-[16px]"></div>
        </div>
      </div>

      <!-- Floating Notes button -->
      <button id="notesToggle"
        class="hidden absolute bottom-4 right-4 rounded-full bg-jc-brown text-white px-4 py-2 text-sm shadow-soft hover:opacity-90">
        Notes
      </button>

      <!-- Notes Panel -->
      <div id="notesPanel"
          class="hidden absolute right-4 bottom-16 w-[380px] max-h-[72vh] rounded-xl border border-jc-border bg-white shadow-soft grid"
          style="grid-template-rows:auto 1fr auto;">
        <div class="px-4 py-3 border-b text-sm font-semibold">Notes for page <span id="notesPageLabel">—</span></div>

        <div id="notesList" class="overflow-y-auto px-3 py-2 space-y-3 text-sm"></div>

        <div class="border-t p-3 space-y-2">
          <div class="text-xs text-slate-500">Add a note (confirm your PIN to save):</div>
          <textarea id="noteBody" class="w-full h-20 rounded-lg border border-jc-border px-3 py-2 text-sm"></textarea>
          <div class="flex items-center gap-2">
            <input id="notePin" type="password" inputmode="numeric" maxlength="8"
                  class="w-32 rounded-lg border border-jc-border px-3 py-2 text-sm" placeholder="PIN" />
            <button id="noteSave"
                    class="rounded-lg bg-jc-brown text-white px-3 py-2 text-sm hover:opacity-90">Save note</button>
            <button id="notesClose"
                    class="ml-auto rounded-lg border px-3 py-2 text-sm hover:bg-slate-50">Close</button>
          </div>
          <div id="notesMsg" class="text-xs text-red-600 min-h-[16px]"></div>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="text-[11px] text-slate-500 mt-3 mb-6 px-1">
      © 2025 Jeng Chi Restaurant — All rights reserved. Internal reference only. Unauthorized copying or distribution is prohibited.
    </div>
  </main>

  <script>
    /* ===================== CONFIG ===================== */
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const client = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const PDF_URL  = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.pdf";
    const DOCX_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co/storage/v1/object/public/HANDBOOK/Handbook%202026.docx";

    // Section index mapping (title → printed page)
    const SECTION_INDEX = [
      { title: 'SECTION I – INTRODUCTION', page: 6 },
      { title: '1.1 WELCOME TO JENG CHI RESTAURANT', page: 6 },
      { title: '1.2 EMPLOYEE HANDBOOK', page: 6 },
      { title: '1.3 DISCLAIMER, EMPLOYMENT-AT-WILL & MANAGEMENT APPROVAL AUTHORITY', page: 6 },
      { title: '1.4 APPROVAL AUTHORITY FOR POSITION & PAY CHANGES', page: 7 },
      { title: '1.5 ADMINISTRATION AND CHANGES', page: 8 },
      { title: '1.6 INTERPRETATION; DEVIATION; NO PAST-PRACTICE RIGHTS', page: 8 },
      { title: '1.7 CONFLICTS WITH LAW OR OTHER DOCUMENTS', page: 8 },

      { title: 'SECTION II - EMPLOYMENT POLICIES', page: 9 },
      { title: '2.1 EMPLOYEE CLASSIFICATIONS', page: 9 },
      { title: '2.2 EQUAL EMPLOYMENT OPPORTUNITY (EEO) & AMERICANS WITH DISABILITIES ACT (ADA)', page: 9 },
      { title: '2.3 INTRODUCTORY PERIOD', page: 10 },
      { title: '2.4 REPORTING DISCRIMINATION/HARASSMENT', page: 10 },
      { title: '2.5 REQUIRED CERTIFICATIONS & PAID TRAINING', page: 10 },
      { title: '2.5.1 FOOD SAFETY (FOOD HANDLER – TXDSHS)', page: 10 },
      { title: '2.5.2 ALCOHOL SERVICE (TABC SELLER-SERVER)', page: 11 },
      { title: '2.6 PAID TRAINING – FLSA/TWC COMPLIANCE RULES', page: 11 },
      { title: '2.7 PARKING', page: 11 },
      { title: '2.8 REQUIRED NOTICES AND POSTINGS', page: 12 },

      { title: 'SECTION III - HOURS OF WORK & PAYROLL PRACTICES', page: 13 },
      { title: '3.1 PAY PERIODS & PAYDAYS (TEXAS PAYDAY LAW)', page: 13 },
      { title: '3.2 WORKWEEK & HOURS OF WORK', page: 13 },
      { title: '3.3 TIMEKEEPING (ALL EMPLOYEES)', page: 14 },
      { title: '3.4 TIMEKEEPING: RECORD ALL TRAINING TIME ON YOUR TIMECARD.', page: 14 },
      { title: '3.5 TIMEKEEPING & WAGE COMPLIANCE.', page: 14 },
      { title: '3.6 OVERTIME (NONEXEMPT)', page: 15 },
      { title: '3.7 OVERTIME FOR TIPPED EMPLOYEES (SERVERS)', page: 15 },
      { title: '3.8 MEAL & REST BREAKS', page: 16 },
      { title: '3.9 PAYROLL DEDUCTIONS (TEXAS PAYDAY LAW)', page: 16 },
      { title: '3.10 UNIFORMS & WORK EQUIPMENT (DEDUCTIONS)', page: 16 },
      { title: '3.11 WAGE GARNISHMENTS', page: 17 },
      { title: '3.12 DIRECT DEPOSIT & LOST/RETURNED PAYMENTS', page: 17 },
      { title: '3.13 PAY STATEMENTS & ACCESS (MYTOAST)', page: 17 },
      { title: '3.14 PAYROLL QUESTIONS & DISPUTES', page: 18 },
      { title: '3.15 TIPS & GRATUITIES POLICY (TEXAS) — TIP CREDIT, POOLING, CREDIT-CARD TIPS & PROCESSING FEES', page: 18 },

      { title: 'SECTION IV — STANDARDS OF CONDUCT', page: 20 },
      { title: '4.1 ZERO-TOLERANCE POLICY (SAFETY, INTEGRITY & RESPECT)', page: 20 },
      { title: '4.2 ANTI-HARASSMENT / ANTI-DISCRIMINATION & DIVERSITY', page: 21 },
      { title: '4.3 DIVERSITY & INCLUSION COMMITMENT', page: 21 },
      { title: '4.4 EXAMPLES OF PROHIBITED CONDUCT (NOT EXHAUSTIVE)', page: 21 },
      { title: '4.5 SPEAK-UP & INVESTIGATION POLICY', page: 22 },
      { title: '4.6 OUR INVESTIGATION (WHAT HAPPENS BEHIND THE SCENES)', page: 22 },
      { title: '4.7 ANTI-RETALIATION (ZERO TOLERANCE)', page: 22 },
      { title: '4.8 PROFESSIONAL BOUNDARIES & NO HORSEPLAY', page: 23 },
      { title: '4.9 WORKPLACE SEARCHES & MONITORING', page: 24 },
      { title: '4.10 PERSONAL CELL PHONE & EARBUD POLICY', page: 25 },
      { title: '4.11 NO SMOKING, VAPING, CHEWING GUM, DIPPING', page: 25 },
      { title: '4.12 PERSONAL ERRANDS WHILE ON THE CLOCK', page: 26 },
      { title: '4.13 EMPLOYEE BAR POLICY', page: 26 },
      { title: '4.14 FOH ORDER INTEGRITY & GUEST SERVICE', page: 26 },

      { title: 'SECTION V - DISCIPLINE & CORRECTIVE ACTION', page: 29 },
      { title: '5.1 STANDARD PROGRESSIVE PATH', page: 29 },
      { title: '5.2 CROSS-POLICY PROGRESSION (NO RESET)', page: 29 },
      { title: '5.3 DOCUMENTATION & TIMELINES', page: 30 },
      { title: '5.4 ZERO-TOLERANCE / IMMEDIATE-TERMINATION OFFENSES (EXAMPLES)', page: 30 },
      { title: '5.5 ATTENDANCE & PUNCTUALITY – SPECIFIC LADDER', page: 30 },
      { title: '5.6 FIGHTS, THREATS & WORKPLACE VIOLENCE', page: 31 },
      { title: '5.7 DISHONESTY, THEFT & FRAUD (YOUR REQUESTED RULES)', page: 31 },
      { title: '5.8 UNPROFESSIONAL / DISRESPECTFUL CONDUCT (EMPLOYEES ↔ MANAGERS/OWNERS)', page: 31 },
      { title: '5.9 SOCIAL MEDIA & COMMUNICATIONS', page: 32 },
      { title: '5.10 DRUGS, ALCOHOL & IMPAIRMENT', page: 32 },
      { title: '5.11 HARASSMENT, DISCRIMINATION & RETALIATION', page: 32 },
      { title: '5.12 CORRECTIVE ACTION PLANS (CAPS)', page: 32 },
      { title: '5.13 BENEFITS & PTO ON SEPARATION', page: 33 },
      { title: '5.14 RESIGNATION (TWO-WEEKS’ NOTICE) & HOW TO SUBMIT', page: 33 },
      { title: '5.15 COMPANY ACCEPTANCE / SCHEDULING DURING NOTICE', page: 33 },
      { title: '5.16 CONDUCT DURING NOTICE (DISCIPLINE STILL APPLIES)', page: 33 },
      { title: '5.17 JOB ABANDONMENT (NO-CALL/NO-SHOW)', page: 34 },
      { title: '5.18 DISCIPLINE & CORRECTIVE ACTION (FOH: ORDER INTEGRITY & GUEST SERVICE)', page: 34 },

      { title: 'FAMILY AND MEDICAL LEAVE (FMLA)', page: 37 },
      { title: '6.1 ELIGIBILITY (FMLA)', page: 37 },
      { title: '6.2 QUALIFYING REASONS (FMLA)', page: 37 },
      { title: '6.3 PREGNANCY & CHILDBIRTH — HOW FMLA AND PWFA/ADA INTERACT', page: 37 },
      { title: '6.4 AMOUNT, SCHEDULING & INTERMITTENT LEAVE', page: 38 },
      { title: '6.6 EMPLOYEE NOTICE RESPONSIBILITIES', page: 38 },
      { title: '6.7 MEDICAL CERTIFICATION & FITNESS-FOR-DUTY', page: 39 },
      { title: '6.8 EMPLOYER NOTICES (WHAT YOU’LL RECEIVE)', page: 39 },
      { title: '6.9 PERFORMANCE, CONDUCT & ANTI-RETALIATION', page: 39 },
      { title: '6.10 FRAUD/ABUSE', page: 39 },
      { title: '6.11 CONCURRENT LEAVES & WORKERS’ COMPENSATION', page: 39 },
      { title: '6.12 HOW TO REQUEST FMLA OR PREGNANCY-RELATED ACCOMMODATION', page: 40 },
      { title: '6.13 ADMINISTRATION & QUESTIONS', page: 40 },

      { title: 'DOCTOR’S NOTICE & MEDICAL LEAVE DOCUMENTATION', page: 41 },
      { title: '7.1 WHEN A DOCTOR’S NOTE IS REQUIRED', page: 41 },
      { title: '7.2 HOW TO SUBMIT YOUR DOCTOR’S NOTE', page: 41 },
      { title: '7.3 FMLA SCREENING & PAPERWORK (IF/WHEN WE ARE FMLA-COVERED)', page: 42 },
      { title: '7.4 PREGNANCY, CHILDBIRTH & RELATED CONDITIONS (PWFA/ADA)', page: 42 },
      { title: '7.5 WORKERS’ COMPENSATION & WORK-INJURY NOTES', page: 42 },
      { title: '7.6 PAY, PTO & SCHEDULING DURING MEDICAL LEAVE', page: 43 },
      { title: '7.7 IF DOCUMENTATION IS NOT PROVIDED (DOCTOR’S NOTES, FMLA CERTIFICATION, FITNESS-FOR-DUTY)', page: 43 },
      { title: '7.8 FITNESS-FOR-DUTY (FFD) TO RETURN', page: 44 },
      { title: '7.9 NO RETALIATION / CONSISTENT APPLICATION', page: 44 },

      { title: 'SECTION VIII – EMPLOYEE BENEFITS & SERVICES (OVERVIEW)', page: 45 },
      { title: '8.1 ELIGIBILITY & WAITING PERIOD', page: 45 },
      { title: '8.2 PTO (PAID TIME OFF) — ACCRUAL START', page: 46 },
      { title: '8.3 COORDINATION WITH LEAVE & PAYROLL', page: 46 },
      { title: '8.4 PAYROLL ADVANCE POLICY', page: 46 },
      { title: '8.5 CONDITIONS FOR REQUESTING A PAYROLL ADVANCE', page: 46 },
      { title: '8.6 EMPLOYEE MEAL', page: 47 },
      { title: '8.7 WORKER COMPENSATION INSURANCE.', page: 48 },
      { title: '8.8 EMPLOYEE TIME OFF', page: 48 },
      { title: '8.9 VACATION POLICY', page: 48 },
      { title: '8.10 USE AND MANAGEMENT OF PTO', page: 49 },
      { title: '8.11 REQUEST TO USE PTO', page: 50 },
      { title: '8.12 PAID TIME OFF (PTO) – FULL-TIME EMPLOYEES (≥30 HRS./WK.)', page: 50 },
      { title: '8.13 REQUESTING & SCHEDULING PTO', page: 52 },
      { title: '8.14 PAY & FLSA GUARDRAILS', page: 52 }
    ];

    /* ===================== DOM REFS ===================== */
    const loginCard     = document.getElementById('loginCard');
    const loginInitials = document.getElementById('loginInitials');
    const loginPin      = document.getElementById('loginPin');
    const loginBtn      = document.getElementById('loginBtn');
    const loginMsg      = document.getElementById('loginMsg');

    const lockedOverlay = document.getElementById('lockedOverlay');
    const pdfFrame      = document.getElementById('pdfFrame');

    const jumpWrap   = document.getElementById('jumpWrap');
    const jumpSelect = document.getElementById('jumpSelect');

    const whoChip  = document.getElementById('whoChip');
    const logoutBtn= document.getElementById('logoutBtn');

    const downloadPdf = document.getElementById('downloadPdf');
    const downloadDocx= document.getElementById('downloadDocx');
    const printBtn    = document.getElementById('printBtn');

    // Notes UI
    const notesToggle = document.getElementById('notesToggle');
    const notesPanel  = document.getElementById('notesPanel');
    const notesList   = document.getElementById('notesList');
    const notesPageLabel = document.getElementById('notesPageLabel');
    const noteBody = document.getElementById('noteBody');
    const notePin  = document.getElementById('notePin');
    const noteSave = document.getElementById('noteSave');
    const notesClose = document.getElementById('notesClose');
    const notesMsg = document.getElementById('notesMsg');

    /* ===================== STATE ===================== */
    let session = null; // { initials: 'JT', is_owner: true }

    function toast(el, msg, ok=false) {
      el.textContent = msg;
      el.className = `text-xs ${ok ? 'text-green-700' : 'text-red-600'}`;
      setTimeout(()=>{ el.textContent=''; el.className='text-xs'; }, 3500);
    }

    function setSession(s) {
      session = s;
      if (s) {
        localStorage.setItem('hb_session', JSON.stringify(s));
        whoChip.textContent = `Logged in: ${s.initials}`;
        whoChip.classList.remove('hidden');
        logoutBtn.classList.remove('hidden');

        lockedOverlay.classList.add('hidden');
        pdfFrame.classList.remove('hidden');
        loginCard.classList.add('hidden');

        jumpWrap.classList.remove('hidden');
        notesToggle.classList.remove('hidden');

        // load first visible page (default to first TOC entry or 1)
        const firstPage = SECTION_INDEX[0]?.page ?? 1;
        goToPage(firstPage, true);
      } else {
        localStorage.removeItem('hb_session');
        whoChip.classList.add('hidden');
        logoutBtn.classList.add('hidden');

        lockedOverlay.classList.remove('hidden');
        pdfFrame.classList.add('hidden');
        loginCard.classList.remove('hidden');

        jumpWrap.classList.add('hidden');
        notesToggle.classList.add('hidden');
        notesPanel.classList.add('hidden');
      }
    }

    function restoreSession(){
      const raw = localStorage.getItem('hb_session');
      if(!raw) return setSession(null);
      try {
        const s = JSON.parse(raw);
        setSession(s);
      } catch { setSession(null); }
    }

    /* ===================== LOGIN ===================== */
    loginBtn.addEventListener('click', async () => {
      const initials = (loginInitials.value || '').trim().toUpperCase();
      const pin = (loginPin.value || '').trim();
      if(!initials || !pin){ toast(loginMsg, 'Enter initials and PIN.'); return; }

      const { data: rows, error } = await client.rpc('hb_login', { p_initials: initials, p_pin: pin });
      if(error){ toast(loginMsg, error.message); return; }
      if(!rows || rows.length === 0){ toast(loginMsg, 'Invalid initials or PIN.'); return; }

      const row = rows[0] || {};
      const is_owner = typeof row.is_owner === 'boolean'
        ? row.is_owner
        : (initials === 'JT' || initials === 'PG');

      setSession({ initials, is_owner });
      toast(loginMsg, 'Unlocked.', true);
    });

    logoutBtn.addEventListener('click', () => setSession(null));

    /* ===================== PDF VIEWER ===================== */
    function buildJumpOptions(){
      jumpSelect.innerHTML = '';
      SECTION_INDEX.forEach(({title, page}) => {
        const opt = document.createElement('option');
        opt.value = page;
        opt.textContent = `${title} (p.${page})`;
        jumpSelect.appendChild(opt);
      });
    }

    function goToPage(page, force=false){
      // Always rewrite src so Chrome's viewer jumps reliably
      const src = `${PDF_URL}#page=${page}`;
      if (force || pdfFrame.src !== src) {
        pdfFrame.src = src;
      } else {
        // If same page chosen, nudge with a tiny cache-buster to force a refresh
        pdfFrame.src = `${PDF_URL}?t=${Date.now()}#page=${page}`;
      }
      jumpSelect.value = String(page);
      // refresh notes badge/page label if open
      if (!notesPanel.classList.contains('hidden')) {
        notesPageLabel.textContent = `p.${page}`;
        loadNotes();
      }
    }

    jumpSelect.addEventListener('change', () => {
      const page = Number(jumpSelect.value || 1);
      goToPage(page);
    });

    downloadPdf.addEventListener('click', () => window.open(PDF_URL, '_blank'));
    downloadDocx.addEventListener('click', () => window.open(DOCX_URL, '_blank'));
    printBtn.addEventListener('click', () => window.open(PDF_URL + '#print', '_blank'));

    /* ===================== NOTES ===================== */
    function currentPrintedPage(){ return Number(jumpSelect.value || 1); }
    function currentSectionLabel(){
      const opt = jumpSelect.options[jumpSelect.selectedIndex];
      return opt ? opt.textContent : '';
    }
    function notesToast(msg, ok=false){
      notesMsg.textContent = msg;
      notesMsg.className = `text-xs ${ok ? 'text-green-700' : 'text-red-600'}`;
      setTimeout(()=>{ notesMsg.textContent=''; notesMsg.className='text-xs'; }, 3500);
    }
    function renderNotes(list){
      notesList.innerHTML = '';
      if(!list || list.length === 0){
        notesList.innerHTML = `<div class="text-slate-500 text-sm px-1">No notes on this page yet.</div>`;
        return;
      }
      list.forEach(n => {
        const div = document.createElement('div');
        div.className = 'rounded-lg border border-jc-border p-3';
        div.innerHTML = `
          <div class="text-xs text-slate-500 mb-1">
            ${n.author_initials} • ${new Date(n.created_at).toLocaleString()}
            ${n.section ? ` • <span class="text-slate-400">${n.section}</span>` : ''}
          </div>
          <div class="${n.resolved ? 'line-through text-slate-400' : ''} whitespace-pre-wrap">${n.body}</div>
          <div class="mt-2 flex items-center gap-2 text-xs">
            <button data-id="${n.id}" data-res="${!n.resolved}"
              class="resolveBtn rounded border px-2 py-1 hover:bg-slate-50">
              ${n.resolved ? 'Reopen' : 'Mark resolved'}
            </button>
            ${n.resolved && n.resolved_by ? `<span class="text-slate-500">Resolved by ${n.resolved_by}</span>` : ''}
          </div>
        `;
        notesList.appendChild(div);
      });
      notesList.querySelectorAll('.resolveBtn').forEach(btn => {
        btn.addEventListener('click', async (e) => {
          const id = Number(e.currentTarget.dataset.id);
          const newState = e.currentTarget.dataset.res === 'true';
          const pin = prompt('Confirm your PIN to toggle resolve:');
          if(!pin) return;
          const { error } = await client.rpc('hb_resolve_note', {
            p_initials: session.initials,
            p_pin: pin,
            p_id: id,
            p_resolved: newState
          });
          if(error){ notesToast(error.message || 'Could not update'); return; }
          await loadNotes();
          notesToast('Updated', true);
        });
      });
    }
    async function loadNotes(){
      const page = currentPrintedPage();
      notesPageLabel.textContent = `p.${page}`;
      const { data, error } = await client.rpc('hb_list_notes', { p_page: page });
      if(error){ renderNotes([]); return; }
      renderNotes(data);
    }

    notesToggle.addEventListener('click', async () => {
      if (notesPanel.classList.contains('hidden')) {
        await loadNotes();
        notesPanel.classList.remove('hidden');
      } else {
        notesPanel.classList.add('hidden');
      }
    });
    notesClose.addEventListener('click', () => notesPanel.classList.add('hidden'));

    noteSave.addEventListener('click', async () => {
      if(!session){ notesToast('Please log in first.'); return; }
      const body = (noteBody.value || '').trim();
      const pin  = (notePin.value || '').trim();
      if(!body || !pin){ notesToast('Write a note and enter your PIN.'); return; }

      const { error } = await client.rpc('hb_add_note', {
        p_initials: session.initials,
        p_pin: pin,
        p_page: currentPrintedPage(),
        p_section: currentSectionLabel(),
        p_body: body
      });
      if(error){ notesToast(error.message || 'Could not save'); return; }

      noteBody.value = '';
      notePin.value = '';
      await loadNotes();
      notesToast('Saved', true);
    });

    jumpSelect.addEventListener('change', async () => {
      if(!notesPanel.classList.contains('hidden')) await loadNotes();
    });

    /* ===================== INIT ===================== */
    (function init(){
      buildJumpOptions();
      restoreSession();
      // If not logged in, show the very first page frame as blank (locked overlay shows)
      if(!session){
        pdfFrame.src = `${PDF_URL}#page=1`;
      }
    })();
  </script>
</body>
</html>
