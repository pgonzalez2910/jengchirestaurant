<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Advance Request</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <!-- html2pdf (bundles html2canvas + jsPDF) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    .shadow-soft{ box-shadow: 0 6px 28px rgba(0,0,0,0.08); }
    @media print{ .no-print{ display:none !important; } body{ background:white; } }
    input[type="number"]::-webkit-outer-spin-button,
    input[type="number"]::-webkit-inner-spin-button{ -webkit-appearance: none; margin: 0; }
    input[type="number"]{ -moz-appearance: textfield; }
    /* highlight for keyboard selection */
    .result-active { background: rgb(248 250 252); }
  </style>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#2D2320',
            'jc-secondary': '#5B463E',
            'jc-gold': '#C0A06D',
            'jc-border': '#E2E8F0',
            'jc-ink': '#2B2B2B'
          }
        }
      }
    }
  </script>
</head>
<body class="min-h-full text-jc-ink">
  <div class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Letterhead / Header -->
    <header class="bg-white shadow-soft rounded-2xl p-6 border border-jc-border">
      <div class="flex items-center gap-6">
        <img id="jc-logo" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="h-16 w-auto object-contain"/>
        <div>
          <h1 class="font-serif-head text-2xl sm:text-3xl tracking-wide text-jc-primary">JENG CHI RESTAURANT</h1>
          <p class="text-sm text-slate-700">400 N. Greenville Ave. Ste 11 • Richardson, Texas 75081</p>
          <p class="text-sm text-slate-700">info@jengchirestaurant.com • (972) 669-9094</p>
        </div>
        <div class="ml-auto text-right">
          <span class="inline-block text-xs uppercase tracking-wider text-white bg-jc-primary px-3 py-1 rounded-full">Payroll Advance</span>
        </div>
      </div>
    </header>

    <!-- Form & History Layout -->
    <div class="mt-6 grid lg:grid-cols-2 gap-6">
      <!-- Advance Form Card -->
      <section class="bg-white rounded-2xl p-6 border border-jc-border shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Create / Edit Advance</h2>
          <span id="form-mode" class="text-xs text-slate-500">Mode: New</span>
        </div>

        <form id="advance-form" class="mt-4 space-y-4">
          <input type="hidden" id="advance-id" />

          <!-- EMPLOYEE COMBO -->
          <div>
            <label class="block text-sm font-medium text-slate-700">Employee</label>
            <div class="mt-1 relative">
              <input id="employee-search" class="w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold pr-10" placeholder="Search by name or email (type at least 2 letters)" autocomplete="off" />
              <input type="hidden" id="employee-id" />
              <!-- Results dropdown (desktop/tablet) -->
              <div id="employee-results" class="hidden absolute left-0 right-0 top-full mt-1 bg-white border border-jc-border rounded-xl shadow-2xl max-h-96 overflow-auto z-50"></div>
            </div>
            <p class="mt-1 text-xs text-slate-500">List comes from <code>public.employees</code>. Use 2+ letters to search.</p>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Is Server? (tips included)</label>
              <select id="is-server" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold">
                <option value="false" selected>No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Hourly Rate ($/hr)</label>
              <input id="rate" type="number" step="0.01" min="0" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" placeholder="0.00" />
            </div>
          </div>

          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Hours Worked to Date</label>
              <input id="hours" type="number" step="0.01" min="0" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" placeholder="0.00" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Tips Earned to Date</label>
              <input id="tips" type="number" step="0.01" min="0" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" placeholder="0.00" />
            </div>
            <div>
              <label for="amount" class="block text-sm font-medium text-slate-700">Requested Advance Amount ($)</label>
              <input id="amount" type="number" step="0.01" min="0" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" placeholder="0.00" required />
            </div>
          </div>

          <div class="grid sm:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Gross Earned to Date</label>
              <div id="gross" class="mt-1 h-10 flex items-center px-3 rounded-xl border bg-slate-50">$0.00</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Eligible (50% of earned)</label>
              <div id="eligible" class="mt-1 h-10 flex items-center px-3 rounded-xl border bg-slate-50">$0.00</div>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Today's Advance Count</label>
              <div id="today-count" class="mt-1 h-10 flex items-center px-3 rounded-xl border bg-slate-50"></div>
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div><div id="limit-note" class="text-sm">OK — within 50% limit.</div></div>
            <div><div id="policy-note" class="text-sm">ELIGIBLE — Meets policy conditions.</div></div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Pay Period Start</label>
              <input id="pps" type="date" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" />
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Pay Period End</label>
              <input id="ppe" type="date" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" />
            </div>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Disciplinary Action?</label>
              <select id="disciplinary" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold">
                <option value="false" selected>No</option>
                <option value="true">Yes</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Outstanding Advance?</label>
              <select id="outstanding" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold">
                <option value="false" selected>No</option>
                <option value="true">Yes</option>
              </select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-slate-700">Reason (optional)</label>
            <textarea id="reason" rows="3" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" placeholder="Explain the reason for the request (optional)"></textarea>
          </div>

          <div class="grid sm:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-slate-700">Deduct From Next Paycheck?</label>
              <select id="repay-next" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold">
                <option value="true" selected>Yes</option>
                <option value="false">No</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-slate-700">Scheduled Deduction Date</label>
              <input id="deduct-date" type="date" class="mt-1 w-full rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold" />
            </div>
          </div>

          <div class="flex flex-wrap items-center gap-3 pt-2">
            <button id="save-btn" class="px-4 py-2 rounded-xl bg-jc-primary text-white font-medium hover:opacity-95">Save</button>
            <button id="update-btn" class="px-4 py-2 rounded-xl bg-white border border-slate-300 text-slate-800 font-medium hover:bg-slate-50 disabled:opacity-40" disabled>Update</button>
            <button id="new-btn" type="button" class="px-4 py-2 rounded-xl bg-white border border-slate-300 text-slate-800 font-medium hover:bg-slate-50">New</button>
            <span class="ml-auto text-sm text-slate-500">Record ID: <span id="rid">—</span></span>
          </div>
        </form>

        <div class="mt-6 border-t pt-4">
          <div class="flex flex-wrap items-center gap-3 no-print">
            <button id="pdf-btn" class="px-4 py-2 rounded-xl bg-jc-gold text-white font-medium hover:opacity-95 disabled:opacity-40" disabled>Export PDF</button>
            <button id="pdf-upload-btn" class="px-4 py-2 rounded-xl bg-jc-secondary text-white font-medium hover:opacity-95 disabled:opacity-40" disabled>Export & Upload</button>
            <a id="pdf-link" href="#" target="_blank" class="text-sm text-blue-700 underline hidden">Open Saved PDF</a>
          </div>
        </div>
      </section>

      <!-- History Card -->
      <section class="bg-white rounded-2xl p-6 border border-jc-border shadow-soft">
        <div class="flex items-center justify-between">
          <h2 class="text-lg font-semibold">Advance History</h2>
          <div class="flex items-center gap-3">
            <select id="history-filter" class="rounded-xl border-slate-300 focus:ring-jc-gold focus:border-jc-gold">
              <option value="all" selected>All Employees</option>
            </select>
            <button id="refresh-history" class="px-3 py-2 rounded-xl bg-white border border-slate-300 text-slate-800 hover:bg-slate-50">Refresh</button>
          </div>
        </div>

        <!-- Clear filter chip -->
        <div class="mt-3">
          <button id="clear-filter" class="hidden text-xs px-2 py-1 rounded-full bg-slate-100 hover:bg-slate-200 border border-slate-200">Clear employee filter</button>
        </div>

        <div class="mt-3 overflow-hidden border border-jc-border rounded-xl">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-50">
              <tr class="text-left text-slate-600">
                <th class="px-4 py-2">Date</th>
                <th class="px-4 py-2">Employee</th>
                <th class="px-4 py-2">Amount</th>
                <th class="px-4 py-2">Status</th>
                <th class="px-4 py-2">Actions</th>
              </tr>
            </thead>
            <tbody id="history-rows" class="divide-y"></tbody>
          </table>
        </div>
        <div id="employee-totals" class="mt-3 text-xs text-slate-600"></div>
      </section>
    </div>

    <!-- Printable / PDF Template -->
    <section id="printable" class="mt-6 bg-white rounded-2xl p-8 border border-jc-border shadow-soft">
      <div class="flex items-center gap-4">
        <img id="pdf-logo" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" class="h-14 w-auto object-contain"/>
        <div>
          <h3 class="font-serif-head text-xl tracking-wide text-jc-primary">JENG CHI RESTAURANT</h3>
          <p class="text-xs text-slate-700">400 N. Greenville Ave. Ste 11 • Richardson, Texas 75081 • info@jengchirestaurant.com • (972) 669-9094</p>
        </div>
      </div>
      <h2 class="mt-4 text-lg font-semibold">Payroll Advance Request</h2>
      <p class="text-xs text-slate-500">This document is autogenerated from the web form and may be signed and filed in the employee record.</p>

      <div class="mt-4 grid sm:grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium">Employee:</span> <span id="p-employee">—</span></div>
        <div><span class="font-medium">Request Date:</span> <span id="p-date">—</span></div>
        <div><span class="font-medium">Pay Period:</span> <span id="p-pp">—</span></div>
        <div><span class="font-medium">Status:</span> <span id="p-status">—</span></div>
        <div><span class="font-medium">Disciplinary:</span> <span id="p-disc">—</span></div>
        <div><span class="font-medium">Outstanding Advance:</span> <span id="p-out">—</span></div>
        <div class="sm:col-span-2"><span class="font-medium">Amount Requested:</span> <span id="p-amount">—</span></div>
      </div>

      <div class="mt-4 grid sm:grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium">Is Server:</span> <span id="p-server">—</span></div>
        <div><span class="font-medium">Hours × Rate + Tips:</span> <span id="p-calc">—</span></div>
        <div><span class="font-medium">Eligible (50%):</span> <span id="p-eligible">—</span></div>
      </div>

      <div class="mt-4">
        <div class="font-medium text-sm">Reason (employee statement):</div>
        <div id="p-reason" class="mt-1 min-h-[72px] p-3 rounded-lg border bg-slate-50"></div>
      </div>

      <div class="mt-6 grid sm:grid-cols-2 gap-4 text-sm">
        <div><span class="font-medium">Deduct From Next Paycheck:</span> <span id="p-repay">—</span></div>
        <div><span class="font-medium">Scheduled Deduction Date:</span> <span id="p-deduct">—</span></div>
      </div>

      <div class="mt-6 text-[11px] leading-snug text-slate-600">
        <p class="font-semibold">Disclaimer</p>
        <p>Any wage deduction for repayment of this advance is made pursuant to the employee's written authorization and in compliance with the Fair Labor Standards Act (FLSA), U.S. Department of Labor guidance, and Texas Payday Law/Texas Workforce Commission (TWC) requirements. Advances may be denied if prior advances are outstanding or if disciplinary action is active. For tipped employees, calculations may include reported tips as specified by company policy. This form does not guarantee approval.</p>
      </div>

      <div class="mt-8 grid sm:grid-cols-2 gap-10 text-sm">
        <div>
          <div class="h-12 border-b"></div>
          <div class="mt-2">Employee Signature / Date</div>
        </div>
        <div>
          <div class="h-12 border-b"></div>
          <div class="mt-2">Manager Approval / Date</div>
        </div>
      </div>
    </section>

    <footer class="mt-8 text-center text-xs text-slate-500">
      © <span id="year"></span> Jeng Chi Restaurant. All rights reserved.
    </footer>
  </div>

  <script>
    // ====== CONFIG ======
    const DEFAULT_LOGO_DATA_URI = 'https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg';
    const STORAGE_BUCKET = 'advance-pdfs';
    const PRESET_SUPABASE_URL = 'https://kpldzwlftkvjjntgsqxx.supabase.co';
    const PRESET_SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs';

    // UI behavior
    const MIN_QUERY_CHARS = 2;  // <-- your requested change
    const MAX_RESULTS = 60;     // <-- configurable

    // Optional email (leave disabled if you don't use an Edge Function)
    const EMAIL_SEND_ENABLED = false;
    const SEND_EMAIL_FUNCTION = 'send-email';
    const SEND_TO = 'admin@jengchirestaurant.com';
    const CURRENT_USER = 'Julio';
    const TIMEZONE = 'America/Chicago';

    // ====== STATE ======
    let supabaseClient = null;
    let employees = [];          // [{id, full_name, email, hourly_rate}]
    let employeeMap = new Map(); // label -> id
    let activeIndex = -1;        // keyboard highlight

    // ====== HELPERS ======
    const $  = (id) => document.getElementById(id);
    const $$ = (sel, root=document) => Array.from(root.querySelectorAll(sel));
    const money = (n) => new Intl.NumberFormat('en-US',{ style:'currency', currency:'USD'}).format(Number(n||0));

    function setLogo(src){
      const el1 = $('jc-logo'); const el2 = $('pdf-logo');
      if(src){ el1.src = src; el2.src = src; }
    }
    function setMode(mode){ $('form-mode').textContent = `Mode: ${mode}`; }
    function ensureConnected(){ if(!supabaseClient){ throw new Error('Not connected'); } }
    function setButtonsForSaved(saved){
      $('pdf-btn').disabled = !saved;
      $('pdf-upload-btn').disabled = !saved;
      $('save-btn').disabled = false;
    }

    // ====== SUPABASE ======
    async function connect(){
      try{
        supabaseClient = window.supabase.createClient(PRESET_SUPABASE_URL, PRESET_SUPABASE_ANON_KEY);
        await loadEmployees();
        await loadHistory();
      } catch (e){
        console.error(e);
        alert('Could not connect to Supabase.');
      }
    }

    async function loadEmployees(){
      ensureConnected();
      const { data, error } = await supabaseClient
        .from('employees')
        .select('id, full_name, email, status, hourly_rate')
        .order('full_name');
      if(error){ console.error(error); alert('Error loading employees'); return; }
      employees = data || [];
      employeeMap.clear();
      const hf = $('history-filter'); if (hf) hf.innerHTML = '<option value="all" selected>All Employees</option>';
      employees.forEach(e => {
        const label = `${e.full_name}${e.email ? ' — ' + e.email : ''}`;
        employeeMap.set(label, e.id);
        const opt2 = document.createElement('option');
        opt2.value = e.id; opt2.textContent = e.full_name; if(hf) hf.appendChild(opt2);
      });
    }

    async function saveAdvance(evt){
      evt.preventDefault(); ensureConnected();
      const employeeLabel = $('employee-search').value.trim();
      const employee_id = employeeMap.get(employeeLabel) || $('employee-id').value;
      if(!employee_id){ alert('Select a valid employee from the list.'); return; }
      const v = recalc(false);
      if(!v.ok){ alert('Over limit or ineligible per policy. Please adjust.'); return; }
      const payload = buildPayload(employee_id);
      try{
        const { data, error } = await supabaseClient.from('employee_advances').insert(payload).select().single();
        if(error) throw error;
        $('advance-id').value = data.id; $('rid').textContent = data.id; setMode('Edit');
        $('update-btn').disabled = false; setButtonsForSaved(true);
        fillPrintable(data, employeeLabel);
        await loadHistory();
        if (EMAIL_SEND_ENABLED) { try { await sendEmail('created', data, employeeLabel); } catch(e){ console.warn('Email failed', e);} }
        alert('Saved.');
      } catch(e){
        alert('Save failed: ' + (e?.message || e));
        console.error(e);
      }
    }

    async function updateAdvance(evt){
      evt.preventDefault(); ensureConnected();
      const id = $('advance-id').value; if(!id){ alert('No record loaded.'); return; }
      const employeeLabel = $('employee-search').value.trim();
      const employee_id = employeeMap.get(employeeLabel) || $('employee-id').value;
      if(!employee_id){ alert('Select a valid employee from the list.'); return; }
      const v = recalc(false);
      if(!v.ok){ alert('Over limit or ineligible per policy. Please adjust.'); return; }
      const payload = buildPayload(employee_id);
      try{
        const { data, error } = await supabaseClient.from('employee_advances').update(payload).eq('id', id).select().single();
        if(error) throw error;
        fillPrintable(data, employeeLabel);
        await loadHistory();
        if (EMAIL_SEND_ENABLED) { try { await sendEmail('updated', data, employeeLabel); } catch(e){ console.warn('Email failed', e);} }
        alert('Updated.');
      } catch(e){
        alert('Update failed: ' + (e?.message || e));
        console.error(e);
      }
    }

    function buildPayload(employee_id){
      const amount = Number($('amount').value || 0);
      if(amount <= 0){ throw new Error('Amount must be greater than 0'); }
      return {
        employee_id,
        request_amount: amount,
        reason: $('reason').value || null,
        status: $('status') ? $('status').value : 'pending',
        has_disciplinary_action: $('disciplinary').value === 'true',
        has_outstanding_advance: $('outstanding').value === 'true',
        pay_period_start: $('pps').value || null,
        pay_period_end: $('ppe').value || null,
        repay_from_next_check: $('repay-next').value === 'true',
        deduction_check_date: $('deduct-date').value || null
      };
    }

    async function loadHistory(){
      ensureConnected();
      const filterId = $('history-filter').value;
      let query = supabaseClient.from('employee_advances')
        .select('id, request_amount, status, requested_at, employee_id')
        .order('requested_at', { ascending: false })
        .limit(200);
      if(filterId && filterId !== 'all') query = query.eq('employee_id', filterId);
      const { data, error } = await query;
      if(error){ console.error(error); alert('Failed to load history'); return; }
      const rowsEl = $('history-rows'); rowsEl.innerHTML = '';
      let total = 0; let count = 0;
      data.forEach(row => {
        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';
        const empName = (employees.find(e => e.id === row.employee_id) || {}).full_name || row.employee_id;
        tr.innerHTML = `
          <td class="px-4 py-2">${new Date(row.requested_at).toLocaleDateString()}</td>
          <td class="px-4 py-2">${empName}</td>
          <td class="px-4 py-2">${money(row.request_amount)}</td>
          <td class="px-4 py-2"><span class="px-2 py-0.5 rounded-full text-xs ${badgeClass(row.status)}">${row.status}</span></td>
          <td class="px-4 py-2">
            <button class="text-blue-700 underline" data-id="${row.id}">Edit</button>
          </td>`;
        rowsEl.appendChild(tr);
        tr.querySelector('button').addEventListener('click', () => editRecord(row.id));
        if(!filterId || filterId === 'all' || row.employee_id === filterId){ total += Number(row.request_amount||0); count++; }
      });
      if(filterId && filterId !== 'all'){
        $('employee-totals').textContent = `Total advances for selected employee: ${money(total)} across ${count} request(s).`;
        $('clear-filter').classList.remove('hidden');
      } else {
        $('employee-totals').textContent = '';
        $('clear-filter').classList.add('hidden');
      }
    }

    function badgeClass(status){
      switch(status){
        case 'approved': return 'bg-green-100 text-green-800';
        case 'denied': return 'bg-red-100 text-red-800';
        case 'repaid': return 'bg-slate-200 text-slate-800';
        default: return 'bg-yellow-100 text-yellow-800';
      }
    }

    async function editRecord(id){
      ensureConnected();
      const { data, error } = await supabaseClient.from('employee_advances').select('*').eq('id', id).single();
      if(error){ console.error(error); alert('Load failed.'); return; }
      $('advance-id').value = data.id; $('rid').textContent = data.id;
      const emp = employees.find(e => e.id === data.employee_id);
      const label = emp ? `${emp.full_name}${emp.email ? ' — ' + emp.email : ''}` : data.employee_id;
      $('employee-search').value = label; $('employee-id').value = data.employee_id;
      $('amount').value = data.request_amount; $('pps').value = data.pay_period_start || ''; $('ppe').value = data.pay_period_end || '';
      $('disciplinary').value = String(!!data.has_disciplinary_action);
      $('outstanding').value = String(!!data.has_outstanding_advance);
      $('reason').value = data.reason || '';
      $('repay-next').value = String(!!data.repay_from_next_check);
      $('deduct-date').value = data.deduction_check_date || '';
      setMode('Edit'); $('update-btn').disabled = false; setButtonsForSaved(true);
      fillPrintable(data, label);
      $('pdf-link').classList.toggle('hidden', !data.document_url); if(data.document_url){ $('pdf-link').href = data.document_url; }
    }

    function fillPrintable(data, employeeLabel){
      $('p-employee').textContent = employeeLabel;
      $('p-date').textContent = new Date(data.requested_at || Date.now()).toLocaleDateString();
      $('p-pp').textContent = (data.pay_period_start || '—') + ' to ' + (data.pay_period_end || '—');
      $('p-status').textContent = data.status || 'pending';
      $('p-disc').textContent = data.has_disciplinary_action ? 'Yes' : 'No';
      $('p-out').textContent = data.has_outstanding_advance ? 'Yes' : 'No';
      $('p-amount').textContent = money(data.request_amount);
      const v = recalc(false);
      $('p-server').textContent = v.isServer ? 'Yes' : 'No';
      $('p-calc').textContent = `${money(v.hours)} × ${money(v.rate)} + ${money(v.isServer ? v.tips : 0)} = ${money(v.gross)}`;
      $('p-eligible').textContent = money(v.eligible);
      $('p-reason').textContent = data.reason || '';
      $('p-repay').textContent = data.repay_from_next_check ? 'Yes' : 'No';
      $('p-deduct').textContent = data.deduction_check_date || '—';
    }

    async function exportPDF(downloadOnly=true){
      const node = $('printable');
      const id = $('advance-id').value || 'new';
      const opt = {
        margin: 12,
        filename: `employee-advance-${id}.pdf`,
        image: { type: 'jpeg', quality: 0.98 },
        html2canvas: { scale: 2, useCORS: true },
        jsPDF: { unit: 'mm', format: 'letter', orientation: 'portrait' }
      };
      const worker = html2pdf().set(opt).from(node);
      if(downloadOnly){ await worker.save(); return; }
      const blob = await worker.outputPdf('blob');
      return blob;
    }

    async function exportAndUpload(){
      ensureConnected();
      const id = $('advance-id').value; if(!id){ alert('Save the record before exporting.'); return; }
      const empLabel = $('employee-search').value.trim();
      const empId = employeeMap.get(empLabel) || $('employee-id').value;
      if(!empId){ alert('Employee not set.'); return; }
      const blob = await exportPDF(false);
      const path = `${empId}/${id}.pdf`;
      const { error } = await supabaseClient.storage.from(STORAGE_BUCKET).upload(path, blob, { upsert: true, contentType: 'application/pdf' });
      if(error){ console.error(error); alert('Upload failed'); return; }
      const { data: pub } = supabaseClient.storage.from(STORAGE_BUCKET).getPublicUrl(path);
      await supabaseClient.from('employee_advances').update({ document_url: pub.publicUrl }).eq('id', id);
      $('pdf-link').href = pub.publicUrl; $('pdf-link').classList.remove('hidden');
      alert('PDF exported & uploaded.');
    }

    function clearForm(){
      $('advance-form').reset();
      $('advance-id').value = ''; $('rid').textContent = '—'; setMode('New'); $('update-btn').disabled = true; setButtonsForSaved(false);
      $('pdf-link').classList.add('hidden'); $('pdf-link').href = '#';
      updateTodayCount(null);
    }

    async function sendEmail(kind, data, employeeLabel){
      if(!supabaseClient || !EMAIL_SEND_ENABLED) return;
      const when = new Date(data.requested_at || Date.now()).toLocaleString('en-US', { timeZone: TIMEZONE });
      const subj = `Payroll advance ${kind} — ${employeeLabel} — ${money(data.request_amount)}`;
      const html = `
        <h3>Payroll advance ${kind}</h3>
        <p><strong>Employee:</strong> ${employeeLabel}</p>
        <p><strong>Amount:</strong> ${money(data.request_amount)}</p>
        <p><strong>Status:</strong> ${data.status}</p>
        <p><strong>Requested at:</strong> ${when}</p>
        <p><strong>Disciplinary:</strong> ${data.has_disciplinary_action ? 'Yes' : 'No'}</p>
        <p><strong>Outstanding advance:</strong> ${data.has_outstanding_advance ? 'Yes' : 'No'}</p>
        <p><strong>Reason:</strong> ${data.reason || ''}</p>
        <p><em>Sent by ${CURRENT_USER}</em></p>`;
      try { await supabaseClient.functions.invoke(SEND_EMAIL_FUNCTION, { body: { to: SEND_TO, subject: subj, html } }); }
      catch(err){ console.error('sendEmail error', err); }
    }

    // ====== CALCULATIONS ======
    function recalc(updateUI){
      const isServer = $('is-server')?.value === 'true';
      const hours = Number($('hours')?.value || 0);
      const rate = Number($('rate')?.value || 0);
      const tips = Number($('tips')?.value || 0);
      const amount = Number($('amount')?.value || 0);
      const disciplinary = $('disciplinary')?.value === 'true';
      const outstanding = $('outstanding')?.value === 'true';

      const gross = (hours * rate) + (isServer ? tips : 0);
      const eligible = 0.5 * gross;
      const within = amount <= eligible;

      let policyMsg = 'ELIGIBLE — Meets policy conditions.';
      let ok = within;
      if(outstanding){ policyMsg = 'INELIGIBLE — Outstanding advance pending.'; ok = false; }
      else if(disciplinary){ policyMsg = 'INELIGIBLE — Active disciplinary action.'; ok = false; }

      if(updateUI){
        if($('gross')) $('gross').textContent = money(gross);
        if($('eligible')) $('eligible').textContent = money(eligible);
        if($('limit-note')) $('limit-note').textContent = within ? 'OK — within 50% limit.' : 'Over limit — reduce amount.';
        if($('policy-note')) $('policy-note').textContent = policyMsg;
      }
      return {isServer, hours, rate, tips, amount, gross, eligible, within, policyMsg, ok};
    }

    async function fetchTodayCount(employee_id){
      const start = new Date(); start.setHours(0,0,0,0);
      const end = new Date(start); end.setDate(end.getDate()+1);
      const { count } = await supabaseClient
        .from('employee_advances')
        .select('id', { count: 'exact', head: true })
        .eq('employee_id', employee_id)
        .gte('requested_at', start.toISOString())
        .lt('requested_at', end.toISOString());
      return count || 0;
    }
    function updateTodayCount(c){
      const el = $('today-count'); if(!el) return;
      if(c === null || c === 0){ el.textContent = ''; el.classList.remove('text-red-700'); $('save-btn').disabled = false; return; }
      el.textContent = String(c);
      if(c >= 6){
        el.classList.add('text-red-700');
        $('save-btn').disabled = true;
        if($('policy-note')) $('policy-note').textContent = 'INELIGIBLE — Reached daily limit (6).';
      } else {
        el.classList.remove('text-red-700');
        $('save-btn').disabled = false;
      }
    }

    // ====== Employee dropdown (desktop + full-screen overlay on mobile) ======
    function renderEmployeeResults(q){
      const box = $('employee-results'); if(!box) return;
      if(!q || q.length < MIN_QUERY_CHARS){ hideResults(); return; }
      const ql = q.toLowerCase();
      const matches = employees.filter(e =>
        (e.full_name||'').toLowerCase().includes(ql) || (e.email||'').toLowerCase().includes(ql)
      ).slice(0, MAX_RESULTS);
      if(matches.length === 0){ hideResults(); return; }

      box.innerHTML = matches.map((e, i) => {
        const label = `${e.full_name}${e.email ? ' — ' + e.email : ''}`;
        return `<button type="button" data-id="${e.id}" data-label="${label.replace(/"/g,'&quot;')}" class="w-full text-left px-3 py-2 hover:bg-slate-50 flex flex-col">
                  <span class="font-medium">${e.full_name}</span>
                  <span class="text-xs text-slate-500">${e.email || ''}</span>
                </button>`;
      }).join('');

      activeIndex = -1;
      // Mobile overlay: make the dropdown fixed & edge-to-edge
      if (window.innerWidth < 640) {
        box.className = "fixed inset-0 bg-white z-50 overflow-auto p-3";
        box.style.borderRadius = "0";
        // sticky close + hint
        const head = document.createElement('div');
        head.className = "sticky top-0 bg-white pb-2 mb-2 border-b flex items-center justify-between";
        head.innerHTML = `
          <div class="text-sm text-slate-600">Results for: <span class="font-medium">${q}</span></div>
          <button id="close-emp" class="px-3 py-1 rounded-lg border text-sm">Close</button>`;
        box.prepend(head);
        $('close-emp').onclick = hideResults;
      } else {
        box.className = "absolute left-0 right-0 top-full mt-1 bg-white border border-jc-border rounded-xl shadow-2xl max-h-96 overflow-auto z-50";
        box.style.borderRadius = "";
      }

      box.classList.remove('hidden');
      // bind clicks
      $$('#employee-results button').forEach(btn => {
        btn.addEventListener('click', async () => {
          const id = btn.getAttribute('data-id');
          const label = btn.getAttribute('data-label');
          await onSelectEmployee(id, label);
        });
      });
    }

    function hideResults(){ const box = $('employee-results'); if(!box) return; box.classList.add('hidden'); box.innerHTML=''; activeIndex = -1; }

    async function onSelectEmployee(id, label){
      $('employee-search').value = label || '';
      $('employee-id').value = id || '';
      hideResults();
      const emp = employees.find(x => x.id === id);
      if(emp && typeof emp.hourly_rate === 'number'){ $('rate').value = emp.hourly_rate; }
      if(id){ const count = await fetchTodayCount(id); updateTodayCount(count); }
      if($('history-filter')){ $('history-filter').value = id; await loadHistory(); }
      recalc(true);
    }

    function moveActive(delta){
      const items = $$('#employee-results button'); if(items.length === 0) return;
      activeIndex = (activeIndex + delta + items.length) % items.length;
      items.forEach((el,i)=> el.classList.toggle('result-active', i===activeIndex));
      items[activeIndex].scrollIntoView({ block:'nearest' });
    }
    async function selectActive(){
      const items = $$('#employee-results button'); if(items.length === 0 || activeIndex < 0) return;
      const btn = items[activeIndex];
      const id = btn.getAttribute('data-id');
      const label = btn.getAttribute('data-label');
      await onSelectEmployee(id, label);
    }

    // ====== EVENTS ======
    window.addEventListener('DOMContentLoaded', () => {
      setLogo(DEFAULT_LOGO_DATA_URI);
      $('year').textContent = new Date().getFullYear();

      $('save-btn').addEventListener('click', saveAdvance);
      $('update-btn').addEventListener('click', updateAdvance);
      $('new-btn').addEventListener('click', clearForm);
      $('pdf-btn').addEventListener('click', () => exportPDF(true));
      $('pdf-upload-btn').addEventListener('click', exportAndUpload);
      $('refresh-history').addEventListener('click', loadHistory);
      $('history-filter').addEventListener('change', loadHistory);
      $('clear-filter').addEventListener('click', async () => {
        $('history-filter').value = 'all';
        $('employee-search').value=''; $('employee-id').value='';
        await loadHistory();
      });

      // Inputs that trigger recalculation
      ['is-server','hours','rate','tips','amount','disciplinary','outstanding'].forEach(id => {
        const el = $(id); if(el){ el.addEventListener('input', () => recalc(true)); el.addEventListener('change', () => recalc(true)); }
      });

      // Custom combo logic
      const input = $('employee-search');
      if(input){
        input.setAttribute('autocomplete','off');
        input.addEventListener('input', (e)=> renderEmployeeResults(e.target.value.trim()));
        input.addEventListener('keydown', async (e) => {
          const visible = !$('employee-results').classList.contains('hidden');
          if(e.key === 'ArrowDown'){ e.preventDefault(); if(!visible) renderEmployeeResults(input.value.trim()); moveActive(1); }
          else if(e.key === 'ArrowUp'){ e.preventDefault(); moveActive(-1); }
          else if(e.key === 'Enter'){ if(visible){ e.preventDefault(); await selectActive(); } }
          else if(e.key === 'Escape'){ hideResults(); }
        });
        document.addEventListener('click', (evt) => {
          const box = $('employee-results'); if(!box) return;
          if(evt.target !== input && !box.contains(evt.target)) hideResults();
        });
      }

      connect();
      recalc(true);
      updateTodayCount(null);
    });
  </script>
</body>
</html>
