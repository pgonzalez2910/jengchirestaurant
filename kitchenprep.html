<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
 <!-- Paste the security check script here -->
    <script>
        const userPermissions = localStorage.getItem('userPermissions');
        if (!userPermissions) {
            window.location.assign('https://portal.jengchirestaurant.com/index.html');
        }
    </script>
    <!-- End of script -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeng Chi Inventory Management</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* CSS variables for a consistent theme */
        :root {
            --primary-color: #3b82f6;
            --primary-dark: #2563eb;
            --bg-color: #f3f4f6;
            --surface-color: #ffffff;
            --text-color: #1f2937;
            --light-text-color: #6b7280;
            --border-color: #e5e7eb;
            --shadow-color: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: 'Inter', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--bg-color);
            color: var(--text-color);
        }

        /* -----------------------
           âœ… Header
           ----------------------- */
        .app-header {
            background-color: var(--surface-color);
            padding: 1.5rem 2rem;
            display: grid;
            grid-template-columns: 1fr auto 1fr; /* Defines three columns for layout */
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        /* Centers the logo and main titles */
        .header-center {
            grid-column: 2 / 3;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Positions the app title in the top-right corner */
        .header-right {
            grid-column: 3 / 4;
            justify-self: end;
        }

        .app-header .branding {
            height: 50px;
            border-radius: 8px;
        }
        
        .app-header .titles {
            display: flex;
            flex-direction: column;
            align-items: center;
            line-height: 1.2;
            text-align: center;
        }

        .app-header .titles h1 {
            margin: 0.5rem 0 0;
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .app-header .titles h3 {
            margin: 0.25rem 0 0;
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-color);
        }

        .app-header .header-right h2 {
            margin: 0;
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--light-text-color);
            align-self: flex-start;
            padding-top: 0.25rem;
        }

        /* -----------------------
           âœ… Main Content
           ----------------------- */
        .main-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 1.5rem;
        }

        /* -----------------------
           âœ… Product Grid
           ----------------------- */
        .product-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 2rem;
        }

        .product-card {
            background-color: var(--surface-color);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px var(--shadow-color);
            display: flex;
            flex-direction: column;
            gap: 1rem;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
        }

        .product-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px var(--shadow-color);
        }

        .product-details {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .product-details img {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .product-name {
            font-weight: 600;
            font-size: 1rem;
        }

        .counter {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-top: auto;
        }

        .counter button {
            background-color: var(--primary-color);
            color: var(--surface-color);
            border: none;
            padding: 0.75rem 1.25rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.25rem;
            font-weight: 600;
            line-height: 1;
            transition: background-color 0.2s ease;
        }

        .counter button:hover {
            background-color: var(--primary-dark);
        }

        .counter input {
            width: 70px;
            text-align: center;
            font-size: 1rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
            outline: none;
        }

        .counter input:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* -----------------------
           âœ… Submit Button
           ----------------------- */
        .submit-container {
            text-align: center;
            margin-top: 3rem;
            margin-bottom: 2rem;
        }

        .submit-btn {
            background-color: #10b981; /* Green color for submit */
            color: white;
            border: none;
            padding: 1rem 3rem;
            font-size: 1.125rem;
            font-weight: 600;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: background-color 0.2s ease;
        }

        .submit-btn:hover {
            background-color: #059669;
        }

        /* -----------------------
           âœ… Responsive Design
           ----------------------- */
        @media (max-width: 768px) {
            .app-header {
                grid-template-columns: 1fr;
                gap: 1rem;
                justify-items: center;
                padding: 1rem;
            }

            .header-right {
                justify-self: center;
            }
            
            .main-container {
                padding: 0 1rem;
            }

            .product-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>

    <!-- âœ… App Header -->
    <header class="app-header">
        <!-- The centered content -->
        <div class="header-center">
            <img class="branding" src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo">
            <div class="titles">
                <h1>JENG CHI RESTAURANT</h1>
                <h3>DAILY INVENTORY</h3>
            </div>
        </div>
        <!-- The right-aligned text -->
        <div class="header-right">
            <h2>JENG CHI MANAGEMENT APP</h2>
        </div>
    </header>

    <!-- âœ… Main Content Container -->
    <div class="main-container">
        <!-- Product Grid -->
        <section id="inventory-list" class="product-grid">
            <!-- Product cards will be loaded here by JavaScript -->
        </section>

        <!-- Submit Button -->
        <div class="submit-container">
            <button class="submit-btn" onclick="submitInventory()">Submit</button>
        </div>
    </div>
    
    <script>
        // ðŸ”‘ Supabase credentials
        const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
        const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        document.addEventListener('DOMContentLoaded', () => {
            // Initial load of inventory, filtered by "Kitchen Prep" as requested.
            loadInventory('Kitchen Prep');
        });

        /**
         * Loads and displays inventory items, grouping duplicate products.
         * @param {string} departmentName - The department name to filter products by.
         */
        async function loadInventory(departmentName) {
            let data = null;
            let error = null;

            try {
                // Attempt to fetch and filter the data by department
                const response = await supabaseClient
                    .from("inventory_products")
                    .select("product_name, image_url, on_hand, department")
                    .eq('department', departmentName);
                
                data = response.data;
                error = response.error;

            } catch (e) {
                console.error("An error occurred during the Supabase query:", e);
                const container = document.getElementById("inventory-list");
                container.innerHTML = `<p style="text-align:center; color:red;">An error occurred while loading inventory. Please check the database connection and 'department' column.</p>`;
                return;
            }

            if (error) {
                console.error("Error loading inventory:", error);
                const container = document.getElementById("inventory-list");
                container.innerHTML = `<p style="text-align:center; color:red;">Error loading inventory. Please check the console for details.</p>`;
                return;
            }
            
            // âœ… Group products and sum quantities
            const groupedProducts = {};
            data.forEach(item => {
                if (!groupedProducts[item.product_name]) {
                    groupedProducts[item.product_name] = {
                        totalOnHand: 0,
                        image_url: item.image_url,
                    };
                }
                groupedProducts[item.product_name].totalOnHand += item.on_hand;
            });

            const container = document.getElementById("inventory-list");
            container.innerHTML = "";

            // âœ… Generate cards for unique products
            for (const productName in groupedProducts) {
                const product = groupedProducts[productName];
                const card = document.createElement("div");
                card.classList.add("product-card");

                card.innerHTML = `
                    <div class="product-details">
                        <img src="${product.image_url || "https://via.placeholder.com/80?text=No+Image"}" alt="${productName}">
                        <div class="product-name">${productName}</div>
                    </div>
                    <div class="counter">
                        <button onclick="updateQuantity('${productName}', -1)">-</button>
                        <input type="number" id="qty-${productName}" value="${product.totalOnHand ?? 0}" min="0">
                        <button onclick="updateQuantity('${productName}', 1)">+</button>
                    </div>
                `;

                container.appendChild(card);
            }
        }

        /**
         * Updates the quantity for all database entries matching a product name.
         * @param {string} productName - The name of the product to update.
         * @param {number} change - The change in quantity (-1 or 1).
         */
        async function updateQuantity(productName, change) {
            const input = document.getElementById(`qty-${productName}`);
            let newValue = parseInt(input.value) + change;
            if (newValue < 0) newValue = 0;
            input.value = newValue;

            // âœ… Auto-save all changes to Supabase
            const { error } = await supabaseClient
                .from("inventory_products")
                .update({ on_hand: newValue })
                .eq("product_name", productName);

            if (error) {
                console.error("Error updating:", error);
            }
        }

        /**
         * Handles the form submission.
         * In a real application, this would trigger a backend process to send an email.
         */
        function submitInventory() {
            // NOTE: Directly sending emails from a web browser is not secure or reliable.
            // This function simulates the process for demonstration purposes.
            // const date = document.getElementById('inventory-date').value;
            
            // Here, you would send the data to a backend server.
            console.log("Submitting inventory...");
            
            // Example of what the data payload would look like
            const products = Array.from(document.querySelectorAll('.product-card')).map(card => {
                const name = card.querySelector('.product-name').textContent;
                const quantity = card.querySelector('input').value;
                return { name, quantity };
            });

            console.log("Payload:", products);
            console.log("Simulating email to: ADMIN@JENGCHIRESTAURANT.COM");
            alert("Inventory has been submitted! An email notification will be sent.");
        }
    </script>
</body>
</html>
