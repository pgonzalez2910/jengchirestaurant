<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake Orders Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif']
          },
          colors: {
            'jc-primary': '#2D3748',
            'jc-secondary': '#4A5568',
            'jc-gold': '#C0A06D',
            'jc-bg': '#F7FAFC',
            'jc-card': '#FFFFFF',
            'jc-border': '#E2E8F0',
            'jc-accent': '#FBD38D',
            'jc-success': '#059669',
            'jc-warning': '#D97706',
            'jc-danger': '#DC2626'
          },
          boxShadow: {
            'jc': '0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)'
          }
        }
      }
    }
  </script>
  <style>
    body{font-family:'Inter',system-ui,sans-serif;}
    .card{background:#fff;border:1px solid #E2E8F0;border-radius:1rem;box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05);}
    .btn{border-radius:.7rem;font-weight:600;padding:.55rem .9rem;border:1px solid #E5E7EB;background:#fff}
    .btn-primary{background:linear-gradient(90deg,#FBD38D,#C0A06D);color:#2D3748;border:none}
    .btn-primary:hover{filter:brightness(1.05)}
    .badge{font-size:.75rem;padding:.25rem .5rem;border-radius:.5rem;border:1px solid #E5E7EB}
    .input{border:1px solid #E2E8F0;border-radius:.5rem;padding:.45rem .6rem;width:100%;}
    .cell{padding:.75rem 1rem;vertical-align:top;}
    /* Full-width stable table (no horizontal scroll / overlapping) */
    table{table-layout:fixed;width:100%}
    thead th, tbody td{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .col-created{width:9.5rem}
    .col-customer{width:10rem}
    .col-contact{width:12rem;white-space:normal}
    .col-ship{width:6.5rem}
    .col-total{width:6.5rem}
    .col-drop{width:8.5rem}
    .col-status{width:9.5rem}
    .col-usps{width:7.5rem}
    .col-track{width:12rem}
    .col-actions{width:9.5rem}
    .col-last{width:18rem;white-space:normal}
    .w-28{width:7rem}
    .w-36{width:9rem}
    .w-44{width:11rem}
  </style>
</head>
<body class="min-h-full">
  <!-- Header -->
  <header class="bg-jc-bg border-b border-jc-border">
    <div class="max-w-screen-2xl mx-auto px-4 md:px-8 py-6 flex items-center gap-4">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-12 w-auto"/>
      <div>
        <h1 class="text-2xl md:text-3xl font-serif-head font-bold text-jc-primary">Mooncake Orders Dashboard</h1>
        <p class="text-sm text-jc-secondary">Review preorders, shipping details, and delivery status</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnRefresh" class="btn btn-primary">Refresh</button>
        <button id="btnExport" class="btn">Export CSV</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-screen-2xl mx-auto px-4 md:px-8 py-8 space-y-6">
    <!-- Filters -->
    <section class="card p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Search</span>
          <input id="q" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2" placeholder="Name, email, phone, city, state, zip, tracking"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Status</span>
          <select id="status" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2">
            <option value="">All</option>
            <option value="pending">pending</option>
            <option value="dropped_off">dropped off</option>
            <option value="delivered">delivered</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date From</span>
          <input id="dateFrom" type="date" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date To</span>
          <input id="dateTo" type="date" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2"/>
        </label>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Orders</div>
        <div id="kpiOrders" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Customer Shipping</div>
        <div id="kpiShip" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Mooncakes</div>
        <div id="kpiMoon" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">USPS Total</div>
        <div id="kpiUSPS" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Packing</div>
        <div id="kpiPack" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-0 overflow-hidden">
      <div>
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 border-b border-jc-border">
            <tr>
              <th class="text-left px-4 py-3 font-semibold col-created">Created</th>
              <th class="text-left px-4 py-3 font-semibold col-customer">Customer</th>
              <th class="text-left px-4 py-3 font-semibold col-contact">Contact</th>
              <th class="text-right px-4 py-3 font-semibold col-ship">Shipping</th>
              <th class="text-right px-4 py-3 font-semibold col-total">Total</th>
              <th class="text-left px-4 py-3 font-semibold col-drop">Drop-off</th>
              <th class="text-left px-4 py-3 font-semibold col-status">Delivery Status</th>
              <th class="text-right px-4 py-3 font-semibold col-usps">USPS Spend $</th>
              <th class="text-left px-4 py-3 font-semibold col-track">Tracking #</th>
              <th class="text-left px-4 py-3 font-semibold col-actions">Actions</th>
              <th class="text-left px-4 py-3 font-semibold col-last">Last USPS Update</th>
            </tr>
          </thead>
          <tbody id="ordersBody" class="divide-y divide-jc-border">
            <tr>
              <td colspan="11" class="px-4 py-8 text-center text-jc-secondary" id="loadingRow">Loading orders…</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-4 py-3 border-t border-jc-border bg-slate-50">
        <div class="text-xs text-jc-secondary" id="rowCount">—</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn">Prev</button>
          <span id="pageInfo" class="text-sm text-jc-secondary">Page 1</span>
          <button id="nextPage" class="btn">Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Supabase config ======
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== State ======
    let RAW = [];
    let VIEW = [];
    let PAGE = 1;
    const PAGE_SIZE = 20;

    // ====== Utils ======
    const fmtUSD = n => n == null ? '—' : `$${(n/100).toFixed(2)}`;
    const fmtDate = s => s ? new Date(s).toLocaleString() : '—';
    function centsFromInput(v){ const x = parseFloat(String(v||'').trim()); return isNaN(x)?0:Math.round(x*100); }
    function dollars(v){ return (v||0)/100; }
    function escapeHTML(s=''){ return s.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    function shipCents(order) {
      const rows = order.mooncake_preorder_shipments || [];
      const viaShipments = rows.reduce((t, r) => t + (r.ship_cents || 0), 0);
      return order.shipping_cost ?? viaShipments;
    }
    function mooncakeCents(order){
      const ship = shipCents(order) || 0;
      return Math.max((order.total_cents||0) - ship, 0);
    }

    // ====== USPS Edge function helper (with 404 fallback to /usps) ======
    async function callUsps(route, payload){
      const headers = {
        "content-type":"application/json",
        "authorization": `Bearer ${SUPABASE_ANON_KEY}`,
        "apikey": SUPABASE_ANON_KEY
      };
      const url1 = `${SUPABASE_URL}/functions/v1/usps/${route}`;
      const url2 = `${SUPABASE_URL}/functions/v1/usps`;
      let res = await fetch(url1, { method:"POST", headers, body: JSON.stringify(payload) });
      if (res.status === 404) res = await fetch(url2, { method:"POST", headers, body: JSON.stringify(payload) });
      if (!res.ok) {
        const text = await res.text();
        throw new Error(`${res.status} ${text || 'USPS function error'}`);
      }
      return await res.json();
    }

    // ====== Fetch ======
    async function fetchOrders() {
      setLoading(true);
      PAGE = 1;
      const { data, error } = await sb
        .from('mooncake_preorders')
        .select(`
          id, customer_name, phone, email, created_at,
          shipping_address, shipping_cost, total_cents,
          delivery_status, usps_spend_cents, tracking_number,
          usps_last_status_text, usps_last_event_at,
          mooncake_preorder_shipments(id, qty, ship_cents, created_at),
          mooncake_preorder_items(unit_amount, qty, product:mooncake_products ( name, category ))
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        document.getElementById('ordersBody').innerHTML =
          `<tr><td colspan="11" class="px-4 py-8 text-center text-red-600">Error loading orders: ${escapeHTML(error.message)}</td></tr>`;
        return;
      }
      RAW = data || [];
      applyFilters();
      setLoading(false);
    }

    function setLoading(isLoading) {
      const row = document.getElementById('loadingRow');
      if (!row) return;
      row.style.display = isLoading ? '' : 'none';
    }

    // ====== Filters ======
    function applyFilters() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const status = document.getElementById('status').value;
      const df = document.getElementById('dateFrom').value;
      const dt = document.getElementById('dateTo').value;

      VIEW = RAW.filter(o => {
        if (status && (o.delivery_status || '').toLowerCase() !== status.toLowerCase()) return false;
        const baseDate = o.created_at;
        if (df && new Date(baseDate) < new Date(df)) return false;
        if (dt && new Date(baseDate) > new Date(dt + 'T23:59:59')) return false;

        if (q) {
          const hay = [
            o.customer_name, o.email, o.phone, o.shipping_address, o.tracking_number
          ].filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      updateKPIs();
      renderPage();
    }

    function updateKPIs() {
      const totalOrders = VIEW.length;
      const totalShip = VIEW.reduce((t,o)=> t + (shipCents(o)||0), 0);
      const totalMoon = VIEW.reduce((t,o)=> t + mooncakeCents(o), 0);
      const totalUSPS = VIEW.reduce((t,o)=> t + (o.usps_spend_cents||0), 0);
      const pack = Math.max(totalShip - totalUSPS, 0);
      document.getElementById('kpiOrders').textContent = totalOrders;
      document.getElementById('kpiShip').textContent = fmtUSD(totalShip);
      document.getElementById('kpiMoon').textContent = fmtUSD(totalMoon);
      document.getElementById('kpiUSPS').textContent = fmtUSD(totalUSPS);
      document.getElementById('kpiPack').textContent = fmtUSD(pack);
    }

    // ====== Table Rendering & Paging ======
    function renderPage() {
      const body = document.getElementById('ordersBody');
      body.innerHTML = '';

      const start = (PAGE-1)*PAGE_SIZE;
      const pageRows = VIEW.slice(start, start + PAGE_SIZE);

      if (pageRows.length === 0) {
        body.innerHTML = `<tr><td colspan="11" class="px-4 py-8 text-center text-jc-secondary">No orders match your filters.</td></tr>`;
      }

      for (const o of pageRows) {
        const lastText = o.usps_last_status_text || '';
        const lastTime = o.usps_last_event_at ? new Date(o.usps_last_event_at).toLocaleString() : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="cell col-created">${fmtDate(o.created_at)}</td>
          <td class="cell col-customer"><div class="font-medium">${escapeHTML(o.customer_name||'')}</div></td>
          <td class="cell col-contact">
            <div>${escapeHTML(o.email||'—')}</div>
            <div class="text-xs text-jc-secondary">${escapeHTML(o.phone||'')}</div>
          </td>
          <td class="cell col-ship text-right">${fmtUSD(shipCents(o))}</td>
          <td class="cell col-total text-right">${fmtUSD(o.total_cents)}</td>

          <td class="cell col-drop">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-dropoff="${o.id}" ${ (o.delivery_status||'')==='dropped_off' ? 'checked' : '' } class="rounded border-jc-border">
              <span class="text-xs text-jc-secondary">Dropped Off</span>
            </label>
          </td>

          <td class="cell col-status">
            <select data-status="${o.id}" class="input w-36">
              ${['pending','dropped_off','delivered'].map(v => `<option value="${v}" ${ (o.delivery_status||'pending')===v?'selected':'' }>${v.replace('_',' ')}</option>`).join('')}
            </select>
          </td>

          <td class="cell col-usps text-right">
            <input data-usps="${o.id}" class="input w-28 text-right" inputmode="decimal" placeholder="0.00"
                   value="${dollars(o.usps_spend_cents||0).toFixed(2)}" />
          </td>

          <td class="cell col-track">
            <input data-track="${o.id}" class="input w-44" placeholder="Tracking #" value="${escapeHTML(o.tracking_number||'')}" />
          </td>

          <td class="cell col-actions">
            <button class="btn btn-primary" data-save="${o.id}">Save</button>
            <button class="btn ml-2" data-refresh="${o.id}">Refresh</button>
            <span class="text-xs text-jc-secondary ml-2" data-saveresult="${o.id}"></span>
          </td>

          <td class="cell col-last" data-last="${o.id}">
            ${ (lastText || lastTime)
                ? `<div class="text-xs text-jc-secondary">${lastTime || '—'}</div><div>${escapeHTML(lastText)}</div>`
                : `<span class="text-xs text-jc-secondary">No updates yet</span>`
            }
          </td>
        `;
        body.appendChild(tr);
      }

      document.getElementById('rowCount').textContent = `${VIEW.length} orders · showing ${pageRows.length} on this page`;
      const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
      document.getElementById('pageInfo').textContent = `Page ${PAGE} of ${totalPages}`;
      document.getElementById('prevPage').disabled = PAGE <= 1;
      document.getElementById('nextPage').disabled = PAGE >= totalPages;

      // Row events
      body.querySelectorAll('input[data-dropoff]').forEach(chk => {
        chk.addEventListener('change', () => {
          const id = chk.getAttribute('data-dropoff');
          const statusSel = body.querySelector(`select[data-status="${id}"]`);
          statusSel.value = chk.checked ? 'dropped_off' : 'pending';
        });
      });

      body.querySelectorAll('button[data-save]').forEach(btn =>
        btn.addEventListener('click', () => handleSave(btn.getAttribute('data-save')))
      );

      body.querySelectorAll('button[data-refresh]').forEach(btn =>
        btn.addEventListener('click', () => handleRefresh(btn.getAttribute('data-refresh')))
      );
    }

    async function handleSave(id){
      const body = document.getElementById('ordersBody');
      const statusSel = body.querySelector(`select[data-status="${id}"]`);
      const uspsInput = body.querySelector(`input[data-usps="${id}"]`);
      const trackInput = body.querySelector(`input[data-track="${id}"]`);
      const resultEl  = body.querySelector(`span[data-saveresult="${id}"]`);

      const delivery_status = statusSel.value;
      const usps_spend_cents = centsFromInput(uspsInput.value);
      const tracking_number = (trackInput.value||'').trim();

      resultEl.textContent = 'Saving…';

      const { error } = await sb
        .from('mooncake_preorders')
        .update({ delivery_status, usps_spend_cents, tracking_number })
        .eq('id', id);

      if (error){
        console.error(error);
        resultEl.textContent = 'Error';
        resultEl.className = 'text-xs text-red-600 ml-2';
        return;
      }

      // Update local cache + KPIs
      const row = RAW.find(r=>r.id===id);
      if (row){
        row.delivery_status = delivery_status;
        row.usps_spend_cents = usps_spend_cents;
        row.tracking_number = tracking_number;
      }
      updateKPIs();

      resultEl.textContent = 'Saved';
      resultEl.className = 'text-xs text-jc-success ml-2';
      setTimeout(()=>{ resultEl.textContent=''; }, 1500);
    }

    async function handleRefresh(id){
      const statusSpan  = document.querySelector(`span[data-saveresult="${id}"]`);
      const lastCell    = document.querySelector(`td[data-last="${id}"]`);
      const row         = RAW.find(r=>r.id===id);
      if (!row || !(row.tracking_number||'').trim()){
        if (statusSpan) { statusSpan.textContent = 'Add tracking first'; statusSpan.className='text-xs text-jc-warning'; setTimeout(()=>statusSpan.textContent='',1500);}
        return;
      }

      if (statusSpan) { statusSpan.textContent = 'Refreshing…'; statusSpan.className = 'text-xs text-jc-secondary'; }

      try {
        const out = await callUsps('refresh-tracking', { preorder_id: id });

        // Update cache with fields returned by your function
        if (out) {
          if (out.status) row.delivery_status = out.status;
          if (out.lastText !== undefined) row.usps_last_status_text = out.lastText;
          if (out.eventTime !== undefined) row.usps_last_event_at = out.eventTime;
        }

        // Update UI
        const time = row.usps_last_event_at ? new Date(row.usps_last_event_at).toLocaleString() : '—';
        const text = row.usps_last_status_text || 'No status text';
        if (lastCell) lastCell.innerHTML = `<div class="text-xs text-jc-secondary">${time}</div><div>${escapeHTML(text)}</div>`;

        // Reflect status select if changed
        const sel = document.querySelector(`select[data-status="${id}"]`);
        if (sel && row.delivery_status) sel.value = row.delivery_status;

        updateKPIs();
        if (statusSpan) { statusSpan.textContent = 'Updated'; statusSpan.className = 'text-xs text-jc-success'; setTimeout(()=>{ statusSpan.textContent=''; }, 1500); }
      } catch (e){
        console.error(e);
        if (statusSpan) { statusSpan.textContent = 'Error'; statusSpan.className = 'text-xs text-red-600'; }
        if (lastCell)    lastCell.innerHTML = `<span class="text-xs text-red-600">${escapeHTML(String(e?.message || e))}</span>`;
      }
    }

    // ====== Events ======
    document.getElementById('btnRefresh').addEventListener('click', fetchOrders);
    document.getElementById('btnExport').addEventListener('click', exportCSV);
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (PAGE>1){ PAGE--; renderPage(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ const max = Math.ceil(VIEW.length/PAGE_SIZE)||1; if (PAGE<max){ PAGE++; renderPage(); }});

    ['q','status','dateFrom','dateTo'].forEach(id => {
      document.getElementById(id).addEventListener('input', debounce(applyFilters, 200));
      document.getElementById(id).addEventListener('change', debounce(applyFilters, 200));
    });

    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }}

    // ====== Export ======
    function exportCSV(){
      const rows = [['Order ID','Customer','Email','Phone','Created','Shipping Cents','Total Cents','Delivery Status','USPS Spend Cents','Tracking #','USPS Last Time','USPS Last Text','Shipping Address']];
      for (const o of VIEW){
        rows.push([
          o.id,
          o.customer_name||'',
          o.email||'',
          o.phone||'',
          new Date(o.created_at||'').toISOString(),
          String(shipCents(o)||0),
          String(o.total_cents||0),
          o.delivery_status||'pending',
          String(o.usps_spend_cents||0),
          (o.tracking_number||''),
          o.usps_last_event_at || '',
          (o.usps_last_status_text||'').replace(/\n/g,' '),
          (o.shipping_address||'').replace(/\n/g,' ')
        ]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mooncake_orders_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ====== Init ======
    fetchOrders();
  </script>

  <footer class="py-8 text-center text-xs text-jc-secondary">© <span id="y"></span> Jeng Chi Restaurant</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
</body>
</html>
