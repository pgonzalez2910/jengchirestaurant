<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake Orders Dashboard</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif'],
          },
          colors: {
            'jc-primary': '#2D3748',
            'jc-secondary': '#4A5568',
            'jc-gold': '#C0A06D',
            'jc-border': '#E2E8F0',
            'jc-success': '#059669',
            'jc-warning': '#D97706',
            'jc-danger': '#DC2626'
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .card { background:#fff; border:1px solid #E2E8F0; border-radius:1rem; }
    .btn { border-radius:.75rem; font-weight:600; padding:.55rem .9rem; border:1px solid #E5E7EB; }
    .btn-primary { background:linear-gradient(90deg,#FBD38D,#C0A06D); color:#2D3748; border:none; }
    .badge { font-size:.75rem; padding:.25rem .5rem; border-radius:.5rem; border:1px solid #E5E7EB; }
    .input { border:1px solid #E2E8F0; border-radius:.5rem; padding:.45rem .6rem; width:100%; }

    /* Full width, no left-right scroll on typical screens */
    .container { max-width: 1400px; }
    table { table-layout: fixed; width: 100%; }
    th, td { vertical-align: top; }
    .nowrap { white-space: nowrap; }
  </style>
</head>
<body class="min-h-full overflow-x-hidden">
  <!-- Header -->
  <header class="bg-white border-b border-jc-border">
    <div class="container mx-auto px-4 md:px-6 py-5 flex items-center gap-4">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-11 w-auto"/>
      <div>
        <h1 class="text-2xl md:text-3xl font-serif-head font-bold text-jc-primary">Mooncake Orders Dashboard</h1>
        <p class="text-sm text-jc-secondary">Review preorders, shipping details, and delivery status</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnRefreshAll" class="btn btn-primary">Refresh</button>
        <button id="btnExport" class="btn">Export CSV</button>
      </div>
    </div>
  </header>

  <main class="container mx-auto px-4 md:px-6 py-6 space-y-6">
    <!-- Filters -->
    <section class="card p-4 md:p-5">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Search</span>
          <input id="q" class="mt-1 input" placeholder="Name, email, phone, city, state, zip, tracking"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Status</span>
          <select id="status" class="mt-1 input">
            <option value="">All</option>
            <option value="pending">pending</option>
            <option value="dropped_off">dropped off</option>
            <option value="delivered">delivered</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date From</span>
          <input id="dateFrom" type="date" class="mt-1 input"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date To</span>
          <input id="dateTo" type="date" class="mt-1 input"/>
        </label>
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-5 gap-4">
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Orders</div>
        <div id="kpiOrders" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>

      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Customer Shipping</div>
        <div id="kpiShip" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>

      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Mooncakes</div>
        <div id="kpiMoon" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>

      <div class="card p-4">
        <div class="text-sm text-jc-secondary">USPS Total</div>
        <div id="kpiUSPS" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>

      <div class="card p-4">
        <div class="text-sm text-jc-secondary">In Packing</div>
        <div id="kpiPacking" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-0 overflow-hidden">
      <table class="text-sm">
        <thead class="bg-slate-100 border-b border-jc-border">
          <tr>
            <th class="px-3 py-3 text-left w-[140px]">Created</th>
            <th class="px-3 py-3 text-left w-[160px]">Customer</th>
            <th class="px-3 py-3 text-left w-[220px]">Contact</th>
            <th class="px-3 py-3 text-right w-[110px]">Shipping</th>
            <th class="px-3 py-3 text-right w-[110px]">Total</th>
            <th class="px-3 py-3 text-left w-[120px]">Drop-off</th>
            <th class="px-3 py-3 text-left w-[150px]">Delivery Status</th>
            <th class="px-3 py-3 text-right w-[120px]">USPS Spend $</th>
            <th class="px-3 py-3 text-left w-[220px]">Tracking #</th>
            <th class="px-3 py-3 text-left w-[190px]">Actions</th>
            <th class="px-3 py-3 text-left">Last USPS Update</th>
          </tr>
        </thead>
        <tbody id="ordersBody" class="divide-y divide-jc-border">
          <tr>
            <td colspan="11" class="px-4 py-8 text-center text-jc-secondary" id="loadingRow">Loading orders…</td>
          </tr>
        </tbody>
      </table>

      <div class="flex items-center justify-between px-4 py-3 border-t border-jc-border bg-slate-50">
        <div class="text-xs text-jc-secondary" id="rowCount">—</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn">Prev</button>
          <span id="pageInfo" class="text-sm text-jc-secondary">Page 1</span>
          <button id="nextPage" class="btn">Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- VIEW MODAL -->
  <div id="viewModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40"></div>
    <div class="absolute inset-0 flex items-center justify-center p-4">
      <div class="w-full max-w-3xl bg-white rounded-xl shadow-2xl border border-jc-border overflow-hidden">
        <div class="flex items-center justify-between px-5 py-3 border-b">
          <h3 id="vmTitle" class="text-lg font-semibold text-jc-primary">Order</h3>
          <div class="flex items-center gap-2">
            <button id="vmPrint" class="btn">Print</button>
            <button id="vmClose" class="btn">Close</button>
          </div>
        </div>

        <div id="vmBody" class="p-5 space-y-5 text-sm"></div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    /***** replace with your values *****/
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    /************************************/

    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // function endpoints (we will try these in order)
    const USPS_REFRESH_FN = `${SUPABASE_URL}/functions/v1/usps/refresh-tracking`;
    const USPS_TRACK_FN   = `${SUPABASE_URL}/functions/v1/usps-track`;
    const USPS_FALLBACK   = `${SUPABASE_URL}/functions/v1/usps`;

    // state
    let RAW = [];
    let VIEW = [];
    let PAGE = 1;
    const PAGE_SIZE = 20;

    // utils
    const fmtUSD = n => n == null ? '—' : `$${(n/100).toFixed(2)}`;
    const fmtDate = s => s ? new Date(s).toLocaleString() : '—';
    function centsFromInput(v){ const x = parseFloat(String(v||'').trim()); return isNaN(x)?0:Math.round(x*100); }
    function dollars(v){ return (v||0)/100; }
    function escapeHTML(s=''){
      return s.replace(/[&<>"]/g, c => ({
        "&":"&amp;",
        "<":"&lt;",
        ">":"&gt;",
        "\"":"&quot;"
      }[c]));
    }

    function shipCents(order) {
      const rows = order.mooncake_preorder_shipments || [];
      const viaShipments = rows.reduce((t, r) => t + (r.ship_cents || 0), 0);
      return order.shipping_cost ?? viaShipments;
    }
    function mooncakeCents(order){
      const ship = shipCents(order) || 0;
      return Math.max((order.total_cents||0) - ship, 0);
    }

    // fetch
    async function fetchOrders(){
      setLoading(true);
      PAGE = 1;
      const { data, error } = await sb
        .from('mooncake_preorders')
        .select(`
          id, customer_name, phone, email, created_at,
          shipping_address, shipping_cost, total_cents,
          drop_off, delivery_status, usps_spend_cents, tracking_number,
          usps_last_status_text, usps_last_event_at,
          mooncake_preorder_shipments(id, qty, ship_cents, created_at),
          mooncake_preorder_items(unit_amount, qty, product:mooncake_products ( name, category ))
        `)
        .order('created_at', { ascending: false });

      if (error){
        console.error(error);
        document.getElementById('ordersBody').innerHTML =
          `<tr><td colspan="11" class="px-4 py-8 text-center text-red-600">Error loading orders: ${escapeHTML(error.message)}</td></tr>`;
        return;
      }
      RAW = data || [];
      applyFilters();
      setLoading(false);
    }

    function setLoading(isLoading){
      const row = document.getElementById('loadingRow');
      if (row) row.style.display = isLoading ? '' : 'none';
    }

    // filters
    function applyFilters(){
      const q = document.getElementById('q').value.trim().toLowerCase();
      const status = document.getElementById('status').value;
      const df = document.getElementById('dateFrom').value;
      const dt = document.getElementById('dateTo').value;

      VIEW = RAW.filter(o=>{
        if (status && (o.delivery_status||'').toLowerCase() !== status.toLowerCase()) return false;

        const baseDate = o.created_at;
        if (df && new Date(baseDate) < new Date(df)) return false;
        if (dt && new Date(baseDate) > new Date(dt + 'T23:59:59')) return false;

        if (q){
          const hay = [
            o.customer_name, o.email, o.phone, o.shipping_address, o.tracking_number
          ].filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      updateKPIs();
      renderPage();
    }

    function updateKPIs(){
      const totalOrders = VIEW.length;
      const customerShip = VIEW.reduce((t,o)=> t + (shipCents(o)||0), 0);
      const totalMoon = VIEW.reduce((t,o)=> t + mooncakeCents(o), 0);
      const totalUSPS = VIEW.reduce((t,o)=> t + (o.usps_spend_cents||0), 0);
      const inPacking = Math.max(customerShip - totalUSPS, 0);

      document.getElementById('kpiOrders').textContent   = totalOrders;
      document.getElementById('kpiShip').textContent     = fmtUSD(customerShip);
      document.getElementById('kpiMoon').textContent     = fmtUSD(totalMoon);
      document.getElementById('kpiUSPS').textContent     = fmtUSD(totalUSPS);
      document.getElementById('kpiPacking').textContent  = fmtUSD(inPacking);
    }

    // rendering
    function renderPage(){
      const body = document.getElementById('ordersBody');
      body.innerHTML = '';

      const start = (PAGE-1)*PAGE_SIZE;
      const pageRows = VIEW.slice(start, start + PAGE_SIZE);

      if (pageRows.length === 0) {
        body.innerHTML = `<tr><td colspan="11" class="px-4 py-8 text-center text-jc-secondary">No orders match your filters.</td></tr>`;
      }

      for (const o of pageRows){
        const ship = shipCents(o);
        const lastText = o.usps_last_status_text || '';
        const lastTime = o.usps_last_event_at ? new Date(o.usps_last_event_at).toLocaleString() : '';

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-3">${fmtDate(o.created_at)}</td>
          <td class="px-3 py-3"><div class="font-medium">${escapeHTML(o.customer_name||'')}</div></td>
          <td class="px-3 py-3">
            <div class="truncate">${escapeHTML(o.email||'—')}</div>
            <div class="text-xs text-jc-secondary">${escapeHTML(o.phone||'')}</div>
          </td>
          <td class="px-3 py-3 text-right">${fmtUSD(ship)}</td>
          <td class="px-3 py-3 text-right">${fmtUSD(o.total_cents)}</td>
          <td class="px-3 py-3">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" data-dropoff="${o.id}" ${o.drop_off ? 'checked' : ''} class="rounded border-jc-border">
              <span class="text-xs text-jc-secondary">Dropped Off</span>
            </label>
          </td>
          <td class="px-3 py-3">
            <select data-status="${o.id}" class="input">
              ${['pending','dropped_off','delivered'].map(v=>`<option value="${v}" ${(o.delivery_status||'pending')===v?'selected':''}>${v}</option>`).join('')}
            </select>
          </td>
          <td class="px-3 py-3 text-right">
            <input data-usps="${o.id}" class="input text-right" inputmode="decimal" placeholder="0.00"
              value="${dollars(o.usps_spend_cents||0).toFixed(2)}" />
          </td>
          <td class="px-3 py-3">
            <input data-track="${o.id}" class="input" placeholder="Tracking #"
              value="${escapeHTML(o.tracking_number||'')}" />
          </td>
          <td class="px-3 py-3">
            <div class="flex items-center gap-2">
              <button class="btn btn-primary" data-save="${o.id}">Save</button>
              <button class="btn" data-refresh="${o.id}">Refresh</button>
              <button class="btn" data-view="${o.id}">View</button>
            </div>
            <div class="text-xs mt-1">
              <span class="text-jc-secondary" data-saveresult="${o.id}"></span>
              <span class="text-jc-secondary" data-refreshresult="${o.id}"></span>
            </div>
          </td>
          <td class="px-3 py-3" data-last="${o.id}">
            ${
              (lastText || lastTime)
                ? `<div class="text-xs text-jc-secondary">${lastTime || '—'}</div><div class="truncate">${escapeHTML(lastText)}</div>`
                : `<span class="text-xs text-jc-secondary">No updates yet</span>`
            }
          </td>
        `;
        body.appendChild(tr);
      }

      document.getElementById('rowCount').textContent = `${VIEW.length} orders · showing ${pageRows.length} on this page`;
      const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
      document.getElementById('pageInfo').textContent = `Page ${PAGE} of ${totalPages}`;
      document.getElementById('prevPage').disabled = PAGE <= 1;
      document.getElementById('nextPage').disabled = PAGE >= totalPages;

      // row events
      body.querySelectorAll('button[data-save]').forEach(btn =>
        btn.addEventListener('click', () => handleSave(btn.getAttribute('data-save')))
      );
      body.querySelectorAll('button[data-refresh]').forEach(btn =>
        btn.addEventListener('click', () => handleRefresh(btn.getAttribute('data-refresh')))
      );
      body.querySelectorAll('button[data-view]').forEach(btn =>
        btn.addEventListener('click', () => openView(btn.getAttribute('data-view')))
      );
    }

    // Save row
    async function handleSave(id){
      const bodyEl = document.getElementById('ordersBody');
      const statusSel = bodyEl.querySelector(`select[data-status="${id}"]`);
      const dropChk    = bodyEl.querySelector(`input[data-dropoff="${id}"]`);
      const uspsInput  = bodyEl.querySelector(`input[data-usps="${id}"]`);
      const trackInput = bodyEl.querySelector(`input[data-track="${id}"]`);
      const resultEl   = bodyEl.querySelector(`span[data-saveresult="${id}"]`);

      const payload = {
        preorder_id: id,
        drop_off: !!dropChk?.checked,
        delivery_status: statusSel?.value || 'pending',
        usps_spend: parseFloat(uspsInput?.value || '0') || 0, // dollars
        tracking_number: (trackInput?.value||'').trim()
      };

      resultEl.textContent = 'Saving…';
      try {
        // persist to the table
        const { error } = await sb
          .from('mooncake_preorders')
          .update({
            drop_off: payload.drop_off,
            delivery_status: payload.delivery_status,
            usps_spend_cents: Math.round(payload.usps_spend * 100),
            tracking_number: payload.tracking_number
          })
          .eq('id', id);
        if (error) throw error;

        // update local cache
        const row = RAW.find(r=>r.id===id);
        if (row){
          row.drop_off = payload.drop_off;
          row.delivery_status = payload.delivery_status;
          row.usps_spend_cents = Math.round(payload.usps_spend * 100);
          row.tracking_number  = payload.tracking_number;
        }
        updateKPIs();

        // optional server-side hook (ignore if not present)
        await callUsps(`${SUPABASE_URL}/functions/v1/usps/save-shipping`, payload).catch(()=>{});

        resultEl.textContent = 'Saved';
        resultEl.className = 'text-jc-success';
        setTimeout(()=>{ resultEl.textContent=''; }, 1500);
      } catch (err){
        console.error(err);
        resultEl.textContent = 'Error';
        resultEl.className = 'text-red-600';
      }
    }

    // Refresh USPS (per row)
    async function handleRefresh(id){
      const row = RAW.find(r=>r.id===id);
      const resultEl = document.querySelector(`span[data-refreshresult="${id}"]`);
      const lastCell = document.querySelector(`td[data-last="${id}"]`);

      if (!row?.tracking_number) {
        resultEl.textContent = 'No tracking #';
        resultEl.className = 'text-red-600';
        setTimeout(()=>{ resultEl.textContent=''; }, 2500);
        return;
      }

      resultEl.textContent = 'Refreshing…';
      resultEl.className = 'text-jc-secondary';

      const urls = [USPS_REFRESH_FN, USPS_TRACK_FN, USPS_FALLBACK];
      let out = null, lastErr = null;

      for (const url of urls) {
        try {
          out = await callUsps(url, { preorder_id: id });
          if (out && out.ok !== false && !out.error) break;
          lastErr = out;
        } catch (e) {
          lastErr = { error:true, message: String(e) };
        }
      }

      try {
        // render details from the function response immediately if available
        if (out && (out.lastText || out.statusText || out.eventTime)) {
          const immediateText = out.lastText || out.statusText || '';
          const immediateTime = out.eventTime ? new Date(out.eventTime).toLocaleString() : '';
          if (immediateText || immediateTime) {
            lastCell.innerHTML =
              `<div class="text-xs text-jc-secondary">${immediateTime || '—'}</div>
               <div class="truncate">${escapeHTML(immediateText)}</div>`;
          }
        }

        // requery to pick up persisted values
        const { data, error } = await sb
          .from('mooncake_preorders')
          .select('usps_last_status_text, usps_last_event_at')
          .eq('id', id)
          .single();

        if (!error) {
          const dbText = data?.usps_last_status_text || '';
          const dbTime = data?.usps_last_event_at ? new Date(data.usps_last_event_at).toLocaleString() : '';
          if (dbText || dbTime) {
            lastCell.innerHTML =
              `<div class="text-xs text-jc-secondary">${dbTime || '—'}</div>
               <div class="truncate">${escapeHTML(dbText)}</div>`;
          }
        }

        if (out && out.ok === false) {
          resultEl.textContent = out.message || 'Not updated';
          resultEl.className = 'text-red-600';
        } else if (error && !(data?.usps_last_status_text || data?.usps_last_event_at)) {
          resultEl.textContent = 'No updates yet';
          resultEl.className = 'text-jc-secondary';
        } else {
          resultEl.textContent = 'Updated';
          resultEl.className = 'text-jc-success';
        }
        setTimeout(()=>{ resultEl.textContent=''; }, 1500);
      } catch (err){
        console.error(err);
        const msg = (lastErr?.text || lastErr?.message || '').slice(0,120) || 'Error';
        resultEl.textContent = msg;
        resultEl.className = 'text-red-600';
        setTimeout(()=>{ resultEl.textContent=''; }, 2500);
      }
    }

    // VIEW: open modal with all details
    function openView(id){
      const o = RAW.find(r=>r.id===id);
      if (!o) return;

      const vm = document.getElementById('viewModal');
      const title = document.getElementById('vmTitle');
      const body  = document.getElementById('vmBody');

      const addrLines = String(o.shipping_address||'')
        .split(/\n+/)
        .map(escapeHTML)
        .join('<br>');

      const items = (o.mooncake_preorder_items || []);
      const rows = items.map((it, idx)=>{
        const name = escapeHTML(it?.product?.name || '');
        const cat  = escapeHTML(it?.product?.category || '—');
        const qty  = it?.qty || 0;
        const unit = it?.unit_amount || 0;
        const line = (unit * qty) || 0;
        return `
          <tr class="${idx%2? 'bg-slate-50':''}">
            <td class="px-3 py-2">${cat}</td>
            <td class="px-3 py-2">${name}</td>
            <td class="px-3 py-2 text-right">${qty}</td>
            <td class="px-3 py-2 text-right">${fmtUSD(unit)}</td>
            <td class="px-3 py-2 text-right">${fmtUSD(line)}</td>
          </tr>`;
      }).join('') || `
          <tr>
            <td colspan="5" class="px-3 py-4 text-center text-jc-secondary">No line items</td>
          </tr>`;

      title.textContent = `Order ${o.id}`;
      body.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Customer</div>
            <div class="text-base font-semibold">${escapeHTML(o.customer_name||'')}</div>
            <div class="text-xs"><a class="text-blue-600 underline" href="mailto:${escapeHTML(o.email||'')}">${escapeHTML(o.email||'—')}</a></div>
            <div class="text-xs">${escapeHTML(o.phone||'')}</div>
          </div>
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Order</div>
            <div>Created: <span class="font-medium">${fmtDate(o.created_at)}</span></div>
            <div>Status: <span class="badge">${escapeHTML(o.delivery_status||'pending')}</span></div>
            <div>Drop-off: <span class="badge">${o.drop_off ? 'Yes' : 'No'}</span></div>
          </div>
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Shipping Address</div>
            <div class="border rounded-md p-2">${addrLines || '—'}</div>
          </div>
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Totals</div>
            <div>Shipping: <span class="font-medium">${fmtUSD(shipCents(o))}</span></div>
            <div>Order Total: <span class="font-medium">${fmtUSD(o.total_cents)}</span></div>
            <div>USPS Spend: <span class="font-medium">${fmtUSD(o.usps_spend_cents)}</span></div>
          </div>
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Tracking</div>
            <div class="font-mono text-xs">${escapeHTML(o.tracking_number||'—')}</div>
          </div>
          <div class="space-y-1">
            <div class="text-xs text-jc-secondary">Last USPS Update</div>
            <div class="text-xs text-jc-secondary">${o.usps_last_event_at ? fmtDate(o.usps_last_event_at) : '—'}</div>
            <div>${escapeHTML(o.usps_last_status_text||'')}</div>
          </div>
        </div>

        <div class="pt-3 border-t">
          <div class="font-semibold mb-2">Items</div>
          <div class="overflow-auto border rounded-md">
            <table class="w-full text-sm">
              <thead class="bg-slate-100">
                <tr>
                  <th class="px-3 py-2 text-left">Category</th>
                  <th class="px-3 py-2 text-left">Product</th>
                  <th class="px-3 py-2 text-right">Qty</th>
                  <th class="px-3 py-2 text-right">Unit</th>
                  <th class="px-3 py-2 text-right">Total</th>
                </tr>
              </thead>
              <tbody>${rows}</tbody>
            </table>
          </div>
        </div>
      `;

      vm.classList.remove('hidden');

      // close & print handlers
      document.getElementById('vmClose').onclick = () => vm.classList.add('hidden');
      document.getElementById('vmPrint').onclick = () => {
        const printWin = window.open('', '_blank', 'width=900,height=700');
        if (!printWin) return;
        printWin.document.write(`
          <html>
            <head>
              <title>Order ${o.id}</title>
              <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@3.4.10/dist/tailwind.min.css">
              <style>body{font-family:Inter,system-ui,sans-serif;padding:16px}</style>
            </head>
            <body>${document.getElementById('vmBody').innerHTML}</body>
          </html>
        `);
        printWin.document.close();
        printWin.focus();
        printWin.print();
      };

      // click outside to close
      vm.querySelector('.absolute.inset-0.bg-black\\/40').onclick = () => vm.classList.add('hidden');
    }

    // call Edge Function with proper headers + timeout
    async function callUsps(url, body){
      const ctrl = new AbortController();
      const t = setTimeout(()=>ctrl.abort(), 10000);
      try {
        const res = await fetch(url, {
          method: 'POST',
          mode: 'cors',
          headers: {
            'Content-Type': 'application/json',
            'apikey': SUPABASE_ANON_KEY,
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify(body),
          signal: ctrl.signal
        });
        clearTimeout(t);

        const text = await res.text();
        let json = {};
        try { json = text ? JSON.parse(text) : {}; } catch { /* keep text */ }

        if (!res.ok) {
          return { error: true, ok: false, status: res.status, text, message: json?.message || text || 'Request failed' };
        }
        return json;
      } catch (e) {
        clearTimeout(t);
        return { error: true, ok: false, message: String(e) };
      }
    }

    // export CSV
    function exportCSV(){
      const rows = [['Order ID','Customer','Email','Phone','Created','Shipping Cents','Total Cents','Delivery Status','USPS Spend Cents','Tracking #','Last Status','Last Event Time','Shipping Address']];
      for (const o of VIEW){
        rows.push([
          o.id,
          o.customer_name||'',
          o.email||'',
          o.phone||'',
          new Date(o.created_at||'').toISOString(),
          String(shipCents(o)||0),
          String(o.total_cents||0),
          o.delivery_status||'pending',
          String(o.usps_spend_cents||0),
          (o.tracking_number||''),
          (o.usps_last_status_text||''),
          (o.usps_last_event_at||''),
          (o.shipping_address||'').replace(/\n/g,' ')
        ]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mooncake_orders_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // pagination + events
    document.getElementById('btnExport').addEventListener('click', exportCSV);
    document.getElementById('btnRefreshAll').addEventListener('click', fetchOrders);
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (PAGE>1){ PAGE--; renderPage(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ const max = Math.ceil(VIEW.length/PAGE_SIZE)||1; if (PAGE<max){ PAGE++; renderPage(); }});
    ['q','status','dateFrom','dateTo'].forEach(id=>{
      document.getElementById(id).addEventListener('input', debounce(applyFilters, 200));
      document.getElementById(id).addEventListener('change', debounce(applyFilters, 200));
    });
    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }}

    // init
    fetchOrders();
  </script>

  <footer class="py-8 text-center text-xs text-jc-secondary">© <span id="y"></span> Jeng Chi Restaurant</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
</body>
</html>
