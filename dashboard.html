<!DOCTYPE html>
<html lang="en" class="h-full bg-slate-50">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake Orders Dashboard</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            'serif-head': ['Playfair Display','serif'],
            'sans': ['Inter','system-ui','sans-serif']
          },
          colors: {
            'jc-primary': '#2D3748',
            'jc-secondary': '#4A5568',
            'jc-gold': '#C0A06D',
            'jc-bg': '#F7FAFC',
            'jc-card': '#FFFFFF',
            'jc-border': '#E2E8F0',
            'jc-accent': '#FBD38D',
            'jc-success': '#059669',
            'jc-warning': '#D97706',
            'jc-danger': '#DC2626'
          },
          boxShadow: {
            'jc': '0 10px 15px -3px rgba(0,0,0,0.1), 0 4px 6px -2px rgba(0,0,0,0.05)'
          }
        }
      }
    }
  </script>
  <style>
    body { font-family: 'Inter', system-ui, sans-serif; }
    .card { background:#fff; border:1px solid #E2E8F0; border-radius:1rem; box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05); }
    .btn { border-radius:.75rem; font-weight:600; padding:.65rem 1rem; border:1px solid #E5E7EB; }
    .btn-primary { background:linear-gradient(90deg,#FBD38D,#C0A06D); color:#2D3748; border:none; }
    .btn-primary:hover { filter:brightness(1.05); }
    .badge { font-size:.75rem; padding:.25rem .5rem; border-radius:.5rem; border:1px solid #E5E7EB; }
    .scroll-table { overflow:auto; }
    .modal { position:fixed; inset:0; display:none; place-items:center; background:rgba(0,0,0,.4); z-index:50; }
    .modal.show { display:grid; }
    .input { border:1px solid #E2E8F0; border-radius:.5rem; padding:.4rem .6rem; }
    .cell { padding:.5rem 1rem; vertical-align:top; }
  </style>
</head>
<body class="min-h-full">
  <!-- Header -->
  <header class="bg-jc-bg border-b border-jc-border">
    <div class="max-w-7xl mx-auto px-4 md:px-8 py-6 flex items-center gap-4">
      <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-12 w-auto"/>
      <div>
        <h1 class="text-2xl md:text-3xl font-serif-head font-bold text-jc-primary">Mooncake Orders Dashboard</h1>
        <p class="text-sm text-jc-secondary">Review preorders, shipping, and status</p>
      </div>
      <div class="ml-auto flex items-center gap-2">
        <button id="btnRefresh" class="btn btn-primary">Refresh</button>
        <button id="btnExport" class="btn">Export CSV</button>
      </div>
    </div>
  </header>

  <!-- Filters & Stats -->
  <main class="max-w-7xl mx-auto px-4 md:px-8 py-8 space-y-6">
    <!-- Filters -->
    <section class="card p-4 md:p-6">
      <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Search</span>
          <input id="q" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2" placeholder="Name, email, phone, city, state, zip"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Status</span>
          <select id="status" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2">
            <option value="">All</option>
            <option value="pending">Pending</option>
            <option value="dropped_off">Dropped Off</option>
            <option value="delivered">Delivered</option>
          </select>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date From</span>
          <input id="dateFrom" type="date" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2"/>
        </label>
        <label class="block">
          <span class="text-sm font-medium text-jc-secondary">Date To</span>
          <input id="dateTo" type="date" class="mt-1 w-full rounded-lg border border-jc-border px-3 py-2"/>
        </label>
        <!-- (Filter by pickup date removed) -->
      </div>
    </section>

    <!-- KPIs -->
    <section class="grid grid-cols-2 md:grid-cols-4 gap-4">
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Orders</div>
        <div id="kpiOrders" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Shipping</div>
        <div id="kpiShip" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">Total Mooncakes</div>
        <div id="kpiItems" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
      <div class="card p-4">
        <div class="text-sm text-jc-secondary">USPS Total</div>
        <div id="kpiUsps" class="text-2xl font-bold text-jc-primary mt-1">—</div>
      </div>
    </section>

    <!-- Table -->
    <section class="card p-0 overflow-hidden">
      <div class="scroll-table">
        <table class="min-w-full text-sm">
          <thead class="bg-slate-100 border-b border-jc-border">
            <tr>
              <th class="text-left px-4 py-3 font-semibold">Order</th>
              <th class="text-left px-4 py-3 font-semibold">Customer</th>
              <th class="text-left px-4 py-3 font-semibold">Contact</th>
              <th class="text-left px-4 py-3 font-semibold">Created</th>
              <th class="text-right px-4 py-3 font-semibold">Shipping</th>
              <th class="text-right px-4 py-3 font-semibold">Total</th>
              <th class="text-left px-4 py-3 font-semibold">Paid</th>
              <th class="text-left px-4 py-3 font-semibold">Drop-off</th>
              <th class="text-left px-4 py-3 font-semibold">Delivery Status</th>
              <th class="text-left px-4 py-3 font-semibold">USPS Spend $</th>
              <th class="text-left px-4 py-3 font-semibold">Tracking #</th>
              <th class="px-4 py-3"></th>
            </tr>
          </thead>
          <tbody id="ordersBody" class="divide-y divide-jc-border">
            <tr>
              <td colspan="12" class="px-4 py-8 text-center text-jc-secondary" id="loadingRow">Loading orders…</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="flex items-center justify-between px-4 py-3 border-t border-jc-border bg-slate-50">
        <div class="text-xs text-jc-secondary" id="rowCount">—</div>
        <div class="flex items-center gap-2">
          <button id="prevPage" class="btn">Prev</button>
          <span id="pageInfo" class="text-sm text-jc-secondary">Page 1</span>
          <button id="nextPage" class="btn">Next</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Detail Modal (unchanged layout; keeps items breakdown etc.) -->
  <div id="detailModal" class="modal">
    <div class="card max-w-3xl w-[95vw] p-6 bg-white">
      <div class="flex items-start gap-3">
        <div class="flex-1">
          <h3 class="text-xl font-bold text-jc-primary">Order Details</h3>
          <p id="detailSubtitle" class="text-sm text-jc-secondary">—</p>
        </div>
        <button id="closeModal" class="btn">Close</button>
      </div>
      <div class="mt-4 grid md:grid-cols-2 gap-4">
        <div class="space-y-2">
          <div><span class="text-xs text-jc-secondary">Customer</span><div id="dCustomer" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Contact</span><div id="dContact" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Created</span><div id="dCreated" class="font-medium"></div></div>
        </div>
        <div class="space-y-2">
          <div><span class="text-xs text-jc-secondary">Shipping Address</span><div id="dAddress" class="font-medium break-words"></div></div>
          <div><span class="text-xs text-jc-secondary">Shipping Cost</span><div id="dShipCost" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Total</span><div id="dTotal" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Payment</span><div id="dPayment" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Delivery Status</span><div id="dDeliv" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">USPS Spend</span><div id="dUsps" class="font-medium"></div></div>
          <div><span class="text-xs text-jc-secondary">Tracking #</span><div id="dTrack" class="font-medium"></div></div>
        </div>
      </div>

      <div class="mt-6">
        <h4 class="font-semibold text-jc-primary mb-2">Shipments</h4>
        <div class="scroll-table border border-jc-border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th class="text-left px-3 py-2">Recipient</th>
                <th class="text-left px-3 py-2">Address</th>
                <th class="text-right px-3 py-2">Qty</th>
                <th class="text-right px-3 py-2">Ship $</th>
                <th class="text-left px-3 py-2">Created</th>
              </tr>
            </thead>
            <tbody id="dShipments" class="divide-y divide-jc-border"></tbody>
          </table>
        </div>
      </div>

      <div class="mt-6">
        <h4 class="font-semibold text-jc-primary mb-2">Items</h4>
        <div class="scroll-table border border-jc-border rounded-lg">
          <table class="min-w-full text-sm">
            <thead class="bg-slate-100">
              <tr>
                <th class="text-left px-3 py-2">Category</th>
                <th class="text-left px-3 py-2">Product</th>
                <th class="text-right px-3 py-2">Unit</th>
                <th class="text-right px-3 py-2">Qty</th>
                <th class="text-right px-3 py-2">Line</th>
              </tr>
            </thead>
            <tbody id="dItems" class="divide-y divide-jc-border"></tbody>
            <tfoot id="dItemsFoot"></tfoot>
          </table>
        </div>
      </div>

      <div class="mt-6">
        <h4 class="font-semibold text-jc-primary mb-2">Notes</h4>
        <div id="dNotes" class="text-sm text-jc-secondary whitespace-pre-wrap">—</div>
      </div>
    </div>
  </div>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // ====== Supabase config ======
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // ====== State ======
    let RAW = [];
    let VIEW = [];
    let PAGE = 1;
    const PAGE_SIZE = 20;

    // ====== Utils ======
    const toCents = (usd) => Math.round((Number(usd || 0)) * 100);
    const fromCents = (c) => (c == null ? 0 : Number(c)) / 100;
    const fmtUSD = n => n == null ? '—' : `$${fromCents(n).toFixed(2)}`;
    const fmtDate = s => s ? new Date(s).toLocaleString() : '—';
    const shortId = s => s ? s.substring(0,8) : '—';
    function escapeHTML(s=''){ return s.replace(/[&<>"]/g, c=>({"&":"&amp;","<":"&lt;","<": "&lt;",">":"&gt;","\"":"&quot;"}[c])); }

    const itemsSubtotal = (o) =>
      (o.mooncake_preorder_items || []).reduce((t,it)=> t + (Number(it.unit_amount||0) * Number(it.qty||0)), 0);

    const sumShipCents = (o) => {
      const rows = o.mooncake_preorder_shipments || [];
      const viaShipments = rows.reduce((t,r)=> t + (r.ship_cents || 0), 0);
      return o.shipping_cost ?? viaShipments;
    };

    // ====== Fetch ======
    async function fetchOrders() {
      setLoading(true);
      PAGE = 1;
      const { data, error } = await sb
        .from('mooncake_preorders')
        .select(`
          id, customer_name, phone, email, created_at, notes,
          shipping_address, shipping_cost, total_cents,
          payment_status, delivery_status, usps_spend_cents, tracking_number,
          mooncake_preorder_shipments(
            id, recipient_name, address, city, state, zip, qty, ship_cents, created_at
          ),
          mooncake_preorder_items(
            unit_amount, qty, product_id,
            product:mooncake_products ( name, category )
          )
        `)
        .order('created_at', { ascending: false });

      if (error) {
        console.error(error);
        document.getElementById('ordersBody').innerHTML = `
          <tr><td colspan="12" class="px-4 py-8 text-center text-red-600">
            Error loading orders: ${escapeHTML(error.message)}
          </td></tr>`;
        setLoading(false);
        return;
      }

      RAW = data || [];
      applyFilters();
      setLoading(false);
    }

    function setLoading(isLoading) {
      const row = document.getElementById('loadingRow');
      if (!row) return;
      row.style.display = isLoading ? '' : 'none';
    }

    // ====== Filters ======
    function applyFilters() {
      const q = document.getElementById('q').value.trim().toLowerCase();
      const status = document.getElementById('status').value;
      const df = document.getElementById('dateFrom').value;
      const dt = document.getElementById('dateTo').value;

      VIEW = RAW.filter(o => {
        // delivery_status filter
        if (status && (o.delivery_status || 'pending') !== status) return false;

        // created_at date range
        const base = o.created_at;
        if (df && new Date(base) < new Date(df)) return false;
        if (dt && new Date(base) > new Date(dt + 'T23:59:59')) return false;

        // search
        if (q) {
          const hay = [
            o.customer_name, o.email, o.phone, o.shipping_address, o.tracking_number
          ].filter(Boolean).join(' ').toLowerCase();
          if (!hay.includes(q)) return false;
        }
        return true;
      });

      updateKPIs();
      renderPage();
    }

    function updateKPIs() {
      const totalOrders = VIEW.length;
      const totalShip = VIEW.reduce((t,o)=> t + (sumShipCents(o) || 0), 0);
      const totalItems = VIEW.reduce((t,o)=> t + itemsSubtotal(o), 0);
      const totalUsps = VIEW.reduce((t,o)=> t + (o.usps_spend_cents || 0), 0);

      document.getElementById('kpiOrders').textContent = totalOrders;
      document.getElementById('kpiShip').textContent = fmtUSD(totalShip);
      document.getElementById('kpiItems').textContent = fmtUSD(totalItems);
      document.getElementById('kpiUsps').textContent = fmtUSD(totalUsps);
    }

    // ====== Save helpers ======
    async function saveOrder(id, patch) {
      const { error } = await sb.from('mooncake_preorders').update(patch).eq('id', id);
      if (error) {
        console.error('Update failed', error);
        alert('Update failed: ' + (error.message || 'Unknown error'));
      } else {
        // Update in-memory & rerender
        const idx = RAW.findIndex(r=>r.id===id);
        if (idx>=0) RAW[idx] = { ...RAW[idx], ...patch };
        applyFilters();
      }
    }

    const debouncers = new Map();
    function debounceSave(id, key, value, ms=500) {
      const k = id + '::' + key;
      clearTimeout(debouncers.get(k));
      debouncers.set(k, setTimeout(()=> {
        saveOrder(id, { [key]: value });
      }, ms));
    }

    // ====== Table Rendering & Paging ======
    function renderPage() {
      const body = document.getElementById('ordersBody');
      body.innerHTML = '';

      const start = (PAGE-1)*PAGE_SIZE;
      const pageRows = VIEW.slice(start, start + PAGE_SIZE);

      if (pageRows.length === 0) {
        body.innerHTML = `<tr><td colspan="12" class="px-4 py-8 text-center text-jc-secondary">No orders match your filters.</td></tr>`;
      }

      for (const o of pageRows) {
        const paid = (o.payment_status||'').toLowerCase()==='paid';
        const deliv = (o.delivery_status||'pending');

        const tr = document.createElement('tr');
        tr.className = 'hover:bg-slate-50';

        tr.innerHTML = `
          <td class="cell"><div class="font-semibold">#${shortId(o.id)}</div><div class="text-xs text-jc-secondary">${o.id}</div></td>
          <td class="cell">${escapeHTML(o.customer_name||'')}</td>
          <td class="cell">
            <div>${escapeHTML(o.email||'—')}</div>
            <div class="text-xs text-jc-secondary">${escapeHTML(o.phone||'')}</div>
          </td>
          <td class="cell">${fmtDate(o.created_at)}</td>
          <td class="cell text-right">${fmtUSD(sumShipCents(o))}</td>
          <td class="cell text-right">${fmtUSD(o.total_cents)}</td>
          <td class="cell">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" ${paid?'checked':''} data-paid="${o.id}" class="h-4 w-4 rounded border-jc-border">
              <span class="text-xs">${paid ? 'Paid' : 'Unpaid'}</span>
            </label>
          </td>
          <td class="cell">
            <label class="inline-flex items-center gap-2">
              <input type="checkbox" ${deliv==='dropped_off'?'checked':''} data-drop="${o.id}" class="h-4 w-4 rounded border-jc-border">
              <span class="text-xs">Dropped Off</span>
            </label>
          </td>
          <td class="cell">
            <select data-status="${o.id}" class="input">
              <option value="pending" ${deliv==='pending'?'selected':''}>pending</option>
              <option value="dropped_off" ${deliv==='dropped_off'?'selected':''}>dropped off</option>
              <option value="delivered" ${deliv==='delivered'?'selected':''}>delivered</option>
            </select>
          </td>
          <td class="cell">
            <input data-usps="${o.id}" class="input w-28" type="number" min="0" step="0.01" value="${fromCents(o.usps_spend_cents||0).toFixed(2)}">
          </td>
          <td class="cell">
            <input data-track="${o.id}" class="input w-44" type="text" value="${escapeHTML(o.tracking_number||'')}">
          </td>
          <td class="cell text-right">
            <button class="btn" data-open="${o.id}">View</button>
          </td>
        `;
        body.appendChild(tr);
      }

      // wiring
      body.querySelectorAll('button[data-open]').forEach(btn => btn.addEventListener('click', () => openDetail(btn.getAttribute('data-open'))));
      body.querySelectorAll('input[data-paid]').forEach(cb => {
        cb.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-paid');
          saveOrder(id, { payment_status: e.target.checked ? 'paid' : 'pending' });
        });
      });
      body.querySelectorAll('input[data-drop]').forEach(cb => {
        cb.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-drop');
          const desired = e.target.checked ? 'dropped_off' : 'pending';
          saveOrder(id, { delivery_status: desired });
        });
      });
      body.querySelectorAll('select[data-status]').forEach(sel => {
        sel.addEventListener('change', (e)=>{
          const id = e.target.getAttribute('data-status');
          saveOrder(id, { delivery_status: e.target.value });
        });
      });
      body.querySelectorAll('input[data-usps]').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-usps');
          const cents = toCents(e.target.value || 0);
          debounceSave(id, 'usps_spend_cents', cents);
        });
      });
      body.querySelectorAll('input[data-track]').forEach(inp => {
        inp.addEventListener('input', (e)=>{
          const id = e.target.getAttribute('data-track');
          debounceSave(id, 'tracking_number', e.target.value);
        });
      });

      // paging footer
      document.getElementById('rowCount').textContent = `${VIEW.length} orders · showing ${pageRows.length} on this page`;
      const totalPages = Math.max(1, Math.ceil(VIEW.length / PAGE_SIZE));
      document.getElementById('pageInfo').textContent = `Page ${PAGE} of ${totalPages}`;
      document.getElementById('prevPage').disabled = PAGE <= 1;
      document.getElementById('nextPage').disabled = PAGE >= totalPages;
    }

    // ====== Detail Modal ======
    function openDetail(id) {
      const o = RAW.find(x => x.id === id);
      if (!o) return;
      document.getElementById('detailModal').classList.add('show');
      document.getElementById('detailSubtitle').textContent = `#${shortId(o.id)}`;
      document.getElementById('dCustomer').textContent = o.customer_name || '—';
      document.getElementById('dContact').textContent = [o.email, o.phone].filter(Boolean).join(' • ') || '—';
      document.getElementById('dCreated').textContent = fmtDate(o.created_at);

      const addr = o.shipping_address || '';
      document.getElementById('dAddress').textContent = addr || '—';
      document.getElementById('dShipCost').textContent = fmtUSD(sumShipCents(o));
      document.getElementById('dTotal').textContent = fmtUSD(o.total_cents);
      document.getElementById('dPayment').textContent = (o.payment_status||'pending');
      document.getElementById('dDeliv').textContent = (o.delivery_status||'pending');
      document.getElementById('dUsps').textContent = fmtUSD(o.usps_spend_cents||0);
      document.getElementById('dTrack').textContent = o.tracking_number || '—';
      document.getElementById('dNotes').textContent = o.notes || '—';

      // Shipments table
      const shipBody = document.getElementById('dShipments');
      shipBody.innerHTML = '';
      for (const r of (o.mooncake_preorder_shipments||[])) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHTML(r.recipient_name||'')}</td>
          <td class="px-3 py-2">${escapeHTML([r.address, r.city, r.state, r.zip].filter(Boolean).join(', ') || '')}</td>
          <td class="px-3 py-2 text-right">${r.qty ?? 0}</td>
          <td class="px-3 py-2 text-right">${fmtUSD(r.ship_cents)}</td>
          <td class="px-3 py-2">${fmtDate(r.created_at)}</td>
        `;
        shipBody.appendChild(tr);
      }

      // Items table with category subtotals + items subtotal
      const items = (o.mooncake_preorder_items || []).slice().sort((a,b) => {
        const ac = (a?.product?.category || '').localeCompare(b?.product?.category || '');
        if (ac !== 0) return ac;
        return (a?.product?.name || '').localeCompare(b?.product?.name || '');
      });

      const itBody = document.getElementById('dItems');
      const itFoot = document.getElementById('dItemsFoot');
      itBody.innerHTML = '';
      itFoot.innerHTML = '';

      if (items.length === 0) {
        itBody.innerHTML = `<tr><td colspan="5" class="px-3 py-3 text-jc-secondary">No items recorded for this order.</td></tr>`;
        return;
      }

      let currentCat = null;
      let catSum = 0;
      let itemsSum = 0;

      function pushCatSubtotalRow(cat, cents) {
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td colspan="4" class="px-3 py-2 text-right font-medium bg-slate-50">Subtotal — ${escapeHTML(cat)}</td>
          <td class="px-3 py-2 text-right font-semibold bg-slate-50">${fmtUSD(cents)}</td>
        `;
        itBody.appendChild(tr);
      }

      for (const it of items) {
        const name = it?.product?.name || '';
        const category = it?.product?.category || 'Uncategorized';
        const unit = it?.unit_amount || 0;
        const qty = it?.qty || 0;
        const line = unit * qty;

        if (currentCat !== null && category !== currentCat) {
          pushCatSubtotalRow(currentCat, catSum);
          catSum = 0;
        }
        currentCat = category;

        itemsSum += line;
        catSum += line;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td class="px-3 py-2">${escapeHTML(category)}</td>
          <td class="px-3 py-2">${escapeHTML(name)}</td>
          <td class="px-3 py-2 text-right">${fmtUSD(unit)}</td>
          <td class="px-3 py-2 text-right">${qty}</td>
          <td class="px-3 py-2 text-right">${fmtUSD(line)}</td>
        `;
        itBody.appendChild(tr);
      }
      if (currentCat !== null) pushCatSubtotalRow(currentCat, catSum);

      const ft = document.createElement('tr');
      ft.innerHTML = `
        <td colspan="4" class="px-3 py-2 text-right font-semibold">Items Subtotal</td>
        <td class="px-3 py-2 text-right font-extrabold">${fmtUSD(itemsSum)}</td>
      `;
      itFoot.appendChild(ft);
    }

    document.getElementById('closeModal').addEventListener('click', ()=> document.getElementById('detailModal').classList.remove('show'));
    document.getElementById('detailModal').addEventListener('click', (e)=>{ if (e.target.id==='detailModal') e.currentTarget.classList.remove('show'); });

    // ====== Events ======
    document.getElementById('btnRefresh').addEventListener('click', fetchOrders);
    document.getElementById('btnExport').addEventListener('click', exportCSV);
    document.getElementById('prevPage').addEventListener('click', ()=>{ if (PAGE>1){ PAGE--; renderPage(); }});
    document.getElementById('nextPage').addEventListener('click', ()=>{ const max = Math.ceil(VIEW.length/PAGE_SIZE)||1; if (PAGE<max){ PAGE++; renderPage(); }});

    ['q','status','dateFrom','dateTo'].forEach(id => {
      const el = document.getElementById(id);
      el.addEventListener('input', debounce(applyFilters, 200));
      el.addEventListener('change', debounce(applyFilters, 200));
    });

    function debounce(fn, wait){ let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), wait); }}

    // ====== Export (updated CSV) ======
    function exportCSV(){
      const rows = [[
        'Order ID','Customer','Email','Phone','Created',
        'Shipping Cents','Total Cents','Payment Status','Delivery Status',
        'USPS Spend Cents','Tracking Number','Shipping Address','Notes'
      ]];
      for (const o of VIEW){
        rows.push([
          o.id,
          o.customer_name||'',
          o.email||'',
          o.phone||'',
          new Date(o.created_at||'').toISOString(),
          String(sumShipCents(o)||0),
          String(o.total_cents||0),
          o.payment_status||'',
          o.delivery_status||'',
          String(o.usps_spend_cents||0),
          o.tracking_number||'',
          (o.shipping_address||'').replace(/\n/g,' '),
          (o.notes||'').replace(/\n/g,' ')
        ]);
      }
      const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `mooncake_orders_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    // ====== Init ======
    fetchOrders();
  </script>

  <footer class="py-8 text-center text-xs text-jc-secondary">© <span id="y"></span> Jeng Chi Restaurant</footer>
  <script>document.getElementById('y').textContent = new Date().getFullYear();</script>
</body>
</html>
