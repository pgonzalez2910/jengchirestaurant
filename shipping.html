<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Mooncake 2025 Pre-Order</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">

  <!-- Supabase JS v2 -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    :root{
      --jc-primary:#7A3D36; --jc-primary-dark:#5c2e29;
      --ink:#fff;
    }
    html,body{height:100%}
    body{font-family:Montserrat,system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,'Helvetica Neue',Arial,'Noto Sans',sans-serif;background:#120706;color:var(--ink);margin:0}

    .bg-waves{position:fixed;inset:0;z-index:-1;overflow:hidden;background:
      radial-gradient(1200px 800px at 50% 20%, rgba(255,219,200,.18), transparent 60%),
      radial-gradient(1200px 800px at 50% 80%, rgba(255,219,200,.12), transparent 60%),
      radial-gradient(circle at center, #7A3D36 0%, #2B0F0D 60%, #120706 100%);}
    .bg-waves::before,.bg-waves::after{content:"";position:absolute;inset:-20%;background:conic-gradient(from 0deg,#ffd7be22,#ffffff11,#ffd7be22,#ffffff00);filter:blur(40px);animation:spin 28s linear infinite}
    .bg-waves::after{animation-duration:40s;mix-blend-mode:overlay;opacity:.6}
    @keyframes spin{to{transform:rotate(360deg)}}

    .panel{background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.07));border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(8px);box-shadow:0 18px 48px rgba(0,0,0,.45), inset 0 1px 0 rgba(255,255,255,.22);border-radius:22px}
    .btn{background:var(--jc-primary);color:#fff;border-radius:12px;padding:.65rem .9rem;font-weight:700;box-shadow:0 10px 24px rgba(122,61,54,.38);transition:.2s ease}
    .btn:hover{transform:translateY(-1px);background:var(--jc-primary-dark);box-shadow:0 16px 36px rgba(122,61,54,.5)}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.35);color:#fff;border-radius:12px;padding:.55rem .85rem}
    .qty{width:64px;text-align:center}
    .row{display:grid;grid-template-columns: 1.4fr 0.6fr 0.9fr 1fr;gap:14px;align-items:center}
    @media (max-width: 640px){ .row{grid-template-columns: 1fr 0.5fr 1fr} .hide-sm{display:none} }
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent)}
    .price{font-weight:800}
    .logo-glow{filter:drop-shadow(0 0 28px rgba(255,228,204,.85)) drop-shadow(0 0 6px rgba(255,255,255,.6))}
    .address-input{width:100%; padding:0.4rem; border-radius:8px; border:1px solid rgba(255,255,255,.3); background:rgba(255,255,255,.1); color:#fff;}
  </style>
</head>
<body class="min-h-full">
  <div class="bg-waves" aria-hidden="true"></div>

  <!-- HEADER -->
  <header class="w-full pt-8 pb-4 flex flex-col items-center gap-3">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-20 w-auto logo-glow" />
    <h1 class="text-3xl md:text-4xl font-extrabold">Mooncake 2025 — Pre-Order</h1>
    <p class="opacity-90 text-center px-4">Choose any 4 or 8 mooncakes per address. Shipping is flat $60 per address (up to 8 mooncakes).</p>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-7xl px-5 pb-24">
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- LEFT: Product list -->
      <section class="lg:col-span-2 space-y-8" id="groupedRoot"></section>

      <!-- RIGHT: Cart -->
      <aside class="panel p-6 h-max sticky top-6">
        <h3 class="text-xl font-bold">Order Summary</h3>
        <div id="cartList" class="mt-3 space-y-2 text-sm"></div>
        <div class="mt-3 divider"></div>
        <div class="mt-3 flex items-center justify-between text-lg">
          <span>Subtotal</span>
          <span id="cartSubtotal" class="price">$0.00</span>
        </div>
        <div class="mt-1 flex items-center justify-between text-lg">
          <span>Shipping</span>
          <span id="cartShipping" class="price">$0.00</span>
        </div>
        <div class="mt-1 flex items-center justify-between text-lg">
          <span>Total</span>
          <span id="cartTotal" class="price">$0.00</span>
        </div>

        <div class="mt-6 grid gap-3">
          <button id="btnSavePreorder" class="btn">Reserve (no payment yet)</button>
          <p class="text-xs opacity-80">Flat shipping: $60 per address (up to 8 mooncakes).</p>
        </div>
      </aside>
    </div>
  </main>

  <footer class="py-8 text-center text-xs opacity-80">© <span id="y"></span> Jeng Chi Restaurant</footer>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const cart = new Map();
    let allProducts = [];

    const fmtUSD = cents => `$${(cents/100).toFixed(2)}`;

    function addToCart(p, qty){
      if(qty <= 0) return;
      const current = cart.get(p.id) || { product:p, qty:0, address:'' };
      current.qty += qty;
      cart.set(p.id, current);
      updateCartUI();
    }

    function calcShipping(addressGroups){
      let total = 0;
      for(const addr in addressGroups){
        const qty = addressGroups[addr];
        if(qty % 4 !== 0){
          return { error: `Address "${addr}" must order in multiples of 4 (current ${qty}).` };
        }
        const blocks = Math.ceil(qty/8);
        total += blocks * 60_00; // $60 in cents
      }
      return { total };
    }

    function updateCartUI(){
      const list = document.getElementById('cartList');
      const subtotalEl = document.getElementById('cartSubtotal');
      const shippingEl = document.getElementById('cartShipping');
      const totalEl = document.getElementById('cartTotal');
      list.innerHTML = '';
      let subtotal = 0;

      const addressGroups = {};

      for (const [id, item] of cart){
        subtotal += item.product.price_cents * item.qty;

        const row = document.createElement('div');
        row.className = 'row';
        row.innerHTML = `
          <div class="font-semibold">${item.product.name}</div>
          <div class="price">${fmtUSD(item.product.price_cents)}</div>
          <div class="flex flex-col gap-1">
            <div class="flex items-center gap-2">
              <button class="btn-ghost px-2" aria-label="dec">−</button>
              <input class="panel qty py-1" type="number" min="0" step="1" value="${item.qty}" />
              <button class="btn-ghost px-2" aria-label="inc">+</button>
              <button class="btn-ghost px-3" aria-label="remove">×</button>
            </div>
            <input class="address-input" type="text" placeholder="Delivery Address" value="${item.address||''}" />
          </div>
          <div class="text-right">${fmtUSD(item.product.price_cents * item.qty)}</div>
        `;

        const btnDec = row.querySelector('button[aria-label="dec"]');
        const btnInc = row.querySelector('button[aria-label="inc"]');
        const qtyInput = row.querySelector('input[type="number"]');
        const btnRem = row.querySelector('button[aria-label="remove"]');
        const addrInput = row.querySelector('.address-input');

        const commitQty = (q)=>{ if(q<=0){cart.delete(id);} else {item.qty=q; cart.set(id,item);} updateCartUI(); };

        btnDec.onclick = ()=>commitQty(item.qty-1);
        btnInc.onclick = ()=>commitQty(item.qty+1);
        qtyInput.onchange = ()=>commitQty(parseInt(qtyInput.value,10));
        btnRem.onclick = ()=>{ cart.delete(id); updateCartUI(); };
        addrInput.onchange = ()=>{ item.address=addrInput.value.trim(); cart.set(id,item); updateCartUI(); };

        list.appendChild(row);

        if(item.address){
          addressGroups[item.address] = (addressGroups[item.address]||0) + item.qty;
        }
      }

      subtotalEl.textContent = fmtUSD(subtotal);

      const shippingResult = calcShipping(addressGroups);
      if(shippingResult.error){
        shippingEl.textContent = '⚠️ Error';
        totalEl.textContent = shippingResult.error;
      } else {
        const shipping = shippingResult.total;
        shippingEl.textContent = fmtUSD(shipping);
        totalEl.textContent = fmtUSD(subtotal+shipping);
      }
    }

    function renderSection(category, products){
      const wrap = document.createElement('section');
      wrap.className = 'panel overflow-hidden';
      wrap.innerHTML = `<div class="p-5">
        <h2 class="text-2xl font-bold mb-3">${category}</h2>
        <div data-rows></div></div>`;
      const rows = wrap.querySelector('[data-rows]');
      for(const p of products){
        const row = document.createElement('div');
        row.className = 'row items-center py-3';
        row.innerHTML = `
          <div class="font-semibold">${p.name}</div>
          <div class="price">${fmtUSD(p.price_cents)}</div>
          <div class="flex items-center gap-2">
            <button class="btn-ghost px-3" aria-label="minus">−</button>
            <input class="panel qty py-2" type="number" min="1" step="1" value="1"/>
            <button class="btn-ghost px-3" aria-label="plus">+</button>
            <button class="btn" aria-label="add">Add</button>
          </div>
          <div class="hide-sm text-right opacity-80">${fmtUSD(p.price_cents)}</div>`;
        const qtyInput = row.querySelector('input[type="number"]');
        row.querySelector('button[aria-label="minus"]').onclick=()=>{ qtyInput.value=Math.max(1,parseInt(qtyInput.value)-1); };
        row.querySelector('button[aria-label="plus"]').onclick =()=>{ qtyInput.value=parseInt(qtyInput.value)+1; };
        row.querySelector('button[aria-label="add"]').onclick=()=>{ addToCart(p,parseInt(qtyInput.value)); };
        rows.appendChild(row);
        rows.appendChild(Object.assign(document.createElement('div'),{className:'divider'}));
      }
      return wrap;
    }

    function renderGrouped(products){
      const root = document.getElementById('groupedRoot');
      root.innerHTML = '';
      const groups={};
      for(const p of products){ (groups[p.category] ||= []).push(p); }
      for(const cat of Object.keys(groups)){
        root.appendChild(renderSection(cat,groups[cat]));
      }
    }

    async function loadProducts(){
      const { data, error } = await supabaseClient.from('mooncake_products').select('*').eq('is_active',true);
      if(error){ console.error(error); return; }
      allProducts=data||[]; renderGrouped(allProducts);
    }

    document.getElementById('y').textContent=new Date().getFullYear();
    loadProducts();
  </script>
</body>
</html>
