<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Jeng Chi — Mooncake 2025 Pre-Order</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{--jc-primary:#7A3D36;--jc-primary-dark:#5c2e29;--ink:#fff;}
    body{font-family:Montserrat,sans-serif;background:#120706;color:var(--ink);margin:0;}
    .bg-waves{position:fixed;inset:0;z-index:-1;overflow:hidden;
      background:radial-gradient(1200px 800px at 50% 20%, rgba(255,219,200,.18),transparent 60%),
                 radial-gradient(1200px 800px at 50% 80%, rgba(255,219,200,.12),transparent 60%),
                 radial-gradient(circle at center, #7A3D36 0%,#2B0F0D 60%,#120706 100%);}
    .bg-waves::before,.bg-waves::after{content:"";position:absolute;inset:-20%;
      background:conic-gradient(from 0deg,#ffd7be22,#ffffff11,#ffd7be22,#ffffff00);
      filter:blur(40px);animation:spin 28s linear infinite;}
    .bg-waves::after{animation-duration:40s;mix-blend-mode:overlay;opacity:.6;}
    @keyframes spin{to{transform:rotate(360deg);}}
    .panel{background:linear-gradient(180deg,rgba(255,255,255,.16),rgba(255,255,255,.07));
      border:1px solid rgba(255,255,255,.22);backdrop-filter:blur(8px);
      box-shadow:0 18px 48px rgba(0,0,0,.45),inset 0 1px 0 rgba(255,255,255,.22);
      border-radius:22px;}
    .btn{background:var(--jc-primary);color:#fff;border-radius:12px;padding:.65rem .9rem;
      font-weight:700;transition:.2s ease;}
    .btn:hover{background:var(--jc-primary-dark);transform:translateY(-1px);}
    .btn-ghost{background:transparent;border:1px solid rgba(255,255,255,.35);
      color:#fff;border-radius:12px;padding:.55rem .85rem;}
    .qty{width:64px;text-align:center;}
    .row{display:grid;grid-template-columns:1.4fr 0.6fr 1.6fr 1fr;gap:14px;align-items:center;}
    @media(max-width:640px){.row{grid-template-columns:1fr 0.5fr 1fr}.hide-sm{display:none}}
    .divider{height:1px;background:linear-gradient(90deg,transparent,rgba(255,255,255,.22),transparent);}
    .price{font-weight:800;}
    .logo-glow{filter:drop-shadow(0 0 28px rgba(255,228,204,.85));}
    .address-input{width:100%;padding:.4rem;border-radius:8px;
      border:1px solid rgba(255,255,255,.3);background:rgba(255,255,255,.1);color:#fff;}
    .suggestion-list{position:relative;}
    .suggestions{position:absolute;top:100%;left:0;right:0;background:#fff;color:#000;
      max-height:200px;overflow:auto;border-radius:4px;z-index:50;}
    .suggestion{padding:.5rem;cursor:pointer;}
    .suggestion:hover{background:#f0f0f0;}
  </style>
</head>
<body class="min-h-full">
  <div class="bg-waves"></div>
  <header class="text-center p-8">
    <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Logo" class="h-20 mx-auto logo-glow">
    <h1 class="text-3xl font-extrabold mt-2">Mooncake 2025 — Pre-Order</h1>
    <p class="opacity-90 mt-1">Order by multiples of 4 per address. Flat shipping $60/address (up to 8 mooncakes).</p>
  </header>

  <main class="max-w-7xl mx-auto px-5 pb-24 grid grid-cols-1 lg:grid-cols-3 gap-6">
    <section class="lg:col-span-2 space-y-8" id="groupedRoot"></section>
    <aside class="panel p-6 sticky top-6">
      <h3 class="text-xl font-bold mb-3">Order Summary</h3>
      <div id="cartList" class="space-y-2 text-sm"></div>
      <div class="divider my-3"></div>
      <div class="text-lg flex justify-between"><span>Subtotal</span><span id="cartSubtotal" class="price">$0.00</span></div>
      <div class="text-lg flex justify-between"><span>Shipping</span><span id="cartShipping" class="price">$0.00</span></div>
      <div class="text-lg flex justify-between"><span>Total</span><span id="cartTotal" class="price">$0.00</span></div>
      <button id="btnSavePreorder" class="btn w-full mt-6">Reserve (no payment yet)</button>
    </aside>
  </main>

  <footer class="text-center py-8 text-xs opacity-80">© <span id="y"></span> Jeng Chi Restaurant</footer>

  <script>
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";

    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const cart = new Map();
    const fmtUSD = cents => `$${(cents/100).toFixed(2)}`;

    // Photon (OpenStreetMap) autocomplete
    async function suggestPlaces(query) {
      const res = await fetch(`https://photon.komoot.io/api/?q=${encodeURIComponent(query)}&limit=5`);
      const data = await res.json();
      return data.features || [];
    }

    function makeAutocomplete(input, item) {
      const wrapper = document.createElement('div');
      wrapper.className = 'suggestion-list';
      input.parentNode.insertBefore(wrapper, input);
      wrapper.appendChild(input);
      const list = document.createElement('div');
      list.className = 'suggestions hidden';
      wrapper.appendChild(list);

      input.addEventListener('input', async () => {
        const q = input.value.trim(); 
        if (!q) { list.classList.add('hidden'); return; }
        const feats = await suggestPlaces(q);
        list.innerHTML = '';
        feats.forEach(f => {
          const div = document.createElement('div');
          div.className = 'suggestion';
          div.textContent = f.properties.name + ', ' + (f.properties.city || f.properties.country);
          div.onclick = () => {
            input.value = div.textContent;
            item.address = div.textContent;
            cart.set(item.product.id, item);
            list.classList.add('hidden');
            updateCartUI();
          };
          list.appendChild(div);
        });
        list.classList.toggle('hidden', feats.length === 0);
      });

      document.addEventListener('click', e => {
        if (!wrapper.contains(e.target)) list.classList.add('hidden');
      });
    }

    function addToCart(p, qty) {
      if (qty <= 0) return;
      const cur = cart.get(p.id) || { product: p, qty: 0, address: '' };
      cur.qty += qty; 
      cart.set(p.id, cur); 
      updateCartUI();
    }

    function updateCartUI() {
      const list = document.getElementById('cartList'),
            subtotalEl = document.getElementById('cartSubtotal'),
            shippingEl = document.getElementById('cartShipping'),
            totalEl = document.getElementById('cartTotal');
      list.innerHTML = '';
      let subtotal = 0, addrGroups = {};

      cart.forEach(item => {
        subtotal += item.product.price_cents * item.qty;
        addrGroups[item.address] = (addrGroups[item.address] || 0) + item.qty;

        const row = document.createElement('div'); 
        row.className = 'row';
        row.innerHTML = `
          <div>${item.product.name}</div>
          <div>${fmtUSD(item.product.price_cents)}</div>
          <div>
            <button class="btn-ghost" aria-label="dec">−</button>
            <input type="number" min="0" value="${item.qty}" class="qty">
            <button class="btn-ghost" aria-label="inc">+</button>
            <button class="btn-ghost" aria-label="remove">×</button>
            <input class="address-input" type="text" placeholder="Address" value="${item.address}">
          </div>
          <div>${fmtUSD(item.product.price_cents * item.qty)}</div>`;
        const [btnDec, qtyInput, btnInc, btnRem, addrInput] = row.querySelectorAll('button, input.address-input');
        btnDec.onclick = () => { const v = +qtyInput.value-1; v>0 ? item.qty=v : cart.delete(item.product.id); updateCartUI(); };
        btnInc.onclick = () => { item.qty += 1; updateCartUI(); };
        qtyInput.onchange = () => { const v = parseInt(qtyInput.value,10); if(v>0) item.qty=v; else cart.delete(item.product.id); updateCartUI(); };
        btnRem.onclick = () => { cart.delete(item.product.id); updateCartUI(); };
        addrInput.onchange = () => { item.address = addrInput.value.trim(); cart.set(item.product.id, item); updateCartUI(); };
        makeAutocomplete(addrInput, item);
        list.appendChild(row);
      });

      subtotalEl.textContent = fmtUSD(subtotal);

      let shipping = 0, errorMsg = '';
      Object.entries(addrGroups).forEach(([addr, qty]) => {
        if (!addr) { errorMsg = 'All items need an address'; return; }
        if (qty % 4 !== 0) { errorMsg = `Address "${addr}" must be multiple of 4`; return; }
        shipping += Math.ceil(qty / 8) * 6000; // $60 per 8 mooncakes (in cents)
      });

      if (errorMsg) {
        shippingEl.textContent = '—';
        totalEl.textContent = errorMsg;
      } else {
        shippingEl.textContent = fmtUSD(shipping);
        totalEl.textContent = fmtUSD(subtotal + shipping);
      }
    }

    function renderSection(cat, prods) {
      const wrap = document.createElement('section'); 
      wrap.className = 'panel p-5';
      wrap.innerHTML = `<h2 class="text-2xl font-bold mb-3">${cat}</h2><div></div>`;
      const container = wrap.lastChild;
      prods.forEach(p => {
        const row = document.createElement('div'); 
        row.className = 'row items-center py-3';
        row.innerHTML = `
          <div>${p.name}</div>
          <div>${fmtUSD(p.price_cents)}</div>
          <div>
            <button class="btn-ghost" aria-label="minus">−</button>
            <input type="number" min="1" value="1" class="qty">
            <button class="btn-ghost" aria-label="plus">+</button>
            <button class="btn" aria-label="add">Add</button>
          </div>`;
        const [btnM, qtyInput, btnP, btnA] = row.querySelectorAll('button, input.qty');
        btnM.onclick = () => qtyInput.value = Math.max(1, +qtyInput.value - 1);
        btnP.onclick = () => qtyInput.value = +qtyInput.value + 1;
        btnA.onclick = () => addToCart(p, +qtyInput.value);
        container.appendChild(row);
        container.appendChild(Object.assign(document.createElement('div'), {className:'divider'}));
      });
      return wrap;
    }

    async function loadProducts() {
      const { data, error } = await supabaseClient.from('mooncake_products').select('*').eq('is_active', true);
      if (error) return console.error(error);
      const grouped = data.reduce((acc, p) => { (acc[p.category] ||= []).push(p); return acc; }, {});
      const root = document.getElementById('groupedRoot');
      root.innerHTML = '';
      Object.entries(grouped).forEach(([cat, prods]) => root.appendChild(renderSection(cat, prods)));
    }

    document.getElementById('y').textContent = new Date().getFullYear();
    loadProducts();
  </script>
</body>
</html>
