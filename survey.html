<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Portal & Survey</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A',
            'jc-muted':'#6B7280',
            'jc-gold':'#C0A06D',
            'jc-border':'#E5E7EB',
            'jc-card':'#FFFFFF'
          },
          boxShadow: { 'elevated':'0 30px 80px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <!-- Supabase JS -->
  <script type="module" defer src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>

  <style>
    .card{ background:#FFF; border:1px solid #E5E7EB; border-radius:20px }
    .gold-btn{ background:#C0A06D; color:#111; }
    .gold-btn:hover{ filter:brightness(0.98) }
    .gold-divider{ height:4px; background:linear-gradient(90deg,#C0A06D,#D7BF8F,#C0A06D); border-radius:999px }
    .choice:hover{ background:#FAFAFA }
    @media print{ .no-print{display:none!important} body{background:#FFF} }

    /* Redesign for centered login */
    #loginSection {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 3rem 1rem;
    }
    /* Corporate Information Layout Styling - COMPACT HORIZONTAL */
    .info-container {
        display: grid;
        grid-template-columns: repeat(2, minmax(0, 1fr));
        gap: 0 4rem; /* Horizontal gap is large, vertical is minimal */
    }
    .info-field {
        padding: 0.5rem 0; /* Minimal vertical padding */
        border-bottom: 1px solid #F3F4F6; /* Very light divider line for grouping */
    }
    /* Vertical separator for second column on desktop */
    @media (min-width: 768px) {
        .info-field:nth-child(2n) {
            border-left: 1px solid #E5E7EB; /* Subtle vertical divider */
            padding-left: 1.5rem;
        }
    }
    
    /* Ensure the last two fields don't have bottom borders */
    .info-container > div:nth-last-child(1),
    .info-container > div:nth-last-child(2) {
        border-bottom: none;
    }
    
    .info-label {
        font-size: 0.75rem; /* text-xs */
        text-transform: uppercase;
        color: #6B7280; /* jc-muted */
        font-weight: 500;
        letter-spacing: 0.05em;
        margin-bottom: 0.125rem;
    }
    .info-value {
        font-weight: 600; /* font-semibold */
        font-size: 1rem; /* text-base */
        color: #0F172A; /* jc-ink */
    }
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <main class="min-h-screen">
    <!-- ===== Login ===== -->
    <section id="loginSection">
      <div class="w-full max-w-sm mx-auto card shadow-elevated p-8 relative overflow-hidden">
        <div class="absolute inset-0 pointer-events-none" style="background:radial-gradient(1200px 400px at 50% -50%, rgba(192,160,109,0.15), transparent)"></div>

        <div class="relative flex flex-col items-center gap-4 pt-4 pb-2">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi Logo" class="h-16 w-auto rounded-xl shadow-md" onerror="this.style.display='none'"/>
          <h1 class="font-serif-head text-3xl tracking-tight text-jc-ink">Employee Access</h1>
          <p class="text-jc-muted text-sm -mt-2">Sign in using your corporate credentials</p>
        </div>

        <form id="loginForm" class="mt-8 space-y-5">
          <div>
            <label class="block text-sm font-medium text-jc-muted mb-1" for="inUsername">Username</label>
            <input id="inUsername" class="w-full rounded-lg border border-jc-border px-3.5 py-2.5 focus:outline-none focus:ring-2 focus:ring-jc-gold placeholder:text-slate-400" placeholder="" autocomplete="username" autofocus>
          </div>
          <div>
            <label class="block text-sm font-medium text-jc-muted mb-1" for="inPIN">PIN</label>
            <input id="inPIN"
                   type="password"
                   inputmode="numeric"
                   pattern="[0-9]{4}"
                   maxlength="4"
                   class="w-full rounded-lg border border-jc-border px-3.5 py-2.5 focus:outline-none focus:ring-2 focus:ring-jc-gold placeholder:text-slate-400 tracking-widest text-center"
                   placeholder="••••"
                   autocomplete="one-time-code"
                   aria-describedby="pinHelp">
            <p id="pinHelp" class="text-xs text-jc-muted mt-1">Enter your 4-digit numeric PIN.</p>
          </div>
          <button id="btnLogin" type="submit" class="w-full gold-btn rounded-lg py-3.5 font-semibold text-lg shadow-md hover:shadow-lg transition-shadow">Sign in to Portal</button>
          <p id="loginError" class="text-sm text-red-600 hidden text-center pt-2"></p>
        </form>

        <div class="text-center text-[10px] text-jc-muted mt-10 border-t border-jc-border pt-4">
          Need Assistance? Contact HR at (972) 669-9094
          <div class="mt-1">400 North Greenville Avenue Ste 11, Richardson TX 75091</div>
        </div>
      </div>
    </section>

      

    <!-- ===== Already Submitted Message ===== -->
    <section id="alreadySection" class="hidden">
      <div class="max-w-3xl mx-auto mt-10 card p-8 text-center">
        <h2 class="font-serif-head text-2xl mb-2">Survey Submitted</h2>
        <p class="text-jc-muted">Our records show you already completed this training survey. Thank you!</p>
        <p class="text-jc-muted mt-1">If you believe this is a mistake, please contact your supervisor.</p>
        <button class="mt-6 gold-btn px-5 py-3 rounded-lg" onclick="location.reload()">OK</button>
      </div>
    </section>

    <!-- ===== Post-login Content (Summary + Survey) -->
    <section id="contentSection" class="hidden">
      <!-- Survey header with address -->
      <div class="bg-white border-t border-b border-jc-border no-print">
        <div class="max-w-6xl mx-auto px-4 md:px-8 py-4 text-sm text-jc-muted flex flex-col md:flex-row gap-2 md:gap-6 md:items-center">
          <div>400 North Greenville Avenue Ste 11, Richardson Texas 75091</div>
          <div class="hidden md:block">•</div>
          <div>admin@jengchirestaurant.com</div>
          <div class="hidden md:block">•</div>
          <div>Tel (972) 669-9094</div>
        </div>
      </div>

      <div class="max-w-6xl mx-auto px-4 md:px-8 py-8 space-y-8">
        
        <!-- SIMPLE GREETING -->
        <p class="text-xl font-semibold text-jc-ink mb-4" id="greetingMessage">Loading Employee Data...</p>

        <!-- Survey -->
        <div class="card p-6 md:p-8 shadow-elevated">
          <div class="flex items-center justify-between">
            <h2 class="font-serif-head text-2xl">Steps of Service — Training Survey</h2>
          </div>

          <div id="surveyMessage" class="mt-4 hidden p-4 rounded-xl text-sm font-medium border border-red-200 bg-red-50 text-red-700"></div>

          <form id="surveyForm" class="mt-6 space-y-6 text-[15px]">
            <!-- (Questions unchanged) -->
            <!-- Q1 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q1. Shipley Donuts provided the kolaches. What was your favorite flavor? <span class="text-jc-muted">(Choose one)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage" required> Sausage</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage with Cheese"> Sausage with Cheese</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage with Cheese & Jalapeño" required> Sausage with Cheese &amp; Jalapeño</label>
              </div>
            </fieldset>

            <!-- Q2 (Choose 2) - required attribute removed from inputs -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q2. When do we place a black bev nap on the table? <span class="text-jc-muted">(Choose 2)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q1" value="When ordering dessert"> <span>When ordering dessert</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q1" value="When the appetizer arrives"> <span>When the appetizer arrives</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q1" value="When we’re pre-bussing"> <span>When we’re pre-bussing</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q1" value="When we greet the guest at the table"> <span>When we greet the guest at the table</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q1" value="When the bev nap is wet"> <span>When the bev nap is wet</span></label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 2 boxes must be selected.</p>
            </fieldset>

            <!-- Q3 (Choose 2) - required attribute removed from inputs -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q3. When do we bring tap water to the guest? <span class="text-jc-muted">(Choose 2)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q2" value="On Tuesday"> <span>On Tuesday</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q2" value="After offering an upsell to bottled water, tea, cocktails."> <span>After offering an upsell to bottled water, tea, cocktails.</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q2" value="We do not automatically bring water glasses to the table."> <span>We do not automatically bring water glasses to the table.</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q2" value="When the guest asks for tap water"> <span>When the guest asks for tap water</span></label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 2 boxes must be selected.</p>
            </fieldset>

            <!-- Q4 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q4. What is the rule of 2?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Order 2 Traditional Fruit Cake at a time" required> <span>Order 2 Traditional Fruit Cake at a time</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="2 minute or 2 bite check back" required> <span>2 minute or 2 bite check back</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Send 2 bowls of rice" required> <span>Send 2 bowls of rice</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Greet the customer within the first 2 minutes of being seated" required> <span>Greet the customer within the first 2 minutes of being seated</span></label>
              </div>
            </fieldset>

            <!-- Q5 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q5. What is the rule of 1?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q4" value="Order 1 Traditional Fruit Cake at a time" required> <span>Order 1 Traditional Fruit Cake at a time</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q4" value="There is no rule of 1" required> <span>There is no rule of 1</span></label>
              </div>
            </fieldset>

            <!-- Q6 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q6. According to our Steps of Service, what is the correct order for service?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Fire the orders for drinks and food, deliver food, deliver drinks" required> <span>Fire the orders for drinks and food, deliver food, deliver drinks</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss" required> <span>Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Take tap water to the table, order food, deliver food, order drinks, deliver drinks" required> <span>Take tap water to the table, order food, deliver food, order drinks, deliver drinks</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Serve water, order & serve appetizers and food, order drinks" required> <span>Serve water, order &amp; serve appetizers and food, order drinks</span></label>
              </div>
            </fieldset>

            <!-- Q7 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q7. Which of these is <u>not</u> true when hosting?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="First (early) shift receives large table priority" required> <span>First (early) shift receives large table priority</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Ask the customer what table they would like to sit" required> <span>Ask the customer what table they would like to sit </span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Mark the table you’re taking the guest to" required> <span>Mark the table you’re taking the guest to</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Always tap out table when the guest has left" required> <span>Always tap out table when the guest has left</span></label>
              </div>
            </fieldset>

            <!-- Q8 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q8. When handing the menu we…</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q7" value="Drop a stack on the table" required> <span>Drop a stack on the table</span></label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q7" value="Place the bar menu on the table then hand the menu to the guest" required> <span>Place the bar menu on the table then hand the menu to the guest</span></label>
              </div>
            </fieldset>

            <!-- Q9 (Choose 3) - required attribute removed from inputs -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q9. When do we wipe all menus? <span class="text-jc-muted">(Choose 3)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="11am"> 11am</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="2-4pm"> 2-4pm</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="8-8:30pm"> 8-8:30pm</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="Whenever they are dirty"> Whenever they are dirty</label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 3 boxes must be selected.</p>
            </fieldset>

            <!-- Q10 (Choose 2) - required attribute removed from inputs -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q10. When do we fill the condiments on the table? <span class="text-jc-muted">(Choose 2)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="11am"> 11am</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Before we take our break"> Before we take our break</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Whenever they are used"> Whenever they are used</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Only at closing"> Only at closing</label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 2 boxes must be selected.</p>
            </fieldset>

            <!-- Progress -->
            <div class="mb-2">
              <div class="flex items-center justify-between text-sm text-jc-muted">
                <span>Completion</span>
                <span id="progressPct">0%</span>
              </div>
              <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-[#C0A06D] w-0 rounded-full"></div>
            </div>
            </div>

            <div class="flex items-center justify-between pt-2">
              <button class="no-print gold-btn inline-flex items-center gap-2 rounded-lg px-6 py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                      id="btnSubmit" type="submit" disabled>Submit Survey</button>
              <span id="submitMsg" class="text-sm text-jc-muted"></span>
            </div>
          </form>
        </div>

        <!-- Results (now displayed after submission) -->
        <div id="reportCard" class="card p-6 md:p-8 shadow-elevated hidden">
          <div class="flex items-center justify-between">
            <h2 class="font-serif-head text-2xl">Your Results</h2>
            <button class="no-print border border-jc-border px-4 py-2 rounded-lg hover:bg-slate-50" onclick="window.print()">Print</button>
            
          </div>
          <div id="reportBody" class="mt-4 text-[15px]"></div>
        </div>
        </div>

      <!-- Footer disclaimer -->
      <footer class="mt-8">
        <div class="max-w-6xl mx-auto px-4 md:px-8">
          <div class="gold-divider mb-3"></div>
          <p class="text-xs text-jc-muted pb-8">
            Disclaimer: This training survey is for internal use by Jeng Chi Restaurant employees. By submitting, you confirm that
            answers represent your understanding of the Steps of Service. For questions, contact your supervisor or HR. The English
            version controls in case of any translation differences.
          </p>
        </div>
      </footer>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

    // Supabase (your project)
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elements
    const loginForm = document.getElementById('loginForm');
    const loginSection = document.getElementById('loginSection');
    const contentSection = document.getElementById('contentSection');
    const alreadySection = document.getElementById('alreadySection');

    const inUsername = document.getElementById('inUsername');
    const inPIN = document.getElementById('inPIN');
    const loginError = document.getElementById('loginError');

    const surveyForm = document.getElementById('surveyForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const submitMsg = document.getElementById('submitMsg');
    const surveyMessage = document.getElementById('surveyMessage');

    // Elements for results display
    const reportCard = document.getElementById('reportCard');
    const reportBody = document.getElementById('reportBody');

    // SIMPLE GREETING ELEMENT
    const greetingMessage = document.getElementById('greetingMessage');

    let currentEmp = null;

    // Correct answers for scoring (q6 fixed to remove trailing space)
   const correct = {
    q1: ["When we greet the guest at the table", "When the bev nap is wet"], // Q2 (Choose 2)
    q2: ["When the guest asks for tap water", "After offering an upsell to bottled water, tea, cocktails."], // Q3 (Choose 2)
    q3: "2 minute or 2 bite check back",
    q4: "There is no rule of 1",
    q5: "Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
    q6: "Ask the customer what table they would like to sit", // Q7 (Which is NOT true when hosting)
    q7: "Place the bar menu on the table then hand the menu to the guest", // Q8
    q8: ["2-4pm","8-8:30pm","Whenever they are dirty"],           // Q9 Menus — (Choose 3)
    q9: ["Before we take our break", "Whenever they are used"]      // Q10 Condiments — (Choose 2) **UPDATED**
   };

   // Question mapping for report card
   const QUESTIONS = [
    { key: 'q0', text: 'Q1. Shipley Donuts provided the kolaches. What was your favorite flavor?' },
    { key: 'q1', text: 'Q2. When do we place a black bev nap on the table?' },
    { key: 'q2', text: 'Q3. When do we bring tap water to the guest?' },
    { key: 'q3', text: 'Q4. What is the rule of 2?' },
    { key: 'q4', text: 'Q5. What is the rule of 1?' },
    { key: 'q5', text: 'Q6. According to our Steps of Service, what is the correct order for service?' },
    { key: 'q6', text: 'Q7. Which of these is not true when hosting?' },
    { key: 'q7', text: 'Q8. When handing the menu we…' },
    { key: 'q8', text: 'Q9. When do we wipe all menus?' },
    { key: 'q9', text: 'Q10. When do we fill the condiments on the table?' }
   ];

    // Utils
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const getChecked = (name) => $$( 'input[name="'+name+'"]:checked' ).map(i => i.value);
    const arraysEqualSet = (a,b) => {
      const A = new Set(a), B = new Set(b);
      if (A.size !== B.size) return false;
      for (const v of A) if (!B.has(v)) return false;
      return true;
    };

    // Progress tracking (Q0..Q9 must be complete => 100%)
    const progressBar = document.getElementById('progressBar');
    const progressPct = document.getElementById('progressPct');
    // REQUIRED COUNT: q1, q2, q9 need 2 selections; q8 needs 3 selections. The rest need 1.
    const REQUIRED = { q0:1,q1:2,q2:2,q3:1,q4:1,q5:1,q6:1,q7:1,q8:3,q9:2 };
    const KNOWLEDGE_KEYS = ['q1','q2','q3','q4','q5','q6','q7','q8','q9'];
    const ALL_FORM_FIELDS = Object.keys(REQUIRED);

    function isComplete(name){
      // For radio buttons (where required is 1 and input type is radio)
      if (REQUIRED[name]===1 && document.querySelector(`input[name="${name}"]`)?.type === 'radio') {
        return !!document.querySelector(`input[name="${name}"]:checked`);
      }
      // For checkboxes (q1, q2, q8, q9)
      return getChecked(name).length === REQUIRED[name];
    }
    function computeProgress(){
      const done = ALL_FORM_FIELDS.filter(isComplete).length;
      const pct = Math.round((done / ALL_FORM_FIELDS.length) * 100);
      progressBar.style.width = pct + '%';
      progressPct.textContent = pct + '%';
      btnSubmit.disabled = (pct < 100);
    }
    ALL_FORM_FIELDS.forEach(name=>{
      document.querySelectorAll(`input[name="${name}"]`).forEach(el=>el.addEventListener('change', computeProgress));
    });

    // Multi-select validation (limit to required number)
    $$('input[name="q1"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q1'); if(a.length>2) cb.checked=false; computeProgress(); }));
    $$('input[name="q2"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q2'); if(a.length>2) cb.checked=false; computeProgress(); }));
    $$('input[name="q8"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q8'); if(a.length>3) cb.checked=false; computeProgress(); }));
    $$('input[name="q9"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q9'); if(a.length>2) cb.checked=false; computeProgress(); }));

    function disableSurvey(message, success=false){
      surveyMessage.textContent = message;
      surveyMessage.classList.remove('hidden','border-red-200','bg-red-50','text-red-700','border-green-200','bg-green-50','text-green-700');
      surveyMessage.classList.add(success ? 'border-green-200':'border-red-200', success ? 'bg-green-50':'bg-red-50', success ? 'text-green-700':'text-red-700');
      $$('#surveyForm input').forEach(el=>el.disabled=true);
      btnSubmit.classList.add('hidden');
    }
    
    // Utility to safely format answers for display
    function formatAnswer(answer) {
      if (Array.isArray(answer)) {
        // Handle array of answers (checkboxes)
        if (answer.length === 0) return '<span class="text-red-500 font-semibold italic">No answer selected</span>';
        return answer.map(a => `<span>${a}</span>`).join('<br/>');
      }
      // Handle single string answer (radio buttons)
      return answer || '<span class="text-red-500 font-semibold italic">No answer selected</span>';
    }

    // Function to display results after submission
    function displayResults(answers, score, total) {
        // Hide the survey form/content
        surveyForm.classList.add('hidden');

        let reportHtml = `<div class="mb-6 pb-4 border-b border-jc-border">
            <h3 class="text-4xl font-serif-head mb-1 text-jc-ink">${score}/${total}</h3>
            <p class="text-lg text-jc-muted font-medium">Knowledge Score (Q2 - Q10)</p>
        </div>`;

        // Only iterate over the knowledge questions (q1-q9), skip q0 (kolache flavor)
        const knowledgeQuestions = QUESTIONS.filter(q => KNOWLEDGE_KEYS.includes(q.key));

        knowledgeQuestions.forEach((q) => {
            const key = q.key;
            const userAnswer = answers[key];
            const correctAnswer = correct[key];

            const isCorrect = Array.isArray(correctAnswer)
                ? arraysEqualSet(userAnswer, correctAnswer)
                : (userAnswer === correctAnswer);

            const statusClass = isCorrect ? 'text-green-600' : 'text-red-600';

            reportHtml += `
                <div class="py-4 border-b border-jc-border">
                    <p class="font-semibold text-jc-ink">${q.text}</p>
                    <div class="mt-2 pl-4 space-y-1">
                        <p class="text-sm font-medium ${isCorrect ? 'text-green-600' : 'text-red-600'}">
                            Your Answer: ${formatAnswer(userAnswer)}
                        </p>
                        ${!isCorrect ? `
                            <p class="text-sm font-medium text-green-600">
                                Correct Answer: ${formatAnswer(correctAnswer)}
                            </p>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        reportBody.innerHTML = reportHtml;
        // Show the report card
        reportCard.classList.remove('hidden');
        // Scroll to the results for visibility
        reportCard.scrollIntoView({ behavior: 'smooth' });
    }

    // ===== Login flow (using RPC) =====
    loginForm.addEventListener('submit', async (ev)=>{
      ev.preventDefault();
      loginError.classList.add('hidden');

      const u = inUsername.value.trim();
      const p = inPIN.value.trim();

      if(!u || !p){
        loginError.textContent="Enter username and PIN.";
        loginError.classList.remove('hidden');
        return;
      }
      // EXACTLY 4 DIGITS
      if(!/^\d{4}$/.test(p)){
        loginError.textContent="PIN must be exactly 4 digits.";
        loginError.classList.remove('hidden');
        return;
      }

      try{
        // Attempt login using the hb_auth_employee RPC
        const { data, error } = await sb.rpc('hb_auth_employee', { in_username: u, in_pin: p });
        
        // For debugging login issues:
        console.log('Login RPC Data:', data);
        console.log('Login RPC Error:', error);
        
        if(error) throw error;
        if(!data || !data.length){
          loginError.textContent="Invalid credentials.";
          loginError.classList.remove('hidden');
          return;
        }

        const e = data[0];
        currentEmp = {
          employee_id: e.id,
          username: e.username,
          full_name: e.full_name || '',
          email: e.email || '',
          phone: e.phone || '',
          position: e.position || e["position"] || '',
          department: e.department || '',
          reports_to: e.reports_to || '',
          is_owner: !!e.is_owner
        };

        // NEW: Populate the simple greeting message
        const names = currentEmp.full_name.split(' ');
        const firstName = names[0] || currentEmp.username;
        greetingMessage.textContent = `Hello, ${firstName}! Please complete the training survey below.`;


        // Check already submitted
        const { data: already, error: alreadyErr } = await sb.rpc('hb_ts_already_submitted', { p_employee_id: currentEmp.employee_id });
        if(alreadyErr){
          console.error('already-submitted RPC error:', alreadyErr);
        }

        loginSection.classList.add('hidden');
        if (already === true) {
          contentSection.classList.add('hidden');
          alreadySection.classList.remove('hidden');
        } else {
          alreadySection.classList.add('hidden');
          contentSection.classList.remove('hidden');
          window.scrollTo({ top: 0, behavior: 'smooth' });
          computeProgress();
        }
      }catch(err){
        console.error('Login error:', err);
        loginError.textContent = `Sign-in failed. Error: ${err.message || "Try again."}`;
        loginError.classList.remove('hidden');
      }
    });


   // ===== Submit survey =====
surveyForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!currentEmp) {
    submitMsg.textContent = "Sign in first.";
    submitMsg.classList.add('text-red-600');
    return;
  }

  btnSubmit.disabled = true;
  submitMsg.textContent = "";

  try {
    // Build answers
    const fd = new FormData(surveyForm);
    const a = {
      q0: (fd.get('q0') || "").toString(),
      q1: getChecked('q1'), // Now an array of strings
      q2: getChecked('q2'), // Now an array of strings
      q3: (fd.get('q3') || "").toString(),
      q4: (fd.get('q4') || "").toString(),
      q5: (fd.get('q5') || "").toString(),
      q6: (fd.get('q6') || "").toString().trim(), // Ensure trailing space is trimmed from input
      q7: (fd.get('q7') || "").toString(),
      q8: getChecked('q8'),
      q9: getChecked('q9')
    };

    // New validation check for multi-select questions
    if (a.q1.length !== 2) {
      submitMsg.textContent = "Q2: Pick exactly 2 options.";
      submitMsg.classList.add('text-red-600');
      btnSubmit.disabled = false;
      return;
    }
    if (a.q2.length !== 2) {
      submitMsg.textContent = "Q3: Pick exactly 2 options.";
      submitMsg.classList.add('text-red-600');
      btnSubmit.disabled = false;
      return;
    }
    if (a.q8.length !== 3 || a.q9.length !== 2) {
      submitMsg.textContent = "Q9 & Q10: Check the number of selections required.";
      submitMsg.classList.add('text-red-600');
      btnSubmit.disabled = false;
      return;
    }

    // Calculate score
    let score = 0;
    for (const k of KNOWLEDGE_KEYS) {
      // If the correct answer is an array (multi-select), use arraysEqualSet
      score += Array.isArray(correct[k])
        ? (arraysEqualSet(a[k], correct[k]) ? 1 : 0)
        : (a[k] === correct[k] ? 1 : 0);
    }
    const total = KNOWLEDGE_KEYS.length;

    submitMsg.textContent = "Submitting…";
    submitMsg.classList.remove('text-red-600', 'text-green-600');

    // 🔥 Call the new RPC that writes to hb_ts_submissions
    const { error } = await sb.rpc('hb_ts_submit', {
      p_employee_id: currentEmp.employee_id,
      p_username: currentEmp.username,
      p_full_name: currentEmp.full_name,
      p_phone: currentEmp.phone,
      p_position: currentEmp.position,
      p_department: currentEmp.department,
      p_is_owner: currentEmp.is_owner,
      p_score: score,
      p_total: total,
      p_answers: a
    });

    if (error) throw error;

    submitMsg.textContent = "✅ Submitted successfully! Thank you for completing the survey.";
    submitMsg.classList.remove('text-red-600');
    submitMsg.classList.add('text-green-600');
    disableSurvey("Your survey has been recorded successfully.", true);

    // NEW: Display the results
    displayResults(a, score, total);

  } catch (err) {
    console.error("Submission error:", err);
    submitMsg.textContent = `Save failed: ${err.message || "Unexpected error"}`;
    submitMsg.classList.add('text-red-600');
  } finally {
    btnSubmit.disabled = false;
  }
});


    // Removed: Owner CSV export functionality
    // btnExportCsv.addEventListener('click', ... ) was here

    // Initialize progress UI
    computeProgress();
  </script>
</body>
</html>
