<!DOCTYPE html>
<html lang="en" class="h-full bg-[#FBF8F3]">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jeng Chi — Employee Portal & Survey</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { 'serif-head':['Playfair Display','serif'], sans:['Inter','system-ui','sans-serif'] },
          colors: {
            'jc-ink':'#0F172A',
            'jc-muted':'#6B7280',
            'jc-gold':'#C0A06D',
            'jc-border':'#E5E7EB',
            'jc-card':'#FFFFFF'
          },
          boxShadow: { 'elevated':'0 30px 80px rgba(0,0,0,0.08), 0 8px 24px rgba(0,0,0,0.06)' }
        }
      }
    }
  </script>

  <!-- Supabase JS -->
  <script type="module" defer src="https://esm.sh/@supabase/supabase-js@2?bundle"></script>

  <style>
    .card{ background:#FFF; border:1px solid #E5E7EB; border-radius:20px }
    .gold-btn{ background:#C0A06D; color:#111; }
    .gold-btn:hover{ filter:brightness(0.98) }
    .gold-divider{ height:4px; background:linear-gradient(90deg,#C0A06D,#D7BF8F,#C0A06D); border-radius:999px }
    .choice:hover{ background:#FAFAFA }
    /* Hide report card permanently */
    #reportCard { display: none !important; }
    @media print{ .no-print{display:none!important} body{background:#FFF} }
  </style>
</head>

<body class="h-full font-sans text-jc-ink">
  <main class="min-h-screen">
    <!-- ===== Login ===== -->
    <section id="loginSection" class="px-4 py-12">
      <div class="max-w-xl mx-auto card shadow-elevated p-8 relative overflow-hidden">
        <div class="absolute inset-0 pointer-events-none" style="background:radial-gradient(1200px 400px at 50% -50%, rgba(192,160,109,0.15), transparent)"></div>

        <div class="relative flex flex-col items-center gap-4">
          <img src="https://raw.githubusercontent.com/pgonzalez2910/jengchi-product-images/main/jengchilogo.jpg" alt="Jeng Chi" class="h-16 w-auto rounded-xl shadow-sm" onerror="this.style.display='none'"/>
          <h1 class="font-serif-head text-3xl md:text-[34px] tracking-tight">Employee Portal</h1>
          <p class="text-jc-muted -mt-2">Enterprise Sign-In</p>
        </div>

        <form class="mt-6 space-y-4">
          <div>
            <label class="block text-sm font-medium text-jc-muted mb-1">Username</label>
            <input id="inUsername" class="w-full rounded-xl border border-jc-border px-3.5 py-2.75 focus:outline-none focus:ring-2 focus:ring-jc-gold" placeholder="e.g., pg" autocomplete="username">
          </div>
          <div>
            <label class="block text-sm font-medium text-jc-muted mb-1">PIN</label>
            <input id="inPIN" inputmode="numeric" maxlength="6" class="w-full rounded-xl border border-jc-border px-3.5 py-2.75 focus:outline-none focus:ring-2 focus:ring-jc-gold" placeholder="••••">
          </div>
          <button id="btnLogin" type="button" class="w-full gold-btn rounded-xl py-3 font-semibold">Sign in</button>
          <p id="loginError" class="text-sm text-red-600 hidden"></p>
        </form>

        <div class="text-center text-xs text-jc-muted mt-8">
          400 North Greenville Avenue Ste 11, Richardson TX 75091 · admin@jengchirestaurant.com · Tel (972) 669-9094
          <div class="mt-2">© 2025 Jeng Chi Restaurant — All Rights Reserved</div>
        </div>
      </div>
    </section>

    <!-- ===== Already Submitted Message (separate section) ===== -->
    <section id="alreadySection" class="hidden">
      <div class="max-w-3xl mx-auto mt-10 card p-8 text-center">
        <h2 class="font-serif-head text-2xl mb-2">Survey Submitted</h2>
        <p class="text-jc-muted">Our records show you already completed this training survey. Thank you!</p>
        <p class="text-jc-muted mt-1">If you believe this is a mistake, please contact your supervisor.</p>
        <button class="mt-6 gold-btn px-5 py-3 rounded-lg" onclick="location.reload()">OK</button>
      </div>
    </section>

    <!-- ===== Post-login Content (Summary + Survey) ===== -->
    <section id="contentSection" class="hidden">
      <!-- Survey header with address -->
      <div class="bg-white border-t border-b border-jc-border">
        <div class="max-w-6xl mx-auto px-4 md:px-8 py-4 text-sm text-jc-muted flex flex-col md:flex-row gap-2 md:gap-6 md:items-center">
          <div>400 North Greenville Avenue Ste 11, Richardson Texas 75091</div>
          <div class="hidden md:block">•</div>
          <div>admin@jengchirestaurant.com</div>
          <div class="hidden md:block">•</div>
          <div>Tel (972) 669-9094</div>
        </div>
      </div>

      <div class="max-w-6xl mx-auto px-4 md:px-8 py-8 space-y-8">
        <!-- Employee Summary -->
        <div class="card p-6 md:p-8 shadow-elevated">
          <h2 class="font-serif-head text-2xl">Employee Information</h2>
          <div class="mt-4 grid sm:grid-cols-2 lg:grid-cols-3 gap-4 text-[15px]">
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">Employee</div>
              <div id="empName" class="font-semibold mt-1">—</div>
            </div>
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">User</div>
              <div id="empUser" class="font-semibold mt-1">—</div>
            </div>
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">Position</div>
              <div id="empPos" class="font-semibold mt-1">—</div>
            </div>
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">Department</div>
              <div id="empDept" class="font-semibold mt-1">—</div>
            </div>
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">Phone</div>
              <div id="empPhone" class="font-semibold mt-1">—</div>
            </div>
            <div class="border border-jc-border rounded-xl p-4 bg-[#F9FAFB]">
              <div class="text-xs uppercase text-jc-muted">Session started</div>
              <div id="empSession" class="font-semibold mt-1">—</div>
            </div>
          </div>
        </div>

        <!-- Survey -->
        <div class="card p-6 md:p-8 shadow-elevated">
          <div class="flex items-center justify-between">
            <h2 class="font-serif-head text-2xl">Steps of Service — Training Survey</h2>
            <button id="btnExportCsv" class="no-print hidden px-4 py-2 rounded-lg border border-jc-border text-sm hover:bg-slate-50">Export CSV</button>
          </div>

          <div id="surveyMessage" class="mt-4 hidden p-4 rounded-xl text-sm font-medium border border-red-200 bg-red-50 text-red-700"></div>

          <form id="surveyForm" class="mt-6 space-y-6 text-[15px]">
            <!-- Q1 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q1. Shipley Donuts provided the kolaches. What was your favorite flavor? <span class="text-jc-muted">(Choose one)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage" required> Sausage</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage with Cheese"> Sausage with Cheese</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q0" value="Sausage with Cheese & Jalapeño"> Sausage with Cheese &amp; Jalapeño</label>
              </div>
            </fieldset>

            <!-- Q2 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q2. When do we place a black bev nap on the table?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q1" value="When ordering dessert" required> <span>When ordering dessert</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q1" value="When the appetizer arrives"> <span>When the appetizer arrives</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q1" value="When we’re pre-bussing"> <span>When we’re pre-bussing</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q1" value="When we greet the guest at the table"> <span>When we greet the guest at the table</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q1" value="When the bev nap is wet"> <span>When the bev nap is wet</span></label>
              </div>
            </fieldset>

            <!-- Q3 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q3. When do we bring tap water to the guest?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q2" value="On Tuesday" required> <span>On Tuesday</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q2" value="After offering an upsell to bottled water, tea, cocktails."> <span>After offering an upsell to bottled water, tea, cocktails.</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q2" value="We do not automatically bring water glasses to the table."> <span>We do not automatically bring water glasses to the table.</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q2" value="When the guest asks for tap water"> <span>When the guest asks for tap water</span></label>
              </div>
            </fieldset>

            <!-- Q4 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q4. What is the rule of 2?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Order 2 Traditional Fruit Cake at a time" required> <span>Order 2 Traditional Fruit Cake at a time</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="2 minute or 2 bite check back"> <span>2 minute or 2 bite check back</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Send 2 bowls of rice"> <span>Send 2 bowls of rice</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q3" value="Greet the customer within the first 2 minutes of being seated"> <span>Greet the customer within the first 2 minutes of being seated</span></label>
              </div>
            </fieldset>

            <!-- Q5 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q5. What is the rule of 1?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q4" value="Order 1 Traditional Fruit Cake at a time" required> <span>Order 1 Traditional Fruit Cake at a time</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q4" value="There is no rule of 1"> <span>There is no rule of 1</span></label>
              </div>
            </fieldset>

            <!-- Q6 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q6. According to our Steps of Service, what is the correct order for service?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Fire the orders for drinks and food, deliver food, deliver drinks" required> <span>Fire the orders for drinks and food, deliver food, deliver drinks</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss"> <span>Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Take tap water to the table, order food, deliver food, order drinks, deliver drinks"> <span>Take tap water to the table, order food, deliver food, order drinks, deliver drinks</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q5" value="Serve water, order & serve appetizers and food, order drinks"> <span>Serve water, order &amp; serve appetizers and food, order drinks</span></label>
              </div>
            </fieldset>

            <!-- Q7 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q7. Which of these is <u>not</u> true when hosting?</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="First (early) shift receives large table priority" required> <span>First (early) shift receives large table priority</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Ask the customer what table they would like to sit at"> <span>Ask the customer what table they would like to sit at</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Mark the table you’re taking the guest to"> <span>Mark the table you’re taking the guest to</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q6" value="Always tap out table when the guest has left"> <span>Always tap out table when the guest has left</span></label>
              </div>
            </fieldset>

            <!-- Q8 -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q8. When handing the menu we…</legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q7" value="Drop a stack on the table" required> <span>Drop a stack on the table</span></label>
                <label class="choice flex gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="radio" name="q7" value="Place the bar menu on the table then hand the menu to the seat"> <span>Place the bar menu on the table then hand the menu to the seat</span></label>
              </div>
            </fieldset>

            <!-- Q9 (Choose 3) -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q9. When do we wipe all menus? <span class="text-jc-muted">(Choose 3)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="11am"> 11am</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="2-4pm"> 2-4pm</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="8-8:30pm"> 8-8:30pm</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q8" value="Whenever they are dirty"> Whenever they are dirty</label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 3 boxes must be selected.</p>
            </fieldset>

            <!-- Q10 (Choose 2) -->
            <fieldset class="border border-jc-border rounded-xl p-4">
              <legend class="px-2 text-sm font-semibold">Q10. When do we fill the condiments on the table? <span class="text-jc-muted">(Choose 2)</span></legend>
              <div class="mt-3 grid gap-2">
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="11am"> 11am</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Before we take our break"> Before we take our break</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Whenever they are empty"> Whenever they are empty</label>
                <label class="choice flex items-center gap-3 rounded-lg border border-jc-border px-3 py-2"><input type="checkbox" name="q9" value="Only at closing"> Only at closing</label>
              </div>
              <p class="text-xs text-jc-muted mt-2">Exactly 2 boxes must be selected.</p>
            </fieldset>

            <!-- Progress -->
            <div class="mb-2">
              <div class="flex items-center justify-between text-sm text-jc-muted">
                <span>Completion</span>
                <span id="progressPct">0%</span>
              </div>
              <div class="w-full h-2 bg-slate-200 rounded-full overflow-hidden">
                <div id="progressBar" class="h-2 bg-[#C0A06D] w-0 rounded-full"></div>
              </div>
            </div>

            <div class="flex items-center justify-between pt-2">
              <button class="no-print gold-btn inline-flex items-center gap-2 rounded-lg px-6 py-3 font-semibold disabled:opacity-50 disabled:cursor-not-allowed"
                      id="btnSubmit" type="submit" disabled>Submit Survey</button>
              <span id="submitMsg" class="text-sm text-jc-muted"></span>
            </div>
          </form>
        </div>

        <!-- Results (kept hidden) -->
        <div id="reportCard" class="card p-6 md:p-8 shadow-elevated hidden">
          <div class="flex items-center justify-between">
            <h2 class="font-serif-head text-2xl">Your Results</h2>
            <button class="no-print border border-jc-border px-4 py-2 rounded-lg hover:bg-slate-50" onclick="window.print()">Print</button>
          </div>
          <div id="reportBody" class="mt-4 text-[15px]"></div>
        </div>
      </div>

      <!-- Footer disclaimer -->
      <footer class="mt-8">
        <div class="max-w-6xl mx-auto px-4 md:px-8">
          <div class="gold-divider mb-3"></div>
          <p class="text-xs text-jc-muted pb-8">
            Disclaimer: This training survey is for internal use by Jeng Chi Restaurant employees. By submitting, you confirm that
            answers represent your understanding of the Steps of Service. For questions, contact your supervisor or HR. The English
            version controls in case of any translation differences.
          </p>
        </div>
      </footer>
    </section>
  </main>

  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2?bundle";

    // Supabase (your project)
    const SUPABASE_URL = "https://kpldzwlftkvjjntgsqxx.supabase.co";
    const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImtwbGR6d2xmdGt2ampudGdzcXh4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDY2MzE5NzAsImV4cCI6MjA2MjIwNzk3MH0.qnWbOQv2RLPsIyO-oRwQkAN2VhmmdhTBt46SweUsLbs";
    const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Elements
    const loginSection = document.getElementById('loginSection');
    const contentSection = document.getElementById('contentSection');
    const alreadySection = document.getElementById('alreadySection');

    const inUsername = document.getElementById('inUsername');
    const inPIN = document.getElementById('inPIN');
    const btnLogin = document.getElementById('btnLogin');
    const loginError = document.getElementById('loginError');

    const empName = document.getElementById('empName');
    const empUser = document.getElementById('empUser');
    const empPos = document.getElementById('empPos');
    const empDept = document.getElementById('empDept');
    const empPhone = document.getElementById('empPhone');
    const empSession = document.getElementById('empSession');

    const surveyForm = document.getElementById('surveyForm');
    const btnSubmit = document.getElementById('btnSubmit');
    const submitMsg = document.getElementById('submitMsg');
    const surveyMessage = document.getElementById('surveyMessage');
    const btnExportCsv = document.getElementById('btnExportCsv');

    let currentEmp = null;

    // Correct answers for scoring
    const correct = {
      q1: "When we greet the guest at the table",
      q2: "After offering an upsell to bottled water, tea, cocktails.",
      q3: "2 minute or 2 bite check back",
      q4: "There is no rule of 1",
      q5: "Place bev nap on the table, order drinks, deliver drinks, order food, deliver food, 2 minute check back, pre buss",
      q6: "First (early) shift receives large table priority",
      q7: "Place the bar menu on the table then hand the menu to the seat",
      q8: ["11am","2-4pm","8-8:30pm"],
      q9: ["11am","Whenever they are empty"]
    };

    // Utils
    const $$ = (s) => Array.from(document.querySelectorAll(s));
    const getChecked = (name) => $$( 'input[name="'+name+'"]:checked' ).map(i => i.value);
    const arraysEqualSet = (a,b) => a.length===b.length && a.every(v => new Set(b).has(v));

    // Progress tracking (Q0..Q9 must be complete => 100%)
    const progressBar = document.getElementById('progressBar');
    const progressPct = document.getElementById('progressPct');
    const REQUIRED = { q0:1,q1:1,q2:1,q3:1,q4:1,q5:1,q6:1,q7:1,q8:3,q9:2 };
    const KNOWLEDGE_KEYS = ['q1','q2','q3','q4','q5','q6','q7','q8','q9'];
    const ALL_FORM_FIELDS = Object.keys(REQUIRED);

    function isComplete(name){
      if (REQUIRED[name]===1) return !!document.querySelector(`input[name="${name}"]:checked`);
      return getChecked(name).length === REQUIRED[name];
    }
    function computeProgress(){
      const done = ALL_FORM_FIELDS.filter(isComplete).length;
      const pct = Math.round((done / ALL_FORM_FIELDS.length) * 100);
      progressBar.style.width = pct + '%';
      progressPct.textContent = pct + '%';
      btnSubmit.disabled = (pct < 100);
    }
    ALL_FORM_FIELDS.forEach(name=>{
      document.querySelectorAll(`input[name="${name}"]`).forEach(el=>el.addEventListener('change', computeProgress));
    });
    $$('input[name="q8"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q8'); if(a.length>3) cb.checked=false; computeProgress(); }));
    $$('input[name="q9"]').forEach(cb => cb.addEventListener('change', ()=>{ const a=getChecked('q9'); if(a.length>2) cb.checked=false; computeProgress(); }));

    function disableSurvey(message, success=false){
      surveyMessage.textContent = message;
      surveyMessage.classList.remove('hidden','border-red-200','bg-red-50','text-red-700','border-green-200','bg-green-50','text-green-700');
      surveyMessage.classList.add(success ? 'border-green-200':'border-red-200', success ? 'bg-green-50':'bg-red-50', success ? 'text-green-700':'text-red-700');
      $$('#surveyForm input').forEach(el=>el.disabled=true);
      btnSubmit.classList.add('hidden');
    }
    function enableSurvey(){
      surveyMessage.classList.add('hidden');
      $$('#surveyForm input').forEach(el=>el.disabled=false);
      btnSubmit.classList.remove('hidden');
    }

    // ===== Login flow =====
    btnLogin.addEventListener('click', async ()=>{
      loginError.classList.add('hidden');
      const u = inUsername.value.trim();
      const p = inPIN.value.trim();
      if(!u && !p){ loginError.textContent="Enter username and/or PIN."; loginError.classList.remove('hidden'); return; }

      const { data, error } = await sb.rpc('hb_auth_employee', { in_username: u || null, in_pin: p || null });
      if(error || !data || !data.length){ loginError.textContent="Invalid credentials."; loginError.classList.remove('hidden'); return; }

      const e = data[0];
      currentEmp = {
        employee_id: e.id, username: e.username, full_name: e.full_name || '',
        email: e.email || '', phone: e.phone || '',
        position: e.position || e["position"] || '', department: e.department || '',
        is_owner: !!e.is_owner
      };

      // Fill summary
      empName.textContent = currentEmp.full_name || '(no name)';
      empUser.textContent = currentEmp.username || '';
      empPos.textContent = currentEmp.position || '';
      empDept.textContent = currentEmp.department || '';
      empPhone.textContent = currentEmp.phone || '';
      empSession.textContent = new Date().toLocaleString();
      if(currentEmp.is_owner) btnExportCsv.classList.remove('hidden');

      
loginSection.classList.add('hidden');

// server-side check (works even with RLS)
const { data: already, error: alreadyErr } = await sb.rpc(
  'hb_ts_already_submitted',
  { p_employee_id: currentEmp.employee_id }
);

if (alreadyErr) {
  console.error('already-submitted RPC error:', alreadyErr);
}

if (already === true) {
  contentSection.classList.add('hidden');
  alreadySection.classList.remove('hidden');
  return;
}

// not submitted yet -> show the survey
alreadySection.classList.add('hidden');
contentSection.classList.remove('hidden');
window.scrollTo({ top: 0, behavior: 'smooth' });
computeProgress();











      // show survey
      alreadySection.classList.add('hidden');
      contentSection.classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
      computeProgress();
    });

    // ===== Submit survey =====
    surveyForm.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!currentEmp){ submitMsg.textContent="Sign in first."; submitMsg.classList.add('text-red-600'); return; }

      // Quick re-check right before submit (prevents second submission in another tab)
    

const { data: already2, error: alreadyErr2 } = await sb.rpc(
  'hb_ts_already_submitted',
  { p_employee_id: currentEmp.employee_id }
);
if (already2 === true) {
  disableSurvey("You already submitted this survey. Thank you!", true);
  return;
}














      const a = {
        q0: (new FormData(surveyForm).get('q0')||"").toString(),
        q1: (new FormData(surveyForm).get('q1')||"").toString(),
        q2: (new FormData(surveyForm).get('q2')||"").toString(),
        q3: (new FormData(surveyForm).get('q3')||"").toString(),
        q4: (new FormData(surveyForm).get('q4')||"").toString(),
        q5: (new FormData(surveyForm).get('q5')||"").toString(),
        q6: (new FormData(surveyForm).get('q6')||"").toString(),
        q7: (new FormData(surveyForm).get('q7')||"").toString(),
        q8: getChecked('q8'),
        q9: getChecked('q9')
      };

      if(a.q8.length!==3 || a.q9.length!==2){
        submitMsg.textContent = "Pick exactly 3 (wipe menus) and 2 (condiments).";
        submitMsg.classList.add('text-red-600'); return;
      }

      let score = 0;
      for(const k of KNOWLEDGE_KEYS){
        score += Array.isArray(correct[k]) ? (arraysEqualSet(a[k], correct[k])?1:0) : (a[k]===correct[k]?1:0);
      }
      const total = KNOWLEDGE_KEYS.length;

      submitMsg.textContent = "Submitting…"; submitMsg.classList.remove('text-red-600','text-green-600');

      const { data, error } = await sb.rpc('hb_ts_submit', {
        p_employee_id: currentEmp.employee_id,
        p_username:    currentEmp.username,
        p_full_name:   currentEmp.full_name,
        p_phone:       currentEmp.phone,
        p_position:    currentEmp.position,
        p_department:  currentEmp.department,
        p_is_owner:    currentEmp.is_owner,
        p_score:       score,
        p_total:       total,
        p_answers:     a
      });

      if (error) {
        console.error('Submission RPC error:', error);
        submitMsg.textContent = `Save failed: ${error.message}`;
        submitMsg.classList.add('text-red-600');
        return;
      }

      submitMsg.textContent = "Submitted successfully! Redirecting...";
      setTimeout(()=>{ window.location.href = 'https://www.jengchirestaurant.com/'; }, 1000);
    });

    // Owner CSV export
    btnExportCsv.addEventListener('click', async ()=>{
      if(!currentEmp?.is_owner) return;
      const ownerUser = prompt("Owner username:", currentEmp.username || "");
      const ownerPin  = prompt("Owner PIN:");
      if(!ownerUser || !ownerPin) return;

      const { data, error } = await sb.rpc('hb_ts_export_owner', { owner_username: ownerUser, owner_pin: ownerPin });
      if(error) return;

      const rows = [["submitted_at","employee_id","username","full_name","phone","position","department","score","total","q0","q1","q2","q3","q4","q5","q6","q7","q8","q9"]];
      for(const r of data){
        const ans = r.answers || {};
        rows.push([
          r.submitted_at, r.employee_id, r.username||"", r.full_name||"", r.phone||"", r.position||"", r.department||"",
          r.score, r.total, ans.q0||"", ans.q1||"", ans.q2||"", ans.q3||"", ans.q4||"", ans.q5||"", ans.q6||"", ans.q7||"",
          Array.isArray(ans.q8)?ans.q8.join('|'):"", Array.isArray(ans.q9)?ans.q9.join('|'):""
        ]);
      }
      const csv = rows.map(r=>r.map(x=>{
        const s = (x??"").toString(); return /[,"\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s;
      }).join(",")).join("\n");
      const blob = new Blob([csv],{type:"text/csv;charset=utf-8"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `steps_of_service_responses_${new Date().toISOString().slice(0,10)}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    });

    // Initialize progress UI
    computeProgress();
  </script>
</body>
</html>
